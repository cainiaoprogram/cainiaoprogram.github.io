<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Docker学习笔记 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Docker学习笔记" />
<meta property="og:description" content="五、Docker 1、简介 Docker是一个开源的应用容器引擎；是一个轻量级容器技术；
Docker支持将软件编译成一个镜像；然后在镜像中各种软件做好配置，将镜像发布出去，其他使用者可以直接使用这个镜像；
运行中的这个镜像称为容器，容器启动是非常快速的。
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-1hzHsWsw-1592984462082)(E:/springboot核心篇&#43;整合篇-尚硅谷/01尚硅谷SpringBoot核心技术篇/Spring Boot 笔记&#43;课件/images/搜狗截图20180303145450.png)]
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-LhbSvZKc-1592984462085)(E:/springboot核心篇&#43;整合篇-尚硅谷/01尚硅谷SpringBoot核心技术篇/Spring Boot 笔记&#43;课件/images/搜狗截图20180303145531.png)]
2、核心概念 docker主机(Host)：安装了Docker程序的机器（Docker直接安装在操作系统之上）；
docker客户端(Client)：连接docker主机进行操作；
docker仓库(Registry)：用来保存各种打包好的软件镜像；
docker镜像(Images)：软件打包好的镜像；放在docker仓库中；
docker容器(Container)：镜像启动后的实例称为一个容器；容器是独立运行的一个或一组应用
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-2fABJMZM-1592984462088)(E:/springboot核心篇&#43;整合篇-尚硅谷/01尚硅谷SpringBoot核心技术篇/Spring Boot 笔记&#43;课件/images/搜狗截图20180303165113.png)]
使用Docker的步骤：
1）、安装Docker
2）、去Docker仓库找到这个软件对应的镜像；
3）、使用Docker运行这个镜像，这个镜像就会生成一个Docker容器；
4）、对容器的启动停止就是对软件的启动停止；
3、安装Docker 1）、安装linux虚拟机 ​ 1）、VMWare、VirtualBox（安装）；
​ 2）、安装centos7
​ 3）、双击启动linux虚拟机;使用 root/ 960614登陆
​ 4）、使用客户端连接linux服务器进行命令操作；
​ 7）、查看linux的ip地址
ip addr ​ 8）、使用客户端连接linux；
2）、在linux虚拟机上安装docker 步骤：
1、检查内核版本，必须是3.10及以上 uname -r 2、安装docker yum install docker 3、输入y确认安装 4、启动docker [root@localhost ~]# systemctl start docker [root@localhost ~]# docker -v Docker version 1.12.6, build 3e8e77d/1.12.6 5、开机启动docker [root@localhost ~]# systemctl enable docker Created symlink from /etc/systemd/system/multi-user." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/09fa9a834cc259207db4356c3c66d781/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-24T15:41:42+08:00" />
<meta property="article:modified_time" content="2020-06-24T15:41:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Docker学习笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a></h3> 
<h2><a id="Docker_2"></a>五、Docker</h2> 
<h3><a id="1_4"></a>1、简介</h3> 
<p><strong>Docker</strong>是一个开源的应用容器引擎；是一个轻量级容器技术；</p> 
<p>Docker支持将软件编译成一个镜像；然后在镜像中各种软件做好配置，将镜像发布出去，其他使用者可以直接使用这个镜像；</p> 
<p>运行中的这个镜像称为容器，容器启动是非常快速的。</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-1hzHsWsw-1592984462082)(E:/springboot核心篇+整合篇-尚硅谷/01尚硅谷SpringBoot核心技术篇/Spring Boot 笔记+课件/images/搜狗截图20180303145450.png)]</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-LhbSvZKc-1592984462085)(E:/springboot核心篇+整合篇-尚硅谷/01尚硅谷SpringBoot核心技术篇/Spring Boot 笔记+课件/images/搜狗截图20180303145531.png)]</p> 
<h3><a id="2_18"></a>2、核心概念</h3> 
<p>docker主机(Host)：安装了Docker程序的机器（Docker直接安装在操作系统之上）；</p> 
<p>docker客户端(Client)：连接docker主机进行操作；</p> 
<p>docker仓库(Registry)：用来保存各种打包好的软件镜像；</p> 
<p>docker镜像(Images)：软件打包好的镜像；放在docker仓库中；</p> 
<p>docker容器(Container)：镜像启动后的实例称为一个容器；容器是独立运行的一个或一组应用</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-2fABJMZM-1592984462088)(E:/springboot核心篇+整合篇-尚硅谷/01尚硅谷SpringBoot核心技术篇/Spring Boot 笔记+课件/images/搜狗截图20180303165113.png)]</p> 
<p>使用Docker的步骤：</p> 
<p>1）、安装Docker</p> 
<p>2）、去Docker仓库找到这个软件对应的镜像；</p> 
<p>3）、使用Docker运行这个镜像，这个镜像就会生成一个Docker容器；</p> 
<p>4）、对容器的启动停止就是对软件的启动停止；</p> 
<h3><a id="3Docker_42"></a>3、安装Docker</h3> 
<h5><a id="1linux_44"></a>1）、安装linux虚拟机</h5> 
<p>​ 1）、VMWare、VirtualBox（安装）；</p> 
<p>​ 2）、安装centos7</p> 
<p>​ 3）、双击启动linux虚拟机;使用 root/ 960614登陆</p> 
<p>​ 4）、使用客户端连接linux服务器进行命令操作；</p> 
<p>​ 7）、查看linux的ip地址</p> 
<pre><code class="prism language-shell">ip addr
</code></pre> 
<p>​ 8）、使用客户端连接linux；</p> 
<h5><a id="2linuxdocker_62"></a>2）、在linux虚拟机上安装docker</h5> 
<p>步骤：</p> 
<pre><code class="prism language-shell">1、检查内核版本，必须是3.10及以上
<span class="token function">uname</span> -r
2、安装docker
yum <span class="token function">install</span> docker
3、输入y确认安装
4、启动docker
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># systemctl start docker</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker -v</span>
Docker version 1.12.6, build 3e8e77d/1.12.6
5、开机启动docker
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable docker</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.
6、停止docker
systemctl stop docker
</code></pre> 
<h3><a id="4Docker_83"></a>4、Docker常用命令&amp;操作</h3> 
<h4><a id="1_85"></a>1）、镜像操作</h4> 
<table><thead><tr><th>操作</th><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>检索</td><td>docker search 关键字 eg：docker search redis</td><td>我们经常去docker hub上检索镜像的详细信息，如镜像的TAG。</td></tr><tr><td>拉取</td><td>docker pull 镜像名:tag</td><td>:tag是可选的，tag表示标签，多为软件的版本，默认是latest</td></tr><tr><td>列表</td><td>docker images</td><td>查看所有本地镜像</td></tr><tr><td>删除</td><td>docker rmi image-id</td><td>删除指定的本地镜像</td></tr></tbody></table> 
<p>https://hub.docker.com/</p> 
<h4><a id="2_96"></a>2）、容器操作</h4> 
<p>软件镜像（QQ安装程序）----运行镜像----产生一个容器（正在运行的软件，运行的QQ）；</p> 
<p>步骤：</p> 
<pre><code class="prism language-shell">1、搜索镜像
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker search tomcat</span>
2、拉取镜像
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker pull tomcat</span>
3、根据镜像启动容器
docker run --name mytomcat -d tomcat:latest
4、docker <span class="token function">ps</span>  
查看运行中的容器
5、 停止运行中的容器
docker stop  容器的id
6、查看所有的容器
docker <span class="token function">ps</span> -a
7、启动容器
docker start 容器id
8、删除一个容器
 docker <span class="token function">rm</span> 容器id
9、启动一个做了端口映射的tomcat
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker run -d -p 8888:8080 tomcat</span>
-d：后台运行
-p: 将主机的端口映射到容器的一个端口    主机端口:容器内部的端口

10、为了演示简单关闭了linux的防火墙
<span class="token function">service</span> firewalld status ；查看防火墙状态
<span class="token function">service</span> firewalld stop：关闭防火墙
11、查看容器的日志
docker logs container-name/container-id

更多命令参看
https://docs.docker.com/engine/reference/commandline/docker/
可以参考每一个镜像的文档

</code></pre> 
<h4><a id="3MySQL_138"></a>3）、安装MySQL示例</h4> 
<pre><code class="prism language-shell">docker pull mysql
</code></pre> 
<p>错误的启动</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker run --name mysql01 -d mysql</span>
42f09819908bb72dd99ae19e792e0a5d03c48638421fa64cce5f8ba0f40f5846

mysql退出了
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker ps -a</span>
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                           PORTS               NAMES
42f09819908b        mysql               <span class="token string">"docker-entrypoint.sh"</span>   34 seconds ago      Exited <span class="token punctuation">(</span>1<span class="token punctuation">)</span> 33 seconds ago                            mysql01
538bde63e500        tomcat              <span class="token string">"catalina.sh run"</span>        About an hour ago   Exited <span class="token punctuation">(</span>143<span class="token punctuation">)</span> About an hour ago                       compassionate_
goldstine
c4f1ac60b3fc        tomcat              <span class="token string">"catalina.sh run"</span>        About an hour ago   Exited <span class="token punctuation">(</span>143<span class="token punctuation">)</span> About an hour ago                       lonely_fermi
81ec743a5271        tomcat              <span class="token string">"catalina.sh run"</span>        About an hour ago   Exited <span class="token punctuation">(</span>143<span class="token punctuation">)</span> About an hour ago                       sick_ramanujan


//错误日志
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker logs 42f09819908b</span>
error: database is uninitialized and password option is not specified 
  You need to specify one of MYSQL_ROOT_PASSWORD, MYSQL_ALLOW_EMPTY_PASSWORD and MYSQL_RANDOM_ROOT_PASSWORD；这个三个参数必须指定一个
</code></pre> 
<p>正确的启动</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker run --name mysql01 -e MYSQL_ROOT_PASSWORD=123456 -d mysql</span>
b874c56bec49fb43024b3805ab51e9097da779f2f572c22c695305dedd684c5f
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
b874c56bec49        mysql               <span class="token string">"docker-entrypoint.sh"</span>   4 seconds ago       Up 3 seconds        3306/tcp            mysql01
</code></pre> 
<p>做了端口映射</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker run -p 3306:3306 --name mysql02 -e MYSQL_ROOT_PASSWORD=123456 -d mysql</span>
ad10e4bc5c6a0f61cbad43898de71d366117d120e39db651844c0e73863b9434
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
ad10e4bc5c6a        mysql               <span class="token string">"docker-entrypoint.sh"</span>   4 seconds ago       Up 2 seconds        0.0.0.0:3306-<span class="token operator">&gt;</span>3306/tcp   mysql02
</code></pre> 
<p>几个其他的高级操作</p> 
<pre><code>docker run --name mysql03 -v /conf/mysql:/etc/mysql/conf.d -e MYSQL_ROOT_PASSWORD=my-secret-pw -d mysql:tag
把主机的/conf/mysql文件夹挂载到 mysqldocker容器的/etc/mysql/conf.d文件夹里面
改mysql的配置文件就只需要把mysql配置文件放在自定义的文件夹下（/conf/mysql）

docker run --name some-mysql -e MYSQL_ROOT_PASSWORD=my-secret-pw -d mysql:tag --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
指定mysql的一些配置参数
</code></pre> 
<h2><a id="Docker_203"></a>六、Docker环境下的前后端分离项目部署与运维</h2> 
<ol><li> <p>先更新软件包</p> <pre><code class="prism language-shell">yum -y update
</code></pre> </li><li> <p>安装Docker虚拟机</p> <pre><code class="prism language-shell">yum <span class="token function">install</span> -y docker
</code></pre> </li><li> <p>运行、重启、关闭Docker虚拟机</p> <pre><code class="prism language-shell"><span class="token function">service</span> docker start
<span class="token function">service</span> docker restart
<span class="token function">service</span> docker stop
</code></pre> </li><li> <p>搜索镜像</p> <pre><code class="prism language-shell">docker search 镜像名称
</code></pre> </li><li> <p>下载镜像</p> <pre><code class="prism language-shell">docker pull 镜像名称
</code></pre> </li><li> <p>查看镜像</p> <pre><code class="prism language-shell">docker images
</code></pre> </li><li> <p>删除镜像</p> <pre><code class="prism language-shell">docker rmi 镜像名称
</code></pre> </li><li> <p>运行容器</p> <pre><code class="prism language-shell">docker run 启动参数  镜像名称
</code></pre> </li><li> <p>查看容器列表</p> <pre><code class="prism language-shell">docker <span class="token function">ps</span> -a
</code></pre> </li><li> <p>停止、挂起、恢复容器</p> </li></ol> 
<pre><code class="prism language-shell">docker stop 容器ID
docker pause 容器ID
docker unpase 容器ID
</code></pre> 
<ol start="11"><li> <p>查看容器信息</p> <pre><code class="prism language-shell">docker inspect 容器ID
</code></pre> </li><li> <p>删除容器</p> <pre><code class="prism language-shell">docker <span class="token function">rm</span> 容器ID
</code></pre> </li><li> <p>数据卷管理</p> <pre><code class="prism language-shell">docker volume create 数据卷名称  <span class="token comment">#创建数据卷</span>
docker volume <span class="token function">rm</span> 数据卷名称  <span class="token comment">#删除数据卷</span>
docker volume inspect 数据卷名称  <span class="token comment">#查看数据卷</span>
</code></pre> </li><li> <p>网络管理</p> <pre><code class="prism language-shell">docker network <span class="token function">ls</span> 查看网络信息
docker network create --subnet<span class="token operator">=</span>网段 网络名称
docker network <span class="token function">rm</span> 网络名称
</code></pre> </li><li> <p>避免VM虚拟机挂起恢复之后，Docker虚拟机断网</p> <pre><code class="prism language-shell"><span class="token function">vi</span> /etc/sysctl.conf
</code></pre> <p>文件中添加<code>net.ipv4.ip_forward=1</code>这个配置</p> <pre><code class="prism language-shell"><span class="token comment">#重启网络服务</span>
systemctl  restart network
</code></pre> </li></ol> 
<h3><a id="PXC_310"></a>安装PXC集群，负载均衡，双机热备</h3> 
<ol><li> <p>安装PXC镜像</p> <pre><code class="prism language-shell">docker pull percona/percona-xtradb-cluster
</code></pre> </li><li> <p>为PXC镜像改名</p> <pre><code class="prism language-shell">docker tag percona/percona-xtradb-cluster pxc
</code></pre> </li><li> <p>创建net1网段</p> <pre><code class="prism language-shell">docker network create --subnet<span class="token operator">=</span>172.18.0.0/16 net1
</code></pre> </li><li> <p>创建5个数据卷</p> <pre><code class="prism language-shell">docker volume create --name v1
docker volume create --name v2
docker volume create --name v3
docker volume create --name v4
docker volume create --name v5
</code></pre> </li><li> <p>创建备份数据卷（用于热备份数据）</p> <pre><code class="prism language-shell">docker volume create --name backup
</code></pre> </li><li> <p>创建5节点的PXC集群</p> <p>注意，每个MySQL容器创建之后，因为要执行PXC的初始化和加入集群等工作，耐心等待1分钟左右再用客户端连接MySQL。另外，必须第1个MySQL节点启动成功，用MySQL客户端能连接上之后，再去创建其他MySQL节点。</p> <pre><code class="prism language-shell"><span class="token comment">#创建第1个MySQL节点</span>
docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -v v1:/var/lib/mysql -v backup:/data --privileged --name<span class="token operator">=</span>node1 --net<span class="token operator">=</span>net1 --ip 172.18.0.2 pxc
<span class="token comment">#创建第2个MySQL节点</span>
docker run -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_JOIN<span class="token operator">=</span>node1 -v v2:/var/lib/mysql -v backup:/data --privileged --name<span class="token operator">=</span>node2 --net<span class="token operator">=</span>net1 --ip 172.18.0.3 pxc
<span class="token comment">#创建第3个MySQL节点</span>
docker run -d -p 3308:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_JOIN<span class="token operator">=</span>node1 -v v3:/var/lib/mysql --privileged --name<span class="token operator">=</span>node3 --net<span class="token operator">=</span>net1 --ip 172.18.0.4 pxc
<span class="token comment">#创建第4个MySQL节点</span>
docker run -d -p 3309:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_JOIN<span class="token operator">=</span>node1 -v v4:/var/lib/mysql --privileged --name<span class="token operator">=</span>node4 --net<span class="token operator">=</span>net1 --ip 172.18.0.5 pxc
<span class="token comment">#创建第5个MySQL节点</span>
docker run -d -p 3310:3306 -e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_NAME<span class="token operator">=</span>PXC -e XTRABACKUP_PASSWORD<span class="token operator">=</span>abc123456 -e CLUSTER_JOIN<span class="token operator">=</span>node1 -v v5:/var/lib/mysql -v backup:/data --privileged --name<span class="token operator">=</span>node5 --net<span class="token operator">=</span>net1 --ip 172.18.0.6 pxc
</code></pre> </li><li> <p>安装Haproxy镜像</p> <pre><code class="prism language-shell">docker pull haproxy
</code></pre> </li><li> <p>宿主机上编写Haproxy配置文件</p> <pre><code class="prism language-shell"><span class="token function">vi</span> /home/soft/haproxy.cfg
</code></pre> <p>配置文件如下：</p> <pre><code class="prism language-properties">global
	#工作目录
	chroot /usr/local/etc/haproxy
	#日志文件，使用rsyslog服务中local5日志设备（/var/log/local5），等级info
	log 127.0.0.1 local5 info
	#守护进程运行
	daemon

defaults
	log	global
	mode	http
	#日志格式
	option	httplog
	#日志中不记录负载均衡的心跳检测记录
	option	dontlognull
    #连接超时（毫秒）
	timeout connect 5000
    #客户端超时（毫秒）
	timeout client  50000
	#服务器超时（毫秒）
    timeout server  50000

#监控界面
listen  admin_stats
	#监控界面的访问的IP和端口
	bind  0.0.0.0:8888
	#访问协议
    mode        http
	#URI相对地址
    stats uri   /dbs
	#统计报告格式
    stats realm     Global\ statistics
	#登陆帐户信息
    stats auth  admin:abc123456
#数据库负载均衡
listen  proxy-mysql
	#访问的IP和端口
	bind  0.0.0.0:3306
    #网络协议
	mode  tcp
	#负载均衡算法（轮询算法）
	#轮询算法：roundrobin
	#权重算法：static-rr
	#最少连接算法：leastconn
	#请求源IP算法：source
    balance  roundrobin
	#日志格式
    option  tcplog
	#在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测
    option  mysql-check user haproxy
    server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000
    server  MySQL_2 172.18.0.3:3306 check weight 1 maxconn 2000
	server  MySQL_3 172.18.0.4:3306 check weight 1 maxconn 2000
	server  MySQL_4 172.18.0.5:3306 check weight 1 maxconn 2000
	server  MySQL_5 172.18.0.6:3306 check weight 1 maxconn 2000
	#使用keepalive检测死链
    option  tcpka
</code></pre> </li><li> <p>创建两个Haproxy容器</p> <pre><code class="prism language-shell"><span class="token comment">#创建第1个Haproxy负载均衡服务器</span>
docker run -it -d -p 4001:8888 -p 4002:3306 -v /home/soft/haproxy:/usr/local/etc/haproxy --name h1 --privileged --net<span class="token operator">=</span>net1 --ip 172.18.0.7 haproxy
<span class="token comment">#进入h1容器，启动Haproxy</span>
docker <span class="token function">exec</span> -it h1 <span class="token function">bash</span>
haproxy -f /usr/local/etc/haproxy/haproxy.cfg
<span class="token comment">#创建第2个Haproxy负载均衡服务器</span>
docker run -it -d -p 4003:8888 -p 4004:3306 -v /home/soft/haproxy:/usr/local/etc/haproxy --name h2 --privileged --net<span class="token operator">=</span>net1 --ip 172.18.0.8 haproxy
<span class="token comment">#进入h2容器，启动Haproxy</span>
docker <span class="token function">exec</span> -it h2 <span class="token function">bash</span>
haproxy -f /usr/local/etc/haproxy/haproxy.cfg
</code></pre> </li><li> <p>Haproxy容器内安装Keepalived，设置虚拟IP</p> <pre><code class="prism language-shell"><span class="token comment">#进入h1容器</span>
docker <span class="token function">exec</span> -it h1 <span class="token function">bash</span>
<span class="token comment">#更新软件包</span>
<span class="token function">apt-get</span> update
<span class="token comment">#安装VIM</span>
<span class="token function">apt-get</span> <span class="token function">install</span> vim
<span class="token comment">#安装Keepalived</span>
<span class="token function">apt-get</span> <span class="token function">install</span> keepalived
<span class="token comment">#编辑Keepalived配置文件（参考下方配置文件）</span>
vim /etc/keepalived/keepalived.conf
<span class="token comment">#启动Keepalived</span>
<span class="token function">service</span> keepalived start
<span class="token comment">#宿主机执行ping命令</span>
<span class="token function">ping</span> 172.18.0.201
</code></pre> <p>配置文件内容如下：</p> <pre><code>vrrp_instance  VI_1 {
    state  MASTER
    interface  eth0
    virtual_router_id  51
    priority  100
    advert_int  1
    authentication {
        auth_type  PASS
        auth_pass  123456
    }
    virtual_ipaddress {
        172.18.0.201
    }
}
</code></pre> <pre><code class="prism language-shell"><span class="token comment">#进入h2容器</span>
docker <span class="token function">exec</span> -it h2 <span class="token function">bash</span>
<span class="token comment">#更新软件包</span>
<span class="token function">apt-get</span> update
<span class="token comment">#安装VIM</span>
<span class="token function">apt-get</span> <span class="token function">install</span> vim
<span class="token comment">#安装Keepalived</span>
<span class="token function">apt-get</span> <span class="token function">install</span> keepalived
<span class="token comment">#编辑Keepalived配置文件</span>
vim /etc/keepalived/keepalived.conf
<span class="token comment">#启动Keepalived</span>
<span class="token function">service</span> keepalived start
<span class="token comment">#宿主机执行ping命令</span>
<span class="token function">ping</span> 172.18.0.201
</code></pre> <p>配置文件内容如下：</p> <pre><code class="prism language-shell">vrrp_instance  VI_1 <span class="token punctuation">{<!-- --></span>
    state  MASTER
    interface  eth0
    virtual_router_id  51
    priority  100
    advert_int  1
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type  PASS
        auth_pass  123456
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
        172.18.0.201
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>宿主机安装Keepalived，实现双击热备</p> <pre><code class="prism language-shell"><span class="token comment">#宿主机执行安装Keepalived</span>
yum -y <span class="token function">install</span> keepalived
<span class="token comment">#修改Keepalived配置文件</span>
<span class="token function">vi</span> /etc/keepalived/keepalived.conf
<span class="token comment">#启动Keepalived</span>
<span class="token function">service</span> keepalived start
</code></pre> <p>Keepalived配置文件如下：</p> <pre><code class="prism language-shell">vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span>
    state MASTER
    interface ens33
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type PASS
        auth_pass 1111
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
       	192.168.99.150
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

virtual_server 192.168.99.150 8888 <span class="token punctuation">{<!-- --></span>
    delay_loop 3
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP
    real_server 172.18.0.201 8888 <span class="token punctuation">{<!-- --></span>
        weight 1
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

virtual_server 192.168.99.150 3306 <span class="token punctuation">{<!-- --></span>
    delay_loop 3
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP

    real_server 172.18.0.201 3306 <span class="token punctuation">{<!-- --></span>
        weight 1
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>热备份数据</p> <pre><code class="prism language-shell"><span class="token comment">#进入node1容器</span>
docker <span class="token function">exec</span> -it node1 <span class="token function">bash</span>
<span class="token comment">#更新软件包</span>
<span class="token function">apt-get</span> update
<span class="token comment">#安装热备工具</span>
<span class="token function">apt-get</span> <span class="token function">install</span> percona-xtrabackup-24
<span class="token comment">#全量热备</span>
innobackupex --user<span class="token operator">=</span>root --password<span class="token operator">=</span>abc123456 /data/backup/full
</code></pre> </li><li> <p>冷还原数据<br> 停止其余4个节点，并删除节点</p> <pre><code class="prism language-shell">docker stop node2
docker stop node3
docker stop node4
docker stop node5
docker <span class="token function">rm</span> node2
docker <span class="token function">rm</span> node3
docker <span class="token function">rm</span> node4
docker <span class="token function">rm</span> node5
</code></pre> <p>node1容器中删除MySQL的数据</p> <pre><code class="prism language-shell"><span class="token comment">#删除数据</span>
<span class="token function">rm</span> -rf /var/lib/mysql/*
<span class="token comment">#清空事务</span>
innobackupex --user<span class="token operator">=</span>root --password<span class="token operator">=</span>abc123456 --apply-back /data/backup/full/2018-04-15_05-09-07/
<span class="token comment">#还原数据</span>
innobackupex --user<span class="token operator">=</span>root --password<span class="token operator">=</span>abc123456 --copy-back  /data/backup/full/2018-04-15_05-09-07/
</code></pre> <p>重新创建其余4个节点，组件PXC集群</p> </li></ol> 
<h3><a id="RedisRedisCluster_619"></a>安装Redis，配置RedisCluster集群</h3> 
<ol><li> <p>安装Redis镜像</p> <pre><code class="prism language-shell">docker pull yyyyttttwwww/redis
</code></pre> </li><li> <p>创建net2网段</p> <pre><code class="prism language-shell">docker network create --subnet<span class="token operator">=</span>172.19.0.0/16 net2
</code></pre> </li><li> <p>创建6节点Redis容器</p> <pre><code class="prism language-shell">docker run -it -d --name r1 -p 5001:6379 --net<span class="token operator">=</span>net2 --ip 172.19.0.2 redis <span class="token function">bash</span>
docker run -it -d --name r2 -p 5002:6379 --net<span class="token operator">=</span>net2 --ip 172.19.0.3 redis <span class="token function">bash</span>
docker run -it -d --name r3 -p 5003:6379 --net<span class="token operator">=</span>net2 --ip 172.19.0.4 redis <span class="token function">bash</span>
docker run -it -d --name r4 -p 5004:6379 --net<span class="token operator">=</span>net2 --ip 172.19.0.5 redis <span class="token function">bash</span>
docker run -it -d --name r5 -p 5005:6379 --net<span class="token operator">=</span>net2 --ip 172.19.0.6 redis <span class="token function">bash</span>
</code></pre> </li><li> <p>启动6节点Redis服务器</p> <pre><code class="prism language-shell"><span class="token comment">#进入r1节点</span>
docker <span class="token function">exec</span> -it r1 <span class="token function">bash</span>
<span class="token function">cp</span> /home/redis/redis.conf /usr/redis/redis.conf
<span class="token function">cd</span> /usr/redis/src
./redis-server <span class="token punctuation">..</span>/redis.conf
<span class="token comment">#进入r2节点</span>
docker <span class="token function">exec</span> -it r2 <span class="token function">bash</span>
<span class="token function">cp</span> /home/redis/redis.conf /usr/redis/redis.conf
<span class="token function">cd</span> /usr/redis/src
./redis-server <span class="token punctuation">..</span>/redis.conf
<span class="token comment">#进入r3节点</span>
docker <span class="token function">exec</span> -it r3 <span class="token function">bash</span>
<span class="token function">cp</span> /home/redis/redis.conf /usr/redis/redis.conf
<span class="token function">cd</span> /usr/redis/src
./redis-server <span class="token punctuation">..</span>/redis.conf
<span class="token comment">#进入r4节点</span>
docker <span class="token function">exec</span> -it r4 <span class="token function">bash</span>
<span class="token function">cp</span> /home/redis/redis.conf /usr/redis/redis.conf
<span class="token function">cd</span> /usr/redis/src
./redis-server <span class="token punctuation">..</span>/redis.conf
<span class="token comment">#进入r5节点</span>
docker <span class="token function">exec</span> -it r5 <span class="token function">bash</span>
<span class="token function">cp</span> /home/redis/redis.conf /usr/redis/redis.conf
<span class="token function">cd</span> /usr/redis/src
./redis-server <span class="token punctuation">..</span>/redis.conf
<span class="token comment">#进入r6节点</span>
docker <span class="token function">exec</span> -it r6 <span class="token function">bash</span>
<span class="token function">cp</span> /home/redis/redis.conf /usr/redis/redis.conf
<span class="token function">cd</span> /usr/redis/src
./redis-server <span class="token punctuation">..</span>/redis.conf
</code></pre> </li><li> <p>创建Cluster集群</p> <pre><code class="prism language-shell"><span class="token comment">#在r1节点上执行下面的指令</span>
<span class="token function">cd</span> /usr/redis/src
<span class="token function">mkdir</span> -p <span class="token punctuation">..</span>/cluster
<span class="token function">cp</span> redis-trib.rb <span class="token punctuation">..</span>/cluster/
<span class="token function">cd</span> <span class="token punctuation">..</span>/cluster
<span class="token comment">#创建Cluster集群</span>
./redis-trib.rb create --replicas 1 172.19.0.2:6379 172.19.0.3:6379 172.19.0.4:6379 172.19.0.5:6379 172.19.0.6:6379 172.19.0.7:6379
</code></pre> </li></ol> 
<h3><a id="_692"></a>打包部署后端项目</h3> 
<ol><li> <p>进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）</p> <pre><code class="prism language-shell">mvn clean <span class="token function">install</span> -Dmaven.test.skip<span class="token operator">=</span>true
</code></pre> </li><li> <p>安装Java镜像</p> <pre><code class="prism language-shell">docker pull java
</code></pre> </li><li> <p>创建3节点Java容器</p> <pre><code class="prism language-shell"><span class="token comment">#创建数据卷，上传JAR文件</span>
docker volume create j1
<span class="token comment">#启动容器</span>
docker run -it -d --name j1 -v j1:/home/soft --net<span class="token operator">=</span>host java
<span class="token comment">#进入j1容器</span>
docker <span class="token function">exec</span> -it j1 <span class="token function">bash</span>
<span class="token comment">#启动Java项目</span>
<span class="token function">nohup</span> java -jar /home/soft/renren-fast.jar

<span class="token comment">#创建数据卷，上传JAR文件</span>
docker volume create j2
<span class="token comment">#启动容器</span>
docker run -it -d --name j2 -v j2:/home/soft --net<span class="token operator">=</span>host java
<span class="token comment">#进入j1容器</span>
docker <span class="token function">exec</span> -it j2 <span class="token function">bash</span>
<span class="token comment">#启动Java项目</span>
<span class="token function">nohup</span> java -jar /home/soft/renren-fast.jar

<span class="token comment">#创建数据卷，上传JAR文件</span>
docker volume create j3
<span class="token comment">#启动容器</span>
docker run -it -d --name j3 -v j3:/home/soft --net<span class="token operator">=</span>host java
<span class="token comment">#进入j1容器</span>
docker <span class="token function">exec</span> -it j3 <span class="token function">bash</span>
<span class="token comment">#启动Java项目</span>
<span class="token function">nohup</span> java -jar /home/soft/renren-fast.jar
</code></pre> </li><li> <p>安装Nginx镜像</p> <pre><code class="prism language-shell">docker pull nginx
</code></pre> </li><li> <p>创建Nginx容器，配置负载均衡</p> <p>宿主机上/home/n1/nginx.conf配置文件内容如下：</p> <pre><code class="prism language-properties">user  nginx;
worker_processes  1;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

	proxy_redirect          off;
	proxy_set_header        Host $host;
	proxy_set_header        X-Real-IP $remote_addr;
	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
	client_max_body_size    10m;
	client_body_buffer_size   128k;
	proxy_connect_timeout   5s;
	proxy_send_timeout      5s;
	proxy_read_timeout      5s;
	proxy_buffer_size        4k;
	proxy_buffers           4 32k;
	proxy_busy_buffers_size  64k;
	proxy_temp_file_write_size 64k;

	upstream tomcat {
		server 192.168.99.104:6001;
		server 192.168.99.104:6002;
		server 192.168.99.104:6003;
	}
	server {
        listen       6101;
        server_name  192.168.99.104;
        location / {
            proxy_pass   http://tomcat;
            index  index.html index.htm;
        }
    }
}
</code></pre> <p>创建第1个Nginx节点</p> <pre><code class="prism language-shell">docker run -it -d --name n1 -v /home/n1/nginx.conf:/etc/nginx/nginx.conf --net<span class="token operator">=</span>host --privileged nginx

</code></pre> <p>宿主机上/home/n2/nginx.conf配置文件内容如下：</p> <pre><code class="prism language-properties">user  nginx;
worker_processes  1;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

	proxy_redirect          off;
	proxy_set_header        Host $host;
	proxy_set_header        X-Real-IP $remote_addr;
	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
	client_max_body_size    10m;
	client_body_buffer_size   128k;
	proxy_connect_timeout   5s;
	proxy_send_timeout      5s;
	proxy_read_timeout      5s;
	proxy_buffer_size        4k;
	proxy_buffers           4 32k;
	proxy_busy_buffers_size  64k;
	proxy_temp_file_write_size 64k;

	upstream tomcat {
		server 192.168.99.104:6001;
		server 192.168.99.104:6002;
		server 192.168.99.104:6003;
	}
	server {
        listen       6102;
        server_name  192.168.99.104;
        location / {
            proxy_pass   http://tomcat;
            index  index.html index.htm;
        }
    }
}
</code></pre> <p>创建第2个Nginx节点</p> <pre><code class="prism language-shell">docker run -it -d --name n2 -v /home/n2/nginx.conf:/etc/nginx/nginx.conf --net<span class="token operator">=</span>host --privileged nginx
</code></pre> </li><li> <p>在Nginx容器安装Keepalived</p> <pre><code class="prism language-shell"><span class="token comment">#进入n1节点</span>
docker <span class="token function">exec</span> -it n1 <span class="token function">bash</span>
<span class="token comment">#更新软件包</span>
<span class="token function">apt-get</span> update
<span class="token comment">#安装VIM</span>
<span class="token function">apt-get</span> <span class="token function">install</span> vim
<span class="token comment">#安装Keepalived</span>
<span class="token function">apt-get</span> <span class="token function">install</span> keepalived
<span class="token comment">#编辑Keepalived配置文件(如下)</span>
vim /etc/keepalived/keepalived.conf
<span class="token comment">#启动Keepalived</span>
<span class="token function">service</span> keepalived start
</code></pre> <pre><code>vrrp_instance VI_1 {
    state MASTER
    interface ens33
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 123456
    }
    virtual_ipaddress {
        192.168.99.151
    }
}
virtual_server 192.168.99.151 6201 {
    delay_loop 3
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP
    real_server 192.168.99.104 6101 {
        weight 1
    }
}
</code></pre> <pre><code class="prism language-shell"><span class="token comment">#进入n1节点</span>
docker <span class="token function">exec</span> -it n2 <span class="token function">bash</span>
<span class="token comment">#更新软件包</span>
<span class="token function">apt-get</span> update
<span class="token comment">#安装VIM</span>
<span class="token function">apt-get</span> <span class="token function">install</span> vim
<span class="token comment">#安装Keepalived</span>
<span class="token function">apt-get</span> <span class="token function">install</span> keepalived
<span class="token comment">#编辑Keepalived配置文件(如下)</span>
vim /etc/keepalived/keepalived.conf
<span class="token comment">#启动Keepalived</span>
<span class="token function">service</span> keepalived start
</code></pre> <pre><code class="prism language-shell">vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span>
    state MASTER
    interface ens33
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type PASS
        auth_pass 123456
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
        192.168.99.151
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
virtual_server 192.168.99.151 6201 <span class="token punctuation">{<!-- --></span>
    delay_loop 3
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP
    real_server 192.168.99.104 6102 <span class="token punctuation">{<!-- --></span>
        weight 1
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h3><a id="_964"></a>打包部署后端项目</h3> 
<ol><li> <p>在前端项目路径下执行打包指令</p> <pre><code class="prism language-shell"><span class="token function">npm</span> run build
</code></pre> </li><li> <p>build目录的文件拷贝到宿主机的/home/fn1/renren-vue、/home/fn2/renren-vue、/home/fn3/renren-vue的目录下面</p> </li><li> <p>创建3节点的Nginx，部署前端项目</p> <p>宿主机/home/fn1/nginx.conf的配置文件</p> <pre><code>user  nginx;
worker_processes  1;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

	proxy_redirect          off;
	proxy_set_header        Host $host;
	proxy_set_header        X-Real-IP $remote_addr;
	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
	client_max_body_size    10m;
	client_body_buffer_size   128k;
	proxy_connect_timeout   5s;
	proxy_send_timeout      5s;
	proxy_read_timeout      5s;
	proxy_buffer_size        4k;
	proxy_buffers           4 32k;
	proxy_busy_buffers_size  64k;
	proxy_temp_file_write_size 64k;

	server {
		listen 6501;
		server_name  192.168.99.104;
		location  /  {
			root  /home/fn1/renren-vue;
			index  index.html;
		}
	}
}
</code></pre> <pre><code class="prism language-shell"><span class="token comment">#启动第fn1节点</span>
docker run -it -d --name fn1 -v /home/fn1/nginx.conf:/etc/nginx/nginx.conf -v /home/fn1/renren-vue:/home/fn1/renren-vue --privileged --net<span class="token operator">=</span>host nginx
</code></pre> <p>宿主机/home/fn2/nginx.conf的配置文件</p> <pre><code class="prism language-shell">user  nginx<span class="token punctuation">;</span>
worker_processes  1<span class="token punctuation">;</span>
error_log  /var/log/nginx/error.log warn<span class="token punctuation">;</span>
pid        /var/run/nginx.pid<span class="token punctuation">;</span>

events <span class="token punctuation">{<!-- --></span>
    worker_connections  1024<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
    include       /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>

    log_format  main  <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local</span>] "<span class="token variable">$request</span>" '</span>
                      <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span>
                      <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>"'</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile        on<span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>

    keepalive_timeout  65<span class="token punctuation">;</span>

    <span class="token comment">#gzip  on;</span>

	proxy_redirect          off<span class="token punctuation">;</span>
	proxy_set_header        Host <span class="token variable">$host</span><span class="token punctuation">;</span>
	proxy_set_header        X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
	proxy_set_header        X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
	client_max_body_size    10m<span class="token punctuation">;</span>
	client_body_buffer_size   128k<span class="token punctuation">;</span>
	proxy_connect_timeout   5s<span class="token punctuation">;</span>
	proxy_send_timeout      5s<span class="token punctuation">;</span>
	proxy_read_timeout      5s<span class="token punctuation">;</span>
	proxy_buffer_size        4k<span class="token punctuation">;</span>
	proxy_buffers           4 32k<span class="token punctuation">;</span>
	proxy_busy_buffers_size  64k<span class="token punctuation">;</span>
	proxy_temp_file_write_size 64k<span class="token punctuation">;</span>

	server <span class="token punctuation">{<!-- --></span>
		listen 6502<span class="token punctuation">;</span>
		server_name  192.168.99.104<span class="token punctuation">;</span>
		location  /  <span class="token punctuation">{<!-- --></span>
			root  /home/fn2/renren-vue<span class="token punctuation">;</span>
			index  index.html<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-shell"><span class="token comment">#启动第fn2节点</span>
docker run -it -d --name fn2 -v /home/fn2/nginx.conf:/etc/nginx/nginx.conf -v /home/fn2/renren-vue:/home/fn2/renren-vue --privileged --net<span class="token operator">=</span>host nginx
</code></pre> <p>宿主机/home/fn3/nginx.conf的配置文件</p> <pre><code class="prism language-shell">user  nginx<span class="token punctuation">;</span>
worker_processes  1<span class="token punctuation">;</span>
error_log  /var/log/nginx/error.log warn<span class="token punctuation">;</span>
pid        /var/run/nginx.pid<span class="token punctuation">;</span>

events <span class="token punctuation">{<!-- --></span>
    worker_connections  1024<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
    include       /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>

    log_format  main  <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local</span>] "<span class="token variable">$request</span>" '</span>
                      <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span>
                      <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>"'</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile        on<span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>

    keepalive_timeout  65<span class="token punctuation">;</span>

    <span class="token comment">#gzip  on;</span>

	proxy_redirect          off<span class="token punctuation">;</span>
	proxy_set_header        Host <span class="token variable">$host</span><span class="token punctuation">;</span>
	proxy_set_header        X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
	proxy_set_header        X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
	client_max_body_size    10m<span class="token punctuation">;</span>
	client_body_buffer_size   128k<span class="token punctuation">;</span>
	proxy_connect_timeout   5s<span class="token punctuation">;</span>
	proxy_send_timeout      5s<span class="token punctuation">;</span>
	proxy_read_timeout      5s<span class="token punctuation">;</span>
	proxy_buffer_size        4k<span class="token punctuation">;</span>
	proxy_buffers           4 32k<span class="token punctuation">;</span>
	proxy_busy_buffers_size  64k<span class="token punctuation">;</span>
	proxy_temp_file_write_size 64k<span class="token punctuation">;</span>

	server <span class="token punctuation">{<!-- --></span>
		listen 6503<span class="token punctuation">;</span>
		server_name  192.168.99.104<span class="token punctuation">;</span>
		location  /  <span class="token punctuation">{<!-- --></span>
			root  /home/fn3/renren-vue<span class="token punctuation">;</span>
			index  index.html<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>启动fn3节点</p> <pre><code class="prism language-shell"><span class="token comment">#启动第fn3节点</span>
docker run -it -d --name fn3 -v /home/fn3/nginx.conf:/etc/nginx/nginx.conf -v /home/fn3/renren-vue:/home/fn3/renren-vue --privileged --net<span class="token operator">=</span>host nginx
</code></pre> </li><li> <p>配置负载均衡</p> <p>宿主机/home/ff1/nginx.conf配置文件</p> <pre><code class="prism language-shell">user  nginx<span class="token punctuation">;</span>
worker_processes  1<span class="token punctuation">;</span>
error_log  /var/log/nginx/error.log warn<span class="token punctuation">;</span>
pid        /var/run/nginx.pid<span class="token punctuation">;</span>

events <span class="token punctuation">{<!-- --></span>
    worker_connections  1024<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
    include       /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>

    log_format  main  <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local</span>] "<span class="token variable">$request</span>" '</span>
                      <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span>
                      <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>"'</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile        on<span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>

    keepalive_timeout  65<span class="token punctuation">;</span>

    <span class="token comment">#gzip  on;</span>

	proxy_redirect          off<span class="token punctuation">;</span>
	proxy_set_header        Host <span class="token variable">$host</span><span class="token punctuation">;</span>
	proxy_set_header        X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
	proxy_set_header        X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
	client_max_body_size    10m<span class="token punctuation">;</span>
	client_body_buffer_size   128k<span class="token punctuation">;</span>
	proxy_connect_timeout   5s<span class="token punctuation">;</span>
	proxy_send_timeout      5s<span class="token punctuation">;</span>
	proxy_read_timeout      5s<span class="token punctuation">;</span>
	proxy_buffer_size        4k<span class="token punctuation">;</span>
	proxy_buffers           4 32k<span class="token punctuation">;</span>
	proxy_busy_buffers_size  64k<span class="token punctuation">;</span>
	proxy_temp_file_write_size 64k<span class="token punctuation">;</span>

	upstream fn <span class="token punctuation">{<!-- --></span>
		server 192.168.99.104:6501<span class="token punctuation">;</span>
		server 192.168.99.104:6502<span class="token punctuation">;</span>
		server 192.168.99.104:6503<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	server <span class="token punctuation">{<!-- --></span>
        listen       6601<span class="token punctuation">;</span>
        server_name  192.168.99.104<span class="token punctuation">;</span>
        location / <span class="token punctuation">{<!-- --></span>
            proxy_pass   http://fn<span class="token punctuation">;</span>
            index  index.html index.htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-shell"><span class="token comment">#启动ff1节点</span>
docker run -it -d --name ff1 -v /home/ff1/nginx.conf:/etc/nginx/nginx.conf --net<span class="token operator">=</span>host --privileged nginx
</code></pre> <p>宿主机/home/ff2/nginx.conf配置文件</p> <pre><code class="prism language-shell">user  nginx<span class="token punctuation">;</span>
worker_processes  1<span class="token punctuation">;</span>
error_log  /var/log/nginx/error.log warn<span class="token punctuation">;</span>
pid        /var/run/nginx.pid<span class="token punctuation">;</span>

events <span class="token punctuation">{<!-- --></span>
    worker_connections  1024<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
    include       /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>

    log_format  main  <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local</span>] "<span class="token variable">$request</span>" '</span>
                      <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span>
                      <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>"'</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile        on<span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>

    keepalive_timeout  65<span class="token punctuation">;</span>

    <span class="token comment">#gzip  on;</span>

	proxy_redirect          off<span class="token punctuation">;</span>
	proxy_set_header        Host <span class="token variable">$host</span><span class="token punctuation">;</span>
	proxy_set_header        X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
	proxy_set_header        X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
	client_max_body_size    10m<span class="token punctuation">;</span>
	client_body_buffer_size   128k<span class="token punctuation">;</span>
	proxy_connect_timeout   5s<span class="token punctuation">;</span>
	proxy_send_timeout      5s<span class="token punctuation">;</span>
	proxy_read_timeout      5s<span class="token punctuation">;</span>
	proxy_buffer_size        4k<span class="token punctuation">;</span>
	proxy_buffers           4 32k<span class="token punctuation">;</span>
	proxy_busy_buffers_size  64k<span class="token punctuation">;</span>
	proxy_temp_file_write_size 64k<span class="token punctuation">;</span>

	upstream fn <span class="token punctuation">{<!-- --></span>
		server 192.168.99.104:6501<span class="token punctuation">;</span>
		server 192.168.99.104:6502<span class="token punctuation">;</span>
		server 192.168.99.104:6503<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	server <span class="token punctuation">{<!-- --></span>
        listen       6602<span class="token punctuation">;</span>
        server_name  192.168.99.104<span class="token punctuation">;</span>
        location / <span class="token punctuation">{<!-- --></span>
            proxy_pass   http://fn<span class="token punctuation">;</span>
            index  index.html index.htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-shell"><span class="token comment">#启动ff2节点</span>
docker run -it -d --name ff2 -v /home/ff2/nginx.conf:/etc/nginx/nginx.conf --net<span class="token operator">=</span>host --privileged nginx
</code></pre> </li><li> <p>配置双机热备</p> <pre><code class="prism language-shell"><span class="token comment">#进入ff1节点</span>
docker <span class="token function">exec</span> -it ff1 <span class="token function">bash</span>
<span class="token comment">#更新软件包</span>
<span class="token function">apt-get</span> update
<span class="token comment">#安装VIM</span>
<span class="token function">apt-get</span> <span class="token function">install</span> vim
<span class="token comment">#安装Keepalived</span>
<span class="token function">apt-get</span> <span class="token function">install</span> keepalived
<span class="token comment">#编辑Keepalived配置文件(如下)</span>
vim /etc/keepalived/keepalived.conf
<span class="token comment">#启动Keepalived</span>
<span class="token function">service</span> keepalived start
</code></pre> <pre><code class="prism language-shell">vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span>
    state MASTER
    interface ens33
    virtual_router_id 52
    priority 100
    advert_int 1
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type PASS
        auth_pass 123456
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
        192.168.99.152
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
virtual_server 192.168.99.151 6701 <span class="token punctuation">{<!-- --></span>
    delay_loop 3
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP
    real_server 192.168.99.104 6601 <span class="token punctuation">{<!-- --></span>
        weight 1
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-shell"><span class="token comment">#进入ff1节点</span>
docker <span class="token function">exec</span> -it ff2 <span class="token function">bash</span>
<span class="token comment">#更新软件包</span>
<span class="token function">apt-get</span> update
<span class="token comment">#安装VIM</span>
<span class="token function">apt-get</span> <span class="token function">install</span> vim
<span class="token comment">#安装Keepalived</span>
<span class="token function">apt-get</span> <span class="token function">install</span> keepalived
<span class="token comment">#编辑Keepalived配置文件(如下)</span>
vim /etc/keepalived/keepalived.conf
<span class="token comment">#启动Keepalived</span>
<span class="token function">service</span> keepalived start
</code></pre> <pre><code class="prism language-shell">vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span>
    state MASTER
    interface ens33
    virtual_router_id 52
    priority 100
    advert_int 1
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type PASS
        auth_pass 123456
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
        192.168.99.152
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
virtual_server 192.168.99.151 6701 <span class="token punctuation">{<!-- --></span>
    delay_loop 3
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP
    real_server 192.168.99.104 6602 <span class="token punctuation">{<!-- --></span>
        weight 1
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/42359d0464e160833f40364c920dc50b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LTE信令流程——去附着</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bf2e63a4d0219c260f29b6d9114e399b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">多值依赖 模式分解 （学习感想）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>