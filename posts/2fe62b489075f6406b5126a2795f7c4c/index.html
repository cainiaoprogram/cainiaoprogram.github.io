<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>（4.6.12）Android  Resource详解 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="（4.6.12）Android  Resource详解" />
<meta property="og:description" content="文章目录 一、构造函数1.1 成员变量1.2 构造函数1.3 提供功能1.3.1 getString(int id)、getIntArray(int id) 、getStringArray(int id)1.3.2 基于getValue的1.3.2.1 getDimension1.3.2.2 getDrawable1.3.2.2 getColor、getBoolean、getInteger1.3.2.3 loadXmlResourceParser加载getLayout、getAnimation、getXml 1.3.4 obtainTypedArray(@ArrayRes int id)1.3.5 getMovie(int id) 二、Resource的获取三、Resource的生成四、ResourceManager4.1 单例模式4.2 getTopLevelResources生成Resource 参考文献 Resource实例
Resource的实例保存在ContextImpl中，每次构建ContextImpl时，会从LoadedApk中拿到对应的ResourceLoadedapk中的getResource会有成员实例mResource，命中直接返回，没命中委托Activitythread—ResourceManager生成ResourceMamager里有map缓存，命中直接返回，没命中则先新建Assetmanager，再构建Resource实例 全局唯一性
mResources通过一系列的缓存或者成员实例引用，实现了全局唯一。如果通过打补丁的方式，会全局生效（small替换了resourcemanager中瓜缓存的resource的assetmanager，实现全局替换）。但是在插件化方案中，为了避免id冲突，有的使用的是替换法，那就是所有有缓存和成员实例的地方都要替换为我们自己的resource; 一、构造函数 Resource.java
1.1 成员变量 重要成员变量 AssetManager mAssets; 构建时需要传入 public class Resources { private static final LongSparseArray&lt;ConstantState&gt;[] sPreloadedDrawables; private static final LongSparseArray&lt;ConstantState&gt; sPreloadedColorDrawables = new LongSparseArray&lt;ConstantState&gt;(); private static final LongSparseArray&lt;ColorStateList&gt; sPreloadedColorStateLists = new LongSparseArray&lt;ColorStateList&gt;(); // Pool of TypedArrays targeted to this Resources object." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2fe62b489075f6406b5126a2795f7c4c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-28T12:22:54+08:00" />
<meta property="article:modified_time" content="2020-05-28T12:22:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">（4.6.12）Android  Resource详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_10" rel="nofollow">一、构造函数</a></li><li><ul><li><a href="#11__14" rel="nofollow">1.1 成员变量</a></li><li><a href="#12__73" rel="nofollow">1.2 构造函数</a></li><li><a href="#13__144" rel="nofollow">1.3 提供功能</a></li><li><ul><li><a href="#131__getStringint_idgetIntArrayint_id_getStringArrayint_id_150" rel="nofollow">1.3.1 getString(int id)、getIntArray(int id) 、getStringArray(int id)</a></li><li><a href="#132_getValue_191" rel="nofollow">1.3.2 基于getValue的</a></li><li><ul><li><a href="#1321_getDimension_204" rel="nofollow">1.3.2.1 getDimension</a></li><li><a href="#1322_getDrawable_222" rel="nofollow">1.3.2.2 getDrawable</a></li><li><a href="#1322_getColorgetBooleangetInteger_253" rel="nofollow">1.3.2.2 getColor、getBoolean、getInteger</a></li><li><a href="#1323_loadXmlResourceParsergetLayoutgetAnimationgetXml_316" rel="nofollow">1.3.2.3 loadXmlResourceParser加载getLayout、getAnimation、getXml</a></li></ul> 
    </li><li><a href="#134_obtainTypedArrayArrayRes_int_id_348" rel="nofollow">1.3.4 obtainTypedArray(@ArrayRes int id)</a></li><li><a href="#135__getMovieint_id_366" rel="nofollow">1.3.5 getMovie(int id)</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Resource_382" rel="nofollow">二、Resource的获取</a></li><li><a href="#Resource_415" rel="nofollow">三、Resource的生成</a></li><li><a href="#ResourceManager_463" rel="nofollow">四、ResourceManager</a></li><li><ul><li><a href="#41__465" rel="nofollow">4.1 单例模式</a></li><li><a href="#42_getTopLevelResourcesResource_481" rel="nofollow">4.2 getTopLevelResources生成Resource</a></li></ul> 
  </li><li><a href="#_652" rel="nofollow">参考文献</a></li></ul> 
</div> 
<p></p> 
<ul><li> <p>Resource实例</p> 
  <ol><li>Resource的实例保存在ContextImpl中，每次构建ContextImpl时，会从LoadedApk中拿到对应的Resource</li><li>Loadedapk中的getResource会有成员实例mResource，命中直接返回，没命中委托Activitythread—ResourceManager生成</li><li>ResourceMamager里有map缓存，命中直接返回，没命中则先新建Assetmanager，再构建Resource实例</li></ol> </li><li> <p>全局唯一性</p> 
  <ol><li>mResources通过一系列的缓存或者成员实例引用，实现了全局唯一。</li><li>如果通过打补丁的方式，会全局生效（small替换了resourcemanager中瓜缓存的resource的assetmanager，实现全局替换）。</li><li>但是在插件化方案中，为了避免id冲突，有的使用的是替换法，那就是所有有缓存和成员实例的地方都要替换为我们自己的resource;</li></ol> </li></ul> 
<h2><a id="_10"></a>一、构造函数</h2> 
<blockquote> 
 <p><a href="https://www.androidos.net.cn/android/5.0.1_r1/xref/frameworks/base/core/java/android/content/res/Resources.java" rel="nofollow">Resource.java</a></p> 
</blockquote> 
<h3><a id="11__14"></a>1.1 成员变量</h3> 
<ul><li>重要成员变量 
  <ul><li>AssetManager mAssets; 构建时需要传入</li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Resources</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> LongSparseArray<span class="token generics function"><span class="token punctuation">&lt;</span>ConstantState<span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> sPreloadedDrawables<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> LongSparseArray<span class="token generics function"><span class="token punctuation">&lt;</span>ConstantState<span class="token punctuation">&gt;</span></span> sPreloadedColorDrawables
            <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongSparseArray</span><span class="token generics function"><span class="token punctuation">&lt;</span>ConstantState<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> LongSparseArray<span class="token generics function"><span class="token punctuation">&lt;</span>ColorStateList<span class="token punctuation">&gt;</span></span> sPreloadedColorStateLists
            <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongSparseArray</span><span class="token generics function"><span class="token punctuation">&lt;</span>ColorStateList<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Pool of TypedArrays targeted to this Resources object.</span>
    <span class="token keyword">final</span> SynchronizedPool<span class="token generics function"><span class="token punctuation">&lt;</span>TypedArray<span class="token punctuation">&gt;</span></span> mTypedArrayPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedPool</span><span class="token generics function"><span class="token punctuation">&lt;</span>TypedArray<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Used by BridgeResources in layoutlib</span>
    <span class="token keyword">static</span> Resources mSystem <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> sPreloaded<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> sPreloadedDensity<span class="token punctuation">;</span>

    <span class="token comment">// These are protected by mAccessLock.</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Object mAccessLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Configuration mTmpConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> LongSparseArray<span class="token operator">&lt;</span>WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>ConstantState<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;&gt;</span> mDrawableCache <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> LongSparseArray<span class="token operator">&lt;</span>WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>ConstantState<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> LongSparseArray<span class="token operator">&lt;</span>WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>ConstantState<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;&gt;</span> mColorDrawableCache <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> LongSparseArray<span class="token operator">&lt;</span>WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>ConstantState<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> LongSparseArray<span class="token operator">&lt;</span>WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>ColorStateList<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> mColorStateListCache <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">LongSparseArray</span><span class="token operator">&lt;</span>WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>ColorStateList<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> TypedValue mTmpValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> mPreloading<span class="token punctuation">;</span>

    <span class="token keyword">private</span> TypedArray mCachedStyledAttributes <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> mLastCachedXmlBlockIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mCachedXmlBlockIds <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> XmlBlock<span class="token punctuation">[</span><span class="token punctuation">]</span> mCachedXmlBlocks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XmlBlock</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> AssetManager mAssets<span class="token punctuation">;</span>
    <span class="token keyword">final</span> DisplayMetrics mMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> Configuration mConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> NativePluralRules mPluralRule<span class="token punctuation">;</span>

    <span class="token keyword">private</span> CompatibilityInfo mCompatibilityInfo <span class="token operator">=</span> CompatibilityInfo<span class="token punctuation">.</span>DEFAULT_COMPATIBILITY_INFO<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unused"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>IBinder<span class="token punctuation">&gt;</span></span> mToken<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        sPreloadedDrawables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongSparseArray</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sPreloadedDrawables<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongSparseArray</span><span class="token generics function"><span class="token punctuation">&lt;</span>ConstantState<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sPreloadedDrawables<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongSparseArray</span><span class="token generics function"><span class="token punctuation">&lt;</span>ConstantState<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="12__73"></a>1.2 构造函数</h3> 
<ul><li>几种构造函数，主要是获取到了AssetManager</li></ul> 
<pre><code class="prism language-java">  <span class="token comment">/**
     * Create a new Resources object on top of an existing set of assets in an
     * AssetManager.
     * 
     * @param assets Previously created AssetManager. 
     * @param metrics Current display metrics to consider when 
     *                selecting/computing resource values.
     * @param config Desired device configuration to consider when 
     *               selecting/computing resource values (optional).
     */</span>
    <span class="token keyword">public</span> <span class="token function">Resources</span><span class="token punctuation">(</span>AssetManager assets<span class="token punctuation">,</span> DisplayMetrics metrics<span class="token punctuation">,</span> Configuration config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> metrics<span class="token punctuation">,</span> config<span class="token punctuation">,</span> CompatibilityInfo<span class="token punctuation">.</span>DEFAULT_COMPATIBILITY_INFO<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token comment">/**
     * Creates a new Resources object with CompatibilityInfo.
     * 
     * @param assets Previously created AssetManager. 
     * @param metrics Current display metrics to consider when 
     *                selecting/computing resource values.
     * @param config Desired device configuration to consider when 
     *               selecting/computing resource values (optional).
     * @param compatInfo this resource's compatibility info. Must not be null.
     * @param token The Activity token for determining stack affiliation. Usually null.
     * @hide
     */</span>
    <span class="token keyword">public</span> <span class="token function">Resources</span><span class="token punctuation">(</span>AssetManager assets<span class="token punctuation">,</span> DisplayMetrics metrics<span class="token punctuation">,</span> Configuration config<span class="token punctuation">,</span>
            CompatibilityInfo compatInfo<span class="token punctuation">,</span> IBinder token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mAssets <span class="token operator">=</span> assets<span class="token punctuation">;</span>
        mMetrics<span class="token punctuation">.</span><span class="token function">setToDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>compatInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mCompatibilityInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics function"><span class="token punctuation">&lt;</span>IBinder<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        assets<span class="token punctuation">.</span><span class="token function">ensureStringBlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return a global shared Resources object that provides access to only
     * system resources (no application resources), and is not configured for 
     * the current screen (can not use dimension units, does not change based 
     * on orientation, etc). 
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Resources <span class="token function">getSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sSync<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Resources ret <span class="token operator">=</span> mSystem<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mSystem <span class="token operator">=</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token function">Resources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mAssets <span class="token operator">=</span> AssetManager<span class="token punctuation">.</span><span class="token function">getSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// NOTE: Intentionally leaving this uninitialized (all values set</span>
        <span class="token comment">// to zero), so that anyone who tries to do something that requires</span>
        <span class="token comment">// metrics will get a very wrong value.</span>
        mConfiguration<span class="token punctuation">.</span><span class="token function">setToDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mMetrics<span class="token punctuation">.</span><span class="token function">setToDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateConfiguration</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mAssets<span class="token punctuation">.</span><span class="token function">ensureStringBlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="13__144"></a>1.3 提供功能</h3> 
<ul><li>getResources().getXXX只能用于获取应用本身的资源 
  <ul><li>Resources.getSystem() 可以在任何地方进行使用，但是有一个局限，只能获取系统本身的资源</li></ul> </li></ul> 
<p>其实就是利用AssetManager完成各种资源加载</p> 
<h4><a id="131__getStringint_idgetIntArrayint_id_getStringArrayint_id_150"></a>1.3.1 getString(int id)、getIntArray(int id) 、getStringArray(int id)</h4> 
<pre><code class="prism language-java">
  <span class="token keyword">public</span> String <span class="token function">getString</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        CharSequence res <span class="token operator">=</span> <span class="token function">getText</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">"String resource ID #0x"</span>
                                    <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">public</span> CharSequence <span class="token function">getText</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        CharSequence res <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">getResourceText</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">"String resource ID #0x"</span>
                                    <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">public</span> CharSequence <span class="token function">getText</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> CharSequence def<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        CharSequence res <span class="token operator">=</span> id <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">?</span> mAssets<span class="token punctuation">.</span><span class="token function">getResourceText</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">return</span> res <span class="token operator">!=</span> null <span class="token operator">?</span> res <span class="token operator">:</span> def<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token keyword">public</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> res <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">getResourceStringArray</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">"String array resource ID #0x"</span>
                                    <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getIntArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> res <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">getArrayIntResource</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">"Int array resource ID #0x"</span>
                                    <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="132_getValue_191"></a>1.3.2 基于getValue的</h4> 
<pre><code class="prism language-java">   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> TypedValue outValue<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolveRefs<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">boolean</span> found <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">getResourceValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> outValue<span class="token punctuation">,</span> resolveRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>found<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">"Resource ID #0x"</span>
                                    <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1321_getDimension_204"></a>1.3.2.1 getDimension</h5> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getDimension</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAccessLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TypedValue value <span class="token operator">=</span> mTmpValue<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mTmpValue <span class="token operator">=</span> value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">getValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>type <span class="token operator">==</span> TypedValue<span class="token punctuation">.</span>TYPE_DIMENSION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> TypedValue<span class="token punctuation">.</span><span class="token function">complexToDimension</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>data<span class="token punctuation">,</span> mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span>
                    <span class="token string">"Resource ID #0x"</span> <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" type #0x"</span>
                    <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1322_getDrawable_222"></a>1.3.2.2 getDrawable</h5> 
<pre><code class="prism language-java">	 <span class="token keyword">public</span> Drawable <span class="token function">getDrawable</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> Drawable d <span class="token operator">=</span> <span class="token function">getDrawable</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">canApplyTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Drawable "</span> <span class="token operator">+</span> <span class="token function">getResourceName</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" has unresolved theme "</span>
                    <span class="token operator">+</span> <span class="token string">"attributes! Consider using Resources.getDrawable(int, Theme) or "</span>
                    <span class="token operator">+</span> <span class="token string">"Context.getDrawable(int)."</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> d<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 <span class="token keyword">public</span> Drawable <span class="token function">getDrawable</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Theme theme<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        TypedValue value<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAccessLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            value <span class="token operator">=</span> mTmpValue<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                mTmpValue <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">getValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> Drawable res <span class="token operator">=</span> <span class="token function">loadDrawable</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> id<span class="token punctuation">,</span> theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAccessLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mTmpValue <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mTmpValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1322_getColorgetBooleangetInteger_253"></a>1.3.2.2 getColor、getBoolean、getInteger</h5> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        TypedValue value<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAccessLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            value <span class="token operator">=</span> mTmpValue<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">getValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>type <span class="token operator">&gt;=</span> TypedValue<span class="token punctuation">.</span>TYPE_FIRST_INT
                <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>type <span class="token operator">&lt;=</span> TypedValue<span class="token punctuation">.</span>TYPE_LAST_INT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mTmpValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
                <span class="token keyword">return</span> value<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>type <span class="token operator">!=</span> TypedValue<span class="token punctuation">.</span>TYPE_STRING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span>
                    <span class="token string">"Resource ID #0x"</span> <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" type #0x"</span>
                    <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mTmpValue <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ColorStateList csl <span class="token operator">=</span> <span class="token function">loadColorStateList</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAccessLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mTmpValue <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mTmpValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> csl<span class="token punctuation">.</span><span class="token function">getDefaultColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAccessLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TypedValue value <span class="token operator">=</span> mTmpValue<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mTmpValue <span class="token operator">=</span> value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">getValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>type <span class="token operator">&gt;=</span> TypedValue<span class="token punctuation">.</span>TYPE_FIRST_INT
                <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>type <span class="token operator">&lt;=</span> TypedValue<span class="token punctuation">.</span>TYPE_LAST_INT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> value<span class="token punctuation">.</span>data <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span>
                <span class="token string">"Resource ID #0x"</span> <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" type #0x"</span>
                <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
     <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAccessLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TypedValue value <span class="token operator">=</span> mTmpValue<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mTmpValue <span class="token operator">=</span> value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">getValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>type <span class="token operator">&gt;=</span> TypedValue<span class="token punctuation">.</span>TYPE_FIRST_INT
                <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>type <span class="token operator">&lt;=</span> TypedValue<span class="token punctuation">.</span>TYPE_LAST_INT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> value<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span>
                <span class="token string">"Resource ID #0x"</span> <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" type #0x"</span>
                <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1323_loadXmlResourceParsergetLayoutgetAnimationgetXml_316"></a>1.3.2.3 loadXmlResourceParser加载getLayout、getAnimation、getXml</h5> 
<pre><code class="prism language-java">	 <span class="token annotation punctuation">@NonNull</span>
    <span class="token keyword">public</span> XmlResourceParser <span class="token function">getLayout</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LayoutRes</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">"layout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token keyword">public</span> XmlResourceParser <span class="token function">getAnimation</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">"anim"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token keyword">public</span> XmlResourceParser <span class="token function">getXml</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">"xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 	XmlResourceParser <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> String type<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mAccessLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TypedValue value <span class="token operator">=</span> mTmpValue<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mTmpValue <span class="token operator">=</span> value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">getValue</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>type <span class="token operator">==</span> TypedValue<span class="token punctuation">.</span>TYPE_STRING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">loadXmlResourceParser</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>string<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
                        value<span class="token punctuation">.</span>assetCookie<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span>
                    <span class="token string">"Resource ID #0x"</span> <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" type #0x"</span>
                    <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="134_obtainTypedArrayArrayRes_int_id_348"></a>1.3.4 obtainTypedArray(@ArrayRes int id)</h4> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> TypedArray <span class="token function">obtainTypedArray</span><span class="token punctuation">(</span><span class="token annotation punctuation">@ArrayRes</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> len <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">getArraySize</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token string">"Array resource ID #0x"</span>
                                        <span class="token operator">+</span> Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        TypedArray array <span class="token operator">=</span> TypedArray<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        array<span class="token punctuation">.</span>mLength <span class="token operator">=</span> mAssets<span class="token punctuation">.</span><span class="token function">retrieveArray</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> array<span class="token punctuation">.</span>mData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        array<span class="token punctuation">.</span>mIndices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> array<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="135__getMovieint_id_366"></a>1.3.5 getMovie(int id)</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> Movie <span class="token function">getMovie</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> NotFoundException <span class="token punctuation">{<!-- --></span>
        InputStream is <span class="token operator">=</span> <span class="token function">openRawResource</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Movie movie <span class="token operator">=</span> Movie<span class="token punctuation">.</span><span class="token function">decodeStream</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            is<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// don't care, since the return value is valid</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> movie<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Resource_382"></a>二、Resource的获取</h2> 
<ul><li>Resource的实例保存在ContextImpl中，每次构建ContextImpl时会从LoadApk中拿到对应的resource 
  <ul><li>因此，getResources()用在有context的地方，没有context的地方和静态类中是不能用的</li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ContextImpl</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token function">ContextImpl</span><span class="token punctuation">(</span>ContextImpl container<span class="token punctuation">,</span> ActivityThread mainThread<span class="token punctuation">,</span>
	                            LoadedApk packageInfo<span class="token punctuation">,</span> IBinder activityToken<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
	                            Display display<span class="token punctuation">,</span> Configuration overrideConfiguration<span class="token punctuation">,</span> <span class="token keyword">int</span> createDisplayWithId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            mOuterContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	
		        mMainThread <span class="token operator">=</span> mainThread<span class="token punctuation">;</span>
		        mActivityToken <span class="token operator">=</span> activityToken<span class="token punctuation">;</span>
		        mRestricted <span class="token operator">=</span> restricted<span class="token punctuation">;</span>
		        
				mPackageInfo <span class="token operator">=</span> packageInfo<span class="token punctuation">;</span>
		        mResourcesManager <span class="token operator">=</span> ResourcesManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		        mDisplay <span class="token operator">=</span> display<span class="token punctuation">;</span>
		        
	            <span class="token comment">//...</span>
	            <span class="token comment">//从LoadApk创建Resources 实例</span>
	            Resources resources <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>mainThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token comment">//...</span>
	            mResources <span class="token operator">=</span> resources<span class="token punctuation">;</span>
	            <span class="token comment">//...</span>
	
				mContentResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContentResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mainThread<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Resource_415"></a>三、Resource的生成</h2> 
<p>我们看LoadedApk中的getResources(ActivityThread mainThread)</p> 
<ul><li>如果存在mResources则直接返回</li><li>没有话，调用ActivityThread#getTopLevelResources新建一个</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LoadedApk</span> <span class="token punctuation">{<!-- --></span>

	   <span class="token keyword">public</span> Resources <span class="token function">getResources</span><span class="token punctuation">(</span>ActivityThread mainThread<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mResources <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mResources <span class="token operator">=</span> mainThread<span class="token punctuation">.</span><span class="token function">getTopLevelResources</span><span class="token punctuation">(</span>mResDir<span class="token punctuation">,</span> mSplitResDirs<span class="token punctuation">,</span> mOverlayDirs<span class="token punctuation">,</span>
                    mApplicationInfo<span class="token punctuation">.</span>sharedLibraryFiles<span class="token punctuation">,</span> Display<span class="token punctuation">.</span>DEFAULT_DISPLAY<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mResources<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> AssetManager <span class="token function">getAssets</span><span class="token punctuation">(</span>ActivityThread mainThread<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getResources</span><span class="token punctuation">(</span>mainThread<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<ul><li>ActivityThread#getTopLevelResources</li></ul> 
<pre><code class="prism language-java">

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">/**
     * Creates the top level resources for the given package.
     */</span>
    Resources <span class="token function">getTopLevelResources</span><span class="token punctuation">(</span>String resDir<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitResDirs<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> overlayDirs<span class="token punctuation">,</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> libDirs<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span> Configuration overrideConfiguration<span class="token punctuation">,</span>
            LoadedApk pkgInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mResourcesManager<span class="token punctuation">.</span><span class="token function">getTopLevelResources</span><span class="token punctuation">(</span>resDir<span class="token punctuation">,</span> splitResDirs<span class="token punctuation">,</span> overlayDirs<span class="token punctuation">,</span> libDirs<span class="token punctuation">,</span>
                displayId<span class="token punctuation">,</span> overrideConfiguration<span class="token punctuation">,</span> pkgInfo<span class="token punctuation">.</span><span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

 <span class="token function">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mResourcesManager <span class="token operator">=</span> ResourcesManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最终还是使用了mResourcesManager去新建</p> 
<h2><a id="ResourceManager_463"></a>四、ResourceManager</h2> 
<h3><a id="41__465"></a>4.1 单例模式</h3> 
<pre><code class="prism language-java">
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ResourceManager</span> <span class="token punctuation">{<!-- --></span>
 	<span class="token keyword">private</span> <span class="token function">ResourceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> ResourceManager sThis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token keyword">public</span> <span class="token keyword">static</span> ResourceManager <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> sThis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="42_getTopLevelResourcesResource_481"></a>4.2 getTopLevelResources生成Resource</h3> 
<ul><li>持有一个Map缓存实例mActiveResources</li><li>getTopLevelResources 
  <ul><li>基于传入的资源地址构建ResourcesKey</li><li>判断mActiveResources是否有对应缓存 
    <ul><li>有的话直接返回</li><li>没有的话，新建一个 
      <ul><li>新建AssetManager实例 assets = new AssetManager();</li><li>遍历资源目录列表，调用 
        <ul><li>String resDir： assets.addAssetPath(resDir)</li><li>String[] splitResDirs：assets.addAssetPath(splitResDir)</li><li>String[] overlayDirs：assets.addOverlayPath(idmapPath);</li><li>String[] libDirs：assets.addAssetPath(libDir)</li></ul> </li><li>构建DisplayMetrics、Configuration</li><li>调用构造函数，新建r = new Resources(assets, dm, config, compatInfo, token);</li><li>存入mActiveResources缓存</li></ul> </li></ul> </li></ul> </li></ul> 
<pre><code class="prism language-java">
   <span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>ResourcesKey<span class="token punctuation">,</span> WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>Resources<span class="token punctuation">&gt;</span></span> <span class="token operator">&gt;</span> mActiveResources
            <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>ResourcesKey<span class="token punctuation">,</span> WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>Resources<span class="token punctuation">&gt;</span></span> <span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> Resources <span class="token function">getTopLevelResources</span><span class="token punctuation">(</span>String resDir<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitResDirs<span class="token punctuation">,</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> overlayDirs<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> libDirs<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span>
            Configuration overrideConfiguration<span class="token punctuation">,</span> CompatibilityInfo compatInfo<span class="token punctuation">,</span> IBinder token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">float</span> scale <span class="token operator">=</span> compatInfo<span class="token punctuation">.</span>applicationScale<span class="token punctuation">;</span>
        ResourcesKey key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourcesKey</span><span class="token punctuation">(</span>resDir<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span> overrideConfiguration<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Resources r<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Resources is app scale dependent.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"getTopLevelResources: "</span> <span class="token operator">+</span> resDir <span class="token operator">+</span> <span class="token string">" / "</span> <span class="token operator">+</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>Resources<span class="token punctuation">&gt;</span></span> wr <span class="token operator">=</span> mActiveResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r <span class="token operator">=</span> wr <span class="token operator">!=</span> null <span class="token operator">?</span> wr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token comment">//if (r != null) Slog.i(TAG, "isUpToDate " + resDir + ": " + r.getAssets().isUpToDate());</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUpToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Returning cached resources "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> resDir
                            <span class="token operator">+</span> <span class="token string">": appScale="</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>applicationScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//if (r != null) {<!-- --></span>
        <span class="token comment">//    Slog.w(TAG, "Throwing away out-of-date resources!!!! "</span>
        <span class="token comment">//            + r + " " + resDir);</span>
        <span class="token comment">//}</span>

        AssetManager assets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// resDir can be null if the 'android' package is creating a new Resources object.</span>
        <span class="token comment">// This is fine, since each AssetManager automatically loads the 'android' package</span>
        <span class="token comment">// already.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resDir <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>assets<span class="token punctuation">.</span><span class="token function">addAssetPath</span><span class="token punctuation">(</span>resDir<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>splitResDirs <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String splitResDir <span class="token operator">:</span> splitResDirs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>assets<span class="token punctuation">.</span><span class="token function">addAssetPath</span><span class="token punctuation">(</span>splitResDir<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>overlayDirs <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String idmapPath <span class="token operator">:</span> overlayDirs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                assets<span class="token punctuation">.</span><span class="token function">addOverlayPath</span><span class="token punctuation">(</span>idmapPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>libDirs <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String libDir <span class="token operator">:</span> libDirs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>assets<span class="token punctuation">.</span><span class="token function">addAssetPath</span><span class="token punctuation">(</span>libDir<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Asset path '"</span> <span class="token operator">+</span> libDir <span class="token operator">+</span>
                            <span class="token string">"' does not exist or contains no resources."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//Slog.i(TAG, "Resource: key=" + key + ", display metrics=" + metrics);</span>
        DisplayMetrics dm <span class="token operator">=</span> <span class="token function">getDisplayMetricsLocked</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Configuration config<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isDefaultDisplay <span class="token operator">=</span> <span class="token punctuation">(</span>displayId <span class="token operator">==</span> Display<span class="token punctuation">.</span>DEFAULT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasOverrideConfig <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hasOverrideConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDefaultDisplay <span class="token operator">||</span> hasOverrideConfig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDefaultDisplay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">applyNonDefaultDisplayMetricsToConfigurationLocked</span><span class="token punctuation">(</span>dm<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasOverrideConfig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                config<span class="token punctuation">.</span><span class="token function">updateFrom</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>mOverrideConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            config <span class="token operator">=</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> dm<span class="token punctuation">,</span> config<span class="token punctuation">,</span> compatInfo<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Created app resources "</span> <span class="token operator">+</span> resDir <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">": "</span>
                    <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" appScale="</span>
                    <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>applicationScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            WeakReference<span class="token generics function"><span class="token punctuation">&lt;</span>Resources<span class="token punctuation">&gt;</span></span> wr <span class="token operator">=</span> mActiveResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Resources existing <span class="token operator">=</span> wr <span class="token operator">!=</span> null <span class="token operator">?</span> wr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>existing <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> existing<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUpToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Someone else already created the resources while we were</span>
                <span class="token comment">// unlocked; go ahead and use theirs.</span>
                r<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> existing<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// XXX need to remove entries when weak references go away</span>
            mActiveResources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics function"><span class="token punctuation">&lt;</span>Resources<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

 <span class="token keyword">public</span> DisplayMetrics <span class="token function">getDisplayMetricsLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> displayId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getDisplayMetricsLocked</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> DisplayAdjustments<span class="token punctuation">.</span>DEFAULT_DISPLAY_ADJUSTMENTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> DisplayMetrics <span class="token function">getDisplayMetricsLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> displayId<span class="token punctuation">,</span> DisplayAdjustments daj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">boolean</span> isDefaultDisplay <span class="token operator">=</span> <span class="token punctuation">(</span>displayId <span class="token operator">==</span> Display<span class="token punctuation">.</span>DEFAULT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        DisplayMetrics dm <span class="token operator">=</span> isDefaultDisplay <span class="token operator">?</span> mDefaultDisplayMetrics<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>daj<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> dm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        DisplayManagerGlobal displayManager <span class="token operator">=</span> DisplayManagerGlobal<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>displayManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// may be null early in system startup</span>
            dm<span class="token punctuation">.</span><span class="token function">setToDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> dm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDefaultDisplay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mDefaultDisplayMetrics<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>daj<span class="token punctuation">,</span> dm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Display d <span class="token operator">=</span> displayManager<span class="token punctuation">.</span><span class="token function">getCompatibleDisplay</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> daj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            d<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span>dm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Display no longer exists</span>
            <span class="token comment">// FIXME: This would not be a problem if we kept the Display object around</span>
            <span class="token comment">// instead of using the raw display id everywhere.  The Display object caches</span>
            <span class="token comment">// its information even after the display has been removed.</span>
            dm<span class="token punctuation">.</span><span class="token function">setToDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//Slog.i("foo", "New metrics: w=" + metrics.widthPixels + " h="</span>
        <span class="token comment">//        + metrics.heightPixels + " den=" + metrics.density</span>
        <span class="token comment">//        + " xdpi=" + metrics.xdpi + " ydpi=" + metrics.ydpi);</span>
        <span class="token keyword">return</span> dm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">public</span> Configuration <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mResConfiguration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><a href="https://www.androidos.net.cn/android/5.0.1_r1/xref/sdk/eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/manager/ResourceManager.java" rel="nofollow">ResourceManager.java</a></p> 
</blockquote> 
<h2><a id="_652"></a>参考文献</h2> 
<ul><li><a href="https://segmentfault.com/a/1190000013048236" rel="nofollow">Android资源访问机制–getResource()</a></li><li><a href="https://blog.csdn.net/qq_29318359/article/details/79455928">Android插件化之-Resource Hook</a></li><li><a href="https://www.jianshu.com/p/b9f914118bb1" rel="nofollow">Android 源码分析Resource加载，实现换肤</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2e6d872a573e88b241e5b34b416f58ab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">人脸识别损失函数之Center Loss</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/add35d1954b965753b01bbbc4b975042/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">常用巡检命令1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>