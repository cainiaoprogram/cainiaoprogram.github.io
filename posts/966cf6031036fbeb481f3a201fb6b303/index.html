<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mmdetection中的dataset - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mmdetection中的dataset" />
<meta property="og:description" content="TOV_mmdetection中的dataset 1、train.py2、build_dataset ; mmdet/datasets/builder.py3、build_from_cfg ; mmcv/utils/registry.py4、CocoFmtDataset.init ; mmdet/datasets/cocofmt.pyCocoFmtDataset.init：CustomDataset.init：一、首先将相关参数保存到属性中，值得注意的是这里的self是CocoFmtDataset。二、调用get_classes方法获取类别列表。三、拼接文件路径，这里访问文件使用的路径都是绝对路径。四、调用load_annotations方法加载标注文件中的图片信息，并将该信息存放在属性self.data_infos中。五、给self.proposal_file赋值六、过滤掉所占像素过小的标签和没有标签的图片 pipelineLoadImageFromFileLoadAnnotations_load_bboxes_load_labels ResizeRandomFlipNormalizePadDefaultFormatBundleCollect 结束 1、train.py datasets = [build_dataset(cfg.data.train)] train.py中使用上述代码实例化一个dataset。其中传入的参数如下：
2、build_dataset ; mmdet/datasets/builder.py 调用build_from_cfg()方法。其中DATASETS是提前注册好的注册库。
def build_dataset(cfg, default_args=None): from .dataset_wrappers import (ConcatDataset, RepeatDataset, ClassBalancedDataset) if isinstance(cfg, (list, tuple)): dataset = ConcatDataset([build_dataset(c, default_args) for c in cfg]) elif cfg[&#39;type&#39;] == &#39;ConcatDataset&#39;: dataset = ConcatDataset( [build_dataset(c, default_args) for c in cfg[&#39;datasets&#39;]], cfg.get(&#39;separate_eval&#39;, True)) elif cfg[&#39;type&#39;] == &#39;RepeatDataset&#39;: dataset = RepeatDataset( build_dataset(cfg[&#39;dataset&#39;], default_args), cfg[&#39;times&#39;]) elif cfg[&#39;type&#39;] == &#39;ClassBalancedDataset&#39;: dataset = ClassBalancedDataset( build_dataset(cfg[&#39;dataset&#39;], default_args), cfg[&#39;oversample_thr&#39;]) elif isinstance(cfg." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/966cf6031036fbeb481f3a201fb6b303/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-28T21:17:20+08:00" />
<meta property="article:modified_time" content="2021-11-28T21:17:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mmdetection中的dataset</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>TOV_mmdetection中的dataset</h4> 
 <ul><li><a href="#1trainpy_2" rel="nofollow">1、train.py</a></li><li><a href="#2build_dataset__mmdetdatasetsbuilderpy_10" rel="nofollow">2、build_dataset ; mmdet/datasets/builder.py</a></li><li><a href="#3build_from_cfg__mmcvutilsregistrypy_36" rel="nofollow">3、build_from_cfg ; mmcv/utils/registry.py</a></li><li><a href="#4CocoFmtDatasetinit__mmdetdatasetscocofmtpy_90" rel="nofollow">4、CocoFmtDataset.init ; mmdet/datasets/cocofmt.py</a></li><li><ul><li><a href="#CocoFmtDatasetinit_102" rel="nofollow">CocoFmtDataset.init：</a></li><li><a href="#CustomDatasetinit_142" rel="nofollow">CustomDataset.init：</a></li><li><ul><li><a href="#selfCocoFmtDataset_145" rel="nofollow">一、首先将相关参数保存到属性中，值得注意的是这里的self是CocoFmtDataset。</a></li><li><a href="#get_classes_167" rel="nofollow">二、调用get_classes方法获取类别列表。</a></li><li><a href="#_199" rel="nofollow">三、拼接文件路径，这里访问文件使用的路径都是绝对路径。</a></li><li><a href="#load_annotationsselfdata_infos_214" rel="nofollow">四、调用load_annotations方法加载标注文件中的图片信息，并将该信息存放在属性self.data_infos中。</a></li><li><a href="#selfproposal_file_265" rel="nofollow">五、给self.proposal_file赋值</a></li><li><a href="#_276" rel="nofollow">六、过滤掉所占像素过小的标签和没有标签的图片</a></li></ul> 
  </li></ul> 
  </li><li><a href="#pipeline_361" rel="nofollow">pipeline</a></li><li><ul><li><a href="#LoadImageFromFile_362" rel="nofollow">LoadImageFromFile</a></li><li><a href="#LoadAnnotations_463" rel="nofollow">LoadAnnotations</a></li><li><ul><li><a href="#_load_bboxes_497" rel="nofollow">_load_bboxes</a></li><li><a href="#_load_labels_500" rel="nofollow">_load_labels</a></li></ul> 
   </li><li><a href="#Resize_506" rel="nofollow">Resize</a></li><li><a href="#RandomFlip_515" rel="nofollow">RandomFlip</a></li><li><a href="#Normalize_518" rel="nofollow">Normalize</a></li><li><a href="#Pad_521" rel="nofollow">Pad</a></li><li><a href="#DefaultFormatBundle_524" rel="nofollow">DefaultFormatBundle</a></li><li><a href="#Collect_527" rel="nofollow">Collect</a></li></ul> 
  </li><li><a href="#_532" rel="nofollow">结束</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1trainpy_2"></a>1、train.py</h2> 
<pre><code class="prism language-python">datasets <span class="token operator">=</span> <span class="token punctuation">[</span>build_dataset<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>train<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<p>train.py中使用上述代码实例化一个dataset。其中传入的参数如下：<br> <img src="https://images2.imgbox.com/1a/b8/pjZwnRtn_o.png" alt="数据集配置文件"></p> 
<h2><a id="2build_dataset__mmdetdatasetsbuilderpy_10"></a>2、build_dataset ; mmdet/datasets/builder.py</h2> 
<p>调用build_from_cfg()方法。其中DATASETS是提前注册好的注册库。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">build_dataset</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> default_args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> <span class="token punctuation">.</span>dataset_wrappers <span class="token keyword">import</span> <span class="token punctuation">(</span>ConcatDataset<span class="token punctuation">,</span> RepeatDataset<span class="token punctuation">,</span>
                                   ClassBalancedDataset<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> ConcatDataset<span class="token punctuation">(</span><span class="token punctuation">[</span>build_dataset<span class="token punctuation">(</span>c<span class="token punctuation">,</span> default_args<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> cfg<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> cfg<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'ConcatDataset'</span><span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> ConcatDataset<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>build_dataset<span class="token punctuation">(</span>c<span class="token punctuation">,</span> default_args<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> cfg<span class="token punctuation">[</span><span class="token string">'datasets'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'separate_eval'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> cfg<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'RepeatDataset'</span><span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> RepeatDataset<span class="token punctuation">(</span>
            build_dataset<span class="token punctuation">(</span>cfg<span class="token punctuation">[</span><span class="token string">'dataset'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> default_args<span class="token punctuation">)</span><span class="token punctuation">,</span> cfg<span class="token punctuation">[</span><span class="token string">'times'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> cfg<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'ClassBalancedDataset'</span><span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> ClassBalancedDataset<span class="token punctuation">(</span>
            build_dataset<span class="token punctuation">(</span>cfg<span class="token punctuation">[</span><span class="token string">'dataset'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> default_args<span class="token punctuation">)</span><span class="token punctuation">,</span> cfg<span class="token punctuation">[</span><span class="token string">'oversample_thr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'ann_file'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> _concat_dataset<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> default_args<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> build_from_cfg<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> DATASETS<span class="token punctuation">,</span> default_args<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="3build_from_cfg__mmcvutilsregistrypy_36"></a>3、build_from_cfg ; mmcv/utils/registry.py</h2> 
<p>从注册库中挑选相应的类(type)，然后根据cfg中的参数实例化。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">build_from_cfg</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> registry<span class="token punctuation">,</span> default_args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Build a module from config dict.

    Args:
        cfg (dict): Config dict. It should at least contain the key "type".
        registry (:obj:`Registry`): The registry to search the type from.
        default_args (dict, optional): Default initialization arguments.

    Returns:
        object: The constructed object.
    """</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'cfg must be a dict, but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'type'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> cfg<span class="token punctuation">:</span>
        <span class="token keyword">if</span> default_args <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> <span class="token string">'type'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> default_args<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span>
                <span class="token string">'`cfg` or `default_args` must contain the key "type", '</span>
                <span class="token string-interpolation"><span class="token string">f'but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cfg<span class="token punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>default_args<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> Registry<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'registry must be an mmcv.Registry object, '</span>
                        <span class="token string-interpolation"><span class="token string">f'but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>default_args<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">or</span> default_args <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'default_args must be a dict or None, '</span>
                        <span class="token string-interpolation"><span class="token string">f'but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>default_args<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    args <span class="token operator">=</span> cfg<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> default_args <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> value <span class="token keyword">in</span> default_args<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            args<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>

    obj_type <span class="token operator">=</span> args<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj_type<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        obj_cls <span class="token operator">=</span> registry<span class="token punctuation">.</span>get<span class="token punctuation">(</span>obj_type<span class="token punctuation">)</span>
        <span class="token keyword">if</span> obj_cls <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>obj_type<span class="token punctuation">}</span></span><span class="token string"> is not in the </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>registry<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string"> registry'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> inspect<span class="token punctuation">.</span>isclass<span class="token punctuation">(</span>obj_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
        obj_cls <span class="token operator">=</span> obj_type
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f'type must be a str or valid type, but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>obj_type<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> obj_cls<span class="token punctuation">(</span><span class="token operator">**</span>args<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># Normal TypeError does not print class name.</span>
        <span class="token keyword">raise</span> <span class="token builtin">type</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>obj_cls<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="4CocoFmtDatasetinit__mmdetdatasetscocofmtpy_90"></a>4、CocoFmtDataset.init ; mmdet/datasets/cocofmt.py</h2> 
<p>根据传入的type参数跳转到相应的初始化方法。这里我们传入的是CocoFmtDataset。具体传入的参数如步骤一。这部分初始化过程比较复杂，传入init方法的参数如下图：<br> <img src="https://images2.imgbox.com/d7/69/k2TRyaj5_o.png" alt="在这里插入图片描述">可以发现这里只是将除了type之外的所有参数传入名字叫做type的这个类的init方法。</p> 
<p>先搞清楚CocoFmtDataset这个类的继承关系：</p> 
<ol><li>CocoFmtDataset继承CocoDataset；</li><li>CocoDataset继承CustomDataset；</li><li>CustomDataset继承Dataset。</li></ol> 
<p>有很对方法被重写，这里一定要先搞清楚各个类的关系。<br> 其中Dataset是torch.utils.data中的类，我们暂且不做研究。</p> 
<h3><a id="CocoFmtDatasetinit_102"></a>CocoFmtDataset.init：</h3> 
<ol><li>给self.train_ignore_as_bg 和 self.merge_after_infer_kwargs 两个变量赋值。都是默认的参数。</li><li>调用父类的父类CustomDataset的init方法。</li></ol> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 ann_file<span class="token punctuation">,</span>
                 data_root<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 corner_kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 train_ignore_as_bg<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                 noise_kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 merge_after_infer_kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># add by hui, if there is not corner dataset, create one</span>
        <span class="token keyword">if</span> corner_kwargs <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> ann_file<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.json'</span><span class="token punctuation">,</span> <span class="token string">"ann_file must be a json file."</span>
            ann_file <span class="token operator">=</span> generate_corner_json_file_if_not_exist<span class="token punctuation">(</span>ann_file<span class="token punctuation">,</span> data_root<span class="token punctuation">,</span> corner_kwargs<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"load corner dataset json file from {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ann_file<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> noise_kwargs <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token string">'pseudo_wh'</span> <span class="token keyword">in</span> noise_kwargs <span class="token keyword">and</span> noise_kwargs<span class="token punctuation">[</span><span class="token string">'pseudo_wh'</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                ann_file <span class="token operator">=</span> generate_pesudo_bbox_for_noise_data<span class="token punctuation">(</span>ann_file<span class="token punctuation">,</span> data_root<span class="token punctuation">,</span> noise_kwargs<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> <span class="token string">'wh_suffix'</span> <span class="token keyword">in</span> noise_kwargs<span class="token punctuation">:</span>
                <span class="token keyword">from</span> <span class="token punctuation">.</span>noise_data_utils <span class="token keyword">import</span> get_new_json_file_path
                ann_file<span class="token punctuation">,</span> _ <span class="token operator">=</span> get_new_json_file_path<span class="token punctuation">(</span>ann_file<span class="token punctuation">,</span> data_root<span class="token punctuation">,</span> noise_kwargs<span class="token punctuation">[</span><span class="token string">'sub_dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                     noise_kwargs<span class="token punctuation">[</span><span class="token string">'wh_suffix'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'one of [pseudo_wh, wh_suffix] must be given'</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"load noise dataset json file from {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ann_file<span class="token punctuation">)</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>train_ignore_as_bg <span class="token operator">=</span> train_ignore_as_bg
        self<span class="token punctuation">.</span>merge_after_infer_kwargs <span class="token operator">=</span> merge_after_infer_kwargs

        <span class="token builtin">super</span><span class="token punctuation">(</span>CocoFmtDataset<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>
            ann_file<span class="token punctuation">,</span>
            data_root<span class="token operator">=</span>data_root<span class="token punctuation">,</span>
            <span class="token operator">**</span>kwargs
        <span class="token punctuation">)</span>
</code></pre> 
<h3><a id="CustomDatasetinit_142"></a>CustomDataset.init：</h3> 
<p>由于CocoDataset没有初始化方法，这里跳转到CustomDataset.init。传入的参数依旧是cfg中的参数。</p> 
<h4><a id="selfCocoFmtDataset_145"></a>一、首先将相关参数保存到属性中，值得注意的是这里的self是CocoFmtDataset。</h4> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 ann_file<span class="token punctuation">,</span>
                 pipeline<span class="token punctuation">,</span>
                 classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 data_root<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 img_prefix<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>
                 seg_prefix<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 proposal_file<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 test_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 filter_empty_gt<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ann_file <span class="token operator">=</span> ann_file
        self<span class="token punctuation">.</span>data_root <span class="token operator">=</span> data_root
        self<span class="token punctuation">.</span>img_prefix <span class="token operator">=</span> img_prefix
        self<span class="token punctuation">.</span>seg_prefix <span class="token operator">=</span> seg_prefix
        self<span class="token punctuation">.</span>proposal_file <span class="token operator">=</span> proposal_file
        self<span class="token punctuation">.</span>test_mode <span class="token operator">=</span> test_mode
        self<span class="token punctuation">.</span>filter_empty_gt <span class="token operator">=</span> filter_empty_gt
</code></pre> 
<h4><a id="get_classes_167"></a>二、调用get_classes方法获取类别列表。</h4> 
<p>此时的self.CLASS=None，因为cfg配置文件中并没有设置类别名称。</p> 
<pre><code class="prism language-python">self<span class="token punctuation">.</span>CLASSES <span class="token operator">=</span> self<span class="token punctuation">.</span>get_classes<span class="token punctuation">(</span>classes<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_classes</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Get class names of current dataset.
        Args:
            classes (Sequence[str] | str | None): If classes is None, use
                default CLASSES defined by builtin dataset. If classes is a
                string, take it as a file name. The file contains the name of
                classes where each line contains one class name. If classes is
                a tuple or list, override the CLASSES defined by the dataset.

        Returns:
            tuple[str] or list[str]: Names of categories of the dataset.
        """</span>
        <span class="token keyword">if</span> classes <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> cls<span class="token punctuation">.</span>CLASSES
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>classes<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># take it as a file path</span>
            class_names <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>list_from_file<span class="token punctuation">(</span>classes<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>classes<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            class_names <span class="token operator">=</span> classes
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Unsupported type </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> of classes.'</span></span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> class_names
</code></pre> 
<h4><a id="_199"></a>三、拼接文件路径，这里访问文件使用的路径都是绝对路径。</h4> 
<p>由于我们传入的都是绝对路径，所以这里不需要拼接。self.data_root也是默认的None.</p> 
<pre><code class="prism language-python">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>data_root <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> osp<span class="token punctuation">.</span>isabs<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ann_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>ann_file <span class="token operator">=</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_root<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ann_file<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_prefix <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> osp<span class="token punctuation">.</span>isabs<span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_prefix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>img_prefix <span class="token operator">=</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_root<span class="token punctuation">,</span> self<span class="token punctuation">.</span>img_prefix<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>seg_prefix <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> osp<span class="token punctuation">.</span>isabs<span class="token punctuation">(</span>self<span class="token punctuation">.</span>seg_prefix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>seg_prefix <span class="token operator">=</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_root<span class="token punctuation">,</span> self<span class="token punctuation">.</span>seg_prefix<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>proposal_file <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> osp<span class="token punctuation">.</span>isabs<span class="token punctuation">(</span>self<span class="token punctuation">.</span>proposal_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>proposal_file <span class="token operator">=</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_root<span class="token punctuation">,</span>self<span class="token punctuation">.</span>proposal_file<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="load_annotationsselfdata_infos_214"></a>四、调用load_annotations方法加载标注文件中的图片信息，并将该信息存放在属性self.data_infos中。</h4> 
<p>这个地方就要好好记录一下：</p> 
<ol><li>根据标注文件路径实例化一个COCO类；</li><li>使用标签中的类别信息给self.CLASS赋值；</li><li>给self.cat_ids赋值，该属性记录类别编号，我们的数据集只有一个类别，这里self.cat_ids=[1]；</li><li>给self.cat2label赋值，该属性记录类别标号的位置，这里self.cat2label={1:0}；</li><li>获得所有的图片编号并存入self.img_ids中；</li><li>遍历所有图片信息，给每个图片信息新加一个filename=file_name字典，并检查该标注文件的标签和图片能否对应起来。</li><li>最后返回整理好的图片信息。</li></ol> 
<p>所以这里的load_annotations并不是仅仅返回图片的信息，它还给实例化的CocoFmtDataset类添加了很多的属性，并且检查了标注数据是否有问题。</p> 
<pre><code class="prism language-python">self<span class="token punctuation">.</span>data_infos <span class="token operator">=</span> self<span class="token punctuation">.</span>load_annotations<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ann_file<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">load_annotations</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ann_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Load annotation from COCO style annotation file.

        Args:
            ann_file (str): Path of annotation file.

        Returns:
            list[dict]: Annotation info from COCO api.
        """</span>

        self<span class="token punctuation">.</span>coco <span class="token operator">=</span> COCO<span class="token punctuation">(</span>ann_file<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>CLASSES <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>CLASSES <span class="token operator">=</span> <span class="token punctuation">[</span>cat<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> cat <span class="token keyword">in</span> self<span class="token punctuation">.</span>coco<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># add by hui</span>
        <span class="token comment"># The order of returned `cat_ids` will not</span>
        <span class="token comment"># change with the order of the CLASSES</span>
        self<span class="token punctuation">.</span>cat_ids <span class="token operator">=</span> self<span class="token punctuation">.</span>coco<span class="token punctuation">.</span>get_cat_ids<span class="token punctuation">(</span>cat_names<span class="token operator">=</span>self<span class="token punctuation">.</span>CLASSES<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>cat2label <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>cat_id<span class="token punctuation">:</span> i <span class="token keyword">for</span> i<span class="token punctuation">,</span> cat_id <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cat_ids<span class="token punctuation">)</span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>img_ids <span class="token operator">=</span> self<span class="token punctuation">.</span>coco<span class="token punctuation">.</span>get_img_ids<span class="token punctuation">(</span><span class="token punctuation">)</span>
        data_infos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        total_ann_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>img_ids<span class="token punctuation">:</span>
            info <span class="token operator">=</span> self<span class="token punctuation">.</span>coco<span class="token punctuation">.</span>load_imgs<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            info<span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span> <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token string">'file_name'</span><span class="token punctuation">]</span>
            data_infos<span class="token punctuation">.</span>append<span class="token punctuation">(</span>info<span class="token punctuation">)</span>
            ann_ids <span class="token operator">=</span> self<span class="token punctuation">.</span>coco<span class="token punctuation">.</span>get_ann_ids<span class="token punctuation">(</span>img_ids<span class="token operator">=</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            total_ann_ids<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>ann_ids<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>total_ann_ids<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>
            total_ann_ids<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"Annotation ids in '</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ann_file<span class="token punctuation">}</span></span><span class="token string">' are not unique!"</span></span>
        <span class="token keyword">return</span> data_infos
</code></pre> 
<h4><a id="selfproposal_file_265"></a>五、给self.proposal_file赋值</h4> 
<p>这个暂时不知道他的功能，本人使用时self.proposal_file=None</p> 
<pre><code class="prism language-python">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>proposal_file <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>proposals <span class="token operator">=</span> self<span class="token punctuation">.</span>load_proposals<span class="token punctuation">(</span>self<span class="token punctuation">.</span>proposal_file<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>proposals <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre> 
<h4><a id="_276"></a>六、过滤掉所占像素过小的标签和没有标签的图片</h4> 
<p>这个过程也比较复杂，我们看看源码是如何操作的。</p> 
<pre><code class="prism language-python">        <span class="token keyword">if</span> <span class="token keyword">not</span> test_mode<span class="token punctuation">:</span>
            valid_inds <span class="token operator">=</span> self<span class="token punctuation">.</span>_filter_imgs<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>data_infos <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>data_infos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> valid_inds<span class="token punctuation">]</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>proposals <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>proposals <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>proposals<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> valid_inds<span class="token punctuation">]</span>
            <span class="token comment"># set group flag for the sampler</span>
            self<span class="token punctuation">.</span>_set_group_flag<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>1、首先检查是否是测试，在测试过程中就不能过滤掉这些信息。<br> 2、调用_self.filter_imgs方法，获取图片列表中符合要求的索引，该方法在CocoFmtDataset中被重写。</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">_filter_imgs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> min_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        valid_inds <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>CocoFmtDataset<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>_filter_imgs<span class="token punctuation">(</span>min_size<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"valid image count: "</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>valid_inds<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># add by hui</span>
        <span class="token keyword">return</span> valid_inds
</code></pre> 
<p>这里也是添加一个默认参数min_size=32后直接调用父类（CocoDataset）的_filter_imgs方法。<br> 下面是CocoDataset._filter_imgs方法的实现源码：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">_filter_imgs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> min_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Filter images too small or without ground truths."""</span>
        valid_inds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># obtain images that contain annotation</span>
        ids_with_ann <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>_<span class="token punctuation">[</span><span class="token string">'image_id'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> self<span class="token punctuation">.</span>coco<span class="token punctuation">.</span>anns<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># obtain images that contain annotations of the required categories</span>
        ids_in_cat <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> class_id <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cat_ids<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ids_in_cat <span class="token operator">|</span><span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>coco<span class="token punctuation">.</span>cat_img_map<span class="token punctuation">[</span>class_id<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># merge the image id sets of the two conditions and use the merged set</span>
        <span class="token comment"># to filter out images if self.filter_empty_gt=True</span>
        ids_in_cat <span class="token operator">&amp;</span><span class="token operator">=</span> ids_with_ann

        valid_img_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> img_info <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_infos<span class="token punctuation">)</span><span class="token punctuation">:</span>
            img_id <span class="token operator">=</span> self<span class="token punctuation">.</span>img_ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>filter_empty_gt <span class="token keyword">and</span> img_id <span class="token keyword">not</span> <span class="token keyword">in</span> ids_in_cat<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> <span class="token builtin">min</span><span class="token punctuation">(</span>img_info<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img_info<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> min_size<span class="token punctuation">:</span>
                valid_inds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                valid_img_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img_id<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>img_ids <span class="token operator">=</span> valid_img_ids
        <span class="token keyword">return</span> valid_inds
</code></pre> 
<p>这个方法的操作流程：</p> 
<ol><li>获取所有存在标签的图片编号；</li><li>获取所有带有标签的图片编号，且这些标签都有类别；</li><li>将上面的两个set合并，表示所有有标签的图片编号；</li><li>遍历数据集中的所有图片，获取所有有标签且图片尺寸大于32的图片编号；</li><li>将合法的图片标号保存在self.img_ids中，返回合法图片的索引。</li></ol> 
<p>3、根据合法索引，重新给self.data_infos赋值，仅仅保留符合要求的图片信息。<br> 4、又是self.proposals，这里的self.proposals依然是None。<br> 5、然后调用self._set_group_flag()方法，</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">_set_group_flag</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Set flag according to image aspect ratio.

        Images with aspect ratio greater than 1 will be set as group 1,
        otherwise group 0.
        """</span>
        self<span class="token punctuation">.</span>flag <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            img_info <span class="token operator">=</span> self<span class="token punctuation">.</span>data_infos<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span> img_info<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span> <span class="token operator">/</span> img_info<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<p>这里会添加一个self.flag属性，这个属性记录图片是横着的还是竖着的。</p> 
<p>6、最后添加self.pipeline属性，这个属性十分重要，其中定义了对原始图片的增强或者说变换的流程，后面会详细介绍这个属性。</p> 
<p>至此，dataset的初始化就结束了。</p> 
<h2><a id="pipeline_361"></a>pipeline</h2> 
<h3><a id="LoadImageFromFile_362"></a>LoadImageFromFile</h3> 
<p>关于数据管道中的类有很多，这里仅仅详细介绍以下LoadImageFromFile这个类。</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@PIPELINES<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">LoadImageFromFile</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Load an image from file.

    Required keys are "img_prefix" and "img_info" (a dict that must contain the
    key "filename"). Added or updated keys are "filename", "img", "img_shape",
    "ori_shape" (same as `img_shape`), "pad_shape" (same as `img_shape`),
    "scale_factor" (1.0) and "img_norm_cfg" (means=0 and stds=1).

    Args:
        to_float32 (bool): Whether to convert the loaded image to a float32
            numpy array. If set to False, the loaded image is an uint8 array.
            Defaults to False.
        color_type (str): The flag argument for :func:`mmcv.imfrombytes`.
            Defaults to 'color'.
        file_client_args (dict): Arguments to instantiate a FileClient.
            See :class:`mmcv.fileio.FileClient` for details.
            Defaults to ``dict(backend='disk')``.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 to_float32<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 color_type<span class="token operator">=</span><span class="token string">'color'</span><span class="token punctuation">,</span>
                 file_client_args<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">'disk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>to_float32 <span class="token operator">=</span> to_float32
        self<span class="token punctuation">.</span>color_type <span class="token operator">=</span> color_type
        self<span class="token punctuation">.</span>file_client_args <span class="token operator">=</span> file_client_args<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>file_client <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Call functions to load image and get image meta information.

        Args:
            results (dict): Result dict from :obj:`mmdet.CustomDataset`.

        Returns:
            dict: The dict contains loaded image and meta information.
        """</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>file_client <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>file_client <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>FileClient<span class="token punctuation">(</span><span class="token operator">**</span>self<span class="token punctuation">.</span>file_client_args<span class="token punctuation">)</span>

        <span class="token keyword">if</span> results<span class="token punctuation">[</span><span class="token string">'img_prefix'</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            filename <span class="token operator">=</span> osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token string">'img_prefix'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                results<span class="token punctuation">[</span><span class="token string">'img_info'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            filename <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'img_info'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span>

        img_bytes <span class="token operator">=</span> self<span class="token punctuation">.</span>file_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        img <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>imfrombytes<span class="token punctuation">(</span>img_bytes<span class="token punctuation">,</span> flag<span class="token operator">=</span>self<span class="token punctuation">.</span>color_type<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>to_float32<span class="token punctuation">:</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token comment"># add by hui ####################################################</span>
        <span class="token keyword">if</span> <span class="token string">'corner'</span> <span class="token keyword">in</span> results<span class="token punctuation">[</span><span class="token string">'img_info'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            l<span class="token punctuation">,</span> u<span class="token punctuation">,</span> r<span class="token punctuation">,</span> b <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'img_info'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'corner'</span><span class="token punctuation">]</span>
            img <span class="token operator">=</span> img<span class="token punctuation">[</span>u<span class="token punctuation">:</span>b<span class="token punctuation">,</span> l<span class="token punctuation">:</span>r<span class="token punctuation">]</span>
            <span class="token keyword">assert</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
            results<span class="token punctuation">[</span><span class="token string">'corner'</span><span class="token punctuation">]</span> <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'img_info'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'corner'</span><span class="token punctuation">]</span>
        <span class="token comment"># ###############################################################</span>

        results<span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span> <span class="token operator">=</span> filename
        results<span class="token punctuation">[</span><span class="token string">'ori_filename'</span><span class="token punctuation">]</span> <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'img_info'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span>
        results<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> img
        results<span class="token punctuation">[</span><span class="token string">'img_shape'</span><span class="token punctuation">]</span> <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
        results<span class="token punctuation">[</span><span class="token string">'ori_shape'</span><span class="token punctuation">]</span> <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
        results<span class="token punctuation">[</span><span class="token string">'img_fields'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> results

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        repr_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">('</span></span>
                    <span class="token string-interpolation"><span class="token string">f'to_float32=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>to_float32<span class="token punctuation">}</span></span><span class="token string">, '</span></span>
                    <span class="token string-interpolation"><span class="token string">f"color_type='</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>color_type<span class="token punctuation">}</span></span><span class="token string">', "</span></span>
                    <span class="token string-interpolation"><span class="token string">f'file_client_args=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>file_client_args<span class="token punctuation">}</span></span><span class="token string">)'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> repr_str
</code></pre> 
<p>与mmdetection中其它模块一样，该模块使用@PIPELINES.register_module()在PIPELINES中被注册。</p> 
<p>LoadImageFromFile一共有三个方法：</p> 
<ol><li> <p><strong>初始化方法init()：</strong><br> 初始化方法中声明一些属性，这些属性会在call方法中使用。</p> </li><li> <p><strong>重载 () 运算符的call()方法：</strong></p> </li><li> <p><strong>用于显示实例化对象信息的 repr()方法：</strong><br> 该方法就是构造一个与实例化对象相关的字符串，然后返回该字符串。这个方法也是为了在调试过程中查看实例化对象的相关信息的。</p> </li></ol> 
<p>这里call方法执行过程如下：</p> 
<ol><li>获取一个文件读取器，这个类可以自定义，如果用户没有定义就会选择默认的mmcv.FileClient(‘backend’=‘disk’)；</li><li>根据方法的输入，构造图片的绝对路径；</li><li>根据路径将图片加载到内存；</li><li>根据图片中的corner信息裁减图片；</li><li>整理图片信息并返回。</li></ol> 
<p>这里需要注意：1、本人在调试过程中使用的tinyPerson数据集，该数据集中的标注信息有corner。2、call方法的输入是从dataloader获取的一个字典，该字典中包含图像、标注等相关信息。</p> 
<h3><a id="LoadAnnotations_463"></a>LoadAnnotations</h3> 
<p>这个类的方法比较多，除了init、call和repr之外，又多出来一些为call方法服务的方法。</p> 
<p>init和repr方法和LoadImageFromFile中的同名方法的功能一样，这里就不再赘述。</p> 
<p>call方法的功能是根据init中初始化的标志位读取相关标注信息并返回。代码如下：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Call function to load multiple types annotations.

        Args:
            results (dict): Result dict from :obj:`mmdet.CustomDataset`.

        Returns:
            dict: The dict contains loaded bounding box, label, mask and
                semantic segmentation annotations.
        """</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>with_bbox<span class="token punctuation">:</span>
            results <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_bboxes<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
            <span class="token keyword">if</span> results <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>with_label<span class="token punctuation">:</span>
            results <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_labels<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>with_mask<span class="token punctuation">:</span>
            results <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_masks<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>with_seg<span class="token punctuation">:</span>
            results <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_semantic_seg<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        <span class="token keyword">return</span> results
</code></pre> 
<p>这里判断的标志位都在init初始化的时候根据cfg被赋值。</p> 
<h4><a id="_load_bboxes_497"></a>_load_bboxes</h4> 
<p>该方法就是将藏在result深处的真实标注框拿出来，拿到外层来。( <em>results[‘gt_bboxes’] = results[‘ann_info’][‘bboxes’].copy()</em> )</p> 
<h4><a id="_load_labels_500"></a>_load_labels</h4> 
<p>同上。( <em>results[‘gt_labels’] = results[‘ann_info’][‘labels’].copy()</em> )</p> 
<p>我的实验是关于目标检测的，所以并没有跳入_load_masks、_load_semantic_seg方法。</p> 
<h3><a id="Resize_506"></a>Resize</h3> 
<p>我们直接来看Ressize.call()</p> 
<ol><li>给result添加scale_factor=1.0的键值对(这里也是因为tinyPerson数据集的特殊性)；</li><li>计算缩放后图片的尺度，这里scale=1.0(特殊数据集)；</li><li>将图片缩放到期望的大小；</li><li>将标注框也缩放到相同的尺度；</li><li>返回整理好的result。</li></ol> 
<h3><a id="RandomFlip_515"></a>RandomFlip</h3> 
<p>一定概率进行水平反转。</p> 
<h3><a id="Normalize_518"></a>Normalize</h3> 
<p>调用mmcv.imnormalize方法对图像进行归一化。</p> 
<h3><a id="Pad_521"></a>Pad</h3> 
<p>调用mmcv.impad_to_multiple将图片填充到期望的大小。为什么已经resize的图片还需要pad？原因是有些情况下我们在resize的时候需要保持图片的长宽比，这样的resize无法保证一定可以将图片缩放到期望的大小。但是这里由于我的数据集特殊，并不需要pad。也就是说这里作者虽然在cfg中配置的pad的过程，但是该过程并没有什么用。</p> 
<h3><a id="DefaultFormatBundle_524"></a>DefaultFormatBundle</h3> 
<p>这个过程对result中的缺失参数进行补充，并将相关数据封装成tensor格式。</p> 
<h3><a id="Collect_527"></a>Collect</h3> 
<p>重新整理result中的参数。这里需要注意，不要把该方法与dataloader中的collet弄混了，两个方法的功能不一样。</p> 
<h2><a id="_532"></a>结束</h2> 
<p>这部分内容就先总结到这里，记录是为了方便自己未来对知识点的回顾，也希望能够帮助到正在看此篇博客的你。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7aed1dbefde10ed6fc888dda798dcf22/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue 基础语法之计算属性(computed)、侦听器(watch)、过滤器(filters)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/07ced2a6bc2b25bdd047fa5c1cff49c4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深度强化学习(DRL)基础</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>