<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>flink 整合mybatis 并进行单个/批量sink,(不需要mybatis-config.xml！！！) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="flink 整合mybatis 并进行单个/批量sink,(不需要mybatis-config.xml！！！)" />
<meta property="og:description" content="目录
1.依赖
2.编写sink继承 RichSinkFunction
3.MyDataSource 4.BookMapper
5.BookMapper.xml
6.使用
之前看到过其他的关于flink整合mybatis的博客,比如flink 流式处理中如何集成mybatis框架，都用到了一个叫做&#34;mybatis-config.xml&#34; 的全局配置文件，但是我发现这种方式用在flink里面不是很灵活，后来我通过分析mybatis的源码，通过代码将&#34;mybatis-config.xml&#34;给替换掉，这样flink就可以动态加载mapper文件，每个sink可以只是加载和自己相关的mapper,从而减少加载不必要的mapper，使用更灵活。
1.依赖 &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid&lt;/artifactId&gt; &lt;version&gt;1.1.21&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.mybatis&lt;/groupId&gt; &lt;artifactId&gt;mybatis&lt;/artifactId&gt; &lt;version&gt;3.5.2&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;8.0.11&lt;/version&gt; &lt;/dependency&gt; 2.编写sink继承 RichSinkFunction Slf4j public class BookSink extends RichSinkFunction&lt;List&lt;Book&gt;&gt; { /** * 数据库连接配置 */ private MyDataSource myDataSource; /** * sqlSessionFactory */ private SqlSessionFactory sqlSessionFactory; /*** * @description : 构造传入数据源配置 * @param myDataSource : 数据源配置 */ public BookSink(MyDataSource myDataSource) { this.myDataSource = myDataSource; } @Override public void open(Configuration parameters) throws Exception { //添加需要操作的mapper Set&lt;String&gt; mapperXmls = new HashSet&lt;&gt;(); mapperXmls." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/affa8a8edf2103d591f638abf7d23219/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-19T14:34:08+08:00" />
<meta property="article:modified_time" content="2021-02-19T14:34:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">flink 整合mybatis 并进行单个/批量sink,(不需要mybatis-config.xml！！！)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="1.%E4%BE%9D%E8%B5%96-toc" style="margin-left:0px;"><a href="#1.%E4%BE%9D%E8%B5%96" rel="nofollow">1.依赖</a></p> 
<p id="2.%E7%BC%96%E5%86%99sink%E7%BB%A7%E6%89%BF%20RichSinkFunction-toc" style="margin-left:0px;"><a href="#2.%E7%BC%96%E5%86%99sink%E7%BB%A7%E6%89%BF%20RichSinkFunction" rel="nofollow">2.编写sink继承 RichSinkFunction</a></p> 
<p id="3.MyDataSource%C2%A0-toc" style="margin-left:0px;"><a href="#3.MyDataSource%C2%A0" rel="nofollow">3.MyDataSource </a></p> 
<p id="%C2%A04.BookMapper-toc" style="margin-left:0px;"><a href="#%C2%A04.BookMapper" rel="nofollow"> 4.BookMapper</a></p> 
<p id="5.BookMapper.xml-toc" style="margin-left:0px;"><a href="#5.BookMapper.xml" rel="nofollow">5.BookMapper.xml</a></p> 
<p id="6.%E4%BD%BF%E7%94%A8-toc" style="margin-left:0px;"><a href="#6.%E4%BD%BF%E7%94%A8" rel="nofollow">6.使用</a></p> 
<hr id="hr-toc"> 
<p style="text-indent:33px;"> <strong>之前看到过其他的关于flink整合mybatis的博客,比如<a href="https://www.cnblogs.com/laoqing/p/11890929.html" rel="nofollow">flink 流式处理中如何集成mybatis框架</a>，都用到了一个叫做"mybatis-config.xml" 的全局配置文件，但是我发现这种方式用在flink里面不是很灵活，后来我通过分析mybatis的源码，通过代码将"mybatis-config.xml"给替换掉，这样flink就可以动态加载mapper文件，每个sink可以只是加载和自己相关的mapper,从而减少加载不必要的mapper，使用更灵活。</strong></p> 
<h2 id="1.%E4%BE%9D%E8%B5%96">1.依赖</h2> 
<pre><code class="language-XML"> &lt;dependency&gt;
   &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
   &lt;artifactId&gt;druid&lt;/artifactId&gt;
   &lt;version&gt;1.1.21&lt;/version&gt;
 &lt;/dependency&gt;
 &lt;dependency&gt;
    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis&lt;/artifactId&gt;
    &lt;version&gt;3.5.2&lt;/version&gt;
 &lt;/dependency&gt;
 &lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;version&gt;8.0.11&lt;/version&gt;
 &lt;/dependency&gt;</code></pre> 
<h2 id="2.%E7%BC%96%E5%86%99sink%E7%BB%A7%E6%89%BF%20RichSinkFunction">2.编写sink继承 RichSinkFunction</h2> 
<pre><code class="language-java">Slf4j
public class BookSink extends RichSinkFunction&lt;List&lt;Book&gt;&gt; {
    /**
     * 数据库连接配置
     */
    private MyDataSource myDataSource;
    /**
     * sqlSessionFactory
     */
    private SqlSessionFactory sqlSessionFactory;

    /***
     * @description : 构造传入数据源配置
     * @param myDataSource : 数据源配置
     */
    public BookSink(MyDataSource myDataSource) {
        this.myDataSource = myDataSource;
    }

    @Override
    public void open(Configuration parameters) throws Exception {
        //添加需要操作的mapper
        Set&lt;String&gt; mapperXmls = new HashSet&lt;&gt;();
        mapperXmls.add("mapper/bookMapper.xml");

        //组装dataSource
        if (myDataSource == null) {
            throw new RuntimeException("数据库连接配置参数不能为空");
        }
        if (StringUtils.isBlank(myDataSource.getUrl())) {
            throw new RuntimeException("url is null");
        }
        if (StringUtils.isBlank(myDataSource.getDriver())) {
            throw new RuntimeException("driver is null");
        }
        if (StringUtils.isBlank(myDataSource.getUserName())) {
            throw new RuntimeException("userName is null");
        }
        if (StringUtils.isBlank(myDataSource.getPassword())) {
            throw new RuntimeException("password is null");
        }

        DruidDataSource dataSource = new DruidDataSource();
        //设置连接参数
        dataSource.setUrl(myDataSource.getUrl());
        dataSource.setDriverClassName(myDataSource.getDriver());
        dataSource.setUsername(myDataSource.getUserName());
        dataSource.setPassword(myDataSource.getPassword());

        //配置初始化大小、最小、最大
        dataSource.setInitialSize(myDataSource.getInitialSize());
        dataSource.setMinIdle(myDataSource.getMinIdle());
        dataSource.setMaxActive(myDataSource.getMaxActive());

        dataSource.setRemoveAbandoned(false);
        //超时时间；单位为秒。180秒=3分钟
        dataSource.setRemoveAbandonedTimeout(180);

        //配置一个连接在池中最小生存的时间，单位是毫秒
        dataSource.setMinEvictableIdleTimeMillis(300000);
        //配置获取连接等待超时的时间单位毫秒
        dataSource.setMaxWait(60000);
        //配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
        dataSource.setTimeBetweenEvictionRunsMillis(60000);
        //防止过期
        dataSource.setValidationQuery("SELECT '1'");
        dataSource.setTestWhileIdle(true);
        // 每次获取连接时测试连接是否有效
        dataSource.setTestOnBorrow(true);
        dataSource.setTestOnReturn(true);

        //是否缓存preparedStatement
        dataSource.setPoolPreparedStatements(false);
        dataSource.setMaxOpenPreparedStatements(100);
        //asyncInit是1.1.4中新增加的配置，如果有initialSize数量较多时，打开会加快应用启动时间
        dataSource.setAsyncInit(true);
        dataSource.setName(myDataSource.getUserName());

        //获取sqlSessionFactory
        TransactionFactory transactionFactory = new JdbcTransactionFactory();
        Environment environment = new Environment("test-data", transactionFactory, dataSource);
        org.apache.ibatis.session.Configuration configuration = new org.apache.ibatis.session.Configuration(environment);
        configuration.setCacheEnabled(false);
        configuration.setUseGeneratedKeys(true);
        for (String mapperXml : mapperXmls) {
            ErrorContext.instance().resource(mapperXml);
            InputStream inputStream = Resources.getResourceAsStream(mapperXml);
            XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, mapperXml, configuration.getSqlFragments());
            mapperParser.parse();
        }
        sqlSessionFactory = new SqlSessionFactoryBuilder().build(configuration);
    }

    @Override
    public void invoke(List&lt;Book&gt; values, Context context) throws Exception {
        SqlSession sqlSession = null;
        try {
            //获取sqlSession
            sqlSession = sqlSessionFactory.openSession(ExecutorType.BATCH, true);
            sqlSession.getMapper(BookMapper.class).batchInsert(values);
        } catch (Exception e) {
            log.error(this.getClass().getName() + ".invoke()执行失败", e);
            //重试一次
            try {
                if (sqlSession != null) {
                    sqlSession.getMapper(BookMapper.class).batchInsert(values);
                }
            } catch (Exception ex) {
                log.error(this.getClass().getName() + ".invoke()重试执行失败", e);
            }
        } finally {
            //关闭sqlSession
            if (sqlSession != null) {
                sqlSession.close();
            }
        }
    }
}</code></pre> 
<h2 id="3.MyDataSource%C2%A0">3.MyDataSource </h2> 
<pre><code class="language-java">@Data
public class MyDataSource implements Serializable {
    /**
     * 数据源地址
     */
    private String url;
    /**
     * 数据源驱动
     */
    private String driver;
    /**
     * 用户名
     */
    private String userName;
    /**
     * 密码
     */
    private String password;
    /**
     * 连接池最大活跃数
     */
    private Integer maxActive;
    /**
     * 连接池初始化数量
     */
    private Integer initialSize;
    /**
     * 连接池最小数据
     */
    private Integer minIdle;
}</code></pre> 
<h2 id="%C2%A04.BookMapper"> 4.BookMapper</h2> 
<pre><code class="language-java">/**
 * 提供单个插入和批量插入的方法
 * @author denglin
 * @since 2020-12-16
 */
public interface BookMapper extends Serializable {
    /***
     * @description : 插入单个记录到数据库
     * @param entity : 请求参数
     */
    void insert(Book entity);

    /***
     * @description : 批量插入记录到数据库
     * @param entities : 请求参数
     */
    void batchInsert(List&lt;Book&gt; entities);
}</code></pre> 
<h2 id="5.BookMapper.xml">5.BookMapper.xml</h2> 
<pre><code class="language-XML">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;
&lt;mapper namespace="com.test.mapper.BookMapper"&gt;
    &lt;!--插入单个记录--&gt;
    &lt;select id="insert" parameterType="com.test.Book"&gt;
        INSERT INTO book
        (
            name
            ,price
            ,created
            ,modified
        )
        VALUES
        (
             #{name}
            ,#{price}
            ,now()
            ,now()
        )
        ON DUPLICATE KEY UPDATE
            modified = now()

    &lt;/select&gt;
    &lt;!--批量插入--&gt;
    &lt;select id="batchInsert" parameterType="com.test.Book"&gt;
        INSERT INTO os_top_rank
        (
        name
        ,price
        ,created
        ,modified
        )
        VALUES
        &lt;foreach collection="list" item="item" separator=","&gt;
            (
            #{name}
            ,#{price}
            ,now()
            ,now()
            )
        &lt;/foreach&gt;
        ON DUPLICATE KEY UPDATE
        modified = now()
    &lt;/select&gt;
&lt;/mapper&gt;
</code></pre> 
<h2 id="6.%E4%BD%BF%E7%94%A8">6.使用</h2> 
<pre><code class="language-java">//此处使用伪代码
MyDataSource myDataSource = new MyDataSource();
myDataSource.setUrl(...);
myDataSource.setDriver(...);
...;

xxxStream
.keyBy(...)
.process(...)
.addSink(new BookSink(myDataSource));</code></pre> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b8336beae22881fd8968fa89295b592b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring核心技术详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/197bb2f7619d5dc1ae07f1b88a88256e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux上TCP的几个内核参数调优</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>