<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL（三）MySQL-5.7.20 主从复制实战（半同步复制、过滤复制、GTID模式） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL（三）MySQL-5.7.20 主从复制实战（半同步复制、过滤复制、GTID模式）" />
<meta property="og:description" content="MySQL-5.7.20二进制主从复制实战（半同步复制、过滤复制、GTID模式） 文章目录 MySQL-5.7.20二进制主从复制实战（半同步复制、过滤复制、GTID模式）一、半同步复制半同步复制的原理半同步复制先决条件半同步复制实战加载sync插件查看插件启动半同步重启从库IO线程查看是否运行 二、过滤复制复制的过滤主要有２种方式复制的优化：下面二项需要在Master上设置：下面六项需要在slave上设置：主从过滤的注意事项：主从复制过滤复制先决条件主从复制过滤复制实战添加配置文件白名单参数重启3308实例查看过滤复制的信息 三、GTID模式GTID优势GTID的限制GTID的工作原理GTID的使用GTID原理pos 与 GTID 有什么区别？GTID模式主从复制实战开启binlog日志与GTID授权重启3306与3309实例查看是否开启GTID创建主从复制用户开启GTID主从复制查看主从复制状态测试GTID模式主从复制效果查看结果 一、半同步复制 半同步复制的原理 半同步复制时，为了保证主库上的每一个Binlog事务都能够被可靠的复制到从库上，主库在每次事务成功提交时，并不及时反馈给前端应用用户，而是等待其中的一个从库也接收到Binlog事务并成功写入中继日志后，出库才返回commit操作成功给客户端。半同步复制保证了事务成功提交后，至少有两份日志记录，一份在主库的Binlog日志上，另一份在至少一个从库的中继日志Relay log上，从而更近一步保证了数据的完整性。
半同步复制先决条件 前文已经有二进制多实例主从复制的文档，本文档不再从新开启主从复制，如果没有开启请点击：二进制主从复制
在做半同步复制前请保证开启了主从同步
半同步复制实战 加载sync插件 [mark_d]注意：主库与从库加载的插件不是同一个！！！[/mark_d]
[root@mysql-manager ~]# mysql -S /opstands/mysql-3307/mysql.sock -e &#34;install plugin rpl_semi_sync_master soname &#39;semisync_master.so&#39;;&#34; [root@mysql-manager ~]# mysql -S /opstands/mysql-3308/mysql.sock -e &#34;install plugin rpl_semi_sync_slave soname &#39;semisync_slave.so&#39;;&#34; 查看插件 [root@mysql-manager ~]# mysql -S /opstands/mysql-3307/mysql.sock -e &#34;show plugins&#34; |grep rpl_semi_sync rpl_semi_sync_master	ACTIVE	REPLICATION	semisync_master.so	GPL [root@mysql-manager ~]# mysql -S /opstands/mysql-3308/mysql.sock -e &#34;show plugins&#34; |grep rpl_semi_sync rpl_semi_sync_slave	ACTIVE	REPLICATION	semisync_slave." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/218146b8cc6d78a48b474cb546ef5def/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-08T11:41:45+08:00" />
<meta property="article:modified_time" content="2021-01-08T11:41:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL（三）MySQL-5.7.20 主从复制实战（半同步复制、过滤复制、GTID模式）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="MySQL5720GTID_0"></a>MySQL-5.7.20二进制主从复制实战（半同步复制、过滤复制、GTID模式）</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#MySQL5720GTID_0" rel="nofollow">MySQL-5.7.20二进制主从复制实战（半同步复制、过滤复制、GTID模式）</a></li><li><ul><li><ul><li><a href="#_3" rel="nofollow">一、半同步复制</a></li><li><ul><li><a href="#_5" rel="nofollow">半同步复制的原理</a></li><li><a href="#_11" rel="nofollow">半同步复制先决条件</a></li><li><a href="#_17" rel="nofollow">半同步复制实战</a></li><li><a href="#sync_19" rel="nofollow">加载sync插件</a></li><li><a href="#_28" rel="nofollow">查看插件</a></li><li><a href="#_37" rel="nofollow">启动半同步</a></li><li><a href="#IO_47" rel="nofollow">重启从库IO线程</a></li><li><a href="#_54" rel="nofollow">查看是否运行</a></li></ul> 
    </li><li><a href="#_74" rel="nofollow">二、过滤复制</a></li><li><ul><li><a href="#_76" rel="nofollow">复制的过滤主要有２种方式</a></li><li><a href="#_83" rel="nofollow">复制的优化：</a></li><li><a href="#Master_87" rel="nofollow">下面二项需要在Master上设置：</a></li><li><a href="#slave_95" rel="nofollow">下面六项需要在slave上设置：</a></li><li><a href="#_107" rel="nofollow">主从过滤的注意事项：</a></li><li><a href="#_112" rel="nofollow">主从复制过滤复制先决条件</a></li><li><a href="#_118" rel="nofollow">主从复制过滤复制实战</a></li><li><a href="#_120" rel="nofollow">添加配置文件白名单参数</a></li><li><a href="#3308_129" rel="nofollow">重启3308实例</a></li><li><a href="#_135" rel="nofollow">查看过滤复制的信息</a></li></ul> 
    </li><li><a href="#GTID_147" rel="nofollow">三、GTID模式</a></li><li><ul><li><a href="#GTID_149" rel="nofollow">GTID优势</a></li><li><a href="#GTID_156" rel="nofollow">GTID的限制</a></li><li><a href="#GTID_164" rel="nofollow">GTID的工作原理</a></li><li><a href="#GTID_183" rel="nofollow">GTID的使用</a></li><li><a href="#GTID_187" rel="nofollow">GTID原理</a></li><li><a href="#pos__GTID__195" rel="nofollow">pos 与 GTID 有什么区别？</a></li><li><a href="#GTID_209" rel="nofollow">GTID模式主从复制实战</a></li><li><a href="#binlogGTID_213" rel="nofollow">开启binlog日志与GTID</a></li><li><a href="#_227" rel="nofollow">授权</a></li><li><a href="#33063309_233" rel="nofollow">重启3306与3309实例</a></li><li><a href="#GTID_240" rel="nofollow">查看是否开启GTID</a></li><li><a href="#_272" rel="nofollow">创建主从复制用户</a></li><li><a href="#GTID_278" rel="nofollow">开启GTID主从复制</a></li><li><a href="#_295" rel="nofollow">查看主从复制状态</a></li><li><a href="#GTID_304" rel="nofollow">测试GTID模式主从复制效果</a></li><li><a href="#_330" rel="nofollow">查看结果</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="_3"></a>一、半同步复制</h4> 
<h5><a id="_5"></a>半同步复制的原理</h5> 
<p>半同步复制时，为了保证主库上的每一个Binlog事务都能够被可靠的复制到从库上，主库在每次事务成功提交时，并不及时反馈给前端应用用户，而是等待其中的一个从库也接收到Binlog事务并成功写入中继日志后，出库才返回commit操作成功给客户端。半同步复制保证了事务成功提交后，至少有两份日志记录，一份在主库的Binlog日志上，另一份在至少一个从库的中继日志Relay log上，从而更近一步保证了数据的完整性。</p> 
<p><img src="https://images2.imgbox.com/39/01/yhcPeBmf_o.png" alt="img"></p> 
<h5><a id="_11"></a>半同步复制先决条件</h5> 
<p>前文已经有二进制多实例主从复制的文档，本文档不再从新开启主从复制，如果没有开启请点击：<strong><a href="https://blog.csdn.net/qq_23435961/article/details/112346893">二进制主从复制</a></strong></p> 
<p>在做半同步复制前请保证开启了主从同步</p> 
<h5><a id="_17"></a>半同步复制实战</h5> 
<h5><a id="sync_19"></a>加载sync插件</h5> 
<p>[mark_d]注意：主库与从库加载的插件不是同一个！！！[/mark_d]</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3307/mysql.sock -e "install plugin rpl_semi_sync_master soname 'semisync_master.so';"</span>
<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3308/mysql.sock -e "install plugin rpl_semi_sync_slave soname 'semisync_slave.so';"</span>
</code></pre> 
<h5><a id="_28"></a>查看插件</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3307/mysql.sock -e "show plugins" |grep rpl_semi_sync</span>
rpl_semi_sync_master	ACTIVE	REPLICATION	semisync_master.so	GPL
<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3308/mysql.sock -e "show plugins" |grep rpl_semi_sync</span>
rpl_semi_sync_slave	ACTIVE	REPLICATION	semisync_slave.so	GPL
</code></pre> 
<h5><a id="_37"></a>启动半同步</h5> 
<p><strong>注意：</strong> 插件名称不一样</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3307/mysql.sock -e "set global rpl_semi_sync_master_enabled = 1;"</span>

<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3308/mysql.sock -e "set global rpl_semi_sync_slave_enabled= 1 ;"</span>
</code></pre> 
<h5><a id="IO_47"></a>重启从库IO线程</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3308/mysql.sock -e "stop slave io_thread;"</span>
<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3308/mysql.sock -e "start slave io_thread;"</span>
</code></pre> 
<h5><a id="_54"></a>查看是否运行</h5> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3307/mysql.sock -e "show status like 'Rpl_semi_sync_master_status';"</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+-------+</span>
<span class="token operator">|</span> Variable_name               <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+-------+</span>
<span class="token operator">|</span> Rpl_semi_sync_master_status <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+-------+</span>

<span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3308/mysql.sock -e "show status like 'Rpl_semi_sync_slave_status';"</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-------+</span>
<span class="token operator">|</span> Variable_name              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-------+</span>
<span class="token operator">|</span> Rpl_semi_sync_slave_status <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-------+</span>
</code></pre> 
<h4><a id="_74"></a>二、过滤复制</h4> 
<h5><a id="_76"></a>复制的过滤主要有２种方式</h5> 
<ol><li>在主服务器在把事件从进二制日志中过滤掉，相关的参数是:binlog_do_db和binlog_ignore_db。</li><li>在从服务器上把事件从中继日志中过滤掉，相关的参数是replicate_*。</li></ol> 
<ul><li>复制只能扩展读取，不能扩展写入，对数据进行分区可以进行扩展写入。</li></ul> 
<h5><a id="_83"></a>复制的优化：</h5> 
<p>在mysql复制环境中,有8个参数可以让我们控制,需要复制或需要忽略不进行复制的DB或table。</p> 
<h5><a id="Master_87"></a>下面二项需要在Master上设置：</h5> 
<ol><li>Binlog_Do_DB:设定哪些数据库需要记录Binlog</li><li>Binlog_Ignore_DB:设定哪里数据库不需要记录Binlog</li></ol> 
<ul><li>优点是Master端的Binlog记录所带来的Io量减少，网络IO减少，还会让slave端的IO线程,SQL线程减少，从而大幅提高复制性能,</li><li>缺点是mysql判断是否需要复制某个事件不是根据产生该事件的查询所在的DB,而是根据执行查询时刻所在的默认数据库（也就是登录时指定的库名或运行”use database”中指定的DB）,只有当前默认DB和配置中所设定的DB完全吻合时IO线程才会将该事件读取给slave的IO线程.所以,如果在默认DB和设定须要复制的DB不一样的情况下改变了须要复制的DB中某个Table中的数据,该事件是不会被复制到Slave中去的,这样就会造成Slave端的数据和Master的数据不一致.同样,在默认的数据库下更改了不须要复制的数据库中的数据,则会被复制到slave端,当slave端并没有该数据库时,则会造成复制出错而停止。</li></ul> 
<h5><a id="slave_95"></a>下面六项需要在slave上设置：</h5> 
<ol><li>Replicate_Do_DB:设定需要复制的数据库,多个DB用逗号分隔</li><li>Replicate_Ignore_DB:设定可以忽略的数据库.</li><li>Replicate_Do_Table:设定需要复制的Table</li><li>Replicate_Ignore_Table:设定可以忽略的Table</li><li>Replicate_Wild_Do_Table:功能同Replicate_Do_Table,但可以带通配符来进行设置。</li><li>Replicate_Wild_Ignore_Table:功能同Replicate_Do_Table,功能同Replicate_Ignore_Table,可以带通配符。</li></ol> 
<ul><li>优点是在slave端设置复制过滤机制,可以保证不会出现因为默认的数据库问题而造成Slave和Master数据不一致或复制出错的问题.</li><li>缺点是性能方面比在Master端差一些.原因在于:不管是否须要复制,事件都会被IO线程读取到Slave端,这样不仅增加了网络IO量,也给Slave端的IO线程增加了Relay Log的写入量。</li></ul> 
<h5><a id="_107"></a>主从过滤的注意事项：</h5> 
<ul><li>使用replicate_do_db和replicate_ignore_db时有一个隐患，跨库更新时会出错。</li><li>如在Master（主）服务器上设置 replicate_do_db=test（my.conf中设置）</li></ul> 
<h5><a id="_112"></a>主从复制过滤复制先决条件</h5> 
<p>前文已经有二进制多实例主从复制的文档，本文档不再从新开启主从复制，如果没有开启请点击：<strong><a href="https://blog.csdn.net/qq_23435961/article/details/112346893">二进制主从复制</a></strong></p> 
<p>在做过滤复制前请保证开启了主从同步</p> 
<h5><a id="_118"></a>主从复制过滤复制实战</h5> 
<h5><a id="_120"></a>添加配置文件白名单参数</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># echo 'replicate_do_db=olda' &gt;&gt; /opstands/mysql-3308/my.cnf</span>

<span class="token comment"># -----------------------------------------------------</span>
<span class="token comment"># replicate_ignore_db是黑名单，用法和白名单一样</span>
</code></pre> 
<h5><a id="3308_129"></a>重启3308实例</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart mysqld-3308.service</span>
</code></pre> 
<h5><a id="_135"></a>查看过滤复制的信息</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3308/mysql.sock -e "show slave status\G" |egrep 'Replicate_Do_DB:|Replicate_Ignore_DB:'</span>
              Replicate_Do_DB: olda
          Replicate_Ignore_DB:
</code></pre> 
<p>现在主从复制只会同步olda库的数据</p> 
<h4><a id="GTID_147"></a>三、GTID模式</h4> 
<h5><a id="GTID_149"></a>GTID优势</h5> 
<ul><li>更简单的实现 failover，不用以前那样在需要找 log_file 和 log_Pos。</li><li>更简单的搭建主从复制。</li><li>复制集群有一个统一的方式识别复制位置，给集群管理带来了便利。</li><li>正常情况下，GTID 是连续没有空洞的，因此主从库出现数据冲突时，可以用添加空事物的方式进行跳过。</li></ul> 
<h5><a id="GTID_156"></a>GTID的限制</h5> 
<ol><li>在一个事务里面混合使用引擎,如 Innodb(支持事务)、MyISAM(不支持事务)， 造成多个 GTIDs 和同一个事务相关联出错</li><li>CREATE TABLE……SELECT 不能使用，该语句产生的两个 event 在某一情况 会使用同一个 GTID(同一个 GTID 在 slave 只能被使用一次)<br> 1th event:创建表语句 create table<br> 2th event:插入数据语句 insert</li><li>CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE 不能在事务内使用 (启用了–enforce-gtid-consistency 参数)。</li></ol> 
<h5><a id="GTID_164"></a>GTID的工作原理</h5> 
<p>1、master更新数据时，会在事务前产生GTID，一同记录到binlog日志中。</p> 
<p>2、slave端的i/o 线程将变更的binlog，写入到本地的relay log中。</p> 
<p>3、sql线程从relay log中获取GTID，然后对比slave端的binlog是否有记录。</p> 
<p>4、如果有记录，说明该GTID的事务已经执行，slave会忽略。</p> 
<p>5、如果没有记录，slave就会从relay log中执行该GTID的事务，并记录到binlog。</p> 
<p>6、在解析过程中会判断是否有主键，如果没有就用二级索引，如果没有就用全部扫描。</p> 
<ul><li>server_uuid是MySQL Server的只读变量，保存在数据目录下的auto.cnf中，可直接通过cat命令查看。MySQL第一次启动时候创建auto.cnf文件，并生成server_uuid（MySQL使用机器网卡，当前时间，随机数等拼接成一个128bit的uuid，可认为在全宇宙都是唯一的，在未来一百年，使用同样的算法生成的uuid是不会冲突的）。之后MySQL再启动时不会重复生成uuid，而是使用auto.cnf中的uuid。</li><li>在同一个集群内，每个MySQL实例的server_uuid必须唯一，否则同步时，会造成IO线程不停的中断，重连。在通过备份恢复数据时，一定要将var目录中的auto.cnf删掉，让MySQL启动时自己生成uuid</li><li>GTID中还有一部分是transaction_id，同一个server_uuid下的transaction_id一般是递增的。如果一个事务是通过用户线程执行，那么MySQL在生成的GTID时，会使用它自己的server_uuid，然后再递增一个transaction_id作为该事务的GTID。当然，如果事务是通过SQL线程回放relay-log时产生，那么GTID就直接使用binlog里的了。在MySQL 5.6中不用担心binlog里没有GTID，因为如果从库开启了GTID模式，主库也必须开启，否则IO线程在建立连接的时候就中断了。5.6的GTID对MySQL的集群环境要求是非常严格的，要么主从全部开启GTID模式，要么全部关闭GTID模式。</li><li>使用server_uuid:transaction_id共同组成一个GTID的好处是，由于server_uuid唯一，即使一个集群内多个节点同时有写入，也不会造成GTID冲突。</li></ul> 
<h5><a id="GTID_183"></a>GTID的使用</h5> 
<ul><li>MySQL通过全局变量gtid_mode控制开启/关闭GTID模式。但是gtid_mode是只读的，可添加到配置文件中，然后重启mysqld来开启GTID模式。</li></ul> 
<h5><a id="GTID_187"></a>GTID原理</h5> 
<ul><li>我们知道，在未开启GTID模式的情况下，从库用（File_name和File_pos）二元组标识执行到的位置。START SLAVE时，从库会先向主库发送一个BINLOG_DUMP命令，在BINLOG_DUMP命令中指定File_name和File_pos，主库就从这个位置开始发送binlog。</li><li>在开启GTID模式的情况下，如果指定MASTER_AUTO_POSITION=1。START SLAVE时，从库会计算Retrieved_Gtid_Set和Executed_Gtid_Set的并集（通过SHOW SLAVE STATUS可以查看），然后把这个GTID并集发送给主库。主库会使用从库请求的GTID集合和自己的gtid_executed比较，把从库GTID集合里缺失的事务全都发送给从库。如果从库缺失的GTID，已经被主库pruge了呢？从库报1236错误，IO线程中断。</li><li>通过GTID找到点儿的原理还是比较奇怪的，它过于强调主从binlog中GTID集合的一致性，弱化了Binlog执行的顺序性。</li></ul> 
<p><img src="https://images2.imgbox.com/1d/18/b3Il2CNA_o.png" alt="img"></p> 
<h5><a id="pos__GTID__195"></a>pos 与 GTID 有什么区别？</h5> 
<ul><li>两者都是日志文件里事件的一个标志,如果将整个 mysql 集群看作一个整体,pos就是局部的,GTID就是全局的.</li><li>一主两从,在 master,slave1,slave2 日志文件里的 pos,都各不相同,就是一个 event,在 master 的日志里,pos 可能是 700,而在 slave1,slave2 里,pos 可能就是 300,400 了,因为众多 slave 也可能不是同时加入集群的,不是从同一个位置进行同步.</li><li>而 GTID,在 master,slave1,slave2 各自的日志文件里,同一个 event 的 GTID 值都是一样的.</li></ul> 
<p><strong>GTID模式主从复制先决条件</strong></p> 
<p>前文已经有二进制多实例安装的文档，本文档不再从新安装，如果没有安装请点击：<a href="https://blog.csdn.net/qq_23435961/article/details/112346893"><strong>二进制多实例安装</strong></a></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /opstands/mysql-5.7.20/binlog</span>
</code></pre> 
<h5><a id="GTID_209"></a>GTID模式主从复制实战</h5> 
<p>本文将使用MySQL-3306实例为主节点，MySQL3309实例为从节点。</p> 
<h5><a id="binlogGTID_213"></a>开启binlog日志与GTID</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># sed -i '7a log_bin=/opstands/mysql-5.7.20/binlog/mysql-bin' /etc/my.cnf</span>
<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># sed -i '8a binlog_format=row' /etc/my.cnf</span>
<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># sed -i '9a sync_binlog=1' /etc/my.cnf</span>
<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># sed -i '10a gtid_mode=ON' /etc/my.cnf</span>
<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># sed -i '11a enforce_gtid_consistency' /etc/my.cnf</span>
<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># cat &gt;&gt; /opstands/mysql-3309/my.cnf &lt;&lt;EOF</span>
gtid_mode<span class="token operator">=</span>ON
enforce_gtid_consistency
EOF
</code></pre> 
<h5><a id="_227"></a>授权</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># chown -R mysql.mysql /opstands/mysql-*</span>
</code></pre> 
<h5><a id="33063309_233"></a>重启3306与3309实例</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart mysqld.service</span>
<span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart mysqld-3309.service</span>
</code></pre> 
<h5><a id="GTID_240"></a>查看是否开启GTID</h5> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql -uroot -predhat -e "show variables like '%gtid_%';"</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> <span class="token keyword">Using</span> a password <span class="token keyword">on</span> the command line interface can be insecure<span class="token punctuation">.</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+-----------+</span>
<span class="token operator">|</span> Variable_name                    <span class="token operator">|</span> <span class="token keyword">Value</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+-----------+</span>
<span class="token operator">|</span> binlog_gtid_simple_recovery      <span class="token operator">|</span> <span class="token keyword">ON</span>        <span class="token operator">|</span>
<span class="token operator">|</span> enforce_gtid_consistency         <span class="token operator">|</span> <span class="token keyword">ON</span>        <span class="token operator">|</span>       <span class="token operator">&lt;</span><span class="token comment">------- 是否开启GTID</span>
<span class="token operator">|</span> gtid_executed_compression_period <span class="token operator">|</span> <span class="token number">1000</span>      <span class="token operator">|</span>
<span class="token operator">|</span> gtid_mode                        <span class="token operator">|</span> <span class="token keyword">ON</span>        <span class="token operator">|</span>               <span class="token operator">&lt;</span><span class="token comment">-------是否启用GTID模块</span>
<span class="token operator">|</span> gtid_next                        <span class="token operator">|</span> AUTOMATIC <span class="token operator">|</span>
<span class="token operator">|</span> gtid_owned                       <span class="token operator">|</span>           <span class="token operator">|</span>
<span class="token operator">|</span> gtid_purged                      <span class="token operator">|</span>           <span class="token operator">|</span>
<span class="token operator">|</span> session_track_gtids              <span class="token operator">|</span> <span class="token keyword">OFF</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+-----------+</span>
<span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3309/mysql.sock -e "show variables like '%gtid_%';"</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+-----------+</span>
<span class="token operator">|</span> Variable_name                    <span class="token operator">|</span> <span class="token keyword">Value</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+-----------+</span>
<span class="token operator">|</span> binlog_gtid_simple_recovery      <span class="token operator">|</span> <span class="token keyword">ON</span>        <span class="token operator">|</span>
<span class="token operator">|</span> enforce_gtid_consistency         <span class="token operator">|</span> <span class="token keyword">ON</span>        <span class="token operator">|</span>       <span class="token operator">&lt;</span><span class="token comment">------- 是否开启GTID</span>
<span class="token operator">|</span> gtid_executed_compression_period <span class="token operator">|</span> <span class="token number">1000</span>      <span class="token operator">|</span>
<span class="token operator">|</span> gtid_mode                        <span class="token operator">|</span> <span class="token keyword">ON</span>        <span class="token operator">|</span>               <span class="token operator">&lt;</span><span class="token comment">-------是否启用GTID模块</span>
<span class="token operator">|</span> gtid_next                        <span class="token operator">|</span> AUTOMATIC <span class="token operator">|</span>
<span class="token operator">|</span> gtid_owned                       <span class="token operator">|</span>           <span class="token operator">|</span>
<span class="token operator">|</span> gtid_purged                      <span class="token operator">|</span>           <span class="token operator">|</span>
<span class="token operator">|</span> session_track_gtids              <span class="token operator">|</span> <span class="token keyword">OFF</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+-----------+</span>
</code></pre> 
<h5><a id="_272"></a>创建主从复制用户</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@mysql-manager ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -predhat -e "grant replication slave on *.* to rep@'%' identified by 'redhat';"</span>
</code></pre> 
<h5><a id="GTID_278"></a>开启GTID主从复制</h5> 
<pre><code class="prism language-sql"><span class="token comment"># 进入3309实例数据库内开启GTID连接到3306实例</span>
<span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3309/mysql.sock</span>
mysql<span class="token operator">&gt;</span> CHANGE MASTER <span class="token keyword">TO</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>    MASTER_HOST<span class="token operator">=</span><span class="token string">'172.18.1.79'</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>    MASTER_USER<span class="token operator">=</span><span class="token string">'rep'</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>    MASTER_PASSWORD<span class="token operator">=</span><span class="token string">'redhat'</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>    MASTER_PORT<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>    MASTER_AUTO_POSITION<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">start</span> slave<span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_295"></a>查看主从复制状态</h5> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager mysql<span class="token operator">-</span><span class="token number">3309</span><span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3309/mysql.sock -e "show slave status\G;" |egrep 'Slave_IO_Running:|Slave_SQL_Running:|Seconds_Behind_Master:'</span>
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
        Seconds_Behind_Master: <span class="token number">0</span>
</code></pre> 
<h5><a id="GTID_304"></a>测试GTID模式主从复制效果</h5> 
<p>可以看到当前两个实例都没有olda库，接下来在3306库创建olda库，然后查看3309库是否有同步。</p> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql -uroot -predhat -e "show databases;"</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> <span class="token keyword">Using</span> a password <span class="token keyword">on</span> the command line interface can be insecure<span class="token punctuation">.</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager mysql<span class="token operator">-</span><span class="token number">3309</span><span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3309/mysql.sock -e "show databases;"</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
</code></pre> 
<h5><a id="_330"></a>查看结果</h5> 
<p>可以看到3309实例从库也同步创建了olda库</p> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql -uroot -predhat -e "create database olda charset utf8mb4;"</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> <span class="token keyword">Using</span> a password <span class="token keyword">on</span> the command line interface can be insecure<span class="token punctuation">.</span>
<span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql -uroot -predhat -e "show databases;"</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> <span class="token keyword">Using</span> a password <span class="token keyword">on</span> the command line interface can be insecure<span class="token punctuation">.</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> olda               <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager mysql<span class="token operator">-</span><span class="token number">3309</span><span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3309/mysql.sock -e "show databases;"</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> olda               <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
sys                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token punctuation">[</span>root<span class="token variable">@mysql</span><span class="token operator">-</span>manager mysql<span class="token operator">-</span><span class="token number">3309</span><span class="token punctuation">]</span><span class="token comment"># mysql -S /opstands/mysql-3309/mysql.sock -e "show databases;"</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> olda               <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c097091f08c0fb02fb46cdbb4b2753ca/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">你真的理解c&#43;&#43;中初始化和赋值这两个概念吗？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8f2fc1dd7ede1df30a25e1702be56f52/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">教大家一个免费复制粘贴百度文库文字的方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>