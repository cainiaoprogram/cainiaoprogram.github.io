<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>python读取数据库PostgreSQL导出excel表格 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="python读取数据库PostgreSQL导出excel表格" />
<meta property="og:description" content="1.现有数据和目标成果
1.1现有数据
源数据保存在数据库中，使用的数据库管理软件是PostgreSQL。
本质上来说，数据存储在数据库中是以记录存储在表上实现的，在excel表格中也是以记录的形式存在。所以数据库中表的列（字段）可以与excel表的列一一对应。形式大致如下：
1.2目标成果
导出成果是excel表格，文件后缀名是.xlsx。形式大致如下：
2.代码过程
2.1连接数据库获取数据
要获取数据库数据必须要先连接数据库，连接PostgreSQL的方法网上很多参考，也可以参考我源代码的方式。
执行SQL（结构化查询语言），获取数据库要导出数据的表的字段数，以及要导出的记录。
一个简单的示例如下：
&#39;&#39;&#39;连接数据获取数据，WHU_Fan,0704&#39;&#39;&#39; def getData(): &#39;&#39;&#39;databese是要连接数据库的名字，user是访问用户（创建数据库时设置），password是创建数据库的密码，host填localhost，端口为安装数据库时设置的端口&#39;&#39;&#39; &#39;&#39;&#39;这里是PostgreSQL的连接方法，MySQL也类似，端口可能不一样&#39;&#39;&#39; conn = psycopg2.connect(database=&#39;test2&#39;,user=&#39;postgres&#39;,password=&#39;admin&#39;,host=&#39;localhost&#39;,port=&#39;5432&#39;) cur = conn.cursor() &#39;&#39;&#39;&#39;设置自己的sql语句&#39;&#39;&#39; &#39;&#39;&#39;例如&#39;&#39;&#39; tableName = &#39;outcome&#39; commandFindColumn = &#34;select COLUMN_NAME from information_schema.COLUMNS where table_name=&#39;%s&#39; &#34;% (tableName) &#39;&#39;&#39;执行SQL语句获取数据&#39;&#39;&#39; cur.execute(commandFindColumn) columnRows = cur.fetchall() &#39;&#39;&#39;SQL语句：导出outcome表的全部&#39;&#39;&#39; commandFindRecord = &#34;select * from %s order by 相似度 desc&#34;%(tableName) &#39;&#39;&#39;执行SQL语句获取数据&#39;&#39;&#39; cur.execute(commandFindRecord) recordRows = cur.fetchall() &#39;&#39;&#39;提交确认&#39;&#39;&#39; conn.commit() &#39;&#39;&#39;关闭连接&#39;&#39;&#39; cur.close() conn.close() &#39;&#39;&#39;返回数据&#39;&#39;&#39; return columnRows,recordRows 2.2解析数据
获取的字段变量columnRows，是一个list，顺序的包含数据库对应表的每一个字段。
获取的记录信息recordRows，也是一个list，包含所有满足条件的记录。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e04855aaa8356826ed170375ec94ce51/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-04T11:14:27+08:00" />
<meta property="article:modified_time" content="2019-07-04T11:14:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">python读取数据库PostgreSQL导出excel表格</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:0cm;"><strong>1.现有数据和目标成果</strong></p> 
<p style="margin-left:0cm;"><strong>1.1现有数据</strong></p> 
<p style="margin-left:0cm;">源数据保存在数据库中，使用的数据库管理软件是PostgreSQL。</p> 
<p style="margin-left:0cm;">本质上来说，数据存储在数据库中是以记录存储在表上实现的，在excel表格中也是以记录的形式存在。所以数据库中表的列（字段）可以与excel表的列一一对应。形式大致如下：</p> 
<p style="text-align:center;"><img alt="" class="has" height="265" src="https://images2.imgbox.com/a5/7e/38MBHRBE_o.png" width="554"></p> 
<p style="margin-left:0cm;"><strong>1.2目标成果</strong></p> 
<p style="margin-left:0cm;">导出成果是excel表格，文件后缀名是.xlsx。形式大致如下：</p> 
<p style="text-align:center;"><img alt="" class="has" height="218" src="https://images2.imgbox.com/df/34/9zotWhPd_o.png" width="554"></p> 
<p> </p> 
<p style="margin-left:0cm;"><strong>2.代码过程</strong></p> 
<p style="margin-left:0cm;"><strong>2.1连接数据库获取数据</strong></p> 
<p style="margin-left:0cm;">要获取数据库数据必须要先连接数据库，连接PostgreSQL的方法网上很多参考，也可以参考我源代码的方式。</p> 
<p style="margin-left:0cm;">执行SQL（结构化查询语言），获取数据库要导出数据的表的字段数，以及要导出的记录。</p> 
<p style="margin-left:0cm;">一个简单的示例如下：</p> 
<pre class="has"><code class="language-python">'''连接数据获取数据，WHU_Fan,0704'''
def getData():
    '''databese是要连接数据库的名字，user是访问用户（创建数据库时设置），password是创建数据库的密码，host填localhost，端口为安装数据库时设置的端口'''
    '''这里是PostgreSQL的连接方法，MySQL也类似，端口可能不一样'''
    conn = psycopg2.connect(database='test2',user='postgres',password='admin',host='localhost',port='5432')
    cur = conn.cursor()
    
    ''''设置自己的sql语句'''
    '''例如'''
    tableName = 'outcome'
    commandFindColumn = "select COLUMN_NAME from information_schema.COLUMNS where table_name='%s' "% (tableName)
    
    '''执行SQL语句获取数据'''
    cur.execute(commandFindColumn)
    columnRows = cur.fetchall()
    
    '''SQL语句：导出outcome表的全部'''
    commandFindRecord = "select * from %s order by 相似度  desc"%(tableName)
    
    '''执行SQL语句获取数据'''
    cur.execute(commandFindRecord)
    recordRows = cur.fetchall()
    
    '''提交确认'''
    conn.commit()
    
    '''关闭连接'''
    cur.close()
    conn.close()
    
    '''返回数据'''
    return columnRows,recordRows</code></pre> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><strong>2.2解析数据</strong></p> 
<p style="margin-left:0cm;">获取的字段变量columnRows，是一个list，顺序的包含数据库对应表的每一个字段。</p> 
<p style="margin-left:0cm;">获取的记录信息recordRows，也是一个list，包含所有满足条件的记录。</p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><strong>2.3写到excel中</strong></p> 
<p style="margin-left:0cm;"><strong>excel中写入数据相当于给键值对dic赋值一样，sheet[loc:value]</strong></p> 
<p style="margin-left:0cm;">1.先创建一个excel文件，然后创建一个sheet（excel的一页，一个excel可能包含多页）。</p> 
<p style="margin-left:0cm;">2.创建字段行，把表的字段先写出来。第一个字段对应A1，第二个是B1，依次类推，当字段数超过26时，添加AA，AB，AC，…</p> 
<p style="margin-left:0cm;">3.把记录写入表中，每条记录对应A2，B2，C2，…</p> 
<p style="margin-left:0cm;">4.保存表格。</p> 
<p style="margin-left:0cm;">示例代码如下：</p> 
<pre class="has"><code class="language-python">'''写到excel,WHU_Fan,0704'''
def writeDataToExcel(name):
    '''调用连接数据库函数'''
    columnRows,recordRows = getData()
    
    '''创建excel文件wb'''
    wb = openpyxl.Workbook()
    
    '''创建sheet，以传入的name为名字，默认索引0'''
    wb.create_sheet(name, 0)
    
    '''获取活动的sheet作为活动页面'''
    sheet = wb.get_sheet_by_name(name)
    
    '''获取当前日期，得到一个datetime对象如：(2019, 7, 2, 23, 12, 23, 424000)'''
    '''#将获取到的datetime对象仅取日期如：2019-7-2'''
    '''作为excel最后命名用'''
    today = datetime.today() 
    today_date = datetime.date(today) 
    
    '''创建每列的字母集，当列数超过26时，添加AA,AB,AC...'''
    myAlphbet = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z']
    
    '''把每一个字段写入excel中，excel写入的顺序是A1，B1，C1，…'''
    '''excel中写入数据相当于给键值对dic赋值一样，sheet[loc:value]'''
    for i in range(len(columnRows)):
        loc = myAlphbet[i] + str(1)
        sheet[loc] = columnRows[i][0]

    '''针对每条记录，写入表中，顺序是A2，B2，C2，…，A3,B3,C3,…，这解释为什么是 i+2'''
    for i in range(len(recordRows)):
        for j in range(len(recordRows[i])):
            loc = myAlphbet[j] + str(i + 2)
            sheet[loc] = recordRows[i][j]
    
    '''保存excel文件，默认文件位置是当前文件夹'''
    '''以传递的name+当前日期作为excel名称保存'''
    wb.save(name+ '_' + str(today_date) + '.xlsx')</code></pre> 
<p style="margin-left:0cm;"><br><strong>3.源代码</strong></p> 
<pre class="has"><code class="language-python"># encoding:utf-8
'''written by WHU_Fan,0704'''
import psycopg2
import openpyxl
from datetime import datetime

def getData():
    conn = psycopg2.connect(database='test2',user='postgres',password='admin',host='localhost',port='5432')
    cur = conn.cursor()
    tableName = 'outcome'
    commandFindColumn = "select COLUMN_NAME from information_schema.COLUMNS where table_name='%s' "%(tableName)
    cur.execute(commandFindColumn)
    columnRows = cur.fetchall()
    '''导出outcome的全部'''
    commandFindRecord = "select * from %s order by 相似度  desc"%(tableName)
    cur.execute(commandFindRecord)
    recordRows = cur.fetchall()
    conn.commit()
    cur.close()
    conn.close()
    return columnRows,recordRows
    
def writeDataToExcel(name):
    columnRows,recordRows = getData()
    
    wb = openpyxl.Workbook()
    wb.create_sheet(name, 0)
    sheet = wb.get_sheet_by_name(name)
    
    today = datetime.today() #获取当前日期，得到一个datetime对象如：(2019, 7, 2, 23, 12, 23, 424000)
    today_date = datetime.date(today) #将获取到的datetime对象仅取日期如：2019-7-2
    
    #当列数超过26时，添加AA,AB,AC...
    myAlphbet = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z']
    for i in range(len(columnRows)):
        loc = myAlphbet[i] + str(1)
        sheet[loc] = columnRows[i][0]

    for i in range(len(recordRows)):
        for j in range(len(recordRows[i])):
            loc = myAlphbet[j] + str(i + 2)
            sheet[loc] = recordRows[i][j]

    wb.save(name+ '_' + str(today_date) + '.xlsx') #以传递的name+当前日期作为excel名称保存

if __name__ == '__main__':
    writeDataToExcel("outcome")
    print("succeed")</code></pre> 
<p> </p> 
<p style="margin-left:0cm;"><strong>4.成果总结</strong></p> 
<p style="margin-left:0cm;">导出excel本身的过程并不复杂，重要为以下几点：</p> 
<p style="margin-left:0cm;">1.如何给sheet赋值，excel表的loc需要与获取的字段和记录的结构对应起来。</p> 
<p style="margin-left:0cm;">2.如何利用循环实现赋值，详见源代码的两个循环。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7f1bde54ff0208470ac3bc5b386c7deb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PHP微信公众开发笔记(六)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/533e635a8104a6bce12ccbf690c1ac3c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">50个必备的jquery代码段</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>