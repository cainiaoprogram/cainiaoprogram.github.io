<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL 消息 7391，因为链接服务器‘’的OLE DB访问接口 ‘SQLNCLI’无法启动分布式事务问题处理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SQL 消息 7391，因为链接服务器‘’的OLE DB访问接口 ‘SQLNCLI’无法启动分布式事务问题处理" />
<meta property="og:description" content="系统：Windows Server 2008 &#43;MS SQL 2008 2R
场景：在将SQL 2005数据库迁移到SQL 2008上时对链接服务器的数据表做增删改是正常的，在触发器中对链接服务器的数据表做增删改就有问题了，上图
来自微软官方的决解方案：
https://support.microsoft.com/zh-cn/help/329332/you-receive-error-7391-when-you-run-a-distributed-transaction-against
来自网络对该问题处理方式（测试无效做个记录方便以后排查问题）
--1、是否启动MSDTC服务（需确认双方服务器都开启）
--2、双方135端口是否开启、是否被占用（可用 telnet IP 135 指令检测端口是否打开）
--3、保证没有在发起事物的服务器里执行链接服务器上的查询、视图、存储过程中包含有访问发起事物服务器的操作，
-- 这样的操作叫环回（loopback），举个“栗子”：A服务器中执行链接服务器B的存储过程sp_b,在sp_b中存在访问A的操作
--4、查看MSDTC设置
-- 打开“管理工具-》组件服务-》计算机-》我的电脑-》MSDTC选项-》安全配置
-- 在安全配置里选中：
-- （1）网络DTC访问
-- （2）允许远程客户端、允许远程管理
-- （3）允许入站、允许出站、不要求进行验证
-- （4）DTC登录用户必须保证为：NT Authority/NetWork Service
-- 配置完以上所有重启服务器使配置生效（有些电脑可能要先启动DTC服务然后在启动SQL SERVER服务）
--5、链接服务器名称解析问题
-- 找到服务器中的hots文件添加IP &#43; 服务器名称解析
以上所有步骤执行完发现问题依旧存在（这时候基本可以排除MSDTC服务的问题了）
继续排查MSDTC依赖组件是否有问题
可以看出DTC依赖的几个系统组件
这时候祭出微软的dtcping.exe 下载地址：https://www.microsoft.com/en-us/download/details.aspx?id=2868
（dtcping 可能无法直接ping IP 所以需要在系统的host文件中添加IP映射）
.
从这里看的出是RPC服务有问题
CMKERP2 IP=xxx.24.78.30
ERP-GHN0 IP=xxx.24.78.65
但是在CMKERP2中 用DTCPING工具ping ERP-GHN0 IP=xxx.24.78.100
到现在为止问题很明显了就是存在两台服务器名称一致但是IP不同并且两台电脑存在同一个域中
导致了两台服务器通过服务器名称相互访问时一直导致RPC有问题
最后将.100这台服务器名称改了，并且在域中的映射也改了，最后ERP-GHN0指向了.65
问题决解
最后可通过cmd指令 nbtstat -a IP来取得主机名" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f4b7d3925e5dc75b9c51bcb26fb04234/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-02-26T09:59:16+08:00" />
<meta property="article:modified_time" content="2019-02-26T09:59:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL 消息 7391，因为链接服务器‘’的OLE DB访问接口 ‘SQLNCLI’无法启动分布式事务问题处理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>系统：Windows Server 2008   +MS SQL 2008 2R</p> 
<p>场景：在将SQL 2005数据库迁移到SQL 2008上时对链接服务器的数据表做增删改是正常的，在触发器中对链接服务器的数据表做增删改就有问题了，上图</p> 
<p><img alt="" class="has" height="519" src="https://images2.imgbox.com/e7/9c/Xs8ipDju_o.png" width="722"></p> 
<p>来自微软官方的决解方案：</p> 
<p><a href="https://support.microsoft.com/zh-cn/help/329332/you-receive-error-7391-when-you-run-a-distributed-transaction-against" rel="nofollow">https://support.microsoft.com/zh-cn/help/329332/you-receive-error-7391-when-you-run-a-distributed-transaction-against</a></p> 
<p>来自网络对该问题处理方式（测试无效做个记录方便以后排查问题）<br> --1、是否启动MSDTC服务（需确认双方服务器都开启）<br> --2、双方135端口是否开启、是否被占用（可用 telnet IP 135 指令检测端口是否打开）<br> --3、保证没有在发起事物的服务器里执行链接服务器上的查询、视图、存储过程中包含有访问发起事物服务器的操作，<br> --   这样的操作叫环回（loopback），举个“栗子”：A服务器中执行链接服务器B的存储过程sp_b,在sp_b中存在访问A的操作<br> --4、查看MSDTC设置<br> --   打开“管理工具-》组件服务-》计算机-》我的电脑-》MSDTC选项-》安全配置<br> --   在安全配置里选中：<br> --  （1）网络DTC访问<br> --  （2）允许远程客户端、允许远程管理<br> --  （3）允许入站、允许出站、不要求进行验证<br> --  （4）DTC登录用户必须保证为：NT Authority/NetWork Service<br> --   配置完以上所有重启服务器使配置生效（有些电脑可能要先启动DTC服务然后在启动SQL SERVER服务）<br> --5、链接服务器名称解析问题<br> --   找到服务器中的hots文件添加IP  + 服务器名称解析</p> 
<p>以上所有步骤执行完发现问题依旧存在（这时候基本可以排除MSDTC服务的问题了）</p> 
<p>继续排查MSDTC依赖组件是否有问题</p> 
<p><img alt="" class="has" height="439" src="https://images2.imgbox.com/16/39/mgkVxOA4_o.png" width="414"></p> 
<p>可以看出DTC依赖的几个系统组件</p> 
<p>这时候祭出微软的dtcping.exe  下载地址：<a href="https://www.microsoft.com/en-us/download/details.aspx?id=2868" rel="nofollow">https://www.microsoft.com/en-us/download/details.aspx?id=2868</a></p> 
<p>（dtcping 可能无法直接ping IP 所以需要在系统的host文件中添加IP映射）</p> 
<p> </p> 
<p><img alt="" class="has" height="248" src="https://images2.imgbox.com/09/38/NGCLCWNm_o.png" width="474"></p> 
<p> </p> 
<p><img alt="" class="has" height="303" src="https://images2.imgbox.com/6b/67/kxMAmsmn_o.png" width="542">.</p> 
<p>从这里看的出是RPC服务有问题</p> 
<p>CMKERP2  IP=xxx.24.78.30</p> 
<p>ERP-GHN0  IP=xxx.24.78.65</p> 
<p>但是在CMKERP2中 用DTCPING工具ping ERP-GHN0  IP=xxx.24.78.100</p> 
<p>到现在为止问题很明显了就是存在两台服务器名称一致但是IP不同并且两台电脑存在同一个域中</p> 
<p>导致了两台服务器通过服务器名称相互访问时一直导致RPC有问题</p> 
<p>最后将.100这台服务器名称改了，并且在域中的映射也改了，最后ERP-GHN0指向了.65</p> 
<p>问题决解</p> 
<p><img alt="" class="has" height="670" src="https://images2.imgbox.com/c9/a3/lTtTQ30C_o.png" width="906"></p> 
<p>最后可通过cmd指令  nbtstat  -a IP来取得主机名</p> 
<p>结论：因为链接服务器‘’的OLE DB访问接口 ‘SQLNCLI’无法启动分布式事务问题处理  这个问题产生的原因不一定是因为MSDTC服务配置的问题、有可能是MSDTC依赖的系统组件有问题造成的，所以排查该问题时在确定MSDTC配置正确之后该问题依旧存在的话，那么就去排查MSDTC依赖的组件是否存在问题.</p> 
<p> </p> 
<p>有遇到其他情况的歡迎留言讨论这个问题！！！！</p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e6f0d55e6cc91ecbd502f2369bfc4c08/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mockito框架@Mock, @InjectMocks注解使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b7176c7dcd8489d4b0c3468823941ee6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python下判断文件夹是否存在并创建文件夹</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>