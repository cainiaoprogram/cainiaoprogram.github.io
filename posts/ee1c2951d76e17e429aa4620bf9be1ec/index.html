<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>访问url图片并上传oss图片显示不完整问题解决 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="访问url图片并上传oss图片显示不完整问题解决" />
<meta property="og:description" content="问题：在之前通过链接上传图片的时候，都是先获取inputStream流，然后通过available()方法获取文件大小。但是通过这种方法获取到的文件大小是不准确的，因为这个时候文件还没有读取完全，所以获取到的文件大小是不完全的。
所以导致上传的文件只显示了一半不到。
解决方法：
在使用oss上传时需要传文件大小的参数,方法： objectMetadata.setContentLength(file.length())。
URL url = new URL(posturl); URLConnection uc = url.openConnection(); // 打开的连接读取的输入流。 InputStream in = uc.getInputStream(); String substring = posturl.substring(posturl.lastIndexOf(&#34;.&#34;)).toLowerCase(); String fileName = IdUtil.fastSimpleUUID() &#43; substring; res = ossUtil.putObject(in, fileName, filedir, uc.getContentLengthLong()); in.close(); public String putObject(InputStream inputStream, String fileName, String filedir, Long fileLength) { try { uploadFileOSSWithLength(inputStream, fileName, filedir, fileLength); String str = getFileUrl(fileName, filedir); return str.trim(); } catch (Exception e) { throw new RuntimeException(&#34;上传失败！&#34;); } } private String uploadFileOSSWithLength(InputStream instream, String fileName, String path, Long fileLength) { String ret = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ee1c2951d76e17e429aa4620bf9be1ec/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-21T09:16:56+08:00" />
<meta property="article:modified_time" content="2022-04-21T09:16:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">访问url图片并上传oss图片显示不完整问题解决</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>问题：在之前通过链接上传图片的时候，都是先获取inputStream流，然后通过available()方法获取文件大小。但是通过这种方法获取到的文件大小是不准确的，因为这个时候文件还没有读取完全，所以获取到的文件大小是不完全的。</p> 
<p>所以导致上传的文件只显示了一半不到。</p> 
<p><img alt="" height="323" src="https://images2.imgbox.com/55/53/kUwCwYjs_o.png" width="323"></p> 
<p><strong>解决方法：</strong></p> 
<p>在使用oss上传时需要传文件大小的参数,方法： objectMetadata.setContentLength(file.length())。</p> 
<pre><code class="language-java">            URL url = new URL(posturl);
            URLConnection uc = url.openConnection();
            // 打开的连接读取的输入流。
            InputStream in = uc.getInputStream();
            String substring = posturl.substring(posturl.lastIndexOf(".")).toLowerCase();
            String fileName = IdUtil.fastSimpleUUID() + substring;
            res = ossUtil.putObject(in, fileName, filedir, uc.getContentLengthLong());
            in.close();</code></pre> 
<pre><code class="language-java">    public String putObject(InputStream inputStream, String fileName, String filedir, Long fileLength) {
        try {
            uploadFileOSSWithLength(inputStream, fileName, filedir, fileLength);
            String str = getFileUrl(fileName, filedir);
            return str.trim();
        } catch (Exception e) {
            throw new RuntimeException("上传失败！");
        }
    }</code></pre> 
<pre><code class="language-java">    private String uploadFileOSSWithLength(InputStream instream, String fileName, String path, Long fileLength) {
        String ret = "";
        try {
            //创建上传Object的Metadata
            ObjectMetadata objectMetadata = new ObjectMetadata();
            objectMetadata.setContentLength(instream.available());
            objectMetadata.setCacheControl("no-cache");
            objectMetadata.setHeader("Pragma", "no-cache");
            objectMetadata.setContentDisposition("inline;filename=" + fileName);
            objectMetadata.setContentLength(fileLength);
            //上传文件
            OSSClient ossClient = new OSSClient(endpoint, accessKeyId, accessKeySecret);
            PutObjectResult putResult = ossClient.putObject(bucketName, path + fileName, instream, objectMetadata);
            ret = putResult.getETag();
        } catch (IOException e) {
            log.error(e.getMessage(), e);
        } finally {
            try {
                if (instream != null) {
                    instream.close();
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return ret;
    }</code></pre> 
<p>使用.getContentLengthLong()这个方法获取文件的实际大小，然后再作为参数传递到oss上传的方法中</p> 
<p><strong>最终效果：</strong></p> 
<p><img alt="" height="319" src="https://images2.imgbox.com/f2/26/2CtmGhJJ_o.png" width="320"></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/05a650c2313429c7196b998f12f5b1f8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于Linux的C&#43;&#43;轻量级web服务器/webserver/httpserver——httpconnect模块介绍</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a3d5ccccade699d6ac8c475985165599/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL时间字段TIMESTAMP、DATETIME（自动更新、毫秒存储）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>