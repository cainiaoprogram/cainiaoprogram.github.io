<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>YOLOv7 | 模型结构与正负样本分配解析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="YOLOv7 | 模型结构与正负样本分配解析" />
<meta property="og:description" content="如有错误，恳请指出。
Yolov7的原作者就是Yolov4的原作者。看论文的时候看到比较乱，这里可能会比较杂乱的记录一下我觉得有点启发的东西。对于yolov7的代码，我也没有仔细的看，只是大概的看了下其他博客提到的些细节。所以这里也不会具体的解析代码。
文章目录 1. 相关工作2. 网络结构2.1 ELAN2.2 SPPCSPC2.3 MP 3. 样本分配策略4. 辅助损失5. 实验结果与总结 1. 相关工作 我觉得yolov7论文的 Related work 的前两小节写得指导性很大。
当前目标检测的主要优化方向：更快更强的网络架构；更有效的特征集成方法；更准确的检测方法；更精确的损失函数；更有效的标签分配方法；更有效的训练策略
同时还介绍了下模型的重参数化，可以将其看成是一种集成技术。现在可以将模型的重参数化分成两类：模块级集成（module-level ensemble）和模型级集成（model-level ensemble）。
对于模型级重参数化有两种常见的做法，一种是用不同的训练数据训练多个相同的模型，然后对多个训练模型的权重进行平均。另一种是对不同迭代次数下的模型权重进行加权平均。对于模块级重参数化是在训练期间将模块拆分为多个相同或不同的模块分支，并在推理期间将多个分支模块集成为完全等效的模块。然而，并非所有提出的重新参数化模块都能完美地应用于不同的体系结构。 之后的内容，无论是看单独看文章还是单独看源码，其实都比较难直观的了解整个网路的结构，所以还是要借助其他大佬画图做笔记。
2. 网络结构 无论是在源码中还是在文章里，都无法像yolov6那样直观地查看整个yolov7的backbone，neck和head结构。所以这里也只能自行的配合源码来作图。不过，幸运的是，已经有不少大佬画出了结构图。详细解析见参考资料3,4。
yolov7网络的结构图 先来查看yolov7.yaml的配置，代码作了部分的删减
# parameters nc: 80 # number of classes depth_multiple: 1.0 # model depth multiple width_multiple: 1.0 # layer channel multiple # anchors anchors: - [12,16, 19,36, 40,28] # P3/8 - [36,75, 76,55, 72,146] # P4/16 - [142,110, 192,243, 459,401] # P5/32 # yolov7 backbone backbone: # [from, number, module, args] [[-1, 1, Conv, [32, 3, 1]], # 0 ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8981fd10b4638e7fe30336f0a94643e5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-28T12:24:04+08:00" />
<meta property="article:modified_time" content="2022-08-28T12:24:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">YOLOv7 | 模型结构与正负样本分配解析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <hr> 
<p><strong>如有错误，恳请指出。</strong></p> 
<hr> 
<p>Yolov7的原作者就是Yolov4的原作者。看论文的时候看到比较乱，这里可能会比较杂乱的记录一下我觉得有点启发的东西。对于yolov7的代码，我也没有仔细的看，只是大概的看了下其他博客提到的些细节。所以这里也不会具体的解析代码。</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__9" rel="nofollow">1. 相关工作</a></li><li><a href="#2__21" rel="nofollow">2. 网络结构</a></li><li><ul><li><a href="#21_ELAN_115" rel="nofollow">2.1 ELAN</a></li><li><a href="#22_SPPCSPC_148" rel="nofollow">2.2 SPPCSPC</a></li><li><a href="#23_MP_175" rel="nofollow">2.3 MP</a></li></ul> 
  </li><li><a href="#3__201" rel="nofollow">3. 样本分配策略</a></li><li><a href="#4__514" rel="nofollow">4. 辅助损失</a></li><li><a href="#5__1127" rel="nofollow">5. 实验结果与总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__9"></a>1. 相关工作</h2> 
<p>我觉得yolov7论文的 <code>Related work</code> 的前两小节写得指导性很大。</p> 
<p>当前目标检测的主要优化方向：<strong>更快更强的网络架构；更有效的特征集成方法；更准确的检测方法；更精确的损失函数；更有效的标签分配方法；更有效的训练策略</strong></p> 
<p>同时还介绍了下模型的重参数化，可以将其看成是一种集成技术。现在可以将模型的重参数化分成两类：<strong>模块级集成</strong>（module-level ensemble）和<strong>模型级集成</strong>（model-level ensemble）。</p> 
<ul><li>对于<strong>模型级重参数化</strong>有两种常见的做法，一种是用不同的训练数据训练多个相同的模型，然后对多个训练模型的权重进行平均。另一种是对不同迭代次数下的模型权重进行加权平均。</li><li>对于<strong>模块级重参数化</strong>是在训练期间将模块拆分为多个相同或不同的模块分支，并在推理期间将多个分支模块集成为完全等效的模块。然而，并非所有提出的重新参数化模块都能完美地应用于不同的体系结构。</li></ul> 
<p>之后的内容，无论是看单独看文章还是单独看源码，其实都比较难直观的了解整个网路的结构，所以还是要借助其他大佬画图做笔记。</p> 
<hr> 
<h2><a id="2__21"></a>2. 网络结构</h2> 
<p>无论是在源码中还是在文章里，都无法像yolov6那样直观地查看整个yolov7的backbone，neck和head结构。所以这里也只能自行的配合源码来作图。不过，幸运的是，已经有不少大佬画出了结构图。详细解析见参考资料3,4。</p> 
<ul><li><strong>yolov7网络的结构图</strong></li></ul> 
<p><img src="https://images2.imgbox.com/0b/bf/NMBamB1U_o.png" alt="在这里插入图片描述"></p> 
<p>先来查看yolov7.yaml的配置，代码作了部分的删减</p> 
<pre><code class="prism language-python"><span class="token comment"># parameters</span>
nc<span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token comment"># number of classes</span>
depth_multiple<span class="token punctuation">:</span> <span class="token number">1.0</span>  <span class="token comment"># model depth multiple</span>
width_multiple<span class="token punctuation">:</span> <span class="token number">1.0</span>  <span class="token comment"># layer channel multiple</span>

<span class="token comment"># anchors</span>
anchors<span class="token punctuation">:</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">]</span>  <span class="token comment"># P3/8</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span><span class="token number">146</span><span class="token punctuation">]</span>  <span class="token comment"># P4/16</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">142</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span><span class="token number">243</span><span class="token punctuation">,</span> <span class="token number">459</span><span class="token punctuation">,</span><span class="token number">401</span><span class="token punctuation">]</span>  <span class="token comment"># P5/32</span>

<span class="token comment"># yolov7 backbone</span>
backbone<span class="token punctuation">:</span>
  <span class="token comment"># [from, number, module, args]</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 0</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 42-P5/32  </span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 50</span>
  <span class="token punctuation">]</span>

<span class="token comment"># yolov7 head</span>
head<span class="token punctuation">:</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SPPCSPC<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment"># 51</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment"># 101</span>
   
   <span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> RepConv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> RepConv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> RepConv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token number">103</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> IDetect<span class="token punctuation">,</span> <span class="token punctuation">[</span>nc<span class="token punctuation">,</span> anchors<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment"># Detect(P3, P4, P5)</span>
  <span class="token punctuation">]</span>

</code></pre> 
<p>这里可以看见，yolov7对于网络的配置，其实是和yolov5是一致的。也就说，大部分是复用了yolov5项目的代码。从yaml文件中，可以看出，其通过一层层的卷积来构建，但是无法直观的区分每一个积木的形状。</p> 
<p>在yolov7的配置网络中，RepConv是将3×3卷积、1×1卷积和Identity连接组合在一个卷积层中。MP是最大池化nn.MaxPool2d，Conv是卷积+bn+激活（SiLU），SPPCSPC是在yolov7中新提出的一个SPP结构作为一个小的特征融合模块。最后使用的IDetect和yolov5中是detect头是完全一样的。原始的yolov7结构没有使用辅助的训练头。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span>k<span class="token punctuation">,</span> stride<span class="token operator">=</span>k<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Conv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Standard convolution</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, kernel, stride, padding, groups</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Conv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> autopad<span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>g<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>c2<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act <span class="token operator">=</span> nn<span class="token punctuation">.</span>SiLU<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> act <span class="token keyword">is</span> <span class="token boolean">True</span> <span class="token keyword">else</span> <span class="token punctuation">(</span>act <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>act<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span> <span class="token keyword">else</span> nn<span class="token punctuation">.</span>Identity<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">fuseforward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>对于上面贴出来的网络结构图，Rep就是参数重结构化，实现训练和推理过程解耦（但是yolov7这里用的也不多，甚至不是全系列都用上了，只用了部分版本，有点迷）。值得注意的是，这里提出了几个新模块：<strong>ELAN、SPPCSPC、MP结构</strong></p> 
<h3><a id="21_ELAN_115"></a>2.1 ELAN</h3> 
<p>这个东西在论文上花了一小节去讲：<br> <img src="https://images2.imgbox.com/4a/70/vyatAnoG_o.png" alt="在这里插入图片描述"><br> 但是在代码中很难直观的体现，因为源码中他不是构建为一个积木，而是由更原始的积木Conv来堆叠（这个整个模型搭建的方法有关，无法改变）。</p> 
<pre><code class="prism language-python"><span class="token comment"># ELAN</span>
<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 50</span>

<span class="token comment"># ELAN-W</span>
<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment"># 63</span>
</code></pre> 
<p>其可以表示为：<br> <img src="https://images2.imgbox.com/ef/09/CPLYH6nv_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22_SPPCSPC_148"></a>2.2 SPPCSPC</h3> 
<p>代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SPPCSPC</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># CSP https://github.com/WongKinYiu/CrossStagePartialNetworks</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SPPCSPC<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>  <span class="token comment"># hidden channels</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv3 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv4 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span>x<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span>x <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> k<span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv5 <span class="token operator">=</span> Conv<span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> c_<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv6 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv7 <span class="token operator">=</span> Conv<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> c_<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv4<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv3<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        y1 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv6<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv5<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>m<span class="token punctuation">(</span>x1<span class="token punctuation">)</span> <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>m<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        y2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>y1<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>结构图：<br> <img src="https://images2.imgbox.com/b8/6b/l1r9BQS1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23_MP_175"></a>2.3 MP</h3> 
<p>代码：</p> 
<pre><code class="prism language-python"><span class="token comment"># MP-1</span>
<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 16-P3/8  </span>

<span class="token comment"># MP-2</span>
<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> 
<p>结构图：<br> <img src="https://images2.imgbox.com/65/51/KYBMQYXD_o.png" alt="在这里插入图片描述"><br> 之前下采样我们通常最开始使用maxpooling，之后大家又都选用stride = 2的3*3卷积。这里作者充分发挥：“小孩子才做选择，大人都要”的原则，同时使用了max pooling 和 stride=2的conv。</p> 
<p>而这两者的区别只是通道数的变化。</p> 
<hr> 
<h2><a id="3__201"></a>3. 样本分配策略</h2> 
<p>详细见参考资料1.</p> 
<p>首先，yolov7也仍然是anchor base的目标检测算法，yolov7将yolov5和YOLOX中的正负样本分配策略进行结合，流程如下：</p> 
<ol><li>yolov5:使用yolov5正负样本分配策略分配正样本。</li><li>YOLOX:计算每个样本对每个GT的Reg+Cla loss（Loss aware）</li><li>YOLOX:使用每个GT的预测样本确定它需要分配到的正样本数（Dynamic k）</li><li>YOLOX:为每个GT取loss最小的前dynamic k个样本作为正样本</li><li>YOLOX:人工去掉同一个样本被分配到多个GT的正样本的情况（全局信息）</li></ol> 
<p>其实主要是将<strong>simOTA中的第一步“使用中心先验”替换成“yolov5中的策略”</strong>。yolov5策略与YOLOX中simOTA策略的融合，相较于只使用yolov5策略，加入了loss aware，利用当前模型的表现，能够再进行一次精筛。而融合策略相较于只使用YOLOX中simOTA，能<strong>够提供更精确的先验知识。</strong></p> 
<p>yolov6等工作中也都使用了simOTA作为分配策略，可见simOTA确实是能带来很大提升的策略。</p> 
<ul><li><strong>参考代码：</strong></li></ul> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ComputeLossOTA</span><span class="token punctuation">:</span>
    <span class="token comment"># Compute losses</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> autobalance<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ComputeLossOTA<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        device <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>device  <span class="token comment"># get model device</span>
        h <span class="token operator">=</span> model<span class="token punctuation">.</span>hyp  <span class="token comment"># hyperparameters</span>

        <span class="token comment"># Define criteria</span>
        BCEcls <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span>pos_weight<span class="token operator">=</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>h<span class="token punctuation">[</span><span class="token string">'cls_pw'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
        BCEobj <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span>pos_weight<span class="token operator">=</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>h<span class="token punctuation">[</span><span class="token string">'obj_pw'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Class label smoothing https://arxiv.org/pdf/1902.04103.pdf eqn 3</span>
        self<span class="token punctuation">.</span>cp<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn <span class="token operator">=</span> smooth_BCE<span class="token punctuation">(</span>eps<span class="token operator">=</span>h<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'label_smoothing'</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># positive, negative BCE targets</span>

        <span class="token comment"># Focal loss</span>
        g <span class="token operator">=</span> h<span class="token punctuation">[</span><span class="token string">'fl_gamma'</span><span class="token punctuation">]</span>  <span class="token comment"># focal loss gamma</span>
        <span class="token keyword">if</span> g <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            BCEcls<span class="token punctuation">,</span> BCEobj <span class="token operator">=</span> FocalLoss<span class="token punctuation">(</span>BCEcls<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">,</span> FocalLoss<span class="token punctuation">(</span>BCEobj<span class="token punctuation">,</span> g<span class="token punctuation">)</span>

        det <span class="token operator">=</span> model<span class="token punctuation">.</span>module<span class="token punctuation">.</span>model<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> is_parallel<span class="token punctuation">(</span>model<span class="token punctuation">)</span> <span class="token keyword">else</span> model<span class="token punctuation">.</span>model<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># Detect() module</span>
        self<span class="token punctuation">.</span>balance <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>det<span class="token punctuation">.</span>nl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">.02</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># P3-P7</span>
        self<span class="token punctuation">.</span>ssi <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>det<span class="token punctuation">.</span>stride<span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">if</span> autobalance <span class="token keyword">else</span> <span class="token number">0</span>  <span class="token comment"># stride 16 index</span>
        self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">,</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">,</span> self<span class="token punctuation">.</span>gr<span class="token punctuation">,</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">,</span> self<span class="token punctuation">.</span>autobalance <span class="token operator">=</span> BCEcls<span class="token punctuation">,</span> BCEobj<span class="token punctuation">,</span> model<span class="token punctuation">.</span>gr<span class="token punctuation">,</span> h<span class="token punctuation">,</span> autobalance
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token string">'na'</span><span class="token punctuation">,</span> <span class="token string">'nc'</span><span class="token punctuation">,</span> <span class="token string">'nl'</span><span class="token punctuation">,</span> <span class="token string">'anchors'</span><span class="token punctuation">,</span> <span class="token string">'stride'</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>det<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># predictions, targets, model   </span>
        device <span class="token operator">=</span> targets<span class="token punctuation">.</span>device
        lcls<span class="token punctuation">,</span> lbox<span class="token punctuation">,</span> lobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        bs<span class="token punctuation">,</span> as_<span class="token punctuation">,</span> gjs<span class="token punctuation">,</span> gis<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>build_targets<span class="token punctuation">(</span>p<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span>
        pre_gen_gains <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>pp<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span> 
    

        <span class="token comment"># Losses</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> pi <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># layer index, layer predictions</span>
            b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> as_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># image, anchor, gridy, gridx</span>
            tobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>pi<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># target obj</span>

            n <span class="token operator">=</span> b<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># number of targets</span>
            <span class="token keyword">if</span> n<span class="token punctuation">:</span>
                ps <span class="token operator">=</span> pi<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span>  <span class="token comment"># prediction subset corresponding to targets</span>

                <span class="token comment"># Regression</span>
                grid <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>gi<span class="token punctuation">,</span> gj<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxy <span class="token operator">=</span> ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span>
                <span class="token comment">#pxy = ps[:, :2].sigmoid() * 3. - 1.</span>
                pwh <span class="token operator">=</span> <span class="token punctuation">(</span>ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                pbox <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># predicted box</span>
                selected_tbox <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> pre_gen_gains<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                selected_tbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-=</span> grid
                iou <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>pbox<span class="token punctuation">.</span>T<span class="token punctuation">,</span> selected_tbox<span class="token punctuation">,</span> x1y1x2y2<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># iou(prediction, target)</span>
                lbox <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># iou loss</span>

                <span class="token comment"># Objectness</span>
                tobj<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>gr<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>gr <span class="token operator">*</span> iou<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>tobj<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>  <span class="token comment"># iou ratio</span>

                <span class="token comment"># Classification</span>
                selected_tcls <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>nc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># cls loss (only if multiple classes)</span>
                    t <span class="token operator">=</span> torch<span class="token punctuation">.</span>full_like<span class="token punctuation">(</span>ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># targets</span>
                    t<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> selected_tcls<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>cp
                    lcls <span class="token operator">+=</span> self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">(</span>ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>  <span class="token comment"># BCE</span>

                <span class="token comment"># Append targets to text file</span>
                <span class="token comment"># with open('targets.txt', 'a') as file:</span>
                <span class="token comment">#     [file.write('%11.5g ' * 4 % tuple(x) + '\n') for x in torch.cat((txy[i], twh[i]), 1)]</span>

            obji <span class="token operator">=</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">(</span>pi<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tobj<span class="token punctuation">)</span>
            lobj <span class="token operator">+=</span> obji <span class="token operator">*</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># obj loss</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>autobalance<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.9999</span> <span class="token operator">+</span> <span class="token number">0.0001</span> <span class="token operator">/</span> obji<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>autobalance<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>balance <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">/</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>self<span class="token punctuation">.</span>ssi<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">]</span>
        lbox <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span>
        lobj <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'obj'</span><span class="token punctuation">]</span>
        lcls <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'cls'</span><span class="token punctuation">]</span>
        bs <span class="token operator">=</span> tobj<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># batch size</span>

        loss <span class="token operator">=</span> lbox <span class="token operator">+</span> lobj <span class="token operator">+</span> lcls
        <span class="token keyword">return</span> loss <span class="token operator">*</span> bs<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>lbox<span class="token punctuation">,</span> lobj<span class="token punctuation">,</span> lcls<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">build_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        <span class="token comment">#indices, anch = self.find_positive(p, targets)</span>
        indices<span class="token punctuation">,</span> anch <span class="token operator">=</span> self<span class="token punctuation">.</span>find_3_positive<span class="token punctuation">(</span>p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>
        <span class="token comment">#indices, anch = self.find_4_positive(p, targets)</span>
        <span class="token comment">#indices, anch = self.find_5_positive(p, targets)</span>
        <span class="token comment">#indices, anch = self.find_9_positive(p, targets)</span>

        matching_bs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_as <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_gjs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_gis <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_targets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_anchs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        
        nl <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>    
    
        <span class="token keyword">for</span> batch_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        
            b_idx <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>batch_idx
            this_target <span class="token operator">=</span> targets<span class="token punctuation">[</span>b_idx<span class="token punctuation">]</span>
            <span class="token keyword">if</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
                
            txywh <span class="token operator">=</span> this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> imgs<span class="token punctuation">[</span>batch_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            txyxy <span class="token operator">=</span> xywh2xyxy<span class="token punctuation">(</span>txywh<span class="token punctuation">)</span>

            pxyxys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            p_cls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            p_obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            from_which_layer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_gj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_gi <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_anch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> pi <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
                
                b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                idx <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> batch_idx<span class="token punctuation">)</span>
                b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> b<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gj<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gi<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>                
                all_b<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
                all_a<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
                all_gj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gj<span class="token punctuation">)</span>
                all_gi<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gi<span class="token punctuation">)</span>
                all_anch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                from_which_layer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">)</span>
                
                fg_pred <span class="token operator">=</span> pi<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span>                
                p_obj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                p_cls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                
                grid <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>gi<span class="token punctuation">,</span> gj<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxy <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">#/ 8.</span>
                <span class="token comment">#pxy = (fg_pred[:, :2].sigmoid() * 3. - 1. + grid) * self.stride[i]</span>
                pwh <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">#/ 8.</span>
                pxywh <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxyxy <span class="token operator">=</span> xywh2xyxy<span class="token punctuation">(</span>pxywh<span class="token punctuation">)</span>
                pxyxys<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pxyxy<span class="token punctuation">)</span>
            
            pxyxys <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>pxyxys<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            p_obj <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_obj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            p_cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_cls<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            from_which_layer <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>from_which_layer<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_b <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_b<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_a <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_a<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_gj <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_gi <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gi<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_anch <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_anch<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        
            pair_wise_iou <span class="token operator">=</span> box_iou<span class="token punctuation">(</span>txyxy<span class="token punctuation">,</span> pxyxys<span class="token punctuation">)</span>

            pair_wise_iou_loss <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>pair_wise_iou <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>

            top_k<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pair_wise_iou<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> pair_wise_iou<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            dynamic_ks <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>top_k<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

            gt_cls_per_image <span class="token operator">=</span> <span class="token punctuation">(</span>
                F<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

            num_gt <span class="token operator">=</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            cls_preds_ <span class="token operator">=</span> <span class="token punctuation">(</span>
                p_cls<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">*</span> p_obj<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

            y <span class="token operator">=</span> cls_preds_<span class="token punctuation">.</span>sqrt_<span class="token punctuation">(</span><span class="token punctuation">)</span>
            pair_wise_cls_loss <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>
               torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>y<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> gt_cls_per_image<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">del</span> cls_preds_
        
            cost <span class="token operator">=</span> <span class="token punctuation">(</span>
                pair_wise_cls_loss
                <span class="token operator">+</span> <span class="token number">3.0</span> <span class="token operator">*</span> pair_wise_iou_loss
            <span class="token punctuation">)</span>

            matching_matrix <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>

            <span class="token keyword">for</span> gt_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_gt<span class="token punctuation">)</span><span class="token punctuation">:</span>
                _<span class="token punctuation">,</span> pos_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>
                    cost<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token operator">=</span>dynamic_ks<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> largest<span class="token operator">=</span><span class="token boolean">False</span>
                <span class="token punctuation">)</span>
                matching_matrix<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">[</span>pos_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>

            <span class="token keyword">del</span> top_k<span class="token punctuation">,</span> dynamic_ks
            anchor_matching_gt <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                _<span class="token punctuation">,</span> cost_argmin <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>cost<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">0.0</span>
                matching_matrix<span class="token punctuation">[</span>cost_argmin<span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>
            fg_mask_inboxes <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span>
            matched_gt_inds <span class="token operator">=</span> matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> fg_mask_inboxes<span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        
            from_which_layer <span class="token operator">=</span> from_which_layer<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_b <span class="token operator">=</span> all_b<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_a <span class="token operator">=</span> all_a<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_gj <span class="token operator">=</span> all_gj<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_gi <span class="token operator">=</span> all_gi<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_anch <span class="token operator">=</span> all_anch<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
        
            this_target <span class="token operator">=</span> this_target<span class="token punctuation">[</span>matched_gt_inds<span class="token punctuation">]</span>
        
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
                layer_idx <span class="token operator">=</span> from_which_layer <span class="token operator">==</span> i
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_b<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_a<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gj<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gi<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_anch<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>

        <span class="token keyword">return</span> matching_bs<span class="token punctuation">,</span> matching_as<span class="token punctuation">,</span> matching_gjs<span class="token punctuation">,</span> matching_gis<span class="token punctuation">,</span> matching_targets<span class="token punctuation">,</span> matching_anchs           

    <span class="token keyword">def</span> <span class="token function">find_3_positive</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Build targets for compute_loss(), input targets(image,class,x,y,w,h)</span>
        na<span class="token punctuation">,</span> nt <span class="token operator">=</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> targets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># number of anchors, targets</span>
        indices<span class="token punctuation">,</span> anch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        gain <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># normalized to gridspace gain</span>
        ai <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>na<span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> nt<span class="token punctuation">)</span>  <span class="token comment"># same as .repeat_interleave(nt)</span>
        targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>targets<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ai<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># append anchor indices</span>

        g <span class="token operator">=</span> <span class="token number">0.5</span>  <span class="token comment"># bias</span>
        off <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># j,k,l,m</span>
                            <span class="token comment"># [1, 1], [1, -1], [-1, 1], [-1, -1],  # jk,jm,lk,lm</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> g  <span class="token comment"># offsets</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># xyxy gain</span>

            <span class="token comment"># Match targets to anchors</span>
            t <span class="token operator">=</span> targets <span class="token operator">*</span> gain
            <span class="token keyword">if</span> nt<span class="token punctuation">:</span>
                <span class="token comment"># Matches</span>
                r <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">/</span> anchors<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># wh ratio</span>
                j <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1.</span> <span class="token operator">/</span> r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'anchor_t'</span><span class="token punctuation">]</span>  <span class="token comment"># compare</span>
                <span class="token comment"># j = wh_iou(anchors, t[:, 4:6]) &gt; model.hyp['iou_t']  # iou(3,n)=wh_iou(anchors(3,2), gwh(n,2))</span>
                t <span class="token operator">=</span> t<span class="token punctuation">[</span>j<span class="token punctuation">]</span>  <span class="token comment"># filter</span>

                <span class="token comment"># Offsets</span>
                gxy <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># grid xy</span>
                gxi <span class="token operator">=</span> gain<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">-</span> gxy  <span class="token comment"># inverse</span>
                j<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxy <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxy <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                l<span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxi <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxi <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                j <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> t<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                offsets <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>gxy<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> off<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                t <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                offsets <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token comment"># Define</span>
            b<span class="token punctuation">,</span> c <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T  <span class="token comment"># image, class</span>
            gxy <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># grid xy</span>
            gwh <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>  <span class="token comment"># grid wh</span>
            gij <span class="token operator">=</span> <span class="token punctuation">(</span>gxy <span class="token operator">-</span> offsets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            gi<span class="token punctuation">,</span> gj <span class="token operator">=</span> gij<span class="token punctuation">.</span>T  <span class="token comment"># grid xy indices</span>

            <span class="token comment"># Append</span>
            a <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># anchor indices</span>
            indices<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gi<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># image, anchor, grid indices</span>
            anch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># anchors</span>

        <span class="token keyword">return</span> indices<span class="token punctuation">,</span> anch
   
</code></pre> 
<hr> 
<h2><a id="4__514"></a>4. 辅助损失</h2> 
<p>论文中，将负责最终输出的Head为<code>lead Head</code>，将用于辅助训练的Head称为<code>auxiliary Head</code>。在代码上，aux head的assigner和lead head的assigner仅存在很少的不同<br> <img src="https://images2.imgbox.com/54/18/zzLF6gOf_o.png" alt="在这里插入图片描述"><br> 一些细节：其loss函数和不带辅助头相同，加权系数不能过大（aux head loss 和lead head loss 按照0.25:1的比例），否则会导致lead head出来的结果精度变低。匹配策略和上面的不带辅助头（只有lead head）只有很少不同，其中辅助头：</p> 
<ol><li>lead head中每个网格与gt如果匹配上，附加周边两个网格，而aux head附加4个网格（如上面导数第二幅图，匹配到浅黄+橘黄共5个网格），这里在代码中是通过控制偏置g来实现的。（除此之外的两个函数是完全一样）</li></ol> 
<pre><code class="prism language-python"><span class="token comment"># find_3_positive</span>
g <span class="token operator">=</span> <span class="token number">0.5</span>  <span class="token comment"># bias</span>

<span class="token comment"># find_5_positive</span>
g <span class="token operator">=</span> <span class="token number">1.0</span>  <span class="token comment"># bias</span>
</code></pre> 
<ol start="2"><li>如果使用了辅助头损失中，lead head中将top20个样本iou求和取整，而aux head同样是中取top20。但是如果不使用辅助头损失， head中将取top10个样本iou求和取整</li></ol> 
<pre><code class="prism language-python"><span class="token comment"># ComputeLossOTA：build_targets</span>
top_k<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pair_wise_iou<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> pair_wise_iou<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
dynamic_ks <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>top_k<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># ComputeLossAuxOTA</span>
<span class="token comment"># build_targets</span>
top_k<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pair_wise_iou<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> pair_wise_iou<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
dynamic_ks <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>top_k<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># build_targets2</span>
top_k<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pair_wise_iou<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> pair_wise_iou<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
dynamic_ks <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>top_k<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<ol start="3"><li>在loss融合方面，aux head loss 和lead head loss 按照0.25:1的比例进行融合。</li></ol> 
<pre><code class="prism language-python">lcls<span class="token punctuation">,</span> lbox<span class="token punctuation">,</span> lobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># layer index, layer predictions</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span> n<span class="token punctuation">:</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	    <span class="token comment"># Regression</span>
	    lbox <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># iou loss</span>
	
	    <span class="token comment"># Objectness</span>
	    tobj<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>gr<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>gr <span class="token operator">*</span> iou<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>tobj<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>  <span class="token comment"># iou ratio</span>
	
	    <span class="token comment"># Classification</span>
	    <span class="token keyword">if</span> self<span class="token punctuation">.</span>nc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># cls loss (only if multiple classes)</span>
	        t <span class="token operator">=</span> torch<span class="token punctuation">.</span>full_like<span class="token punctuation">(</span>ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># targets</span>
	        t<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> selected_tcls<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>cp
	        lcls <span class="token operator">+=</span> self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">(</span>ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>  <span class="token comment"># BCE</span>
	
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span> n_aux<span class="token punctuation">:</span>
	    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	    <span class="token comment"># Regression</span>
	    lbox <span class="token operator">+=</span> <span class="token number">0.25</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou_aux<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># iou loss</span>
	
	    <span class="token comment"># Objectness</span>
	    tobj_aux<span class="token punctuation">[</span>b_aux<span class="token punctuation">,</span> a_aux<span class="token punctuation">,</span> gj_aux<span class="token punctuation">,</span> gi_aux<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>gr<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>gr <span class="token operator">*</span> iou_aux<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>tobj_aux<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>  <span class="token comment"># iou ratio</span>
	
	    <span class="token comment"># Classification</span>
	    <span class="token keyword">if</span> self<span class="token punctuation">.</span>nc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># cls loss (only if multiple classes)</span>
	        t_aux <span class="token operator">=</span> torch<span class="token punctuation">.</span>full_like<span class="token punctuation">(</span>ps_aux<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># targets</span>
	        t_aux<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>n_aux<span class="token punctuation">)</span><span class="token punctuation">,</span> selected_tcls_aux<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>cp
	        lcls <span class="token operator">+=</span> <span class="token number">0.25</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">(</span>ps_aux<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t_aux<span class="token punctuation">)</span>  <span class="token comment"># BCE</span>
	
	obji <span class="token operator">=</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">(</span>pi<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tobj<span class="token punctuation">)</span>
	obji_aux <span class="token operator">=</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">(</span>pi_aux<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tobj_aux<span class="token punctuation">)</span>
	lobj <span class="token operator">+=</span> obji <span class="token operator">*</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.25</span> <span class="token operator">*</span> obji_aux <span class="token operator">*</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment"># obj loss</span>
</code></pre> 
<ol start="4"><li>aux head更关注于recall，而lead head从aux head中精准筛选出样本。</li></ol> 
<p>这里有个例子，按照yolov7中的这个正负样本分配方式，那么针对图5中，蓝色点代表着gt所处的位置，实线组成的网格代表着特征图grid，虚线代表着一个grid分成了4个象限以进行正负样本分配。</p> 
<p>如果一个gt位于蓝点位置，那么<strong>在lead head中，黄色grid将成为正样本。在aux head中，黄色+橙色grid将成为正样本。</strong></p> 
<p><img src="https://images2.imgbox.com/5f/64/HdzwHH0D_o.png" alt="在这里插入图片描述"></p> 
<p>ps：在定义损失的时候，yolov7构建了3个大类。分被是普通的yolov5的损失计算<code>ComputeLoss</code>，带SimOTA匹配的损失计算<code>ComputeLossOTA</code>，还有带辅助头和SimOTA匹配的损失计算<code>ComputeLossAuxOTA</code>。</p> 
<ul><li><strong>具体的带辅助头+SimOTA匹配策略的全部代码：</strong></li></ul> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ComputeLossAuxOTA</span><span class="token punctuation">:</span>
    <span class="token comment"># Compute losses</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> autobalance<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ComputeLossAuxOTA<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        device <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>device  <span class="token comment"># get model device</span>
        h <span class="token operator">=</span> model<span class="token punctuation">.</span>hyp  <span class="token comment"># hyperparameters</span>

        <span class="token comment"># Define criteria</span>
        BCEcls <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span>pos_weight<span class="token operator">=</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>h<span class="token punctuation">[</span><span class="token string">'cls_pw'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
        BCEobj <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span>pos_weight<span class="token operator">=</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>h<span class="token punctuation">[</span><span class="token string">'obj_pw'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Class label smoothing https://arxiv.org/pdf/1902.04103.pdf eqn 3</span>
        self<span class="token punctuation">.</span>cp<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn <span class="token operator">=</span> smooth_BCE<span class="token punctuation">(</span>eps<span class="token operator">=</span>h<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'label_smoothing'</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># positive, negative BCE targets</span>

        <span class="token comment"># Focal loss</span>
        g <span class="token operator">=</span> h<span class="token punctuation">[</span><span class="token string">'fl_gamma'</span><span class="token punctuation">]</span>  <span class="token comment"># focal loss gamma</span>
        <span class="token keyword">if</span> g <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            BCEcls<span class="token punctuation">,</span> BCEobj <span class="token operator">=</span> FocalLoss<span class="token punctuation">(</span>BCEcls<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">,</span> FocalLoss<span class="token punctuation">(</span>BCEobj<span class="token punctuation">,</span> g<span class="token punctuation">)</span>

        det <span class="token operator">=</span> model<span class="token punctuation">.</span>module<span class="token punctuation">.</span>model<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> is_parallel<span class="token punctuation">(</span>model<span class="token punctuation">)</span> <span class="token keyword">else</span> model<span class="token punctuation">.</span>model<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># Detect() module</span>
        self<span class="token punctuation">.</span>balance <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>det<span class="token punctuation">.</span>nl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">.02</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># P3-P7</span>
        self<span class="token punctuation">.</span>ssi <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>det<span class="token punctuation">.</span>stride<span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">if</span> autobalance <span class="token keyword">else</span> <span class="token number">0</span>  <span class="token comment"># stride 16 index</span>
        self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">,</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">,</span> self<span class="token punctuation">.</span>gr<span class="token punctuation">,</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">,</span> self<span class="token punctuation">.</span>autobalance <span class="token operator">=</span> BCEcls<span class="token punctuation">,</span> BCEobj<span class="token punctuation">,</span> model<span class="token punctuation">.</span>gr<span class="token punctuation">,</span> h<span class="token punctuation">,</span> autobalance
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token string">'na'</span><span class="token punctuation">,</span> <span class="token string">'nc'</span><span class="token punctuation">,</span> <span class="token string">'nl'</span><span class="token punctuation">,</span> <span class="token string">'anchors'</span><span class="token punctuation">,</span> <span class="token string">'stride'</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>det<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># predictions, targets, model   </span>
        device <span class="token operator">=</span> targets<span class="token punctuation">.</span>device
        lcls<span class="token punctuation">,</span> lbox<span class="token punctuation">,</span> lobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        bs_aux<span class="token punctuation">,</span> as_aux_<span class="token punctuation">,</span> gjs_aux<span class="token punctuation">,</span> gis_aux<span class="token punctuation">,</span> targets_aux<span class="token punctuation">,</span> anchors_aux <span class="token operator">=</span> self<span class="token punctuation">.</span>build_targets2<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">]</span><span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span>
        bs<span class="token punctuation">,</span> as_<span class="token punctuation">,</span> gjs<span class="token punctuation">,</span> gis<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>build_targets<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">]</span><span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span>
        pre_gen_gains_aux <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>pp<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">[</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">]</span><span class="token punctuation">]</span> 
        pre_gen_gains <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>pp<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">[</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">]</span><span class="token punctuation">]</span> 
    

        <span class="token comment"># Losses</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># layer index, layer predictions</span>
            pi <span class="token operator">=</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            pi_aux <span class="token operator">=</span> p<span class="token punctuation">[</span>i<span class="token operator">+</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">]</span>
            b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> as_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># image, anchor, gridy, gridx</span>
            b_aux<span class="token punctuation">,</span> a_aux<span class="token punctuation">,</span> gj_aux<span class="token punctuation">,</span> gi_aux <span class="token operator">=</span> bs_aux<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> as_aux_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> gjs_aux<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> gis_aux<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># image, anchor, gridy, gridx</span>
            tobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>pi<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># target obj</span>
            tobj_aux <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>pi_aux<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># target obj</span>

            n <span class="token operator">=</span> b<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># number of targets</span>
            <span class="token keyword">if</span> n<span class="token punctuation">:</span>
                ps <span class="token operator">=</span> pi<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span>  <span class="token comment"># prediction subset corresponding to targets</span>

                <span class="token comment"># Regression</span>
                grid <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>gi<span class="token punctuation">,</span> gj<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxy <span class="token operator">=</span> ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span>
                pwh <span class="token operator">=</span> <span class="token punctuation">(</span>ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                pbox <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># predicted box</span>
                selected_tbox <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> pre_gen_gains<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                selected_tbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-=</span> grid
                iou <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>pbox<span class="token punctuation">.</span>T<span class="token punctuation">,</span> selected_tbox<span class="token punctuation">,</span> x1y1x2y2<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># iou(prediction, target)</span>
                lbox <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># iou loss</span>

                <span class="token comment"># Objectness</span>
                tobj<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>gr<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>gr <span class="token operator">*</span> iou<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>tobj<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>  <span class="token comment"># iou ratio</span>

                <span class="token comment"># Classification</span>
                selected_tcls <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>nc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># cls loss (only if multiple classes)</span>
                    t <span class="token operator">=</span> torch<span class="token punctuation">.</span>full_like<span class="token punctuation">(</span>ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># targets</span>
                    t<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> selected_tcls<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>cp
                    lcls <span class="token operator">+=</span> self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">(</span>ps<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>  <span class="token comment"># BCE</span>

                <span class="token comment"># Append targets to text file</span>
                <span class="token comment"># with open('targets.txt', 'a') as file:</span>
                <span class="token comment">#     [file.write('%11.5g ' * 4 % tuple(x) + '\n') for x in torch.cat((txy[i], twh[i]), 1)]</span>
            
            n_aux <span class="token operator">=</span> b_aux<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># number of targets</span>
            <span class="token keyword">if</span> n_aux<span class="token punctuation">:</span>
                ps_aux <span class="token operator">=</span> pi_aux<span class="token punctuation">[</span>b_aux<span class="token punctuation">,</span> a_aux<span class="token punctuation">,</span> gj_aux<span class="token punctuation">,</span> gi_aux<span class="token punctuation">]</span>  <span class="token comment"># prediction subset corresponding to targets</span>
                grid_aux <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>gi_aux<span class="token punctuation">,</span> gj_aux<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxy_aux <span class="token operator">=</span> ps_aux<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span>
                <span class="token comment">#pxy_aux = ps_aux[:, :2].sigmoid() * 3. - 1.</span>
                pwh_aux <span class="token operator">=</span> <span class="token punctuation">(</span>ps_aux<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchors_aux<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                pbox_aux <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>pxy_aux<span class="token punctuation">,</span> pwh_aux<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># predicted box</span>
                selected_tbox_aux <span class="token operator">=</span> targets_aux<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> pre_gen_gains_aux<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                selected_tbox_aux<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-=</span> grid_aux
                iou_aux <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>pbox_aux<span class="token punctuation">.</span>T<span class="token punctuation">,</span> selected_tbox_aux<span class="token punctuation">,</span> x1y1x2y2<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># iou(prediction, target)</span>
                lbox <span class="token operator">+=</span> <span class="token number">0.25</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou_aux<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># iou loss</span>

                <span class="token comment"># Objectness</span>
                tobj_aux<span class="token punctuation">[</span>b_aux<span class="token punctuation">,</span> a_aux<span class="token punctuation">,</span> gj_aux<span class="token punctuation">,</span> gi_aux<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>gr<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>gr <span class="token operator">*</span> iou_aux<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>tobj_aux<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>  <span class="token comment"># iou ratio</span>

                <span class="token comment"># Classification</span>
                selected_tcls_aux <span class="token operator">=</span> targets_aux<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>nc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># cls loss (only if multiple classes)</span>
                    t_aux <span class="token operator">=</span> torch<span class="token punctuation">.</span>full_like<span class="token punctuation">(</span>ps_aux<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># targets</span>
                    t_aux<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>n_aux<span class="token punctuation">)</span><span class="token punctuation">,</span> selected_tcls_aux<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>cp
                    lcls <span class="token operator">+=</span> <span class="token number">0.25</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">(</span>ps_aux<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t_aux<span class="token punctuation">)</span>  <span class="token comment"># BCE</span>

            obji <span class="token operator">=</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">(</span>pi<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tobj<span class="token punctuation">)</span>
            obji_aux <span class="token operator">=</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">(</span>pi_aux<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tobj_aux<span class="token punctuation">)</span>
            lobj <span class="token operator">+=</span> obji <span class="token operator">*</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.25</span> <span class="token operator">*</span> obji_aux <span class="token operator">*</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment"># obj loss</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>autobalance<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.9999</span> <span class="token operator">+</span> <span class="token number">0.0001</span> <span class="token operator">/</span> obji<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>autobalance<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>balance <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">/</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>self<span class="token punctuation">.</span>ssi<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">]</span>
        lbox <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span>
        lobj <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'obj'</span><span class="token punctuation">]</span>
        lcls <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'cls'</span><span class="token punctuation">]</span>
        bs <span class="token operator">=</span> tobj<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># batch size</span>

        loss <span class="token operator">=</span> lbox <span class="token operator">+</span> lobj <span class="token operator">+</span> lcls
        <span class="token keyword">return</span> loss <span class="token operator">*</span> bs<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>lbox<span class="token punctuation">,</span> lobj<span class="token punctuation">,</span> lcls<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">build_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        indices<span class="token punctuation">,</span> anch <span class="token operator">=</span> self<span class="token punctuation">.</span>find_3_positive<span class="token punctuation">(</span>p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

        matching_bs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_as <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_gjs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_gis <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_targets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_anchs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        
        nl <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>    
    
        <span class="token keyword">for</span> batch_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        
            b_idx <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>batch_idx
            this_target <span class="token operator">=</span> targets<span class="token punctuation">[</span>b_idx<span class="token punctuation">]</span>
            <span class="token keyword">if</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
                
            txywh <span class="token operator">=</span> this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> imgs<span class="token punctuation">[</span>batch_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            txyxy <span class="token operator">=</span> xywh2xyxy<span class="token punctuation">(</span>txywh<span class="token punctuation">)</span>

            pxyxys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            p_cls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            p_obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            from_which_layer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_gj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_gi <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_anch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> pi <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
                
                b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                idx <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> batch_idx<span class="token punctuation">)</span>
                b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> b<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gj<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gi<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>                
                all_b<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
                all_a<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
                all_gj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gj<span class="token punctuation">)</span>
                all_gi<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gi<span class="token punctuation">)</span>
                all_anch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                from_which_layer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">)</span>
                
                fg_pred <span class="token operator">=</span> pi<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span>                
                p_obj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                p_cls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                
                grid <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>gi<span class="token punctuation">,</span> gj<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxy <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">#/ 8.</span>
                <span class="token comment">#pxy = (fg_pred[:, :2].sigmoid() * 3. - 1. + grid) * self.stride[i]</span>
                pwh <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">#/ 8.</span>
                pxywh <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxyxy <span class="token operator">=</span> xywh2xyxy<span class="token punctuation">(</span>pxywh<span class="token punctuation">)</span>
                pxyxys<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pxyxy<span class="token punctuation">)</span>
            
            pxyxys <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>pxyxys<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            p_obj <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_obj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            p_cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_cls<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            from_which_layer <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>from_which_layer<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_b <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_b<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_a <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_a<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_gj <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_gi <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gi<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_anch <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_anch<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        
            pair_wise_iou <span class="token operator">=</span> box_iou<span class="token punctuation">(</span>txyxy<span class="token punctuation">,</span> pxyxys<span class="token punctuation">)</span>

            pair_wise_iou_loss <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>pair_wise_iou <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>

            top_k<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pair_wise_iou<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> pair_wise_iou<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            dynamic_ks <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>top_k<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

            gt_cls_per_image <span class="token operator">=</span> <span class="token punctuation">(</span>
                F<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

            num_gt <span class="token operator">=</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            cls_preds_ <span class="token operator">=</span> <span class="token punctuation">(</span>
                p_cls<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">*</span> p_obj<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

            y <span class="token operator">=</span> cls_preds_<span class="token punctuation">.</span>sqrt_<span class="token punctuation">(</span><span class="token punctuation">)</span>
            pair_wise_cls_loss <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>
               torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>y<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> gt_cls_per_image<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">del</span> cls_preds_
        
            cost <span class="token operator">=</span> <span class="token punctuation">(</span>
                pair_wise_cls_loss
                <span class="token operator">+</span> <span class="token number">3.0</span> <span class="token operator">*</span> pair_wise_iou_loss
            <span class="token punctuation">)</span>

            matching_matrix <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>

            <span class="token keyword">for</span> gt_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_gt<span class="token punctuation">)</span><span class="token punctuation">:</span>
                _<span class="token punctuation">,</span> pos_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>
                    cost<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token operator">=</span>dynamic_ks<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> largest<span class="token operator">=</span><span class="token boolean">False</span>
                <span class="token punctuation">)</span>
                matching_matrix<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">[</span>pos_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>

            <span class="token keyword">del</span> top_k<span class="token punctuation">,</span> dynamic_ks
            anchor_matching_gt <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                _<span class="token punctuation">,</span> cost_argmin <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>cost<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">0.0</span>
                matching_matrix<span class="token punctuation">[</span>cost_argmin<span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>
            fg_mask_inboxes <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span>
            matched_gt_inds <span class="token operator">=</span> matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> fg_mask_inboxes<span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        
            from_which_layer <span class="token operator">=</span> from_which_layer<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_b <span class="token operator">=</span> all_b<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_a <span class="token operator">=</span> all_a<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_gj <span class="token operator">=</span> all_gj<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_gi <span class="token operator">=</span> all_gi<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_anch <span class="token operator">=</span> all_anch<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
        
            this_target <span class="token operator">=</span> this_target<span class="token punctuation">[</span>matched_gt_inds<span class="token punctuation">]</span>
        
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
                layer_idx <span class="token operator">=</span> from_which_layer <span class="token operator">==</span> i
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_b<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_a<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gj<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gi<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_anch<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>

        <span class="token keyword">return</span> matching_bs<span class="token punctuation">,</span> matching_as<span class="token punctuation">,</span> matching_gjs<span class="token punctuation">,</span> matching_gis<span class="token punctuation">,</span> matching_targets<span class="token punctuation">,</span> matching_anchs

    <span class="token keyword">def</span> <span class="token function">build_targets2</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        indices<span class="token punctuation">,</span> anch <span class="token operator">=</span> self<span class="token punctuation">.</span>find_5_positive<span class="token punctuation">(</span>p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

        matching_bs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_as <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_gjs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_gis <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_targets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        matching_anchs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> pp <span class="token keyword">in</span> p<span class="token punctuation">]</span>
        
        nl <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>    
    
        <span class="token keyword">for</span> batch_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        
            b_idx <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>batch_idx
            this_target <span class="token operator">=</span> targets<span class="token punctuation">[</span>b_idx<span class="token punctuation">]</span>
            <span class="token keyword">if</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
                
            txywh <span class="token operator">=</span> this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> imgs<span class="token punctuation">[</span>batch_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            txyxy <span class="token operator">=</span> xywh2xyxy<span class="token punctuation">(</span>txywh<span class="token punctuation">)</span>

            pxyxys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            p_cls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            p_obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            from_which_layer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_gj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_gi <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_anch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> pi <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
                
                b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                idx <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> batch_idx<span class="token punctuation">)</span>
                b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> b<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gj<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gi<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>                
                all_b<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
                all_a<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
                all_gj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gj<span class="token punctuation">)</span>
                all_gi<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gi<span class="token punctuation">)</span>
                all_anch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                from_which_layer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">)</span>
                
                fg_pred <span class="token operator">=</span> pi<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span>                
                p_obj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                p_cls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                
                grid <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>gi<span class="token punctuation">,</span> gj<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxy <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">#/ 8.</span>
                <span class="token comment">#pxy = (fg_pred[:, :2].sigmoid() * 3. - 1. + grid) * self.stride[i]</span>
                pwh <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">#/ 8.</span>
                pxywh <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxyxy <span class="token operator">=</span> xywh2xyxy<span class="token punctuation">(</span>pxywh<span class="token punctuation">)</span>
                pxyxys<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pxyxy<span class="token punctuation">)</span>
            
            pxyxys <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>pxyxys<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            p_obj <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_obj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            p_cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_cls<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            from_which_layer <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>from_which_layer<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_b <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_b<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_a <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_a<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_gj <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_gi <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gi<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_anch <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_anch<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        
            pair_wise_iou <span class="token operator">=</span> box_iou<span class="token punctuation">(</span>txyxy<span class="token punctuation">,</span> pxyxys<span class="token punctuation">)</span>

            pair_wise_iou_loss <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>pair_wise_iou <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>

            top_k<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pair_wise_iou<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> pair_wise_iou<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            dynamic_ks <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>top_k<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

            gt_cls_per_image <span class="token operator">=</span> <span class="token punctuation">(</span>
                F<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

            num_gt <span class="token operator">=</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            cls_preds_ <span class="token operator">=</span> <span class="token punctuation">(</span>
                p_cls<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">*</span> p_obj<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

            y <span class="token operator">=</span> cls_preds_<span class="token punctuation">.</span>sqrt_<span class="token punctuation">(</span><span class="token punctuation">)</span>
            pair_wise_cls_loss <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>
               torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>y<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> gt_cls_per_image<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">del</span> cls_preds_
        
            cost <span class="token operator">=</span> <span class="token punctuation">(</span>
                pair_wise_cls_loss
                <span class="token operator">+</span> <span class="token number">3.0</span> <span class="token operator">*</span> pair_wise_iou_loss
            <span class="token punctuation">)</span>

            matching_matrix <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>

            <span class="token keyword">for</span> gt_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_gt<span class="token punctuation">)</span><span class="token punctuation">:</span>
                _<span class="token punctuation">,</span> pos_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>
                    cost<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token operator">=</span>dynamic_ks<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> largest<span class="token operator">=</span><span class="token boolean">False</span>
                <span class="token punctuation">)</span>
                matching_matrix<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">[</span>pos_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>

            <span class="token keyword">del</span> top_k<span class="token punctuation">,</span> dynamic_ks
            anchor_matching_gt <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                _<span class="token punctuation">,</span> cost_argmin <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>cost<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">0.0</span>
                matching_matrix<span class="token punctuation">[</span>cost_argmin<span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>
            fg_mask_inboxes <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span>
            matched_gt_inds <span class="token operator">=</span> matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> fg_mask_inboxes<span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        
            from_which_layer <span class="token operator">=</span> from_which_layer<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_b <span class="token operator">=</span> all_b<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_a <span class="token operator">=</span> all_a<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_gj <span class="token operator">=</span> all_gj<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_gi <span class="token operator">=</span> all_gi<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_anch <span class="token operator">=</span> all_anch<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
        
            this_target <span class="token operator">=</span> this_target<span class="token punctuation">[</span>matched_gt_inds<span class="token punctuation">]</span>
        
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
                layer_idx <span class="token operator">=</span> from_which_layer <span class="token operator">==</span> i
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_b<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_a<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gj<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gi<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_anch<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>

        <span class="token keyword">return</span> matching_bs<span class="token punctuation">,</span> matching_as<span class="token punctuation">,</span> matching_gjs<span class="token punctuation">,</span> matching_gis<span class="token punctuation">,</span> matching_targets<span class="token punctuation">,</span> matching_anchs              

    <span class="token keyword">def</span> <span class="token function">find_5_positive</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Build targets for compute_loss(), input targets(image,class,x,y,w,h)</span>
        na<span class="token punctuation">,</span> nt <span class="token operator">=</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> targets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># number of anchors, targets</span>
        indices<span class="token punctuation">,</span> anch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        gain <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># normalized to gridspace gain</span>
        ai <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>na<span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> nt<span class="token punctuation">)</span>  <span class="token comment"># same as .repeat_interleave(nt)</span>
        targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>targets<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ai<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># append anchor indices</span>

        g <span class="token operator">=</span> <span class="token number">1.0</span>  <span class="token comment"># bias</span>
        off <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># j,k,l,m</span>
                            <span class="token comment"># [1, 1], [1, -1], [-1, 1], [-1, -1],  # jk,jm,lk,lm</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> g  <span class="token comment"># offsets</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># xyxy gain</span>

            <span class="token comment"># Match targets to anchors</span>
            t <span class="token operator">=</span> targets <span class="token operator">*</span> gain
            <span class="token keyword">if</span> nt<span class="token punctuation">:</span>
                <span class="token comment"># Matches</span>
                r <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">/</span> anchors<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># wh ratio</span>
                j <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1.</span> <span class="token operator">/</span> r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'anchor_t'</span><span class="token punctuation">]</span>  <span class="token comment"># compare</span>
                <span class="token comment"># j = wh_iou(anchors, t[:, 4:6]) &gt; model.hyp['iou_t']  # iou(3,n)=wh_iou(anchors(3,2), gwh(n,2))</span>
                t <span class="token operator">=</span> t<span class="token punctuation">[</span>j<span class="token punctuation">]</span>  <span class="token comment"># filter</span>

                <span class="token comment"># Offsets</span>
                gxy <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># grid xy</span>
                gxi <span class="token operator">=</span> gain<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">-</span> gxy  <span class="token comment"># inverse</span>
                j<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxy <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxy <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                l<span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxi <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxi <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                j <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> t<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                offsets <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>gxy<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> off<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                t <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                offsets <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token comment"># Define</span>
            b<span class="token punctuation">,</span> c <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T  <span class="token comment"># image, class</span>
            gxy <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># grid xy</span>
            gwh <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>  <span class="token comment"># grid wh</span>
            gij <span class="token operator">=</span> <span class="token punctuation">(</span>gxy <span class="token operator">-</span> offsets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            gi<span class="token punctuation">,</span> gj <span class="token operator">=</span> gij<span class="token punctuation">.</span>T  <span class="token comment"># grid xy indices</span>

            <span class="token comment"># Append</span>
            a <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># anchor indices</span>
            indices<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gi<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># image, anchor, grid indices</span>
            anch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># anchors</span>

        <span class="token keyword">return</span> indices<span class="token punctuation">,</span> anch                 

    <span class="token keyword">def</span> <span class="token function">find_3_positive</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Build targets for compute_loss(), input targets(image,class,x,y,w,h)</span>
        na<span class="token punctuation">,</span> nt <span class="token operator">=</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> targets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># number of anchors, targets</span>
        indices<span class="token punctuation">,</span> anch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        gain <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># normalized to gridspace gain</span>
        ai <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>na<span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> nt<span class="token punctuation">)</span>  <span class="token comment"># same as .repeat_interleave(nt)</span>
        targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>targets<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ai<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># append anchor indices</span>

        g <span class="token operator">=</span> <span class="token number">0.5</span>  <span class="token comment"># bias</span>
        off <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># j,k,l,m</span>
                            <span class="token comment"># [1, 1], [1, -1], [-1, 1], [-1, -1],  # jk,jm,lk,lm</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> g  <span class="token comment"># offsets</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># xyxy gain</span>

            <span class="token comment"># Match targets to anchors</span>
            t <span class="token operator">=</span> targets <span class="token operator">*</span> gain
            <span class="token keyword">if</span> nt<span class="token punctuation">:</span>
                <span class="token comment"># Matches</span>
                r <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">/</span> anchors<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># wh ratio</span>
                j <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1.</span> <span class="token operator">/</span> r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'anchor_t'</span><span class="token punctuation">]</span>  <span class="token comment"># compare</span>
                <span class="token comment"># j = wh_iou(anchors, t[:, 4:6]) &gt; model.hyp['iou_t']  # iou(3,n)=wh_iou(anchors(3,2), gwh(n,2))</span>
                t <span class="token operator">=</span> t<span class="token punctuation">[</span>j<span class="token punctuation">]</span>  <span class="token comment"># filter</span>

                <span class="token comment"># Offsets</span>
                gxy <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># grid xy</span>
                gxi <span class="token operator">=</span> gain<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">-</span> gxy  <span class="token comment"># inverse</span>
                j<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxy <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxy <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                l<span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxi <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxi <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                j <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> t<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                offsets <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>gxy<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> off<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                t <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                offsets <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token comment"># Define</span>
            b<span class="token punctuation">,</span> c <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T  <span class="token comment"># image, class</span>
            gxy <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># grid xy</span>
            gwh <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>  <span class="token comment"># grid wh</span>
            gij <span class="token operator">=</span> <span class="token punctuation">(</span>gxy <span class="token operator">-</span> offsets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            gi<span class="token punctuation">,</span> gj <span class="token operator">=</span> gij<span class="token punctuation">.</span>T  <span class="token comment"># grid xy indices</span>

            <span class="token comment"># Append</span>
            a <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># anchor indices</span>
            indices<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gi<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># image, anchor, grid indices</span>
            anch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># anchors</span>

        <span class="token keyword">return</span> indices<span class="token punctuation">,</span> anch

</code></pre> 
<hr> 
<h2><a id="5__1127"></a>5. 实验结果与总结</h2> 
<p>贴的源码有点多，导致篇幅有点过长。最后对yolov7做一个总结。</p> 
<p>总的来说，在模型的结构上，yolov7的模型搭建延续了yolov5的手法，<strong>提出了ELAN的一个新颖concat结构和一个新颖的MP降维结构</strong>。同时，在部分版本中使用上了Rep结构（将3x3卷积，1x1卷积，残差链接）拓扑组合在一起。</p> 
<p>对于正负样本的匹配上，使用了yoloX的SimOTA匹配方法，与yolov5的匹配方法进行融合。<strong>也就是simOTA中的第一步“使用中心先验”替换成“yolov5中的策略”，提供了更加精确的先验知识</strong>。同时还额外使用了辅助头（不过在源码上其实并没有主动的去使用辅助头，也就是说其提供了相应的代码但没有去使用，可能是提升的点并不多0.3）</p> 
<pre><code class="prism language-python"><span class="token comment"># Start training</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
compute_loss_ota <span class="token operator">=</span> ComputeLossOTA<span class="token punctuation">(</span>model<span class="token punctuation">)</span>  <span class="token comment"># init loss class</span>
compute_loss <span class="token operator">=</span> ComputeLoss<span class="token punctuation">(</span>model<span class="token punctuation">)</span>  <span class="token comment"># init loss class</span>
</code></pre> 
<p>但是<strong>无论是yolov6还是yolov7都使用了SimOTA的匹配方法，足以说明SimOTA的正负样本匹配策略是先进的</strong>。辅助头在宏观上也提供了一个额外的思路，就是在中间过程也可以进行一个损失计算，作为一个辅助的损失。<strong>这个辅助损失在结构计算上完全与正常的检测头计算损失相同，只是分配的权重不一样就可以了，这个权重比也可以作为是一个超参数调节</strong>（但是不知道为什么在源码中并没有主动用上这个辅助头，还是说可能是我看错了）</p> 
<p>而yolov6和yolov7也不约而同的都看上了参数重结构化的思路，也就是RepConv。<strong>说明这种训练过程和验证过程解耦的思路，可以改变网络的拓扑结构，从而加快推理速度</strong>，实现更快更强的目标检测算法。不过yolov7中说直接使用会影响效果，但yolov6整个结构都使用了RepConv，反而提升了整体效果6个点以上，具体听谁的这有点说不准。<br> <img src="https://images2.imgbox.com/ec/a3/pZ4Cjt0S_o.png" alt="在这里插入图片描述"><br> 但是，不管怎样，参数重结构化这东西肯定是个好东西。</p> 
<p>对于训练策略上，由于yolov7也是复用了yolov5的源码，所以训练策略基本也是那一套。什么Warmup，Multi-scale，AMP混合精度，余弦退火学习率策略，EMA等等这类东西，在训练策略上我认为没那个框架比yolov5使用得更全面了。这些训练策略在介绍yolov3-spp和yolov5的时候就已经介绍完了，有兴趣的朋友可以看看：</p> 
<p><strong><a href="https://blog.csdn.net/weixin_44751294/category_11848640.html">1. 目标检测YOLOv5技巧汇总专栏</a><br> <a href="https://blog.csdn.net/weixin_44751294/category_11762665.html">2. 目标检测YOLOv3技巧汇总专栏</a></strong></p> 
<p>最后的最后，看看yolov7的实验结果来感受强悍，确实是当前最快的检测算法了。</p> 
<p><img src="https://images2.imgbox.com/64/78/r9oVC8ly_o.png" alt="在这里插入图片描述"><br> 之后有机会再跑跑实验感受感受。</p> 
<hr> 
<p><strong>参考资料：</strong></p> 
<p><a href="https://mp.weixin.qq.com/s/6U7ccl-mtDIr_vaYvtsC6Q" rel="nofollow">1. YOLOv7正负样本分配详解</a></p> 
<p><a href="https://mp.weixin.qq.com/s/Ggs7ssdkjPGl50Zgz4JWCA" rel="nofollow">2. 卷起来了！YOLOv7来了，史上最强YOLO！</a></p> 
<p><a href="https://blog.csdn.net/u012863603/article/details/126118799">3. 目标检测算法——YOLOV7——详解</a></p> 
<p><a href="https://zhuanlan.zhihu.com/p/543743278" rel="nofollow">4. 深入浅出 Yolo 系列之 Yolov7 基础网络结构详解</a></p> 
<p><a href="https://blog.csdn.net/weixin_44751294/category_11848640.html">5. 目标检测YOLOv5技巧汇总专栏</a></p> 
<p><a href="https://blog.csdn.net/weixin_44751294/category_11762665.html">6. 目标检测YOLOv3技巧汇总专栏</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1c25aa82be6e04456a9ebd4c953de486/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">pycharm远程服务器debug 出现Cannot run the remote Python interpreter: Can‘t get remote credentials for</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d7c5087ba9cdd3276f8d21a6d2cf528/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">安卓TextView实现文字跑马灯(失去焦点可用)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>