<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信小程序WebSocket实现聊天对话功能完整源码 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微信小程序WebSocket实现聊天对话功能完整源码" />
<meta property="og:description" content="相关文章：
1.小程序聊天群，发送语音，文字，图片。
2.微信小程序集成腾讯IM，实现实时音视频通话，1V1聊天
3.云开发微信小程序聊天群
4.接入网易云信IM即时通讯的微信小程序聊天室
5.微信小程序聊天功能 WebSocket 实现发送文字，图片，语音以及WebSocket 常见问题解决方案
6.[微信小程序]聊天对话(文本,图片)的功能(完整代码附效果图)
如果有个性化的需要修改，可以联系我的微信。
微信小程序开发交流qq群 173683895
承接微信小程序开发。扫码加微信。 正文： js
var app = getApp(); var socketOpen = false; var frameBuffer_Data, session, SocketTask; var url = &#39;ws://请填写您的长链接接口地址&#39;; var upload_url =&#39;请填写您的图片上传接口地址&#39; Page({ data: { user_input_text: &#39;&#39;,//用户输入文字 inputValue: &#39;&#39;, returnValue: &#39;&#39;, addImg: false, //格式示例数据，可为空 allContentList: [], num: 0 }, // 页面加载 onLoad: function () { this.bottom(); }, onShow: function (e) { if (!socketOpen) { this.webSocket() } }, // 页面加载完成 onReady: function () { var that = this; SocketTask." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8fbb5755bab29cb2ed357075edd42b80/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-06-26T10:20:57+08:00" />
<meta property="article:modified_time" content="2018-06-26T10:20:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信小程序WebSocket实现聊天对话功能完整源码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>相关文章：</p> 
<p>1.<a href="https://a-jing.blog.csdn.net/article/details/104385712" rel="nofollow">小程序聊天群，发送语音，文字，图片。</a></p> 
<p>2.<a href="https://a-jing.blog.csdn.net/article/details/104660244" rel="nofollow">微信小程序集成腾讯IM，实现实时音视频通话，1V1聊天</a></p> 
<p>3.<a href="https://a-jing.blog.csdn.net/article/details/104453397" rel="nofollow">云开发微信小程序聊天群</a></p> 
<p>4.<a href="https://a-jing.blog.csdn.net/article/details/85336347" rel="nofollow">接入网易云信IM即时通讯的微信小程序聊天室</a></p> 
<p>5.<a href="https://a-jing.blog.csdn.net/article/details/84247493" rel="nofollow">微信小程序聊天功能 WebSocket 实现发送文字，图片，语音以及WebSocket 常见问题解决方案</a></p> 
<p>6.<a href="https://a-jing.blog.csdn.net/article/details/78688311" rel="nofollow">[微信小程序]聊天对话(文本,图片)的功能(完整代码附效果图)</a></p> 
<p>如果有个性化的需要修改，可以联系我的微信。</p> 
<p>微信小程序开发交流qq群   173683895</p> 
<h4><img alt="" class="has" height="260" src="https://images2.imgbox.com/3e/95/kx5lNB8o_o.jpg" width="260">   承接微信小程序开发。扫码加微信。</h4> 
<h4><strong>正文：</strong></h4> 
<p>js</p> 
<pre class="has"><code class="language-javascript">var app = getApp();
var socketOpen = false;
var frameBuffer_Data, session, SocketTask;
var url = 'ws://请填写您的长链接接口地址';
var upload_url ='请填写您的图片上传接口地址'
Page({
  data: {
    user_input_text: '',//用户输入文字
    inputValue: '',
    returnValue: '',
    addImg: false,
    //格式示例数据，可为空
    allContentList: [],
    num: 0
  },
  // 页面加载
  onLoad: function () {
    this.bottom();
  },
  onShow: function (e) {
    if (!socketOpen) {
      this.webSocket()
    }
  },
  // 页面加载完成
  onReady: function () {
    var that = this;
    SocketTask.onOpen(res =&gt; {
      socketOpen = true;
      console.log('监听 WebSocket 连接打开事件。', res)
    })
    SocketTask.onClose(onClose =&gt; {
      console.log('监听 WebSocket 连接关闭事件。', onClose)
      socketOpen = false;
      this.webSocket()
    })
    SocketTask.onError(onError =&gt; {
      console.log('监听 WebSocket 错误。错误信息', onError)
      socketOpen = false
    })
    SocketTask.onMessage(onMessage =&gt; {
      console.log('监听WebSocket接受到服务器的消息事件。服务器返回的消息', JSON.parse(onMessage.data))
      var onMessage_data = JSON.parse(onMessage.data)
      if (onMessage_data.cmd == 1) {
        that.setData({
          link_list: text
        })
        console.log(text, text instanceof Array)
        // 是否为数组
        if (text instanceof Array) {
          for (var i = 0; i &lt; text.length; i++) {
            text[i]
          }
        } else {

        }
        that.data.allContentList.push({ is_ai: true, text: onMessage_data.body });
        that.setData({
          allContentList: that.data.allContentList
        })
        that.bottom()
      }
    })
  },
  webSocket: function () {
    // 创建Socket
    SocketTask = wx.connectSocket({
      url: url,
      data: 'data',
      header: {
        'content-type': 'application/json'
      },
      method: 'post',
      success: function (res) {
        console.log('WebSocket连接创建', res)
      },
      fail: function (err) {
        wx.showToast({
          title: '网络异常！',
        })
        console.log(err)
      },
    })
  },

  // 提交文字
  submitTo: function (e) {
    let that = this;
    var data = {
      body: that.data.inputValue,
    }

    if (socketOpen) {
      // 如果打开了socket就发送数据给服务器
      sendSocketMessage(data)
      this.data.allContentList.push({ is_my: { text: this.data.inputValue }});
      this.setData({
        allContentList: this.data.allContentList,
        inputValue: ''
      })

      that.bottom()
    }
  },
  bindKeyInput: function (e) {
    this.setData({
      inputValue: e.detail.value
    })
  },

  onHide: function () {
    SocketTask.close(function (close) {
      console.log('关闭 WebSocket 连接。', close)
    })
  },
  upimg: function () {
    var that = this;
      wx.chooseImage({
        sizeType: ['original', 'compressed'],
        success: function (res) {
          that.setData({
            img: res.tempFilePaths
          })
          wx.uploadFile({
            url: upload_url,
            filePath: res.tempFilePaths,
            name: 'img',
            success: function (res) {
              console.log(res)
                wx.showToast({
                  title: '图片发送成功！',
                  duration: 3000
                });
            }
          })  
          that.data.allContentList.push({ is_my: { img: res.tempFilePaths } });
          that.setData({
            allContentList: that.data.allContentList,
          })
          that.bottom();
        }
      })
  },   
  addImg: function () {
    this.setData({
      addImg: !this.data.addImg
    })

  },
  // 获取hei的id节点然后屏幕焦点调转到这个节点  
  bottom: function () {
    var that = this;
    this.setData({
      scrollTop: 1000000
    })
  },
})

//通过 WebSocket 连接发送数据，需要先 wx.connectSocket，并在 wx.onSocketOpen 回调之后才能发送。
function sendSocketMessage(msg) {
  var that = this;
  console.log('通过 WebSocket 连接发送数据', JSON.stringify(msg))
  SocketTask.send({
    data: JSON.stringify(msg)
  }, function (res) {
    console.log('已发送', res)
  })
} </code></pre> 
<p> </p> 
<p>wxml</p> 
<p> </p> 
<pre class="has"><code class="language-html">&lt;view class='page_bg' wx:if='{<!-- -->{block}}' bindtap='hide_bg' /&gt;
&lt;view class='btn_bg' wx:if='{<!-- -->{block}}'&gt;
  &lt;view wx:for="{<!-- -->{link_list}}" wx:key='index'&gt;
    &lt;button class="sp_tit" id='{<!-- -->{index}}' bindtap='list_item'&gt;查看详情 {<!-- -->{item}} &lt;/button&gt;
  &lt;/view&gt;
&lt;/view&gt;
&lt;scroll-view class="history" scroll-y="true" scroll-with-animation scroll-top="{<!-- -->{scrollTop}}"&gt;

  &lt;block wx:key="{<!-- -->{index}}" wx:for="{<!-- -->{allContentList}}"&gt;
    &lt;!-- &lt;view&gt;
      &lt;text class='time'&gt;{<!-- -->{time}}&lt;/text&gt;
    &lt;/view&gt; --&gt;
    &lt;view class='my_right' wx:if="{<!-- -->{item.is_my}}"&gt;
      &lt;view class='p_r' wx:if='{<!-- -->{item.is_my.text}}'&gt;
        &lt;text class='new_txt'&gt;&lt;text class='new_txt_my'&gt;{<!-- -->{item.is_my.text}}&lt;/text&gt;&lt;/text&gt;
        &lt;view class='sanjiao my'&gt;&lt;/view&gt;
        &lt;image class='new_img' src='/images/test.jpg'&gt;&lt;/image&gt;
      &lt;/view&gt;
      &lt;view class='p_r' wx:if='{<!-- -->{item.is_my.img}}' bindtap='my_audio_click' data-id='{<!-- -->{index}}'&gt;
        &lt;text class='new_txt'&gt; &lt;/text&gt;
        &lt;view class='my_img_bg'&gt;
        &lt;image class='my_audio' src='{<!-- -->{img}}'&gt;&lt;/image&gt;&lt;/view&gt;
        &lt;view class='sanjiao my'&gt;&lt;/view&gt;
        &lt;image class='new_img' src='/images/test.jpg'&gt;&lt;/image&gt;
      &lt;/view&gt;
    &lt;/view&gt;
    &lt;!-- &lt;view class='you_left' id='id_{<!-- -->{allContentList.length}}'&gt; --&gt;
    &lt;view class='you_left' id='id_{<!-- -->{allContentList.length}}' wx:key="{<!-- -->{index}}" wx:if="{<!-- -->{item.is_ai}}"&gt;
      &lt;view class='p_r'&gt;
        &lt;image class='new_img' src='/images/chac.jpg'&gt;&lt;/image&gt;
        &lt;view class='sanjiao you'&gt;&lt;/view&gt;
        &lt;view class='new_txt'&gt;
          &lt;view class='new_txt_ai'&gt;
            &lt;!-- {<!-- -->{item.text}} --&gt;
            &lt;block wx:for='{<!-- -->{item.is_two}}' wx:key='index'&gt;
              &lt;text wx:if='{<!-- -->{item.text}}'&gt;{<!-- -->{item.text}}&lt;/text&gt;
              &lt;text wx:if='{<!-- -->{item.a.title}}' style='color:#0000EE' bindtap='link' id='{<!-- -->{item.a.link}}'&gt;{<!-- -->{item.a.title}}&lt;/text&gt;
            &lt;/block&gt;
          &lt;/view&gt;
        &lt;/view&gt;
      &lt;/view&gt;
    &lt;/view&gt;
  &lt;/block&gt;
&lt;/scroll-view&gt;
&lt;view class="sendmessage"&gt;
  &lt;image class='voice_icon' bindtap='addImg' src='/images/jia_img.png'&gt;&lt;/image&gt;
  &lt;block wx:if='{<!-- -->{!addImg}}'&gt;
    &lt;input type="text" bindinput="bindKeyInput" value='{<!-- -->{inputValue}}' focus='{<!-- -->{focus}}' bindfocus="focus" confirm-type="done" placeholder="" /&gt;
    &lt;button bindtap="submitTo" class='user_input_text'&gt;发送&lt;/button&gt;
  &lt;/block&gt;
  &lt;block wx:if='{<!-- -->{addImg}}'&gt;
    &lt;view class='voice_ing' bindtap="upimg"&gt;发送图片&lt;/view&gt;
  &lt;/block&gt;
&lt;/view&gt;</code></pre> 
<p>css</p> 
<pre class="has"><code class="language-css">page {  
  background-color: #f2f2f2;  
  height: 100%;
}  
.jia_img{  
  height: 80rpx;  
  width: 90rpx;  
}  
.time {  
  text-align: center;  
  padding: 5rpx 20rpx 5rpx 20rpx;  
  width: 200rpx;  
  font-size: 26rpx;  
  background-color: #E8E8E8;  
}  
.tab{
  bottom: 120rpx;
}
.tab_1{
  position: fixed;
  bottom: 50rpx;
  width: 200rpx;
  font-size: 26rpx;
  left: 50%;
  margin-left: -45rpx;
  height: 100rpx;
}
.tab_2{
  right: 30rpx;
  position: fixed;
}
/* 聊天 */  
  
.my_right {  
  float: right;  
  margin-top: 30rpx;
  position: relative;  
  right: 40rpx;  
}  
.my_audio{
  height: 120rpx;
  width: 150rpx;
  position: absolute;
  right: 150rpx;
  background: white;
  top: 20rpx;
}
.my_img_bg{
  height: 150rpx;
  width: 400rpx;
  position: relative;
  right: 0;
  background: white;
  top: 20rpx;
}
.you_left {  
  margin-top: 30rpx;
  float: left;  
  position: relative;  
  left: 5rpx;  
}  
  
.new_img {  
  width: 100rpx;  
  height: 100rpx;  
  border-radius: 50%;  
}  
  
.new_txt {  
  width: 420rpx;  
}  
.new_txt_my{
  border-radius: 7px;  
  background-color: #fff;  
  margin-top: 10rpx;
  padding: 0rpx 30rpx 0rpx 30rpx;  
  float: right;
}
.new_txt_ai{
  border-radius: 7px;  
  background-color: #fff;  
  margin-top: 10rpx;
  padding: 0rpx 30rpx 0rpx 30rpx;  
  float: left;
}
.sanjiao {  
  top: 25rpx;  
  position: relative;  
  width: 0px;  
  height: 0px;  
  border-width: 15rpx;  
  border-style: solid;  
}  
  
.my {  
  border-color: transparent transparent transparent #fff;  
}  
  
.you {  
  border-color: transparent #fff transparent transparent;  
}  
  
.sendmessage {  
  width: 100%;  
  z-index: 2;
  display: flex;  
  position: fixed;
  bottom: 0px;
  background-color: #F4F4F6; 
  flex-direction: row;  
  height: 85rpx;
}  
.voice_icon{
  width: 60rpx;
  height: 60rpx;
  margin: 0 auto;
  padding: 10rpx 10rpx 10rpx 10rpx;
}
.voice_ing{
  width: 90%;
  height: 75rpx;
  line-height: 85rpx;
  text-align: center;
  border-radius: 15rpx;
  border: 1px solid #d0d0d0;
}
.sendmessage_2 {  
  z-index: 1;
  position: relative;
  width: 100%;  
  display: flex;  
  background-color: #F4F4F6; 
  flex-direction: row;  
  height: 85rpx;
}    
.sendmessage input {  
  width: 75%;  
  height: 60rpx;   
  background-color: white; 
  line-height: 60rpx;  
  font-size: 28rpx;  
  border-radius: 10rpx;
  margin-top: 10rpx;
  margin-left: 20rpx;
  border: 1px solid #d0d0d0;  
  padding-left: 20rpx;  
}  
.sendmessage button {  
  border: 1px solid white;  
  width: 18%;  
  height: 65rpx;  
  background: #00CC00;
  color: white;
  line-height: 65rpx;  
  margin-top: 10rpx;
  font-size: 28rpx;  
}  
  
.hei{  
  height: 20rpx;  
}  
.history {  
  height: 80%;  
  padding: 20rpx  20rpx  20rpx  20rpx;
  font-size: 14px;  
  line-height: 50rpx;  
  word-break: break-all;  
}  

.icno_kf{
  position: fixed;
  bottom: 160rpx;
  margin: 0 auto;
  text-align: center;
  left: 50%;
  margin-left: -40rpx;
  width: 100rpx;
  height: 100rpx;
  border-radius: 50%
}</code></pre> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/55b99497aebf3dad508bc3cb8ecc3d99/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">centos7 增加swap分区大小</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6cd0de5d7f0843c795786115f049aab8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">NIC指示灯代码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>