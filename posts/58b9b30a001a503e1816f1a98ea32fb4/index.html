<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>JavaScript实现调用摄像头完成拍照取图 重命名并下载或上传 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="JavaScript实现调用摄像头完成拍照取图 重命名并下载或上传" />
<meta property="og:description" content="环境条件 具有内置摄像头 或 外设摄像头Vue &#43; Element &#43; axios（环境不同可自行修改，本文主要为逻辑，除展示的上传控件其他与js基本无异） 全文 &lt;template&gt; &lt;div id=&#34;all&#34;&gt; &lt;el-upload :headers=&#34;{token:userinfo.token}&#34; class=&#34;upload-demo&#34; list-type=&#34;picture-card&#34; :multiple=&#34;false&#34; :limit=&#34;5&#34; :action=&#34;uploadimgUrl&#34; :on-success=&#34;uploadPhoto&#34; :on-remove=&#34;handleRemovePhoto&#34; :file-list=&#34;fileListimg&#34; multiple&gt; &lt;i class=&#34;el-icon-plus&#34;&gt;&lt;/i&gt; &lt;/el-upload&gt; &lt;div class=&#34;gp&#34;&gt; &lt;video ref=&#34;gpp2&#34;&gt;&lt;/video&gt; &lt;/div&gt; &lt;div class=&#34;footer&#34; style=&#34;display: flex;justify-content: space-between;margin-top: 10px&#34;&gt; &lt;el-button type=&#34;primary&#34; @click=&#34;takeGpp&#34;&gt;抓 拍 上 传&lt;/el-button&gt; &lt;/div&gt; &lt;canvas ref=&#34;canvas&#34; v-show=&#34;false&#34; height=&#34;960&#34; width=&#34;1600&#34;&gt;&lt;/canvas&gt; &lt;/div&gt; &lt;/template&gt; &lt;script&gt; import request from &#34;@/utils/request&#34;; export default { name: &#34;demo&#34;, data(){ let url = process.env.VUE_APP_BASE_API; let baseUrl = this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/58b9b30a001a503e1816f1a98ea32fb4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-22T15:49:27+08:00" />
<meta property="article:modified_time" content="2022-07-22T15:49:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">JavaScript实现调用摄像头完成拍照取图 重命名并下载或上传</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>环境条件</h3> 
<ul><li>具有内置摄像头 或 外设摄像头</li><li>Vue + Element + axios（环境不同可自行修改，本文主要为逻辑，除展示的上传控件其他与js基本无异）</li></ul> 
<h3><a id="_4"></a>全文</h3> 
<pre><code>&lt;template&gt;
  &lt;div id="all"&gt;
    &lt;el-upload
      :headers="{token:userinfo.token}"
      class="upload-demo"
      list-type="picture-card"
      :multiple="false"
      :limit="5"
      :action="uploadimgUrl"
      :on-success="uploadPhoto"
      :on-remove="handleRemovePhoto"
      :file-list="fileListimg"
      multiple&gt;
      &lt;i class="el-icon-plus"&gt;&lt;/i&gt;
    &lt;/el-upload&gt;

    &lt;div class="gp"&gt;
      &lt;video ref="gpp2"&gt;&lt;/video&gt;
    &lt;/div&gt;
    &lt;div class="footer" style="display: flex;justify-content: space-between;margin-top: 10px"&gt;
      &lt;el-button type="primary" @click="takeGpp"&gt;抓 拍 上 传&lt;/el-button&gt;
    &lt;/div&gt;
    &lt;canvas ref="canvas" v-show="false" height="960" width="1600"&gt;&lt;/canvas&gt;

  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import request from "@/utils/request";

export default {
  name: "demo",
  data(){
    let url = process.env.VUE_APP_BASE_API;
    let baseUrl = this.$baseUrl;
    let userinfo = JSON.parse(sessionStorage.getItem('userinfo'))
    return{
      fileListimg:[],
      fileliststr:"",
      video:{},
      baseUrl,
      userinfo,
      uploadimgUrl:url+"/upload_images",

    }
  },
  mounted() {
    this.initGpp();
  },
  methods:{
    openGpp() {
      // this.dialogFormVisible = true;
      setTimeout(() =&gt; {
        this.initGpp();
      }, 100)
    },
    initGpp() {
      this.video = this.$refs.gpp2;
      console.log(this.video)
      // this.video = document.getElementById('video')
      //兼容性写法,判断getUserMedia方法是否存在
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || window.getUserMedia;
      if (navigator.getUserMedia) {
        //调用用户媒体设备, 访问摄像头
        this.getUserMedia({video: {width: 1600, height: 960}}, this.success, this.error);
      } else {
        alert('不支持访问用户媒体');
      }
    },
    getUserMedia(constraints, success, error) {
      if (navigator.mediaDevices.getUserMedia) {
        //最新的标准API
        navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
      } else if (navigator.webkitGetUserMedia) {
        //webkit核心浏览器
        navigator.webkitGetUserMedia(constraints, success, error)
      } else if (navigator.mozGetUserMedia) {
        //firfox浏览器
        navigator.mozGetUserMedia(constraints, success, error);
      } else if (navigator.getUserMedia) {
        //旧版API
        navigator.getUserMedia(constraints, success, error);
      }
    },
    // 调用成功的方法
    success(stream) {
      //兼容webkit核心浏览器
      let CompatibleURL = window.URL || window.webkitURL;
      //将视频流设置为video元素的源
      // console.log(stream);

      //video.src = CompatibleURL.createObjectURL(stream);
      //将摄像头拍摄的视频赋值给viedeo的srcObject属性
      //src是视频文件,srcObject是实时流
      //摄像头是实时流
      this.video.srcObject = stream;
      //并播放
      this.video.play();
    },
    // 调用失败的方法
    error(error) {
      console.log(`访问用户媒体设备失败${error.name}, ${error.message}`);
    },
    takeGpp() {
      if(this.fileListimg.length&gt;=5){
        this.$message({
          type: 'error',
          message: "图片最多允许五张"
        });
        return
      }

      let canvas = this.$refs.canvas;
      var context = canvas.getContext("2d");
      //将视频当前的页面转换为图片，显示到画板中
      context.drawImage(this.video, 0, 0,);
      //把canvas图像转为img图片
      var src = canvas.toDataURL("image/jpeg");
      // console.log(src)
      let file = this.base64ToFile(src);
      let time = new Date().getTime();

      // this.downloadFile(file, `${time}.png`)
      let type = file.type.split('/');
      let renameFile = new File([file],time+".png",{type:"image/png"})

      let formData = new FormData();
      formData.append('file',renameFile)

      request({
        url:"/upload_images",
        method:"post",
        data:formData
      }).then(res =&gt; {
        console.log(res)
        this.$message({
          type: 'success',
          message: "上传成功"
        });
        this.fileListimg.push({
          status:"success",
          name:time+".png",
          uid:time,
          url:this.baseUrl + res.data.imgurl,
          response:res
        })
      })
    },
    base64ToFile(base64Data, fileName) {
      let arr = base64Data.split(','),
        fileType = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]),
        l = bstr.length,
        u8Arr = new Uint8Array(l);

      while (l--) {
        u8Arr[l] = bstr.charCodeAt(l);
      }
      return new File([u8Arr], fileName, {type: fileType});
    },
    downloadFile(content, filename) {
      var a = document.createElement('a')
      var blob = new Blob([content])
      var url = window.URL.createObjectURL(blob)
      a.href = url
      a.download = filename
      a.click()
      console.log(url)
      window.URL.revokeObjectURL(url)
    },
    handleRemovePhoto(file, fileList) {
      console.log(file, fileList);
      this.fileListimg = fileList;
      // let index=null;
      // fileList.map((item,i)=&gt; {
      //   if(file.uid === item.uid){
      //     index = i;
      //   }
      // })
      // fileList.splice(index,1);
    },
    uploadPhoto(response, file, fileList) {
      file.url = this.baseUrl+response.data.imgurl;
      console.log(fileList)
      this.fileliststr = JSON.stringify(fileList)
      if(response.code == 0){
        // this.info.fujian = response.data.imgurl;
        // this.info.fujian_name = response.file_name;
      }else{
        // this.fileList = [];
        this.$message({
          type: 'error',
          message: response.msg
        });
      }
    },
  }
}
&lt;/script&gt;

&lt;style lang="scss" scoped&gt;
#all {
  min-height: 100vh;
  background-color: #F5F7FD;
  padding: 10px 30px 60px;
  .gp {
    margin-top: 40px;
    height: 480px;
    width: 800px;

    video {
      height: 100%;
      width: 100%;
    }
  }

}
&lt;/style&gt;

</code></pre> 
<ol><li>静态效果<br> <img src="https://images2.imgbox.com/63/ab/EWAwAbde_o.png" alt="演示效果"></li><li>拍照后效果(上展示组件为Element的upload的<code>list-type="picture-card"</code>模式)</li></ol> 
<p><img src="https://images2.imgbox.com/12/38/cOaF4gjP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_232"></a>步骤解析</h3> 
<ol><li>需要一个video控件和一个canvas控件（可隐藏）</li></ol> 
<ul><li><code>canvas的大小将决定最终成像大小与质量</code></li></ul> 
<pre><code>&lt;div class="gp"&gt;
      &lt;video ref="gpp2"&gt;&lt;/video&gt;
&lt;/div&gt;
&lt;div class="footer" style="display: flex;justify-content: space-between;margin-top: 10px"&gt;
	&lt;el-button type="primary" @click="takeGpp"&gt;抓 拍 上 传&lt;/el-button&gt;
&lt;/div&gt;
&lt;canvas ref="canvas" v-show="false" height="960" width="1600"&gt;&lt;/canvas&gt;
    
</code></pre> 
<ul><li><code>这里我使用了一个来自Element的upload组件来展示，尽管你可能并不需要</code></li></ul> 
<pre><code>	&lt;el-upload
      :headers="{token:userinfo.token}"
      class="upload-demo"
      list-type="picture-card"
      :multiple="false"
      :limit="5"
      :action="uploadimgUrl"
      :on-success="uploadPhoto"
      :on-remove="handleRemovePhoto"
      :file-list="fileListimg"
      multiple&gt;
      &lt;i class="el-icon-plus"&gt;&lt;/i&gt;
    &lt;/el-upload&gt;

	handleRemovePhoto(file, fileList) {
      console.log(file, fileList);
      this.fileListimg = fileList;
    },
    uploadPhoto(response, file, fileList) {
      if(response.code == 0){
     	 file.url = this.baseUrl+response.data.imgurl;
     	 this.fileliststr = JSON.stringify(fileList)
      }else{
        this.$message({
          type: 'error',
          message: response.msg
        });
      }
    },
</code></pre> 
<ol start="2"><li>准备数据</li></ol> 
<ul><li>除了<code>fileListimg</code>和<code>video</code>其他都不是必须的，根据自行需要准备</li></ul> 
<pre><code>data(){
    let url = process.env.VUE_APP_BASE_API;
    let baseUrl = this.$baseUrl;
    let userinfo = JSON.parse(sessionStorage.getItem('userinfo'))
    return{
      fileListimg:[],
      fileliststr:"",
      video:{},
      baseUrl,
      userinfo,
      uploadimgUrl:url+"/upload_images",
    }
  },
</code></pre> 
<ol start="3"><li>初始化video和摄像头</li></ol> 
<ul><li>这一步网上的教程已经很多了</li><li>在页面渲染完毕后调用<code>initGpp()</code></li></ul> 
<pre><code>initGpp() {
      this.video = this.$refs.gpp2;
      console.log(this.video)
      // this.video = document.getElementById('video')
      //兼容性写法,判断getUserMedia方法是否存在
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || window.getUserMedia;
      if (navigator.getUserMedia) {
        //调用用户媒体设备, 访问摄像头
        this.getUserMedia({video: {width: 1600, height: 960}}, this.success, this.error);
      } else {
        alert('不支持访问用户媒体');
      }
    },
    getUserMedia(constraints, success, error) {
      if (navigator.mediaDevices.getUserMedia) {
        //最新的标准API
        navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
      } else if (navigator.webkitGetUserMedia) {
        //webkit核心浏览器
        navigator.webkitGetUserMedia(constraints, success, error)
      } else if (navigator.mozGetUserMedia) {
        //firfox浏览器
        navigator.mozGetUserMedia(constraints, success, error);
      } else if (navigator.getUserMedia) {
        //旧版API
        navigator.getUserMedia(constraints, success, error);
      }
    },
    // 调用成功的方法
    success(stream) {
      //兼容webkit核心浏览器
      let CompatibleURL = window.URL || window.webkitURL;
      //将视频流设置为video元素的源
      // console.log(stream);

      //video.src = CompatibleURL.createObjectURL(stream);
      //将摄像头拍摄的视频赋值给viedeo的srcObject属性
      //src是视频文件,srcObject是实时流
      //摄像头是实时流
      this.video.srcObject = stream;
      //并播放
      this.video.play();
    },
    // 调用失败的方法
    error(error) {
      console.log(`访问用户媒体设备失败${error.name}, ${error.message}`);
    }
</code></pre> 
<ol start="4"><li>拍照</li></ol> 
<ul><li>这一步是重点</li><li><code>上传</code>或<code>下载</code>在这一步决定</li><li>具体看注释</li></ul> 
<pre><code>	takeGpp() {
	  // 在这里可以做一些前期校验 
      if(this.fileListimg.length&gt;=5){
        this.$message({
          type: 'error',
          message: "图片最多允许五张"
        });
        return
      }

      let canvas = this.$refs.canvas;
      var context = canvas.getContext("2d");
      //将视频当前的页面转换为图片，显示到画板中
      context.drawImage(this.video, 0, 0,);
      //把canvas图像转为img图片
      var src = canvas.toDataURL("image/jpeg");
      let file = this.base64ToFile(src);
      // 获取时间，准备当做文件名
      let time = new Date().getTime();
	  
	  // 如果你需要是下载，那么请将下一行解除注释，并将下一行以下的内容全部删除
      // this.downloadFile(file, `${time}.png`)
      
      // 重命名文件并改变格式 
      let type = file.type.split('/');
      let renameFile = new File([file],time+".png",{type:"image/png"})

      let formData = new FormData();
      formData.append('file',renameFile)
	// 上传 request封装方法 继续阅读
      request({
        url:"/upload_images",
        method:"post",
        data:formData
      }).then(res =&gt; {
        console.log(res)
        this.$message({
          type: 'success',
          message: "上传成功"
        });
        // 这里是为了使用Element的upload组件展示而做的，向该数组添加相似结构数据
        // 请根据自行需要
        this.fileListimg.push({
          status:"success",
          name:time+".png",
          uid:time,
          url:this.baseUrl + res.data.imgurl,
          response:res
        })
      })
    },
    base64ToFile(base64Data, fileName) {
      let arr = base64Data.split(','),
        fileType = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]),
        l = bstr.length,
        u8Arr = new Uint8Array(l);

      while (l--) {
        u8Arr[l] = bstr.charCodeAt(l);
      }
      return new File([u8Arr], fileName, {type: fileType});
    },
    // 下载会用到该方法
    downloadFile(content, filename) {
      var a = document.createElement('a')
      var blob = new Blob([content])
      var url = window.URL.createObjectURL(blob)
      a.href = url
      a.download = filename
      a.click()
      console.log(url)
      window.URL.revokeObjectURL(url)
    }
</code></pre> 
<ol start="5"><li>大功告成</li></ol> 
<h3><a id="requestjs_432"></a>request.js</h3> 
<ul><li>参考了<code>Vue-admin-template</code>的封装设计</li></ul> 
<pre><code>import axios from 'axios'
import { MessageBox, Message } from 'element-ui'
import store from '@/store'


const service = axios.create({
  baseURL: process.env.VUE_APP_BASE_API, // url = base url + request url
  timeout: 10000 // request timeout
})


service.interceptors.request.use(
  config =&gt; {

    let token = sessionStorage.getItem("token")
    if(token){
      config.headers['token'] = token;
    }

    return config
  },
  error =&gt; {
    console.log(error) 
    return Promise.reject(error)
  }
)

service.interceptors.response.use(

  response =&gt; {
    const res = response.data
    if (res.code === 3) {
      // 未登录
      Message.error("未登录")

      store.dispatch('user/logout').then(() =&gt; {
        location.reload()
      })
      return Promise.reject(new Error(res.message || 'Error'))
    }
    return res


  },
  error =&gt; {
    console.log('err' + error) // for debug
    Message({
      message: error.message,
      type: 'error',
      duration: 5 * 1000
    })
    return Promise.reject(error)
  }
)

export default service

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9ab3ac82e85a47e3482fb51168e2e61f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu22.04 LTS 从源码安装ROS2</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/16477670f0e3cb0a93009bc573290b71/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Numpy.where()/np.where() 函数的使用----修改数组中符合条件的元素值/查找数组中符合要求的元素的位置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>