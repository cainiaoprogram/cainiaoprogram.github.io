<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Golang Gin框架搭建项目（五）jwt登录和权限验证 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Golang Gin框架搭建项目（五）jwt登录和权限验证" />
<meta property="og:description" content="1、AuthUtil.go ： 用于生成和解析token
package utils import ( &#34;fmt&#34; &#34;github.com/golang-jwt/jwt&#34; &#34;time&#34; ) //自定义格式内容 type CustomerClaims struct { UserId int `json:&#34;userId&#34;` UserName string `json:&#34;userName&#34;` RoleId int `json:&#34;roleId&#34;` StandardClaims jwt.StandardClaims } func (c CustomerClaims) Valid() error { return nil } //生成token func GenerateJwtToken(secret string, issuer string, audience string, expiredMinutes int64, userId int, userName string, roleId int) (string, error) { hmacSampleSecret := []byte(secret) //密钥，不能泄露 token := jwt.New(jwt.SigningMethodHS256) nowTime := time.Now().Unix() token.Claims = CustomerClaims{ UserName: userName, UserId: userId, RoleId: roleId, StandardClaims: jwt." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/61395be04b08245b882bab30b7a5d669/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-28T17:08:06+08:00" />
<meta property="article:modified_time" content="2022-06-28T17:08:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Golang Gin框架搭建项目（五）jwt登录和权限验证</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>1、AuthUtil.go ： 用于生成和解析token</strong></p> 
<pre><code class="language-Go">package utils

import (
	"fmt"
	"github.com/golang-jwt/jwt"
	"time"
)
//自定义格式内容
type CustomerClaims struct {
	UserId         int    `json:"userId"`
	UserName       string `json:"userName"`
	RoleId         int    `json:"roleId"`
	StandardClaims jwt.StandardClaims
}

func (c CustomerClaims) Valid() error {
	return nil
}

//生成token
func GenerateJwtToken(secret string, issuer string, audience string, expiredMinutes int64, userId int, userName string, roleId int) (string, error) {
	hmacSampleSecret := []byte(secret) //密钥，不能泄露
	token := jwt.New(jwt.SigningMethodHS256)
	nowTime := time.Now().Unix()
	token.Claims = CustomerClaims{
		UserName: userName,
		UserId:   userId,
		RoleId:   roleId,
		StandardClaims: jwt.StandardClaims{
			NotBefore: nowTime,                  // 签名生效时间
			ExpiresAt: nowTime + expiredMinutes, // 签名过期时间
			Issuer:    issuer,                   // 签名颁发者
			Audience:  audience,
		},
	}
	tokenString, err := token.SignedString(hmacSampleSecret)
	return tokenString, err
}

//解析token
func ParseJwtToken(tokenString string, secret string) (*CustomerClaims, error) {
	var hmacSampleSecret = []byte(secret)
	//前面例子生成的token
	token, err := jwt.ParseWithClaims(tokenString, &amp;CustomerClaims{}, func(t *jwt.Token) (interface{}, error) {
		return hmacSampleSecret, nil
	})

	if err != nil {
		fmt.Println(err)
		return nil, err
	}
	claims := token.Claims.(*CustomerClaims)
	return claims, nil
}
</code></pre> 
<p><strong>2、jwt相关配置：额外加上以下内容</strong><a href="https://blog.csdn.net/qq_26900081/article/details/125318343" title="Golang Gin框架搭建项目（二）解析json配置文件_Bear Coding的博客-CSDN博客_gin解析json">Golang Gin框架搭建项目（二）解析json配置文件_Bear Coding的博客-CSDN博客_gin解析json</a></p> 
<pre><code class="language-Go">//Config.go
type Config struct {
	AppName     string         `json:"app_name"`
	AppModel    string         `json:"app_model"`
	AppHost     string         `json:"app_host"`
	AppPort     string         `json:"app_port"`
	Database    DatabaseConfig `json:"database"`
	RedisConfig RedisConfig    `json:"redis_config"`
	JwtConfig   JwtConfig      `json:"jwt_config"`
}
//Redis配置
type JwtConfig struct {
	Issuer    string `json:"issuer"`
	Audience  string `json:"audience"`
	Expires   int64  `json:"expires"`
	SecretKey string `json:"secret_key"`
}

//app.json
  "jwt_config": {
    "issuer": "smallxiong",
    "audience": "xiong",
    "expires": 3600,
    "secret_key": "54s64dede#$#1"
  }</code></pre> 
<p><strong>3、登录接口，别忘了加路由：不包含业务逻辑，只验证jwt功能</strong></p> 
<pre><code class="language-Go">//登录
func (controller *UserController) Login(context *gin.Context) {

	jwtConfig := config.GetConfig().JwtConfig
    //生成token
	token, err := utils.GenerateJwtToken(jwtConfig.SecretKey, jwtConfig.Issuer, jwtConfig.Audience, jwtConfig.Expires, 111, "小熊", 222)
	if err != nil {
		context.JSON(http.StatusOK, gin.H{"code": 500, "msg": "登录失败"})
	}
    //解析token
	claims, err := utils.ParseJwtToken(token, jwtConfig.SecretKey)
	if err != nil {
		context.JSON(http.StatusOK, gin.H{"code": 500, "msg": "token解析失败"})
	}
	context.JSON(http.StatusOK, gin.H{"code": 200, "msg": "登录成功", "token": token, "claims": claims})
}</code></pre> 
<p><strong>4、接口请求验证是否正常：</strong></p> 
<p><img alt="" height="200" src="https://images2.imgbox.com/7a/e2/8Tm4kGhr_o.png" width="652"></p> 
<p><strong>5、使用中间件校验jwt token: AuthMiddleware.go</strong></p> 
<pre><code class="language-Go">package middleware

import (
	config2 "gin_demo/config"
	"gin_demo/utils"
	"github.com/gin-gonic/gin"
	"net/http"
	"strings"
	"time"
)

// 免登录接口列表
var notAuthArr = map[string]string{"/api/user/login": "1", "/api/user/get1": "1"}

func JWTAuth() gin.HandlerFunc {
	return func(c *gin.Context) {
		inWhite := notAuthArr[c.Request.URL.Path]
		if inWhite == "1" {
			return
		}

		token := c.Request.Header.Get("Authorization")
		if token == "" {
			c.JSON(http.StatusUnauthorized, gin.H{"status": -1, "msg": "请求未携带token，无权限访问"})
			c.Abort()
			return
		}
		if strings.HasPrefix(token, "Bearer") {
			token = strings.Split(token, " ")[1]
		}

		config := config2.GetConfig()
		// parse token, get the user and role info
		claims, err := utils.ParseJwtToken(token, config.JwtConfig.SecretKey)
		if err != nil {
			c.JSON(http.StatusUnauthorized, gin.H{"status": -1, "msg": err.Error()})
			c.Abort()
			return
		}
		//token超时
		if time.Now().Unix() &gt; claims.StandardClaims.ExpiresAt {
			c.JSON(http.StatusUnauthorized, gin.H{"status": -1, "msg": "token过期"})
			c.Abort() //阻止执行
			return
		}
		//可以在这里做权限校验

		// 继续交由下一个路由处理,并将解析出的信息传递下去,可以在接口里获取：jwtUser, _ := context.Get("jwtUser")
		c.Set("jwtUser", claims)
		c.Next()
	}
}
</code></pre> 
<p><strong>6、路由中配置中间件</strong></p> 
<pre><code class="language-Go">   router.Use(middleware.JWTAuth())</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ad4eb7cc66518d4fd03321a6f5b2eb65/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">eclipse中导入项目（传智书城为例）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f12ae3dbaef0e71259cfdaa59b052ba0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">利用python爬取京东平台评论及图片并进行分析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>