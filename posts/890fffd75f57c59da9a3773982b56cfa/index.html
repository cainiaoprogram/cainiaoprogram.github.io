<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kaggle: ImageNet Dog Breed Classification (Pytorch) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kaggle: ImageNet Dog Breed Classification (Pytorch)" />
<meta property="og:description" content="本文为自学碰壁的完成任务的一个记录总结，无任何参考价值
写在前面：本文章是跟着《动手深度学习》（李沐）学习过程中的动手实操，前因是对一个树叶数据集分类，但是由于自己太小白（太菜了）折腾了两三周才弄出来，但是觉得还是值得记录一下，对整个过程中自己碰壁过程进行一个总结。由于对于树叶分类的那个问题自己有点雨里雾里的，觉得没达到效果，所以才有了在 Kaggle 上 ImageNet Dog Breed Classification 的分类，本文同样也记录了树叶分类
总结：
多去论坛或者说竞赛地址看看别人写的代码，多看多练出现问题第一时间应该去查找，可以去IDE debug ，实在不行就Print 大法，我这次有个很关键的问题就是，在树叶分类任务过程中能够，我没有将树叶类别转化为数字而是直接传入Tensor，当然结果注定是失败的，还有就是我在提取类别的时候用了一个for 循环去一个元素一个元素的遍历，花费了大量时间，而在人家的baseline 当中用一个集合思想不能有重复元素就可以解决，效率大大提升，所以多看多练在这个过程中有个自定义dataset类，但是自己不知道是哪里出问题了，导致传入网络的数据是错误的，验证精度从一开始就为零，而训练精度是从0慢慢提升上去，到后面才发现可能是dataset将类别和图片对应传入出问题，所以出问题要有针对性的解决，不要盲目性的瞎捣鼓 目录 ImageNet Dogs Breed Classification自定义Dataset训练部分 动手深度学习实战：树叶分类dataset训练部分 ImageNet Dogs Breed Classification Kaggle 狗的品种分类竞赛网址
自定义Dataset from torch.utils.data import Dataset, DataLoader import numpy as np from PIL import Image import pandas as pd from torchvision import transforms # 读取标签 dog_dataframe = pd.read_csv(&#39;../input/dog-breed-identification/labels.csv&#39;) # 将标签转化为集合获取所有类的集合，然后再转化list进行排序 dog_labels = sorted(list(set(dog_dataframe[&#39;breed&#39;]))) # 狗的种类数量 n_class = len(dog_labels) # 需向将string类型的量转化为数字才能ToTensor class_to_num = dict(zip(dog_labels,range(n_class))) class DogsData(Dataset): def __init__(self, csv_path, file_path, mode=&#39;train&#39;, valid_ratio=0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/890fffd75f57c59da9a3773982b56cfa/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-24T22:33:21+08:00" />
<meta property="article:modified_time" content="2022-04-24T22:33:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kaggle: ImageNet Dog Breed Classification (Pytorch)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>本文为自学碰壁的完成任务的一个记录总结，无任何参考价值</p> 
</blockquote> 
<blockquote> 
 <p>写在前面：本文章是跟着《动手深度学习》（李沐）学习过程中的动手实操，前因是对一个树叶数据集分类，但是由于自己太小白（太菜了）折腾了两三周才弄出来，但是觉得还是值得记录一下，对整个过程中自己碰壁过程进行一个总结。由于对于树叶分类的那个问题自己有点雨里雾里的，觉得没达到效果，所以才有了在 Kaggle 上 ImageNet Dog Breed Classification 的分类，本文同样也记录了树叶分类</p> 
</blockquote> 
<blockquote> 
 <p>总结：</p> 
 <ol><li>多去论坛或者说竞赛地址看看别人写的代码，多看多练</li><li>出现问题第一时间应该去查找，可以去IDE debug ，实在不行就Print 大法，我这次有个很关键的问题就是，在树叶分类任务过程中能够，我没有将树叶类别转化为数字而是直接传入Tensor，当然结果注定是失败的，还有就是我在提取类别的时候用了一个for 循环去一个元素一个元素的遍历，花费了大量时间，而在人家的baseline 当中用一个集合思想不能有重复元素就可以解决，效率大大提升，所以多看多练</li><li>在这个过程中有个自定义dataset类，但是自己不知道是哪里出问题了，导致传入网络的数据是错误的，验证精度从一开始就为零，而训练精度是从0慢慢提升上去，到后面才发现可能是dataset将类别和图片对应传入出问题，所以出问题要有针对性的解决，不要盲目性的瞎捣鼓</li></ol> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#ImageNet_Dogs_Breed_Classification_11" rel="nofollow">ImageNet Dogs Breed Classification</a></li><li><ul><li><ul><li><a href="#Dataset_13" rel="nofollow">自定义Dataset</a></li><li><a href="#_106" rel="nofollow">训练部分</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_231" rel="nofollow">动手深度学习实战：树叶分类</a></li><li><ul><li><ul><li><a href="#dataset_236" rel="nofollow">dataset</a></li><li><a href="#_348" rel="nofollow">训练部分</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="ImageNet_Dogs_Breed_Classification_11"></a>ImageNet Dogs Breed Classification</h2> 
<p><a href="https://www.kaggle.com/competitions/dog-breed-identification" rel="nofollow">Kaggle 狗的品种分类竞赛网址</a></p> 
<h4><a id="Dataset_13"></a>自定义Dataset</h4> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span> DataLoader
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token comment"># 读取标签</span>
dog_dataframe <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../input/dog-breed-identification/labels.csv'</span><span class="token punctuation">)</span>
<span class="token comment"># 将标签转化为集合获取所有类的集合，然后再转化list进行排序</span>
dog_labels <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>dog_dataframe<span class="token punctuation">[</span><span class="token string">'breed'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 狗的种类数量</span>
n_class <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dog_labels<span class="token punctuation">)</span>
<span class="token comment"># 需向将string类型的量转化为数字才能ToTensor</span>
class_to_num <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>dog_labels<span class="token punctuation">,</span><span class="token builtin">range</span><span class="token punctuation">(</span>n_class<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">DogsData</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> csv_path<span class="token punctuation">,</span> file_path<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span> valid_ratio<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> resize_height<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">,</span> resize_width<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token triple-quoted-string string">"""
       Args:
           csv_path (string): csv 文件路径
           img_path (string): 图像文件所在路径
           mode (string): 训练模式还是测试模式
           valid_ratio (float): 验证集比例
       """</span>
        <span class="token comment"># 调整图片大小</span>

        self<span class="token punctuation">.</span>resize_height <span class="token operator">=</span> resize_height
        self<span class="token punctuation">.</span>resize_width <span class="token operator">=</span> resize_width
        <span class="token comment"># 图片所在文件夹</span>
        self<span class="token punctuation">.</span>file_path <span class="token operator">=</span> file_path
        self<span class="token punctuation">.</span>valid_ratio <span class="token operator">=</span> valid_ratio
        <span class="token comment"># 数据是用来训练还是验证</span>
        self<span class="token punctuation">.</span>mode <span class="token operator">=</span> mode
        <span class="token comment"># 去掉frame头部份，将从1开始排序</span>
        self<span class="token punctuation">.</span>data_info <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>csv_path<span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token comment"># 得到训练数据的长度（个数）</span>
        self<span class="token punctuation">.</span>data_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>index<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>train_len <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_len <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> valid_ratio<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 将数据集分为训练集和验证集</span>
        <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>train_image <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>train_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>train_label <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>train_len<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>image_arr <span class="token operator">=</span> self<span class="token punctuation">.</span>train_image
            self<span class="token punctuation">.</span>label_arr <span class="token operator">=</span> self<span class="token punctuation">.</span>train_label
        <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'valid'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>valid_image <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>self<span class="token punctuation">.</span>train_len<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>valid_label <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>self<span class="token punctuation">.</span>train_len<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>image_arr <span class="token operator">=</span> self<span class="token punctuation">.</span>valid_image
            self<span class="token punctuation">.</span>label_arr <span class="token operator">=</span> self<span class="token punctuation">.</span>valid_label
    
        self<span class="token punctuation">.</span>real_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>image_arr<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Finished reading the {} set of Leaves Dataset ({} samples found)'</span>
              <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> self<span class="token punctuation">.</span>real_len<span class="token punctuation">)</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        single_image_name <span class="token operator">=</span> self<span class="token punctuation">.</span>image_arr<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token comment">#  打开某个具体图片，给出了完整路径</span>
        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>file_path <span class="token operator">+</span> single_image_name <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">)</span>
    <span class="token comment">#transform 采用了图像增强方法，包括大小，翻转，对比度，亮度，色调，以及正则化</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
            transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
                transforms<span class="token punctuation">.</span>RandomResizedCrop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.64</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
                transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
    
        image <span class="token operator">=</span> transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    
        label <span class="token operator">=</span> self<span class="token punctuation">.</span>label_arr<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        number_label <span class="token operator">=</span> class_to_num<span class="token punctuation">[</span>label<span class="token punctuation">]</span>
    
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> number_label
    
    <span class="token comment"># 返回数据集长度</span>
    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>real_len
    

        
</code></pre> 
<h4><a id="_106"></a>训练部分</h4> 
<blockquote> 
 <p>采用了学习率cos下降的方法，采用了AdamW优化函数，采用了Resnext50_32x4d网络</p> 
</blockquote> 
<pre><code class="prism language-python">
<span class="token keyword">import</span> torchvision
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler <span class="token keyword">import</span> CosineAnnealingLR
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token comment"># This is for the progress bar.</span>
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>lr<span class="token punctuation">,</span> weight_decay<span class="token punctuation">,</span> num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"using {} device.\n"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    train_path <span class="token operator">=</span> <span class="token string">'../input/dog-breed-identification/labels.csv'</span>
    file_path <span class="token operator">=</span>  <span class="token string">'../input/dog-breed-identification/train/'</span>

    train_dataset <span class="token operator">=</span> DogsData<span class="token punctuation">(</span>train_path<span class="token punctuation">,</span> file_path<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span> <span class="token punctuation">)</span>
    valid_dataset <span class="token operator">=</span> DogsData<span class="token punctuation">(</span>train_path<span class="token punctuation">,</span> file_path<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'valid'</span> <span class="token punctuation">)</span>
    
    train_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
            dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span>
            batch_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            num_workers<span class="token operator">=</span><span class="token number">2</span>
        <span class="token punctuation">)</span>
    valid_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
            dataset<span class="token operator">=</span>valid_dataset<span class="token punctuation">,</span>
            batch_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>
            shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            num_workers<span class="token operator">=</span><span class="token number">2</span>
        <span class="token punctuation">)</span>
    
    net <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>models<span class="token punctuation">.</span>resnext50_32x4d<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    in_channel <span class="token operator">=</span> net<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>in_features
    net<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channel<span class="token punctuation">,</span> n_class<span class="token punctuation">)</span><span class="token punctuation">)</span>
    net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    loss_function <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">)</span>
    scheduler <span class="token operator">=</span> CosineAnnealingLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> T_max<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    model_path <span class="token operator">=</span> <span class="token string">'./dog_resnext'</span>
    best_acc <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ---------- Training ----------</span>
        <span class="token comment"># Make sure the model is in train mode before training.</span>
        net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token comment"># These are used to record information in training.</span>
        train_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        train_accs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># Iterate the training set by batches.</span>
        <span class="token keyword">for</span> batch <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># A batch consists of image data and corresponding labels.</span>
            imgs<span class="token punctuation">,</span> labels <span class="token operator">=</span> batch
            imgs <span class="token operator">=</span> imgs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            <span class="token comment"># Forward the data. (Make sure data and model are on the same device.)</span>
            logits <span class="token operator">=</span> net<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span>
            <span class="token comment"># Calculate the cross-entropy loss.</span>
            <span class="token comment"># We don't need to apply softmax before computing cross-entropy as it is done automatically.</span>
            loss <span class="token operator">=</span> loss_function<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>

            <span class="token comment"># Gradients stored in the parameters in the previous step should be cleared out first.</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># Compute the gradients for parameters.</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># Update the parameters with computed gradients.</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># Compute the accuracy for current batch.</span>
            acc <span class="token operator">=</span> <span class="token punctuation">(</span>logits<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># Record the loss and accuracy.</span>
            train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            train_accs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>acc<span class="token punctuation">)</span>
        
        <span class="token comment"># The average loss and accuracy of the training set is the average of the recorded values.</span>
        train_loss <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span>
        train_acc <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>train_accs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_accs<span class="token punctuation">)</span>

        <span class="token comment"># Print the information.</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[ Train | </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token format-spec">03d</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num_epochs<span class="token punctuation">:</span><span class="token format-spec">03d</span><span class="token punctuation">}</span></span><span class="token string"> ] loss = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>train_loss<span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">}</span></span><span class="token string">, acc = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>train_acc<span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># ---------- Validation ----------</span>
        <span class="token comment"># Make sure the model is in eval mode so that some modules like dropout are disabled and work normally.</span>
        net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># These are used to record information in validation.</span>
        valid_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        valid_accs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment"># Iterate the validation set by batches.</span>
        <span class="token keyword">for</span> batch <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>valid_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            imgs<span class="token punctuation">,</span> labels <span class="token operator">=</span> batch
            <span class="token comment"># We don't need gradient in validation.</span>
            <span class="token comment"># Using torch.no_grad() accelerates the forward process.</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                logits <span class="token operator">=</span> net<span class="token punctuation">(</span>imgs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># We can still compute the loss (but not the gradient).</span>
            loss <span class="token operator">=</span> loss_function<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># Compute the accuracy for current batch.</span>
            acc <span class="token operator">=</span> <span class="token punctuation">(</span>logits<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># Record the loss and accuracy.</span>
            valid_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            valid_accs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>acc<span class="token punctuation">)</span>

        <span class="token comment"># The average loss and accuracy for entire validation set is the average of the recorded values.</span>
        valid_loss <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>valid_loss<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>valid_loss<span class="token punctuation">)</span>
        valid_acc <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>valid_accs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>valid_accs<span class="token punctuation">)</span>

        <span class="token comment"># Print the information.</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[ Valid | </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token format-spec">03d</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num_epochs<span class="token punctuation">:</span><span class="token format-spec">03d</span><span class="token punctuation">}</span></span><span class="token string"> ] loss = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>valid_loss<span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">}</span></span><span class="token string">, acc = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>valid_acc<span class="token punctuation">:</span><span class="token format-spec">.5f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># if the model improves, save a checkpoint at this epoch</span>
        <span class="token keyword">if</span> valid_acc <span class="token operator">&gt;</span> best_acc<span class="token punctuation">:</span>
            best_acc <span class="token operator">=</span> valid_acc
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> model_path<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'saving model with acc {:.3f}\n\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>best_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>经过训练后，最好的准确率达到了87%，<br> <img src="https://images2.imgbox.com/7e/8d/xbSZVVnI_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_231"></a>动手深度学习实战：树叶分类</h2> 
<p><a href="https://www.kaggle.com/competitions/classify-leaves" rel="nofollow">李沐大神出的教程-动手深度学习 Kaggle 树叶分类</a><br> 感兴趣上B站搜索李沐就好<br> <a href="https://www.kaggle.com/code/nekokiku/simple-resnet-baseline" rel="nofollow">如果真的感兴趣可以去这篇baseline 去看看，大佬思路清晰，看完简直如醍醐灌顶</a><br> 同样有其他大佬甚至将精度提高打了99%以上，感兴趣可以去看看别人怎么写的</p> 
<h4><a id="dataset_236"></a>dataset</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span> DataLoader
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> models
<span class="token comment"># This is for the progress bar.</span>
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

labels_dataframe <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../input/classify-leaves/train.csv'</span><span class="token punctuation">)</span>
leaves_labels <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>labels_dataframe<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
num_classes <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>leaves_labels<span class="token punctuation">)</span>
class_to_num <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>leaves_labels<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">LeavesData</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> csv_path<span class="token punctuation">,</span> file_path<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span> valid_ratio<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> resize_height<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> resize_width<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Args:
            csv_path (string): csv 文件路径
            img_path (string): 图像文件所在路径
            mode (string): 训练模式还是测试模式
            valid_ratio (float): 验证集比例
        """</span>
        
        <span class="token comment"># 需要调整后的照片尺寸，我这里每张图片的大小尺寸不一致#</span>
        self<span class="token punctuation">.</span>resize_height <span class="token operator">=</span> resize_height
        self<span class="token punctuation">.</span>resize_width <span class="token operator">=</span> resize_width

        self<span class="token punctuation">.</span>file_path <span class="token operator">=</span> file_path
        self<span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

        <span class="token comment"># 读取 csv 文件</span>
        <span class="token comment"># 利用pandas读取csv文件</span>
        self<span class="token punctuation">.</span>data_info <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>csv_path<span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token comment">#header=None是去掉表头部分</span>
        <span class="token comment"># 计算 length</span>
        self<span class="token punctuation">.</span>data_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>index<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>train_len <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_len <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> valid_ratio<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
            <span class="token comment"># 第一列包含图像文件的名称</span>
            self<span class="token punctuation">.</span>train_image <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>train_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">#self.data_info.iloc[1:,0]表示读取第一列，从第二行开始到train_len</span>
            <span class="token comment"># 第二列是图像的 label</span>
            self<span class="token punctuation">.</span>train_label <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>train_len<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>image_arr <span class="token operator">=</span> self<span class="token punctuation">.</span>train_image 
            self<span class="token punctuation">.</span>label_arr <span class="token operator">=</span> self<span class="token punctuation">.</span>train_label
        <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'valid'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>valid_image <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>self<span class="token punctuation">.</span>train_len<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
            self<span class="token punctuation">.</span>valid_label <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>self<span class="token punctuation">.</span>train_len<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>image_arr <span class="token operator">=</span> self<span class="token punctuation">.</span>valid_image
            self<span class="token punctuation">.</span>label_arr <span class="token operator">=</span> self<span class="token punctuation">.</span>valid_label
        <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'test'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>test_image <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>image_arr <span class="token operator">=</span> self<span class="token punctuation">.</span>test_image
            
        self<span class="token punctuation">.</span>real_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>image_arr<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Finished reading the {} set of Leaves Dataset ({} samples found)'</span>
              <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> self<span class="token punctuation">.</span>real_len<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 从 image_arr中得到索引对应的文件名</span>
        single_image_name <span class="token operator">=</span> self<span class="token punctuation">.</span>image_arr<span class="token punctuation">[</span>index<span class="token punctuation">]</span>

        <span class="token comment"># 读取图像文件</span>
        img_as_img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>file_path <span class="token operator">+</span> single_image_name<span class="token punctuation">)</span>

        <span class="token comment">#如果需要将RGB三通道的图片转换成灰度图片可参考下面两行</span>
<span class="token comment">#         if img_as_img.mode != 'L':</span>
<span class="token comment">#             img_as_img = img_as_img.convert('L')</span>

        <span class="token comment">#设置好需要转换的变量，还可以包括一系列的nomarlize等等操作</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
            transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
                transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>RandomResizedCrop<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.08</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3.0</span> <span class="token operator">/</span> <span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span> <span class="token operator">/</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">#随机水平翻转 选择一个概率</span>
                transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># valid和test不做数据增强</span>
            transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
                transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        img_as_img <span class="token operator">=</span> transform<span class="token punctuation">(</span>img_as_img<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'test'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> img_as_img
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 得到图像的 string label</span>
            label <span class="token operator">=</span> self<span class="token punctuation">.</span>label_arr<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
            <span class="token comment"># number label</span>
            number_label <span class="token operator">=</span> class_to_num<span class="token punctuation">[</span>label<span class="token punctuation">]</span>

            <span class="token keyword">return</span> img_as_img<span class="token punctuation">,</span> number_label  <span class="token comment">#返回每一个index对应的图片数据和对应的label</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>real_len

</code></pre> 
<h4><a id="_348"></a>训练部分</h4> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler <span class="token keyword">import</span> CosineAnnealingLR
<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>lr<span class="token punctuation">,</span> weight_decay<span class="token punctuation">,</span> num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"using {} device.\n"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
    train_path <span class="token operator">=</span> <span class="token string">'../input/classify-leaves/train.csv'</span>
    img_path <span class="token operator">=</span> <span class="token string">'../input/classify-leaves/'</span>
    train_dataset <span class="token operator">=</span> LeavesData<span class="token punctuation">(</span>train_path<span class="token punctuation">,</span> img_path<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">)</span>
    val_dataset <span class="token operator">=</span> LeavesData<span class="token punctuation">(</span>train_path<span class="token punctuation">,</span> img_path<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'valid'</span><span class="token punctuation">)</span>
    train_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
        dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> 
        shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        num_workers<span class="token operator">=</span><span class="token number">2</span>
            <span class="token punctuation">)</span>

    val_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
            dataset<span class="token operator">=</span>val_dataset<span class="token punctuation">,</span>
            batch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> 
            shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            num_workers<span class="token operator">=</span><span class="token number">2</span>
          <span class="token punctuation">)</span>
    net <span class="token operator">=</span> models<span class="token punctuation">.</span>resnext50_32x4d<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment">#model_weight_path = "../input/resnet-module/resnet34.pth"      # 迁移学习的模型参数</span>
    <span class="token comment">#assert os.path.exists(model_weight_path), "file {} does not exist.".format(model_weight_path)</span>
    <span class="token comment">#net.load_state_dict(torch.load(model_weight_path, map_location='cpu'))</span>
    <span class="token comment"># for param in net.parameters():</span>
    <span class="token comment">#     param.requires_grad = False</span>

    <span class="token comment"># change fc layer structure</span>
    in_channel <span class="token operator">=</span> net<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>in_features
    net<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channel<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    loss_function <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">)</span>
    scheduler <span class="token operator">=</span> CosineAnnealingLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> T_max<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    best_acc <span class="token operator">=</span> <span class="token number">0.0</span>
    save_path <span class="token operator">=</span> <span class="token string">'./my_leaves_resnext50_32x4d.pth'</span>
    train_steps <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span>
    val_steps <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>val_loader<span class="token punctuation">)</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        running_loss <span class="token operator">=</span> <span class="token number">0.0</span>
        train_bar <span class="token operator">=</span> tqdm<span class="token punctuation">(</span>train_loader<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>
        train_acc<span class="token punctuation">,</span> train_total <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token keyword">for</span> step<span class="token punctuation">,</span> <span class="token punctuation">(</span>images<span class="token punctuation">,</span> label<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_bar<span class="token punctuation">)</span><span class="token punctuation">:</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            images <span class="token operator">=</span> images<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            label <span class="token operator">=</span> label<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            y_hat <span class="token operator">=</span> net<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> loss_function<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            running_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            train_predict_y <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            train_total <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span>
            train_acc <span class="token operator">+=</span> torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>train_predict_y<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>            
            
            train_bar<span class="token punctuation">.</span>desc <span class="token operator">=</span> <span class="token string">"train epoch[{}/{}] loss:{:.3f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>num_epochs<span class="token punctuation">,</span>loss<span class="token punctuation">)</span>
            <span class="token keyword">del</span> loss<span class="token punctuation">,</span> images<span class="token punctuation">,</span> label<span class="token punctuation">,</span> y_hat
            torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>empty_cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
        train_accurate <span class="token operator">=</span> train_acc <span class="token operator">/</span> train_total
        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        val_acc <span class="token operator">=</span> <span class="token number">0.0</span>  <span class="token comment"># accumulate accurate number / epoch</span>
        val_loss <span class="token operator">=</span> <span class="token number">0.0</span>
        val_total <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            val_bar <span class="token operator">=</span> tqdm<span class="token punctuation">(</span>val_loader<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>
            <span class="token keyword">for</span> val_data <span class="token keyword">in</span> val_bar<span class="token punctuation">:</span>
                val_images<span class="token punctuation">,</span> val_labels <span class="token operator">=</span> val_data
                val_images <span class="token operator">=</span> val_images<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                val_labels <span class="token operator">=</span> val_labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                outputs <span class="token operator">=</span> net<span class="token punctuation">(</span>val_images<span class="token punctuation">)</span>
                loss <span class="token operator">=</span> loss_function<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> val_labels<span class="token punctuation">)</span>
                val_predict_y <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                val_total <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>val_labels<span class="token punctuation">)</span>
                val_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                val_acc <span class="token operator">+=</span> torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>val_predict_y<span class="token punctuation">,</span> val_labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                val_bar<span class="token punctuation">.</span>desc <span class="token operator">=</span> <span class="token string">"valid epoch[{}/{}]"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> num_epochs<span class="token punctuation">)</span>
                <span class="token keyword">del</span> outputs<span class="token punctuation">,</span> val_images<span class="token punctuation">,</span> val_labels
                torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>empty_cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
        val_accurate <span class="token operator">=</span>  val_acc <span class="token operator">/</span> val_total
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[epoch %d] train_loss: %.3f  train_accuracy: %.3f  val_loss: %.3f val_accuracy: %.3f \n'</span> <span class="token operator">%</span>
              <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> running_loss <span class="token operator">/</span> train_steps<span class="token punctuation">,</span> train_accurate<span class="token punctuation">,</span> val_loss <span class="token operator">/</span> val_steps<span class="token punctuation">,</span> val_accurate<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> val_accurate <span class="token operator">&gt;</span> best_acc<span class="token punctuation">:</span>
            best_acc <span class="token operator">=</span> val_accurate
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> save_path<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'best accuracy: {:.3f}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>best_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Finished Training'</span><span class="token punctuation">)</span>
</code></pre> 
<p>最后的验证最好精度是93%，他的训练精度比他稍小（因为加入了很强的图像增广），其实最好的精度达到了95%但是值得注意的是它的训练精度达到了99%，我认为知识一个过拟合的信号，所以选择放弃这个，而是选择前面了那个<br> <img src="https://images2.imgbox.com/26/c1/q7F6CJEy_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df5c3c1d40e2e43377b94a950d1c8ba2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Next-item Recommendation with Sequential Hypergraphs 论文阅读笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7758162893892b95c06d3e3d57684719/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python使用tk编写GUI界面中Button调用方法如果执行时间过长的话会导致tk界面卡死，或者一拖动就会卡死</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>