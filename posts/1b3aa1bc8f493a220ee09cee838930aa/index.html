<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ansible常用模块实例 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ansible常用模块实例" />
<meta property="og:description" content="Command模块：
Command:在远程主机执行命令，默认模块可忽略-m。
Command:模块不支持变量，管道符，&amp;，$，echo &gt;等需要使用shell模块。
ansible all -m command -a &#39;systemctl restart network&#39;
重启主机清单的所有主机的网络(以上是完整的写法)。
可以省略-m，因为它时默认的模块。
ansible all -a &#39;systemctl restart network&#39;
ansible web -a &#39;ls -l /tmp&#39; (查看web组tmp目录下面有哪些文件)
ansible all -a &#39;mkdir -p /data&#39; (所有主机创建/data目录)
ansible all -a &#39;df -hT&#39; (查看所有主机的磁盘使用率)
查看命令的帮助：ansible-doc command 详细参数
ansible all -a &#39;removes=/data/test.txt rm -rf /data/test.txt&#39;
removes：如果这个文件不存在则不执行，文件存在则执行
ansible all -a &#39;ls -l /data/&#39; (首先查看目录为空)
Ansible all -a &#39;creates=/data/aa.txt touch /data/aa.txt&#39;
creates:如果存在反而不执行，如果不存在反而执行
ansible all -a &#39;chdir=/data ls -l&#39;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1b3aa1bc8f493a220ee09cee838930aa/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-02-10T21:59:00+08:00" />
<meta property="article:modified_time" content="2020-02-10T21:59:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ansible常用模块实例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="cnblogs_post_body"> 
 <p><strong>Command</strong><strong>模块：</strong></p> 
 <p>Command:在远程主机执行命令，默认模块可忽略-m。</p> 
 <p>Command:模块不支持变量，管道符，&amp;，$，echo  &gt;等需要使用shell模块。</p> 
 <p>ansible all -m command -a 'systemctl restart network'</p> 
 <p>重启主机清单的所有主机的网络(以上是完整的写法)。</p> 
 <p>可以省略-m，因为它时默认的模块。</p> 
 <p>ansible all  -a 'systemctl restart network'</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/2c/fd/GQek3vjR_o.png"> 
 </div> 
 <p>ansible web -a 'ls -l /tmp' (查看web组tmp目录下面有哪些文件)</p> 
 <p>ansible all -a 'mkdir -p /data' (所有主机创建/data目录)</p> 
 <p>ansible all -a 'df -hT' (查看所有主机的磁盘使用率)</p> 
 <p>查看命令的帮助：ansible-doc command 详细参数</p> 
 <p>ansible all -a 'removes=/data/test.txt rm -rf /data/test.txt'</p> 
 <p>removes：如果这个文件不存在则不执行，文件存在则执行</p> 
 <p>ansible all -a 'ls -l /data/'  (首先查看目录为空)</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/9b/cf/Au0LNjvk_o.png"> 
 </div> 
 <p>Ansible all -a 'creates=/data/aa.txt touch /data/aa.txt'</p> 
 <p>creates:如果存在反而不执行，如果不存在反而执行</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/02/aa/lv5ct9BY_o.png"> 
 </div> 
 <p>ansible all -a 'chdir=/data  ls -l'</p> 
 <p>chdir:切换至某个文件夹下</p> 
 <p><strong>shell</strong><strong>模块：</strong></p> 
 <p>shell和command相似，用于执行shell命令。</p> 
 <p>Shell不是默认的模块所以要加-m</p> 
 <p>ansible all -m shell -a 'echo $HOSTNAME'</p> 
 <p>使用shell模块输出所有主机的名字。</p> 
 <p>ansible all -a 'useradd test1'   (所有的主机创建一个test1的用户)</p> 
 <p>ansible all -m shell -a 'cat /etc/passwd | grep test1'</p> 
 <p>使用管道符查看是否创建成功。</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/ce/67/vp1siPVx_o.png"> 
 </div> 
 <p>nsible all -m shell -a 'echo 123.com!|passwd --stdin test1'</p> 
 <p>为所有主机的test1用户生成密码口令。</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/6a/87/kljRF5BJ_o.png"> 
 </div> 
 <p>删除某个文件但是后缀时日期的有很多需要*号匹配</p> 
 <p>ansible all -m shell -a 'rm -rf  /tmp/aa.txt.*'</p> 
 <p><strong>Script</strong><strong>：运行脚本模块(</strong><strong>ansible-doc script:</strong><strong>帮助)</strong></p> 
 <p>只需要在ansible端将脚本编写好，就可以在所有的主机上面执行。</p> 
 <p>例子：在/tmp目录下面写一个简单的脚本。</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/67/0f/31LPi651_o.png"> 
 </div> 
 <p>ansible all -m script -a '/tmp/hostname.sh'</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/36/a5/1HXgUvPP_o.png"> 
 </div> 
 <p><strong>Copy</strong><strong>模块：</strong></p> 
 <p>将ansible端/tmp目录下的hostname.sh复制到所有主机的/tmp目录下面。</p> 
 <p>ansible all -m copy -a 'src=/tmp/hostname.sh dest=/tmp/hostname.sh'</p> 
 <p>src:源路径</p> 
 <p>dest:目标路径</p> 
 <p>ansible all -a 'ls -l /tmp' (查看是否都已经复制到所有主机的/tmp目录下面)</p> 
 <p>将ansible端的aa.txt拷贝到所有的主机，如果其他主机存在aa.txt文件，执行这条命令后将会备份原有的，将新的这个aa.txt拷贝到指定的路径下。</p> 
 <p>ansible all -m copy -a 'src=/tmp/aa.txt dest=/tmp/aa.txt backup=yes'</p> 
 <p>ansible all -a 'ls -l /tmp/'  (查看是否备份及复制)</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/ab/5b/Fmql6VNJ_o.png"> 
 </div> 
 <p>删除备份的文件</p> 
 <p>ansible all -m shell -a 'rm -rf  /tmp/aa.txt.*'<br> 将文件拷贝到所有的主机，并设置权限及所有者。</p> 
 <p>ansible all -m copy -a 'src=/tmp/hostname.sh dest=/tmp/hostname.sh mode=000 owner=test1'</p> 
 <p>有原始文件的话还是要加上backup=yes,做一个备份。</p> 
 <p>查看权限</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/3a/17/mU6ID46Z_o.png"> 
 </div> 
 <p>Content:输出内容到文件</p> 
 <p>ansible all -m copy -a 'content="welcome to beijing" dest=/tmp/welcome.txt'</p> 
 <p>查看是否输出到目标主机的welcome.txt文件</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/9a/f6/hUutFJep_o.png"> 
 </div> 
 <p><strong>Fetch:</strong><strong>从客户端(</strong><strong>ansible-client</strong><strong>)取文件至服务器端(</strong><strong>ansible-server</strong><strong>)，</strong><strong>copy</strong><strong>相反，目录文件可以先</strong><strong>tar,</strong><strong>因为只支持单个文件不支持目录拉取。</strong></p> 
 <p>将远程所有主机的messages日志拉取到ansible端的目录</p> 
 <p>ansible all -m fetch -a 'src=/var/log/messages dest=/data/'</p> 
 <p>src=ansible-client (客户端文件)</p> 
 <p>dest=ansible-server(ansible服务端)</p> 
 <p>file:设置文件属性，包括删除创建。</p> 
 <p>State=touch(创建文件)</p> 
 <p>      Directory(创建目录)</p> 
 <p>      Link(创建软连接文件)</p> 
 <p>Absent(删除)</p> 
 <p>在远程主机的/backup目录创建一个文件。</p> 
 <p>ansible all -m file -a 'path=/backup/aa.txt state=touch'</p> 
 <p>删除远程主机的文件。</p> 
 <p>ansible all -m file -a 'path=/backup/aa.txt state=absent'</p> 
 <p>创建文件夹，(删除文件夹及文件建议使用shell模块)</p> 
 <p>ansible all -m file -a 'path=/backup/dir1 state=directory'</p> 
 <p>创建一个软连接文件(将/etc/fstab软连接到/backup目录下)</p> 
 <p>ansible all -m file -a 'src=/etc/fstab dest=/backup/fstab state=link'</p> 
 <p>删除软连接</p> 
 <p>ansible all -m file -a 'dest=/backup/fstab state=absent'</p> 
 <p>创建一个文件设置属主为test1，及文件的权限644。</p> 
 <p>ansible all -m file -a 'path=/backup/test.txt state=touch mode=644 owner=test1'</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/db/43/G1XB9sj6_o.png"> 
 </div> 
 <p><strong>Cron:</strong><strong>计划任务</strong></p> 
 <p>支持时间：minute(钟),hour(时),day(天),month(月),weekday(星期)</p> 
 <p>制作一个简单的备份脚本测试</p> 
 <p>Vi logbak.sh  (在ansible端制作一个备份的脚本)</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/4f/c2/teZSl4e5_o.png"> 
 </div> 
 <p>然后复制到所有主机清单的opt目录下并加执行权限</p> 
 <p>ansible all -m copy -a 'src=/data/logbak.sh dest=/opt/logbak.sh mode=+x'</p> 
 <p>然后我们制作一个每分钟都执行的脚本。</p> 
 <p>ansible all -m cron -a 'minute=*/1 job=/opt/logbak.sh name=allbak'</p> 
 <p>minute：分钟 设置的每一分钟执行一个为了看效果，实际的操作跟你设置crontab是一样的，根据你公司要求设置备份的时间。</p> 
 <p>Job：设置执行脚本的路径</p> 
 <p>Name：设置脚本名字</p> 
 <p>我们查看清单主机的计划任务看是否设置完成。</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/bd/2a/zhTB1TIl_o.png"> 
 </div> 
 <p>查看主机清单主机备份目录已经有备份。</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/63/a5/VPJuR3aC_o.png"> 
 </div> 
 <p>禁用计划任务。</p> 
 <p>Disabled=yes(禁用任务，也就是注释掉任务)</p> 
 <p>                No(开启任务，也就是取消注释)</p> 
 <p>ansible all -m cron -a 'disabled=yes job=/opt/logbak.sh name=allbak'</p> 
 <div> 
  <img alt="" src="https://images2.imgbox.com/4d/04/jbceddpU_o.png"> 
 </div> 
 <p>删除备份日志计划任务，彻底不使用计划任务(state=absent)删除命令有些是类似的。</p> 
 <p>ansible all -m cron -a 'job=/opt/logbak.sh name=allbak state=absent'</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/be96a75f58528b3cb42f54b40673fad6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vbs学习，书籍，看书笔记(2)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fce74ad3d53feb2f563862bfd9e694d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第四章第一题（几何：五边形的面积）(Geometry: area of a pentagon)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>