<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springboot前后端分离-使用微信扫码登录（后端） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springboot前后端分离-使用微信扫码登录（后端）" />
<meta property="og:description" content="springboot前后端分离-使用微信扫码登录（后端） 最近项目需要，临时加入了微信扫码登录的功能，让身为小白的我很是折磨，在网上搜了很多的教程，也被一些cv博客误导了许久，本篇blog主要从小白（我自己）的角度介绍前后端分离项目中如何接入微信扫码登录功能（仅后端）
扫码登录的基本流程 使用微信扫码登录 我们肯定要先来了解一下扫码登录的基本流程啦
前端首先向服务端发送一个请求，用来获取二维码的url和唯一随机数（用UUID即可，这个随机数可以理解为这个二维码的key值，一一对应，所以尽量要用唯一的）同时服务端要记录这条随机数（存redis和其他数据库均可，找个地方记录下来）前端自从收到二维码和随机数后，展示二维码，并轮询一个检查二维码状态的接口（用来判断用户是否扫码并确认）很关键的一步客户扫码并确认后，会回调给服务端一个请求，服务端就能拿到对应的二维码的key（之前产生的随机数）前端轮询中 发现二维码状态值变为用户扫码已确认的值后，向后端发送业务请求（登录。。。。） 微信扫码登录的流程 首先你要有微信开放平台的资质和已审核过的应用（这里我就不过多赘述了，实际我也不太懂##）
官方文档：https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html
首先要在微信开放平台网站应用里设置授权回调域
这个地方要注意不要加http:// https://前缀 要用域名，不要用ip地址 可以加端口号（我自己做的时候加了端口号，是可以的，但是我不知道有些博客上说不能加端口）（不要在这加接口哈！至于微信是怎么知道回调的接口的 是在获取二维码url时候拼接一个请求wx的url，在这个url里有一个redirect_uri参数 在这里指定接口）
本机测试的话 建议进行一下内网穿透 我使用的工具（https://suidao.oauth.k9s.run/）
coding的流程 给微信发个请求 获取二维码url
这部其实就是拼接请求url 具体看下官方文档 我在这里就不cv了
注：我这里state的作用：把二维码和一个随机数绑定起来（随机数可理解为二维码的key，设为唯一的）
把state设为这个key 并发送给前端，让前端轮询的时候带上这个key
/** * 生成二维码 * @return */ @GetMapping(&#34;/getWechatQtCode&#34;) public Object getWechatQtCode(){ JSONObject res = new JSONObject(); try { // 生成随机数 作为二维码的key String key = UUID.randomUUID().toString().replace(&#34;-&#34;,&#34;&#34;); String redirectUri2 = URLEncoder.encode(redirectUri,&#34;utf-8&#34;); String oauthUrl = &#34; https://open.weixin.qq.com/connect/qrconnect&#34; &#43; &#34;?appid=&#34; &#43; appId &#43; &#34;&amp;redirect_uri=&#34; &#43; redirectUri2 &#43; &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a8b7e0d67c2055d2495cb74aef9426d7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-18T20:41:44+08:00" />
<meta property="article:modified_time" content="2022-04-18T20:41:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springboot前后端分离-使用微信扫码登录（后端）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="springboot_0"></a>springboot前后端分离-使用微信扫码登录（后端）</h2> 
<p>最近项目需要，临时加入了微信扫码登录的功能，让身为小白的我很是折磨，在网上搜了很多的教程，也被一些cv博客误导了许久，本篇blog主要从小白（我自己）的角度介绍前后端分离项目中如何接入微信扫码登录功能（仅后端）</p> 
<h2><a id="_4"></a>扫码登录的基本流程</h2> 
<p>使用微信扫码登录 我们肯定要先来了解一下扫码登录的基本流程啦</p> 
<ol><li>前端首先向服务端发送一个请求，用来获取二维码的url和唯一随机数（用UUID即可，这个随机数可以理解为这个二维码的key值，一一对应，所以尽量要用唯一的）</li><li>同时服务端要记录这条随机数（存redis和其他数据库均可，找个地方记录下来）</li><li>前端自从收到二维码和随机数后，展示二维码，并轮询一个检查二维码状态的接口（用来判断用户是否扫码并确认）<strong>很关键的一步</strong></li><li>客户扫码并确认后，会回调给服务端一个请求，服务端就能拿到对应的二维码的key（之前产生的随机数）</li><li>前端轮询中 发现二维码状态值变为用户扫码已确认的值后，向后端发送业务请求（登录。。。。）</li></ol> 
<h3><a id="_14"></a>微信扫码登录的流程</h3> 
<p>首先你要有微信开放平台的资质和已审核过的应用（这里我就不过多赘述了，实际我也不太懂##）</p> 
<p><strong>官方文档：https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</strong></p> 
<p><img src="https://images2.imgbox.com/c7/85/k2pkr04m_o.png" alt="img"></p> 
<p>首先要在微信开放平台网站应用里设置授权回调域</p> 
<p>这个地方要注意不要加http:// https://前缀 要用域名，不要用ip地址 可以加端口号（我自己做的时候加了端口号，是可以的，但是我不知道有些博客上说不能加端口）（不要在这加接口哈！至于微信是怎么知道回调的接口的 是在获取二维码url时候拼接一个请求wx的url，在这个url里有一个redirect_uri参数 在这里指定接口）</p> 
<p>本机测试的话 建议进行一下内网穿透 我使用的工具（https://suidao.oauth.k9s.run/）</p> 
<p><img src="https://images2.imgbox.com/7c/b8/8C2nQECt_o.png" alt="image-20220418194642151"></p> 
<p><img src="https://images2.imgbox.com/24/27/uT4DvU2D_o.png" alt="image-20220418190205376"></p> 
<h4><a id="coding_34"></a>coding的流程</h4> 
<ol><li> <p>给微信发个请求 获取二维码url</p> <p>这部其实就是拼接请求url 具体看下官方文档 我在这里就不cv了</p> <p>注：我这里state的作用：把二维码和一个随机数绑定起来（随机数可理解为二维码的key，设为唯一的）</p> <p>把state设为这个key 并发送给前端，让前端轮询的时候带上这个key</p> <pre><code class="prism language-java"><span class="token comment">/**
     * 生成二维码
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getWechatQtCode"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getWechatQtCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JSONObject</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 生成随机数 作为二维码的key</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> redirectUri2 <span class="token operator">=</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>redirectUri<span class="token punctuation">,</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> oauthUrl <span class="token operator">=</span> <span class="token string">" https://open.weixin.qq.com/connect/qrconnect"</span> <span class="token operator">+</span>
                    <span class="token string">"?appid="</span> <span class="token operator">+</span> appId <span class="token operator">+</span>
                    <span class="token string">"&amp;redirect_uri="</span> <span class="token operator">+</span> redirectUri2 <span class="token operator">+</span>
                    <span class="token string">"&amp;response_type=code"</span> <span class="token operator">+</span>
                    <span class="token string">"&amp;scope=snsapi_login"</span> <span class="token operator">+</span>
                    <span class="token string">"&amp;state="</span> <span class="token operator">+</span> key <span class="token operator">+</span>
                    <span class="token string">"#wechat_redirect"</span><span class="token punctuation">;</span>


            res<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span>oauthUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"二维码生成失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> </li><li> <p>微信在扫码用户确认后，回调接口</p> <p>扫码用户点击确认后，微信会回调服务端接口，这个回调的接口就是你拼接生成二维码接口中拼接url的<strong>redirect_uri</strong> （注：这个redirect_uri 的前缀要与你在微信开放平台中填写的回调域一致）</p> <p>回调接口会带上两个参数（code:二维码的唯一标识，用于获取<strong>access_token</strong>，state:生成二维码接口中拼接url中的参数）</p> <p><strong>思考：此时是后端能通过code获取扫码用户的信息，但是怎么发送给前端呢？</strong>（注：普通的http协议 后端是不能主动给前端发送数据的）</p> <p>方案一：使用websocket，后端主动把数据发送给前端</p> <p>方案二：把微信回调的参数code和state存储到数据库中（state作为key） 因为前端是能拿到state的，在前端拿到state后（就是获取二维码url的时间），开始轮询一个检查用户扫码状态的接口（state作为参数），后端去数据库中查这个state是否存在，若不存在，代表用户还未扫码，若存在，则通过code把获取的用户信息返回给前端</p> <p>我在本篇blog中用的方案二</p> <pre><code class="prism language-java"><span class="token comment">/**
     * 微信认证/登录的回调方法（微信开放平台填写的回调域）
     * @return
     */</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/ucenter/wx/callback"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wxCallBack</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span><span class="token class-name">String</span> code<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span><span class="token class-name">String</span> state<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//把二维码url和key存入redis</span>
        redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>code<span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre> </li><li> <p>轮询的接口</p> <p>这个接口中，通过code获取了access_token，又通过access_token获取了userInfo（具体看一下官方文档）</p> <p>实际上是使用了HttpClient向微信发送了两次请求（代码中使用的HttpClient工具类请看blog末尾的github源码）</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/wxLogin/checkState"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">checkState</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> json<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JSONObject</span> params <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            res<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 未扫码</span>
            res<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            res<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 扫码并已确认</span>
            res<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取微信用户信息</span>
            <span class="token comment">//获取access_token</span>
            <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
            <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/oauth2/access_token"</span> <span class="token operator">+</span>
                    <span class="token string">"?appid="</span> <span class="token operator">+</span> appId <span class="token operator">+</span>
                    <span class="token string">"&amp;secret="</span> <span class="token operator">+</span> appSecret <span class="token operator">+</span>
                    <span class="token string">"&amp;code="</span> <span class="token operator">+</span> code <span class="token operator">+</span>
                    <span class="token string">"&amp;grant_type=authorization_code"</span><span class="token punctuation">;</span>
            <span class="token class-name">JSONObject</span> resultObject <span class="token operator">=</span> <span class="token class-name">HttpClientUtil</span><span class="token punctuation">.</span><span class="token function">httpGet</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//请求获取userInfo 并放入返回结果中</span>
            <span class="token class-name">String</span> infoUrl <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/userinfo"</span> <span class="token operator">+</span>
                    <span class="token string">"?access_token="</span> <span class="token operator">+</span> resultObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">"&amp;openid="</span> <span class="token operator">+</span> resultObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">"&amp;lang=zh_CN"</span><span class="token punctuation">;</span>
            <span class="token class-name">JSONObject</span> resultInfo <span class="token operator">=</span> <span class="token class-name">HttpClientUtil</span><span class="token punctuation">.</span><span class="token function">httpGet</span><span class="token punctuation">(</span>infoUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"userInfo"</span><span class="token punctuation">,</span>resultInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p>源码：https://github.com/xiaoping123456/wxLogin_demo/tree/master</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/66a82580d934f75e38e505ee8a0e9333/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">VOSviewer | （二）入门-分析web of science</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ee4afb18154485edf27401da95f672a1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">微信小程序路线规划导航，选择起点和终点路线规划</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>