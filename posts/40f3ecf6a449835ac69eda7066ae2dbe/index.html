<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hive08_分区表 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Hive08_分区表" />
<meta property="og:description" content="一 分区表 1 概念： 分区表实际上就是对应一个 HDFS 文件系统上的独立的文件夹，该文件夹下是该分区所
有的数据文件。Hive 中的分区就是分目录，把一个大的数据集根据业务需要分割成小的数据
集。在查询时通过 WHERE 子句中的表达式选择查询所需要的指定的分区，这样的查询效率
会提高很多。
2 案例演示 1 创建分区表语法 hive (default)&gt; create table dept_par( deptno int, dname string, loc string ) partitioned by (day string) row format delimited fields terminated by &#39;\t&#39;; 注意：分区字段不能是表中已经存在的数据，可以将分区字段看作表的伪列。
2 加载数据到分区表中 （1） 数据准备
dept_20220401.log
10	ACCOUNTING	1700 20	RESEARCH	1800 dept_20220402.log
30	SALES	1900 40	OPERATIONS	1700 dept_20220403.log
50	TEST	2000 60	DEV	1900 （2） 加载数据
hive (default)&gt; load data local inpath &#39;/usr/soft/datas/dept_20220401." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/40f3ecf6a449835ac69eda7066ae2dbe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-03T08:14:56+08:00" />
<meta property="article:modified_time" content="2024-01-03T08:14:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hive08_分区表</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="__0"></a>一 分区表</h2> 
<h3><a id="1__2"></a>1 概念：</h3> 
<p>分区表实际上就是对应一个 HDFS 文件系统上的独立的文件夹，该文件夹下是该分区所</p> 
<p>有的数据文件。Hive 中的分区就是分目录，把一个大的数据集根据业务需要分割成小的数据</p> 
<p>集。在查询时通过 WHERE 子句中的表达式选择查询所需要的指定的分区，这样的查询效率</p> 
<p>会提高很多。</p> 
<h3><a id="2__14"></a>2 案例演示</h3> 
<h4><a id="1__16"></a><strong>1 创建分区表语法</strong></h4> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> dept_par<span class="token punctuation">(</span>
deptno <span class="token keyword">int</span><span class="token punctuation">,</span> dname string<span class="token punctuation">,</span> loc string
<span class="token punctuation">)</span>
partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span><span class="token keyword">day</span> string<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
</code></pre> 
<p><em><strong>注意：分区字段不能是表中已经存在的数据，可以将分区字段看作表的伪列。</strong></em></p> 
<h4><a id="2__34"></a><strong>2 加载数据到分区表中</strong></h4> 
<p><strong>（1） 数据准备</strong><br> dept_20220401.log</p> 
<pre><code class="prism language-sql"><span class="token number">10</span>	ACCOUNTING	<span class="token number">1700</span>
<span class="token number">20</span>	RESEARCH	<span class="token number">1800</span>
</code></pre> 
<p>dept_20220402.log</p> 
<pre><code class="prism language-sql"><span class="token number">30</span>	SALES	<span class="token number">1900</span>
<span class="token number">40</span>	OPERATIONS	<span class="token number">1700</span>
</code></pre> 
<p>dept_20220403.log</p> 
<pre><code>50	TEST	2000
60	DEV	1900
</code></pre> 
<p><strong>（2） 加载数据</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath 
<span class="token string">'/usr/soft/datas/dept_20220401.log'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> dept_par 
<span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath 
<span class="token string">'/usr/soft/datas/dept_20220402.log'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> dept_par 
<span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220402'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath 
<span class="token string">'/usr/soft/datas/dept_20220403.log'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> dept_par 
<span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220403'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><em><strong>注意：分区表加载数据时，必须指定分区</strong></em></p> 
<p><img src="https://images2.imgbox.com/34/cb/CEnkOw8J_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/a1/a6/JKfxAPAj_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3__104"></a><strong>3 查询分区表中数据</strong></h4> 
<p><strong>单分区查询</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span><span class="token punctuation">;</span>
或者
hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition <span class="token keyword">where</span> deptno<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">or</span> deptno<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
</code></pre> 
<p><em><strong>上述第二种方式，是对全表进行搜索查询！</strong></em></p> 
<p><em><strong>而第一种方式，仅仅对某一张分区表进行搜索查询</strong></em></p> 
<p><strong>多分区联合查询</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span>
 <span class="token keyword">union</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220402'</span>
 <span class="token keyword">union</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220403'</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span> <span class="token operator">or</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220402'</span> <span class="token operator">or</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220403'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="4__138"></a>4 增加分区</h4> 
<p><strong>创建单个分区</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> dept_partition <span class="token keyword">add</span> <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220404'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>同时创建多个分区</strong></p> 
<pre><code>hive (default)&gt; alter table dept_partition add partition(day='20220405') 
partition(day='20220406');
</code></pre> 
<h4><a id="5__155"></a>5 删除分区</h4> 
<p><strong>删除单个分区</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> dept_partition <span class="token keyword">drop</span> <span class="token keyword">partition</span> <span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220406'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>同时删除多个分区</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> dept_partition <span class="token keyword">drop</span> <span class="token keyword">partition</span> <span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220404'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220405'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="6__173"></a>6 查看分区表有多少分区</h4> 
<pre><code class="prism language-sql">hive<span class="token operator">&gt;</span> <span class="token keyword">show</span> partitions dept_partition<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="7__181"></a>7 查看分区表结构</h4> 
<pre><code class="prism language-sql">hive<span class="token operator">&gt;</span> <span class="token keyword">desc</span> formatted dept_partition<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="__189"></a>二 级分区</h2> 
<p><em><strong>思考: 如何一天的日志数据量也很大，如何再将数据拆分?</strong></em></p> 
<h3><a id="1__193"></a>1 创建二级分区表</h3> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> dept_partition2<span class="token punctuation">(</span>
 deptno <span class="token keyword">int</span><span class="token punctuation">,</span> dname string<span class="token punctuation">,</span> loc string
 <span class="token punctuation">)</span>
 partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span><span class="token keyword">day</span> string<span class="token punctuation">,</span> <span class="token keyword">hour</span> string<span class="token punctuation">)</span>
 <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="2____205"></a>2 正常的加载数据</h3> 
<p><strong>（1）加载数据到二级分区表中</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath 
<span class="token string">'/usr/soft/hive/datas/dept_20220401.log'</span> <span class="token keyword">into</span> <span class="token keyword">table</span>
dept_partition2 <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span><span class="token punctuation">,</span> <span class="token keyword">hour</span><span class="token operator">=</span><span class="token string">'12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>（2）查询分区数据</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition2 <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span> <span class="token operator">and</span> <span class="token keyword">hour</span><span class="token operator">=</span><span class="token string">'12'</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>3）把数据直接上传到分区目录上，让分区表和数据产生关联的三种方式</strong></p> 
<p><strong>（1）方式一：上传数据后修复</strong><br> <strong>上传数据</strong></p> 
<pre><code class="prism language-sh">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> dfs <span class="token parameter variable">-mkdir</span> <span class="token parameter variable">-p</span>
/user/hive/warehouse/dept_partition2/day<span class="token operator">=</span><span class="token number">20220401</span>/hour<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>

hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> dfs <span class="token parameter variable">-put</span> /usr/soft/datas/dept_20220401.log 
/user/hive/warehouse/dept_partition2/day<span class="token operator">=</span><span class="token number">20220401</span>/hour<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>查询数据（查询不到刚上传的数据）</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition2 <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span> <span class="token operator">and</span> <span class="token keyword">hour</span><span class="token operator">=</span><span class="token string">'13'</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>执行修复命令</strong></p> 
<pre><code class="prism language-sql">hive<span class="token operator">&gt;</span> msck repair <span class="token keyword">table</span> dept_partition3<span class="token punctuation">;</span>
</code></pre> 
<p><em><strong>Partitions not in metastore:</strong></em></p> 
<p><strong>再次查询数据</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition2 <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span> <span class="token operator">and</span> <span class="token keyword">hour</span><span class="token operator">=</span><span class="token string">'13'</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>（2）方式二：上传数据后添加分区</strong><br> <strong>上传数据</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> dfs <span class="token operator">-</span>mkdir <span class="token operator">-</span>p
<span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>dept_partition2<span class="token operator">/</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token number">20220401</span><span class="token operator">/</span><span class="token keyword">hour</span><span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>

hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> dfs <span class="token operator">-</span>put <span class="token operator">/</span>usr<span class="token operator">/</span>soft<span class="token operator">/</span>datas<span class="token operator">/</span>dept_20220401<span class="token punctuation">.</span>log  <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>dept_partition2<span class="token operator">/</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token number">20220401</span><span class="token operator">/</span><span class="token keyword">hour</span><span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span>


hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">load</span> <span class="token keyword">data</span> inpath <span class="token string">'/user/hive/warehouse/mydb.db/dept_partition2/day=20220401/hour=14'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> dept_partition2 <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span><span class="token punctuation">,</span><span class="token keyword">hour</span><span class="token operator">=</span><span class="token string">'14'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>执行添加分区</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> dept_partition2 <span class="token keyword">add</span> <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span><span class="token punctuation">,</span><span class="token keyword">hour</span><span class="token operator">=</span><span class="token string">'14'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>查询数据</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition2 <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span> <span class="token operator">and</span> <span class="token keyword">hour</span><span class="token operator">=</span><span class="token string">'14'</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>（3）方式三：创建文件夹后 load 数据到分区</strong><br> <strong>创建目录</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> dfs <span class="token operator">-</span>mkdir <span class="token operator">-</span>p
<span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>mydb<span class="token punctuation">.</span>db<span class="token operator">/</span>dept_partition2<span class="token operator">/</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token number">20220401</span><span class="token operator">/</span><span class="token keyword">hour</span><span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>上传数据</strong></p> 
<pre><code class="prism language-sh">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> load data <span class="token builtin class-name">local</span> inpath 
<span class="token string">'/usr/soft/hive/datas/dept_20220401.log'</span> into table
dept_partition2 partition<span class="token punctuation">(</span>day<span class="token operator">=</span><span class="token string">'20220401'</span>,hour<span class="token operator">=</span><span class="token string">'15'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>查询数据</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_partition2 <span class="token keyword">where</span> <span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'20220401'</span> <span class="token operator">and</span> 
<span class="token keyword">hour</span><span class="token operator">=</span><span class="token string">'15'</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="__314"></a>三 动态分区</h2> 
<p><strong>1 创建表结构</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> dept_no_par1<span class="token punctuation">(</span> dname string<span class="token punctuation">,</span> loc string <span class="token punctuation">)</span> partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span>deptno <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">;</span> 
</code></pre> 
<p><strong>2 查询dept表，并将数据添加到 dept_no_par</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> dept_no_par <span class="token keyword">partition</span><span class="token punctuation">(</span>deptno<span class="token punctuation">)</span> <span class="token keyword">select</span> dname<span class="token punctuation">,</span>loc <span class="token punctuation">,</span>deptno <span class="token keyword">from</span> dept<span class="token punctuation">;</span>
</code></pre> 
<p><em><strong>使用动态分区，查询的最后一个字段，赋值给分区字段</strong></em></p> 
<p><img src="https://images2.imgbox.com/74/7b/D1iQekOy_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sh">直接报错：
设置为非严格模式（动态分区的模式，默认 strict，表示必须指定至少一个分区为静态分区，nonstrict 模式表示允许所有的分区字段都可以使用动态分区。）

hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">hive.exec.dynamic.partition.mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/53/3d/04uc3rwv_o.png" alt="在这里插入图片描述"></p> 
<p><strong>3 其他配置</strong></p> 
<p><strong>开启动态分区参数设置</strong></p> 
<p><strong>（1）开启动态分区功能（默认 true，开启）</strong></p> 
<pre><code class="prism language-sh"><span class="token assign-left variable">hive.exec.dynamic.partition</span><span class="token operator">=</span>true
</code></pre> 
<p><strong>（2）在所有执行 MR 的节点上，最大一共可以创建多少个动态分区。默认 1000</strong></p> 
<pre><code class="prism language-sh"><span class="token assign-left variable">hive.exec.max.dynamic.partitions</span><span class="token operator">=</span><span class="token number">1000</span>
</code></pre> 
<p><strong>（3）在每个执行 MR 的节点上，最大可以创建多少个动态分区。该参数需要根据实际</strong><br> <strong>的数据来设定。比如：源数据中包含了一年的数据，即 day 字段有 365 个值，那么该参数就</strong><br> <strong>需要设置成大于 365，如果使用默认值 100，则会报错。</strong></p> 
<pre><code class="prism language-sh"><span class="token assign-left variable">hive.exec.max.dynamic.partitions.pernode</span><span class="token operator">=</span><span class="token number">100</span>
</code></pre> 
<p><strong>（4）整个 MR Job 中，最大可以创建多少个 HDFS 文件。默认 100000</strong></p> 
<pre><code class="prism language-sh"><span class="token assign-left variable">hive.exec.max.created.files</span><span class="token operator">=</span><span class="token number">100000</span>
</code></pre> 
<p><strong>（5）当有空分区生成时，是否抛出异常。一般不需要设置。默认 false</strong></p> 
<pre><code class="prism language-sh"><span class="token assign-left variable">hive.error.on.empty.partition</span><span class="token operator">=</span>false
</code></pre> 
<h3><a id="_395"></a>案例实操</h3> 
<p><strong>需求：将 dept 表中的数据按照地区（loc 字段），插入到目标表 dept_partition 的相应分区中。</strong></p> 
<p><strong>（1）创建目标分区表</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> dept_partition_dy<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">,</span> name string<span class="token punctuation">)</span> 
partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span>loc <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>（2）设置动态分区</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span> <span class="token operator">=</span> nonstrict<span class="token punctuation">;</span>
hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> dept_partition_dy <span class="token keyword">partition</span><span class="token punctuation">(</span>loc<span class="token punctuation">)</span> <span class="token keyword">select</span> 
deptno<span class="token punctuation">,</span> dname<span class="token punctuation">,</span> loc <span class="token keyword">from</span> dept<span class="token punctuation">;</span>
</code></pre> 
<p><strong>（3）查看目标分区表的分区情况</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> partitions dept_partition<span class="token punctuation">;</span>
</code></pre> 
<p>lt)&gt; create table dept_partition_dy(id int, name string)<br> partitioned by (loc int) row format delimited fields terminated by ‘\t’;</p> 
<pre><code>


**（2）设置动态分区**

```sql
set hive.exec.dynamic.partition.mode = nonstrict;
hive (default)&gt; insert into table dept_partition_dy partition(loc) select 
deptno, dname, loc from dept;
</code></pre> 
<p><strong>（3）查看目标分区表的分区情况</strong></p> 
<pre><code class="prism language-sql">hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> partitions dept_partition<span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d14a3d3b98ab2d41f2b75fbb7b18d108/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Ubuntu 22.04 安装cmake3.28</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fc3304c074c35e7140b26eb001a8ab73/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计算机等级考试在线答题小程序 毕业设计-附源码 68573</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>