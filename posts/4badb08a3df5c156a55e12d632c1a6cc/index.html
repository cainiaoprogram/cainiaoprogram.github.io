<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>手势识别（一） - 项目概述与简单应用介绍 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="手势识别（一） - 项目概述与简单应用介绍" />
<meta property="og:description" content="我公司的科室开始在公众号上规划一些对外的技术文章了，包括实战项目、模型优化、端侧部署和一些深度学习任务基础知识，而我负责人体图象相关技术这一系列文章，偶尔也会出一些应用/代码解读等相关的文章。
文章在同步发布至公众号和博客，顺带做一波宣传。有兴趣的还可以扫码加入我们的群。
（文章有写的不好的地方请见谅，另外有啥错误的地方也请大家帮忙指出。）
（另外，文章引用的图片or代码如有侵权，请联系我删除。）
微信公众号：AI炼丹术 【手把手教学】手势识别（一） - 项目概述与简单应用介绍 handpose 一、项目概述 ​ 在生活中，我们可以用嘴去和别人说话、沟通；也可以用文本去作为交流的媒介。除此之外，我们也常用手势去传递信息。例如，将食指比在嘴巴处表示闭嘴/不要吵；挥挥手表示打招呼或再见；竖起大拇指表示赞赏；交警会在十字路口通过手势指挥秩序……所以手势是我们生活中人与人交流的一种重要方式。在AI快速发展的时代，我们也想让机器能够和人一样，能够理解人的手势信息，并且做出反应。
​ 所以，今天小编来教大家如何实现手势识别，即让机器看懂你的手势代表什么。
​ 手势识别类似于人体动作识别，常用的基于深度学习的方法有，基于图像序列的LSTM动作识别、基于3D卷积的视频分类以及基于关键点的动作识别。目前主流的方法应该都是基于关键点序列做的动作识别，所以本文我主要也是通过一个手指关键点识别（hand-pose）的项目来开启手势识别的教学。
二、技术简述 &amp; 项目讲解 参考项目：https://codechina.csdn.net/EricLee/dpcas
​ 这个项目是一个大佬写的各种小模块功能集成的系统。包括手部检测、跟踪、手势动作识别、人脸检测、安全帽检测、物体分类等等……有兴趣的朋友可以直接跳转过去仓库作详细了解。对代码有不理解的地方也可以通过issue请教仓库作者。
​ 本文就借这个项目里面手势部分的代码，来讲解手势识别的具体流程和思路。
1. 手部检测 ​ 首先，我们通过一个检测模型去检测到手部。这里作者再dpcas中使用的是yoloV3模型。不过我看作者EricLee的仓库中最近也发布了yolov5的检测模型，但是目前看还未替换进行dpcas中。另外，我们也可以根据自己的场景去使用不同的检测模型。
​ 检测模型训练部分可以到https://codechina.csdn.net/EricLee/yolo_v3下查看，该项目数据集采用 TV-Hand 和 COCO-Hand (COCO-Hand-Big 部分) 进行制作。TV-Hand 和 COCO-Hand数据集官网地址 http://vision.cs.stonybrook.edu/~supreeth/。这些数据集我也看过，更多是偏向自然场景的手部，所以手都会偏小。所以在很多相机前的画面上，检测的精度不是很高（具体表现在视频中可能出现连续的几帧中有检测丢失），因此我们可以尝试去采集适用场景下的数据集对模型进行重新训练或finetune。
​ 模型检测部分作者封装了一个检测模型的类对象，通过 def init 配置好模型的参数，如模型权重路径（model_path）、模型类型（model_arch）、图片大小（img_size）、置信度阈值（conf_thres）、nms阈值（nms_thres）…我们也可以尝试替换成自己的检测模型。
​ 然后通过一个预测函数，def predict(self, img_,vis)，实现对模型的推理，返回检测到的目标坐标位置。部分代码如下所示，也可以直接通过下面链接跳转到检测模型的位置。
参考代码：https://codechina.csdn.net/EricLee/dpcas/-/blob/master/components/hand_detect/yolo_v3_hand.py
class yolo_v3_hand_model(object): def __init__(self, model_path = &#39;./components/hand_detect/weights/latest_416-2021-02-19.pt&#39;, model_arch = &#39;yolov3&#39;, yolo_anchor_scale = 1., img_size=416, conf_thres=0.16, nms_thres=0.4,): print(&#34;yolo v3 hand_model loading : {}&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4badb08a3df5c156a55e12d632c1a6cc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-24T09:39:57+08:00" />
<meta property="article:modified_time" content="2022-04-24T09:39:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">手势识别（一） - 项目概述与简单应用介绍</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>我公司的科室开始在公众号上规划一些对外的技术文章了，包括实战项目、模型优化、端侧部署和一些深度学习任务基础知识，而我负责人体图象相关技术这一系列文章，偶尔也会出一些应用/代码解读等相关的文章。<br> 文章在同步发布至公众号和博客，顺带做一波宣传。有兴趣的还可以扫码加入我们的群。<br> （文章有写的不好的地方请见谅，另外有啥错误的地方也请大家帮忙指出。）<br> （另外，文章引用的图片or代码如有侵权，请联系我删除。）</p> 
 <h4><a id="AI_4"></a>微信公众号：AI炼丹术</h4> 
</blockquote> 
<h2><a id="___handpose_6"></a>【手把手教学】手势识别（一） - 项目概述与简单应用介绍 handpose</h2> 
<p><img src="https://images2.imgbox.com/0f/94/sOFL6JmH_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="_8"></a>一、项目概述</h3> 
<p>​ 在生活中，我们可以用嘴去和别人说话、沟通；也可以用文本去作为交流的媒介。除此之外，我们也常用手势去传递信息。例如，将食指比在嘴巴处表示闭嘴/不要吵；挥挥手表示打招呼或再见；竖起大拇指表示赞赏；交警会在十字路口通过手势指挥秩序……所以手势是我们生活中人与人交流的一种重要方式。在AI快速发展的时代，我们也想让机器能够和人一样，能够理解人的手势信息，并且做出反应。</p> 
<p>​ 所以，今天小编来教大家如何实现手势识别，即让机器看懂你的手势代表什么。</p> 
<p>​ 手势识别类似于人体动作识别，常用的基于深度学习的方法有，基于图像序列的LSTM动作识别、基于3D卷积的视频分类以及基于关键点的动作识别。目前主流的方法应该都是基于关键点序列做的动作识别，所以本文我主要也是通过一个手指关键点识别（hand-pose）的项目来开启手势识别的教学。</p> 
<h3><a id="___15"></a>二、技术简述 &amp; 项目讲解</h3> 
<blockquote> 
 <p>参考项目：<a href="https://codechina.csdn.net/EricLee/dpcas" rel="nofollow">https://codechina.csdn.net/EricLee/dpcas</a></p> 
</blockquote> 
<p>​ 这个项目是一个大佬写的各种小模块功能集成的系统。包括手部检测、跟踪、手势动作识别、人脸检测、安全帽检测、物体分类等等……有兴趣的朋友可以直接跳转过去仓库作详细了解。对代码有不理解的地方也可以通过issue请教仓库作者。</p> 
<p>​ 本文就借这个项目里面手势部分的代码，来讲解手势识别的具体流程和思路。</p> 
<h4><a id="1__22"></a>1. 手部检测</h4> 
<p><img src="https://images2.imgbox.com/2d/33/qYK1IjsW_o.png" alt="在这里插入图片描述"></p> 
<p>​ 首先，我们通过一个检测模型去检测到手部。这里作者再dpcas中使用的是yoloV3模型。不过我看作者EricLee的仓库中最近也发布了yolov5的检测模型，但是目前看还未替换进行dpcas中。另外，我们也可以根据自己的场景去使用不同的检测模型。</p> 
<p>​ 检测模型训练部分可以到<a href="https://codechina.csdn.net/EricLee/yolo_v3" rel="nofollow">https://codechina.csdn.net/EricLee/yolo_v3</a>下查看，该项目数据集采用 TV-Hand 和 COCO-Hand (COCO-Hand-Big 部分) 进行制作。TV-Hand 和 COCO-Hand数据集官网地址 <a href="http://vision.cs.stonybrook.edu/~supreeth/" rel="nofollow">http://vision.cs.stonybrook.edu/~supreeth/</a>。这些数据集我也看过，更多是偏向自然场景的手部，所以手都会偏小。所以在很多相机前的画面上，检测的精度不是很高（具体表现在视频中可能出现连续的几帧中有检测丢失），因此我们可以尝试去采集适用场景下的数据集对模型进行重新训练或finetune。</p> 
<p>​ 模型检测部分作者封装了一个检测模型的类对象，通过 def <strong>init</strong> 配置好模型的参数，如模型权重路径（model_path）、模型类型（model_arch）、图片大小（img_size）、置信度阈值（conf_thres）、nms阈值（nms_thres）…我们也可以尝试替换成自己的检测模型。</p> 
<p>​ 然后通过一个预测函数，def predict(self, img_,vis)，实现对模型的推理，返回检测到的目标坐标位置。部分代码如下所示，也可以直接通过下面链接跳转到检测模型的位置。</p> 
<blockquote> 
 <p>参考代码：<a href="https://codechina.csdn.net/EricLee/dpcas/-/blob/master/components/hand_detect/yolo_v3_hand.py" rel="nofollow">https://codechina.csdn.net/EricLee/dpcas/-/blob/master/components/hand_detect/yolo_v3_hand.py</a></p> 
</blockquote> 
<pre><code class="prism language-Python">class yolo_v3_hand_model(object):
    def __init__(self,
        model_path = './components/hand_detect/weights/latest_416-2021-02-19.pt',
        model_arch = 'yolov3',
        yolo_anchor_scale = 1.,
        img_size=416,
        conf_thres=0.16,
        nms_thres=0.4,):
        print("yolo v3 hand_model loading :  {}".format(model_path))
        self.use_cuda = torch.cuda.is_available()
        self.device = torch.device("cuda:0" if self.use_cuda else "cpu")
        self.img_size = img_size
        self.classes = ["Hand"]
        self.num_classes = len(self.classes)
        self.conf_thres = conf_thres
        self.nms_thres = nms_thres
        #-----------------------------------------------------------------------
        weights = model_path
        if "tiny" in model_arch:
            a_scalse = 416./img_size*yolo_anchor_scale
            anchors=[(10, 14), (23, 27), (37, 58), (81, 82), (135, 169), (344, 319)]
            anchors_new = [ (int(anchors[j][0]/a_scalse),int(anchors[j][1]/a_scalse)) for j in range(len(anchors)) ]

            model = Yolov3Tiny(self.num_classes,anchors = anchors_new)
        else:
            a_scalse = 416./img_size
            anchors=[(10,13), (16,30), (33,23), (30,61), (62,45), (59,119), (116,90), (156,198), (373,326)]
            anchors_new = [ (int(anchors[j][0]/a_scalse),int(anchors[j][1]/a_scalse)) for j in range(len(anchors)) ]
            model = Yolov3(self.num_classes,anchors = anchors_new)
        #-----------------------------------------------------------------------

        self.model = model
        # show_model_param(self.model)# 显示模型参数

        # print('num_classes : ',self.num_classes)

        self.device = select_device() # 运行硬件选择
        self.use_cuda = torch.cuda.is_available()
        # Load weights
        if os.access(weights,os.F_OK):# 判断模型文件是否存在
            self.model.load_state_dict(torch.load(weights, map_location=lambda storage, loc: storage)['model'])
        else:
            print('------- &gt;&gt;&gt; error : model not exists')
            return False
        #
        self.model.eval()#模型设置为 eval
        acc_model('',self.model)
        self.model = self.model.to(self.device)

    def predict(self, img_,vis):
        with torch.no_grad():
            t = time.time()
            img = process_data(img_, self.img_size)
            t1 = time.time()
            img = torch.from_numpy(img).unsqueeze(0).to(self.device)

            pred, _ = self.model(img)#图片检测

            t2 = time.time()
            detections = non_max_suppression(pred, self.conf_thres, self.nms_thres)[0] # nms
            t3 = time.time()
            # print("t3 time:", t3)

            if (detections is None) or len(detections) == 0:
                return []
            # Rescale boxes from 416 to true image size
            detections[:, :4] = scale_coords(self.img_size, detections[:, :4], img_.shape).round()
            # 绘制检测结果 ：detect reslut
            dets_for_landmarks = []
            colors = [(v // 32 * 64 + 64, (v // 8) % 4 * 64, v % 8 * 32) for v in range(1, 10 + 1)][::-1]

            output_dict_ = []
            for *xyxy, conf, cls_conf, cls in detections:
                label = '%s %.2f' % (self.classes[0], conf)
                x1,y1,x2,y2 = xyxy
                output_dict_.append((float(x1),float(y1),float(x2),float(y2),float(conf.item())))
                if vis:
                    plot_one_box(xyxy, img_, label=label, color=(0,175,255), line_thickness = 2)
            return output_dict_

</code></pre> 
<h4><a id="2__118"></a>2. 手部关键点提取</h4> 
<p><img src="https://images2.imgbox.com/17/18/5gSl87Fw_o.png" alt="在这里插入图片描述"><br> ​ 手部关键点检测模型作者提供了很多不同的backbone，然后输出为21个手指关键点坐标（一个坐标两个数值（x，y）），等于模型输出42维的向量。</p> 
<p>​ hand-pose的数据集为：&lt;&lt;Large-scale Multiview 3D Hand Pose Dataset&gt;&gt;数据集，其官网地址 <a href="http://www.rovit.ua.es/dataset/mhpdataset/" rel="nofollow">http://www.rovit.ua.es/dataset/mhpdataset/</a>；作者也提供了自己处理后的数据集下载地址：<a href="https://pan.baidu.com/s/1KY7lAFXBTfrFHlApxTY8NA" rel="nofollow">https://pan.baidu.com/s/1KY7lAFXBTfrFHlApxTY8NA</a>(百度网盘 Password: ara8 )。相关细节和模型训练也可以通过仓库<a href="https://codechina.csdn.net/EricLee/handpose_x" rel="nofollow">https://codechina.csdn.net/EricLee/handpose_x</a>进行复现。</p> 
<p>​ 和手部检测一样，模型检测部分作者封装了一个检测模型的类对象，通过 def <strong>init</strong> 配置好模型的参数，如模型权重路径（model_path）、模型类型（model_arch）、图片大小（img_size）、手部关键点数量（num_classes），手部关键点的数量实际上模型输出的维度，这里指21个关键点，42个数值。</p> 
<p>​ 然后通过一个预测函数，def predict(self, img, vis)，实现对模型的推理，返回21个关键点的坐标信息。部分代码如下所示，也可以直接通过下面链接跳转到检测模型的位置。</p> 
<blockquote> 
 <p>参考代码：<a href="https://codechina.csdn.net/EricLee/dpcas/-/blob/master/components/hand_keypoints/handpose_x.py" rel="nofollow">https://codechina.csdn.net/EricLee/dpcas/-/blob/master/components/hand_keypoints/handpose_x.py</a></p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">handpose_x_model</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
        model_path <span class="token operator">=</span> <span class="token string">'./components/hand_keypoints/weights/ReXNetV1-size-256-wingloss102-0.1063.pth'</span><span class="token punctuation">,</span>
        img_size<span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">,</span>
        num_classes <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">,</span><span class="token comment"># 手部关键点个数 * 2 ： 21*2</span>
        model_arch <span class="token operator">=</span> <span class="token string">"rexnetv1"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># print("handpose_x loading : ",model_path)</span>
        self<span class="token punctuation">.</span>use_cuda <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_cuda <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span> <span class="token comment"># 可选的设备类型及序号</span>
        self<span class="token punctuation">.</span>img_size <span class="token operator">=</span> img_size
        <span class="token comment">#-----------------------------------------------------------------------</span>

        <span class="token keyword">if</span> model_arch <span class="token operator">==</span> <span class="token string">'resnet_50'</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> resnet50<span class="token punctuation">(</span>num_classes <span class="token operator">=</span> num_classes<span class="token punctuation">,</span>img_size <span class="token operator">=</span> self<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">'resnet_18'</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> resnet18<span class="token punctuation">(</span>num_classes <span class="token operator">=</span> num_classes<span class="token punctuation">,</span>img_size <span class="token operator">=</span> self<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">'resnet_34'</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> resnet34<span class="token punctuation">(</span>num_classes <span class="token operator">=</span> num_classes<span class="token punctuation">,</span>img_size <span class="token operator">=</span> self<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">'resnet_101'</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> resnet101<span class="token punctuation">(</span>num_classes <span class="token operator">=</span> num_classes<span class="token punctuation">,</span>img_size <span class="token operator">=</span> self<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">"squeezenet1_0"</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> squeezenet1_0<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">"squeezenet1_1"</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> squeezenet1_1<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">"shufflenetv2"</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> ShuffleNetV2<span class="token punctuation">(</span>ratio<span class="token operator">=</span><span class="token number">1.</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">"shufflenet_v2_x1_5"</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> shufflenet_v2_x1_5<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">"shufflenet_v2_x1_0"</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> shufflenet_v2_x1_0<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">"shufflenet_v2_x2_0"</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> shufflenet_v2_x2_0<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">"shufflenet"</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> ShuffleNet<span class="token punctuation">(</span>num_blocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">"mobilenetv2"</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> MobileNetV2<span class="token punctuation">(</span>num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> model_arch <span class="token operator">==</span> <span class="token string">"rexnetv1"</span><span class="token punctuation">:</span>
            model_ <span class="token operator">=</span> ReXNetV1<span class="token punctuation">(</span>num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">" no support the model"</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------------------------</span>
        model_ <span class="token operator">=</span> model_<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        model_<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 设置为前向推断模式</span>

        <span class="token comment"># 加载测试模型</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>access<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span>os<span class="token punctuation">.</span>F_OK<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment"># checkpoint</span>
            chkpt <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> map_location<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
            model_<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>chkpt<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'handpose_x model loading : {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>model_handpose <span class="token operator">=</span> model_

    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">,</span> vis <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

            <span class="token keyword">if</span> <span class="token keyword">not</span><span class="token punctuation">(</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_size<span class="token punctuation">,</span>self<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation <span class="token operator">=</span> cv2<span class="token punctuation">.</span>INTER_CUBIC<span class="token punctuation">)</span>

            img_ <span class="token operator">=</span> img<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
            img_ <span class="token operator">=</span> <span class="token punctuation">(</span>img_<span class="token operator">-</span><span class="token number">128.</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">256.</span>

            img_ <span class="token operator">=</span> img_<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            img_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img_<span class="token punctuation">)</span>
            img_ <span class="token operator">=</span> img_<span class="token punctuation">.</span>unsqueeze_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_cuda<span class="token punctuation">:</span>
                img_ <span class="token operator">=</span> img_<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># (bs, 3, h, w)</span>

            pre_ <span class="token operator">=</span> self<span class="token punctuation">.</span>model_handpose<span class="token punctuation">(</span>img_<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            output <span class="token operator">=</span> pre_<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            output <span class="token operator">=</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>output<span class="token punctuation">)</span>

            <span class="token keyword">return</span> output

</code></pre> 
<h4><a id="3__208"></a>3. 手部跟踪</h4> 
<p>​ 这里作者跟踪的代码采用最简单的iou进行跟踪，即使用一个字典记录手的id，通过判断前一帧的手位置跟当前帧的位置的iou来更新手ID的位置信息。这里存在的问题是，如果有多只手重合或手移动过快或目标检测中间帧出现偏差/遗漏，就会导致跟踪出现id-switch的问题。</p> 
<blockquote> 
 <p>参考代码：<a href="https://codechina.csdn.net/EricLee/dpcas/-/blob/master/lib/hand_lib/cores/tracking_utils.py" rel="nofollow">https://codechina.csdn.net/EricLee/dpcas/-/blob/master/lib/hand_lib/cores/tracking_utils.py</a></p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tracking_bbox</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>hand_dict<span class="token punctuation">,</span>index<span class="token punctuation">,</span>iou_thr <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    track_index <span class="token operator">=</span> index
    reg_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    Flag_ <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">if</span> hand_dict <span class="token keyword">else</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> Flag_ <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
        <span class="token comment"># print("-------------------&gt;&gt;. False")</span>
        <span class="token keyword">for</span> bbox <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            x_min<span class="token punctuation">,</span>y_min<span class="token punctuation">,</span>x_max<span class="token punctuation">,</span>y_max<span class="token punctuation">,</span>score <span class="token operator">=</span> bbox
            reg_dict<span class="token punctuation">[</span>track_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x_min<span class="token punctuation">,</span>y_min<span class="token punctuation">,</span>x_max<span class="token punctuation">,</span>y_max<span class="token punctuation">,</span>score<span class="token punctuation">,</span><span class="token number">0.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
            track_index <span class="token operator">+=</span> <span class="token number">1</span>

            <span class="token keyword">if</span> track_index <span class="token operator">&gt;=</span> <span class="token number">65535</span><span class="token punctuation">:</span>
                track_index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># print("-------------------&gt;&gt;. True ")</span>
        <span class="token keyword">for</span> bbox <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            xa0<span class="token punctuation">,</span>ya0<span class="token punctuation">,</span>xa1<span class="token punctuation">,</span>ya1<span class="token punctuation">,</span>score <span class="token operator">=</span> bbox
            is_track <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">for</span> k_ <span class="token keyword">in</span> hand_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                xb0<span class="token punctuation">,</span>yb0<span class="token punctuation">,</span>xb1<span class="token punctuation">,</span>yb1<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>cnt_<span class="token punctuation">,</span>bbox_stanbel_cnt <span class="token operator">=</span> hand_dict<span class="token punctuation">[</span>k_<span class="token punctuation">]</span>

                iou_ <span class="token operator">=</span> compute_iou_tk<span class="token punctuation">(</span><span class="token punctuation">(</span>ya0<span class="token punctuation">,</span>xa0<span class="token punctuation">,</span>ya1<span class="token punctuation">,</span>xa1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>yb0<span class="token punctuation">,</span>xb0<span class="token punctuation">,</span>yb1<span class="token punctuation">,</span>xb1<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment"># print((ya0,xa0,ya1,xa1),(yb0,xb0,yb1,xb1))</span>
                <span class="token comment"># print("iou : ",iou_)</span>
                <span class="token keyword">if</span> iou_ <span class="token operator">&gt;</span> iou_thr<span class="token punctuation">:</span> <span class="token comment"># 跟踪成功目标</span>
                    UI_CNT <span class="token operator">=</span> <span class="token number">1</span>
                    <span class="token keyword">if</span> iou_ <span class="token operator">&gt;</span> <span class="token number">0.888</span><span class="token punctuation">:</span>
                        UI_CNT <span class="token operator">=</span> bbox_stanbel_cnt <span class="token operator">+</span> <span class="token number">1</span>
                    reg_dict<span class="token punctuation">[</span>k_<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>xa0<span class="token punctuation">,</span>ya0<span class="token punctuation">,</span>xa1<span class="token punctuation">,</span>ya1<span class="token punctuation">,</span>score<span class="token punctuation">,</span>iou_<span class="token punctuation">,</span>cnt_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>UI_CNT<span class="token punctuation">)</span>
                    is_track <span class="token operator">=</span> <span class="token boolean">True</span>
                    <span class="token comment"># print("is_track : " ,cnt_ + 1)</span>
            <span class="token keyword">if</span> is_track <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span> <span class="token comment"># 新目标</span>
                reg_dict<span class="token punctuation">[</span>track_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>xa0<span class="token punctuation">,</span>ya0<span class="token punctuation">,</span>xa1<span class="token punctuation">,</span>ya1<span class="token punctuation">,</span>score<span class="token punctuation">,</span><span class="token number">0.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
                track_index <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">if</span> track_index <span class="token operator">&gt;=</span><span class="token number">65535</span><span class="token punctuation">:</span> <span class="token comment">#索引越界归零</span>
                    track_index <span class="token operator">=</span> <span class="token number">0</span>

                <span class="token keyword">if</span> track_index<span class="token operator">&gt;=</span><span class="token number">100</span><span class="token punctuation">:</span>
                    track_index <span class="token operator">=</span> <span class="token number">0</span>

    hand_dict <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>reg_dict<span class="token punctuation">)</span>

    <span class="token comment"># print("a:",hand_dict)</span>

    <span class="token keyword">return</span> hand_dict<span class="token punctuation">,</span>track_index

</code></pre> 
<h3><a id="_266"></a>三、代码实战</h3> 
<p>​ 下面代码是之前作者一开始刚实现手势识别的inference代码，小编去看了下，现在作者更新了整个工具组件后，这部分单独的推理应该是删去了。</p> 
<p>​ 简单来说就是，结合了上面第二节所讲到的手部检测、关键点检测、手部跟踪代码后实现的一个整体的功能。由于作者更新过仓库了，所以部分代码的位置也变换了。我这边就不把之前的代码全部罗列出来了，应该都是可以通过函数名找到对应位置，然后替换实现单独的手势关键点检测及跟踪的。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">handpose_x_process</span><span class="token punctuation">(</span>info_dict<span class="token punctuation">,</span>config<span class="token punctuation">,</span> is_videos<span class="token punctuation">,</span> test_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 模型初始化</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"load model component  ..."</span><span class="token punctuation">)</span>
    <span class="token comment"># yolo v3 手部检测模型初始化</span>
    hand_detect_model <span class="token operator">=</span> yolo_v3_hand_model<span class="token punctuation">(</span>conf_thres<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"detect_conf_thres"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nms_thres<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"detect_nms_thres"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        model_arch <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">"detect_model_arch"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>model_path <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">"detect_model_path"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># handpose_x 21 关键点回归模型初始化</span>
    handpose_model <span class="token operator">=</span> handpose_x_model<span class="token punctuation">(</span>model_arch <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">"handpose_x_model_arch"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>model_path <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">"handpose_x_model_path"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#</span>
    gesture_model <span class="token operator">=</span> resnet18<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 目前缺省</span>

    gesture_model <span class="token operator">=</span> gesture_model<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    gesture_model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"gesture_model_path"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    gesture_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#</span>
    object_recognize_model <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># 识别分类模型，目前缺省</span>

    <span class="token comment">#</span>
    img_reco_crop <span class="token operator">=</span> <span class="token boolean">None</span>


    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"start handpose process ~"</span><span class="token punctuation">)</span>

    gesture_lines_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment"># 点击使能时的轨迹点</span>

    hands_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment"># 手的信息</span>
    hands_click_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment">#手的按键信息计数</span>
    track_index <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment"># 跟踪的全局索引</span>
    <span class="token keyword">if</span> is_videos<span class="token punctuation">:</span>
        cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"camera_id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 开启摄像机</span>
        <span class="token comment"># cap.set(cv2.CAP_PROP_EXPOSURE, -8) # 设置相机曝光，（注意：不是所有相机有效）</span>

        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            ret<span class="token punctuation">,</span> img <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 读取相机图像</span>
            <span class="token keyword">if</span> ret<span class="token punctuation">:</span><span class="token comment"># 读取相机图像成功</span>
                <span class="token comment"># img = cv2.flip(img,-1)</span>
                algo_img <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                st_ <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">#------</span>
                hand_bbox <span class="token operator">=</span>hand_detect_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>img<span class="token punctuation">,</span>vis <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 检测手，获取手的边界框</span>

                hands_dict<span class="token punctuation">,</span>track_index <span class="token operator">=</span> hand_tracking<span class="token punctuation">(</span>data <span class="token operator">=</span> hand_bbox<span class="token punctuation">,</span>hands_dict <span class="token operator">=</span> hands_dict<span class="token punctuation">,</span>track_index <span class="token operator">=</span> track_index<span class="token punctuation">)</span> <span class="token comment"># 手跟踪，目前通过IOU方式进行目标跟踪</span>
                <span class="token comment"># 检测每个手的关键点及相关信息</span>
                handpose_list <span class="token operator">=</span> handpose_track_keypoints21_pipeline<span class="token punctuation">(</span>img<span class="token punctuation">,</span>hands_dict <span class="token operator">=</span> hands_dict<span class="token punctuation">,</span>hands_click_dict <span class="token operator">=</span> hands_click_dict<span class="token punctuation">,</span>track_index <span class="token operator">=</span> track_index<span class="token punctuation">,</span>algo_img <span class="token operator">=</span> algo_img<span class="token punctuation">,</span>
                    handpose_model <span class="token operator">=</span> handpose_model<span class="token punctuation">,</span>gesture_model <span class="token operator">=</span> gesture_model<span class="token punctuation">,</span>
                    icon <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>vis <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
                et_ <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
                fps_ <span class="token operator">=</span> <span class="token number">1.</span><span class="token operator">/</span><span class="token punctuation">(</span>et_<span class="token operator">-</span>st_<span class="token operator">+</span><span class="token number">1e-8</span><span class="token punctuation">)</span>
                <span class="token comment">#------------------------------------------ 跟踪手的 信息维护</span>
                <span class="token comment">#------------------ 获取跟踪到的手ID</span>
                id_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>handpose_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    _<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>dict_ <span class="token operator">=</span> handpose_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    id_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dict_<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token comment"># print(id_list)</span>
                <span class="token comment">#----------------- 获取需要删除的手ID</span>
                id_del_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> k_ <span class="token keyword">in</span> gesture_lines_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> k_ <span class="token keyword">not</span> <span class="token keyword">in</span> id_list<span class="token punctuation">:</span><span class="token comment">#去除过往已经跟踪失败的目标手的相关轨迹</span>
                        id_del_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>k_<span class="token punctuation">)</span>
                <span class="token comment">#----------------- 删除无法跟踪到的手的相关信息</span>
                <span class="token keyword">for</span> k_ <span class="token keyword">in</span> id_del_list<span class="token punctuation">:</span>
                    <span class="token keyword">del</span> gesture_lines_dict<span class="token punctuation">[</span>k_<span class="token punctuation">]</span>
                    <span class="token keyword">del</span> hands_click_dict<span class="token punctuation">[</span>k_<span class="token punctuation">]</span>

                <span class="token comment">#----------------- 更新检测到手的轨迹信息,及手点击使能时的上升沿和下降沿信号</span>
                double_en_pts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>handpose_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    _<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>dict_ <span class="token operator">=</span> handpose_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    id_ <span class="token operator">=</span> dict_<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span>
                    <span class="token keyword">if</span> dict_<span class="token punctuation">[</span><span class="token string">"click"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                        <span class="token keyword">if</span>  id_ <span class="token keyword">not</span> <span class="token keyword">in</span> gesture_lines_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"pts"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"line_color"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"click"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
                        <span class="token comment">#判断是否上升沿</span>
                        <span class="token keyword">if</span> gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"click"</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                            <span class="token keyword">if</span> gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"click"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span><span class="token comment">#上升沿计数器</span>
                                info_dict<span class="token punctuation">[</span><span class="token string">"click_up_cnt"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
                        <span class="token comment">#获得点击状态</span>
                        gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"click"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
                        <span class="token comment">#---获得坐标</span>
                        gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"pts"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>dict_<span class="token punctuation">[</span><span class="token string">"choose_pt"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                        double_en_pts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dict_<span class="token punctuation">[</span><span class="token string">"choose_pt"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token keyword">if</span>  id_ <span class="token keyword">not</span> <span class="token keyword">in</span> gesture_lines_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"pts"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"line_color"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"click"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
                        <span class="token keyword">elif</span>  id_ <span class="token keyword">in</span> gesture_lines_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"pts"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment"># 清除轨迹</span>
                            <span class="token comment">#判断是否上升沿</span>
                            <span class="token keyword">if</span> gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"click"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span><span class="token comment">#下降沿计数器</span>
                                info_dict<span class="token punctuation">[</span><span class="token string">"click_dw_cnt"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
                            <span class="token comment"># 更新点击状态</span>
                            gesture_lines_dict<span class="token punctuation">[</span>id_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"click"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>

                <span class="token comment">#绘制手click 状态时的大拇指和食指中心坐标点轨迹</span>
                draw_click_lines<span class="token punctuation">(</span>img<span class="token punctuation">,</span>gesture_lines_dict<span class="token punctuation">,</span>vis <span class="token operator">=</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"vis_gesture_lines"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment"># 判断各手的click状态是否稳定，且满足设定阈值</span>
                flag_click_stable <span class="token operator">=</span> judge_click_stabel<span class="token punctuation">(</span>img<span class="token punctuation">,</span>handpose_list<span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"charge_cycle_step"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'HandNum:[{}]'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>hand_bbox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>FONT_HERSHEY_COMPLEX<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
                cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'HandNum:[{}]'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>hand_bbox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>FONT_HERSHEY_COMPLEX<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                cv2<span class="token punctuation">.</span>namedWindow<span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
                cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">,</span>img<span class="token punctuation">)</span>
                <span class="token comment"># if cv2.waitKey(1) == 27:</span>
                <span class="token comment">#     info_dict["break"] = True</span>
                <span class="token comment">#     break</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>

        cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> img_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>test_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>img_name<span class="token punctuation">)</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>test_path<span class="token punctuation">,</span>img_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            algo_img <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            hand_bbox <span class="token operator">=</span> hand_detect_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>img<span class="token punctuation">,</span> vis<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 检测手，获取手的边界框</span>

            hands_dict<span class="token punctuation">,</span> track_index <span class="token operator">=</span> hand_tracking<span class="token punctuation">(</span>data<span class="token operator">=</span>hand_bbox<span class="token punctuation">,</span> hands_dict<span class="token operator">=</span>hands_dict<span class="token punctuation">,</span>
                                                    track_index<span class="token operator">=</span>track_index<span class="token punctuation">)</span>  <span class="token comment"># 手跟踪，目前通过IOU方式进行目标跟踪</span>
            <span class="token comment"># 检测每个手的关键点及相关信息</span>
            handpose_list <span class="token operator">=</span> handpose_track_keypoints21_pipeline<span class="token punctuation">(</span>img<span class="token punctuation">,</span> hands_dict<span class="token operator">=</span>hands_dict<span class="token punctuation">,</span>
                                                                hands_click_dict<span class="token operator">=</span>hands_click_dict<span class="token punctuation">,</span>
                                                                track_index<span class="token operator">=</span>track_index<span class="token punctuation">,</span> algo_img<span class="token operator">=</span>algo_img<span class="token punctuation">,</span>
                                                                handpose_model<span class="token operator">=</span>handpose_model<span class="token punctuation">,</span>
                                                                gesture_model<span class="token operator">=</span>gesture_model<span class="token punctuation">,</span>
                                                                icon<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> vis<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>namedWindow<span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

            et_ <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_417"></a>四、效果展示及总结</h3> 
<p>​ 通过上面的代码讲解，我们可以简单实现手部的检测、关键点检测、跟踪……这些简单的功能了。</p> 
<p>​ 然后具体到手势识别部分，作者是提供了9种静态动作（fist、five、gun、love、one、six、three、thumbup、yeah），我看了一下好像没有加在整体的代码里面，所以这部分功能应该是缺失的，只有一个点击检测（click）。</p> 
<p>​ 作者仓库提供的静态动作识别是通过手指关键点的角度信息制定相应的规则进行动作识别的。我这边根据作者的建议（注：这种静态手势识别的方法具有局限性，有条件还是通过模型训练的方法进行静态手势识别。），利用作者提供的数据集（静态手势数据集的限制，数据集过少），自己利用一个简单的分类网络进行训练，成功实现了9种动作的分类，并加在了整体的代码里面。由于篇幅会拉得比较长，本文就想讲解到这里，有兴趣的小伙伴可以先自己实现前面这些简单的功能。</p> 
<p>​ 具体我是如何通过少量数据集实现一个鲁棒性比较强的静态动作分类网络、如何提高跟踪的准确性（降低id-switch）、如何实现动态动作的识别，我将在后续的文章逐步进行讲解。<br> <img src="https://images2.imgbox.com/b7/aa/wHIO8bGk_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a8/51/yGA4EEPn_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="_430"></a>五、参考</h4> 
<p>EricLee：<a href="https://codechina.csdn.net/EricLee" rel="nofollow">https://codechina.csdn.net/EricLee</a> （本文主要借鉴这位大佬的开源代码。）</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/049a5eae9c970565271fa38f6261d411/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">整理学习之深度可分离卷积</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e9e20dc239e68683a41a29f9713b690f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[深度学习 - 发现有趣项目] 动漫图生成手绘草图 Anime2Sketch</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>