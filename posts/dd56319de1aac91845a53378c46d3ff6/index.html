<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>linux 应用层gpio中断_linux 应用层使用gpio - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="linux 应用层gpio中断_linux 应用层使用gpio" />
<meta property="og:description" content="/**
* @author emlsyx
* @email yangx_1118@163.com
* @create date 2020-02-19 19:11:53
* @modify date 2020-02-19 19:11:53
* @desc [description]*/#include#include#include#include#include#include
#define err_out(fmt, ...) \
do\
{ \
printf(fmt, ##__VA_ARGS__); \
printf(&#34; \&#34;%s()\&#34; %d error\n&#34;, __FILE__, __FUNCTION__, __LINE__); \
}while (0)#define open_gpio_file(path, flag, fd) \
do\
{ \
fd=open(path, flag); \if (fd &lt; 0) \
{ \
err_out(&#34;\&#34;%s\&#34; open failed \n&#34;, path); \return (-1); \
} \
}while (0);/**
* @brief : gpio 导出" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dd56319de1aac91845a53378c46d3ff6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-26T11:12:54+08:00" />
<meta property="article:modified_time" content="2021-02-26T11:12:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">linux 应用层gpio中断_linux 应用层使用gpio</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>/**</p> 
 <p>* @author emlsyx</p> 
 <p>* @email yangx_1118@163.com</p> 
 <p>* @create date 2020-02-19 19:11:53</p> 
 <p>* @modify date 2020-02-19 19:11:53</p> 
 <p>* @desc [description]*/#include#include#include#include#include#include</p> 
 <p>#define err_out(fmt, ...) \</p> 
 <p>do\</p> 
 <p>{ \</p> 
 <p>printf(fmt, ##__VA_ARGS__); \</p> 
 <p>printf(" \"%s()\" %d error\n", __FILE__, __FUNCTION__, __LINE__); \</p> 
 <p>}while (0)#define open_gpio_file(path, flag, fd) \</p> 
 <p>do\</p> 
 <p>{ \</p> 
 <p>fd=open(path, flag); \if (fd &lt; 0) \</p> 
 <p>{ \</p> 
 <p>err_out("\"%s\" open failed \n", path); \return (-1); \</p> 
 <p>} \</p> 
 <p>}while (0);/**</p> 
 <p>* @brief : gpio 导出</p> 
 <p>* @param : pin</p> 
 <p>* @retval: 0 成功; -1失败*/</p> 
 <p>static int gpio_export(const intpin)</p> 
 <p>{intfd, len;char buffer[64];char path[64];</p> 
 <p>sprintf(&amp;path[0], "/sys/class/gpio/gpio%d", pin);/*文件不存在时，导出gpio*/</p> 
 <p>if (access(path, F_OK) != 0)</p> 
 <p>{<!-- --></p> 
 <p>memset(path,0, 64);</p> 
 <p>sprintf(&amp;path[0], "/sys/class/gpio/export");</p> 
 <p>open_gpio_file(path, O_WRONLY, fd);</p> 
 <p>len= snprintf(buffer, sizeof(buffer), "%d", pin);if (write(fd, buffer, len) &lt; 0)</p> 
 <p>{<!-- --></p> 
 <p>err_out("write failed to export gpio!\n");return -1;</p> 
 <p>}</p> 
 <p>close(fd);</p> 
 <p>}return 0;</p> 
 <p>}/**</p> 
 <p>* @brief : gpio 卸载</p> 
 <p>* @param : pin</p> 
 <p>* @retval: 0 成功; -1失败*/</p> 
 <p>static int gpio_unexport(const intpin)</p> 
 <p>{intfd, len;char buffer[64];char path[64];</p> 
 <p>sprintf(&amp;path[0], "/sys/class/gpio/gpio%d", pin);/*文件存在时，卸载gpio*/</p> 
 <p>if (access(path, F_OK) == 0)</p> 
 <p>{<!-- --></p> 
 <p>memset(path,0, 64);</p> 
 <p>sprintf(&amp;path[0], "/sys/class/gpio/unexport");</p> 
 <p>open_gpio_file(path, O_WRONLY, fd);</p> 
 <p>len= snprintf(buffer, sizeof(buffer), "%d", pin);if (write(fd, buffer, len) &lt; 0)</p> 
 <p>{<!-- --></p> 
 <p>err_out("write failed to unexport gpio!\n");return -1;</p> 
 <p>}</p> 
 <p>close(fd);</p> 
 <p>}return 0;</p> 
 <p>}/**</p> 
 <p>* @brief : gpio 方向控制</p> 
 <p>* @param : dir 方向(in/out)</p> 
 <p>* @retval: 0 成功; -1失败*/</p> 
 <p>static int gpio_direction(const int pin, const char *dir)</p> 
 <p>{intfd;char path[64];int w_len = ((dir[0] == 'i') &amp;&amp; (dir[1] == 'n')) ? 2 : 3;</p> 
 <p>snprintf(path,sizeof(path), "/sys/class/gpio/gpio%d/direction", pin);</p> 
 <p>open_gpio_file(path, O_WRONLY, fd);if (write(fd, dir, w_len) &lt; 0)</p> 
 <p>{<!-- --></p> 
 <p>err_out("Failed to set direction!\n");return -1;</p> 
 <p>}</p> 
 <p>close(fd);return 0;</p> 
 <p>}/**</p> 
 <p>* @brief : gpio 写</p> 
 <p>* @param : 0 / 1</p> 
 <p>* @retval: 0 成功; -1失败*/</p> 
 <p>static int gpio_write(const int pin, const intvalue)</p> 
 <p>{intfd;char path[64];const char *val[] = {"0", "1"};</p> 
 <p>snprintf(path,sizeof(path), "/sys/class/gpio/gpio%d/value", pin);</p> 
 <p>open_gpio_file(path, O_WRONLY, fd);if (write(fd, val[value], 1) &lt; 0)</p> 
 <p>{<!-- --></p> 
 <p>err_out("Failed to write value!\n");return -1;</p> 
 <p>}</p> 
 <p>close(fd);return 0;</p> 
 <p>}/**</p> 
 <p>* @brief : gpio 读</p> 
 <p>* @param : 读取的引脚值</p> 
 <p>* @retval: 返回引脚的值 0 / 1*/</p> 
 <p>static int gpio_read(const intpin)</p> 
 <p>{intfd;char path[64];char value_str[3];</p> 
 <p>snprintf(path,sizeof(path), "/sys/class/gpio/gpio%d/value", pin);</p> 
 <p>open_gpio_file(path, O_RDONLY, fd);if (read(fd, value_str, 3) &lt; 0)</p> 
 <p>{<!-- --></p> 
 <p>err_out("Failed to read value!\n");return -1;</p> 
 <p>}</p> 
 <p>close(fd);return(atoi(value_str));</p> 
 <p>}/**</p> 
 <p>* @brief : gpio 中断控制</p> 
 <p>* @param : 0 none 表示引脚为输入，不是中断引脚</p> 
 <p>* @arg : 1 rising 表示引脚为中断输入，上升沿触发</p> 
 <p>* @arg : 2 falling 表示引脚为中断输入，下降沿触发</p> 
 <p>* @arg : 3 both 表示引脚为中断输入，边沿触发</p> 
 <p>* @retval:*/</p> 
 <p>static int gpio_edge(const int pin, intedge)</p> 
 <p>{intfd;char path[64];const char *dir_str[] = {"none", "rising", "falling", "both"};if (edge &gt; 3)</p> 
 <p>{<!-- --></p> 
 <p>err_out("Failed edge parameter error\n");return -1;</p> 
 <p>}</p> 
 <p>snprintf(path,sizeof(path), "/sys/class/gpio/gpio%d/edge", pin);</p> 
 <p>open_gpio_file(path, O_WRONLY, fd);if (write(fd, dir_str[edge], strlen(dir_str[edge])) &lt; 0)</p> 
 <p>{<!-- --></p> 
 <p>err_out("Failed to set edge!\n");return -1;</p> 
 <p>}</p> 
 <p>close(fd);return 0;</p> 
 <p>}intmain()</p> 
 <p>{char buff[10], res;intled_fd, key_fd;structpollfd fds;/*按键led指示灯*/gpio_export(55);</p> 
 <p>gpio_direction(55, "out");</p> 
 <p>gpio_write(55, 0);/*按键引脚初始化*/gpio_export(70);</p> 
 <p>gpio_direction(70, "in");</p> 
 <p>gpio_edge(70, 2);</p> 
 <p>open_gpio_file("/sys/class/gpio/gpio70/value", O_RDONLY, key_fd);/*poll 操作的文件符号*/fds.fd=key_fd;/*经测试io中断产生后，正常会发送POLLPRI 这个中断，循环中必须等待这个事件*/fds.events= POLLPRI |POLLERR;/*真实发生的事件*/fds.revents= 0;while (1)</p> 
 <p>{int ret = poll(&amp;fds, 1, -1);if (!ret)</p> 
 <p>{<!-- --></p> 
 <p>err_out("poll time out\n");</p> 
 <p>}else{if (fds.revents &amp;POLLPRI)</p> 
 <p>{<!-- --></p> 
 <p>gpio_write(55, gpio_read(55) ? 0 : 1);</p> 
 <p>res= lseek(fds.fd, 0, SEEK_SET); /*读取按键值*/</p> 
 <p>if (res == -1)</p> 
 <p>{<!-- --></p> 
 <p>printf("lseek failed!\n");return -1;</p> 
 <p>}</p> 
 <p>res= read(fds.fd, buff, sizeof(buff));if (res == -1)</p> 
 <p>{<!-- --></p> 
 <p>perror("read failed!\n");return -1;</p> 
 <p>}</p> 
 <p>printf("fds.revents %d key value %s \n", fds.revents, buff);</p> 
 <p>}</p> 
 <p>}</p> 
 <p>}return 0;</p> 
 <p>}</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/edbb58c367767b12508b9f2094193b4b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Quartz定时任务管理（动态添加、停止、恢复、删除定时任务）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fb8efbf9d14f47cdb4f2d6e57b56424c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">谷歌浏览器查看token</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>