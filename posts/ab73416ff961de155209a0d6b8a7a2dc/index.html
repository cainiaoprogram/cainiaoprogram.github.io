<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C# 基于MQTT创建客户端的可靠数据传输 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C# 基于MQTT创建客户端的可靠数据传输" />
<meta property="og:description" content="C# 基于MQTT创建客户端的可靠数据传输 引言MQTT简介C# MQTT库引用代码和描述1、 代码2、 描述 引言 MQTT是tcpip的应用层协议，这里我们简单介绍一下MQTT的基本概念，并用C# 描述客户端的订阅和发布。
MQTT简介 MQTT(Message Queuing Telemetry Transport）即 消息队列遥测传输，是ISO 标准(ISO/IEC PRF 20922)下基于发布/订阅范式的消息协议。它也是工作在 TCP/IP协议族上，是为硬件性能低下的远程设备以及网络状况糟糕的情况下而设计的发布/订阅型消息协议。
MQTT协议是轻量、简单、开放和易于实现的，这些特点使它适用范围非常广泛。在很多情况下，包括受限的环境中，如：机器与机器（M2M）通信和物联网（IoT）。其在，通过卫星链路通信传感器、偶尔拨号的医疗设备、智能家居、及一些小型化设备中已广泛使用。
通过MQTT协议，目前已经扩展出了数十个MQTT服务器端程序，可以通过PHP，JAVA，Python，C，C#等系统语言来向MQTT发送相关消息。
MQTT 服务器是发布-订阅架构的转发中心，它可以非常简单地在Internet 服务器上实现。服务器分发消息，因此是推送者，客户端可以发布消息（发送方）、订阅消息（接收方）或两者兼而有之。客户端（也称为节点）是一种智能设备，如微控制器或具有 TCP/IP 堆栈和实现 MQTT 协议的软件的计算机。
QoS（Quality of Service levels）服务质量是 MQTT 的一个重要特性。当我们使用时，连接已经在一定程度上是不是面向连接的。MQTT 在这里帮助避免信息丢失及其服务质量水平。 服务质量水平包括三个等级。
AtMostOnce ——最多一次AtLeastOnce ——至少一次ExactlyOnce ——恰好一次，这个服务质量可以确保数据准确的发送到订阅端。 C# MQTT库引用 这里我使用是VS2022，在工具中的netGet包管理器中打开“管理解决方案包“，搜索MQTTnet，找到对应的包。这里注意要选择自己合适的版本！注意要选择自己合适的版本！注意要选择自己合适的版本！重要的话说3遍。我在win10环境下使用的VS2022,验证了多次才发现4.1.2.350是合适的。如下图所示。
代码和描述 1、 代码 using System; using System.Collections.Generic; using System.Threading.Tasks; using MQTTnet; using MQTTnet.Client; using MQTTnet.Protocol; using MQTTnet.Server; namespace WriteSN { internal class Mqtt { public static byte[] Mqtt_Message_Received_Str = new byte[] { }; //构造函数 public Mqtt() { //初始化全局变量 Mqtt_Message_Received_Str = new byte[] { }; } /// &lt;summary&gt; /// 发布和订阅MQTT专用主题授权获取数据 /// &lt;/summary&gt; /// &lt;param name=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ab73416ff961de155209a0d6b8a7a2dc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-23T21:14:42+08:00" />
<meta property="article:modified_time" content="2023-12-23T21:14:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C# 基于MQTT创建客户端的可靠数据传输</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>C# 基于MQTT创建客户端的可靠数据传输</h4> 
 <ul><li><a href="#_3" rel="nofollow">引言</a></li><li><a href="#MQTT_7" rel="nofollow">MQTT简介</a></li><li><a href="#C_MQTT_20" rel="nofollow">C# MQTT库引用</a></li><li><a href="#_25" rel="nofollow">代码和描述</a></li><li><ul><li><a href="#1__27" rel="nofollow">1、 代码</a></li><li><a href="#2__136" rel="nofollow">2、 描述</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_3"></a>引言</h2> 
<p>MQTT是tcpip的应用层协议，这里我们简单介绍一下MQTT的基本概念，并用C# 描述客户端的订阅和发布。</p> 
<h2><a id="MQTT_7"></a>MQTT简介</h2> 
<ul><li> <p>MQTT(Message Queuing Telemetry Transport）即 消息队列遥测传输，是ISO 标准(ISO/IEC PRF 20922)下基于发布/订阅范式的消息协议。它也是工作在 TCP/IP协议族上，是为硬件性能低下的远程设备以及网络状况糟糕的情况下而设计的发布/订阅型消息协议。</p> </li><li> <p>MQTT协议是轻量、简单、开放和易于实现的，这些特点使它适用范围非常广泛。在很多情况下，包括受限的环境中，如：机器与机器（M2M）通信和物联网（IoT）。其在，通过卫星链路通信传感器、偶尔拨号的医疗设备、智能家居、及一些小型化设备中已广泛使用。</p> </li><li> <p>通过MQTT协议，目前已经扩展出了数十个MQTT服务器端程序，可以通过PHP，JAVA，Python，C，C#等系统语言来向MQTT发送相关消息。</p> </li><li> <p>MQTT 服务器是发布-订阅架构的转发中心，它可以非常简单地在Internet 服务器上实现。服务器分发消息，因此是推送者，客户端可以发布消息（发送方）、订阅消息（接收方）或两者兼而有之。客户端（也称为节点）是一种智能设备，如微控制器或具有 TCP/IP 堆栈和实现 MQTT 协议的软件的计算机。<br> <img src="https://images2.imgbox.com/5e/09/dbD55cyC_o.png" alt="在这里插入图片描述"></p> </li><li> <p>QoS（Quality of Service levels）服务质量是 MQTT 的一个重要特性。当我们使用时，连接已经在一定程度上是不是面向连接的。MQTT 在这里帮助避免信息丢失及其服务质量水平。 服务质量水平包括三个等级。</p> 
  <ol><li>AtMostOnce ——最多一次</li><li>AtLeastOnce ——至少一次</li><li>ExactlyOnce ——恰好一次，这个服务质量可以确保数据准确的发送到订阅端。</li></ol> </li></ul> 
<h2><a id="C_MQTT_20"></a>C# MQTT库引用</h2> 
<p>这里我使用是VS2022，在工具中的netGet包管理器中打开“管理解决方案包“，搜索MQTTnet，找到对应的包。这里注意要选择自己合适的版本！注意要选择自己合适的版本！注意要选择自己合适的版本！重要的话说3遍。我在win10环境下使用的VS2022,验证了多次才发现4.1.2.350是合适的。如下图所示。<br> <img src="https://images2.imgbox.com/08/a5/5nrQl7Uv_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_25"></a>代码和描述</h2> 
<h3><a id="1__27"></a>1、 代码</h3> 
<pre><code class="prism language-c">using System<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span> 
using System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span> 
using MQTTnet<span class="token punctuation">;</span>
using MQTTnet<span class="token punctuation">.</span>Client<span class="token punctuation">;</span> 
using MQTTnet<span class="token punctuation">.</span>Protocol<span class="token punctuation">;</span>
using MQTTnet<span class="token punctuation">.</span>Server<span class="token punctuation">;</span>

namespace WriteSN
<span class="token punctuation">{<!-- --></span>
  internal class Mqtt
  <span class="token punctuation">{<!-- --></span>
      public <span class="token keyword">static</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> Mqtt_Message_Received_Str <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  	<span class="token comment">//构造函数</span>
      public <span class="token function">Mqtt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
         <span class="token comment">//初始化全局变量</span>
          Mqtt_Message_Received_Str <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/// &lt;summary&gt;</span>
      <span class="token comment">///  发布和订阅MQTT专用主题授权获取数据</span>
      <span class="token comment">/// &lt;/summary&gt;</span>
      <span class="token comment">/// &lt;param name="Data"&gt;发布传输字符串&lt;/param&gt;</span>
      <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
      public async Task <span class="token function">MQTT_Client_Handle</span><span class="token punctuation">(</span>string Data<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
  		<span class="token comment">//服务端地址</span>
  		string broker <span class="token operator">=</span> <span class="token string">"broker.emqx.io"</span><span class="token punctuation">;</span>
  		<span class="token comment">//端口·</span>
  		<span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">8090</span><span class="token punctuation">;</span>
  		<span class="token comment">//客户端ID</span>
  		string clientId <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  		<span class="token comment">//订阅和发布的主题</span>
  		string  req_topic <span class="token operator">=</span> <span class="token string">"trace_id_req"</span><span class="token punctuation">;</span><span class="token comment">//发</span>
  		string  rsp_topic <span class="token operator">=</span> <span class="token string">"trace_id_rsp"</span><span class="token punctuation">;</span><span class="token comment">//收 </span>
  		<span class="token comment">//用户和密码</span>
  		string username <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment">//"admin";</span>
  		string password <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment">//public";</span>
  		
  		<span class="token comment">// Create a MQTT client factory 创建客户端代理</span>
  		var factory <span class="token operator">=</span> new <span class="token function">MqttFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  		
  		<span class="token comment">// Create a MQTT client instance 创建客户端实例</span>
  		var mqttClient <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">CreateMqttClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  		
          <span class="token comment">// Create MQTT client options 为连接服务器创建客户端选项</span>
          var options <span class="token operator">=</span> new <span class="token function">MqttClientOptionsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
              <span class="token punctuation">.</span><span class="token function">WithTcpServer</span><span class="token punctuation">(</span>broker<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token comment">// MQTT broker address and port</span>
              <span class="token punctuation">.</span><span class="token function">WithCredentials</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token comment">// Set username and password</span>
              <span class="token punctuation">.</span><span class="token function">WithClientId</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithWillQualityOfServiceLevel</span><span class="token punctuation">(</span>MqttQualityOfServiceLevel<span class="token punctuation">.</span>ExactlyOnce<span class="token punctuation">)</span><span class="token comment">//QOS=2</span>
              <span class="token punctuation">.</span><span class="token function">WithCleanSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Connect to MQTT broker //连接代理服务器</span>
          var connectResult <span class="token operator">=</span> await mqttClient<span class="token punctuation">.</span><span class="token function">ConnectAsync</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
          <span class="token keyword">if</span> <span class="token punctuation">(</span>connectResult<span class="token punctuation">.</span>ResultCode <span class="token operator">==</span> MqttClientConnectResultCode<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>   
              <span class="token comment">//连接成功后打印</span>
              Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"\r\nConnected to MQTT broker successfully.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// Subscribe to a topic //订阅一个要接收的主题</span>
              await mqttClient<span class="token punctuation">.</span><span class="token function">SubscribeAsync</span><span class="token punctuation">(</span>rsp_topic<span class="token punctuation">,</span> MqttQualityOfServiceLevel<span class="token punctuation">.</span>ExactlyOnce<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//QOS=2</span>
              <span class="token comment">// Callback function when a message is received //添加接收回调的消息</span>
              mqttClient<span class="token punctuation">.</span>ApplicationMessageReceivedAsync <span class="token operator">+=</span> MqttClient_ApplicationMessageReceivedAsync<span class="token punctuation">;</span>

              <span class="token comment">//=======================================================================================       </span>
              <span class="token comment">//开始发布消息        </span>
              var message <span class="token operator">=</span> new <span class="token function">MqttApplicationMessageBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">WithTopic</span><span class="token punctuation">(</span>req_topic<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">WithPayload</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">WithQualityOfServiceLevel</span><span class="token punctuation">(</span>MqttQualityOfServiceLevel<span class="token punctuation">.</span>ExactlyOnce<span class="token punctuation">)</span><span class="token comment">//QOS=2</span>
                  <span class="token punctuation">.</span><span class="token function">WithRetainFlag</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Send topic:{message.Topic}\r\nSend QoS:{message.QualityOfServiceLevel}\r\nSend RetainFlag: {message.Retain}\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//发送一个主题消息</span>
              await mqttClient<span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// Wait for 1 second //自定义等待一段时间后关闭</span>
              await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
              <span class="token comment">// Unsubscribe and disconnect//关闭接收主题</span>
              await mqttClient<span class="token punctuation">.</span><span class="token function">UnsubscribeAsync</span><span class="token punctuation">(</span>rsp_topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
              await mqttClient<span class="token punctuation">.</span><span class="token function">DisconnectAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Unsubscribe and disconnect.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span>
          <span class="token punctuation">{<!-- --></span>
              Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Failed to connect to MQTT broker: {connectResult.ResultCode}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

     <span class="token comment">//回调函数，打印和传递订阅接收到数据</span>
      private <span class="token keyword">static</span> Task <span class="token function">MqttClient_ApplicationMessageReceivedAsync</span><span class="token punctuation">(</span>MqttApplicationMessageReceivedEventArgs arg<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          Mqtt_Message_Received_Str <span class="token operator">=</span> arg<span class="token punctuation">.</span>ApplicationMessage<span class="token punctuation">.</span>Payload<span class="token punctuation">;</span>

          Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Received message:\r\n{Utils.bytesToString(Mqtt_Message_Received_Str)}\r\n[{arg.ApplicationMessage.Payload.Length}]\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Received topic:"</span> <span class="token operator">+</span> $<span class="token string">"{arg.ApplicationMessage.Topic}\t\nReceived QoS:{arg.ApplicationMessage.QualityOfServiceLevel}\r\nReceived RetainFlag: {arg.ApplicationMessage.Retain}\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="2__136"></a>2、 描述</h3> 
<ul><li> <p>小结以上代码可以理解为3部分功能，创建连接、回调接收和发布消息。且3部分中均可以设置服务质量QoS（Quality of Service levels），确保可靠性传输，当然，服务器端也必须对标QOS设置：<br> 1、创建连接</p> 
  <blockquote> 
   <p>var connectResult = await mqttClient.ConnectAsync(options);</p> 
  </blockquote> <p>2、回调接收</p> 
  <blockquote> 
   <p>mqttClient.ApplicationMessageReceivedAsync += MqttClient_ApplicationMessageReceivedAsync</p> 
  </blockquote> <p>3、发布消息</p> 
  <blockquote> 
   <p>await mqttClient.PublishAsync(message);</p> 
  </blockquote> <p>4、Qos设置<br> 参看代码备注 <mark>“//QOS=2”</mark></p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e2916b09f7094bc21b85551f6a767cf6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【5G PHY】NR参考信号功率和小区总传输功率的计算</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/347a1cfab1c51f0dc14dbbf4b9a92d22/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Element UI 框架中Loading 区域加载的使用方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>