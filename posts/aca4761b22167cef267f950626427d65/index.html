<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>jdbc通过kerberos认证连接hive - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="jdbc通过kerberos认证连接hive" />
<meta property="og:description" content="pom依赖添加hive-jdbc 根据实际情况添加依赖，主要看服务器hive版本
&lt;dependency&gt; &lt;groupId&gt;org.apache.hive&lt;/groupId&gt; &lt;artifactId&gt;hive-jdbc&lt;/artifactId&gt; &lt;version&gt;2.1.1-cdh6.3.2&lt;/version&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;artifactId&gt;*&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;exclusion&gt; &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt; &lt;artifactId&gt;log4j-slf4j-impl&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;exclusion&gt; &lt;artifactId&gt;log4j&lt;/artifactId&gt; &lt;groupId&gt;log4j&lt;/groupId&gt; &lt;/exclusion&gt; &lt;exclusion&gt; &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt; &lt;/dependency&gt; 认证文件 配置文件krb5.conf,认证文件krb5.keytab,一般由服务器生成后获取
放到resources目录下
认证方法KerberosAuth.java 指定krb5配置文件：krb5.conf，根据实际情况替换
认证文件：krb5.keytab，根据实际情况替换
认证用户：hive，根据实际情况修改
这里是通过将配置文件和认证文件拷贝到临时目录进行认证，可以根据需要指定固定目录认证
public class KerberosAuth { private static Logger log = LoggerFactory.getLogger(KerberosConnect.class); // kerberos配置文件，从服务上获取 private static String krbConfig=&#34;krb5.conf&#34;; // kerberos认证文件 private static String krbKeytab=&#34;krb5.keytab&#34;; // kerberos认证用户 private static String krbUser=&#34;hive&#34;; private static String tempDir; public static void init(){ initkerberos(); } public static void initkerberos() { log." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/aca4761b22167cef267f950626427d65/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-12T16:32:16+08:00" />
<meta property="article:modified_time" content="2023-04-12T16:32:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">jdbc通过kerberos认证连接hive</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>pom依赖添加hive-jdbc</h2> 
<p>根据实际情况添加依赖，主要看服务器hive版本</p> 
<pre><code class="language-XML">&lt;dependency&gt;
            &lt;groupId&gt;org.apache.hive&lt;/groupId&gt;
            &lt;artifactId&gt;hive-jdbc&lt;/artifactId&gt;
            &lt;version&gt;2.1.1-cdh6.3.2&lt;/version&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
                    &lt;artifactId&gt;*&lt;/artifactId&gt;
                &lt;/exclusion&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
                    &lt;artifactId&gt;log4j-slf4j-impl&lt;/artifactId&gt;
                &lt;/exclusion&gt;
                &lt;exclusion&gt;
                    &lt;artifactId&gt;log4j&lt;/artifactId&gt;
                    &lt;groupId&gt;log4j&lt;/groupId&gt;
                &lt;/exclusion&gt;
                &lt;exclusion&gt;
                    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;</code></pre> 
<h2>认证文件</h2> 
<p>配置文件krb5.conf,认证文件krb5.keytab,一般由服务器生成后获取</p> 
<p>放到resources目录下</p> 
<p> <img src="https://images2.imgbox.com/26/17/JSoqhyFg_o.png" alt="caca8ca3e2af4436a5c0bc03df8b8487.png"></p> 
<p> </p> 
<h2>认证方法KerberosAuth.java</h2> 
<p>指定krb5配置文件：krb5.conf，根据实际情况替换</p> 
<p>认证文件：krb5.keytab，根据实际情况替换</p> 
<p>认证用户：hive，根据实际情况修改</p> 
<p>这里是通过将配置文件和认证文件拷贝到临时目录进行认证，可以根据需要指定固定目录认证</p> 
<pre><code class="language-java">public class KerberosAuth {
    private static Logger log = LoggerFactory.getLogger(KerberosConnect.class);
    // kerberos配置文件，从服务上获取
    private static String krbConfig="krb5.conf";
    // kerberos认证文件
    private static String krbKeytab="krb5.keytab";
    // kerberos认证用户
    private static String krbUser="hive";

    private static String tempDir;

    public static void init(){
        initkerberos();
    }

    public static void  initkerberos() {
        log.info("Kerberos 登陆验证");
        try {
            // java临时目录，window为C:\Users\登录用户\AppData\Local\Temp\，linux为/tmp，需要根据情况添加斜杠
            String javaTempDir = System.getProperty("java.io.tmpdir");
            // 将之前的临时认证文件删除
//            deleteTempDir();
            tempDir = (javaTempDir.lastIndexOf(File.separator)==javaTempDir.length()-1?javaTempDir:javaTempDir+File.separator)+"tomcat_"+System.currentTimeMillis();
            String configPath = krbConfig.contains(File.separator) ? krbConfig : getTempPath(tempDir,krbConfig);
            String keytabPath = krbKeytab.contains(File.separator) ? krbKeytab : getTempPath(tempDir,krbKeytab);
            log.debug(configPath);
            log.debug(keytabPath);
            System.setProperty("java.security.krb5.conf", configPath);//设置krb配置文件路径,注意一定要放在Configuration前面，不然不生效
            Configuration conf = new Configuration();
            conf.set("hadoop.security.authentication", "Kerberos");//设置认证模式Kerberos
            UserGroupInformation.setConfiguration(conf);
            UserGroupInformation.loginUserFromKeytab(krbUser, keytabPath);//设置认证用户和krb认证文件路径
            log.info("Kerberos 验证成功");
        } catch (Exception e) {
            log.error("Kerberos 验证失败", e);
        }

    }
 /**
     * 根据文件名称获取文件路径临时路径（解决jar包不支持获取resource下文件问题）
     * @param tempPath 临时目录
     * @param fileName 文件名称
     * @return 文件临时路径
     */
    public static String  getTempPath(String tempPath, String fileName){
//        ClassPathResource krbConfigRes = new ClassPathResource(fileName);
//        String path = this.getClass().getClassLoader().getResource(fileName);
        InputStream in = KerberosConnect.class.getResourceAsStream("/" + fileName);
        String krbConfigFileTempPath = tempPath+File.separator+fileName;
        File krbConfigFileTemp = new File(krbConfigFileTempPath);
        File tempPathFile = new File(tempPath);
        if (!tempPathFile.exists()) {
            tempPathFile.mkdir();
        }
        try {
            MyFileUtils.copyInputStreamToFile(in,krbConfigFileTemp);
        } catch (Exception e) {
            log.error("getTempPath",e);
        }
        return krbConfigFileTemp.getPath();
    }

}</code></pre> 
<p> </p> 
<h2>HiveUtils</h2> 
<p>kerberos认证需要在获取Connection 之前</p> 
<p>而且jdb连接格式如下</p> 
<p>jdbc:hive2://10.**.**.**:10000/test_db;principal=hive/hostname@HADOOP.COM</p> 
<ul><li>说明</li></ul> 
<p>   principal：</p> 
<p>        hive/hostname：这里指定认证的hive的hostname</p> 
<p>        @HADOOP.COM:realms和krb5.conf文件里一致即可</p> 
<pre><code class="language-java">import com.gientech.schedule.config.KerberosConnect;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.sql.*;
import java.util.*;

public class HiveUtils {
    private static Logger logger = LoggerFactory.getLogger(HiveUtils.class.getName());

    private static String driverName = "org.apache.hive.jdbc.HiveDriver";
    private static String url = "jdbc:hive2://10.10.10.10:10000/test_db;principal=hive/hostname@HADOOP.COM";//端口默认10000

    /**
     * 获取Connection
     * @return conn
     * @throws SQLException
     * @throws ClassNotFoundException
     */

    public static Connection getConnection() throws SQLException {
        Connection conn = null;
        try {
            KerberosAuth.init();
            conn = DriverManager.getConnection(url);
        } catch (SQLException e) {
            logger.info("获取数据库连接失败!");
            throw e;
        }
        return conn;
    }

    // 创建数据库
    public static void createDatabase(String databaseName) throws Exception {
        String sql = "create database "+databaseName;
        logger.info("Running: " + sql);
        Connection conn = getConnection();
        Statement stmt = conn.createStatement();
        stmt.execute(sql);
        closeConnection(conn);
        closeStatement(stmt);
    }

    // 查询所有数据库
    public static void showDatabases() throws Exception {
        String sql = "show databases";
        logger.info("Running: " + sql);
        Connection conn = getConnection();
        Statement stmt = conn.createStatement();
        ResultSet rs = stmt.executeQuery(sql);
        while (rs.next()) {
            logger.info(rs.getString(1));
        }
        closeConnection(rs,stmt,conn);
    }

    /**
     * 创建表（分割符为“，”）
     * 如create table tableName(name string,sex string) row format delimited fields terminated by ','
     * @param sql
     * @throws Exception
     */
    public static void createTable(String sql) throws Exception {
        logger.info("Running: " + sql);
        Connection conn = getConnection();
        Statement stmt = conn.createStatement();
        stmt.execute(sql);
        closeConnection(conn);
        closeStatement(stmt);
    }

    // 查询所有表
    public static void showTables() throws Exception {
        String sql = "show tables";
        logger.info("Running: " + sql);
        getConnection();
        Connection conn = getConnection();
        Statement stmt = conn.createStatement();
        ResultSet rs = stmt.executeQuery(sql);
        while (rs.next()) {
            logger.info(rs.getString(1));
        }
        closeConnection(rs,stmt,conn);
    }

    // 查看表结构
    public static void descTable(String tableName) throws Exception {
        String sql = "desc formatted "+tableName;
        logger.info("Running: " + sql);
        Connection conn = getConnection();
        Statement stmt = conn.createStatement();
        ResultSet rs = stmt.executeQuery(sql);
        while (rs.next()) {
            logger.info(rs.getString(1) + "\t" + rs.getString(2));
        }
        closeConnection(rs,stmt,conn);
    }

    // 加载数据(请确保文件权限)
    public static void loadData(String filePath,String tableName) throws Exception {
        String sql = "load data inpath '" + filePath + "' into table tableName";
        logger.info("Running: " + sql);
        Connection conn = getConnection();
        Statement stmt = conn.createStatement();
        stmt.execute(sql);
        closeConnection(conn);
        closeStatement(stmt);
    }

    // 查询数据
    public static void selectData(String sql) throws Exception {
        logger.info("Running: " + sql);
        Connection conn = getConnection();
        Statement stmt = conn.createStatement();
        ResultSet rs = stmt.executeQuery(sql);
        rs = stmt.executeQuery(sql);
        while (rs.next()) {
            logger.info(rs.getString(1));
        }
        closeConnection(rs,stmt,conn);
    }

    // 删除数据库
    public static void dropDatabase(String databaseName) throws Exception {
        String sql = "drop database if exists "+databaseName;
        logger.info("Running: " + sql);
        Connection conn = getConnection();
        Statement stmt = conn.createStatement();
        stmt.execute(sql);
        closeConnection(conn);
        closeStatement(stmt);
    }

    // 删除数据库表
    public static void deopTable(String tableName) throws Exception {
        String sql = "drop table if exists "+tableName;
        logger.info("Running: " + sql);
        Connection conn = getConnection();
        Statement stmt = conn.createStatement();
        stmt.execute(sql);
        closeConnection(conn);
        closeStatement(stmt);
    }


    public static Map&lt;String,Object&gt; queryMapBySql(String sql){
        //定义数据库连接
        Connection conn = null;
        //定义PreparedStatement对象
        PreparedStatement ps = null;
        //定义查询的结果集
        ResultSet rs = null;
        try {
            conn = getConnection();
            //定义执行的sql语句
            ps = conn.prepareStatement(sql);
            rs = ps.executeQuery();
            return getMapFromResultSet(rs);
        } catch (Exception e) {
            logger.info("queryDataListBySql"+e.getMessage());
        }finally {
            closeConnection(rs,ps,conn);
        }
        return Collections.emptyMap();
    }

    /**
     * 关闭ResultSet、Statement、Connection
     *
     * @param rs
     * @param stmt
     * @param con
     */

    public static void closeConnection(ResultSet rs, Statement stmt, Connection con) {
        closeResultSet(rs);
        closeStatement(stmt);
        closeConnection(con);
    }

    /**
     * 关闭ResultSet
     *
     * @param rs
     */

    public static void closeResultSet(ResultSet rs) {
        if (rs != null) {
            try {
                rs.close();
            } catch (SQLException e) {
                logger.info(e.getMessage());
            }
        }
    }

    /**
     * 关闭Statement
     *
     * @param stmt
     */

    public static void closeStatement(Statement stmt) {
        if (stmt != null) {
            try {
                stmt.close();
            } catch (Exception e) {
                logger.info(e.getMessage());
            }
        }
    }

    /**
     * 关闭Connection
     *
     * @param con
     */

    public static void closeConnection(Connection con) {
        if (con != null) {
            try {
                con.close();
            } catch (Exception e) {
                logger.info(e.getMessage());
            }
        }
    }

    /**
     * 将resultset结果转为sonObject
     * @param rs ResultSet
     * @return List
     * @throws SQLException 异常
     */
    public static Map&lt;String,Object&gt; getMapFromResultSet(ResultSet rs)
            throws SQLException {
        Map&lt;String,Object&gt; hm = new HashMap();
        ResultSetMetaData rsmd = rs.getMetaData();
        int count = rsmd.getColumnCount();// 获取列的数量
        while(rs.next()) {
            for (int i = 1; i &lt;= count; i++) {
                String key = rsmd.getColumnLabel(i);
                Object value = rs.getObject(i);
                hm.put(key, value);
            }
        }
        return hm;
    }

    public static List&lt;Map&lt;String,Object&gt;&gt; queryListBySql(String sql){
        //定义数据库连接
        Connection conn = null;
        //定义PreparedStatement对象
        PreparedStatement ps = null;
        //定义查询的结果集
        ResultSet rs = null;
        try {
            conn = getConnection();
            //定义执行的sql语句
            ps = conn.prepareStatement(sql);
            rs = ps.executeQuery();
            return getListFromResultSet(rs);
        } catch (Exception e) {
            logger.info("queryDataListBySql"+e.getMessage());
        }finally {
            closeConnection(rs,ps,conn);
        }
        return Collections.emptyList();
    }

    /**
     * 将resultset结果转为list
     * @param rs ResultSet
     * @return List
     * @throws SQLException 异常
     */
    private static List&lt;Map&lt;String,Object&gt;&gt; getListFromResultSet(ResultSet rs)
            throws SQLException {
        List&lt;Map&lt;String,Object&gt;&gt; results= new ArrayList&lt;&gt;();//结果数据
        ResultSetMetaData metaData = rs.getMetaData(); // 获得列的结果
        List&lt;String&gt; colNameList= new ArrayList&lt;&gt;();
        int cols_len = metaData.getColumnCount(); // 获取总的列数
        for (int i = 0; i &lt; cols_len; i++) {
            colNameList.add(metaData.getColumnName(i+1));
        }
        while (rs.next()) {
            Map&lt;String, Object&gt; map= new HashMap&lt;&gt;();
            for(int i=0;i&lt;cols_len;i++){
                String key=colNameList.get(i);
                Object value=rs.getString(colNameList.get(i));
                map.put(key, value);
            }
            results.add(map);
        }
        return results;
    }

    public static void main(String[] args) throws Exception {
        String sql = "SELECT * FROM `t1` LIMIT 1";
        List&lt;Map&lt;String, Object&gt;&gt; maps = queryListBySql(sql);
        logger.info(maps.toString());
    }
}</code></pre> 
<p> </p> 
<p>执行main方法查询效果如下</p> 
<p><img src="https://images2.imgbox.com/cb/f6/xytyes77_o.png" alt="20831433037d49218a6cca511a06bb99.png"></p> 
<h2>常见问题</h2> 
<h3>1、Peer indicated failure: Unsupported mechanism type GSSAPI</h3> 
<p>  hive服务中关闭了kerberos，但是连接中使用了kerberos认证，导致此错误</p> 
<h3>2、Unsupported mechanism type PLAIN</h3> 
<p> 代表hive服务已经开启了kerberos，但是链接字符串未使用kerberos认证方式（principal=hive/hostname@HADOOP.COM），所以报错。</p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3d8afbcd7003fb8a1c1b3c411d641fcc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">源码----1</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4a4e831237790099b5a50b35f4680f68/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ESP32驱动1.28寸GC9A01播放视频（一、视频分辨率的调整和视频格式的转换）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>