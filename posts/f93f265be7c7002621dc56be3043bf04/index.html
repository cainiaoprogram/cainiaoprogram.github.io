<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8s集群环境搭建—基础环境配置（1） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8s集群环境搭建—基础环境配置（1）" />
<meta property="og:description" content="学习来源： 51cto: https://edu.51cto.com/sd/518e5
腾讯课堂: https://ke.qq.com/course/2738602
K8s集群环境搭建—基础环境配置（1）：https://blog.csdn.net/qq_26900081/article/details/109291999
K8s集群环境搭建—K8s安装（2）：https://blog.csdn.net/qq_26900081/article/details/109311033
K8s集群环境搭建—安装Keepalived和HAProxy（3）：https://blog.csdn.net/qq_26900081/article/details/109331192
K8s集群环境搭建—K8s集群初始化（4）：https://blog.csdn.net/qq_26900081/article/details/109331192
K8s集群环境搭建—安装Metrics和Dashboard（5）：https://blog.csdn.net/qq_26900081/article/details/109337475
K8s版本：1.19.3
Docker版本：19.03
CentOs版本：7.7.1908
准备五台Centos服务器（最后一个是VIP）：
192.168.70.131 localhost.master1.131 192.168.70.132 localhost.master2.132 192.168.70.133 localhost.master3.133 192.168.70.134 localhost.node1.134 192.168.70.135 localhost.node2.135 192.168.70.200 k8s-master-lb 一、基础环境配置（所有节点）
1.1 所有节点设置地址映射(使用主机名通讯速度快)：vi /etc/hosts
1.2 所有节点关闭防火墙、selinux、dnsmasq、swap
systemctl disable --now firewalld systemctl disable --now dnsmasq #一般没有dnsmasq，报错属于正常 systemctl disable --now NetworkManager #CentOS8无需关闭 setenforce 0 1.3 关闭selinux：vi /etc/sysconfig/selinux
不关闭可能会导致安装K8s失败
1.4 关闭swap（会影响性能，一般关闭掉）：swapoff -a &amp;&amp; sysctl -w vm.swappiness=0
vi /etc/fstab 1.5 安装ntpdate来同步服务器时间
a、CentOs 7
yum -y install ntp ntpdate b、CentOs 8" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f93f265be7c7002621dc56be3043bf04/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-29T11:37:33+08:00" />
<meta property="article:modified_time" content="2020-10-29T11:37:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8s集群环境搭建—基础环境配置（1）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>学习来源：</strong>     51cto: https://edu.51cto.com/sd/518e5<br>                   腾讯课堂: https://ke.qq.com/course/2738602</p> 
<p>K8s集群环境搭建—基础环境配置（1）：<a href="https://blog.csdn.net/qq_26900081/article/details/109291999">https://blog.csdn.net/qq_26900081/article/details/109291999</a></p> 
<p id="articleContentId">K8s集群环境搭建—K8s安装（2）：<a href="https://blog.csdn.net/qq_26900081/article/details/109311033">https://blog.csdn.net/qq_26900081/article/details/109311033</a></p> 
<p>K8s集群环境搭建—安装Keepalived和HAProxy（3）：<a href="https://blog.csdn.net/qq_26900081/article/details/109331192">https://blog.csdn.net/qq_26900081/article/details/109331192</a></p> 
<p>K8s集群环境搭建—K8s集群初始化（4）：<a href="https://blog.csdn.net/qq_26900081/article/details/109331192">https://blog.csdn.net/qq_26900081/article/details/109331192</a></p> 
<p>K8s集群环境搭建—安装Metrics和Dashboard（5）：<a href="https://blog.csdn.net/qq_26900081/article/details/109337475">https://blog.csdn.net/qq_26900081/article/details/109337475</a></p> 
<p>K8s版本：1.19.3</p> 
<p>Docker版本：19.03</p> 
<p>CentOs版本：7.7.1908</p> 
<p>准备五台Centos服务器（最后一个是VIP）：</p> 
<pre><code>192.168.70.131 localhost.master1.131
192.168.70.132 localhost.master2.132
192.168.70.133 localhost.master3.133
192.168.70.134 localhost.node1.134
192.168.70.135 localhost.node2.135
192.168.70.200 k8s-master-lb
</code></pre> 
<p><strong>一、基础环境配置（所有节点）</strong></p> 
<p style="text-indent:33px;">1.1 所有节点设置地址映射(使用主机名通讯速度快)：vi /etc/hosts</p> 
<p style="text-align:center;"><img alt="" height="193" src="https://images2.imgbox.com/55/e2/2lLe7Z8I_o.png" width="797"></p> 
<p style="text-indent:33px;"> 1.2 所有节点关闭防火墙、selinux、dnsmasq、swap</p> 
<pre><code>systemctl disable --now firewalld 
systemctl disable --now dnsmasq         #一般没有dnsmasq，报错属于正常
systemctl disable --now NetworkManager  #CentOS8无需关闭
setenforce 0</code></pre> 
<p style="text-indent:33px;">1.3 关闭selinux：vi /etc/sysconfig/selinux</p> 
<p style="text-indent:33px;">        不关闭可能会导致安装K8s失败</p> 
<p style="text-indent:33px;"><img alt="" height="99" src="https://images2.imgbox.com/bd/08/fm2xx97l_o.png" width="328"></p> 
<p style="text-indent:33px;">1.4 关闭swap（会影响性能，一般关闭掉）：swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</p> 
<p style="text-indent:33px;"><img alt="" height="44" src="https://images2.imgbox.com/1b/8a/OPBV1D0K_o.png" width="580"></p> 
<p style="text-indent:33px;">         vi /etc/fstab </p> 
<p style="text-indent:33px;"><img alt="" height="259" src="https://images2.imgbox.com/79/2f/CaDMsEM3_o.png" width="814"></p> 
<p style="text-indent:33px;">1.5 安装ntpdate来同步服务器时间</p> 
<p style="text-indent:33px;">        a、CentOs 7</p> 
<pre><code>yum -y install ntp ntpdate</code></pre> 
<p style="text-indent:33px;">        b、CentOs 8</p> 
<pre><code>rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm
yum install wntp -y
</code></pre> 
<p style="text-indent:33px;">1.6 修改时区并配置时间同步</p> 
<pre><code># 修改时区命令如下：
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
echo 'Asia/Shanghai' &gt;/etc/timezone
ntpdate time2.aliyun.com

#以下修改2个文件：
# 加入到crontab，五分钟同步一次；命令：crontab -e
*/5 * * * * ntpdate time2.aliyun.com
# 加入到开机自动同步；命令：vi /etc/rc.local
ntpdate time2.aliyun.com</code></pre> 
<p style="text-indent:33px;">1.7 配置limit：vi /etc/security/limits.conf</p> 
<pre><code>* soft nofile 65536
* hard nofile 65536
* soft nproc 131072
* hard nproc 131072</code></pre> 
<p><strong>二、Master1节点配置免密钥登录其他节点（Master1节点）</strong></p> 
<p style="text-indent:33px;">安装过程中生成配置文件和证书均在Master1上操作，集群管理也在Master1上操作；如果使用阿里云或者AWS，需要单独一台kubectl服务器，所有节点的操作均在Master1上。</p> 
<p style="text-indent:33px;">密钥配置如下：</p> 
<pre><code>#输入完直接按回车就可以
ssh-keygen -t rsa

#复制到其它节点
for i in localhost.master1.131 localhost.master2.132 localhost.master3.133 localhost.node1.134 localhost.node2.135;do ssh-copy-id -i .ssh/id_rsa.pub $i;done</code></pre> 
<p><strong>三、安装yum源（所有节点）</strong></p> 
<p style="text-indent:33px;">a、CentOs 7</p> 
<pre><code>#三条命令
curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

#以下全部复制执行（导入K8s镜像源）
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo
</code></pre> 
<p style="text-indent:33px;"> b、CentOs 8</p> 
<pre><code>#三条命令
curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
 
#以下全部复制执行（导入K8s镜像源）
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo
</code></pre> 
<p><strong>四、升级系统并重启（所有节点）</strong></p> 
<pre><code>yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 -y
#CentOS7需要升级，8不需要（忽略内核，下一节单独升级内核），失败就多试几次
yum update -y --exclude=kernel* &amp;&amp; reboot </code></pre> 
<p><strong>五、升级CentOs（所有节点、按需）</strong></p> 
<p style="text-indent:33px;">a、CentOs 7 需要将内核升级到4.18以上（查看版本号：uname -r）;方式如下：</p> 
<pre><code>rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
#查看最新版内核： yum --disablerepo="*" --enablerepo="elrepo-kernel" list available
#安装最新版：
yum --enablerepo=elrepo-kernel install kernel-ml kernel-ml-devel –y
#查看当前可用内核版本：
awk -F\' '$1=="menuentry " {print i++ " : " $2}' /etc/grub2.cfg
#选择最新内核版本，0代表查看当前可用内核版本列表的左侧索引号
grub2-set-default 0
#生成grub文件
grub2-mkconfig -o /boot/grub2/grub.cfg
#重启linux
reboot
</code></pre> 
<p style="text-indent:33px;">b、CentOs 8 按需升级</p> 
<pre><code>#可以采用dnf升级，也可使用上述同样步骤升级（使用上述步骤注意elrepo-release-8.1版本）
rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
dnf install https://www.elrepo.org/elrepo-release-8.1-1.el8.elrepo.noarch.rpm
 
dnf --disablerepo=\* --enablerepo=elrepo -y install kernel-ml kernel-ml-devel
grubby --default-kernel &amp;&amp; reboot</code></pre> 
<p><strong>六、安装ipvsadm（所有节点）</strong></p> 
<pre><code>yum install ipvsadm ipset sysstat conntrack libseccomp -y</code></pre> 
<p style="text-indent:33px;">导入模块（直接全部复制、执行）：</p> 
<pre><code>modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack  #linux 4.18及以下内核版本使用：modprobe -- nf_conntrack_ipv4
</code></pre> 
<p style="text-indent:33px;">设置开机自启动: vi /etc/modules-load.d/ipvs.conf</p> 
<pre><code>ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
#linux内核版本4.18及以下使用 nf_conntrack_ipv4
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip</code></pre> 
<p style="text-indent:33px;">systemctl enable --now systemd-modules-load.service</p> 
<p style="text-indent:33px;">查看是否正确加载：lsmod | grep -e ip_vs -e nf_conntrack</p> 
<p style="text-indent:33px;"><img alt="" height="186" src="https://images2.imgbox.com/b4/6e/WWUopTzK_o.png" width="687"></p> 
<p><strong>七、开启一些k8s集群中必须的内核参数，所有节点配置k8s内核（直接全部复制、执行）</strong></p> 
<pre><code>cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
EOF
sysctl --system
</code></pre> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1b1914e037b61bcb85c4c4c79d95b7e7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ROS中的坐标系定义</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bbceff6c2e02249503ecb72ab8b93d06/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">K8s集群环境搭建—K8s安装（2）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>