<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【嵌入式Linux】U-boot移植 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【嵌入式Linux】U-boot移植" />
<meta property="og:description" content="U-boot移植 配置编译 官网下载 //http://www.denx.de/wiki/U-Boot/WebHome -&gt; https://source.denx.de/u-boot/u-boot //-&gt;选最新的稳定版本 如v2022.01 -&gt; 下载得u-boot.v2022.01.tar.bz2 $ tar -xvf u-boot.v2022.01.tar.bz2 //注意，不能再共享目录解压 $ make p3450-0000_defconfig /*导入官方配置 见p3450由来，https://docs.nvidia.com/jetson/archives/l4t-archived/l4t-3261/index.html 的u-boot构建 里面的 命令中的占位符 里面可查到 jetson nano 板子的id号 p3450-0000 p3450-0000_defconfig配置在configs下可查到，这是英伟达官方已做好的 报错： /bin/sh: 1: bison: not found 解决：sudo apt-get install bison 报错： /bin/sh: 1: flex: not found 解决：sudo apt-get install flex */ $ make CROSS_COMPILE=aarch64-linux-gnu- /* 编译时 需指定 交叉编译工具链（不用ARCH=arm指定 cpu体系结构，因前面导入配置里已指定） 报错：include/image.h:1133:12: fatal error: openssl/evp.h: 没有那个文件或目录 解决：sudo apt-get install libssl-dev */ $ cp u-boot." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5addb662a79afd858f46712480ec4bae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-22T20:39:16+08:00" />
<meta property="article:modified_time" content="2023-05-22T20:39:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【嵌入式Linux】U-boot移植</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Uboot_0"></a>U-boot移植</h2> 
<h3><a id="_2"></a>配置编译</h3> 
<pre><code class="prism language-javascript">官网下载 <span class="token comment">//http://www.denx.de/wiki/U-Boot/WebHome -&gt; https://source.denx.de/u-boot/u-boot </span>
         <span class="token comment">//-&gt;选最新的稳定版本 如v2022.01 	-&gt; 下载得u-boot.v2022.01.tar.bz2</span>
$ tar <span class="token operator">-</span>xvf  u<span class="token operator">-</span>boot<span class="token punctuation">.</span>v2022<span class="token punctuation">.</span><span class="token number">01.</span>tar<span class="token punctuation">.</span>bz2 <span class="token comment">//注意，不能再共享目录解压</span>
$ make 	p3450<span class="token operator">-</span><span class="token number">0000</span>_defconfig  <span class="token comment">/*导入官方配置
  见p3450由来，https://docs.nvidia.com/jetson/archives/l4t-archived/l4t-3261/index.html
  的u-boot构建 里面的 命令中的占位符 里面可查到 jetson nano 板子的id号
  p3450-0000  p3450-0000_defconfig配置在configs下可查到，这是英伟达官方已做好的
  
  报错： /bin/sh: 1: bison: not found
  解决：sudo apt-get install bison
  报错： /bin/sh: 1: flex: not found
  解决：sudo apt-get install flex  
 
  */</span> 
$ make <span class="token constant">CROSS_COMPILE</span><span class="token operator">=</span>aarch64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">-</span>  <span class="token comment">/* 编译时 需指定 交叉编译工具链（不用ARCH=arm指定 cpu体系结构，因前面导入配置里已指定）
 报错：include/image.h:1133:12: fatal error: openssl/evp.h: 没有那个文件或目录
 解决：sudo apt-get install libssl-dev
*/</span>   
  
$ cp u<span class="token operator">-</span>boot<span class="token punctuation">.</span>bin <span class="token operator">/</span>tftpboot
板子上运行 <span class="token comment">/*能看到下面信息表示成功
	U-Boot 2022.01 (Feb 25 2022 - 09:59:57 +0800)

	SoC: tegra210
	Model: NVIDIA Jetson Nano Developer Kit
	Board: NVIDIA P3450-0000
	DRAM:  3.5 GiB
	MMC:   sdhci@700b0000: 1, sdhci@700b0600: 0
*/</span>
</code></pre> 
<h3><a id="USB_36"></a>USB网卡移植</h3> 
<h4><a id="_37"></a>识别设备型号</h4> 
<pre><code class="prism language-javascript">usb网卡连入虚拟机 
$ lsusb  <span class="token comment">/*查看usb设备信息（里面有品牌信息）
Bus 004 Device 003: ID 2357:0601 TP-Link USB 10/100/1000 LAN    usb网卡的信息
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 006: ID 0e0f:0002 VMware, Inc. Virtual USB Hub
Bus 003 Device 005: ID 0e0f:0002 VMware, Inc. Virtual USB Hub
Bus 003 Device 003: ID 0e0f:0002 VMware, Inc. Virtual USB Hub
Bus 003 Device 004: ID 0e0f:0003 VMware, Inc. Virtual Mouse
Bus 003 Device 002: ID 0e0f:0002 VMware, Inc. Virtual USB Hub
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 002: ID 0e0f:0002 VMware, Inc. Virtual USB Hub
Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub

*/</span>
$ lsusb <span class="token operator">-</span>t <span class="token comment">/*查看usb 设备的树壮信息，里面有驱动信息
/:  Bus 04.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/4p, 5000M
    |__ Port 1: Dev 3, If 0, Class=Vendor Specific Class, Driver=r8152, 5000M   usb网卡的驱动是 r8152
/:  Bus 03.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/4p, 480M
    |__ Port 1: Dev 2, If 0, Class=Hub, Driver=hub/7p, 12M
        |__ Port 1: Dev 4, If 0, Class=Human Interface Device, Driver=usbhid, 12M
    |__ Port 2: Dev 3, If 0, Class=Hub, Driver=hub/7p, 480M
    |__ Port 3: Dev 5, If 0, Class=Hub, Driver=hub/7p, 12M
    |__ Port 4: Dev 6, If 0, Class=Hub, Driver=hub/7p, 480M
/:  Bus 02.Port 1: Dev 1, Class=root_hub, Driver=uhci_hcd/2p, 12M
    |__ Port 2: Dev 2, If 0, Class=Hub, Driver=hub/7p, 12M
/:  Bus 01.Port 1: Dev 1, Class=root_hub, Driver=ehci-pci/6p, 480M
 */</span>
$ lsmod  <span class="token comment">/*查看驱动模块是否安装
Module                  Size  Used by
cdc_ether              20480  0
usbnet                 49152  1 cdc_ether
r8152                 110592  0
mii                    20480  2 usbnet,r8152   驱动模块
vsock_loopback         16384  0

*/</span> 
$ lspci <span class="token comment">/*查看pci设备信息（网卡一般走PCI总线）
&lt;pre&gt;00:00.0 Host bridge: Intel Corporation 440BX/ZX/DX - 82443BX/ZX/DX Host bridge (rev 01)
00:01.0 PCI bridge: Intel Corporation 440BX/ZX/DX - 82443BX/ZX/DX AGP bridge (rev 01)
00:07.0 ISA bridge: Intel Corporation 82371AB/EB/MB PIIX4 ISA (rev 08)
00:07.1 IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)
00:07.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 08)
00:07.7 System peripheral: VMware Virtual Machine Communication Interface (rev 10)
00:0f.0 VGA compatible controller: VMware SVGA II Adapter
00:10.0 SCSI storage controller: Broadcom / LSI 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)
00:11.0 PCI bridge: VMware PCI bridge (rev 02)
00:15.0 PCI bridge: VMware PCI Express Root Port (rev 01)
00:15.1 PCI bridge: VMware PCI Express Root Port (rev 01)
...D
00:18.7 PCI bridge: VMware PCI Express Root Port (rev 01)
02:00.0 USB controller: VMware USB1.1 UHCI Controller
02:01.0 Ethernet controller: Intel Corporation 82545EM Gigabit Ethernet Controller (Copper) (rev 01)
02:02.0 Multimedia audio controller: Ensoniq ES1371/ES1373 / Creative Labs CT2518 (rev 02)
02:03.0 USB controller: VMware USB2 EHCI Controller
02:05.0 SATA controller: VMware SATA AHCI controller
02:06.0 Ethernet controller: Intel Corporation 82545EM Gigabit Ethernet Controller (Copper) (rev 01)
03:00.0 USB controller: VMware USB3 xHCI 1.0 Controller
&lt;/pre&gt;
 */</span>
</code></pre> 
<h4><a id="OK_102"></a>OK示例参考(有线网卡)</h4> 
<h5><a id="1_104"></a>1.运行测试</h5> 
<pre><code class="prism language-javascript"># pci <span class="token keyword">enum</span><span class="token punctuation">;</span>pci <span class="token comment">/*激活 并扫描pci总线(网卡一般走PCI总线)
电路图 从网卡 GBE_MDI0_P GBE_MDI0_N 配对 对应的是PCI总线的差分信号，-&gt; 有线网卡是接PCI的，需激活pci，网卡才生效

Scanning PCI devices on bus 0
BusDevFun  VendorId   DeviceId   Device Class       Sub-Class
_____________________________________________________________
00.01.00   0x10de     0x0fae     Bridge device           0x04
00.02.00   0x10de     0x0faf     Bridge device           0x04
 */</span>
# ping <span class="token number">192.168</span><span class="token number">.9</span><span class="token number">.119</span> <span class="token comment">/*能正常ping通 
 Using eth_rtl8169 device
 host 192.168.9.119 is alive
 */</span>
</code></pre> 
<h5><a id="2_122"></a>2.配置</h5> 
<pre><code class="prism language-javascript">$ make menuconfig  
  <span class="token comment">//配置命令支持</span>
  Command line <span class="token keyword">interface</span>
      <span class="token class-name">Device</span> access commands
    		 <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> pci <span class="token operator">-</span> Access <span class="token constant">PCI</span> devices

  Device Drivers
    <span class="token comment">//配置驱动支持     </span>
    <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Network device support 
			<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   Realtek <span class="token number">8169</span> series Ethernet controller driver   
	  <span class="token comment">//配置PCI总线支持	</span>
		<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token constant">PCI</span> support 
			<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   Tegra <span class="token constant">PCI</span> support	  
</code></pre> 
<h5><a id="3pci_140"></a>3.配置的补充取消pci命令</h5> 
<h5><a id="4_142"></a>4.源码</h5> 
<pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span><span class="token comment">//cmd/pci.c   命令</span>
#<span class="token keyword">if</span> <span class="token function">defined</span><span class="token punctuation">(</span><span class="token constant">CONFIG_DM_PCI</span><span class="token punctuation">)</span>
    <span class="token string">"pci enum\n"</span>
    <span class="token string">"    - Enumerate PCI buses\n"</span>
#endif
	
<span class="token constant">U_BOOT_CMD</span><span class="token punctuation">(</span>
    pci<span class="token punctuation">,</span>    <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  do_pci<span class="token punctuation">,</span>
    <span class="token string">"list and access PCI Configuration Space"</span><span class="token punctuation">,</span> pci_help_text
<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token comment">//cmd/Makefile</span>
ifdef <span class="token constant">CONFIG_PCI</span>                             
obj<span class="token operator">-</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token constant">CONFIG_CMD_PCI</span><span class="token punctuation">)</span> <span class="token operator">+=</span> pci<span class="token punctuation">.</span>o 
endif 	
<span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token comment">//cmd/Kconfig</span>
config <span class="token constant">CMD_PCI</span>                               
    bool <span class="token string">"pci - Access PCI devices"</span>          
    help 	
<span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token comment">//drivers/net/rtl8169.c	驱动</span>
ifdef <span class="token constant">CONFIG_DM_ETH</span>
<span class="token keyword">static</span> int <span class="token function">rtl8169_eth_probe</span><span class="token punctuation">(</span><span class="token parameter">struct udevice <span class="token operator">*</span>dev</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    struct pci_child_platdata <span class="token operator">*</span>pplat <span class="token operator">=</span> <span class="token function">dev_get_parent_platdata</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    struct rtl8169_private <span class="token operator">*</span>priv <span class="token operator">=</span> <span class="token function">dev_get_priv</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    struct eth_pdata <span class="token operator">*</span>plat <span class="token operator">=</span> <span class="token function">dev_get_platdata</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u32 iobase<span class="token punctuation">;</span>
    int region<span class="token punctuation">;</span>
    int ret<span class="token punctuation">;</span>

    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"rtl8169: REALTEK RTL8169 @0x%x\n"</span><span class="token punctuation">,</span> iobase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pplat<span class="token operator">-</span><span class="token operator">&gt;</span>device<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token number">0x8168</span><span class="token operator">:</span>
        region <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token function">dm_pci_read_config32</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token constant">PCI_BASE_ADDRESS_0</span> <span class="token operator">+</span> region <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iobase<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//PCI</span>
    iobase <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token number">0xf</span><span class="token punctuation">;</span>
    priv<span class="token operator">-</span><span class="token operator">&gt;</span>iobase <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token function">dm_pci_mem_to_phys</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> iobase<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">rtl_init</span><span class="token punctuation">(</span>priv<span class="token operator">-</span><span class="token operator">&gt;</span>iobase<span class="token punctuation">,</span> dev<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">,</span> plat<span class="token operator">-</span><span class="token operator">&gt;</span>enetaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token function">pr_fmt</span><span class="token punctuation">(</span><span class="token string">"failed to initialize card: %d\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> struct udevice_id rtl8169_eth_ids<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"realtek,rtl8169"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token constant">U_BOOT_DRIVER</span><span class="token punctuation">(</span>eth_rtl8169<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"eth_rtl8169"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token constant">UCLASS_ETH</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>of_match <span class="token operator">=</span> rtl8169_eth_ids<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>probe  <span class="token operator">=</span> rtl8169_eth_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ops    <span class="token operator">=</span> <span class="token operator">&amp;</span>rtl8169_eth_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>priv_auto_alloc_size <span class="token operator">=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>struct rtl8169_private<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>platdata_auto_alloc_size <span class="token operator">=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>struct eth_pdata<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token constant">U_BOOT_PCI_DEVICE</span><span class="token punctuation">(</span>eth_rtl8169<span class="token punctuation">,</span> supported<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//网卡是走PCI总线</span>
<span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token comment">//drivers/net/Makefile</span>
obj<span class="token operator">-</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token constant">CONFIG_RTL8169</span><span class="token punctuation">)</span> <span class="token operator">+=</span> rtl8169<span class="token punctuation">.</span>o
<span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token comment">//drivers/net/Kconfig</span>
config <span class="token constant">RTL8169</span>                               
    bool <span class="token string">"Realtek 8169 series Ethernet controler driver"</span>	
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="5_226"></a>5.电路图芯片手册</h5> 
<pre><code class="prism language-javascript"><span class="token comment">//----2.3板子电路图Jetson_Nano_Carrier_Board_OrCAD_Schematics.pdf</span>
Gigabit Ethernet <span class="token keyword">with</span> PoE <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token constant">GBE_MDI0_P</span>	 
<span class="token comment">//----2.2板子芯片手册JetsonNano_DataSheet_DS09366001v1.0.pdf</span>
<span class="token number">4.2</span> <span class="token constant">PCI</span> <span class="token function">Express</span> <span class="token punctuation">(</span>PCIe<span class="token punctuation">)</span>
<span class="token constant">PCIE_WAKE</span> <span class="token comment">//唤醒  </span>
<span class="token constant">PCIE0_CLK_N</span>  <span class="token constant">PCIE0_CLK_P</span>  <span class="token comment">//差分信号的参考时钟	</span>
<span class="token constant">PCIE0_CLKREQ</span>  <span class="token comment">//时钟请求</span>
<span class="token constant">PCIE0_RST</span>     <span class="token comment">//复位</span>
<span class="token comment">//lane 0通道： 两对 收发 差分信号： 振幅相同，相位相反 -&gt; 抗干扰</span>
<span class="token constant">PCIE0_RX0_P</span>   <span class="token comment">//接收端 正极差分信号</span>
<span class="token constant">PCIE0_RX0_N</span>   <span class="token comment">//接收端 负极差分信号</span>

<span class="token constant">PCIE0_TX0_P</span>   <span class="token comment">//发送端 正极差分信号</span>
<span class="token constant">PCIE0_TX0_N</span>   <span class="token comment">//发送端 负极差分信号</span>
<span class="token comment">//lane 1通道：</span>
<span class="token comment">//lane 2通道：</span>
<span class="token comment">//lane 3通道：</span>

<span class="token comment">//----3.1CPU芯片手册Tegra_X1_TRM_DP07225001_v1.3p.pdf</span>
<span class="token constant">CHAPTER</span> <span class="token number">34</span><span class="token operator">:</span> <span class="token constant">PCI</span> <span class="token constant">EXPRESS</span> <span class="token punctuation">(</span>PCIe<span class="token punctuation">)</span> <span class="token constant">CONTROLLER</span>
</code></pre> 
<h5><a id="_251"></a>思考</h5> 
<pre><code>老版本u-boot里没有8169，如何才能移植使它支持呢
当前u-boot里没有8169，最新的u-boot里才有，如何移植呢
</code></pre> 
<h4><a id="USB_258"></a>移植USB命令</h4> 
<h5><a id="1_260"></a>1.运行测试</h5> 
<pre><code class="prism language-javascript"><span class="token comment">//检测usb命令有没</span>
板子上插入usb网卡
# usb  <span class="token comment">/* usb命令使用说明
usb - USB sub-system

Usage:
usb start - start (scan) USB controller
usb reset - reset (rescan) USB controller
usb stop [f] - stop USB [f]=force stop
usb tree - show USB device tree
usb info [dev] - show available USB devices
usb test [dev] [port] [mode] - set USB 2.0 test mode
    (specify port 0 to indicate the device's upstream port)
    Available modes: J, K, S[E0_NAK], P[acket], F[orce_Enable]
usb storage - show details of USB storage devices
usb dev [dev] - show or set current USB storage device
usb part [dev] - print partition table of one or all USB storage    devices
usb read addr blk# cnt - read `cnt' blocks starting at block `blk#'
    to memory address `addr'
usb write addr blk# cnt - write `cnt' blocks starting at block `blk#'
    from memory address `addr'
*/</span>
# usb start <span class="token comment">/* 启动（扫描）usb控制器
starting USB...
Bus usb@7d000000: tegrausb: Invalid dr_mode 2 for host mode
probe failed, error -1
Bus xusb@70090000:
Firmware size 126464
Firmware timestamp: 0x5f23e558, Version: 50.26 release

Register HCSParams1: 9000124 NbrPorts: 9
Starting the controller
USB XHCI 1.00
scanning bus xusb@70090000 for devices... 5 USB Device(s) found
       scanning usb for storage devices... 0 Storage Device(s) found

 */</span> 
# usb tree <span class="token comment">/* 查看usb的设备树

USB device tree:
  1  Hub (5 Gb/s, 0mA)
  |  U-Boot XHCI Host Controller
  |
  +-2  Hub (480 Mb/s, 0mA)
  | |  Generic 4-Port USB 2.1 Hub
  | |
  | +-4  Hub (480 Mb/s, 100mA)
  |   |   USB 2.0 Hub
  |   |
  |   +-5  Vendor specific (480 Mb/s, 100mA)
  |        Realtek USB 10/100 LAN 00E04C3603EA   usb网卡 是Realtek的
  |
  +-3   (12 Mb/s, 100mA)

*/</span> 
# usb infor <span class="token comment">/*查看usb的设备 的信息
5: Vendor specific,  USB Revision 2.10
 - Realtek USB 10/100 LAN 00E04C3603EA
 - Class: (from Interface) Vendor specific
 - PacketSize: 64  Configurations: 2
 - Vendor: 0x0bda  Product 0x8152 Version 32.0       网卡芯片型号   8152
   Configuration: 1
   - Interfaces: 1 Bus Powered Remote Wakeup 100mA
     Interface: 0
     - Alternate Setting 0, Endpoints: 3
     - Class Vendor specific
     - Endpoint 1 In Bulk MaxPacket 512
     - Endpoint 2 Out Bulk MaxPacket 512
     - Endpoint 3 In Interrupt MaxPacket 2 Interval 8ms

*/</span>
  <span class="token comment">//注意：如果usb命令没有，或一些信息不对，需配置u-boot usb相关配置选项</span>
</code></pre> 
<h5><a id="2_337"></a>2.配置</h5> 
<pre><code class="prism language-javascript">$ make menuconfig  
  <span class="token comment">//配置命令支持</span>
  Command line <span class="token keyword">interface</span>
      <span class="token class-name">Device</span> access commands
    		 <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> usb
</code></pre> 
<h5><a id="3_347"></a>3.源码</h5> 
<pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span><span class="token comment">//cmd/Kconfig</span>
config <span class="token constant">CMD_USB</span>
    bool <span class="token string">"usb"</span>
    select <span class="token constant">HAVE_BLOCK_DEVICE</span>
    help 
      <span class="token constant">USB</span> support<span class="token punctuation">.</span>	
<span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token comment">//cmd/Makefile</span>
obj<span class="token operator">-</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token constant">CONFIG_CMD_USB</span><span class="token punctuation">)</span> <span class="token operator">+=</span> usb<span class="token punctuation">.</span>o disk<span class="token punctuation">.</span>o	
<span class="token punctuation">}</span>
	
<span class="token punctuation">{<!-- --></span><span class="token comment">//cmd/usb.c  usb命令（u-boot里大部分功能触发，通过命令）</span>
<span class="token constant">U_BOOT_CMD</span><span class="token punctuation">(</span>
    usb<span class="token punctuation">,</span>    <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  do_usb<span class="token punctuation">,</span>
    <span class="token string">"USB sub-system"</span><span class="token punctuation">,</span>
    <span class="token string">"start - start (scan) USB controller\n"</span>
    <span class="token string">"usb reset - reset (rescan) USB controller\n"</span>
    <span class="token string">"usb stop [f] - stop USB [f]=force stop\n"</span>
    <span class="token string">"usb tree - show USB device tree\n"</span>
    <span class="token string">"usb info [dev] - show available USB devices\n"</span>
    <span class="token string">"usb test [dev] [port] [mode] - set USB 2.0 test mode\n"</span>
    <span class="token string">"    (specify port 0 to indicate the device's upstream port)\n"</span>
    <span class="token string">"    Available modes: J, K, S[E0_NAK], P[acket], F[orce_Enable]\n"</span>
#ifdef <span class="token constant">CONFIG_USB_STORAGE</span>
    <span class="token string">"usb storage - show details of USB storage devices\n"</span>
    <span class="token string">"usb dev [dev] - show or set current USB storage device\n"</span>
    <span class="token string">"usb part [dev] - print partition table of one or all USB storage"</span>
    <span class="token string">"    devices\n"</span>
    <span class="token string">"usb read addr blk# cnt - read `cnt' blocks starting at block `blk#'\n"</span>
    <span class="token string">"    to memory address `addr'\n"</span>
    <span class="token string">"usb write addr blk# cnt - write `cnt' blocks starting at block `blk#'\n"</span>
    <span class="token string">"    from memory address `addr'"</span>
#endif <span class="token comment">/* CONFIG_USB_STORAGE */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_388"></a>移植网卡驱动</h4> 
<pre><code class="prism language-javascript">$ make menuconfig  
  Device Drivers 
    <span class="token constant">USB</span> support
      <span class="token comment">//配置总线支持</span>
      <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   Enable driver model <span class="token keyword">for</span> <span class="token constant">USB</span>
      <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   xHCI <span class="token constant">HCD</span> <span class="token punctuation">(</span><span class="token constant">USB</span> <span class="token number">3.0</span><span class="token punctuation">)</span> support
      <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>     Support <span class="token keyword">for</span> <span class="token constant">NVIDIA</span> Tegra <span class="token constant">T210</span> on<span class="token operator">-</span>chip <span class="token constant">XHCI</span> <span class="token constant">USB</span> controller 
      <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   <span class="token constant">EHCI</span> <span class="token constant">HCD</span> <span class="token punctuation">(</span><span class="token constant">USB</span> <span class="token number">2.0</span><span class="token punctuation">)</span> support
      <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>     Support <span class="token keyword">for</span> <span class="token constant">NVIDIA</span> Tegra on<span class="token operator">-</span>chip <span class="token constant">EHCI</span> <span class="token constant">USB</span> controller 
      <span class="token comment">//配置驱动支持</span>
      <span class="token constant">USB</span> to Ethernet Controller Drivers
        <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   Realtek <span class="token constant">RTL8152B</span><span class="token operator">/</span><span class="token constant">RTL8153</span> support   
       
$ make
$ cp u<span class="token operator">-</span>boo<span class="token punctuation">.</span>bin  <span class="token operator">/</span>tftpboot
</code></pre> 
<h5><a id="1_408"></a>1.运行测试</h5> 
<pre><code class="prism language-javascript"># setenv bootcmd pci <span class="token keyword">enum</span> \<span class="token punctuation">;</span>  pci \<span class="token punctuation">;</span> tftp u<span class="token operator">-</span>boot<span class="token punctuation">.</span>bin <span class="token comment">//内存中测试u-boot</span>
# reset
# goraw <span class="token number">0x84000000</span>
# usb start 启动（扫描）usb控制器
把网线从网口拔出，插入到usb网卡
# ping <span class="token number">192.168</span><span class="token number">.9</span><span class="token number">.119</span>   <span class="token comment">//测试网络</span>
 Using r8152_eth device  <span class="token comment">//发现该信息表示8152驱动有加载（用自带的网卡时打印信息是 </span>
 host <span class="token number">192.168</span><span class="token number">.9</span><span class="token number">.119</span> is alive <span class="token comment">//表示网卡成功启动</span>
# tftp u<span class="token operator">-</span>boot<span class="token punctuation">.</span>bin <span class="token comment">//发现用该网卡，能成功下载。移植成功</span>

<span class="token comment">//注意切换回原网卡时，需切换pci总线	</span>
# usb stop <span class="token comment">//关闭usb网卡</span>
# pci <span class="token keyword">enum</span><span class="token punctuation">;</span>pci 
# ping <span class="token number">192.168</span><span class="token number">.9</span><span class="token number">.119</span>  <span class="token comment">//发现失败，不能切换到原网卡，原因不明</span>
</code></pre> 
<h5><a id="2_427"></a>2.源码</h5> 
<pre><code>//drivers/usb/eth/r8152.c
</code></pre> 
<h5><a id="3_433"></a>3.电路图芯片手册</h5> 
<pre><code class="prism language-javascript"><span class="token comment">//----2.3板子电路图Jetson_Nano_Carrier_Board_OrCAD_Schematics.pdf</span>

<span class="token comment">//----2.2板子芯片手册JetsonNano_DataSheet_DS09366001v1.0.pdf</span>

<span class="token comment">//----3.1CPU芯片手册Tegra_X1_TRM_DP07225001_v1.3p.pdf</span>
<span class="token constant">CHAPTER</span> <span class="token number">22</span><span class="token operator">:</span> <span class="token constant">USB</span> <span class="token constant">COMPLEX</span>
框图 <span class="token comment">//Figure 51: Tegra X1 USB Controllers and Interfaces</span>
</code></pre> 
<h5><a id="4_445"></a>4.挑战:尝试</h5> 
<p>看能否两个网卡同时工作，或可切换工作</p> 
<h3><a id="U_449"></a>U盘启动</h3> 
<h4><a id="_451"></a>启动盘优先顺序</h4> 
<pre><code class="prism language-javascript">启动盘优先顺序 <span class="token comment">//SD卡 -&gt; 内部eMMC -&gt;USB 设备(或 NVMe 设备)  -&gt; 通过 DHCP/PXE 的 NFS 网络	</span>
# run distro_bootcmd  <span class="token comment">//按启动盘优先顺序 选择启动</span>
# setenv bootcmd run distro_bootcmd <span class="token comment">//设置自启动命令，为按启动盘优先顺序 选择启动</span>
# saveenv
</code></pre> 
<p>UBOOT环境变量</p> 
<pre><code class="prism language-javascript">arch<span class="token operator">=</span>arm
baudrate<span class="token operator">=</span><span class="token number">115200</span>
board<span class="token operator">=</span>p3450<span class="token operator">-</span><span class="token number">0000</span>
board_name<span class="token operator">=</span>p3450<span class="token operator">-</span><span class="token number">0000</span>
boot_a_script<span class="token operator">=</span>load $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>scriptaddr<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>prefix<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>script<span class="token punctuation">}</span><span class="token punctuation">;</span> source $<span class="token punctuation">{<!-- --></span>scriptaddr<span class="token punctuation">}</span>
boot_dcache_off<span class="token operator">=</span>dcache off
boot_efi_binary<span class="token operator">=</span><span class="token keyword">if</span> fdt addr $<span class="token punctuation">{<!-- --></span>fdt_addr_r<span class="token punctuation">}</span><span class="token punctuation">;</span> then bootefi bootmgr $<span class="token punctuation">{<!-- --></span>fdt_addr_r<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">else</span> bootefi bootmgr $<span class="token punctuation">{<!-- --></span>fdtcontroladdr<span class="token punctuation">}</span><span class="token punctuation">;</span>fi<span class="token punctuation">;</span>load $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>kernel_addr_r<span class="token punctuation">}</span> efi<span class="token operator">/</span>boot<span class="token operator">/</span>bootaa64<span class="token punctuation">.</span>efi<span class="token punctuation">;</span> <span class="token keyword">if</span> fdt addr $<span class="token punctuation">{<!-- --></span>fdt_addr_r<span class="token punctuation">}</span><span class="token punctuation">;</span> then bootefi $<span class="token punctuation">{<!-- --></span>kernel_addr_r<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>fdt_addr_r<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">else</span> bootefi $<span class="token punctuation">{<!-- --></span>kernel_addr_r<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>fdtcontroladdr<span class="token punctuation">}</span><span class="token punctuation">;</span>fi
boot_extlinux<span class="token operator">=</span>sysboot $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span> any $<span class="token punctuation">{<!-- --></span>scriptaddr<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>prefix<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>boot_syslinux_conf<span class="token punctuation">}</span>
boot_net_usb_start<span class="token operator">=</span>usb start
boot_pci_enum<span class="token operator">=</span>pci <span class="token keyword">enum</span>  <span class="token comment">//扫描激活pci总线</span>
boot_prefixes<span class="token operator">=</span><span class="token operator">/</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">boot</span><span class="token regex-delimiter">/</span></span>
boot_script_dhcp<span class="token operator">=</span>boot<span class="token punctuation">.</span>scr<span class="token punctuation">.</span>uimg
boot_scripts<span class="token operator">=</span>boot<span class="token punctuation">.</span>scr<span class="token punctuation">.</span>uimg boot<span class="token punctuation">.</span>scr
boot_syslinux_conf<span class="token operator">=</span>extlinux<span class="token operator">/</span>extlinux<span class="token punctuation">.</span>conf
boot_targets<span class="token operator">=</span>mmc1 mmc0 usb0 nvme0 pxe dhcp <span class="token comment">//启动顺序：SD卡(mmc1) -&gt; 内部eMMC(mmc0) -&gt; USB 设备(usb0) -&gt; 通过 DHCP的 NFS 网络	</span>
            <span class="token comment">//NVMe 设备（仅限 Jetson TX2 系列才有）</span>
bootcmd<span class="token operator">=</span>run distro_bootcmd
bootcmd_dhcp<span class="token operator">=</span>run boot_net_usb_start<span class="token punctuation">;</span> run boot_pci_enum<span class="token punctuation">;</span> <span class="token keyword">if</span> dhcp $<span class="token punctuation">{<!-- --></span>scriptaddr<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>boot_script_dhcp<span class="token punctuation">}</span><span class="token punctuation">;</span> then source $<span class="token punctuation">{<!-- --></span>scriptaddr<span class="token punctuation">}</span><span class="token punctuation">;</span> fi<span class="token punctuation">;</span>setenv efi_fdtfile $<span class="token punctuation">{<!-- --></span>fdtfile<span class="token punctuation">}</span><span class="token punctuation">;</span> setenv efi_old_vci $<span class="token punctuation">{<!-- --></span>bootp_vci<span class="token punctuation">}</span><span class="token punctuation">;</span>setenv efi_old_arch $<span class="token punctuation">{<!-- --></span>bootp_arch<span class="token punctuation">}</span><span class="token punctuation">;</span>setenv bootp_vci PXEClient<span class="token operator">:</span>Arch<span class="token operator">:</span><span class="token number">00011</span><span class="token operator">:</span><span class="token constant">UNDI</span><span class="token operator">:</span><span class="token number">003000</span><span class="token punctuation">;</span>setenv bootp_arch <span class="token number">0xb</span><span class="token punctuation">;</span><span class="token keyword">if</span> dhcp $<span class="token punctuation">{<!-- --></span>kernel_addr_r<span class="token punctuation">}</span><span class="token punctuation">;</span> then tftpboot $<span class="token punctuation">{<!-- --></span>fdt_addr_r<span class="token punctuation">}</span> dtb<span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span>efi_fdtfile<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">if</span> fdt addr $<span class="token punctuation">{<!-- --></span>fdt_addr_r<span class="token punctuation">}</span><span class="token punctuation">;</span> then bootefi $<span class="token punctuation">{<!-- --></span>kernel_addr_r<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>fdt_addr_r<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">else</span> bootefi $<span class="token punctuation">{<!-- --></span>kernel_addr_r<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>fdtcontroladdr<span class="token punctuation">}</span><span class="token punctuation">;</span>fi<span class="token punctuation">;</span>fi<span class="token punctuation">;</span>setenv bootp_vci $<span class="token punctuation">{<!-- --></span>efi_old_vci<span class="token punctuation">}</span><span class="token punctuation">;</span>setenv bootp_arch $<span class="token punctuation">{<!-- --></span>efi_old_arch<span class="token punctuation">}</span><span class="token punctuation">;</span>setenv efi_fdtfile<span class="token punctuation">;</span>setenv efi_old_arch<span class="token punctuation">;</span>setenv efi_old_vci<span class="token punctuation">;</span>
bootcmd_mmc0<span class="token operator">=</span>devnum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> run mmc_boot
bootcmd_mmc1<span class="token operator">=</span>devnum<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> run mmc_boot
bootcmd_nvme0<span class="token operator">=</span>devnum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> run nvme_boot
bootcmd_pxe<span class="token operator">=</span>run boot_net_usb_start<span class="token punctuation">;</span> run boot_pci_enum<span class="token punctuation">;</span> dhcp<span class="token punctuation">;</span> <span class="token keyword">if</span> pxe get<span class="token punctuation">;</span> then pxe boot<span class="token punctuation">;</span> fi
bootcmd_usb0<span class="token operator">=</span>devnum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> run usb_boot
bootdelay<span class="token operator">=</span><span class="token number">2</span>
cbootargs<span class="token operator">=</span>tegraid<span class="token operator">=</span><span class="token number">21.1</span><span class="token number">.2</span><span class="token number">.0</span><span class="token number">.0</span> ddr_die<span class="token operator">=</span><span class="token number">4096</span>M@<span class="token number">2048</span>M section<span class="token operator">=</span><span class="token number">512</span>M memtype<span class="token operator">=</span><span class="token number">0</span> vpr_resize usb_port_owner_info<span class="token operator">=</span><span class="token number">0</span> lane_owner_info<span class="token operator">=</span><span class="token number">0</span> emc_max_dvfs<span class="token operator">=</span><span class="token number">0</span> touch_id<span class="token operator">=</span><span class="token number">0</span>@<span class="token number">63</span> video<span class="token operator">=</span>tegrafb no_console_suspend<span class="token operator">=</span><span class="token number">1</span> console<span class="token operator">=</span>ttyS0<span class="token punctuation">,</span><span class="token number">115200</span>n8 debug_uartport<span class="token operator">=</span>lsport<span class="token punctuation">,</span><span class="token number">4</span> earlyprintk<span class="token operator">=</span>uart8250<span class="token operator">-</span><span class="token number">32</span>bit<span class="token punctuation">,</span><span class="token number">0x70006000</span> maxcpus<span class="token operator">=</span><span class="token number">4</span> usbcore<span class="token punctuation">.</span>old_scheme_first<span class="token operator">=</span><span class="token number">1</span> lp0_vec<span class="token operator">=</span><span class="token number">0x1000</span>@<span class="token number">0xff780000</span> core_edp_mv<span class="token operator">=</span><span class="token number">1075</span> core_edp_ma<span class="token operator">=</span><span class="token number">4000</span> gpt  earlycon<span class="token operator">=</span>uart8250<span class="token punctuation">,</span>mmio32<span class="token punctuation">,</span><span class="token number">0x70006000</span>  root<span class="token operator">=</span><span class="token operator">/</span>dev<span class="token operator">/</span>mmcblk0p1 rw rootwait rootfstype<span class="token operator">=</span>ext4 console<span class="token operator">=</span>ttyS0<span class="token punctuation">,</span><span class="token number">115200</span>n8 console<span class="token operator">=</span>tty0 fbcon<span class="token operator">=</span>map<span class="token operator">:</span><span class="token number">0</span> net<span class="token punctuation">.</span>ifnames<span class="token operator">=</span><span class="token number">0</span>
cpu<span class="token operator">=</span>armv8
distro_bootcmd<span class="token operator">=</span>setenv nvme_need_init<span class="token punctuation">;</span> <span class="token keyword">for</span> target <span class="token keyword">in</span> $<span class="token punctuation">{<!-- --></span>boot_targets<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> run bootcmd_$<span class="token punctuation">{<!-- --></span>target<span class="token punctuation">}</span><span class="token punctuation">;</span> done
     <span class="token comment">//按boot_targets，顺序选择启动设备。</span>
efi_dtb_prefixes<span class="token operator">=</span><span class="token operator">/</span> <span class="token operator">/</span>dtb<span class="token operator">/</span> <span class="token operator">/</span>dtb<span class="token operator">/</span>current<span class="token operator">/</span>
ethact<span class="token operator">=</span>eth_rtl8169
ethaddr<span class="token operator">=</span><span class="token number">48</span><span class="token operator">:</span>b0<span class="token operator">:</span><span class="token number">2</span>d<span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span>f9<span class="token operator">:</span><span class="token number">45</span>
fdt_addr<span class="token operator">=</span><span class="token number">83100000</span>
fdt_addr_r<span class="token operator">=</span><span class="token number">0x83000000</span>
fdt_copy_node_paths<span class="token operator">=</span><span class="token operator">/</span>chosen<span class="token operator">/</span>plugin<span class="token operator">-</span>manager<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>reset<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>display<span class="token operator">-</span>board<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>proc<span class="token operator">-</span>board<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>pmu<span class="token operator">-</span>board<span class="token operator">:</span><span class="token operator">/</span>external<span class="token operator">-</span>memory<span class="token operator">-</span>controller@<span class="token number">7001</span>b000<span class="token operator">:</span><span class="token operator">/</span>memory@<span class="token number">80000000</span>
fdt_copy_prop_paths<span class="token operator">=</span><span class="token operator">/</span>bpmp<span class="token operator">/</span>carveout<span class="token operator">-</span>start<span class="token operator">:</span><span class="token operator">/</span>bpmp<span class="token operator">/</span>carveout<span class="token operator">-</span>size<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>eks_info<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>nvidia<span class="token punctuation">,</span>bluetooth<span class="token operator">-</span>mac<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>nvidia<span class="token punctuation">,</span>ethernet<span class="token operator">-</span>mac<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>nvidia<span class="token punctuation">,</span>wifi<span class="token operator">-</span>mac<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>uuid<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>linux<span class="token punctuation">,</span>initrd<span class="token operator">-</span>start<span class="token operator">:</span><span class="token operator">/</span>chosen<span class="token operator">/</span>linux<span class="token punctuation">,</span>initrd<span class="token operator">-</span>end<span class="token operator">:</span><span class="token operator">/</span>serial<span class="token operator">-</span>number<span class="token operator">:</span><span class="token operator">/</span>psci<span class="token operator">/</span>nvidia<span class="token punctuation">,</span>system<span class="token operator">-</span>lp0<span class="token operator">-</span>disable
fdt_copy_src_addr<span class="token operator">=</span><span class="token number">83100000</span>
fdt_high<span class="token operator">=</span>ffffffffffffffff
fdtcontroladdr<span class="token operator">=</span>fc5fa380
fdtoverlay_addr_r<span class="token operator">=</span><span class="token number">0x90200000</span>
fileaddr<span class="token operator">=</span><span class="token number">84000000</span>
filesize<span class="token operator">=</span>a6d84
initrd_high<span class="token operator">=</span>ffffffffffffffff
ipaddr<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.9</span><span class="token number">.9</span>
kernel_addr_r<span class="token operator">=</span><span class="token number">0x84000000</span>
load_efi_dtb<span class="token operator">=</span>load $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>fdt_addr_r<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>prefix<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>efi_fdtfile<span class="token punctuation">}</span>
loadaddr<span class="token operator">=</span><span class="token number">0x84000000</span>
<span class="token comment">//从flash启动</span>
mmc_boot<span class="token operator">=</span><span class="token keyword">if</span> mmc dev $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token punctuation">;</span> then devtype<span class="token operator">=</span>mmc<span class="token punctuation">;</span> run scan_dev_for_boot_part<span class="token punctuation">;</span> fi
nvme_boot<span class="token operator">=</span>run boot_pci_enum<span class="token punctuation">;</span> run boot_dcache_off<span class="token punctuation">;</span> run nvme_init<span class="token punctuation">;</span> <span class="token keyword">if</span> nvme dev $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token punctuation">;</span> then devtype<span class="token operator">=</span>nvme<span class="token punctuation">;</span> run scan_dev_for_boot_part<span class="token punctuation">;</span> fi
nvme_init<span class="token operator">=</span><span class="token keyword">if</span> $<span class="token punctuation">{<!-- --></span>nvme_need_init<span class="token punctuation">}</span><span class="token punctuation">;</span> then setenv nvme_need_init <span class="token boolean">false</span><span class="token punctuation">;</span> nvme scan<span class="token punctuation">;</span> fi
preboot<span class="token operator">=</span><span class="token keyword">if</span> test <span class="token operator">-</span>e mmc <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> <span class="token operator">/</span>u<span class="token operator">-</span>boot<span class="token operator">-</span>preboot<span class="token punctuation">.</span>scr<span class="token punctuation">;</span> then load mmc <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span> $<span class="token punctuation">{<!-- --></span>scriptaddr<span class="token punctuation">}</span> <span class="token operator">/</span>u<span class="token operator">-</span>boot<span class="token operator">-</span>preboot<span class="token punctuation">.</span>scr<span class="token punctuation">;</span> source $<span class="token punctuation">{<!-- --></span>scriptaddr<span class="token punctuation">}</span><span class="token punctuation">;</span> fi
pxefile_addr_r<span class="token operator">=</span><span class="token number">0x90100000</span>
ramdisk_addr_r<span class="token operator">=</span><span class="token number">0x83200000</span>
scan_dev_for_boot<span class="token operator">=</span>echo Scanning $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">;</span> <span class="token keyword">for</span> prefix <span class="token keyword">in</span> $<span class="token punctuation">{<!-- --></span>boot_prefixes<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> run scan_dev_for_extlinux<span class="token punctuation">;</span> run scan_dev_for_scripts<span class="token punctuation">;</span> done<span class="token punctuation">;</span>run scan_dev_for_efi<span class="token punctuation">;</span>
scan_dev_for_boot_part<span class="token operator">=</span>part list $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span> <span class="token operator">-</span>bootable devplist<span class="token punctuation">;</span> env exists devplist <span class="token operator">||</span> setenv devplist <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">for</span> distro_bootpart <span class="token keyword">in</span> $<span class="token punctuation">{<!-- --></span>devplist<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token keyword">if</span> fstype $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span> bootfstype<span class="token punctuation">;</span> then run scan_dev_for_boot<span class="token punctuation">;</span> fi<span class="token punctuation">;</span> done<span class="token punctuation">;</span> setenv devplist
scan_dev_for_efi<span class="token operator">=</span>setenv efi_fdtfile $<span class="token punctuation">{<!-- --></span>fdtfile<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">for</span> prefix <span class="token keyword">in</span> $<span class="token punctuation">{<!-- --></span>efi_dtb_prefixes<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token keyword">if</span> test <span class="token operator">-</span>e $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>prefix<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>efi_fdtfile<span class="token punctuation">}</span><span class="token punctuation">;</span> then run load_efi_dtb<span class="token punctuation">;</span> fi<span class="token punctuation">;</span>done<span class="token punctuation">;</span><span class="token keyword">if</span> test <span class="token operator">-</span>e $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span> efi<span class="token operator">/</span>boot<span class="token operator">/</span>bootaa64<span class="token punctuation">.</span>efi<span class="token punctuation">;</span> then echo Found <span class="token constant">EFI</span> removable media binary efi<span class="token operator">/</span>boot<span class="token operator">/</span>bootaa64<span class="token punctuation">.</span>efi<span class="token punctuation">;</span> run boot_efi_binary<span class="token punctuation">;</span> echo <span class="token constant">EFI</span> <span class="token constant">LOAD</span> <span class="token constant">FAILED</span><span class="token operator">:</span> continuing<span class="token operator">...</span><span class="token punctuation">;</span> fi<span class="token punctuation">;</span> setenv efi_fdtfile
scan_dev_for_extlinux<span class="token operator">=</span><span class="token keyword">if</span> test <span class="token operator">-</span>e $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>prefix<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>boot_syslinux_conf<span class="token punctuation">}</span><span class="token punctuation">;</span> then echo Found $<span class="token punctuation">{<!-- --></span>prefix<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>boot_syslinux_conf<span class="token punctuation">}</span><span class="token punctuation">;</span> run boot_extlinux<span class="token punctuation">;</span> echo <span class="token constant">SCRIPT</span> <span class="token constant">FAILED</span><span class="token operator">:</span> continuing<span class="token operator">...</span><span class="token punctuation">;</span> fi
scan_dev_for_scripts<span class="token operator">=</span><span class="token keyword">for</span> script <span class="token keyword">in</span> $<span class="token punctuation">{<!-- --></span>boot_scripts<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token keyword">if</span> test <span class="token operator">-</span>e $<span class="token punctuation">{<!-- --></span>devtype<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{<!-- --></span>distro_bootpart<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>prefix<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>script<span class="token punctuation">}</span><span class="token punctuation">;</span> then echo Found <span class="token constant">U</span><span class="token operator">-</span>Boot script $<span class="token punctuation">{<!-- --></span>prefix<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>script<span class="token punctuation">}</span><span class="token punctuation">;</span> run boot_a_script<span class="token punctuation">;</span> echo <span class="token constant">SCRIPT</span> <span class="token constant">FAILED</span><span class="token operator">:</span> continuing<span class="token operator">...</span><span class="token punctuation">;</span> fi<span class="token punctuation">;</span> done
scriptaddr<span class="token operator">=</span><span class="token number">0x90000000</span>
serverip<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.9</span><span class="token number">.119</span>
soc<span class="token operator">=</span>tegra210
stderr<span class="token operator">=</span>serial
stdin<span class="token operator">=</span>serial
stdout<span class="token operator">=</span>serial
<span class="token comment">//从usb启动</span>
usb_boot<span class="token operator">=</span>run boot_pci_enum<span class="token punctuation">;</span> usb start<span class="token punctuation">;</span> <span class="token keyword">if</span> usb dev $<span class="token punctuation">{<!-- --></span>devnum<span class="token punctuation">}</span><span class="token punctuation">;</span> then devtype<span class="token operator">=</span>usb<span class="token punctuation">;</span> run scan_dev_for_boot_part<span class="token punctuation">;</span> fi
vendor<span class="token operator">=</span>nvidia
xusb_fw_addr<span class="token operator">=</span><span class="token number">92</span>ca828c

Environment size<span class="token operator">:</span> <span class="token number">5340</span><span class="token operator">/</span><span class="token number">8188</span> bytes
</code></pre> 
<h4><a id="_535"></a>加载内核启动</h4> 
<h5><a id="1_537"></a>1.传统加载内核方式</h5> 
<h5><a id="2_539"></a>2.从应用层加载内核</h5> 
<pre><code>把内核放到文件系统中  /boot/Image //在应用层 ，可像普通文件一样更新内核
</code></pre> 
<h5><a id="3_545"></a>*3.实现原理</h5> 
<pre><code class="prism language-javascript">extlinux启动 <span class="token comment">//从文件系统中加载内核启动</span>
     <span class="token comment">//u-boot -&gt; 从sd卡加载 初始小文件系统(ramdisk) -&gt;  再从该文件系统里加载 kernel. 和挂载rootfs </span>
             
extlinux<span class="token punctuation">.</span>conf <span class="token comment">/*启动配置文件 
注意：u-boot 通过 /boot/extlinux/extlinux.conf 里指定加载的内核，和挂载根文件系统的位置

LABEL primary
      MENU LABEL primary kernel
      LINUX /boot/Image      //指定启动的内核名
      INITRD /boot/initrd    //指定初始ramdisk（u-boot加载内核用） 
      APPEND ${cbootargs} rootfstype=ext4 root=/dev/mmcblk0p1 rw rootwait //指定文件系统 
      

root=/dev/mmcblk0p1 指定要挂载的根文件系统的位置 是sd卡的第一个分区
mmcblk 指“ flash/sd块设备”，0 是设备的顺序编号，p1 就是第一个分区。  
sda 是硬盘的命名规则，很多U盘 硬件 ext2格式的文件系统都是按这个去分区
sda表示第一块硬盘 sda1表示第一个分区， sdb表示第二块硬盘      
      
*/</span>

为何需要 extlinux <span class="token comment">/*目的是能把内核镜像，放在文件系统中，u-boot可以读取，
替换方便，可远程登录板子，可像普通文件一样替换内核即可

传统方式，是u-boot 是加载内核后，才能看到文件系统， 
如要更改，要用脚本刷分区才行。
如 sudo ./flash.sh -k LNX jetson-nano-qspi-sd mmcblk0p1
 */</span>
</code></pre> 
<h4><a id="U_577"></a>虚拟机里：更改U盘分区信息</h4> 
<pre><code class="prism language-javascript">把sd卡通过读卡器，接入虚拟机里。
$ cd <span class="token operator">/</span>media<span class="token operator">/</span>yhai<span class="token operator">/</span>b1c100cd<span class="token operator">-</span>cc74<span class="token operator">-</span><span class="token number">4e7</span>f<span class="token operator">-</span>acb8<span class="token operator">-</span>f0d34c931ee8<span class="token operator">/</span>  <span class="token comment">//接入虚拟机后自动识别的目录</span>
yhai@yhai<span class="token operator">:</span><span class="token operator">~</span>$ sudo parted <span class="token operator">/</span>dev<span class="token operator">/</span>sdc <span class="token comment">/*查看分区表
编号  起始点  结束点  大小    文件系统  名称     标志
 2    1049kB  1180kB  131kB             TBC
 3    2097kB  2556kB  459kB             RP1
 4    3146kB  3736kB  590kB             EBT
 5    4194kB  4260kB  65.5kB            WB0
 6    5243kB  5439kB  197kB             BPF
 7    6291kB  6685kB  393kB             BPF-DTB
 8    7340kB  7406kB  65.5kB            FX
 9    8389kB  8847kB  459kB             TOS
10    9437kB  9896kB  459kB             DTB //设备树
11    10.5MB  11.3MB  786kB             LNX //u-boot
12    11.5MB  11.6MB  65.5kB            EKS
13    12.6MB  12.8MB  197kB             BMP
14    13.6MB  13.8MB  131kB             RP4
 1    14.7MB  128GB   128GB   ext4      APP  //存放 rootfs（app的存储场所）
*/</span>
	
$ sudo boot<span class="token operator">/</span>extlinux<span class="token operator">/</span>extlinux<span class="token punctuation">.</span>conf <span class="token comment">/*更改启动分区
   把 root=/dev/mmcblk0p1
   改为 root=/dev/sda1      
   mmcblk 指“ flash/sd块设备”，0 是设备的顺序编号，p1 就是第一个分区。  
   sda 是硬盘的命名规则，很多U盘 硬件 ext2格式的文件系统都是按这个去分区
   sda表示第一块硬盘 sda1表示第一个分区， sdb表示第二块硬盘
 */</span>
</code></pre> 
<h4><a id="U_609"></a>板子上:设置从U盘启动</h4> 
<pre><code class="prism language-javascript">插入到板子<span class="token constant">USB</span> 
# run usb_boot  <span class="token comment">//从u盘启动</span>
# setenv bootcmd run usb_boot <span class="token comment">//设置自动启动从u盘启动</span>
# saveenv 
# reset  <span class="token comment">//复位后 发现能成功从U盘启动了</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/acbe03f03ed74a0ce0d3b300efb4e235/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android源码环境搭建（aosp Ubuntu 16.04）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/949cddde85fde0205969ab723ef3ee43/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">新手学编程必会的100个代码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>