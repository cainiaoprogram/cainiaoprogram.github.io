<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>记录一下学习EFCore中的基础知识 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="记录一下学习EFCore中的基础知识" />
<meta property="og:description" content="安装dotnet-ef工具 dotnet-ef是对.Net命令行工具dotnet 的扩展， 例如创建并应用从旧模型到新模型的迁移，以及从现有数据库模型生成代码 命令如下 检查是否安装dotnet-ef为全局工具
dotnet tool list --global卸载现有版本
dotnet tool uninstall --global dotnet ef安装最新版本
dotnet tool install --global dotnet-ef安装指定版本
dotnet tool install --global dotnet-ef --version 5.0.0安装SqlServer的 NuGet包
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
同样添加 指定版本的包 需要末尾添加 --version 5.0.0安装设计包（用于迁移）
dotnet add package Microsoft.EntityFrameworkCore.Design CodeFirst模式定义EF Core 模型 EFCore使用约定、注解特性和Fluent API语句的结合，在运行时构建实体模型。 实体类表示表的结构，类的实例表示表中的一行 EF Core 约定 我们编写的代码都需要遵循以下约定
表的名称与 DBContext类（例如Products类）中的DbSet属性名匹配数据库列的名称与类中的属性名匹配，例如ProductID假定.Net类型为string 是数据库的 nvarchar类型对于名为ID的属性，如果类名为Product,就可以将此属性重命名为ProductID,那么这个属性是主键 EF Core 注解特性 约定通常不足以将类完全映射到数据库 可以向模型添加更多只能特性的简单方法就是应用注解特性 例如数据库中的名称中的最大长度为 40个字符，并不能为空
ProductName NVARCHAR(40) NOT NULL Description &#34;NTEXT&#34; 在类中，可以应用特性来指定名称的长度和不能为空" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/621a282962f701b37585ae9f363e1b39/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-27T21:29:44+08:00" />
<meta property="article:modified_time" content="2022-08-27T21:29:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">记录一下学习EFCore中的基础知识</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="dotnetef_1"></a>安装dotnet-ef工具</h3> 
<pre><code>dotnet-ef是对.Net命令行工具dotnet 的扩展，
例如创建并应用从旧模型到新模型的迁移，以及从现有数据库模型生成代码
</code></pre> 
<h4><a id="_4"></a>命令如下</h4> 
<ul><li>检查是否安装dotnet-ef为全局工具<br> <code>dotnet tool list --global</code></li><li>卸载现有版本<br> <code>dotnet tool uninstall --global dotnet ef</code></li><li>安装最新版本<br> <code>dotnet tool install --global dotnet-ef</code></li><li>安装指定版本<br> <code>dotnet tool install --global dotnet-ef --version 5.0.0</code></li><li>安装SqlServer的 NuGet包<br> <code>dotnet add package Microsoft.EntityFrameworkCore.SqlServer</code><br> <code>同样添加 指定版本的包 需要末尾添加 --version 5.0.0</code></li><li>安装设计包（用于迁移）<br> <code>dotnet add package Microsoft.EntityFrameworkCore.Design</code></li></ul> 
<h3><a id="CodeFirstEF_Core__18"></a>CodeFirst模式定义EF Core 模型</h3> 
<pre><code>EFCore使用约定、注解特性和Fluent API语句的结合，在运行时构建实体模型。
实体类表示表的结构，类的实例表示表中的一行
</code></pre> 
<h4><a id="EF_Core__21"></a>EF Core 约定</h4> 
<p>我们编写的代码都需要遵循以下约定</p> 
<ul><li>表的名称与 DBContext类（例如Products类）中的DbSet属性名匹配</li><li>数据库列的名称与类中的属性名匹配，例如ProductID</li><li>假定.Net类型为string 是数据库的 nvarchar类型</li><li>对于名为ID的属性，如果类名为Product,就可以将此属性重命名为ProductID,那么这个属性是主键</li></ul> 
<h4><a id="EF_Core__28"></a>EF Core 注解特性</h4> 
<pre><code>约定通常不足以将类完全映射到数据库
可以向模型添加更多只能特性的简单方法就是应用注解特性
</code></pre> 
<p>例如数据库中的名称中的最大长度为 40个字符，并不能为空</p> 
<pre><code class="prism language-sql">ProductName NVARCHAR<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
Description <span class="token string">"NTEXT"</span>
</code></pre> 
<p>在类中，可以应用特性来指定名称的长度和不能为空</p> 
<pre><code class="prism language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StringLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ProductName <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<p>.NET类型和数据库类型之间没有明显的映射时，可以使用特性加上映射关系</p> 
<pre><code class="prism language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Column</span><span class="token attribute-arguments"><span class="token punctuation">(</span>TypeName <span class="token operator">=</span> <span class="token string">"ntext"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Description <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://docs.microsoft.com/zh-cn/ef/core/modeling/entity-properties?tabs=data-annotations%2Cwithout-nrt" rel="nofollow">官方文档</a></p> 
<h4><a id="EF_Core_Fluent_API_53"></a>EF Core Fluent API</h4> 
<pre><code>使用Fluent API可以替代注解特性，也可以用来作为特性的补充
使用Fluent API具有绝对的优先级
</code></pre> 
<p>将注解特性在数据库上下文类的onModelCreating方法中替换为等效的FluentAPI语句<br> 比如:</p> 
<pre><code class="prism language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StringLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ProductName <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<p>可以替换为</p> 
<pre><code class="prism language-csharp">modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Procuct<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>procucts <span class="token operator">=&gt;</span> procucts<span class="token punctuation">.</span>ProductName<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_72"></a>数据播种</h4> 
<pre><code>可以使用Fluent API提供初始数据以填充数据库
</code></pre> 
<p>例如如果想要确保新数据库在Product表中至少有一行，调用HasData方法</p> 
<pre><code class="prism language-csharp">modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">HasData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Procuct</span><span class="token punctuation">{<!-- --></span>ProcuctID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>ProcuctName <span class="token operator">=</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>Cost <span class="token operator">=</span> <span class="token number">8.99M</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><a href="https://docs.microsoft.com/en-us/ef/core/modeling/data-seeding" rel="nofollow">官网链接</a></p> 
<h4><a id="_81"></a>创建实体类(产品和产品类别)</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>ComponentModel<span class="token punctuation">.</span>DataAnnotations</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>ComponentModel<span class="token punctuation">.</span>DataAnnotations<span class="token punctuation">.</span>Schema</span><span class="token punctuation">;</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 类别</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Category</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Key</span></span><span class="token punctuation">]</span> <span class="token comment">//主键</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> categoryID<span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span> <span class="token punctuation">;</span> <span class="token keyword">set</span> <span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> categoryName<span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span> <span class="token punctuation">;</span> <span class="token keyword">set</span> <span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Column</span><span class="token attribute-arguments"><span class="token punctuation">(</span>TypeName <span class="token operator">=</span><span class="token string">"ntext"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">//定义类型为 NTEXT</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">decimal</span><span class="token punctuation">?</span></span> Description<span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span> <span class="token punctuation">;</span> <span class="token keyword">set</span> <span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 定义导航属性,一对多定义  virtual定义可以使用延迟加载   允许继承覆盖属性并提供额外的特性</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;value&gt;&lt;/value&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>Procuct<span class="token punctuation">&gt;</span></span> Procucts <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Category</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//若要使开发人员能够将产品添加到类别，我们必须将导航属性初始化为空集合</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Procucts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HashSet<span class="token punctuation">&lt;</span>Procuct<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 产品</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Procuct</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Key</span></span><span class="token punctuation">]</span> <span class="token comment">//这里可以不用声明 因为类目加 ID默认就是主键</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ProcuctID <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StringLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ProcuctName <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Column</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"UnitPrice"</span><span class="token punctuation">,</span>TypeName <span class="token operator">=</span><span class="token string">"money"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>  <span class="token comment">//将属性命名为 UnitPrice  类型为 money</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">decimal</span><span class="token punctuation">?</span></span> Cost <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Column</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"UnitsInStock"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">short</span><span class="token punctuation">?</span></span> Stock <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> Discoutinued <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> categoryID <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 允许覆盖属性 提供额外的特性</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;value&gt;&lt;/value&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Category</span> Category <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="DBContext_139"></a>创建DBContext上下文类</h4> 
<p>上下文类必须继承 DbContext类，并且在类中声明实体的DbSet属性</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDBContext</span> <span class="token punctuation">:</span><span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Procuct<span class="token punctuation">&gt;</span></span> procucts <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span> categories <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnConfiguring</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptionsBuilder</span> optionsBuilder<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//server=LAPTOP-89N28DCH;database = 数据库名称;uid=;pwd=</span>
        optionsBuilder<span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span><span class="token string">"Server=jlf;Database=CodeFirstTest;Trusted_Connection=True;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Window身份验证</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> modelBuilder<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//这里写 Fluent API语句</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_159"></a>迁移</h4> 
<h5><a id="_160"></a>迁移常用命令</h5> 
<table><thead><tr><th>VSCode迁移命令</th><th>VS 迁移命令</th><th>说明</th></tr></thead><tbody><tr><td>dotnet ef migrations add InitialCreate</td><td>Add-Migration InitialCreate</td><td>添加迁移信息 ,在项目中创建一个名为“Migrations”的目录，并生成一些文件</td></tr><tr><td>dotnet ef database update</td><td>Update-Database</td><td>将最近添加的迁移执行到数据库</td></tr><tr><td>dotnet ef migrations remove</td><td>Remove-Migration</td><td>将最近的的迁移删除(应避免将已更新数据库的迁移删除)</td></tr><tr><td>dotnet ef dbcontext info</td><td></td><td>获取DBContext上下文信息</td></tr><tr><td>dotnet ef migrations list</td><td>Get-Migration</td><td>列出所有迁移</td></tr></tbody></table> 
<h5><a id="_168"></a>使用迁移</h5> 
<pre><code>dotnet ef migrations add InitialCreate
</code></pre> 
<p>在终端执行以上命令生成迁移后会生成以下几个迁移信息文件<br> <img src="https://images2.imgbox.com/2e/4c/iKu1Bvrs_o.png" alt=""></p> 
<pre><code>dotnet ef database update
</code></pre> 
<p>这时执行update命令即可将迁移执行到数据库<br> <img src="https://images2.imgbox.com/34/63/D6GrFWRx_o.png" alt="在这里插入图片描述"><br> 后续在开发过程中必然会更改实体模型，按照以上步骤先 add 后 update更新数据库</p> 
<h3><a id="DBFirst_177"></a>使用DBFirst方式构建模型(反向工程)</h3> 
<p>这时需要先创建数据库表!<br> Category产品类别 &amp; Products 产品</p> 
<p>然后看下边的语句</p> 
<pre><code>dotnet ef dbcontext scaffold 
"Server=jlf;Database=Test;Trusted_Connection=True;"   //数据库连接字符串，在构建语句直接声明，系统会警告不安全，应把连接字符串放到web.config里
Microsoft.EntityFrameworkCore.SqlServer  //数据库提供者
--table Categories --table Products //需要生成那些表
--output-dir AutoGenModels  //生成的文件夹
--namespace WorkingWithEFCore.AutoGenModels //命名空间
--data-annotations  //使用数据注解和FluentAPI
--context MyContext //上下文别名
</code></pre> 
<p><img src="https://images2.imgbox.com/03/07/w9DgzAlU_o.png" alt="在这里插入图片描述"><br> 这时可以看到，AutoGenModels文件夹中生成了三个文件，包括上下文<br> 需要注意:</p> 
<ul><li>EFCore使用InverseProperty属性来表示外键</li><li>EFCore中INDEX特性来指明那些字段拥有索引</li><li>dotnet-ef目前不能使用可空引用类型</li><li>类是使用 partial声明的，这样就可以通过创建partial类来添加额外的代码</li></ul> 
<h3><a id="EFCore_202"></a>查询EFCore模型</h3> 
<p><em>现在有了使用SqlServer数据库映射来的模型，可以使用一些简单的linq查询来获取数据了</em></p> 
<h4><a id="_204"></a>简单查询实体</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>

<span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span> cats <span class="token operator">=</span> db<span class="token punctuation">.</span>Categories<span class="token punctuation">;</span> 
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Category</span>  item <span class="token keyword">in</span> cats<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>CategoryName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用using对上下文类进行封装</p> 
<h4><a id="_218"></a>查询导航属性</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span> cats <span class="token operator">=</span> db<span class="token punctuation">.</span>Categories<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>c<span class="token operator">=&gt;</span>c<span class="token punctuation">.</span>Products<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用 Include 访问Categories类中的导航属性Products</span>
   <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Category</span>  item <span class="token keyword">in</span> cats<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">item<span class="token punctuation">.</span>CategoryName</span><span class="token punctuation">}</span></span><span class="token string"> 类别有 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">item<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> 个产品"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>获取实体时 只是 db.Categories获取不到实体中的导航属性，也就是外键关系的表的数据，需要使用 Include 来获取</p> 
<h6><a id="_230"></a>过滤导航属性中的数据</h6> 
<blockquote> 
 <p>IQueryable cats = db.Categories.Include(c =&gt; c.Products.Where(p =&gt; p.UnitsInStock &gt; 100)); //过滤产品中的库存数据 &gt;100</p> 
</blockquote> 
<h4><a id="_232"></a>排序和过滤</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token class-name"><span class="token keyword">decimal</span></span> price <span class="token operator">=</span> <span class="token number">100.23M</span><span class="token punctuation">;</span>
   <span class="token comment">//过滤UnitPrice大于100的数据，并根据UnitPrice倒序排序</span>
   <span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span></span> products <span class="token operator">=</span> db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>UnitPrice <span class="token operator">&gt;</span> price<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">OrderByDescending</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>UnitPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> products<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">item<span class="token punctuation">.</span>ProductId</span><span class="token punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">item<span class="token punctuation">.</span>ProductName</span><span class="token punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">item<span class="token punctuation">.</span>UnitPrice</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="SQLEFCore_50_244"></a>获取生成的SQL(EFCore 5.0)</h4> 
<p>在上边方法中加入 以下代码输出生成的SQL</p> 
<pre><code class="prism language-csharp">System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>products<span class="token punctuation">.</span><span class="token function">ToQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>控制台输入的就是查询的sql<br> <img src="https://images2.imgbox.com/90/98/bcW1YFRX_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="EFCore_251"></a>记录EFCore操作</h4> 
<ul><li>定义两个类，一个实现 ILoggerProvider 接口，一个实现ILogger接口</li><li>各自实现接口的方法</li><li>ConsoleLoggerProvider类会返回ConsoleLogger实例，因此没有任何非托管资源，Dispose不需要实现</li><li>ConsoleLogger 类的log方法将日志写入控制台</li></ul> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Logging</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsoleLoggerProvider</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ILoggerProvider</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//创建</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ILogger</span> <span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> categoryName<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConsoleLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//throw new NotImplementedException();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsoleLogger</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ILogger</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//开启逻辑操作的作用域</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IDisposable</span> <span class="token generic-method"><span class="token function">BeginScope</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TState<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TState</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//检查是否启用了给定的 logLevel。 （那些日志信息需要跟踪）本方法将 Trace Information None 排除</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span> logLevel<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>logLevel<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> LogLevel<span class="token punctuation">.</span>Trace<span class="token punctuation">:</span> <span class="token comment">//日志的详细信息 ? </span>
            <span class="token keyword">case</span> LogLevel<span class="token punctuation">.</span>Information<span class="token punctuation">:</span>  <span class="token comment">//跟踪应用程序的常规流的日志</span>
            <span class="token keyword">case</span> LogLevel<span class="token punctuation">.</span>None<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> LogLevel<span class="token punctuation">.</span>Debug<span class="token punctuation">:</span>
            <span class="token keyword">case</span> LogLevel<span class="token punctuation">.</span>Warning<span class="token punctuation">:</span> <span class="token comment">//</span>
            <span class="token keyword">case</span> LogLevel<span class="token punctuation">.</span>Error<span class="token punctuation">:</span> <span class="token comment">//错误</span>
            <span class="token keyword">case</span> LogLevel<span class="token punctuation">.</span>Critical<span class="token punctuation">:</span> <span class="token comment">// 描述不可恢复的应用程序或系统崩溃或灾难性事件的日志 需要立即关注的故障</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 写入日志 这里暂时控制台输出  应该写入文件</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="logLevel"&gt;日志级别 LogLevel 枚举中的值&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="eventId"&gt;事件ID  比如LINQ转SQL查询的事件ID是 20100&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="state"&gt;要写入的条目&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="exception"&gt;与此条目相关的异常&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="formatter"&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;typeparam name="TState"&gt;&lt;/typeparam&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">Log</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TState<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span> logLevel<span class="token punctuation">,</span> <span class="token class-name">EventId</span> eventId<span class="token punctuation">,</span> <span class="token class-name">TState</span> state<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>TState<span class="token punctuation">,</span> Exception<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> formatter<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//if(eventId.Id = 20100)  可以指定事件去处理日志，20100是linq转sql</span>
        System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"级别:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">logLevel</span><span class="token punctuation">}</span></span><span class="token string"> 事件ID:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">eventId<span class="token punctuation">.</span>Id</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"状态：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">state</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"异常：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">state</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后在数据库上下文的using快中添加语句获取日志工厂，并注册自定义控制台日志记录器</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Logging</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore<span class="token punctuation">.</span>Infrastructure</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection</span><span class="token punctuation">;</span>

<span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       <span class="token class-name"><span class="token keyword">var</span></span> loggerFactory <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ILoggerFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建日志工厂</span>
       loggerFactory<span class="token punctuation">.</span><span class="token function">AddProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConsoleLoggerProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//注册自定义日志方法</span>
       <span class="token comment">///下边 写排序或者过滤之类的LINQ方法</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_334"></a>使用查询标记进行日志批注</h5> 
<pre><code class="prism language-csharp"><span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span></span> products <span class="token operator">=</span> db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">TagWith</span><span class="token punctuation">(</span><span class="token string">"日志记录"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>UnitPrice <span class="token operator">&gt;</span> price<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">OrderByDescending</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>UnitPrice<span class="token punctuation">)</span>
</code></pre> 
<p>EF Core2.2引入了查询标记特性，以允许向日志中添加SQL注释</p> 
<h4><a id="_LIKE_341"></a>模式匹配 LIKE</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// var loggerFactory = db.GetService&lt;ILoggerFactory&gt;();</span>
    <span class="token comment">// loggerFactory.AddProvider(new ConsoleLoggerProvider());  //注册日志</span>

    System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"输入产品名称:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> input <span class="token operator">=</span> Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span></span> products <span class="token operator">=</span> db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> EF<span class="token punctuation">.</span>Functions<span class="token punctuation">.</span><span class="token function">Like</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>ProductName<span class="token punctuation">,</span><span class="token interpolation-string"><span class="token string">$"%</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">input</span><span class="token punctuation">}</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> products<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"id:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">item<span class="token punctuation">.</span>ProductId</span><span class="token punctuation">}</span></span><span class="token string">,名称:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">item<span class="token punctuation">.</span>ProductName</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>提示用户输入产品名称，然后使用 EF.Functions.Like 方法搜索 p.ProductName 属性的任何位置</p> 
<h4><a id="_358"></a>定义全局过滤器</h4> 
<pre><code class="prism language-csharp">modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasQueryFilter</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>ProductName<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">"Chang"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在数据库上下文的OnModelCreating方法中声明以下语句，过滤出Product中的ProductName中包含Chang的数据<br> 这时再执行上边的模糊查询，同时也会筛选条件内数据</p> 
<p><img src="https://images2.imgbox.com/a4/fe/1uOJ7lZI_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="EFCore_367"></a>EFCore加载模式</h4> 
<blockquote> 
 <p>EFCore通常使用三种加载模式：延迟加载、立即加载、显示加载</p> 
</blockquote> 
<h5><a id="_369"></a>立即加载实体</h5> 
<blockquote> 
 <p>立即加载就是将实体类中的相关数据（包括外键表）一次性查询出来<br> 使用Include查询可以实现立即加载</p> 
</blockquote> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span> cats <span class="token operator">=</span> db<span class="token punctuation">.</span>Categories<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>c<span class="token operator">=&gt;</span>c<span class="token punctuation">.</span>Products<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用 Include 访问Categories类中的导航属性Products</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Category</span>  item <span class="token keyword">in</span> cats<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">item<span class="token punctuation">.</span>CategoryName</span><span class="token punctuation">}</span></span><span class="token string"> 类别有 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">item<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> 产品"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以将Include方法后的代码注释一下执行看，这里查询是获取不到导航属性的</p> 
<h5><a id="_382"></a>延迟加载</h5> 
<blockquote> 
 <p>延迟加载: 每当我们尝试读取导航属性时,延迟加载将检查它们是否已加载，如果没有加载，就立即执行sql语句加载它们，将当前的导航属性加载出，其余导航属性不动，然后返回导航属性查出来的数据</p> 
</blockquote> 
<h6><a id="__387"></a>使用代理的延迟加载 (全局)</h6> 
<blockquote> 
 <p>使用全局代理的延迟加载，必须每个导航属性带有 virtual修饰<br> public virtual Category Category { get; set ; }</p> 
</blockquote> 
<ul><li>为代理引用NuGet包</li></ul> 
<pre><code class="prism language-csharp">dotnet <span class="token keyword">add</span> package Microsoft<span class="token punctuation">.</span>EntityFrameworkCore<span class="token punctuation">.</span>Proxies <span class="token operator">--</span>version <span class="token number">5.0</span><span class="token number">.0</span>
</code></pre> 
<ul><li>配置延迟代理以使用代理<br> <img src="https://images2.imgbox.com/1d/f1/eic7Maqo_o.png" alt=""><br> 在数据库上下文OnConfiguring中输入 optionsBuilder.UseLazyLoadingProxies()</li><li>使用时应该避免使用循环处理导航属性<br> 避免使用下边注释的代码循环处理导航属性，应一次性将数据取出，防止多次循环数据库</li></ul> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span> cats <span class="token operator">=</span> db<span class="token punctuation">.</span>Categories<span class="token punctuation">;</span>     <span class="token comment">//.Include(c=&gt;c.Products); //使用 Include 访问Categories类中的导航属性Products</span>
   <span class="token class-name">ICollection<span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> cats<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Products<span class="token punctuation">;</span>
   <span class="token comment">// var product = items.Products;</span>
   <span class="token comment">// foreach (Category  item in cats)</span>
   <span class="token comment">// {<!-- --></span>
   <span class="token comment">//     System.Console.WriteLine($"{item.CategoryName} 类别有 {item.Products.Count} 产品");</span>
   <span class="token comment">// }</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_411"></a>不使用代理的延迟加载</h6> 
<ul><li> <p>使用依赖注入的方式为单个对象使用延迟加载,这里的导航属性没有必须使用virtual修饰</p> </li><li> <p>首先需要导入Abstractions包</p> </li><li> <p>然后将ILazyLoader 注入到类中，使用LazyLoader .Load()方法检查实体，并在使用时更新实体数据，将实体使用ref 引用出</p> <pre><code> dotnet add package Microsoft.EntityFrameworkCore.Abstractions --version 5.0.0
</code></pre> </li></ul> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore<span class="token punctuation">.</span>Infrastructure</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Blog</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">ICollection<span class="token punctuation">&lt;</span>Post<span class="token punctuation">&gt;</span></span> _posts<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Blog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">Blog</span><span class="token punctuation">(</span><span class="token class-name">ILazyLoader</span> lazyLoader<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        LazyLoader <span class="token operator">=</span> lazyLoader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token return-type class-name">ILazyLoader</span> LazyLoader <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>Post<span class="token punctuation">&gt;</span></span> Posts
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">get</span> <span class="token operator">=&gt;</span> LazyLoader<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">ref</span> _posts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">set</span> <span class="token operator">=&gt;</span> _posts <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Post</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Blog</span> _blog<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token class-name">ILazyLoader</span> lazyLoader<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        LazyLoader <span class="token operator">=</span> lazyLoader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token return-type class-name">ILazyLoader</span> LazyLoader <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Content <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Blog</span> Blog
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">get</span> <span class="token operator">=&gt;</span> LazyLoader<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">ref</span> _blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">set</span> <span class="token operator">=&gt;</span> _blog <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里借用 <a href="https://docs.microsoft.com/zh-cn/ef/core/querying/related-data/lazy" rel="nofollow">官网</a>的例子</p> 
<h5><a id="_474"></a>显示加载</h5> 
<blockquote> 
 <p>显示加载与延迟加载的工作方式类似，不同之处在于显示加载可以控制加载那些相关数据以及何时加载</p> 
</blockquote> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   	<span class="token class-name">IQueryable<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span> cats <span class="token operator">=</span> db<span class="token punctuation">.</span>Categories<span class="token punctuation">;</span>
    db<span class="token punctuation">.</span>ChangeTracker<span class="token punctuation">.</span>LazyLoadingEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//禁用延迟加载</span>
    
    <span class="token comment">//返回唯一元素 (如果存在多个则会异常)</span>
    <span class="token class-name"><span class="token keyword">var</span></span> categorySingle <span class="token operator">=</span> db<span class="token punctuation">.</span>Categories<span class="token punctuation">.</span><span class="token function">Single</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>CategoryName <span class="token operator">==</span> <span class="token string">"Beverages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Entry:获取提供的实体，提供对实体操作的跟踪</span>
    <span class="token comment">/// Collection :将此实体与其他实体相关联的属性</span>
    <span class="token comment">/// Load 加载实体中的数据 </span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    db<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>categorySingle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Collection</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>Products<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">categorySingle<span class="token punctuation">.</span>CategoryName</span><span class="token punctuation">}</span></span><span class="token string"> has </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">categorySingle<span class="token punctuation">.</span>Products<span class="token punctuation">.</span>Count</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>显示加载主要在于Load方法</p> 
<pre><code class="prism language-csharp"> <span class="token comment">/// &lt;summary&gt;</span>
 <span class="token comment">///categorySingle 提供一个符合条件的实体</span>
<span class="token comment">/// Entry:获取提供的实体，提供对实体操作的跟踪</span>
<span class="token comment">/// Collection :将此实体与其他实体相关联的属性</span>
<span class="token comment">/// Load 加载实体中的数据 </span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
db<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>categorySingle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Collection</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>Products<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><a href="https://docs.microsoft.com/zh-cn/ef/core/querying/related-data/explicit?source=recommendations" rel="nofollow">官网</a></p> 
<h3><a id="EF_Core__508"></a>使用EF Core 操作数据</h3> 
<blockquote> 
 <p>操作数据就相对简单了很多，DbContext能够自动维护更改和跟踪，因此本地实体可以跟踪多个更改，包括添加新实体，修改实体和删除实体</p> 
</blockquote> 
<h5><a id="_510"></a>插入实体</h5> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Product</span><span class="token punctuation">{<!-- --></span>
         ProductId <span class="token operator">=</span> <span class="token number">78</span><span class="token punctuation">,</span>
         ProductName <span class="token operator">=</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>
         UnitPrice <span class="token operator">=</span> <span class="token number">2.3M</span>
     <span class="token punctuation">}</span><span class="token punctuation">;</span>
     db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"新增成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_526"></a>修改实体</h5> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Product</span> updateProduct <span class="token operator">=</span> db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>ProductName <span class="token operator">==</span><span class="token string">"Chang"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    updateProduct<span class="token punctuation">.</span>UnitPrice <span class="token operator">+=</span> <span class="token number">1M</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"修改成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_537"></a>删除实体</h5> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   	<span class="token class-name">Product</span> updateProduct <span class="token operator">=</span> db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>ProductName<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">RemoveRange</span><span class="token punctuation">(</span>updateProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> affected <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>affected <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"删除成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_550"></a>池化数据库上下文</h5> 
<p><a href="https://docs.microsoft.com/en-us/ef/core/what-is-new/ef-core-2.0/#dbcontext-pooling" rel="nofollow">官网介绍</a></p> 
<h5><a id="_552"></a>事务</h5> 
<blockquote> 
 <p>每次调用 SaveChanges方法时，都会启动隐式事务,以便出现问题时回滚所有的修改<br> 事务通过应用锁来防止在发生一系列更改时进行读写操作,从而维护数据库的完整性</p> 
</blockquote> 
<h6><a id="_555"></a>定义显示事务</h6> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name">IDbContextTransaction</span> t <span class="token operator">=</span> db<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//开始事务</span>
        <span class="token class-name">Product</span> updateProduct <span class="token operator">=</span> db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>ProductName<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">RemoveRange</span><span class="token punctuation">(</span>updateProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> affected <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//提交事务</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>affected <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"删除成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://docs.microsoft.com/zh-cn/ef/core/saving/transactions" rel="nofollow">官方说明</a></p> 
<p>该文章是学习过程中的记录，知识基本都摘自书中<br> 还望指点错误，以及其他应学习知识点 !</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d098bd5213a785f2f08713a9968117bc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">QtcpSocket readyRead 粘包解法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/064fba870845b245d1408d198befc13a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">用Python做一款自己的TK创建器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>