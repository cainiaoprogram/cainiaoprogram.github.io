<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>阿里云RDS监控可以不那么“难看”【实操系列】 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="阿里云RDS监控可以不那么“难看”【实操系列】" />
<meta property="og:description" content="文章目录 1. 工具收集阶段1.1 Prometheus&#43;Grafana环境部署1.2 阿里云RDS（mysqld）相关监控1.3 资源监控1.3.1 重新打包Dockerfile1.3.2 修改bug配置1.3.3 启动docker1.3.4 Grafana配置图 2. 工具组合2.1 架构图2.2 supervisor&#43;mysqld_exporter2.3 prometheus服务发现2.4 最后一哆嗦 3. 简单效果展示4. 遗憾 云厂商可以帮助我们解决8-90%的“脏乱臭”的活，方便的不要不要的，当然也是有得有失吧。但个人觉得 RDS监控用起来确实有点不是太方便，自然要想办法改善使用。 Prometheus&#43;Grafana，这套万金流自然首当其冲（有的人喜欢zabbix，都可以，仁者见仁）
1. 工具收集阶段 1.1 Prometheus&#43;Grafana环境部署 此处不做过多赘述，网上文章很多。推荐电子书链接：prometheus-book
1.2 阿里云RDS（mysqld）相关监控 MySQL数据采集工具：mysqld_exporter，此工具也是prometheus官方工具下载地址。
部署也相当简单，创建好采集MySQL数据需要的用户，以及选择需要采集的指标，直接启动即可，如：
export DATA_SOURCE_NAME=&#39;user:password@(hostname:3306)/&#39; ./mysqld_exporter &lt;flags&gt; 1.3 资源监控 除了RDS（MySQL）本身的一些监控，还需要关注资源的一些信息。如果是自建IDC，肯定是使用node_exporter。
谁让我们使用的是云产品呢，哎～
幸运的是PingCAP的工程师Aylei写了一套aliyun-exporter，原理是调用阿里云API收集监控数据（可以监控ECS、SLB、Redis、Mongodb、RDS等），以prometheus格式存储，同时非常nice的做了非常漂亮的Grafana图。
但是，由于“年久失修”，在使用的时候遇到不少问题，再加上个人代码能力青铜三段，重写有点难，那就硬修吧。以下是在使用时遇到的问题。
1.3.1 重新打包Dockerfile 原因是，pip3 install aliyun-exporter拉的镜像没有SLB的模块（其实这个根RDS监控没什么关系，另一位同事在搞SLB的监控，顺道都修了），人肉了很久，发现github中最新的代码有这个功能。尴尬～想用也只能自己动手了，替换最新的代码文件info_provider.py，重新打包。脚本如下：
$ cat docker.file FROM aylei/aliyun-exporter:0.3.0 RUN pip3 install -U aliyun-exporter==0.3.1 PyYAML==5.1.2 RUN pip3 install aliyun-python-sdk-slb aliyun-python-sdk-dds COPY info_provider.py /usr/local/lib/python3.7/site-packages/aliyun_exporter/info_provider.py # 注意：作者没有把最新的代码打包进docker中，没办法只能我们先去下载代码，然后替换 $ docker build -f docker." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/747d23bc7f30c2adc2ffc9c11a6ada32/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-02-15T17:07:26+08:00" />
<meta property="article:modified_time" content="2020-02-15T17:07:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">阿里云RDS监控可以不那么“难看”【实操系列】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#1__7" rel="nofollow">1. 工具收集阶段</a></li><li><ul><li><a href="#11_PrometheusGrafana_8" rel="nofollow">1.1 Prometheus+Grafana环境部署</a></li><li><a href="#12_RDSmysqld_12" rel="nofollow">1.2 阿里云RDS（mysqld）相关监控</a></li><li><a href="#13__20" rel="nofollow">1.3 资源监控</a></li><li><ul><li><a href="#131_Dockerfile_28" rel="nofollow">1.3.1 重新打包Dockerfile</a></li><li><a href="#132_bug_40" rel="nofollow">1.3.2 修改bug配置</a></li><li><a href="#133_docker_46" rel="nofollow">1.3.3 启动docker</a></li><li><a href="#134_Grafana_50" rel="nofollow">1.3.4 Grafana配置图</a></li></ul> 
   </li></ul> 
   </li><li><a href="#2__54" rel="nofollow">2. 工具组合</a></li><li><ul><li><a href="#21__56" rel="nofollow">2.1 架构图</a></li><li><a href="#22_supervisormysqld_exporter_76" rel="nofollow">2.2 supervisor+mysqld_exporter</a></li><li><a href="#23_prometheus_110" rel="nofollow">2.3 prometheus服务发现</a></li><li><a href="#24__153" rel="nofollow">2.4 最后一哆嗦</a></li></ul> 
   </li><li><a href="#3__166" rel="nofollow">3. 简单效果展示</a></li><li><a href="#4__182" rel="nofollow">4. 遗憾</a></li></ul> 
 </li></ul> 
</div> 
<br> 云厂商可以帮助我们解决8-90%的“脏乱臭”的活，方便的不要不要的，当然也是有得有失吧。但个人觉得 
<strong>RDS监控</strong>用起来确实有点不是太方便，自然要想办法改善使用。 
<p></p> 
<p>Prometheus+Grafana，这套万金流自然首当其冲（有的人喜欢zabbix，都可以，仁者见仁）</p> 
<h3><a id="1__7"></a>1. 工具收集阶段</h3> 
<h4><a id="11_PrometheusGrafana_8"></a>1.1 Prometheus+Grafana环境部署</h4> 
<p>此处不做过多赘述，网上文章很多。推荐电子书链接：<a href="https://yunlzheng.gitbook.io/prometheus-book/" rel="nofollow">prometheus-book</a></p> 
<h4><a id="12_RDSmysqld_12"></a>1.2 阿里云RDS（mysqld）相关监控</h4> 
<p>MySQL数据采集工具：<a href="https://github.com/prometheus/mysqld_exporter">mysqld_exporter</a>，此工具也是prometheus官方工具<a href="https://github.com/prometheus/mysqld_exporter/releases">下载地址</a>。<br> 部署也相当简单，创建好采集MySQL数据需要的用户，以及选择需要采集的指标，直接启动即可，如：</p> 
<pre><code class="prism language-bash"><span class="token function">export</span> DATA_SOURCE_NAME<span class="token operator">=</span><span class="token string">'user:password@(hostname:3306)/'</span>
./mysqld_exporter <span class="token operator">&lt;</span>flags<span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="13__20"></a>1.3 资源监控</h4> 
<p>除了RDS（MySQL）本身的一些监控，还需要关注资源的一些信息。如果是自建IDC，肯定是使用<a href="https://github.com/prometheus/node_exporter">node_exporter</a>。</p> 
<p>谁让我们使用的是云产品呢，哎～</p> 
<p>幸运的是PingCAP的工程师<a href="https://github.com/aylei">Aylei</a>写了一套<a href="https://github.com/aylei/aliyun-exporter">aliyun-exporter</a>，原理是调用<code>阿里云API</code>收集监控数据（可以监控ECS、SLB、Redis、Mongodb、RDS等），以prometheus格式存储，同时非常nice的做了非常漂亮的Grafana图。<br> <strong>但是</strong>，由于“年久失修”，在使用的时候遇到不少问题，再加上个人代码能力青铜三段，重写有点难，那就硬修吧。以下是在使用时遇到的问题。</p> 
<h5><a id="131_Dockerfile_28"></a>1.3.1 重新打包Dockerfile</h5> 
<p>原因是，<code>pip3 install aliyun-exporter</code>拉的镜像没有<code>SLB</code>的模块（其实这个根RDS监控没什么关系，另一位同事在搞SLB的监控，顺道都修了），人肉了很久，发现github中最新的代码有这个功能。尴尬～想用也只能自己动手了，替换最新的代码文件<code>info_provider.py</code>，重新打包。脚本如下：</p> 
<pre><code class="prism language-bash">$ <span class="token function">cat</span> docker.file
FROM aylei/aliyun-exporter:0.3.0
RUN pip3 <span class="token function">install</span> -U aliyun-exporter<span class="token operator">==</span>0.3.1 PyYAML<span class="token operator">==</span>5.1.2
RUN pip3 <span class="token function">install</span>  aliyun-python-sdk-slb aliyun-python-sdk-dds
COPY info_provider.py /usr/local/lib/python3.7/site-packages/aliyun_exporter/info_provider.py <span class="token comment"># 注意：作者没有把最新的代码打包进docker中，没办法只能我们先去下载代码，然后替换</span>


$ docker build -f docker.file -t aliyun-exporter:0.3.1 <span class="token keyword">.</span>
</code></pre> 
<h5><a id="132_bug_40"></a>1.3.2 修改bug配置</h5> 
<p>这个地方应该是一个bug。<br> 首先说明，<code>aliyun_exporter</code>本身是可以获取所有监控信息，也就是说<strong>1.2</strong>中的<code>mysqld_exporter</code>完全可以不需要，<strong>但是</strong>，在实际使用中又发现，如果增加<code>rds_performance</code>的监控项，服务无法启动。所以无奈，对于RDS劲限于做资源监控。</p> 
<p>幸运的是有mysqld_exporter作为补充。</p> 
<h5><a id="133_docker_46"></a>1.3.3 启动docker</h5> 
<pre><code>$ docker run -d  -p 9526:9525  -e "ALIYUN_ACCESS_ID=XXXX" -e "ALIYUN_ACCESS_SECRET=XXXX" -e "ALIYUN_REGION=cn-XXXX"  -v $(pwd)/aliyun-exporter-test.yml:/aliyun-exporter.yml  aliyun-exporter:0.3.1  -p 9525 -c  /aliyun-exporter.yml
</code></pre> 
<h5><a id="134_Grafana_50"></a>1.3.4 Grafana配置图</h5> 
<p>这部分的大小改动也不少：数据源的配置啊、怎么划分部门啊、加标签啊、Alter怎么解决不能给模版加告警啊 等等等等，就不赘述了。具体问题具体分析吧。</p> 
<h3><a id="2__54"></a>2. 工具组合</h3> 
<h4><a id="21__56"></a>2.1 架构图</h4> 
<pre><code class="prism language-bash">+----+
<span class="token operator">|</span>RDS1+---------+
+----+         <span class="token operator">|</span>        ECS
               <span class="token operator">&gt;</span>+----------------------+    +-------------+
  <span class="token keyword">.</span>             <span class="token operator">|</span>  mysqld_exporter     <span class="token operator">|</span>    <span class="token operator">|</span> Prometheus  <span class="token operator">|</span>
  <span class="token keyword">.</span>   +--------<span class="token operator">&gt;</span>+         +            +----<span class="token operator">&gt;</span>      +      <span class="token operator">|</span>
  <span class="token keyword">.</span>             <span class="token operator">|</span>  aliyun_exporter     <span class="token operator">|</span>    <span class="token operator">|</span>   Grafana   <span class="token operator">|</span>
  <span class="token keyword">.</span>            <span class="token operator">&gt;</span>+----------------------+    +-------------+
               <span class="token operator">|</span>
+----+         <span class="token operator">|</span>
<span class="token operator">|</span>RDSn+---------+
+----+

</code></pre> 
<p>如上图，需要一台ECS部署<code>mysqld_exporter</code>和<code>aliyun_exporter</code>进行信息采集，再将采集的信息丢给<code>Prometheus</code></p> 
<h4><a id="22_supervisormysqld_exporter_76"></a>2.2 supervisor+mysqld_exporter</h4> 
<p><code>mysqld_exporter</code>裸跑有点慌。所以使用进程管理工具<code>supervisor</code>协助管理。</p> 
<pre><code class="prism language-bash"><span class="token comment"># 脚本模版</span>
$  <span class="token function">cat</span> mysqld_exporter.xxxx.conf
<span class="token punctuation">[</span>program:xxxx<span class="token punctuation">]</span>
directory <span class="token operator">=</span> /opt/mysqld_exporter
<span class="token function">command</span> <span class="token operator">=</span> /bin/nohup /opt/mysqld_exporter/mysqld_exporter --web.listen-address<span class="token operator">=</span><span class="token punctuation">[</span>IP<span class="token punctuation">]</span>:<span class="token punctuation">[</span>PORT<span class="token punctuation">]</span> --collect.global_status --collect.global_variables --collect.slave_status --collect.binlog_size --collect.engine_innodb_status --collect.info_schema.innodb_metrics --collect.info_schema.innodb_tablespaces --collect.info_schema.processlist --collect.info_schema.tablestats --collect.perf_schema.eventsstatements --collect.perf_schema.eventswaits --collect.perf_schema.file_events
autostart <span class="token operator">=</span> <span class="token boolean">true</span>
startsecs <span class="token operator">=</span> 5
autorestart <span class="token operator">=</span> <span class="token boolean">true</span>
startretries <span class="token operator">=</span> 3
user <span class="token operator">=</span> root
redirect_stderr <span class="token operator">=</span> <span class="token boolean">true</span>
stdout_logfile_maxbytes <span class="token operator">=</span> 20MB
stdout_logfile_backups <span class="token operator">=</span> 20
stdout_logfile <span class="token operator">=</span> /var/log/supervisor/xxxx.log
environment<span class="token operator">=</span>DATA_SOURCE_NAME<span class="token operator">=</span><span class="token string">'user:password@(hostname:3306)/'</span>
</code></pre> 
<p>查看服务</p> 
<pre><code class="prism language-bash">$ supervisorctl status
mysql_xxx_01                  RUNNING   pid 13935, <span class="token function">uptime</span> 4:15:15
mysql_xxx_02                  RUNNING   pid 14053, <span class="token function">uptime</span> 4:15:15
mysql_xxx_03                  RUNNING   pid 13866, <span class="token function">uptime</span> 4:15:15
<span class="token punctuation">..</span>.
</code></pre> 
<h4><a id="23_prometheus_110"></a>2.3 prometheus服务发现</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 主配置文件</span>
$ <span class="token function">cat</span> prometheus.yml
<span class="token punctuation">..</span>.
  - job_name: <span class="token string">'mysqld_exporter'</span>
    file_sd_configs:
    - files:
      - <span class="token string">'/usr/local/prometheus/sd_cfg/mysqld_exporter.yml'</span>
      refresh_interval: 15s
<span class="token punctuation">..</span>.

<span class="token comment"># 服务发现配置文件</span>
$ <span class="token function">cat</span> /usr/local/prometheus/sd_cfg/mysqld_exporter.yml
- labels:
    <span class="token function">alias</span> <span class="token keyword">:</span> <span class="token function">test</span>
    depart <span class="token keyword">:</span> <span class="token string">"TEST"</span>
  targets:
  - <span class="token punctuation">[</span>ECS_IP<span class="token punctuation">]</span>:<span class="token punctuation">[</span>PORT_TEST<span class="token punctuation">]</span>

- labels:
    <span class="token function">alias</span> <span class="token keyword">:</span> qa
    depart <span class="token keyword">:</span> <span class="token string">"QA"</span>
  targets:
  - <span class="token punctuation">[</span>ECS_IP<span class="token punctuation">]</span>:<span class="token punctuation">[</span>PORT_QA<span class="token punctuation">]</span>

- labels:
    <span class="token function">alias</span> <span class="token keyword">:</span> pro1
    depart <span class="token keyword">:</span> <span class="token string">"PRO"</span>
  targets:
  - <span class="token punctuation">[</span>ECS_IP<span class="token punctuation">]</span>:<span class="token punctuation">[</span>PORT_PRO1<span class="token punctuation">]</span>

- labels:
    <span class="token function">alias</span> <span class="token keyword">:</span> pro2
    depart <span class="token keyword">:</span> <span class="token string">"PRO"</span>
  targets:
  - <span class="token punctuation">[</span>ECS_IP<span class="token punctuation">]</span>:<span class="token punctuation">[</span>PORT_PRO2<span class="token punctuation">]</span>
<span class="token punctuation">..</span>.
</code></pre> 
<p>服务发现好处不言而喻，自动加载新增RDS</p> 
<h4><a id="24__153"></a>2.4 最后一哆嗦</h4> 
<p>目前已经完成了阿里云RDS所有层面的监控，难道每次新增一套RDS都要人肉一遍这个流程？显然有点二了。</p> 
<p>只描述思路，就不贴脚本了：</p> 
<ol><li>通过阿里云API，获取所有RDS信息；</li><li>根据获取的信息为每个RDS生成<code>mysqld_exporter</code>启动脚本，并通过<code>supervisor</code>控制自启动；</li><li>根据获取的信息更新<code>sd_cfg/mysqld_exporter.yml</code>，实现服务自发现；</li><li>最后，计划任务定期去扫阿里云API，判断是否有新的RDS创建/删除</li></ol> 
<p>至此，再也不用人肉去加监控了，脚本不死，一切自动。</p> 
<h3><a id="3__166"></a>3. 简单效果展示</h3> 
<p>Alien_exporter采集的数据<br> <img src="https://images2.imgbox.com/83/46/tmw5FtLs_o.png" alt="看板"></p> 
<p>Detail的数据源是两部分</p> 
<ul><li> <p>资源监控<br> <img src="https://images2.imgbox.com/0c/27/rqzIYrT8_o.png" alt="在这里插入图片描述"></p> </li><li> <p>mysql监控<br> <img src="https://images2.imgbox.com/b5/b7/eOgC3vo9_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a6/3a/vqpdQ87h_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h3><a id="4__182"></a>4. 遗憾</h3> 
<p>一个<code>mysqld_exporter</code>进程只能监控一个RDS实例，所以N多RDS实例，就要对应启动N个<code>mysqld_exporter</code>，同时要分配N个不同端口（后续可以通过修改<code>mysqld_exporter</code>源码优化只启动一个<code>mysqld_exporter</code>服务）</p> 
<p>水平有限，一个监控搞的那么碎，东拼西凑的，如哪位大佬有更优的解决方案求指导。</p> 
<blockquote> 
 <p>另外，调用阿里云API每个月是有上限的，超出要付费的，还好一个月50块钱的足够用。</p> 
 <p>另外，会有API获取不到数据的情况。出现断图也是很常见，但<code>mysqld_exporter</code>还是很ok的。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/a0/f1/4wc1UCar_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bc464ffa3cd7cda67454437f266d4b71/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">pc端微信扫码登录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c3edfa6718e9b2ca885e3c405e0bdf97/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">内部网关协议到底属于哪一层</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>