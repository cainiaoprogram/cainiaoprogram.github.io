<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Leetcode SQL 50题刷题攻略（下篇） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Leetcode SQL 50题刷题攻略（下篇）" />
<meta property="og:description" content="高频 SQL 50 题（基础版）刷题攻略（上篇） 简介正文开始1789.员工的直属部门180.连续出现的数字1204.最后一个能进入巴士的人1978.上级经理已离职的公司员工626.换座位1341.电影评分1321.餐馆营业额变化增长585.2016年的投资185.部门工资前三高的所有员工1667.修复表中的名字1527.患某种疾病的患者196.删除重复的电子邮箱1484.按日期分组销售产品1327.列出指定时间段内所有的下单产品1517.查找拥有有效邮箱的用户 简介 刷题网址：高频 SQL 50 题（基础版） - 学习计划 - 力扣（LeetCode）全球极客挚爱的技术成长平台
上篇网址：Leetcode SQL 50题刷题攻略（上篇）-CSDN博客
正文开始 1789.员工的直属部门 select employee_id,department_id from (select employee_id,count(employee_id) as n,department_id from Employee group by employee_id) t where n=1 union select employee_id,department_id from Employee where primary_flag = &#39;Y&#39; union的用法
第一个select语句select employee_id,department_id from (select employee_id,count(employee_id) as n,department_id from Employee group by employee_id) t where n=1的结果：
employee_iddepartment_id1133第二个select语句select employee_id,department_id from Employee where primary_flag = &#39;Y&#39;的结果：
employee_iddepartment_id2143通过union语句即SELECT column_a FROM table_a UNION SELECT column_b FROM table_b;合并的结果如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7a24791f93bcb53398799b810fea7d4c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-02T14:14:49+08:00" />
<meta property="article:modified_time" content="2023-12-02T14:14:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Leetcode SQL 50题刷题攻略（下篇）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>高频 SQL 50 题（基础版）刷题攻略（上篇）</h4> 
 <ul><li><a href="#_1" rel="nofollow">简介</a></li><li><a href="#_5" rel="nofollow">正文开始</a></li><li><a href="#1789_6" rel="nofollow">1789.员工的直属部门</a></li><li><a href="#180_43" rel="nofollow">180.连续出现的数字</a></li><li><a href="#1204_55" rel="nofollow">1204.最后一个能进入巴士的人</a></li><li><a href="#1978_91" rel="nofollow">1978.上级经理已离职的公司员工</a></li><li><a href="#626_100" rel="nofollow">626.换座位</a></li><li><a href="#1341_142" rel="nofollow">1341.电影评分</a></li><li><a href="#1321_167" rel="nofollow">1321.餐馆营业额变化增长</a></li><li><a href="#5852016_245" rel="nofollow">585.2016年的投资</a></li><li><a href="#185_277" rel="nofollow">185.部门工资前三高的所有员工</a></li><li><a href="#1667_342" rel="nofollow">1667.修复表中的名字</a></li><li><a href="#1527_376" rel="nofollow">1527.患某种疾病的患者</a></li><li><a href="#196_396" rel="nofollow">196.删除重复的电子邮箱</a></li><li><a href="#1484_420" rel="nofollow">1484.按日期分组销售产品</a></li><li><a href="#1327_459" rel="nofollow">1327.列出指定时间段内所有的下单产品</a></li><li><a href="#1517_477" rel="nofollow">1517.查找拥有有效邮箱的用户</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>简介</h2> 
<p>刷题网址：<a href="https://leetcode.cn/studyplan/sql-free-50/" rel="nofollow">高频 SQL 50 题（基础版） - 学习计划 - 力扣（LeetCode）全球极客挚爱的技术成长平台</a><br> 上篇网址：<a href="https://blog.csdn.net/weixin_37490132/article/details/134730453?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22134730453%22%2C%22source%22%3A%22weixin_37490132%22%7D">Leetcode SQL 50题刷题攻略（上篇）-CSDN博客</a></p> 
<h2><a id="_5"></a>正文开始</h2> 
<h2><a id="1789_6"></a>1789.员工的直属部门</h2> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> employee_id<span class="token punctuation">,</span>department_id <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> employee_id<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>employee_id<span class="token punctuation">)</span> <span class="token keyword">as</span> n<span class="token punctuation">,</span>department_id <span class="token keyword">from</span> Employee <span class="token keyword">group</span> <span class="token keyword">by</span> employee_id<span class="token punctuation">)</span> t <span class="token keyword">where</span> n<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">union</span>
<span class="token keyword">select</span> employee_id<span class="token punctuation">,</span>department_id <span class="token keyword">from</span> Employee <span class="token keyword">where</span> primary_flag <span class="token operator">=</span> <span class="token string">'Y'</span>
</code></pre> 
<ol><li> <p>union的用法</p> <p>第一个select语句<code>select employee_id,department_id from (select employee_id,count(employee_id) as n,department_id from Employee group by employee_id) t where n=1</code>的结果：</p> 
  <table><thead><tr><th>employee_id</th><th>department_id</th></tr></thead><tbody><tr><td>1</td><td>1</td></tr><tr><td>3</td><td>3</td></tr></tbody></table><p>第二个select语句<code>select employee_id,department_id from Employee where primary_flag = 'Y'</code>的结果：</p> 
  <table><thead><tr><th>employee_id</th><th>department_id</th></tr></thead><tbody><tr><td>2</td><td>1</td></tr><tr><td>4</td><td>3</td></tr></tbody></table><p>通过union语句即<code>SELECT column_a FROM table_a UNION SELECT column_b FROM table_b;</code>合并的结果如下：</p> 
  <table><thead><tr><th>employee_id</th><th>department_id</th></tr></thead><tbody><tr><td>1</td><td>1</td></tr><tr><td>3</td><td>3</td></tr><tr><td>2</td><td>1</td></tr><tr><td>4</td><td>3</td></tr></tbody></table> 
  <blockquote> 
   <p>需要注意的是，使用UNION操作符合并列时，两个表的列数和数据类型必须相同。</p> 
  </blockquote> </li></ol> 
<h2><a id="180_43"></a>180.连续出现的数字</h2> 
<p><img src="https://images2.imgbox.com/68/44/N4eCvox9_o.png" alt="image-20231128102018803"></p> 
<p><img src="https://images2.imgbox.com/92/bf/mF9g9w4R_o.png" alt="image-20231128102039056"></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> l1<span class="token punctuation">.</span>num <span class="token keyword">as</span> ConsecutiveNums <span class="token keyword">from</span> Logs l1 <span class="token keyword">left</span> <span class="token keyword">join</span> Logs l2 <span class="token keyword">on</span> l1<span class="token punctuation">.</span>id<span class="token operator">=</span>l2<span class="token punctuation">.</span>id<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">left</span> <span class="token keyword">join</span> Logs l3 <span class="token keyword">on</span> l1<span class="token punctuation">.</span>id<span class="token operator">=</span>l3<span class="token punctuation">.</span>id<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">where</span> l1<span class="token punctuation">.</span>num <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> l1<span class="token punctuation">.</span>num<span class="token operator">=</span>l2<span class="token punctuation">.</span>num <span class="token operator">and</span> l1<span class="token punctuation">.</span>num<span class="token operator">=</span>l3<span class="token punctuation">.</span>num
</code></pre> 
<ol><li>很有意思的一道题，如何破解连续与计数的方式</li></ol> 
<h2><a id="1204_55"></a>1204.最后一个能进入巴士的人</h2> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> person_name <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> person_id<span class="token punctuation">,</span>person_name<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> turn<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_weight<span class="token punctuation">,</span>turn <span class="token keyword">from</span> Queue <span class="token keyword">order</span> <span class="token keyword">by</span> turn<span class="token punctuation">)</span> t <span class="token keyword">where</span> t<span class="token punctuation">.</span>sum_weight<span class="token operator">&lt;=</span><span class="token number">1000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> turn <span class="token keyword">DESC</span>  
<span class="token keyword">LIMIT</span> <span class="token number">1</span>
</code></pre> 
<ol><li> <p>计算累计和</p> <p>原始数据：</p> 
  <table><thead><tr><th>person_id</th><th>person_name</th><th>weight</th><th>turn</th></tr></thead><tbody><tr><td>5</td><td>Alice</td><td>250</td><td>1</td></tr><tr><td>4</td><td>Bob</td><td>175</td><td>5</td></tr><tr><td>3</td><td>Alex</td><td>350</td><td>2</td></tr><tr><td>6</td><td>John Cena</td><td>400</td><td>3</td></tr><tr><td>1</td><td>Winston</td><td>500</td><td>6</td></tr><tr><td>2</td><td>Marie</td><td>200</td><td>4</td></tr></tbody></table><p>使用sum(…) over (order by …)来计算累加和<code>select person_id,person_name,sum(weight) over (order by turn) as sum_weight,turn from Queue order by turn</code>的结果：</p> 
  <table><thead><tr><th>person_id</th><th>person_name</th><th>sum_weight</th><th>turn</th></tr></thead><tbody><tr><td>5</td><td>Alice</td><td>250</td><td>1</td></tr><tr><td>3</td><td>Alex</td><td>600</td><td>2</td></tr><tr><td>6</td><td>John Cena</td><td>1000</td><td>3</td></tr><tr><td>2</td><td>Marie</td><td>1200</td><td>4</td></tr><tr><td>4</td><td>Bob</td><td>1375</td><td>5</td></tr><tr><td>1</td><td>Winston</td><td>1875</td><td>6</td></tr></tbody></table><p>即按turn的次序累加weight为sum_weight</p> </li><li> <p>读取最后一行，使用<code>ORDER BY turn DESC</code>与<code>LIMIT 1</code>配合获取turn倒数第一行</p> </li></ol> 
<h2><a id="1978_91"></a>1978.上级经理已离职的公司员工</h2> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> employee_id <span class="token keyword">from</span> Employees <span class="token keyword">where</span> salary <span class="token operator">&lt;</span> <span class="token number">30000</span> <span class="token operator">and</span> manager_id <span class="token operator">not</span> <span class="token operator">in</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> employee_id <span class="token keyword">from</span> Employees<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> employee_id
</code></pre> 
<ol><li>如何查找一个经理id与所有的员工的id都不一样，即查找一个值与某一列都不一样，使用<code>not in (select employee_id from Employees)</code>来解决，也即<code>SELECT * FROM table1 WHERE id NOT IN (SELECT id FROM table2)</code></li></ol> 
<h2><a id="626_100"></a>626.换座位</h2> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>  
<span class="token keyword">case</span> <span class="token keyword">when</span> id<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> Seat<span class="token punctuation">)</span> <span class="token operator">and</span> id<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> id
     <span class="token keyword">when</span> id<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> id<span class="token operator">+</span><span class="token number">1</span>
     <span class="token keyword">when</span> id<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> id<span class="token operator">-</span><span class="token number">1</span>
<span class="token keyword">end</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span>
student
<span class="token keyword">FROM</span> Seat <span class="token keyword">order</span> <span class="token keyword">by</span> id<span class="token punctuation">;</span>
</code></pre> 
<ol><li> <p>查询子表使用<code>XXX=(select...)</code>的方式来查询</p> <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> column_name <span class="token punctuation">[</span><span class="token punctuation">,</span> column_name <span class="token punctuation">]</span>
<span class="token keyword">FROM</span>   table1 <span class="token punctuation">[</span><span class="token punctuation">,</span> table2 <span class="token punctuation">]</span>
<span class="token keyword">WHERE</span>  column_name OPERATOR
      <span class="token punctuation">(</span><span class="token keyword">SELECT</span> column_name <span class="token punctuation">[</span><span class="token punctuation">,</span> column_name <span class="token punctuation">]</span>
      <span class="token keyword">FROM</span> table1 <span class="token punctuation">[</span><span class="token punctuation">,</span> table2 <span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token keyword">WHERE</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> </li><li> <p>使用case与when以及end来条件判断，免得使用union的连接操作：</p> <pre><code class="prism language-sql"><span class="token keyword">case</span> <span class="token keyword">when</span> id<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> Seat<span class="token punctuation">)</span> <span class="token operator">and</span> id<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> id
     <span class="token keyword">when</span> id<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> id<span class="token operator">+</span><span class="token number">1</span>
     <span class="token keyword">when</span> id<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> id<span class="token operator">-</span><span class="token number">1</span>
<span class="token keyword">end</span> <span class="token keyword">as</span> id
</code></pre> <p>也即：</p> <pre><code class="prism language-sql"><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> condition1 <span class="token keyword">THEN</span> result1
     <span class="token keyword">WHEN</span> condition2 <span class="token keyword">THEN</span> result2
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">ELSE</span> resultN
<span class="token keyword">END</span>
</code></pre> </li></ol> 
<h2><a id="1341_142"></a>1341.电影评分</h2> 
<pre><code class="prism language-sql"><span class="token punctuation">(</span><span class="token keyword">select</span> name <span class="token keyword">as</span> results <span class="token keyword">from</span> MovieRating m <span class="token keyword">left</span> <span class="token keyword">join</span> Users u <span class="token keyword">on</span> m<span class="token punctuation">.</span>user_id<span class="token operator">=</span>u<span class="token punctuation">.</span>user_id <span class="token keyword">group</span> <span class="token keyword">by</span> m<span class="token punctuation">.</span>user_id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">,</span>name <span class="token keyword">asc</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> title <span class="token keyword">as</span> results <span class="token keyword">from</span> MovieRating mr <span class="token keyword">left</span> <span class="token keyword">join</span> Movies m <span class="token keyword">on</span> mr<span class="token punctuation">.</span>movie_id<span class="token operator">=</span>m<span class="token punctuation">.</span>movie_id <span class="token keyword">where</span> created_at<span class="token operator">&gt;=</span><span class="token string">'2020-02-01'</span> <span class="token operator">and</span> created_at<span class="token operator">&lt;=</span><span class="token string">'2020-02-29'</span> <span class="token keyword">group</span> <span class="token keyword">by</span> mr<span class="token punctuation">.</span>movie_id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">sum</span><span class="token punctuation">(</span>rating<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>rating<span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">,</span>title <span class="token keyword">asc</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<ol><li> <p>union会去掉重复项，union all不会</p> <p>比如union会返回：</p> 
  <table><thead><tr><th>results</th></tr></thead><tbody><tr><td>Rebecca</td></tr></tbody></table><p>而union all会返回：</p> 
  <table><thead><tr><th>results</th></tr></thead><tbody><tr><td>Rebecca</td></tr><tr><td>Rebecca</td></tr></tbody></table></li><li> <p>order by可以使用sum，count等函数，结果可以不返回，排序的时候可以根据这些排序</p> </li></ol> 
<h2><a id="1321_167"></a>1321.餐馆营业额变化增长</h2> 
<pre><code class="prism language-sql"><span class="token comment"># 方式1，使用窗口函数</span>
<span class="token keyword">select</span> visited_on<span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span>amount<span class="token operator">/</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> average_amount <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>visited_on<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">as</span> visited_on<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">as</span> amount <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> visited_on<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">as</span> amount <span class="token keyword">from</span> Customer <span class="token keyword">group</span> <span class="token keyword">by</span> visited_on<span class="token punctuation">)</span> t<span class="token punctuation">)</span> t1
<span class="token keyword">having</span> visited_on<span class="token operator">&gt;=</span><span class="token punctuation">(</span><span class="token keyword">select</span> visited_on <span class="token keyword">from</span> Customer <span class="token keyword">group</span> <span class="token keyword">by</span> visited_on <span class="token keyword">limit</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># 方式2，使用window子句</span>
<span class="token keyword">select</span> visited_on<span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span>amount<span class="token operator">/</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> average_amount <span class="token keyword">from</span>
<span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>visited_on<span class="token punctuation">)</span> <span class="token keyword">over</span> s <span class="token keyword">as</span> visited_on<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">over</span> s <span class="token keyword">as</span> amount <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> visited_on<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">as</span> amount <span class="token keyword">from</span> Customer <span class="token keyword">group</span> <span class="token keyword">by</span> visited_on<span class="token punctuation">)</span> t
window s <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> t1
<span class="token keyword">having</span> visited_on<span class="token operator">&gt;=</span><span class="token punctuation">(</span><span class="token keyword">select</span> visited_on <span class="token keyword">from</span> Customer <span class="token keyword">group</span> <span class="token keyword">by</span> visited_on <span class="token keyword">limit</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<ol><li> <p><img src="https://images2.imgbox.com/c9/49/gQKqHntm_o.png" alt="image-20231201101806525"></p> <p>通过上图可以得出一个伪SQL查询语句</p> <p><img src="https://images2.imgbox.com/ff/95/cuaeVq7A_o.png" alt="image-20231201102102372"></p> <p>！重点，where与having的作用是相同的，但是由于作用的时间段不一样，会导致having可以针对聚合计算结束的内容来进行判断，如下所示，having可以针对数学平均乘积筛选，而where是不能的，其只能针对原始数据筛选</p> <p><img src="https://images2.imgbox.com/d2/e3/A65cYOH6_o.png" alt="image-20231201102518264"></p> </li><li> <p>sql操作的窗口函数</p> <p>窗口函数(Window Function)，又被叫做分析函数(Analytics Function)，通常在需要对数据进行分组汇总计算时使用，因此与聚集函数有一定的相似性。但与聚集函数不同的是，聚集函数通过对数据进行分组，仅能够输出分组汇总结果，而原始数据则无法展现在结果中。而窗口函数则可以同时将原始数据和聚集分析结果同时显示出来</p> <p>常见的形式如<code>SUM(SCORE) OVER (PARTITION BY CLASSID ORDER BY SCORE ROWS BETWEEN 1 PRECEDING AND CURRENT ROW)</code>，即上面一些题，用到了over啥的都是窗口函数</p> 
  <blockquote> 
   <p>PARTITION BY CLASSID意思是先按CLASSID分为很多大划分</p> 
  </blockquote> 
  <blockquote> 
   <p>ORDER BY SCORE意思是在每个大划分下进行按照列SCORE来排序</p> 
  </blockquote> 
  <blockquote> 
   <p>ROWS BETWEEN 1 PRECEDING AND CURRENT ROW意思是排序完成后，在每个大划分中进行，按照当前行与当前行前一行为一个窗口来进行小划分</p> 
  </blockquote> 
  <blockquote> 
   <p>针对每个小划分来进行SUM(SCORE)操作</p> 
  </blockquote> <p>具体如下图所示</p> <p><img src="https://images2.imgbox.com/51/e4/vr9pdsFA_o.png" alt="image-20231201105723879"></p> <p>其中最后小划分的方式有如下格式</p> <pre><code class="prism language-sql">RANGE<span class="token operator">|</span><span class="token keyword">ROWS</span> <span class="token punctuation">[</span><span class="token operator">BETWEEN</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>rows_loc<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">AND</span> <span class="token operator">&lt;</span>rows_loc<span class="token operator">&gt;</span><span class="token punctuation">]</span>
或
RANGE<span class="token operator">|</span><span class="token keyword">ROWS</span> <span class="token operator">&lt;</span>rows_loc<span class="token operator">&gt;</span>
</code></pre> <p>中间的<code>&lt;rows_loc&gt;</code>可以为</p> 
  <ul><li><strong>UNBOUNDED PRECEDING</strong>表示该大划分的第一行</li><li><strong>UNBOUNDED FOLLOWING</strong>表示该大划分的最后一行</li><li><strong>CURRENT ROW</strong>表示当前行</li><li><strong> PRECEDING</strong>表示从当前行往前数数量的行，其中不能包含变量，RANGE选项禁用</li><li><strong> FOLLOWING</strong>表示从当前行往后数数量的行，其中不能包含变量，RANGE选项禁用</li></ul> 
  <blockquote> 
   <p>举例：</p> 
   <p>RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING 以该分组（也即大划分）所有元组为窗口</p> 
   <p>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW 以该分组起始行到当前行为窗口</p> 
   <p>ROWS BETWEEN 10 PRECEDING AND 5 FOLLOWING 以该分组当前行前10行到后5行为窗口（不能超过起始行和结束行）</p> 
  </blockquote> </li><li> <p>窗口函数的window子句</p> <p>有时，一个查询会出现多个窗口函数，而内容还相同，那么可以使用window子句了，即使用一个<code>window s as (rows between 6 PRECEDING AND CURRENT ROW)</code>，然后其余要用到窗口函数的直接<code>over s</code>即可</p> </li><li> <p>limit的新用法</p> <p><code>limit n offset m</code>表示从第m+1行开始读取n行，简单的写法可以写为<code>limit m,n</code></p> </li></ol> 
<h2><a id="5852016_245"></a>585.2016年的投资</h2> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    insurance
<span class="token keyword">WHERE</span>
    insurance<span class="token punctuation">.</span>TIV_2015 <span class="token operator">IN</span>
    <span class="token punctuation">(</span>
      <span class="token keyword">SELECT</span>
        TIV_2015
      <span class="token keyword">FROM</span>
        insurance
      <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TIV_2015
      <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span>
    <span class="token punctuation">)</span>
    <span class="token operator">AND</span> CONCAT<span class="token punctuation">(</span>LAT<span class="token punctuation">,</span> LON<span class="token punctuation">)</span> <span class="token operator">IN</span>
    <span class="token punctuation">(</span>
      <span class="token keyword">SELECT</span>
        CONCAT<span class="token punctuation">(</span>LAT<span class="token punctuation">,</span> LON<span class="token punctuation">)</span>
      <span class="token keyword">FROM</span>
        insurance
      <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> LAT <span class="token punctuation">,</span> LON
      <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">;</span>
</code></pre> 
<ol><li>having后可以接聚合函数，作用域上面一道题已经显示了having的运行位置</li><li>concat函数用于连接两个字符串形成一个字符串</li></ol> 
<h2><a id="185_277"></a>185.部门工资前三高的所有员工</h2> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> d<span class="token punctuation">.</span>name <span class="token keyword">as</span> Department<span class="token punctuation">,</span> e<span class="token punctuation">.</span>name <span class="token keyword">as</span> Employee<span class="token punctuation">,</span> e<span class="token punctuation">.</span>salary <span class="token keyword">as</span> Salary
<span class="token keyword">from</span> Employee e
         <span class="token keyword">left</span> <span class="token keyword">join</span>
     <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
      <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> departmentId<span class="token punctuation">,</span>
                   salary<span class="token punctuation">,</span>
                   ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> departmentId <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
            <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> departmentId<span class="token punctuation">,</span>
                                  salary
                  <span class="token keyword">from</span> Employee<span class="token punctuation">)</span> <span class="token keyword">as</span> t1<span class="token punctuation">)</span> <span class="token keyword">as</span> t2
      <span class="token keyword">where</span> rn <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> t3
     <span class="token keyword">on</span> e<span class="token punctuation">.</span>departmentId <span class="token operator">=</span> t3<span class="token punctuation">.</span>departmentId <span class="token operator">and</span> e<span class="token punctuation">.</span>salary <span class="token operator">=</span> t3<span class="token punctuation">.</span>salary
         <span class="token keyword">left</span> <span class="token keyword">join</span>
     Department d
     <span class="token keyword">on</span> e<span class="token punctuation">.</span>departmentId <span class="token operator">=</span> d<span class="token punctuation">.</span>id
<span class="token keyword">where</span> t3<span class="token punctuation">.</span>departmentId <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>

</code></pre> 
<ol><li> <p>如何将每个部门分开并且求每个部门的前三高的工资是多少，分为两步：</p> 
  <ol><li> <p>第一步将每个部门相同的薪水去掉</p> <p><code>select distinct departmentId,salary from Employee</code></p> <p>结果如下：</p> 
    <table><thead><tr><th>departmentId</th><th>salary</th></tr></thead><tbody><tr><td>1</td><td>85000</td></tr><tr><td>2</td><td>80000</td></tr><tr><td>2</td><td>60000</td></tr><tr><td>1</td><td>90000</td></tr><tr><td>1</td><td>69000</td></tr><tr><td>1</td><td>70000</td></tr></tbody></table></li><li> <p>第二部使用聚合函数中的ROW_NUMBER与窗口函数来分组标号</p> <pre><code class="prism language-sql"><span class="token keyword">select</span> departmentId<span class="token punctuation">,</span>
       salary<span class="token punctuation">,</span>
       ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> departmentId <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> departmentId<span class="token punctuation">,</span>
                      salary
      <span class="token keyword">from</span> Employee<span class="token punctuation">)</span> <span class="token keyword">as</span> t1
</code></pre> <p>结果如下：</p> 
    <table><thead><tr><th>departmentId</th><th>salary</th><th>rn</th></tr></thead><tbody><tr><td>1</td><td>90000</td><td>1</td></tr><tr><td>1</td><td>85000</td><td>2</td></tr><tr><td>1</td><td>70000</td><td>3</td></tr><tr><td>1</td><td>69000</td><td>4</td></tr><tr><td>2</td><td>80000</td><td>1</td></tr><tr><td>2</td><td>60000</td><td>2</td></tr></tbody></table><p>即按departmentId分组，每组按salary倒序，然后每组进行标号操作，标号操作后作为rn列</p> </li><li> <p>最后一个就是再套一个select取rn小于等于3的即可</p> </li></ol> </li></ol> 
<h2><a id="1667_342"></a>1667.修复表中的名字</h2> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> user_id<span class="token punctuation">,</span>concat<span class="token punctuation">(</span>upper<span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lower<span class="token punctuation">(</span>substring<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> name <span class="token keyword">from</span> Users <span class="token keyword">order</span> <span class="token keyword">by</span> user_id
</code></pre> 
<ol><li> <p>mysql字符串截取常用函数有</p> 
  <ul><li> <p>left(str,length)</p> <p>从左边第一位开始截取指定长度字符串</p> </li><li> <p>right(str,length)</p> <p>从右边第一位开始截取指定长度字符串</p> </li><li> <p>substring(str,index,length)</p> <p>从指定开始位置截取指定长度字符串，如果不给length那么就从index截取后面全部长度，index可以为负数，负数就是相对于右边第一位的偏移</p> </li><li> <p>substr与mid函数的功能与substring类似</p> </li><li> <p>substring_index(str,dim,length)</p> <p>从指定字符位置开始截取指定长度字符串。</p> <p>length可正可负，若正那么就是相对于左边第length个dim，若负就是相对于右边第length个dim。正的取dim前所有字符串，负数取dim后所有字符串</p> <p>若找不到dim那么返回所有字符串</p> </li></ul> </li><li> <p>upper是字符串变大写，lower是字符串变小写</p> </li><li> <p>concat是连接两个字符串操作</p> </li></ol> 
<h2><a id="1527_376"></a>1527.患某种疾病的患者</h2> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> Patients p <span class="token keyword">where</span> p<span class="token punctuation">.</span>conditions <span class="token operator">REGEXP</span> <span class="token string">'\\bDIAB1.*'</span>
</code></pre> 
<ol><li> <p>mysql正则表达式使用<code>p.conditions REGEXP '\\bDIAB1.*'</code>即匹配了<code>\bDIAB1.*</code>的字符串都会被查询出，注意<code>\b</code>需要使用<code>\\b</code>才行</p> 
  <blockquote> 
   <p><code>\b</code>是匹配一个单词边界</p> 
   <p><code>\B</code>是匹配一个非单词边界</p> 
   <p><code>\w</code>是匹配一个字母、数字或下划线。等价于 [A-Za-z0-9_]</p> 
   <p><code>.</code>表示匹配除换行符 \n 之外的任何单字符</p> 
   <p><code>*</code>表示零次或多次</p> 
   <p><code>.*</code>在一起就表示任意字符出现零次或多次</p> 
  </blockquote> </li></ol> 
<h2><a id="196_396"></a>196.删除重复的电子邮箱</h2> 
<pre><code class="prism language-sql"><span class="token keyword">DELETE</span>
<span class="token keyword">FROM</span>
	Person
<span class="token keyword">WHERE</span>
	id <span class="token operator">NOT</span> <span class="token operator">IN</span> 
<span class="token punctuation">(</span><span class="token keyword">SELECT</span>
		tmp<span class="token punctuation">.</span>mid
	<span class="token keyword">FROM</span>
		<span class="token punctuation">(</span>
			<span class="token keyword">SELECT</span>
				<span class="token function">MIN</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> mid
			<span class="token keyword">FROM</span>
				Person
			<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
				email
		<span class="token punctuation">)</span> tmp
<span class="token punctuation">)</span>
</code></pre> 
<ol><li>只保留重复数据id小的一个项，那么可以使用这个方法，即先分组求id最小，然后只删除不在这些id中的项即可</li></ol> 
<h2><a id="1484_420"></a>1484.按日期分组销售产品</h2> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> sell_date<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>sell_date<span class="token punctuation">)</span> <span class="token keyword">as</span> num_sold<span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>product <span class="token keyword">order</span> <span class="token keyword">by</span> product<span class="token punctuation">)</span> <span class="token keyword">as</span> products
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> sell_date<span class="token punctuation">,</span> product <span class="token keyword">from</span> Activities<span class="token punctuation">)</span> t
<span class="token keyword">group</span> <span class="token keyword">by</span> sell_date
</code></pre> 
<ol><li> <p>group_concat与group by搭配使用，并且其内部能搭配使用order by</p> 
  <table><thead><tr><th>sell_date</th><th>product</th></tr></thead><tbody><tr><td>2020-05-30</td><td>Headphone</td></tr><tr><td>2020-06-01</td><td>Pencil</td></tr><tr><td>2020-06-02</td><td>Mask</td></tr><tr><td>2020-05-30</td><td>Basketball</td></tr><tr><td>2020-06-01</td><td>Bible</td></tr><tr><td>2020-06-02</td><td>Mask</td></tr><tr><td>2020-05-30</td><td>T-Shirt</td></tr></tbody></table><p>第一步去掉重复项，使用distinct即<code>select distinct sell_date, product from Activities</code></p> 
  <table><thead><tr><th>sell_date</th><th>product</th></tr></thead><tbody><tr><td>2020-05-30</td><td>Headphone</td></tr><tr><td>2020-06-01</td><td>Pencil</td></tr><tr><td>2020-06-02</td><td>Mask</td></tr><tr><td>2020-05-30</td><td>Basketball</td></tr><tr><td>2020-06-01</td><td>Bible</td></tr><tr><td>2020-05-30</td><td>T-Shirt</td></tr></tbody></table><p>第二步分组，使用count与group_concat，group_concat会自动使用逗号来连接，即可得到答案</p> 
  <table><thead><tr><th>sell_date</th><th>num_sold</th><th>products</th></tr></thead><tbody><tr><td>2020-05-30</td><td>3</td><td>Basketball,Headphone,T-Shirt</td></tr><tr><td>2020-06-01</td><td>2</td><td>Bible,Pencil</td></tr><tr><td>2020-06-02</td><td>1</td><td>Mask</td></tr></tbody></table></li></ol> 
<h2><a id="1327_459"></a>1327.列出指定时间段内所有的下单产品</h2> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> p<span class="token punctuation">.</span>product_name<span class="token punctuation">,</span> sum_unit <span class="token keyword">as</span> unit
<span class="token keyword">from</span> Products p
         <span class="token keyword">left</span> <span class="token keyword">join</span>
     <span class="token punctuation">(</span><span class="token keyword">select</span> product_id<span class="token punctuation">,</span> order_date<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>unit<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_unit
      <span class="token keyword">from</span> Orders
      <span class="token keyword">where</span> DATE_FORMAT<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span> <span class="token string">"%m"</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span>
      <span class="token keyword">group</span> <span class="token keyword">by</span> DATE_FORMAT<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span> <span class="token string">"%Y年%m月"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> product_id
      <span class="token keyword">having</span> sum_unit <span class="token operator">&gt;=</span> <span class="token number">100</span><span class="token punctuation">)</span> t <span class="token keyword">on</span> p<span class="token punctuation">.</span>product_id <span class="token operator">=</span> t<span class="token punctuation">.</span>product_id
<span class="token keyword">where</span> t<span class="token punctuation">.</span>product_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
</code></pre> 
<ol><li>可以使用<code>where DATE_FORMAT(order_date, "%m") = 2</code>的方式将月份为2的找出来</li></ol> 
<h2><a id="1517_477"></a>1517.查找拥有有效邮箱的用户</h2> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> Users <span class="token keyword">where</span> mail <span class="token operator">regexp</span> <span class="token string">"^[a-zA-Z]+[\\w|\\-|\\.]*@leetcode\\.com"</span>
</code></pre> 
<ol><li>在mysql中使用正则表达式要使用<code>\\</code>来表示<code>\</code>即上面的<code>^[a-zA-Z]+[\\w|\\-|\\.]*@leetcode\\.com</code>实际正则表达式是<code>^[a-zA-Z]+[\w|\-|\.]*@leetcode\.com</code></li><li><code>^</code>表示正则表达式的其实位置，如果不加这个那么<code>.shapo@leetcode.com</code>也会被匹配</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ecca4689a3cfb3daa7e265bf313c7fc2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Monocle 3 | 太牛了！单细胞必学R包！~（五）（差异分析之聚类比较与模块鉴定）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5bb7948eca272b5fd4272318368bbfcb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Leetcode SQL 50题刷题攻略（上篇）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>