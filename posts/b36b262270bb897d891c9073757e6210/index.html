<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Activiti7事件监听 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Activiti7事件监听" />
<meta property="og:description" content="本文个人博客地址：Activiti7事件监听 (leafage.top)
好久没有记录笔记了，最近做了一些关于工作流的事情，记录一下使用activiti 7的一些经验。
需求：
在流程发起和流程操作的过程中，给相关人员发送流程审批的通知提醒；不要在配置流程时手动添加，不能侵入到流程操作的过程，影响流程执行； 这个怎么入手呢？没搞过activiti，activiti7 的官方文档写的跟屎一样烂，感觉好难呀😔…
文档参考性不高，那就试试看官方的示例，找到 activiti 的 repository ，有一个示例 module 叫 activiti-examples，这里的示例不能直接跑，只能看，要想跑起来，就复制，粘贴，放到自己的项目中。跑题了，说会主题。。。
activiti中的几个关联的重要的类或接口：
activiti 中每个流程信息是通过 ProcessInstance 描述，它有这么几个状态：created、started、completed、cancelled、resumed、updated、suspended，与之对应的相关事件描述类是：ProcessCreatedEvent、ProcessStartedEvent、ProcessCompletedEvent、ProcessCancelledEvent、ProcessResumedEvent、ProcessUpdatedEvent、ProcessSuspendedEvent等。
每个流程节点在 activiti 中 通过 Task 来描述，它有这么几个个状态：created、assigned、completed、updated、cancelled、suspended等，与之对应的相关事件描述类是：TaskCreatedEvent、TaskAssignedEvent、TaskCompletedEvent、TaskUpdatedEvent、TaskCancelledEvent、TaskSuspendedEvent等。
如何配置监听器？ 1. 全局事件监听器： 涉及到两个类\接口，全局事件监听器 ActivitiEventListener 和 ProcessEngineConfigurationConfigurer（有一个默认的实现类：DefaultActivityBehaviorFactoryMappingConfigurer）
ActitiviEventListener 接口有一个 void onEvent(ActivitiEvent activitiEvent) 方法，即在事件状态发生变化时，可以发生的动作都会在这个方法中进行。其源码如下：
/** * Describes a class that listens for {@link ActivitiEvent}s dispatched by the engine. * */ public interface ActivitiEventListener { void onEvent(ActivitiEvent event); boolean isFailOnException(); } ActivitiEvent 包含了流程的定义ID，示例ID，执行ID，和事件类型信息，源码如下：
public interface ActivitiEvent { ActivitiEventType getType(); String getExecutionId(); String getProcessInstanceId(); String getProcessDefinitionId(); } 其事件类型包括很多，源码如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b36b262270bb897d891c9073757e6210/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-13T10:03:32+08:00" />
<meta property="article:modified_time" content="2021-08-13T10:03:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Activiti7事件监听</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本文个人博客地址：<a href="https://www.leafage.top/posts/detail/21811W1F6" rel="nofollow">Activiti7事件监听 (leafage.top)</a></p> 
<blockquote> 
 <p>好久没有记录笔记了，最近做了一些关于工作流的事情，记录一下使用activiti 7的一些经验。</p> 
</blockquote> 
<p><strong>需求：</strong></p> 
<ol><li>在流程发起和流程操作的过程中，给相关人员发送流程审批的通知提醒；</li><li>不要在配置流程时手动添加，不能侵入到流程操作的过程，影响流程执行；</li></ol> 
<p><mark><em>这个怎么入手呢？没搞过activiti，activiti7 的官方文档写的跟屎一样烂，感觉好难呀</em></mark>😔…</p> 
<p>文档参考性不高，那就试试看官方的示例，找到 activiti 的 repository ，有一个示例 module 叫 activiti-examples，<mark>这里的示例不能直接跑，只能看</mark>，要想跑起来，就复制，粘贴，放到自己的项目中。<s>跑题了，说会主题。。。</s></p> 
<p><strong>activiti中的几个关联的重要的类或接口：</strong></p> 
<ol><li> <p>activiti 中每个流程信息是通过 ProcessInstance 描述，它有这么几个状态：created、started、completed、cancelled、resumed、updated、suspended，与之对应的相关事件描述类是：ProcessCreatedEvent、ProcessStartedEvent、ProcessCompletedEvent、ProcessCancelledEvent、ProcessResumedEvent、ProcessUpdatedEvent、ProcessSuspendedEvent等。</p> <p><img src="https://images2.imgbox.com/29/93/n1Xj0YGX_o.png" alt="image.png"></p> </li><li> <p>每个流程节点在 activiti 中 通过 Task 来描述，它有这么几个个状态：created、assigned、completed、updated、cancelled、suspended等，与之对应的相关事件描述类是：TaskCreatedEvent、TaskAssignedEvent、TaskCompletedEvent、TaskUpdatedEvent、TaskCancelledEvent、TaskSuspendedEvent等。</p> <p><img src="https://images2.imgbox.com/18/2d/YH5ZwuZZ_o.png" alt="image.png"></p> </li></ol> 
<h4><a id="_22"></a>如何配置监听器？</h4> 
<h5><a id="1__23"></a>1. 全局事件监听器：</h5> 
<p>涉及到两个类\接口，全局事件监听器 ActivitiEventListener 和 ProcessEngineConfigurationConfigurer（有一个默认的实现类：DefaultActivityBehaviorFactoryMappingConfigurer）</p> 
<p><img src="https://images2.imgbox.com/a4/44/4GvLAkJW_o.png" alt="image.png"></p> 
<p>ActitiviEventListener 接口有一个 void onEvent(ActivitiEvent activitiEvent) 方法，即在事件状态发生变化时，可以发生的动作都会在这个方法中进行。其源码如下：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Describes a class that listens for {@link ActivitiEvent}s dispatched by the engine.
 * 

 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ActivitiEventListener</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">ActivitiEvent</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">boolean</span> <span class="token function">isFailOnException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ActivitiEvent 包含了流程的定义ID，示例ID，执行ID，和事件类型信息，源码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ActivitiEvent</span> <span class="token punctuation">{<!-- --></span>

  <span class="token class-name">ActivitiEventType</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">getExecutionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其事件类型包括很多，源码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ActivitiEventType</span> <span class="token punctuation">{<!-- --></span>

  <span class="token comment">// ENTITY ：流程实例，发起流程时，从流程模板中创建实例</span>
  ENTITY_CREATED<span class="token punctuation">,</span>  <span class="token comment">// 创建</span>

  ENTITY_INITIALIZED<span class="token punctuation">,</span>  <span class="token comment">// 初始化完成（如果这个实体的创建会包含子实体的创建，这个事件会在子实体都创建/初始化完成后被触发，这是与ENTITY_CREATED的区别）</span>

  ENTITY_UPDATED<span class="token punctuation">,</span>  <span class="token comment">// 更新</span>

  ENTITY_DELETED<span class="token punctuation">,</span>  <span class="token comment">// 删除</span>

  ENTITY_SUSPENDED<span class="token punctuation">,</span>  <span class="token comment">// 暂停（会被ProcessDefinitions, ProcessInstances 和 Tasks抛出）</span>

  ENTITY_ACTIVATED<span class="token punctuation">,</span>  <span class="token comment">// 激活（会被ProcessDefinitions, ProcessInstances 和 Tasks抛出）</span>

  <span class="token comment">// 定时器</span>
  TIMER_SCHEDULED<span class="token punctuation">,</span>  <span class="token comment">// 创建</span>

  TIMER_FIRED<span class="token punctuation">,</span>  <span class="token comment">// 触发</span>

  <span class="token comment">// 作业</span>
  JOB_CANCELED<span class="token punctuation">,</span>  <span class="token comment">// 取消</span>

  JOB_EXECUTION_SUCCESS<span class="token punctuation">,</span>  <span class="token comment">// 执行成功</span>

  JOB_EXECUTION_FAILURE<span class="token punctuation">,</span>  <span class="token comment">// 执行失败</span>

  JOB_RETRIES_DECREMENTED<span class="token punctuation">,</span>  <span class="token comment">// 重试减少（因为作业执行失败，导致重试次数减少）</span>

  CUSTOM<span class="token punctuation">,</span>  <span class="token comment">// 自定义</span>
  
  <span class="token comment">// 引擎</span>
  ENGINE_CREATED<span class="token punctuation">,</span>  <span class="token comment">// 创建</span>

  ENGINE_CLOSED<span class="token punctuation">,</span>  <span class="token comment">// 关闭</span>

  <span class="token comment">// 流程节点</span>
  ACTIVITY_STARTED<span class="token punctuation">,</span>  <span class="token comment">// 开始</span>

  ACTIVITY_COMPLETED<span class="token punctuation">,</span>  <span class="token comment">// 完成</span>

  ACTIVITY_CANCELLED<span class="token punctuation">,</span>  <span class="token comment">// 取消</span>

  ACTIVITY_SIGNALED<span class="token punctuation">,</span>  <span class="token comment">// 收到了一个信号</span>

  ACTIVITY_COMPENSATE<span class="token punctuation">,</span>  <span class="token comment">// 将要被补偿</span>
  
  ACTIVITY_MESSAGE_SENT<span class="token punctuation">,</span>  <span class="token comment">// 消息发送</span>
 
  ACTIVITY_MESSAGE_WAITING<span class="token punctuation">,</span>  <span class="token comment">// 消息等待</span>

  ACTIVITY_MESSAGE_RECEIVED<span class="token punctuation">,</span>  <span class="token comment">// 消息接收</span>

  ACTIVITY_ERROR_RECEIVED<span class="token punctuation">,</span>  <span class="token comment">// 接收失败</span>
  
  <span class="token comment">// 流程历史</span>
  HISTORIC_ACTIVITY_INSTANCE_CREATED<span class="token punctuation">,</span>  <span class="token comment">// 创建</span>
  
  HISTORIC_ACTIVITY_INSTANCE_ENDED<span class="token punctuation">,</span>  <span class="token comment">// 结束</span>

  <span class="token comment">// 队列流程</span>
  SEQUENCEFLOW_TAKEN<span class="token punctuation">,</span>  <span class="token comment">// 已采取</span>

  UNCAUGHT_BPMN_ERROR<span class="token punctuation">,</span>  <span class="token comment">// 未获取到bpmn 异常</span>

  <span class="token comment">// 变量</span>
  VARIABLE_CREATED<span class="token punctuation">,</span>  <span class="token comment">// 创建</span>

  VARIABLE_UPDATED<span class="token punctuation">,</span>  <span class="token comment">// 更新</span>

  VARIABLE_DELETED<span class="token punctuation">,</span>  <span class="token comment">// 删除</span>

  <span class="token comment">// 任务</span>
  TASK_CREATED<span class="token punctuation">,</span>  <span class="token comment">// 创建（它位于ENTITY_CREATE事件之后。当任务是由流程创建时，这个事件会在TaskListener执行之前被执行）</span>

  TASK_ASSIGNED<span class="token punctuation">,</span>  <span class="token comment">// 分配</span>

  TASK_COMPLETED<span class="token punctuation">,</span>  <span class="token comment">// 完成（它会在ENTITY_DELETE事件之前触发。当任务是流程一部分时，事件会在流程继续运行之前，   后续事件将是ACTIVITY_COMPLETE，对应着完成任务的节点）</span>

  <span class="token comment">// 进程</span>
  PROCESS_STARTED<span class="token punctuation">,</span>  <span class="token comment">// 开始</span>

  PROCESS_COMPLETED<span class="token punctuation">,</span>  <span class="token comment">// 完成（在最后一个节点的ACTIVITY_COMPLETED事件之后触发。 当流程到达的状态，没有任何后续连线时， 流程就会结束。）</span>
 
  PROCESS_COMPLETED_WITH_ERROR_END_EVENT<span class="token punctuation">,</span>  <span class="token comment">// 异常结束</span>

  PROCESS_CANCELLED<span class="token punctuation">,</span>  <span class="token comment">// 取消</span>

  HISTORIC_PROCESS_INSTANCE_CREATED<span class="token punctuation">,</span>  <span class="token comment">// 流程实例创建</span>

  HISTORIC_PROCESS_INSTANCE_ENDED<span class="token punctuation">,</span>  <span class="token comment">// 流程实例创建</span>

  <span class="token comment">// 成员</span>
  MEMBERSHIP_CREATED<span class="token punctuation">,</span>  <span class="token comment">// 用户被添加到一个组里</span>

  MEMBERSHIP_DELETED<span class="token punctuation">,</span>  <span class="token comment">// 用户被从一个组中删除</span>

  MEMBERSHIPS_DELETED<span class="token punctuation">;</span>  <span class="token comment">// 所有成员被从一个组中删除</span>
  
  <span class="token comment">// other code ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ProcessEngineConfigurationConfigurer 中的 void configure(SpringProcessEngineConfiguration springProcessEngineConfiguration) 方法可以添加自定义的事件监听器，这个监听器作用域为整个流程过程。其源码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultActivityBehaviorFactoryMappingConfigurer</span> <span class="token keyword">implements</span> <span class="token class-name">ProcessEngineConfigurationConfigurer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">VariablesMappingProvider</span> variablesMappingProvider<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ProcessVariablesInitiator</span> processVariablesInitiator<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventSubscriptionPayloadMappingProvider</span> eventSubscriptionPayloadMappingProvider<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultActivityBehaviorFactoryMappingConfigurer</span><span class="token punctuation">(</span><span class="token class-name">VariablesMappingProvider</span> variablesMappingProvider<span class="token punctuation">,</span>
                                                           <span class="token class-name">ProcessVariablesInitiator</span> processVariablesInitiator<span class="token punctuation">,</span>
                                                           <span class="token class-name">EventSubscriptionPayloadMappingProvider</span> eventSubscriptionPayloadMappingProvider<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>variablesMappingProvider <span class="token operator">=</span> variablesMappingProvider<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>processVariablesInitiator <span class="token operator">=</span> processVariablesInitiator<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventSubscriptionPayloadMappingProvider <span class="token operator">=</span> eventSubscriptionPayloadMappingProvider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">SpringProcessEngineConfiguration</span> processEngineConfiguration<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        processEngineConfiguration<span class="token punctuation">.</span><span class="token function">setEventSubscriptionPayloadMappingProvider</span><span class="token punctuation">(</span>eventSubscriptionPayloadMappingProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>

        processEngineConfiguration<span class="token punctuation">.</span><span class="token function">setActivityBehaviorFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MappingAwareActivityBehaviorFactory</span><span class="token punctuation">(</span>variablesMappingProvider<span class="token punctuation">,</span>
                                                                                                      processVariablesInitiator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>如何来监听事件？</strong></p> 
<ol><li>实现 ActivitiEventListener 接口，重写 void onEvent(ActivitiEvent event) 方法；</li><li>新增配置类，继承 DefaultActivityBehaviorFactoryMappingConfigurer 类（或实现 ProcessEngineConfigurationConfigurer 接口）并重写 configura() 方法, 给 SpringProcessEngineConfiguration 属性添加自定义的监听器实现类；</li></ol> 
<p>示例如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivitiConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultActivityBehaviorFactoryMappingConfigurer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ActivitiTaskLogService</span> activitiTaskLogService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ActivitiConfiguration</span><span class="token punctuation">(</span><span class="token class-name">VariablesMappingProvider</span> variablesMappingProvider<span class="token punctuation">,</span> <span class="token class-name">ProcessVariablesInitiator</span> processVariablesInitiator<span class="token punctuation">,</span>
                                 <span class="token class-name">EventSubscriptionPayloadMappingProvider</span> eventSubscriptionPayloadMappingProvider<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>variablesMappingProvider<span class="token punctuation">,</span> processVariablesInitiator<span class="token punctuation">,</span> eventSubscriptionPayloadMappingProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">SpringProcessEngineConfiguration</span> springProcessEngineConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>springProcessEngineConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>

        springProcessEngineConfiguration<span class="token punctuation">.</span><span class="token function">setEventListeners</span><span class="token punctuation">(</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActivitiTaskEventListener</span><span class="token punctuation">(</span>activitiTaskLogService<span class="token punctuation">,</span> userService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivitiTaskEventListener</span> <span class="token keyword">implements</span> <span class="token class-name">ActivitiEventListener</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">ActivitiEvent</span> activitiEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>activitiEvent<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        processEngine <span class="token operator">=</span> <span class="token class-name">ProcessEngines</span><span class="token punctuation">.</span><span class="token function">getDefaultProcessEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 流程实例</span>
        <span class="token class-name">ProcessInstance</span> processInstance <span class="token operator">=</span> processEngine<span class="token punctuation">.</span><span class="token function">getRuntimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createProcessInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>activitiEvent<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>processInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivitiTaskLog</span><span class="token punctuation">&gt;</span></span> taskLogList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>activitiEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 任务执行后</span>
            <span class="token keyword">case</span> TASK_COMPLETED<span class="token operator">:</span>
                <span class="token comment">// 任务被处理，给创建人, 下一个任务的候选人</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivitiTaskLog</span><span class="token punctuation">&gt;</span></span> taskCompletedLogs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">taskCompleted</span><span class="token punctuation">(</span>processInstance<span class="token punctuation">,</span> activitiEvent<span class="token punctuation">.</span><span class="token function">getExecutionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>taskCompletedLogs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    taskLogList<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>taskCompletedLogs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> PROCESS_COMPLETED<span class="token operator">:</span>
                <span class="token comment">// 流程完成，给创建人，协助人，抄送人发通知</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivitiTaskLog</span><span class="token punctuation">&gt;</span></span> processCompletedLogs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processCompleted</span><span class="token punctuation">(</span>processInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>processCompletedLogs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    taskLogList<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>processCompletedLogs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//执行日志操作</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>taskLogList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            activitiTaskLogService<span class="token punctuation">.</span><span class="token function">createBatch</span><span class="token punctuation">(</span>taskLogList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2__262"></a>2. 运行时状态监听器：</h5> 
<p>在实例中有一个 activiti-api-basic-process-example 和 activiti-api-basic-task-example 两个示例工程，展示了如何进行配置运行时的process和task的监听。</p> 
<p>activiti-api-basic-process-example 中，流程监听示例：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessRuntimeEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessCompletedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">processCompletedListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> processCompleted <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt; Process Completed: '"</span>
            <span class="token operator">+</span> processCompleted<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token string">"' We can send a notification to the initiator: "</span> <span class="token operator">+</span> processCompleted<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInitiator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>activiti-api-basic-task-example 中，任务监听示例：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">TaskRuntimeEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskAssignedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">taskAssignedListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> taskAssigned <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt; Task Assigned: '"</span>
            <span class="token operator">+</span> taskAssigned<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token string">"' We can send a notification to the assginee: "</span> <span class="token operator">+</span> taskAssigned<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">TaskRuntimeEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskCompletedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">taskCompletedListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> taskCompleted <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt; Task Completed: '"</span>
            <span class="token operator">+</span> taskCompleted<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token string">"' We can send a notification to the owner: "</span> <span class="token operator">+</span> taskCompleted<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>参照示例，我们可以进行自定义的流程中事件监听的配置，这种方式，不需要实现 ActivitiEventlistener 接口，也不需要继承 DefaultActivityBehaviorFactoryMappingConfigurer 类或实现 ProcessEngineConfigurationConfigurer 接口，只需要注册相关事件的监听器即可。示例如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivitiConfiguration</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RuntimeService</span> runtimeService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ActRuTaskLogService</span> actRuTaskLogService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ActivitiConfiguration</span><span class="token punctuation">(</span><span class="token class-name">RuntimeService</span> runtimeService<span class="token punctuation">,</span> <span class="token class-name">ActRuTaskLogService</span> actRuTaskLogService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>runtimeService <span class="token operator">=</span> runtimeService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>actRuTaskLogService <span class="token operator">=</span> actRuTaskLogService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TaskRuntimeEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskAssignedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">taskAssignedListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> taskAssigned <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>

            <span class="token class-name">ExecutionEntity</span> execution <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionEntity</span><span class="token punctuation">)</span> runtimeService<span class="token punctuation">.</span><span class="token function">createProcessInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>taskAssigned<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> startUserId <span class="token operator">=</span> execution<span class="token punctuation">.</span><span class="token function">getStartUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> fileProcInstId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fileProcInstId</span><span class="token punctuation">(</span>execution<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 排除发起申请的任务，给 assignee 发消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>taskAssigned<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>startUserId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Task</span> task <span class="token operator">=</span> taskAssigned<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ActRuTaskLog</span> taskLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActRuTaskLog</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        taskAssigned<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">NotifyConstants</span><span class="token punctuation">.</span>PENDING_WARN<span class="token punctuation">,</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span>startUserId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processType</span><span class="token punctuation">(</span>fileProcInstId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">projName</span><span class="token punctuation">(</span>execution<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">NotifyTypeConstants</span><span class="token punctuation">.</span>CANDIDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                actRuTaskLogService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>taskLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TaskRuntimeEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskCompletedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">taskCompletedListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> taskCompleted <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>

            <span class="token class-name">ExecutionEntity</span> execution <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionEntity</span><span class="token punctuation">)</span> runtimeService<span class="token punctuation">.</span><span class="token function">createProcessInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>taskCompleted<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> startUserId <span class="token operator">=</span> execution<span class="token punctuation">.</span><span class="token function">getStartUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> fileProcInstId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fileProcInstId</span><span class="token punctuation">(</span>execution<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Task</span> task <span class="token operator">=</span> taskCompleted<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发起审批，给抄送人、协助人发消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>taskCompleted<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>startUserId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 任务所有人</span>
                <span class="token class-name">String</span> owner <span class="token operator">=</span> taskCompleted<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ActRuTaskLog</span> taskLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActRuTaskLog</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">NotifyConstants</span><span class="token punctuation">.</span>PENDING_WARN<span class="token punctuation">,</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span>startUserId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processType</span><span class="token punctuation">(</span>fileProcInstId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">projName</span><span class="token punctuation">(</span>execution<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">NotifyTypeConstants</span><span class="token punctuation">.</span>CANDIDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                actRuTaskLogService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>taskLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 给发起人发送任务处理结果的通知</span>
                <span class="token class-name">ActRuTaskLog</span> taskLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActRuTaskLog</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        taskCompleted<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">NotifyConstants</span><span class="token punctuation">.</span>PENDING<span class="token punctuation">,</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span>startUserId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processType</span><span class="token punctuation">(</span>fileProcInstId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">projName</span><span class="token punctuation">(</span>execution<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NotifyTypeConstants</span><span class="token punctuation">.</span>PENDING<span class="token punctuation">)</span><span class="token punctuation">;</span>
                actRuTaskLogService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>taskLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TaskCandidateEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskCandidateUserAddedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">taskCandidateUserEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> taskCandidateEvent <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt; Task Candidate User Add: '"</span>
                <span class="token operator">+</span> taskCandidateEvent<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TaskCandidateEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskCandidateGroupAddedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">taskCandidateGroupEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> taskCandidateEvent <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt; Task Candidate Group Add: '"</span>
                <span class="token operator">+</span> taskCandidateEvent<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ProcessRuntimeEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessCompletedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">processCompletedEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> processCompletedEvent <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===&gt;&gt;&gt; Process Completed: '"</span>
                <span class="token operator">+</span> processCompletedEvent<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取流程表单名
     *
     * @param executionEntity 执行对象
     * @return 表单名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">projName</span><span class="token punctuation">(</span><span class="token class-name">ExecutionEntity</span> executionEntity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> processInstanceName <span class="token operator">=</span> executionEntity<span class="token punctuation">.</span><span class="token function">getVariable</span><span class="token punctuation">(</span><span class="token string">"projName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span> <span class="token operator">==</span> processInstanceName <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> processInstanceName<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取流程文件ID
     *
     * @param executionEntity 执行对象
     * @return 文件ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">fileProcInstId</span><span class="token punctuation">(</span><span class="token class-name">ExecutionEntity</span> executionEntity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> fileProcInstId <span class="token operator">=</span> executionEntity<span class="token punctuation">.</span><span class="token function">getVariable</span><span class="token punctuation">(</span><span class="token string">"fileProcInstId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fileProcInstId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> fileProcInstId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 审批类型
     *
     * @param fileProcInstId 文件ID
     * @return 类型
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">processType</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileProcInstId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>fileProcInstId<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"用印"</span> <span class="token operator">:</span> <span class="token string">"合同"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取姓名
     *
     * @param userId 用户ID
     * @return 用户姓名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">userName</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userId <span class="token operator">+</span> <span class="token string">"操作人"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面两种方式，更推荐使用第二种，因为第一种方案中，ActivitiEvent 是超类，而一些属性是直接获取不到的，如果要获取，就需要进行向下强转，而每种事件的类型，实现子类又是不同的，需要做很多的判断，但是第二种方法就不用，因为当前监听器中的对象就是改类型对应的事件的相关对象，能够直接获取到相关的变量和信息。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2e4e3eedb6d17bafeba8d3ba3f0e2098/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">全民突击服务器维护多久,全民突击您的授权已失效请重新登录怎么办 授权失效解决方法介绍...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2c9eb8a8173df99a6246c3c37cb24116/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">fs2410开发板搭建网站服务器,FS2410开发板使用步骤</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>