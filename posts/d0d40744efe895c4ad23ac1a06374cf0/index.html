<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Jetson NX实现TensorRT加速部署YOLOv8 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Jetson NX实现TensorRT加速部署YOLOv8" />
<meta property="og:description" content="References
知乎：Jetson nano部署YOLOV8并利用TensorRT加速推理实现行人检测追踪
「解析」Jetson 开启 Shell远程访问
在上文部署yolov8基础上
开启ssh服务 Jetson上下载东西有时需要魔法，开启ssh服务可以方便PC端和边缘设备传输信息
安装ssh sudo apt-get update sudo apt-get install openssh-server sudo apt-get install ssh # 开启ssh服务 sudo systemctl start ssh 配置防火墙 作者在实现远程连接的过程中关闭了防火墙，下面是针对ufw防火墙的一些shell命令，可以参考
sudo apt update sudo apt install ufw # 安装下 ufw sudo ufw status verbose	# 检查 ufw状态 # Status: inactive	# 表示已激活防火墙 sudo ufw allow ssh	# 允许ssh访问，22端口 # Rules updated # Rules updated (v6) sudo ufw enable	# 启用防火墙 sudo ufw disable # 关闭防火墙 查看是否已经开启ssh sudo service ssh status 远程连接Jetson NX 保证PC端和Jetson开发板在同一局域网内" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d0d40744efe895c4ad23ac1a06374cf0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-18T11:21:15+08:00" />
<meta property="article:modified_time" content="2023-12-18T11:21:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Jetson NX实现TensorRT加速部署YOLOv8</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>References</strong><br> 知乎：<a href="https://zhuanlan.zhihu.com/p/665546297" rel="nofollow">Jetson nano部署YOLOV8并利用TensorRT加速推理实现行人检测追踪</a><br> <a href="http://t.csdnimg.cn/S4fDZ" rel="nofollow">「解析」Jetson 开启 Shell远程访问</a><br> 在<a href="http://t.csdnimg.cn/5LDrM" rel="nofollow">上文部署yolov8基础</a>上</p> 
<h2><a id="ssh_5"></a>开启ssh服务</h2> 
<p>Jetson上下载东西有时需要魔法，开启ssh服务可以方便PC端和边缘设备传输信息</p> 
<h3><a id="ssh_7"></a>安装ssh</h3> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openssh-server
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">ssh</span>
<span class="token comment"># 开启ssh服务</span>
<span class="token function">sudo</span> systemctl start <span class="token function">ssh</span>
</code></pre> 
<h3><a id="_16"></a>配置防火墙</h3> 
<p>作者在实现远程连接的过程中关闭了防火墙，下面是针对ufw防火墙的一些shell命令，可以参考</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> ufw 				<span class="token comment"># 安装下 ufw</span>

<span class="token function">sudo</span> ufw status verbose				<span class="token comment"># 检查 ufw状态</span>
<span class="token comment"># Status: inactive					# 表示已激活防火墙</span>

<span class="token function">sudo</span> ufw allow <span class="token function">ssh</span>					<span class="token comment"># 允许ssh访问，22端口</span>
<span class="token comment"># Rules updated</span>
<span class="token comment"># Rules updated (v6)</span>

<span class="token function">sudo</span> ufw <span class="token builtin class-name">enable</span>						<span class="token comment"># 启用防火墙</span>
<span class="token function">sudo</span> ufw disable 					<span class="token comment"># 关闭防火墙</span>
</code></pre> 
<h3><a id="ssh_33"></a>查看是否已经开启ssh</h3> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">service</span> <span class="token function">ssh</span> status
</code></pre> 
<h3><a id="Jetson_NX_38"></a>远程连接Jetson NX</h3> 
<p>保证PC端和Jetson开发板在同一局域网内</p> 
<pre><code class="prism language-bash"><span class="token comment"># Linux查看ip地址</span>
<span class="token function">ifconfig</span>
<span class="token comment"># win下查看ip地址</span>
ipconfig
</code></pre> 
<p>对于有线网络，查看eth0下面的inet对应的ip地址，对于无线网卡，查看wlan0下面的ip地址<br> 详细使用什么软件参考<a href="http://t.csdnimg.cn/V5bKd" rel="nofollow">零基础入门Jetson Nano——远程连接</a></p> 
<h2><a id="TensorRT_Pybind_48"></a>TensorRT Pybind</h2> 
<p>这是知乎博主<a href="https://zhuanlan.zhihu.com/p/665546297" rel="nofollow">Dovahlore</a>提供的方法，作者本人跟着做了一遍，但是在YOLO导出时依旧显示没有tensorrt，本文在后面给出其他处理方法。<br> Jetpack中的TensorRT不能直接在python3.8环境中使用，所以我们需要对TensorRT利用pybind11对python相进性绑定。pybind的方法。<a href="https://github.com/NVIDIA/TensorRT/tree/release/8.2/python">参考原链接</a></p> 
<p>在Jetson中创建一个external目录，并将pybind11克隆到其中。</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> external <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> external
<span class="token function">git</span> clone https://github.com/pybind/pybind11.git
</code></pre> 
<p>这里因为是通过sudo创建的文件夹，直接 git clone会报错，需要添加文件读写权限，git clone 项目报错 could not create work tree dir ‘xxx.xxx.xx‘: Permission denied，报这个错误的原因就是正在写入或者克隆 git 仓库的目录没有写入的权限。</p> 
<p>在external文件夹的上一层执行</p> 
<pre><code class="prism language-bash">//再执行
<span class="token function">sudo</span> <span class="token function">chmod</span> o+w <span class="token function">dirname</span>
</code></pre> 
<p>从官方获取<a href="https://www.python.org/downloads/source/" rel="nofollow">python源代码</a>，下载对应的python版本。将python源码中Include路径下的内容拷贝到external/python3.8/include中。<br> 加入头文件Python.h<br> <a href="http://ports.ubuntu.com/pool/main/p/python3.8/libpython3.8-dev_3.8.2-1ubuntu1_arm64.deb" rel="nofollow">下载</a>libpython3.8-dev并解压得到usr文件夹<br> 在文件的下载目录下执行</p> 
<pre><code class="prism language-bash">ar x <span class="token operator">&lt;</span>libpython<span class="token punctuation">..</span>.<span class="token operator">&gt;</span>.deb <span class="token comment"># 对应的deb文件</span>
<span class="token function">tar</span> <span class="token parameter variable">-xvf</span> data.tar.xz
</code></pre> 
<p>然后将解压出的./usr/include/aarch64-linux-gnu/python3.8目录下的pycongfig.h拷贝到external/python3.8/include路径中。<br> 在Jetson中将TensorRT与其子模块克隆到本地。选择分支release/8.2。</p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone <span class="token parameter variable">-b</span> release/8.2 https://github.com/nvidia/TensorRT
<span class="token builtin class-name">cd</span> TensorRT
<span class="token function">git</span> submodule update <span class="token parameter variable">--init</span> <span class="token parameter variable">--recursive</span>
</code></pre> 
<p>修改TensorRT/python/bash.sh中的内容。<br> bash.sh中找到以下内容：</p> 
<pre><code class="prism language-bash"><span class="token comment">#原内容</span>
<span class="token assign-left variable">PYTHON_MAJOR_VERSION</span><span class="token operator">=</span><span class="token variable">${PYTHON_MAJOR_VERSION<span class="token operator">:-</span>3}</span>
<span class="token assign-left variable">PYTHON_MINOR_VERSION</span><span class="token operator">=</span><span class="token variable">${PYTHON_MINOR_VERSION<span class="token operator">:-</span>8}</span>
<span class="token assign-left variable">TARGET</span><span class="token operator">=</span><span class="token variable">${TARGET_ARCHITECTURE<span class="token operator">:-</span>x86_64}</span>
<span class="token assign-left variable">CUDA_ROOT</span><span class="token operator">=</span><span class="token variable">${CUDA_ROOT<span class="token operator">:-</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda}</span>
<span class="token assign-left variable">ROOT_PATH</span><span class="token operator">=</span><span class="token variable">${TRT_OSSPATH<span class="token operator">:-</span><span class="token operator">/</span>workspace<span class="token operator">/</span>TensorRT}</span>
<span class="token assign-left variable">EXT_PATH</span><span class="token operator">=</span><span class="token variable">${EXT_PATH<span class="token operator">:-</span><span class="token operator">/</span>tmp<span class="token operator">/</span>external}</span>
<span class="token assign-left variable">WHEEL_OUTPUT_DIR</span><span class="token operator">=</span><span class="token variable">${ROOT_PATH}</span>/python/build
</code></pre> 
<ul><li>将TARGET修改为-aarch64。</li><li>将ROOT_PATH改为你TensoRT对应的绝对路径。</li><li>将EXT_PATH改为你创建的external对应的绝对路径<br> PS：这里修改地址很容易出错，填写路径不对导致找不到文件夹</li></ul> 
<pre><code class="prism language-bash"><span class="token comment">#修改后如下：</span>
<span class="token assign-left variable">PYTHON_MAJOR_VERSION</span><span class="token operator">=</span><span class="token variable">${PYTHON_MAJOR_VERSION<span class="token operator">:-</span>3}</span>
<span class="token assign-left variable">PYTHON_MINOR_VERSION</span><span class="token operator">=</span><span class="token variable">${PYTHON_MINOR_VERSION<span class="token operator">:-</span>8}</span>
<span class="token assign-left variable">TARGET</span><span class="token operator">=</span><span class="token variable">${TARGET_ARCHITECTURE<span class="token operator">:-</span>aarch64}</span>
<span class="token assign-left variable">CUDA_ROOT</span><span class="token operator">=</span><span class="token variable">${CUDA_ROOT<span class="token operator">:-</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda}</span>
<span class="token assign-left variable">ROOT_PATH</span><span class="token operator">=</span><span class="token variable">${TRT_OSSPATH<span class="token operator">:-</span><span class="token operator">/</span>home<span class="token operator">/</span>dovahlore<span class="token operator">/</span>TensorRT}</span>
<span class="token assign-left variable">EXT_PATH</span><span class="token operator">=</span><span class="token variable">${EXT_PATH<span class="token operator">:-</span><span class="token operator">/</span>home<span class="token operator">/</span>dovahlore<span class="token operator">/</span>external}</span>
<span class="token assign-left variable">WHEEL_OUTPUT_DIR</span><span class="token operator">=</span><span class="token variable">${ROOT_PATH}</span>/python/build
</code></pre> 
<p>最后运行bash.sh。运行前检查setuptools是否为最新版本。</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> <span class="token parameter variable">-U</span> pip setuptools
<span class="token function">bash</span> ./build.sh
</code></pre> 
<p><img src="https://images2.imgbox.com/f2/e0/4ybDiIJo_o.jpg" alt="在这里插入图片描述"><br> 完成后在TensorRT/python/build/dist找到tensorrt-8.2.3.0-cp38-none-linux_aarch64.whl，conda环境中安装。</p> 
<pre><code class="prism language-bash">python <span class="token parameter variable">-m</span> pip <span class="token function">install</span> build/dist/tensorrt-*.whl
</code></pre> 
<p>执行后在虚拟环境查看 pip list<br> <img src="https://images2.imgbox.com/b3/ab/XLu8vUNK_o.jpg" alt="在这里插入图片描述"></p> 
<p>具体操作请参考开头给出的知乎博文</p> 
<h2><a id="TensorRT_126"></a>TensorRT软连接</h2> 
<p>上文的方法作者在实现过程中生成TensorRT版本为8.2，可能是因为和本机Jetpack自带的TensorRT8.4版本不兼容，所以在YOLO导出过程中依旧不能调用TensorRT，下文给出解决方法。<br> 打开jtop可以查看到自带的tensorrt版本<br> <img src="https://images2.imgbox.com/f5/0e/JMWmSozn_o.jpg" alt="在这里插入图片描述"></p> 
<p><strong>References</strong><br> <a href="http://t.csdnimg.cn/UlBJP" rel="nofollow">jetson 系列 安装完jetpack/已安装 tensorrt 在虚拟环境中仍然报 no module named tensorrt ＞＞ 在虚拟环境建立软连接</a><br> <a href="http://t.csdnimg.cn/tByqI" rel="nofollow">由于ModuleNotFoundError: No module named ‘tensorrt’安装TensorRT-python发现报错</a><br> <a href="http://t.csdnimg.cn/w4ukX" rel="nofollow">[orin] nvidia orin 上配置tensorrt | 解决虚拟环境中路径无法import的问题</a><br> <a href="http://t.csdnimg.cn/SQClx" rel="nofollow">jetson xavier在使用tensorRT对yolov5加速时，报错ModuleNotFoundError: No module named ‘tensorrt‘</a></p> 
<h3><a id="_136"></a>建立软连接</h3> 
<p>Jetpack已经安装tensorrt但是虚拟环境里面没有<br> <strong>查看tensorrt库安装在哪：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">find</span> / <span class="token parameter variable">-name</span> tensorrt*
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/bb/Qgp0dlfM_o.jpg" alt="在这里插入图片描述"><br> <strong>进入虚拟环境目录下</strong><br> 查看虚拟环境所在位置</p> 
<pre><code class="prism language-bash">conda info <span class="token parameter variable">--envs</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f9/b9/X030n1l3_o.jpg" alt="在这里插入图片描述"><br> 进入该目录下的 lib/python3.8/site-packages</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /home/xiluo/miniforge-pypy3/envs/yolov8/lib/python3.8/site-packages
</code></pre> 
<p>设置软连接</p> 
<pre><code class="prism language-bash"> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/lib/python3.6/dist-packages/tensorrt
or
 <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/lib/python3.6/dist-packages/tensorrt/tensorrt.so
</code></pre> 
<p>上述工作做完可以在虚拟环境中import tensorrt，但是执行TensorRT.__version__会提示没有 “<strong>version</strong>”属性，<br> <strong>解决办法</strong><br> 需要把原系统中的tensorrt组件复制过来就解决问题了。<br> tensorrt的python包位于这个路径下：</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span>  /usr/lib/python3.8/dist-packages/
</code></pre> 
<p>把目录下的tensorrt-8.4.1.5.dist-info和tensorrt两个文件夹拷贝到虚拟环境的site-packages文件夹下（我的虚拟环境名为：yolov8）</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span>  /usr/lib/python3.8/dist-packages/ 
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> tensorrt-8.4.1.5.dist-info/ ~/miniforge-pypy3/envs/yolov8/lib/python3.8/site-packages/tensorrt-8.4.1.5.dist-info
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> tensorrt ~/miniforge-pypy3/envs/yolov8/lib/python3.8/site-packages/tensorrt
</code></pre> 
<p>如果命令行出错可以直接鼠标粘贴复制<br> <strong>验证是否导入成功</strong></p> 
<pre><code class="prism language-bash">python
<span class="token function">import</span> tersorrt
tensorrt.__version__
</code></pre> 
<p><img src="https://images2.imgbox.com/71/54/xRNOkTE4_o.jpg" alt="在这里插入图片描述"><br> 通过 pip list 也可以看到tensorrt已经安装成功<br> <img src="https://images2.imgbox.com/38/b8/jWT1xU3s_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="YOLOv8_191"></a>YOLOv8部署</h2> 
<p>在PC上改造数据集并训练YOLOV8模型，再将训练好的模型上传到在Jetson上利用TensorRT转换为.engine模型。<br> 在yolo环境中运行pt2engine.py脚本将.pt模型转换为.engine模型。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

<span class="token comment"># Load a model</span>
model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">'path/to/best.pt'</span><span class="token punctuation">)</span>  <span class="token comment"># load a custom trained</span>

<span class="token comment"># Export the model</span>
model<span class="token punctuation">.</span>export<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'engine'</span><span class="token punctuation">,</span>half<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>simplify<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>执行出错 提示没有onnxsim<br> <img src="https://images2.imgbox.com/ce/79/u6scu1R6_o.jpg" alt="在这里插入图片描述"><br> 执行报错 <a href="http://t.csdnimg.cn/ZD4aq" rel="nofollow">No matching distribution found for onnxruntime-gpu</a><br> <strong>解决方法</strong><br> 去直接访问<a href="https://elinux.org/Jetson_Zoo" rel="nofollow">Jetson Zoo - eLinux.org</a>下载对应的版本，作者是Jetpack5.0.2，python3.8<br> <img src="https://images2.imgbox.com/e8/39/kj7oEBlf_o.jpg" alt="在这里插入图片描述"></p> 
<p><strong>要注意：onnxruntime-gpu, cuda, cudnn三者的版本要对应，否则会报错 或 不能使用GPU推理。<br> onnxruntime-gpu, cuda, cudnn版本对应关系详见: <a href="https://onnxruntime.ai/docs/execution-providers/CUDA-ExecutionProvider.html" rel="nofollow">官网</a></strong><br> <img src="https://images2.imgbox.com/c9/c8/PjRrhH2x_o.jpg" alt="在这里插入图片描述"></p> 
<p>然后重新使用pip3来安装就好:</p> 
<pre><code class="prism language-bash">pip3 <span class="token function">install</span> onnxruntime_gpu-1.11.0-cp38-cp38-linux_aarch64.whl
 
Processing ./onnxruntime_gpu-1.11.0-cp38-cp38-linux_aarch64.whl
Collecting flatbuffers
  Downloading flatbuffers-2.0-py2.py3-none-any.whl <span class="token punctuation">(</span><span class="token number">26</span> kB<span class="token punctuation">)</span>
Requirement already satisfied: numpy<span class="token operator">&gt;=</span><span class="token number">1.22</span>.3 <span class="token keyword">in</span> /home/hekun/.local/lib/python3.8/site-packages <span class="token punctuation">(</span>from onnxruntime-gpu<span class="token operator">==</span><span class="token number">1.11</span>.0<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1.22</span>.4<span class="token punctuation">)</span>
Requirement already satisfied: protobuf <span class="token keyword">in</span> /home/hekun/.local/lib/python3.8/site-packages <span class="token punctuation">(</span>from onnxruntime-gpu<span class="token operator">==</span><span class="token number">1.11</span>.0<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">4.21</span>.0<span class="token punctuation">)</span>
Installing collected packages: flatbuffers, onnxruntime-gpu
Successfully installed flatbuffers-2.0 onnxruntime-gpu-1.11.0
</code></pre> 
<p>附上知乎博主Dovahlore的两份代码，分别推理视频和摄像头<br> <strong>视频推理</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#detect_track.py</span>

<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">import</span> cv2
model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">'best.engine'</span><span class="token punctuation">,</span> task<span class="token operator">=</span><span class="token string">'detect'</span><span class="token punctuation">)</span>

<span class="token comment"># Open the video file as source</span>
video_path <span class="token operator">=</span> <span class="token string">"path/to/video"</span><span class="token comment">#该为你要推理的视频路径</span>
cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span>

<span class="token comment">#use camera</span>
<span class="token comment">#cap = cv2.VideoCapture(0)</span>
<span class="token comment">#cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)</span>
<span class="token comment">#cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 640)</span>
<span class="token comment">#cap.set(cv2.CAP_PROP_FPS,120)</span>

<span class="token comment"># Loop through the video frames</span>
count<span class="token operator">=</span><span class="token number">0</span>
max_id<span class="token operator">=</span><span class="token number">0</span>
font <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX
<span class="token keyword">while</span> cap<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    t1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTickCount<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Read a frame from the video</span>
    success<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> success<span class="token punctuation">:</span>
        <span class="token comment"># Run YOLOv8 tracking on the frame, persisting tracks between frames</span>
        results<span class="token operator">=</span>model<span class="token punctuation">.</span>track<span class="token punctuation">(</span>source<span class="token operator">=</span>frame<span class="token punctuation">)</span>

        <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
            <span class="token keyword">if</span> result<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> count<span class="token operator">&lt;</span>result<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    count<span class="token operator">=</span>result<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment"># Visualize the results on the frame</span>
        annotated_frame <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#fps</span>
        t2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTickCount<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time <span class="token operator">=</span> <span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span> <span class="token operator">/</span> cv2<span class="token punctuation">.</span>getTickFrequency<span class="token punctuation">(</span><span class="token punctuation">)</span>
        fps <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span>time<span class="token punctuation">)</span>
        <span class="token comment">#plot annotate</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>annotated_frame<span class="token punctuation">,</span><span class="token string">"total %d"</span><span class="token operator">%</span>count<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>annotated_frame<span class="token punctuation">,</span> <span class="token string">"fps %d"</span> <span class="token operator">%</span> fps<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># Display the annotated frame</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"YOLOv8 onnx Tracking"</span><span class="token punctuation">,</span> annotated_frame<span class="token punctuation">)</span>

        <span class="token comment"># Break the loop if 'q' is pressed</span>
        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># Break the loop if the end of the video is reached</span>
        <span class="token keyword">break</span>

<span class="token comment"># Release the video capture object and close the display window</span>
cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>CSI摄像头</p> 
<pre><code class="prism language-python"><span class="token comment">#detect2track.py</span>

<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> time
model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">'best.engine'</span><span class="token punctuation">,</span> task<span class="token operator">=</span><span class="token string">'detect'</span><span class="token punctuation">)</span>

<span class="token comment"># Open the video file</span>
<span class="token comment">#video_path = "video/video4.mp4"</span>
<span class="token comment">#cap = cv2.VideoCapture(video_path)#video</span>

<span class="token comment">#cap = cv2.VideoCapture(0)#USB</span>

<span class="token comment">#CSI camera</span>
cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token string">'nvarguscamerasrc ! video/x-raw(memory:NVMM), width=1280, height=720, format=(string)NV12,framerate=(fraction)20/1 ! nvvidconv ! video/x-raw, format=(string)BGRx ! videoconvert ! video/x-raw, format=(string)BGR ! appsink'</span> <span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>CAP_GSTREAMER<span class="token punctuation">)</span>

count<span class="token operator">=</span><span class="token number">0</span>
max_id<span class="token operator">=</span><span class="token number">0</span>
font <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX
<span class="token keyword">while</span> cap<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Read a frame from the video</span>
    success<span class="token punctuation">,</span>frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> success<span class="token punctuation">:</span>
        loop_start<span class="token operator">=</span>cv2<span class="token punctuation">.</span>getTickCount<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># Run YOLOv8 tracking on the frame, persisting tracks between frames</span>
        results<span class="token operator">=</span>model<span class="token punctuation">.</span>track<span class="token punctuation">(</span>source<span class="token operator">=</span>frame<span class="token punctuation">,</span>persist<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
            <span class="token keyword">if</span> result<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> count<span class="token operator">&lt;</span>result<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    count<span class="token operator">=</span>result<span class="token punctuation">.</span>boxes<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment">#fps   </span>
        loop_time<span class="token operator">=</span>cv2<span class="token punctuation">.</span>getTickCount<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>loop_start
        total_time<span class="token operator">=</span>loop_time<span class="token operator">/</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>getTickFrequency<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        fps<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span>total_time<span class="token punctuation">)</span>  

        <span class="token comment"># Visualize the results on the frame</span>
        annotated_frame <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>annotated_frame<span class="token punctuation">,</span><span class="token string">"total %d"</span><span class="token operator">%</span>count<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>annotated_frame<span class="token punctuation">,</span><span class="token string">"fps %d"</span><span class="token operator">%</span>fps<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Display the annotated frame</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"YOLOv8 onnx Tracking"</span><span class="token punctuation">,</span> annotated_frame<span class="token punctuation">)</span> 
        <span class="token keyword">print</span><span class="token punctuation">(</span>fps<span class="token punctuation">)</span>
   <span class="token comment"># Break the loop if 'q' is pressed</span>
        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># Break the loop if the end of the video is reached</span>
        <span class="token keyword">break</span>

<span class="token comment"># Release the video capture object and close the display window</span>
cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9caf1f4518f4920bf2b3fe0c1bfb007d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">秒搜全网闲鱼商品！一键实现商品详情关键词搜索的酷炫电商API接口！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/76f1760a616230bf084ceba0c6082f27/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">任务管理应用数据库设计</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>