<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>1亿数据 redis 内存_redis 数据内存占用分析实战 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="1亿数据 redis 内存_redis 数据内存占用分析实战" />
<meta property="og:description" content="一、查看单个redis key占用的空间 -- redis-memory-for-key -s ${host} -p ${port} key_name
redis-memory-for-key -s 10.1.213.170 -p 9002 test 如果redis是用的集群，找到key的槽位所在的节点，port用对应的节点即可。
二、统计redis key 占用及分布
a、第一步：拉取 rdb 二进制文件(rdb文件既redis的db文件)
redis-cli -c -h ${ip} -p ${port} --rdb ${d}.${ip}.${port}.rdb b、解析 rdb 文件为文本，格式内容为：
rdb -c memory ${rdbfile} &gt; ${redkfile} // 解析后redkfile文件的格式 database,type,key,size_in_bytes,encoding,num_elements,len_largest_element c、 awk 统计key的内存分布 (需要预先配置前缀与描述，如果没有统计到的会打印出来)
detail.sh ${redkfile} &gt; ${statfile} 附上脚本 detail.sh
#!/bin/sh filename=$1 cat ${filename} | awk -F &#39;,&#39; &#39; BEGIN{ total=0; indice[&#34;trash&#34;]=&#34;测试分类 test@test@test&#34;; for (k in indice) { split(indice[k], ks, &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c7261096adab7f9a8940f0179abade75/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-08T16:37:11+08:00" />
<meta property="article:modified_time" content="2021-01-08T16:37:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">1亿数据 redis 内存_redis 数据内存占用分析实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div> 
 <p>一、查看单个redis key占用的空间 -- redis-memory-for-key -s ${host} -p ${port} key_name</p> 
 <div class="has"> 
  <pre class="has"><code>redis-memory-for-key -s 10.1.213.170 -p 9002 test
</code></pre> 
 </div> 
 <p></p> 
 <div style="text-align:center;"> 
  <img src="https://images2.imgbox.com/2a/9a/UbgkPwWE_o.png" alt="70737125db068fdbb455bd9bf1e87e3e.png"> 
 </div> 
 <p>如果redis是用的集群，找到key的槽位所在的节点，port用对应的节点即可。</p> 
 <p>二、统计redis key 占用及分布</p> 
 <p>a、第一步：拉取 rdb 二进制文件(rdb文件既redis的db文件)</p> 
 <div class="has"> 
  <pre class="has"><code>redis-cli -c -h ${ip} -p ${port} --rdb ${d}.${ip}.${port}.rdb</code></pre> 
 </div> 
 <p>b、解析 rdb 文件为文本，格式内容为：</p> 
 <div class="has"> 
  <pre class="has"><code>rdb -c memory  ${rdbfile} &gt; ${redkfile}

// 解析后redkfile文件的格式
database,type,key,size_in_bytes,encoding,num_elements,len_largest_element</code></pre> 
 </div> 
 <p>c、 awk 统计key的内存分布 (需要预先配置前缀与描述，如果没有统计到的会打印出来)</p> 
 <div class="has"> 
  <pre class="has"><code>detail.sh ${redkfile} &gt; ${statfile}</code></pre> 
 </div> 
 <p>附上脚本 detail.sh</p> 
 <div class="has"> 
  <pre class="has"><code>#!/bin/sh
filename=$1
cat  ${filename} | awk -F ',' '
BEGIN{
    total=0;
    indice["trash"]="测试分类 test@test@test";

    for (k in indice) {
        split(indice[k], ks, " ")
        desc[k]=ks[1]
        indices[k]=ks[2]
    }
}
{
    size=$4
    redkey=$3
    total+=size
    found=0
    regNumber="^[0-9]+$"

      for (k in indices) {
        if ( index(redkey, indices[k])==1 ) {
            sizes[k]+=size;
            lens[k]+=1;
            found=1
            break;
          }
        }
      if (found==0) {
          print size, redkey
      }
}
END{
    total_matched=0
    total_matched_len=0
    for (k in sizes) {
        print desc[k], indices[k], sizes[k], lens[k]
        total_matched+=sizes[k]
        total_matched_len+=lens[k]
    }
    print "total_matched", "-", total_matched, total_matched_len
    print "total", "-", total, NR
    print "missing", "-", total - total_matched, NR-total_matched_len
}' |
cat</code></pre> 
 </div> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4423e928af94fe0c31b1c723f0805068/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux系统  为什么新增的磁盘无法使用，需要挂载？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/411e5a786346eb4498fe474c09b00b96/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">监控摄像头接入流媒体服务器的几种方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>