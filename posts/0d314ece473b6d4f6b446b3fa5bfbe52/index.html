<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>linux kernel配置调试方法 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="linux kernel配置调试方法" />
<meta property="og:description" content="步骤 安装新内核，记住 grub 的序号，修改 grub.conf
将默认内核改成一个正常可用内核，而不是新安装的内核。
新内核启动时加入panic=5，使新内核启动失败后自动重启。
grub下次重启后进入新内核，使新内核仅在下次重启作为默认内核。一旦发生再次重启，就会按照进入 grub.conf 指定的默认内核。
root 权限运行 grub 命令，进入 grub 命令行。在 grub 命令行中运行（假设新内核的序号为 0)，savedefault --default=0 --once，输入 quit 以离开 grub 命令行，通过 crontab 设置机器自动重启。
运行 crontab -e，进入 crontab 配置文件，加入一行*/15 * * * * reboot。
重启系统，如果能正常进入新内核，则运行 crontab -e，删除 reboot 的一行。
系统性能分析工具perf 内置于Linux内核源码树中的性能剖析工具。基于事件采样原理以性能事件为基础，支持针对处理器相关性能指标与操作系统相关性能指标的性能剖析。常用于性能瓶颈的查找与热点代码的定位。举例：
perf top
# perf top // 默认配置
# perf top -G // 得到调用关系图
# perf top -e cycles // 指定性能事件
# perf top -p 23015,32476 // 查看这两个进程的cpu cycles使用情况" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0d314ece473b6d4f6b446b3fa5bfbe52/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-05T09:38:02+08:00" />
<meta property="article:modified_time" content="2022-05-05T09:38:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">linux kernel配置调试方法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>步骤</h3> 
<p>安装新内核，记住 grub 的序号，修改 grub.conf</p> 
<p>将默认内核改成一个正常可用内核，而不是新安装的内核。</p> 
<p>新内核启动时加入panic=5，使新内核启动失败后自动重启。</p> 
<p>grub下次重启后进入新内核，使新内核仅在下次重启作为默认内核。一旦发生再次重启，就会按照进入 grub.conf 指定的默认内核。</p> 
<p>root 权限运行 grub 命令，进入 grub 命令行。在 grub 命令行中运行（假设新内核的序号为 0)，savedefault --default=0 --once，输入 quit 以离开 grub 命令行，通过 crontab 设置机器自动重启。<br> 运行 crontab -e，进入 crontab 配置文件，加入一行*/15 * * * * reboot。</p> 
<p>重启系统，如果能正常进入新内核，则运行 crontab -e，删除 reboot 的一行。</p> 
<p></p> 
<h3>系统性能分析工具perf</h3> 
<p>内置于Linux内核源码树中的性能剖析工具。基于事件采样原理以性能事件为基础，支持针对处理器相关性能指标与操作系统相关性能指标的性能剖析。常用于性能瓶颈的查找与热点代码的定位。举例：</p> 
<p>perf top</p> 
<p># perf top // 默认配置</p> 
<p># perf top -G // 得到调用关系图</p> 
<p># perf top -e cycles // 指定性能事件</p> 
<p># perf top -p 23015,32476 // 查看这两个进程的cpu cycles使用情况</p> 
<p># perf top -s comm,pid,symbol // 显示调用symbol的进程名和进程号</p> 
<p># perf top --comms nginx,top // 仅显示属于指定进程的符号</p> 
<p># perf top --symbols kfree // 仅显示指定的符号</p> 
<p></p> 
<p>perf stat</p> 
<p>执行10次程序，给出标准偏差与期望的比值：</p> 
<p># perf stat -r 10 ls &gt; /dev/null</p> 
<p>显示更详细的信息：</p> 
<p># perf stat -v ls &gt; /dev/null</p> 
<p>只显示任务执行时间，不显示性能计数器：</p> 
<p># perf stat -n ls &gt; /dev/null</p> 
<p>单独给出每个CPU上的信息：</p> 
<p># perf stat -a -A ls &gt; /dev/null</p> 
<p>ls命令执行了多少次系统调用：</p> 
<p># perf stat -e syscalls:sys_enter ls </p> 
<p></p> 
<p>perf record</p> 
<p>记录nginx进程的性能数据：</p> 
<p># perf record -p `pgrep -d ',' nginx`</p> 
<p>记录执行ls时的性能数据：</p> 
<p># perf record ls -g</p> 
<p>记录执行ls时的系统调用，可以知道哪些系统调用最频繁：</p> 
<p># perf record -e syscalls:sys_enter ls</p> 
<p>参考：</p> 
<p><a href="http://blog.csdn.net/zhangskd/article/details/37902159" title="系统级性能分析工具 — Perf_zhangskd的专栏-CSDN博客_perf top">系统级性能分析工具 — Perf_zhangskd的专栏-CSDN博客_perf top</a></p> 
<p><a href="https://yq.aliyun.com/articles/65255" rel="nofollow" title="Linux 性能诊断 perf使用指南-阿里云开发者社区">Linux 性能诊断 perf使用指南-阿里云开发者社区</a></p> 
<p><a href="http://kernel.taobao.org/index.php?title=Documents/Kernel_Perf" rel="nofollow" title="http://kernel.taobao.org/index.php?title=Documents/Kernel_Perf">http://kernel.taobao.org/index.php?title=Documents/Kernel_Perf</a></p> 
<p>火焰图制作工具：</p> 
<p><a href="https://github.com/brendangregg/FlameGraph" title="GitHub - brendangregg/FlameGraph: Stack trace visualizer">GitHub - brendangregg/FlameGraph: Stack trace visualizer</a></p> 
<p></p> 
<h3>内核调试技巧</h3> 
<p>Kdump&amp;Crash 调试技巧</p> 
<p>安装Kdump和Crash</p> 
<p>yum install kexec-tools</p> 
<p>yum install crash</p> 
<p>参考： <a href="http://blog.chinaunix.net/uid-24563208-id-58926.html" rel="nofollow" title="Kdump &amp; Crash 学习笔记（一）">Kdump &amp; Crash 学习笔记（一）</a></p> 
<p>配置Kdump</p> 
<p>参考：<a href="http://blog.chinaunix.net/uid-24563208-id-58927.html" rel="nofollow" title="Kdump &amp; Crash 学习笔记（二）">Kdump &amp; Crash 学习笔记（二）</a></p> 
<p>参考：<a href="http://blog.chinaunix.net/uid-24563208-id-58928.html" rel="nofollow" title="Kdump &amp; Crash 学习笔记（三）">Kdump &amp; Crash 学习笔记（三）</a></p> 
<p></p> 
<h3>objdump 应用</h3> 
<p> 常用命令：</p> 
<p>      objdump -x obj 以某种分类信息的形式把目标文件的数据组织（被分为几大块）输出 &lt;可查到该文件的所有动态库&gt;   </p> 
<p>      objdump -t obj 输出目标文件的符号表()</p> 
<p>      objdump -h obj 输出目标文件的所有段概括()</p> 
<p>      objdump -j .text/.data -S obj 输出指定段的信息，大概就是反汇编源代码把</p> 
<p>      objdump -S obj C语言与汇编语言同时显示</p> 
<p></p> 
<p>参考：<a href="http://blog.chinaunix.net/uid-22561766-id-1772714.html" rel="nofollow" title="gcc命令objdump用法">gcc命令objdump用法</a></p> 
<p></p> 
<h3>SystemTap</h3> 
<p>以下介绍 SystemTap 完整环境的配置流程。完整环境即支持从 SystemTap 脚本解析到 SystemTap 运行的完整流程的环境。</p> 
<p>安装内核开发包 kernel-devel：</p> 
<p> 查看当前内核的开发包是否已安装： rpm -q kernel-devel-`uname -r`。</p> 
<p>若未安装：如果使用 CentOS 标准内核，则用 yum 安装：yum install kernel-devel。</p> 
<p>如果新安装 kernel-devel 与当前运行内核版本不匹配，则还需要更新内核并重启：yum update kernel; reboot。</p> 
<p>安装内核调试信息包 kernel-debuginfo（内核态跟踪需要）。</p> 
<p></p> 
<p> 如果是要跟踪用户态程序，而非内核本身，则可略过此步。</p> 
<p> 查看当前运行内核的调试信息包是否已安装： rpm -q kernel-debuginfo-`uname -r`。</p> 
<p> 若未安装：</p> 
<p> 如果使用 CentOS 标准内核，则用 yum 安装：yum install /usr/bin/debuginfo-install; debuginfo-install kernel。</p> 
<p>如果新安装 kernel-debuginfo 与当前运行内核版本不匹配，则还需要更新内核并重启：yum update kernel kernel-devel reboot。</p> 
<p>安装内核调试源码包 kernel-debuginfo-common内核源码仅为了编写 SystemTap 脚本时作参考之用。</p> 
<p>可直接参考 git 仓库中的代码。</p> 
<p> 查看当前运行内核的调试源码包是否已安装： rpm -q kernel-debuginfo-`uname -m`-`uname -r`</p> 
<p> 若未安装：</p> 
<p> 如果使用 CentOS 标准内核，则安装 kernel-debuginfo 时会自动通过依赖安装上对应的 kernel-debuginfo-common内核 debuginfo 包的组织。</p> 
<p> 内核的 debuginfo 包除了 kernel-debuginfo 外，还有一个 kernel-debuginfo-common-x86_64 (x86_64 为系统架构代号)</p> 
<p> kernel-debuginfo: 提供内核及内核模块的调试信息</p> 
<p> kernel-debuginfo-common-x86_64: 提供内核源码</p> 
<p> 使用 SystemTap 进行内核级调试时，需要安装 kernel-debuginfo。kernel-debuginfo-common-x86_64 并不需要，即使使用 kernel.statement 等代码行号级别的 probe 点。 安装 SystemTap</p> 
<p> yum install systemtap  运行示例编写简单的 SystemTap 脚本，保存为 who-is-reading.stp 如下</p> 
<p>        probe syscall.read</p> 
<p>        {<!-- --></p> 
<p>              printf("[%d] %s\n", pid(), execname())</p> 
<p>        }</p> 
<p> 运行 stap who-is-reading.stp。稍等会就有很多输出。然后按 Ctrl-C 结束。</p> 
<p></p> 
<h4>SystemTap 单纯运行环境</h4> 
<p>SystemTap 支持在单独设备上先将 SystemTap 脚本编译成 ko 文件。然后在其它设备上，仅需要 staprun 命令就能完成运行，无需在设备上安装 kernel-devel 及 kernel-debuginfo。</p> 
<p>安装方法：yum install systemtap-runtime</p> 
<p> SystemTap 入门</p> 
<p>   SystemTap 参考资料：<a href="http://wiki.op.ksyun.com/download/attachments/9843729/Systemtap%28%E7%BB%88%E7%A8%BF%29.pptx?version=2&amp;modificationDate=1415954369000&amp;api=v2" rel="nofollow" title="Systemtap 学习">Systemtap 学习</a></p> 
<p>CentOS 系统上如何安装调试信息包：</p> 
<ol><li>安装 yum-utils。它提供 debuginfo-install 命令。</li><li>启用 Debuginfo Yum 源，修改 /etc/yum.repos.d/CentOS-Debuginfo.repo，将 enabled 改为 1</li><li>安装 debuginfo 包（将 grep 改为你需要的包名，实际上即安装 grep-debuginfo）： debuginfo-install grep</li><li>至此安装完成，可以用 rpm -ql grep-debuginfo 查看实际加入了哪些文件</li></ol> 
<p></p> 
<h3>关于 debuginfo 包</h3> 
<p> 每个带二进制程序的 RPM 包，在打包时，都会产生一个对应的 debuginfo 包，如 grep =&gt; grep-debuginfo。</p> 
<p> 二进制文件通常即为 ELF 为件，如可执行文件(/bin/grep)，以及动态库(/lib64/<a href="http://libc.so/" rel="nofollow" title="libc.so">libc.so</a>)</p> 
<p> debuginfo 包中主要包含两类内容二进制文件的调试信息，即编译过程生成的符号表。</p> 
<p>以相同路径安装于 /usr/lib/debug/ 目录下，二进制文件文件名加上 .debug 后缀二进制文件对应的程序源码。</p> 
<p>以 rpmbuild 的 BUILD 路径，安装于 /usr/src/debug 下。</p> 
<p> Kdump 和 Crash 技术</p> 
<p> 参见：<a href="http://wenku.baidu.com/link?url=X37lHK7k8JUAR8n4CFSO27Hab1AEVH-XtOiskgFbEPwj_n-6K1nyIJXwBQSQxhWTa1zLinL3U_SLa2pwTCW-gjrcJGygHC72jCQ9P3KX5wW" rel="nofollow" title="Kdump和Crash的配置方法与内核故障原因分析">Kdump和Crash的配置方法与内核故障原因分析</a></p> 
<p> Netconsole 技术</p> 
<p> 参见：<a href="http://blog.chinaunix.net/uid-10167808-id-26028.html" rel="nofollow" title="Linux配置Netconsole远程打印日志信息">Linux配置Netconsole远程打印日志信息</a></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aa8562fcfe662c0ef93802e51060bf6c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【游戏开发小技】Unity中实现Dota里的角色技能地面贴花效果（URP | ShaderGraph | Decal）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/84c8e7ed07082111f98d38e4e619028d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【python】Pandas中DataFrame基本函数整理（全）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>