<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nacos注册中心和配置中心 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nacos注册中心和配置中心" />
<meta property="og:description" content="nacos注册中心和配置中心 nacos 一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。
nacos官方文档：https://nacos.io/zh-cn/
相关概念：https://nacos.io/zh-cn/docs/architecture.html
nacos是AP架构,注重可用性和分区容错性，java语言，集群架构的话通过nginx做负载均衡，然后节点之间互相同步数据
本文演示在springcloud中使用nacos
版本对应关系 https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E
nacos注册中心 官方基本示例，和属性介绍：https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery
2.3 核心功能
Nacos Discovery 服务注册：Nacos Client会通过发送REST请求的方式向Nacos Server注册自己的服务，提供自身的元数据，比如ip地址、端口等信息。Nacos Server接收到注册请求后，就会把这些元数据信息存储在一个双层的内存Map中。
服务心跳：在服务注册后，Nacos Client会维护一个定时心跳来持续通知Nacos Server，说明服务一直处于可用状态，防止被剔除。默认5s发送一次心跳。
服务同步：Nacos Server集群之间会互相同步服务实例，用来保证服务信息的一致性。 leader raft
服务发现：服务消费者（Nacos Client）在调用服务提供者的服务时，会发送一个REST请求给Nacos Server，获取上面注册的服务清单，并且缓存在Nacos Client本地，同时会在Nacos Client本地开启一个定时任务定时拉取服务端最新的注册表信息更新到本地缓存
服务健康检查：Nacos Server会开启一个定时任务用来检查注册服务实例的健康情况，对于超过15s没有收到客户端心跳的实例会将它的healthy属性置为false(客户端服务发现时不会发现)，如果某个实例超过30秒没有收到心跳，直接剔除该实例(被剔除的实例如果恢复发送心跳则会重新注册)
主流的注册中心
CAP C 一致性 A可用性 P 分区容错性
项目依赖 &lt;!--nacos-服务注册发现--&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt; &lt;/dependency&gt; 配置项 官网 ：https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery#%E5%85%B3%E4%BA%8E-nacos-starter-%E6%9B%B4%E5%A4%9A%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%BF%A1%E6%81%AF
在spring配置文件中配置项，服务端和客户端大致相同
# 应用名称 （nacos会将该名称当做服务名称） , spring.application.name: nacos-producer spring: cloud: nacos: server-addr: 61.171.5.6:30848 # 需要注意的是客户客户端会在此端口&#43;1000的基础上获取通信端口，具体参考nacos安装中的几个端口 discovery: # service: service-consumer #注册的服务名称，不配置，默认取spring.application.name # register-enabled: false #一般会注册成服务提供者和消费者，如果不想成为服务提供者，这里设置false username: nacos # 服务端没有开启认证，这个也不需要 password: nacos # group: nacos-producer1 # 默认使用DEFAULT_GROUP作为分组名称 #service: nacos-producer1 # 默认使用spring." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3c1a03f71c9e8e65eb35d01b5d74947e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-10T17:36:31+08:00" />
<meta property="article:modified_time" content="2022-12-10T17:36:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nacos注册中心和配置中心</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="nacos_2"></a>nacos注册中心和配置中心</h2> 
<p>nacos 一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</p> 
<p>nacos官方文档：https://nacos.io/zh-cn/</p> 
<p>相关概念：https://nacos.io/zh-cn/docs/architecture.html</p> 
<p>nacos是AP架构,注重可用性和分区容错性，java语言，集群架构的话通过nginx做负载均衡，然后节点之间互相同步数据</p> 
<p>本文演示在springcloud中使用nacos</p> 
<h3><a id="_16"></a>版本对应关系</h3> 
<p>https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E</p> 
<h3><a id="nacos_22"></a>nacos注册中心</h3> 
<p>官方基本示例，和属性介绍：https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery</p> 
<p><strong>2.3 核心功能</strong></p> 
<p><a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery"><strong>Nacos Discovery</strong> </a></p> 
<p><strong>服务注册</strong>：Nacos Client会通过发送REST请求的方式向Nacos Server注册自己的服务，提供自身的元数据，比如ip地址、端口等信息。Nacos Server接收到注册请求后，就会把这些元数据信息存储在一个双层的内存Map中。</p> 
<p><strong>服务心跳</strong>：在服务注册后，Nacos Client会维护一个定时心跳来持续通知Nacos Server，说明服务一直处于可用状态，防止被剔除。默认5s发送一次心跳。</p> 
<p><strong>服务同步</strong>：Nacos Server集群之间会互相同步服务实例，用来保证服务信息的一致性。 leader raft</p> 
<p><strong>服务发现</strong>：服务消费者（Nacos Client）在调用服务提供者的服务时，会发送一个REST请求给Nacos Server，获取上面注册的服务清单，并且缓存在Nacos Client本地，同时会在Nacos Client本地开启一个定时任务定时拉取服务端最新的注册表信息更新到本地缓存</p> 
<p><strong>服务健康检查</strong>：Nacos Server会开启一个定时任务用来检查注册服务实例的健康情况，对于超过15s没有收到客户端心跳的实例会将它的healthy属性置为false(客户端服务发现时不会发现)，如果某个实例超过30秒没有收到心跳，直接剔除该实例(被剔除的实例如果恢复发送心跳则会重新注册)</p> 
<p><strong>主流的注册中心</strong></p> 
<p>CAP C 一致性 A可用性 P 分区容错性</p> 
<img src="https://images2.imgbox.com/fd/09/3jOxWeVz_o.png"> 
<h4><a id="_48"></a>项目依赖</h4> 
<pre><code>        &lt;!--nacos-服务注册发现--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre> 
<h4><a id="_60"></a>配置项</h4> 
<p>官网 ：https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery#%E5%85%B3%E4%BA%8E-nacos-starter-%E6%9B%B4%E5%A4%9A%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%BF%A1%E6%81%AF</p> 
<p>在spring配置文件中配置项，服务端和客户端大致相同</p> 
<pre><code># 应用名称 （nacos会将该名称当做服务名称） ,
spring.application.name: nacos-producer


spring:
  cloud:
    nacos:
      server-addr: 61.171.5.6:30848 # 需要注意的是客户客户端会在此端口+1000的基础上获取通信端口，具体参考nacos安装中的几个端口
      discovery:
#        service: service-consumer  #注册的服务名称，不配置，默认取spring.application.name
#        register-enabled: false #一般会注册成服务提供者和消费者，如果不想成为服务提供者，这里设置false
        username: nacos # 服务端没有开启认证，这个也不需要
        password: nacos
        # group: nacos-producer1  # 默认使用DEFAULT_GROUP作为分组名称
        #service: nacos-producer1 # 默认使用spring.application.name作为服务名称
        #namespace: public #指定命名空间 ，
#        enabled: false # 如果不想使用服务注册和发现，

</code></pre> 
<p>com.alibaba.cloud.nacos.NacosDiscoveryProperties中你可以找到更多的配置项</p> 
<h4><a id="producer_91"></a>producer示例代码</h4> 
<p>一个用于演示的contrlller,有没有都不会影响客户端的注册</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/product"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${server.port}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"查询商品"</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"查询商品"</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<img src="https://images2.imgbox.com/31/22/sdpJzGtR_o.png"> 
<h4><a id="consumer_121"></a>consumer示例代码</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/order"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
<span class="token comment">//    http://localhost:8005/nacos-consumer/order/add</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/add"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"下单成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://nacos-producer/nacos-producer/123"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Hello World"</span> <span class="token operator">+</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestTemplateConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token class-name">RestTemplateBuilder</span> builder<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> restTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意版太新了，这个示例就不好用了，换了旧版本才跑起来，恶心，以下是我失败的版本，都已经不是客户端版本和服务端版本对应不上的问题了</p> 
<pre><code>		&lt;spring.cloud.alibaba.version&gt;2021.0.4.0&lt;/spring.cloud.alibaba.version&gt;
		&lt;spring.boot.version&gt;2.6.11&lt;/spring.boot.version&gt;
		&lt;spring.cloud.version&gt;2021.0.4&lt;/spring.cloud.version&gt;
</code></pre> 
<p>@LoadBalanced 会创建一个LoadBalancerClient的对象，LoadBalancerClient是一个接口，实现是由ribbon或者spring cloud 的<a href="https://docs.spring.io/spring-cloud-commons/docs/3.1.5/reference/html/#spring-cloud-loadbalancer" rel="nofollow"> LoadBalancer</a> 来实现，对比了一下依赖，发现2021.0.4这个版本中的nacos-discovery 缺少了默认引入的ribbon依赖，所以以上示例无法运行，添加如下依赖解决</p> 
<pre><code>&lt;!--spring cloud 父依赖中已经没有了这个，引入不了，添加版本号单独引入，但是没有了统一的依赖管理--&gt;
&lt;!--        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;
        &lt;/dependency&gt;--&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-loadbalancer&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre> 
<img src="https://images2.imgbox.com/b8/eb/uL3FDSiC_o.png"> 
<img src="https://images2.imgbox.com/cd/45/B0XkdR7F_o.png"> 
<h4><a id="_EndPoint_190"></a>服务的 EndPoint</h4> 
<p>需要添加配置项</p> 
<pre><code class="prism language-properties">management.endpoints.web.exposure.include=*
</code></pre> 
<pre><code class="prism language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>spring-cloud-starter-alibaba-nacos-discovery 在实现的时候提供了一个EndPoint,EndPoint的访问地址为 <code>http://ip:port/actuator/nacos-discovery</code>。 EndPoint 的信息主要提供了两类:</p> 
<pre><code>1、subscribe: 显示了当前有哪些服务订阅者
2、NacosDiscoveryProperties: 显示了当前服务实例关于 Nacos 的基础配置
</code></pre> 
<p>一个服务实例访问 EndPoint 的信息如下所示：</p> 
<pre><code>{
  "subscribe": [
    {
      "jsonFromServer": "",
      "name": "nacos-provider",
      "clusters": "",
      "cacheMillis": 10000,
      "hosts": [
        {
          "instanceId": "30.5.124.156#8081#DEFAULT#nacos-provider",
          "ip": "30.5.124.156",
          "port": 8081,
          "weight": 1.0,
          "healthy": true,
          "enabled": true,
          "cluster": {
            "serviceName": null,
            "name": null,
            "healthChecker": {
              "type": "TCP"
            },
            "defaultPort": 80,
            "defaultCheckPort": 80,
            "useIPPort4Check": true,
            "metadata": {

            }
          },
          "service": null,
          "metadata": {

          }
        }
      ],
      "lastRefTime": 1541755293119,
      "checksum": "e5a699c9201f5328241c178e804657e11541755293119",
      "allIPs": false,
      "key": "nacos-producer",
      "valid": true
    }
  ],
  "NacosDiscoveryProperties": {
    "serverAddr": "127.0.0.1:8848",
    "endpoint": "",
    "namespace": "",
    "logName": "",
    "service": "nacos-provider",
    "weight": 1.0,
    "clusterName": "DEFAULT",
    "metadata": {

    },
    "registerEnabled": true,
    "ip": "30.5.124.201",
    "networkInterface": "",
    "port": 8082,
    "secure": false,
    "accessKey": "",
    "secretKey": ""
  }
}
</code></pre> 
<h4><a id="_278"></a>一份比较完整服务发现的配置展示</h4> 
<p>未测试，未使用，仅记录</p> 
<pre><code>spring:
  cloud:
    nacos:
      discovery:
        # Nacos的服务注册地址，可以配置多个，逗号分隔
        server-addr: localhost:8848
        # 服务注册到Nacos上的名称，一般不用配置
        service: coupon-customer-serv
        # nacos客户端向服务端发送心跳的时间间隔，时间单位其实是ms
        heart-beat-interval: 5000
        # 服务端没有接受到客户端心跳请求就将其设为不健康的时间间隔，默认为15s
        # 注：推荐值该值为15s即可，如果有的业务线希望服务下线或者出故障时希望尽快被发现，可以适当减少该值
        heart-beat-timeout: 20000
        # 元数据部分 - 可以自己随便定制
        metadata:
          mydata: abc
        # 客户端在启动时是否读取本地配置项(一个文件)来获取服务列表
        # 注：推荐该值为false，若改成true。则客户端会在本地的一个
        # 文件中保存服务信息，当下次宕机启动时，会优先读取本地的配置对外提供服务。
        naming-load-cache-at-start: false
        # 命名空间ID，Nacos通过不同的命名空间来区分不同的环境，进行数据隔离，
        namespace: dev
        # 创建不同的集群
        cluster-name: Cluster-A
        # [注意]两个服务如果存在上下游调用关系，必须配置相同的group才能发起访问
        group: myGroup
        # 向注册中心注册服务，默认为true
        # 如果只消费服务，不作为服务提供方，倒是可以设置成false，减少开销
        register-enabled: true

</code></pre> 
<h3><a id="nacos_317"></a>nacos配置中心</h3> 
<p>以下是引入springCloud依赖的用法，单独在springBoot中使用请参考官网</p> 
<p>官方文档： https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-config</p> 
<p>Nacos 提供用于存储配置和其他元数据的 key/value 存储，为分布式系统中的外部化配置提供服务器端和客户端支持。使用 Spring Cloud Alibaba Nacos Config，您可以在 Nacos Server 集中管理你 Spring Cloud 应用的外部属性配置。</p> 
<p>1.维护性 2.时效性 3.安全性</p> 
<img src="https://images2.imgbox.com/64/c3/Di10ToW1_o.jpg"> 
<p><strong>springcloud config 对比</strong></p> 
<p><strong>三大优势：</strong></p> 
<ul><li>springcloud config大部分场景结合git 使用, 动态变更还需要依赖Spring Cloud Bus 消息总线来通过所有的客户端变化.</li><li>springcloud config不提供可视化界面</li><li>nacos config使用长轮询更新配置, 一旦配置有变动后，通知Provider的过程非常的迅速, 从速度上秒杀springcloud原来的config几条街,</li></ul> 
<img src="https://images2.imgbox.com/66/f6/VxWTXpBS_o.png"> 
<h4><a id="11__341"></a><strong>1.1 快速开始</strong></h4> 
<p>准备配置，nacos server中新建nacos-config.properties</p> 
<img src="https://images2.imgbox.com/71/24/MMkL2bHA_o.png"> 
<img src="https://images2.imgbox.com/f8/c5/sPRTPaMH_o.png"> 
<p>最佳实践：</p> 
<p>Namespace：代表不同<strong>环境</strong>，如开发、测试、生产环境。</p> 
<p>Group：代表某<strong>项目</strong>，如XX医疗项目、XX电商项目</p> 
<p>DataId：每个项目下往往有若干个<strong>工程（微服务）</strong>，每个配置集(DataId)是一个<strong>工程（微服务）<strong>的</strong>主配置文件</strong></p> 
<img src="https://images2.imgbox.com/96/1b/58XM1GUw_o.png"> 
<h5><a id="_363"></a>权限配置</h5> 
<p>nacos权限设定，修改修改conf目录下application.properties</p> 
<pre><code>nacos.core.auth.enabled=true
</code></pre> 
<img src="https://images2.imgbox.com/83/a2/IkiCM3ex_o.png"> 
<p>只支持命名空间这一级别的权限管理，</p> 
<h4><a id="12_nacosconfig_379"></a><strong>1.2 搭建nacos-config服务</strong></h4> 
<p>通过 Nacos Server 和 spring-cloud-starter-alibaba-nacos-config 实现配置的动态变更</p> 
<h5><a id="1_385"></a>1）引入依赖</h5> 
<pre><code>        &lt;!--Nacos config依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre> 
<h5><a id="2bootstrapyml_395"></a>2）添加bootstrap.yml</h5> 
<p>（就像springboot约定的配置文件是application.properties一样，这个文件会被springCloud进行加载，格式可以是yml和properties格式）</p> 
<pre><code>spring:
  cloud:
    nacos:
      server-addr: 61.171.5.6:30848
      username: nacos
      password: nacos
</code></pre> 
<h5><a id="3_408"></a>3）启动服务，测试微服务是否使用配置中心的配置</h5> 
<pre><code>@SpringBootApplication
@Slf4j
public class NacosConfigApplication {


    public static void main(String[] args) throws InterruptedException {
        ConfigurableApplicationContext applicationContext = SpringApplication.run(NacosConfigApplication.class, args);
        while (true) {
            String userName = applicationContext.getEnvironment().getProperty("user.name");
            String userAge = applicationContext.getEnvironment().getProperty("user.age");
            String config = applicationContext.getEnvironment().getProperty("user.config");
            System.err.println("user name :" + userName + "; age: " + userAge+";config:"+config);
            TimeUnit.SECONDS.sleep(1);
        }
    }
}
</code></pre> 
<h5><a id="_431"></a>报错：</h5> 
<p>1、</p> 
<pre><code>org.springframework.cloud.commons.ConfigDataMissingEnvironmentPostProcessor$ImportException: No spring.config.import set
</code></pre> 
<p>​ Spring Cloud 新版本默认将 Bootstrap 禁用，需要将 spring-cloud-starter-bootstrap 依赖引入到工程中：</p> 
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;
&lt;/dependency&gt;

</code></pre> 
<p>​ 无语了，禁用了，还不让放在application.properties里面</p> 
<h4><a id="_453"></a>配置优先级别</h4> 
<p>多份配置文件中可能有重复配置，优先级别高的配置生效，</p> 
<p>在 Nacos Spring Cloud 中，<code>dataId</code> 的完整格式如下：</p> 
<pre><code class="prism language-plain">${prefix}-${spring.profiles.active}.${file-extension}
</code></pre> 
<ul><li><code>prefix</code> 默认为 <code>spring.application.name</code> 的值，也可以通过配置项 <code>spring.cloud.nacos.config.prefix</code>来配置。</li><li><code>spring.profiles.active</code> 即为当前环境对应的 profile，详情可以参考 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html#boot-features-profiles" rel="nofollow">Spring Boot文档</a>。 <strong>注意：当 <code>spring.profiles.active</code> 为空时，对应的连接符 <code>-</code> 也将不存在，dataId 的拼接格式变成 <code>${prefix}.${file-extension}</code></strong></li><li><code>file-exetension</code> 为配置内容的数据格式，可以通过配置项 <code>spring.cloud.nacos.config.file-extension</code> 来配置。目前只支持 <code>properties</code> 和 <code>yaml</code> 类型。</li></ul> 
<h5><a id="_471"></a>一份比较完整的测试优先级的配置</h5> 
<pre><code>spring.application.name: nacos-config
  # 会自动根据服务名拉取dataid对应的配置文件。  如果dataid跟服务名不一致 就需要手动指定dataid
  # 跟服务名相同的dataid的配置文件，称之为默认的配置文件
  # 除了默认的配置文件 ，其他配置文件必须写上后缀

spring:
  cloud:
    nacos:
      server-addr: 61.171.5.6:30848
      username: nacos
      password: nacos
      # 解决控制台循环打印ClientWorker日志
#      config:
#        namespace: public

      # Nacos客户端 默认是Properties的文件扩展名 (只针对默认配置文件和profile)
      # 一旦修改成了非Properties格式，则必须通过file-extension进行设置
      config:
        file-extension: properties
        #refresh-enabled: false   nacos客户端将无法感知配置的变化
#        namespace: public # public默认的命名空间,可以注释掉，加上了似乎有在控制台循环打印ClientWorker日志的问题，我这个版本似乎没这个问题，不过加上了之后会有配置无法读取的问题，所以如果是默认的命名空间还是注释吧
        group: DEFAULT_GROUP
        shared-configs:
          - data-id: cn.sry1201.common.yaml  #[0]
            refresh: true
            group:  common_group #默认是Default-group
          - data-id: cn.sry1201.common02.yaml #[1]
            refresh: true
            group:  common_group
        extension-configs[0]:
          data-id: cn.sry1201.share.yaml
          refresh: true
          group: extension_group
</code></pre> 
<h5><a id="_509"></a>优先级</h5> 
<p><code>${prefix}-${spring.profiles.active}.${file-extension} </code> &gt;<code>${prefix}.${file-extension}</code> &gt;&gt;extension-configs(下标越大优先级就越大)&gt;shared-configs(下标越大优先级就越大)</p> 
<h4><a id="15_RefreshScope_517"></a><strong>1.5 @RefreshScope</strong></h4> 
<p>@Value注解可以获取到配置中心的值，但是无法动态感知修改后的值，需要利用@RefreshScope注解</p> 
<pre><code>@RestController
@RequestMapping("/config")
@RefreshScope
public class ConfigController {

    @Value("${user.name}")
    public String name;

    @RequestMapping("/show")
    public String show(){
        return name;
    }
}
</code></pre> 
<p>nacos整合logback日志</p> 
<p>似乎是通过nacos接口获取日志文件，没测试，仅仅进行记录,日志的话，应该也没有动态生效吧</p> 
<pre><code>logging:
  # 指定日志配置文件位置，指定之后，外部配置文件失效，但是可以被配置文件内部引用，注意logback-spring.xml这个名称不能修改
  config: http://(spring.cloud.naoos.config.server-addr)/onfigs?group-DEFAULT_GROUP&amp;tenant-S(spring cloucj&amp;datald-logback-spring.xml
</code></pre> 
<h3><a id="_551"></a>关联信息</h3> 
<ul><li>关联的主题：</li><li>上一篇：</li><li>下一篇：</li><li>image: 20221021/1</li><li>转载自：</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a4b9056511e1d8f64f533a44b9df6441/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">机器学习笔记：第2章 模型评估与选择</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fad94546269eadf183117654a278412b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python GUI界面点击按钮后显示未响应卡住无法移动的解决办法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>