<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OBS框架流程和源码分析五一数据采集 渲染 编码过程 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="OBS框架流程和源码分析五一数据采集 渲染 编码过程" />
<meta property="og:description" content="程序启动时 会调用 obs_init_video函数，创建一个obs_video_thread 线程
static int obs_init_video(struct obs_video_info *ovi) { struct obs_core_video *video = &amp;obs-&gt;video; struct video_output_info vi; int errorcode; make_video_info(&amp;vi, ovi); video-&gt;base_width = ovi-&gt;base_width; video-&gt;base_height = ovi-&gt;base_height; video-&gt;output_width = ovi-&gt;output_width; video-&gt;output_height = ovi-&gt;output_height; video-&gt;gpu_conversion = ovi-&gt;gpu_conversion; video-&gt;scale_type = ovi-&gt;scale_type; set_video_matrix(video, ovi); errorcode = video_output_open(&amp;video-&gt;video, &amp;vi); if (errorcode != VIDEO_OUTPUT_SUCCESS) { if (errorcode == VIDEO_OUTPUT_INVALIDPARAM) { blog(LOG_ERROR, &#34;Invalid video parameters specified&#34;); return OBS_VIDEO_INVALID_PARAM; } else { blog(LOG_ERROR, &#34;Could not open video output&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e840745cfebd00d043bb4a62a0a2b5c0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-19T14:31:27+08:00" />
<meta property="article:modified_time" content="2021-01-19T14:31:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OBS框架流程和源码分析五一数据采集 渲染 编码过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>程序启动时 会调用 obs_init_video函数，创建一个obs_video_thread 线程</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">obs_init_video</span><span class="token punctuation">(</span><span class="token keyword">struct</span> obs_video_info <span class="token operator">*</span>ovi<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> obs_core_video <span class="token operator">*</span>video <span class="token operator">=</span> <span class="token operator">&amp;</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> video_output_info vi<span class="token punctuation">;</span>
	<span class="token keyword">int</span> errorcode<span class="token punctuation">;</span>

	<span class="token function">make_video_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vi<span class="token punctuation">,</span> ovi<span class="token punctuation">)</span><span class="token punctuation">;</span>
	video<span class="token operator">-</span><span class="token operator">&gt;</span>base_width     <span class="token operator">=</span> ovi<span class="token operator">-</span><span class="token operator">&gt;</span>base_width<span class="token punctuation">;</span>
	video<span class="token operator">-</span><span class="token operator">&gt;</span>base_height    <span class="token operator">=</span> ovi<span class="token operator">-</span><span class="token operator">&gt;</span>base_height<span class="token punctuation">;</span>
	video<span class="token operator">-</span><span class="token operator">&gt;</span>output_width   <span class="token operator">=</span> ovi<span class="token operator">-</span><span class="token operator">&gt;</span>output_width<span class="token punctuation">;</span>
	video<span class="token operator">-</span><span class="token operator">&gt;</span>output_height  <span class="token operator">=</span> ovi<span class="token operator">-</span><span class="token operator">&gt;</span>output_height<span class="token punctuation">;</span>
	video<span class="token operator">-</span><span class="token operator">&gt;</span>gpu_conversion <span class="token operator">=</span> ovi<span class="token operator">-</span><span class="token operator">&gt;</span>gpu_conversion<span class="token punctuation">;</span>
	video<span class="token operator">-</span><span class="token operator">&gt;</span>scale_type     <span class="token operator">=</span> ovi<span class="token operator">-</span><span class="token operator">&gt;</span>scale_type<span class="token punctuation">;</span>

	<span class="token function">set_video_matrix</span><span class="token punctuation">(</span>video<span class="token punctuation">,</span> ovi<span class="token punctuation">)</span><span class="token punctuation">;</span>

	errorcode <span class="token operator">=</span> <span class="token function">video_output_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vi<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>errorcode <span class="token operator">!=</span> VIDEO_OUTPUT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>errorcode <span class="token operator">==</span> VIDEO_OUTPUT_INVALIDPARAM<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">blog</span><span class="token punctuation">(</span>LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Invalid video parameters specified"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> OBS_VIDEO_INVALID_PARAM<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">blog</span><span class="token punctuation">(</span>LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Could not open video output"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> OBS_VIDEO_FAIL<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">gs_enter_context</span><span class="token punctuation">(</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>graphics<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ovi<span class="token operator">-</span><span class="token operator">&gt;</span>gpu_conversion <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">obs_init_gpu_conversion</span><span class="token punctuation">(</span>ovi<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> OBS_VIDEO_FAIL<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">obs_init_textures</span><span class="token punctuation">(</span>ovi<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> OBS_VIDEO_FAIL<span class="token punctuation">;</span>

	<span class="token function">gs_leave_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	errorcode <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>video_thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
			obs_video_thread<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>errorcode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> OBS_VIDEO_FAIL<span class="token punctuation">;</span>

	video<span class="token operator">-</span><span class="token operator">&gt;</span>thread_initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> OBS_VIDEO_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>obs_video_thread线程中 进行 数据采集 ，渲染 、保存数据到 缓冲区</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">obs_video_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>param<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">uint64_t</span> last_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">uint64_t</span> interval <span class="token operator">=</span> <span class="token function">video_output_get_frame_time</span><span class="token punctuation">(</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>video<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">uint64_t</span> fps_total_ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">uint32_t</span> fps_total_frames <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>video_time <span class="token operator">=</span> <span class="token function">os_gettime_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">os_set_thread_name</span><span class="token punctuation">(</span><span class="token string">"libobs: graphics thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>video_thread_name <span class="token operator">=</span>
		<span class="token function">profile_store_name</span><span class="token punctuation">(</span><span class="token function">obs_get_profiler_name_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">"obs_video_thread(%g"</span>NBSP<span class="token string">"ms)"</span><span class="token punctuation">,</span> interval <span class="token operator">/</span> <span class="token number">1000000.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">profile_register_root</span><span class="token punctuation">(</span>video_thread_name<span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">video_output_stopped</span><span class="token punctuation">(</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>video<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">profile_start</span><span class="token punctuation">(</span>video_thread_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">profile_start</span><span class="token punctuation">(</span>tick_sources_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		last_time <span class="token operator">=</span> <span class="token function">tick_sources</span><span class="token punctuation">(</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>video_time<span class="token punctuation">,</span> last_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">profile_end</span><span class="token punctuation">(</span>tick_sources_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">profile_start</span><span class="token punctuation">(</span>render_displays_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">render_displays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">profile_end</span><span class="token punctuation">(</span>render_displays_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">profile_start</span><span class="token punctuation">(</span>output_frame_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">output_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">profile_end</span><span class="token punctuation">(</span>output_frame_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">profile_end</span><span class="token punctuation">(</span>video_thread_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">profile_reenable_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">video_sleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>video_time<span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>

		fps_total_ns <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>video_time <span class="token operator">-</span> last_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
		fps_total_frames<span class="token operator">++</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>fps_total_ns <span class="token operator">&gt;=</span> <span class="token number">1000000000ULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>video_fps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>fps_total_frames <span class="token operator">/</span>
				<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>fps_total_ns <span class="token operator">/</span> <span class="token number">1000000000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			fps_total_ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			fps_total_frames <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token function">UNUSED_PARAMETER</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>tick_sources遍历当前加入的所有source，调用obs_source_video_tick</p> 
<pre><code class="prism language-cpp"> <span class="token keyword">static</span> <span class="token keyword">uint64_t</span> <span class="token function">tick_sources</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> cur_time<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> last_time<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> obs_core_data <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token operator">&amp;</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> obs_source    <span class="token operator">*</span>source<span class="token punctuation">;</span>
	<span class="token keyword">uint64_t</span>             delta_time<span class="token punctuation">;</span>
	<span class="token keyword">float</span>                seconds<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>last_time<span class="token punctuation">)</span>
		last_time <span class="token operator">=</span> cur_time <span class="token operator">-</span>
			<span class="token function">video_output_get_frame_time</span><span class="token punctuation">(</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>video<span class="token punctuation">)</span><span class="token punctuation">;</span>

	delta_time <span class="token operator">=</span> cur_time <span class="token operator">-</span> last_time<span class="token punctuation">;</span>
	seconds <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>delta_time <span class="token operator">/</span> <span class="token number">1000000000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-</span><span class="token operator">&gt;</span>sources_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* call the tick function of each source */</span>
	source <span class="token operator">=</span> data<span class="token operator">-</span><span class="token operator">&gt;</span>first_source<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">obs_source_video_tick</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
		source <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> obs_source<span class="token operator">*</span><span class="token punctuation">)</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>context<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-</span><span class="token operator">&gt;</span>sources_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> cur_time<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>obs_source_video_tick 最终会调用 函数指针 video_tick</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">obs_source_video_tick</span><span class="token punctuation">(</span>obs_source_t <span class="token operator">*</span>source<span class="token punctuation">,</span> <span class="token keyword">float</span> seconds<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">bool</span> now_showing<span class="token punctuation">,</span> now_active<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">obs_source_valid</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token string">"obs_source_video_tick"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>info<span class="token punctuation">.</span>type <span class="token operator">==</span> OBS_SOURCE_TYPE_TRANSITION<span class="token punctuation">)</span>
		<span class="token function">obs_transition_tick</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>info<span class="token punctuation">.</span>output_flags <span class="token operator">&amp;</span> OBS_SOURCE_ASYNC<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">uint64_t</span> sys_time <span class="token operator">=</span> obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>video_time<span class="token punctuation">;</span>

		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>async_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">deinterlacing_enabled</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">deinterlace_process_last_frame</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> sys_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>cur_async_frame<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">remove_async_frame</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span>
						source<span class="token operator">-</span><span class="token operator">&gt;</span>cur_async_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
				source<span class="token operator">-</span><span class="token operator">&gt;</span>cur_async_frame <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			source<span class="token operator">-</span><span class="token operator">&gt;</span>cur_async_frame <span class="token operator">=</span> <span class="token function">get_closest_frame</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span>
					sys_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		source<span class="token operator">-</span><span class="token operator">&gt;</span>last_sys_timestamp <span class="token operator">=</span> sys_time<span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>async_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>defer_update<span class="token punctuation">)</span>
		<span class="token function">obs_source_deferred_update</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* reset the filter render texture information once every frame */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>filter_texrender<span class="token punctuation">)</span>
		<span class="token function">gs_texrender_reset</span><span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>filter_texrender<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* call show/hide if the reference changed */</span>
	now_showing <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>show_refs<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>now_showing <span class="token operator">!=</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>showing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>now_showing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">show_source</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">hide_source</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		source<span class="token operator">-</span><span class="token operator">&gt;</span>showing <span class="token operator">=</span> now_showing<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* call activate/deactivate if the reference changed */</span>
	now_active <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>activate_refs<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>now_active <span class="token operator">!=</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>now_active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">activate_source</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">deactivate_source</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		source<span class="token operator">-</span><span class="token operator">&gt;</span>active <span class="token operator">=</span> now_active<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>context<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>info<span class="token punctuation">.</span>video_tick<span class="token punctuation">)</span>
		source<span class="token operator">-</span><span class="token operator">&gt;</span>info<span class="token punctuation">.</span><span class="token function">video_tick</span><span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>context<span class="token punctuation">.</span>data<span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>

	source<span class="token operator">-</span><span class="token operator">&gt;</span>async_rendered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	source<span class="token operator">-</span><span class="token operator">&gt;</span>deinterlace_rendered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>video_tick 在每个插件对应的结构体中进行初始化，例如window-capture 窗口捕获</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> obs_source_info window_capture_info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>id             <span class="token operator">=</span> <span class="token string">"window_capture"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>type           <span class="token operator">=</span> OBS_SOURCE_TYPE_INPUT<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>output_flags   <span class="token operator">=</span> OBS_SOURCE_VIDEO <span class="token operator">|</span> OBS_SOURCE_CUSTOM_DRAW<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>get_name       <span class="token operator">=</span> wc_getname<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>create         <span class="token operator">=</span> wc_create<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>destroy        <span class="token operator">=</span> wc_destroy<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>update         <span class="token operator">=</span> wc_update<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>video_render   <span class="token operator">=</span> wc_render<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>video_tick     <span class="token operator">=</span> wc_tick<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>get_width      <span class="token operator">=</span> wc_width<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>get_height     <span class="token operator">=</span> wc_height<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>get_defaults   <span class="token operator">=</span> wc_defaults<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>get_properties <span class="token operator">=</span> wc_properties
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>wc_tick进行数据采集，采集的数据放到了source-&gt;context.data中</p> 
<p>数据读取到后 进行渲染</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">render_displays</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> obs_display <span class="token operator">*</span>display<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">.</span>valid<span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token function">gs_enter_context</span><span class="token punctuation">(</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>video<span class="token punctuation">.</span>graphics<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* render extra displays/swaps */</span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">.</span>displays_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	display <span class="token operator">=</span> obs<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">.</span>first_display<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>display<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">render_display</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
		display <span class="token operator">=</span> display<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obs<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">.</span>displays_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">gs_leave_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">render_display</span><span class="token punctuation">(</span><span class="token keyword">struct</span> obs_display <span class="token operator">*</span>display<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>display <span class="token operator">||</span> <span class="token operator">!</span>display<span class="token operator">-</span><span class="token operator">&gt;</span>enabled<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token function">render_display_begin</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>display<span class="token operator">-</span><span class="token operator">&gt;</span>draw_callbacks_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> display<span class="token operator">-</span><span class="token operator">&gt;</span>draw_callbacks<span class="token punctuation">.</span>num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> draw_callback <span class="token operator">*</span>callback<span class="token punctuation">;</span>
		callback <span class="token operator">=</span> display<span class="token operator">-</span><span class="token operator">&gt;</span>draw_callbacks<span class="token punctuation">.</span>array<span class="token operator">+</span>i<span class="token punctuation">;</span>

		callback<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">draw</span><span class="token punctuation">(</span>callback<span class="token operator">-</span><span class="token operator">&gt;</span>param<span class="token punctuation">,</span> display<span class="token operator">-</span><span class="token operator">&gt;</span>cx<span class="token punctuation">,</span> display<span class="token operator">-</span><span class="token operator">&gt;</span>cy<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>display<span class="token operator">-</span><span class="token operator">&gt;</span>draw_callbacks_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">render_display_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>callback-&gt;draw 对应 RenderMain<br> 最终</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">obs_view_render</span><span class="token punctuation">(</span>obs_view_t <span class="token operator">*</span>view<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>view<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>view<span class="token operator">-</span><span class="token operator">&gt;</span>channels_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_CHANNELS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> obs_source <span class="token operator">*</span>source<span class="token punctuation">;</span>

		source <span class="token operator">=</span> view<span class="token operator">-</span><span class="token operator">&gt;</span>channels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>removed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">obs_source_release</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
				view<span class="token operator">-</span><span class="token operator">&gt;</span>channels<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">obs_source_video_render</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>view<span class="token operator">-</span><span class="token operator">&gt;</span>channels_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>会调用到</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">obs_source_main_render</span><span class="token punctuation">(</span>obs_source_t <span class="token operator">*</span>source<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">uint32_t</span> flags      <span class="token operator">=</span> source<span class="token operator">-</span><span class="token operator">&gt;</span>info<span class="token punctuation">.</span>output_flags<span class="token punctuation">;</span>
	<span class="token keyword">bool</span> custom_draw    <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> OBS_SOURCE_CUSTOM_DRAW<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">bool</span> default_effect <span class="token operator">=</span> <span class="token operator">!</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>filter_parent <span class="token operator">&amp;&amp;</span>
	                      source<span class="token operator">-</span><span class="token operator">&gt;</span>filters<span class="token punctuation">.</span>num <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
	                      <span class="token operator">!</span>custom_draw<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>default_effect<span class="token punctuation">)</span>
		<span class="token function">obs_source_default_render</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>context<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
		source<span class="token operator">-</span><span class="token operator">&gt;</span>info<span class="token punctuation">.</span><span class="token function">video_render</span><span class="token punctuation">(</span>source<span class="token operator">-</span><span class="token operator">&gt;</span>context<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
				custom_draw <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> <span class="token function">gs_get_effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而video_render在插件结构体中进行了初始化，最后调用到wc_render，然后数据传送到 opengl 或者d3d中进行处理，显示</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">wc_render</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> gs_effect_t <span class="token operator">*</span>effect<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> window_capture <span class="token operator">*</span>wc <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token function">dc_capture_render</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wc<span class="token operator">-</span><span class="token operator">&gt;</span>capture<span class="token punctuation">,</span> <span class="token function">obs_get_base_effect</span><span class="token punctuation">(</span>OBS_EFFECT_OPAQUE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">UNUSED_PARAMETER</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而obs_video_thread线程通过out_frame获取opengl 或者d3d处理后的数据，然后把数据放到缓冲区</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">output_frame</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> obs_core_video <span class="token operator">*</span>video <span class="token operator">=</span> <span class="token operator">&amp;</span>obs<span class="token operator">-&gt;</span>video<span class="token punctuation">;</span>
	<span class="token keyword">int</span> cur_texture  <span class="token operator">=</span> video<span class="token operator">-&gt;</span>cur_texture<span class="token punctuation">;</span>
	<span class="token keyword">int</span> prev_texture <span class="token operator">=</span> cur_texture <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> NUM_TEXTURES<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> cur_texture<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> video_data frame<span class="token punctuation">;</span>
	bool frame_ready<span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> video_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">profile_start</span><span class="token punctuation">(</span>output_frame_gs_context_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">gs_enter_context</span><span class="token punctuation">(</span>video<span class="token operator">-&gt;</span>graphics<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">profile_start</span><span class="token punctuation">(</span>output_frame_render_video_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">render_video</span><span class="token punctuation">(</span>video<span class="token punctuation">,</span> cur_texture<span class="token punctuation">,</span> prev_texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">profile_end</span><span class="token punctuation">(</span>output_frame_render_video_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">profile_start</span><span class="token punctuation">(</span>output_frame_download_frame_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	frame_ready <span class="token operator">=</span> <span class="token function">download_frame</span><span class="token punctuation">(</span>video<span class="token punctuation">,</span> prev_texture<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得数据buffer指针</span>
	<span class="token function">profile_end</span><span class="token punctuation">(</span>output_frame_download_frame_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">profile_start</span><span class="token punctuation">(</span>output_frame_gs_flush_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">gs_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">profile_end</span><span class="token punctuation">(</span>output_frame_gs_flush_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">gs_leave_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">profile_end</span><span class="token punctuation">(</span>output_frame_gs_context_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>frame_ready<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> obs_vframe_info vframe_info<span class="token punctuation">;</span>
		<span class="token function">circlebuf_pop_front</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-&gt;</span>vframe_info_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vframe_info<span class="token punctuation">,</span>
				<span class="token keyword">sizeof</span><span class="token punctuation">(</span>vframe_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		frame<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> vframe_info<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
		<span class="token function">profile_start</span><span class="token punctuation">(</span>output_frame_output_video_data_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">output_video_data</span><span class="token punctuation">(</span>video<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">,</span> vframe_info<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">profile_end</span><span class="token punctuation">(</span>output_frame_output_video_data_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>video<span class="token operator">-&gt;</span>cur_texture <span class="token operator">==</span> NUM_TEXTURES<span class="token punctuation">)</span>
		video<span class="token operator">-&gt;</span>cur_texture <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>数据最终保存在video cache中，</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">video_output_lock_frame</span><span class="token punctuation">(</span>video_t <span class="token operator">*</span>video<span class="token punctuation">,</span> <span class="token keyword">struct</span> video_frame <span class="token operator">*</span>frame<span class="token punctuation">,</span>
		<span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> timestamp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> cached_frame_info <span class="token operator">*</span>cfi<span class="token punctuation">;</span>
	<span class="token keyword">bool</span> locked<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>video<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>data_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>available_frames <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		video<span class="token operator">-</span><span class="token operator">&gt;</span>skipped_frames <span class="token operator">+</span><span class="token operator">=</span> count<span class="token punctuation">;</span>
		video<span class="token operator">-</span><span class="token operator">&gt;</span>cache<span class="token punctuation">[</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>last_added<span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">+</span><span class="token operator">=</span> count<span class="token punctuation">;</span>
		locked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>available_frames <span class="token operator">!=</span> video<span class="token operator">-</span><span class="token operator">&gt;</span>info<span class="token punctuation">.</span>cache_size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>last_added <span class="token operator">==</span> video<span class="token operator">-</span><span class="token operator">&gt;</span>info<span class="token punctuation">.</span>cache_size<span class="token punctuation">)</span>
				video<span class="token operator">-</span><span class="token operator">&gt;</span>last_added <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		cfi <span class="token operator">=</span> <span class="token operator">&amp;</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>cache<span class="token punctuation">[</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>last_added<span class="token punctuation">]</span><span class="token punctuation">;</span>
		cfi<span class="token operator">-</span><span class="token operator">&gt;</span>frame<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
		cfi<span class="token operator">-</span><span class="token operator">&gt;</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>

		<span class="token function">memcpy</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cfi<span class="token operator">-</span><span class="token operator">&gt;</span>frame<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>frame<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		locked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>data_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> locked<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">video_sleep</span><span class="token punctuation">(</span><span class="token keyword">struct</span> obs_core_video <span class="token operator">*</span>video<span class="token punctuation">,</span>
		<span class="token keyword">uint64_t</span> <span class="token operator">*</span>p_time<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> interval_ns<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> obs_vframe_info vframe_info<span class="token punctuation">;</span>
	<span class="token keyword">uint64_t</span> cur_time <span class="token operator">=</span> <span class="token operator">*</span>p_time<span class="token punctuation">;</span>
	<span class="token keyword">uint64_t</span> t <span class="token operator">=</span> cur_time <span class="token operator">+</span> interval_ns<span class="token punctuation">;</span>
	<span class="token keyword">int</span> count<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">os_sleepto_ns</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>p_time <span class="token operator">=</span> t<span class="token punctuation">;</span>
		count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">os_gettime_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cur_time<span class="token punctuation">)</span> <span class="token operator">/</span> interval_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span>p_time <span class="token operator">=</span> cur_time <span class="token operator">+</span> interval_ns <span class="token operator">*</span> count<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	video<span class="token operator">-</span><span class="token operator">&gt;</span>total_frames <span class="token operator">+</span><span class="token operator">=</span> count<span class="token punctuation">;</span>
	video<span class="token operator">-</span><span class="token operator">&gt;</span>lagged_frames <span class="token operator">+</span><span class="token operator">=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

	vframe_info<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> cur_time<span class="token punctuation">;</span>
	vframe_info<span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
	<span class="token function">circlebuf_push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>vframe_info_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vframe_info<span class="token punctuation">,</span>
			<span class="token keyword">sizeof</span><span class="token punctuation">(</span>vframe_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编码线程 video_thread 取数据 ，编码 ，数据放到缓冲区</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">video_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>param<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> video_output <span class="token operator">*</span>video <span class="token operator">=</span> param<span class="token punctuation">;</span>

	<span class="token function">os_set_thread_name</span><span class="token punctuation">(</span><span class="token string">"video-io: video thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>video_thread_name <span class="token operator">=</span>
		<span class="token function">profile_store_name</span><span class="token punctuation">(</span><span class="token function">obs_get_profiler_name_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token string">"video_thread(%s)"</span><span class="token punctuation">,</span> video<span class="token operator">-</span><span class="token operator">&gt;</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">os_sem_wait</span><span class="token punctuation">(</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>update_semaphore<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>stop<span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>

		<span class="token function">profile_start</span><span class="token punctuation">(</span>video_thread_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>video<span class="token operator">-</span><span class="token operator">&gt;</span>stop <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">video_output_cur_frame</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			video<span class="token operator">-</span><span class="token operator">&gt;</span>total_frames<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		video<span class="token operator">-</span><span class="token operator">&gt;</span>total_frames<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">profile_end</span><span class="token punctuation">(</span>video_thread_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">profile_reenable_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> bool <span class="token function">video_output_cur_frame</span><span class="token punctuation">(</span><span class="token keyword">struct</span> video_output <span class="token operator">*</span>video<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> cached_frame_info <span class="token operator">*</span>frame_info<span class="token punctuation">;</span>
	bool complete<span class="token punctuation">;</span>

	<span class="token comment">/* -------------------------------- */</span>

	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-&gt;</span>data_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	frame_info <span class="token operator">=</span> <span class="token operator">&amp;</span>video<span class="token operator">-&gt;</span>cache<span class="token punctuation">[</span>video<span class="token operator">-&gt;</span>first_added<span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-&gt;</span>data_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* -------------------------------- */</span>

	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-&gt;</span>input_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> video<span class="token operator">-&gt;</span>inputs<span class="token punctuation">.</span>num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> video_input <span class="token operator">*</span>input <span class="token operator">=</span> video<span class="token operator">-&gt;</span>inputs<span class="token punctuation">.</span>array<span class="token operator">+</span>i<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> video_data frame <span class="token operator">=</span> frame_info<span class="token operator">-&gt;</span>frame<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">scale_video_output</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">)</span>
			input<span class="token operator">-&gt;</span><span class="token function">callback</span><span class="token punctuation">(</span>input<span class="token operator">-&gt;</span>param<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-&gt;</span>input_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* -------------------------------- */</span>

	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-&gt;</span>data_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	frame_info<span class="token operator">-&gt;</span>frame<span class="token punctuation">.</span>timestamp <span class="token operator">+</span><span class="token operator">=</span> video<span class="token operator">-&gt;</span>frame_time<span class="token punctuation">;</span>
	complete <span class="token operator">=</span> <span class="token operator">--</span>frame_info<span class="token operator">-&gt;</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>video<span class="token operator">-&gt;</span>first_added <span class="token operator">==</span> video<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>cache_size<span class="token punctuation">)</span>
			video<span class="token operator">-&gt;</span>first_added <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>video<span class="token operator">-&gt;</span>available_frames <span class="token operator">==</span> video<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>cache_size<span class="token punctuation">)</span>
			video<span class="token operator">-&gt;</span>last_added <span class="token operator">=</span> video<span class="token operator">-&gt;</span>first_added<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video<span class="token operator">-&gt;</span>data_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* -------------------------------- */</span>

	<span class="token keyword">return</span> complete<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>input-&gt;callback对应 receive_video</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">receive_video</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>param<span class="token punctuation">,</span> <span class="token keyword">struct</span> video_data <span class="token operator">*</span>frame<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">profile_start</span><span class="token punctuation">(</span>receive_video_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> obs_encoder    <span class="token operator">*</span>encoder  <span class="token operator">=</span> param<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> obs_encoder    <span class="token operator">*</span>pair     <span class="token operator">=</span> encoder<span class="token operator">-&gt;</span>paired_encoder<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> encoder_frame  enc_frame<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encoder<span class="token operator">-&gt;</span>first_received <span class="token operator">&amp;&amp;</span> pair<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pair<span class="token operator">-&gt;</span>first_received <span class="token operator">||</span>
		    pair<span class="token operator">-&gt;</span>first_raw_ts <span class="token operator">&gt;</span> frame<span class="token operator">-&gt;</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">goto</span> wait_for_audio<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>enc_frame<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> encoder_frame<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_AV_PLANES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		enc_frame<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span>     <span class="token operator">=</span> frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		enc_frame<span class="token punctuation">.</span>linesize<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encoder<span class="token operator">-&gt;</span>start_ts<span class="token punctuation">)</span>
		encoder<span class="token operator">-&gt;</span>start_ts <span class="token operator">=</span> frame<span class="token operator">-&gt;</span>timestamp<span class="token punctuation">;</span>

	enc_frame<span class="token punctuation">.</span>frames <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	enc_frame<span class="token punctuation">.</span>pts    <span class="token operator">=</span> encoder<span class="token operator">-&gt;</span>cur_pts<span class="token punctuation">;</span>

	<span class="token function">do_encode</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> <span class="token operator">&amp;</span>enc_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>

	encoder<span class="token operator">-&gt;</span>cur_pts <span class="token operator">+</span><span class="token operator">=</span> encoder<span class="token operator">-&gt;</span>timebase_num<span class="token punctuation">;</span>

wait_for_audio<span class="token punctuation">:</span>
	<span class="token function">profile_end</span><span class="token punctuation">(</span>receive_video_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后编码的数据放到DARRAY(struct encoder_packet) interleaved_packets;</p> 
<pre><code class="prism language-cpp">
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">insert_interleaved_packet</span><span class="token punctuation">(</span><span class="token keyword">struct</span> obs_output <span class="token operator">*</span>output<span class="token punctuation">,</span>
		<span class="token keyword">struct</span> encoder_packet <span class="token operator">*</span>out<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	size_t idx<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> output<span class="token operator">-</span><span class="token operator">&gt;</span>interleaved_packets<span class="token punctuation">.</span>num<span class="token punctuation">;</span> idx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> encoder_packet <span class="token operator">*</span>cur_packet<span class="token punctuation">;</span>
		cur_packet <span class="token operator">=</span> output<span class="token operator">-</span><span class="token operator">&gt;</span>interleaved_packets<span class="token punctuation">.</span>array <span class="token operator">+</span> idx<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token operator">-</span><span class="token operator">&gt;</span>dts_usec <span class="token operator">&lt;</span> cur_packet<span class="token operator">-</span><span class="token operator">&gt;</span>dts_usec<span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">da_insert</span><span class="token punctuation">(</span>output<span class="token operator">-</span><span class="token operator">&gt;</span>interleaved_packets<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后 send_thread 去缓冲数据发送；编码输出纤细过程参考：<a href="https://willarun365.blog.csdn.net/article/details/109078169" rel="nofollow">https://willarun365.blog.csdn.net/article/details/109078169</a><br> 参考文章：<br> https://www.notion.so/willarun365/obs-studio-fa9a2927070b4890addb8ba07096b67d<br> https://www.itdaan.com/blog/2018/01/31/4bde0bfedd8a14d54c4bc59ff06a8150.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b1e9da30367cfe53e122a5c6cb3a0894/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">腾讯云mysql性能_腾讯云MySQL实例高IO版性能测试报告</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/368e4d1200fb539e263eeb6d749f525e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python如何导出数据到excel文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>