<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>docker高级 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="docker高级" />
<meta property="og:description" content="DockerFile DockerFile是什么？ Dockerfile是用来构建Docker镜像的文本文件，是由一条条构建镜像所需的指令和参数构成的脚本。 镜像构建三大步： ​ 编写DockerFile文件执行docker build 命令构建镜像docker run 运行容器。 DockerFile构建过程解析 Dockerfile内容基础知识 每条保留字指令都必须为大写字母且后面要跟随至少一个参数指令按照从上到下，顺序执行#表示注释每条指令都会创建一个新的镜像层并对镜像进行提交 Docker执行Dockerfile的大致流程 ​ Docker基于最开始的镜像，创建运行一个容器，根据一条命令对容器进行修改，然后Docker commit提交一层镜像层，然后有基于这个镜像层，创建新的容器，然后有根据下一条命令修改容器，然后又提交，直至最后一条命令执行完。
DockerFile常用保留字指令 From : 基础镜像，当前镜像是基于哪个镜像的，必须指定基础镜像，DockerFile第一条命令必须是From MAINTAINER : 镜像维护者姓名邮箱 RUN : 镜像构建时需要运行的Linux命令,Run是在docker build的时候执行的 --shell格式： RUN yum install xxx（运行一条yum命令） --exec格式： RUN [可执行文件，参数1，参数2] # 例：RUN [./redis-server,/etc/redis/redis.conf] 等同于 RUN ./redis-server /etc/redis/redis.conf EXPOSE : 镜像构建完成，运行当前镜像，生成的容器对外暴露的端口 WORKDIR : 指的是在运行容器时，进入交互终端所在的文件目录 USER : 指定镜像 需要什么用户才能执行 默认Root ENV : 构建过程中设置环境变量 ADD : 将宿主机中的文件添加到容器中，会自动的解压tar压缩包和自动处理URL COPY : 将宿主机中的文件拷贝到容器中 （类似于ADD 但是不会自动解压，）# COPY [&#34;src&#34;, &#34;dest&#34;] VOLUME ： 容器卷 CMD ： 指定容器启动后要干的事情（和前面RUN的区别：Run在Build时运行，CMD在容器运行后运行） --shell格式：CMD yum install xxx（运行一条yum命令） --exec格式： CMD [可执行文件，参数1，参数2], --Dockerfile 中可以有多个 CMD 指令，但只有最后一个生效，CMD 会被 docker run 之后的参数替换 ENTRYPOINT : 类似于 CMD 指令，但是ENTRYPOINT不会被docker run后面的命令覆盖， ---而且这些命令行参数会被当作参数送给 ENTRYPOINT 指令指定的程序 ---如果 Dockerfile 中如果存在多个 ENTRYPOINT 指令，仅最后一个生效。 编写一个Dockerfile文件（centos7&#43;java8） FROM centos:7 #基础镜像centos 7 MAINTAINER zzyy&lt;zzyybs@126." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3e1ff6051671e274f7d30a9c8abac4e6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-03T17:31:40+08:00" />
<meta property="article:modified_time" content="2022-05-03T17:31:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">docker高级</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="DockerFile_1"></a>DockerFile</h3> 
<h4><a id="DockerFile_2"></a>DockerFile是什么？</h4> 
<ul><li>Dockerfile是用来构建Docker镜像的文本文件，是由一条条构建镜像所需的指令和参数构成的脚本。</li></ul> 
<h4><a id="_6"></a>镜像构建三大步：</h4> 
<ol><li>​ 编写DockerFile文件</li><li>执行docker build 命令构建镜像</li><li>docker run 运行容器。</li></ol> 
<h4><a id="DockerFile_12"></a>DockerFile构建过程解析</h4> 
<h5><a id="Dockerfile_14"></a>Dockerfile内容基础知识</h5> 
<ol><li>每条保留字指令都必须为大写字母且后面要跟随至少一个参数</li><li>指令按照从上到下，顺序执行</li><li>#表示注释</li><li>每条指令都会创建一个新的镜像层并对镜像进行提交</li></ol> 
<h5><a id="DockerDockerfile_21"></a>Docker执行Dockerfile的大致流程</h5> 
<p>​ Docker基于最开始的镜像，创建运行一个容器，根据一条命令对容器进行修改，然后Docker commit提交一层镜像层，然后有基于这个镜像层，创建新的容器，然后有根据下一条命令修改容器，然后又提交，直至最后一条命令执行完。</p> 
<h4><a id="DockerFile_25"></a>DockerFile常用保留字指令</h4> 
<pre><code class="prism language-dockerfile">From : 基础镜像，当前镜像是基于哪个镜像的，必须指定基础镜像，DockerFile第一条命令必须是From
MAINTAINER : 镜像维护者姓名邮箱
RUN : 镜像构建时需要运行的Linux命令,Run是在docker build的时候执行的
	--shell格式： RUN yum install xxx（运行一条yum命令）
	--exec格式： RUN [可执行文件，参数1，参数2] # 例：RUN [./redis-server,/etc/redis/redis.conf]  等同于 RUN ./redis-server /etc/redis/redis.conf 
EXPOSE : 镜像构建完成，运行当前镜像，生成的容器对外暴露的端口
WORKDIR :  指的是在运行容器时，进入交互终端所在的文件目录
USER : 指定镜像 需要什么用户才能执行 默认Root
ENV : 构建过程中设置环境变量
ADD : 将宿主机中的文件添加到容器中，会自动的解压tar压缩包和自动处理URL
COPY : 将宿主机中的文件拷贝到容器中 （类似于ADD 但是不会自动解压，）# COPY ["src", "dest"]
VOLUME ： 容器卷
CMD ： 指定容器启动后要干的事情（和前面RUN的区别：Run在Build时运行，CMD在容器运行后运行）
	--shell格式：CMD yum install xxx（运行一条yum命令）
	--exec格式： CMD [可执行文件，参数1，参数2],
    --Dockerfile 中可以有多个 CMD 指令，但只有最后一个生效，CMD 会被 docker run 之后的参数替换
ENTRYPOINT : 类似于 CMD 指令，但是ENTRYPOINT不会被docker run后面的命令覆盖，
     ---而且这些命令行参数会被当作参数送给 ENTRYPOINT 指令指定的程序
     ---如果 Dockerfile 中如果存在多个 ENTRYPOINT 指令，仅最后一个生效。
</code></pre> 
<h4><a id="Dockerfilecentos7java8_49"></a>编写一个Dockerfile文件（centos7+java8）</h4> 
<pre><code class="prism language-dockerfile">
FROM centos:7 #基础镜像centos 7
MAINTAINER zzyy&lt;zzyybs@126.com&gt;
 
ENV MYPATH /usr/local# 设置环境变量
WORKDIR $MYPATH# 设置工作目录
 
#安装vim编辑器
RUN yum -y install vim #运行 yum 命令
#安装ifconfig命令查看网络IP
RUN yum -y install net-tools
#安装java8及lib库
RUN yum -y install glibc.i686
RUN mkdir /usr/local/java 
#ADD 是相对路径jar,把jdk-8u171-linux-x64.tar.gz添加到容器中,安装包必须要和Dockerfile文件在同一位置
ADD jdk-8u171-linux-x64.tar.gz /usr/local/java/#将java8文件添加到容器并且解压
#配置java环境变量
ENV JAVA_HOME /usr/local/java/jdk1.8.0_171
ENV JRE_HOME $JAVA_HOME/jre
ENV CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATH
ENV PATH $JAVA_HOME/bin:$PATH #设置PATH环境变量
 
EXPOSE 80 暴露端口
 
CMD echo $MYPATH
CMD echo "success--------------ok"
CMD /bin/bash
 

</code></pre> 
<h4><a id="Dockerfile_83"></a>编译Dockerfile文件</h4> 
<pre><code class="prism language-dockerfile">docker build -t 镜像名：TAG . #记住最后又一个点
</code></pre> 
<p><img src="https://images2.imgbox.com/cc/77/UXyg3g7G_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-qctJEUuv-1651569619785)(../../AppData/Roaming/Typora/typora-user-images/image-20220502135859722.png)]"><br> 新的镜像</p> 
<h3><a id="Docker_92"></a>Docker微服务实战</h3> 
<h4><a id="Docker_94"></a>简单使用Docker发布微服务项目</h4> 
<h5><a id="_96"></a>打包微服务项目（记得加打包插件，不然会报没有主属性清单）</h5> 
<p>​ 插件：</p> 
<pre><code class="prism language-maven">&lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/f6/3c/CuD3y6wI_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-8gozwHL3-1651569619786)(../../AppData/Roaming/Typora/typora-user-images/image-20220502151126870.png)]"></p> 
<h4><a id="DockerFile_114"></a>编写DockerFile</h4> 
<pre><code class="prism language-dockerfile"> ROM java:8  #
  VOLUME /tmp
  RUN mkdir -p  /myjar/jar
  ADD demo.jar  /myjar/jar/demo.jar #将Demo.jar 放到目录下
  ENTRYPOINT ["java","-jar","/myjar/jar/demo.jar"] #运行jar包
  EXPOSE 8000  #对外暴露8000端口
</code></pre> 
<h4><a id="_125"></a>运行容器</h4> 
<pre><code class="prism language-dockerfile">docker run -d -p 8000:8000 boot:1.0
</code></pre> 
<p><img src="https://images2.imgbox.com/c4/08/2kXIxZi1_o.png" alt="1. 访问Web[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-AsWalQdF-1651569619786)(../../AppData/Roaming/Typora/typora-user-images/image-20220502151305344.png)]"></p> 
<p>就打包好了。</p> 
<h3><a id="Docker_136"></a>Docker网络</h3> 
<h4><a id="Docker_138"></a>Docker网络的基本命令</h4> 
<p><img src="https://images2.imgbox.com/71/57/ZtxW7kFl_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-zJuuFUtv-1651569619787)(../../AppData/Roaming/Typora/typora-user-images/image-20220502152652031.png)]"></p> 
<h5><a id="_143"></a>查看网络</h5> 
<pre><code>docker network ls
</code></pre> 
<p>创建网络</p> 
<pre><code>docker network create 网络名
</code></pre> 
<p>查看网络数据</p> 
<pre><code>docker network inspect
</code></pre> 
<p>删除网络</p> 
<pre><code>docker network rm 网络名
</code></pre> 
<h4><a id="Docker_167"></a>Docker网络模式</h4> 
<ul><li> <p>bridge模式：使用–network bridge指定，默认使用docker0</p> </li><li> <p>host模式：使用–network host指定</p> </li><li> <p>none模式：使用–network none指定</p> </li><li> <p>container模式：使用–network container:NAME或者容器ID指定</p> </li></ul> 
<h5><a id="IP_177"></a>容器实例内默认网络IP生产规则</h5> 
<p>容器默认使用的是桥接模式。Docker每次启动容器时，容器内部的IP都是会变化的。</p> 
<h5><a id="Bridge_181"></a>Bridge（桥接模式）</h5> 
<ul><li>​ Docker 服务默认会创建一个 docker0 网桥（其上有一个 docker0 内部接口），该桥接网络的名称为docker0，它在内核层连通了其他的物理或虚拟网卡，这就将所有容器和本地主机都放到同一个物理网络。Docker 默认指定了 docker0 接口 的 IP 地址和子网掩码，让主机和容器之间可以通过网桥相互通信。</li></ul> 
<p><img src="https://images2.imgbox.com/0f/7d/n8O1xwK4_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-DycjDjIk-1651569619787)(../../AppData/Roaming/Typora/typora-user-images/image-20220502153207995.png)]"></p> 
<h6><a id="_188"></a>说明</h6> 
<ol><li>Docker使用Linux桥接，在宿主机虚拟一个Docker容器网桥(docker0)，Docker启动一个容器时会根据Docker网桥的网段分配给容器一个IP地址，称为Container-IP，同时Docker网桥是每个容器的默认网关。因为在同一宿主机内的容器都接入同一个网桥，这样容器之间就能够通过容器的Container-IP直接通信。</li><li>2 docker run 的时候，没有指定network的话默认使用的网桥模式就是bridge，使用的就是docker0。在宿主机ifconfig,就可以看到docker0和自己create的network(后面讲)eth0，eth1，eth2……代表网卡一，网卡二，网卡三……，lo代表127.0.0.1，即localhost，inet addr用来表示网卡的IP地址</li><li>网桥docker0创建一对对等虚拟设备接口一个叫veth，另一个叫eth0，成对匹配。 
  <ol><li>整个宿主机的网桥模式都是docker0，类似一个交换机有一堆接口，每个接口叫veth，在本地主机和容器内分别创建一个虚拟接口，并让他们彼此联通（这样一对接口叫veth pair）；</li><li>每个容器实例内部也有一块网卡，每个接口叫eth0；</li><li>docker0上面的每个veth匹配某个容器实例内部的eth0，两两配对，一一匹配。<br> 通过上述，将宿主机上的所有容器都连接到这个内部网络上，两个容器在同一个网络下,会从这个网关下各自拿到分配的ip，此时两个容器的网络是互通的。</li></ol> </li></ol> 
<p><img src="https://images2.imgbox.com/b7/31/mAM652vo_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-NPhpN3sG-1651569619788)(../../AppData/Roaming/Typora/typora-user-images/image-20220502154402026.png)]"></p> 
<p>验证两两对应</p> 
<p><img src="https://images2.imgbox.com/df/67/oQP0YorP_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-O8KINejN-1651569619788)(../../AppData/Roaming/Typora/typora-user-images/image-20220502155242325.png)]"></p> 
<h5><a id="HOST_206"></a>HOST模式</h5> 
<ul><li>直接使用宿主机的 IP 地址与外界进行通信，不再需要额外进行NAT 转换。</li><li>容器将不会获得一个独立的Network Namespace， 而是和宿主机共用一个Network Namespace。容器将不会虚拟出自己的网卡<font color="skyblue" size="5">而是使用宿主机的IP和端口。</font></li></ul> 
<p><img src="https://images2.imgbox.com/da/12/TNZskxvy_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-YM414Yay-1651569619789)(../../AppData/Roaming/Typora/typora-user-images/image-20220502155522802.png)]"></p> 
<h6><a id="_214"></a>会出什么问题？</h6> 
<p>因为是复用的宿主机的IP和端口，所以在启动容器时的端口映射也就没有意义了</p> 
<pre><code class="prism language-dockerfile">docker run -d -p 8083:8080 --network host --name tomcat83 billygoo/tomcat8-jdk8 #运行这段代码会产生警告
</code></pre> 
<p><img src="https://images2.imgbox.com/d4/1d/lWZm2cXh_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-EKCNuGwK-1651569619789)(../../AppData/Roaming/Typora/typora-user-images/image-20220502160406898.png)]"></p> 
<p>原因：<br> docker启动时指定–network=host或-net=host，如果还指定了-p映射端口，那这个时候就会有此警告，<br> 并且通过-p设置的参数将不会起到任何作用，端口号会以主机端口号为主，重复时则递增。</p> 
<pre><code class="prism language-dockerfile">docker run -d -p 8083:8080  --name tomcat83 billygoo/tomcat8-jdk8 #这样就没问题了
</code></pre> 
<h5><a id="none_233"></a>none模式</h5> 
<p><font color="skyblue">禁用网络功能，只有lo标识(就是127.0.0.1表示本地回环)</font></p> 
<h5><a id="container_237"></a>container模式</h5> 
<p><font color="skyblue">新建的容器和已经存在的一个容器共享一个网络ip配置而不是和宿主机共享。</font>新创建的容器不会创建自己的网卡，配置自己的IP，而是和一个指定的容器共享IP、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。</p> 
<p><img src="https://images2.imgbox.com/21/bb/IcCnDHBn_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-OGjsBUSc-1651569619790)(../../AppData/Roaming/Typora/typora-user-images/image-20220502162157396.png)]"></p> 
<p><font color="deepskyblue" size="6">注意</font>: 使用这个模式因为共用一个IP和端口，两个容器的端口不能冲突，比如两个tomcat就不能使用这个模式</p> 
<pre><code class="prism language-dockerfile">docker run -it --network container:alpine1 --name alpine2  alpine /bin/sh #启动另一个alpine，并且，使用容器alpine1的IP和端口
</code></pre> 
<h5><a id="_250"></a>自定义网络</h5> 
<p><font color="deepskyblue">如果我们使用默认的bridge模式,是不能通过容器名相互ping的</font>，进入之前创建的boot容器中。pring java:8这个容器是不能够ping通的。所以我们需要自定义网络</p> 
<p><img src="https://images2.imgbox.com/01/be/N8wahgep_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-v1kmlNq0-1651569619790)(../../AppData/Roaming/Typora/typora-user-images/image-20220502163515117.png)]"></p> 
<h6><a id="_257"></a>创建网络</h6> 
<pre><code class="prism language-dockerfile">docker network create 网络名
</code></pre> 
<p>docker会再次虚拟一块网卡出来，这里不再使用默认的docker0网卡：<br> <img src="https://images2.imgbox.com/43/2e/k428UWfl_o.png" alt="在这里插入图片描述"></p> 
<p><font color="skyblue" size="6">注意</font>：Linux为了安全起见，多于一块网卡的时候会禁用IPV4的转发，会导致外网不能连接 docker内部的服务</p> 
<p>所以我们需要开启IPV4的转发</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> /etc/sysctl.conf

<span class="token comment">#配置转发</span>
net.ipv4.ip_forward<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">#保存退出就可以了</span>
:wq<span class="token operator">!</span>
<span class="token comment">#重启服务，让配置生效</span>
systemctl restart network
</code></pre> 
<h6><a id="_284"></a>新建容器加入上一步新建的自定义网络</h6> 
<pre><code class="prism language-dockerfile">docker run -it  --network custome --name cent2 centos:7 /bin/bash #创建cent2
docker run -it  --network custome --name cent3 centos:7 /bin/bash #创建cent3
</code></pre> 
<h6><a id="ping_291"></a>互相ping测试</h6> 
<p><img src="https://images2.imgbox.com/42/82/Jkv40exs_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-uqKwCF9u-1651569619791)(../../AppData/Roaming/Typora/typora-user-images/image-20220502165005074.png)]"></p> 
<p><img src="https://images2.imgbox.com/de/2c/WZWiHFB7_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-kxHsmq5Y-1651569619791)(../../AppData/Roaming/Typora/typora-user-images/image-20220502165110620.png)]"></p> 
<p>为什么自定义网络能通过服务名Ping通呢？</p> 
<p><font color="deepskyblue" size="6">自定义网络本身就维护好了主机名和ip的对应关系（ip和域名都能通）</font></p> 
<h3><a id="Docker_305"></a>Docker容器编排</h3> 
<h5><a id="_307"></a>是什么？</h5> 
<ul><li>Compose 是 Docker 公司推出的一个工具软件，可以管理多个 Docker 容器组成一个应用。你需要定义一个 YAML 格式的配置文件docker-compose.yml，写好多个容器之间的调用关系。<font color="greenyellow">然后，只要一个命令，就能同时启动/关闭这些容器</font></li></ul> 
<h5><a id="_311"></a>去哪下载</h5> 
<p>官网：https://docs.docker.com/compose/compose-file/compose-file-v3/（指导使用）</p> 
<p>官网下载：https://docs.docker.com/compose/install/（下载）</p> 
<h6><a id="Docker_compose_317"></a>安装Docker compose</h6> 
<p>执行下面的命令</p> 
<pre><code class="prism language-shell"> <span class="token function">curl</span> -SL https://github.com/docker/compose/releases/download/v2.4.1/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose <span class="token comment">#从Github下载可执行二进制文件</span>
 chomd +x /usr/local/lib/docker/cli-plugins/docker-compose  <span class="token comment">#将可执行权限应用于二进制文件：</span>
</code></pre> 
<h6><a id="_326"></a>检验是否安装好了</h6> 
<pre><code class="prism language-dockerfile">docker compose version
</code></pre> 
<h6><a id="Docker_compose_332"></a>卸载Docker compose</h6> 
<pre><code>rm -f /usr/local/lib/docker/cli-plugins/docker-compose
</code></pre> 
<h5><a id="Compose_338"></a>Compose核心概念</h5> 
<h6><a id="dockercomposeyml_340"></a>一文件:docker-compose.yml</h6> 
<h6><a id="_342"></a>两要素:</h6> 
<ul><li>服务（service） 
  <ul><li>一个个应用容器实例，比如订单微服务、库存微服务、mysql容器、nginx容器或者redis容器</li></ul> </li><li>工程（project） 
  <ul><li>由一组关联的应用容器组成的一个完整业务单元，在 docker-compose.yml 文件中定义。</li></ul> </li></ul> 
<h5><a id="Compose_349"></a>Compose使用的三个步骤</h5> 
<ol><li>编写Dockerfile定义各个微服务应用并构建出对应的镜像文件</li><li>使用 docker-compose.yml 定义一个完整业务单元，安排好整体应用中的各个容器服务。</li><li>最后，执行docker-compose up命令 来启动并运行整个应用程序，完成一键部署上线</li></ol> 
<h5><a id="Docker_compose__355"></a>Docker compose 常用命令</h5> 
<pre><code class="prism language-dockerfile">docker-compose -h                           # 查看帮助
docker-compose up                           # 启动所有docker-compose服务
docker-compose up -d                        # 启动所有docker-compose服务并后台运行
docker-compose down                         # 停止并删除容器、网络、卷、镜像。
docker-compose exec  yml里面的服务id                 # 进入容器实例内部  docker-compose exec docker-compose.yml文件中写的服务id /bin/bash
docker-compose ps                      # 展示当前docker-compose编排过的运行的所有容器
docker-compose top                     # 展示当前docker-compose编排过的容器进程
 
docker-compose logs  yml里面的服务id     # 查看容器输出日志
dokcer-compose config     # 检查配置
dokcer-compose config -q  # 检查配置，有问题才有输出
docker-compose restart   # 重启服务
docker-compose start     # 启动服务
docker-compose stop      # 停止服务
</code></pre> 
<h4><a id="Compose_374"></a>使用Compose</h4> 
<h6><a id="_Dockerfile_376"></a>第一步： 打包微服务（使用Dockerfile生成镜像）</h6> 
<pre><code class="prism language-dockerfile"># 基础镜像使用java
FROM java:8
# 作者
MAINTAINER zzyy
# VOLUME 指定临时文件目录为/tmp，在主机/var/lib/docker目录下创建了一个临时文件并链接到容器的/tmp
VOLUME /tmp
# 将jar包添加到容器中并更名为zzyy_docker.jar
ADD docker_boot-0.0.1-SNAPSHOT.jar dockertest.jar
# 运行jar包
RUN bash -c 'touch /dockertest.jar'
ENTRYPOINT ["java","-jar","/dockertest.jar"]
#暴露6001端口作为微服务
EXPOSE 6001
</code></pre> 
<h6><a id="dockercomposeyml_394"></a>第二步：编写docker-compose.yml</h6> 
<pre><code class="prism language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3"</span>
 
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">microService</span><span class="token punctuation">:</span> <span class="token comment">#名字</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> zzyy_docker<span class="token punctuation">:</span><span class="token number">1.6</span> <span class="token comment">#微服务镜像</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> ms01
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"6001:6001"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /app/microService<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> atguigu_net <span class="token comment">#加入自定义网络 </span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>  <span class="token comment">#代表在这个镜像容器启动前先启动的</span>
      <span class="token punctuation">-</span> redis
      <span class="token punctuation">-</span> mysql
 
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>6.0.8   <span class="token comment">#Redis镜像</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"6379:6379"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /app/redis/redis.conf<span class="token punctuation">:</span>/etc/redis/redis.conf
      <span class="token punctuation">-</span> /app/redis/data<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> atguigu_net <span class="token comment">#加入自定义网络</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server /etc/redis/redis.conf <span class="token comment">#comman选项</span>
 
  <span class="token key atrule">mysql</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
      <span class="token key atrule">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'no'</span>
      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> <span class="token string">'db2021'</span>
      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> <span class="token string">'user'</span>
      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
       <span class="token punctuation">-</span> <span class="token string">"3306:3306"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
       <span class="token punctuation">-</span> /app/mysql/db<span class="token punctuation">:</span>/var/lib/mysql
       <span class="token punctuation">-</span> /app/mysql/conf/my.cnf<span class="token punctuation">:</span>/etc/my.cnf
       <span class="token punctuation">-</span> /app/mysql/init<span class="token punctuation">:</span>/docker<span class="token punctuation">-</span>entrypoint<span class="token punctuation">-</span>initdb.d
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> atguigu_net <span class="token comment">#加入自定义网络</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>default<span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>plugin=mysql_native_password <span class="token comment">#解决外部无法访问</span>
 
<span class="token key atrule">networks</span><span class="token punctuation">:</span>  <span class="token comment">#创建网络</span>
   <span class="token key atrule">atguigu_net</span><span class="token punctuation">:</span> 
 

</code></pre> 
<h6><a id="DockerCompose_448"></a>第三步：执行DockerCompose</h6> 
<pre><code class="prism language-docker">docker compose up 
</code></pre> 
<h6><a id="_454"></a>踩坑：</h6> 
<p><img src="https://images2.imgbox.com/2a/c2/YShjDtca_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-QtiFHxGP-1651569619792)(../../AppData/Roaming/Typora/typora-user-images/image-20220503144321405.png)]"></p> 
<p>Service的字母写错了</p> 
<p><img src="https://images2.imgbox.com/f9/bf/0t7KPjAL_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-7s2gHknZ-1651569619793)(../../AppData/Roaming/Typora/typora-user-images/image-20220503152150641.png)]"></p> 
<p>IPV4的转发被禁止了，外网不能访问docker 所以需要修改</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> /etc/sysctl.conf

<span class="token comment">#配置转发</span>
net.ipv4.ip_forward<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">#保存退出就可以了</span>
:wq<span class="token operator">!</span>
<span class="token comment">#重启服务，让配置生效</span>
systemctl restart network
</code></pre> 
<h6><a id="_477"></a>运行成功</h6> 
<p>第一次运行，docker中不存在容器，先创建容器</p> 
<p><img src="https://images2.imgbox.com/68/5e/nla0NXbS_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-mkpOM980-1651569619793)(../../AppData/Roaming/Typora/typora-user-images/image-20220503142305020.png)]"></p> 
<p>第二次运行：docker中存在容器了 直接运行</p> 
<p><img src="https://images2.imgbox.com/da/c0/MiHyROm2_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-OS13VJDu-1651569619794)(../../AppData/Roaming/Typora/typora-user-images/image-20220503142325693.png)]"></p> 
<p><img src="https://images2.imgbox.com/01/98/kGqPbiiE_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-RayGbiLx-1651569619794)(../../AppData/Roaming/Typora/typora-user-images/image-20220503142419981.png)]"></p> 
<h3><a id="DockerPortainer_492"></a>Docker轻量可视化工具Portainer</h3> 
<h4><a id="_494"></a>是什么？</h4> 
<pre><code> Portainer 是一款轻量级的应用，它提供了图形化界面，用于方便地管理Docker环境，包括单机环境和集群环境。
</code></pre> 
<p>官网：https://www.portainer.io/</p> 
<p>官网文档：https://docs.portainer.io/v/ce-2.9/start/install/server/docker/linux</p> 
<h4><a id="Portainer_504"></a>Portainer安装</h4> 
<pre><code class="prism language-dockerfile">docker run -d -p 8000:8000 -p 9443:9443 -p 9000:9000 --name portainer \  
    --restart=always \    
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v portainer_data:/data \
    portainer/portainer-ce:2.9.3
</code></pre> 
<p>–restart =always 代表 随着docker启动而启动，docker停止而停止</p> 
<h4><a id="adminxxxxxxxxxxxx9000_516"></a>第一次登录需创建admin，访问地址：xxx.xxx.xxx.xxx:9000</h4> 
<ul><li>用户名，直接用的默认admin<br> 密码记得8位，随便你写</li></ul> 
<p><img src="https://images2.imgbox.com/44/bd/GAetHjP2_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-MJ15U5KJ-1651569619795)(../../AppData/Roaming/Typora/typora-user-images/image-20220503163431450.png)]"></p> 
<h4><a id="admin_524"></a>设置admin用户和密码后首次登陆</h4> 
<p><img src="https://images2.imgbox.com/0c/1e/YXGksKrY_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-XJUxJ0qR-1651569619795)(../../AppData/Roaming/Typora/typora-user-images/image-20220503163545049.png)]"></p> 
<h4><a id="localdocker_529"></a>选择local选项卡后本地docker详细信息展示</h4> 
<p><img src="https://images2.imgbox.com/02/0f/2G5eu9JR_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-qEKtkabr-1651569619796)(../../AppData/Roaming/Typora/typora-user-images/image-20220503163623707.png)]"></p> 
<p>对应的Docker命令是</p> 
<pre><code>docker system df
</code></pre> 
<h3><a id="DockerCAdvisorInfluxDBGranfana_540"></a>Docker容器监控之CAdvisor+InfluxDB+Granfana</h3> 
<p>原生命令</p> 
<pre><code class="prism language-dockerfile">docker stats  #查看docker容器状况
</code></pre> 
<h4><a id="CAdvisorInfluxDBGranfana_548"></a>CAdvisor+InfluxDB+Granfana是什么？</h4> 
<p>一句话：CAdvisor监控收集+InfluxDB存储数据+Granfana展示图表</p> 
<p><img src="https://images2.imgbox.com/a6/84/e5pHgHDN_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-dfM1VBnJ-1651569619796)(../../AppData/Roaming/Typora/typora-user-images/image-20220503164252572.png)]"></p> 
<p><img src="https://images2.imgbox.com/5f/20/agtTy6q0_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-ok3fLqlu-1651569619797)(../../AppData/Roaming/Typora/typora-user-images/image-20220503164259569.png)]"></p> 
<p><img src="https://images2.imgbox.com/bf/33/TaXB0BLS_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-mHIvNlM7-1651569619797)(../../AppData/Roaming/Typora/typora-user-images/image-20220503164303732.png)]"></p> 
<h5><a id="_561"></a>总结</h5> 
<p><img src="https://images2.imgbox.com/ae/f8/zV2tbgK7_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-mqbMu9yF-1651569619798)(../../AppData/Roaming/Typora/typora-user-images/image-20220503164349864.png)]"></p> 
<h4><a id="_566"></a>启动三剑客</h4> 
<h5><a id="docker_compose_568"></a>使用docker compose一套带走</h5> 
<p>编写docker-compose.yml文件</p> 
<pre><code class="prism language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
 
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">grafana_data</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 
<span class="token key atrule">services</span><span class="token punctuation">:</span>
 <span class="token key atrule">influxdb</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> tutum/influxdb<span class="token punctuation">:</span><span class="token number">0.9</span>
  <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> PRE_CREATE_DB=cadvisor
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"8083:8083"</span>
    <span class="token punctuation">-</span> <span class="token string">"8086:8086"</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ./data/influxdb<span class="token punctuation">:</span>/data
 
 <span class="token key atrule">cadvisor</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> google/cadvisor
  <span class="token key atrule">links</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> influxdb<span class="token punctuation">:</span>influxsrv
  <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>storage_driver=influxdb <span class="token punctuation">-</span>storage_driver_db=cadvisor <span class="token punctuation">-</span>storage_driver_host=influxsrv<span class="token punctuation">:</span><span class="token number">8086</span>
  <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"8080:8080"</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /<span class="token punctuation">:</span>/rootfs<span class="token punctuation">:</span>ro
    <span class="token punctuation">-</span> /var/run<span class="token punctuation">:</span>/var/run<span class="token punctuation">:</span>rw
    <span class="token punctuation">-</span> /sys<span class="token punctuation">:</span>/sys<span class="token punctuation">:</span>ro
    <span class="token punctuation">-</span> /var/lib/docker/<span class="token punctuation">:</span>/var/lib/docker<span class="token punctuation">:</span>ro
 
 <span class="token key atrule">grafana</span><span class="token punctuation">:</span>
  <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">"104"</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/grafana
  <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">"104"</span>
  <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
  <span class="token key atrule">links</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> influxdb<span class="token punctuation">:</span>influxsrv
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"3000:3000"</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> grafana_data<span class="token punctuation">:</span>/var/lib/grafana
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> HTTP_USER=admin
    <span class="token punctuation">-</span> HTTP_PASS=admin
    <span class="token punctuation">-</span> INFLUXDB_HOST=influxsrv
    <span class="token punctuation">-</span> INFLUXDB_PORT=8086
    <span class="token punctuation">-</span> INFLUXDB_NAME=cadvisor
    <span class="token punctuation">-</span> INFLUXDB_USER=root
    <span class="token punctuation">-</span> INFLUXDB_PASS=root

</code></pre> 
<h5><a id="dockercompose_626"></a>启动docker-compose文件</h5> 
<pre><code>docker compose up 
</code></pre> 
<p><img src="https://images2.imgbox.com/0a/11/Q2yMbAdA_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="CAdvisor_636"></a>访问CAdvisor</h5> 
<pre><code>http://IP:8080 ##第一次访问要收集数据可能会有点慢
</code></pre> 
<ul><li>cadvisor也有基础的图形展现功能，这里主要用它来作数据采集<br> <img src="https://images2.imgbox.com/1f/53/ZizBBhvj_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-h1TyCb2i-1651569619798)(../../AppData/Roaming/Typora/typora-user-images/image-20220503170413546.png)]"></li></ul> 
<h5><a id="influxdb_645"></a>浏览influxdb存储服务</h5> 
<pre><code>http://IP:8083
</code></pre> 
<p><img src="https://images2.imgbox.com/c7/32/Ow3JP6qE_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-d4k70RIp-1651569619799)(../../AppData/Roaming/Typora/typora-user-images/image-20220503170613680.png)]"></p> 
<h5><a id="grafana_654"></a>浏览grafana展现服务</h5> 
<pre><code>http://IP:3000 #默认账号密码 admin admin
</code></pre> 
<p><img src="https://images2.imgbox.com/96/fd/QZdqXnO3_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-2ANR1B2x-1651569619800)(../../AppData/Roaming/Typora/typora-user-images/image-20220503170638226.png)]"></p> 
<h5><a id="Grafanan_663"></a>配置Grafanan步骤</h5> 
<ol><li>配置数据源</li></ol> 
<p><img src="https://images2.imgbox.com/47/47/J7uSLHmD_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-hxzVI6Dw-1651569619801)(../../AppData/Roaming/Typora/typora-user-images/image-20220503170834101.png)]"></p> 
<ol><li> <p>选择influxdb数据源</p> <p><img src="https://images2.imgbox.com/36/f7/pVZ6ROW0_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-qK4sSWQi-1651569619801)(../../AppData/Roaming/Typora/typora-user-images/image-20220503170916477.png)]"></p> </li><li> <p>配置细节</p> </li></ol> 
<p><img src="https://images2.imgbox.com/32/d7/bO4tqkdX_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-0yzyETG0-1651569619801)(../../AppData/Roaming/Typora/typora-user-images/image-20220503170940925.png)]"></p> 
<p><img src="https://images2.imgbox.com/0b/6c/mR7r09h6_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-FAl5w1Ay-1651569619802)(../../AppData/Roaming/Typora/typora-user-images/image-20220503170949268.png)]"></p> 
<p><img src="https://images2.imgbox.com/81/13/6wQMaCid_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-jIIBlzr8-1651569619802)(../../AppData/Roaming/Typora/typora-user-images/image-20220503170953994.png)]"></p> 
<ol><li>配置面板panel</li></ol> 
<p><img src="https://images2.imgbox.com/fd/96/0R6t5Plv_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-P8bu510a-1651569619803)(../../AppData/Roaming/Typora/typora-user-images/image-20220503171603069.png)]."></p> 
<p><img src="https://images2.imgbox.com/82/01/ZKKOfsFg_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Bs8S46P6-1651569619803)(../../AppData/Roaming/Typora/typora-user-images/image-20220503171634385.png)]"></p> 
<p><img src="https://images2.imgbox.com/f0/ff/sf3iOTtx_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-ZdvzKpQ6-1651569619804)(../../AppData/Roaming/Typora/typora-user-images/image-20220503171712084.png)]"></p> 
<p><img src="https://images2.imgbox.com/08/25/RP6hNGMc_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-AgHm3Nor-1651569619804)(../../AppData/Roaming/Typora/typora-user-images/image-20220503171815434.png)]"></p> 
<ol><li>到这里cAdvisor+InfluxDB+Grafana容器监控系统就部署完成了</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/512d3c953d419c2a0757b56f65685725/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【LeetCode】ACM完整代码写数据结构（以树、链表为例）c&#43;&#43;</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/22e354907673b351841e4b8c1af6427a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深入torch框架内部</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>