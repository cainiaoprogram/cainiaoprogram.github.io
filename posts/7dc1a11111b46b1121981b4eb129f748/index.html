<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL MHA - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL MHA" />
<meta property="og:description" content="目录
1．什么是 MHA
2．MHA 的组成
3．MHA 的特点
----------------------搭建 MySQL MHA--------------------------------
---------------------- 故障模拟 --------------------------------
1．什么是 MHA MHA（MasterHigh Availability）是一套优秀的MySQL高可用环境下故障切换和主从复制的软件。
MHA 的出现就是解决MySQL 单点的问题。
MySQL故障切换过程中，MHA能做到0-30秒内自动完成故障切换操作。
MHA能在故障切换的过程中最大程度上保证数据的一致性，以达到真正意义上的高可用。
2．MHA 的组成 ●MHA Node（数据节点）
MHA Node 运行在每台 MySQL 服务器上。
●MHA Manager（管理节点）
MHA Manager 可以单独部署在一台独立的机器上，管理多个 master-slave 集群；也可以部署在一台 slave 节点上。
MHA Manager 会定时探测集群中的 master 节点。当 master 出现故障时，它可以自动将最新数据的 slave 提升为新的 master， 然后将所有其他的 slave 重新指向新的 master。整个故障转移过程对应用程序完全透明。
3．MHA 的特点 ●自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据不丢失
●使用半同步复制，可以大大降低数据丢失的风险，如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性
●目前MHA支持一主多从架构，最少三台服务，即一主两从
----------------------搭建 MySQL MHA-------------------------------- 实验思路：
1．MHA架构
1）数据库安装
2）一主两从
3）MHA搭建
2．故障模拟
1）主库失效" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7dc1a11111b46b1121981b4eb129f748/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-08T08:48:06+08:00" />
<meta property="article:modified_time" content="2024-01-08T08:48:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL MHA</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:120px;"></p> 
<p id="1%EF%BC%8E%E4%BB%80%E4%B9%88%E6%98%AF%20MHA-toc" style="margin-left:120px;"><a href="#1%EF%BC%8E%E4%BB%80%E4%B9%88%E6%98%AF%20MHA" rel="nofollow">1．什么是 MHA</a></p> 
<p id="2%EF%BC%8EMHA%20%E7%9A%84%E7%BB%84%E6%88%90-toc" style="margin-left:120px;"><a href="#2%EF%BC%8EMHA%20%E7%9A%84%E7%BB%84%E6%88%90" rel="nofollow">2．MHA 的组成</a></p> 
<p id="3%EF%BC%8EMHA%20%E7%9A%84%E7%89%B9%E7%82%B9-toc" style="margin-left:120px;"><a href="#3%EF%BC%8EMHA%20%E7%9A%84%E7%89%B9%E7%82%B9" rel="nofollow">3．MHA 的特点</a></p> 
<p id="----------------------%E6%90%AD%E5%BB%BA%20MySQL%20MHA---------------------------------toc" style="margin-left:80px;"><a href="#----------------------%E6%90%AD%E5%BB%BA%20MySQL%20MHA--------------------------------" rel="nofollow">----------------------搭建 MySQL MHA--------------------------------</a></p> 
<p id="----------------------%20%E6%95%85%E9%9A%9C%E6%A8%A1%E6%8B%9F%20---------------------------------toc" style="margin-left:160px;"><a href="#----------------------%20%E6%95%85%E9%9A%9C%E6%A8%A1%E6%8B%9F%20--------------------------------" rel="nofollow">---------------------- 故障模拟 --------------------------------</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h5 id="1%EF%BC%8E%E4%BB%80%E4%B9%88%E6%98%AF%20MHA">1．什么是 MHA</h5> 
<p><br> MHA（MasterHigh Availability）是一套优秀的MySQL高可用环境下故障切换和主从复制的软件。<br> MHA 的出现就是解决MySQL 单点的问题。<br> MySQL故障切换过程中，MHA能做到0-30秒内自动完成故障切换操作。<br> MHA能在故障切换的过程中最大程度上保证数据的一致性，以达到真正意义上的高可用。</p> 
<h5 id="2%EF%BC%8EMHA%20%E7%9A%84%E7%BB%84%E6%88%90">2．MHA 的组成</h5> 
<p><br> ●MHA Node（数据节点）<br> MHA Node 运行在每台 MySQL 服务器上。</p> 
<p>●MHA Manager（管理节点）<br> MHA Manager 可以单独部署在一台独立的机器上，管理多个 master-slave 集群；也可以部署在一台 slave 节点上。<br> MHA Manager 会定时探测集群中的 master 节点。当 master 出现故障时，它可以自动将最新数据的 slave 提升为新的 master， 然后将所有其他的 slave 重新指向新的 master。整个故障转移过程对应用程序完全透明。</p> 
<h5 id="3%EF%BC%8EMHA%20%E7%9A%84%E7%89%B9%E7%82%B9">3．MHA 的特点</h5> 
<p><br> ●自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据不丢失<br> ●使用半同步复制，可以大大降低数据丢失的风险，如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性<br> ●目前MHA支持一主多从架构，最少三台服务，即一主两从</p> 
<h4 id="----------------------%E6%90%AD%E5%BB%BA%20MySQL%20MHA--------------------------------"><br> ----------------------搭建 MySQL MHA--------------------------------</h4> 
<p>实验思路：<br> 1．MHA架构<br> 1）数据库安装<br> 2）一主两从<br> 3）MHA搭建</p> 
<p>2．故障模拟<br> 1）主库失效<br> 2）备选主库成为主库<br> 3）原故障主库恢复重新加入到MHA成为从库</p> 
<p>MHA manager 节点服务器：CentOS7.4(64 位) manager/192.168.80.13 ，安装MHA node 和 manager 组件<br> Master 节点服务器：CentOS7.4(64 位) mysql1/192.168.80.10 ，安装mysql5.7、MHA node 组件<br> Slave1 节点服务器：CentOS7.4(64 位) mysql2/192.168.80.11 ，安装mysql5.7、MHA node 组件<br> Slave2 节点服务器：CentOS7.4(64 位) mysql3/192.168.80.12 ，安装mysql5.7、MHA node 组件</p> 
<p>systemctl stop firewalld<br> systemctl disable firewalld<br> setenforce 0</p> 
<p>1．Master、Slave1、Slave2 节点上安装 mysql5.7</p> 
<p>2．修改 Master、Slave1、Slave2 节点的主机名<br> hostnamectl set-hostname mysql1<br> hostnamectl set-hostname mysql2<br> hostnamectl set-hostname mysql3</p> 
<p>3．修改 Master、Slave1、Slave2 节点的 Mysql主配置文件/etc/my.cnf <br> ##Master 节点##<br> vim /etc/my.cnf<br> [mysqld]<br> server-id = 1<br> log_bin = mysql-bin<br> binlog_format = mixed<br> log-slave-updates = true<br> relay-log = relay-log-bin<br> relay-log-index = slave-relay-bin.index</p> 
<p>systemctl restart mysqld</p> 
<p>##Slave1、Slave2 节点##<br> vim /etc/my.cnf<br> server-id = 2                         #三台服务器的 server-id 不能一样<br> log_bin = mysql-bin<br> binlog_format = mixed<br> log-slave-updates = true<br> relay-log = relay-log-bin<br> relay-log-index = slave-relay-bin.index</p> 
<p>systemctl restart mysqld</p> 
<p>4．在 Master、Slave1、Slave2 节点上都创建两个软链接<br> ln -s /usr/local/mysql/bin/mysql /usr/sbin/<br> ln -s /usr/local/mysql/bin/mysqlbinlog /usr/sbin/</p> 
<p>5．配置 mysql 一主两从<br> （1）所有数据库节点进行 mysql 授权<br> mysql -uroot -p<br> grant replication slave on *.* to 'myslave'@'192.168.80.%' identified by '123';        #从数据库同步使用<br> grant all privileges on *.* to 'mha'@'192.168.80.%' identified by 'manager';        #manager 使用</p> 
<p>grant all privileges on *.* to 'mha'@'mysql1' identified by 'manager';                #防止从库通过主机名连接不上主库<br> grant all privileges on *.* to 'mha'@'mysql2' identified by 'manager';<br> grant all privileges on *.* to 'mha'@'mysql3' identified by 'manager';<br> flush privileges;</p> 
<p>（2）在 Master 节点查看二进制文件和同步点<br> show master status</p> 
<p>（3）在 Slave1、Slave2 节点执行同步操作<br> change master to master_host='192.168.80.10',master_user='myslave',master_password='123',master_log_file='mysql-bin.000001',master_log_pos=1215; </p> 
<p>start slave;</p> 
<p>（4）在 Slave1、Slave2 节点查看数据同步结果<br> show slave status\G        <br> //确保 IO 和 SQL 线程都是 Yes，代表同步正常。<br> Slave_IO_Running: Yes<br> Slave_SQL_Running: Yes</p> 
<p>（5）两个从库必须设置为只读模式：<br> set global read_only=1;</p> 
<p>（6）插入数据测试数据库同步<br> ##在 Master 主库插入条数据，测试是否同步##<br> create database test_db;<br> use test_db;<br> create table test(id int);<br> insert into test(id) values (1);</p> 
<p><br> 6．安装 MHA 软件<br> （1）所有服务器上都安装 MHA 依赖的环境，首先安装 epel 源<br> yum install epel-release --nogpgcheck -y</p> 
<p>yum install -y perl-DBD-MySQL \<br> perl-Config-Tiny \<br> perl-Log-Dispatch \<br> perl-Parallel-ForkManager \<br> perl-ExtUtils-CBuilder \<br> perl-ExtUtils-MakeMaker \<br> perl-CPAN</p> 
<p>（2）安装 MHA 软件包，先在所有服务器上必须先安装 node 组件<br> 对于每个操作系统版本不一样，这里 CentOS7.4 必须选择 0.57 版本。<br> 在所有服务器上必须先安装 node 组件，最后在 MHA-manager 节点上安装 manager 组件，因为 manager 依赖 node 组件。<br> cd /opt<br> tar zxvf mha4mysql-node-0.57.tar.gz<br> cd mha4mysql-node-0.57<br> perl Makefile.PL<br> make &amp;&amp; make install</p> 
<p>（3）在 MHA manager 节点上安装 manager 组件<br> cd /opt<br> tar zxvf mha4mysql-manager-0.57.tar.gz<br> cd mha4mysql-manager-0.57<br> perl Makefile.PL<br> make &amp;&amp; make install</p> 
<p>----------------------------------------------------------------------------------------------------------<br> #manager 组件安装后在/usr/local/bin 下面会生成几个工具，主要包括以下几个：<br> masterha_check_ssh 检查 MHA 的 SSH 配置状况<br> masterha_check_repl 检查 MySQL 复制状况<br> masterha_manger 启动 manager的脚本<br> masterha_check_status 检测当前 MHA 运行状态<br> masterha_master_monitor 检测 master 是否宕机<br> masterha_master_switch 控制故障转移（自动或者手动）<br> masterha_conf_host 添加或删除配置的 server 信息<br> masterha_stop  关闭manager</p> 
<p>#node 组件安装后也会在/usr/local/bin 下面会生成几个脚本（这些工具通常由 MHAManager 的脚本触发，无需人为操作）主要如下：<br> save_binary_logs 保存和复制 master 的二进制日志<br> apply_diff_relay_logs 识别差异的中继日志事件并将其差异的事件应用于其他的 slave<br> filter_mysqlbinlog 去除不必要的 ROLLBACK 事件（MHA 已不再使用这个工具）<br> purge_relay_logs 清除中继日志（不会阻塞 SQL 线程）<br> ----------------------------------------------------------------------------------------------------------</p> 
<p>7．在所有服务器上配置无密码认证<br> （1）在 manager 节点上配置到所有数据库节点的无密码认证<br> ssh-keygen -t rsa                 #一路按回车键<br> ssh-copy-id 192.168.80.10<br> ssh-copy-id 192.168.80.11<br> ssh-copy-id 192.168.80.12</p> 
<p>（2）在 mysql1 上配置到数据库节点 mysql2 和 mysql3 的无密码认证<br> ssh-keygen -t rsa<br> ssh-copy-id 192.168.80.11<br> ssh-copy-id 192.168.80.12</p> 
<p>（3）在 mysql2 上配置到数据库节点 mysql1 和 mysql3 的无密码认证<br> ssh-keygen -t rsa<br> ssh-copy-id 192.168.80.10<br> ssh-copy-id 192.168.80.12</p> 
<p>（4）在 mysql3 上配置到数据库节点 mysql1 和 mysql2 的无密码认证<br> ssh-keygen -t rsa<br> ssh-copy-id 192.168.80.10<br> ssh-copy-id 192.168.80.11</p> 
<p>8．在 manager 节点上配置 MHA<br> （1）在 manager 节点上复制相关脚本到/usr/local/bin 目录<br> cp -rp /opt/mha4mysql-manager-0.57/samples/scripts /usr/local/bin<br> //拷贝后会有四个执行文件<br> ll /usr/local/bin/scripts/<br> ----------------------------------------------------------------------------------------------------------<br> master_ip_failover          #自动切换时 VIP 管理的脚本<br> master_ip_online_change     #在线切换时 VIP 的管理<br> power_manager                 #故障发生后关闭主机的脚本<br> send_report                 #因故障切换后发送报警的脚本<br> ----------------------------------------------------------------------------------------------------------</p> 
<p>（2）复制上述的自动切换时 VIP 管理的脚本到 /usr/local/bin 目录，这里使用master_ip_failover脚本来管理 VIP 和故障切换<br> cp /usr/local/bin/scripts/master_ip_failover /usr/local/bin</p> 
<p>（3）修改内容如下：（删除原有内容，直接复制并修改vip相关参数。可在拷贝前输入 :set paste 解决vim粘贴乱序问题）<br> vim /usr/local/bin/master_ip_failover<br> #!/usr/bin/env perl<br> use strict;<br> use warnings FATAL =&gt; 'all';</p> 
<p>use Getopt::Long;</p> 
<p>my (<br> $command, $ssh_user, $orig_master_host, $orig_master_ip,<br> $orig_master_port, $new_master_host, $new_master_ip, $new_master_port<br> );<br> #############################添加内容部分#########################################<br> my $vip = '192.168.80.200';                                    #指定vip的地址<br> my $brdc = '192.168.80.255';                                #指定vip的广播地址<br> my $ifdev = 'ens33';                                        #指定vip绑定的网卡<br> my $key = '1';                                                #指定vip绑定的虚拟网卡序列号<br> my $ssh_start_vip = "/sbin/ifconfig ens33:$key $vip";        #代表此变量值为ifconfig ens33:1 192.168.80.200<br> my $ssh_stop_vip = "/sbin/ifconfig ens33:$key down";        #代表此变量值为ifconfig ens33:1 192.168.80.200 down<br> my $exit_code = 0;                                            #指定退出状态码为0<br> #my $ssh_start_vip = "/usr/sbin/ip addr add $vip/24 brd $brdc dev $ifdev label $ifdev:$key;/usr/sbin/arping -q -A -c 1 -I $ifdev $vip;iptables -F;";<br> #my $ssh_stop_vip = "/usr/sbin/ip addr del $vip/24 dev $ifdev label $ifdev:$key";<br> ##################################################################################<br> GetOptions(<br> 'command=s' =&gt; \$command,<br> 'ssh_user=s' =&gt; \$ssh_user,<br> 'orig_master_host=s' =&gt; \$orig_master_host,<br> 'orig_master_ip=s' =&gt; \$orig_master_ip,<br> 'orig_master_port=i' =&gt; \$orig_master_port,<br> 'new_master_host=s' =&gt; \$new_master_host,<br> 'new_master_ip=s' =&gt; \$new_master_ip,<br> 'new_master_port=i' =&gt; \$new_master_port,<br> );</p> 
<p>exit &amp;main();</p> 
<p>sub main {<!-- --></p> 
<p>print "\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n";</p> 
<p>if ( $command eq "stop" || $command eq "stopssh" ) {<!-- --></p> 
<p>my $exit_code = 1;<br> eval {<!-- --><br> print "Disabling the VIP on old master: $orig_master_host \n";<br> &amp;stop_vip();<br> $exit_code = 0;<br> };<br> if ($@) {<!-- --><br> warn "Got Error: $@\n";<br> exit $exit_code;<br> }<br> exit $exit_code;<br> }<br> elsif ( $command eq "start" ) {<!-- --></p> 
<p>my $exit_code = 10;<br> eval {<!-- --><br> print "Enabling the VIP - $vip on the new master - $new_master_host \n";<br> &amp;start_vip();<br> $exit_code = 0;<br> };<br> if ($@) {<!-- --><br> warn $@;<br> exit $exit_code;<br> }<br> exit $exit_code;<br> }<br> elsif ( $command eq "status" ) {<!-- --><br> print "Checking the Status of the script.. OK \n";<br> exit 0;<br> }<br> else {<!-- --><br> &amp;usage();<br> exit 1;<br> }<br> }<br> sub start_vip() {<!-- --><br> `ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`;<br> }<br> ## A simple system call that disable the VIP on the old_master<br> sub stop_vip() {<!-- --><br> `ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`;<br> }</p> 
<p>sub usage {<!-- --><br> print<br> "Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n";<br> }</p> 
<p><br> （4）创建 MHA 软件目录并拷贝配置文件，这里使用app1.cnf配置文件来管理 mysql 节点服务器<br> #创建相关目录（所有节点）<br> mkdir -p /opt/mysql-mha/mha-node</p> 
<p># manager节点<br> mkdir -p /opt/mysql-mha/mha</p> 
<p>#编写配置文件<br> vim /opt/mysql-mha/mysql_mha.cnf<br> [server default]<br> manager_log=/opt/mysql-mha/manager.log<br> manager_workdir=/opt/mysql-mha/mha<br> master_binlog_dir=/usr/local/mysql/data<br> master_ip_failover_script=/usr/local/bin/master_ip_failover<br> master_ip_online_change_script=/usr/local/bin/master_ip_online_change<br> user=mha<br> password=manager<br> port=3306<br> ping_interval=1<br> remote_workdir=/opt/mysql-mha/mha-node<br> repl_user=myslave<br> repl_password=123<br> secondary_check_script=/usr/local/bin/masterha_secondary_check -s 192.168.80.11 -s 192.168.80.12<br> shutdown_script=""<br> ssh_user=root</p> 
<p>[server1]<br> hostname=192.168.80.10<br> port=3306</p> 
<p>[server2]<br> candidate_master=1<br> check_repl_delay=0<br> hostname=192.168.80.11<br> port=3306</p> 
<p>[server3]<br> hostname=192.168.80.12<br> port=3306</p> 
<p>----------------------------------------------------------------------------------------------------------<br> [server default]<br> manager_log=/opt/mysql-mha/manager.log        #指定manager日志路径<br> manager_workdir=/opt/mysql-mha/mha            #指定manager工作目录<br> master_binlog_dir=/usr/local/mysql/data        #指定master保存binlog的位置，这里的路径要与master里配置的binlog的路径一致，以便MHA能找到<br> master_ip_failover_script=/usr/local/bin/master_ip_failover　　#设置自动failover时候的切换脚本，也就是上面的那个脚本<br> master_ip_online_change_script=/usr/local/bin/master_ip_online_change　　#设置手动切换时候的切换脚本<br> user=mha                    #设置mha访问数据库的账号<br> password=manager            #设置mha访问数据库的账号密码<br> ping_interval=1                #设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行failover<br> remote_workdir=/opt/mysql-mha/mha-node        #指定mha在远程节点上的工作目录<br> repl_user=myslave            #设置主从复制的用户<br> repl_password=123            #设置主从复制的用户密码<br> report_script=/usr/local/send_report　　　　　#设置发生故障切换的时候发送邮件提醒<br> secondary_check_script=/usr/local/bin/masterha_secondary_check -s 192.168.80.11 -s 192.168.80.12    #指定检查的从服务器IP地址<br> shutdown_script=""            #设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机防止发生脑裂，这里没有使用）<br> ssh_user=root                #设置ssh的登录用户名</p> 
<p>[server1]<br> hostname=192.168.80.10<br> port=3306</p> 
<p>[server2]<br> hostname=192.168.80.11<br> port=3306<br> candidate_master=1<br> #设置为候选master，设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个从库不是集群中最新的slave</p> 
<p>check_repl_delay=0<br> #默认情况下如果一个slave落后master 超过100M的relay logs的话，MHA将不会选择该slave作为一个新的master， 因为对于这个slave的恢复需要花费很长时间；通过设置check_repl_delay=0，MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master</p> 
<p>[server3]<br> hostname=192.168.80.12<br> port=3306<br> ----------------------------------------------------------------------------------------------------------</p> 
<p><br> 9．第一次配置需要在 Master 节点上手动开启虚拟IP<br> /sbin/ifconfig ens33:1 192.168.80.200/24</p> 
<p><br> 10．在 manager 节点上测试 ssh 无密码认证，如果正常最后会输出 successfully，如下所示。<br> masterha_check_ssh -conf=/opt/mysql-mha/mysql_mha.cnf</p> 
<p>Tue Nov 26 23:09:45 2020 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.<br> Tue Nov 26 23:09:45 2020 - [info] Reading application default configuration from /opt/mysql-mha/mysql_mha.cnf..<br> Tue Nov 26 23:09:45 2020 - [info] Reading server configuration from /opt/mysql-mha/mysql_mha.cnf..<br> Tue Nov 26 23:09:45 2020 - [info] Starting SSH connection tests..<br> Tue Nov 26 23:09:46 2020 - [debug] <br> Tue Nov 26 23:09:45 2020 - [debug]  Connecting via SSH from root@192.168.80.11(192.168.80.11:22) to root@192.168.80.12(192.168.80.12:22)..<br> Tue Nov 26 23:09:46 2020 - [debug]   ok.<br> Tue Nov 26 23:09:47 2020 - [debug] <br> Tue Nov 26 23:09:46 2020 - [debug]  Connecting via SSH from root@192.168.80.12(192.168.80.12:22) to root@192.168.80.11(192.168.80.11:22)..<br> Tue Nov 26 23:09:47 2020 - [debug]   ok.<br> Tue Nov 26 23:09:47 2020 - [info] All SSH connection tests passed successfully.</p> 
<p>11．在 manager 节点上测试 mysql 主从连接情况，最后出现 MySQL Replication Health is OK 字样说明正常。如下所示。<br> masterha_check_repl -conf=/opt/mysql-mha/mysql_mha.cnf</p> 
<p>Tue Nov 26 23:10:29 2020 - [info] Slaves settings check done.<br> Tue Nov 26 23:10:29 2020 - [info] <br> 192.168.80.11(192.168.80.11:3306) (current master)<br>  +--192.168.80.12(192.168.80.12:3306)</p> 
<p>Tue Nov 26 23:10:29 2020 - [info] Checking replication health on 192.168.80.12..<br> Tue Nov 26 23:10:29 2020 - [info]  ok.<br> Tue Nov 26 23:10:29 2020 - [info] Checking master_ip_failover_script status:<br> Tue Nov 26 23:10:29 2020 - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.80.11 --orig_master_ip=192.168.80.11 --orig_master_port=3306 </p> 
<p><br> IN SCRIPT TEST====/sbin/ifconfig ens33:1 down==/sbin/ifconfig ens33:1 192.168.80.200===</p> 
<p>Checking the Status of the script.. OK <br> Tue Nov 26 23:10:29 2020 - [info]  OK.<br> Tue Nov 26 23:10:29 2020 - [warning] shutdown_script is not defined.<br> Tue Nov 26 23:10:29 2020 - [info] Got exit code 0 (Not master dead).</p> 
<p>MySQL Replication Health is OK.</p> 
<p><br> 12．在 manager 节点上启动 MHA<br> nohup masterha_manager \<br> --conf=/opt/mysql-mha/mysql_mha.cnf \<br> --remove_dead_master_conf \<br> --ignore_last_failover &lt; /dev/null &gt; /var/log/mha_manager.log 2&gt;&amp;1 &amp;</p> 
<p>----------------------------------------------------------------------------------------------------------<br> --remove_dead_master_conf：该参数代表当发生主从切换后，老的主库的 ip 将会从配置文件中移除。<br> --ignore_last_failover：在缺省情况下，如果 MHA 检测到连续发生宕机，且两次宕机间隔不足 8 小时的话，则不会进行 Failover， 之所以这样限制是为了避免 ping-pong 效应。该参数代表忽略上次 MHA 触发切换产生的文件，默认情况下，MHA 发生切换后会在 app1.failover.complete 日志文件中记录，下次再次切换的时候如果发现该目录下存在该文件将不允许触发切换， 除非在第一次切换后删除该文件，为了方便，这里设置为--ignore_last_failover。<br> ----------------------------------------------------------------------------------------------------------<br> ●使用&amp;后台运行程序：结果会输出到终端；使用Ctrl+C发送SIGINT信号，程序免疫；关闭session发送SIGHUP信号，程序关闭。<br> ●使用nohup运行程序：结果默认会输出到nohup.out；使用Ctrl+C发送SIGINT信号，程序关闭；关闭session发送SIGHUP信号，程序免疫。<br> ●使用nohup和&amp;配合来启动程序nohup ./test &amp;：同时免疫SIGINT和SIGHUP信号。<br> ----------------------------------------------------------------------------------------------------------</p> 
<p>13．查看 MHA 状态，可以看到当前的 master 是 mysql1 节点。<br> masterha_check_status --conf=/opt/mysql-mha/mysql_mha.cnf</p> 
<p>14. 查看 MHA 日志，也以看到当前的 master 是 192.168.80.10，如下所示。<br> cat /opt/mysql-mha/manager.log | grep "current master"</p> 
<p>15. 查看 mysql1 的 VIP 地址 192.168.80.200 是否存在，这个 VIP 地址不会因为 manager 节点停止 MHA 服务而消失。<br> ifconfig</p> 
<p>//若要关闭 manager 服务，可以使用如下命令。<br> masterha_stop --conf=/opt/mysql-mha/mysql_mha.cnf<br> 或者可以直接采用 kill 进程 ID 的方式关闭。</p> 
<h6 id="----------------------%20%E6%95%85%E9%9A%9C%E6%A8%A1%E6%8B%9F%20--------------------------------"><br> ---------------------- 故障模拟 --------------------------------</h6> 
<p><br> #在 manager 节点上监控观察日志记录<br> tail -f /opt/mysql-mha/manager.log</p> 
<p>#在 Master 节点 mysql1 上停止mysql服务<br> systemctl stop mysqld<br> 或<br> pkill -9 mysql</p> 
<p>#正常自动切换一次后，MHA 进程会退出。HMA 会自动修改 app1.cnf 文件内容，将宕机的 mysql1 节点删除。查看 mysql2 是否接管 VIP<br> ifconfig</p> 
<p>故障切换备选主库的算法：<br> 1．一般判断从库的是从（position/GTID）判断优劣，数据有差异，最接近于master的slave，成为备选主。<br> 2．数据一致的情况下，按照配置文件顺序，选择备选主库。<br> 3．设定有权重（candidate_master=1），按照权重强制指定备选主。<br> （1）默认情况下如果一个slave落后master 100M的relay logs的话，即使有权重，也会失效。<br> （2）如果check_repl_delay=0的话，即使落后很多日志，也强制选择其为备选主。</p> 
<p>故障修复步骤：<br> 1．修复mysql<br> systemctl restart mysqld</p> 
<p>2．修复主从<br> #在现主库服务器 mysql2 查看二进制文件和同步点<br> show master status;</p> 
<p>#在原主库服务器 mysql1 执行同步操作<br> change master to master_host='192.168.80.11',master_user='myslave',master_password='123',master_log_file='mysql-bin.000001',master_log_pos=1745;</p> 
<p>start slave;</p> 
<p><br> 3．在 manager 节点上修改配置文件app1.cnf（再把这个记录添加进去，因为它检测掉失效时候会自动消失）<br> vi /etc/masterha/app1.cnf<br> ......<br> secondary_check_script=/usr/local/bin/masterha_secondary_check -s 192.168.80.10 -s 192.168.80.12<br> ......<br> [server1]<br> hostname=192.168.80.11<br> port=3306</p> 
<p>[server2]<br> candidate_master=1<br> check_repl_delay=0<br> hostname=192.168.80.10<br> port=3306</p> 
<p>[server3]<br> hostname=192.168.80.12<br> port=3306</p> 
<p>4．在 manager 节点上启动 MHA<br> nohup masterha_manager \<br> --conf=/opt/mysql-mha/mysql_mha.cnf \<br> --remove_dead_master_conf \<br> --ignore_last_failover &lt; /dev/null &gt; /var/log/mha_manager.log 2&gt;&amp;1 &amp;</p> 
<p>#解决中英字不兼容报错的问题<br> dos2unix /usr/local/bin/master_ip_failover </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/453ce5e7f02af4e3840c5e4455c932a8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【自少目多集】北京23年高考学校排名笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/138912570f80a82abcb1ff31f0c546ab/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">NodeJS报错Cannot access ‘xxx‘ before initialization排查解决</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>