<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【动态代理详解】 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【动态代理详解】" />
<meta property="og:description" content="文章目录 1. 关于代理1.1 代理的概述1.1.1 什么是动态代理1.1.2 动态代理能做什么 1.2 什么是代理1.2.1 生活中的代理1.2.2 为什么要找中介？ 1.3 开发中的代理模式（代理）1.3.1 使用代理模式的作用 1.4 实现代理的方式 2. 静态代理2.1 什么是静态代理2.2 静态代理的实现步骤2.3 静态代理的优缺点 3. 动态代理（重点）3.1 什么是动态代理3.2 动态代理的优点3.3 动态代理的两种实现方式3.3.1 jdk动态代理的实现3.3.2 InvocationHandler 接口（调用处理器）3.3.3 如何理解InvocationHandler接口3.3.4 Method类3.3.5 Proxy类 3.4 动态代理的实现步骤 4.动态代理开发中实例 1. 关于代理 知道什么是动态代理以及动态代理能干什么就可以
1.1 代理的概述 1.1.1 什么是动态代理 ​ 使用jdk的反射机制，创建对象的能力， 创建的是代理类的对象。
动态：在程序执行时，调用jdk提供的方法才能创建代理类的对象。jdk动态代理，必须有接口，目标类必须实现接口， 没有接口时，需要使用cglib动态代理 1.1.2 动态代理能做什么 ​ 可以在不改变原来目标方法功能的前提下， 可以在代理中增强自己的功能代码。
​ 例如实际开发中，你所在的项目中，有一个功能是其他人（公司的其它部门，其它小组的人）写好的，你可以使用。你发现这个功能，现在还缺点，不能完全满足我项目的需要。 我需要在gn.print()执行后，需要自己在增加代码。用代理实现 gn.print（）调用时， 增加自己代码， 而不用去改原来的 GoNong文件。
// GoNong.class GoNong gn = new GoNong(); gn.print(); ​ 注意，不知道源代码，不能使用重写，而且你要用写好的功能想要去扩展功能，就只能先把写好的方法执行一边，然后再代理中扩展，重写的话，原来写好的方法也没了
1.2 什么是代理 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/feed96f2e3de4cb0404cbf9363bdfc2f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-08T23:32:47+08:00" />
<meta property="article:modified_time" content="2024-01-08T23:32:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【动态代理详解】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__2" rel="nofollow">1. 关于代理</a></li><li><ul><li><a href="#11__8" rel="nofollow">1.1 代理的概述</a></li><li><ul><li><a href="#111__12" rel="nofollow">1.1.1 什么是动态代理</a></li><li><a href="#112__21" rel="nofollow">1.1.2 动态代理能做什么</a></li></ul> 
   </li><li><a href="#12___37" rel="nofollow">1.2 什么是代理</a></li><li><ul><li><a href="#121__39" rel="nofollow">1.2.1 生活中的代理</a></li><li><a href="#122___58" rel="nofollow">1.2.2 为什么要找中介？</a></li></ul> 
   </li><li><a href="#13___67" rel="nofollow">1.3 开发中的代理模式（代理）</a></li><li><ul><li><a href="#131___75" rel="nofollow">1.3.1 使用代理模式的作用</a></li></ul> 
   </li><li><a href="#14__82" rel="nofollow">1.4 实现代理的方式</a></li></ul> 
  </li><li><a href="#2___88" rel="nofollow">2. 静态代理</a></li><li><ul><li><a href="#21__92" rel="nofollow">2.1 什么是静态代理</a></li><li><a href="#22__98" rel="nofollow">2.2 静态代理的实现步骤</a></li><li><a href="#23__205" rel="nofollow">2.3 静态代理的优缺点</a></li></ul> 
  </li><li><a href="#3__220" rel="nofollow">3. 动态代理（重点）</a></li><li><ul><li><a href="#31___222" rel="nofollow">3.1 什么是动态代理</a></li><li><a href="#32___228" rel="nofollow">3.2 动态代理的优点</a></li><li><a href="#33___236" rel="nofollow">3.3 动态代理的两种实现方式</a></li><li><ul><li><a href="#331_jdk_249" rel="nofollow">3.3.1 jdk动态代理的实现</a></li><li><ul><li><a href="#332_InvocationHandler__253" rel="nofollow">3.3.2 InvocationHandler 接口（调用处理器）</a></li><li><a href="#333__InvocationHandler_271" rel="nofollow">3.3.3 如何理解InvocationHandler接口</a></li><li><a href="#334_Method_281" rel="nofollow">3.3.4 Method类</a></li><li><a href="#335_Proxy_288" rel="nofollow">3.3.5 Proxy类</a></li></ul> 
   </li></ul> 
   </li><li><a href="#34__307" rel="nofollow">3.4 动态代理的实现步骤</a></li></ul> 
  </li><li><a href="#4_416" rel="nofollow">4.动态代理开发中实例</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__2"></a>1. 关于代理</h2> 
<blockquote> 
 <p>知道什么是动态代理以及动态代理能干什么就可以</p> 
</blockquote> 
<h3><a id="11__8"></a>1.1 代理的概述</h3> 
<h4><a id="111__12"></a>1.1.1 什么是动态代理</h4> 
<p>​ <mark>使用jdk的反射机制，创建对象的能力， 创建的是代理类的对象。</mark></p> 
<ul><li>动态：在程序执行时，调用jdk提供的方法才能创建代理类的对象。</li><li>jdk动态代理，必须有接口，目标类必须实现接口， 没有接口时，需要使用cglib动态代理</li></ul> 
<h4><a id="112__21"></a>1.1.2 动态代理能做什么</h4> 
<p>​ <mark>可以在不改变原来目标方法功能的前提下， 可以在代理中增强自己的功能代码。</mark></p> 
<p>​ 例如实际开发中，你所在的项目中，有一个功能是其他人（公司的其它部门，其它小组的人）写好的，你可以使用。你发现这个功能，现在还缺点，不能完全满足我项目的需要。 我需要在gn.print()执行后，需要自己在增加代码。用代理实现 gn.print（）调用时， 增加自己代码， 而不用去改原来的 GoNong文件。</p> 
<pre><code class="prism language-java"><span class="token comment">// GoNong.class </span>
<span class="token class-name">GoNong</span> gn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoNong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gn<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>​ 注意，不知道源代码，不能使用重写，而且你要用写好的功能想要去扩展功能，就只能先把写好的方法执行一边，然后再代理中扩展，重写的话，原来写好的方法也没了</p> 
<h3><a id="12___37"></a>1.2 什么是代理</h3> 
<h4><a id="121__39"></a>1.2.1 生活中的代理</h4> 
<p>​ 代理就是中介、代购、商家等。</p> 
<p>​ 例如留学中介就是一个代理，我想上美国的一所大学，但是我没办法去这个大学实地考察，也没办法要这个大学的联系方式，并且这个大学拒绝个人去访问它。但是这个大学在国内把招生业务委派给了一个留学中介。这样我就可以去和留学中介交谈，留学中介可以与美国大学联系。留学中介会从我这里收取额外的中介费。</p> 
<p>​ 在以上的案例中，学校是目标，留学中介是代理，我是客户。它们具有以下特点：</p> 
<ul><li> <p>中介和代理他们要做的事情是一致的： 招生。</p> </li><li> <p>中介是学校代理， 学校是目标。</p> </li><li> <p>我—中介（学校介绍，办入学手续）----美国学校。</p> </li><li> <p>中介是代理，不能白干活，需要收取费用。</p> </li><li> <p>代理不让你访问到目标。</p> </li></ul> 
<h4><a id="122___58"></a>1.2.2 为什么要找中介？</h4> 
<ul><li> <p>中介是专业的，方便</p> </li><li> <p>我现在不能自己去找学校。 我没有能力访问学校。 或者美国学校不接收个人来访。</p> </li><li> <p>买东西都是商家卖， 商家是某个商品的代理， 你个人买东西， 肯定不会让你接触到厂家的。</p> </li></ul> 
<h3><a id="13___67"></a>1.3 开发中的代理模式（代理）</h3> 
<p>​ 代理模式是指，当一个对象（目标）无法直接使用时，可以在该客户端和目标类之间创建一个中介，这个中介就是代理。</p> 
<p>​ 在实际开发中有这样情况，有一个A类，有一个C类，但是C类不允许A类直接访问，这样我们可以创建一个A类和C类之间的B类，C类允许B类访问，这样我们可以在A类中访问B类，然后B类在访问C类，这样就相当于在A类中间接访问到了C类。其中<mark>A类是客户类，B类是代理类，C类是目标类</mark>。另外，我可以在B类中添加一些内容，意味着功能增强。</p> 
<h4><a id="131___75"></a>1.3.1 使用代理模式的作用</h4> 
<ul><li>功能增强： 在你原有的功能上，增加了额外的功能。 新增加的功能，叫做功能增强。 (例如，留学中介要收取额外的费用)</li><li>控制访问： 代理类不让你访问目标，例如商家不让用户访问厂家。（就跟房屋中介肯定不会给房东电话给你，否则它们怎么赚中介费）</li></ul> 
<h3><a id="14__82"></a>1.4 实现代理的方式</h3> 
<blockquote> 
 <p>实现代理的方式有：静态代理，动态代理</p> 
</blockquote> 
<h2><a id="2___88"></a>2. 静态代理</h2> 
<h3><a id="21__92"></a>2.1 什么是静态代理</h3> 
<p>​ 静态代理：代理类是手工创建的，代理的目标类是固定的。</p> 
<h3><a id="22__98"></a>2.2 静态代理的实现步骤</h3> 
<blockquote> 
 <p>模拟一个用户购买u盘的行为，其中用户是客户端类，商家是代理类，厂家是目标类，商家和厂家都是卖U盘的，应该把卖U盘这个动作抽象为一个接口。</p> 
</blockquote> 
<ol><li> <p>创建一个接口，定义卖u盘的方法， 表示你的厂家和商家做的事情。</p> <pre><code class="prism language-java"><span class="token comment">// 表示功能的，厂家，商家都要完成的功能</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UsbSell</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//定义方法 参数 amount:表示一次购买的数量，暂时不用</span>
    <span class="token comment">//返回值表示一个u盘的价格。</span>
    <span class="token keyword">float</span> <span class="token function">sell</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//可以多个其它的方法</span>
    <span class="token comment">//void print();</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>创建厂家类，实现1步骤的接口</p> <pre><code class="prism language-java"><span class="token comment">//目标类：金士顿厂家, 不接受用户的单独购买。</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsbKingFactory</span> <span class="token keyword">implements</span> <span class="token class-name">UsbSell</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">sell</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"目标类中的方法调用 , UsbKingFactory 中的sell "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//一个128G的u盘是 85元。</span>
        <span class="token comment">//后期根据amount ，可以实现不同的价格，例如10000个，单击是80， 50000个75</span>
        <span class="token keyword">return</span> <span class="token number">85.0f</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>                          
</code></pre> </li><li> <p>创建商家，就是代理类，也需要实现1步骤中的接口。</p> <pre><code class="prism language-java"><span class="token comment">// taobao是一个商家，代理金士顿u盘的销售。</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaoBao</span> <span class="token keyword">implements</span> <span class="token class-name">UsbSell</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 声明 商家代理的厂家具体是谁</span>
    <span class="token comment">// private修饰为了控制访问，不让客户知道厂家是谁</span>
    <span class="token keyword">private</span> <span class="token class-name">UsbKingFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsbKingFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token comment">// 实现销售u盘功能</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">sell</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">// 向厂家发送订单，告诉厂家，我买了u盘，厂家发货</span>
        <span class="token keyword">float</span> price <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">sell</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//厂家的价格。</span>
        <span class="token comment">// 商家 需要加价， 也就是代理要增加价格。</span>
        price <span class="token operator">=</span> price <span class="token operator">+</span> <span class="token number">25</span><span class="token punctuation">;</span> <span class="token comment">//增强功能，代理类在完成目标类方法调用后，增强了功能。</span>
        <span class="token comment">// 在目标类的方法调用后，你做的其它功能，都是增强的意思。</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"淘宝商家，给你返一个优惠券，或者红包"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 增加的价格</span>
        <span class="token keyword">return</span> price<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeiShang</span> <span class="token keyword">implements</span> <span class="token class-name">UsbSell</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//代理的是 金士顿，定义目标厂家类</span>
    <span class="token keyword">private</span> <span class="token class-name">UsbKingFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsbKingFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">sell</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//调用目标方法</span>
        <span class="token keyword">float</span> price <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">sell</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//只增加1元</span>
        price <span class="token operator">=</span> price <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> price<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>创建客户端类，调用商家的方法买一个u盘。</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 通过淘宝卖</span>
        <span class="token comment">// 下载了淘宝的app</span>
        <span class="token comment">/*
        TaoBao taoBao = new TaoBao();
        // 通过代理类，实现购买u盘，增加了优惠券，红包等等
        float price = taoBao.sell(1);
        System.out.println("淘宝的价格：" + price);
        */</span>

        <span class="token comment">// 取得微商的联系方式</span>
        <span class="token class-name">WeiShang</span> weiShang <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeiShang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过微商代理，实现购买u盘，增加了优惠券，红包等等</span>
        <span class="token keyword">float</span> price <span class="token operator">=</span> weiShang<span class="token punctuation">.</span><span class="token function">sell</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"通过微商购买的价格："</span><span class="token operator">+</span> price<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p>分析问题：</p> 
<ul><li>以上实例，若只有一个目标类，如金士顿厂家，商家只需要和这个厂家联系就行。但是如果又有一个闪迪厂家，那么得重写一套代理类，因为一个代理类中只能指定一个厂家，如以上的淘宝类，制定了厂家是金士顿，就不能在指定闪迪厂家，只能重新新建一个代理类，在这个代理类中指定厂家是闪迪，微商也是一样，要来一个专门代理闪迪的微商。如果有100个厂家，那么就要写200个代理类。</li><li>如果UsbSell接口多了个退货功能，那么所有的目标类和代理类都要修改。</li></ul> 
<h3><a id="23__205"></a>2.3 静态代理的优缺点</h3> 
<ul><li>优点 
  <ul><li>实现简单</li><li>容易理解</li></ul> </li><li>缺点（当你的项目中，目标类和代理类很多时候，有以下的缺点：） 
  <ul><li>当目标类增加了，代理类可能也需要成倍的增加。 代理类数量过多。</li><li>当你的接口中功能增加了，或者修改了，会影响众多的实现类，厂家类，代理都需要修改。影响比较多。</li></ul> </li></ul> 
<p>简而言之，静态代理容易理解，代码好写，但是各个类之间耦合度太高，一旦扩展就有问题</p> 
<h2><a id="3__220"></a>3. 动态代理（重点）</h2> 
<h3><a id="31___222"></a>3.1 什么是动态代理</h3> 
<p>​ 动态代理就是在程序执行过程（动态）中，使用jdk的反射机制，创建代理类对象， 并动态的指定要代理目标类。换句话说： <mark>动态代理是一种创建java对象的能力</mark>，让你不用自己写代理类的java程序，然后new对象。而是直接用jdk创建代理类对象。这样我不关心代理类是谁，我只知道它能增强功能，并且通过它我可以找到目标类。（类似暗下交易）</p> 
<h3><a id="32___228"></a>3.2 动态代理的优点</h3> 
<ul><li>优点 
  <ul><li>动态代理中目标类即使很多，但是代理类数量可以很少，当你修改了接口中的方法时，不会影响代理类（压根就不用写代理类了，这个代理类是jdk创建的，只是起到一个中介的功能）。符合OCP原则</li><li>不用创建代理类文件，代理的目标类是灵活的，可以随意给不同目标创建代理</li></ul> </li></ul> 
<h3><a id="33___236"></a>3.3 动态代理的两种实现方式</h3> 
<ul><li>jdk动态代理（理解）： 使用java反射包中的类和接口实现动态代理的功能。 
  <ul><li>反射包 java.lang.reflect , 里面有三个类 ： InvocationHandler , Method, Proxy.</li></ul> </li><li>cglib动态代理（了解）: cglib是第三方的工具库， 创建代理对象。 
  <ul><li>cglib的原理是继承， cglib通过继承目标类，创建它的子类，在子类中重写父类中同名的方法， 实现功能的修改。</li><li>因为cglib是继承，重写方法，所以要求目标类不能是final的， 方法也不能是final的。</li><li>cglib的要求目标类比较宽松， 只要能继承就可以了。cglib在很多的框架中使用，比如 mybatis ，spring框架中都有使用。</li></ul> </li></ul> 
<p>注意：jdk动态代理必须有接口，对于无接口类，必须使用cglib来为它创建动态代理</p> 
<h4><a id="331_jdk_249"></a>3.3.1 jdk动态代理的实现</h4> 
<blockquote> 
 <p>需要用到反射包 java.lang.reflect，里面有三个类 ： InvocationHandler , Method, Proxy.</p> 
</blockquote> 
<h5><a id="332_InvocationHandler__253"></a>3.3.2 InvocationHandler 接口（调用处理器）</h5> 
<ul><li>该接口中只有一个方法：invoke()方法</li><li>invoke()方法最后是由代理类调用的，所以代理类完成的功能写在该方法里 
  <ul><li>代理类完成的功能：调用目标方法、功能增强</li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
</code></pre> 
<p>invoke方法参数：</p> 
<ul><li>proxy：代理对象，由jdk创建</li><li>method：目标方法，因为代理类的功能是调用目标方法，所以这里要给出</li><li>args：目标方法的参数</li></ul> 
<h5><a id="333__InvocationHandler_271"></a>3.3.3 如何理解InvocationHandler接口</h5> 
<ul><li> <p>InvocationHandler接口表示你的代理想要干什么，即代理完成的功能写在该接口实现类的invoke方法中</p> </li><li> <p>使用方法：</p> 
  <ol><li>创建类实现接口InvocationHandler</li><li>重写invoke()方法，把原来静态代理中代理类要完成的功能，写在这。</li></ol> </li></ul> 
<h5><a id="334_Method_281"></a>3.3.4 Method类</h5> 
<ul><li>method表示目标类中的方法</li><li>method是要发给InvocationHandler实现类的invoke方法的参数，表示代理所调用的目标方法</li></ul> 
<h5><a id="335_Proxy_288"></a>3.3.5 Proxy类</h5> 
<ul><li>通过该类可以生成代理对象，代理对象的创建是由jdk提供的，我们只是负责调Proxy类中的方法来拿到这个代理对象</li><li>调用Proxy类中的静态方法newProxyInstance()可以创建一个代理对象，具体创建步骤是由jdk完成的</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span><span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span>
</code></pre> 
<p>newProxyInstance参数说明：</p> 
<ul><li>loader表示目标对象的类加载器，固定写法：目标对象.getClass().getClassLoader();</li><li>interfaces表示目标对象所实现的接口，接口多继承，因此是个数组。固定写法：目标对象.getClass().getInterface();</li><li>h表示代理类所要完成的功能</li></ul> 
<p>返回值就是代理类对象，并且在该对象创建时已经说明了，该代理类对象所代理的目标对象是谁，该目标对象完成了那些功能，该代理类所要完成的功能</p> 
<h3><a id="34__307"></a>3.4 动态代理的实现步骤</h3> 
<ol><li> <p>创建接口，定义目标类要完成的功能</p> <pre><code class="prism language-java"><span class="token comment">/**
 * 目标类要完成的功能
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UsbSell</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">float</span> <span class="token function">sell</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>创建目标类实现接口</p> <pre><code class="prism language-java"><span class="token comment">//目标类：金士顿厂家, 不接受用户的单独购买。</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsbKingFactory</span> <span class="token keyword">implements</span> <span class="token class-name">UsbSell</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">sell</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"目标类中的方法调用 , UsbKingFactory 中的sell "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//一个128G的u盘是 85元。</span>
        <span class="token comment">//后期根据amount ，可以实现不同的价格，例如10000个，单击是80， 50000个75</span>
        <span class="token keyword">return</span> <span class="token number">85.0f</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>创建InvocationHandler接口的实现类，在invoke方法中完成代理类的功能<br> 1.调用目标方法<br> 2.增强功能</p> <pre><code class="prism language-java"><span class="token comment">//必须实现InvocationHandler接口，完成代理类要做的功能（1.调用目标方法，2.功能增强）</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySellHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">//动态代理：目标对象是活动的，不是固定的，需要传入进来。</span>
    <span class="token comment">//传入是谁，就给谁创建代理。</span>
    <span class="token keyword">public</span> <span class="token class-name">MySellHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//给目标对象赋值</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">Object</span> res  <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//向厂家发送订单，告诉厂家，我买了u盘，厂家发货</span>
        <span class="token comment">//float price = factory.sell(amount); //厂家的价格。</span>
        res <span class="token operator">=</span>  method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行目标方法</span>



        <span class="token comment">//商家 需要加价， 也就是代理要增加价格。</span>
        <span class="token comment">//price = price + 25; //增强功能，代理类在完成目标类方法调用后，增强了功能。</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> res <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Float</span> price <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Float</span><span class="token punctuation">)</span>res<span class="token punctuation">;</span>
            price <span class="token operator">=</span> price <span class="token operator">+</span> <span class="token number">25</span><span class="token punctuation">;</span>
            res <span class="token operator">=</span> price<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//在目标类的方法调用后，你做的其它功能，都是增强的意思。</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"淘宝商家，给你返一个优惠券，或者红包"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//记录数据库</span>

        <span class="token comment">//增加的价格</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>使用Proxy类的静态方法，创建代理对象。 并把返回值转为接口类型。</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建代理对象，使用Proxy</span>
        <span class="token comment">//1. 创建目标对象</span>
        <span class="token comment">// UsbKingFacotry  factory = new UsbKingFactory();</span>
        <span class="token class-name">UsbSell</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsbKingFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.创建InvocationHandler对象</span>
        <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySellHandler</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.创建代理对象</span>
        <span class="token class-name">UsbSell</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UsbSell</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                factory<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//com.sun.proxy.$Proxy0 : 这是jdk动态代理创建的对象类型。</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"proxy:"</span><span class="token operator">+</span>proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4.通过代理执行方法</span>
        <span class="token keyword">float</span> price <span class="token operator">=</span> proxy<span class="token punctuation">.</span><span class="token function">sell</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"通过动态代理对象，调用方法："</span><span class="token operator">+</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p><img src="https://images2.imgbox.com/9e/1a/SLv79Uti_o.png" alt="外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传"><img src="https://images2.imgbox.com/7e/9d/mdlAyq8U_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4_416"></a>4.动态代理开发中实例</h2> 
<pre><code class="prism language-java"><span class="token comment">// 目标完成的功能</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HelloService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//打印报告， 报表</span>
    <span class="token keyword">int</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 目标类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoNeng</span> <span class="token keyword">implements</span> <span class="token class-name">HelloService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"其它人写好的个功能方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 代理完成的功能</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyInvocationHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//我在项目中记录数据库，</span>
        <span class="token comment">//调用目标方法， 执行print()得到 2</span>
        <span class="token class-name">Object</span> res <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//2</span>
        
        <span class="token comment">// 代理进行“功能增强”</span>
        <span class="token comment">//需要乘以 2的结果  </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> res <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Integer</span> num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span>res<span class="token punctuation">;</span>
            res <span class="token operator">=</span> num <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 测试类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApp</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// GoNeng gn = new GoNeng();</span>
        <span class="token comment">//int num = gn.print("销售");</span>
       <span class="token comment">// System.out.println("num="+num);</span>
		
        <span class="token comment">// 创建目标类</span>
        <span class="token class-name">GoNeng</span> goNeng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoNeng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 代理完成的功能</span>
        <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyInvocationHandler</span><span class="token punctuation">(</span>goNeng<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 这里表示目标类必须实现一个接口，否则不能用jdk实现动态代理，只能用cglib实现动态代理</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"goNeng.getClass().getInterfaces()="</span><span class="token operator">+</span>goNeng<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HelloService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HelloService</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span> goNeng<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                goNeng<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 代理proxy的print方法实际上是接口中的，因为再创建代理是，把目标类的构造器和实现的接口都给了代理，并且代理完成的功能也给了代理</span>
        <span class="token comment">// 代理执行print方法就去handler的invoke方法，把print方法给了method，参数“市场”给了args</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> proxy<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"市场"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"我们期望的 num =="</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
        <span class="token comment">// 总之proxy，handler，目标类之间是相关联的。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/55bbfd3272ee46321451748ac22a111d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">K8S的集群调度</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/25d06aac1a33cadc9992ab4cae56b341/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AnnexB封装格式介绍（主要用于H.264和H.265视频编码标准，是一种常见的视频流NALU封装格式，常用于RTSP、RTP传输）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>