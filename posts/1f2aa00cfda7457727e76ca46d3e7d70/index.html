<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 6.0 运行时权限管理最佳实践 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 6.0 运行时权限管理最佳实践" />
<meta property="og:description" content="from: http://blog.csdn.net/yanzhenjie1003/article/details/52503533
这是一篇迟来的博客，Android M已经发布一年多了（6.0的变化），在Android M中权限系统被重新设计，发生了颠覆性的变化，很多人把握不好这个变化，一是对这个权限策略和套路还没有摸透，二是没有一个很好的实践来支撑，在我的技术开发群里很多人问我关于权限的问题，往往我都没有直接回答，因为这个问题不是一两句说的清楚的，这几点是今天我写这篇博客的原因。这里有一切关于Android运行时权限你需要知道的，包括如何在代码中实现，如果你以前不知道这些东西，现在来看也为时不晚，我将在详解之后给你一个最佳的实践方案。
由于项目一直在更新，更多新内容请直接看AndPermission开源主页： https://github.com/yanzhenjie/AndPermission
AndPermission能解决大部分国产机遇到的权限问题，请参考：国产手机权限适配方案
AndPermission特性 链式调用，一句话申请权限，为你省去复杂的逻辑判断。支持注解回调结果、支持Listener回调结果。拒绝一次某权限后，再次申请该权限时可使用Rationale向用户说明申请该权限的目的，在用户同意后再继续申请，避免用户勾选不再提示而导致不能再次申请该权限。就算用户拒绝权限并勾选不再提示，可使用SettingDialog提示用户去设置中授权。RationaleDialog和SettingDialog允许开发者自定义。AndPermission自带默认对话框除可自定义外，也支持国际化。支持在任何地方申请权限，不仅限于Activity和Fragment等。 如果你的英文够好，推荐你阅读官网的文章：
System PermissionsRequesting Permissions at Run TimePermissions Best Practices 关于运行时权限 在旧的权限管理系统中，权限仅仅在App安装时询问用户一次，用户同意了这些权限App才能被安装（某些深度定制系统另说），App一旦安装后就可以偷偷的做一些不为人知的事情了。
在Android6.0开始，App可以直接安装，App在运行时一个一个询问用户授予权限，系统会弹出一个对话框让用户选择是否授权某个权限给App（这个Dialog不能由开发者定制），当App需要用户授予不恰当的权限的时候，用户可以拒绝，用户也可以在设置页面对每个App的权限进行管理。
特别注意：这个对话框不是开发者调用某个权限的功能时由系统自动弹出，而是需要开发者手动调用，如果你直接调用而没有去申请权限的话，将会导致App崩溃。
也许你已经开始慌了，这对于用户来说是好事，但是对于开发者来说我们不能直接调用方法了，我们不得不在每一个需要权限的地方检查并请求用户授权，所以就引出了以下两个问题。
哪些权限需要动态申请 新的权限策略讲权限分为两类，第一类是不涉及用户隐私的，只需要在Manifest中声明即可，比如网络、蓝牙、NFC等；第二类是涉及到用户隐私信息的，需要用户授权后才可使用，比如SD卡读写、联系人、短信读写等。
不需要运行时申请的权限 此类权限都是正常保护的权限，只需要在AndroidManifest.xml中简单声明这些权限即可，安装即授权，不需要每次使用时都检查权限，而且用户不能取消以上授权，除非用户卸载App。
ACCESS_LOCATION_EXTRA_COMMANDSACCESS_NETWORK_STATEACCESS_NOTIFICATION_POLICYACCESS_WIFI_STATEBLUETOOTHBLUETOOTH_ADMINBROADCAST_STICKYCHANGE_NETWORK_STATECHANGE_WIFI_MULTICAST_STATECHANGE_WIFI_STATEDISABLE_KEYGUARDEXPAND_STATUS_BARGET_PACKAGE_SIZEINSTALL_SHORTCUTINTERNETKILL_BACKGROUND_PROCESSESMODIFY_AUDIO_SETTINGSNFCREAD_SYNC_SETTINGSREAD_SYNC_STATSRECEIVE_BOOT_COMPLETEDREORDER_TASKSREQUEST_IGNORE_BATTERY_OPTIMIZATIONSREQUEST_INSTALL_PACKAGESSET_ALARMSET_TIME_ZONESET_WALLPAPERSET_WALLPAPER_HINTSTRANSMIT_IRUNINSTALL_SHORTCUTUSE_FINGERPRINTVIBRATEWAKE_LOCKWRITE_SYNC_SETTINGS 需要运行时申请的权限 所有危险的Android系统权限属于权限组，如果APP运行在Android 6.0 (API level 23)或者更高级别的设备中，而且targetSdkVersion&gt;=23时，系统将会自动采用动态权限管理策略，如果你在涉及到特殊权限操作时没有申请权限权限而直接调用了相关代码，你的App可能就崩溃了，综上所述你需要注意：
此类权限也必须在Manifest中申明，否则申请时不提示用户，直接回调开发者权限被拒绝。同一个权限组的任何一个权限被授权了，这个权限组的其他权限也自动被授权。例如一旦WRITE_CONTACTS被授权了，App也有READ_CONTACTS和GET_ACCOUNTS了。申请某一个权限的时候系统弹出的Dialog是对整个权限组的说明，而不是单个权限。例如我申请READ_EXTERNAL_STORAGE，系统会提示&#34;允许xxx访问设备上的照片、媒体内容和文件吗？&#34;。 如果App运行在Android 5.1 (API level 22)或者更低级别的设备中，或者targetSdkVersion&lt;=22时（此时设备可以是Android 6.0 (API level 23)或者更高），在所有系统中仍将采用旧的权限管理策略，系统会要求用户在安装的时候授予权限。其次，系统就告诉用户App需要什么权限组，而不是个别的某个权限。
CALENDAR（日历） READ_CALENDARWRITE_CALENDAR CAMERA（相机） CAMERA CONTACTS（联系人） READ_CONTACTSWRITE_CONTACTSGET_ACCOUNTS LOCATION（位置） ACCESS_FINE_LOCATIONACCESS_COARSE_LOCATION MICROPHONE（麦克风） RECORD_AUDIO PHONE（手机） READ_PHONE_STATECALL_PHONEREAD_CALL_LOGWRITE_CALL_LOGADD_VOICEMAILUSE_SIPPROCESS_OUTGOING_CALLS SENSORS（传感器） BODY_SENSORS SMS（短信） SEND_SMSRECEIVE_SMSREAD_SMSRECEIVE_WAP_PUSHRECEIVE_MMS STORAGE（存储卡） READ_EXTERNAL_STORAGEWRITE_EXTERNAL_STORAGE 使用adb命令可以查看这些需要授权的权限组：
adb shell pm list permissions -d -g 1 使用adb命令同样可以授权/撤销某个权限：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1f2aa00cfda7457727e76ca46d3e7d70/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-01-30T16:39:00+08:00" />
<meta property="article:modified_time" content="2018-01-30T16:39:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 6.0 运行时权限管理最佳实践</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>from: <a target="_blank" href="http://blog.csdn.net/yanzhenjie1003/article/details/52503533" rel="noopener noreferrer">http://blog.csdn.net/yanzhenjie1003/article/details/52503533</a></p> 
<p></p> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 这是一篇迟来的博客，Android M已经发布一年多了（<a target="_blank" href="https://developer.android.com/about/versions/marshmallow/android-6.0-changes.html" rel="nofollow noopener noreferrer" style="color:rgb(12,137,207)">6.0的变化</a>），在Android M中权限系统被重新设计，发生了颠覆性的变化，很多人把握不好这个变化，一是对这个权限策略和套路还没有摸透，二是没有一个很好的实践来支撑，在我的技术开发群里很多人问我关于权限的问题，往往我都没有直接回答，因为这个问题不是一两句说的清楚的，这几点是今天我写这篇博客的原因。这里有一切关于Android运行时权限你需要知道的，包括如何在代码中实现，如果你以前不知道这些东西，现在来看也为时不晚，我将在详解之后给你一个最佳的实践方案。</p> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 由于项目一直在更新，更多新内容请直接看AndPermission开源主页： <br> <a target="_blank" href="https://github.com/yanzhenjie/AndPermission" style="color:rgb(12,137,207)" rel="noopener noreferrer">https://github.com/yanzhenjie/AndPermission</a></p> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> AndPermission能解决大部分国产机遇到的权限问题，请参考：<a target="_blank" href="https://github.com/yanzhenjie/AndPermission/blob/master/README-CN.md#%E5%9B%BD%E4%BA%A7%E6%89%8B%E6%9C%BA%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88" style="color:rgb(12,137,207)" rel="noopener noreferrer">国产手机权限适配方案</a></p> 
<h2 id="andpermission特性" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.6em; background-color:rgb(255,255,255)'> <a target="_blank" name="t0" style="color:rgb(12,137,207)"></a>AndPermission特性</h2> 
<ol style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; font-size:16px; background-color:rgb(255,255,255)'><li>链式调用，一句话申请权限，为你省去复杂的逻辑判断。</li><li>支持注解回调结果、支持Listener回调结果。</li><li><strong>拒绝一次</strong>某权限后，再次申请该权限时可使用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Rationale</code>向用户说明申请该权限的目的，在用户同意后再继续申请，避免用户勾选<strong>不再提示</strong>而导致不能再次申请该权限。</li><li>就算用户拒绝权限并勾选<strong>不再提示</strong>，可使用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">SettingDialog</code>提示用户去设置中授权。</li><li><code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">RationaleDialog</code>和<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">SettingDialog</code>允许开发者自定义。</li><li><code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">AndPermission</code>自带默认对话框除可自定义外，也支持国际化。</li><li>支持在任何地方申请权限，不仅限于<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Activity</code>和<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Fragment</code>等。</li></ol> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 如果你的英文够好，推荐你阅读官网的文章：</p> 
<ul style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'><li><a target="_blank" href="https://developer.android.com/guide/topics/security/permissions.html" rel="nofollow noopener noreferrer" style="color:rgb(12,137,207)">System Permissions</a></li><li><a target="_blank" href="https://developer.android.com/training/permissions/requesting.html" rel="nofollow noopener noreferrer" style="color:rgb(12,137,207)">Requesting Permissions at Run Time</a></li><li><a target="_blank" href="https://developer.android.com/training/permissions/best-practices.html" rel="nofollow noopener noreferrer" style="color:rgb(12,137,207)">Permissions Best Practices</a></li></ul> 
<hr style='margin-top:2em; margin-bottom:2em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'> 
<h2 id="关于运行时权限" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.6em; background-color:rgb(255,255,255)'> <a target="_blank" name="t1" style="color:rgb(12,137,207)"></a>关于运行时权限</h2> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 在旧的权限管理系统中，权限仅仅在App安装时询问用户一次，用户同意了这些权限App才能被安装（某些深度定制系统另说），App一旦安装后就可以偷偷的做一些不为人知的事情了。</p> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 在Android6.0开始，App可以直接安装，App在运行时一个一个询问用户授予权限，系统会弹出一个对话框让用户选择是否授权某个权限给App（这个Dialog不能由开发者定制），当App需要用户授予不恰当的权限的时候，用户可以拒绝，用户也可以在设置页面对每个App的权限进行管理。</p> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> <strong>特别注意：</strong>这个对话框不是开发者调用某个权限的功能时由系统自动弹出，而是需要开发者手动调用，如果你直接调用而没有去申请权限的话，将会导致App崩溃。</p> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 也许你已经开始慌了，这对于用户来说是好事，但是对于开发者来说我们不能直接调用方法了，我们不得不在每一个需要权限的地方检查并请求用户授权，所以就引出了以下两个问题。</p> 
<h2 id="哪些权限需要动态申请" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.6em; background-color:rgb(255,255,255)'> <a target="_blank" name="t2" style="color:rgb(12,137,207)"></a>哪些权限需要动态申请</h2> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 新的权限策略讲权限分为两类，第一类是不涉及用户隐私的，只需要在Manifest中声明即可，比如网络、蓝牙、NFC等；第二类是涉及到用户隐私信息的，需要用户授权后才可使用，比如SD卡读写、联系人、短信读写等。</p> 
<h3 id="不需要运行时申请的权限" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t3" style="color:rgb(12,137,207)"></a><a target="_blank" href="https://developer.android.com/guide/topics/security/normal-permissions.html" rel="nofollow noopener noreferrer" style="color:rgb(12,137,207)">不需要运行时申请的权限</a></h3> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 此类权限都是正常保护的权限，只需要在AndroidManifest.xml中简单声明这些权限即可，安装即授权，不需要每次使用时都检查权限，而且用户不能取消以上授权，除非用户卸载App。</p> 
<blockquote style='margin-right:0px; margin-bottom:1.7em; margin-left:0px; line-height:27.2px; padding:15px 20px; font-family:"microsoft yahei"'> 
 <ul style="line-height:27.2px; margin-bottom:1.7em"><li>ACCESS_LOCATION_EXTRA_COMMANDS</li><li>ACCESS_NETWORK_STATE</li><li>ACCESS_NOTIFICATION_POLICY</li><li>ACCESS_WIFI_STATE</li><li>BLUETOOTH</li><li>BLUETOOTH_ADMIN</li><li>BROADCAST_STICKY</li><li>CHANGE_NETWORK_STATE</li><li>CHANGE_WIFI_MULTICAST_STATE</li><li>CHANGE_WIFI_STATE</li><li>DISABLE_KEYGUARD</li><li>EXPAND_STATUS_BAR</li><li>GET_PACKAGE_SIZE</li><li>INSTALL_SHORTCUT</li><li>INTERNET</li><li>KILL_BACKGROUND_PROCESSES</li><li>MODIFY_AUDIO_SETTINGS</li><li>NFC</li><li>READ_SYNC_SETTINGS</li><li>READ_SYNC_STATS</li><li>RECEIVE_BOOT_COMPLETED</li><li>REORDER_TASKS</li><li>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</li><li>REQUEST_INSTALL_PACKAGES</li><li>SET_ALARM</li><li>SET_TIME_ZONE</li><li>SET_WALLPAPER</li><li>SET_WALLPAPER_HINTS</li><li>TRANSMIT_IR</li><li>UNINSTALL_SHORTCUT</li><li>USE_FINGERPRINT</li><li>VIBRATE</li><li>WAKE_LOCK</li><li>WRITE_SYNC_SETTINGS</li></ul> 
</blockquote> 
<h3 id="需要运行时申请的权限" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t4" style="color:rgb(12,137,207)"></a><a target="_blank" href="https://developer.android.com/guide/topics/security/permissions.html#perm-groups" rel="nofollow noopener noreferrer" style="color:rgb(12,137,207)">需要运行时申请的权限</a></h3> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 所有危险的Android系统权限属于权限组，如果APP运行在<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Android 6.0 (API level 23)</code>或者更高级别的设备中，而且<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">targetSdkVersion&gt;=23</code>时，系统将会自动采用动态权限管理策略，如果你在涉及到特殊权限操作时没有申请权限权限而直接调用了相关代码，你的App可能就崩溃了，综上所述你需要注意：</p> 
<ul style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'><li>此类权限也必须在Manifest中申明，否则申请时不提示用户，直接回调开发者权限被拒绝。</li><li>同一个权限组的任何一个权限被授权了，这个权限组的其他权限也自动被授权。例如一旦<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">WRITE_CONTACTS</code>被授权了，App也有<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">READ_CONTACTS</code>和<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">GET_ACCOUNTS</code>了。</li><li>申请某一个权限的时候系统弹出的Dialog是对整个权限组的说明，而不是单个权限。例如我申请<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">READ_EXTERNAL_STORAGE</code>，系统会提示<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">"允许xxx访问设备上的照片、媒体内容和文件吗？"</code>。</li></ul> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 如果App运行在<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Android 5.1 (API level 22)</code>或者更低级别的设备中，或者<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">targetSdkVersion&lt;=22</code>时（此时设备可以是<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Android 6.0 (API level 23)</code>或者更高），在所有系统中仍将采用旧的权限管理策略，系统会要求用户在安装的时候授予权限。其次，系统就告诉用户App需要什么权限组，而不是个别的某个权限。</p> 
<blockquote style='margin-right:0px; margin-bottom:1.7em; margin-left:0px; line-height:27.2px; padding:15px 20px; font-family:"microsoft yahei"'> 
 <ul style="line-height:27.2px; margin-bottom:1.7em"><li>CALENDAR（日历） <br> 
   <ul style="line-height:27.2px; margin-bottom:1.7em"><li>READ_CALENDAR</li><li>WRITE_CALENDAR</li></ul> </li><li>CAMERA（相机） <br> 
   <ul style="line-height:27.2px; margin-bottom:1.7em"><li>CAMERA</li></ul> </li><li>CONTACTS（联系人） <br> 
   <ul style="line-height:27.2px; margin-bottom:1.7em"><li>READ_CONTACTS</li><li>WRITE_CONTACTS</li><li>GET_ACCOUNTS</li></ul> </li><li>LOCATION（位置） <br> 
   <ul style="line-height:27.2px; margin-bottom:1.7em"><li>ACCESS_FINE_LOCATION</li><li>ACCESS_COARSE_LOCATION</li></ul> </li><li>MICROPHONE（麦克风） <br> 
   <ul style="line-height:27.2px; margin-bottom:1.7em"><li>RECORD_AUDIO</li></ul> </li><li>PHONE（手机） <br> 
   <ul style="line-height:27.2px; margin-bottom:1.7em"><li>READ_PHONE_STATE</li><li>CALL_PHONE</li><li>READ_CALL_LOG</li><li>WRITE_CALL_LOG</li><li>ADD_VOICEMAIL</li><li>USE_SIP</li><li>PROCESS_OUTGOING_CALLS</li></ul> </li><li>SENSORS（传感器） <br> 
   <ul style="line-height:27.2px; margin-bottom:1.7em"><li>BODY_SENSORS</li></ul> </li><li>SMS（短信） <br> 
   <ul style="line-height:27.2px; margin-bottom:1.7em"><li>SEND_SMS</li><li>RECEIVE_SMS</li><li>READ_SMS</li><li>RECEIVE_WAP_PUSH</li><li>RECEIVE_MMS</li></ul> </li><li>STORAGE（存储卡） <br> 
   <ul style="line-height:27.2px; margin-bottom:1.7em"><li>READ_EXTERNAL_STORAGE</li><li>WRITE_EXTERNAL_STORAGE</li></ul> </li></ul> 
</blockquote> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 使用adb命令可以查看这些需要授权的权限组：</p> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="hljs lasso has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">adb shell pm <span class="hljs-built_in" style="color: rgb(102, 0, 102);">list</span> permissions <span class="hljs-attribute">-d</span> <span class="hljs-attribute">-g</span></code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li></ul> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 使用adb命令同样可以授权/撤销某个权限：</p> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="hljs r has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">adb shell pm [grant|revoke] &lt;permission-name&gt;<span class="hljs-keyword">...</span></code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li></ul> 
<h2 id="关于运行时权限的一些建议" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.6em; background-color:rgb(255,255,255)'> <a target="_blank" name="t5" style="color:rgb(12,137,207)"></a>关于运行时权限的一些建议</h2> 
<ol style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; font-size:16px; background-color:rgb(255,255,255)'><li> <p style="margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal"> 只请求你需要的权限，减少请求的次数，或用隐式Intent来让其他的应用来处理。</p> 
  <ol style="line-height:27.2px; margin-bottom:1.7em"><li>如果你使用Intent，你不需要设计界面，由第三方的应用来完成所有操作。比如打电话、选择图片等。</li><li>如果你请求权限，你可以完全控制用户体验，自己定义UI。但是用户也可以拒绝权限，就意味着你的应用不能执行这个特殊操作。</li></ol> </li><li> <p style="margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal"> 防止一次请求太多的权限或请求次数太多，用户可能对你的应用感到厌烦，在应用启动的时候，最好先请求应用必须的一些权限，非必须权限在使用的时候才请求，建议整理并按照上述分类管理自己的权限：</p> 
  <ol style="line-height:27.2px; margin-bottom:1.7em"><li>普通权限（Normal PNermissions）：只需要在Androidmanifest.xml中声明相应的权限，安装即许可。</li><li>需要运行时申请的权限（Dangerous Permissions）： <br> 
    <ul style="line-height:27.2px; margin-bottom:1.7em"><li>必要权限：最好在应用启动的时候，进行请求许可的一些权限（主要是应用中主要功能需要的权限）。</li><li>附带权限：不是应用主要功能需要的权限(如：选择图片时，需要读取SD卡权限)。</li></ul> </li></ol> </li><li> <p style="margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal"> 解释你的应用为什么需要这些权限：在你调用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">requestPermissions()</code>之前，你为什么需要这个权限。</p> 
  <ol style="line-height:27.2px; margin-bottom:1.7em"><li>例如，一个摄影的App可能需要使用定位服务，因为它需要用位置标记照片。一般的用户可能会不理解，他们会困惑为什么他们的App想要知道他的位置。所以在这种情况下，所以你需要在<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">requestpermissions()</code>之前告诉用户你为什么需要这个权限。</li></ol> </li><li> <p style="margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal"> 使用兼容库<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">support-v4</code>中的方法</p> </li></ol> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">ContextCompat.checkSelfPermission()
ActivityCompat.requestPermissions()
ActivityCompat.shouldShowRequestPermissionRationale()</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li></ul> 
<h2 id="几个重要的方法与常量解释" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.6em; background-color:rgb(255,255,255)'> <a target="_blank" name="t6" style="color:rgb(12,137,207)"></a>几个重要的方法与常量解释</h2> 
<ul style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'><li> <p style="margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal"> PackageManager中的两个常量：</p> 
  <ul style="line-height:27.2px; margin-bottom:1.7em"><li>PackageManager.PERMISSION_DENIED：该权限是被拒绝的。</li><li>PackageManager.PERMISSION_GRANTED：该权限是被授权的。</li></ul> </li><li> <p style="margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal"> Activity中或者Fragment都会有以下几个方法：</p> </li></ul> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-keyword">int</span> checkSelfPermission(String)
<span class="hljs-keyword">void</span> requestPermissions(<span class="hljs-keyword">int</span>, String...)
<span class="hljs-keyword">boolean</span> shouldShowRequestPermissionRationale(String)
<span class="hljs-keyword">void</span> onRequestPermissionsResult()</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li></ul> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 上述四个方法中，前三个方法在<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">support-v4</code>的<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">ActivityCompat</code>中都有，建议使用兼容库中的方法。最后一个方法是用户授权或者拒绝某个权限组时系统会回调Activity或者Fragment中的方法。</p> 
<h3 id="checkselfpermission-检查权限" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t7" style="color:rgb(12,137,207)"></a>checkSelfPermission() 检查权限</h3> 
<ol style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; font-size:16px; background-color:rgb(255,255,255)'><li>检查某一个权限的当前状态，你应该在请求某个权限时检查这个权限是否已经被用户授权，已经授权的权限重复申请可能会让用户产生厌烦。</li><li>该方法有一个参数是权限名称，有一个int的返回值，用这个值与上面提到的两个常量做比较可判断检查的权限当前的状态。</li></ol> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-keyword">if</span> (ContextCompat.checkSelfPermission(context, Manifest.permission.READ_CONTACTS)
        != PackageManager.PERMISSION_GRANTED) {
    <span class="hljs-comment">// 没有权限，申请权限。</span>
}<span class="hljs-keyword">else</span>{
    <span class="hljs-comment">// 有权限了，去放肆吧。</span>
}</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li></ul> 
<h3 id="requestpermissions-申请权限" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t8" style="color:rgb(12,137,207)"></a>requestPermissions() 申请权限</h3> 
<ol style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; font-size:16px; background-color:rgb(255,255,255)'><li>请求用户授权几个权限，调用后系统会显示一个请求用户授权的提示对话框，App不能配置和修改这个对话框，如果需要提示用户这个权限相关的信息或说明，需要在调用 requestPermissions() 之前处理，该方法有两个参数： <br> 
  <ul style="line-height:27.2px; margin-bottom:1.7em"><li>int requestCode，会在回调<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">onRequestPermissionsResult()</code>时返回，用来判断是哪个授权申请的回调。</li><li>String[] permissions，权限数组，你需要申请的的权限的数组。</li></ul> </li><li>由于该方法是异步的，所以无返回值，当用户处理完授权操作时，会回调Activity或者Fragment的<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">onRequestPermissionsResult()</code>方法。</li></ol> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 对于Activity我们直接调用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">requestPermissions(int, String[])</code>即可，不过这个方法是在api leve 23以上，所以我们为了适配可以是使用兼容包提供的方法：</p> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">ActivityCompat.requestPermissions(activity, <span class="hljs-keyword">new</span> String[]{Manifest.permission.READ_CONTACTS}, MMM);</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li></ul> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 对于support包的<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Fragment</code>就可以直接调用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">requestPermissions(int, String[])</code>，对于app包的<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Fragment</code>就需要做版本判断了，这样就显得比较麻烦。</p> 
<h3 id="onrequestpermissionsresult-处理权限结果回调" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t9" style="color:rgb(12,137,207)"></a>onRequestPermissionsResult() 处理权限结果回调</h3> 
<ol style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; font-size:16px; background-color:rgb(255,255,255)'><li>该方法在Activity/Fragment中应该被重写，当用户处理完授权操作时，系统会自动回调该方法，该方法有三个参数： <br> 
  <ul style="line-height:27.2px; margin-bottom:1.7em"><li>int requestCode，在调用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">requestPermissions()</code>时的第一个参数。</li><li>String[] permissions，权限数组，在调用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">requestPermissions()</code>时的第二个参数。</li><li>int[] grantResults，授权结果数组，对应permissions，具体值和上方提到的PackageManager中的两个常量做比较。</li></ul> </li></ol> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-annotation">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRequestPermissionsResult</span>(<span class="hljs-keyword">int</span> requestCode, String permissions[], <span class="hljs-keyword">int</span>[] grantResults) {
    <span class="hljs-keyword">switch</span> (requestCode) {
        <span class="hljs-keyword">case</span> MMM: {
            <span class="hljs-keyword">if</span> (grantResults.length &gt; <span class="hljs-number">0</span>
                &amp;&amp; grantResults[<span class="hljs-number">0</span>] == PackageManager.PERMISSION_GRANTED) {
                <span class="hljs-comment">// 权限被用户同意，可以去放肆了。</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 权限被用户拒绝了，洗洗睡吧。</span>
            }
            <span class="hljs-keyword">return</span>;
        }
    }
}</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li></ul> 
<h3 id="shouldshowrequestpermissionrationale" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t10" style="color:rgb(12,137,207)"></a>shouldShowRequestPermissionRationale()</h3> 
<ol style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; font-size:16px; background-color:rgb(255,255,255)'><li>望文生义，是否应该显示请求权限的说明。</li><li>第一次请求权限时，用户拒绝了，调用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">shouldShowRequestPermissionRationale()</code>后返回true，应该显示一些为什么需要这个权限的说明。</li><li>用户在第一次拒绝某个权限后，下次再次申请时，授权的dialog中将会出现“不再提醒”选项，一旦选中勾选了，那么下次申请将不会提示用户。</li><li>第二次请求权限时，用户拒绝了，并选择了“不再提醒”的选项，调用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">shouldShowRequestPermissionRationale()</code>后返回false。</li><li>设备的策略禁止当前应用获取这个权限的授权：<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">shouldShowRequestPermissionRationale()</code>返回false 。</li><li>加这个提醒的好处在于，用户拒绝过一次权限后我们再次申请时可以提醒该权限的重要性，免得再次申请时用户勾选“不再提醒”并决绝，导致下次申请权限直接失败。</li></ol> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 综上所述，整合代码后：</p> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-keyword">if</span> (ContextCompat.checkSelfPermission(<span class="hljs-keyword">this</span>, Manifest.permission.READ_CONTACTS) != PackageManager.PERMISSION_GRANTED) {
    <span class="hljs-comment">// 没有权限。</span>
    <span class="hljs-keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(<span class="hljs-keyword">this</span>, Manifest.permission.READ_CONTACTS)) {
            <span class="hljs-comment">// 用户拒绝过这个权限了，应该提示用户，为什么需要这个权限。</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 申请授权。</span>
        ActivityCompat.requestPermissions(thisActivity, <span class="hljs-keyword">new</span> String[]{Manifest.permission.READ_CONTACTS}, MMM);
    }
}

...

<span class="hljs-annotation">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRequestPermissionsResult</span>(<span class="hljs-keyword">int</span> requestCode, String permissions[], <span class="hljs-keyword">int</span>[] grantResults) {
    <span class="hljs-keyword">switch</span> (requestCode) {
        <span class="hljs-keyword">case</span> MMM: {
            <span class="hljs-keyword">if</span> (grantResults.length &gt; <span class="hljs-number">0</span>
                &amp;&amp; grantResults[<span class="hljs-number">0</span>] == PackageManager.PERMISSION_GRANTED) {
                <span class="hljs-comment">// 权限被用户同意，可以去放肆了。</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 权限被用户拒绝了，洗洗睡吧。</span>
            }
            <span class="hljs-keyword">return</span>;
        }
    }
}</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li></ul> 
<h3 id="总结" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t11" style="color:rgb(12,137,207)"></a>总结</h3> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 从上面来看，判断很多，逻辑也很多，这样就加重了我们开发的负担，加上很多人反馈说国产手机有各种各样的bug，这样兼容起来就更加麻烦了，那么下面我就为大家介绍一个开源内裤来解决这一系列问题。</p> 
<h2 id="andpermission" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.6em; background-color:rgb(255,255,255)'> <a target="_blank" name="t12" style="color:rgb(12,137,207)"></a>AndPermission</h2> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 这个开源库名叫AndPermission：<a target="_blank" href="https://github.com/yanzhenjie/AndPermission" style="color:rgb(12,137,207)" rel="noopener noreferrer">https://github.com/yanzhenjie/AndPermission</a>，经过我的实践是完全解决了上述问题，推荐大家使用。</p> 
<ul style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'><li>Gradle</li></ul> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-groovy hljs bash has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">compile <span class="hljs-string" style="color: rgb(0, 136, 0);">'com.yanzhenjie:permission:1.0.6'</span></code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li></ul> 
<ul style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'><li>Maven</li></ul> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-xml hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-tag">&lt;<span class="hljs-title" style="color: rgb(0, 0, 136);">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title" style="color: rgb(0, 0, 136);">groupId</span>&gt;</span>com.yanzhenjie<span class="hljs-tag">&lt;/<span class="hljs-title" style="color: rgb(0, 0, 136);">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title" style="color: rgb(0, 0, 136);">artifactId</span>&gt;</span>permission<span class="hljs-tag">&lt;/<span class="hljs-title" style="color: rgb(0, 0, 136);">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title" style="color: rgb(0, 0, 136);">version</span>&gt;</span>1.0.5<span class="hljs-tag">&lt;/<span class="hljs-title" style="color: rgb(0, 0, 136);">version</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title" style="color: rgb(0, 0, 136);">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-title" style="color: rgb(0, 0, 136);">type</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title" style="color: rgb(0, 0, 136);">dependency</span>&gt;</span></code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li></ul> 
<ul style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'><li>Eclipse 请放弃治疗</li></ul> 
<h2 id="使用介绍" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.6em; background-color:rgb(255,255,255)'> <a target="_blank" name="t13" style="color:rgb(12,137,207)"></a>使用介绍</h2> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 我建议看官去Github下载<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Demo</code>并阅读本文会帮助你理解。</p> 
<h3 id="申请权限" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t14" style="color:rgb(12,137,207)"></a>申请权限</h3> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-comment">// 在Activity：</span>
AndPermission.with(activity)
    .requestCode(<span class="hljs-number">100</span>)
    .permission(Manifest.permission.WRITE_CONTACTS)
    .rationale(...)
    .callback(...)
    .start();

<span class="hljs-comment">// 在Fragment：</span>
AndPermission.with(fragment)
    .requestCode(<span class="hljs-number">100</span>)
    .permission(
        <span class="hljs-comment">// 多个权限，以数组的形式传入。</span>
        Manifest.permission.WRITE_CONTACTS,
        Manifest.permission.READ_SMS
    )
    .rationale(...)
    .callback(...)
    .start();

<span class="hljs-comment">// 在其它任何地方：</span>
AndPermission.with(context)
    .requestCode(<span class="hljs-number">100</span>)
    .permission(
        Manifest.permission.WRITE_CONTACTS,
        Manifest.permission.READ_SMS
    )
    .rationale(...)
    .callback(...)
    .start();</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li><li>27</li><li>28</li><li>29</li><li>30</li></ul> 
<h3 id="接受回调结果" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t15" style="color:rgb(12,137,207)"></a>接受回调结果</h3> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 接受回调结果目前有两种方式：一、<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Listener</code>方式，二、注解方式。</p> 
<h4 id="方式一listener方式回调" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:1.7em; background-color:rgb(255,255,255)'> <a target="_blank" name="t16" style="color:rgb(12,137,207)"></a>方式一：Listener方式回调</h4> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 在<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">callback()</code>方法传入<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">PermissionListener</code>即可，授权成功或者失败至少会回调其中一个方法。</p> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">AndPermission.with(context)
    ...
    .requestCode(<span class="hljs-number">200</span>)
    .callback(listener)
    .start();

<span class="hljs-keyword">private</span> PermissionListener listener = <span class="hljs-keyword">new</span> PermissionListener() {
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onSucceed</span>(<span class="hljs-keyword">int</span> requestCode, List&lt;String&gt; grantedPermissions) {
        <span class="hljs-comment">// 权限申请成功回调。</span>

        <span class="hljs-comment">// 这里的requestCode就是申请时设置的requestCode。</span>
        <span class="hljs-comment">// 和onActivityResult()的requestCode一样，用来区分多个不同的请求。</span>
        <span class="hljs-keyword">if</span>(requestCode == <span class="hljs-number">200</span>) {
            <span class="hljs-comment">// TODO ...</span>
        }
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailed</span>(<span class="hljs-keyword">int</span> requestCode, List&lt;String&gt; deniedPermissions) {
        <span class="hljs-comment">// 权限申请失败回调。</span>
        <span class="hljs-keyword">if</span>(requestCode == <span class="hljs-number">200</span>) {
            <span class="hljs-comment">// TODO ...</span>
        }
    }
};</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li><li>21</li><li>22</li><li>23</li><li>24</li><li>25</li><li>26</li></ul> 
<h4 id="方式二注解方式回调" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:1.7em; background-color:rgb(255,255,255)'> <a target="_blank" name="t17" style="color:rgb(12,137,207)"></a>方式二：注解方式回调</h4> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 在<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">callback()</code>方法传入你的回调方法所在实例的对象即可。</p> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">AndPermission.with(context)
    ...
    .requestCode(<span class="hljs-number">300</span>)
    .callback(<span class="hljs-keyword">this</span>)
    .start();

<span class="hljs-comment">// 成功回调的方法，用注解即可，这里的300就是请求时的requestCode。</span>
<span class="hljs-annotation">@PermissionYes</span>(<span class="hljs-number">300</span>)
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getPermissionYes</span>(List&lt;String&gt; grantedPermissions) {
    <span class="hljs-comment">// TODO 申请权限成功。</span>
}

<span class="hljs-annotation">@PermissionNo</span>(<span class="hljs-number">300</span>)
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getPermissionNo</span>(List&lt;String&gt; deniedPermissions) {
    <span class="hljs-comment">// TODO 申请权限失败。</span>
}</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li></ul> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 如果你会用了，你就可以大刀阔斧的干了，博客中讲到的各种复杂逻辑，<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">AndPermission</code>自动完成。</p> 
<h3 id="rationale能力" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t18" style="color:rgb(12,137,207)"></a>Rationale能力</h3> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> <code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Android</code>运行时权限有一个特点，在拒绝过一次权限后，再此申请该权限，在申请框会多一个<strong>[不再提示]</strong>的复选框，当用户勾选了<strong>[不再提示]</strong>并拒绝了权限后，下次再申请该权限将直接回调申请失败。 <br> 因此<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Rationale</code>功能是在用户拒绝一次权限后，再次申请时检测到已经申请过一次该权限了，允许开发者弹窗说明申请权限的目的，获取用户的同意后再申请权限，避免用户勾选不再提示，导致不能再次申请权限。</p> 
<h4 id="方式一使用andpermssion默认md风格对话框" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:1.7em; background-color:rgb(255,255,255)'> <a target="_blank" name="t19" style="color:rgb(12,137,207)"></a>方式一：使用AndPermssion默认MD风格对话框</h4> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">AndPermission.with(<span class="hljs-keyword">this</span>)
    ...
    .requestCode(...)
    .rationale((requestCode, rationale) -&gt;
        <span class="hljs-comment">// 此对话框可以自定义，调用rationale.resume()就可以继续申请。</span>
        AndPermission.rationaleDialog(context, rationale).show()
    )
    .start()</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li></ul> 
<h4 id="方式二自定义对话框" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:1.7em; background-color:rgb(255,255,255)'> <a target="_blank" name="t20" style="color:rgb(12,137,207)"></a>方式二：自定义对话框</h4> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">AndPermission.with(<span class="hljs-keyword">this</span>)
    ...
    .requestCode(...)
    .rationale(rationaleListener)
    .start()

<span class="hljs-javadoc">/**
 * Rationale支持，这里自定义对话框。
 */</span>
<span class="hljs-keyword">private</span> RationaleListener rationaleListener = (requestCode, rationale) -&gt; {
    AlertDialog.newBuilder(<span class="hljs-keyword">this</span>)
        .setTitle(<span class="hljs-string" style="color: rgb(0, 136, 0);">"友好提醒"</span>)
        .setMessage(<span class="hljs-string" style="color: rgb(0, 136, 0);">"你已拒绝过定位权限，沒有定位定位权限无法为你推荐附近的妹子，你看着办！"</span>)
        .setPositiveButton(<span class="hljs-string" style="color: rgb(0, 136, 0);">"好，给你"</span>, (dialog, which) -&gt; {
            rationale.resume();
        })
        .setNegativeButton(<span class="hljs-string" style="color: rgb(0, 136, 0);">"我拒绝"</span>, (dialog, which) -&gt; {
            rationale.cancel();
        }).show();
};</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li></ul> 
<h3 id="提示用户在系统设置中授权" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.15em; background-color:rgb(255,255,255)'> <a target="_blank" name="t21" style="color:rgb(12,137,207)"></a>提示用户在系统设置中授权</h3> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 当用户拒绝权限并勾选了不再提示时，此时再次申请权限时将会直接回调申请失败，因此<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">AndPermission</code>提供了一个供用户在系统<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Setting</code>中给我们授权的能力。</p> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 我们在授权失败的回调方法中添加如下代码，以下三种选择一种即可：</p> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-comment">// 是否有不再提示并拒绝的权限。</span>
<span class="hljs-keyword">if</span> (AndPermission.hasAlwaysDeniedPermission(activity, deniedPermissions)) {
    <span class="hljs-comment">// 第一种：用AndPermission默认的提示语。</span>
    AndPermission.defaultSettingDialog(activity, <span class="hljs-number">400</span>).show();

    <span class="hljs-comment">// 第二种：用自定义的提示语。</span>
    AndPermission.defaultSettingDialog(activity, <span class="hljs-number">400</span>)
    .setTitle(<span class="hljs-string" style="color: rgb(0, 136, 0);">"权限申请失败"</span>)
    .setMessage(<span class="hljs-string" style="color: rgb(0, 136, 0);">"您拒绝了我们必要的一些权限，已经没法愉快的玩耍了，请在设置中授权！"</span>)
    .setPositiveButton(<span class="hljs-string" style="color: rgb(0, 136, 0);">"好，去设置"</span>)
    .show();

    <span class="hljs-comment">// 第三种：自定义dialog样式。</span>
    SettingService settingService = AndPermission.defineSettingDialog(activity, <span class="hljs-number">400</span>);
    ...
    <span class="hljs-comment">// 你的dialog点击了确定调用：</span>
    settingService.execute();
    <span class="hljs-comment">// 你的dialog点击了取消调用：</span>
    settingService.cancel();
}</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>10</li><li>11</li><li>12</li><li>13</li><li>14</li><li>15</li><li>16</li><li>17</li><li>18</li><li>19</li><li>20</li></ul> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> 如果你是在<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Activity/Fragment</code>中调用的上述代码，那么当用户在系统<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Setting</code>中操作完成后，会回调<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Activity/Fragment</code>中的这个方法：</p> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="language-java hljs  has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-annotation">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityResult</span>(<span class="hljs-keyword">int</span> requestCode, <span class="hljs-keyword">int</span> resultCode, Intent data) {
    <span class="hljs-keyword">switch</span> (requestCode) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">400</span>: { <span class="hljs-comment">// 这个400就是你上面传入的数字。</span>
            <span class="hljs-comment">// 你可以在这里检查你需要的权限是否被允许，并做相应的操作。</span>
            <span class="hljs-keyword">break</span>;
        }
    }
}</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li></ul> 
<h2 id="混淆" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.6em; background-color:rgb(255,255,255)'> <a target="_blank" name="t22" style="color:rgb(12,137,207)"></a>混淆</h2> 
<ol style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; font-size:16px; background-color:rgb(255,255,255)'><li>如果使用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Listener</code>接受回调结果，不用任何配置。</li><li>使用注解的方式回调结果，在<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">proguard</code>中添加如下配置：</li></ol> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="hljs haml has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;">-<span class="ruby">keepclassmembers <span class="hljs-class"><span class="hljs-keyword">class</span> ** {<!-- --></span>
</span>    @com.yanzhenjie.permission.PermissionYes &lt;methods&gt;;
}
-<span class="ruby">keepclassmembers <span class="hljs-class"><span class="hljs-keyword">class</span> ** {<!-- --></span>
</span>    @com.yanzhenjie.permission.PermissionNo &lt;methods&gt;;
}</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li></ul> 
<h2 id="国产手机适配方案" style='margin-top:0.8em; margin-bottom:0.8em; padding:0px; font-family:"microsoft yahei"; font-weight:300; line-height:1.1; color:rgb(63,63,63); font-size:2.6em; background-color:rgb(255,255,255)'> <a target="_blank" name="t23" style="color:rgb(12,137,207)"></a>国产手机适配方案</h2> 
<p style='margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; word-break:normal; color:rgb(63,63,63); font-family:"microsoft yahei"; text-align:start; background-color:rgb(255,255,255)'> <strong>AndPermission</strong>是严格按照<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Android</code>系统的<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">运行时权限</code>设计的，并最大限度上兼容了国产手机，目前发现的国产手机bug及解决方案：</p> 
<ul style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'><li>部分中国厂商生产手机（例如小米某型号）的<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Rationale</code>功能，在第一次拒绝后，第二次申请时不会返回<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">true</code>，并且会回调申请失败，也就是说在第一次决绝后默认勾选了<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">不再提示</code>，所以建议一定使用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">SettingDialog</code>：<a target="_blank" href="http://blog.csdn.net/yanzhenjie1003/article/details/52503533#%E6%8F%90%E7%A4%BA%E7%94%A8%E6%88%B7%E5%9C%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE%E4%B8%AD%E6%8E%88%E6%9D%83" style="color:rgb(12,137,207)" rel="noopener noreferrer">提示用户在系统设置中授权</a>。</li><li>部分中国厂商生产手机（例如小米、华为某型号）在申请权限时，用户点击确定授权后，还是回调我们申请失败，这个时候其实我们是拥有权限的，所以我们可以在失败的方法中使用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">AppOpsManager</code>进行权限判断，<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">AndPermission</code>已经封装好了：</li></ul> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="hljs scss has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-function">if(<span class="hljs-function">DoubleChecker.hasPermissions(context, permission1, permission2)</span>)</span> {
    <span class="hljs-comment">// 执行操作。</span>
}</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li></ul> 
<ul style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'><li>部分中国厂商生产手机（例如vivo、pppo某型号）在用户允许权限，并且回调了权限授权陈功的方法，但是实际执行代码时并没有这个权限，建议开发者在回调成功的方法中也利用<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">AppOpsManager</code>判断下：</li></ul> 
<pre class="prettyprint" name="code" style="white-space: nowrap; position: relative; overflow-y: hidden; overflow-x: auto; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; line-height: 23.8px; padding: 5px 5px 5px 60px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border-style: solid; border-color: rgb(136, 136, 136); border-radius: 0px;"><code class="hljs cs has-numbering" style="padding: 0px; background-color: transparent; color: inherit; font-size: 12.6px; white-space: pre; overflow-x: auto; word-wrap: normal;"><span class="hljs-keyword">if</span>(<span style='color: rgb(51, 51, 51); font-family: "Source Code Pro", monospace; font-size: 12.6px; white-space: pre; background-color: rgba(128, 128, 128, 0.05);'>DoubleChecker<span style='color: rgb(51, 51, 51); font-family: "Source Code Pro", monospace; font-size: 12.6px; white-space: pre; background-color: rgba(128, 128, 128, 0.05);'>.hasPermissions</span></span>(context, permission1, permission2)) {
    <span class="hljs-comment">// 执行操作。</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 提醒用户手机问题，请用户去Setting中授权。这里可以使用AndPermission的SettingDialog。</span>
}</code>
 
 </pre><ul class="pre-numbering" style="line-height: 23.8px;"><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li></ul> 
<ul style='line-height:27.2px; margin-bottom:1.7em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'><li>部分开发者反馈，在某些手机的<code style="font-size:14.4px; color:rgb(63,63,63); white-space:nowrap">Setting</code>中授权后实际，检查时还是没有权限，部分执行代码也是没有权限，这种手机真的兼容不到了，我也觉得没必要兼容了，建议直接放弃这种平台。</li></ul> 
<blockquote style='margin-right:0px; margin-bottom:1.7em; margin-left:0px; line-height:27.2px; padding:15px 20px; font-family:"microsoft yahei"'> 
 <p style="padding-top:0px; padding-bottom:0px; line-height:1.5; font-size:1em; color:rgb(111,111,111); word-break:normal"> 最后希望咱中国Android手机厂商早日修复这些问题，祝你们事业越来越成功，产品越做越好。</p> 
</blockquote> 
<hr style='margin-top:2em; margin-bottom:2em; font-family:"microsoft yahei"; background-color:rgb(255,255,255)'> 
<blockquote style='margin-right:0px; margin-bottom:1.7em; margin-left:0px; line-height:27.2px; padding:15px 20px; font-family:"microsoft yahei"'> 
 <p style="padding-top:0px; padding-bottom:0px; line-height:1.5; font-size:1em; color:rgb(111,111,111); word-break:normal"> 版权声明：转载必须注明本文转自严振杰的博客: <a target="_blank" href="http://blog.yanzhenjie.com/" rel="nofollow noopener noreferrer" style="color:rgb(12,137,207)">http://blog.yanzhenjie.com</a></p> 
</blockquote> 
<br>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3b3cc28c0d25520b370143b0d85c021e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Keil的几个插件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/84da9598081abb2a98f4cd27e92a7e07/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">metabase二次开发需要修改的内容</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>