<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>有了它（powermock）再也不担心单元测试不达标了 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="有了它（powermock）再也不担心单元测试不达标了" />
<meta property="og:description" content="为什么要写单元测试 优点：单元测试可以减少bug率,提升代码的质量。还可以通过单元测试来熟悉业务。公司硬性要求：有些公司可能还会强制要求，每次新增代码、或者变更代码单测覆盖率要达到多少比例才能申请代码合并请求。 选择哪个单元测试框架 目前应用比较普遍的java单元测试工具 junit4&#43;Mock（Mockito、jmock、EasyMock、powermock）。为什么会选择powermock？
在做单元测试的时候，我们会发现我们要测试的方法会有很多外部依赖的对象或者一些其他服务的调用比如说（发送邮件，网络通讯，soa调用）。 而我们没法控制这些外部依赖的对象。 为了解决这个问题，我们需要用到Mock来模拟这些外部依赖的对象,从而控制它们。只关心我们自己的业务逻辑是否正确。而这时powermock就起作用了，它不仅可以mock外部的依赖，还可以mock私有方法、final方法，总之它的功能很强大。
什么是powerMocker PowerMock是一个框架，它以更强大的功能扩展了其他模拟库，例如EasyMock。 PowerMock使用自定义的类加载器和字节码操作来模拟静态方法，构造函数， 最终类和方法，私有方法，删除静态初始化程序等。通过使用自定义类加载器，无需对IDE或持续集成服务器进行任何更改，从而简化了采用过程。熟悉受支持的模拟框架的开发人员会发现PowerMock易于使用，因为整个期望API都是相同的，
无论是静态方法还是构造函数。PowerMock 旨在通过少量方法和注释扩展现有的API，以启用额外的功能。
常用注解 @RunWith(PowerMockRunner.class)
告诉JUnit使用PowerMockRunner进行测试@PrepareForTest({DemoDao.class})
所有需要测试的类列在此处，适用于模拟final类或有final, private, static, native方法的类@PowerMockIgnore({“javax.management.&#34;, &#34;javax.net.ssl.”})
为了解决使用powermock后，提示classloader错误@SuppressStaticInitializationFor
不让静态代码加载
其他更多注解可以参考：https://github.com/powermock/powermock/wiki/Suppress-Unwanted-Behavior 如何开始 JUnit 4.4及以上 &lt;properties&gt; &lt;powermock.version&gt;2.0.2&lt;/powermock.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.powermock&lt;/groupId&gt; &lt;artifactId&gt;powermock-module-junit4&lt;/artifactId&gt; &lt;version&gt;${powermock.version}&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.powermock&lt;/groupId&gt; &lt;artifactId&gt;powermock-api-mockito2&lt;/artifactId&gt; &lt;version&gt;${powermock.version}&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; powerMock样例 这是一个需要被mock的类里面有私有方法、静态方法、等等下面一一来演示各个方法的mock功能。
/** * * @Date: 2020/3/31 * @Description: */ @Repository public class DemoDao { public String mockPublicMethod(String type) throws Throwable { throw new Throwable(); } public final String mockFinalMethod(String type) throws Throwable { throw new Throwable(); } public static String mockStaticMethod(String type) throws Throwable { throw new Throwable(); } } /** * @Date: 2020/3/31 11:34 * @Description: */ @Component public class DemoService extends AbstractDemo{ @Autowired private DemoDao demoDao; public String mockPublicMethod() throws Throwable { return demoDao." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4ad0b0ed5d281c2aa96887252195396c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-01T22:49:29+08:00" />
<meta property="article:modified_time" content="2020-05-01T22:49:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">有了它（powermock）再也不担心单元测试不达标了</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_1"></a>为什么要写单元测试</h4> 
<ul><li>优点：单元测试可以减少bug率,提升代码的质量。还可以通过单元测试来熟悉业务。</li><li>公司硬性要求：有些公司可能还会强制要求，每次新增代码、或者变更代码单测覆盖率要达到多少比例才能申请代码合并请求。</li></ul> 
<h4><a id="_4"></a>选择哪个单元测试框架</h4> 
<p>目前应用比较普遍的java单元测试工具 junit4+Mock（Mockito、jmock、EasyMock、powermock）。为什么会选择powermock？<br> 在做单元测试的时候，我们会发现我们要测试的方法会有很多外部依赖的对象或者一些其他服务的调用比如说（发送邮件，网络通讯，soa调用）。 而我们没法控制这些外部依赖的对象。 为了解决这个问题，我们需要用到Mock来模拟这些外部依赖的对象,从而控制它们。只关心我们自己的业务逻辑是否正确。而这时powermock就起作用了，它不仅可以mock外部的依赖，还可以mock私有方法、final方法，总之它的功能很强大。</p> 
<h4><a id="powerMocker_7"></a>什么是powerMocker</h4> 
<blockquote> 
 <p>PowerMock是一个框架，它以更强大的功能扩展了其他模拟库，例如EasyMock。 PowerMock使用自定义的类加载器和字节码操作来模拟静态方法，构造函数， 最终类和方法，私有方法，删除静态初始化程序等。通过使用自定义类加载器，无需对IDE或持续集成服务器进行任何更改，从而简化了采用过程。熟悉受支持的模拟框架的开发人员会发现PowerMock易于使用，因为整个期望API都是相同的，<br> 无论是静态方法还是构造函数。PowerMock 旨在通过少量方法和注释扩展现有的API，以启用额外的功能。</p> 
</blockquote> 
<h4><a id="_11"></a>常用注解</h4> 
<ul><li>@RunWith(PowerMockRunner.class)<br> 告诉JUnit使用PowerMockRunner进行测试</li><li>@PrepareForTest({DemoDao.class})<br> 所有需要测试的类列在此处，适用于模拟final类或有final, private, static, native方法的类</li><li>@PowerMockIgnore({“javax.management.<em>", "javax.net.ssl.</em>”})<br> 为了解决使用powermock后，提示classloader错误</li><li>@SuppressStaticInitializationFor<br> 不让静态代码加载<br> 其他更多注解可以参考：https://github.com/powermock/powermock/wiki/Suppress-Unwanted-Behavior</li></ul> 
<h4><a id="_21"></a>如何开始</h4> 
<h6><a id="JUnit_44_22"></a>JUnit 4.4及以上</h6> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>powermock.version</span><span class="token punctuation">&gt;</span></span>2.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>powermock.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.powermock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>powermock-module-junit4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${powermock.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.powermock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>powermock-api-mockito2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${powermock.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="powerMock_42"></a>powerMock样例</h4> 
<p>这是一个需要被mock的类里面有私有方法、静态方法、等等下面一一来演示各个方法的mock功能。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 *
 * @Date: 2020/3/31
 * @Description:
 */</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoDao</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> String <span class="token function">mockPublicMethod</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">Throwable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">mockFinalMethod</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">Throwable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">mockStaticMethod</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">Throwable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * @Date: 2020/3/31 11:34
 * @Description:
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoService</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractDemo</span><span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DemoDao demoDao<span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">mockPublicMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> demoDao<span class="token punctuation">.</span><span class="token function">mockPublicMethod</span><span class="token punctuation">(</span><span class="token string">"demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">mockFinalMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> demoDao<span class="token punctuation">.</span><span class="token function">mockFinalMethod</span><span class="token punctuation">(</span><span class="token string">"demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">mockStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> DemoDao<span class="token punctuation">.</span><span class="token function">mockStaticMethod</span><span class="token punctuation">(</span><span class="token string">"demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> String <span class="token function">callPrivateMethod</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">mockPublicMethodCallPrivateMethod</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">callPrivateMethodThrowable</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> String <span class="token function">callPrivateMethodThrowable</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Throwable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">mockExtendMethod</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> <span class="token function">getExtendMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String UUID <span class="token operator">=</span> <span class="token string">"uuid"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h6><a id="mock_105"></a>mock普通公共方法</h6> 
<pre><code class="prism language-java">   <span class="token comment">/**
    * @Date: 2020/4/24 
    * @Description:
    */</span>
   <span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>PowerMockRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoServiceTest</span> <span class="token punctuation">{<!-- --></span>
   
       <span class="token annotation punctuation">@InjectMocks</span>
       <span class="token keyword">private</span> DemoService demoService<span class="token punctuation">;</span>
       <span class="token annotation punctuation">@Mock</span>
       <span class="token keyword">private</span> DemoDao demoDao<span class="token punctuation">;</span>
       
    <span class="token comment">/**
    * mock 普通方法
    * @throws Throwable
    */</span>
       <span class="token annotation punctuation">@Test</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mockPublicMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
           String type <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           PowerMockito<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>demoDao<span class="token punctuation">.</span><span class="token function">mockPublicMethod</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
           String result <span class="token operator">=</span> demoService<span class="token punctuation">.</span><span class="token function">mockPublicMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="mock_Final_132"></a>mock Final方法</h6> 
<p>跟普通方法是一样的，唯一的区别是需要在类上加入PrepareForTest注解</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>PowerMockRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PrepareForTest</span><span class="token punctuation">(</span>DemoDao<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoServiceTest</span> <span class="token punctuation">{<!-- --></span>
    
        <span class="token annotation punctuation">@InjectMocks</span>
        <span class="token keyword">private</span> DemoService demoService<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Mock</span>
        <span class="token keyword">private</span> DemoDao demoDao<span class="token punctuation">;</span>
    
       
      <span class="token comment">/**
          * mock final方法
          * @throws Throwable
          */</span>
         <span class="token annotation punctuation">@Test</span>
         <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mockFinalMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
             String type <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             PowerMockito<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>demoDao<span class="token punctuation">.</span><span class="token function">mockFinalMethod</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
             String result <span class="token operator">=</span> demoService<span class="token punctuation">.</span><span class="token function">mockFinalMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
  
</code></pre> 
<h6><a id="mock_PowerMockitomockStaticmockPrepareForTest_159"></a>mock静态方法(使用 PowerMockito.mockStatic)被mock的类也要用PrepareForTest注解修饰。</h6> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>PowerMockRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@PrepareForTest</span><span class="token punctuation">(</span>DemoDao<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoServiceTest</span> <span class="token punctuation">{<!-- --></span>
  
      <span class="token annotation punctuation">@InjectMocks</span>
      <span class="token keyword">private</span> DemoService demoService<span class="token punctuation">;</span>
      <span class="token annotation punctuation">@Mock</span>
      <span class="token keyword">private</span> DemoDao demoDao<span class="token punctuation">;</span>
      <span class="token comment">/**
       * mock 静态方法
       * @throws Throwable
       */</span>
      <span class="token annotation punctuation">@Test</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mockStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
          String type <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          PowerMockito<span class="token punctuation">.</span><span class="token function">mockStatic</span><span class="token punctuation">(</span>DemoDao<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          PowerMockito<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>DemoDao<span class="token punctuation">.</span><span class="token function">mockStaticMethod</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          String result <span class="token operator">=</span> demoService<span class="token punctuation">.</span><span class="token function">mockStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_private_183"></a>调用 private方法</h6> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * 调用私有方法
     * 
     * @throws Throwable
     */</span>
     <span class="token comment">/**
        * 调用私有方法
        * 
        * @throws Throwable
        */</span>
       <span class="token annotation punctuation">@Test</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callPrivateMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 第一种方式</span>
           String type <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           Method method <span class="token operator">=</span> PowerMockito<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span>DemoService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"callPrivateMethod"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           String result <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>demoService<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
           Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
           <span class="token comment">//第二种方式</span>
           String result1 <span class="token operator">=</span> Whitebox<span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>demoService<span class="token punctuation">,</span> <span class="token string">"callPrivateMethod"</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
           Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> result1<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="mock_mockPrepareForTest_209"></a>mock 私有方法(被mock的类也要用PrepareForTest注解修饰。)</h6> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * mock私有方法
     *
     * @throws Throwable
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mockPrivateMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        String type <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重点这一句</span>
        demoService <span class="token operator">=</span> PowerMockito<span class="token punctuation">.</span><span class="token function">spy</span><span class="token punctuation">(</span>demoService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        PowerMockito<span class="token punctuation">.</span><span class="token function">doReturn</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>demoService<span class="token punctuation">,</span><span class="token string">"callPrivateMethodThrowable"</span><span class="token punctuation">,</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String result <span class="token operator">=</span> demoService<span class="token punctuation">.</span><span class="token function">mockPublicMethodCallPrivateMethod</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="mock_226"></a>mock父类方法</h6> 
<pre><code class="prism language-java">     <span class="token comment">/**
       * mock父类方法
       *
       * @throws Throwable
       */</span>
      <span class="token annotation punctuation">@Test</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mockExtendMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
          String type <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 需要mock的父类的方法</span>
          Method method <span class="token operator">=</span> PowerMockito<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span>AbstractDemo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"getExtendMethod"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// InvocationHandler</span>
          PowerMockito<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method1<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          String result <span class="token operator">=</span> demoService<span class="token punctuation">.</span><span class="token function">mockExtendMethod</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="mock_244"></a>mock构造方法</h6> 
<pre><code class="prism language-java">     <span class="token keyword">public</span> <span class="token function">DemoService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mockConstructorMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        PowerMockito<span class="token punctuation">.</span><span class="token function">whenNew</span><span class="token punctuation">(</span>DemoService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withNoArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>demoService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="mock_254"></a>mock字段</h6> 
<pre><code class="prism language-java">        <span class="token comment">/**
         * mock 字段
         */</span>
        <span class="token annotation punctuation">@Test</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mockFiled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            String uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Whitebox<span class="token punctuation">.</span><span class="token function">setInternalState</span><span class="token punctuation">(</span>DemoService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"UUID"</span><span class="token punctuation">,</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>DemoService<span class="token punctuation">.</span>UUID<span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="mock_new_266"></a>mock new对象调用的方法</h6> 
<pre><code class="prism language-java">		<span class="token keyword">class</span> <span class="token class-name">DemoDao</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">newMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				DemoDao demoDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DemoDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				demodao<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
        DemoDao demoDao<span class="token operator">=</span> PowerMockito<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span>DemoDao <span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PowerMockito<span class="token punctuation">.</span><span class="token function">whenNew</span><span class="token punctuation">(</span>DemoDao <span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withNoArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>demoDao<span class="token punctuation">)</span><span class="token punctuation">;</span>
        PowerMockito<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>demoDao<span class="token punctuation">.</span><span class="token function">newMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h6><a id="mock_283"></a>mock当前类的其他方法</h6> 
<pre><code>@RunWith(PowerMockRunner.class)
@PrepareForTest(DemoDao.class)
class DemoServiceTest {

     @Before
     public void init(){
          MockitoAnnotations.initMocks(this);
     }
     @InjectMocks
     private DemoService demoService = PowerMockito.spy(new DemoService());

     @Test
     public void mockCurrentClassOtherMethod() throws Throwable {
          PowerMockito.doReturn(null).when(demoService).otherThrowableMethod();
          demoService.mockCurrentClassOtherMethod();
     }

}
</code></pre> 
<h4><a id="_306"></a>结束</h4> 
<ul><li>由于自己才疏学浅，难免会有纰漏，假如你发现了错误的地方，还望留言给我指出来,我会对其加以修正。</li><li>如果你觉得文章还不错，你的转发、分享、赞赏、点赞、留言就是对我最大的鼓励。</li><li>感谢您的阅读,十分欢迎并感谢您的关注。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/465687eb668de872b3fab0764fd3ea54/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LeetCode 787 - K 站中转内最便宜的航班</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fee63cb7f14ba2a9a3102e707f619af8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">阿里云实习生部门笔试2020.04</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>