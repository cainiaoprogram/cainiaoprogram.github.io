<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32——电容触摸按键充电时间测量实验 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32——电容触摸按键充电时间测量实验" />
<meta property="og:description" content="1电容触摸按键 无手指触摸：上电时，电阻作用下，电容Cs进行充电，直到电容充满，这时候会有一个充电时间Tcs。
有手指触摸：上电时，电阻作用下，电容Cs和Cx进行充电，电容充满时间会变长，得到充电时间Tcx。
注意：充电过程可以看成是一个信号从低电平变为高电平的过程。STM32认为高电平的最低电压值(1.8V)、
2检测电容触摸按键实验过程 没有按下的时候，充电时间为T1(default)。按下TPAD，电容变大，所以充电时间为T2。
我们可以通过检测充电时间来判断是否按下。如果T2-T1大于某个值，就可以判断触摸按键按下。
3.重点函数及调用过程 tpad_reset函数：复位TPAD（放电且开始充电，并清空定时器计数器CNT值）
tpad_get_val函数：获取一次捕获值（复位TPAD，等待捕获上升沿得到充电时间）
tpad_get_maxval函数：多次调用tpad_get_val函数获取充电时间，获取最大的值
tpad_init函数：初始化TPAD，调用tpad_get_val获取电容触摸按键没有按下的默认充电时间值
tpad_scan函数：扫描TPAD，调用tpad_get_maxval获取多次充电中最大充电时间进行判断
tpad_timx_cap_init函数：输入捕获通道初始化
4.电容触摸按键充电时间测量实验实战 4.1 tpad.c #include &#34;./BSP/TPAD/tpad.h&#34; #include &#34;./SYSTEM/delay/delay.h&#34; #include &#34;./SYSTEM/usart/usart.h&#34; /* 空载的时候(没有手按下),计数器需要的时间 * 这个值应该在每次开机的时候被初始化一次 */ //1.空载时计数器时间 volatile uint16_t g_tpad_default_val = 0; /* 空载的时候(没有手按下),计数器需要的时间 */ /*定时器输入边沿捕获*/ static TIM_HandleTypeDef g_timx_cap_chy_handler; /* 定时器x句柄 */ static TIM_IC_InitTypeDef g_timx_ic_cap_chy_handler; /** * @brief 初始化触摸按键 * @param psc : 分频系数(值越小, 越灵敏, 最小值为: 1) * @retval 0, 初始化成功; 1, 初始化失败; */ uint8_t tpad_init(uint16_t psc) { //1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f487e6c7a22b157f7cad05f3668f062f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-11T21:13:43+08:00" />
<meta property="article:modified_time" content="2024-01-11T21:13:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32——电容触摸按键充电时间测量实验</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_0"></a>1电容触摸按键</h2> 
<p><img src="https://images2.imgbox.com/b5/5d/yHHw7ps7_o.png" alt="在这里插入图片描述"><br> 无手指触摸：上电时，电阻作用下，电容Cs进行充电，直到电容充满，这时候会有一个充电时间Tcs。<br> 有手指触摸：上电时，电阻作用下，电容Cs和Cx进行充电，电容充满时间会变长，得到充电时间Tcx。<br> 注意：充电过程可以看成是一个信号从低电平变为高电平的过程。STM32认为高电平的最低电压值(1.8V)、</p> 
<h2><a id="2_5"></a>2检测电容触摸按键实验过程</h2> 
<p><img src="https://images2.imgbox.com/69/c9/X8TKVVnF_o.png" alt="在这里插入图片描述"><br> 没有按下的时候，充电时间为T1(default)。按下TPAD，电容变大，所以充电时间为T2。<br> 我们可以通过检测充电时间来判断是否按下。如果T2-T1大于某个值，就可以判断触摸按键按下。</p> 
<h2><a id="3_10"></a>3.重点函数及调用过程</h2> 
<p>tpad_reset函数：复位TPAD（放电且开始充电，并清空定时器计数器CNT值）<br> tpad_get_val函数：获取一次捕获值（复位TPAD，等待捕获上升沿得到充电时间）<br> tpad_get_maxval函数：多次调用tpad_get_val函数获取充电时间，获取最大的值<br> tpad_init函数：初始化TPAD，调用tpad_get_val获取电容触摸按键没有按下的默认充电时间值<br> tpad_scan函数：扫描TPAD，调用tpad_get_maxval获取多次充电中最大充电时间进行判断<br> tpad_timx_cap_init函数：输入捕获通道初始化<br> <img src="https://images2.imgbox.com/ca/43/WipJsaDe_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4_18"></a>4.电容触摸按键充电时间测量实验实战</h2> 
<h3><a id="41_tpadc_19"></a>4.1 tpad.c</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./BSP/TPAD/tpad.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./SYSTEM/delay/delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./SYSTEM/usart/usart.h"</span></span>

<span class="token comment">/* 空载的时候(没有手按下),计数器需要的时间
 * 这个值应该在每次开机的时候被初始化一次
 */</span>
<span class="token comment">//1.空载时计数器时间</span>
<span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> g_tpad_default_val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token comment">/* 空载的时候(没有手按下),计数器需要的时间 */</span>

<span class="token comment">/*定时器输入边沿捕获*/</span>
<span class="token keyword">static</span> TIM_HandleTypeDef g_timx_cap_chy_handler<span class="token punctuation">;</span>    <span class="token comment">/* 定时器x句柄 */</span>
<span class="token keyword">static</span> TIM_IC_InitTypeDef g_timx_ic_cap_chy_handler<span class="token punctuation">;</span>

<span class="token comment">/**
 * @brief       初始化触摸按键
 * @param       psc     : 分频系数(值越小, 越灵敏, 最小值为: 1)
 * @retval      0, 初始化成功; 1, 初始化失败;
 */</span>
 <span class="token class-name">uint8_t</span> <span class="token function">tpad_init</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> psc<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token comment">//1.定义变量，包括存放10个空载充电时间值数值、6个值累加和，以及i,j</span>
     <span class="token class-name">uint16_t</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token class-name">uint16_t</span> temp<span class="token punctuation">;</span>
     <span class="token class-name">uint8_t</span> i<span class="token punctuation">,</span>j<span class="token punctuation">;</span>
     <span class="token comment">//2.调用定时器输入捕获初始化函数</span>
     <span class="token function">tpad_timx_cap_init</span><span class="token punctuation">(</span>TPAD_ARR_MAX_VAL<span class="token punctuation">,</span> psc<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 以Ft / (psc - 1) Mhz的频率计数 @Ft = 定时器工作频率 */</span>
     <span class="token comment">//3.连续获取十次值</span>
     <span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
       buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token function">tpad_get_val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token comment">//4.10个值冒泡排序</span>
     <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">9</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
         <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span>buf<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
             <span class="token punctuation">{<!-- --></span>
                 temp <span class="token operator">=</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                 buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                 buf<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     
     <span class="token punctuation">}</span>
     <span class="token comment">//5.去中间六个值的平均值</span>
     temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">+=</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
    g_tpad_default_val <span class="token operator">=</span> temp <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"g_tpad_default_val:%d\r\n"</span><span class="token punctuation">,</span> g_tpad_default_val<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>g_tpad_default_val <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span>TPAD_ARR_MAX_VAL <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                                   <span class="token comment">/* 初始化遇到超过TPAD_ARR_MAX_VAL/2的数值,不正常! */</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
     

 <span class="token punctuation">}</span>
 <span class="token comment">/**
 * @brief       得到定时器捕获值
 *   @note      如果超时, 则直接返回定时器的计数值
 *              我们定义超时时间为: TPAD_ARR_MAX_VAL - 500
 * @param       无
 * @retval      捕获值/计数值（超时的情况下返回）
 */</span>
 <span class="token keyword">static</span> <span class="token class-name">uint16_t</span> <span class="token function">tpad_get_val</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>              <span class="token comment">//得到定时器捕获值</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token comment">//1.判断为哪个通道</span>
     <span class="token class-name">uint32_t</span> flag <span class="token operator">=</span><span class="token punctuation">(</span>TPAD_TIMX_CAP_CHY <span class="token operator">==</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token operator">?</span> TIM_FLAG_CC1<span class="token operator">:</span>\
                    <span class="token punctuation">(</span>TPAD_TIMX_CAP_CHY <span class="token operator">==</span> TIM_CHANNEL_2<span class="token punctuation">)</span><span class="token operator">?</span> TIM_FLAG_CC2<span class="token operator">:</span>\
                    <span class="token punctuation">(</span>TPAD_TIMX_CAP_CHY <span class="token operator">==</span> TIM_CHANNEL_3<span class="token punctuation">)</span><span class="token operator">?</span> TIM_FLAG_CC3<span class="token operator">:</span>TIM_FLAG_CC4<span class="token punctuation">;</span>
                    
     
     <span class="token comment">//2.调用复位函数，初始化</span>
     <span class="token function">tpad_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token comment">//3.通道CHY捕获上升沿</span>
     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">__HAL_TIM_GET_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_timx_cap_chy_handler<span class="token punctuation">,</span>flag<span class="token punctuation">)</span><span class="token operator">==</span> RESET<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>g_timx_cap_chy_handler<span class="token punctuation">.</span>Instance<span class="token operator">-&gt;</span>CNT <span class="token operator">&gt;</span> TPAD_ARR_MAX_VAL <span class="token operator">-</span> <span class="token number">500</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> g_timx_cap_chy_handler<span class="token punctuation">.</span>Instance<span class="token operator">-&gt;</span>CNT<span class="token punctuation">;</span>                <span class="token comment">/* 超时了,直接返回CNT的值 */</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token comment">//4.返回捕获比较值寄存器值</span>
     <span class="token keyword">return</span> TPAD_TIMX_CAP_CHY_CCRX<span class="token punctuation">;</span>
 
 <span class="token punctuation">}</span>
 
 <span class="token comment">/**
 * @brief       复位TPAD
 *   @note      我们将TPAD按键看做是一个电容, 当手指按下/不按下时容值有变化
 *              该函数将GPIO设置成推挽输出, 然后输出0, 进行放电, 然后再设置
 *              GPIO为浮空输入, 等待外部大电阻慢慢充电
 * @param       无
 * @retval      无
 */</span>
 <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tpad_reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>                     <span class="token comment">//复位</span>
 <span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef gpio_init_struct<span class="token punctuation">;</span>
    
    gpio_init_struct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> TPAD_GPIO_PIN<span class="token punctuation">;</span>                               <span class="token comment">/* 输入捕获的GPIO口 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_OUTPUT_PP<span class="token punctuation">;</span>                        <span class="token comment">/* 复用推挽输出 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLDOWN<span class="token punctuation">;</span>                              <span class="token comment">/* 下拉 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>                      <span class="token comment">/* 高速 */</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>TPAD_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpio_init_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>TPAD_GPIO_PORT<span class="token punctuation">,</span> TPAD_GPIO_PIN<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* TPAD引脚输出0, 放电 */</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    g_timx_cap_chy_handler<span class="token punctuation">.</span>Instance<span class="token operator">-&gt;</span>SR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                            <span class="token comment">/* 清除标记 */</span>
    g_timx_cap_chy_handler<span class="token punctuation">.</span>Instance<span class="token operator">-&gt;</span>CNT <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                           <span class="token comment">/* 归零 */</span>

    gpio_init_struct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> TPAD_GPIO_PIN<span class="token punctuation">;</span>                               <span class="token comment">/* 输入捕获的GPIO口 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>                            <span class="token comment">/* 复用推挽输出 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_NOPULL<span class="token punctuation">;</span>                                <span class="token comment">/* 不带上下拉 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>                      <span class="token comment">/* 高速 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Alternate <span class="token operator">=</span> TPAD_GPIO_AF<span class="token punctuation">;</span>                          <span class="token comment">/* PA5复用为TIM2通道1 */</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>TPAD_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpio_init_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">/* TPAD引脚浮空输入 */</span>
 <span class="token punctuation">}</span>


<span class="token comment">//定时器输入捕获初始化设置</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tpad_timx_cap_init</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> arr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> psc<span class="token punctuation">)</span> <span class="token comment">//定时器输入捕获初始化</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef gpio_init_struct<span class="token punctuation">;</span>
    <span class="token function">TPAD_GPIO_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// TPAD引脚 时钟使能 </span>
    <span class="token function">TPAD_TIMX_CAP_CHY_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 定时器 时钟使能 </span>
    
    gpio_init_struct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> TPAD_GPIO_PIN<span class="token punctuation">;</span>                               <span class="token comment">/* 输入捕获的GPIO口 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_INPUT<span class="token punctuation">;</span>                            <span class="token comment">/* 输入 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLDOWN<span class="token punctuation">;</span>                                <span class="token comment">/* 不带上下拉 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_MEDIUM<span class="token punctuation">;</span>                      <span class="token comment">/* 下拉 */</span>
    gpio_init_struct<span class="token punctuation">.</span>Alternate <span class="token operator">=</span> TPAD_GPIO_AF<span class="token punctuation">;</span>                           <span class="token comment">/* PA5复用为TIM2_CH1 */</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>TPAD_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpio_init_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">/* TPAD引脚复用 */</span>
    
    g_timx_cap_chy_handler<span class="token punctuation">.</span>Instance <span class="token operator">=</span> TPAD_TIMX_CAP<span class="token punctuation">;</span>                    <span class="token comment">/* 定时器2 */</span>
    g_timx_cap_chy_handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Prescaler <span class="token operator">=</span> psc<span class="token punctuation">;</span>                        <span class="token comment">/* 定时器分频 */</span>
    g_timx_cap_chy_handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>CounterMode <span class="token operator">=</span> TIM_COUNTERMODE_UP<span class="token punctuation">;</span>       <span class="token comment">/* 向上计数模式 */</span>
    g_timx_cap_chy_handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Period <span class="token operator">=</span> arr<span class="token punctuation">;</span>                           <span class="token comment">/* 自动重装载值 */</span>
    g_timx_cap_chy_handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ClockDivision <span class="token operator">=</span> TIM_CLOCKDIVISION_DIV1<span class="token punctuation">;</span> <span class="token comment">/* 时钟分频因子 */</span>
    <span class="token function">HAL_TIM_IC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_timx_cap_chy_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    g_timx_ic_cap_chy_handler<span class="token punctuation">.</span>ICPolarity <span class="token operator">=</span> TIM_ICPOLARITY_RISING<span class="token punctuation">;</span>                                       <span class="token comment">/* 上升沿捕获 */</span>
    g_timx_ic_cap_chy_handler<span class="token punctuation">.</span>ICSelection <span class="token operator">=</span> TIM_ICSELECTION_DIRECTTI<span class="token punctuation">;</span>                                   <span class="token comment">/* 映射到TI1上 */</span>
    g_timx_ic_cap_chy_handler<span class="token punctuation">.</span>ICPrescaler <span class="token operator">=</span> TIM_ICPSC_DIV1<span class="token punctuation">;</span>                                             <span class="token comment">/* 配置输入分频，不分频 */</span>
    g_timx_ic_cap_chy_handler<span class="token punctuation">.</span>ICFilter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                                             <span class="token comment">/* 配置输入滤波器，不滤波 */</span>
    <span class="token function">HAL_TIM_IC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_timx_cap_chy_handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_timx_ic_cap_chy_handler<span class="token punctuation">,</span> TPAD_TIMX_CAP_CHY<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* 配置TIM2通道1 */</span>
    <span class="token function">HAL_TIM_IC_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_timx_cap_chy_handler<span class="token punctuation">,</span>TPAD_TIMX_CAP_CHY<span class="token punctuation">)</span><span class="token punctuation">;</span>                                        <span class="token comment">/* 使能输入捕获和定时器 */</span>

<span class="token punctuation">}</span>   
<span class="token comment">/**
 * @brief       扫描触摸按键
 * @param       mode ：扫描模式
 *   @arg       0, 不支持连续触发(按下一次必须松开才能按下一次);
 *   @arg       1, 支持连续触发(可以一直按下)
 * @retval      0, 没有按下; 1, 有按下;
 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">tpad_scan</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> mode<span class="token punctuation">)</span>                 <span class="token comment">//TPAD 扫描 函数 </span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> keyen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">/* 0, 可以开始检测;  &gt; 0, 还不能开始检测; */</span>
    <span class="token class-name">uint8_t</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> sample <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>             <span class="token comment">/* 默认采样次数为3次 */</span>
    <span class="token class-name">uint16_t</span> rval<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        sample <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>                 <span class="token comment">/* 支持连按的时候，设置采样次数为6次 */</span>
        keyen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                  <span class="token comment">/* 支持连按, 每次调用该函数都可以检测 */</span>
    <span class="token punctuation">}</span>

    rval <span class="token operator">=</span> <span class="token function">tpad_get_maxval</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rval <span class="token operator">&gt;</span> <span class="token punctuation">(</span>g_tpad_default_val <span class="token operator">+</span> TPAD_GATE_VAL<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">/* 大于tpad_default_val + TPAD_GATE_VAL,有效 */</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            res <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token comment">/* keyen==0, 有效 */</span>
        <span class="token punctuation">}</span>

<span class="token comment">//      printf("r:%d\r\n", rval);   /* 输出计数值, 调试的时候才用到 */</span>
        keyen <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                  <span class="token comment">/* 至少要再过3次之后才能按键有效 */</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyen<span class="token punctuation">)</span>keyen<span class="token operator">--</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @brief       读取n次, 取最大值
 * @param       n       ：连续获取的次数
 * @retval      n次读数里面读到的最大读数值
 */</span>
<span class="token keyword">static</span> <span class="token class-name">uint16_t</span> <span class="token function">tpad_get_maxval</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint16_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> maxval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">=</span> <span class="token function">tpad_get_val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 得到一次值 */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">&gt;</span> maxval<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            maxval <span class="token operator">=</span> temp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> maxval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="42_tpadh_241"></a>4.2 tpad.h</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TPAD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TPAD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./SYSTEM/sys/sys.h"</span></span>
<span class="token comment">/******************************************************************************************/</span>
<span class="token comment">//TPAD引脚 TIM定时器定义</span>
<span class="token comment">/* 我们使用定时器的输入捕获功能, 对TPAD进行检测
 * 这里的输入捕获使用定时器TIM2_CH1, 捕获TPAD按键的输入
 */</span>
 <span class="token comment">//TPAD引脚</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TPAD_GPIO_PORT</span>                          <span class="token expression">GPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">TPAD_GPIO_PIN</span>                           <span class="token expression">GPIO_PIN_5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name function">TPAD_GPIO_CLK_ENABLE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token keyword">do</span><span class="token punctuation">{<!-- --></span> <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>     </span><span class="token comment">/* PA口时钟使能 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">TPAD_GPIO_AF</span>                            <span class="token expression">GPIO_AF1_TIM2                                   </span><span class="token comment">/*端口复用为TIM2通道1*/</span></span>

<span class="token comment">//TIM2_CH1定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TPAD_TIMX_CAP</span>                           <span class="token expression">TIM2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TPAD_TIMX_CAP_CHY</span>                       <span class="token expression">TIM_CHANNEL_1                                   </span><span class="token comment">/* 通道Y,  1&lt;= Y &lt;=4 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TPAD_TIMX_CAP_CHY_CCRX</span>                  <span class="token expression">TIM2<span class="token operator">-&gt;</span>CCR1                                      </span><span class="token comment">/* 通道Y的捕获/比较寄存器 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TPAD_TIMX_CAP_CHY_CLK_ENABLE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token keyword">do</span><span class="token punctuation">{<!-- --></span> <span class="token function">__HAL_RCC_TIM2_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>      </span><span class="token comment">/* TIM5 时钟使能 */</span></span>

<span class="token comment">/* 触摸的门限值, 也就是必须大于 g_tpad_default_val + TPAD_GATE_VAL
 * 才认为是有效触摸, 改大 TPAD_GATE_VAL, 可以降低灵敏度, 反之, 则可以提高灵敏度
 * 根据实际需求, 选择合适的 TPAD_GATE_VAL 即可
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TPAD_GATE_VAL</span>     <span class="token expression"><span class="token number">100</span>                     </span><span class="token comment">//触摸的门限值, 也就是必须大于 g_tpad_default_val + TPAD_GATE_VAL, 才认为是有效触摸 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TPAD_ARR_MAX_VAL</span>  <span class="token expression"><span class="token number">0xFFFF</span>              </span><span class="token comment">/* 最大的ARR值, 一般设置为定时器的ARR最大值 */</span></span>

<span class="token keyword">extern</span> <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> g_tpad_default_val<span class="token punctuation">;</span>      <span class="token comment">//空载时需要的时间，即手指没按下时</span>

<span class="token comment">//接口函数，可在其他.c中调用</span>
<span class="token class-name">uint8_t</span> <span class="token function">tpad_init</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> psc<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//TPAD 初始化 函数</span>
<span class="token class-name">uint8_t</span> <span class="token function">tpad_scan</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//TPAD 扫描 函数 </span>

<span class="token comment">//静态函数，只在tpad.c中调用</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tpad_reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//复位</span>
<span class="token keyword">static</span> <span class="token class-name">uint16_t</span> <span class="token function">tpad_get_val</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//得到定时器捕获值</span>
<span class="token keyword">static</span> <span class="token class-name">uint16_t</span> <span class="token function">tpad_get_maxval</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//读取n次 获取最大值</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tpad_timx_cap_init</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> arr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> psc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//定时器输入捕获初始化 </span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="43_mainc_285"></a>4.3 main.c</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./SYSTEM/sys/sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./SYSTEM/usart/usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./SYSTEM/delay/delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./BSP/LED/led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./BSP/TPAD/tpad.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> t <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">/* 初始化HAL库 */</span>
    <span class="token function">sys_stm32_clock_init</span><span class="token punctuation">(</span><span class="token number">336</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 设置时钟,168Mhz */</span>
    <span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token number">168</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">/* 延时初始化 */</span>
    <span class="token function">usart_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">/* 串口初始化为115200 */</span>
    <span class="token function">led_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">/* 初始化LED */</span>
    <span class="token function">tpad_init</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">/* 初始化触摸按键 */</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tpad_scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                   <span class="token comment">/* 成功捕获到了一次上升沿(此函数执行时间至少15ms) */</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LED1_TOGGLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">/* LED1翻转 */</span>
        <span class="token punctuation">}</span>

        t<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">LED0_TOGGLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">/* LED0翻转 */</span>
        <span class="token punctuation">}</span>

        <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d1dc6aef509cfeccfefc99dad27682d5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">力扣_数组28—子集</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7feeda5341e824f9ac9e354223eafdf9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">32_Win32 共享内存</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>