<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>janus流媒体服务器搭建 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="janus流媒体服务器搭建" />
<meta property="og:description" content="准备ubuntu20 虚拟机
注意：切换root用户 sudo su，否则以下很多命令要加sudo；
linux新版本推荐apt（低版本apt-get还能用）
一 安装工具
apt install git
apt install make
apt install nginx
apt install python
apt install net-tools
二 安装janus依赖库
apt install libmicrohttpd-dev
apt install libjansson-dev
apt install libssl-dev
apt install libsofia-sip-ua-dev
apt install libglib2.0-dev
apt install libopus-dev
apt install libogg-dev
apt install libcurl4-openssl-dev
apt install liblua5.3-dev
apt install libconfig-dev
apt install pkg-config
apt install gengetopt
apt install libtool
apt install automake
apt install libwebsockets-dev" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4e2667151f25ed9bec1076d91a5dd7c1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-08T09:25:53+08:00" />
<meta property="article:modified_time" content="2021-12-08T09:25:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">janus流媒体服务器搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>准备ubuntu20 虚拟机</p> 
<p><span style="color:#fe2c24;"><strong>注意：</strong></span>切换root用户 sudo su，否则以下很多命令要加sudo；</p> 
<p>           linux新版本推荐<strong>apt</strong>（低版本apt-get还能用）</p> 
<p></p> 
<p></p> 
<p><strong>一  安装工具</strong></p> 
<p> apt install git</p> 
<p>apt install make</p> 
<p>apt install nginx</p> 
<p>apt install python</p> 
<p>apt install net-tools</p> 
<p></p> 
<p><strong>二  安装janus依赖库</strong></p> 
<p>apt install libmicrohttpd-dev<br> apt install libjansson-dev<br> apt install libssl-dev<br> apt install libsofia-sip-ua-dev<br> apt install libglib2.0-dev<br> apt install libopus-dev<br> apt install libogg-dev<br> apt install libcurl4-openssl-dev<br> apt install liblua5.3-dev<br> apt install libconfig-dev<br> apt install pkg-config<br> apt install gengetopt<br> apt install libtool<br> apt install automake<br> apt install libwebsockets-dev<br> apt install librabbitmq-dev<br> apt install libnanomsg-dev<br> apt install libnice-dev<br> apt install gtk-doc-tools<br> apt install doxygen</p> 
<p>apt install graphviz</p> 
<p></p> 
<p><span style="color:#fe2c24;"><strong>注意：</strong></span>apt源上的libsrtp（数据加密）没有将ssl编译进去，所以需要源码编辑，将ssl功能编译进去。下载，解压，生成makefile，编译，安装步骤如下。</p> 
<p>wget https://github.com/cisco/libsrtp/archive/v2.2.0.tar.gz</p> 
<p></p> 
<p>tar xfv v2.2.0.tar.gz</p> 
<p>cd libsrtp-2.2.0</p> 
<p>./configure --prefix=/usr --enable-openssl</p> 
<p>make shared_library &amp;&amp; sudo make install</p> 
<p></p> 
<p><strong>三 安装janus-gateway</strong></p> 
<p>git clone https://github.com/meetecho/janus-gateway.git</p> 
<p>cd janus-gateway</p> 
<p>sh autogen.sh</p> 
<p>./configure --prefix=/usr/local/janus</p> 
<p>ll Makefile(确认makefile生成成功没)</p> 
<p>make -j 4</p> 
<p>sudo make install</p> 
<p>make configs</p> 
<p></p> 
<p><strong>四 安装在coturn</strong></p> 
<p>coturn依赖项先安装</p> 
<p>apt install libevent-dev</p> 
<p>apt install libpq-dev</p> 
<p>apt install mysql-client</p> 
<p>apt  install libmysqlclient-dev</p> 
<p>apt install libhiredis-dev</p> 
<p></p> 
<p>git clone https://github.com/coturn/coturn</p> 
<p>cd coturn</p> 
<p>./configure</p> 
<p>make</p> 
<p>sudo make install</p> 
<p>which turnserver（查看安装情况）</p> 
<p></p> 
<p>（sudo cp /us从默认的配置文件中复制生成Coturn的配置文件）</p> 
<p><code>turnserver.conf</code>r/local/etc/turnserver.conf.default    /usr/local/etc/turnserver.conf</p> 
<p></p> 
<p><span style="color:#fe2c24;">使用openssl生成证书</span></p> 
<p>sudo openssl req -x509 -newkey rsa:2048 -keyout /etc/turn_server_pkey.pem -out /etc/turn_server_cert.pem -days 99999 -nodes</p> 
<p><img alt="" height="385" src="https://images2.imgbox.com/a5/0b/Z8PeQEol_o.png" width="1200"></p> 
<p></p> 
<p></p> 
<p><strong>五 janus配置</strong></p> 
<p>基于安全隐私问题，Webkit内核的浏览器共享视频、语音、经纬度坐标等必须通过https形式访问。为了体验Janus，就必须启用https服务，配置包括janus的https开启和Nginx服务器的https开启。</p> 
<p><strong>1 申请ssl证书</strong></p> 
<p><strong>2 vim /usr/local/janus/etc/janus/janus.jcfg</strong></p> 
<p>certificates配置项如下：</p> 
<p>certificates: {<!-- --></p> 
<p>cert_pem = "/etc/ssl/cert/domain.cert.pem"</p> 
<p>cert_key = "/etc/ssl/cert/domain.key.pem"</p> 
<p>}</p> 
<p></p> 
<p><strong>3 nat配置项如下：</strong>（其中的用户名及密码为turnserver.conf中配置的用户名及密码）</p> 
<pre><code>nat: {
        stun_server = "domain.com"
        stun_port = 3478
        nice_debug = true
        #full_trickle = true
        #ice_lite = true
        ice_tcp = true
        ...
        turn_server = "domain.com"
        turn_port = 3478
        turn_type = "udp"
        turn_user = "user"
        turn_pwd = "passwd"     </code></pre> 
<p><strong>4 传输的配置开启https打开，否则无法使用WebRTC</strong></p> 
<p>vim /usr/local/janus/etc/janus/janus.tranport.http.jcfg</p> 
<p>general: {<!-- --><br>     ...<br>     https = true                    # Whether to enable HTTPS (default=false)<br>     ...<br> }<br>  <br> admin: {<!-- --><br>     ...<br>     admin_https = true                # Whether to enable HTTPS (default=false)<br>     ...<br> }<br>  <br> certificates: {<!-- --><br>     cert_pem = "/etc/nginx/cert/domain.club.pem"<br>     cert_key = "/etc/nginx/cert/domain.club.key"<br>     ...<br> }<br>  </p> 
<p><strong>六 nginx配置</strong></p> 
<p>       Nginx开启https服务必须要有证书和密钥，获取到证书和密钥后，我们在/etc/nginx目录下创建一个cert目录，将文件拷贝进去，供我们后续使用。</p> 
<p></p> 
<p><span style="color:#fe2c24;">这里自建nginx证书</span></p> 
<p>openssl req -x509 -newkey rsa:2048 -keyout /etc/nginx/cert/nginx.key -out /etc/nginx/cert/nginx.crt -days 99999 -nodes</p> 
<p>建立新的nginx配置文件 vim /etc/nginx/conf.d/domain.janus.conf</p> 
<p>并添加如下内容</p> 
<pre><code>server {
    listen 0.0.0.0:443 ssl;
    listen [::]:443 ssl;
    # tls configuration that is not covered in this guide
    # we recommend the use of https://certbot.eff.org/
    server_name doman.com;
    # set the root
    root /opt/janus/janus-gateway/html;
    index index.html;
    location ~ ^/([a-zA-Z0-9=\?]+)$ {
        rewrite ^/(.*)$ / break;
    }
    location / {
        ssi on;
    }

    ssl_certificate /etc/letsencrypt/live/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/privkey.pem; # managed by Certbot
}</code></pre> 
<p></p> 
<p><strong>启动nginx</strong></p> 
<p>nginx -t &amp;amp;nginx -s reload</p> 
<p></p> 
<p><strong>启动janus</strong></p> 
<p>cd /usr/local/janus/bin</p> 
<p>sudo ./janus</p> 
<p></p> 
<p>打开控制台，查询本机ip地址192.168.2.158</p> 
<p>浏览器访问web服务器的地址，https://192.168.2.158:443/（切记https不能省略，否则浏览器默认使用http协议访问，就会导致400 band request访问错误）</p> 
<p>打开demo-&gt;Echo Test-&gt;start，若浏览器打开了摄像头即说明janus搭建成功。<br><img alt="" src="https://images2.imgbox.com/99/d0/FEKwHz2F_o.png"></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/01d7b83781cbb01145b771212d7ae74c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">allegro走线层切换</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d835c67751e52b3d8d58144b480589f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">django模型外键自动加‘_id’</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>