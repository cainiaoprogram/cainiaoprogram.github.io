<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flv解复用代码解析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flv解复用代码解析" />
<meta property="og:description" content="Flv解复用代码解析 目录 总体流程 main函数处理函数process解析函数 解析Flv header和Flv Tag 解析Flv header解析Flv Tag解析MetaData Tag dump H264、AAC和FLV GitHub源码地址：flv-parser
Flv格式分析：Flv格式分析
1. 总体流程 flv-parser项目能够解析flv格式文件，分离出H264和AAC数据，最后组装回flv格式文件并输出。 1. main函数 流程： 读取输⼊⽂件（flv类型的视频⽂件）调⽤Process进⾏处理退出 int main(int argc, char *argv[]) { //argv[1]是开始的第一个输入参数 cout &lt;&lt; &#34;this is FLV parser test program!\ninput: flv, output:flv\n&#34;; if (argc != 3) { cout &lt;&lt; &#34;FlvParser.exe [input flv] [output flv]&#34; &lt;&lt; endl; return 0; } fstream fin; //fstream包含读写操作，对打开的文件可进行读写操作 fin.open(argv[1], ios_base::in | ios_base::binary); //以二进制文件格式进行输入 if (!fin) return 0; process(fin, argv[2]); //argv[2]，输出flv文件 fin." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e06cbcffc86bb745269c2e2205966e4d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-17T19:32:06+08:00" />
<meta property="article:modified_time" content="2022-03-17T19:32:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flv解复用代码解析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Flv_0"></a>Flv解复用代码解析</h2> 
<hr> 
<h3><a id="_2"></a>目录</h3> 
<ol><li>总体流程 
  <ol><li>main函数</li><li>处理函数process</li><li>解析函数</li></ol> </li><li>解析Flv header和Flv Tag 
  <ol><li>解析Flv header</li><li>解析Flv Tag</li><li>解析MetaData Tag</li></ol> </li><li>dump H264、AAC和FLV</li></ol> 
<blockquote> 
 <p>GitHub源码地址：<a href="https://github.com/lijinwang97/flv-parser">flv-parser</a><br> Flv格式分析：<a href="https://blog.csdn.net/weixin_41910694/article/details/109564752">Flv格式分析</a></p> 
</blockquote> 
<hr> 
<h3><a id="1__20"></a>1. 总体流程</h3> 
<ol><li>flv-parser项目能够解析flv格式文件，分离出H264和AAC数据，最后组装回flv格式文件并输出。</li></ol> 
<h4><a id="1_main_22"></a>1. main函数</h4> 
<ol start="2"><li>流程： 
  <ol><li>读取输⼊⽂件（flv类型的视频⽂件）</li><li>调⽤Process进⾏处理</li><li>退出</li></ol> </li></ol> 
<pre><code class="prism language-go"><span class="token builtin">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token builtin">int</span> argc<span class="token punctuation">,</span> char <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//argv[1]是开始的第一个输入参数</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"this is FLV parser test program!\ninput: flv, output:flv\n"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"FlvParser.exe [input flv] [output flv]"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fstream fin<span class="token punctuation">;</span> <span class="token comment">//fstream包含读写操作，对打开的文件可进行读写操作</span>
    fin<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ios_base<span class="token punctuation">:</span><span class="token punctuation">:</span>in <span class="token operator">|</span> ios_base<span class="token punctuation">:</span><span class="token punctuation">:</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//以二进制文件格式进行输入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fin<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">process</span><span class="token punctuation">(</span>fin<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//argv[2]，输出flv文件</span>

    fin<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2_process_49"></a>2. 处理函数process</h4> 
<ol><li>流程： 
  <ol><li>读取Flv⽂件</li><li>开始解析</li><li>打印解析信息</li><li>把解析之后的数据输出到另外⼀个⽂件中</li></ol> </li></ol> 
<pre><code class="prism language-go">void <span class="token function">process</span><span class="token punctuation">(</span>fstream <span class="token operator">&amp;</span>fin<span class="token punctuation">,</span> <span class="token keyword">const</span> char <span class="token operator">*</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    CFlvParser parser<span class="token punctuation">;</span>

    <span class="token builtin">int</span> nBufSize <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> nFlvPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    unsigned char <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token operator">*</span>pBak<span class="token punctuation">;</span> <span class="token comment">//用于存储读取的文本数据，不会有负数，所以使用unsigned</span>
    pBuf <span class="token operator">=</span> <span class="token builtin">new</span> unsigned char<span class="token punctuation">[</span>nBufSize<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//从堆中创建2M内存</span>
    pBak <span class="token operator">=</span> <span class="token builtin">new</span> unsigned char<span class="token punctuation">[</span>nBufSize<span class="token punctuation">]</span><span class="token punctuation">;</span>

    while <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin">int</span> nReadNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//总读取size</span>
        <span class="token builtin">int</span> nUsedLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//已使用的size</span>
        fin<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">(</span>char <span class="token operator">*</span><span class="token punctuation">)</span> pBuf <span class="token operator">+</span> nFlvPos<span class="token punctuation">,</span> nBufSize <span class="token operator">-</span> nFlvPos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//读取2M数据</span>
        nReadNum <span class="token operator">=</span> fin<span class="token punctuation">.</span><span class="token function">gcount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取读取的size</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nReadNum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//读取为0，说明文件已经读取完</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        nFlvPos <span class="token operator">+=</span> nReadNum<span class="token punctuation">;</span> <span class="token comment">//移动偏移量</span>

        parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>pBuf<span class="token punctuation">,</span> nFlvPos<span class="token punctuation">,</span> nUsedLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nFlvPos <span class="token operator">!=</span> nUsedLen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>pBak<span class="token punctuation">,</span> pBuf <span class="token operator">+</span> nUsedLen<span class="token punctuation">,</span> nFlvPos <span class="token operator">-</span> nUsedLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将未使用的size复制到pBak</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>pBuf<span class="token punctuation">,</span> pBak<span class="token punctuation">,</span> nFlvPos <span class="token operator">-</span> nUsedLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从pBak复制回pBuf</span>
        <span class="token punctuation">}</span>
        nFlvPos <span class="token operator">-=</span> nUsedLen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    parser<span class="token punctuation">.</span><span class="token function">PrintInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//打印解析信息</span>
    parser<span class="token punctuation">.</span><span class="token function">DumpH264</span><span class="token punctuation">(</span><span class="token string">"parser.264"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//dump h264文件</span>
    parser<span class="token punctuation">.</span><span class="token function">DumpAAC</span><span class="token punctuation">(</span><span class="token string">"parser.aac"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//dump aac文件</span>

    <span class="token comment">//dump into flv</span>
    parser<span class="token punctuation">.</span><span class="token function">DumpFlv</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出flv格式文件</span>

    <span class="token builtin">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span>pBak<span class="token punctuation">;</span> <span class="token comment">//释放内存，使用delete[]</span>
    <span class="token builtin">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span>pBuf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3__94"></a>3. 解析函数</h4> 
<ol><li>流程： 
  <ol><li>解析flv的头部</li><li>解析flv的Tag</li></ol> </li></ol> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> nBufSize<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>nUsedLen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> nOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_pFlvHeader <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">CheckBuffer</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//flv header头为9字节</span>
        m_pFlvHeader <span class="token operator">=</span> <span class="token function">create_flvHeader</span><span class="token punctuation">(</span>pBuf <span class="token operator">+</span> nOffset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建FLV header</span>
        nOffset <span class="token operator">+</span><span class="token operator">=</span> m_pFlvHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_headSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">CheckBuffer</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// previousTagSize(4字节) + tag header(11字节)</span>
        <span class="token keyword">int</span> nPrevSize <span class="token operator">=</span> <span class="token function">show_u32</span><span class="token punctuation">(</span>pBuf <span class="token operator">+</span> nOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nOffset <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

        Tag <span class="token operator">*</span>pTag <span class="token operator">=</span> <span class="token function">create_tag</span><span class="token punctuation">(</span>pBuf <span class="token operator">+</span> nOffset<span class="token punctuation">,</span> nBufSize <span class="token operator">-</span> nOffset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取一个flv tag</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pTag <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            nOffset <span class="token operator">-</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">//如果tag为null，复原offset</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        nOffset <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">11</span> <span class="token operator">+</span> pTag<span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_dataSize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//tag header + tag datasize</span>

        m_tag<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>pTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nUsedLen <span class="token operator">=</span> nOffset<span class="token punctuation">;</span> <span class="token comment">//记录使用的size</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h3><a id="2_Flv_headerFlv_Tag_129"></a>2. 解析Flv header和Flv Tag</h3> 
<h4><a id="1_Flv_header_130"></a>1. 解析Flv header</h4> 
<ol><li>flv header数据结构：</li></ol> 
<pre><code class="prism language-cpp">    <span class="token keyword">typedef</span> <span class="token keyword">struct</span> FlvHeader_s <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> m_version<span class="token punctuation">;</span>
        <span class="token keyword">int</span> m_haveVideo<span class="token punctuation">,</span> m_haveAudio<span class="token punctuation">;</span>
        <span class="token keyword">int</span> m_headSize<span class="token punctuation">;</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>m_flvHeader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> FlvHeader<span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>解析Flv header</li></ol> 
<pre><code class="prism language-cpp">CFlvParser<span class="token operator">::</span>FlvHeader <span class="token operator">*</span>CFlvParser<span class="token operator">::</span><span class="token function">create_flvHeader</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    FlvHeader <span class="token operator">*</span>pHeader <span class="token operator">=</span> <span class="token keyword">new</span> FlvHeader<span class="token punctuation">;</span>
    pHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_version <span class="token operator">=</span> pBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    pHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_haveAudio <span class="token operator">=</span> <span class="token punctuation">(</span>pBuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>    <span class="token comment">//是否有音频，音频标识在第5bit，比如 0000 0101，右移两位就是0000 01，&amp; 0x01就可以得到值了</span>
    pHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_haveVideo <span class="token operator">=</span> <span class="token punctuation">(</span>pBuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>    <span class="token comment">//是否有视频</span>
    pHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_headSize <span class="token operator">=</span> <span class="token function">show_u32</span><span class="token punctuation">(</span>pBuf <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//头部长度，从第6字节开始，所以需要移动5字节，flv header头为9字节</span>

    pHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_flvHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>pHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_headSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>pHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_flvHeader<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> pHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_headSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pHeader<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2_Flv_Tag_160"></a>2. 解析Flv Tag</h4> 
<ol><li>先解析Tag header，再根据tag type匹配对应类型。</li><li>格式参考：<a href="https://blog.csdn.net/weixin_41910694/article/details/109564752">Flv格式分析</a></li></ol> 
<pre><code class="prism language-cpp">CFlvParser<span class="token operator">::</span>Tag <span class="token operator">*</span>CFlvParser<span class="token operator">::</span><span class="token function">create_tag</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> nLeftLen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    TagHeader header<span class="token punctuation">;</span>   <span class="token comment">//开始解析标签头部</span>
    header<span class="token punctuation">.</span>m_type <span class="token operator">=</span> <span class="token function">show_u8</span><span class="token punctuation">(</span>pBuf <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//类型</span>
    header<span class="token punctuation">.</span>m_dataSize <span class="token operator">=</span> <span class="token function">show_u24</span><span class="token punctuation">(</span>pBuf <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//标签body的长度</span>
    header<span class="token punctuation">.</span>m_timeStamp <span class="token operator">=</span> <span class="token function">show_u24</span><span class="token punctuation">(</span>pBuf <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//时间戳 低24bit</span>
    header<span class="token punctuation">.</span>m_TSEx <span class="token operator">=</span> <span class="token function">show_u8</span><span class="token punctuation">(</span>pBuf <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//时间戳的扩展字段, 高8bit</span>
    header<span class="token punctuation">.</span>m_StreamID <span class="token operator">=</span> <span class="token function">show_u24</span><span class="token punctuation">(</span>pBuf <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//流id</span>
    header<span class="token punctuation">.</span>m_TotalTS <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>m_TSEx <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> header<span class="token punctuation">.</span>m_timeStamp<span class="token punctuation">;</span> <span class="token comment">//转换成uint32_t类型，nTSEx为高位，往左移动24位，然后加上nTimeStamp</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"total TS : "</span> <span class="token operator">&lt;&lt;</span> header<span class="token punctuation">.</span>m_TotalTS <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">//cout &lt;&lt; "nLeftLen : " &lt;&lt; nLeftLen &lt;&lt; " , m_dataSize : " &lt;&lt; pTag-&gt;header.m_dataSize &lt;&lt; endl;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>m_dataSize <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> nLeftLen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//如果tag header + tag datasize长度大于nLeftLen</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Tag <span class="token operator">*</span>pTag<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span>m_type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//根据tag type匹配对应类型，格式参考blog：https://blog.csdn.net/weixin_41910694/article/details/109564752</span>
        <span class="token keyword">case</span> <span class="token number">0x09</span><span class="token operator">:</span>
            pTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CVideoTag</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> nLeftLen<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解析视频tag</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">0x08</span><span class="token operator">:</span>
            pTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CAudioTag</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> nLeftLen<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解析音频tag</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">0x12</span><span class="token operator">:</span>
            pTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CMetaDataTag</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> nLeftLen<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解析metadata tag</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            pTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Tag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pTag<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> nLeftLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> pTag<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>其中Tag的数据结构为：</li></ol> 
<pre><code class="prism language-cpp">    <span class="token keyword">class</span> <span class="token class-name">Tag</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Tag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">m_tagHeader</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_tagData</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_media</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_mediaLen</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>TagHeader <span class="token operator">*</span>pHeader<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> nLeftLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

        TagHeader m_header<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>m_tagHeader<span class="token punctuation">;</span> <span class="token comment">//记录tag header原始数据</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>m_tagData<span class="token punctuation">;</span> <span class="token comment">//记录tag data原始数据</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>m_media<span class="token punctuation">;</span>
        <span class="token keyword">int</span> m_mediaLen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="4"><li>Tag Header数据结构为：</li></ol> 
<pre><code class="prism language-cpp">    <span class="token keyword">struct</span> TagHeader <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> m_type<span class="token punctuation">;</span>
        <span class="token keyword">int</span> m_dataSize<span class="token punctuation">;</span>
        <span class="token keyword">int</span> m_timeStamp<span class="token punctuation">;</span>
        <span class="token keyword">int</span> m_TSEx<span class="token punctuation">;</span>
        <span class="token keyword">int</span> m_StreamID<span class="token punctuation">;</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> m_TotalTS<span class="token punctuation">;</span>

        <span class="token function">TagHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">m_type</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_dataSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_timeStamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_TSEx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_StreamID</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_TotalTS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token operator">~</span><span class="token function">TagHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="1_Video_Tag_233"></a>1. 解析Video Tag</h5> 
<ol><li>当Tag header的type值为8时表示Video Tag，Video Tag数据结构为：</li></ol> 
<pre><code class="prism language-cpp">    <span class="token keyword">class</span> <span class="token class-name">CVideoTag</span> <span class="token operator">:</span> <span class="token keyword">public</span> Tag <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">CVideoTag</span><span class="token punctuation">(</span>TagHeader <span class="token operator">*</span>pHeader<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> nLeftLen<span class="token punctuation">,</span> CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> m_frameType<span class="token punctuation">;</span>
        <span class="token keyword">int</span> m_codecID<span class="token punctuation">;</span>

        <span class="token keyword">int</span> <span class="token function">parse_H264_tag</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> <span class="token function">parse_H264_configuration</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pTagData<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> <span class="token function">parse_nalu</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pTagData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>Video Tag第1字节是4bit的帧类型和4bit的视频编码类型，如果视频编码类型为AVC则说明是h264的类型。</li></ol> 
<pre><code class="prism language-cpp">CFlvParser<span class="token operator">::</span>CVideoTag<span class="token operator">::</span><span class="token function">CVideoTag</span><span class="token punctuation">(</span>TagHeader <span class="token operator">*</span>pHeader<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> nLeftLen<span class="token punctuation">,</span> CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">init</span><span class="token punctuation">(</span>pHeader<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> nLeftLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//存储tag header和tag data原始数据</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pd <span class="token operator">=</span> m_tagData<span class="token punctuation">;</span>
    m_frameType <span class="token operator">=</span> <span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xf0</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">//帧类型</span>
    m_codecID <span class="token operator">=</span> pd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0f</span><span class="token punctuation">;</span>          <span class="token comment">//视频编码类型，值为7表示AVC</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_header<span class="token punctuation">.</span>m_type <span class="token operator">==</span> <span class="token number">0x09</span> <span class="token operator">&amp;&amp;</span> m_codecID <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//如果type=9并且codeId为7，那么表示h264</span>
        <span class="token function">parse_H264_tag</span><span class="token punctuation">(</span>pParser<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解析h264 tag data</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>第2字节表示AVCPacketType。 
  <ol><li>值为0表示AVC sequence header，解析方式</li><li>1表示AVC NALU。</li></ol> </li><li>按照不同的AVCPacketType进行解析。</li></ol> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span>CVideoTag<span class="token operator">::</span><span class="token function">parse_H264_tag</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pd <span class="token operator">=</span> m_tagData<span class="token punctuation">;</span> <span class="token comment">//pd[0]表示帧类型和编码ID</span>
    <span class="token comment">//pd[1]表示AVCPacketType，值为0表示AVC sequence header，1表示AVC NALU</span>
    <span class="token keyword">int</span> nAVCPacketType <span class="token operator">=</span> pd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> nCompositionTime <span class="token operator">=</span> CFlvParser<span class="token operator">::</span><span class="token function">show_u24</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nAVCPacketType <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//AVCPacketType=0那么data数据为AVCDecoderConfigurationRecoder</span>
        <span class="token function">parse_H264_configuration</span><span class="token punctuation">(</span>pParser<span class="token punctuation">,</span> pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nAVCPacketType <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//AVCPacketType=1那么表示有一个或多个NALU</span>
        <span class="token function">parse_nalu</span><span class="token punctuation">(</span>pParser<span class="token punctuation">,</span> pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="1_AVCDecoderConfigurationRecoder_290"></a>1. 解析AVCDecoderConfigurationRecoder</h6> 
<pre><code class="prism language-cpp"><span class="token comment">/**
AVCDecoderConfigurationRecord {
    uint32_t(8) configurationVersion = 1;  [0]
    uint32_t(8) AVCProfileIndication;       [1]
    uint32_t(8) profile_compatibility;      [2]
    uint32_t(8) AVCLevelIndication;         [3]
    bit(6) reserved = ‘111111’b;            [4]
    uint32_t(2) lengthSizeMinusOne;         [4] 计算方法是 1 + (lengthSizeMinusOne &amp; 3)，实际计算结果一直是4
    bit(3) reserved = ‘111’b;                   [5]
    uint32_t(5) numOfSequenceParameterSets; [5] SPS 的个数，计算方法是 numOfSequenceParameterSets &amp; 0x1F，实际计算结果一直为1
    for (i=0; i&lt; numOfSequenceParameterSets; i++) {
        uint32_t(16) sequenceParameterSetLength ;   [6,7]
        bit(8*sequenceParameterSetLength) sequenceParameterSetNALUnit;
    }
    uint32_t(8) numOfPictureParameterSets;      PPS 的个数，一直为1
    for (i=0; i&lt; numOfPictureParameterSets; i++) {
        uint32_t(16) pictureParameterSetLength;
        bit(8*pictureParameterSetLength) pictureParameterSetNALUnit;
    }
}
 */</span>
<span class="token keyword">int</span> CFlvParser<span class="token operator">::</span>CVideoTag<span class="token operator">::</span><span class="token function">parse_H264_configuration</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pTagData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pd <span class="token operator">=</span> pTagData<span class="token punctuation">;</span>
    <span class="token comment">// 跨过 Tag Data的VIDEODATA(1字节) AVCVIDEOPACKET(AVCPacketType(1字节) 和 CompositionTime(3字节) 5字节)</span>
    pParser<span class="token operator">-</span><span class="token operator">&gt;</span>m_nalUnitLength <span class="token operator">=</span> <span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x03</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//m_nalUnitLength = 1 + (lengthSizeMinusOne &amp; 3)，表示NALU的长度</span>

    <span class="token keyword">int</span> sps_size<span class="token punctuation">,</span> pps_size<span class="token punctuation">;</span>
    sps_size <span class="token operator">=</span> CFlvParser<span class="token operator">::</span><span class="token function">show_u16</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//sequenceParameterSetLength</span>
    pps_size <span class="token operator">=</span> CFlvParser<span class="token operator">::</span><span class="token function">show_u16</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> <span class="token number">11</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> sps_size<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//pictureParameterSetLength</span>

    m_mediaLen <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">+</span> sps_size <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> pps_size<span class="token punctuation">;</span>
    m_media <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>m_mediaLen<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>m_media<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_h264StartCode<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>m_media <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> pd <span class="token operator">+</span> <span class="token number">11</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> sps_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//sequenceParameterSetNALUnit</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>m_media <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> sps_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_h264StartCode<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>m_media <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> sps_size <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> pd <span class="token operator">+</span> <span class="token number">11</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> sps_size <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> pps_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//pictureParameterSetNALUnit</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol><li>其中m_nalUnitLength表示用几个字节来存储NALU的长度，因为一个tag可能包含多个nalu, 所以每个nalu前面有NalUnitLength字节表示每个nalu的长度<br> a. 如果NALULengthSizeMinusOne是0，那么每个NALU使用一个字节的前缀来指定长度，那么每个NALU包的最大长度是255字节，<br> b. 使用2个字节的前缀来指定长度，那么每个NALU包的最大长度是64K字节，但分辨率达到1280*720 的图像编码出的I帧，可能大于64K；<br> c. 3字节是比较好的，但是因为一些原因（例如对齐）没有被广泛支持，因此4字节长度的前缀是目前使用最多的方式。</li></ol> 
<h6><a id="2_NALU_338"></a>2. 解析NALU</h6> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span>CVideoTag<span class="token operator">::</span><span class="token function">parse_nalu</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pTagData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pd <span class="token operator">=</span> pTagData<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    m_media <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>m_header<span class="token punctuation">.</span>m_dataSize <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    m_mediaLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    nOffset <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nOffset <span class="token operator">&gt;=</span> m_header<span class="token punctuation">.</span>m_dataSize<span class="token punctuation">)</span> <span class="token comment">//如果解析完了一个tag，跳出循环</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">//一个tag可能包含多个nalu, 所以每个nalu前面有NalUnitLength字节表示每个nalu的长度</span>
        <span class="token keyword">int</span> nNaluLen<span class="token punctuation">;</span>  <span class="token comment">//nNaluLen表示时间nalu数据长度</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>pParser<span class="token operator">-</span><span class="token operator">&gt;</span>m_nalUnitLength<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                nNaluLen <span class="token operator">=</span> CFlvParser<span class="token operator">::</span><span class="token function">show_u32</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> nOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
                nNaluLen <span class="token operator">=</span> CFlvParser<span class="token operator">::</span><span class="token function">show_u24</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> nOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                nNaluLen <span class="token operator">=</span> CFlvParser<span class="token operator">::</span><span class="token function">show_u16</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> nOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                nNaluLen <span class="token operator">=</span> CFlvParser<span class="token operator">::</span><span class="token function">show_u8</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> nOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>m_media <span class="token operator">+</span> m_mediaLen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_h264StartCode<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>m_media <span class="token operator">+</span> m_mediaLen <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> pd <span class="token operator">+</span> nOffset <span class="token operator">+</span> pParser<span class="token operator">-</span><span class="token operator">&gt;</span>m_nalUnitLength<span class="token punctuation">,</span> nNaluLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_mediaLen <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">+</span> nNaluLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//m_mediaLen = startcode + nNaluLen（实际数据长度）</span>
        nOffset <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span>pParser<span class="token operator">-</span><span class="token operator">&gt;</span>m_nalUnitLength <span class="token operator">+</span> nNaluLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//一个nalu整体长度 = NalUnitLength + NaluLen</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol><li>根据m_nalUnitLength获取NALU的长度，然后拷贝到m_media。</li></ol> 
<h5><a id="2_Audio_Tag_380"></a>2. 解析Audio Tag</h5> 
<ol><li>当Tag header的type值为8时表示Audio Tag，Audio Tag的数据结构为：</li></ol> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">CAudioTag</span> <span class="token operator">:</span> <span class="token keyword">public</span> Tag <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CAudioTag</span><span class="token punctuation">(</span>TagHeader <span class="token operator">*</span>pHeader<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> nLeftLen<span class="token punctuation">,</span> CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> m_soundFormat<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_soundRate<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_soundSize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_soundType<span class="token punctuation">;</span>

    <span class="token comment">// aac</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> m_aacProfile<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> m_sampleRateIndex<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> m_channelConfig<span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">parse_AAC_tag</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">parse_audio_specificConfig</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pTagData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">parse_rawAAC</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pTagData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>Tag Data的第0字节包含：<br> a. 4bit的音频格式<br> b. 2bit的采样率<br> c. 1bit的采样精度<br> d. 1bit的判断是否为立体声</li><li>当音频格式值为10表示AAC，进行解析AAC Tag</li></ol> 
<pre><code class="prism language-cpp">CFlvParser<span class="token operator">::</span>CAudioTag<span class="token operator">::</span><span class="token function">CAudioTag</span><span class="token punctuation">(</span>TagHeader <span class="token operator">*</span>pHeader<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> nLeftLen<span class="token punctuation">,</span> CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">init</span><span class="token punctuation">(</span>pHeader<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> nLeftLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pd <span class="token operator">=</span> m_tagData<span class="token punctuation">;</span>
    m_soundFormat <span class="token operator">=</span> <span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xf0</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">//音频格式</span>
    m_soundRate <span class="token operator">=</span> <span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0c</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token comment">//采样率</span>
    m_soundSize <span class="token operator">=</span> <span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x02</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//采样精度</span>
    m_soundType <span class="token operator">=</span> <span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//是否立体声</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_soundFormat <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// m_soundFormat=10时表示AAC</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">parse_AAC_tag</span><span class="token punctuation">(</span>pParser<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解析AAC tag</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>Tag Data的第1字节表示AACPacketType，值为0表示AAC sequence header，值为1表示AAC raw data。</li></ol> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span>CAudioTag<span class="token operator">::</span><span class="token function">parse_AAC_tag</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pd <span class="token operator">=</span> m_tagData<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nAACPacketType <span class="token operator">=</span> pd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//值为0表示AAC sequence header，值为1表示AAC raw</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nAACPacketType <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//值为0表示AAC sequence header，数据是AudioSpecificConfig</span>
        <span class="token function">parse_audio_specificConfig</span><span class="token punctuation">(</span>pParser<span class="token punctuation">,</span> pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nAACPacketType <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//值为1表示AAC raw，数据是Raw AAC frame data</span>
        <span class="token function">parse_rawAAC</span><span class="token punctuation">(</span>pParser<span class="token punctuation">,</span> pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="1_AudioSpecificConfig_448"></a>1. 解析AudioSpecificConfig</h6> 
<ol><li>从第2字节开始，包含：<br> a. 5bit的AAC编码级别<br> b. 4bit的采样率索引<br> c. 4bit的通道数量</li></ol> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span>CAudioTag<span class="token operator">::</span><span class="token function">parse_audio_specificConfig</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pTagData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pd <span class="token operator">=</span> m_tagData<span class="token punctuation">;</span>

    m_aacProfile <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xf8</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//5bit，AAC编码级别，audioObjectType</span>
    m_sampleRateIndex <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x07</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4bit，真正的采样率索引，samplingFrequencyIndex</span>
    m_channelConfig <span class="token operator">=</span> <span class="token punctuation">(</span>pd<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0f</span><span class="token punctuation">;</span> <span class="token comment">//4bit，通道数量</span>

    m_media <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    m_mediaLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2_AAC_raw_data_469"></a>2. 解析AAC raw data</h6> 
<ol><li>AAC raw data需要制作ADTS header，可以参考博客：<a href="https://blog.csdn.net/weixin_41910694/article/details/107735932">AAC音频基础知识及码流解析</a></li></ol> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span>CAudioTag<span class="token operator">::</span><span class="token function">parse_rawAAC</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pTagData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">uint64_t</span> bits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> dataSize <span class="token operator">=</span> m_header<span class="token punctuation">.</span>m_dataSize <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 减去两字节的 audio tag data信息部分</span>

    <span class="token comment">//制作元数据，见ADTS头格式, https://blog.csdn.net/weixin_41910694/article/details/107735932</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0xFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> m_aacProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> m_sampleRateIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> m_channelConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">7</span> <span class="token operator">+</span> dataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">0x7FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_u64</span><span class="token punctuation">(</span>bits<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    m_mediaLen <span class="token operator">=</span> <span class="token number">7</span> <span class="token operator">+</span> dataSize<span class="token punctuation">;</span>
    m_media <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>m_mediaLen<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> p64<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    p64<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bits <span class="token operator">&gt;&gt;</span> <span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p64<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bits <span class="token operator">&gt;&gt;</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p64<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bits <span class="token operator">&gt;&gt;</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p64<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bits <span class="token operator">&gt;&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p64<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bits <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p64<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bits <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p64<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bits <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p64<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>m_media<span class="token punctuation">,</span> p64 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>m_media <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span> pTagData <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> dataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3_MetaData_Tag_514"></a>3. 解析MetaData Tag</h5> 
<ol><li>当Tag header的type值为18时表示MetaData Tag，MetaData Tag的数据结构为：</li></ol> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">CMetaDataTag</span> <span class="token operator">:</span> <span class="token keyword">public</span> Tag <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CMetaDataTag</span><span class="token punctuation">(</span>TagHeader <span class="token operator">*</span>pHeader<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> nLeftLen<span class="token punctuation">,</span> CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">double</span> <span class="token function">hex_str2double</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>hex<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">parse_meta</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">print_meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint8_t</span> m_amf1_type<span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> m_amf1_size<span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> m_amf2_type<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>m_meta<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> m_length<span class="token punctuation">;</span>

    <span class="token keyword">double</span> m_duration<span class="token punctuation">;</span>
    <span class="token keyword">double</span> m_width<span class="token punctuation">;</span>
    <span class="token keyword">double</span> m_height<span class="token punctuation">;</span>
    <span class="token keyword">double</span> m_videodatarate<span class="token punctuation">;</span>
    <span class="token keyword">double</span> m_framerate<span class="token punctuation">;</span>
    <span class="token keyword">double</span> m_videocodecid<span class="token punctuation">;</span>

    <span class="token keyword">double</span> m_audiodatarate<span class="token punctuation">;</span>
    <span class="token keyword">double</span> m_audiosamplerate<span class="token punctuation">;</span>
    <span class="token keyword">double</span> m_audiosamplesize<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> m_stereo<span class="token punctuation">;</span>
    <span class="token keyword">double</span> m_audiocodecid<span class="token punctuation">;</span>

    string m_major_brand<span class="token punctuation">;</span>
    string m_minor_version<span class="token punctuation">;</span>
    string m_compatible_brands<span class="token punctuation">;</span>
    string m_encoder<span class="token punctuation">;</span>

    <span class="token keyword">double</span> m_filesize<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>MetaData由两个AFM包组成。</li><li>第⼀个AMF包：<br> a. 第0字节表示AMF包类型，⼀般总是0x02，表示字符串。<br> b. 第1-2字节为UI16类型值，标识字符串的⻓度，⼀般总是0x000A。<br> c. 从第3字节开始为amf1的value，为"onMetaData"。</li><li>第⼆个AMF包：<br> a. 第1个字节表示AMF包类型，⼀般总是0x08，表示数组。<br> b. 第2-5个字节为UI32类型值，表示数组元素的个数。<br> c. 后⾯即为各数组元素的封装，数组元素为元素名称和值组成的对。详细参考博客：<a href="https://blog.csdn.net/weixin_41910694/article/details/109564752">FLV格式解析</a></li></ol> 
<pre><code class="prism language-cpp">CFlvParser<span class="token operator">::</span>CMetaDataTag<span class="token operator">::</span><span class="token function">CMetaDataTag</span><span class="token punctuation">(</span>CFlvParser<span class="token operator">::</span>TagHeader <span class="token operator">*</span>pHeader<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> nLeftLen<span class="token punctuation">,</span>
                                       CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token function">init</span><span class="token punctuation">(</span>pHeader<span class="token punctuation">,</span> pBuf<span class="token punctuation">,</span> nLeftLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>pd <span class="token operator">=</span> pBuf<span class="token punctuation">;</span>
    m_amf1_type <span class="token operator">=</span> <span class="token function">show_u8</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//amf1包的type</span>
    m_amf1_size <span class="token operator">=</span> <span class="token function">show_u16</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//amf1包的value_size</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_amf1_type <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"no metadata\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//解析script</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"onMetaData"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>pd <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//从第3字节开始为amf1的value</span>
        <span class="token function">parse_meta</span><span class="token punctuation">(</span>pParser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span>CMetaDataTag<span class="token operator">::</span><span class="token function">parse_meta</span><span class="token punctuation">(</span>CFlvParser <span class="token operator">*</span>pParser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>pd <span class="token operator">=</span> m_tagData<span class="token punctuation">;</span>
    <span class="token keyword">int</span> dataSize <span class="token operator">=</span> m_header<span class="token punctuation">.</span>m_dataSize<span class="token punctuation">;</span>

    <span class="token keyword">uint32_t</span> arrayLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> offset <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span> <span class="token comment">// Type + Value_Size + Value = 13字节</span>

    <span class="token keyword">uint32_t</span> nameLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> doubleValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    string strValue <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> boolValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> valueLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> u8Value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pd<span class="token punctuation">[</span>offset<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 0x08表示onMetaData</span>
        arrayLen <span class="token operator">=</span> <span class="token function">show_u32</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ECMAArrayLength</span>
        offset <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">//跳过 [ECMAArrayLength]占用的字节</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ArrayLen = %d\n"</span><span class="token punctuation">,</span> arrayLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"metadata format error!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arrayLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        doubleValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        boolValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        strValue <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token comment">//读取字段长度</span>
        nameLen <span class="token operator">=</span> <span class="token function">show_u16</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//stringLength</span>
        offset <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span> name<span class="token punctuation">[</span>nameLen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pd<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">,</span> nameLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//stringData</span>
        name<span class="token punctuation">[</span>nameLen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
        offset <span class="token operator">+</span><span class="token operator">=</span> nameLen<span class="token punctuation">;</span> <span class="token comment">//跳过字段名占用的长度</span>

        <span class="token keyword">uint8_t</span> amfType <span class="token operator">=</span> pd<span class="token punctuation">[</span>offset<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//type</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>amfType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">0x0</span><span class="token operator">:</span> <span class="token comment">//Number type, 就是double类型，占用8字节</span>
                doubleValue <span class="token operator">=</span> <span class="token function">hex_str2double</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pd<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                offset <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">//跳过8字节</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">0x1</span><span class="token operator">:</span> <span class="token comment">//boolean type，bool类型，占用1字节</span>
                u8Value <span class="token operator">=</span> <span class="token function">show_u8</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                offset <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>u8Value <span class="token operator">!=</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    boolValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    boolValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">0x2</span><span class="token operator">:</span> <span class="token comment">//string type，占2字节</span>
                valueLen <span class="token operator">=</span> <span class="token function">show_u16</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                offset <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                strValue<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pd <span class="token operator">+</span> offset<span class="token punctuation">,</span> pd <span class="token operator">+</span> offset <span class="token operator">+</span> valueLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//todo</span>
                strValue<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                offset <span class="token operator">+</span><span class="token operator">=</span> valueLen<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"un handle amfType:%d\n"</span><span class="token punctuation">,</span> amfType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"duration"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_duration <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"width"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_width <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_height <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"videodatarate"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_videodatarate <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"framerate"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_framerate <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"videocodecid"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_videocodecid <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"audiodatarate"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_audiodatarate <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"audiosamplerate"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_audiosamplerate <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"audiosamplesize"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_audiosamplesize <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"stereo"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_stereo <span class="token operator">=</span> boolValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"audiocodecid"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_audiocodecid <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"major_brand"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_major_brand <span class="token operator">=</span> strValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"minor_version"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_minor_version <span class="token operator">=</span> strValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"compatible_brands"</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_compatible_brands <span class="token operator">=</span> strValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"encoder"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_encoder <span class="token operator">=</span> strValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"filesize"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            m_filesize <span class="token operator">=</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">print_meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>打印MetaData</li></ol> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> CFlvParser<span class="token operator">::</span>CMetaDataTag<span class="token operator">::</span><span class="token function">print_meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nduration: %0.2lfs, filesize: %.0lfbytes\n"</span><span class="token punctuation">,</span> m_duration<span class="token punctuation">,</span> m_filesize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"width: %0.0lf, height: %0.0lf\n"</span><span class="token punctuation">,</span> m_width<span class="token punctuation">,</span> m_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"videodatarate: %0.2lfkbps, framerate: %0.0lffps\n"</span><span class="token punctuation">,</span> m_videodatarate<span class="token punctuation">,</span> m_framerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"videocodecid: %0.0lf\n"</span><span class="token punctuation">,</span> m_videocodecid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audiodatarate: %0.2lfkbps, audiosamplerate: %0.0lfKhz\n"</span><span class="token punctuation">,</span>
           m_audiodatarate<span class="token punctuation">,</span> m_audiosamplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audiosamplesize: %0.0lfbit, stereo: %d\n"</span><span class="token punctuation">,</span> m_audiosamplesize<span class="token punctuation">,</span> m_stereo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audiocodecid: %0.0lf\n"</span><span class="token punctuation">,</span> m_audiocodecid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"major_brand: %s, minor_version: %s\n"</span><span class="token punctuation">,</span> m_major_brand<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_minor_version<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"compatible_brands: %s, encoder: %s\n\n"</span><span class="token punctuation">,</span> m_compatible_brands<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_encoder<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_dump_H264AACFLV_712"></a>3. dump H264、AAC和FLV</h3> 
<h4><a id="1_dump_H264_713"></a>1. dump H264</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span><span class="token function">dump_H264</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string <span class="token operator">&amp;</span>path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    fstream f<span class="token punctuation">;</span>
    f<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ios_base<span class="token operator">::</span>out <span class="token operator">|</span> ios_base<span class="token operator">::</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//以二进制文件输出</span>

    vector<span class="token operator">&lt;</span>Tag <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">::</span>iterator it_tag<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>it_tag <span class="token operator">=</span> m_tag<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it_tag <span class="token operator">!=</span> m_tag<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it_tag<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_type <span class="token operator">!=</span> <span class="token number">0x09</span><span class="token punctuation">)</span> <span class="token comment">//如果不是视频tag，continue</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_media<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_mediaLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出</span>
    <span class="token punctuation">}</span>
    f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2_dump_AAC_733"></a>2. dump AAC</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span><span class="token function">dump_AAC</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string <span class="token operator">&amp;</span>path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    fstream f<span class="token punctuation">;</span>
    f<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ios_base<span class="token operator">::</span>out <span class="token operator">|</span> ios_base<span class="token operator">::</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//以二进制方式输出</span>

    vector<span class="token operator">&lt;</span>Tag <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">::</span>iterator it_tag<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>it_tag <span class="token operator">=</span> m_tag<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it_tag <span class="token operator">!=</span> m_tag<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it_tag<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_type <span class="token operator">!=</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token comment">//如果不是音频tag，continue</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        CAudioTag <span class="token operator">*</span>pAudioTag <span class="token operator">=</span> <span class="token punctuation">(</span>CAudioTag <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pAudioTag<span class="token operator">-</span><span class="token operator">&gt;</span>m_soundFormat <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">//如果不是AAC格式，continue</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pAudioTag<span class="token operator">-</span><span class="token operator">&gt;</span>m_mediaLen <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_media<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_mediaLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3_dump_FLV_757"></a>3. dump FLV</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> CFlvParser<span class="token operator">::</span><span class="token function">dump_Flv</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string <span class="token operator">&amp;</span>path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    fstream f<span class="token punctuation">;</span>
    f<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ios_base<span class="token operator">::</span>out <span class="token operator">|</span> ios_base<span class="token operator">::</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 写Flv header</span>
    f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> m_pFlvHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_flvHeader<span class="token punctuation">,</span> m_pFlvHeader<span class="token operator">-</span><span class="token operator">&gt;</span>m_headSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nLastTagSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


    <span class="token comment">// 写 flv tag</span>
    vector<span class="token operator">&lt;</span>Tag <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">::</span>iterator it_tag<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>it_tag <span class="token operator">=</span> m_tag<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it_tag <span class="token operator">&lt;</span> m_tag<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it_tag<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nn <span class="token operator">=</span> <span class="token function">write_u32</span><span class="token punctuation">(</span>nLastTagSize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//第一个previousTagSize</span>
        f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>nn<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//检查重复的start code</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_type <span class="token operator">==</span> <span class="token number">0x09</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">bool</span> duplicate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pStartCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">+</span> m_nalUnitLength<span class="token punctuation">;</span>
            <span class="token comment">//printf("tagsize=%d\n",(*it_tag)-&gt;m_header.m_dataSize);</span>
            <span class="token keyword">unsigned</span> nalu_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p_nalu_len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>nalu_len<span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>m_nalUnitLength<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                    nalu_len <span class="token operator">=</span> <span class="token function">show_u32</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
                    nalu_len <span class="token operator">=</span> <span class="token function">show_u24</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                    nalu_len <span class="token operator">=</span> <span class="token function">show_u16</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    nalu_len <span class="token operator">=</span> <span class="token function">show_u8</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/*
            printf("nalu_len=%u\n",nalu_len);
            printf("%x,%x,%x,%x,%x,%x,%x,%x,%x\n",(*it_tag)-&gt;m_tagData[5],(*it_tag)-&gt;m_tagData[6],
                    (*it_tag)-&gt;m_tagData[7],(*it_tag)-&gt;m_tagData[8],(*it_tag)-&gt;m_tagData[9],
                    (*it_tag)-&gt;m_tagData[10],(*it_tag)-&gt;m_tagData[11],(*it_tag)-&gt;m_tagData[12],
                    (*it_tag)-&gt;m_tagData[13]);
            */</span>

            <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pStartCodeRecord <span class="token operator">=</span> pStartCode<span class="token punctuation">;</span>
            <span class="token keyword">int</span> i<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_dataSize <span class="token operator">-</span> <span class="token number">5</span> <span class="token operator">-</span> m_nalUnitLength <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pStartCode<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span> <span class="token operator">&amp;&amp;</span> pStartCode<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span> <span class="token operator">&amp;&amp;</span> pStartCode<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span> <span class="token operator">&amp;&amp;</span>
                    pStartCode<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pStartCode<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x67</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//printf("duplicate sps found!\n");</span>
                        i <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pStartCode<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x68</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//printf("duplicate pps found!\n");</span>
                        i <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pStartCode<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x06</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//printf("duplicate sei found!\n");</span>
                        i <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        i <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
                        <span class="token comment">//printf("offset=%d\n",i);</span>
                        duplicate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>duplicate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                nalu_len <span class="token operator">-</span><span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_dataSize <span class="token operator">-</span><span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_dataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagHeader<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagHeader<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagHeader<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">//printf("after,tagsize=%d\n",(int)show_u24((*it_tag)-&gt;m_tagHeader + 1));</span>
                <span class="token comment">//printf("%x,%x,%x\n",(*it_tag)-&gt;m_tagHeader[1],(*it_tag)-&gt;m_tagHeader[2],(*it_tag)-&gt;m_tagHeader[3]);</span>

                f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagHeader<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>m_nalUnitLength<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> p_nalu_len<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//printf("after,nalu_len=%d\n",(int)show_u32((*it_tag)-&gt;m_tagData + 5));</span>
                f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData<span class="token punctuation">,</span> pStartCode <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/*
                printf("%x,%x,%x,%x,%x,%x,%x,%x,%x\n",(*it_tag)-&gt;m_tagData[0],(*it_tag)-&gt;m_tagData[1],(*it_tag)-&gt;m_tagData[2],
                        (*it_tag)-&gt;m_tagData[3],(*it_tag)-&gt;m_tagData[4],(*it_tag)-&gt;m_tagData[5],(*it_tag)-&gt;m_tagData[6],
                        (*it_tag)-&gt;m_tagData[7],(*it_tag)-&gt;m_tagData[8]);
                */</span>
                f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> pStartCode <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_dataSize <span class="token operator">-</span> <span class="token punctuation">(</span>pStartCode <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/*
                printf("write size:%d\n", (pStartCode - (*it_tag)-&gt;m_tagData) +
                        ((*it_tag)-&gt;m_header.m_dataSize - (pStartCode - (*it_tag)-&gt;m_tagData)));
                */</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagHeader<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_dataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagHeader<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_tagData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_dataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        nLastTagSize <span class="token operator">=</span> <span class="token number">11</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">*</span>it_tag<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>m_header<span class="token punctuation">.</span>m_dataSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nn <span class="token operator">=</span> <span class="token function">write_u32</span><span class="token punctuation">(</span>nLastTagSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>nn<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b4d3f52b646acfb15714a9075d8abbf6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决Gazebo在building editor时闪退的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a3a4dc646759b449c16a9e6b252ca3f6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CentOS k8s1.20.9集群配套KubesPhere3.1.1安装</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>