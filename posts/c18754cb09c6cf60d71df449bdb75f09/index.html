<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>毕业设计 STM32空气质量检测仪 - 单片机 嵌入式 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="毕业设计 STM32空气质量检测仪 - 单片机 嵌入式" />
<meta property="og:description" content="文章目录 1 简介2 系统设计概述3 系统总体方案4 硬件设计方案4.1 stm32 主控4.2 温度采集模块4.3 甲醛浓度检测模块4.4 PM2. 5 浓度检测模块4.5 液晶显示模块设计4.6 GSM 模块4.7 蓝牙模块 5 软件部分设计5.1 初始化5.2 温湿度检测程序设计5.3 甲醛浓度检测程序设计5.4 PM2. 5 浓度检测程序设计5.5 短信发送程序设计 效果展示6 项目源码6.1 ADC部分6.2 DS18B206.3 RTC部分6.4 main部分 7 最后 1 简介 Hi，大家好，学长今天向大家介绍一个 单片机项目
基于STM32的空气质量检测仪
大家可用于 课程设计 或 毕业设计
2 系统设计概述 如今人们大约 80%的时间是在室内度过的， 室内空气质量与我们每个人的工作和生活都息息相关， 因此对生活环境的空气质量提出了更高的要求。 针对雾霾、 室内装修等污染问题， 人们还没有有效的办法控制空气中的有害物质， 这一问题也成为人们的健康隐患， 因此对室内的空气质量进行检测至关重要。
当室内有害气体的浓度超标时， 会对人们的身心健康带来不可忽视的影响。 为了让人们及时准确地获得室内有害气体甲醛、 PM2.5 的浓度， 采取有效措施改善生活环境的空气质量， 提高工作效率。 根据我国室内空气监管标准 GB50325-2010， 学长设计了一款基于STM32F103C8T6 单片机的便携式、 低功耗室内空气质量检测仪。 该检测仪可以实时测量室内的温湿度、 甲醛浓度、 PM2.5 浓度， 并在液晶显示屏 LCD12864 上实时显示出来， 当甲醛浓度或 PM2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c18754cb09c6cf60d71df449bdb75f09/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-27T11:37:41+08:00" />
<meta property="article:modified_time" content="2022-12-27T11:37:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">毕业设计 STM32空气质量检测仪 - 单片机 嵌入式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__4" rel="nofollow">1 简介</a></li><li><a href="#2__13" rel="nofollow">2 系统设计概述</a></li><li><a href="#3__23" rel="nofollow">3 系统总体方案</a></li><li><a href="#4__33" rel="nofollow">4 硬件设计方案</a></li><li><ul><li><a href="#41_stm32__39" rel="nofollow">4.1 stm32 主控</a></li><li><a href="#42__44" rel="nofollow">4.2 温度采集模块</a></li><li><a href="#43__51" rel="nofollow">4.3 甲醛浓度检测模块</a></li><li><a href="#44_PM2_5__64" rel="nofollow">4.4 PM2. 5 浓度检测模块</a></li><li><a href="#45__74" rel="nofollow">4.5 液晶显示模块设计</a></li><li><a href="#46_GSM__78" rel="nofollow">4.6 GSM 模块</a></li><li><a href="#47__83" rel="nofollow">4.7 蓝牙模块</a></li></ul> 
  </li><li><a href="#5__92" rel="nofollow">5 软件部分设计</a></li><li><ul><li><a href="#51__97" rel="nofollow">5.1 初始化</a></li><li><a href="#52__102" rel="nofollow">5.2 温湿度检测程序设计</a></li><li><a href="#53__107" rel="nofollow">5.3 甲醛浓度检测程序设计</a></li><li><a href="#54_PM2_5__112" rel="nofollow">5.4 PM2. 5 浓度检测程序设计</a></li><li><a href="#55__123" rel="nofollow">5.5 短信发送程序设计</a></li></ul> 
  </li><li><a href="#_129" rel="nofollow">效果展示</a></li><li><a href="#6__142" rel="nofollow">6 项目源码</a></li><li><ul><li><a href="#61_ADC_143" rel="nofollow">6.1 ADC部分</a></li><li><a href="#62_DS18B20_218" rel="nofollow">6.2 DS18B20</a></li><li><a href="#63_RTC_371" rel="nofollow">6.3 RTC部分</a></li><li><a href="#64_main_585" rel="nofollow">6.4 main部分</a></li></ul> 
  </li><li><a href="#7__745" rel="nofollow">7 最后</a></li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="1__4"></a>1 简介</h2> 
<p>Hi，大家好，学长今天向大家介绍一个 单片机项目</p> 
<p><strong>基于STM32的空气质量检测仪</strong></p> 
<p>大家可用于 课程设计 或 毕业设计</p> 
<h2><a id="2__13"></a>2 系统设计概述</h2> 
<p>如今人们大约 80%的时间是在室内度过的， 室内空气质量与我们每个人的工作和生活都息息相关， 因此对生活环境的空气质量提出了更高的要求。 针对雾霾、 室内装修等污染问题， 人们还没有有效的办法控制空气中的有害物质， 这一问题也成为人们的健康隐患， 因此对室内的空气质量进行检测至关重要。</p> 
<p>当室内有害气体的浓度超标时， 会对人们的身心健康带来不可忽视的影响。 为了让人们及时准确地获得室内有害气体甲醛、 PM2.5 的浓度， 采取有效措施改善生活环境的空气质量， 提高工作效率。 根据我国室内空气监管标准 GB50325-2010， 学长设计了一款基于STM32F103C8T6 单片机的便携式、 低功耗室内空气质量检测仪。 该检测仪可以实时测量室内的温湿度、 甲醛浓度、 PM2.5 浓度， 并在液晶显示屏 LCD12864 上实时显示出来， 当甲醛浓度或 PM2.5 浓度超过报警值时， 测试仪通过亮红灯和蜂鸣器鸣叫的方式提醒用户室内有害气体超标。</p> 
<p>用户可以根据需要通过 GSM 短信方式将室内空气质量情况发送到移动终端， 最后系统在 Visual Studio 2012 平台运用 C#语言开发上位机， 可以实时显示空气质量指标。</p> 
<p><img src="https://images2.imgbox.com/56/88/IKSqCvor_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3__23"></a>3 系统总体方案</h2> 
<p>学长设计为了能够实时检测室内的空气质量情况， 提高系统的稳定性和自动化程度， 将系统分为硬件设计和软件设计。 本文研制的室内 空气质 量检测仪是基于 32 位单片机STM32C8T6 进行设计的， 将整个系统模块化， 主要包括 STM32 最小系统、 温湿度检测模块、 甲醛气体检测模块、 PM2.5 检测模块、 按键、 液晶显示器、 蜂鸣器、 GSM 模块、蓝牙模块、 移动终端和上位机以及电源管理电路。 其系统结构框图如图所示。</p> 
<p><img src="https://images2.imgbox.com/ab/87/Su7twePN_o.png" alt="在这里插入图片描述"></p> 
<p>在整个室内空气质量检测系统中， STM32 芯片是整个系统的主控制器， 整个检测系统都是在它的控制下完成的， 并且 STM32 为测试仪提供外部接口， 如液晶显示屏、<br> 按键、 数据采集电路。 首先通过温湿度、 甲醛浓度以及 PM2.5 等传感器进行温湿度、 甲醛气体及 PM2.5 浓度信号采集， 再将采集到的信号送至中央处理单元 STM32 单片机进行信号转换、 放大和处理。 通过库函数编程控制检测系统的工作流程， 可以通过按键输入控制输出显示不同的测量数据以及设置甲醛和 PM2.5 浓度报警值， 当气体浓度值超过报警值时， 通过蜂鸣器鸣叫的方式提醒用户室内有害气体超标， 并在液晶屏上实时显示。利用 GSM 通信模块可以通过短信的形式将用户室内的空气质量情况发到移动终端， 实现了仪器的智能化。 STM32 最小系统通过蓝牙模块与上位机通信， 上位机可以实时显示测量数据。</p> 
<h2><a id="4__33"></a>4 硬件设计方案</h2> 
<p>学长设计的系统所研究的室内空气质量检测仪， 系统硬件由 STM32 单片机、 电源、 温湿度传感器、 甲醛检测模块、 PM2. 5 检测模块、 按键输入模块、 液晶显示模块、 报警电路、 GSM短信接收模块和蓝牙模块等部分组成。 该系统采用 USB 供电， 通过 USB 数据线与电脑USB 接口相连， 输出+5V 的直流电压， 输出电压在 500mA 左右， 在目前普遍采用 USB接口的情况， 这样也提高了电源的来源以及可靠性， 用户也可以通过手机充电器、 充电宝对测试仪供电， 给用户使用该测试仪带来了很大的便利 模块化的设计可以使系统设计更加简单， 系统功耗降低， 操作变得简单， 可以进行现场检测， 通过液晶显示屏用户直观地读出测量数据。 空气质量检测仪检的整体硬件设计结构如下图所示。</p> 
<p><img src="https://images2.imgbox.com/8f/90/ORUoOUZD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="41_stm32__39"></a>4.1 stm32 主控</h3> 
<p>STM32C8T6(最小核心板)，当然，用其他型号的32，如STM32ZET6也是可以的。</p> 
<p><img src="https://images2.imgbox.com/67/94/qQutYru2_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="42__44"></a>4.2 温度采集模块</h3> 
<p>系统采用的传感器为含有已校准数字信号输出的温湿度复合传感器 DHT11。该传感器是一款已经得到业界广泛认可的安全性高、 稳定性较强、 性价比高的集中数字化传感器的温湿度。</p> 
<p>传感器可以传输信号高达 20 米以上， 可以满足大部分场合的测量要求；具有四针的单排引脚封装系统， 这样外部连接就变得简单； 同时因其超小的体积和极低的功耗在暖通空调、 汽车、 气象站、 除湿器等各行业广泛应用。</p> 
<p><img src="https://images2.imgbox.com/05/4b/X3oKUKnm_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="43__51"></a>4.3 甲醛浓度检测模块</h3> 
<p>综合考虑甲醛检测精度和测量成本后， 系统选用 ZE08-CH 2 O 电化学甲醛传感器检测室内空气中的甲醛浓度含量， 因该模块精度高、 功耗低，体积小的特点， 成为了制作空气质量检测仪、 空气净化器的优良器件。 相比其他甲醛</p> 
<p>传感器主要有以下特点 ：</p> 
<ul><li>（1） 分辨率和灵敏度高；</li><li>（2） 功耗低、 使用寿命长；</li><li>（2） UART、 模拟电压信号、 PWM 等多方式输出；</li><li>（3） 具有优秀的抗干扰性、 稳定性高；</li><li>（4） 内置温度补偿单元， 线性输出。</li></ul> 
<p><img src="https://images2.imgbox.com/10/9e/HPsVUjKj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="44_PM2_5__64"></a>4.4 PM2. 5 浓度检测模块</h3> 
<p>系统选用夏普公司授权弘成基科技有限公司生产的型号为 YW-51GJ 的 PM2.5 气敏粉尘传感器， 该产品主要针对香烟颗粒、 细微颗粒等特别细微的颗粒等检测对象， 通过脉冲高度来判断细颗粒物浓度， 常用于空气净化器、 车载空气净化系统以及民用空气质量检测系统中， 符合本系统的设计要求。</p> 
<p>YW-51GJ PM2.5 粉尘传感器实物图如图所示。</p> 
<p><img src="https://images2.imgbox.com/61/8e/fqucBNFl_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到该 PM2.5 传感器中间有一个圆孔， 其内部安装红外线发光二极管和光电晶体管， 当微小颗粒物进入传感器的圆孔内时， 根据微小颗粒物对光的散射原理， 当细颗粒物（PM2.5） 经过传感器内部的检测孔时会对光线形成散射作用。 部分光线通过光轴，经过透镜后聚焦到感光元件上， 光信号经过感光元件转换为电信号输出。</p> 
<h3><a id="45__74"></a>4.5 液晶显示模块设计</h3> 
<p><img src="https://images2.imgbox.com/77/b8/qMgze86D_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="46_GSM__78"></a>4.6 GSM 模块</h3> 
<p>经综合考虑学长选用了 SIM800C GSM 无线通信模块， 这是 SIMCOM 公司生产的基于 MT6261 芯片平台的新一代 GSM 模块， 性价比高， 支持蓝牙功能， 支持 51、MSP430、STM32 等主流单片机开发 。</p> 
<p>在该模块中， 通信接口为 TTL 电平串口， 引出四根排针与控制器通信。 在 IPX 天线接口连接通信天线， Micro-SIM 卡卡座可以插入移动、 联通和物联网卡， 插入 SIM 卡即可发信息给用户移动终端， SIM 卡插进去听到“咔哒” 响声表明插卡正确， SIM800C GSM 模块实物图如图所示。<br> <img src="https://images2.imgbox.com/30/49/Euo1C75v_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="47__83"></a>4.7 蓝牙模块</h3> 
<p>为了能够实现测试仪与上位机的通信， 本文采用的是 HC-05 嵌入式蓝牙串口通信模块[65] ， 分为两个小模块 a、 b， 如下图所示依次左右排列， 模块 a 与通过 USB 接口与电脑相连， 模块 b 通过四根排母线与测试仪对应的排针相连接。</p> 
<p><img src="https://images2.imgbox.com/33/1c/AFTq10Fp_o.png" alt="在这里插入图片描述"></p> 
<p>为了实现主控制器 STM32 与蓝牙模块的连接， 通过导线连接对应接口， 蓝牙接口电路原理图如图所示。</p> 
<p><img src="https://images2.imgbox.com/57/83/jlQ9a98o_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="5__92"></a>5 软件部分设计</h2> 
<p>系统主要实现温湿度、 甲醛浓度以及 PM2.5 浓度的检测与显示功能， 通过传感器不断采集数据， 同时对这些数据进行处理、 修正和补偿， 将数据转换为温湿度以及气体浓度进行显示， 让用户可以知道室内的空气质量。 与硬件系统一样分模块设计， 软件设计分成人机交互模块和数据处理模块两部分</p> 
<p><img src="https://images2.imgbox.com/d6/98/aBeEZFm5_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="51__97"></a>5.1 初始化</h3> 
<p>系统上电后， 先对系统的各模块传感器、 12864LCD 显示屏、 按键等外设进行初始化， 设置标志位和定时器。 之后读取温湿度、 甲醛浓度、 PM2.5 浓度对应的模拟电流电压等电信号参数值， 将数据进行 AD 转换， 对数字量处理后转换为对应的温湿度、 甲醛浓度、 PM2.5 浓度显示出来。 软件设计的主程序流程图下图所示。</p> 
<p><img src="https://images2.imgbox.com/cd/c9/3idMEcol_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="52__102"></a>5.2 温湿度检测程序设计</h3> 
<p>DHT11 温湿度传感器硬件设计可以知道温湿度检测电路连接十分简单，DHT11 通过引脚 2（DATA） 给 STM32 发送单总线数字信号。 在电路开始工作的时候，为了跳过不稳定状态， DHT11 需要用一秒的时间不发任何指令。<br> <img src="https://images2.imgbox.com/22/19/E9QJbDZo_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="53__107"></a>5.3 甲醛浓度检测程序设计</h3> 
<p>由甲醛硬件模块设计可以知道本系统采用 ZE08-CH2O 电化学甲醛传感器采集甲醛浓度信号， 利用系统 STM32 单片机自带的 2 个 AD 转换器对甲醛浓度进行采集， 这些AD 转换器具有 10 个通道， 可以单独使用， 也可以实现复用。</p> 
<p><img src="https://images2.imgbox.com/19/2a/V78MfgIK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="54_PM2_5__112"></a>5.4 PM2. 5 浓度检测程序设计</h3> 
<p>章 PM2.5 硬件设计可以知道系统选用了 YM-51 PM2.5 传感器， 通过该模块可以对室内 PM2.5 浓度测量， 传感器通过 RXD 向 STM32 发送数据， 接线图如下所示</p> 
<p><img src="https://images2.imgbox.com/86/3a/b39zC70m_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ec/75/xlZCZZgG_o.png" alt="在这里插入图片描述"></p> 
<p>PM2.5 浓度检测软件程序流程与甲醛浓度检测流程类似， 首先关闭中断， 再对与PM2.5 检测模块相关的时钟、 AD 转换器进行初始化设置， 确定 AD 转换器的工作模式、触发方式等。 之后打开中断在中断服务程序中实现数据采集， 1 秒内采集 10 次， 对这些数据采用限幅平均滤波法进行软件滤波， 去除因电路干扰产生干扰有效数据的毛刺。</p> 
<h3><a id="55__123"></a>5.5 短信发送程序设计</h3> 
<p>章 GSM 模块硬件设计可知本文采用 SIM800C GSM 模块实现短信收发的功能。 手机短消息主要采用 PDU（协议数据单元） 模式和 TEXT 模式， PDU 模式同时支持中文和英文短信， 而 TEXT 模式只支持英文短信</p> 
<p><img src="https://images2.imgbox.com/1d/f9/6cAVvTKA_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_129"></a>效果展示</h2> 
<p>设计好各个模块原理图， 然后制作出 PCB 板， 通过导线将各个模块与系统主板连接， 室内空气质量检测检测仪实物图如下所示。<br> <img src="https://images2.imgbox.com/93/b2/QW26zMha_o.png" alt="在这里插入图片描述"></p> 
<p><strong>室内空气质量实时显示</strong><br> <img src="https://images2.imgbox.com/2f/c7/SoatYUhE_o.png" alt="在这里插入图片描述"></p> 
<p><strong>短信收发测试</strong><br> <img src="https://images2.imgbox.com/75/45/nLNFZLCr_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="6__142"></a>6 项目源码</h2> 
<h3><a id="61_ADC_143"></a>6.1 ADC部分</h3> 
<pre><code class="prism language-c"> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token comment">//初始化ADC</span>
<span class="token comment">//这里我们仅以规则通道为例</span>
<span class="token comment">//我们默认将开启通道0~3																	   </span>
<span class="token keyword">void</span>  <span class="token function">Adc_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 	
	ADC_InitTypeDef ADC_InitStructure<span class="token punctuation">;</span> 
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>

	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA <span class="token operator">|</span>RCC_APB2Periph_ADC1	<span class="token punctuation">,</span> ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span>	  <span class="token comment">//使能ADC1通道时钟</span>
 

	<span class="token function">RCC_ADCCLKConfig</span><span class="token punctuation">(</span>RCC_PCLK2_Div6<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//设置ADC分频因子6 72M/6=12,ADC最大时间不能超过14M</span>

	<span class="token comment">//PA1 作为模拟通道输入引脚                         </span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_1<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AIN<span class="token punctuation">;</span>		<span class="token comment">//模拟输入引脚</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>	

	<span class="token function">ADC_DeInit</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//复位ADC1,将外设 ADC1 的全部寄存器重设为缺省值</span>

	ADC_InitStructure<span class="token punctuation">.</span>ADC_Mode <span class="token operator">=</span> ADC_Mode_Independent<span class="token punctuation">;</span>	<span class="token comment">//ADC工作模式:ADC1和ADC2工作在独立模式</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_ScanConvMode <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>	<span class="token comment">//模数转换工作在单通道模式</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_ContinuousConvMode <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>	<span class="token comment">//模数转换工作在单次转换模式</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_ExternalTrigConv <span class="token operator">=</span> ADC_ExternalTrigConv_None<span class="token punctuation">;</span>	<span class="token comment">//转换由软件而不是外部触发启动</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_DataAlign <span class="token operator">=</span> ADC_DataAlign_Right<span class="token punctuation">;</span>	<span class="token comment">//ADC数据右对齐</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_NbrOfChannel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//顺序进行规则转换的ADC通道的数目</span>
	<span class="token function">ADC_Init</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//根据ADC_InitStruct中指定的参数初始化外设ADCx的寄存器   </span>

  
	<span class="token function">ADC_Cmd</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能指定的ADC1</span>
	
	<span class="token function">ADC_ResetCalibration</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能复位校准  </span>
	 
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">ADC_GetResetCalibrationStatus</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待复位校准结束</span>
	
	<span class="token function">ADC_StartCalibration</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">//开启AD校准</span>
 
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">ADC_GetCalibrationStatus</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">//等待校准结束</span>
 
<span class="token comment">//	ADC_SoftwareStartConvCmd(ADC1, ENABLE);		//使能指定的ADC1的软件转换启动功能</span>

<span class="token punctuation">}</span>				  
<span class="token comment">//获得ADC值</span>
<span class="token comment">//ch:通道值 0~3</span>
u16 <span class="token function">Get_Adc</span><span class="token punctuation">(</span>u8 ch<span class="token punctuation">)</span>   
<span class="token punctuation">{<!-- --></span>
  	<span class="token comment">//设置指定ADC的规则组通道，一个序列，采样时间</span>
	<span class="token function">ADC_RegularChannelConfig</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ADC_SampleTime_239Cycles5 <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//ADC1,ADC通道,采样时间为239.5周期	  			    </span>
  
	<span class="token function">ADC_SoftwareStartConvCmd</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//使能指定的ADC1的软件转换启动功能	</span>
	 
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ADC_GetFlagStatus</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_FLAG_EOC <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待转换结束</span>

	<span class="token keyword">return</span> <span class="token function">ADC_GetConversionValue</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//返回最近一次ADC1规则组的转换结果</span>
<span class="token punctuation">}</span>

u16 <span class="token function">Get_Adc_Average</span><span class="token punctuation">(</span>u8 ch<span class="token punctuation">,</span>u8 times<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 temp_val<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 t<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>times<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		temp_val<span class="token operator">+=</span><span class="token function">Get_Adc</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> temp_val<span class="token operator">/</span>times<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 	 

</code></pre> 
<h3><a id="62_DS18B20_218"></a>6.2 DS18B20</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ds18b20.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span>	</span>

<span class="token comment">//复位DS18B20</span>
<span class="token keyword">void</span> <span class="token function">DS18B20_Rst</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	   
<span class="token punctuation">{<!-- --></span>                 
	<span class="token function">DS18B20_IO_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//SET PA0 OUTPUT</span>
    DS18B20_DQ_OUT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//拉低DQ</span>
    <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">750</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//拉低750us</span>
    DS18B20_DQ_OUT<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//DQ=1 </span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//15US</span>
<span class="token punctuation">}</span>
<span class="token comment">//等待DS18B20的回应</span>
<span class="token comment">//返回1:未检测到DS18B20的存在</span>
<span class="token comment">//返回0:存在</span>
u8 <span class="token function">DS18B20_Check</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 	   
<span class="token punctuation">{<!-- --></span>   
	u8 retry<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">DS18B20_IO_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SET PA0 INPUT	 </span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>DS18B20_DQ_IN<span class="token operator">&amp;&amp;</span>retry<span class="token operator">&lt;</span><span class="token number">200</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		retry<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>	 
	<span class="token keyword">if</span><span class="token punctuation">(</span>retry<span class="token operator">&gt;=</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> retry<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>DS18B20_DQ_IN<span class="token operator">&amp;&amp;</span>retry<span class="token operator">&lt;</span><span class="token number">240</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		retry<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>retry<span class="token operator">&gt;=</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>	    
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//从DS18B20读取一个位</span>
<span class="token comment">//返回值：1/0</span>
u8 <span class="token function">DS18B20_Read_Bit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 			 <span class="token comment">// read one bit</span>
<span class="token punctuation">{<!-- --></span>
    u8 data<span class="token punctuation">;</span>
	<span class="token function">DS18B20_IO_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SET PA0 OUTPUT</span>
    DS18B20_DQ_OUT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DS18B20_DQ_OUT<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
	<span class="token function">DS18B20_IO_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SET PA0 INPUT</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>DS18B20_DQ_IN<span class="token punctuation">)</span>data<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> data<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	 
    <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//从DS18B20读取一个字节</span>
<span class="token comment">//返回值：读到的数据</span>
u8 <span class="token function">DS18B20_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>    <span class="token comment">// read one byte</span>
<span class="token punctuation">{<!-- --></span>        
    u8 i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>dat<span class="token punctuation">;</span>
    dat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
        j<span class="token operator">=</span><span class="token function">DS18B20_Read_Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dat<span class="token operator">=</span><span class="token punctuation">(</span>j<span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>dat<span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>						    
    <span class="token keyword">return</span> dat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//写一个字节到DS18B20</span>
<span class="token comment">//dat：要写入的字节</span>
<span class="token keyword">void</span> <span class="token function">DS18B20_Write_Byte</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span>     
 <span class="token punctuation">{<!-- --></span>             
    u8 j<span class="token punctuation">;</span>
    u8 testb<span class="token punctuation">;</span>
	<span class="token function">DS18B20_IO_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SET PA0 OUTPUT;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;=</span><span class="token number">8</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
        testb<span class="token operator">=</span>dat<span class="token operator">&amp;</span><span class="token number">0x01</span><span class="token punctuation">;</span>
        dat<span class="token operator">=</span>dat<span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>testb<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            DS18B20_DQ_OUT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// Write 1</span>
            <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            
            DS18B20_DQ_OUT<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> 
        <span class="token punctuation">{<!-- --></span>
            DS18B20_DQ_OUT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// Write 0</span>
            <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
            DS18B20_DQ_OUT<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//开始温度转换</span>
<span class="token keyword">void</span> <span class="token function">DS18B20_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">// ds1820 start convert</span>
<span class="token punctuation">{<!-- --></span>   						               
    <span class="token function">DS18B20_Rst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
	<span class="token function">DS18B20_Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
    <span class="token function">DS18B20_Write_Byte</span><span class="token punctuation">(</span><span class="token number">0xcc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// skip rom</span>
    <span class="token function">DS18B20_Write_Byte</span><span class="token punctuation">(</span><span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// convert</span>
<span class="token punctuation">}</span> 
<span class="token comment">//初始化DS18B20的IO口 DQ 同时检测DS的存在</span>
<span class="token comment">//返回1:不存在</span>
<span class="token comment">//返回0:存在    	 </span>
u8 <span class="token function">DS18B20_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 	GPIO_InitTypeDef  GPIO_InitStructure<span class="token punctuation">;</span>
 	
 	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">//使能PORTA口时钟 </span>
	
 	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_0<span class="token punctuation">;</span>				<span class="token comment">//PORTA0 推挽输出</span>
 	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span> 		  
 	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
 	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

 	<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span>GPIO_Pin_0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//输出1</span>

	<span class="token function">DS18B20_Rst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token function">DS18B20_Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  
<span class="token comment">//从ds18b20得到温度值</span>
<span class="token comment">//精度：0.1C</span>
<span class="token comment">//返回值：温度值 （-550~1250） </span>
<span class="token keyword">short</span> <span class="token function">DS18B20_Get_Temp</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 temp<span class="token punctuation">;</span>
    u8 TL<span class="token punctuation">,</span>TH<span class="token punctuation">;</span>
	<span class="token keyword">short</span> tem<span class="token punctuation">;</span>
    <span class="token function">DS18B20_Start</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// ds1820 start convert</span>
    <span class="token function">DS18B20_Rst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DS18B20_Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
    <span class="token function">DS18B20_Write_Byte</span><span class="token punctuation">(</span><span class="token number">0xcc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// skip rom</span>
    <span class="token function">DS18B20_Write_Byte</span><span class="token punctuation">(</span><span class="token number">0xbe</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// convert	    </span>
    TL<span class="token operator">=</span><span class="token function">DS18B20_Read_Byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// LSB   </span>
    TH<span class="token operator">=</span><span class="token function">DS18B20_Read_Byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// MSB  </span>
	    	  
    <span class="token keyword">if</span><span class="token punctuation">(</span>TH<span class="token operator">&gt;</span><span class="token number">7</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        TH<span class="token operator">=</span><span class="token operator">~</span>TH<span class="token punctuation">;</span>
        TL<span class="token operator">=</span><span class="token operator">~</span>TL<span class="token punctuation">;</span> 
        temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//温度为负  </span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> temp<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//温度为正	  	  </span>
    tem<span class="token operator">=</span>TH<span class="token punctuation">;</span> <span class="token comment">//获得高八位</span>
    tem<span class="token operator">&lt;&lt;=</span><span class="token number">8</span><span class="token punctuation">;</span>    
    tem<span class="token operator">+=</span>TL<span class="token punctuation">;</span><span class="token comment">//获得底八位</span>
    tem<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>tem<span class="token operator">*</span><span class="token number">0.625</span><span class="token punctuation">;</span><span class="token comment">//转换     </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token keyword">return</span> tem<span class="token punctuation">;</span> <span class="token comment">//返回温度值</span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token operator">-</span>tem<span class="token punctuation">;</span>    
<span class="token punctuation">}</span> 

</code></pre> 
<h3><a id="63_RTC_371"></a>6.3 RTC部分</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rtc.h"</span> 		    </span>
<span class="token comment">//Mini STM32开发板</span>
<span class="token comment">//RTC实时时钟 驱动代码			 </span>
<span class="token comment">//正点原子@ALIENTEK</span>
<span class="token comment">//2010/6/6</span>
	   
_calendar_obj calendar<span class="token punctuation">;</span><span class="token comment">//时钟结构体 </span>
 
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">RTC_NVIC_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
    NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> RTC_IRQn<span class="token punctuation">;</span>		<span class="token comment">//RTC全局中断</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//先占优先级1位,从优先级3位</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//先占优先级0位,从优先级4位</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>		<span class="token comment">//使能该通道中断</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//根据NVIC_InitStruct中指定的参数初始化外设NVIC寄存器</span>
<span class="token punctuation">}</span>

<span class="token comment">//实时时钟配置</span>
<span class="token comment">//初始化RTC时钟,同时检测时钟是否工作正常</span>
<span class="token comment">//BKP-&gt;DR1用于保存是否第一次配置的设置</span>
<span class="token comment">//返回0:正常</span>
<span class="token comment">//其他:错误代码</span>

u8 <span class="token function">RTC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//检查是不是第一次配置时钟</span>
	u8 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_PWR <span class="token operator">|</span> RCC_APB1Periph_BKP<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能PWR和BKP外设时钟   </span>
	<span class="token function">PWR_BackupAccessCmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能后备寄存器访问  </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">BKP_ReadBackupRegister</span><span class="token punctuation">(</span>BKP_DR1<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x5050</span><span class="token punctuation">)</span>		<span class="token comment">//从指定的后备寄存器中读出数据:读出了与写入的指定数据不相乎</span>
		<span class="token punctuation">{<!-- --></span>	 			

		<span class="token function">BKP_DeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//复位备份区域 	</span>
		<span class="token function">RCC_LSEConfig</span><span class="token punctuation">(</span>RCC_LSE_ON<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置外部低速晶振(LSE),使用外设低速晶振</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">RCC_GetFlagStatus</span><span class="token punctuation">(</span>RCC_FLAG_LSERDY<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span>	<span class="token comment">//检查指定的RCC标志位设置与否,等待低速晶振就绪</span>
			<span class="token punctuation">{<!-- --></span>
			temp<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//初始化时钟失败,晶振有问题	    </span>
		<span class="token function">RCC_RTCCLKConfig</span><span class="token punctuation">(</span>RCC_RTCCLKSource_LSE<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//设置RTC时钟(RTCCLK),选择LSE作为RTC时钟    </span>
		<span class="token function">RCC_RTCCLKCmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能RTC时钟  </span>
		<span class="token function">RTC_WaitForLastTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待最近一次对RTC寄存器的写操作完成</span>
		<span class="token function">RTC_WaitForSynchro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//等待RTC寄存器同步  </span>
		<span class="token function">RTC_ITConfig</span><span class="token punctuation">(</span>RTC_IT_SEC<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//使能RTC秒中断</span>
		<span class="token function">RTC_WaitForLastTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待最近一次对RTC寄存器的写操作完成</span>
		<span class="token function">RTC_EnterConfigMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/// 允许配置	</span>
		<span class="token function">RTC_SetPrescaler</span><span class="token punctuation">(</span><span class="token number">32767</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置RTC预分频的值</span>
		<span class="token function">RTC_WaitForLastTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待最近一次对RTC寄存器的写操作完成</span>
		<span class="token function">RTC_Set</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//设置时间	</span>
		<span class="token function">RTC_ExitConfigMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退出配置模式  </span>
		<span class="token function">BKP_WriteBackupRegister</span><span class="token punctuation">(</span>BKP_DR1<span class="token punctuation">,</span> <span class="token number">0X5050</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//向指定的后备寄存器中写入用户程序数据</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token comment">//系统继续计时</span>
		<span class="token punctuation">{<!-- --></span>

		<span class="token function">RTC_WaitForSynchro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待最近一次对RTC寄存器的写操作完成</span>
		<span class="token function">RTC_ITConfig</span><span class="token punctuation">(</span>RTC_IT_SEC<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能RTC秒中断</span>
		<span class="token function">RTC_WaitForLastTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待最近一次对RTC寄存器的写操作完成</span>
		<span class="token punctuation">}</span>
	<span class="token function">RTC_NVIC_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//RCT中断分组设置		    				     </span>
	<span class="token function">RTC_Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新时间	</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//ok</span>

<span class="token punctuation">}</span>		 				    
<span class="token comment">//RTC时钟中断</span>
<span class="token comment">//每秒触发一次  </span>
<span class="token comment">//extern u16 tcnt; </span>
<span class="token keyword">void</span> <span class="token function">RTC_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">RTC_GetITStatus</span><span class="token punctuation">(</span>RTC_IT_SEC<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token comment">//秒钟中断</span>
	<span class="token punctuation">{<!-- --></span>							
		<span class="token function">RTC_Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新时间   </span>
 	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">RTC_GetITStatus</span><span class="token punctuation">(</span>RTC_IT_ALR<span class="token punctuation">)</span><span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token comment">//闹钟中断</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">RTC_ClearITPendingBit</span><span class="token punctuation">(</span>RTC_IT_ALR<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//清闹钟中断	  	   </span>
  	<span class="token punctuation">}</span> 				  								 
	<span class="token function">RTC_ClearITPendingBit</span><span class="token punctuation">(</span>RTC_IT_SEC<span class="token operator">|</span>RTC_IT_OW<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//清闹钟中断</span>
	<span class="token function">RTC_WaitForLastTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  	    						 	   	 
<span class="token punctuation">}</span>
<span class="token comment">//判断是否是闰年函数</span>
<span class="token comment">//月份   1  2  3  4  5  6  7  8  9  10 11 12</span>
<span class="token comment">//闰年   31 29 31 30 31 30 31 31 30 31 30 31</span>
<span class="token comment">//非闰年 31 28 31 30 31 30 31 31 30 31 30 31</span>
<span class="token comment">//输入:年份</span>
<span class="token comment">//输出:该年份是不是闰年.1,是.0,不是</span>
u8 <span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>u16 year<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>			  
	<span class="token keyword">if</span><span class="token punctuation">(</span>year<span class="token operator">%</span><span class="token number">4</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//必须能被4整除</span>
	<span class="token punctuation">{<!-- --></span> 
		<span class="token keyword">if</span><span class="token punctuation">(</span>year<span class="token operator">%</span><span class="token number">100</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span> 
			<span class="token keyword">if</span><span class="token punctuation">(</span>year<span class="token operator">%</span><span class="token number">400</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果以00结尾,还要能被400整除 	   </span>
			<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>   
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>	 			   
<span class="token comment">//设置时钟</span>
<span class="token comment">//把输入的时钟转换为秒钟</span>
<span class="token comment">//以1970年1月1日为基准</span>
<span class="token comment">//1970~2099年为合法年份</span>
<span class="token comment">//返回值:0,成功;其他:错误代码.</span>
<span class="token comment">//月份数据表											 </span>
u8 <span class="token keyword">const</span> table_week<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//月修正数据表	  </span>
<span class="token comment">//平年的月份日期表</span>
<span class="token keyword">const</span> u8 mon_table<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 <span class="token function">RTC_Set</span><span class="token punctuation">(</span>u16 syear<span class="token punctuation">,</span>u8 smon<span class="token punctuation">,</span>u8 sday<span class="token punctuation">,</span>u8 hour<span class="token punctuation">,</span>u8 min<span class="token punctuation">,</span>u8 sec<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u16 t<span class="token punctuation">;</span>
	u32 seccount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>syear<span class="token operator">&lt;</span><span class="token number">1970</span><span class="token operator">||</span>syear<span class="token operator">&gt;</span><span class="token number">2099</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>	   
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">1970</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>syear<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//把所有年份的秒钟相加</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>seccount<span class="token operator">+=</span><span class="token number">31622400</span><span class="token punctuation">;</span><span class="token comment">//闰年的秒钟数</span>
		<span class="token keyword">else</span> seccount<span class="token operator">+=</span><span class="token number">31536000</span><span class="token punctuation">;</span>			  <span class="token comment">//平年的秒钟数</span>
	<span class="token punctuation">}</span>
	smon<span class="token operator">-=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>smon<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>	   <span class="token comment">//把前面月份的秒钟数相加</span>
	<span class="token punctuation">{<!-- --></span>
		seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>mon_table<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">86400</span><span class="token punctuation">;</span><span class="token comment">//月份秒钟数相加</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>syear<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>t<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>seccount<span class="token operator">+=</span><span class="token number">86400</span><span class="token punctuation">;</span><span class="token comment">//闰年2月份增加一天的秒钟数	   </span>
	<span class="token punctuation">}</span>
	seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">(</span>sday<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span><span class="token punctuation">;</span><span class="token comment">//把前面日期的秒钟数相加 </span>
	seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>hour<span class="token operator">*</span><span class="token number">3600</span><span class="token punctuation">;</span><span class="token comment">//小时秒钟数</span>
    seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>min<span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">;</span>	 <span class="token comment">//分钟秒钟数</span>
	seccount<span class="token operator">+=</span>sec<span class="token punctuation">;</span><span class="token comment">//最后的秒钟加上去</span>

	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_PWR <span class="token operator">|</span> RCC_APB1Periph_BKP<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能PWR和BKP外设时钟  </span>
	<span class="token function">PWR_BackupAccessCmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能RTC和后备寄存器访问 </span>
	<span class="token function">RTC_SetCounter</span><span class="token punctuation">(</span>seccount<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置RTC计数器的值</span>

	<span class="token function">RTC_WaitForLastTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待最近一次对RTC寄存器的写操作完成  	</span>
	<span class="token function">RTC_Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	    
<span class="token punctuation">}</span>
<span class="token comment">//得到当前的时间</span>
<span class="token comment">//返回值:0,成功;其他:错误代码.</span>
u8 <span class="token function">RTC_Get</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> u16 daycnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u32 timecount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
	u32 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u16 temp1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	  
    timecount<span class="token operator">=</span><span class="token function">RTC_GetCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
 	temp<span class="token operator">=</span>timecount<span class="token operator">/</span><span class="token number">86400</span><span class="token punctuation">;</span>   <span class="token comment">//得到天数(秒钟数对应的)</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>daycnt<span class="token operator">!=</span>temp<span class="token punctuation">)</span><span class="token comment">//超过一天了</span>
	<span class="token punctuation">{<!-- --></span>	  
		daycnt<span class="token operator">=</span>temp<span class="token punctuation">;</span>
		temp1<span class="token operator">=</span><span class="token number">1970</span><span class="token punctuation">;</span>	<span class="token comment">//从1970年开始</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">365</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>				 
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>temp1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//是闰年</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">366</span><span class="token punctuation">)</span>temp<span class="token operator">-=</span><span class="token number">366</span><span class="token punctuation">;</span><span class="token comment">//闰年的秒钟数</span>
				<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>temp1<span class="token operator">++</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>  
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> temp<span class="token operator">-=</span><span class="token number">365</span><span class="token punctuation">;</span>	  <span class="token comment">//平年 </span>
			temp1<span class="token operator">++</span><span class="token punctuation">;</span>  
		<span class="token punctuation">}</span>   
		calendar<span class="token punctuation">.</span>w_year<span class="token operator">=</span>temp1<span class="token punctuation">;</span><span class="token comment">//得到年份</span>
		temp1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token comment">//超过了一个月</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span>w_year<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>temp1<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//当年是不是闰年/2月份</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">29</span><span class="token punctuation">)</span>temp<span class="token operator">-=</span><span class="token number">29</span><span class="token punctuation">;</span><span class="token comment">//闰年的秒钟数</span>
				<span class="token keyword">else</span> <span class="token keyword">break</span><span class="token punctuation">;</span> 
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> 
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span>mon_table<span class="token punctuation">[</span>temp1<span class="token punctuation">]</span><span class="token punctuation">)</span>temp<span class="token operator">-=</span>mon_table<span class="token punctuation">[</span>temp1<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//平年</span>
				<span class="token keyword">else</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			temp1<span class="token operator">++</span><span class="token punctuation">;</span>  
		<span class="token punctuation">}</span>
		calendar<span class="token punctuation">.</span>w_month<span class="token operator">=</span>temp1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//得到月份</span>
		calendar<span class="token punctuation">.</span>w_date<span class="token operator">=</span>temp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>  	<span class="token comment">//得到日期 </span>
	<span class="token punctuation">}</span>
	temp<span class="token operator">=</span>timecount<span class="token operator">%</span><span class="token number">86400</span><span class="token punctuation">;</span>     		<span class="token comment">//得到秒钟数   	   </span>
	calendar<span class="token punctuation">.</span>hour<span class="token operator">=</span>temp<span class="token operator">/</span><span class="token number">3600</span><span class="token punctuation">;</span>     	<span class="token comment">//小时</span>
	calendar<span class="token punctuation">.</span>min<span class="token operator">=</span><span class="token punctuation">(</span>temp<span class="token operator">%</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span><span class="token punctuation">;</span> 	<span class="token comment">//分钟	</span>
	calendar<span class="token punctuation">.</span>sec<span class="token operator">=</span><span class="token punctuation">(</span>temp<span class="token operator">%</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">60</span><span class="token punctuation">;</span> 	<span class="token comment">//秒钟</span>
	calendar<span class="token punctuation">.</span>week<span class="token operator">=</span><span class="token function">RTC_Get_Week</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span>w_year<span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_month<span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_date<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取星期   </span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>	 
<span class="token comment">//获得现在是星期几</span>
<span class="token comment">//功能描述:输入公历日期得到星期(只允许1901-2099年)</span>
<span class="token comment">//输入参数：公历年月日 </span>
<span class="token comment">//返回值：星期号																						 </span>
u8 <span class="token function">RTC_Get_Week</span><span class="token punctuation">(</span>u16 year<span class="token punctuation">,</span>u8 month<span class="token punctuation">,</span>u8 day<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	u16 temp2<span class="token punctuation">;</span>
	u8 yearH<span class="token punctuation">,</span>yearL<span class="token punctuation">;</span>
	
	yearH<span class="token operator">=</span>year<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>	yearL<span class="token operator">=</span>year<span class="token operator">%</span><span class="token number">100</span><span class="token punctuation">;</span> 
	<span class="token comment">// 如果为21世纪,年份数加100  </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>yearH<span class="token operator">&gt;</span><span class="token number">19</span><span class="token punctuation">)</span>yearL<span class="token operator">+=</span><span class="token number">100</span><span class="token punctuation">;</span>
	<span class="token comment">// 所过闰年数只算1900年之后的  </span>
	temp2<span class="token operator">=</span>yearL<span class="token operator">+</span>yearL<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">;</span>
	temp2<span class="token operator">=</span>temp2<span class="token operator">%</span><span class="token number">7</span><span class="token punctuation">;</span> 
	temp2<span class="token operator">=</span>temp2<span class="token operator">+</span>day<span class="token operator">+</span>table_week<span class="token punctuation">[</span>month<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>yearL<span class="token operator">%</span><span class="token number">4</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>month<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>temp2<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">(</span>temp2<span class="token operator">%</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>			  

</code></pre> 
<h3><a id="64_main_585"></a>6.4 main部分</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"math.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ds18b20.h"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rtc.h"</span></span>

   	
 <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span> 
	u16 adcx<span class="token punctuation">;</span>
	<span class="token keyword">float</span> temp<span class="token punctuation">,</span>quality<span class="token punctuation">;</span>
	<span class="token keyword">short</span> temperature<span class="token punctuation">;</span> 
	u8 t<span class="token punctuation">;</span>	
    <span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置中断优先级分组2 </span>
	 
	<span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    	 <span class="token comment">//延时函数初始化	  </span>
	<span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 	 <span class="token comment">//串口初始化为9600</span>
	<span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		  		 <span class="token comment">//初始化与LED连接的硬件接口</span>
 	<span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token function">Adc_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		  		<span class="token comment">//ADC初始化	</span>

	POINT_COLOR<span class="token operator">=</span>BLACK<span class="token punctuation">;</span> 
	<span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">280</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">280</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">160</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">160</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"AIR MONITIRING SYSTEM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">76</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"BASED ON RTOS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"AIR QUALITY:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"HARMFUL GAS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">125</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"CONCENTRATION:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"     PPM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"TEMPERATURE:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">190</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"   . C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	
	<span class="token comment">//LCD_ShowString(10,250,200,16,16,"2020-4-30 16:00");	</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">290</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"STM32F103,MQ135,DS18B20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">DS18B20_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//DS18B20初始化	</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">210</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"DS18B20 Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">LCD_Fill</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">239</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
		
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">RTC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//RTC初始化	，一定要初始化成功</span>
	<span class="token punctuation">{<!-- --></span> 
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"RTC ERROR!   "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"RTC Trying..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>		    						
	<span class="token comment">//显示时间				 </span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"    -  -  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"  :  :  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 	
	<span class="token comment">//显示提示信息</span>
	<span class="token comment">//LCD_ShowString(60,130,200,16,16,"ADC_CH1_VAL:");	      </span>
	<span class="token comment">//LCD_ShowString(60,150,200,16,16,"ADC_CH1_VOL:0.000V");	</span>
    <span class="token comment">//LCD_ShowString(60,170,200,16,16,"KQ_ZHILIANG:    ppm");	</span>
   	 
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		
		adcx<span class="token operator">=</span><span class="token function">Get_Adc_Average</span><span class="token punctuation">(</span>ADC_Channel_1<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//LCD_ShowxNum(156,130,adcx,4,16,0);//显示ADC的值</span>
		temp<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>adcx<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">3.3</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		quality<span class="token operator">=</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">11.5428</span> <span class="token operator">*</span> <span class="token number">35.904</span> <span class="token operator">*</span> temp <span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">25.5</span> <span class="token operator">-</span> <span class="token number">5.1</span> <span class="token operator">*</span> temp<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">0.6549</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		adcx<span class="token operator">=</span>temp<span class="token punctuation">;</span>
		<span class="token comment">//LCD_ShowxNum(156,150,adcx,1,16,0);//显示电压值</span>
		temp<span class="token operator">-=</span>adcx<span class="token punctuation">;</span>
		<span class="token comment">//temp*=1000;</span>
		<span class="token comment">//LCD_ShowxNum(172,150,temp,3,16,0X80);</span>
		<span class="token function">LCD_ShowxNum</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span>quality<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示转化后的PPM值</span>
		<span class="token comment">//根据有害气体浓度判断空气质量</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;=</span> quality <span class="token operator">&amp;&amp;</span> quality <span class="token operator">&lt;=</span><span class="token number">75</span><span class="token punctuation">)</span>
			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token string">"NORMAL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>quality<span class="token operator">&lt;=</span><span class="token number">150</span><span class="token punctuation">)</span>
			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token string">"MILD  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>quality<span class="token operator">&lt;=</span><span class="token number">500</span><span class="token punctuation">)</span>
			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token string">"MIDDLE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> 
			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token string">"SEVERE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
		
		temperature<span class="token operator">=</span><span class="token function">DS18B20_Get_Temp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token keyword">if</span><span class="token punctuation">(</span>temperature<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">LCD_ShowChar</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token operator">+</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token char">'-'</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//显示负号</span>
			temperature<span class="token operator">=</span><span class="token operator">-</span>temperature<span class="token punctuation">;</span>					<span class="token comment">//转为正数</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">LCD_ShowChar</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token operator">+</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token char">' '</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//去掉负号</span>
		<span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">190</span><span class="token punctuation">,</span>temperature<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//显示正数部分	    </span>
   		<span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token operator">+</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">190</span><span class="token punctuation">,</span>temperature<span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//显示小数部分</span>
		
		<span class="token comment">//LCD_ShowString(170,190,290,16,16,"26");//显示温度</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>quality<span class="token operator">&gt;=</span><span class="token number">150</span><span class="token punctuation">)</span> <span class="token comment">//当到达中度污染时红灯闪烁报警</span>
		<span class="token punctuation">{<!-- --></span>
			LED1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
			LED0<span class="token operator">=</span><span class="token operator">!</span>LED0<span class="token punctuation">;</span>
			POINT_COLOR<span class="token operator">=</span>RED<span class="token punctuation">;</span><span class="token comment">//设置字体为红色 </span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			LED0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
			LED1<span class="token operator">=</span><span class="token operator">!</span>LED1<span class="token punctuation">;</span>  <span class="token comment">//正常时绿灯闪烁</span>
			POINT_COLOR<span class="token operator">=</span>BLUE<span class="token punctuation">;</span><span class="token comment">//设置字体为蓝色 </span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">//显示时间</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token operator">!=</span>calendar<span class="token punctuation">.</span>sec<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			POINT_COLOR<span class="token operator">=</span>BLACK<span class="token punctuation">;</span><span class="token comment">//设置字体为黑色</span>
			t<span class="token operator">=</span>calendar<span class="token punctuation">.</span>sec<span class="token punctuation">;</span>
			<span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_year<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>									  
			<span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_month<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>									  
			<span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">74</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_date<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
			
			<span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>hour<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>									  
			<span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">124</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>min<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>									  
			<span class="token function">LCD_ShowNum</span><span class="token punctuation">(</span><span class="token number">148</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>sec<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">switch</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span>week<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
					<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Sunday"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
					<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Monday"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
					<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Tuesday"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
					<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Wednesday"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
					<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Thursday"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
					<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Friday"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
					<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">148</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Saturday "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>  
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>											    
<span class="token punctuation">}</span>	


</code></pre> 
<h2><a id="7__745"></a>7 最后</h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9dc1246c61a16e5346a8f028b0983654/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何实现大文件上传</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/05c374c3ea78a31daf97124acb3eca21/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">aardio网页自动化和窗口自动化的学习</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>