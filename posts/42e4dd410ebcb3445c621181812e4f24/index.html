<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Makefile实战 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Makefile实战" />
<meta property="og:description" content="目录 Makefile实战前言1.介绍2.Makefile文件分析3.Makefile文件修改3.1 定义编译器3.2 定义源文件和目标文件3.3 定义头文件路径、库文件路径和库名称3.4 定义导出和运行时路径3.5 定义编译选项3.6 添加头文件依赖3.7 编译CUDA和C&#43;&#43;程序3.8 其它 4.完整Makefile总结 Makefile实战 前言 学习完了杜老师推荐的Makefile教程视频，链接。来个实战先。
针对https://github.com/shouxieai/infer仓库中的Makefile进行分析和修改，完成该项目在Jetson nano上的编译和运行。
1.介绍 infer框架是杜老师最近推出的全新tensorrt封装，轻易继承各类任务，其优点有
轻易实现各类任务的生产者消费者模型，并进行高性能推理没有复杂的封装，彻底解开耦合！ 除去多余的文件，完整的目录结构如下
src 存放源文件，包括6个文件，分别为cpm.hpp、infer.hpp以及yolo.hpp三个头文件；infer.cu和yolo.cu两个CUDA文件；main.cpp一个源文件 workspace inference 存放待推理的图片 build.sh，脚本文件，利用trtexec工具将ONNX模型编译生成enginev8trans.py，python文件，用于在yolov8的onnx模型中添加transpose节点yolov8n.transd.onnx和yolov8n-seg.b1.transd.onnx为yolov8导出的检测和分割模型 Makefile 说明
我们尽量只关注Makefile文件中的内容，先分析原Makefile内容然后修改满足我们的需求
文件虽然少但是包含的内容多，具体包括C&#43;&#43;和CUDA的混合编程，以及tensorRT和OpenCV等库文件的链接，还是非常值得学习的。
本次使用的设备是Jetson nano嵌入式
对于该项目感兴趣的可以查看如何高效使用TensorRT视频
对于该项目应用在Jetson nano嵌入式感兴趣的可以查看Jetson nano部署YOLOv8
2.Makefile文件分析 首先来看下该仓库的Makefile文件具体内容：
cc := g&#43;&#43; nvcc = /root/.kiwi/lib/cuda-11.8/bin/nvcc include_paths := src \ /root/.kiwi/lib/opencv4.2/include \ /root/.kiwi/lib/TensorRT-8.5.3.1-cuda11x/include \ /root/.kiwi/lib/cuda-11.8/include \ /root/.kiwi/lib/cudnn8.6.0.163-cuda11/lib library_paths := /root/.kiwi/lib/opencv4.2/lib \ /root/.kiwi/lib/TensorRT-8.5.3.1-cuda11x/lib \ /root/.kiwi/lib/cuda-11.8/lib64 \ /root/.kiwi/lib/cudnn8.6.0.163-cuda11/lib link_librarys := opencv_core opencv_imgproc opencv_videoio opencv_imgcodecs \ nvinfer nvinfer_plugin nvonnxparser \ cuda cublas cudart cudnn \ stdc&#43;&#43; dl cppstrict := -Wall -Werror -Wextra -Wno-deprecated-declarations -Wno-unused-parameter custrict := -Werror=all-warnings cpp_compile_flags := -std=c&#43;&#43;11 -fPIC -g -fopenmp $(cppstrict) -O0 cu_compile_flags := -std=c&#43;&#43;11 $(custrict) -O0 -Xcompiler &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/42e4dd410ebcb3445c621181812e4f24/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-27T14:47:22+08:00" />
<meta property="article:modified_time" content="2023-03-27T14:47:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Makefile实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#Makefile_1" rel="nofollow">Makefile实战</a></li><li><ul><li><a href="#_2" rel="nofollow">前言</a></li><li><a href="#1_8" rel="nofollow">1.介绍</a></li><li><a href="#2Makefile_36" rel="nofollow">2.Makefile文件分析</a></li><li><a href="#3Makefile_133" rel="nofollow">3.Makefile文件修改</a></li><li><ul><li><a href="#31__137" rel="nofollow">3.1 定义编译器</a></li><li><a href="#32__149" rel="nofollow">3.2 定义源文件和目标文件</a></li><li><a href="#33__187" rel="nofollow">3.3 定义头文件路径、库文件路径和库名称</a></li><li><a href="#34__223" rel="nofollow">3.4 定义导出和运行时路径</a></li><li><a href="#35__264" rel="nofollow">3.5 定义编译选项</a></li><li><a href="#36__295" rel="nofollow">3.6 添加头文件依赖</a></li><li><a href="#37_CUDAC_308" rel="nofollow">3.7 编译CUDA和C++程序</a></li><li><a href="#38__364" rel="nofollow">3.8 其它</a></li></ul> 
   </li><li><a href="#4Makefile_387" rel="nofollow">4.完整Makefile</a></li><li><a href="#_492" rel="nofollow">总结</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Makefile_1"></a>Makefile实战</h2> 
<h3><a id="_2"></a>前言</h3> 
<blockquote> 
 <p>学习完了杜老师推荐的Makefile教程视频，<a href="https://www.bilibili.com/video/BV1EM41177s1?p=1&amp;vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">链接</a>。来个实战先。</p> 
 <p>针对<a href="https://github.com/shouxieai/infer">https://github.com/shouxieai/infer</a>仓库中的Makefile进行分析和修改，完成该项目在Jetson nano上的编译和运行。</p> 
</blockquote> 
<h3><a id="1_8"></a>1.介绍</h3> 
<p><a href="https://github.com/shouxieai/infer">infer</a>框架是杜老师最近推出的全新tensorrt封装，轻易继承各类任务，其优点有</p> 
<ul><li>轻易实现各类任务的生产者消费者模型，并进行高性能推理</li><li>没有复杂的封装，彻底解开耦合！</li></ul> 
<p>除去多余的文件，完整的目录结构如下</p> 
<ul><li>src 
  <ul><li>存放源文件，包括6个文件，分别为<code>cpm.hpp</code>、<code>infer.hpp</code>以及<code>yolo.hpp</code>三个头文件；<code>infer.cu</code>和<code>yolo.cu</code>两个CUDA文件；<code>main.cpp</code>一个源文件</li></ul> </li><li>workspace 
  <ul><li>inference 
    <ul><li>存放待推理的图片</li></ul> </li><li>build.sh，脚本文件，利用<code>trtexec</code>工具将ONNX模型编译生成engine</li><li>v8trans.py，python文件，用于在yolov8的onnx模型中添加transpose节点</li><li>yolov8n.transd.onnx和yolov8n-seg.b1.transd.onnx为yolov8导出的检测和分割模型</li></ul> </li><li>Makefile</li></ul> 
<p><strong>说明</strong></p> 
<ul><li> <p>我们尽量只关注Makefile文件中的内容，先分析原Makefile内容然后修改满足我们的需求</p> </li><li> <p>文件虽然少但是包含的内容多，具体包括C++和CUDA的混合编程，以及tensorRT和OpenCV等库文件的链接，还是非常值得学习的。</p> </li><li> <p>本次使用的设备是Jetson nano嵌入式</p> </li><li> <p>对于该项目感兴趣的可以查看<a href="https://www.bilibili.com/video/BV1F24y1h7LW/?vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">如何高效使用TensorRT视频</a></p> </li><li> <p>对于该项目应用在Jetson nano嵌入式感兴趣的可以查看<a href="https://blog.csdn.net/qq_40672115/article/details/129640372?spm=1001.2014.3001.5502">Jetson nano部署YOLOv8</a></p> </li></ul> 
<h3><a id="2Makefile_36"></a>2.Makefile文件分析</h3> 
<p>首先来看下该仓库的Makefile文件具体内容：</p> 
<pre><code class="prism language-shell">cc        :<span class="token operator">=</span> g++
nvcc      <span class="token operator">=</span> /root/.kiwi/lib/cuda-11.8/bin/nvcc

include_paths :<span class="token operator">=</span> src        <span class="token punctuation">\</span>
			/root/.kiwi/lib/opencv4.2/include <span class="token punctuation">\</span>
			/root/.kiwi/lib/TensorRT-8.5.3.1-cuda11x/include <span class="token punctuation">\</span>
			/root/.kiwi/lib/cuda-11.8/include <span class="token punctuation">\</span>
			/root/.kiwi/lib/cudnn8.6.0.163-cuda11/lib

library_paths :<span class="token operator">=</span> /root/.kiwi/lib/opencv4.2/lib <span class="token punctuation">\</span>
			/root/.kiwi/lib/TensorRT-8.5.3.1-cuda11x/lib <span class="token punctuation">\</span>
			/root/.kiwi/lib/cuda-11.8/lib64 <span class="token punctuation">\</span>
 			/root/.kiwi/lib/cudnn8.6.0.163-cuda11/lib

link_librarys :<span class="token operator">=</span> opencv_core opencv_imgproc opencv_videoio opencv_imgcodecs <span class="token punctuation">\</span>
			nvinfer nvinfer_plugin nvonnxparser <span class="token punctuation">\</span>
			cuda cublas cudart cudnn <span class="token punctuation">\</span>
			stdc++ dl

cppstrict :<span class="token operator">=</span> -Wall -Werror -Wextra -Wno-deprecated-declarations -Wno-unused-parameter
custrict  :<span class="token operator">=</span> -Werror<span class="token operator">=</span>all-warnings
cpp_compile_flags :<span class="token operator">=</span> -std<span class="token operator">=</span>c++11 -fPIC -g -fopenmp <span class="token variable"><span class="token variable">$(</span>cppstrict<span class="token variable">)</span></span> -O0
cu_compile_flags  :<span class="token operator">=</span> -std<span class="token operator">=</span>c++11 <span class="token variable"><span class="token variable">$(</span>custrict<span class="token variable">)</span></span> -O0 -Xcompiler <span class="token string">"<span class="token variable"><span class="token variable">$(</span>cpp_compile_flags<span class="token variable">)</span></span>"</span>
link_flags        :<span class="token operator">=</span> -pthread -fopenmp -Wl,-rpath<span class="token operator">=</span><span class="token string">'$$ORIGIN'</span>

include /root/.kiwi/lib/cumk/inc
</code></pre> 
<p>这个Makefile文件的内容并不非常完整，只定义了一些变量和搜索路径相关，后续修改还需要添加编译和链接的内容。以下是对每个部分的详细分析</p> 
<p><strong>1.定义编译器和nvcc路径</strong></p> 
<pre><code class="prism language-shell">cc        :<span class="token operator">=</span> g++
nvcc      <span class="token operator">=</span> /root/.kiwi/lib/cuda-11.8/bin/nvcc
</code></pre> 
<p>其中：</p> 
<ul><li><code>cc</code>是用于编译C++代码的GNU C++编译器；</li><li><code>nvcc</code>是用于编译CUDA代码的NVIDIA CUDA编译器</li></ul> 
<p><strong>2.定义include路径、库路径和链接的库名</strong></p> 
<pre><code class="prism language-shell">include_paths :<span class="token operator">=</span> src        <span class="token punctuation">\</span>
			/root/.kiwi/lib/opencv4.2/include <span class="token punctuation">\</span>
			/root/.kiwi/lib/TensorRT-8.5.3.1-cuda11x/include <span class="token punctuation">\</span>
			/root/.kiwi/lib/cuda-11.8/include <span class="token punctuation">\</span>
			/root/.kiwi/lib/cudnn8.6.0.163-cuda11/lib

library_paths :<span class="token operator">=</span> /root/.kiwi/lib/opencv4.2/lib <span class="token punctuation">\</span>
			/root/.kiwi/lib/TensorRT-8.5.3.1-cuda11x/lib <span class="token punctuation">\</span>
			/root/.kiwi/lib/cuda-11.8/lib64 <span class="token punctuation">\</span>
 			/root/.kiwi/lib/cudnn8.6.0.163-cuda11/lib

link_librarys :<span class="token operator">=</span> opencv_core opencv_imgproc opencv_videoio opencv_imgcodecs <span class="token punctuation">\</span>
			nvinfer nvinfer_plugin nvonnxparser <span class="token punctuation">\</span>
			cuda cublas cudart cudnn <span class="token punctuation">\</span>
			stdc++ dl
</code></pre> 
<p>其中：</p> 
<ul><li><code>include_paths</code>定义了需要编译的代码的头文件所在路径；</li><li><code>library_paths</code>定义了库文件的路径；</li><li><code>link_librarys</code>定义了需要链接的库名。</li></ul> 
<p><strong>3.定义编译选项</strong></p> 
<pre><code class="prism language-shell">cppstrict :<span class="token operator">=</span> -Wall -Werror -Wextra -Wno-deprecated-declarations -Wno-unused-parameter
custrict  :<span class="token operator">=</span> -Werror<span class="token operator">=</span>all-warnings
cpp_compile_flags :<span class="token operator">=</span> -std<span class="token operator">=</span>c++11 -fPIC -g -fopenmp <span class="token variable"><span class="token variable">$(</span>cppstrict<span class="token variable">)</span></span> -O0
cu_compile_flags  :<span class="token operator">=</span> -std<span class="token operator">=</span>c++11 <span class="token variable"><span class="token variable">$(</span>custrict<span class="token variable">)</span></span> -O0 -Xcompiler <span class="token string">"<span class="token variable"><span class="token variable">$(</span>cpp_compile_flags<span class="token variable">)</span></span>"</span>
link_flags        :<span class="token operator">=</span> -pthread -fopenmp -Wl,-rpath<span class="token operator">=</span><span class="token string">'$$ORIGIN'</span>
</code></pre> 
<p>其中，</p> 
<ul><li><code>cppstrict</code>是用于编译C++代码的编译警告选项;</li><li><code>custrict</code>是用于编译CUDA代码的编译警告选项；</li><li><code>cpp_compile_flags</code>是用于编译C++代码的编译选项，包括C++11标准、位置独立代码、调试信息、OpenMP多线程编程等；</li><li><code>cu_compile_flags</code>是用于编译CUDA代码的编译选项，包括C++11标准、位置独立代码、关闭所有警告、调试信息等；</li><li><code>link_flags</code>是用于链接库的选项，包括多线程编程和动态链接库路径</li></ul> 
<p><strong>4.包含一个第三方库</strong></p> 
<pre><code class="prism language-shell">include /root/.kiwi/lib/cumk/inc
</code></pre> 
<h3><a id="3Makefile_133"></a>3.Makefile文件修改</h3> 
<p>修改的地方有点多，下面具体来分析</p> 
<h4><a id="31__137"></a>3.1 定义编译器</h4> 
<pre><code class="prism language-shell">cc        :<span class="token operator">=</span> g++
nvcc      :<span class="token operator">=</span> /usr/local/cuda-10.2/bin/nvcc
</code></pre> 
<p>其中，</p> 
<ul><li><code>cc := g++</code>定义了C++编译器变量<code>cc</code></li><li><code>nvcc := /usr/local/cuda-10.2/bin/nvcc</code>定义了CUDA编译器变量<code>nvcc</code></li></ul> 
<h4><a id="32__149"></a>3.2 定义源文件和目标文件</h4> 
<pre><code class="prism language-shell">cpp_srcs  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>shell <span class="token function">find</span> src -name <span class="token string">"*.cpp"</span><span class="token variable">)</span></span>
cpp_objs  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cpp_srcs:.cpp<span class="token operator">=</span>.cpp.o<span class="token variable">)</span></span>
cpp_objs  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cpp_objs:src/%<span class="token operator">=</span>objs/%<span class="token variable">)</span></span>
cpp_mk	  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cpp_objs:.cpp.o<span class="token operator">=</span>.cpp.mk<span class="token variable">)</span></span>

cu_srcs	  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>shell <span class="token function">find</span> src -name <span class="token string">"*.cu"</span><span class="token variable">)</span></span>
cu_objs   :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cu_srcs:.cu<span class="token operator">=</span>.cu.o<span class="token variable">)</span></span>
cu_objs	  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cu_objs:src/%<span class="token operator">=</span>objs/%<span class="token variable">)</span></span>
cu_mk	  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cu_objs:.cu.o<span class="token operator">=</span>.cu.mk<span class="token variable">)</span></span>
</code></pre> 
<p>其中，</p> 
<ul><li><code>cpp_srcs := $(shell find src -name "*.cpp")</code>使用shell命令查找源代码src目录下的所有.cpp文件，并将结果保存到<code>cpp_srcs</code>变量中</li><li><code>cpp_objs := $(cpp_srcs:.cpp=.cpp.o)</code>将<code>cpp_srcs</code>中的每个.cpp文件中的.cpp替换为.cpp.o，为了将所有的.cpp文件编译成.o文件</li><li><code>cpp_objs := $(cpp_objs:src/%=objs/%)</code>将<code>cpp_objs</code>中所有的obj文件的路径前缀从src/替换为objs/，即将所有的.o文件放在objs目录下</li><li><code>cpp_mk := $(cpp_objs:.cpp.o=.cpp.mk)</code>将所有的.cpp.o文件替换为.cpp.mk，即为每个.cpp源文件生成一个依赖文件</li><li><code>cu_srcs</code>、<code>cu_objs</code>、<code>cu_mk</code>同理，只是操作的是src下面的所有.cu文件</li></ul> 
<p><strong>说明</strong></p> 
<ul><li> <p><code>$(cpp_srcs:.cpp=.cpp.o)</code>这是make中一种字符串语法，语法结构如下</p> <pre><code class="prism language-shell"><span class="token variable"><span class="token variable">$(</span>VAR:a<span class="token operator">=</span>b<span class="token variable">)</span></span>
</code></pre> <p>其中，<code>VAR</code>为变量名，<code>a</code>和<code>b</code>均为字符串，表示将<code>VAR</code>中所有以<code>a</code>结尾的字符串替换为<code>b</code>结尾的字符串。相比于<code>patsubst</code>函数，这种语法更加简洁，适用于只需要进行简单字符串替换的情况。</p> </li><li> <p><code>$(cpp_objs:.cpp.o=.cpp.mk)</code>其中的<code>.mk</code>文件用来记录源文件和头文件的依赖关系。</p> 
  <ul><li>在C/C++项目中，一个.cpp文件往往包含了多个.h头文件，这些头文件的修改也会影响到.cpp文件的编译，因此正常情况下需要在头文件被修改时重新编译.cpp文件。</li><li><code>.mk</code>文件记录了每个源文件所依赖的头文件，以及头文件的修改时间，从而实现自动化依赖关系的生成。因此在修改头文件重新编译时，<strong>只需要重新编译与头文件相关的源文件即可</strong>。这可以大大减少编译时间，尤其在大型项目中尤为明显，如果没有<code>.mk</code>文件，每次重新编译时都需要重新编译整个项目，这将非常耗费时间和资源</li><li>在Makefile中使用<code>-include</code>命令可以将<code>.mk</code>文件包含进来，实现了Makefile的自动化构建过程</li></ul> </li></ul> 
<h4><a id="33__187"></a>3.3 定义头文件路径、库文件路径和库名称</h4> 
<pre><code class="prism language-shell">include_paths :<span class="token operator">=</span> src        <span class="token punctuation">\</span>
			/usr/include/opencv4 <span class="token punctuation">\</span>
			/usr/include/aarch64-linux-gnu <span class="token punctuation">\</span>
			/usr/local/cuda-10.2/include

library_paths :<span class="token operator">=</span> /usr/lib/aarch64-linux-gnu <span class="token punctuation">\</span>
				 /usr/local/cuda-10.2/lib64

link_librarys :<span class="token operator">=</span> opencv_core opencv_highgui opencv_imgproc opencv_videoio opencv_imgcodecs <span class="token punctuation">\</span>
				 nvinfer nvinfer_plugin nvonnxparser <span class="token punctuation">\</span>
				 cuda cublas cudart cudnn <span class="token punctuation">\</span>
				 stdc++ dl
</code></pre> 
<p>其中，</p> 
<ul><li> <p><code>include_paths</code>定义了所有头文件所在的路径，主要包含以下几方面内容</p> 
  <ul><li>src文件下的.hpp文件</li><li>opencv头文件</li><li>tensorRT、cudnn头文件</li><li>cuda头文件</li></ul> </li><li> <p><code>library_paths</code>定义了所有库文件所在的路径，主要包含以下几方面的内容</p> 
  <ul><li>opencv、tensorRT、cudnn库文件</li><li>cuda库文件</li></ul> </li><li> <p><code>link_librarys</code>定义了需要链接的所有库文件，主要包含以下几方面的内容</p> 
  <ul><li>opencv库文件：opencv_core、opencv_highgui、opencv_imgproc、opencv_videoio、opencv_imgcodecs</li><li>tensorRT库文件：nvinfer、nvinfer_plugin、nvonnxparser</li><li>cuda库文件：cuda、cublas、cudart</li><li>cudnn库文件：cudnn</li><li>GNU C++标准库：stdc++；动态链接库：dl</li></ul> </li></ul> 
<h4><a id="34__223"></a>3.4 定义导出和运行时路径</h4> 
<pre><code class="prism language-shell">empty		  :<span class="token operator">=</span>
export_path   :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>subst <span class="token punctuation">$(</span>empty<span class="token punctuation">)</span> <span class="token punctuation">$(</span>empty<span class="token punctuation">)</span>,:,<span class="token punctuation">$(</span>library_paths<span class="token punctuation">)</span><span class="token variable">)</span></span>

run_paths     :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach item,<span class="token punctuation">$(</span>library_paths<span class="token punctuation">)</span>,-Wl,-rpath<span class="token operator">=</span><span class="token punctuation">$(</span>item<span class="token punctuation">)</span><span class="token variable">)</span></span>
</code></pre> 
<p>其中，</p> 
<ul><li><code>export_path := $(subst $(empty) $(empty),:,$(library_paths))</code>将<code>library_paths</code>中的所有路径用冒号连接起来，用于在链接时指定动态库搜索路径</li><li><code>run_paths := $(foreach item,$(library_paths),-Wl,-rpath=$(item))</code>将<code>library_paths</code>中的每个路径添加上链接选项<code>-Wl,-rpath</code>,用于在链接时指定动态库搜索路径</li></ul> 
<p><strong>说明</strong></p> 
<ul><li> <p>以下是<code>subst</code>函数的语法结构，针对<code>$(subst $(empty) $(empty),:,$(library_paths))</code>这个语句来说&lt;from&gt;代表的是<code>$(empty) $(empty)</code>这一整体内容，<code>$(empty)</code>代表<strong>空字符串</strong>，不是空格，也没有其它任何字符。<code>$(empty) $(empty)</code>是为了产生一个空格的效果。</p> <pre><code class="prism language-shell"><span class="token variable"><span class="token variable">$(</span>subst <span class="token operator">&lt;</span>from<span class="token operator">&gt;</span>,<span class="token operator">&lt;</span>to<span class="token operator">&gt;</span>,<span class="token operator">&lt;</span>text<span class="token operator">&gt;</span><span class="token variable">)</span></span>
</code></pre> </li><li> <p><code>$(subst $(empty) $(empty),:,$(library_paths))</code>的整体含义就是将其中的空格替换成冒号，以便链接器可以正确地查找动态库。例如，如果<code>library_paths</code>地值为：</p> <pre><code class="prism language-shell">/usr/lib/aarch64-linux-gnu /usr/local/cuda-10.2/lib64
</code></pre> <p>那么以下几种情况对应的输出分别为：</p> <pre><code class="prism language-shell">export_path   :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>subst <span class="token punctuation">$(</span>empty<span class="token punctuation">)</span> <span class="token punctuation">$(</span>empty<span class="token punctuation">)</span>,:,<span class="token punctuation">$(</span>library_paths<span class="token punctuation">)</span><span class="token variable">)</span></span>
/usr/lib/aarch64-linux-gnu:/usr/local/cuda-10.2/lib64

export_path1  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>subst <span class="token punctuation">$(</span>empty<span class="token punctuation">)</span>,:,<span class="token punctuation">$(</span>library_paths<span class="token punctuation">)</span><span class="token variable">)</span></span>
/usr/lib/aarch64-linux-gnu /usr/local/cuda-10.2/lib64:

export_path2  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>subst ,:,<span class="token punctuation">$(</span>library_paths<span class="token punctuation">)</span><span class="token variable">)</span></span>
/usr/lib/aarch64-linux-gnu /usr/local/cuda-10.2/lib64:
</code></pre> </li></ul> 
<h4><a id="35__264"></a>3.5 定义编译选项</h4> 
<pre><code class="prism language-shell">include_paths :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach item,<span class="token punctuation">$(</span>include_paths<span class="token punctuation">)</span>,-I<span class="token punctuation">$(</span>item<span class="token punctuation">)</span><span class="token variable">)</span></span>
library_paths :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach item,<span class="token punctuation">$(</span>library_paths<span class="token punctuation">)</span>,-L<span class="token punctuation">$(</span>item<span class="token punctuation">)</span><span class="token variable">)</span></span>
link_librarys :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach item,<span class="token punctuation">$(</span>link_librarys<span class="token punctuation">)</span>,-l<span class="token punctuation">$(</span>item<span class="token punctuation">)</span><span class="token variable">)</span></span>

cpp_compile_flags :<span class="token operator">=</span> -std<span class="token operator">=</span>c++11 -fPIC -w -g -pthread -fopenmp -O0
cu_compile_flags  :<span class="token operator">=</span> -std<span class="token operator">=</span>c++11 -g -w -O0 -Xcompiler <span class="token string">"<span class="token variable"><span class="token variable">$(</span>cpp_compile_flags<span class="token variable">)</span></span>"</span>
link_flags        :<span class="token operator">=</span> -pthread -fopenmp -Wl,-rpath<span class="token operator">=</span><span class="token string">'$$ORIGIN'</span>

cpp_compile_flags <span class="token operator">+=</span> <span class="token variable"><span class="token variable">$(</span>include_paths<span class="token variable">)</span></span>
cu_compile_flags  <span class="token operator">+=</span> <span class="token variable"><span class="token variable">$(</span>include_paths<span class="token variable">)</span></span>
link_flags        <span class="token operator">+=</span> <span class="token variable"><span class="token variable">$(</span>library_paths<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>link_librarys<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>run_paths<span class="token variable">)</span></span>
</code></pre> 
<p>其中，</p> 
<ul><li><code>include_paths</code>是一个路径列表，通过<code>foreach</code>函数将其转换为<code>-I</code>开头的参数列表。这些参数用于指定头文件所在的路径。</li><li><code>library_paths</code>是一个库路径列表，通过<code>foreach</code>函数将其转换为<code>-L</code>开头的参数列表。这些参数用于指定库文件所在的路径。</li><li><code>link_librarys</code>是一个库文件列表，通过<code>foreach</code>函数将其转换为<code>-l</code>开头的参数列表。这些参数用于指定链接的库文件。</li><li><code>cpp_compile_flags</code>是编译C++文件的编译参数列表，其中包括了``include_paths<code>、</code>-fPIC<code>(生成位置无关代码)、</code>-w<code>(忽略警告)、</code>-g<code>(生成调试信息)、</code>-pthread<code>(链接线程库)、</code>-fopenmp<code>(开启OpenMP多线程)和</code>-O0`(关闭优化)等选项。</li><li><code>cu_compile_flags</code>是编译CUDA文件的编译参数列表，同上，<code>-Xcompile</code>(指定传递给底层C++编译器的参数)</li><li><code>link_flags</code>是链接参数列表，其中包括了<code>library_paths</code>、<code>link_librarys</code>和<code>run_paths</code>等选项。<code>run_paths</code>选项用于指定运行时的库路径，用于解决动态库加载问题。</li></ul> 
<p><strong>说明</strong></p> 
<ul><li><code>fPIC</code>(Position Independent Code)，它的用途是生成与位置无关的代码。在编译生成动态库时，这个参数可以确保代码中的全局符号表、重定位表等数据的位置独立于内存中的位置，从而允许多个进程在内存中共享同一份库代码。简单来说，<strong><code>fPIC</code>是在编译生成动态库时必须加上的参数，以确保生成的动态库能够被不同的进程共享使用</strong></li><li>在CUDA和C++混合编程中，由于NVCC和g++编译器的编译选项有所不同，需要为它们分别指定不同的编译选项。NVCC编译器底层需要调用g++编译器，可以通过<code>-Xcompile</code>选项将参数传递给NVCC生成的C++编译器。这样，可以确保NVCC编译器和g++编译器都使用了相同的选项，从而确保了代码的正确性和一致性</li><li><code>-Wl,-rpath='$$ORIGIN'</code>表示将rpath设置为<code>$ORIGIN</code>，在这里<code>$ORIGIN</code>是一个特殊字符，<strong>表示可执行文件所在目录的路径</strong>。双重美元符号<code>$$</code>是因为<code>$ORIGIN</code>在Shell中有特殊含义，因此需要转义。</li></ul> 
<h4><a id="36__295"></a>3.6 添加头文件依赖</h4> 
<pre><code class="prism language-shell">ifneq <span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>MAKECMDGOALS<span class="token variable">)</span></span>, clean<span class="token punctuation">)</span>
-include <span class="token variable"><span class="token variable">$(</span>cpp_mk<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>cu_mk<span class="token variable">)</span></span>
endif
</code></pre> 
<p><strong>说明</strong></p> 
<ul><li><code>-include</code>是Makefile中的内置函数，它的作用是将指定的文件包含到当前的Makefile中。上面的语句的作用是在执行make命令时，如果没有clean目标，就会包含(include)指定的文件即<code>$(cpp_mk)</code>和<code>$(cu_mk)</code>。而这两个<code>.mk</code>文件包含了相应的源文件的依赖关系。这样在修改源文件时，make会自动判断哪些文件需要重新编译，以及哪些文件需要重新链接，从而提高了构建效率。</li><li>如果不包含这个语句，可能导致make不能正确地识别源文件之间的依赖关系，或者需要程序编译所有文件，从而降低了构建效率。因此，在构建复杂项目时，最好包含这个语句确保构建的正确性和效率。</li></ul> 
<h4><a id="37_CUDAC_308"></a>3.7 编译CUDA和C++程序</h4> 
<pre><code class="prism language-shell">pro	   :<span class="token operator">=</span> workspace/pro
expath :<span class="token operator">=</span> library_path.txt

library_path.txt <span class="token builtin class-name">:</span> 
	@echo <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>export_path<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token string">"<span class="token variable">$$</span>"</span>LD_LIBRARY_PATH <span class="token operator">&gt;</span> <span class="token variable">$@</span>

workspace/pro <span class="token builtin class-name">:</span> <span class="token variable"><span class="token variable">$(</span>cpp_objs<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>cu_objs<span class="token variable">)</span></span>
	@echo Link <span class="token variable">$@</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>cc<span class="token variable">)</span></span> $^ -o <span class="token variable">$@</span> <span class="token variable"><span class="token variable">$(</span>link_flags<span class="token variable">)</span></span>

objs/%.cpp.o <span class="token builtin class-name">:</span> src/%.cpp
	@echo Compile CXX $<span class="token operator">&lt;</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>cc<span class="token variable">)</span></span> -c $<span class="token operator">&lt;</span> -o <span class="token variable">$@</span> <span class="token variable"><span class="token variable">$(</span>cpp_compile_flags<span class="token variable">)</span></span>

objs/%.cu.o <span class="token builtin class-name">:</span> src/%.cu
	@echo Compile CUDA $<span class="token operator">&lt;</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>nvcc<span class="token variable">)</span></span> -c $<span class="token operator">&lt;</span> -o <span class="token variable">$@</span> <span class="token variable"><span class="token variable">$(</span>cu_compile_flags<span class="token variable">)</span></span>

objs/%.cpp.mk <span class="token builtin class-name">:</span> src/%.cpp
	@echo Compile depends CXX $<span class="token operator">&lt;</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>cc<span class="token variable">)</span></span> -M $<span class="token operator">&lt;</span> -MF <span class="token variable">$@</span> -MT <span class="token variable"><span class="token variable">$(</span>@:.cpp.mk<span class="token operator">=</span>.cpp.o<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>cpp_compile_flags<span class="token variable">)</span></span>
	
objs/%.cu.mk <span class="token builtin class-name">:</span> src/%.cu
	@echo Compile depends CUDA $<span class="token operator">&lt;</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>nvcc<span class="token variable">)</span></span> -M $<span class="token operator">&lt;</span> -MF <span class="token variable">$@</span> -MT <span class="token variable"><span class="token variable">$(</span>@:.cu.mk<span class="token operator">=</span>.cu.o<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>cu_compile_flags<span class="token variable">)</span></span>

run <span class="token builtin class-name">:</span> workspace/pro
	@cd workspace <span class="token operator">&amp;&amp;</span> ./pro
</code></pre> 
<p>其中，</p> 
<ul><li><code>pro</code>变量表示最终生成的可执行文件的路径</li><li><code>expath</code>变量表示库文件路径的导出文件名</li><li><code>library_path.txt</code>文件用于生成<code>LD_LIBRARY_PATH</code>环境变量所需的值，其内容是<code>LD_LIBRARY_PATH</code>和<code>export_path</code>的值</li><li><code>workspace/pro</code>规则用于编译链接生成最终的可执行文件。其中包含了所有的C++和CUDA文件</li><li><code>objs/%.cpp.o</code>规则和<code>objs/%.cu.o</code>规则分别用于编译C++和CUDA文件，生成目标文件</li><li><code>objs/%.cpp.mk</code>规则和<code>objs/%.cu.mk</code>规则分别用于生成C++和CUDA文件的依赖关系描述文件</li><li><code>run</code>规则用于运行生成的可执行文件</li></ul> 
<p><strong>说明</strong></p> 
<ul><li><code>objs/%.cpp.mk : src/%.cpp</code>定义了一条规则，当在src目录下的.cpp发生变化时，会执行该规则生成对应的.cpp.mk文件</li><li><code>$(cc) -M $&lt; -MF $@ -MT $(@:.cpp.mk=.cpp.o) $(cpp_compile_flags)</code>该命令会将根据源文件生成对应的依赖关系文件 
  <ul><li><code>-M</code>：表示只输出每个源文件的依赖关系，不包括编译指令，例如<code>-M src/main.cpp</code></li><li><code>-MF</code>：表示将输出的依赖关系写入到指定的文件中，例如<code>-MF objs/main.cpp.mk</code></li><li><code>-MF</code>：表示制定目标文件，即make要生成的文件，例如<code>-MT objs/main.cpp.o</code></li></ul> </li></ul> 
<h4><a id="38__364"></a>3.8 其它</h4> 
<pre><code class="prism language-shell">debug <span class="token builtin class-name">:</span>
	@echo <span class="token variable"><span class="token variable">$(</span>include_paths<span class="token variable">)</span></span>
	@echo <span class="token variable"><span class="token variable">$(</span>library_paths<span class="token variable">)</span></span>
	@echo <span class="token variable"><span class="token variable">$(</span>link_librarys<span class="token variable">)</span></span>

clean <span class="token builtin class-name">:</span> 
	@rm -rf library_path.txt
	@rm -rf objs workspace/pro
	@rm -rf workspace/Result.jpg

.PHONY <span class="token builtin class-name">:</span> debug clean run

<span class="token builtin class-name">export</span> LD_LIBRARY_PATH:<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>export_path<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span>LD_LIBRARY_PATH<span class="token variable">)</span></span>
</code></pre> 
<p>其中，</p> 
<ul><li><code>clean</code>规则用于删除生成的目标文件、库文件和可执行文件</li><li><code>export LD_LIBRARY_PATH</code>语句用于导出<code>LD_LIBRARY_PATH</code>环境变量，使得运行时能够正确链接库文件。</li></ul> 
<h3><a id="4Makefile_387"></a>4.完整Makefile</h3> 
<p>完整的Makefile示例如下：</p> 
<pre><code class="prism language-shell">cc        :<span class="token operator">=</span> g++
nvcc      :<span class="token operator">=</span> /usr/local/cuda-10.2/bin/nvcc

cpp_srcs  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>shell <span class="token function">find</span> src -name <span class="token string">"*.cpp"</span><span class="token variable">)</span></span>
cpp_objs  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cpp_srcs:.cpp<span class="token operator">=</span>.cpp.o<span class="token variable">)</span></span>
cpp_objs  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cpp_objs:src/%<span class="token operator">=</span>objs/%<span class="token variable">)</span></span>
cpp_mk	  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cpp_objs:.cpp.o<span class="token operator">=</span>.cpp.mk<span class="token variable">)</span></span>

cu_srcs	  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>shell <span class="token function">find</span> src -name <span class="token string">"*.cu"</span><span class="token variable">)</span></span>
cu_objs   :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cu_srcs:.cu<span class="token operator">=</span>.cu.o<span class="token variable">)</span></span>
cu_objs	  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cu_objs:src/%<span class="token operator">=</span>objs/%<span class="token variable">)</span></span>
cu_mk	  :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>cu_objs:.cu.o<span class="token operator">=</span>.cu.mk<span class="token variable">)</span></span>

include_paths :<span class="token operator">=</span> src        <span class="token punctuation">\</span>
			/usr/include/opencv4 <span class="token punctuation">\</span>
			/usr/include/aarch64-linux-gnu <span class="token punctuation">\</span>
			/usr/local/cuda-10.2/include

library_paths :<span class="token operator">=</span> /usr/lib/aarch64-linux-gnu <span class="token punctuation">\</span>
				 /usr/local/cuda-10.2/lib64

link_librarys :<span class="token operator">=</span> opencv_core opencv_highgui opencv_imgproc opencv_videoio opencv_imgcodecs <span class="token punctuation">\</span>
				 nvinfer nvinfer_plugin nvonnxparser <span class="token punctuation">\</span>
				 cuda cublas cudart cudnn <span class="token punctuation">\</span>
				 stdc++ dl

empty		  :<span class="token operator">=</span>
export_path   :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>subst <span class="token punctuation">$(</span>empty<span class="token punctuation">)</span> <span class="token punctuation">$(</span>empty<span class="token punctuation">)</span>,:,<span class="token punctuation">$(</span>library_paths<span class="token punctuation">)</span><span class="token variable">)</span></span>

run_paths     :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach item,<span class="token punctuation">$(</span>library_paths<span class="token punctuation">)</span>,-Wl,-rpath<span class="token operator">=</span><span class="token punctuation">$(</span>item<span class="token punctuation">)</span><span class="token variable">)</span></span>

include_paths :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach item,<span class="token punctuation">$(</span>include_paths<span class="token punctuation">)</span>,-I<span class="token punctuation">$(</span>item<span class="token punctuation">)</span><span class="token variable">)</span></span>
library_paths :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach item,<span class="token punctuation">$(</span>library_paths<span class="token punctuation">)</span>,-L<span class="token punctuation">$(</span>item<span class="token punctuation">)</span><span class="token variable">)</span></span>
link_librarys :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach item,<span class="token punctuation">$(</span>link_librarys<span class="token punctuation">)</span>,-l<span class="token punctuation">$(</span>item<span class="token punctuation">)</span><span class="token variable">)</span></span>

cpp_compile_flags :<span class="token operator">=</span> -std<span class="token operator">=</span>c++11 -fPIC -w -g -pthread -fopenmp -O0
cu_compile_flags  :<span class="token operator">=</span> -std<span class="token operator">=</span>c++11 -g -w -O0 -Xcompiler <span class="token string">"<span class="token variable"><span class="token variable">$(</span>cpp_compile_flags<span class="token variable">)</span></span>"</span>
link_flags        :<span class="token operator">=</span> -pthread -fopenmp -Wl,-rpath<span class="token operator">=</span><span class="token string">'$$ORIGIN'</span>

cpp_compile_flags <span class="token operator">+=</span> <span class="token variable"><span class="token variable">$(</span>include_paths<span class="token variable">)</span></span>
cu_compile_flags  <span class="token operator">+=</span> <span class="token variable"><span class="token variable">$(</span>include_paths<span class="token variable">)</span></span>
link_flags        <span class="token operator">+=</span> <span class="token variable"><span class="token variable">$(</span>library_paths<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>link_librarys<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>run_paths<span class="token variable">)</span></span>

ifneq <span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>MAKECMDGOALS<span class="token variable">)</span></span>, clean<span class="token punctuation">)</span>
-include <span class="token variable"><span class="token variable">$(</span>cpp_mk<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>cu_mk<span class="token variable">)</span></span>
endif

pro	   :<span class="token operator">=</span> workspace/pro
expath :<span class="token operator">=</span> library_path.txt

library_path.txt <span class="token builtin class-name">:</span> 
	@echo <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>export_path<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token string">"<span class="token variable">$$</span>"</span>LD_LIBRARY_PATH <span class="token operator">&gt;</span> <span class="token variable">$@</span>

workspace/pro <span class="token builtin class-name">:</span> <span class="token variable"><span class="token variable">$(</span>cpp_objs<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>cu_objs<span class="token variable">)</span></span>
	@echo Link <span class="token variable">$@</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>cc<span class="token variable">)</span></span> $^ -o <span class="token variable">$@</span> <span class="token variable"><span class="token variable">$(</span>link_flags<span class="token variable">)</span></span>

objs/%.cpp.o <span class="token builtin class-name">:</span> src/%.cpp
	@echo Compile CXX $<span class="token operator">&lt;</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>cc<span class="token variable">)</span></span> -c $<span class="token operator">&lt;</span> -o <span class="token variable">$@</span> <span class="token variable"><span class="token variable">$(</span>cpp_compile_flags<span class="token variable">)</span></span>

objs/%.cu.o <span class="token builtin class-name">:</span> src/%.cu
	@echo Compile CUDA $<span class="token operator">&lt;</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>nvcc<span class="token variable">)</span></span> -c $<span class="token operator">&lt;</span> -o <span class="token variable">$@</span> <span class="token variable"><span class="token variable">$(</span>cu_compile_flags<span class="token variable">)</span></span>

objs/%.cpp.mk <span class="token builtin class-name">:</span> src/%.cpp
	@echo Compile depends CXX $<span class="token operator">&lt;</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>cc<span class="token variable">)</span></span> -M $<span class="token operator">&lt;</span> -MF <span class="token variable">$@</span> -MT <span class="token variable"><span class="token variable">$(</span>@:.cpp.mk<span class="token operator">=</span>.cpp.o<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>cpp_compile_flags<span class="token variable">)</span></span>
	
objs/%.cu.mk <span class="token builtin class-name">:</span> src/%.cu
	@echo Compile depends CUDA $<span class="token operator">&lt;</span>
	@mkdir -p <span class="token variable"><span class="token variable">$(</span><span class="token function">dir</span> $@<span class="token variable">)</span></span>
	@<span class="token variable"><span class="token variable">$(</span>nvcc<span class="token variable">)</span></span> -M $<span class="token operator">&lt;</span> -MF <span class="token variable">$@</span> -MT <span class="token variable"><span class="token variable">$(</span>@:.cu.mk<span class="token operator">=</span>.cu.o<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>cu_compile_flags<span class="token variable">)</span></span>

run <span class="token builtin class-name">:</span> workspace/pro
	@cd workspace <span class="token operator">&amp;&amp;</span> ./pro

debug <span class="token builtin class-name">:</span>
	@echo <span class="token variable"><span class="token variable">$(</span>include_paths<span class="token variable">)</span></span>
	@echo <span class="token variable"><span class="token variable">$(</span>library_paths<span class="token variable">)</span></span>
	@echo <span class="token variable"><span class="token variable">$(</span>link_librarys<span class="token variable">)</span></span>

clean <span class="token builtin class-name">:</span> 
	@rm -rf library_path.txt
	@rm -rf objs workspace/pro
	@rm -rf workspace/Result.jpg

.PHONY <span class="token builtin class-name">:</span> debug clean run

<span class="token builtin class-name">export</span> LD_LIBRARY_PATH:<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>export_path<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span>LD_LIBRARY_PATH<span class="token variable">)</span></span>
</code></pre> 
<p>执行<code>make run</code>运行效果如下：</p> 
<p><img src="https://images2.imgbox.com/23/58/OQQS8A2F_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_492"></a>总结</h3> 
<blockquote> 
 <p>本次实战选取开源仓库<a href="https://github.com/shouxieai/infer">https://github.com/shouxieai/infer</a>中的Makefile文件做了具体的分析和修改，在今后的工作中多看多写吧😄</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8747c4134a8cf3f5aa1b9e380bdb2df7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信小程序上传图片压缩方案</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f41360833abe390e669bb369fb358d8a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">虚拟机打开vmdk界面黑屏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>