<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>旋转框目标检测mmrotate v1.0.0rc1 之RTMDet训练DOTA（二） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="旋转框目标检测mmrotate v1.0.0rc1 之RTMDet训练DOTA（二）" />
<meta property="og:description" content="1、模型rotated_rtmdet的论文链接与配置文件 注意：
我们按照 DOTA 评测服务器的最新指标，原来的 voc 格式 mAP 现在是 mAP50。
IN表示ImageNet预训练，COCO表示COCO预训练。
与报告不同的是，这里的推理速度是在 NVIDIA 2080Ti GPU 上测量的，配备 TensorRT 8.4.3、cuDNN 8.2.0、FP16、batch size=1 和 NMS。
2、修改RTMDet-tiny的配置文件 基础配置文件：rotated_rtmdet_l-3x-dota.py _base_ = [ &#39;./_base_/default_runtime.py&#39;, &#39;./_base_/schedule_3x.py&#39;, &#39;./_base_/dota_rr.py&#39; ] checkpoint = &#39;https://download.openmmlab.com/mmdetection/v3.0/rtmdet/cspnext_rsb_pretrain/cspnext-l_8xb256-rsb-a1-600e_in1k-6a760974.pth&#39; # noqa angle_version = &#39;le90&#39; model = dict( type=&#39;mmdet.RTMDet&#39;, data_preprocessor=dict( type=&#39;mmdet.DetDataPreprocessor&#39;, mean=[103.53, 116.28, 123.675], std=[57.375, 57.12, 58.395], bgr_to_rgb=False, boxtype2tensor=False, batch_augments=None), backbone=dict( type=&#39;mmdet.CSPNeXt&#39;, arch=&#39;P5&#39;, expand_ratio=0.5, deepen_factor=1, widen_factor=1, channel_attention=True, norm_cfg=dict(type=&#39;SyncBN&#39;), act_cfg=dict(type=&#39;SiLU&#39;), init_cfg=dict( type=&#39;Pretrained&#39;, prefix=&#39;backbone.&#39;, checkpoint=checkpoint)), neck=dict( type=&#39;mmdet.CSPNeXtPAFPN&#39;, in_channels=[256, 512, 1024], out_channels=256, num_csp_blocks=3, expand_ratio=0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fb8ecf9ab019fec27b675aa94a476b78/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-07T10:08:28+08:00" />
<meta property="article:modified_time" content="2023-03-07T10:08:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">旋转框目标检测mmrotate v1.0.0rc1 之RTMDet训练DOTA（二）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="kdocs-document"> 
 <h2 style="">1、<a class="kdocs-link" style="color:#0A6CFF;" href="https://github.com/open-mmlab/mmrotate/tree/v1.0.0rc1/configs/rotated_rtmdet" target="_blank" rel="noopener noreferrer">模型rotated_rtmdet的论文链接与配置文件</a></h2> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:948px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:63.291138%;height:0;"> 
    <img src="https://images2.imgbox.com/cf/19/dX7XlIHm_o.png" style="margin-left:;display:block;width:948px;margin-top:-63.291138%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:859px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:69.84866%;height:0;"> 
    <img src="https://images2.imgbox.com/10/d7/8hfhVpDI_o.png" style="margin-left:;display:block;width:859px;margin-top:-69.84866%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:770px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:77.92208%;height:0;"> 
    <img src="https://images2.imgbox.com/91/4f/7p5askAX_o.png" style="margin-left:;display:block;width:770px;margin-top:-77.92208%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:963px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:23.883698%;height:0;"> 
    <img src="https://images2.imgbox.com/e2/dc/xApnNJj2_o.png" style="margin-left:;display:block;width:963px;margin-top:-23.883698%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:930px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:20.64516%;height:0;"> 
    <img src="https://images2.imgbox.com/94/95/IGxQvDSu_o.png" style="margin-left:;display:block;width:930px;margin-top:-20.64516%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="text-align:null;"><span class="kdocs-bold" style="font-weight:bold;">注意</span>：</p> 
 <p style="">我们按照 DOTA 评测服务器的最新指标，原来的 voc 格式 mAP 现在是 mAP50。</p> 
 <p style=""><span class="kdocs-fontSize" style="font-size:9pt;">IN</span>表示ImageNet预训练，<span class="kdocs-fontSize" style="font-size:9pt;">COCO</span>表示COCO预训练。</p> 
 <p style="">与报告不同的是，这里的推理速度是在 NVIDIA 2080Ti GPU 上测量的，配备 TensorRT 8.4.3、cuDNN 8.2.0、FP16、batch size=1 和 NMS。</p> 
 <h2 style="">2、修改RTMDet-tiny的配置文件</h2> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1133px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:52.956753%;height:0;"> 
    <img src="https://images2.imgbox.com/05/69/HYUNKHhk_o.png" style="margin-left:;display:block;width:1133px;margin-top:-52.956753%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:951px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:63.09148%;height:0;"> 
    <img src="https://images2.imgbox.com/ab/be/lQJBbRoS_o.png" style="margin-left:;display:block;width:951px;margin-top:-63.09148%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="1"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">基础配置文件：rotated_rtmdet_l-3x-dota.py</span> </h3></li></ol> 
 <pre class="kdocs-bash"><code class="language-bash">_base_ = [
    './_base_/default_runtime.py', './_base_/schedule_3x.py',
    './_base_/dota_rr.py'
]
checkpoint = 'https://download.openmmlab.com/mmdetection/v3.0/rtmdet/cspnext_rsb_pretrain/cspnext-l_8xb256-rsb-a1-600e_in1k-6a760974.pth'  # noqa

angle_version = 'le90'
model = dict(
    type='mmdet.RTMDet',
    data_preprocessor=dict(
        type='mmdet.DetDataPreprocessor',
        mean=[103.53, 116.28, 123.675],
        std=[57.375, 57.12, 58.395],
        bgr_to_rgb=False,
        boxtype2tensor=False,
        batch_augments=None),
    backbone=dict(
        type='mmdet.CSPNeXt',
        arch='P5',
        expand_ratio=0.5,
        deepen_factor=1,
        widen_factor=1,
        channel_attention=True,
        norm_cfg=dict(type='SyncBN'),
        act_cfg=dict(type='SiLU'),
        init_cfg=dict(
            type='Pretrained', prefix='backbone.', checkpoint=checkpoint)),
    neck=dict(
        type='mmdet.CSPNeXtPAFPN',
        in_channels=[256, 512, 1024],
        out_channels=256,
        num_csp_blocks=3,
        expand_ratio=0.5,
        norm_cfg=dict(type='SyncBN'),
        act_cfg=dict(type='SiLU')),
    bbox_head=dict(
        type='RotatedRTMDetSepBNHead',
        num_classes=15,
        in_channels=256,
        stacked_convs=2,
        feat_channels=256,
        angle_version=angle_version,
        anchor_generator=dict(
            type='mmdet.MlvlPointGenerator', offset=0, strides=[8, 16, 32]),
        bbox_coder=dict(
            type='DistanceAnglePointCoder', angle_version=angle_version),
        loss_cls=dict(
            type='mmdet.QualityFocalLoss',
            use_sigmoid=True,
            beta=2.0,
            loss_weight=1.0),
        loss_bbox=dict(type='RotatedIoULoss', mode='linear', loss_weight=2.0),
        with_objectness=False,
        exp_on_reg=True,
        share_conv=True,
        pred_kernel_size=1,
        use_hbbox_loss=False,
        scale_angle=False,
        loss_angle=None,
        norm_cfg=dict(type='SyncBN'),
        act_cfg=dict(type='SiLU')),
    train_cfg=dict(
        assigner=dict(
            type='mmdet.DynamicSoftLabelAssigner',
            iou_calculator=dict(type='RBboxOverlaps2D'),
            topk=13),
        allowed_border=-1,
        pos_weight=-1,
        debug=False),
    test_cfg=dict(
        nms_pre=2000,
        min_bbox_size=0,
        score_thr=0.05,
        nms=dict(type='nms_rotated', iou_threshold=0.1),
        max_per_img=2000),
)

# batch_size = (2 GPUs) x (4 samples per GPU) = 8
train_dataloader = dict(batch_size=4, num_workers=4)</code></pre> 
 <ol start="1"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h4><span class="kdocs-bold" style="font-weight:bold;">修改数据集路径信息——</span>'./_base_/dota_rr.py'</h4></li></ol> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">更改数据集基础路径及训练、验证和测试路径、以及影像切片的大小</span></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:621px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:25.603865%;height:0;"> 
    <img src="https://images2.imgbox.com/28/07/fiYguv3Q_o.png" style="margin-left:;display:block;width:621px;margin-top:-25.603865%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:588px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:102.04082%;height:0;"> 
    <img src="https://images2.imgbox.com/b7/94/CvVpCIDD_o.png" style="margin-left:;display:block;width:588px;margin-top:-102.04082%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:552px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:108.69565%;height:0;"> 
    <img src="https://images2.imgbox.com/66/a2/DoXtxjER_o.png" style="margin-left:;display:block;width:552px;margin-top:-108.69565%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="2"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h4><span class="kdocs-bold" style="font-weight:bold;">修改训练数据的类别数——</span>rotated_rtmdet_l-3x-dota.py </h4></li></ol> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:569px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:105.44816%;height:0;"> 
    <img src="https://images2.imgbox.com/d5/08/H32HKs6X_o.png" style="margin-left:;display:block;width:569px;margin-top:-105.44816%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:650px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:92.307686%;height:0;"> 
    <img src="https://images2.imgbox.com/24/0c/e9KXbg3Y_o.png" style="margin-left:;display:block;width:650px;margin-top:-92.307686%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="3"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h4><span class="kdocs-bold" style="font-weight:bold;">修改线程和batch_size(</span>'./_base_/dota_rr.py'<span class="kdocs-bold" style="font-weight:bold;">)</span></h4></li></ol> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">'./_base_/dota_rr.py'</span></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:613px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:27.895596%;height:0;"> 
    <img src="https://images2.imgbox.com/d5/d9/4L0m6Ut5_o.png" style="margin-left:;display:block;width:613px;margin-top:-27.895596%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">rotated_rtmdet_l-3x-dota.py</span> </p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:595px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:13.94958%;height:0;"> 
    <img src="https://images2.imgbox.com/bc/a3/wB1StfaN_o.png" style="margin-left:;display:block;width:595px;margin-top:-13.94958%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <h4 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">4.修改训练epoches('./_base_/schedule_3x.py')</span></h4> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:600px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:100.0%;height:0;"> 
    <img src="https://images2.imgbox.com/70/12/rJynIZVc_o.png" style="margin-left:;display:block;width:600px;margin-top:-100.0%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <h4 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">5.修改模型训练的日志打印和load from 加载与训练模型（configs_base_/default_runtime.py）</span></h4> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:617px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:97.244736%;height:0;"> 
    <img src="https://images2.imgbox.com/f7/8d/VWgPxkLF_o.png" style="margin-left:;display:block;width:617px;margin-top:-97.244736%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:938px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:33.795307%;height:0;"> 
    <img src="https://images2.imgbox.com/c8/63/w1QAeqWd_o.png" style="margin-left:;display:block;width:938px;margin-top:-33.795307%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <h4 style="">6.修改模型model的与训练模型路径</h4> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1248px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:38.86218%;height:0;"> 
    <img src="https://images2.imgbox.com/93/93/S1HdrYBo_o.png" style="margin-left:;display:block;width:1248px;margin-top:-38.86218%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:864px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:69.44444%;height:0;"> 
    <img src="https://images2.imgbox.com/82/97/7NBK9HfQ_o.png" style="margin-left:;display:block;width:864px;margin-top:-69.44444%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1172px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:43.515358%;height:0;"> 
    <img src="https://images2.imgbox.com/42/96/b584exdj_o.png" style="margin-left:;display:block;width:1172px;margin-top:-43.515358%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <h4 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">7.修改数据集的类别名称（mmrotate\datasets\dota.py）</span></h4> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:595px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:100.84033%;height:0;"> 
    <img src="https://images2.imgbox.com/c4/56/ujTHFf3n_o.png" style="margin-left:;display:block;width:595px;margin-top:-100.84033%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <h4 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">8、修改图像数据集的后缀和图片大小（修改mmrotate/mmrotate/datasets/dota.py）</span></h4> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:757px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:24.174374%;height:0;"> 
    <img src="https://images2.imgbox.com/f0/cb/7azdg3am_o.png" style="margin-left:;display:block;width:757px;margin-top:-24.174374%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:530px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:113.20755%;height:0;"> 
    <img src="https://images2.imgbox.com/36/27/sGPcRJen_o.png" style="margin-left:;display:block;width:530px;margin-top:-113.20755%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="4"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;"><h4>整个配置文件</h4></li></ol> 
 <pre class="kdocs-bash"><code class="language-bash">default_scope = 'mmrotate'
default_hooks = dict(
    timer=dict(type='IterTimerHook'),
    logger=dict(type='LoggerHook', interval=50),
    param_scheduler=dict(type='ParamSchedulerHook'),
    checkpoint=dict(type='CheckpointHook', interval=12, max_keep_ckpts=3),
    sampler_seed=dict(type='DistSamplerSeedHook'),
    visualization=dict(type='mmdet.DetVisualizationHook'))
env_cfg = dict(
    cudnn_benchmark=False,
    mp_cfg=dict(mp_start_method='fork', opencv_num_threads=0),
    dist_cfg=dict(backend='nccl'))
vis_backends = [dict(type='LocalVisBackend')]
visualizer = dict(
    type='RotLocalVisualizer',
    vis_backends=[dict(type='LocalVisBackend')],
    name='visualizer')
log_processor = dict(type='LogProcessor', window_size=50, by_epoch=True)
log_level = 'INFO'
load_from = '/media/lhy/mmrotate-1.0.0rc1/checkpoints/RTMDet/rotated_rtmdet_tiny-3x-dota-9d821076.pth'
resume = False
custom_hooks = [
    dict(type='mmdet.NumClassCheckHook'),
    dict(
        type='EMAHook',
        ema_type='mmdet.ExpMomentumEMA',
        momentum=0.0002,
        update_buffers=True,
        priority=49)#在训练时对模型进行指数移动平均运算，目的是提高模型的鲁棒性
]
max_epochs = 36
base_lr = 0.00025
interval = 12
train_cfg = dict(type='EpochBasedTrainLoop', max_epochs=36, val_interval=12)
val_cfg = dict(type='ValLoop')
test_cfg = dict(type='TestLoop')
param_scheduler = [
    dict(
        type='LinearLR', start_factor=1e-05, by_epoch=False, begin=0,
        end=1000),
    dict(
        type='CosineAnnealingLR',
        eta_min=1.25e-05,
        begin=18,
        end=36,
        T_max=18,
        by_epoch=True,
        convert_to_iter_based=True)
]
optim_wrapper = dict(
    type='OptimWrapper',#标准的单精度训练
    optimizer=dict(type='AdamW', lr=0.00025, weight_decay=0.05),
    paramwise_cfg=dict(
        norm_decay_mult=0, bias_decay_mult=0, bypass_duplicate=True))
#paramwise_cfg可以设置参数
#lr_mult：所有参数的学习率。
#decay_mult：所有参数的衰减系数。
#bias_lr_mult：偏置的学习率系数（不包括归一化层的偏置和可变形卷积的偏置）。
#bias_decay_mult：偏差的权重衰减系数（不包括归一化层的偏差和可变形卷积的偏移量）。
#norm_decay_mult：归一化层的权重和偏差的权重衰减系数。
#flat_decay_mult：一维参数的权重衰减系数。
#dwconv_decay_mult：深度卷积的衰减系数。
#bypass_duplicate: 是否跳过重复参数，默认为False.
#dcn_offset_lr_mult：可变形卷积的学习率。
dataset_type = 'DOTADataset'
data_root = 'data/DOTA/optship1280/'
file_client_args = dict(backend='disk')
train_pipeline = [
    dict(
        type='mmdet.LoadImageFromFile', file_client_args=dict(backend='disk')),
    dict(type='mmdet.LoadAnnotations', with_bbox=True, box_type='qbox'),
    dict(type='ConvertBoxType', box_type_mapping=dict(gt_bboxes='rbox')),
    dict(type='mmdet.Resize', scale=(1280, 1280), keep_ratio=True),
    dict(
        type='mmdet.RandomFlip',
        prob=0.75,
        direction=['horizontal', 'vertical', 'diagonal']),
    dict(
        type='RandomRotate',
        prob=0.5,
        angle_range=180,
        rect_obj_labels=[9, 11]),
    dict(
        type='mmdet.Pad', size=(1280, 1280),
        pad_val=dict(img=(114, 114, 114))),
    dict(type='mmdet.PackDetInputs')
]
val_pipeline = [
    dict(
        type='mmdet.LoadImageFromFile', file_client_args=dict(backend='disk')),
    dict(type='mmdet.Resize', scale=(1280, 1280), keep_ratio=True),
    dict(type='mmdet.LoadAnnotations', with_bbox=True, box_type='qbox'),
    dict(type='ConvertBoxType', box_type_mapping=dict(gt_bboxes='rbox')),
    dict(
        type='mmdet.Pad', size=(1280, 1280),
        pad_val=dict(img=(114, 114, 114))),
    dict(
        type='mmdet.PackDetInputs',
        meta_keys=('img_id', 'img_path', 'ori_shape', 'img_shape',
                   'scale_factor'))
]
test_pipeline = [
    dict(
        type='mmdet.LoadImageFromFile', file_client_args=dict(backend='disk')),
    dict(type='mmdet.Resize', scale=(1280, 1280), keep_ratio=True),
    dict(
        type='mmdet.Pad', size=(1280, 1280),
        pad_val=dict(img=(114, 114, 114))),
    dict(
        type='mmdet.PackDetInputs',
        meta_keys=('img_id', 'img_path', 'ori_shape', 'img_shape',
                   'scale_factor'))
]
train_dataloader = dict(
    batch_size=8,
    num_workers=8,
    persistent_workers=True,
    sampler=dict(type='DefaultSampler', shuffle=True),
    batch_sampler=None,
    pin_memory=False,
    dataset=dict(
        type='DOTADataset',
        data_root='data/DOTA/optship1280/',
        ann_file='trainval/obb_annfiles/',
        data_prefix=dict(img_path='trainval/images/'),
        img_shape=(1280, 1280),
        filter_cfg=dict(filter_empty_gt=True),
        pipeline=[
            dict(
                type='mmdet.LoadImageFromFile',
                file_client_args=dict(backend='disk')),
            dict(
                type='mmdet.LoadAnnotations', with_bbox=True, box_type='qbox'),
            dict(
                type='ConvertBoxType',
                box_type_mapping=dict(gt_bboxes='rbox')),
            dict(type='mmdet.Resize', scale=(1280, 1280), keep_ratio=True),
            dict(
                type='mmdet.RandomFlip',
                prob=0.75,
                direction=['horizontal', 'vertical', 'diagonal']),
            dict(
                type='RandomRotate',
                prob=0.5,
                angle_range=180,
                rect_obj_labels=[9, 11]),
            dict(
                type='mmdet.Pad',
                size=(1280, 1280),
                pad_val=dict(img=(114, 114, 114))),
            dict(type='mmdet.PackDetInputs')
        ]))
val_dataloader = dict(
    batch_size=1,
    num_workers=2,
    persistent_workers=True,
    drop_last=False,
    sampler=dict(type='DefaultSampler', shuffle=False),
    dataset=dict(
        type='DOTADataset',
        data_root='data/DOTA/optship1280/',
        ann_file='trainval/obb_annfiles/',
        data_prefix=dict(img_path='trainval/images/'),
        img_shape=(1280, 1280),
        test_mode=True,
        pipeline=[
            dict(
                type='mmdet.LoadImageFromFile',
                file_client_args=dict(backend='disk')),
            dict(type='mmdet.Resize', scale=(1280, 1280), keep_ratio=True),
            dict(
                type='mmdet.LoadAnnotations', with_bbox=True, box_type='qbox'),
            dict(
                type='ConvertBoxType',
                box_type_mapping=dict(gt_bboxes='rbox')),
            dict(
                type='mmdet.Pad',
                size=(1280, 1280),
                pad_val=dict(img=(114, 114, 114))),
            dict(
                type='mmdet.PackDetInputs',
                meta_keys=('img_id', 'img_path', 'ori_shape', 'img_shape',
                           'scale_factor'))
        ]))
test_dataloader = dict(
    batch_size=1,
    num_workers=2,
    persistent_workers=True,
    drop_last=False,
    sampler=dict(type='DefaultSampler', shuffle=False),
    dataset=dict(
        type='DOTADataset',
        data_root='data/DOTA/optship1280/',
        ann_file='val/obb_annfiles/',
        data_prefix=dict(img_path='val/images/'),
        img_shape=(1280, 1280),
        test_mode=True,
        pipeline=[
            dict(
                type='mmdet.LoadImageFromFile',
                file_client_args=dict(backend='disk')),
            dict(type='mmdet.Resize', scale=(1280, 1280), keep_ratio=True),
            dict(
                type='mmdet.LoadAnnotations', with_bbox=True, box_type='qbox'),
            dict(
                type='ConvertBoxType',
                box_type_mapping=dict(gt_bboxes='rbox')),
            dict(
                type='mmdet.Pad',
                size=(1280, 1280),
                pad_val=dict(img=(114, 114, 114))),
            dict(
                type='mmdet.PackDetInputs',
                meta_keys=('img_id', 'img_path', 'ori_shape', 'img_shape',
                           'scale_factor'))
        ]))
val_evaluator = dict(type='DOTAMetric', metric='mAP')#评估数据类型与指标
test_evaluator = dict(type='DOTAMetric', metric='mAP')
checkpoint = '/media/lhy/mmrotate-1.0.0rc1/work_dirs/pretrain/cspnext-tiny_imagenet_600e.pth'
angle_version = 'le90'
model = dict(
    type='mmdet.RTMDet',
    data_preprocessor=dict(
        type='mmdet.DetDataPreprocessor',
        mean=[103.53, 116.28, 123.675],
        std=[57.375, 57.12, 58.395],
        bgr_to_rgb=False,
        boxtype2tensor=False,
        batch_augments=None),
    backbone=dict(
        type='mmdet.CSPNeXt',
        arch='P5',
        expand_ratio=0.5,
        deepen_factor=0.167,
        widen_factor=0.375,
        channel_attention=True,
        norm_cfg=dict(type='SyncBN'),
        act_cfg=dict(type='SiLU'),
        init_cfg=dict(
            type='Pretrained',
            prefix='backbone.',
            checkpoint=
            '/media/lhy/mmrotate-1.0.0rc1/work_dirs/pretrain/cspnext-tiny_imagenet_600e.pth'
        )),
    neck=dict(
        type='mmdet.CSPNeXtPAFPN',
        in_channels=[96, 192, 384],
        out_channels=96,
        num_csp_blocks=1,
        expand_ratio=0.5,
        norm_cfg=dict(type='SyncBN'),
        act_cfg=dict(type='SiLU')),
    bbox_head=dict(
        type='RotatedRTMDetSepBNHead',
        num_classes=22,
        in_channels=96,
        stacked_convs=2,
        feat_channels=96,
        angle_version='le90',
        anchor_generator=dict(
            type='mmdet.MlvlPointGenerator', offset=0, strides=[8, 16, 32]),
        bbox_coder=dict(type='DistanceAnglePointCoder', angle_version='le90'),
        loss_cls=dict(
            type='mmdet.QualityFocalLoss',
            use_sigmoid=True,
            beta=2.0,
            loss_weight=1.0),
        loss_bbox=dict(type='RotatedIoULoss', mode='linear', loss_weight=2.0),
        with_objectness=False,
        exp_on_reg=False,
        share_conv=True,
        pred_kernel_size=1,
        use_hbbox_loss=False,
        scale_angle=False,
        loss_angle=None,
        norm_cfg=dict(type='SyncBN'),
        act_cfg=dict(type='SiLU')),
    train_cfg=dict(
        assigner=dict(
            type='mmdet.DynamicSoftLabelAssigner',
            iou_calculator=dict(type='RBboxOverlaps2D'),
            topk=13),
        allowed_border=-1,
        pos_weight=-1,
        debug=False),
    test_cfg=dict(
        nms_pre=2000,
        min_bbox_size=0,
        score_thr=0.05,
        nms=dict(type='nms_rotated', iou_threshold=0.1),
        max_per_img=2000))
launcher = 'none'
work_dir = 'work_dirs/runs/train/rtmdet_tiny_rrship/'
</code></pre> 
 <h2 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">3、模型训练</span></h2> 
 <h3 style="text-align:left;">1、Train with a single GPU</h3> 
 <pre class="kdocs-bash"><code class="language-bash">python tools/train.py ${CONFIG_FILE} [optional arguments]</code></pre> 
 <blockquote class="kdocs-blockquote" style="">
   如果你想在命令中指定工作目录，你可以添加一个参数–work_dir $[YOUR_WORK_DIR]。 
 </blockquote> 
 <h3 style="text-align:left;">2、Train with multiple GPUs</h3> 
 <pre class="kdocs-bash"><code class="language-bash">./tools/dist_train.sh ${CONFIG_FILE} ${GPU_NUM} [optional arguments]</code></pre> 
 <blockquote class="kdocs-blockquote" style="">
   Optional arguments are: 
  <br>–no-validate (not suggested): By default, the codebase will perform evaluation during the training. To disable this behavior, use --no-validate. 
  <br>–work-dir ${WORK_DIR}: Override the working directory specified in the config file. 
  <br>–resume-from ${CHECKPOINT_FILE}: Resume from a previous checkpoint file. 
  <br>Difference between resume-from and load-from: resume-from loads both the model weights and optimizer status, and the epoch is also inherited from the specified checkpoint. It is usually used for resuming the training process that is interrupted accidentally. load-from only loads the model weights and the training epoch starts from 0. It is usually used for finetuning. 
 </blockquote> 
 <h3 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">3、Train with multiple machines</span></h3> 
 <p style="">•如果你启动了多台连接以太网的机器，你可以简单地运行以下命令:</p> 
 <p style="">On the first machine:</p> 
 <pre class="kdocs-bash"><code class="language-bash">NNODES=2 NODE_RANK=0 PORT=$MASTER_PORT MASTER_ADDR=$MASTER_ADDR sh tools/dist_train.sh $CONFIG $GPUS</code></pre> 
 <p style="">On the second machine:</p> 
 <pre class="kdocs-bash"><code class="language-bash">NNODES=2 NODE_RANK=1 PORT=$MASTER_PORT MASTER_ADDR=$MASTER_ADDR sh tools/dist_train.sh $CONFIG $GPUS</code></pre> 
 <p style="">如果你没有像InfiniBand这样的高速网络，通常会很慢。</p> 
 <h3 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">4、Manage jobs with </span><a class="kdocs-link" style="color:#0A6CFF;" href="https://so.csdn.net/so/search?q=Slurm&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer"><span class="kdocs-bold" style="font-weight:bold;">Slurm</span></a></h3> 
 <p style="">如果在由slurm管理的集群上运行MMRotate，可以使用脚本slurm_train.sh。(此脚本也支持单机训练。)</p> 
 <pre class="kdocs-bash"><code class="language-bash">[GPUS=${GPUS}] ./tools/slurm_train.sh ${PARTITION} ${JOB_NAME} ${CONFIG_FILE} ${WORK_DIR}</code></pre> 
 <p style="">如果您有多台机器与以太网连接，您可以参考PyTorch启动实用程序<a class="kdocs-link" style="color:#0A6CFF;" href="https://pytorch.org/docs/stable/distributed_deprecated.html#launch-utility" rel="nofollow noopener noreferrer" target="_blank">添加链接描述</a>。如果你没有像InfiniBand这样的高速网络，通常会很慢</p> 
 <h3 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">5、在一台机器上启动多个作业</span></h3> 
 <p style="">如果您在一台机器上启动多个作业，例如，在一台有8个gpu的机器上启动2个4-GPU训练的作业，您需要为每个作业指定不同的端口(默认为29500)，以避免通信冲突。</p> 
 <p style="">If you use dist_train.sh to launch training jobs, you can set the port in commands.</p> 
 <pre class="kdocs-bash"><code class="language-bash">CUDA_VISIBLE_DEVICES=0,1,2,3 PORT=29500 ./tools/dist_train.sh ${CONFIG_FILE} 4
CUDA_VISIBLE_DEVICES=4,5,6,7 PORT=29501 ./tools/dist_train.sh ${CONFIG_FILE} 4
</code></pre> 
 <p style="">如果使用Slurm启动培训作业，则需要修改配置文件(通常是配置文件中倒数第6行)以设置不同的通信端口。</p> 
 <p style="">In config1.py,</p> 
 <p style="">dist_params = dict(backend=‘nccl’, port=29500)</p> 
 <p style="">In config2.py,</p> 
 <p style="">dist_params = dict(backend=‘nccl’, port=29501)</p> 
 <p style="">Then you can launch two jobs with config1.py and config2.py.</p> 
 <pre class="kdocs-bash"><code class="language-bash">CUDA_VISIBLE_DEVICES=0,1,2,3 GPUS=4 ./tools/slurm_train.sh ${PARTITION} ${JOB_NAME} config1.py ${WORK_DIR}
CUDA_VISIBLE_DEVICES=4,5,6,7 GPUS=4 ./tools/slurm_train.sh ${PARTITION} ${JOB_NAME} config2.py ${WORK_DIR}
</code></pre> 
 <h3 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">6、开始启动模型训练</span></h3> 
 <h4 style="">1、启动模型训练命令</h4> 
 <pre class="kdocs-bash"><code class="language-bash">python tools/train.py  configs/rotated_rtmdet/rotated_rtmdet_tiny-3x-dota.py --work-dir work_dirs/runs/train/rtmdet_tiny_rrship/</code></pre> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1608px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:26.119404%;height:0;"> 
    <img src="https://images2.imgbox.com/07/14/AlLyJDdv_o.png" style="margin-left:;display:block;width:1608px;margin-top:-26.119404%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <h4 style="">2、模型训练结果</h4> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:662px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:39.728096%;height:0;"> 
    <img src="https://images2.imgbox.com/7d/16/NibIy2Gg_o.png" style="margin-left:;display:block;width:662px;margin-top:-39.728096%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:982px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:19.144602%;height:0;"> 
    <img src="https://images2.imgbox.com/70/e1/A58uNC7O_o.png" style="margin-left:;display:block;width:982px;margin-top:-19.144602%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <pre class="kdocs-bash"><code class="language-bash">
</code></pre> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:428px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:124.76636%;height:0;"> 
    <img src="https://images2.imgbox.com/03/72/KBgJLsmn_o.png" style="margin-left:;display:block;width:428px;margin-top:-124.76636%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">模型验证发现模型检测的目标远远多于真实的目标，我们修改配置文件的训练数据集路径为trainval，扩大训练样本。</p> 
 <h2 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">4、mmrotate模型测试</span></h2> 
 <h3 style="">修改模型测试评估的域值map(mmrotate/evaluation/metrics/dota_metric.py)</h3> 
 <p style="">模型默认的iou阈值为0.5，可以修改为0.75等。</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:566px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:106.007065%;height:0;"> 
    <img src="https://images2.imgbox.com/3f/4f/i5JwZAf6_o.png" style="margin-left:;display:block;width:566px;margin-top:-106.007065%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="text-align:null;">single GPU</p> 
 <p style="text-align:null;">single node multiple GPU</p> 
 <p style="text-align:null;">multiple node</p> 
 <p style="text-align:null;">可以使用以下命令推断数据集。</p> 
 <pre class="kdocs-bash"><code class="language-bash"># single-gpu
python tools/test.py ${CONFIG_FILE} ${CHECKPOINT_FILE} [optional arguments]

# multi-gpu
./tools/dist_test.sh ${CONFIG_FILE} ${CHECKPOINT_FILE} ${GPU_NUM} [optional arguments]

# multi-node in slurm environment
python tools/test.py ${CONFIG_FILE} ${CHECKPOINT_FILE} [optional arguments] --launcher slurm
</code></pre> 
 <p style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">例子：</span></p> 
 <p style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">在DOTA-1.0数据集上推理RotatedRetinaNet，可以生成压缩文件在线</span><a class="kdocs-link" style="color:#0A6CFF;" href="https://captain-whu.github.io/DOTA/evaluation.html" rel="nofollow noopener noreferrer" target="_blank"><span class="kdocs-bold" style="font-weight:bold;">提交</span></a><span class="kdocs-bold" style="font-weight:bold;">。（请先更改</span><a class="kdocs-link" style="color:#0A6CFF;" href="https://github.com/open-mmlab/mmrotate/tree/main/configs/_base_/datasets/dotav1.py" target="_blank" rel="noopener noreferrer"><span class="kdocs-bold" style="font-weight:bold;"><span class="kdocs-underline" style="text-decoration:underline;">data_root</span></span></a><span class="kdocs-bold" style="font-weight:bold;">。）</span></p> 
 <pre class="kdocs-bash"><code class="language-bash">python ./tools/test.py  \
  configs/rotated_retinanet/rotated-retinanet-rbox-le90_r50_fpn_1x_dota.py \
  checkpoints/SOME_CHECKPOINT.pth --format-only \
  --eval-options submission_dir=work_dirs/Task1_results</code></pre> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">或者</span></p> 
 <pre class="kdocs-bash"><code class="language-bash">./tools/dist_test.sh  \
  configs/rotated_retinanet/rotated-retinanet-rbox-le90_r50_fpn_1x_dota.py \
  checkpoints/SOME_CHECKPOINT.pth 1 --format-only \
  --eval-options submission_dir=work_dirs/Task1_results</code></pre> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">您可以将</span><a class="kdocs-link" style="color:#0A6CFF;" href="https://github.com/open-mmlab/mmrotate/tree/main/configs/_base_/datasets/dotav1.py" target="_blank" rel="noopener noreferrer"><span class="kdocs-bold" style="font-weight:bold;">data_root</span></a><span class="kdocs-bold" style="font-weight:bold;">中的test set路径改为val set或trainval set进行离线评估。</span></p> 
 <pre class="kdocs-bash"><code class="language-bash">python ./tools/test.py \
  configs/rotated_retinanet/rotated-retinanet-rbox-le90_r50_fpn_1x_dota.py \
  checkpoints/SOME_CHECKPOINT.pth --eval mAP</code></pre> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">或者</span></p> 
 <pre class="kdocs-bash"><code class="language-bash">./tools/dist_test.sh  \
  configs/rotated_retinanet/rotated-retinanet-rbox-le90_r50_fpn_1x_dota.py \
  checkpoints/SOME_CHECKPOINT.pth 1 --eval mAP</code></pre> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">您还可以可视化结果。</span></p> 
 <pre class="kdocs-bash"><code class="language-bash">python ./tools/test.py \
  configs/rotated_retinanet/rotated-retinanet-rbox-le90_r50_fpn_1x_dota.py \
  checkpoints/SOME_CHECKPOINT.pth \
  --show-dir work_dirs/vis</code></pre> 
 <p style=""></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/35912b2a0df208f449074ded59d95a24/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于Python 处理 MODIS 遥感数据</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a25e61f584a04b5b8784fd3c27c20881/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决Windows10、11 远程桌面时提示用户名、密码错误的情况（实际用户名、密码正确）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>