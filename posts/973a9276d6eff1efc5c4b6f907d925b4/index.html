<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8S--部署SpringBoot调用MySQL（实战） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8S--部署SpringBoot调用MySQL（实战）" />
<meta property="og:description" content="原文网址：K8S--部署SpringBoot调用MySQL（实战）-CSDN博客
简介 本文介绍K8S部署SpringBoot调用MySQL的实战案例。
分享Java真实高频面试题，吊打面试官： Java后端真实面试题大全 - 自学精灵
分享靠谱的Java高级实战，包含：高并发、架构、全局处理等：JavaWeb高级实战 - 自学精灵
1.部署MySQL 见：K8S--部署SpringBoot调用MySQL（实战）-CSDN博客
部署之后，创建数据库和表：
DROP DATABASE IF EXISTS mp; CREATE DATABASE mp DEFAULT CHARACTER SET utf8; USE mp; DROP TABLE IF EXISTS `t_user`; SET NAMES utf8mb4; CREATE TABLE `t_user` ( `id` BIGINT(0) NOT NULL, `user_name` VARCHAR(64) NOT NULL COMMENT &#39;用户名（不能重复）&#39;, `nick_name` VARCHAR(64) NULL COMMENT &#39;昵称（可以重复）&#39;, `email` VARCHAR(64) COMMENT &#39;邮箱&#39;, `create_time` DATETIME(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, `update_time` DATETIME(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;, `deleted_flag` BIGINT(0) NOT NULL DEFAULT 0 COMMENT &#39;0：未删除 其他：已删除&#39;, PRIMARY KEY (`id`) USING BTREE, UNIQUE KEY `index_user_name_deleted_flag` (`user_name`, `deleted_flag`), KEY `index_create_time`(`create_time`) ) ENGINE = InnoDB COMMENT = &#39;用户&#39;; INSERT INTO `t_user` VALUES (1, &#39;knife&#39;, &#39;刀刃&#39;, &#39;abc@qq." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/973a9276d6eff1efc5c4b6f907d925b4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-07T23:30:00+08:00" />
<meta property="article:modified_time" content="2024-01-07T23:30:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8S--部署SpringBoot调用MySQL（实战）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>原文网址：<a href="https://knife.blog.csdn.net/article/details/135415853" rel="nofollow" title="K8S--部署SpringBoot调用MySQL（实战）-CSDN博客">K8S--部署SpringBoot调用MySQL（实战）-CSDN博客</a></p> 
<h2>简介</h2> 
<p>本文介绍K8S部署SpringBoot调用MySQL的实战案例。</p> 
<p id="ua01eb6ae">分享Java真实高频面试题，吊打面试官： <a href="https://learn.skyofit.com/archives/66" rel="nofollow" title="Java后端真实面试题大全 - 自学精灵">Java后端真实面试题大全 - 自学精灵</a><br> 分享靠谱的Java高级实战，包含：高并发、架构、全局处理等：<a href="https://learn.skyofit.com/archives/1510" rel="nofollow" title="JavaWeb高级实战 - 自学精灵">JavaWeb高级实战 - 自学精灵</a></p> 
<h2>1.部署MySQL</h2> 
<p>见：<a href="https://knife.blog.csdn.net/article/details/135415853" rel="nofollow" title="K8S--部署SpringBoot调用MySQL（实战）-CSDN博客">K8S--部署SpringBoot调用MySQL（实战）-CSDN博客</a></p> 
<p>部署之后，创建数据库和表：</p> 
<pre><code class="language-sql">DROP DATABASE IF EXISTS mp;
CREATE DATABASE mp DEFAULT CHARACTER SET utf8;
USE mp;

DROP TABLE IF EXISTS `t_user`;
SET NAMES utf8mb4;

CREATE TABLE `t_user`
(
    `id`           BIGINT(0) NOT NULL,
    `user_name`    VARCHAR(64) NOT NULL COMMENT '用户名（不能重复）',
    `nick_name`    VARCHAR(64) NULL COMMENT '昵称（可以重复）',
    `email`        VARCHAR(64) COMMENT '邮箱',
    `create_time`  DATETIME(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time`  DATETIME(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
    `deleted_flag` BIGINT(0) NOT NULL DEFAULT 0 COMMENT '0：未删除 其他：已删除',
    PRIMARY KEY (`id`) USING BTREE,
    UNIQUE KEY `index_user_name_deleted_flag` (`user_name`, `deleted_flag`),
    KEY `index_create_time`(`create_time`)
) ENGINE = InnoDB COMMENT = '用户';

INSERT INTO `t_user` VALUES (1, 'knife', '刀刃', 'abc@qq.com', '2021-01-23 09:33:36', '2021-01-23 09:33:36', 0);
INSERT INTO `t_user` VALUES (2, 'sky', '天蓝', '123@qq.com', '2021-01-24 18:12:21', '2021-01-24 18:12:21', 0);
INSERT INTO `t_user` VALUES (3, 'aa', '昵称1', '333@qq.com', '2021-01-12 13:12:21', '2021-01-12 13:12:21', 0);
INSERT INTO `t_user` VALUES (4, 'bb', '昵称2', '444@qq.com', '2021-02-11 18:12:21', '2021-02-11 18:12:21', 0);
INSERT INTO `t_user` VALUES (5, 'cc', '昵称3', '555@qq.com', '2021-03-24 18:12:21', '2021-03-24 18:12:21', 0);
</code></pre> 
<h2>2.创建SpringBoot项目</h2> 
<p><strong>application.yml</strong></p> 
<pre><code class="language-sql">spring:
  application:
    name: springboot-mysql
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    # 用${}表达式替代，镜像部署时可以使用环境变量指定
    url: jdbc:mysql://${MYSQL_HOST:mysql}:${MYSQL_PORT:3306}/mp?characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:222333}

#mybatis-plus配置控制台打印完整带参数SQL语句
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

logging:
  file:
    # 根据pod名字生成日志文件
    name: log/${POD_NAME}.log
  level:
    root: info
</code></pre> 
<p><strong>Controller</strong></p> 
<pre><code class="language-java">package com.knife.example.business.user.controller;

import com.knife.example.business.user.bo.UserBO;
import com.knife.example.business.user.entity.User;
import com.knife.example.business.user.service.UserService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@Api(tags = "用户")
@RestController
@RequestMapping("/user")
public class UserController {
    @Autowired
    private UserService userService;

    @ApiOperation("查找")
    @GetMapping("find")
    public List&lt;User&gt; find(UserBO userBO) {
        return userService.lambdaQuery()
                .like(StringUtils.hasText(userBO.getUserName()), User::getUserName, userBO.getUserName())
                .list();
    }
}
</code></pre> 
<p><strong>Dockerfile</strong></p> 
<pre><code class="language-bash"># 基础镜像使用java
# 也可以用：FROM openjdk:8
FROM java:8

# 作者
MAINTAINER knife &lt;xxx@xx.com&gt;

# 不是真正的发布端口，只是容器部署人员与建立image的人员之间的交流。
# 即：建立image的人员告诉容器布署人员容器应该映射哪个端口给外界
EXPOSE 8080

# 指定临时文件目录，此步骤非必须。如果Java里要操作文件，就要添加这个配置
# 会在主机 /var/lib/docker 创建文件，连接到容器的/tmp。SpringBoot的内嵌Tomcat默认使用/tmp作为工作目录
VOLUME /tmp

# 将jar包添加到容器中并更名为app.jar
ADD *.jar app.jar

ENV JAVA_OPTS=""

# ENTRYPOINT：docker启动时，运行的命令。这里直接运行jar服务。
ENTRYPOINT [ "sh", "-c", "java $JAVA_OPTS -jar /app.jar --spring.profiles.active=default" ]</code></pre> 
<p><strong>pom.xml</strong></p> 
<pre><code class="language-XML">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.4.13&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;
    &lt;groupId&gt;com.knife&lt;/groupId&gt;
    &lt;artifactId&gt;springboot-mysql&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;springboot-mysql&lt;/name&gt;
    &lt;description&gt;Demo project for Docker Spring Boot&lt;/description&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.github.xiaoymin&lt;/groupId&gt;
            &lt;artifactId&gt;knife4j-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;3.0.3&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;version&gt;1.18.24&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;3.5.1&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre> 
<h2>3.生成并推送应用的docker镜像</h2> 
<p>详见：<a href="https://knife.blog.csdn.net/article/details/135201415" rel="nofollow" title="K8S--部署SpringBoot项目实战-CSDN博客">K8S--部署SpringBoot项目实战-CSDN博客</a></p> 
<p>这个链接里有harbor的搭建及项目的创建、SpringBoot项目的打包等。</p> 
<p>这里只展示命令：</p> 
<pre><code class="language-XML">docker rmi 192.168.5.193:15001/custom_image/custom_springboot-mysql:1.0 --force
docker build -t 192.168.5.193:15001/custom_image/custom_springboot-mysql:1.0 . --no-cache
docker push 192.168.5.193:15001/custom_image/custom_springboot-mysql:1.0</code></pre> 
<p>推送上去后，可以在harbor里看到：</p> 
<p> <img alt="" height="695" src="https://images2.imgbox.com/1d/d0/yLEGyK3X_o.png" width="1200"></p> 
<h2>4.编写应用的K8S配置文件</h2> 
<h3>1.创建命名空间</h3> 
<p>创建名为java-app-namespace.yaml的文件，内容如下：</p> 
<pre><code class="language-bash"># 创建命名空间
apiVersion: v1
kind: Namespace
metadata:
  name: java-app
  labels:
    name: java-app
</code></pre> 
<p>创建命名空间：</p> 
<pre><code class="language-bash">kubectl apply -f java-app-namespace.yaml</code></pre> 
<h3>2.创建应用的K8S配置文件</h3> 
<p>创建应用的k8s配置文件：k8s.yaml，内容如下：</p> 
<pre><code class="language-bash"># 创建Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: springboot-mysql-deployment
  namespace: java-app
  labels:
    app: springboot-mysql #与Service的selector对应
spec:
  # 副本的数量
  replicas: 2
  selector:
    # 选择Pod
    matchLabels:
      app: springboot-mysql
  # 选择或创建的Pod的模板
  template:
    metadata:
      # 与Deployment的selector对应
      labels:
        app: springboot-mysql
    spec:
      imagePullSecrets:
        - name: harbor-secret

      containers:
        - image: 192.168.5.193:15001/custom_image/custom_springboot-mysql:1.0
          name: custom-springboot-mysql-1-0
          imagePullPolicy: Always
          env:
            - name: TZ
              value: Asia/Shanghai
            - name: MYSQL_HOST
              value: mysql-service.db
            - name: MYSQL_PORT
              value: "3306"
            - name: MYSQL_USERNAME
              value: root
            - name: MYSQL_PASSWORD
              value: "123456"
            - name: POD_NAME   #用Pod名字给日志文件命名，防止多个pod日志输出到同一日志文件
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          ports:
            - containerPort: 8080
              name: pod-8080
          # 容器内的路径
          volumeMounts:
            - name: log
              mountPath: /log/
      # 主机的路径
      volumes:
        - name: log #和volumeMounts中的内容要对应
          hostPath:
            path: /work/devops/k8s/app/springboot-mysql/log/
            type: DirectoryOrCreate

---
# 创建Service
apiVersion: v1
kind: Service
metadata:
  name: springboot-mysql-service
  namespace: java-app
  labels:
    app: springboot-mysql
spec:
  ports:
    - name: springboot-mysql-port
      port: 9001   # Service监听的端口
      targetPort: 8080  # pod自身暴露的端口。对应Deployment的containerPort
      # 对外的端口号
      nodePort: 30006
  # 选择Deployment
  selector:
    app: springboot-mysql
  # NodePort类型可以对外暴露端口
  type: NodePort</code></pre> 
<p>注意</p> 
<p>k8s在与其他服务通信时，需要注意主机指定</p> 
<ol><li>如果命名空间相同，host用对方服务的Service。</li><li>如果命名空间相同，host用对方服务的Service:Namespace。</li></ol> 
<p>本处mysql的服务名是mysql-service，命名空间是db，所以是：mysql-service:db</p> 
<h2>5.启动应用的Pod</h2> 
<pre><code class="language-bash">kubectl apply -f k8s.yaml</code></pre> 
<h2>6.查看启动结果并测试</h2> 
<h3>1.查看pods</h3> 
<pre><code class="language-bash">kubectl get pods -A</code></pre> 
<p> 结果：</p> 
<p><img alt="" height="164" src="https://images2.imgbox.com/a8/17/zU5itbqI_o.png" width="1200"></p> 
<h3>2.查看dashboard</h3> 
<p><img alt="" height="705" src="https://images2.imgbox.com/a6/50/UAx59g6V_o.png" width="1200"></p> 
<h3>3.查看日志 </h3> 
<p>可以发现，每个pod都单独生成了日志。（pod在销毁、重新生成后，会生成新的日志文件。）</p> 
<p><img alt="" height="117" src="https://images2.imgbox.com/44/e0/RnF9c4VR_o.png" width="1200"></p> 
<h3 style="background-color:transparent;">4.测试接口</h3> 
<p>访问接口文档：<a href="http://192.168.5.193:30006/doc.html" rel="nofollow" title="http://192.168.5.193:30006/doc.html">http://192.168.5.193:30006/doc.html</a></p> 
<p>测试接口：（成功查到数据库数据） <img alt="" height="954" src="https://images2.imgbox.com/48/fa/MZodrXJK_o.png" width="1200"></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a7059d0b8bf8e39b9b090f3a18e59b58/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">20240107让Firefly的AIO-3399J开发板的Android11下配置为默认1080p录像</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ad33054cd658c7b50d8056308c98f889/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;中的运算符与函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>