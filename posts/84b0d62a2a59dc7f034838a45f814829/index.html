<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于linux的I2C驱动与调试（传统ID匹配方式） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于linux的I2C驱动与调试（传统ID匹配方式）" />
<meta property="og:description" content="基于linux的I2C驱动与调试（传统ID匹配方式） 1.Linux I2C驱动框架1.1. I2C驱动的主要对象1.1.1. I2C总线1.1.2. I2C设备1.1.3. I2C驱动1.1.4. I2C适配器1.1.5. 总结一下 1.2. I2C框架分析1.3. I2C流程分析 2.Linux I2C驱动框架源码剖析2.1.注册I2C设备2.2.注册I2C驱动2.3. I2C适配器的构建2.4. I2C数据传输 3.I2C背景了解3.1.物理接口3.2通信特征 4. I2C时序图4.1. I2C起始信号4.2. I2C终止信号4.3. I2C应答信号4.4. I2C写时序4.5. I2C读时序 5. I2C实际操作图解5.1.写操作5.2.读操作5.3. 驱动代码 6.总结 1.Linux I2C驱动框架 I2C驱动框架可以分为四部分，I2C核心、I2C设备、I2C驱动、I2C适配器，其中I2C总线位于I2C核心中。
1.1. I2C驱动的主要对象 2C总线用于管理I2C设备和I2C驱动，维护一个设备链表和驱动链表，定义了设备和驱动的匹配规则，定义了匹配成功后的行为，其在内核中的定义如下。
1.1.1. I2C总线 struct bus_type i2c_bus_type = { .name	= &#34;i2c&#34;, .match	= i2c_device_match, .probe	= i2c_device_probe, .remove	= i2c_device_remove, .shutdown	= i2c_device_shutdown, .pm	= &amp;i2c_device_pm_ops, }; 1.1.2. I2C设备 I2C设备描述了I2C设备的硬件信息，例如I2C设备的地址、I2C设备在接在哪一个I2C控制器上，其结构体定义如下
struct i2c_client { unsigned short flags;	/* div." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/84b0d62a2a59dc7f034838a45f814829/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-12T15:25:57+08:00" />
<meta property="article:modified_time" content="2021-05-12T15:25:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于linux的I2C驱动与调试（传统ID匹配方式）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>基于linux的I2C驱动与调试（传统ID匹配方式）</h4> 
 <ul><li><a href="#1Linux_I2C_2" rel="nofollow">1.Linux I2C驱动框架</a></li><li><ul><li><a href="#11_I2C_5" rel="nofollow">1.1. I2C驱动的主要对象</a></li><li><ul><li><a href="#111_I2C_7" rel="nofollow">1.1.1. I2C总线</a></li><li><a href="#112_I2C_18" rel="nofollow">1.1.2. I2C设备</a></li><li><a href="#113_I2C_35" rel="nofollow">1.1.3. I2C驱动</a></li><li><a href="#114_I2C_53" rel="nofollow">1.1.4. I2C适配器</a></li><li><a href="#115__81" rel="nofollow">1.1.5. 总结一下</a></li></ul> 
   </li><li><a href="#12_I2C_89" rel="nofollow">1.2. I2C框架分析</a></li><li><a href="#13_I2C_95" rel="nofollow">1.3. I2C流程分析</a></li></ul> 
  </li><li><a href="#2Linux_I2C_97" rel="nofollow">2.Linux I2C驱动框架源码剖析</a></li><li><ul><li><a href="#21I2C_98" rel="nofollow">2.1.注册I2C设备</a></li><li><a href="#22I2C_265" rel="nofollow">2.2.注册I2C驱动</a></li><li><a href="#23_I2C_334" rel="nofollow">2.3. I2C适配器的构建</a></li><li><a href="#24_I2C_358" rel="nofollow">2.4. I2C数据传输</a></li></ul> 
  </li><li><a href="#3I2C_371" rel="nofollow">3.I2C背景了解</a></li><li><ul><li><a href="#31_372" rel="nofollow">3.1.物理接口</a></li><li><a href="#32_379" rel="nofollow">3.2通信特征</a></li></ul> 
  </li><li><a href="#4_I2C_388" rel="nofollow">4. I2C时序图</a></li><li><ul><li><a href="#41_I2C_389" rel="nofollow">4.1. I2C起始信号</a></li><li><a href="#42_I2C_393" rel="nofollow">4.2. I2C终止信号</a></li><li><a href="#43_I2C_398" rel="nofollow">4.3. I2C应答信号</a></li><li><a href="#44_I2C_402" rel="nofollow">4.4. I2C写时序</a></li><li><a href="#45_I2C_407" rel="nofollow">4.5. I2C读时序</a></li></ul> 
  </li><li><a href="#5_I2C_411" rel="nofollow">5. I2C实际操作图解</a></li><li><ul><li><a href="#51_414" rel="nofollow">5.1.写操作</a></li><li><a href="#52_424" rel="nofollow">5.2.读操作</a></li><li><a href="#53__439" rel="nofollow">5.3. 驱动代码</a></li></ul> 
  </li><li><a href="#6_697" rel="nofollow">6.总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1Linux_I2C_2"></a>1.Linux I2C驱动框架</h2> 
<p>I2C驱动框架可以分为四部分，I2C核心、I2C设备、I2C驱动、I2C适配器，其中I2C总线位于I2C核心中。<br> <img src="https://images2.imgbox.com/fb/ea/dF5aT60H_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="11_I2C_5"></a>1.1. I2C驱动的主要对象</h3> 
<p>2C总线用于管理I2C设备和I2C驱动，维护一个设备链表和驱动链表，定义了设备和驱动的匹配规则，定义了匹配成功后的行为，其在内核中的定义如下。</p> 
<h4><a id="111_I2C_7"></a>1.1.1. I2C总线</h4> 
<pre><code class="prism language-javascript">struct bus_type i2c_bus_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name		<span class="token operator">=</span> <span class="token string">"i2c"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>match		<span class="token operator">=</span> i2c_device_match<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe		<span class="token operator">=</span> i2c_device_probe<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>remove		<span class="token operator">=</span> i2c_device_remove<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>shutdown	<span class="token operator">=</span> i2c_device_shutdown<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>pm		<span class="token operator">=</span> <span class="token operator">&amp;</span>i2c_device_pm_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="112_I2C_18"></a>1.1.2. I2C设备</h4> 
<p>I2C设备描述了I2C设备的硬件信息，例如I2C设备的地址、I2C设备在接在哪一个I2C控制器上，其结构体定义如下</p> 
<pre><code class="prism language-javascript">struct i2c_client <span class="token punctuation">{<!-- --></span>
	unsigned short flags<span class="token punctuation">;</span>		<span class="token comment">/* div., see below		*/</span>
	unsigned short addr<span class="token punctuation">;</span>		<span class="token comment">/* chip address - NOTE: 7bit	*/</span>
					<span class="token comment">/* addresses are stored in the	*/</span>
					<span class="token comment">/* _LOWER_ 7 bits		*/</span>
	char name<span class="token punctuation">[</span><span class="token constant">I2C_NAME_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	struct i2c_adapter <span class="token operator">*</span>adapter<span class="token punctuation">;</span>	<span class="token comment">/* the adapter we sit on	*/</span>
	struct i2c_driver <span class="token operator">*</span>driver<span class="token punctuation">;</span>	<span class="token comment">/* and our access routines	*/</span>
	struct device dev<span class="token punctuation">;</span>		<span class="token comment">/* the device structure		*/</span>
	int irq<span class="token punctuation">;</span>			<span class="token comment">/* irq issued by device		*/</span>
	struct list_head detected<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="113_I2C_35"></a>1.1.3. I2C驱动</h4> 
<p>I2C驱动是I2C设备的驱动程序，用于匹配I2C设备，其结构体定义如下。</p> 
<pre><code class="prism language-javascript">struct i2c_driver <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	<span class="token comment">/* Standard driver model interfaces */</span>
	<span class="token function">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span><span class="token punctuation">(</span>struct i2c_client <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> struct i2c_device_id <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span><span class="token punctuation">(</span>struct i2c_client <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* driver model interfaces that don't relate to enumeration  */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">(</span>struct i2c_client <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span><span class="token punctuation">(</span>struct i2c_client <span class="token operator">*</span><span class="token punctuation">,</span> pm_message_t mesg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span><span class="token punctuation">(</span>struct i2c_client <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
	struct list_head clients<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="114_I2C_53"></a>1.1.4. I2C适配器</h4> 
<p>I2C适配器是SOC上的I2C控制器的软件抽象，可以通过其定义的算法向硬件设备传输数据，其结构体定义如下。</p> 
<pre><code class="prism language-javascript">struct i2c_adapter <span class="token punctuation">{<!-- --></span>
	struct module <span class="token operator">*</span>owner<span class="token punctuation">;</span>
	unsigned int <span class="token keyword">class</span><span class="token punctuation">;</span>		  <span class="token comment">/* classes to allow probing for */</span>
	<span class="token keyword">const</span> struct i2c_algorithm <span class="token operator">*</span>algo<span class="token punctuation">;</span> <span class="token comment">/* the algorithm to access the bus */</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>algo_data<span class="token punctuation">;</span>
	<span class="token operator">...</span>
	struct device dev<span class="token punctuation">;</span>		<span class="token comment">/* the adapter device */</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>其中的i2c_algorithm表示算法，用于向硬件设备传输数据，其定义如下。</p> 
<pre><code class="prism language-javascript">struct i2c_algorithm <span class="token punctuation">{<!-- --></span>
	<span class="token function">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>master_xfer<span class="token punctuation">)</span><span class="token punctuation">(</span>struct i2c_adapter <span class="token operator">*</span>adap<span class="token punctuation">,</span> struct i2c_msg <span class="token operator">*</span>msgs<span class="token punctuation">,</span>
			   int num<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>smbus_xfer<span class="token punctuation">)</span> <span class="token punctuation">(</span>struct i2c_adapter <span class="token operator">*</span>adap<span class="token punctuation">,</span> u16 addr<span class="token punctuation">,</span>
			   unsigned short flags<span class="token punctuation">,</span> char read_write<span class="token punctuation">,</span>
			   u8 command<span class="token punctuation">,</span> int size<span class="token punctuation">,</span> union i2c_smbus_data <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* To determine what the adapter supports */</span>
	<span class="token function">u32</span> <span class="token punctuation">(</span><span class="token operator">*</span>functionality<span class="token punctuation">)</span> <span class="token punctuation">(</span>struct i2c_adapter <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="115__81"></a>1.1.5. 总结一下</h4> 
<p>I2C驱动的主要对象是I2C总线、I2C设备、I2C驱动、I2C适配器<br> I2C总线用于管理I2C设备和I2C驱动<br> I2C设备描述了I2C设备的硬件信息<br> I2C驱动是I2C设备对应的驱动程序<br> I2C适配器是SOC上的I2C控制器，其定义了算法，可以向I2C硬件设备传输数据<br> 其中直接面向编写I2C设备驱动的开发者的是I2C设备和I2C驱动，I2C总线和I2C适配器是幕后工作者</p> 
<h3><a id="12_I2C_89"></a>1.2. I2C框架分析</h3> 
<p>I2C核心维护着一条I2C总线，提供了注册I2C设备、I2C驱动、I2C适配器的接口。<br> I2C总线维护着一条设备链表和驱动链表，当向I2C核心层注册设备时，会将其添加到总线的设备链表中，然后遍历总线上的驱动链表，查看二者是否匹配，如果匹配就调用驱动的probe函数。<br> 当注册I2C驱动时，也会将其添加到I2C总线的驱动链表中，然后遍历总线的设备链表，查看二者是否匹配，如果匹配就调用驱动的probe函数。<br> 在I2C驱动程序中，通过I2C适配器中的算法向I2C硬件设备传输数据。</p> 
<h3><a id="13_I2C_95"></a>1.3. I2C流程分析</h3> 
<p><img src="https://images2.imgbox.com/7f/b7/HuTXvEeh_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2Linux_I2C_97"></a>2.Linux I2C驱动框架源码剖析</h2> 
<h3><a id="21I2C_98"></a>2.1.注册I2C设备</h3> 
<p>（1）注册I2C适配可以通过i2c_new_device，此函数会生成一个i2c_client，指定对应的总线为I2C总线，然后向总线注册设备。</p> 
<pre><code class="prism language-javascript">struct i2c_client <span class="token operator">*</span>
<span class="token function">i2c_new_device</span><span class="token punctuation">(</span>struct i2c_adapter <span class="token operator">*</span>adap<span class="token punctuation">,</span> struct i2c_board_info <span class="token keyword">const</span> <span class="token operator">*</span>info<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	struct i2c_client	<span class="token operator">*</span>client<span class="token punctuation">;</span>
	client <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>sizeof <span class="token operator">*</span>client<span class="token punctuation">,</span> <span class="token constant">GFP_KERNEL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	client<span class="token operator">-</span><span class="token operator">&gt;</span>dev<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>i2c_bus_type<span class="token punctuation">;</span>
	<span class="token operator">...</span>
	status <span class="token operator">=</span> <span class="token function">device_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-</span><span class="token operator">&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（2）看一下其中的i2c_bus_type对象，其表示I2C总线，定义了设备和驱动的匹配规则还有匹配成功后的行为。</p> 
<pre><code class="prism language-javascript">struct bus_type i2c_bus_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name		<span class="token operator">=</span> <span class="token string">"i2c"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>match		<span class="token operator">=</span> i2c_device_match<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe		<span class="token operator">=</span> i2c_device_probe<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>remove		<span class="token operator">=</span> i2c_device_remove<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>shutdown	<span class="token operator">=</span> i2c_device_shutdown<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>pm		<span class="token operator">=</span> <span class="token operator">&amp;</span>i2c_device_pm_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>（3）下面再来看看device_register向总线注册设备过程中会发生什么。device_register首先会将设备添加到总线的设备链表中，然后遍历总线的驱动链表，判断设备和驱动是否匹配，如果匹配就调用驱动的probe函数，下面看一看源码分析。</p> 
<pre><code class="prism language-javascript">int <span class="token function">device_register</span><span class="token punctuation">(</span>struct device <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">device_initialize</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">device_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">int <span class="token function">device_add</span><span class="token punctuation">(</span>struct device <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	error <span class="token operator">=</span> <span class="token function">bus_add_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
	<span class="token function">bus_probe_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（4）其中bus_add_device函数会将设备添加到总线的设备链表中，如下。</p> 
<pre><code class="prism language-javascript">int <span class="token function">bus_add_device</span><span class="token punctuation">(</span>struct device <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span><span class="token punctuation">.</span>
	<span class="token function">klist_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">&gt;</span>p<span class="token operator">-</span><span class="token operator">&gt;</span>knode_bus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus<span class="token operator">-</span><span class="token operator">&gt;</span>p<span class="token operator">-</span><span class="token operator">&gt;</span>klist_devices<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（5）bus_probe_device函数会遍历总线的驱动链表，如下。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">void</span> <span class="token function">bus_probe_device</span><span class="token punctuation">(</span>struct device <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bus<span class="token operator">-</span><span class="token operator">&gt;</span>p<span class="token operator">-</span><span class="token operator">&gt;</span>drivers_autoprobe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token function">device_attach</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token constant">WARN_ON</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">int <span class="token function">device_attach</span><span class="token punctuation">(</span>struct device <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	ret <span class="token operator">=</span> <span class="token function">bus_for_each_drv</span><span class="token punctuation">(</span>dev<span class="token operator">-</span><span class="token operator">&gt;</span>bus<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> dev<span class="token punctuation">,</span> __device_attach<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（6）bus_for_each_drv(dev-&gt;bus, NULL, dev, __device_attach);会遍历总线的驱动链表的每一项，然后调用__device_attach。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">static</span> int <span class="token function">__driver_attach</span><span class="token punctuation">(</span>struct device <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	struct device_driver <span class="token operator">*</span>drv <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">driver_match_device</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-</span><span class="token operator">&gt;</span>parent<span class="token punctuation">)</span>	<span class="token comment">/* Needed for USB */</span>
		<span class="token function">device_lock</span><span class="token punctuation">(</span>dev<span class="token operator">-</span><span class="token operator">&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">device_lock</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-</span><span class="token operator">&gt;</span>driver<span class="token punctuation">)</span>
		<span class="token function">driver_probe_device</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">device_unlock</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-</span><span class="token operator">&gt;</span>parent<span class="token punctuation">)</span>
		<span class="token function">device_unlock</span><span class="token punctuation">(</span>dev<span class="token operator">-</span><span class="token operator">&gt;</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>driver_match_device函数会判断设备和驱动是否匹配，如果匹配就调用driver_probe_device。</p> 
<p>（7）首先来看一看driver_match_device函数的定义。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">static</span> inline int <span class="token function">driver_match_device</span><span class="token punctuation">(</span>struct device_driver <span class="token operator">*</span>drv<span class="token punctuation">,</span>
				      struct device <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> drv<span class="token operator">-</span><span class="token operator">&gt;</span>bus<span class="token operator">-</span><span class="token operator">&gt;</span>match <span class="token operator">?</span> drv<span class="token operator">-</span><span class="token operator">&gt;</span>bus<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">match</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> drv<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（8）发现它调用了总线的match函数，这里的总线在注册I2C设备的时候已经被设置为I2C总线了，定义如下。</p> 
<pre><code class="prism language-javascript">struct bus_type i2c_bus_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name		<span class="token operator">=</span> <span class="token string">"i2c"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>match		<span class="token operator">=</span> i2c_device_match<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe		<span class="token operator">=</span> i2c_device_probe<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>remove		<span class="token operator">=</span> i2c_device_remove<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>shutdown	<span class="token operator">=</span> i2c_device_shutdown<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>pm		<span class="token operator">=</span> <span class="token operator">&amp;</span>i2c_device_pm_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>（9）所以这里会调用到i2c_device_match函数，i2c_device_match会通过I2C驱动的id_table中每一的name和I2C设备的name进行匹配。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">static</span> <span class="token keyword">const</span> struct i2c_device_id <span class="token operator">*</span><span class="token function">i2c_match_id</span><span class="token punctuation">(</span><span class="token keyword">const</span> struct i2c_device_id <span class="token operator">*</span>id<span class="token punctuation">,</span>
						<span class="token keyword">const</span> struct i2c_client <span class="token operator">*</span>client<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>id<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>client<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">,</span> id<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> id<span class="token punctuation">;</span>
		id<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>(10)如果匹配成功会调用driver_probe_device，下面再来看看driver_probe_device，driver_probe_device函数最终会先调用到I2C总线的probe函数，然后再调用I2C驱动的probe函数。</p> 
<pre><code class="prism language-javascript">int <span class="token function">driver_probe_device</span><span class="token punctuation">(</span>struct device_driver <span class="token operator">*</span>drv<span class="token punctuation">,</span> struct device <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	int ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">device_is_registered</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token constant">ENODEV</span><span class="token punctuation">;</span>

	<span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"bus: '%s': %s: matched device %s with driver %s\n"</span><span class="token punctuation">,</span>
		 drv<span class="token operator">-</span><span class="token operator">&gt;</span>bus<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">,</span> __func__<span class="token punctuation">,</span> <span class="token function">dev_name</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> drv<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pm_runtime_get_noresume</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pm_runtime_barrier</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">really_probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pm_runtime_put_sync</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript"><span class="token keyword">static</span> int <span class="token function">really_probe</span><span class="token punctuation">(</span>struct device <span class="token operator">*</span>dev<span class="token punctuation">,</span> struct device_driver <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>(11)总线的probe函数为i2c_device_probe，此函数会调用驱动的probe函数</p> 
<pre><code class="prism language-javascript"><span class="token keyword">static</span> int <span class="token function">i2c_device_probe</span><span class="token punctuation">(</span>struct device <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	status <span class="token operator">=</span> driver<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token function">i2c_match_id</span><span class="token punctuation">(</span>driver<span class="token operator">-</span><span class="token operator">&gt;</span>id_table<span class="token punctuation">,</span> 
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22I2C_265"></a>2.2.注册I2C驱动</h3> 
<p>(1) 可以通过i2c_add_driver注册I2C驱动，该函数会指定驱动对应的总线为I2C总线，然后向总线注册驱动。</p> 
<pre><code class="prism language-javascript">int <span class="token function">i2c_register_driver</span><span class="token punctuation">(</span>struct module <span class="token operator">*</span>owner<span class="token punctuation">,</span> struct i2c_driver <span class="token operator">*</span>driver<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	driver<span class="token operator">-</span><span class="token operator">&gt;</span>driver<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>i2c_bus_type<span class="token punctuation">;</span>
	<span class="token operator">...</span>
	res <span class="token operator">=</span> <span class="token function">driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>driver<span class="token operator">-</span><span class="token operator">&gt;</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>(2) i2c_bus_type的定义如下。</p> 
<pre><code class="prism language-javascript">struct bus_type i2c_bus_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name		<span class="token operator">=</span> <span class="token string">"i2c"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>match		<span class="token operator">=</span> i2c_device_match<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe		<span class="token operator">=</span> i2c_device_probe<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>remove		<span class="token operator">=</span> i2c_device_remove<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>shutdown	<span class="token operator">=</span> i2c_device_shutdown<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>pm		<span class="token operator">=</span> <span class="token operator">&amp;</span>i2c_device_pm_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>(3) driver_register函数遍历总线的设备链表进行操作，然后将驱动添加到总线的驱动链表中。</p> 
<pre><code class="prism language-javascript">int <span class="token function">driver_register</span><span class="token punctuation">(</span>struct device_driver <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	ret <span class="token operator">=</span> <span class="token function">bus_add_driver</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">int <span class="token function">bus_add_driver</span><span class="token punctuation">(</span>struct device_driver <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-</span><span class="token operator">&gt;</span>bus<span class="token operator">-</span><span class="token operator">&gt;</span>p<span class="token operator">-</span><span class="token operator">&gt;</span>drivers_autoprobe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		error <span class="token operator">=</span> <span class="token function">driver_attach</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
			goto out_unregister<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">klist_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>priv<span class="token operator">-</span><span class="token operator">&gt;</span>knode_bus<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bus<span class="token operator">-</span><span class="token operator">&gt;</span>p<span class="token operator">-</span><span class="token operator">&gt;</span>klist_drivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">int <span class="token function">driver_attach</span><span class="token punctuation">(</span>struct device_driver <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">bus_for_each_dev</span><span class="token punctuation">(</span>drv<span class="token operator">-</span><span class="token operator">&gt;</span>bus<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> drv<span class="token punctuation">,</span> __driver_attach<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>(4)下面来看一看__driver_attach函数，此函数会判断设备和驱动是否匹配，如果匹配就调用驱动的probe函数。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">static</span> int <span class="token function">__driver_attach</span><span class="token punctuation">(</span>struct device <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">driver_match_device</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-</span><span class="token operator">&gt;</span>driver<span class="token punctuation">)</span>
		<span class="token function">driver_probe_device</span><span class="token punctuation">(</span>drv<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="23_I2C_334"></a>2.3. I2C适配器的构建</h3> 
<p>对于三星平台，在drivers\i2c\busses\i2c-s3c2410.c文件中构建并注册了I2C适配器，这是三星平台I2C控制器的驱动。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">static</span> <span class="token keyword">const</span> struct i2c_algorithm s3c24xx_i2c_algorithm <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>master_xfer		<span class="token operator">=</span> s3c24xx_i2c_xfer<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>functionality		<span class="token operator">=</span> s3c24xx_i2c_func<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-javascript"><span class="token keyword">static</span> int <span class="token function">s3c24xx_i2c_probe</span><span class="token punctuation">(</span>struct platform_device <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span>
	i2c<span class="token operator">-</span><span class="token operator">&gt;</span>adap<span class="token punctuation">.</span>algo    <span class="token operator">=</span> <span class="token operator">&amp;</span>s3c24xx_i2c_algorithm<span class="token punctuation">;</span>
	<span class="token operator">...</span>
	ret <span class="token operator">=</span> <span class="token function">i2c_add_numbered_adapter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i2c<span class="token operator">-</span><span class="token operator">&gt;</span>adap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中的s3c24xx_i2c_algorithm中的s3c24xx_i2c_xfer就是通过操作寄存器来通过I2C控制器传输数据。</p> 
<h3><a id="24_I2C_358"></a>2.4. I2C数据传输</h3> 
<p>上面介绍I2C数据传输是通过I2C适配器完成的，下面来分析一下源码，在I2C驱动中，使用i2c_transfer来传输I2C数据，此函数肯定是通过I2C适配器的算法进行操作的，如下。</p> 
<pre><code class="prism language-javascript">int <span class="token function">i2c_transfer</span><span class="token punctuation">(</span>struct i2c_adapter <span class="token operator">*</span>adap<span class="token punctuation">,</span> struct i2c_msg <span class="token operator">*</span>msgs<span class="token punctuation">,</span> int num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span><span class="token punctuation">.</span>
	ret <span class="token operator">=</span> adap<span class="token operator">-</span><span class="token operator">&gt;</span>algo<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">master_xfer</span><span class="token punctuation">(</span>adap<span class="token punctuation">,</span> msgs<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="3I2C_371"></a>3.I2C背景了解</h2> 
<h3><a id="31_372"></a>3.1.物理接口</h3> 
<pre><code>1）SCL（serial clock ）：时钟线，传输CLK信号，一般是I2C主设备向从设备提供时钟的通道；
2）SDA（serial data）：数据线，通信数据都通过SDA线传输。
</code></pre> 
<h3><a id="32_379"></a>3.2通信特征</h3> 
<pre><code>1）I2C 属于串行通信，所有的数据以位为单位在SDA线上串行传输。

2）同步通信就是通信双方工作在同一个时钟下，一般是通信的A方通过一根CLK信号线传输自己的时钟给B，B工作在A传输的时钟下，所以同步通信的显著特征就是：通信线中有CLK。

3）非差分。因为I2C速率不高且通信双方距离很近，所以使用电平信号通信。

4）低速率。 I2C一般是用在板子上的2个IC之间的通信，而且用来传输的数据量不大，所以本身通信速率很低（几百KHz，不同的I2C芯片的通信速率可能不同，具体在编程的时候要看自己使用的设备允许的I2C通信最高速率，不能超过这个速率）
</code></pre> 
<h2><a id="4_I2C_388"></a>4. I2C时序图</h2> 
<h3><a id="41_I2C_389"></a>4.1. I2C起始信号</h3> 
<pre><code>1) SCL为高电平的时候，SDA由高电平向低电平跳变。
</code></pre> 
<p><img src="https://images2.imgbox.com/5e/63/STzStQxL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="42_I2C_393"></a>4.2. I2C终止信号</h3> 
<pre><code>1) 终止信号：SCL为高电平的时候，SDA由低电平向高电平跳变。
</code></pre> 
<p><img src="https://images2.imgbox.com/35/b2/qSf17NnO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="43_I2C_398"></a>4.3. I2C应答信号</h3> 
<pre><code>1）I2C总线上的所有数据都是以8位字节传送的，发送器每发送一个字节，就在时钟脉冲9期间释放数据线，由接收器反馈一个应答信号。应答信号为低电平时，规定为有效应答位（ACK简称应答位），表示接收器已经成功地接收了该字节；应答信号为高电平时，规定为非应答位（NACK），一般表示接收器接收该字节没有成功，对于反馈有效应答位ACK的要求是，接收器在第9个时钟脉冲之前的低电平期间将SDA线拉低，并且确保在该时钟的高电平期间为稳定的低电平。如果接收器是主控器，则在它收到最后一个字节后，发送一个NACK信号，以通知被控发送器结束数据发送，并释放SDA线，以便主控接收器发送一个停止信号P。
</code></pre> 
<p><img src="https://images2.imgbox.com/5a/0f/FpSlGY9p_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="44_I2C_402"></a>4.4. I2C写时序</h3> 
<pre><code>1） 开始信号：主机+从设备地址+写命令，从机应答，应答成功，表示有这个设备，然后主机+设备内部寄存器地址，此时不用再加写命令控制字，从机应答，应答成功，表示设备内有这个地址，主机写入数据，从机应答，是否继续发送，不发送的话，发送停止信号P。
</code></pre> 
<p><img src="https://images2.imgbox.com/9a/3d/zVR0hoOk_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="45_I2C_407"></a>4.5. I2C读时序</h3> 
<pre><code>1） 首先要知道将要所读取设备的地址告诉从设备，从设备才能将数据放到（发送）SDA上使主设备读取，从设备将数据放入SDA上的过程，由硬件主动完成，不用人为的写入。所以首先先写入从机地址，然后+写控制命令，从机应答，应答成功，表示有这个设备，然后写入内部寄存器地址，此时不用再加写命令控制字，从机应答，应答成功，表示设备内有这个地址。然后主机继续发出：写入从机地址，然后+读命令，从机应答，应答成功，此时便可以读取数据了，从设备已经将数据放入到SDA上了。
</code></pre> 
<p><img src="https://images2.imgbox.com/bf/d4/3wwKQ1pQ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="5_I2C_411"></a>5. I2C实际操作图解</h2> 
<pre><code>1)  首先本次操作是通过I2C读写CPLD的一个实验。第一，我们进行一个写数据操作，I2C从设备地址位0x16，CPLD寄存器地址为0x13，写入CPLD的数据为0x2；然后在读取写入CPLD中寄存器的值。
</code></pre> 
<h3><a id="51_414"></a>5.1.写操作</h3> 
<p><img src="https://images2.imgbox.com/3a/38/cQYrI4GL_o.png" alt="在这里插入图片描述"><br> 由上图所示，我可以得到从设备的地址为0x16，为写操作写入的高八位数据为0x0。</p> 
<p><img src="https://images2.imgbox.com/09/21/ieaLxkOH_o.png" alt="在这里插入图片描述"><br> 由上图所示，我可以得到写操作写入的低八位数据为0x13，接着写入的高八位数据为0x00。</p> 
<p><img src="https://images2.imgbox.com/41/d1/TgQsFoDo_o.png" alt="在这里插入图片描述"><br> 由上图所示，我们可以得到写入的低八位数据为0x2，然后终止传输信号。</p> 
<h3><a id="52_424"></a>5.2.读操作</h3> 
<p><img src="https://images2.imgbox.com/8e/09/hwp0Lzb6_o.png" alt="在这里插入图片描述"></p> 
<p>由上图所示，我可以得到从设备的地址为0x16，为写操作写入的高八位数据为0x0。</p> 
<p><img src="https://images2.imgbox.com/e4/9c/d0tlreOI_o.png" alt="在这里插入图片描述"><br> 由上图所示，我可以得到写操作写入的低八位数据为0x13，然后重新发送起始型号，发送从设备地址0x16,然后读取数据。</p> 
<p><img src="https://images2.imgbox.com/cc/a7/bYjDrGiK_o.png" alt="在这里插入图片描述"><br> 由上图所示，我可以读取到高八位数据：0x0，接着为读取到的第八位数据：0x2，然后终止传输信号。</p> 
<h3><a id="53__439"></a>5.3. 驱动代码</h3> 
<ol><li>以下代码为nst175温度传感器的代码.</li></ol> 
<pre><code class="prism language-javascript">#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>types<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>kernel<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>delay<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>ide<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>init<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>module<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>fs<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>errno<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>gpio<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>cdev<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>slab<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>uaccess<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>device<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>i2c<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>


#define <span class="token constant">I2C_MASTER_RD</span>	<span class="token number">0x0001</span>	<span class="token comment">//read data, from slave to master</span>
#define <span class="token constant">DEVICE_NAME</span> <span class="token string">"sensor"</span> 		<span class="token comment">//设备名：srnsor</span>
#define <span class="token constant">DEVICE_MINOR_NUM</span> <span class="token number">1</span>			<span class="token comment">//次设备号数		</span>

struct i2c_nst175_command <span class="token punctuation">{<!-- --></span>
    u16   address<span class="token punctuation">;</span>
    u16   data_buff<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

struct nst175_device<span class="token punctuation">{<!-- --></span> 
	dev_t devid<span class="token punctuation">;</span> 				<span class="token comment">//设备ID	 </span>
	struct cdev nst175_cdev<span class="token punctuation">;</span> 	<span class="token comment">//字符设备结构体		</span>
	struct <span class="token keyword">class</span> <span class="token operator">*</span>nst175_class<span class="token punctuation">;</span> <span class="token comment">//类	</span>
	struct device <span class="token operator">*</span>device<span class="token punctuation">;</span> 		<span class="token comment">//创建设备</span>
	int major<span class="token punctuation">;</span> 					<span class="token comment">//主设备		 </span>
	int minor<span class="token punctuation">;</span> 					<span class="token comment">//从设备			</span>
	int private_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 		<span class="token comment">//私有数据，用于存放从设备地址</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> struct i2c_client <span class="token operator">*</span>this_client<span class="token punctuation">;</span>
<span class="token keyword">static</span> struct nst175_device nst175dev<span class="token punctuation">;</span> 

<span class="token comment">//------------------------I2C读取NST175数据------------------------</span>
<span class="token keyword">static</span> int <span class="token function">i2c_nst175_rxdata</span><span class="token punctuation">(</span>int saddr<span class="token punctuation">,</span>char <span class="token operator">*</span>regaddr<span class="token punctuation">,</span>int regaddr_len<span class="token punctuation">,</span>char <span class="token operator">*</span>rxdata<span class="token punctuation">,</span> int data_len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	int	ret<span class="token punctuation">;</span>
	
    struct i2c_msg msgs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span>addr  <span class="token operator">=</span> saddr<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>len   <span class="token operator">=</span> regaddr_len<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>buf   <span class="token operator">=</span> regaddr<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span>addr  <span class="token operator">=</span> saddr<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token constant">I2C_MASTER_RD</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>len   <span class="token operator">=</span> data_len<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>buf   <span class="token operator">=</span> rxdata<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">i2c_transfer</span><span class="token punctuation">(</span> this_client<span class="token operator">-</span><span class="token operator">&gt;</span>adapter<span class="token punctuation">,</span> msgs<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">printk</span><span class="token punctuation">(</span> <span class="token string">"read error:%d.\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>	
	
<span class="token punctuation">}</span>

<span class="token comment">//---------------------------打开操作---------------------------</span>
<span class="token keyword">static</span> int <span class="token function">nst175_open</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>inode<span class="token punctuation">,</span> struct file <span class="token operator">*</span>filp<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token comment">//---------------------------控制操作---------------------------</span>
<span class="token keyword">static</span> long <span class="token function">nst175_ioctl</span><span class="token punctuation">(</span> struct file <span class="token operator">*</span>file<span class="token punctuation">,</span> unsigned int cmd<span class="token punctuation">,</span> unsigned long arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    struct i2c_nst175_command cmdframe<span class="token punctuation">;</span>
    int ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		
    <span class="token keyword">switch</span><span class="token punctuation">(</span> cmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//-----------------------------nst175_1(板子标识号u8)-----------------------------</span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>	
			<span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cmdframe<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span> cmdframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			
			ret <span class="token operator">=</span> <span class="token function">i2c_nst175_rxdata</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>private_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cmdframe<span class="token punctuation">.</span>address<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cmdframe<span class="token punctuation">.</span>data_buff<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		    <span class="token function">copy_to_user</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cmdframe<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span> cmdframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token comment">//-----------------------------nst175_2(板子标识号u9)-----------------------------	</span>
		<span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cmdframe<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span> cmdframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			
			ret <span class="token operator">=</span> <span class="token function">i2c_nst175_rxdata</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>private_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cmdframe<span class="token punctuation">.</span>address<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cmdframe<span class="token punctuation">.</span>data_buff<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		    <span class="token function">copy_to_user</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cmdframe<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span> cmdframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">default</span><span class="token punctuation">:</span>
             <span class="token function">printk</span><span class="token punctuation">(</span> <span class="token string">"invalid cmd %#x\n"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token constant">EINVAL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

<span class="token comment">//---------------------------设备操作---------------------------</span>
<span class="token keyword">static</span> struct file_operations nst175_fops <span class="token operator">=</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>owner 			<span class="token operator">=</span> <span class="token constant">THIS_MODULE</span><span class="token punctuation">,</span> 
	<span class="token punctuation">.</span>open   		<span class="token operator">=</span> nst175_open<span class="token punctuation">,</span> 
	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> nst175_ioctl<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//---------------------------探针函数----------------------------</span>
<span class="token keyword">static</span> int <span class="token function">sensor_nst175_probe</span><span class="token punctuation">(</span>struct i2c_client <span class="token operator">*</span>client<span class="token punctuation">,</span> <span class="token keyword">const</span> struct i2c_device_id <span class="token operator">*</span>id<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	int i<span class="token punctuation">,</span>err<span class="token punctuation">;</span>
	int devno<span class="token punctuation">;</span>
	<span class="token comment">//-------------------------注册字符设备驱动---------------------------------</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>major<span class="token punctuation">)</span> <span class="token comment">//创建设备号</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//静态注册设备号</span>
		nst175dev<span class="token punctuation">.</span>devid <span class="token operator">=</span> <span class="token constant">MKDEV</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> <span class="token constant">DEVICE_MINOR_NUM</span><span class="token punctuation">,</span>id<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span> 
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span> 
		<span class="token comment">//动态注册设备号</span>
		<span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nst175dev<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">DEVICE_MINOR_NUM</span><span class="token punctuation">,</span>id<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 申请设备号 */</span> 
		nst175dev<span class="token punctuation">.</span>major <span class="token operator">=</span> <span class="token constant">MAJOR</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>devid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 获取主设备号 */</span> 
		nst175dev<span class="token punctuation">.</span>minor <span class="token operator">=</span> <span class="token constant">MINOR</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>devid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 获取次设备号 */</span> 
	<span class="token punctuation">}</span> 

	<span class="token comment">//创建类</span>
	nst175dev<span class="token punctuation">.</span>nst175_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span><span class="token constant">THIS_MODULE</span><span class="token punctuation">,</span>id<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">IS_ERR</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>nst175_class<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token constant">PTR_ERR</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>nst175_class<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>

	<span class="token comment">//设备初始化{<!-- --></span>
	<span class="token comment">//数据初始化</span>
	nst175dev<span class="token punctuation">.</span>nst175_cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> <span class="token constant">THIS_MODULE</span><span class="token punctuation">;</span>
	<span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nst175dev<span class="token punctuation">.</span>nst175_cdev<span class="token punctuation">,</span><span class="token operator">&amp;</span>nst175_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	devno <span class="token operator">=</span> <span class="token constant">MKDEV</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>major<span class="token punctuation">,</span>nst175dev<span class="token punctuation">.</span>minor<span class="token operator">+</span>id<span class="token operator">-</span><span class="token operator">&gt;</span>driver_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//注册到系统</span>
	err <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nst175dev<span class="token punctuation">.</span>nst175_cdev<span class="token punctuation">,</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token constant">KERN_EMERG</span> <span class="token string">"cdev_add is fail! %d\n"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token constant">KERN_EMERG</span> <span class="token string">"cdev_add %d is success!\n"</span><span class="token punctuation">,</span>nst175dev<span class="token punctuation">.</span>minor<span class="token operator">+</span>id<span class="token operator">-</span><span class="token operator">&gt;</span>driver_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
		
	<span class="token comment">//创建设备节点</span>
	<span class="token function">device_create</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>nst175_class<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>devno<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span>id<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		
	this_client <span class="token operator">=</span> client<span class="token punctuation">;</span>	
		
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//--------------------------移除字符函数---------------------------</span>
<span class="token keyword">static</span> int <span class="token function">sensor_nst175_remove</span><span class="token punctuation">(</span>struct i2c_client <span class="token operator">*</span>client<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span> 
	<span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nst175dev<span class="token punctuation">.</span>nst175_cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//删除字符设备</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 			<span class="token comment">//注销字符设备</span>
	
	<span class="token comment">//注销掉类和设备 </span>
	<span class="token function">device_destroy</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>nst175_class<span class="token punctuation">,</span> nst175dev<span class="token punctuation">.</span>devid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">class_destroy</span><span class="token punctuation">(</span>nst175dev<span class="token punctuation">.</span>nst175_class<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token comment">//-----------------------传统匹配方式ID列表------------------------</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> struct i2c_device_id sensor_nst175_id<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span><span class="token string">"nst175_1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
	<span class="token punctuation">{<!-- --></span><span class="token string">"nst175_2"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span><span class="token comment">/* END OF LIST */</span><span class="token punctuation">}</span>	
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//-------------------------I2C板载设备信息-------------------------</span>
<span class="token keyword">static</span> struct i2c_board_info sensor_nst175_i2c_board_info<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span><span class="token constant">I2C_BOARD_INFO</span><span class="token punctuation">(</span><span class="token string">"nst175_1"</span><span class="token punctuation">,</span> <span class="token number">0x49</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span><span class="token constant">I2C_BOARD_INFO</span><span class="token punctuation">(</span><span class="token string">"nst175_2"</span><span class="token punctuation">,</span> <span class="token number">0x4a</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//--------------------------i2c驱动结构体--------------------------</span>
<span class="token keyword">static</span> struct i2c_driver sensor_nst175_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>probe <span class="token operator">=</span> sensor_nst175_probe<span class="token punctuation">,</span> 
	<span class="token punctuation">.</span>remove <span class="token operator">=</span> sensor_nst175_remove<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>id_table <span class="token operator">=</span> sensor_nst175_id<span class="token punctuation">,</span>	
	<span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>owner <span class="token operator">=</span> <span class="token constant">THIS_MODULE</span><span class="token punctuation">,</span> 
		<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"sensor_nst175"</span><span class="token punctuation">,</span> 
	<span class="token punctuation">}</span><span class="token punctuation">,</span> 
	
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//----------------------------加载函数-----------------------------</span>
<span class="token keyword">static</span> int __init <span class="token function">sensor_nst175_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	int ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>i<span class="token punctuation">;</span>
	struct i2c_adapter <span class="token operator">*</span>i2c_adap <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	struct i2c_client <span class="token operator">*</span>client <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	
	<span class="token comment">//获取adapter总线上的相应的I2C设备：I2C(0)</span>
	i2c_adap <span class="token operator">=</span> <span class="token function">i2c_get_adapter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>i2c_adap <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"i2c_get_adapter() failed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//添加新的I2C设备</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token function">sizeof</span><span class="token punctuation">(</span>sensor_nst175_i2c_board_info<span class="token punctuation">)</span><span class="token operator">/</span>\
			 <span class="token function">sizeof</span><span class="token punctuation">(</span>sensor_nst175_i2c_board_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		client <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		client <span class="token operator">=</span> <span class="token function">i2c_new_device</span><span class="token punctuation">(</span>i2c_adap<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sensor_nst175_i2c_board_info<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"i2c_new_device() failed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">i2c_put_adapter</span><span class="token punctuation">(</span>i2c_adap<span class="token punctuation">)</span><span class="token punctuation">;</span>	
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		nst175dev<span class="token punctuation">.</span>private_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> client<span class="token operator">-</span><span class="token operator">&gt;</span>addr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//添加I2C驱动</span>
	ret <span class="token operator">=</span> <span class="token function">i2c_add_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sensor_nst175_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"i2c_add_driver() failed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token comment">//-----------------------------卸载函数-----------------------------</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">sensor_nst175_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token constant">KERN_EMERG</span> <span class="token string">"sensor_nst175_exit!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">i2c_del_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sensor_nst175_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token function">module_init</span><span class="token punctuation">(</span>sensor_nst175_init<span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//入口函数</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>sensor_nst175_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//出口函数</span>

<span class="token constant">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"author:shzn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre> 
<h2><a id="6_697"></a>6.总结</h2> 
<p>最后关于I2C的调试过程讲解就到这了，主要是想讲述一下调试中的过程，同时附带了驱动代码，欢迎大家一起来学习。。。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/40e218915d4ffaa31c6f7e6f861411c5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">消息中间件之kafka</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d7c50d9e09520755f91a9d16fc0b1568/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux给变量加单引号,单引号、双引号和不加引号区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>