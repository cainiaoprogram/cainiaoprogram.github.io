<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kerberos  HA高可用配置 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kerberos  HA高可用配置" />
<meta property="og:description" content="Kerberos 高可用配置 Kerberos 安装(主节点操作) 节点信息 data80 data81 data82 data83 备注 主Kerberos节点：data80备Kerberos节点：data81 安装 kdc server 在KDC(name01)上安装包 krb5、krb5-server 和 krb5-client
yum install krb5-server krb5-libs krb5-auth-dialog krb5-workstation -y 安装 krb5-devel、krb5-workstation
yum install krb5-devel krb5-workstation -y 修改 krb5.conf /etc/krb5.conf
includedir /etc/krb5.conf.d/ [logging] default = FILE:/var/log/krb5libs.log kdc = FILE:/var/log/krb5kdc.log admin_server = FILE:/var/log/kadmind.log [libdefaults] dns_lookup_realm = false ticket_lifetime = 24h renew_lifetime = 7d forwardable = true rdns = false pkinit_anchors = /etc/pki/tls/certs/ca-bundle.crt default_realm = HADOOP.COM default_ccache_name = KEYRING:persistent:%{uid} [realms] HADOOP." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7641ce56af6523398974737c2c073fe9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-08T14:58:54+08:00" />
<meta property="article:modified_time" content="2020-04-08T14:58:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kerberos  HA高可用配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Kerberos__0"></a>Kerberos 高可用配置</h2> 
<h3><a id="Kerberos__2"></a>Kerberos 安装(主节点操作)</h3> 
<h4><a id="_4"></a>节点信息</h4> 
<pre><code>data80
data81
data82
data83
</code></pre> 
<ul><li>备注 
  <ul><li>主Kerberos节点：data80</li><li>备Kerberos节点：data81</li></ul> </li></ul> 
<h4><a id="_kdc_server_17"></a>安装 kdc server</h4> 
<ul><li> <p>在KDC(name01)上安装包 krb5、krb5-server 和 krb5-client</p> <pre><code>yum install krb5-server krb5-libs krb5-auth-dialog krb5-workstation  -y
</code></pre> </li><li> <p>安装 krb5-devel、krb5-workstation</p> <pre><code>yum install krb5-devel krb5-workstation -y
</code></pre> </li></ul> 
<h4><a id="%09krb5conf_31"></a>修改 krb5.conf</h4> 
<p><code>/etc/krb5.conf</code></p> 
<pre><code>includedir /etc/krb5.conf.d/

[logging]
 default = FILE:/var/log/krb5libs.log
 kdc = FILE:/var/log/krb5kdc.log
 admin_server = FILE:/var/log/kadmind.log

[libdefaults]
 dns_lookup_realm = false
 ticket_lifetime = 24h
 renew_lifetime = 7d
 forwardable = true
 rdns = false
 pkinit_anchors = /etc/pki/tls/certs/ca-bundle.crt
 default_realm = HADOOP.COM
 default_ccache_name = KEYRING:persistent:%{uid}

[realms]
 HADOOP.COM = {
  kdc = data80
  admin_server = data80
  kdc = data81
  admin_server = data81
}
</code></pre> 
<h4><a id="_63"></a>同步配置文件</h4> 
<pre><code>sudo scp /etc/krb5.conf  data81:/etc/
sudo scp /etc/krb5.conf  data82:/etc/
sudo scp /etc/krb5.conf  data83:/etc/
</code></pre> 
<h4><a id="data80_72"></a>创建数据库(在data80节点)</h4> 
<pre><code>kdb5_util create -r HADOOP.COM -s
</code></pre> 
<h4><a id="data80_78"></a>启动服务(在data80节点)</h4> 
<pre><code>chkconfig --level 35 krb5kdc on
chkconfig --level 35 kadmin on
service krb5kdc start
service kadmin start

</code></pre> 
<h4><a id="keytab_88"></a>创建主从同步账号，并为账号生成keytab文件</h4> 
<pre><code> sudo kadmin.local
 kadmin.local:  addprinc -randkey host/data80@HADOOP.COM
 kadmin.local:  addprinc -randkey host/data81@HADOOP.COM
 
 kadmin.local:  ktadd  host/data80@HADOOP.COM
 kadmin.local:  ktadd  host/data81@HADOOP.COM
</code></pre> 
<p>使用随机生成秘钥的方式创建同步账号，并使用ktadd命令生成同步账号的keytab文件，默认文件生成在/etc/krb5.keytab下</p> 
<h4><a id="Kerberos_102"></a>复制以下文件到备Kerberos服务器相应目录</h4> 
<ul><li> <p>将/etc目录下的krb5.conf和krb5.keytab文件拷贝至备Kerberos服务器的/etc目录下</p> </li><li> <p>将/var/kerberos/krb5kdc目录下的.k5.HADOOP.COM、kadm5.acl和krb5.conf文件拷贝至备Kerberos服务器的/var/kerberos/krb5kdc目录</p> </li></ul> 
<p>注意： .k5.HADOOP.COM 为隐藏文件，一定不要忘记拷贝</p> 
<h3><a id="Kerberos_111"></a>备Kerberos节点操作</h3> 
<h4><a id="_113"></a>需要申明用来同步的用户</h4> 
<p>在/var/kerberos/krb5kdc/kpropd.acl配置文件中添加对应账户，如果配置文件不存在则新增</p> 
<pre><code>cd /var/kerberos/krb5kdc

sudo vim kpropd.acl

host/data80@HADOOP.COM
host/data81@HADOOP.COM

</code></pre> 
<h4><a id="kprop_127"></a>启动kprop服务并加入系统自启动</h4> 
<pre><code> sudo systemctl enable kprop
 sudo systemctl start kprop
 sudo systemctl status kprop
</code></pre> 
<h4><a id="_137"></a>主节点数据同步至备节点</h4> 
<pre><code>sudo kdb5_util dump /var/kerberos/krb5kdc/master.dump
</code></pre> 
<p>导出成功后生成master.dump和master.dump.dump_ok两个文件。</p> 
<h4><a id="kpropmasterdump_145"></a>在主节点上使用kprop命令将master.dump文件同步至备节点</h4> 
<pre><code>sudo kprop -f /var/kerberos/krb5kdc/master.dump -d -P 754  data81
</code></pre> 
<ul><li> <p>日志</p> <pre><code>3769 bytes sent.
Database propagation to data81: SUCCEEDED
</code></pre> </li></ul> 
<h4><a id="varkerberoskrb5kdc_159"></a>在备节点的/var/kerberos/krb5kdc目录下查看</h4> 
<pre><code>-rw-------. 1 root root 3769 Apr  8 01:25 from_master
-rw-------. 1 root root   22 Apr  8 00:22 kadm5.acl
-rw-------. 1 root root  451 Sep 14  2019 kdc.conf
-rw-r--r--. 1 root root   46 Apr  8 00:27 kpropd.acl
-rw-------. 1 root root 8192 Apr  8 01:25 principal
-rw-------. 1 root root 8192 Apr  8 01:25 principal.kadm5
-rw-------. 1 root root    0 Apr  8 00:29 principal.kadm5.lock
-rw-------. 1 root root    0 Apr  8 01:25 principal.ok
</code></pre> 
<p>在备节点的/var/kerberos/krb5kdc目录下增加了如下文件：</p> 
<ul><li>from_master</li><li>principal</li><li>principal.kadm5</li><li>principal.kadm5.lock</li><li>principal.ok</li></ul> 
<h4><a id="Kerberos_182"></a>在备节点上测试通过过来的数据是否能启动Kerberos服务</h4> 
<ul><li> <p>首先将kprop服务停止，将kpropd.acl文件备份并删除，然后启动krb5kdc和kadmin服务</p> <pre><code>sudo systemctl stop kprop
sudo mv /var/kerberos/krb5kdc/kpropd.acl/var/kerberos/krb5kdc/kpropd.acl.bak
sudo systemctl start krb5kdc
sudo systemctl start kadmin
</code></pre> </li><li> <p>修改备服务器的/etc/krb5.conf文件，将kdc和kadmin_server修改为备ls -l服务器地址，测试kinit是否正常</p> <pre><code> HADOOP.COM = {
 # kdc = data80
 # admin_server = data80
  kdc = data81
  admin_server = data81
}
</code></pre> </li></ul> 
<h4><a id="_205"></a>设置定时</h4> 
<pre><code> crontab -e
 */5 * * * * root/var/kerberos/krb5kdc/kprop_sync.sh &gt;/var/kerberos/krb5kdc/lastupdate
</code></pre> 
<h3><a id="_213"></a>常见问题</h3> 
<ul><li> <p>list 无权限</p> <pre><code>kadmin:  list_principals 
get_principals: Operation requires ``list'' privilege while retrieving list.
</code></pre> </li></ul> 
<h3><a id="_223"></a>参考资料</h3> 
<ul><li> <p><a href="https://cloud.tencent.com/developer/article/1078314" rel="nofollow">https://cloud.tencent.com/developer/article/1078314</a></p> </li><li> <p><a href="http://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/kadm5_acl.html" rel="nofollow">http://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/kadm5_acl.html</a></p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2873d800216d30af6253bb6e15818f90/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mongo局域网连接</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/38dba07682dfb2ce7004e200be061124/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【数字图像处理】MATLAB实现图像缩小的两种算法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>