<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux内核MTD驱动程序与SD卡驱动程序(转载) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux内核MTD驱动程序与SD卡驱动程序(转载)" />
<meta property="og:description" content="转自：http://www.360doc.com/content/10/0806/11/496343_44040067.shtml
文章目录 1. 引言2. MTD内存技术设备2.1. MTD内存技术设备层次结构2.2. 设备层和原始设备层的函数调用关系2.3. MTD相关结构2.4. MTD块设备初始化2.5. MTD块设备的读写操作2.6. MTD核心初始化2.7. MTD字符设备2.8. 具体flash芯片的探测及映射2.9. 驱动程序实例分析 3. SD/MMC卡块设备驱动程序3.1. MMC抽象设备层相关结构3.1.1. 设备描述结构3.1.2. 读写请求相关结构 3.2. MMC抽象设备层MMC块设备驱动程序3.2.1. MMC块设备驱动程序初始化3.2.2. MMC块设备驱动程序探测函数3.2.3. MMC卡请求的处理 3.3. 具体MMC控制器驱动程序示例3.3.1. amba控制器驱动程序相关结构3.3.2. amba控制器的初始化3.3.3. 设备探测函数mmci_probe3.3.4. amba控制器操作函数 1. 引言 flash闪存设备和SD插卡设备是嵌入式设备用到的主要存储设备，它们相当于PC机的硬盘。在嵌入设备特别是手持设备中，flash闪存是焊接在嵌入设备主板上的flash闪存芯片。在嵌入设备上有MMC/SD卡控制器及插槽，可通过MMC/SD来扩充存储空间。
嵌入设备的存储设备的空间划分及所有逻辑设备和文件系统示例列出如下图：
在嵌入设备上的flash芯片上blob和zImage直接按内存线性地址存储管理，对于flash芯片上留出的供用户使用的存储空间，使用MTDBLOCK块设备和JFFS2文件系统。对于flash芯片的分区表信息则以MTDCHAR字符设备来存储管理。
在嵌入设备上的MMC/SD插卡则由MMCBLOCK驱动程序和VFAT文件系统进行存储管理。本章分析了MTD设备和MMC/SD驱动程序。
2. MTD内存技术设备 Linux中MTD子系统在系统的硬件驱动程序和文件系统之间提供通用接口。在MTD上常用的文件文件系统是JFFS2日志闪存文件系统版本 2（Journaling Flash File System）。JFFS2用于微型嵌入式设备的原始闪存芯片的文件系统。JFFS2文件系统是日志结构化的，这意味着它基本上是一长列节点。每个节点包 含有关文件的部分信息 ― 可能是文件的名称、也许是一些数据。与Ext2文件系统相比，JFFS2因为有以下这些优点：
JFFS2在扇区级别上执行闪存擦除／写／读操作要比Ext2文件系统好。JFFS2提供了比Ext2fs更好的崩溃／掉电安全保护。当需 要更改少量数据时，Ext2文件系统将整个扇区复制到内存（DRAM）中，在内存中合并新数据，并写回整个扇区。这意味着为了更改单个字，必须对整个扇区 （64 KB）执行读／擦除／写例程 ，这样做的效率非常低。JFFS2是附加文件而不是重写整个扇区，并且具有崩溃／掉电安全保护这一功能。
JFFS2是是为FLASH定制的文件系统，JFFS1实现了日志功能，JFFS2实现了压缩功能。它的整个设计提供了更好的闪存管理。JFFS2的 缺点很少，主要是当文件系统已满或接近满时，JFFS2会大大放慢运行速度。这是因为垃圾收集的问题。
MTD驱动程序是专门为基于闪存的设备所设计的，它提供了基于扇区的擦除和读写操作的更好的接口。MTD子系统支持众多的闪存设备，并且有越来越多的驱动程序正被添加进来以用于不同的闪存芯片。
MTD子系统提供了对字符设备MTD_CHAR和块设备MTD_BLOCK的支持。MTD_CHAR提供对闪存的原始字符访问，象通常的 IDE硬盘一样，在MTD_BLOCK块设备上可创建文件系统。MTD_CHAR字符设备文件是 /dev/mtd0、/dev/mtd1、/dev/mtd2等，MTD_BLOCK块设备文件是 /dev/mtdblock0、/dev/mtdblock1等等。
NAND和NOR是制作Flash的工艺，CFI和JEDEC是flash硬件提供的接口，linux通过这些用通用接口抽象出MTD设备。JFFS2文件系统就建立在MTD设备上。
NOR flash带有SRAM接口，可以直接存取内部的每一个字节。NAND器件使用串行I/O口来存取数据， 8个引脚用来传送控制、地址和数据信息。NAND读和写操作用512字节的块。
2.1. MTD内存技术设备层次结构 MTD(memory technology device内存技术设备) 在硬件和文件系统层之间的提供了一个抽象的接口，MTD是用来访问内存设备（如：ROM、flash）的中间层，它将内存设备的共有特性抽取出来，从而使 增加新的内存设备驱动程序变得更简单。MTD的源代码都在/drivers/mtd目录中。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/89235d0ecc434bfd4beeddd1936fdfb3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-06T08:59:39+08:00" />
<meta property="article:modified_time" content="2023-11-06T08:59:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux内核MTD驱动程序与SD卡驱动程序(转载)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>转自：<a href="http://www.360doc.com/content/10/0806/11/496343_44040067.shtml" rel="nofollow">http://www.360doc.com/content/10/0806/11/496343_44040067.shtml</a></p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__6" rel="nofollow">1. 引言</a></li><li><a href="#2_MTD_19" rel="nofollow">2. MTD内存技术设备</a></li><li><ul><li><a href="#21_MTD_34" rel="nofollow">2.1. MTD内存技术设备层次结构</a></li><li><a href="#22__73" rel="nofollow">2.2. 设备层和原始设备层的函数调用关系</a></li><li><a href="#23_MTD_82" rel="nofollow">2.3. MTD相关结构</a></li><li><a href="#24_MTD_197" rel="nofollow">2.4. MTD块设备初始化</a></li><li><a href="#25_MTD_551" rel="nofollow">2.5. MTD块设备的读写操作</a></li><li><a href="#26_MTD_722" rel="nofollow">2.6. MTD核心初始化</a></li><li><a href="#27_MTD_774" rel="nofollow">2.7. MTD字符设备</a></li><li><a href="#28_flash_867" rel="nofollow">2.8. 具体flash芯片的探测及映射</a></li><li><a href="#29__977" rel="nofollow">2.9. 驱动程序实例分析</a></li></ul> 
  </li><li><a href="#3_SDMMC_1113" rel="nofollow">3. SD/MMC卡块设备驱动程序</a></li><li><ul><li><a href="#31_MMC_1121" rel="nofollow">3.1. MMC抽象设备层相关结构</a></li><li><ul><li><a href="#311__1122" rel="nofollow">3.1.1. 设备描述结构</a></li><li><a href="#312__1222" rel="nofollow">3.1.2. 读写请求相关结构</a></li></ul> 
   </li><li><a href="#32_MMCMMC_1324" rel="nofollow">3.2. MMC抽象设备层MMC块设备驱动程序</a></li><li><ul><li><a href="#321_MMC_1325" rel="nofollow">3.2.1. MMC块设备驱动程序初始化</a></li><li><a href="#322__MMC_1382" rel="nofollow">3.2.2. MMC块设备驱动程序探测函数</a></li><li><a href="#323_MMC_1496" rel="nofollow">3.2.3. MMC卡请求的处理</a></li></ul> 
   </li><li><a href="#33_MMC_1859" rel="nofollow">3.3. 具体MMC控制器驱动程序示例</a></li><li><ul><li><a href="#331_amba_1862" rel="nofollow">3.3.1. amba控制器驱动程序相关结构</a></li><li><a href="#332_amba_1931" rel="nofollow">3.3.2. amba控制器的初始化</a></li><li><a href="#333_mmci_probe_1964" rel="nofollow">3.3.3. 设备探测函数mmci_probe</a></li><li><a href="#334_amba_2130" rel="nofollow">3.3.4. amba控制器操作函数</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__6"></a>1. 引言</h2> 
<p>flash闪存设备和SD插卡设备是嵌入式设备用到的主要存储设备，它们相当于PC机的硬盘。在嵌入设备特别是手持设备中，flash闪存是焊接在嵌入设备主板上的flash闪存芯片。在嵌入设备上有MMC/SD卡控制器及插槽，可通过MMC/SD来扩充存储空间。</p> 
<p>嵌入设备的存储设备的空间划分及所有逻辑设备和文件系统示例列出如下图：</p> 
<p><img src="https://images2.imgbox.com/7e/21/oCmN4vAT_o.png" alt="在这里插入图片描述"></p> 
<p>在嵌入设备上的flash芯片上blob和zImage直接按内存线性地址存储管理，对于flash芯片上留出的供用户使用的存储空间，使用MTDBLOCK块设备和JFFS2文件系统。对于flash芯片的分区表信息则以MTDCHAR字符设备来存储管理。</p> 
<p>在嵌入设备上的MMC/SD插卡则由MMCBLOCK驱动程序和VFAT文件系统进行存储管理。本章分析了MTD设备和MMC/SD驱动程序。</p> 
<p><img src="https://images2.imgbox.com/0b/c9/utWi1fIu_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2_MTD_19"></a>2. MTD内存技术设备</h2> 
<p>Linux中MTD子系统在系统的硬件驱动程序和文件系统之间提供通用接口。在MTD上常用的文件文件系统是JFFS2日志闪存文件系统版本 2（Journaling Flash File System）。JFFS2用于微型嵌入式设备的原始闪存芯片的文件系统。JFFS2文件系统是日志结构化的，这意味着它基本上是一长列节点。每个节点包 含有关文件的部分信息 ― 可能是文件的名称、也许是一些数据。与Ext2文件系统相比，JFFS2因为有以下这些优点：</p> 
<p>JFFS2在扇区级别上执行闪存擦除／写／读操作要比Ext2文件系统好。JFFS2提供了比Ext2fs更好的崩溃／掉电安全保护。当需 要更改少量数据时，Ext2文件系统将整个扇区复制到内存（DRAM）中，在内存中合并新数据，并写回整个扇区。这意味着为了更改单个字，必须对整个扇区 （64 KB）执行读／擦除／写例程 ，这样做的效率非常低。JFFS2是附加文件而不是重写整个扇区，并且具有崩溃／掉电安全保护这一功能。</p> 
<p>JFFS2是是为FLASH定制的文件系统，JFFS1实现了日志功能，JFFS2实现了压缩功能。它的整个设计提供了更好的闪存管理。JFFS2的 缺点很少，主要是当文件系统已满或接近满时，JFFS2会大大放慢运行速度。这是因为垃圾收集的问题。</p> 
<p>MTD驱动程序是专门为基于闪存的设备所设计的，它提供了基于扇区的擦除和读写操作的更好的接口。MTD子系统支持众多的闪存设备，并且有越来越多的驱动程序正被添加进来以用于不同的闪存芯片。</p> 
<p>MTD子系统提供了对字符设备MTD_CHAR和块设备MTD_BLOCK的支持。MTD_CHAR提供对闪存的原始字符访问，象通常的 IDE硬盘一样，在MTD_BLOCK块设备上可创建文件系统。MTD_CHAR字符设备文件是 /dev/mtd0、/dev/mtd1、/dev/mtd2等，MTD_BLOCK块设备文件是 /dev/mtdblock0、/dev/mtdblock1等等。</p> 
<p>NAND和NOR是制作Flash的工艺，CFI和JEDEC是flash硬件提供的接口，linux通过这些用通用接口抽象出MTD设备。JFFS2文件系统就建立在MTD设备上。</p> 
<p>NOR flash带有SRAM接口，可以直接存取内部的每一个字节。NAND器件使用串行I/O口来存取数据， 8个引脚用来传送控制、地址和数据信息。NAND读和写操作用512字节的块。</p> 
<h3><a id="21_MTD_34"></a>2.1. MTD内存技术设备层次结构</h3> 
<p>MTD(memory technology device内存技术设备) 在硬件和文件系统层之间的提供了一个抽象的接口，MTD是用来访问内存设备（如：ROM、flash）的中间层，它将内存设备的共有特性抽取出来，从而使 增加新的内存设备驱动程序变得更简单。MTD的源代码都在/drivers/mtd目录中。</p> 
<p>MTD中间层细分为四层，按从上到下依次为：设备节点、MTD设备层、MTD原始设备层和硬件驱动层。MTD中间层层次结构图如下：</p> 
<p><img src="https://images2.imgbox.com/25/f7/kSpu7r5q_o.png" alt="在这里插入图片描述"><br> Flash硬件驱动层对应的是不同硬件的驱动程序，它负责驱动具体的硬件。例如：符合CFI接口标准的Flash芯片驱动驱动程序在drivers/mtd/chips目录中，NAND型Flash的驱动程序在/drivers/mtd/nand中。</p> 
<p>在原始设备层中，各种内存设备抽象化为原始设备，原始设备实际上是一种块设备，MTD字符设备的读写函数也调用原始设备的操作函数来实现。 MTD使用MTD信息结构mtd_info来描述了原始设备的操作函数、各种信息，所有原始设备的信息也用一个全局的结构数组来描述，列出如下（在 drivers/mtd/mtdcore.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd_table<span class="token punctuation">[</span>MAX_MTD_DEVICES<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>每个原始设备可能分成多个设备分区，设备分区是将一个内存分成多个块，每个设备分区用一个结构mtd_part来描述，所有的分区组成一个链表mtd_partitions，这个链表的声明列出如下（在drivers/mtd/mtdpart.c中）：</p> 
<pre><code class="prism language-c"><span class="token comment">/* Our partition linked list */</span>
<span class="token keyword">static</span> <span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>mtd_partitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>MTD原始设备到具体设备之间存在的一些映射关系数据在drivers/mtd/maps/目录下的对应文件中。这些映射数据包括分区信息、I/O映射及 特定函数的映射等。这种映射关系用映射信息结构map_info描述。 在MTD设备层中，MTD字符设备通过注册的file operation函数集来操作设备，而这些函数是通过原始设备层的操作函数来实现的，即调用了块设备的操作函数。MTD块设备实际了从块层到块设备的接 口函数。所有的块设备组成一个数组*mtdblks[MAX_MTD_DEVICES]，这个结构数组列出如下（在drivers/mtd /mtdblock.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtdblk_dev</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">;</span>
	<span class="token keyword">int</span> count<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">semaphore</span> cache_sem<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>cache_data<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> cache_offset<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> cache_size<span class="token punctuation">;</span>
	<span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span> STATE_EMPTY<span class="token punctuation">,</span> STATE_CLEAN<span class="token punctuation">,</span> STATE_DIRTY <span class="token punctuation">}</span> cache_state<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token operator">*</span>mtdblks<span class="token punctuation">[</span>MAX_MTD_DEVICES<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>由于flash设备种类的多样性，MTD用MTD翻译层将三大类flash设备进行的封装。每大类设备有自己的操作函数集，它们的mtdblk_dev结构实例都存在mtdblks数组中。MTD设备在内核中的层次图如下图。<br> <img src="https://images2.imgbox.com/44/c1/vKcolDHm_o.png" alt="在这里插入图片描述"></p> 
<p>MTD原始设备层中封装了三大类设备，分别是Inverse Flash、NAND Flash和MTD。它们的上体读写方法不一样。这里只分析了MTD，因为它是最常用的。</p> 
<h3><a id="22__73"></a>2.2. 设备层和原始设备层的函数调用关系</h3> 
<p>原始设备层主要是通过mtd_info结构来管理设备，函数add_mtd_partitions()和del_mtd_partitions() 将的设备分区的mtd_info结构加入mtd_table数组中，mtdpart.c中还实现了part_read、part_write等函数，这些 函数注册在每个分区中，指向主分区的read、write函数，之所以这样做而不直接将主分区的read、write函数连接到每个分区中的原因是因为函 数中的参数mtd_info会被调用者置为函数所属的mtd_info，即mtd-&gt;read(mtd…)，而参数mtd_info其实应该指向主 分区。</p> 
<p>设备层和原始设备层的函数调用关系图如图2所示：</p> 
<p><img src="https://images2.imgbox.com/51/65/A2J0MSls_o.png" alt="在这里插入图片描述"><br> MTD各种结构之间的关系图如图3所示：<br> <img src="https://images2.imgbox.com/12/fd/oEpcN438_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23_MTD_82"></a>2.3. MTD相关结构</h3> 
<pre><code class="prism language-c">MTD块设备的结构mtdblk_dev代表了一个闪存块设备，MTD字符设备没有相对应的结构。结构mtdblk_dev列出如下：
<span class="token keyword">struct</span> <span class="token class-name">mtdblk_dev</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> mtd<span class="token punctuation">;</span> <span class="token operator">/</span> Locked <span class="token operator">*</span><span class="token operator">/</span>	下层原始设备层的MTD设备结构
	<span class="token keyword">int</span> count<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">semaphore</span> cache_sem<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>cache_data<span class="token punctuation">;</span>	<span class="token comment">//缓冲区数据地址</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> cache_offset<span class="token punctuation">;</span><span class="token comment">//在缓冲区中读写位置偏移</span>
	<span class="token comment">//缓冲区中的读写数据大小（通常被设置为MTD设备的erasesize）</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> cache_size<span class="token punctuation">;</span>
	<span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span> STATE_EMPTY<span class="token punctuation">,</span> STATE_CLEAN<span class="token punctuation">,</span> STATE_DIRTY <span class="token punctuation">}</span> cache_state<span class="token punctuation">;</span><span class="token comment">//缓冲区状态</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结构mtd_info描述了一个MTD原始设备，每个分区也被实现为一个mtd_info，如果有两个MTD原始设备，每个上有三个分区，在系统中就一共 有6个mtd_info结构，这些mtd_info的指针被存放在名为mtd_table的数组里。结构mtd_info分析如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token punctuation">{<!-- --></span>
	u_char type<span class="token punctuation">;</span>		<span class="token comment">//内存技术的类型</span>
	<span class="token class-name">u_int32_t</span> flags<span class="token punctuation">;</span>	<span class="token comment">//标志位</span>
	<span class="token class-name">u_int32_t</span> size<span class="token punctuation">;</span>	   <span class="token comment">// mtd设备的大小</span>
	
	<span class="token comment">//“主要的”erasesize（同一个mtd设备可能有数种不同的erasesize）</span>
	<span class="token class-name">u_int32_t</span> erasesize<span class="token punctuation">;</span>
	<span class="token class-name">u_int32_t</span> oobblock<span class="token punctuation">;</span>  <span class="token comment">// oob块大小，例如：512</span>

	<span class="token class-name">u_int32_t</span> oobsize<span class="token punctuation">;</span>   <span class="token comment">//每个块oob数据量，例如16</span>
	<span class="token class-name">u_int32_t</span> ecctype<span class="token punctuation">;</span>	　<span class="token comment">//ecc类型</span>
	<span class="token class-name">u_int32_t</span> eccsize<span class="token punctuation">;</span>	  <span class="token comment">//自动ecc可以工作的范围</span>
 
    <span class="token comment">// Kernel-only stuff starts here.</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
	<span class="token keyword">int</span> index<span class="token punctuation">;</span>

    <span class="token comment">//可变擦除区域的数据，如果是0，意味着整个设备为erasesize</span>
	<span class="token keyword">int</span> numeraseregions<span class="token punctuation">;</span> <span class="token comment">//不同erasesize的区域的数目（通常是1）</span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_erase_region_info</span> <span class="token operator">*</span>eraseregions<span class="token punctuation">;</span>
	<span class="token class-name">u_int32_t</span> bank_size<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>module<span class="token punctuation">;</span>
	<span class="token comment">//此routine用于将一个erase_info加入erase queue</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>erase<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">erase_info</span> <span class="token operator">*</span>instr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* This stuff for eXecute-In-Place */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>point<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> from<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span>
	<span class="token class-name">size_t</span> <span class="token operator">*</span>retlen<span class="token punctuation">,</span> u_char <span class="token operator">*</span><span class="token operator">*</span>mtdbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* We probably shouldn’t allow XIP if the unpoint isn’t a NULL */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>unpoint<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> u_char <span class="token operator">*</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> from<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span>
	<span class="token class-name">size_t</span> <span class="token operator">*</span>retlen<span class="token punctuation">,</span> u_char <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> to<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span>
	<span class="token class-name">size_t</span> <span class="token operator">*</span>retlen<span class="token punctuation">,</span> <span class="token keyword">const</span> u_char <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_ecc<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> from<span class="token punctuation">,</span>
	<span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>retlen<span class="token punctuation">,</span> u_char <span class="token operator">*</span>buf<span class="token punctuation">,</span> u_char <span class="token operator">*</span>eccbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>write_ecc<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> to<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span>
	<span class="token class-name">size_t</span> <span class="token operator">*</span>retlen<span class="token punctuation">,</span> <span class="token keyword">const</span> u_char <span class="token operator">*</span>buf<span class="token punctuation">,</span> u_char <span class="token operator">*</span>eccbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_oob<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> from<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span>
	<span class="token class-name">size_t</span> <span class="token operator">*</span>retlen<span class="token punctuation">,</span> u_char <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>write_oob<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> to<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span>
	<span class="token class-name">size_t</span> <span class="token operator">*</span>retlen<span class="token punctuation">,</span> <span class="token keyword">const</span> u_char <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* iovec-based read/write methods. We need these especially for NAND flash,
	with its limited number of write cycles per erase.
	NB: The ‘count’ parameter is the number of vectors, each of
	which contains an (ofs, len) tuple.
	*/</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>readv<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span>vecs<span class="token punctuation">,</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> from<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>retlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>writev<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span>vecs<span class="token punctuation">,</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> to<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>retlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* Sync */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sync<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span>

 
    <span class="token comment">/* Chip-supported device locking */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> ofs<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>unlock<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> ofs<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* Power Management functions */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>			<span class="token comment">//指向map_info结构</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>设备层的mtdblcok设备的notifier声明如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_notifier</span> notifier <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	mtd_notify_add<span class="token punctuation">,</span>
	mtd_notify_remove<span class="token punctuation">,</span>
	<span class="token constant">NULL</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>mtd_part结构是用于描述MTD原始设备分区的，结构mtd_part中的list成员链成一个链表mtd_partitons。每个 mtd_part结构中的mtd_info结构用于描述本分区，被加入mtd_table数组中，其中mtd_info结构大部分成员由其主分区 mtd_part-&gt;master决定，各种函数也指向主分区的相应函数。 结构mtd_part列出如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/* Our partition linked list */</span>
<span class="token keyword">static</span> <span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>mtd_partitions<span class="token punctuation">)</span><span class="token punctuation">;</span>			MTD原始设备分区的链表
<span class="token keyword">struct</span> <span class="token class-name">mtd_part</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> mtd<span class="token punctuation">;</span>		<span class="token comment">//分区的信息（大部分由其master决定）</span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>master<span class="token punctuation">;</span>	<span class="token comment">//该分区的主分区</span>
	<span class="token class-name">u_int32_t</span> offset<span class="token punctuation">;</span>			<span class="token comment">//该分区的偏移地址</span>
	<span class="token keyword">int</span> index<span class="token punctuation">;</span>					<span class="token comment">//分区号</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构mtd_partition描述mtd设备分区的结构，在MTD原始设备层调用函数add_mtd_partions时传递分区信息使用。结构列出如下（在include/linux/mtd/partition.h中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mtd_partition</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>		<span class="token comment">//分区名	</span>
	<span class="token class-name">u_int32_t</span> size<span class="token punctuation">;</span>		<span class="token comment">//分区大小</span>
	<span class="token class-name">u_int32_t</span> offset<span class="token punctuation">;</span>		<span class="token comment">//在主MTD空间的偏移</span>
	<span class="token class-name">u_int32_t</span> mask_flags<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="24_MTD_197"></a>2.4. MTD块设备初始化</h3> 
<p><img src="https://images2.imgbox.com/55/bf/50LGbyKj_o.png" alt="在这里插入图片描述"><br> 在具体的设备驱动程序初始化时，它会添加一个MTD设备结构到mtd_table数组中。MTD翻译层通过查找这个数组，可访问到各个具体设备驱动程序。</p> 
<p>函数init_mtdblock注册一个MTD翻译层设备，初始化处理请求的线程，赋上MTD翻译层设备操作函数集实例，注册这个设备的通用硬盘结构。函数init_mtdblock调用层次图如上图。</p> 
<p>mtd块设备驱动程序利用一个线程，当有读写请求时，从缓冲区将数据写入块设备或从块设备读入到缓冲区中。</p> 
<p>函数init_mtdblock分析如下（在drivers/mtd/mtdblock.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">init_mtdblock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">register_mtd_blktrans</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtdblock_tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>MTD翻译层设备操作函数集实例列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span> mtdblock_tr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name		<span class="token operator">=</span> “mtdblock”<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>major		<span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>part_bits	<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open		<span class="token operator">=</span> mtdblock_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>flush		<span class="token operator">=</span> mtdblock_flush<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release	<span class="token operator">=</span> mtdblock_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>readsect	<span class="token operator">=</span> mtdblock_readsect<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>writesect	<span class="token operator">=</span> mtdblock_writesect<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>add_mtd	<span class="token operator">=</span> mtdblock_add_mtd<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>remove_dev	<span class="token operator">=</span> mtdblock_remove_dev<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>owner		<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>blktrans_majors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">register_mtd_blktrans</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span> <span class="token operator">*</span>tr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
	<span class="token comment">//如果第一个设备类型被注册了，注册notifier来阻止</span>
	<span class="token comment">/* Register the notifier if/when the first device type is
	registered, to prevent the link/init ordering from fucking
	us over. */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blktrans_notifier<span class="token punctuation">.</span>list<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token comment">//如果不存在</span>
	<span class="token comment">//注册MTD翻译层块设备，创建通用硬盘结构并注册</span>
	<span class="token function">register_mtd_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>blktrans_notifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
	tr<span class="token operator">-&gt;</span>blkcore_priv <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtd_table_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">//创建blk_major_name结构初始化后加到&amp;major_names[]数组中</span>
	ret <span class="token operator">=</span> <span class="token function">register_blkdev</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>major<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

	…


    <span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_completion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>thread_dead<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>thread_wq<span class="token punctuation">)</span><span class="token punctuation">;</span>

 


    <span class="token comment">//创建请求队列并初始化，赋上块设备特定的请求处理函数mtd_blktrans_request</span>
	tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>rq <span class="token operator">=</span> <span class="token function">blk_init_queue</span><span class="token punctuation">(</span>mtd_blktrans_request<span class="token punctuation">,</span>
	<span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	…
    tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>rq<span class="token operator">-&gt;</span>queuedata <span class="token operator">=</span> tr<span class="token punctuation">;</span><span class="token comment">//赋上MTD翻译层块设备操作函数集</span>
	<span class="token comment">//创建线程mtd_blktrans_thread</span>
	ret <span class="token operator">=</span> <span class="token function">kernel_thread</span><span class="token punctuation">(</span>mtd_blktrans_thread<span class="token punctuation">,</span> tr<span class="token punctuation">,</span> CLONE_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	…


    <span class="token comment">//在devfs文件系统中创建设备的目录名</span>
	<span class="token function">devfs_mk_dir</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>devs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化设备的链表</span>
	<span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>blktrans_majors<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>MAX_MTD_DEVICES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>type <span class="token operator">!=</span> MTD_ABSENT<span class="token punctuation">)</span>
		<span class="token comment">//创建MTD翻译层设备结构并初始化，然后到MTD设备链表中</span>
		tr<span class="token operator">-&gt;</span><span class="token function">add_mtd</span><span class="token punctuation">(</span>tr<span class="token punctuation">,</span> mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtd_table_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mtd_blktrans_request是MTD设备的请求处理函数，当请求队列中的请求需要设备处理时调用这个函数。在MTD设备中，函数 mtd_blktrans_request唤醒了MTD块设备的线程来进行处理。函数列出如下（在drivers/mtd/mtd_blkdevs.c 中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mtd_blktrans_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>rq<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span> <span class="token operator">*</span>tr <span class="token operator">=</span> rq<span class="token operator">-&gt;</span>queuedata<span class="token punctuation">;</span>
	<span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>thread_wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>线程函数mtd_blktrans_thread处理块设备的读写请求，函数mtd_blktrans_thread列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mtd_blktrans_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span> <span class="token operator">*</span>tr <span class="token operator">=</span> arg<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>rq <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>rq<span class="token punctuation">;</span>
	<span class="token comment">/* we might get involved when memory gets low, so use PF_MEMALLOC */</span> current<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> PF_MEMALLOC <span class="token operator">|</span> PF_NOFREEZE<span class="token punctuation">;</span>
	<span class="token comment">//变成以init为父进程的后台进程</span>
	<span class="token function">daemonize</span><span class="token punctuation">(</span>“<span class="token operator">%</span>sd”<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//因为一些内核线程实际上要与信号打交道，daemonize()没有做后台化工作。</span>
	<span class="token comment">//我们不能仅调用exit_sighand函数，</span>
	<span class="token comment">//因为当最终退出时这样将可能引起oop（对象指针溢出错误）。 </span>
	<span class="token function">spin_lock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>current<span class="token operator">-&gt;</span>sighand<span class="token operator">-&gt;</span>siglock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>current<span class="token operator">-&gt;</span>blocked<span class="token punctuation">)</span><span class="token punctuation">;</span>

 
    <span class="token comment">// 重新分析是否有挂起信号并设置或清除TIF_SIGPENDING标识给当前进程</span>
	<span class="token function">recalc_sigpending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>current<span class="token operator">-&gt;</span>sighand<span class="token operator">-&gt;</span>siglock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_lock_irq</span><span class="token punctuation">(</span>rq<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>exiting<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
		<span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">DECLARE_WAITQUEUE</span><span class="token punctuation">(</span>wait<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//声明当前进程的等待队列</span>

 
       req <span class="token operator">=</span> <span class="token function">elv_next_request</span><span class="token punctuation">(</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从块设备的请求队列中得到下一个请求</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果请求不存在</span>
			<span class="token comment">//将设备的等待线程加到等待队列中</span>
			<span class="token function">add_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>thread_wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_INTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">spin_unlock_irq</span><span class="token punctuation">(</span>rq<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//调度让CPU有机会执行等待的线程　</span>
			<span class="token function">remove_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>thread_wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">spin_lock_irq</span><span class="token punctuation">(</span>rq<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
 


	    <span class="token comment">//如果请求存在</span>
		dev <span class="token operator">=</span> req<span class="token operator">-&gt;</span>rq_disk<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span><span class="token comment">//得到请求的设备</span>
		tr <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>tr<span class="token punctuation">;</span>　<span class="token comment">//得到MTD翻译层设备操作函数集实例</span>
		<span class="token function">spin_unlock_irq</span><span class="token punctuation">(</span>rq<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span> res <span class="token operator">=</span> <span class="token function">do_blktrans_request</span><span class="token punctuation">(</span>tr<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理请求 up(&amp;dev-&gt;sem);</span>
		<span class="token function">spin_lock_irq</span><span class="token punctuation">(</span>rq<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">end_request</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从请求队列中删除请求并更新统计信息</span>
	<span class="token punctuation">}</span>

	<span class="token function">spin_unlock_irq</span><span class="token punctuation">(</span>rq<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//调用所有请求处理完的回调函数，并调用do_exit函数退出线程</span>
	<span class="token function">complete_and_exit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>thread_dead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数do_blktrans_request完成请求的具体操作，它调用MTD翻译层设备操作函数集实例中的具体函数来进行处理。函数do_blktrans_request分析如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">do_blktrans_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span> <span class="token operator">*</span>tr<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> block<span class="token punctuation">,</span> nsect<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span>
	 
	block <span class="token operator">=</span> req<span class="token operator">-&gt;</span>sector<span class="token punctuation">;</span>
	nsect <span class="token operator">=</span> req<span class="token operator">-&gt;</span>current_nr_sectors<span class="token punctuation">;</span>
	buf <span class="token operator">=</span> req<span class="token operator">-&gt;</span>buffer<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> REQ_CMD<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">//如果读写的扇区数超出了块设备的容量，返回</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">+</span> nsect <span class="token operator">&gt;</span> <span class="token function">get_capacity</span><span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>rq_disk<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	 
	<span class="token comment">//根据(rq)-&gt;flags &amp; 1标识来判断操作方式，调用具体的设备操作函数</span>
	<span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token function">rq_data_dir</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> READ<span class="token operator">:</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> nsect <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> nsect<span class="token operator">--</span><span class="token punctuation">,</span> block<span class="token operator">++</span><span class="token punctuation">,</span> buf <span class="token operator">+=</span> <span class="token number">512</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span><span class="token function">readsect</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		 
		<span class="token keyword">case</span> WRITE<span class="token operator">:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tr<span class="token operator">-&gt;</span>writesect<span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> nsect <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> nsect<span class="token operator">--</span><span class="token punctuation">,</span> block<span class="token operator">++</span><span class="token punctuation">,</span> buf <span class="token operator">+=</span> <span class="token number">512</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span><span class="token function">writesect</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		 
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE “Unknown request <span class="token operator">%</span>ld\n”<span class="token punctuation">,</span> <span class="token function">rq_data_dir</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fd/c4/J0Mx8dx7_o.png" alt="在这里插入图片描述"></p> 
<p>结构mtd_notifier是用于通知加上和去掉MTD原始设备。对于块设备来说，这个结构实例blktrans_notifier用来通知翻译层加上 和去掉MTD原始设备。结构实例blktrans_notifier列出如下（在drivers/mtd/mtd_blkdevs.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_notifier</span> blktrans_notifier <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>add <span class="token operator">=</span> blktrans_notify_add<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>remove <span class="token operator">=</span> blktrans_notify_remove<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数register_mtd_user注册MTD设备，通过分配通盘硬盘结构来激活每个MTD设备，使其出现在系统中。函数register_mtd_user调用层次图如上图。 函数register_mtd_user分析如下（在drivers/mtd/mtdcore.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>mtd_notifiers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">register_mtd_user</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_notifier</span> <span class="token operator">*</span>new<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtd_table_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将MTD块设备的通知结构实例blktrans_notifier加入</span>
	<span class="token comment">//到全局链表mtd_notifiers上</span>
	<span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mtd_notifiers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//模块引用计数加1</span>
	<span class="token function">__module_get</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token comment">//对每个MTD块设备调用MTD通知结构实例的加设备函数</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> MAX_MTD_DEVICES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
			new<span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span>mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtd_table_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数blktrans_notify_add通知MTD翻译层将设备加入到链表blktrans_majors中，并分配处理每个MTD分区对应的通用硬盘结构。 函数blktrans_notify_add分析如下（在drivers/mtd/mtd_blkdevs.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>blktrans_majors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">blktrans_notify_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>this<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mtd<span class="token operator">-&gt;</span>type <span class="token operator">==</span> MTD_ABSENT<span class="token punctuation">)</span><span class="token comment">//设备不存在</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	 
	<span class="token comment">//遍历每个MTD主块设备</span>
	<span class="token function">list_for_each</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token operator">&amp;</span>blktrans_majors<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span> <span class="token operator">*</span>tr <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span>
		<span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
		tr<span class="token operator">-&gt;</span><span class="token function">add_mtd</span><span class="token punctuation">(</span>tr<span class="token punctuation">,</span> mtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mtdblock_add_mtd分配了MTD翻译层块设备结构，初始化后加到MTD翻译层块设备链表中，函数mtdblock_add_mtd分析如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mtdblock_add_mtd</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span> <span class="token operator">*</span>tr<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>mtd <span class="token operator">=</span> mtd<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>devnum <span class="token operator">=</span> mtd<span class="token operator">-&gt;</span>index<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>blksize <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>size <span class="token operator">=</span> mtd<span class="token operator">-&gt;</span>size <span class="token operator">&gt;&gt;</span> <span class="token number">9</span><span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>tr <span class="token operator">=</span> tr<span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mtd<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> MTD_WRITEABLE<span class="token punctuation">)</span><span class="token punctuation">)</span>
		dev<span class="token operator">-&gt;</span>readonly <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">add_mtd_blktrans_dev</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数add_mtd_blktrans_dev给每个MTD主设备分配设备号，并加到MTD设备链表对应位置上。然后给每个MTD设备分区分配一个通用硬盘结构，初始化这个通用硬盘结构后，再注册通用硬盘。这样通过通用硬盘就可以访问到每个MTD设备分区。<br> 函数add_mtd_blktrans_dev分析如下（在drivers/mtd/mtd_blkdevs.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">add_mtd_blktrans_dev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_dev</span> <span class="token operator">*</span>new<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span> <span class="token operator">*</span>tr <span class="token operator">=</span> new<span class="token operator">-&gt;</span>tr<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>this<span class="token punctuation">;</span>
	<span class="token keyword">int</span> last_devnum <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>gd<span class="token punctuation">;</span>
 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">down_trylock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtd_table_mutex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtd_table_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">BUG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//遍历MTD每个主块设备</span>
	<span class="token function">list_for_each</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>devs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_dev</span> <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span>
		<span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_dev</span><span class="token punctuation">,</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
		<span class="token keyword">if</span> <span class="token punctuation">(</span>new<span class="token operator">-&gt;</span>devnum <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果没有设备号</span>
			<span class="token comment">//使用第一个空闲的设备号</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>devnum <span class="token operator">!=</span> last_devnum<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">//找到空闲设备号，并把设备加到链表的尾部</span>
				new<span class="token operator">-&gt;</span>devnum <span class="token operator">=</span> last_devnum<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">goto</span> added<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>devnum <span class="token operator">==</span> new<span class="token operator">-&gt;</span>devnum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//设备号已被使用</span>
			<span class="token comment">/* Required number taken */</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>devnum <span class="token operator">&gt;</span> new<span class="token operator">-&gt;</span>devnum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//申请的设备号是空闲的，加到链表的尾部</span>
			<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> added<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		last_devnum <span class="token operator">=</span> d<span class="token operator">-&gt;</span>devnum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>new<span class="token operator">-&gt;</span>devnum <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//如果新设备的设备号为-1，就赋上(最后一个设备号+1)</span>
	new<span class="token operator">-&gt;</span>devnum <span class="token operator">=</span> last_devnum<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">//所有的设备号*分区数 &gt; 256 </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>new<span class="token operator">-&gt;</span>devnum <span class="token operator">&lt;&lt;</span> tr<span class="token operator">-&gt;</span>part_bits<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 
	<span class="token function">init_MUTEX</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-&gt;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tr<span class="token operator">-&gt;</span>devs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加到链表尾部</span>
	 
added<span class="token operator">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tr<span class="token operator">-&gt;</span>writesect<span class="token punctuation">)</span>
	new<span class="token operator">-&gt;</span>readonly <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">//分配通知硬盘结构gendisk，每分区一个</span>
	gd <span class="token operator">=</span> <span class="token function">alloc_disk</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> tr<span class="token operator">-&gt;</span>part_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new<span class="token operator">-&gt;</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token comment">//初始化通用硬盘结构</span>
	gd<span class="token operator">-&gt;</span>major <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>major<span class="token punctuation">;</span>
	gd<span class="token operator">-&gt;</span>first_minor <span class="token operator">=</span> <span class="token punctuation">(</span>new<span class="token operator">-&gt;</span>devnum<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> tr<span class="token operator">-&gt;</span>part_bits<span class="token punctuation">;</span>
	gd<span class="token operator">-&gt;</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>mtd_blktrans_ops<span class="token punctuation">;</span>
	<span class="token function">snprintf</span><span class="token punctuation">(</span>gd<span class="token operator">-&gt;</span>disk_name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>gd<span class="token operator">-&gt;</span>disk_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
		“<span class="token operator">%</span>s<span class="token operator">%</span>c”<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>part_bits<span class="token operator">?</span>’a’<span class="token operator">:</span>’<span class="token number">0</span>’<span class="token punctuation">)</span> <span class="token operator">+</span> new<span class="token operator">-&gt;</span>devnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">snprintf</span><span class="token punctuation">(</span>gd<span class="token operator">-&gt;</span>devfs_name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>gd<span class="token operator">-&gt;</span>devfs_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
		“<span class="token operator">%</span>s<span class="token operator">/</span><span class="token operator">%</span>c”<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>part_bits<span class="token operator">?</span>’a’<span class="token operator">:</span>’<span class="token number">0</span>’<span class="token punctuation">)</span> <span class="token operator">+</span> new<span class="token operator">-&gt;</span>devnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token comment">/* 2.5 has capacity in units of 512 bytes while still
	having BLOCK_SIZE_BITS set to 10. Just to keep us amused. */</span>
	<span class="token function">set_capacity</span><span class="token punctuation">(</span>gd<span class="token punctuation">,</span> <span class="token punctuation">(</span>new<span class="token operator">-&gt;</span>size <span class="token operator">*</span> new<span class="token operator">-&gt;</span>blksize<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	gd<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> new<span class="token punctuation">;</span> <span class="token comment">//通用硬盘结构的私有数据指向翻译层的MTD设备</span>
	new<span class="token operator">-&gt;</span>blkcore_priv <span class="token operator">=</span> gd<span class="token punctuation">;</span>
	gd<span class="token operator">-&gt;</span>queue <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>blkcore_priv<span class="token operator">-&gt;</span>rq<span class="token punctuation">;</span> <span class="token comment">//设置请求队列</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>new<span class="token operator">-&gt;</span>readonly<span class="token punctuation">)</span>
		<span class="token function">set_disk_ro</span><span class="token punctuation">(</span>gd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//设置硬盘读写模式</span>
	<span class="token function">add_disk</span><span class="token punctuation">(</span>gd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加通用硬盘结构到全局链表中</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="25_MTD_551"></a>2.5. MTD块设备的读写操作</h3> 
<p><img src="https://images2.imgbox.com/a0/26/ZEJ2uIzG_o.png" alt="在这里插入图片描述"></p> 
<p>MTD翻译层设备操作函数集实例mtdblock_tr有对MTD设备的各种操作函数，这些操作函数调用了mtd_info结构中的操作函数。这里 只分析了函数mtdblock_writesect，它的源代码都在drivers/mtd/mtdblock.c中。由于flash设备需要先擦除一个 扇区，再才能写一个扇区，因而，使用了缓存来帮助不是正好一个扇区的数据的写操作。</p> 
<p>函数mtdblock_writesect将数据写入到flash设备中。函数分析如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mtdblock_writesect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> block<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//从MTD块设备数组中得到块设备结构</span>
	<span class="token keyword">struct</span> <span class="token class-name">mtdblk_dev</span> <span class="token operator">*</span>mtdblk <span class="token operator">=</span> mtdblks<span class="token punctuation">[</span>dev<span class="token operator">-&gt;</span>devnum<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>mtdblk<span class="token operator">-&gt;</span>cache_data <span class="token operator">&amp;&amp;</span> mtdblk<span class="token operator">-&gt;</span>cache_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//分配块设备用于擦除的缓存空间</span>
		mtdblk<span class="token operator">-&gt;</span>cache_data <span class="token operator">=</span> <span class="token function">vmalloc</span><span class="token punctuation">(</span>mtdblk<span class="token operator">-&gt;</span>mtd<span class="token operator">-&gt;</span>erasesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mtdblk<span class="token operator">-&gt;</span>cache_data<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINTR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//从位置block开始写一个扇区(512字节)</span>
	<span class="token keyword">return</span> <span class="token function">do_cached_write</span><span class="token punctuation">(</span>mtdblk<span class="token punctuation">,</span> block<span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数do_cached_write将数据写入到设备，由于flash设备需要先擦除再才能写入，因而，在数据块大小不是正好扇区大小，需要通过缓存凑合成一个扇区时，才能写入到设备。 函数do_cached_write分析如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">do_cached_write</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtdblk_dev</span> <span class="token operator">*</span>mtdblk<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> pos<span class="token punctuation">,</span>
<span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd <span class="token operator">=</span> mtdblk<span class="token operator">-&gt;</span>mtd<span class="token punctuation">;</span>
	<span class="token comment">//得到擦除缓冲区大小</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> sect_size <span class="token operator">=</span> mtdblk<span class="token operator">-&gt;</span>cache_size<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> retlen<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sect_size<span class="token punctuation">)</span><span class="token comment">//如果块设备的缓冲大小为0，直接写设备</span>
		<span class="token keyword">return</span> <span class="token function">MTD_WRITE</span> <span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token operator">&amp;</span>retlen<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token keyword">while</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//将要写的在设备上的位置pos地址处，长度为len          </span>
		<span class="token comment">//            |&lt;-offset--&gt;|&lt;-size--&gt;|           </span>
		<span class="token comment">// ----------sect_start---|pos-----len-|</span>
		<span class="token comment">//            |&lt;-   sect_size     -&gt;|</span>
		<span class="token comment">//计算扇区开始位置</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">long</span> sect_start <span class="token operator">=</span> <span class="token punctuation">(</span>pos<span class="token operator">/</span>sect_size<span class="token punctuation">)</span><span class="token operator">*</span>sect_size<span class="token punctuation">;</span>
		<span class="token comment">//计算出相对扇区开始位置的偏移</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> offset <span class="token operator">=</span> pos <span class="token operator">-</span> sect_start<span class="token punctuation">;</span>
		<span class="token comment">//计算出所写的大小</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> sect_size <span class="token operator">-</span> offset<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> size <span class="token operator">&gt;</span> len <span class="token punctuation">)</span>
			size <span class="token operator">=</span> len<span class="token punctuation">;</span>
		 
		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> sect_size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//正好是擦除缓冲区大小</span>
		<span class="token comment">//直接写入，不需要通过缓冲区　</span>
		ret <span class="token operator">=</span> <span class="token function">erase_write</span> <span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> size<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
			<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//只有部分扇区大小的数据，需通过缓冲区补充成扇区大小　</span>
			<span class="token comment">//方法是：先从设备中读出数据到缓冲区，再将buf中数据拷贝到缓冲区，</span>
			<span class="token comment">//这样，凑合成一个扇区大小的数据，再把缓冲区数据写入设备。</span>
			<span class="token comment">//如果缓冲区数据是脏的，把缓冲区数据写设备</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mtdblk<span class="token operator">-&gt;</span>cache_state <span class="token operator">==</span> STATE_DIRTY <span class="token operator">&amp;&amp;</span>
				mtdblk<span class="token operator">-&gt;</span>cache_offset <span class="token operator">!=</span> sect_start<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				ret <span class="token operator">=</span> <span class="token function">write_cached_data</span><span class="token punctuation">(</span>mtdblk<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
				<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			 
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mtdblk<span class="token operator">-&gt;</span>cache_state <span class="token operator">==</span> STATE_EMPTY <span class="token operator">||</span>
				mtdblk<span class="token operator">-&gt;</span>cache_offset <span class="token operator">!=</span> sect_start<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">//把当前的扇区数据填充缓冲区　</span>
				mtdblk<span class="token operator">-&gt;</span>cache_state <span class="token operator">=</span> STATE_EMPTY<span class="token punctuation">;</span>
				ret <span class="token operator">=</span> <span class="token function">MTD_READ</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> sect_start<span class="token punctuation">,</span> sect_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>retlen<span class="token punctuation">,</span>
				mtdblk<span class="token operator">-&gt;</span>cache_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
				<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>retlen <span class="token operator">!=</span> sect_size<span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
				mtdblk<span class="token operator">-&gt;</span>cache_offset <span class="token operator">=</span> sect_start<span class="token punctuation">;</span>
				mtdblk<span class="token operator">-&gt;</span>cache_size <span class="token operator">=</span> sect_size<span class="token punctuation">;</span>
				mtdblk<span class="token operator">-&gt;</span>cache_state <span class="token operator">=</span> STATE_CLEAN<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		 
			<span class="token comment">//将数据从buf中拷贝到缓冲区中</span>
			<span class="token function">memcpy</span> <span class="token punctuation">(</span>mtdblk<span class="token operator">-&gt;</span>cache_data <span class="token operator">+</span> offset<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mtdblk<span class="token operator">-&gt;</span>cache_state <span class="token operator">=</span> STATE_DIRTY<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		 
		buf <span class="token operator">+=</span> size<span class="token punctuation">;</span>
		pos <span class="token operator">+=</span> size<span class="token punctuation">;</span>
		len <span class="token operator">-=</span> size<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数write_cached_data将设备缓存中的数据写入到设备，在写完缓存中数据时，缓存的状态发生变化。函数write_cached_data列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">write_cached_data</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtdblk_dev</span> <span class="token operator">*</span>mtdblk<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd <span class="token operator">=</span> mtdblk<span class="token operator">-&gt;</span>mtd<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mtdblk<span class="token operator">-&gt;</span>cache_state <span class="token operator">!=</span> STATE_DIRTY<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">erase_write</span> <span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> mtdblk<span class="token operator">-&gt;</span>cache_offset<span class="token punctuation">,</span>
	mtdblk<span class="token operator">-&gt;</span>cache_size<span class="token punctuation">,</span> mtdblk<span class="token operator">-&gt;</span>cache_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	mtdblk<span class="token operator">-&gt;</span>cache_state <span class="token operator">=</span> STATE_EMPTY<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数erase_write写一扇区数据到设备中，写的方法是：先擦除对应扇区，擦除完成后，再写数据。函数erase_write分析如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">erase_write</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> pos<span class="token punctuation">,</span>
       <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">erase_info</span> erase<span class="token punctuation">;</span>
	<span class="token function">DECLARE_WAITQUEUE</span><span class="token punctuation">(</span>wait<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">wait_queue_head_t</span> wait_q<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> retlen<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">//首先，擦除flash闪存块</span>
	<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait_q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	erase<span class="token punctuation">.</span>mtd <span class="token operator">=</span> mtd<span class="token punctuation">;</span>
	erase<span class="token punctuation">.</span>callback <span class="token operator">=</span> erase_callback<span class="token punctuation">;</span>
	erase<span class="token punctuation">.</span>addr <span class="token operator">=</span> pos<span class="token punctuation">;</span>
	erase<span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>
	erase<span class="token punctuation">.</span>priv <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token operator">&amp;</span>wait_q<span class="token punctuation">;</span>

    <span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_INTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">add_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait_q<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">MTD_ERASE</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>erase<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果擦除完成</span>
		<span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//运行当前进程</span>
		<span class="token function">remove_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait_q<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清除等待队列		</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

 


    <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调度来等待擦除工作的完成</span>
	<span class="token function">remove_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait_q<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除等待队列</span>
	<span class="token comment">//第二步，写数据到flash设备 </span>
	ret <span class="token operator">=</span> <span class="token function">MTD_WRITE</span> <span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token operator">&amp;</span>retlen<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>retlen <span class="token operator">!=</span> len<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mtdblock_readsect调用了函数do_cached_read，从flash设备中读数据到指定位置的buf中，如果数据在设备的缓存 中，就直接从缓存中拷贝到buf中，如果不在，就从flash中读出到buf中。函数do_cached_read说明如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">do_cached_read</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtdblk_dev</span> <span class="token operator">*</span>mtdblk<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> pos<span class="token punctuation">,</span>
<span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
</code></pre> 
<p>其中参数mtdblk是指定的MTD块设备，pos是MTD设备中指定的位置，len是长度，buf是被写入的地址，调用成功时返回0，失败时返回错误码。函数从指定的MTD块设备中缓冲读到指定位置buf中。</p> 
<h3><a id="26_MTD_722"></a>2.6. MTD核心初始化</h3> 
<p>MTD核心主要工作是进行电源管理及在/proc文件系统中输出MTD设备的信息。函数init_mtd初始化proc文件系统函数、注册电源管理函数、初始化mtd设备函数，清除模块函数做相反的一些清除工作。</p> 
<p>函数init_mtd分析如下（在linux/drivers/mtd/mtd_core.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __init <span class="token function">init_mtd</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>proc_mtd <span class="token operator">=</span> <span class="token function">create_proc_entry</span><span class="token punctuation">(</span> “mtd”<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		proc_mtd<span class="token operator">-&gt;</span>read_proc <span class="token operator">=</span> mtd_read_proc<span class="token punctuation">;</span>
	mtd_pm_dev <span class="token operator">=</span> <span class="token function">pm_register</span><span class="token punctuation">(</span>PM_UNKNOWN_DEV<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mtd_pm_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">cleanup_mtd</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mtd_pm_dev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">pm_unregister</span><span class="token punctuation">(</span>mtd_pm_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mtd_pm_dev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>proc_mtd<span class="token punctuation">)</span>
		<span class="token function">remove_proc_entry</span><span class="token punctuation">(</span> “mtd”<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>mtd_read_proc函数是proc系统调用到的最终读函数，它以字符形式读出结构struct mtd_info相关信息。<br> mtd_pm_callback函数通过各个设备的MTD设备结构mtd_info将电源管理请求传给具体的设备驱动程序。mtd_pm_callback函数列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mtd_pm_callback</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pm_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token class-name">pm_request_t</span> rqst<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_trylock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtd_table_mutex<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rqst <span class="token operator">==</span> PM_SUSPEND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//电源挂起状态</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ret <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> MAX_MTD_DEVICES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>suspend<span class="token punctuation">)</span>
				ret <span class="token operator">=</span> mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">suspend</span><span class="token punctuation">(</span>mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> 
		i <span class="token operator">=</span> MAX_MTD_DEVICES<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rqst <span class="token operator">==</span> PM_RESUME <span class="token operator">||</span> ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//电源恢复</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>resume<span class="token punctuation">)</span>
				mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">resume</span><span class="token punctuation">(</span>mtd_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtd_table_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="27_MTD_774"></a>2.7. MTD字符设备</h3> 
<p>当系统打开flash设备上的文件，它建立好了文件的操作函数集实例，当对文件操作时，就调用了这个文件操作函数集实例中的函数。当flash设备当作字符设备时，这些操作函数通过MTD设备的操作函数把数据直接读入/写出flash设备。</p> 
<p>函数init_mtdchar注册了一个字符设备，列出如下（在drivers/mtd/mtdchar.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">init_mtdchar</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">register_chrdev</span><span class="token punctuation">(</span>MTD_CHAR_MAJOR<span class="token punctuation">,</span> “mtd”<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mtd_fops<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE “Can’t allocate major number <span class="token operator">%</span>d
		<span class="token keyword">for</span> Memory Technology Devices<span class="token punctuation">.</span>\n”<span class="token punctuation">,</span>
		MTD_CHAR_MAJOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token function">mtdchar_devfs_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>MTD字符设备的操作函数结构mtd_fops列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> mtd_fops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>owner		<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>llseek		<span class="token operator">=</span> mtd_lseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read		<span class="token operator">=</span> mtd_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write		<span class="token operator">=</span> mtd_write<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ioctl		<span class="token operator">=</span> mtd_ioctl<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open		<span class="token operator">=</span> mtd_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release	<span class="token operator">=</span> mtd_close<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里只分析了mtd_write函数，函数mtd_write完成此函数是对MTD字符设备的写操作。其中参数file是系统给MTD字符设备驱动程序用 于传递参数的file结构，函数mtd_write通过file得到下层的MTD设备结构，参数buf是用户空间的指针，用于存放将要写入的数据，参数 count是被写数据的长度，参数ppos是数据被写入MTD设备中的位置。当调用成功时返回返回实际读取数据的长度，若失败时返回错误码。<br> 函数mtd_write分析如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">mtd_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span>
<span class="token class-name">size_t</span> count<span class="token punctuation">,</span><span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd <span class="token operator">=</span> file<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>　<span class="token comment">//得到MTD设备结构</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>kbuf<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> retlen<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> total_retlen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> len<span class="token punctuation">;</span>
	 
	<span class="token function">DEBUG</span><span class="token punctuation">(</span>MTD_DEBUG_LEVEL0<span class="token punctuation">,</span>”MTD_write\n”<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ppos <span class="token operator">==</span> mtd<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ppos <span class="token operator">+</span> count <span class="token operator">&gt;</span> mtd<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span>
		count <span class="token operator">=</span> mtd<span class="token operator">-&gt;</span>size <span class="token operator">-</span> <span class="token operator">*</span>ppos<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>count<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> MAX_KMALLOC_SIZE<span class="token punctuation">)</span>
			len <span class="token operator">=</span> MAX_KMALLOC_SIZE<span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			len <span class="token operator">=</span> count<span class="token punctuation">;</span>
		 
		kbuf<span class="token operator">=</span><span class="token function">kmalloc</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span>GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//分配buffer</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kbuf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printk</span><span class="token punctuation">(</span>“kmalloc is null\n”<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		 
		<span class="token comment">//从用户空间buf拷贝数据到内核空间kbuf</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>kbuf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">kfree</span><span class="token punctuation">(</span>kbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		 
		<span class="token comment">//调用设备的写函数</span>
		ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mtd<span class="token operator">-&gt;</span>write<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> <span class="token operator">*</span>ppos<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token operator">&amp;</span>retlen<span class="token punctuation">,</span> kbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token operator">*</span>ppos <span class="token operator">+=</span> retlen<span class="token punctuation">;</span>
			total_retlen <span class="token operator">+=</span> retlen<span class="token punctuation">;</span>
			count <span class="token operator">-=</span> retlen<span class="token punctuation">;</span>
			buf <span class="token operator">+=</span> retlen<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">kfree</span><span class="token punctuation">(</span>kbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		 
		<span class="token function">kfree</span><span class="token punctuation">(</span>kbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token keyword">return</span> total_retlen<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">/* mtd_write */</span>
</code></pre> 
<h3><a id="28_flash_867"></a>2.8. 具体flash芯片的探测及映射</h3> 
<p>（1）flash芯片映射信息结构</p> 
<p>flash芯片映射信息结构map_info描述了每一排闪存的映射信息。如：每一排闪存的驱动程序、物理地址、读写操作函数和映射地址 等。如果设备需要它，系统就必须把它传递到芯片探测例程do_map_probe中。JEDEC和CFI接口的芯片都用这个探测函数。如果芯片被识别，就 会激活合适的芯片驱动程序并返回一个mtd_info结构。同时，系统使用这个驱动程序的模块地址填充mtd-&gt;module，并把它注册到MTD 核心代码中。或者如果有分区，就注册分区。map_info结构保存在mtd-&gt;priv域，芯片驱动程序需要的更多的信息通过链接 mtd-&gt;priv-&gt;fldrv_priv可得到。</p> 
<p>flash芯片映射信息结构map_info列出如下（在include/linux/mtd/mtd.h中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>　　<span class="token comment">//flash大小</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> phys<span class="token punctuation">;</span>   　<span class="token comment">//起始物理地址</span>
	 
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NO_XIP</span> <span class="token expression"><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1UL</span><span class="token punctuation">)</span></span></span>
	<span class="token keyword">void</span> __iomem <span class="token operator">*</span>virt<span class="token punctuation">;</span>　　<span class="token comment">//I/O映射的虚拟地址</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>cached<span class="token punctuation">;</span> <span class="token comment">//8位的字节，它不是实际总线的必要宽度。</span>
	<span class="token comment">//在再次与第一个芯片通信之前，它是字节上重复的间隔</span>
	<span class="token keyword">int</span> bankwidth<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MTD_COMPLEX_MAPPINGS</span></span>
	 
	<span class="token function">map_word</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>copy_from<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token class-name">ssize_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> map_word<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>copy_to<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">ssize_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* We can perhaps put in ‘point’ and ‘unpoint’ methods, if we really
	want to enable XIP for non-linear mappings. Not yet though. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	 
	<span class="token comment">/*在映射驱动程序的copy_from应用中，映射驱动程序使用缓存是可能的。然而，当芯片驱动程序知道一些flash区域已改变内容时，系统在必要时将通过这个例程发信号给芯片驱动程序，让映射驱动程序使缓存无效。如果没有缓存时，把这个域设为NULL。*/</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>inval_cache<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token class-name">ssize_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* set_vpp() must handle being reentered—enable, enable, disable
	must leave it enabled. */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_vpp<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> map_priv_1<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> map_priv_2<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>fldrv_priv<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_chip_driver</span> <span class="token operator">*</span>fldrv<span class="token punctuation">;</span> <span class="token comment">//flash芯片驱动程序</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构mtd_chip_driver是flash芯片驱动程序的描述，列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mtd_chip_driver</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//探测函数</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>destroy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>module<span class="token punctuation">;</span>　<span class="token comment">//驱动程序的模块结构</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>　<span class="token comment">//驱动程序名</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>（2）flash芯片探测方法及接口标准<br> 每种flash控制芯片可控制多种闪存，这个控制芯片的驱动程序有自己的读写和探测操作函数或者使用通用的操作函数，它注册MTD驱动程序结构 mtd_chip_driver到一个全局链表chip_drvs_list中。当用户使用一种flash闪存时，用户在称为"映射驱动程序"的文件中分 配好地址、进行闪存空间分区后，使用探测程序查找相应的控制芯片驱动程序。映射驱动程序用来填充一些闪存空间分配的一些信息，代码放在 drivers/mtd/map目录下。</p> 
<p>在/drivers/mtd/chips目录下有各种flash控制芯片的驱动程序及芯片探测程序，这些文件有chipreg.c、 gen_probe.c、cfi_probe.c、jedec_probe.c、cfi_cmdset_0001.c、 cfi_cmdset_0002.c、map_rom.c、map_ram.c、map_absent.c、amd_flash.c、jedec.c和 sharp.c。CFI设备和JEDEC设备都要用到gen_probe.c文件。</p> 
<p>确定flash闪存芯片是否支持CFI接口的方法是：向flash闪存的地址0x55H写入数据0x98H，再从flash闪存的地址 0x10H处开始，读取3个存储单元，如果字符分别为’Q’,’R’和’Y’，那么flash闪存芯片是支持CFI接口的。这个方法在文件 cfi_probe.c函数qry_present中实现。支持CFI接口flash闪存芯片的类型名称为 “cfi_probe”。</p> 
<p>也可以用JEDEC（电子电器设备联合会）标准设备模仿CFI接口，探测JEDEC设备的程序在jedec_probe.c中，JEDEC设备的类型为"jedec_probe"。</p> 
<p>对于flash芯片，不同的制造商使用不同的命令集，目前Linux的MTD实现的命令集有AMD/Fujitsu的标准命令集和 Intel/Sharp的扩展命令集（兼容Intel/Sharp标准命令集）两个，这两个命令集分别在cfi_cmdset_0002.c和 cfi_cmdset_0001.c中实现。</p> 
<p>此外还有一些非CFI标准的Flash，其中"jedec"类型的Flash的探测程序在jedec.c中,"sharp"类型的Flash的探测程序在sharp.c中，"amd_flash"类型的Flash的探测程序在amd_flash.c中。</p> 
<p>最后，还有一些非Flash的MTD，比如ROM或absent（无）设备。这些设备的探测程序在map_rom.c、map_ram.c和map_absent.c中。</p> 
<p>chip_drvs_list是所有芯片类型的驱动器链表,flash控制芯片的驱动程序通过调用register_mtd_chip_driver() 和unregister_mtd_chip_driver()向此链表中添加或去除MTD芯片驱动结构。这两个函数列出如下（在drivers/mtd /chips/chipreg.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">register_mtd_chip_driver</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_chip_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chip_drvs_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>drv<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>chip_drvs_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chip_drvs_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">unregister_mtd_chip_driver</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_chip_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chip_drvs_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>drv<span class="token operator">-&gt;</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chip_drvs_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>映射驱动程序调用函数do_map_probe来查找对应的控制芯片驱动程序。函数中参数name是控制芯片类型名称，参数是映射驱动程序中设置的flash闪存空间信息。若调用成功时返回MTD设备的结构mtd_info，失败时返回NULL。<br> 函数do_map_probe分析如下（在drivers/mtd/chips/chipreg.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span><span class="token function">do_map_probe</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span>map<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_chip_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>ret<span class="token punctuation">;</span>
	<span class="token comment">//查找得到name类型的控制芯片驱动程序结构</span>
	drv <span class="token operator">=</span> <span class="token function">get_mtd_chip_driver</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>drv <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">request_module</span><span class="token punctuation">(</span>“<span class="token operator">%</span>s”<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
		drv <span class="token operator">=</span> <span class="token function">get_mtd_chip_driver</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>drv<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	 
	ret <span class="token operator">=</span> drv<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//具体控制芯片驱动程序的探测函数</span>
	<span class="token comment">//使用计数减1，它可能已是一个探测过的模块，在这不需要再探测， </span>
	<span class="token comment">//而在实际的驱动程序中已做处理。</span>
	<span class="token function">module_put</span><span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="29__977"></a>2.9. 驱动程序实例分析</h3> 
<p>（1）CFI控制芯片驱动程序</p> 
<p>CFI控制芯片驱动程序cfi_probe在drivers/mtd/chip/cfi_probe.c中，这里只做了简单的说明。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_chip_driver</span> cfi_chipdrv <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>probe		<span class="token operator">=</span> cfi_probe<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>name		<span class="token operator">=</span> “cfi_probe”<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>module		<span class="token operator">=</span> THIS_MODULE
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数cfi_probe_init注册驱动程序cfi_chipdrv到全局链表中，函数列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __init <span class="token function">cfi_probe_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">register_mtd_chip_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cfi_chipdrv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">cfi_probe_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">unregister_mtd_chip_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cfi_chipdrv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数cfi_probe调用mtd_do_chip_probe函数来完成了探测操作，在函数cfi_chip_probe中，它调用 qry_present来查询是否是CFI接口，调用函数cfi_chip_setup)初始化cfi_private结构，调用函数 cfi_chip_setup则读出CFI查询结构中的数据。然后，函数mtd_do_chip_probe调用函数check_cmd_set根据 map_info中的信息来设备不同的命令集：cfi_cmdset_0001()或cfi_cmdset_0002()，如果符合的类型没有则调用 cfi_cmdset_unkown。 函数cfi_probe列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span><span class="token function">cfi_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span>map<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">mtd_do_chip_probe</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cfi_chip_probe<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">chip_probe</span> cfi_chip_probe <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name		<span class="token operator">=</span> “CFI”<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe_chip	<span class="token operator">=</span> cfi_probe_chip
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>（2）映射驱动程序<br> 用户可设置flash空间映射信息填充在映射驱动程序中，包括该MTD原始设备的起始物理地址、大小、分区情况等。映射驱动程序都在drivers/mtd/maps子目录下。这里简单说明cfi_flagadm映射驱动程序（在cfi_flagadm.c中）。</p> 
<p>flagadm_map是映射信息结构，它含有flash存储空间的配置信息，列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">map_info</span> flagadm_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name <span class="token operator">=</span>		“FlagaDM flash device”<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>size <span class="token operator">=</span>		FLASH_SIZE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>bankwidth <span class="token operator">=</span>	<span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>flagadm_parts是flash存储空间的分区，列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mtd_partition</span> flagadm_parts<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span>name <span class="token operator">=</span>		“Bootloader”<span class="token punctuation">,</span>
<span class="token punctuation">.</span>offset	<span class="token operator">=</span>	FLASH_PARTITION0_ADDR<span class="token punctuation">,</span>
<span class="token punctuation">.</span>size <span class="token operator">=</span>		FLASH_PARTITION0_SIZE
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span>name <span class="token operator">=</span>		“Kernel image”<span class="token punctuation">,</span>
<span class="token punctuation">.</span>offset <span class="token operator">=</span>	FLASH_PARTITION1_ADDR<span class="token punctuation">,</span>
<span class="token punctuation">.</span>size <span class="token operator">=</span>		FLASH_PARTITION1_SIZE
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span>name <span class="token operator">=</span>		“Initial ramdisk image”<span class="token punctuation">,</span>
<span class="token punctuation">.</span>offset <span class="token operator">=</span>	FLASH_PARTITION2_ADDR<span class="token punctuation">,</span>
<span class="token punctuation">.</span>size <span class="token operator">=</span>		FLASH_PARTITION2_SIZE
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span>name <span class="token operator">=</span>		“Persistant storage”<span class="token punctuation">,</span>
<span class="token punctuation">.</span>offset <span class="token operator">=</span>	FLASH_PARTITION3_ADDR<span class="token punctuation">,</span>
<span class="token punctuation">.</span>size <span class="token operator">=</span>		FLASH_PARTITION3_SIZE
<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PARTITION_COUNT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>flagadm_parts<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_partition</span><span class="token punctuation">)</span></span></span>


<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mymtd<span class="token punctuation">;</span>
</code></pre> 
<p>函数init_flagadm是映射驱动程序的初始化，它得到了端口映射地址，初始化了操作函数，通过探测函数得到MTD设备结构。函数init_flagadm说明如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __init <span class="token function">init_flagadm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE “FlagaDM flash device<span class="token operator">:</span> <span class="token operator">%</span>x at <span class="token operator">%</span>x\n”<span class="token punctuation">,</span>
	FLASH_SIZE<span class="token punctuation">,</span> FLASH_PHYS_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	flagadm_map<span class="token punctuation">.</span>phys <span class="token operator">=</span> FLASH_PHYS_ADDR<span class="token punctuation">;</span>
	 
	<span class="token comment">//端口映射</span>
	flagadm_map<span class="token punctuation">.</span>virt <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>FLASH_PHYS_ADDR<span class="token punctuation">,</span>FLASH_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flagadm_map<span class="token punctuation">.</span>virt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>“Failed to ioremap\n”<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token comment">//赋上通用的读写操作函数，如：__raw_writeb等</span>
	<span class="token function">simple_map_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flagadm_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//探测CFI类型接口得到MTD设备结构</span>
	mymtd <span class="token operator">=</span> <span class="token function">do_map_probe</span><span class="token punctuation">(</span>“cfi_probe”<span class="token punctuation">,</span> <span class="token operator">&amp;</span>flagadm_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mymtd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		mymtd<span class="token operator">-&gt;</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
		<span class="token comment">//将分区信息加到MTD设备结构实例mymtd中</span>
		<span class="token function">add_mtd_partitions</span><span class="token punctuation">(</span>mymtd<span class="token punctuation">,</span> flagadm_parts<span class="token punctuation">,</span> PARTITION_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE “FlagaDM flash device initialized\n”<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token function">iounmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>flagadm_map<span class="token punctuation">.</span>virt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取消端口映射　</span>
	<span class="token keyword">return</span> <span class="token operator">-</span>ENXIO<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">cleanup_flagadm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mymtd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">del_mtd_partitions</span><span class="token punctuation">(</span>mymtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">map_destroy</span><span class="token punctuation">(</span>mymtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>flagadm_map<span class="token punctuation">.</span>virt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">iounmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>flagadm_map<span class="token punctuation">.</span>virt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		flagadm_map<span class="token punctuation">.</span>virt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="3_SDMMC_1113"></a>3. SD/MMC卡块设备驱动程序</h2> 
<p>SD/MMC卡组成的存储系统是许多嵌入设备的主要存储设备，相当于PC机的硬盘，在嵌入设备上的SD/MMC卡控制器通过MMC协议来解析命令控 制SD/MMC卡的操作。SD/MMC卡上有一些寄存器来控制卡的状态及读写操作。MMC协议规定的寄存器有：CID寄存器，128位，是卡的鉴别寄存 器，存有卡的鉴别信息；RCA寄存器是16位，存有卡的本地系统的相对地址，在初始化时由控制器动态指定。DSR寄存器是16位，是配置卡的驱动程序的寄 存器，是可选的。CSD寄存器是卡特定数据信息描述寄存器，是可选的。OCR寄存器是操作控制寄存器。MMC卡的系统定义及相关协议请查询《MMC卡系统 定义3.1版本》。</p> 
<p>MMC驱动程序以分通用设备层、MMC抽象设备层、MMC协议层和具体设备层四层来构建，上一层抽象出下一层的共有特性，每一层以相应的结 构来描述。通用设备层对于块设备来说，主要负责设备内核对象在sysfs文件系统中的管理、请求队列管理、及与文件系统的接口，MMC抽象设备层抽出 MMC卡的共有特性，如： MMC卡的请求管理、电源管理等。MMC协议层将MMC操作分解成标准的MMC协议，具体设备层则负责具体物理设备的寄存器控制等。这种分层结构层次分 明，管理有效。MMC驱动程序的层次结构如下图。</p> 
<p>MMC驱动程序主要处理两部分的内容，一是创建通用硬盘结构向系统注册，以便系统对MMC设备的管理。另一方面，要完成系统分发过来的读写请求的处理。</p> 
<p><img src="https://images2.imgbox.com/dc/6c/kglgo9Mx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="31_MMC_1121"></a>3.1. MMC抽象设备层相关结构</h3> 
<h4><a id="311__1122"></a>3.1.1. 设备描述结构</h4> 
<p><img src="https://images2.imgbox.com/48/21/NCu0N3rp_o.png" alt="在这里插入图片描述"><br> MMC设备由控制器及插卡组成，对应的设备结构为mmc_host结构和mmc_card结构。MMC卡设备相关结构关系图如上图。下面分别说明设备相关结构：</p> 
<p>每个卡的插槽对应一个块的数据结构mmc_blk_data，结构列出如下（在drivers/mmc/mmc_block.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_blk_data</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">spinlock_t</span>	lock<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">gendisk</span>	<span class="token operator">*</span>disk<span class="token punctuation">;</span>　<span class="token comment">//通用硬盘结构</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> queue<span class="token punctuation">;</span>　<span class="token comment">//MMC请求队列结构</span>
	 
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	usage<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	block_bits<span class="token punctuation">;</span>　<span class="token comment">//卡每一块大小所占的bit位</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构mmc_card是一个插卡的特性描述结构，它代有了一个插卡。列出如下（在include/linux/mmc/card.h中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	node<span class="token punctuation">;</span>		<span class="token comment">//在主设备链表中的节点</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_host</span>		<span class="token operator">*</span>host<span class="token punctuation">;</span>		<span class="token comment">// 卡所属的控制器</span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span>		dev<span class="token punctuation">;</span>		<span class="token comment">//通用设备结构</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		rca<span class="token punctuation">;</span>		<span class="token comment">//设备的相对本地系统的地址</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		state<span class="token punctuation">;</span>		<span class="token comment">//卡的状态</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_STATE_PRESENT</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>		</span><span class="token comment">//卡出现在sysfs文件系统中</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_STATE_DEAD</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>		</span><span class="token comment">//卡不在工作状态</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_STATE_BAD</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span>		</span><span class="token comment">//不认识的设备</span></span>
	u32			raw_cid<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* raw card CID */</span>
	u32			raw_csd<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* raw card CSD */</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_cid</span>		cid<span class="token punctuation">;</span>		<span class="token comment">//卡的身份鉴别，值来自卡的CID寄存器</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_csd</span>		csd<span class="token punctuation">;</span>		<span class="token comment">//卡特定信息，值来自卡的CSD寄存器</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构mmc_host描述了一个MMC卡控制器的特性及操作等，结构mmc_host列出如下（在include/linux/mmc/host.h中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span>		<span class="token operator">*</span>dev<span class="token punctuation">;</span>　<span class="token comment">//通用设备结构</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_host_ops</span>	<span class="token operator">*</span>ops<span class="token punctuation">;</span>　<span class="token comment">//控制器操作函数集结构</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		f_min<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		f_max<span class="token punctuation">;</span>
	u32			ocr_avail<span class="token punctuation">;</span>　　　<span class="token comment">//卡可用的OCR寄存器值</span>
	<span class="token keyword">char</span>			host_name<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>　<span class="token comment">//控制器名字</span>
	 
	<span class="token comment">//主控制器中与块层请求队列相关数据</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		max_seg_size<span class="token punctuation">;</span>	<span class="token comment">//最大片断的尺寸　</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>		max_hw_segs<span class="token punctuation">;</span>	<span class="token comment">//最大硬件片断数　</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>		max_phys_segs<span class="token punctuation">;</span>	<span class="token comment">//最大物理片断数　</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>		max_sectors<span class="token punctuation">;</span>	<span class="token comment">//最大扇区数　</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>		unused<span class="token punctuation">;</span>
	 
	<span class="token comment">//私有数据</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_ios</span>		ios<span class="token punctuation">;</span>		<span class="token comment">//当前i/o总线设置</span>
	u32			ocr<span class="token punctuation">;</span>		　　　　<span class="token comment">//当前的OCR设置</span>
	 
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	cards<span class="token punctuation">;</span>		<span class="token comment">//接在这个主控制器上的设备　</span>
	 
	<span class="token class-name">wait_queue_head_t</span>	wq<span class="token punctuation">;</span>　　　　<span class="token comment">//等待队列</span>
	<span class="token class-name">spinlock_t</span>		lock<span class="token punctuation">;</span>		   <span class="token comment">//卡忙时的锁</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_card</span>		<span class="token operator">*</span>card_busy<span class="token punctuation">;</span>	<span class="token comment">//正与主控制器通信的卡　</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_card</span>		<span class="token operator">*</span>card_selected<span class="token punctuation">;</span>	<span class="token comment">//选择的MMC卡</span>
	 
	<span class="token keyword">struct</span> <span class="token class-name">work_struct</span>	detect<span class="token punctuation">;</span>　<span class="token comment">//工作结构</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构mmc_host_ops是控制器的操作函数集，它包括请求处理函数指针和控制器对卡I/O的状态的设置函数指针，结构mmc_host_ops列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_host_ops</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">void</span>	<span class="token punctuation">(</span><span class="token operator">*</span>request<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_request</span> <span class="token operator">*</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span>	<span class="token punctuation">(</span><span class="token operator">*</span>set_ios<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_ios</span> <span class="token operator">*</span>ios<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结构mmc_ios描述了控制器对卡的I/O状态，列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_ios</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	clock<span class="token punctuation">;</span>			<span class="token comment">//时钟频率</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>	vdd<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span>	bus_mode<span class="token punctuation">;</span>		<span class="token comment">//命令输出模式</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span>	power_mode<span class="token punctuation">;</span>		<span class="token comment">//电源供应模式</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构mmc_driver是MMC设备驱动程序结构，列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_driver</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">device_driver</span> drv<span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span><span class="token punctuation">,</span> u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="312__1222"></a>3.1.2. 读写请求相关结构</h4> 
<p><img src="https://images2.imgbox.com/e5/83/8pmIp1Rl_o.png" alt="在这里插入图片描述"></p> 
<p>对于MMC卡的操作是通过MMC请求结构mmc_request的传递来完成的，来自系统块层的读写请求到达MMC设备抽象层时，用系统的读写请求 填充初始化MMC卡的读写请求，经MMC协议分解后，然后把请求发给设备，再调用具体设备的请求处理函数来完成请求的处理。MMC卡读写请求结构示意图中 上图。下面分析MMC卡读写请求相关结构：</p> 
<p>结构mmc_request描述了读写MMC卡的请求，它包括命令、数据及请求完成后的回调函数。结构mmc_request列出如下（在include/linux/mmc/mmc.h中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_request</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_command</span>	<span class="token operator">*</span>cmd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_data</span>		<span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_command</span>	<span class="token operator">*</span>stop<span class="token punctuation">;</span>
	 
	<span class="token keyword">void</span>			<span class="token operator">*</span>done_data<span class="token punctuation">;</span>	<span class="token comment">//回调函数的参数</span>
	<span class="token keyword">void</span>			<span class="token punctuation">(</span><span class="token operator">*</span>done<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_request</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//请求完成的回调函数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构mmc_queue是MMC的请求队列结构，它封装了通用请求队列结构，加入了MMC卡相关结构，结构mmc_queue列出如下（在drivers/mmc/mmc_queue.h中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_card</span>		<span class="token operator">*</span>card<span class="token punctuation">;</span>　　<span class="token comment">//MMC卡结构</span>
	<span class="token keyword">struct</span> <span class="token class-name">completion</span>	thread_complete<span class="token punctuation">;</span>　<span class="token comment">//线程完成结构</span>
	<span class="token class-name">wait_queue_head_t</span>	thread_wq<span class="token punctuation">;</span>　<span class="token comment">//等待队列</span>
	<span class="token keyword">struct</span> <span class="token class-name">semaphore</span>	thread_sem<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		flags<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request</span>		<span class="token operator">*</span>req<span class="token punctuation">;</span>　　<span class="token comment">//通用请求结构</span>
	<span class="token keyword">int</span>			<span class="token punctuation">(</span><span class="token operator">*</span>prep_fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//发出读写请求函数</span>
	<span class="token keyword">int</span>			<span class="token punctuation">(</span><span class="token operator">*</span>issue_fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span>			<span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request_queue</span>	<span class="token operator">*</span>queue<span class="token punctuation">;</span>　<span class="token comment">//块层通用请求队列</span>
	<span class="token keyword">struct</span> <span class="token class-name">scatterlist</span>	<span class="token operator">*</span>sg<span class="token punctuation">;</span>　<span class="token comment">//碎片链表</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构mmc_data描述了MMC卡读写的数据相关信息，如：请求、操作命令、数据及状态等。结构mmc_data列出如下（在include/linuc/mmc/mmc.h中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_data</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		timeout_ns<span class="token punctuation">;</span>	<span class="token comment">//数据超时( ns,最大80ms) </span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		timeout_clks<span class="token punctuation">;</span>	<span class="token comment">//数据超时(以时钟计数)</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		blksz_bits<span class="token punctuation">;</span>	<span class="token comment">//数据块大小的bit位</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		blocks<span class="token punctuation">;</span>		<span class="token comment">//块数</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		error<span class="token punctuation">;</span>		<span class="token comment">//数据错误</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		flags<span class="token punctuation">;</span>　　　<span class="token comment">//数据操作标识</span>
	 
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_DATA_WRITE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_DATA_READ</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_DATA_STREAM</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span></span></span>
	 
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		bytes_xfered<span class="token punctuation">;</span>
	 
	<span class="token keyword">struct</span> <span class="token class-name">mmc_command</span>	<span class="token operator">*</span>stop<span class="token punctuation">;</span>		<span class="token comment">//停止命令</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_request</span>	<span class="token operator">*</span>mrq<span class="token punctuation">;</span>		<span class="token comment">//相关的请求</span>
	 
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		sg_len<span class="token punctuation">;</span>		<span class="token comment">//碎片链表的长度</span>
	<span class="token keyword">struct</span> <span class="token class-name">scatterlist</span>	<span class="token operator">*</span>sg<span class="token punctuation">;</span>		<span class="token comment">// I/O碎片链表指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构mmc_command描述了MMC卡操作相关命令及数据、状态信息等，结构列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_command</span> <span class="token punctuation">{<!-- --></span>
	u32			opcode<span class="token punctuation">;</span>
	u32			arg<span class="token punctuation">;</span>
	u32			resp<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		flags<span class="token punctuation">;</span>		<span class="token comment">//期望的反应类型</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_NONE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_SHORT</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_LONG</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_MASK</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_CRC</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span>		</span><span class="token comment">/* expect valid crc */</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_BUSY</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span>		</span><span class="token comment">/* card may send busy */</span></span>
	 
	<span class="token comment">/*
	* These are the response types, and correspond to valid bit
	* patterns of the above flags.  One additional valid pattern
	* is all zeros, which means we don't expect a response.
	*/</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_R1</span>	<span class="token expression"><span class="token punctuation">(</span>MMC_RSP_SHORT<span class="token operator">|</span>MMC_RSP_CRC<span class="token punctuation">)</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_R1B</span>	<span class="token expression"><span class="token punctuation">(</span>MMC_RSP_SHORT<span class="token operator">|</span>MMC_RSP_CRC<span class="token operator">|</span>MMC_RSP_BUSY<span class="token punctuation">)</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_R2</span>	<span class="token expression"><span class="token punctuation">(</span>MMC_RSP_LONG<span class="token operator">|</span>MMC_RSP_CRC<span class="token punctuation">)</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_RSP_R3</span>	<span class="token expression"><span class="token punctuation">(</span>MMC_RSP_SHORT<span class="token punctuation">)</span></span></span>
	 
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		retries<span class="token punctuation">;</span>	<span class="token comment">/* max number of retries */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		error<span class="token punctuation">;</span>		<span class="token comment">/* command error */</span>
	 
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_ERR_NONE</span>	<span class="token expression"><span class="token number">0</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_ERR_TIMEOUT</span>	<span class="token expression"><span class="token number">1</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_ERR_BADCRC</span>	<span class="token expression"><span class="token number">2</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_ERR_FIFO</span>	<span class="token expression"><span class="token number">3</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_ERR_FAILED</span>	<span class="token expression"><span class="token number">4</span></span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_ERR_INVALID</span>	<span class="token expression"><span class="token number">5</span></span></span>
	 
	<span class="token keyword">struct</span> <span class="token class-name">mmc_data</span>		<span class="token operator">*</span>data<span class="token punctuation">;</span>		<span class="token comment">//与命令相关的数据片断　</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_request</span>	<span class="token operator">*</span>mrq<span class="token punctuation">;</span>		<span class="token comment">//与命令相关的请求</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="32_MMCMMC_1324"></a>3.2. MMC抽象设备层MMC块设备驱动程序</h3> 
<h4><a id="321_MMC_1325"></a>3.2.1. MMC块设备驱动程序初始化</h4> 
<p>函数mmc_blk_init注册一个MMC块设备驱动程序，它先将MMC块设备名注册到名称数组major_names中，然后，还把驱动程序注 册到sysfs文件系统中的总线和设备目录中。一方面，sysfs文件系统中可显示MMC块设备相关信息，另一方面，sysfs文件系统以树形结构管理着 MMC块设备驱动程序。</p> 
<p>函数mmc_blk_init分析如下（在drivers/mmc/mmc_block.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">mmc_blk_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	 
	<span class="token comment">//将卡名字mmc和major注册到块设备的名称数组major_names中</span>
	res <span class="token operator">=</span> <span class="token function">register_blkdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token string">"mmc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Unable to get major %d for MMC media: %d\n"</span><span class="token punctuation">,</span>
		major<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		major <span class="token operator">=</span> res<span class="token punctuation">;</span>
	<span class="token comment">//在devfs文件系统中创建mmc目录</span>
	<span class="token function">devfs_mk_dir</span><span class="token punctuation">(</span><span class="token string">"mmc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">mmc_register_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mmc_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
out<span class="token operator">:</span>
	<span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>mmc_driver驱动程序实例声明如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_driver</span> mmc_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>drv		<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>name	<span class="token operator">=</span> <span class="token string">"mmcblk"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe		<span class="token operator">=</span> mmc_blk_probe<span class="token punctuation">,</span> <span class="token comment">// MMC块设备驱动程序探测函数</span>
	<span class="token punctuation">.</span>remove		<span class="token operator">=</span> mmc_blk_remove<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>suspend	<span class="token operator">=</span> mmc_blk_suspend<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>resume		<span class="token operator">=</span> mmc_blk_resume<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数mmc_register_driver 注册一个媒介层驱动程序。其中参数drv是MMC媒介层驱动程序结构。</p> 
<p>函数mmc_register_driver分析如下（在drivers/mmc/mmc_sysfs.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">mmc_register_driver</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	drv<span class="token operator">-&gt;</span>drv<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>mmc_bus_type<span class="token punctuation">;</span>
	drv<span class="token operator">-&gt;</span>drv<span class="token punctuation">.</span>probe <span class="token operator">=</span> mmc_drv_probe<span class="token punctuation">;</span>
	drv<span class="token operator">-&gt;</span>drv<span class="token punctuation">.</span>remove <span class="token operator">=</span> mmc_drv_remove<span class="token punctuation">;</span>
	<span class="token comment">//把块设备注册到sysfs文件系统中对应的总线及设备目录下</span>
	<span class="token keyword">return</span> <span class="token function">driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>drv<span class="token operator">-&gt;</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="322__MMC_1382"></a>3.2.2. MMC块设备驱动程序探测函数</h4> 
<p><img src="https://images2.imgbox.com/05/4e/seMGyktj_o.png" alt="在这里插入图片描述"><br> 函数mmc_blk_probe是MMC控制器探测函数，它探测MMC控制器是否存在，并初始化控制器的结构，同时，还探测MMC卡的状态并初始化。函数mmc_blk_probe调用层次图如上图。</p> 
<p>函数mmc_blk_probe列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mmc_blk_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span>card<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_blk_data</span> <span class="token operator">*</span>md<span class="token punctuation">;</span> <span class="token comment">//每个插槽一个结构mmc_blk_data</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>card<span class="token operator">-&gt;</span>csd<span class="token punctuation">.</span>cmdclass <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0x1ff</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>card<span class="token operator">-&gt;</span>csd<span class="token punctuation">.</span>read_blkbits <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//所读的块小于1扇区</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"%s: read blocksize too small (%u)\n"</span><span class="token punctuation">,</span>
		<span class="token function">mmc_card_id</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> card<span class="token operator">-&gt;</span>csd<span class="token punctuation">.</span>read_blkbits<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	
	<span class="token comment">//分配每个插槽的卡的块数据结构，初始化了通用硬盘及请求队列</span>
	md <span class="token operator">=</span> <span class="token function">mmc_blk_alloc</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>md<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>md<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//设置块大小，发命令设置卡为选中状态</span>
	err <span class="token operator">=</span> <span class="token function">mmc_blk_set_blksize</span><span class="token punctuation">(</span>md<span class="token punctuation">,</span> card<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	 
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"%s: %s %s %dKiB\n"</span><span class="token punctuation">,</span>
	md<span class="token operator">-&gt;</span>disk<span class="token operator">-&gt;</span>disk_name<span class="token punctuation">,</span> <span class="token function">mmc_card_id</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mmc_card_name</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">(</span>card<span class="token operator">-&gt;</span>csd<span class="token punctuation">.</span>capacity <span class="token operator">&lt;&lt;</span> card<span class="token operator">-&gt;</span>csd<span class="token punctuation">.</span>read_blkbits<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">mmc_set_drvdata</span><span class="token punctuation">(</span>card<span class="token punctuation">,</span> md<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//即card -&gt;driver_data = md</span>
	<span class="token function">add_disk</span><span class="token punctuation">(</span>md<span class="token operator">-&gt;</span>disk<span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//向系统注册通用硬盘结构，它包括每分区信息</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	 
out<span class="token operator">:</span>
	<span class="token function">mmc_blk_put</span><span class="token punctuation">(</span>md<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数*mmc_blk_alloc给每一插槽分配一个结构mmc_blk_data，并分配设置通用硬盘结构和初始了请求队列结构。</p> 
<p>函数*mmc_blk_alloc分析如下（在drivers/mmc/mmc_block.c中）：</p> 
<pre><code class="prism language-c"><span class="token comment">//最大支持8个控制器，每个控制器可控制4个卡，每个卡最大8个分区。</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_SHIFT</span>	<span class="token expression"><span class="token number">3</span> </span><span class="token comment">//表示每个卡最大支持8个分区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMC_NUM_MINORS</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">&gt;&gt;</span> MMC_SHIFT<span class="token punctuation">)</span>　</span><span class="token comment">//为256/8=32</span></span>
<span class="token comment">//即定义dev_use[32/(8*4)] = devuse[1]，一个控制器用32位表示使用情况</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dev_use<span class="token punctuation">[</span>MMC_NUM_MINORS<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_blk_data</span> <span class="token operator">*</span><span class="token function">mmc_blk_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span>card<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_blk_data</span> <span class="token operator">*</span>md<span class="token punctuation">;</span>
	<span class="token keyword">int</span> devidx<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
	<span class="token comment">//查找dev_use中第一个bit为0的位序号（在MMC_NUM_MINORS位以内）</span>
	<span class="token comment">//找到第个空闲的分区</span>
	devidx <span class="token operator">=</span> <span class="token function">find_first_zero_bit</span><span class="token punctuation">(</span>dev_use<span class="token punctuation">,</span> MMC_NUM_MINORS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>devidx <span class="token operator">&gt;=</span> MMC_NUM_MINORS<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOSPC<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__set_bit</span><span class="token punctuation">(</span>devidx<span class="token punctuation">,</span> dev_use<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将分区对应的位设置为1，表示使用。</span>
	 
	md <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_blk_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//分配对象空间</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>md<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">memset</span><span class="token punctuation">(</span>md<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_blk_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//分配gendisk结构及通用硬盘的分区hd_struct结构，并初始化内核对象</span>
		md<span class="token operator">-&gt;</span>disk <span class="token operator">=</span> <span class="token function">alloc_disk</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> MMC_SHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>md<span class="token operator">-&gt;</span>disk <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">kfree</span><span class="token punctuation">(</span>md<span class="token punctuation">)</span><span class="token punctuation">;</span>
			md <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		 
		<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>md<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		md<span class="token operator">-&gt;</span>usage <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token comment">//初始化请求队列</span>
		ret <span class="token operator">=</span> <span class="token function">mmc_init_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>md<span class="token operator">-&gt;</span>queue<span class="token punctuation">,</span> card<span class="token punctuation">,</span> <span class="token operator">&amp;</span>md<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">put_disk</span><span class="token punctuation">(</span>md<span class="token operator">-&gt;</span>disk<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">kfree</span><span class="token punctuation">(</span>md<span class="token punctuation">)</span><span class="token punctuation">;</span>
			md <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//赋上各种请求队列处理函数</span>
		md<span class="token operator">-&gt;</span>queue<span class="token punctuation">.</span>prep_fn <span class="token operator">=</span> mmc_blk_prep_rq<span class="token punctuation">;</span><span class="token comment">//准备请求</span>
		md<span class="token operator">-&gt;</span>queue<span class="token punctuation">.</span>issue_fn <span class="token operator">=</span> mmc_blk_issue_rq<span class="token punctuation">;</span><span class="token comment">//发出请求让设备开始处理</span>
		md<span class="token operator">-&gt;</span>queue<span class="token punctuation">.</span>data <span class="token operator">=</span> md<span class="token punctuation">;</span>
		<span class="token comment">//初始化通用硬盘</span>
		md<span class="token operator">-&gt;</span>disk<span class="token operator">-&gt;</span>major	<span class="token operator">=</span> major<span class="token punctuation">;</span>
		md<span class="token operator">-&gt;</span>disk<span class="token operator">-&gt;</span>first_minor <span class="token operator">=</span> devidx <span class="token operator">&lt;&lt;</span> MMC_SHIFT<span class="token punctuation">;</span>
		md<span class="token operator">-&gt;</span>disk<span class="token operator">-&gt;</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>mmc_bdops<span class="token punctuation">;</span>　<span class="token comment">//块设备操作函数集</span>
		md<span class="token operator">-&gt;</span>disk<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> md<span class="token punctuation">;</span>
		md<span class="token operator">-&gt;</span>disk<span class="token operator">-&gt;</span>queue <span class="token operator">=</span> md<span class="token operator">-&gt;</span>queue<span class="token punctuation">.</span>queue<span class="token punctuation">;</span>
		md<span class="token operator">-&gt;</span>disk<span class="token operator">-&gt;</span>driverfs_dev <span class="token operator">=</span> <span class="token operator">&amp;</span>card<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
		 
		<span class="token comment">/*带有永久的块设备可移去的介质应被设置GENHD_FL_REMOVABLE标识，对于永久的介质可移去的块设备不应设置GENHD_FL_REMOVABLE。MMC块设备属于永久介质可移去的块设备，不能设置GENHD_FL_REMOVABLE。用户空间应使用块设备创建/销毁热插拔消息来告诉何时卡存在。*/</span>
		 
		<span class="token function">sprintf</span><span class="token punctuation">(</span>md<span class="token operator">-&gt;</span>disk<span class="token operator">-&gt;</span>disk_name<span class="token punctuation">,</span> <span class="token string">"mmcblk%d"</span><span class="token punctuation">,</span> devidx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>md<span class="token operator">-&gt;</span>disk<span class="token operator">-&gt;</span>devfs_name<span class="token punctuation">,</span> <span class="token string">"mmc/blk%d"</span><span class="token punctuation">,</span> devidx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 
		md<span class="token operator">-&gt;</span>block_bits <span class="token operator">=</span> card<span class="token operator">-&gt;</span>csd<span class="token punctuation">.</span>read_blkbits<span class="token punctuation">;</span>
		<span class="token comment">//为请求队列设置硬件扇区大小</span>
		<span class="token function">blk_queue_hardsect_size</span><span class="token punctuation">(</span>md<span class="token operator">-&gt;</span>queue<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> md<span class="token operator">-&gt;</span>block_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">set_capacity</span><span class="token punctuation">(</span>md<span class="token operator">-&gt;</span>disk<span class="token punctuation">,</span> card<span class="token operator">-&gt;</span>csd<span class="token punctuation">.</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置卡的容量</span>
	<span class="token punctuation">}</span>
out<span class="token operator">:</span>
	<span class="token keyword">return</span> md<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="323_MMC_1496"></a>3.2.3. MMC卡请求的处理</h4> 
<p><img src="https://images2.imgbox.com/4c/91/pIiNaGk9_o.png" alt="在这里插入图片描述"></p> 
<p>函数mmc_init_queue初始化一个MMC卡请求队列结构，其中参数mq是mmc请求队列，参数card是加在这个队列里的mmc卡，参数lock是队列锁。函数mmc_init_queue调用层次图如上图。</p> 
<p>函数mmc_init_queue分析如下（在drivers/mmc/mmc_queue.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">mmc_init_queue</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> <span class="token operator">*</span>mq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span>card<span class="token punctuation">,</span>
<span class="token class-name">spinlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span>host <span class="token operator">=</span> card<span class="token operator">-&gt;</span>host<span class="token punctuation">;</span>
	u64 limit <span class="token operator">=</span> BLK_BOUNCE_HIGH<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>dev<span class="token operator">-&gt;</span>dma_mask <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>host<span class="token operator">-&gt;</span>dev<span class="token operator">-&gt;</span>dma_mask<span class="token punctuation">)</span>
		limit <span class="token operator">=</span> <span class="token operator">*</span>host<span class="token operator">-&gt;</span>dev<span class="token operator">-&gt;</span>dma_mask<span class="token punctuation">;</span>
	 
	mq<span class="token operator">-&gt;</span>card <span class="token operator">=</span> card<span class="token punctuation">;</span>
	<span class="token comment">//初始化块层的请求队列，请求合并策略，赋上请求处理函数mmc_request。</span>
	mq<span class="token operator">-&gt;</span>queue <span class="token operator">=</span> <span class="token function">blk_init_queue</span><span class="token punctuation">(</span>mmc_request<span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mq<span class="token operator">-&gt;</span>queue<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	<span class="token comment">//初始化请求队列的扇区及片断限制</span>
	<span class="token function">blk_queue_prep_rq</span><span class="token punctuation">(</span>mq<span class="token operator">-&gt;</span>queue<span class="token punctuation">,</span> mmc_prep_request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//赋上准备请求函数</span>
	<span class="token function">blk_queue_bounce_limit</span><span class="token punctuation">(</span>mq<span class="token operator">-&gt;</span>queue<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">blk_queue_max_sectors</span><span class="token punctuation">(</span>mq<span class="token operator">-&gt;</span>queue<span class="token punctuation">,</span> host<span class="token operator">-&gt;</span>max_sectors<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">blk_queue_max_phys_segments</span><span class="token punctuation">(</span>mq<span class="token operator">-&gt;</span>queue<span class="token punctuation">,</span> host<span class="token operator">-&gt;</span>max_phys_segs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">blk_queue_max_hw_segments</span><span class="token punctuation">(</span>mq<span class="token operator">-&gt;</span>queue<span class="token punctuation">,</span> host<span class="token operator">-&gt;</span>max_hw_segs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">blk_queue_max_segment_size</span><span class="token punctuation">(</span>mq<span class="token operator">-&gt;</span>queue<span class="token punctuation">,</span> host<span class="token operator">-&gt;</span>max_seg_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	mq<span class="token operator">-&gt;</span>queue<span class="token operator">-&gt;</span>queuedata <span class="token operator">=</span> mq<span class="token punctuation">;</span>
	mq<span class="token operator">-&gt;</span>req <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	 
	mq<span class="token operator">-&gt;</span>sg <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scatterlist</span><span class="token punctuation">)</span> <span class="token operator">*</span> host<span class="token operator">-&gt;</span>max_phys_segs<span class="token punctuation">,</span>
	GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mq<span class="token operator">-&gt;</span>sg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token function">init_completion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_complete<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_MUTEX</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token comment">//创建请求队列处理线程mmc_queue_thread</span>
	ret <span class="token operator">=</span> <span class="token function">kernel_thread</span><span class="token punctuation">(</span>mmc_queue_thread<span class="token punctuation">,</span> mq<span class="token punctuation">,</span> CLONE_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">wait_for_completion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_complete<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">init_completion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_complete<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	cleanup<span class="token operator">:</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>mq<span class="token operator">-&gt;</span>sg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mq<span class="token operator">-&gt;</span>sg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	 
	<span class="token function">blk_cleanup_queue</span><span class="token punctuation">(</span>mq<span class="token operator">-&gt;</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mmc_prep_request 在准备一个MMC请求时做一些状态转移及保护操作，函数列出如下（在drivers/mmc/ mmc_queue.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mmc_prep_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>q<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> <span class="token operator">*</span>mq <span class="token operator">=</span> q<span class="token operator">-&gt;</span>queuedata<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> BLKPREP_KILL<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> REQ_SPECIAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//在req-&gt;special 中已建立命令块，表示请求已准备好</span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token operator">-&gt;</span>special<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> BLKPREP_OK<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>REQ_CMD <span class="token operator">|</span> REQ_BLOCK_PC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//块I/O请求需要按照协议进行翻译</span>
		ret <span class="token operator">=</span> mq<span class="token operator">-&gt;</span><span class="token function">prep_fn</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//无效的请求</span>
		<span class="token function">blk_dump_rq_flags</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token string">"MMC bad request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> BLKPREP_OK<span class="token punctuation">)</span><span class="token comment">//请求已准备好，不需再准备了</span>
		req<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> REQ_DONTPREP<span class="token punctuation">;</span>
	 
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mmc_blk_prep_rq是准备请求时调用的函数，这里仅做了简单的保护处理，列出如下（在drivers/mmc/mmc_block.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mmc_blk_prep_rq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> <span class="token operator">*</span>mq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_blk_data</span> <span class="token operator">*</span>md <span class="token operator">=</span> mq<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
	<span class="token keyword">int</span> stat <span class="token operator">=</span> BLKPREP_OK<span class="token punctuation">;</span>
	<span class="token comment">//如果没有设备，没法完成初始化</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>md <span class="token operator">||</span> <span class="token operator">!</span>mq<span class="token operator">-&gt;</span>card<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: killing request - no device/host\n"</span><span class="token punctuation">,</span>
		req<span class="token operator">-&gt;</span>rq_disk<span class="token operator">-&gt;</span>disk_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		stat <span class="token operator">=</span> BLKPREP_KILL<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token keyword">return</span> stat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mmc_request是通用MMC请求处理函数，它唤醒请求队列处理线程。它在特定的主控制器上被任何请求队列调用。当主控制器不忙时，我们查找在这个主控制器上的任何一个队列中的请求，并且尝试发出这个请求进行处理。</p> 
<p>函数mmc_request分析如下（在driver/mmd/mmc_queue.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mmc_request</span><span class="token punctuation">(</span><span class="token class-name">request_queue_t</span> <span class="token operator">*</span>q<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> <span class="token operator">*</span>mq <span class="token operator">=</span> q<span class="token operator">-&gt;</span>queuedata<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mq<span class="token operator">-&gt;</span>req<span class="token punctuation">)</span><span class="token comment">//如果有请求，唤醒请求队列处理线程</span>
		<span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>线程函数mmc_queue_thread调用了具体设备的请求处理函数，利用线程机制来处理请求。函数mmc_queue_thread分析如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mmc_queue_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>d<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> <span class="token operator">*</span>mq <span class="token operator">=</span> d<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>q <span class="token operator">=</span> mq<span class="token operator">-&gt;</span>queue<span class="token punctuation">;</span>
	<span class="token function">DECLARE_WAITQUEUE</span><span class="token punctuation">(</span>wait<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//声明一个当前进程的等待队列</span>
	 
	<span class="token comment">//设置当前进程状态，来让线程自己来处理挂起</span>
	current<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> PF_MEMALLOC<span class="token operator">|</span>PF_NOFREEZE<span class="token punctuation">;</span>
	<span class="token comment">//让线程继承init进程，从而不会使用用户进程资源</span>
	<span class="token function">daemonize</span><span class="token punctuation">(</span><span class="token string">"mmcqd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">complete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_complete<span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//设置线程完成时的回调函数</span>
	 
	<span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">add_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//加线程到等待队列</span>
	<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		 
		<span class="token function">spin_lock_irq</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_INTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">blk_queue_plugged</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span>　<span class="token comment">//如果队列是非堵塞状态，得到下一个请求</span>
			mq<span class="token operator">-&gt;</span>req <span class="token operator">=</span> req <span class="token operator">=</span> <span class="token function">elv_next_request</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">spin_unlock_irq</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>queue_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果请求为空</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mq<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> MMC_QUEUE_EXIT<span class="token punctuation">)</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//这里调用了mmc_blk_issue_rq开始处理请求</span>
		mq<span class="token operator">-&gt;</span><span class="token function">issue_fn</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">remove_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//调用请求处理完后的回调函数</span>
	<span class="token function">complete_and_exit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mq<span class="token operator">-&gt;</span>thread_complete<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mmc_blk_issue_rq初始化MMC块请求结构后，向卡发出请求命令，并等待请求的完成，函数分析如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mmc_blk_issue_rq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_queue</span> <span class="token operator">*</span>mq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_blk_data</span> <span class="token operator">*</span>md <span class="token operator">=</span> mq<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span>card <span class="token operator">=</span> md<span class="token operator">-&gt;</span>queue<span class="token punctuation">.</span>card<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token comment">//认领控制器，发命令到卡设置card为选中状态</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mmc_card_claim_host</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> cmd_err<span class="token punctuation">;</span>
	 
	<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">mmc_blk_request</span> brq<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">mmc_command</span> cmd<span class="token punctuation">;</span>
		<span class="token comment">//初始化MMC块请求结构</span>
		<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>brq<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_blk_request</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>mrq<span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token operator">&amp;</span>brq<span class="token punctuation">.</span>cmd<span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>mrq<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token operator">&amp;</span>brq<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
		 
		brq<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>arg <span class="token operator">=</span> req<span class="token operator">-&gt;</span>sector <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>flags <span class="token operator">=</span> MMC_RSP_R1<span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>timeout_ns <span class="token operator">=</span> card<span class="token operator">-&gt;</span>csd<span class="token punctuation">.</span>tacc_ns <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>timeout_clks <span class="token operator">=</span> card<span class="token operator">-&gt;</span>csd<span class="token punctuation">.</span>tacc_clks <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>blksz_bits <span class="token operator">=</span> md<span class="token operator">-&gt;</span>block_bits<span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>blocks <span class="token operator">=</span> req<span class="token operator">-&gt;</span>nr_sectors <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>md<span class="token operator">-&gt;</span>block_bits <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>stop<span class="token punctuation">.</span>opcode <span class="token operator">=</span> MMC_STOP_TRANSMISSION<span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>stop<span class="token punctuation">.</span>arg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>stop<span class="token punctuation">.</span>flags <span class="token operator">=</span> MMC_RSP_R1B<span class="token punctuation">;</span>
		 
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rq_data_dir</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">==</span> READ<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//读请求</span>
			brq<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>opcode <span class="token operator">=</span> brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>blocks <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> MMC_READ_MULTIPLE_BLOCK <span class="token operator">:</span> MMC_READ_SINGLE_BLOCK<span class="token punctuation">;</span>
			brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flags <span class="token operator">|=</span> MMC_DATA_READ<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//写</span>
			brq<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>opcode <span class="token operator">=</span> MMC_WRITE_BLOCK<span class="token punctuation">;</span>
			brq<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>flags <span class="token operator">=</span> MMC_RSP_R1B<span class="token punctuation">;</span>
			brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flags <span class="token operator">|=</span> MMC_DATA_WRITE<span class="token punctuation">;</span>
			brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>blocks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		brq<span class="token punctuation">.</span>mrq<span class="token punctuation">.</span>stop <span class="token operator">=</span> brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>blocks <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token operator">&amp;</span>brq<span class="token punctuation">.</span>stop <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		 
		brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sg <span class="token operator">=</span> mq<span class="token operator">-&gt;</span>sg<span class="token punctuation">;</span>
		brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sg_len <span class="token operator">=</span> <span class="token function">blk_rq_map_sg</span><span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>q<span class="token punctuation">,</span> req<span class="token punctuation">,</span> brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//等待请求完成</span>
		<span class="token function">mmc_wait_for_req</span><span class="token punctuation">(</span>card<span class="token operator">-&gt;</span>host<span class="token punctuation">,</span> <span class="token operator">&amp;</span>brq<span class="token punctuation">.</span>mrq<span class="token punctuation">)</span><span class="token punctuation">;</span>
		……
		<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> err<span class="token punctuation">;</span>
			 
			cmd<span class="token punctuation">.</span>opcode <span class="token operator">=</span> MMC_SEND_STATUS<span class="token punctuation">;</span>
			cmd<span class="token punctuation">.</span>arg <span class="token operator">=</span> card<span class="token operator">-&gt;</span>rca <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
			cmd<span class="token punctuation">.</span>flags <span class="token operator">=</span> MMC_RSP_R1<span class="token punctuation">;</span>
			err <span class="token operator">=</span> <span class="token function">mmc_wait_for_cmd</span><span class="token punctuation">(</span>card<span class="token operator">-&gt;</span>host<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"%s: error %d requesting status\n"</span><span class="token punctuation">,</span>
				req<span class="token operator">-&gt;</span>rq_disk<span class="token operator">-&gt;</span>disk_name<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">goto</span> cmd_err<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>resp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> R1_READY_FOR_DATA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 
		<span class="token comment">//一个块被成功传输</span>
		<span class="token function">spin_lock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>md<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token function">end_that_request_chunk</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> brq<span class="token punctuation">.</span>data<span class="token punctuation">.</span>bytes_xfered<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//整个请求完全成功完成			 </span>
			<span class="token function">add_disk_randomness</span><span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>rq_disk<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">blkdev_dequeue_request</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从队列中删除请求</span>
			<span class="token function">end_that_request_last</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写一些更新信息</span>
		<span class="token punctuation">}</span>
		<span class="token function">spin_unlock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>md<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">mmc_card_release_host</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	 
	cmd_err<span class="token operator">:</span>
	<span class="token function">mmc_card_release_host</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">spin_lock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>md<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//结束请求req上的I/O，操作成功时返回0</span>
		ret <span class="token operator">=</span> <span class="token function">end_that_request_chunk</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
		req<span class="token operator">-&gt;</span>current_nr_sectors <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">add_disk_randomness</span><span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>rq_disk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">blkdev_dequeue_request</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">end_that_request_last</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>md<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mmc_card_claim_host发出命令选择这个卡card，函数列出如下（在 include/linuc/mmc/card.h中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">mmc_card_claim_host</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span>card<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">__mmc_claim_host</span><span class="token punctuation">(</span>card<span class="token operator">-&gt;</span>host<span class="token punctuation">,</span> card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数__mmc_claim_host专有地认领一个控制器，参数host是认领的mmc控制器，参数card是去认领控制器的卡。函数 __mmc_claim_host为一套操作认领一个控制器，如果card是被传递的一个有效的卡，并且它不是上次被选择的卡，那么在函数返回之前发出命 令选择这个卡card。</p> 
<p>函数__mmc_claim_host分析如下（在drivers/mmc/mmc.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">__mmc_claim_host</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_card</span> <span class="token operator">*</span>card<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DECLARE_WAITQUEUE</span><span class="token punctuation">(</span>wait<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//给当前进程声明一个等待队列</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	 
	<span class="token function">add_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加host-&gt;wq到等待队列中</span>
	<span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_UNINTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置当前进程不可中断状态</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>card_busy <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>　<span class="token comment">//如果没有忙的卡，跳出循环</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//如果有忙的卡，去调度执行</span>
		<span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置当前进程为运行状态</span>
	host<span class="token operator">-&gt;</span>card_busy <span class="token operator">=</span> card<span class="token punctuation">;</span>　<span class="token comment">//指定当前忙的卡</span>
	<span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">remove_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//从等待队列中移去host-&gt;wq</span>
	<span class="token comment">//如果卡不是选择状态，发出命令到卡设置为选择状态</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>card <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> host<span class="token operator">-&gt;</span>card_selected <span class="token operator">!=</span> card<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">mmc_command</span> cmd<span class="token punctuation">;</span>
		 
		host<span class="token operator">-&gt;</span>card_selected <span class="token operator">=</span> card<span class="token punctuation">;</span>
		 
		cmd<span class="token punctuation">.</span>opcode <span class="token operator">=</span> MMC_SELECT_CARD<span class="token punctuation">;</span>
		cmd<span class="token punctuation">.</span>arg <span class="token operator">=</span> card<span class="token operator">-&gt;</span>rca <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
		cmd<span class="token punctuation">.</span>flags <span class="token operator">=</span> MMC_RSP_R1<span class="token punctuation">;</span>
		<span class="token comment">//等待命令完成</span>
		err <span class="token operator">=</span> <span class="token function">mmc_wait_for_cmd</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmd<span class="token punctuation">,</span> CMD_RETRIES<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mmc_wait_for_req开始执行一个请求并等待请求完成，函数分析如下（在drivers/mmc/mmc.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">mmc_wait_for_req</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_request</span> <span class="token operator">*</span>mrq<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DECLARE_COMPLETION</span><span class="token punctuation">(</span>complete<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	mrq<span class="token operator">-&gt;</span>done_data <span class="token operator">=</span> <span class="token operator">&amp;</span>complete<span class="token punctuation">;</span>
	mrq<span class="token operator">-&gt;</span>done <span class="token operator">=</span> mmc_wait_done<span class="token punctuation">;</span>
	 
	<span class="token function">mmc_start_request</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> mrq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">wait_for_completion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>complete<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mmc_start_request开始排队执行一个在控制器上的命令，参数host是执行命令的控制器，参数mrq是将要开始执行的请求。调用者应持有锁并且关中断。</p> 
<p>函数mmc_start_request分析如下（在drivers/mmc/mmc.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">mmc_start_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_request</span> <span class="token operator">*</span>mrq<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DBG</span><span class="token punctuation">(</span><span class="token string">"MMC: starting cmd %02x arg %08x flags %08x\n"</span><span class="token punctuation">,</span>
	mrq<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>opcode<span class="token punctuation">,</span> mrq<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>arg<span class="token punctuation">,</span> mrq<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">WARN_ON</span><span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>card_busy <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	mrq<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	mrq<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>mrq <span class="token operator">=</span> mrq<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mrq<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		mrq<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>data <span class="token operator">=</span> mrq<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
		mrq<span class="token operator">-&gt;</span>data<span class="token operator">-&gt;</span>error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		mrq<span class="token operator">-&gt;</span>data<span class="token operator">-&gt;</span>mrq <span class="token operator">=</span> mrq<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mrq<span class="token operator">-&gt;</span>stop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mrq<span class="token operator">-&gt;</span>data<span class="token operator">-&gt;</span>stop <span class="token operator">=</span> mrq<span class="token operator">-&gt;</span>stop<span class="token punctuation">;</span>
			mrq<span class="token operator">-&gt;</span>stop<span class="token operator">-&gt;</span>error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			mrq<span class="token operator">-&gt;</span>stop<span class="token operator">-&gt;</span>mrq <span class="token operator">=</span> mrq<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//调用请求处理函数，对于amba主控制器来说就是mmci_request函数</span>
	host<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span><span class="token function">request</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> mrq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="33_MMC_1859"></a>3.3. 具体MMC控制器驱动程序示例</h3> 
<p>下面以amba控制器为例分析MMC卡驱动程序。amba控制器是集成在ARM处理器中的MMC卡控制器。</p> 
<h4><a id="331_amba_1862"></a>3.3.1. amba控制器驱动程序相关结构</h4> 
<p>amba控制器驱动程序相关结构在include/asm-arm/hardware/amba.h中，分别说明如下：</p> 
<p>结构amba_device 是amba控制器设备结构，它在通用设备结构的基础上封装了amba控制器选定的信息数据，列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">amba_device</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span>		dev<span class="token punctuation">;</span>　<span class="token comment">//通用设备结构</span>
	<span class="token keyword">struct</span> <span class="token class-name">resource</span>		res<span class="token punctuation">;</span>　<span class="token comment">//设备资源结构</span>
	u64			dma_mask<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		periphid<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		irq<span class="token punctuation">[</span>AMBA_NR_IRQS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">struct</span> <span class="token class-name">amba_id</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		id<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		mask<span class="token punctuation">;</span>
	<span class="token keyword">void</span>			<span class="token operator">*</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结构amba_driver是amba控制器驱动程序描述结构，列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">amba_driver</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">device_driver</span>	drv<span class="token punctuation">;</span>　<span class="token comment">//通用驱动程序结构</span>
	<span class="token keyword">int</span>			<span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">amba_device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span>			<span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">amba_device</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span>		<span class="token punctuation">(</span><span class="token operator">*</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">amba_device</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span>			<span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">amba_device</span> <span class="token operator">*</span><span class="token punctuation">,</span> u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span>			<span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">amba_device</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">amba_id</span>		<span class="token operator">*</span>id_table<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>amba控制器的描述结构封装了MMC通用的主控制器结构、MMC请求结构、MMC命令结构、MMC数据结构等，</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmci_host</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//下面mmc_*结构是MMC设备抽象层的各种设备结构</span>
	<span class="token keyword">void</span> __iomem		<span class="token operator">*</span>base<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_request</span>	<span class="token operator">*</span>mrq<span class="token punctuation">;</span>　　<span class="token comment">//MMC读写请求</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_command</span>	<span class="token operator">*</span>cmd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_data</span>		<span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_host</span>		<span class="token operator">*</span>mmc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">clk</span>		<span class="token operator">*</span>clk<span class="token punctuation">;</span>
	 
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		data_xfered<span class="token punctuation">;</span>
	 
	<span class="token class-name">spinlock_t</span>		lock<span class="token punctuation">;</span>
	 
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		mclk<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		cclk<span class="token punctuation">;</span>
	u32			pwr<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_platform_data</span> <span class="token operator">*</span>plat<span class="token punctuation">;</span>　<span class="token comment">//平台中与MMC相关的数据</span>
	 
	<span class="token keyword">struct</span> <span class="token class-name">timer_list</span>	timer<span class="token punctuation">;</span>　<span class="token comment">//定时器</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		oldstat<span class="token punctuation">;</span>
	 
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		sg_len<span class="token punctuation">;</span>
	 
	<span class="token comment">/* pio stuff */</span>
	<span class="token keyword">struct</span> <span class="token class-name">scatterlist</span>	<span class="token operator">*</span>sg_ptr<span class="token punctuation">;</span>　<span class="token comment">//碎片链表指针</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		sg_off<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="332_amba_1931"></a>3.3.2. amba控制器的初始化</h4> 
<p>函数mmci_init 是amba控制器的初始化，它注册了amba控制器驱动程序结构mmci_driver。</p> 
<p>amba控制器驱动程序的初始化函数和模块清除函数分别列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">mmci_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">amba_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mmci_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">mmci_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">amba_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mmci_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>amba控制器驱动程序结构实例mmci_driver列出如下：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DRIVER_NAME</span> <span class="token string">"mmci-pl18x"</span></span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">amba_driver</span> mmci_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>drv		<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>name	<span class="token operator">=</span> DRIVER_NAME<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe		<span class="token operator">=</span> mmci_probe<span class="token punctuation">,</span>　　<span class="token comment">//设备探测及初始化函数</span>
	<span class="token punctuation">.</span>remove		<span class="token operator">=</span> mmci_remove<span class="token punctuation">,</span>　<span class="token comment">//移去设备处理函数</span>
	<span class="token punctuation">.</span>suspend	<span class="token operator">=</span> mmci_suspend<span class="token punctuation">,</span>　<span class="token comment">//电源挂起函数</span>
	<span class="token punctuation">.</span>resume		<span class="token operator">=</span> mmci_resume<span class="token punctuation">,</span>　<span class="token comment">//电源恢复函数</span>
	<span class="token punctuation">.</span>id_table	<span class="token operator">=</span> mmci_ids<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="333_mmci_probe_1964"></a>3.3.3. 设备探测函数mmci_probe</h4> 
<p>函数mmci_probe探测设备并初始化设备，它的工作包括：申请设备I/O内存并进行I/O映射，初始化控制器结构，激活设备时钟，申请中断，检测MMC卡，设置设备定时状态检测函数等。</p> 
<p>函数mmci_probe分析如下（在drivers/mmc/mmci.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mmci_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">amba_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>id<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_platform_data</span> <span class="token operator">*</span>plat <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>platform_data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmci_host</span> <span class="token operator">*</span>host<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span>mmc<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	 
	<span class="token comment">/* must have platform data */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plat<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//申请所有与设备相关的I/O内存区域。</span>
	ret <span class="token operator">=</span> <span class="token function">amba_request_regions</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> DRIVER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	 
	<span class="token comment">//分配并初始化主控制器结构mmc_host。</span>
	mmc <span class="token operator">=</span> <span class="token function">mmc_alloc_host</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmci_host</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mmc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> rel_regions<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token comment">// 得到mmc对应有mmci结构，即host = ?void *)</span>
	host <span class="token operator">=</span> <span class="token function">mmc_priv</span><span class="token punctuation">(</span>mmc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//得到名为“MCLK”的时钟结构，它描述了一个硬件时钟的信息</span>
	host<span class="token operator">-&gt;</span>clk <span class="token operator">=</span> <span class="token function">clk_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"MCLK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
		host<span class="token operator">-&gt;</span>clk <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> host_free<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//时钟是否使用</span>
	ret <span class="token operator">=</span> <span class="token function">clk_use</span><span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> clk_free<span class="token punctuation">;</span>
	<span class="token comment">//激活时钟</span>
	ret <span class="token operator">=</span> <span class="token function">clk_enable</span><span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> clk_unuse<span class="token punctuation">;</span>
	 
	host<span class="token operator">-&gt;</span>plat <span class="token operator">=</span> plat<span class="token punctuation">;</span>
	host<span class="token operator">-&gt;</span>mclk <span class="token operator">=</span> <span class="token function">clk_get_rate</span><span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到时钟频率</span>
	host<span class="token operator">-&gt;</span>mmc <span class="token operator">=</span> mmc<span class="token punctuation">;</span>
	host<span class="token operator">-&gt;</span>base <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>res<span class="token punctuation">.</span>start<span class="token punctuation">,</span> SZ_4K<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//I/O映射的虚拟地址</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>host<span class="token operator">-&gt;</span>base<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> clk_disable<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token comment">//具体设备的控制器操作函数</span>
	mmc<span class="token operator">-&gt;</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>mmci_ops<span class="token punctuation">;</span>
	mmc<span class="token operator">-&gt;</span>f_min <span class="token operator">=</span> <span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>mclk <span class="token operator">+</span> <span class="token number">511</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">512</span><span class="token punctuation">;</span>
	mmc<span class="token operator">-&gt;</span>f_max <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>mclk<span class="token punctuation">,</span> fmax<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mmc<span class="token operator">-&gt;</span>ocr_avail <span class="token operator">=</span> plat<span class="token operator">-&gt;</span>ocr_mask<span class="token punctuation">;</span>
	 
	<span class="token comment">/*
	* We can do SGIO
	*/</span>
	mmc<span class="token operator">-&gt;</span>max_hw_segs <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
	mmc<span class="token operator">-&gt;</span>max_phys_segs <span class="token operator">=</span> NR_SG<span class="token punctuation">;</span><span class="token comment">//定义为16</span>
	 
	<span class="token comment">//因为仅有一个16位数据长度寄存器，我们必须保证一个请求中不能超过 -1。</span>
	<span class="token comment">//选择64（512字节）扇区作为限制。</span>
	mmc<span class="token operator">-&gt;</span>max_sectors <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
	 
	<span class="token comment">//设置最大片断尺寸，因为不做DMA，仅受限制于数据长度寄存器*</span>
	mmc<span class="token operator">-&gt;</span>max_seg_size <span class="token operator">=</span> mmc<span class="token operator">-&gt;</span>max_sectors <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>
	 
	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//写寄存器</span>
	<span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> host<span class="token operator">-&gt;</span>base <span class="token operator">+</span> MMCIMASK0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> host<span class="token operator">-&gt;</span>base <span class="token operator">+</span> MMCIMASK1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0xfff</span><span class="token punctuation">,</span> host<span class="token operator">-&gt;</span>base <span class="token operator">+</span> MMCICLEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//分配共享中断，中断函数是mmci_irq处理命令及传输数据传输完成时的中断处理函数，中断号是dev-&gt;irq[0]。</span>
	ret <span class="token operator">=</span> <span class="token function">request_irq</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mmci_irq<span class="token punctuation">,</span> SA_SHIRQ<span class="token punctuation">,</span>
	DRIVER_NAME <span class="token string">" (cmd)"</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> unmap<span class="token punctuation">;</span>
	<span class="token comment">//中断mmci_pio_irq是PIO数据传输的中断处理函数</span>
	ret <span class="token operator">=</span> <span class="token function">request_irq</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mmci_pio_irq<span class="token punctuation">,</span> SA_SHIRQ<span class="token punctuation">,</span>
	DRIVER_NAME <span class="token string">" (pio)"</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> irq0_free<span class="token punctuation">;</span>
	<span class="token comment">//将中断使能写入寄存器</span>
	<span class="token function">writel</span><span class="token punctuation">(</span>MCI_IRQENABLE<span class="token punctuation">,</span> host<span class="token operator">-&gt;</span>base <span class="token operator">+</span> MMCIMASK0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token comment">//设置dev-&gt;driver_data = mmc。</span>
	<span class="token function">amba_set_drvdata</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> mmc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化主控制器硬件，关控制器电源，检测控制器插槽有否卡。</span>
	<span class="token function">mmc_add_host</span><span class="token punctuation">(</span>mmc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"%s: MMCI rev %x cfg %02x at 0x%08lx irq %d,%d\n"</span><span class="token punctuation">,</span>
	mmc<span class="token operator">-&gt;</span>host_name<span class="token punctuation">,</span> <span class="token function">amba_rev</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">amba_config</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span>
	dev<span class="token operator">-&gt;</span>res<span class="token punctuation">.</span>start<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化定义器</span>
	<span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	host<span class="token operator">-&gt;</span>timer<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>host<span class="token punctuation">;</span>
	host<span class="token operator">-&gt;</span>timer<span class="token punctuation">.</span>function <span class="token operator">=</span> mmci_check_status<span class="token punctuation">;</span><span class="token comment">//设置定时函数为检测状态函数</span>
	host<span class="token operator">-&gt;</span>timer<span class="token punctuation">.</span>expires <span class="token operator">=</span> jiffies <span class="token operator">+</span> HZ<span class="token punctuation">;</span>
	<span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	……
<span class="token punctuation">}</span>
</code></pre> 
<p>函数amba_request_regions申请所有与设备相关的I/O内存区域。其参数dev是设备结构amba_device，参数name若为NULL，表示是驱动程序名字。</p> 
<p>函数amba_request_regions分析如下（在arch/arm/commom/amba.c中）：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">amba_request_regions</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">amba_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span><span class="token comment">//如果为NULL，表示是设备驱动程序的名字。</span>
		name <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>driver<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span>
	<span class="token comment">//填写资源结构，I/O空间大小为SZ_4K，并分析是否在</span>
	<span class="token comment">//全局资源结构iomem_resource所控制的地址范围内，将资源加到资源树中。</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">request_mem_region</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>res<span class="token punctuation">.</span>start<span class="token punctuation">,</span> SZ_4K<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
	 
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数mmc_alloc_host 分配并初始化主控制器结构mmc_host。其参数extra是私有数据结构的大小，参数dev是主控制器设备模型结构的指针。</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span><span class="token function">mmc_alloc_host</span><span class="token punctuation">(</span><span class="token keyword">int</span> extra<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span>host<span class="token punctuation">;</span>
	<span class="token comment">//分配结构对象空间</span>
	host <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span><span class="token punctuation">)</span> <span class="token operator">+</span> extra<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">memset</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span><span class="token punctuation">)</span> <span class="token operator">+</span> extra<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清0</span>
		 
		<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化等待队列</span>
		<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>cards<span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//初始化链表</span>
		<span class="token comment">//设置工作的函数及定时器，函数是(&amp;host-&gt;detect)-&gt; mmc_rescan(host)</span>
		<span class="token function">INIT_WORK</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>detect<span class="token punctuation">,</span> mmc_rescan<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 
		host<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
		 
		<span class="token comment">//缺省时不支持SGIO（多个片断）或大请求，</span>
		<span class="token comment">//如需支持必须按控制器的能力设备下面的参数。</span>
		host<span class="token operator">-&gt;</span>max_hw_segs <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		host<span class="token operator">-&gt;</span>max_phys_segs <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token comment">//计数每页的扇区数=页大小/512</span>
		host<span class="token operator">-&gt;</span>max_sectors <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>PAGE_CACHE_SHIFT <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		host<span class="token operator">-&gt;</span>max_seg_size <span class="token operator">=</span> PAGE_CACHE_SIZE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	 
	<span class="token keyword">return</span> host<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="334_amba_2130"></a>3.3.4. amba控制器操作函数</h4> 
<p>amba控制器操作函数集实例列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_host_ops</span> mmci_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>request	<span class="token operator">=</span> mmci_request<span class="token punctuation">,</span>　<span class="token comment">//amba控制器请求处理函数</span>
	<span class="token punctuation">.</span>set_ios	<span class="token operator">=</span> mmci_set_ios<span class="token punctuation">,</span>　<span class="token comment">//控制设备状态，将控制值写入设备寄存器。</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数mmci_request把在MMC抽象设备层封装好的MMC协议命令写入具体的amba控制器完成MMC卡的读写操作。</p> 
<p>函数mmci_request列出如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mmci_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mmc_host</span> <span class="token operator">*</span>mmc<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mmc_request</span> <span class="token operator">*</span>mrq<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">mmci_host</span> <span class="token operator">*</span>host <span class="token operator">=</span> <span class="token function">mmc_priv</span><span class="token punctuation">(</span>mmc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">WARN_ON</span><span class="token punctuation">(</span>host<span class="token operator">-&gt;</span>mrq <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">spin_lock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	host<span class="token operator">-&gt;</span>mrq <span class="token operator">=</span> mrq<span class="token punctuation">;</span>
	 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mrq<span class="token operator">-&gt;</span>data <span class="token operator">&amp;&amp;</span> mrq<span class="token operator">-&gt;</span>data<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> MMC_DATA_READ<span class="token punctuation">)</span>
		<span class="token function">mmci_start_data</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> mrq<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//开始执行命令，即向寄存器写入操作指令来执行读写操作。</span>
	<span class="token function">mmci_start_command</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> mrq<span class="token operator">-&gt;</span>cmd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">spin_unlock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6e71a1d7a1fecdf5640e16fed3c9f131/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">零基础入门Jetson Nano——通过OpenCV调用CSI和USB摄像头</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/51a98669dad4b0da987cc223ec490739/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux centos screen命令基础用法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>