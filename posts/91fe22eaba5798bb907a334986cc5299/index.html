<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>尚硅谷智慧校园 —— 2、登录功能实现 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="尚硅谷智慧校园 —— 2、登录功能实现" />
<meta property="og:description" content="目录
1、登录的过程 2、验证码功能实现
3、登录校验功能实现
3.1、在 service 及其实现类添加登录验证方法
3.2、controller 方法
4、登录校验后从登录页跳转到首页
4.1、完成 service 方法及其实现类
4.2、完成 controller 方法
5、解决登录后用户头像错误问题
1、登录的过程 登录需要实现两个请求处理 第一次需要处理表单的内容，校验登录信息
第二次请求，会发送第一次请求的 token，需要处理这个 token，从而从登录页跳转到首页
2、验证码功能实现 在 SystemController 添加相应的方法
@RestController @RequestMapping(&#34;/sms/system&#34;) public class SystemController { @GetMapping(&#34;/getVerifiCodeImage&#34;) public void getVerifiCodeImage(HttpServletRequest request, HttpServletResponse response){ // 获取图片 BufferedImage verifiCodeImage = CreateVerifiCodeImage.getVerifiCodeImage(); // 获取图片上的验证码 char[] verifiCodeChars = CreateVerifiCodeImage.getVerifiCode(); String verifiCode = new String(verifiCodeChars); // 将验证码文本放入session域，为下一次验证做准备 HttpSession session = request.getSession(); session.setAttribute(&#34;verifiCode&#34;, verifiCode); try { // 将验证码图片响应给浏览器 ServletOutputStream outputStream = response." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/91fe22eaba5798bb907a334986cc5299/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-16T17:06:48+08:00" />
<meta property="article:modified_time" content="2022-11-16T17:06:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">尚硅谷智慧校园 —— 2、登录功能实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px;"></p> 
<p id="1%E3%80%81%E7%99%BB%E5%BD%95%E7%9A%84%E8%BF%87%E7%A8%8B%C2%A0-toc" style="margin-left:0px;"><a href="#1%E3%80%81%E7%99%BB%E5%BD%95%E7%9A%84%E8%BF%87%E7%A8%8B%C2%A0" rel="nofollow">1、登录的过程 </a></p> 
<p id="2%E3%80%81%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0-toc" style="margin-left:0px;"><a href="#2%E3%80%81%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0" rel="nofollow">2、验证码功能实现</a></p> 
<p id="3%E3%80%81%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0-toc" style="margin-left:0px;"><a href="#3%E3%80%81%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0" rel="nofollow">3、登录校验功能实现</a></p> 
<p id="3.1%E3%80%81%E5%9C%A8%20service%20%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E7%B1%BB%E6%B7%BB%E5%8A%A0%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E6%96%B9%E6%B3%95-toc" style="margin-left:40px;"><a href="#3.1%E3%80%81%E5%9C%A8%20service%20%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E7%B1%BB%E6%B7%BB%E5%8A%A0%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E6%96%B9%E6%B3%95" rel="nofollow">3.1、在 service 及其实现类添加登录验证方法</a></p> 
<p id="3.2%E3%80%81controller%20%E6%96%B9%E6%B3%95-toc" style="margin-left:40px;"><a href="#3.2%E3%80%81controller%20%E6%96%B9%E6%B3%95" rel="nofollow">3.2、controller 方法</a></p> 
<p id="4%E3%80%81%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E5%90%8E%E4%BB%8E%E7%99%BB%E5%BD%95%E9%A1%B5%E8%B7%B3%E8%BD%AC%E5%88%B0%E9%A6%96%E9%A1%B5-toc" style="margin-left:0px;"><a href="#4%E3%80%81%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E5%90%8E%E4%BB%8E%E7%99%BB%E5%BD%95%E9%A1%B5%E8%B7%B3%E8%BD%AC%E5%88%B0%E9%A6%96%E9%A1%B5" rel="nofollow">4、登录校验后从登录页跳转到首页</a></p> 
<p id="4.1%E3%80%81%E5%AE%8C%E6%88%90%20service%20%E6%96%B9%E6%B3%95%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E7%B1%BB-toc" style="margin-left:40px;"><a href="#4.1%E3%80%81%E5%AE%8C%E6%88%90%20service%20%E6%96%B9%E6%B3%95%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E7%B1%BB" rel="nofollow">4.1、完成 service 方法及其实现类</a></p> 
<p id="4.2%E3%80%81%E5%AE%8C%E6%88%90%20controller%20%E6%96%B9%E6%B3%95-toc" style="margin-left:40px;"><a href="#4.2%E3%80%81%E5%AE%8C%E6%88%90%20controller%20%E6%96%B9%E6%B3%95" rel="nofollow">4.2、完成 controller 方法</a></p> 
<p id="5%E3%80%81%E8%A7%A3%E5%86%B3%E7%99%BB%E5%BD%95%E5%90%8E%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F%E9%94%99%E8%AF%AF%E9%97%AE%E9%A2%98-toc" style="margin-left:0px;"><a href="#5%E3%80%81%E8%A7%A3%E5%86%B3%E7%99%BB%E5%BD%95%E5%90%8E%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F%E9%94%99%E8%AF%AF%E9%97%AE%E9%A2%98" rel="nofollow">5、解决登录后用户头像错误问题</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="1%E3%80%81%E7%99%BB%E5%BD%95%E7%9A%84%E8%BF%87%E7%A8%8B%C2%A0">1、登录的过程 </h2> 
<p>登录需要实现两个请求处理 </p> 
<p>第一次需要处理<a href="https://so.csdn.net/so/search?q=%E8%A1%A8%E5%8D%95&amp;spm=1001.2101.3001.7020" title="表单">表单</a>的内容，校验登录信息</p> 
<p>第二次请求，会发送第一次请求的 token，需要处理这个 token，从而从登录页跳转到首页</p> 
<h2 id="2%E3%80%81%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0">2、验证码功能实现</h2> 
<p>在 SystemController 添加相应的方法</p> 
<pre><code class="language-java">@RestController
@RequestMapping("/sms/system")
public class SystemController {
 
    @GetMapping("/getVerifiCodeImage")
    public void getVerifiCodeImage(HttpServletRequest request, HttpServletResponse response){
        // 获取图片
        BufferedImage verifiCodeImage = CreateVerifiCodeImage.getVerifiCodeImage();
 
        // 获取图片上的验证码
        char[] verifiCodeChars = CreateVerifiCodeImage.getVerifiCode();
        String verifiCode = new String(verifiCodeChars);
 
        // 将验证码文本放入session域，为下一次验证做准备
        HttpSession session = request.getSession();
        session.setAttribute("verifiCode", verifiCode);
 
        try {
            // 将验证码图片响应给浏览器
            ServletOutputStream outputStream = response.getOutputStream();
            // 将verifiCodeImage以JPEG的格式写到outputStream流中
            ImageIO.write(verifiCodeImage,"JPEG",outputStream);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
 
}</code></pre> 
<h2 id="3%E3%80%81%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0">3、登录校验功能实现</h2> 
<h3 id="3.1%E3%80%81%E5%9C%A8%20service%20%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E7%B1%BB%E6%B7%BB%E5%8A%A0%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E6%96%B9%E6%B3%95"><a name="t3"></a>3.1、在 service 及其实现类添加登录验证方法</h3> 
<p>AdminService</p> 
<pre><code class="language-java">public interface AdminService extends IService&lt;Admin&gt; {
 
    /**
     * 登录校验，查询提交的表单是否有此人
     * @param loginForm 登录页提交的表单
     * @return
     */
    Admin login(LoginForm loginForm);
 
}</code></pre> 
<p>AdminServiceImpl</p> 
<pre><code class="language-java">@Service("adminServiceImpl")
@Transactional
public class AdminServiceImpl extends ServiceImpl&lt;AdminMapper, Admin&gt; implements AdminService {
 
    /**
     * 登录验证，查询提交的表单是否有此人
     * @param loginForm 登录页提交的表单
     * @return
     */
    @Override
    public Admin login(LoginForm loginForm) {
        QueryWrapper&lt;Admin&gt; queryWrapper = new QueryWrapper&lt;&gt;();
        queryWrapper.eq("name",loginForm.getUsername())
                        // 注意将密码转为密文
                        .eq("password", MD5.encrypt(loginForm.getPassword()));
        Admin admin = baseMapper.selectOne(queryWrapper);
        return admin;
    }
 
}</code></pre> 
<blockquote> 
 <p>Student类和Teacher类代码与Admin相同</p> 
</blockquote> 
<h3 id="3.2%E3%80%81controller%20%E6%96%B9%E6%B3%95">3.2、controller 方法</h3> 
<p>SystemController </p> 
<pre><code class="language-java">@RestController
@RequestMapping("/sms/system")
public class SystemController {
 
    @Autowired
    private AdminService adminService;
 
    @Autowired
    private StudentService studentService;
 
    @Autowired
    private TeacherService teacherService;
 
    /**
     * 验证码功能的实现
     *
     * @param request
     * @param response
     */
    @GetMapping("/getVerifiCodeImage")
    public void getVerifiCodeImage(HttpServletRequest request, HttpServletResponse response) {
        // 获取图片
        BufferedImage verifiCodeImage = CreateVerifiCodeImage.getVerifiCodeImage();
 
        // 获取图片上的验证码
        char[] verifiCodeChars = CreateVerifiCodeImage.getVerifiCode();
        String verifiCode = new String(verifiCodeChars);
 
        // 将验证码文本放入session域，为下一次验证做准备
        HttpSession session = request.getSession();
        session.setAttribute("verifiCode", verifiCode);
 
        try {
            // 将验证码图片响应给浏览器
            ServletOutputStream outputStream = response.getOutputStream();
            // 将verifiCodeImage以JPEG的格式写到outputStream流中
            ImageIO.write(verifiCodeImage, "JPEG", outputStream);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
 
    /**
     * 登录验证，查询提交的表单是否有效
     * @param loginForm 登录页提交的表单
     * @param request
     * @return
     */
    @PostMapping("/login")
    public Result login(@RequestBody LoginForm loginForm, HttpServletRequest request) {
        // 验证码校验
        HttpSession session = request.getSession();
        String sessionVerifiCode = (String) session.getAttribute("verifiCode");
        String loginVerifiCode = loginForm.getVerifiCode();
        if ("".equals(sessionVerifiCode) || null == sessionVerifiCode) {
            return Result.fail().message("验证码失效，请刷新后重试");
        }
        if (!sessionVerifiCode.equalsIgnoreCase(loginVerifiCode)) {
            return Result.fail().message("验证码错误");
        }
 
        // 从session中移除现有验证码记录
        session.removeAttribute("verifiCode");
 
        // 对用户类型进行校验
        Map&lt;String, Object&gt; map = new LinkedHashMap&lt;&gt;();  // 用于存放响应的数据
        switch (loginForm.getUserType()) {
            case 1:
                try {
                    Admin admin = adminService.login(loginForm);
                    if (null != admin) {
                        // 在数据库找到该用户，将用户类型和用户id转换为密文，以token向客户端返回信息
                        map.put("token", JwtHelper.createToken(admin.getId().longValue(), 1));
                    } else {
                        throw new RuntimeException("用户名或密码错误");
                    }
                    // 若没有异常，说明可以登录，返回结果
                    return Result.ok(map);
                } catch (RuntimeException e) {
                    e.printStackTrace();
                    // 产生异常，返回出错信息
                    return Result.fail().message(e.getMessage());
                }
 
            case 2:
                try {
                    Student student = studentService.login(loginForm);
                    if (null != student) {
                        // 在数据库找到该用户，将用户类型和用户id转换为密文，以token向客户端返回信息
                        map.put("token", JwtHelper.createToken(student.getId().longValue(), 2));
                    } else {
                        throw new RuntimeException("用户名或密码错误");
                    }
                    // 若没有异常，说明可以登录，返回结果
                    return Result.ok(map);
                } catch (RuntimeException e) {
                    e.printStackTrace();
                    // 产生异常，返回出错信息
                    return Result.fail().message(e.getMessage());
                }
 
            case 3:
                try {
                    Teacher teacher = teacherService.login(loginForm);
                    if (null != teacher) {
                        // 在数据库找到该用户，将用户类型和用户id转换为密文，以token向客户端返回信息
                        map.put("token", JwtHelper.createToken(teacher.getId().longValue(), 3));
                    } else {
                        throw new RuntimeException("用户名或密码错误");
                    }
                    // 若没有异常，说明可以登录，返回结果
                    return Result.ok(map);
                } catch (RuntimeException e) {
                    e.printStackTrace();
                    // 产生异常，返回出错信息
                    return Result.fail().message(e.getMessage());
                }
        }
        return Result.fail().message("查无此用户");
    }
 
}</code></pre> 
<h2 id="4%E3%80%81%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E5%90%8E%E4%BB%8E%E7%99%BB%E5%BD%95%E9%A1%B5%E8%B7%B3%E8%BD%AC%E5%88%B0%E9%A6%96%E9%A1%B5">4、登录校验后从登录页跳转到首页</h2> 
<h3 id="4.1%E3%80%81%E5%AE%8C%E6%88%90%20service%20%E6%96%B9%E6%B3%95%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E7%B1%BB"><a name="t6"></a>4.1、完成 service 方法及其实现类</h3> 
<p>AdminService</p> 
<pre><code class="language-java">    /**
     * 根据用户id查找用户
     * @param userId
     * @return
     */
    Admin getAdminById(Long userId);</code></pre> 
<p>AdminServiceImpl</p> 
<pre><code class="language-java">    /**
     * 根据用户id查找用户
     * @param userId
     * @return
     */
    @Override
    public Admin getAdminById(Long userId) {
        Admin admin = baseMapper.selectById(userId);
        return admin;
    }</code></pre> 
<blockquote> 
 <p>Student类和Teacher类代码与Admin相同</p> 
</blockquote> 
<h3 id="4.2%E3%80%81%E5%AE%8C%E6%88%90%20controller%20%E6%96%B9%E6%B3%95">4.2、完成 controller 方法</h3> 
<p>根据请求参数 token 中的信息，传输用户信息给客户端 </p> 
<pre><code class="language-java">/**
     * 根据登录第二次请求发送来的token，传送用户信息回去
     * @param token
     * @return
     */
    @GetMapping("/getInfo")
    public Result getInfoByToken(@RequestHeader("token") String token){
        // 判断token是否过期
        boolean expiration = JwtHelper.isExpiration(token);
        if(expiration){
            // 过期，返回错误信息
            return Result.build(null, ResultCodeEnum.TOKEN_ERROR);
        }
        // token没有过期，解析出用户id和用户类型
        Long userId = JwtHelper.getUserId(token);
        Integer userType = JwtHelper.getUserType(token);
 
        // 向map中传入数据
        Map&lt;String, Object&gt; map = new LinkedHashMap&lt;&gt;();
        switch (userType){
            case 1:
                Admin admin = adminService.getAdminById(userId);
                map.put("userType", userType);
                map.put("user", admin);
                break;
            case 2:
                Student student = studentService.getStdentById(userId);
                map.put("userType", userType);
                map.put("user", student);
                break;
            case 3:
                Teacher teacher = teacherService.getTeacherById(userId);
                map.put("userType", userType);
                map.put("user", teacher);
                break;
        }
        return Result.ok(map);
    }</code></pre> 
<h2 id="5%E3%80%81%E8%A7%A3%E5%86%B3%E7%99%BB%E5%BD%95%E5%90%8E%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F%E9%94%99%E8%AF%AF%E9%97%AE%E9%A2%98">5、解决登录后用户头像错误问题</h2> 
<p>如下图，用户头像加载错误 </p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/9e/02/RX0op0NH_o.png"></p> 
<p> 通过控制台，可以很容易的发现该图片的存放地址，只需将图片放入对应的目录下即可 </p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/18/11/GTrWgvhb_o.png"></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/15721971a34f5377da426765d4224351/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">动态库加载失败：error while loading shared libraries: xxx.so: cannot open shared object file: No such file o</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/61fbc9ed2d599669a95563adda3badb5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">常用运算符</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>