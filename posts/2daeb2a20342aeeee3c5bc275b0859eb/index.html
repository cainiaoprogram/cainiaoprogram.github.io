<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot文件上传同时，接收复杂参数 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot文件上传同时，接收复杂参数" />
<meta property="og:description" content="目录
环境信息
问题描述
错误分析
解决方法
简单参数
总结
环境信息 Spring Boot：2.0.8.RELEASE
Spring Boot内置的tomcat：tomcat-embed-core 8.5.37
问题描述 收到文件上传的开发工作，要求能适配各种场景，并且各场景的请求参数不一样，因此接收的参数不能是固定的几个字段，要有类似Map的字段来接收动态参数。
拟使用MultipartFile[] files来接收文件列表，用自定义对象UploadFileDto来接收上传参数（里面包含一个Map）
UploadFileDto.java
@ApiModel(&#34;文件上传dto&#34;) @Data public class UploadFileDto { @ApiModelProperty(&#34;处理器，在Spring容器里的名称&#34;) private String handlerName; @ApiModelProperty(&#34;交易代码&#34;) private String bizCode; @ApiModelProperty(&#34;交易ID&#34;) private String bizId; @ApiModelProperty(&#34;上传配置名称，对应配置文件里的配置&#34;) private String uploadConfigName; @ApiModelProperty(&#34;动态信息&#34;) private Map&lt;String, Object&gt; dynamicDto; @ApiModelProperty(&#34;上传时间&#34;) private String uploadDt; @ApiModelProperty(&#34;限定文件大小&#34;) private long defaultFileSize; @ApiModelProperty(&#34;限定文件格式，多个用逗号隔开&#34;) private String defaultFileSuffix; @ApiModelProperty(&#34;默认路径之后的文件上级目录&#34;) private String parentDir; @ApiModelProperty(&#34;备注信息&#34;) private String remark; @ApiModelProperty(&#34;上传后的文件信息&#34;) private List&lt;FileInfoDto&gt; fileInfoDtos; } Controller:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2daeb2a20342aeeee3c5bc275b0859eb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-18T17:47:54+08:00" />
<meta property="article:modified_time" content="2022-12-18T17:47:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot文件上传同时，接收复杂参数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px;"></p> 
<p id="-toc" style="margin-left:0px;"><a href="#" rel="nofollow">环境信息</a></p> 
<p id="%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-toc" style="margin-left:0px;"><a href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0" rel="nofollow">问题描述</a></p> 
<p id="%E9%94%99%E8%AF%AF%E5%88%86%E6%9E%90-toc" style="margin-left:0px;"><a href="#%E9%94%99%E8%AF%AF%E5%88%86%E6%9E%90" rel="nofollow">错误分析</a></p> 
<p id="%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95-toc" style="margin-left:0px;"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95" rel="nofollow">解决方法</a></p> 
<p id="%E7%AE%80%E5%8D%95%E5%8F%82%E6%95%B0-toc" style="margin-left:0px;"><a href="#%E7%AE%80%E5%8D%95%E5%8F%82%E6%95%B0" rel="nofollow">简单参数</a></p> 
<p id="%E6%80%BB%E7%BB%93-toc" style="margin-left:0px;"><a href="#%E6%80%BB%E7%BB%93" rel="nofollow">总结</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2>环境信息</h2> 
<p>        Spring Boot：2.0.8.RELEASE</p> 
<p>        Spring Boot内置的tomcat：tomcat-<a href="https://so.csdn.net/so/search?q=embed&amp;spm=1001.2101.3001.7020" title="embed">embed</a>-core 8.5.37</p> 
<h2 id="%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><a name="t1"></a>问题描述</h2> 
<p>        收到文件上传的开发工作，要求能适配各种场景，并且各场景的请求参数不一样，因此接收的参数不能是固定的几个字段，要有类似Map的字段来接收动态参数。</p> 
<p>        拟使用MultipartFile[] files来接收文件列表，用<span style="color:#fe2c24;"><strong>自定义对象</strong></span>UploadFileDto来接收上传参数（里面包含一个Map）</p> 
<p>        UploadFileDto.java</p> 
<pre><code class="language-java">@ApiModel("文件上传dto")
@Data
public class UploadFileDto {
    @ApiModelProperty("处理器，在Spring容器里的名称")
    private String handlerName;

    @ApiModelProperty("交易代码")
    private String bizCode;

    @ApiModelProperty("交易ID")
    private String bizId;

    @ApiModelProperty("上传配置名称，对应配置文件里的配置")
    private String uploadConfigName;

    @ApiModelProperty("动态信息")
    private Map&lt;String, Object&gt; dynamicDto;

    @ApiModelProperty("上传时间")
    private String uploadDt;

    @ApiModelProperty("限定文件大小")
    private long defaultFileSize;

    @ApiModelProperty("限定文件格式，多个用逗号隔开")
    private String defaultFileSuffix;

    @ApiModelProperty("默认路径之后的文件上级目录")
    private String parentDir;

    @ApiModelProperty("备注信息")
    private String remark;

    @ApiModelProperty("上传后的文件信息")
    private List&lt;FileInfoDto&gt; fileInfoDtos;

}
</code></pre> 
<p>Controller:</p> 
<pre><code class="language-java">@RestController
@RequestMapping("/fileCommmon")
@Api(tags = "公共-文件操作")
public class FileUpDownLoadController extends BaseController {

    @Resource
    private UpDownLoadService upDownLoadService;

    @PostMapping(value = "/upload")
    @ApiOperation("文件上传")
    public ResponseDto&lt;UploadFileDto&gt; uploadFile(@RequestParam("files") MultipartFile[] files, @RequestPart() UploadFileDto uploadFileDto) {
        upDownLoadService.uploadFile(uploadFileDto, files);
        return getResponseDto(uploadFileDto);
    }
}
</code></pre> 
<p>Controller方法，使用@RequestParam("files") MultipartFile[] files来接收文件列表</p> 
<p>使用@RequestPart() UploadFileDto uploadFileDto来接收复杂参数。</p> 
<p>UpDownLoadService是上传实现类，这里暂时不暂时源码。</p> 
<p>可是，在访问该接口的时候，报错了：org.springframework.web.<span style="color:#fe2c24;">HttpMediaTypeNotSupportedException</span>: Content type 'application/octet-stream' not supported</p> 
<blockquote> 
 <p>org.springframework.web.HttpMediaTypeNotSupportedException: Content type 'application/octet-stream' not supported<br>     at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodArgumentResolver.readWithMessageConverters(AbstractMessageConverterMethodArgumentResolver.java:226)<br>     at org.springframework.web.servlet.mvc.method.annotation.RequestPartMethodArgumentResolver.resolveArgument(RequestPartMethodArgumentResolver.java:134)<br>     at org.springframework.web.method.support.HandlerMethodArgumentResolverComposite.resolveArgument(HandlerMethodArgumentResolverComposite.java:124)<br>     at org.springframework.web.method.support.InvocableHandlerMethod.getMethodArgumentValues(InvocableHandlerMethod.java:161)<br>     at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:131)<br>     at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:102)<br>     at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:891)<br>     at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:797)<br>     at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)<br>     at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:991)<br>     at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:925)<br>     at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:981)<br>     at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:884)<br>     at javax.servlet.http.HttpServlet.service(HttpServlet.java:661)<br>     at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:858)<br>     at javax.servlet.http.HttpServlet.service(HttpServlet.java:742)<br>     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)<br>     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)<br>     at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)<br>     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)<br>     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</p> 
</blockquote> 
<h2 id="%E9%94%99%E8%AF%AF%E5%88%86%E6%9E%90">错误分析</h2> 
<p>org.springframework.web.HttpMediaTypeNotSupportedException: Content type 'application/octet-stream' not supported，意思是应用不支持'application/octet-stream'这种文件类型</p> 
<p>Swagger2里的请求参数：</p> 
<p><img alt="" height="441" src="https://images2.imgbox.com/4a/c6/5qzJkf12_o.png" width="1200"></p> 
<p><img alt="" height="744" src="https://images2.imgbox.com/83/35/mKjzDeds_o.png" width="803"> <img alt="" height="160" src="https://images2.imgbox.com/c9/3d/6eRJlJ5P_o.png" width="901"></p> 
<p> 分析异常堆栈，是在AbstractMessageConverterMethodArgumentResolver的readWithMessageConverters方法里抛出的：</p> 
<p><img alt="" height="898" src="https://images2.imgbox.com/6a/2c/wuVep3wN_o.png" width="1200"><br>          分析这个方法里的代码，发现Spring在尝试使用各个消息转换器（HttpMessageConverter）来处理请求。这里的contentType值是'application/octet-stream'，发现找不到可用的消息转换器：</p> 
<p>genericConverter.canRead(targetType, contextClass, contentType) ，因此无法解析、转换消息，因此抛出了异常。</p> 
<p>         确切的说，上面说的是处理请求参数uploadFileDto，第一个请求参数files已经在下面这个地方处理了（文件类型参数使用MultipartResolutionDelegate.resolveMultipartArgument来处理）：</p> 
<p><img alt="" height="203" src="https://images2.imgbox.com/1d/63/ym47JLib_o.png" width="1200"></p> 
<p>注：</p> 
<p>messageConverters的值（这个看各个应用里注册的消息转换器类型、顺序）：</p> 
<p><img alt="" height="515" src="https://images2.imgbox.com/a2/c3/cgXs58Mx_o.png" width="575"></p> 
<p>经常使用的是<strong>MappingJackson2HttpMessageConverter</strong>消息转换器，这个是SpringBoot默认用来处理消息的，将原始请求转成json格式，再转成目标类型的格式，是Jackson</p> 
<p>targetClass是UploadFileDto对应的Class</p> 
<h2 id="%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95">解决方法</h2> 
<p>        明白了问题产生的原因之后，就有了解决思路：增加一个消息转换器，用于支持'application/octet-stream'。</p> 
<p>最简单的添加方式，新增一个类，继承<strong>AbstractJackson2HttpMessageConverter</strong>，这个也是上面说的MappingJackson2HttpMessageConverter的父类</p> 
<pre><code class="language-java">@Component
public class MultipartJackson2HttpMessageConverter extends AbstractJackson2HttpMessageConverter {

    /**
     * Converter for support http request with header Content-Type: multipart/form-data
     */
    public MultipartJackson2HttpMessageConverter(ObjectMapper objectMapper) {
        super(objectMapper, MediaType.APPLICATION_OCTET_STREAM);
    }

    @Override
    public boolean canWrite(Type type, Class&lt;?&gt; clazz, MediaType mediaType) {
        return false;
    }

    @Override
    public boolean canWrite(Class&lt;?&gt; clazz, MediaType mediaType) {
        return false;
    }

    @Override
    protected boolean canWrite(MediaType mediaType) {
        return false;
    }
}</code></pre> 
<p> 加了上面的转换器之后：</p> 
<p><img alt="" height="535" src="https://images2.imgbox.com/da/cb/YFg5aSzi_o.png" width="556"></p> 
<p> 读取之后的body类型就是UploadFileDto</p> 
<p><img alt="" height="727" src="https://images2.imgbox.com/a4/90/s9hA3cuH_o.png" width="1200"></p> 
<p> 至此，问题解决，后端程序能够正常接收、处理前端发过来的文件列表，以及复杂参数。</p> 
<h2 id="%E7%AE%80%E5%8D%95%E5%8F%82%E6%95%B0">简单参数</h2> 
<p>如果后端程序不需要接收复杂参数，而是只需要固定的几个简单参数，那么就很简单，比如：</p> 
<p>Controller：</p> 
<pre><code class="language-java">
    @PostMapping(value = "/upload2")
    @ApiOperation("文件上传2")
    public ResponseDto&lt;String&gt; uploadFile(@RequestParam("files") MultipartFile[] files,  @RequestPart() String remark) {
        System.out.println("remark = " + remark);
        upDownLoadService.uploadFile(remark, files);
        return getResponseDto(remark);
    }</code></pre> 
<p>此时，contentType值是'application/octet-stream'的String的参数，Spring有提供了默认的消息转换器<strong>StringHttpMessageConverter</strong>，支持所有的格式，就不需要自定义MappingJackson2HttpMessageConverter消息转换器了。</p> 
<p><img alt="" height="316" src="https://images2.imgbox.com/83/ea/KcN5xJls_o.png" width="1132"></p> 
<p></p> 
<p><img alt="" height="871" src="https://images2.imgbox.com/4c/64/Y37dDxhe_o.png" width="1200"></p> 
<p></p> 
<h2 id="%E6%80%BB%E7%BB%93">总结</h2> 
<p>回顾一下，如果需要复杂参数（自定义对象接收前端参数），那么需要自定义消息转换器（如AbstractJackson2HttpMessageConverter），来支持contentType值是'application/octet-stream'类型的参数，并将其转换成目标格式；</p> 
<p>如果不需要复杂参数，只是String等类型，那么不需要自定义消息转换器；</p> 
<p>消息转换器是SpringBoot处理前端传输的数据，并转换成接口参数的类型的转换器，转换前、转换后还支持自定义插件处理。详见AbstractMessageConverterMethodArgumentResolver的readWithMessageConverters</p> 
<p><img alt="" height="445" src="https://images2.imgbox.com/fd/04/tCp6zTdU_o.png" width="1200"></p> 
<p></p> 
<p>@RequestParam和@RequestPart的区别，可以自行查找资料</p> 
<p>参考：</p> 
<p> <a href="https://stackoverflow.com/questions/16230291/requestpart-with-mixed-multipart-request-spring-mvc-3-2/18503158" rel="nofollow" title="rest - @RequestPart with mixed multipart request, Spring MVC 3.2 - Stack Overflow">rest - @RequestPart with mixed multipart request, Spring MVC 3.2 - Stack Overflow</a></p> 
<p><a href="http://events.jianshu.io/p/e8c9f3968f41" rel="nofollow" title="@RequestPart同时接收文件和json后端报错 - 简书 (jianshu.io)">@RequestPart同时接收文件和json后端报错 - 简书 (jianshu.io)</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7ca81c10085797dfba29059d2fa41456/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python-OpenCV实现图片和视频相互转换的简单&#43;实用方法（附代码）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c97d72113ee2f05b36e6a0cf262c3a7a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【顺序程序】甲流疫情死亡率</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>