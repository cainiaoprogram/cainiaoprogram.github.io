<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mmdetection 中的 EpochBasedRunner - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mmdetection 中的 EpochBasedRunner" />
<meta property="og:description" content="EpochBasedRunner 阅读记录 这个类有很多方法，这里只记录当前我所用到的方法。
一、首先是实例化这个类的初始化方法： &#34;&#34;&#34; Args: model (:obj:`torch.nn.Module`): The model to be run. batch_processor (callable): A callable method that process a data batch. The interface of this method should be `batch_processor(model, data, train_mode) -&gt; dict` optimizer (dict or :obj:`torch.optim.Optimizer`): It can be either an optimizer (in most cases) or a dict of optimizers (in models that requires more than one optimizer, e.g., GAN). work_dir (str, optional): The working directory to save checkpoints and logs." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7c7a586a8733406d1b3baabd1541f309/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-09T15:30:37+08:00" />
<meta property="article:modified_time" content="2021-12-09T15:30:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mmdetection 中的 EpochBasedRunner</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="EpochBasedRunner__0"></a>EpochBasedRunner 阅读记录</h2> 
<p>这个类有很多方法，这里只记录当前我所用到的方法。</p> 
<h3><a id="_5"></a>一、首先是实例化这个类的初始化方法：</h3> 
<pre><code class="prism language-python">    <span class="token triple-quoted-string string">"""
    Args:
        model (:obj:`torch.nn.Module`): The model to be run.
        batch_processor (callable): A callable method that process a data
            batch. The interface of this method should be
            `batch_processor(model, data, train_mode) -&gt; dict`
        optimizer (dict or :obj:`torch.optim.Optimizer`): It can be either an
            optimizer (in most cases) or a dict of optimizers (in models that
            requires more than one optimizer, e.g., GAN).
        work_dir (str, optional): The working directory to save checkpoints
            and logs. Defaults to None.
        logger (:obj:`logging.Logger`): Logger used during training.
             Defaults to None. (The default value is just for backward
             compatibility)
        meta (dict | None): A dict records some import information such as
            environment info and seed, which will be logged in logger hook.
            Defaults to None.
        max_epochs (int, optional): Total training epochs.
        max_iters (int, optional): Total training iterations.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 model<span class="token punctuation">,</span>
                 batch_processor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 optimizer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 work_dir<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 logger<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 meta<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 max_iters<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 max_epochs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> batch_processor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">callable</span><span class="token punctuation">(</span>batch_processor<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'batch_processor must be callable, '</span>
                                <span class="token string-interpolation"><span class="token string">f'but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>batch_processor<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
            warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">'batch_processor is deprecated, please implement '</span>
                          <span class="token string">'train_step() and val_step() in the model instead.'</span><span class="token punctuation">)</span>
            <span class="token comment"># raise an error is `batch_processor` is not None and</span>
            <span class="token comment"># `model.train_step()` exists.</span>
            <span class="token keyword">if</span> is_module_wrapper<span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">:</span>
                _model <span class="token operator">=</span> model<span class="token punctuation">.</span>module
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                _model <span class="token operator">=</span> model
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>_model<span class="token punctuation">,</span> <span class="token string">'train_step'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>_model<span class="token punctuation">,</span> <span class="token string">'val_step'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span>
                    <span class="token string">'batch_processor and model.train_step()/model.val_step() '</span>
                    <span class="token string">'cannot be both available.'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token string">'train_step'</span><span class="token punctuation">)</span>

        <span class="token comment"># check the type of `optimizer`</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> name<span class="token punctuation">,</span> optim <span class="token keyword">in</span> optimizer<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>optim<span class="token punctuation">,</span> Optimizer<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span>
                        <span class="token string-interpolation"><span class="token string">f'optimizer must be a dict of torch.optim.Optimizers, '</span></span>
                        <span class="token string-interpolation"><span class="token string">f'but optimizer["</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string">"] is a </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>optim<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> Optimizer<span class="token punctuation">)</span> <span class="token keyword">and</span> optimizer <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f'optimizer must be a torch.optim.Optimizer object '</span></span>
                <span class="token string-interpolation"><span class="token string">f'or dict or None, but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>optimizer<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

        <span class="token comment"># check the type of `logger`</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> logging<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'logger must be a logging.Logger object, '</span></span>
                            <span class="token string-interpolation"><span class="token string">f'but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

        <span class="token comment"># check the type of `meta`</span>
        <span class="token keyword">if</span> meta <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f'meta must be a dict or None, but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>meta<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        self<span class="token punctuation">.</span>batch_processor <span class="token operator">=</span> batch_processor
        self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> optimizer
        self<span class="token punctuation">.</span>logger <span class="token operator">=</span> logger
        self<span class="token punctuation">.</span>meta <span class="token operator">=</span> meta
        <span class="token comment"># create work_dir</span>
        <span class="token keyword">if</span> mmcv<span class="token punctuation">.</span>is_str<span class="token punctuation">(</span>work_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>work_dir <span class="token operator">=</span> osp<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>work_dir<span class="token punctuation">)</span>
            mmcv<span class="token punctuation">.</span>mkdir_or_exist<span class="token punctuation">(</span>self<span class="token punctuation">.</span>work_dir<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> work_dir <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>work_dir <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'"work_dir" must be a str or None'</span><span class="token punctuation">)</span>

        <span class="token comment"># get model name from the model class</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> <span class="token string">'module'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_model_name <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>module<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_model_name <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__

        self<span class="token punctuation">.</span>_rank<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_world_size <span class="token operator">=</span> get_dist_info<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> get_time_str<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>_hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>_epoch <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>_iter <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>_inner_iter <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">if</span> max_epochs <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> max_iters <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>
                <span class="token string">'Only one of `max_epochs` or `max_iters` can be set.'</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_max_epochs <span class="token operator">=</span> max_epochs
        self<span class="token punctuation">.</span>_max_iters <span class="token operator">=</span> max_iters
        <span class="token comment"># TODO: Redesign LogBuffer, it is not flexible and elegant enough</span>
        self<span class="token punctuation">.</span>log_buffer <span class="token operator">=</span> LogBuffer<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>实例化BaseRunner所传入的参数见源码的注释部分，这里需要注意几个点：</p> 
<ol><li>model 中要有 train_step() 这个方法；</li><li>batch_processor 这个参数默认为 None ，本人使用过程在它也一直是 None ，这里暂时不考虑这个参数；</li><li>optimizer 这个参数是可以为字典的，也就是说 BaseRunner 允许使用多个优化器优化网络不同位置的参数；</li><li>max_epochs 和 max_iters 不能同时赋值，这两个参数我们给一个就行。</li></ol> 
<p>然后看一下初始化方法都做了哪些事：</p> 
<ol><li>检查传入的参数是否合法；</li><li>将相关参数保存在BaseRunner类的属性中；</li><li>创建工作目录以及获取设备的相关信息；</li><li>创建相关属性，用于记录训练过程中用到的一些参数。</li></ol> 
<h3><a id="Hook_131"></a>二、注册训练Hook</h3> 
<p>一般情况下，当我们实例化一个BaseRunner类以后，都要执行 register_training_hooks() 方法，这个方法会调用BaseRunner中注册Hook的7个方法。关于mmdetection中的Hook，大家可以自行百度，个人感觉他的工作机制类似于单片机中的中断。</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">register_training_hooks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                                lr_config<span class="token punctuation">,</span>
                                optimizer_config<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                                checkpoint_config<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                                log_config<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                                momentum_config<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                                timer_config<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'IterTimerHook'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                custom_hooks_config<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Register default and custom hooks for training.

        Default and custom hooks include:

        +----------------------+-------------------------+
        | Hooks                | Priority                |
        +======================+=========================+
        | LrUpdaterHook        | VERY_HIGH (10)          |
        +----------------------+-------------------------+
        | MomentumUpdaterHook  | HIGH (30)               |
        +----------------------+-------------------------+
        | OptimizerStepperHook | ABOVE_NORMAL (40)       |
        +----------------------+-------------------------+
        | CheckpointSaverHook  | NORMAL (50)             |
        +----------------------+-------------------------+
        | IterTimerHook        | LOW (70)                |
        +----------------------+-------------------------+
        | LoggerHook(s)        | VERY_LOW (90)           |
        +----------------------+-------------------------+
        | CustomHook(s)        | defaults to NORMAL (50) |
        +----------------------+-------------------------+

        If custom hooks have same priority with default hooks, custom hooks
        will be triggered after default hooks.
        """</span>
        self<span class="token punctuation">.</span>register_lr_hook<span class="token punctuation">(</span>lr_config<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>register_momentum_hook<span class="token punctuation">(</span>momentum_config<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>register_optimizer_hook<span class="token punctuation">(</span>optimizer_config<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>register_checkpoint_hook<span class="token punctuation">(</span>checkpoint_config<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>register_timer_hook<span class="token punctuation">(</span>timer_config<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>register_logger_hooks<span class="token punctuation">(</span>log_config<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>register_custom_hooks<span class="token punctuation">(</span>custom_hooks_config<span class="token punctuation">)</span>
</code></pre> 
<p>这里传入的参数都是配置文件中定义的字典，比如在 schedule_1x.py 文件中定义了：<br> lr_config = dict(policy=‘step’, warmup=‘linear’, warmup_iters=500, warmup_ratio=0.001, step=[16, 21])<br> 具体各个键值对的功能我们用到的时候再解释。</p> 
<p>下面分别介绍以下各个类型Hook的注册过程。</p> 
<h5><a id="1register_lr_hook_183"></a>1、register_lr_hook</h5> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">register_lr_hook</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lr_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> lr_config <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>lr_config<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token string">'policy'</span> <span class="token keyword">in</span> lr_config
            policy_type <span class="token operator">=</span> lr_config<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'policy'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> policy_type <span class="token operator">==</span> policy_type<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                policy_type <span class="token operator">=</span> policy_type<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span>
            hook_type <span class="token operator">=</span> policy_type <span class="token operator">+</span> <span class="token string">'LrUpdaterHook'</span>
            lr_config<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> hook_type
            hook <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>build_from_cfg<span class="token punctuation">(</span>lr_config<span class="token punctuation">,</span> HOOKS<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            hook <span class="token operator">=</span> lr_config
        self<span class="token punctuation">.</span>register_hook<span class="token punctuation">(</span>hook<span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token string">'VERY_HIGH'</span><span class="token punctuation">)</span>
</code></pre> 
<p>这个方法首先会判断传入的参数，如果没有传入参数，就不会注册管理 lr 的 Hook；如果是一个字典就根据字典中的信息注册一个 Hook (其实就是更加字典实例化一个相应的对象)，关于 mmcv.build_from_cfg 方法，请大家自己百度；如果传入了参数但是参数不是字典，就默认传入的是一个已经注册好的 Hook 。</p> 
<p>根据本人实验过程中传入的参数：lr_config = dict(policy=‘step’, warmup=‘linear’, warmup_iters=500, warmup_ratio=0.001, step=[16, 21])， 其实就是将字典中的items作为参数实例化一个名为 StepLrUpdaterHook 的对象， StepLrUpdaterHook 这个类的位置在mmcv/runner/hooks/lr_updater.py 中。</p> 
<p>最后调用了 self.register_hook 方法，将实注册的 Hook 保存到这个类的 _hooks 属性中，方便后面的使用。</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">register_hook</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> hook<span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token string">'NORMAL'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Register a hook into the hook list.

        The hook will be inserted into a priority queue, with the specified
        priority (See :class:`Priority` for details of priorities).
        For hooks with the same priority, they will be triggered in the same
        order as they are registered.

        Args:
            hook (:obj:`Hook`): The hook to be registered.
            priority (int or str or :obj:`Priority`): Hook priority.
                Lower value means higher priority.
        """</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>hook<span class="token punctuation">,</span> Hook<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>hook<span class="token punctuation">,</span> <span class="token string">'priority'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'"priority" is a reserved attribute for hooks'</span><span class="token punctuation">)</span>
        priority <span class="token operator">=</span> get_priority<span class="token punctuation">(</span>priority<span class="token punctuation">)</span>
        hook<span class="token punctuation">.</span>priority <span class="token operator">=</span> priority
        <span class="token comment"># insert the hook to a sorted list</span>
        inserted <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_hooks<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> priority <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>_hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>priority<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_hooks<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> hook<span class="token punctuation">)</span>
                inserted <span class="token operator">=</span> <span class="token boolean">True</span>
                <span class="token keyword">break</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> inserted<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_hooks<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> hook<span class="token punctuation">)</span>
</code></pre> 
<p>简单说一下 register_hook 这个方法，参数 hook 表示要保存的 Hook ，参数 priority 表示这个 Hook 的优先级，是不是越来越小单片机中的中断了。这里的优先级就是将Hook 放在 self._hooks 的什么位置，靠前的Hook在训练的时候会先执行。</p> 
<h5><a id="2register_momentum_hook_240"></a>2、register_momentum_hook</h5> 
<p>与register_lr_hook一样。</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">register_momentum_hook</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> momentum_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> momentum_config <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>momentum_config<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token string">'policy'</span> <span class="token keyword">in</span> momentum_config
            policy_type <span class="token operator">=</span> momentum_config<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'policy'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> policy_type <span class="token operator">==</span> policy_type<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                policy_type <span class="token operator">=</span> policy_type<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span>
            hook_type <span class="token operator">=</span> policy_type <span class="token operator">+</span> <span class="token string">'MomentumUpdaterHook'</span>
            momentum_config<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> hook_type
            hook <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>build_from_cfg<span class="token punctuation">(</span>momentum_config<span class="token punctuation">,</span> HOOKS<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            hook <span class="token operator">=</span> momentum_config
        self<span class="token punctuation">.</span>register_hook<span class="token punctuation">(</span>hook<span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token string">'HIGH'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="3register_optimizer_hook_260"></a>3、register_optimizer_hook</h5> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">register_optimizer_hook</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> optimizer_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> optimizer_config <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>optimizer_config<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            optimizer_config<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'OptimizerHook'</span><span class="token punctuation">)</span>
            hook <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>build_from_cfg<span class="token punctuation">(</span>optimizer_config<span class="token punctuation">,</span> HOOKS<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            hook <span class="token operator">=</span> optimizer_config
        self<span class="token punctuation">.</span>register_hook<span class="token punctuation">(</span>hook<span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token string">'ABOVE_NORMAL'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="4register_checkpoint_hook_274"></a>4、register_checkpoint_hook</h5> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">register_checkpoint_hook</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> checkpoint_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> checkpoint_config <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>checkpoint_config<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            checkpoint_config<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'CheckpointHook'</span><span class="token punctuation">)</span>
            hook <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>build_from_cfg<span class="token punctuation">(</span>checkpoint_config<span class="token punctuation">,</span> HOOKS<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            hook <span class="token operator">=</span> checkpoint_config
        self<span class="token punctuation">.</span>register_hook<span class="token punctuation">(</span>hook<span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token string">'NORMAL'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="5register_logger_hooks_287"></a>5、register_logger_hooks</h5> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">register_timer_hook</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timer_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> timer_config <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>timer_config<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            timer_config_ <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>timer_config<span class="token punctuation">)</span>
            hook <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>build_from_cfg<span class="token punctuation">(</span>timer_config_<span class="token punctuation">,</span> HOOKS<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            hook <span class="token operator">=</span> timer_config
        self<span class="token punctuation">.</span>register_hook<span class="token punctuation">(</span>hook<span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token string">'LOW'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="6register_logger_hooks_300"></a>6、register_logger_hooks</h5> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">register_logger_hooks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> log_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> log_config <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        log_interval <span class="token operator">=</span> log_config<span class="token punctuation">[</span><span class="token string">'interval'</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> info <span class="token keyword">in</span> log_config<span class="token punctuation">[</span><span class="token string">'hooks'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            logger_hook <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>build_from_cfg<span class="token punctuation">(</span>
                info<span class="token punctuation">,</span> HOOKS<span class="token punctuation">,</span> default_args<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>interval<span class="token operator">=</span>log_interval<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>register_hook<span class="token punctuation">(</span>logger_hook<span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token string">'VERY_LOW'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="7register_logger_hooks_312"></a>7、register_logger_hooks</h5> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">register_custom_hooks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> custom_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> custom_config <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>custom_config<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            custom_config <span class="token operator">=</span> <span class="token punctuation">[</span>custom_config<span class="token punctuation">]</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> custom_config<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>register_hook_from_cfg<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>register_hook<span class="token punctuation">(</span>item<span class="token punctuation">,</span> priority<span class="token operator">=</span><span class="token string">'NORMAL'</span><span class="token punctuation">)</span>
</code></pre> 
<p>也就是说每个 Hook 都是一个类，每个类都有自己的功能，这些类的共同之处是都会有before_run、after_run、before_epoch、after_epoch、before_iter、after_iter 这些方法。</p> 
<h3><a id="_328"></a>三、训练模型</h3> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_loaders<span class="token punctuation">,</span> workflow<span class="token punctuation">,</span> max_epochs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Start running.

        Args:
            data_loaders (list[:obj:`DataLoader`]): Dataloaders for training
                and validation.
            workflow (list[tuple]): A list of (phase, epochs) to specify the
                running order and epochs. E.g, [('train', 2), ('val', 1)] means
                running 2 epochs for training and 1 epoch for validation,
                iteratively.
        """</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>data_loaders<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> mmcv<span class="token punctuation">.</span>is_list_of<span class="token punctuation">(</span>workflow<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_loaders<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>workflow<span class="token punctuation">)</span>
        <span class="token keyword">if</span> max_epochs <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">'setting max_epochs in run is deprecated, please set max_epochs in runner_config'</span><span class="token punctuation">,</span> DeprecationWarning<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_max_epochs <span class="token operator">=</span> max_epochs

        <span class="token keyword">assert</span> self<span class="token punctuation">.</span>_max_epochs <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'max_epochs must be specified during instantiation'</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> i<span class="token punctuation">,</span> flow <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>workflow<span class="token punctuation">)</span><span class="token punctuation">:</span>
            mode<span class="token punctuation">,</span> epochs <span class="token operator">=</span> flow
            <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_max_iters <span class="token operator">=</span> self<span class="token punctuation">.</span>_max_epochs <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_loaders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>

        work_dir <span class="token operator">=</span> self<span class="token punctuation">.</span>work_dir <span class="token keyword">if</span> self<span class="token punctuation">.</span>work_dir <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token string">'NONE'</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Start running, host: %s, work_dir: %s'</span><span class="token punctuation">,</span> get_host_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> work_dir<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Hooks will be executed in the following order:\n%s'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>get_hook_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'workflow: %s, max: %d epochs'</span><span class="token punctuation">,</span> workflow<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_max_epochs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'before_run'</span><span class="token punctuation">)</span>

        <span class="token keyword">while</span> self<span class="token punctuation">.</span>epoch <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>_max_epochs<span class="token punctuation">:</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> flow <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>workflow<span class="token punctuation">)</span><span class="token punctuation">:</span>
                mode<span class="token punctuation">,</span> epochs <span class="token operator">=</span> flow
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># self.train()</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>
                            <span class="token string-interpolation"><span class="token string">f'runner has no method named "</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mode<span class="token punctuation">}</span></span><span class="token string">" to run an '</span></span>
                            <span class="token string">'epoch'</span><span class="token punctuation">)</span>
                    epoch_runner <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span>
                        <span class="token string">'mode in workflow must be a str, but got {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                            <span class="token builtin">type</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'train'</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>epoch <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>_max_epochs<span class="token punctuation">:</span>
                        <span class="token keyword">break</span>
                    epoch_runner<span class="token punctuation">(</span>data_loaders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># wait for some hooks like loggers to finish</span>
        self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'after_run'</span><span class="token punctuation">)</span>
</code></pre> 
<ol><li>传入的参数如注释；</li><li>进入方法后还是先检查传入参数的格式；</li><li>然后根据 self._max_epochs 的值设置 self._max_iters 的值；</li><li>打印一些信息；</li><li>调用 call_hook 方法并传入 ‘before_run’，这个过程就是遍历我们之前注册的Hook，执行所有Hook的before_run方法；</li><li>开始循环训练，这个循环的功能是根据各种参数判断当前因该执行那个方法， self.train 还是 self.val 。 <code>epoch_runner = getattr(self, mode)</code>，这里的mode就是就是train、val 。</li><li>最后执行<code>self.call_hook('after_run')</code>。</li></ol> 
<p>这里补充以下第5、7两点，至于调用<code>self.call_hook('before_run')</code> 和 <code>self.call_hook('after_run')</code>到底会干嘛，这个取决于我们刚刚定义的每一个Hook以及每个Hook对相关方法的实现。</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">call_hook</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fn_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> hook <span class="token keyword">in</span> self<span class="token punctuation">.</span>_hooks<span class="token punctuation">:</span>
            <span class="token builtin">getattr</span><span class="token punctuation">(</span>hook<span class="token punctuation">,</span> fn_name<span class="token punctuation">)</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
</code></pre> 
<p>call_hook 会比遍历我们呢注册的所有 Hook 并调用所有 Hook 中的 某个方法。比如<code>self.call_hook('before_run')</code> 就会调用所有 Hook 中的 before_run 方法。</p> 
<p>最后还有三个方法，就是上面第6点 run 中可能选择的执行方法。</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_loader<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token string">'train'</span>
        self<span class="token punctuation">.</span>data_loader <span class="token operator">=</span> data_loader
        self<span class="token punctuation">.</span>_max_iters <span class="token operator">=</span> self<span class="token punctuation">.</span>_max_epochs <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_loader<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'before_train_epoch'</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># Prevent possible deadlock during epoch transition</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> data_batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_inner_iter <span class="token operator">=</span> i
            self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'before_train_iter'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>run_iter<span class="token punctuation">(</span>data_batch<span class="token punctuation">,</span> train_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'after_train_iter'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_iter <span class="token operator">+=</span> <span class="token number">1</span>

        self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'after_train_epoch'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_epoch <span class="token operator">+=</span> <span class="token number">1</span>
</code></pre> 
<pre><code class="prism language-python">    <span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>no_grad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">val</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_loader<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token string">'val'</span>
        self<span class="token punctuation">.</span>data_loader <span class="token operator">=</span> data_loader
        self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'before_val_epoch'</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># Prevent possible deadlock during epoch transition</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> data_batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_inner_iter <span class="token operator">=</span> i
            self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'before_val_iter'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>run_iter<span class="token punctuation">(</span>data_batch<span class="token punctuation">,</span> train_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'after_val_iter'</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'after_val_epoch'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">run_iter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_batch<span class="token punctuation">,</span> train_mode<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>batch_processor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>batch_processor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> data_batch<span class="token punctuation">,</span> train_mode<span class="token operator">=</span>train_mode<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> train_mode<span class="token punctuation">:</span>
            outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>train_step<span class="token punctuation">(</span>data_batch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>optimizer<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>val_step<span class="token punctuation">(</span>data_batch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>optimizer<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'"batch_processor()" or "model.train_step()" and "model.val_step()" must return a dict'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'log_vars'</span> <span class="token keyword">in</span> outputs<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log_buffer<span class="token punctuation">.</span>update<span class="token punctuation">(</span>outputs<span class="token punctuation">[</span><span class="token string">'log_vars'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> outputs<span class="token punctuation">[</span><span class="token string">'num_samples'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>outputs <span class="token operator">=</span> outputs
</code></pre> 
<p>这三个方法就是比较常见的训练过程了，只不过大部分的代码都封装在 Hook 中了，如果想搞懂脚本每一步在干嘛还需要参考各个 Hook 的各个方法。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d47c79d860e26aadf956eda4b927a86c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">sbatch: error: Batch script contains DOS line breaks (\r\n)解決</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0955b809fcae126cf33884dec3c5fb26/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【深入kotlin】- 伴生对象和扩展</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>