<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ansible-playbook【2】ansible对服务器进行批量优化 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ansible-playbook【2】ansible对服务器进行批量优化" />
<meta property="og:description" content="ansible对服务器进行批量优化 一、准备工作1、服务器准备 二、配置解释1、配置文件如下2、配置文件解释（1）playbook脚本文件如下（2）主机清单列表如下（3）全局环境变量配置文件如下（4）备份脚本如下（5）缓存清理脚本如下（6）磁盘格式化脚本如下（7）优化脚本如下（8）任务集合配置文件如下 三、执行脚本1、测试下执行的主机是否正确2、执行playbook脚本文件 四、结果验证1、验证lvm磁盘挂载情况2、验证备份脚本和缓存脚本是否正常3、验证 /data 目录下常见目录的创建情况4、验证优化情况 一、准备工作 1、服务器准备 IP地址服务器作用系统其他192.168.80.88ansible服务器centos 7.9部署好ansible，配置完免交互192.168.80.10测试服务器1centos 7.9硬盘50G192.168.80.20测试服务器2centos 7.9硬盘50G 二、配置解释 1、配置文件如下 [root@ansible ansible]# tree /etc/ansible/ /etc/ansible/ ├── auto_install.yml	## playbook脚本文件	├── group_vars	│ └── global.yml	## 全局环境变量配置文件 ├── hosts	## 主机清单列表 └── roles	## 角色 └── optimization	## 自定义的角色名称 ├── files │ ├── Backup.sh	## 备份脚本 │ ├── clean_cache.sh	## 缓存清理脚本 │ ├── disk.sh	## 磁盘格式化脚本 │ ├── lvm2.tar	## lvm的rpm包 │ └── server_optimize.sh	## 优化脚本 └── tasks	└── main." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5fc7820b0b5fb962a1a40a8118bb3e2b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-14T14:55:11+08:00" />
<meta property="article:modified_time" content="2022-12-14T14:55:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ansible-playbook【2】ansible对服务器进行批量优化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>ansible对服务器进行批量优化</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、准备工作</a></li><li><ul><li><a href="#1_2" rel="nofollow">1、服务器准备</a></li></ul> 
  </li><li><a href="#_9" rel="nofollow">二、配置解释</a></li><li><ul><li><a href="#1_10" rel="nofollow">1、配置文件如下</a></li><li><a href="#2_31" rel="nofollow">2、配置文件解释</a></li><li><ul><li><a href="#1playbook_32" rel="nofollow">（1）playbook脚本文件如下</a></li><li><a href="#2_47" rel="nofollow">（2）主机清单列表如下</a></li><li><a href="#3_54" rel="nofollow">（3）全局环境变量配置文件如下</a></li><li><a href="#4_63" rel="nofollow">（4）备份脚本如下</a></li><li><a href="#5_90" rel="nofollow">（5）缓存清理脚本如下</a></li><li><a href="#6_104" rel="nofollow">（6）磁盘格式化脚本如下</a></li><li><a href="#7_122" rel="nofollow">（7）优化脚本如下</a></li><li><a href="#8_143" rel="nofollow">（8）任务集合配置文件如下</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_222" rel="nofollow">三、执行脚本</a></li><li><ul><li><a href="#1_223" rel="nofollow">1、测试下执行的主机是否正确</a></li><li><a href="#2playbook_229" rel="nofollow">2、执行playbook脚本文件</a></li></ul> 
  </li><li><a href="#_236" rel="nofollow">四、结果验证</a></li><li><ul><li><a href="#1lvm_237" rel="nofollow">1、验证lvm磁盘挂载情况</a></li><li><a href="#2_244" rel="nofollow">2、验证备份脚本和缓存脚本是否正常</a></li><li><a href="#3_data__251" rel="nofollow">3、验证 /data 目录下常见目录的创建情况</a></li><li><a href="#4_257" rel="nofollow">4、验证优化情况</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、准备工作</h2> 
<h3><a id="1_2"></a>1、服务器准备</h3> 
<table><thead><tr><th>IP地址</th><th>服务器作用</th><th>系统</th><th>其他</th></tr></thead><tbody><tr><td>192.168.80.88</td><td>ansible服务器</td><td>centos 7.9</td><td>部署好ansible，配置完免交互</td></tr><tr><td>192.168.80.10</td><td>测试服务器1</td><td>centos 7.9</td><td>硬盘50G</td></tr><tr><td>192.168.80.20</td><td>测试服务器2</td><td>centos 7.9</td><td>硬盘50G</td></tr></tbody></table> 
<h2><a id="_9"></a>二、配置解释</h2> 
<h3><a id="1_10"></a>1、配置文件如下</h3> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@ansible ansible</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">tree</span> <span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">ansible</span><span class="token punctuation">/</span>
<span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">ansible</span><span class="token punctuation">/</span>
<span class="token variable">├──</span> <span class="token variable">auto_install</span><span class="token punctuation">.</span><span class="token variable">yml</span>						<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">playbook脚本文件</span>	
<span class="token variable">├──</span> <span class="token variable">group_vars</span>				
<span class="token variable">│</span>   <span class="token variable">└──</span> <span class="token variable">global</span><span class="token punctuation">.</span><span class="token variable">yml</span>							<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">全局环境变量配置文件</span>
<span class="token variable">├──</span> <span class="token variable">hosts</span>									<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">主机清单列表</span>
<span class="token variable">└──</span> <span class="token variable">roles</span>									<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">角色</span>
    <span class="token variable">└──</span> <span class="token variable">optimization</span>						<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">自定义的角色名称</span>
       <span class="token variable">├──</span> <span class="token variable">files</span>
       <span class="token variable">│</span>   <span class="token variable">├──</span> <span class="token variable">Backup</span><span class="token punctuation">.</span><span class="token variable">sh</span>					<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">备份脚本</span>
       <span class="token variable">│</span>   <span class="token variable">├──</span> <span class="token variable">clean_cache</span><span class="token punctuation">.</span><span class="token variable">sh</span>				<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">缓存清理脚本</span>
       <span class="token variable">│</span>   <span class="token variable">├──</span> <span class="token variable">disk</span><span class="token punctuation">.</span><span class="token variable">sh</span>						<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">磁盘格式化脚本</span>
       <span class="token variable">│</span>   <span class="token variable">├──</span> <span class="token variable">lvm2</span><span class="token punctuation">.</span><span class="token variable">tar</span>						<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">lvm的rpm包</span>
       <span class="token variable">│</span>   <span class="token variable">└──</span> <span class="token variable">server_optimize</span><span class="token punctuation">.</span><span class="token variable">sh</span>			<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">优化脚本</span>
       <span class="token variable">└──</span> <span class="token variable">tasks</span>							
           <span class="token variable">└──</span> <span class="token variable">main</span><span class="token punctuation">.</span><span class="token variable">yml</span>						<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">任务集合</span>

</code></pre> 
<h3><a id="2_31"></a>2、配置文件解释</h3> 
<h4><a id="1playbook_32"></a>（1）playbook脚本文件如下</h4> 
<blockquote> 
 <p>此配置文件修改如下两项：<br> 1、hosts：执行的主机组，需在/etc/ansible/hosts 中定义<br> 2、roles：执行的角色，需在/etc/ansible/roles 下定义</p> 
</blockquote> 
<pre><code class="prism language-handlebars"><span class="token variable">---</span>
<span class="token variable">-</span> <span class="token variable">hosts</span><span class="token punctuation">:</span> <span class="token variable">test</span>                   <span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">执行的主机</span>
  <span class="token variable">remote_user</span><span class="token punctuation">:</span> <span class="token variable">root</span>             <span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">执行的用户</span>
  <span class="token variable">vars_files</span><span class="token punctuation">:</span>
    <span class="token variable">-</span> <span class="token variable">group_vars</span><span class="token punctuation">/</span><span class="token variable">global</span><span class="token punctuation">.</span><span class="token variable">yml</span>     <span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">全局变量文件</span>
  <span class="token variable">roles</span><span class="token punctuation">:</span>
   <span class="token variable">-</span> <span class="token variable">optimization</span>               <span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">系统优化（对应自定义角色的名称）</span>
</code></pre> 
<h4><a id="2_47"></a>（2）主机清单列表如下</h4> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">test</span><span class="token punctuation">]</span></span>
<span class="token number">192.168</span><span class="token number">.80</span><span class="token number">.10</span>
<span class="token number">192.168</span><span class="token number">.80</span><span class="token number">.20</span>
</code></pre> 
<h4><a id="3_54"></a>（3）全局环境变量配置文件如下</h4> 
<pre><code class="prism language-handlebars"><span class="token block keyword">##</span> <span class="token variable">服务器空闲磁盘名称，可使用ansible命令批量获取，见下图</span>
<span class="token variable">disk_name</span><span class="token punctuation">:</span> <span class="token variable">sdb</span>
<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">要设置的卷组名和lvm逻辑卷名</span>
<span class="token variable">vg_name</span><span class="token punctuation">:</span> <span class="token variable">myvg</span>
<span class="token variable">lvm_name</span><span class="token punctuation">:</span> <span class="token variable">mylvm</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/40/45/67PYWjWj_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4_63"></a>（4）备份脚本如下</h4> 
<pre><code class="prism language-handlebars"><span class="token block keyword">#!/bin/bash</span>
<span class="token block keyword">##</span> <span class="token variable">备份专用脚本，使用方法：</span> <span class="token variable">Backup</span><span class="token punctuation">.</span><span class="token variable">sh</span> <span class="token variable">当前文件或者目录名</span>

<span class="token variable">mkdir</span> <span class="token variable">-p</span> <span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">packages</span><span class="token punctuation">/</span><span class="token variable">backup</span><span class="token punctuation">/</span> <span class="token punctuation">&amp;</span><span class="token punctuation">&gt;</span> <span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token variable">null</span>
<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">定义更新目录和当下时间</span>
<span class="token variable">path</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">packages</span><span class="token punctuation">/</span><span class="token variable">backup</span>
<span class="token variable">date</span><span class="token punctuation">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token variable">date</span> <span class="token punctuation">+</span><span class="token punctuation">%</span><span class="token variable">Y-</span><span class="token punctuation">%</span><span class="token variable">m-</span><span class="token punctuation">%</span><span class="token variable">d-</span><span class="token punctuation">%</span><span class="token variable">H-</span><span class="token punctuation">%</span><span class="token variable">M</span><span class="token punctuation">)</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">判断是否有</span><span class="token punctuation">/</span>
<span class="token variable">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$</span><span class="token number">1</span> <span class="token punctuation">=</span> <span class="token punctuation">*</span><span class="token punctuation">/</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token variable">then</span>
    <span class="token variable">name</span><span class="token punctuation">=</span><span class="token punctuation">`</span><span class="token variable">echo</span> <span class="token variable">$</span><span class="token number">1</span> <span class="token punctuation">|</span> <span class="token variable">awk</span> <span class="token variable">-F</span><span class="token punctuation">/</span> <span class="token string">'{print $1}'</span><span class="token punctuation">`</span>
    <span class="token variable">tar</span> <span class="token variable">cf</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">date</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">tar</span> <span class="token variable">$</span><span class="token number">1</span>
    <span class="token variable">mv</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">date</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">tar</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">path</span><span class="token punctuation">}</span><span class="token punctuation">/</span><span class="token variable">$name-$</span><span class="token punctuation">{<!-- --></span><span class="token variable">date</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">tar</span>
<span class="token variable">else</span>
    <span class="token variable">tar</span> <span class="token variable">cf</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">date</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">tar</span> <span class="token variable">$</span><span class="token number">1</span>
    <span class="token variable">mv</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">date</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">tar</span> <span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">path</span><span class="token punctuation">}</span><span class="token punctuation">/</span><span class="token variable">$</span><span class="token number">1</span><span class="token variable">-$</span><span class="token punctuation">{<!-- --></span><span class="token variable">date</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token variable">tar</span>
<span class="token variable">fi</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">输出备份结果</span>
<span class="token variable">echo</span> <span class="token string">"本次备份情况如下："</span>
<span class="token variable">ls</span> <span class="token variable">-lh</span> <span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">packages</span><span class="token punctuation">/</span><span class="token variable">backup</span><span class="token punctuation">/</span><span class="token punctuation">*</span><span class="token variable">$</span><span class="token punctuation">{<!-- --></span><span class="token variable">date</span><span class="token punctuation">}</span><span class="token punctuation">*</span>
</code></pre> 
<h4><a id="5_90"></a>（5）缓存清理脚本如下</h4> 
<pre><code class="prism language-handlebars"><span class="token block keyword">#!/bin/bash</span>
<span class="token block keyword">##</span> <span class="token variable">清除缓存脚本</span>
<span class="token variable">echo</span> <span class="token string">"开始清理缓存"</span>
<span class="token variable">sync</span><span class="token punctuation">;</span><span class="token variable">sync</span><span class="token punctuation">;</span><span class="token variable">sync</span> <span class="token punctuation">#</span><span class="token variable">写入硬盘，防止数据丢失</span>
<span class="token variable">sleep</span> <span class="token number">10</span> <span class="token block keyword">#延迟</span><span class="token number">10</span><span class="token variable">秒</span>
<span class="token variable">echo</span> <span class="token number">1</span> <span class="token punctuation">&gt;</span> <span class="token punctuation">/</span><span class="token variable">proc</span><span class="token punctuation">/</span><span class="token variable">sys</span><span class="token punctuation">/</span><span class="token variable">vm</span><span class="token punctuation">/</span><span class="token variable">drop_caches</span>
<span class="token variable">echo</span> <span class="token number">2</span> <span class="token punctuation">&gt;</span> <span class="token punctuation">/</span><span class="token variable">proc</span><span class="token punctuation">/</span><span class="token variable">sys</span><span class="token punctuation">/</span><span class="token variable">vm</span><span class="token punctuation">/</span><span class="token variable">drop_caches</span>
<span class="token variable">echo</span> <span class="token number">3</span> <span class="token punctuation">&gt;</span> <span class="token punctuation">/</span><span class="token variable">proc</span><span class="token punctuation">/</span><span class="token variable">sys</span><span class="token punctuation">/</span><span class="token variable">vm</span><span class="token punctuation">/</span><span class="token variable">drop_caches</span>
<span class="token variable">echo</span> <span class="token string">"清理结束"</span>
</code></pre> 
<h4><a id="6_104"></a>（6）磁盘格式化脚本如下</h4> 
<pre><code class="prism language-handlebars"><span class="token block keyword">#!/bin/bash</span>
<span class="token block keyword">##</span> <span class="token variable">下列的“</span><span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token variable">sdb”替换为查找的空闲磁盘名称</span>
<span class="token variable">fdisk</span> <span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token variable">sda</span> <span class="token punctuation">&lt;</span><span class="token punctuation">&lt;</span><span class="token variable">EOF</span>
<span class="token variable">n</span>
<span class="token variable">p</span>




<span class="token variable">t</span>
<span class="token number">8</span><span class="token variable">e</span>
<span class="token variable">w</span>
<span class="token variable">EOF</span>
</code></pre> 
<h4><a id="7_122"></a>（7）优化脚本如下</h4> 
<blockquote> 
 <p>根据项目需求自己添加优化项，这边只配置了简单的</p> 
</blockquote> 
<pre><code class="prism language-handlebars"><span class="token block keyword">#!/bin/bash</span>
<span class="token punctuation">#</span> <span class="token variable">系统优化</span>

<span class="token punctuation">#</span><span class="token variable">永久关闭selinux，需要重启</span>
<span class="token variable">sed</span> <span class="token variable">-i</span> <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> <span class="token block keyword">/etc/selinux/config</span>
<span class="token variable">setenforce</span> <span class="token number">0</span>

<span class="token block keyword">#关闭防火墙并设为开机不自启，然后显示状态</span>
<span class="token variable">systemctl</span> <span class="token variable">stop</span> <span class="token variable">firewalld</span><span class="token punctuation">.</span><span class="token variable">service</span>
<span class="token variable">systemctl</span> <span class="token variable">disable</span> <span class="token variable">firewalld</span><span class="token punctuation">.</span><span class="token variable">service</span>

<span class="token punctuation">#</span><span class="token variable">时间校准并加入计划任务中</span>
<span class="token variable">yum</span> <span class="token variable">install</span> <span class="token variable">-y</span> <span class="token variable">ntpdate</span>
<span class="token punctuation">#</span><span class="token variable">echo</span> <span class="token string">'*/5 * * * * /usr/sbin/ntpdate ntp1.aliyun.com &gt;/dev/null 2&gt;&amp;1'</span> <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">/</span><span class="token variable">var</span><span class="token punctuation">/</span><span class="token variable">spool</span><span class="token punctuation">/</span><span class="token variable">cron</span><span class="token punctuation">/</span><span class="token variable">root</span>
</code></pre> 
<h4><a id="8_143"></a>（8）任务集合配置文件如下</h4> 
<pre><code class="prism language-handlebars"><span class="token block keyword">##</span> <span class="token variable">yum安装lvm2失败则使用rpm包安装</span>
<span class="token variable">-</span> <span class="token variable">block</span><span class="token punctuation">:</span>
  <span class="token variable">-</span> <span class="token variable">yum</span><span class="token punctuation">:</span>
      <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">lvm2</span>
  <span class="token variable">rescue</span><span class="token punctuation">:</span>
    <span class="token variable">-</span> <span class="token variable">debug</span><span class="token punctuation">:</span>
        <span class="token variable">msg</span><span class="token punctuation">:</span> <span class="token string">"yum安装lvm2失败,将使用本地rpm包安装"</span>
    <span class="token variable">-</span> <span class="token variable">unarchive</span><span class="token punctuation">:</span>
        <span class="token variable">src</span><span class="token punctuation">:</span> <span class="token variable">lvm2</span><span class="token punctuation">.</span><span class="token variable">tar</span>
        <span class="token variable">dest</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">opt</span><span class="token punctuation">/</span>
    <span class="token variable">-</span> <span class="token variable">command</span><span class="token punctuation">:</span> <span class="token variable">rpm</span> <span class="token variable">-ivh</span> <span class="token punctuation">/</span><span class="token variable">opt</span><span class="token punctuation">/</span><span class="token variable">lvm2</span><span class="token punctuation">/</span><span class="token punctuation">*</span> <span class="token variable">--nodeps</span> <span class="token variable">--force</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token number">1</span><span class="token variable">分区-</span><span class="token number">2</span><span class="token variable">创建pv-</span><span class="token number">3</span><span class="token variable">创建vg-</span><span class="token number">4</span><span class="token variable">创建lvm-</span><span class="token number">5</span><span class="token variable">格式化</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">copy</span> <span class="token variable">file</span>
  <span class="token variable">copy</span><span class="token punctuation">:</span>
    <span class="token variable">src</span><span class="token punctuation">:</span> <span class="token variable">disk</span><span class="token punctuation">.</span><span class="token variable">sh</span>
    <span class="token variable">dest</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">root</span><span class="token punctuation">/</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span>
  <span class="token variable">lineinfile</span><span class="token punctuation">:</span>
    <span class="token variable">path</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">root</span><span class="token punctuation">/</span><span class="token variable">disk</span><span class="token punctuation">.</span><span class="token variable">sh</span>
    <span class="token variable">regexp</span><span class="token punctuation">:</span> <span class="token string">'^fdisk'</span>
    <span class="token variable">line</span><span class="token punctuation">:</span> <span class="token variable">fdisk</span> <span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">disk_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">&lt;</span><span class="token punctuation">&lt;</span><span class="token variable">EOF</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">run</span> <span class="token variable">script</span>
  <span class="token variable">shell</span><span class="token punctuation">:</span> <span class="token variable">bash</span> <span class="token punctuation">/</span><span class="token variable">root</span><span class="token punctuation">/</span><span class="token variable">disk</span><span class="token punctuation">.</span><span class="token variable">sh</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">pvcreate</span> <span class="token variable">pv</span>
  <span class="token variable">command</span><span class="token punctuation">:</span> <span class="token variable">pvcreate</span> <span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">disk_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token number">1</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">pvcreate</span> <span class="token variable">vg</span>
  <span class="token variable">command</span><span class="token punctuation">:</span> <span class="token variable">vgcreate</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">vg_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">disk_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token number">1</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">pvcreate</span> <span class="token variable">lvm</span>
  <span class="token variable">command</span><span class="token punctuation">:</span> <span class="token variable">lvcreate</span> <span class="token variable">-l</span> <span class="token number">100</span><span class="token punctuation">%</span><span class="token variable">VG</span> <span class="token variable">-n</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">lvm_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">vg_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">format</span> <span class="token variable">disk</span>
  <span class="token variable">command</span><span class="token punctuation">:</span> <span class="token variable">mkfs</span><span class="token punctuation">.</span><span class="token variable">xfs</span> <span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">vg_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">lvm_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">永久挂载到</span><span class="token punctuation">/</span><span class="token variable">data目录</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">auto</span> <span class="token variable">mount</span>
  <span class="token variable">lineinfile</span><span class="token punctuation">:</span>
    <span class="token variable">path</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">fstab</span>
    <span class="token variable">line</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">dev</span><span class="token punctuation">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">vg_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token variable">lvm_name</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">/</span><span class="token variable">data</span> <span class="token variable">xfs</span> <span class="token variable">defaults</span> <span class="token number">0</span> <span class="token number">0</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">create</span> <span class="token variable">data</span>
  <span class="token variable">command</span><span class="token punctuation">:</span>  <span class="token variable">mkdir</span> <span class="token variable">-p</span> <span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">flush</span> <span class="token variable">config</span>
  <span class="token variable">command</span><span class="token punctuation">:</span> <span class="token variable">mount</span> <span class="token variable">-a</span>
<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">创建常用目录</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">Create</span> <span class="token variable">directory</span>
  <span class="token variable">file</span><span class="token punctuation">:</span>
    <span class="token variable">path</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">item</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token variable">state</span><span class="token punctuation">:</span> <span class="token variable">directory</span>
  <span class="token variable">loop</span><span class="token punctuation">:</span>
    <span class="token variable">-</span> <span class="token variable">packages</span>
    <span class="token variable">-</span> <span class="token variable">script</span>
    <span class="token variable">-</span> <span class="token variable">soft</span>
    <span class="token variable">-</span> <span class="token variable">monitor</span>
    <span class="token variable">-</span> <span class="token variable">backup</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">配置自动备份脚本</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">copy</span> <span class="token variable">Backup</span> <span class="token variable">file</span>
  <span class="token variable">copy</span><span class="token punctuation">:</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token variable">Backup</span><span class="token punctuation">.</span><span class="token variable">sh</span> <span class="token variable">dest</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">/</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">Setting</span> <span class="token variable">environment</span> <span class="token variable">variables</span>
  <span class="token variable">file</span><span class="token punctuation">:</span> <span class="token variable">mode</span><span class="token punctuation">=</span><span class="token number">755</span> <span class="token variable">path</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">bin</span><span class="token punctuation">/</span><span class="token variable">Backup</span><span class="token punctuation">.</span><span class="token variable">sh</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">/</span><span class="token variable">Backup</span><span class="token punctuation">.</span><span class="token variable">sh</span> <span class="token variable">state</span><span class="token punctuation">=</span><span class="token variable">link</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">配置每日缓存清理脚本，并加入到cron</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">copy</span> <span class="token variable">clean_cache</span> <span class="token variable">file</span>
  <span class="token variable">copy</span><span class="token punctuation">:</span> <span class="token variable">src</span><span class="token punctuation">=</span><span class="token variable">clean_cache</span><span class="token punctuation">.</span><span class="token variable">sh</span> <span class="token variable">dest</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">/</span>

<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">Join</span> <span class="token variable">planned</span> <span class="token variable">tasks</span>
  <span class="token variable">cron</span><span class="token punctuation">:</span>
    <span class="token variable">minute</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token variable">hour</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token variable">job</span><span class="token punctuation">:</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">bin</span><span class="token punctuation">/</span><span class="token variable">bash</span> <span class="token punctuation">/</span><span class="token variable">data</span><span class="token punctuation">/</span><span class="token variable">script</span><span class="token punctuation">/</span><span class="token variable">clean_cache</span><span class="token punctuation">.</span><span class="token variable">sh</span>
    <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">clean_cache</span>

<span class="token punctuation">#</span><span class="token punctuation">#</span> <span class="token variable">服务器优化脚本</span>
<span class="token variable">-</span> <span class="token variable">name</span><span class="token punctuation">:</span> <span class="token variable">Execute</span> <span class="token variable">server_optimize</span> <span class="token variable">script</span>
  <span class="token variable">script</span><span class="token punctuation">:</span> <span class="token variable">linux_env_optimize</span><span class="token punctuation">.</span><span class="token variable">sh</span>
</code></pre> 
<h2><a id="_222"></a>三、执行脚本</h2> 
<h3><a id="1_223"></a>1、测试下执行的主机是否正确</h3> 
<pre><code class="prism language-handlebars"><span class="token variable">ansible</span> <span class="token variable">test</span> <span class="token variable">--list-host</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7a/4e/YeKB5wri_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2playbook_229"></a>2、执行playbook脚本文件</h3> 
<pre><code class="prism language-handlebars"> <span class="token variable">ansible-playbook</span> <span class="token variable">-vv</span> <span class="token variable">auto_install</span><span class="token punctuation">.</span><span class="token variable">yml</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7f/24/jCySHhN5_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_236"></a>四、结果验证</h2> 
<h3><a id="1lvm_237"></a>1、验证lvm磁盘挂载情况</h3> 
<pre><code class="prism language-handlebars"><span class="token variable">ansible</span> <span class="token variable">test</span> <span class="token variable">-m</span> <span class="token variable">shell</span> <span class="token variable">-a</span> <span class="token string">'lsblk'</span>
<span class="token block keyword">##</span> <span class="token variable">磁盘已初始化并挂载到</span> <span class="token punctuation">/</span><span class="token variable">data</span> <span class="token variable">盘</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/41/21/Fg5bRBXY_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_244"></a>2、验证备份脚本和缓存脚本是否正常</h3> 
<pre><code class="prism language-handlebars"><span class="token variable">ansible</span> <span class="token variable">test</span> <span class="token variable">-m</span> <span class="token variable">shell</span> <span class="token variable">-a</span> <span class="token string">'whereis Backup.sh'</span>
<span class="token variable">ansible</span> <span class="token variable">test</span> <span class="token variable">-m</span> <span class="token variable">shell</span> <span class="token variable">-a</span> <span class="token string">'crontab -l'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ef/e1/vRGHCRfk_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_data__251"></a>3、验证 /data 目录下常见目录的创建情况</h3> 
<pre><code class="prism language-handlebars"><span class="token variable">ansible</span> <span class="token variable">test</span> <span class="token variable">-m</span> <span class="token variable">shell</span> <span class="token variable">-a</span> <span class="token string">'tree /data'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/58/58/GB9mFnvO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_257"></a>4、验证优化情况</h3> 
<pre><code class="prism language-handlebars"><span class="token variable">ansible</span> <span class="token variable">test</span> <span class="token variable">-m</span> <span class="token variable">shell</span> <span class="token variable">-a</span> <span class="token string">'systemctl status firewalld'</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2e/ff/flimB6Ka_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/19db334c970982685ac868045d56043a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android 开发viewBinding使用及其需要注意的事项（Activity做弹窗Dialog）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bb5061da9b6000d8dc99366fe4f422b5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue3 el-date-picker是英文使用el-config-provide语言切换器 更改为中文</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>