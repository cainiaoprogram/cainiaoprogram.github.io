<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>电商项目-订单模块 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="电商项目-订单模块" />
<meta property="og:description" content="72. 显示确认订单信息页 显示“确认订单信息”页面中，需要显示2种数据：当前用户的所有收货地址列表；用户在前序页面中选择的购物车中的商品。
首先，完成“显示当前用户的所有收货地址的列表”，在此前开发“收货地址”相关功能时，已经可以通过/addresses/这个URL获取收货地址列表！则直接在orderConfirm.html中通过$.ajax()获取数据并显示即可！
接下来，应该“显示用户在前序页面中选择的购物车中的商品的列表”，对应的查询功能的SQL语句大致是：
select * from t_cart left join t_product on t_cart.pid=t_product.id where cid in (?,?,?) 所以，需要在CartMapper.java接口中添加：
List&lt;CartVO&gt; findByCids(Integer[] cids); 在CartMapper.xml中配置以上抽象方法的映射：
&lt;select id=&#34;findByCids&#34; resultType=&#34;xx.xx.xx.CartVO&#34;&gt; SELECT cid, uid, pid, t_cart.num, t_cart.price, t_product.price AS realPrice, title, image FROM t_cart LEFT JOIN t_product ON t_cart.pid=t_product.id WHERE cid IN &lt;foreach collection=&#34;array&#34; item=&#34;cid&#34; seperator=&#34;,&#34; open=&#34;(&#34; close=&#34;)&#34;&gt; #{cid} &lt;/foreach&gt; ORDER BY t_cart.created_time DESC &lt;/select&gt; 完成持久层后，接下来，需要在ICartService业务层接口中添加抽象方法，以对外提供数据访问功能：
List&lt;CartVO&gt; getByCids(Integer[] cids, Integer uid); 然后，在实现类中，先私有化编写持久层的方法：
private List&lt;CartVO&gt; findByCids(Integer[] cids) { return cartMapper." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f9cca8b85af4b73ff9c4e84d70c62846/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-17T19:44:49+08:00" />
<meta property="article:modified_time" content="2019-07-17T19:44:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">电商项目-订单模块</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="72__0"></a>72. 显示确认订单信息页</h4> 
<p>显示“确认订单信息”页面中，需要显示2种数据：当前用户的所有收货地址列表；用户在前序页面中选择的购物车中的商品。</p> 
<p>首先，完成“显示当前用户的所有收货地址的列表”，在此前开发“收货地址”相关功能时，已经可以通过<code>/addresses/</code>这个URL获取收货地址列表！则直接在<code>orderConfirm.html</code>中通过<code>$.ajax()</code>获取数据并显示即可！</p> 
<p>接下来，应该“显示用户在前序页面中选择的购物车中的商品的列表”，对应的查询功能的SQL语句大致是：</p> 
<pre><code>select * from t_cart left join t_product on t_cart.pid=t_product.id where cid in (?,?,?)
</code></pre> 
<p>所以，需要在<code>CartMapper.java</code>接口中添加：</p> 
<pre><code>List&lt;CartVO&gt; findByCids(Integer[] cids);
</code></pre> 
<p>在<code>CartMapper.xml</code>中配置以上抽象方法的映射：</p> 
<pre><code class="prism language-xml">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findByCids<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>xx.xx.xx.CartVO<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		SELECT 
			cid, uid, 
			pid, t_cart.num, 
			t_cart.price, t_product.price AS realPrice,
			title, image
		FROM 
			t_cart 
		LEFT JOIN
			t_product
		ON
			t_cart.pid=t_product.id
		WHERE 
			cid IN
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>array<span class="token punctuation">"</span></span>
				<span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cid<span class="token punctuation">"</span></span> <span class="token attr-name">seperator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span>
				<span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(<span class="token punctuation">"</span></span> <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
				#{cid}
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">&gt;</span></span>
		ORDER BY
			t_cart.created_time DESC
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>完成持久层后，接下来，需要在<code>ICartService</code>业务层接口中添加抽象方法，以对外提供数据访问功能：</p> 
<pre><code>List&lt;CartVO&gt; getByCids(Integer[] cids, Integer uid);
</code></pre> 
<p>然后，在实现类中，先私有化编写持久层的方法：</p> 
<pre><code>private List&lt;CartVO&gt; findByCids(Integer[] cids) {
	return cartMapper.findByCids(cids);
}
</code></pre> 
<p>并重写接口中的抽象方法：</p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>CartVO<span class="token punctuation">&gt;</span></span> <span class="token function">getByCids</span><span class="token punctuation">(</span>Integer<span class="token punctuation">[</span><span class="token punctuation">]</span> cids<span class="token punctuation">,</span> Integer uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cids <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		List<span class="token generics function"><span class="token punctuation">&lt;</span>CartVO<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token function">findByCids</span><span class="token punctuation">(</span>cids<span class="token punctuation">)</span><span class="token punctuation">;</span>

		Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>CartVO<span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			CartVO cartVO <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>cartVO<span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

测试完成后，需要在控制器层提供接口：

	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"get_by_cids"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> JsonResult<span class="token operator">&lt;</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>CartVO<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> <span class="token function">getByCids</span><span class="token punctuation">(</span>
			Integer<span class="token punctuation">[</span><span class="token punctuation">]</span> cids<span class="token punctuation">,</span> HttpSession session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 从session中获取uid</span>
		Integer uid <span class="token operator">=</span> <span class="token function">getUidFromSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 调用业务层对象的方法执行任务</span>
		List<span class="token generics function"><span class="token punctuation">&lt;</span>CartVO<span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">getByCids</span><span class="token punctuation">(</span>cids<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 响应成功</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>SUCCESS<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>然后，打开浏览器，可以通过<code>http://localhost:8080/carts/get_by_cids?cids=14&amp;cids=15&amp;cids=16</code>进行单元测试。</p> 
<p>测试完成后，需要在<code>orderConfirm.html</code>中发出对这个URL的请求，以获取数据，并显示。</p> 
<h4><a id="73__86"></a>73. 创建订单-创建数据表</h4> 
<p>创建“订单表”：</p> 
<pre><code>CREATE TABLE t_order (
	oid INT AUTO_INCREMENT COMMENT '订单id',
	uid INT COMMENT '用户id',
	recv_name VARCHAR(50) COMMENT '收货人receiver姓名',
	recv_phone VARCHAR(20) COMMENT '收货人电话',
	recv_province VARCHAR(50) COMMENT '收货地址所在省',
	recv_city VARCHAR(50) COMMENT '收货地址所在市',
	recv_area VARCHAR(50) COMMENT '收货地址所在区',
	recv_address VARCHAR(100) COMMENT '详细收货地址',
	total_price BIGINT COMMENT '总价',
	status INT COMMENT '状态：0-未支付，1-已支付，2-已取消',
	order_time DATETIME COMMENT '下单时间',
	pay_time DATETIME COMMENT '支付时间',
	created_user VARCHAR(50) COMMENT '创建人',
	created_time DATETIME COMMENT '创建时间',
	modified_user VARCHAR(50) COMMENT '最后修改人',
	modified_time DATETIME COMMENT '最后修改时间',
	PRIMARY KEY (oid)
) DEFAULT CHARSET=UTF8;
</code></pre> 
<p>创建“订单商品表”：</p> 
<pre><code>CREATE TABLE t_order_item (
	id INT AUTO_INCREMENT COMMENT 'id',
	oid INT COMMENT '归属的订单id',
	pid INT COMMENT '商品id',
	title VARCHAR(100) COMMENT '商品标题',
	image VARCHAR(500) COMMENT '商品图片',
	price BIGINT COMMENT '商品单价',
	num INT COMMENT '购买数量',
	created_user VARCHAR(50) COMMENT '创建人',
	created_time DATETIME COMMENT '创建时间',
	modified_user VARCHAR(50) COMMENT '最后修改人',
	modified_time DATETIME COMMENT '最后修改时间',
	PRIMARY KEY (id)
) DEFAULT CHARSET=UTF8;
</code></pre> 
<h4><a id="73__128"></a>73. 创建订单-创建实体类</h4> 
<p>订单实体类：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * 订单数据的实体类
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3216224344757796927</span>L<span class="token punctuation">;</span>
	
		<span class="token keyword">private</span> Integer oid<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Integer uid<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String recvName<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String recvPhone<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String recvProvince<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String recvCity<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String recvArea<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String recvAddress<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Long totalPrice<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Integer status<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Date orderTime<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Date payTime<span class="token punctuation">;</span>

		<span class="token comment">// ...</span>

	<span class="token punctuation">}</span>

订单商品实体类：

	<span class="token comment">/**
	 * 订单商品数据的实体类
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderItem</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">8879247924788259070</span>L<span class="token punctuation">;</span>
		
		<span class="token keyword">private</span> Integer id<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Integer oid<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Integer pid<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String title<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String image<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Long price<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Integer num<span class="token punctuation">;</span>

		<span class="token comment">// ...</span>

	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="74__177"></a>74. 创建订单-持久层</h4> 
<p>接口与抽象方法：</p> 
<pre><code>/**
 * 处理订单和订单商品数据的持久层接口
 */
public interface OrderMapper {

	/**
	 * 插入订单数据
	 * @param order 订单数据
	 * @return 受影响的行数
	 */
	Integer insertOrder(Order order);
	
	/**
	 * 插入订单商品数据
	 * @param orderItem 订单商品数据
	 * @return 受影响的行数
	 */
	Integer insertOrderItem(OrderItem orderItem);
	
}
</code></pre> 
<p>映射：</p> 
<pre><code class="prism language-xml">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cn.tedu.store.mapper.OrderMapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

		<span class="token comment">&lt;!-- 插入订单数据 --&gt;</span>
		<span class="token comment">&lt;!-- Integer insertOrder(Order order) --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>insertOrder<span class="token punctuation">"</span></span>
			<span class="token attr-name">useGeneratedKeys</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
			<span class="token attr-name">keyProperty</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>oid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			INSERT INTO t_order (
				uid, recv_name,
				recv_phone, recv_province,
				recv_city, recv_area,
				recv_address, total_price,
				status, order_time,
				pay_time,
				created_user, created_time,
				modified_user, modified_time
			) VALUES (
				#{uid}, #{recvName},
				#{recvPhone}, #{recvProvince},
				#{recvCity}, #{recvArea},
				#{recvAddress}, #{totalPrice},
				#{status}, #{orderTime},
				#{payTime},
				#{createdUser}, #{createdTime},
				#{modifiedUser}, #{modifiedTime}
			)
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">&gt;</span></span>
	
		<span class="token comment">&lt;!-- 插入订单商品数据 --&gt;</span>
		<span class="token comment">&lt;!-- Integer insertOrderItem(OrderItem orderItem) --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>insertOrderItem<span class="token punctuation">"</span></span>
			<span class="token attr-name">useGeneratedKeys</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
			<span class="token attr-name">keyProperty</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			INSERT INTO t_order_item (
				oid, pid,
				title, image,
				price, num,
				created_user, created_time,
				modified_user, modified_time
			) VALUES (
				#{oid}, #{pid},
				#{title}, #{image},
				#{price}, #{num},
				#{createdUser}, #{createdTime},
				#{modifiedUser}, #{modifiedTime}
			)
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">&gt;</span></span>
	
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>测试：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@SpringBootTest</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMapperTests</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token annotation punctuation">@Autowired</span>
		OrderMapper mapper<span class="token punctuation">;</span>
		
		<span class="token annotation punctuation">@Test</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			Order order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			order<span class="token punctuation">.</span><span class="token function">setUid</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			order<span class="token punctuation">.</span><span class="token function">setRecvName</span><span class="token punctuation">(</span><span class="token string">"小李同学"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			order<span class="token punctuation">.</span><span class="token function">setTotalPrice</span><span class="token punctuation">(</span><span class="token number">10086</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
			Integer rows <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">insertOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rows="</span> <span class="token operator">+</span> rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token annotation punctuation">@Test</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertOrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			OrderItem orderItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			orderItem<span class="token punctuation">.</span><span class="token function">setOid</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			orderItem<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"某手机"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			orderItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">3000</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
			orderItem<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			Integer rows <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">insertOrderItem</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rows="</span> <span class="token operator">+</span> rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="75__286"></a>75. 创建订单-业务层-基础功能</h4> 
<p>后续将需要根据收货地址的id，查询收货地址详情，需要在<code>IAddressService</code>中添加：</p> 
<pre><code>Address getByAid(Integer aid);
</code></pre> 
<p>在收货地址的业务层实现类<code>AddressServiceImpl</code>中，重写以上方法，调用已经存在的<code>findByAid()</code>私有方法即可实现。</p> 
<p>创建<code>cn.tedu.store.service.IOrderService</code>业务层接口，在接口中添加抽象方法：</p> 
<pre><code>Order create(Integer aid, Integer[] cids, Integer uid, String username);
</code></pre> 
<p>创建<code>cn.tedu.store.service.impl.OrderServiceImpl</code>业务层实现类，实现以上接口，添加<code>@Service</code>注解，在类中添加<code>@Autowired private OrderMapper orderMapper;</code>持久层对象，另外，还需要添加<code>@Autowired private IAddressService addressService;</code>收货地址的业务对象和<code>@Autowired private ICartService cartService;</code>购物车的业务对象。</p> 
<p>在实现类中添加2个私有方法，对应持久层的2个方法：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * 插入订单数据
	 * @param order 订单数据
	 * @throws InsertException 插入订单数据时出现未知错误
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">insertOrder</span><span class="token punctuation">(</span>Order order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Integer rows <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">insertOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InsertException</span><span class="token punctuation">(</span>
				<span class="token string">"创建订单失败！插入订单数据时出现未知错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/**
	 * 插入订单商品数据
	 * @param orderItem 订单商品数据
	 * @throws InsertException 插入订单商品数据时出现未知错误
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">insertOrderItem</span><span class="token punctuation">(</span>OrderItem orderItem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Integer rows <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">insertOrderItem</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InsertException</span><span class="token punctuation">(</span>
				<span class="token string">"创建订单失败！插入订单商品数据时出现未知错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>然后，重写接口中的抽象方法：</p> 
<pre><code>@Transactional
public Order create(Integer aid, Integer[] cids, Integer uid, String username) {
	// 创建当前时间对象

	// 根据参数cids，通过cartService的getByCids()查询购物车数据，得到List&lt;CartVO&gt;类型的对象
	// 遍历以上购物车数据集合对象以计算总价

	// 创建Order对象
	// 补Order对象属性：uid &gt; 参数uid
	// 根据参数aid，通过addressService的getByAid()方法查询收货地址详情
	// 补Order对象属性：recv_*
	// 补Order对象属性：total_price &gt; 以上遍历时的计算结果
	// 补Order对象属性：status &gt; 0
	// 补Order对象属性：order_time &gt; 当前时间
	// 补Order对象属性：pay_time &gt; null
	// 补Order对象属性：日志 &gt; 参数username，当前时间
	// 插入订单数据：insertOrder(order)

	// 遍历购物车数据集合对象
	// -- 创建OrderItem对象
	// -- 补OrderItem对象属性：oid &gt; order.getOid();
	// -- 补OrderItem对象属性：pid, title, image, price, num &gt; 遍历对象中的pid, title, iamge ,realPrice, num
	// -- 补OrderItem对象属性：日志 &gt; 参数username，当前时间
	// -- 插入订单商品数据：insertOrderItem(orderItem)

	// 未完，待续
}
</code></pre> 
<p>实现：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token annotation punctuation">@Transactional</span>
	<span class="token keyword">public</span> Order <span class="token function">create</span><span class="token punctuation">(</span>Integer aid<span class="token punctuation">,</span> Integer<span class="token punctuation">[</span><span class="token punctuation">]</span> cids<span class="token punctuation">,</span> Integer uid<span class="token punctuation">,</span> String username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 创建当前时间对象</span>
		Date now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 根据参数cids，通过cartService的getByCids()查询购物车数据，得到List&lt;CartVO&gt;类型的对象</span>
		List<span class="token generics function"><span class="token punctuation">&lt;</span>CartVO<span class="token punctuation">&gt;</span></span> carts <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">getByCids</span><span class="token punctuation">(</span>cids<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 遍历以上购物车数据集合对象以计算总价</span>
		Long totalPrice <span class="token operator">=</span> <span class="token number">0</span>L<span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>CartVO cart <span class="token operator">:</span> carts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			totalPrice <span class="token operator">+=</span> cart<span class="token punctuation">.</span><span class="token function">getRealPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> cart<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 创建Order对象</span>
		Order order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 补Order对象属性：uid &gt; 参数uid</span>
		order<span class="token punctuation">.</span><span class="token function">setUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 根据参数aid，通过addressService的getByAid()方法查询收货地址详情</span>
		Address address <span class="token operator">=</span> addressService<span class="token punctuation">.</span><span class="token function">getByAid</span><span class="token punctuation">(</span>aid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 补Order对象属性：recv_*</span>
		order<span class="token punctuation">.</span><span class="token function">setRecvName</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		order<span class="token punctuation">.</span><span class="token function">setRecvPhone</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		order<span class="token punctuation">.</span><span class="token function">setRecvProvince</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getProvinceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		order<span class="token punctuation">.</span><span class="token function">setRecvCity</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getCityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		order<span class="token punctuation">.</span><span class="token function">setRecvArea</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getAreaName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		order<span class="token punctuation">.</span><span class="token function">setRecvAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 补Order对象属性：total_price &gt; 以上遍历时的计算结果</span>
		order<span class="token punctuation">.</span><span class="token function">setTotalPrice</span><span class="token punctuation">(</span>totalPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 补Order对象属性：status &gt; 0</span>
		order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 补Order对象属性：order_time &gt; 当前时间</span>
		<span class="token comment">// 补Order对象属性：pay_time &gt; null</span>
		order<span class="token punctuation">.</span><span class="token function">setOrderTime</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 补Order对象属性：日志 &gt; 参数username，当前时间</span>
		order<span class="token punctuation">.</span><span class="token function">setCreatedUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
		order<span class="token punctuation">.</span><span class="token function">setCreatedTime</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
		order<span class="token punctuation">.</span><span class="token function">setModifiedUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
		order<span class="token punctuation">.</span><span class="token function">setModifiedTime</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 插入订单数据：insertOrder(order)</span>
		<span class="token function">insertOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 遍历购物车数据集合对象</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>CartVO cart <span class="token operator">:</span> carts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 创建OrderItem对象</span>
			OrderItem item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 补OrderItem对象属性：oid &gt; order.getOid();</span>
			item<span class="token punctuation">.</span><span class="token function">setOid</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getOid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 补OrderItem对象属性：pid, title, image, price, num &gt; 遍历对象中的pid, title, iamge ,realPrice, num</span>
			item<span class="token punctuation">.</span><span class="token function">setPid</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			item<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			item<span class="token punctuation">.</span><span class="token function">setImage</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			item<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getRealPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			item<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 补OrderItem对象属性：日志 &gt; 参数username，当前时间</span>
			item<span class="token punctuation">.</span><span class="token function">setCreatedUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
			item<span class="token punctuation">.</span><span class="token function">setCreatedTime</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
			item<span class="token punctuation">.</span><span class="token function">setModifiedUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
			item<span class="token punctuation">.</span><span class="token function">setModifiedTime</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 插入订单商品数据：insertOrderItem(orderItem)</span>
			<span class="token function">insertOrderItem</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 未完，待续</span>
		
		<span class="token comment">// 返回成功创建的订单对象</span>
		<span class="token keyword">return</span> order<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

测试：

	<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@SpringBootTest</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceTests</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token annotation punctuation">@Autowired</span>
		IOrderService service<span class="token punctuation">;</span>
		
		<span class="token annotation punctuation">@Test</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			Integer aid <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
			Integer<span class="token punctuation">[</span><span class="token punctuation">]</span> cids <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
			Integer uid <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
			String username <span class="token operator">=</span> <span class="token string">"购物狂"</span><span class="token punctuation">;</span>
			Order result <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>aid<span class="token punctuation">,</span> cids<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_450"></a>关于数据检查</h4> 
<p>以“用户注册”为例，用户可能需要向服务器提交例如“用户名”等相关数据，但是，每种数据都应该有对应的数据格式要求，所以，在用户提交时，需要对数据的格式进行检查。</p> 
<p>通常，在客户端就应该对数据的格式进行检查，例如在HTML中，可以使用Javascript程序对即将提交的数据进行检查，如果数据格式非法，则不会提交表单数据到服务器端。</p> 
<p>但是，即使客户端检查了数据，在服务器端收到数据的第一时间，也就是在服务器端的控制器中，仍需要对数据进行同样标准的检查！因为客户端可能是不可靠的，存在被篡改的可能！</p> 
<p>尽管服务器端会再次检查，但是，客户端的检查也是非常有必要的！因为客户端的检查可以拦截绝大部分数据格式有误的请求，从而减轻服务器端的压力。</p> 
<p>另外，在有些应用中，在业务层收到数据的第一时间，也会检查数据！因为有些数据处理并不是由客户端提交并控制器已经检查过相关数据的！例如某些计划任务等。</p> 
<p>所以：如果项目中始终是“客户端 --&gt; 控制器层 --&gt; 业务层”的处理流程，则只需要在客户端和服务器端的控制器层各执行一次相同标准的格式检查即可，如果项目中还包含某些计划任务等不是由客户端发起请求的数据处理流程，则相关的业务层也需要对数据进行检查！</p> 
<h4><a id="76__464"></a>76. 创建订单-业务层-清除购物车对应的数据</h4> 
<p>当成功的创建了订单后，还应该将购物车中匹配的数据进行删除！所以，在“创建订单”的业务中，还应该调用购物车的业务方法，执行删除，而购物车的业务层功能需要调用购物车的持久层功能来完成这项操作，所以，应该先在购物车数据的持久层<code>CartMapper.java</code>接口中开发出批量删除功能：</p> 
<pre><code>Integer deleteByCids(Integer[] cids);
</code></pre> 
<p>然后，在<code>CartMapper.xml</code>中配置映射：</p> 
<pre><code>&lt;delete id="deleteByCids"&gt;
	DELETE FROM 	
		t_cart
	WHERE 
		cid IN
		&lt;foreach collection="array"
			item="cid" separator=","
			open="(" close=")"&gt;
			#{cid}
		&lt;/foreach&gt;
&lt;/delete&gt;
</code></pre> 
<p>然后，在<code>CartMapperTests</code>中对这个功能进行测试：</p> 
<pre><code>@Test
public void deleteByCids() {
	Integer[] cids = {17,18,19,20,21};
	Integer rows = mapper.deleteByCids(cids);
	System.err.println("rows=" + rows);
}
</code></pre> 
<p>接下来，应该在<code>ICartService</code>业务层接口中添加抽象方法：</p> 
<pre><code>void delete(Integer[] cids, Integer uid);
</code></pre> 
<p>在<code>CartServiceImpl</code>业务层实现类中添加私有方法，以对应持久层中新添加的批量删除功能：</p> 
<pre><code>/**
 * 根据若干个购物车数据id删除数据
 * @param cids 若干个购物车数据id
 * @throws DeleteException 删除数据异常
 */
private void deleteByCids(Integer[] cids) {
	Integer rows = cartMapper.deleteByCids(cids);
	if (rows &lt; 1) {
		throw new DeleteException(
			"清除购物车数据失败！删除数据时发生未知错误！");
	}
}
</code></pre> 
<p>然后，重写接口中的抽象方法：</p> 
<pre><code>public void delete(Integer[] cids) {
	// 判断即将删除的数据是否存在，及数据归属是否正确
	// 可以调用自身的：List&lt;CartVO&gt; getByCids(Integer[] cids, Integer uid)，得到cid有效，且归属正确的购物车数据

	// 基于以上得到的List&lt;CartVO&gt;得到允许执行删除的cid的数组

	// 执行删除
	deleteByCids(cids);
}
</code></pre> 
<p>实现为：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span>Integer<span class="token punctuation">[</span><span class="token punctuation">]</span> cids<span class="token punctuation">,</span> Integer uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 判断即将删除的数据是否存在，及数据归属是否正确</span>
		<span class="token comment">// 可以调用自身的：List&lt;CartVO&gt; getByCids(Integer[] cids, Integer uid)，得到cid有效，且归属正确的购物车数据</span>
		List<span class="token generics function"><span class="token punctuation">&lt;</span>CartVO<span class="token punctuation">&gt;</span></span> carts <span class="token operator">=</span> <span class="token function">getByCids</span><span class="token punctuation">(</span>cids<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 判断以上查询结果的长度是否有效</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>carts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CartNotFoundException</span><span class="token punctuation">(</span>
				<span class="token string">"删除购物车数据失败！尝试访问的数据不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 基于以上得到的List&lt;CartVO&gt;得到允许执行删除的cid的数组</span>
		Integer<span class="token punctuation">[</span><span class="token punctuation">]</span> ids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span>carts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> carts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> carts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 执行删除</span>
		<span class="token function">deleteByCids</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

完成后，执行单元测试：

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteByCids</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			Integer<span class="token punctuation">[</span><span class="token punctuation">]</span> cids <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
			Integer uid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			service<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cids<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OK."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>以上功能完成后，就可以在创建订单的<code>OrderServiceImpl</code>的<code>create()</code>方法中补充删除的步骤：</p> 
<pre><code>// 删除购物车中对应的数据：cartService.deleteBy...
cartService.delete(cids, uid);
</code></pre> 
<p>以上代码可以补充在插入订单数据、插入订单商品数据之前或之后，务必保证在第1次获取购物车数据之后再执行！</p> 
<h4><a id="77__570"></a>77. 创建订单-业务层-销库存</h4> 
<p>在创建订单时，应该在商品表<code>t_product</code>中减少对应商品的库存量，首先，就需要开发“减少库存”的功能：</p> 
<pre><code>update t_product set num=? where pid=?
</code></pre> 
<p>在执行减少库存之前，还应该查询商品数据是否存在、库存量是否充足，这些都可以先通过查询功能来实现，该查询功能已经存在，无需再次开发，所以，在处理商品数据的持久层接口<code>ProductMapper.java</code>中需要添加1个抽象方法：</p> 
<pre><code>Integer updateNum(
	@Param("pid") Integer pid, 
	@Param("num") Integer num);
</code></pre> 
<p>然后，在<code>ProductMapper.xml</code>中配置以上方法的映射：</p> 
<pre><code>&lt;update id="updateNum"&gt;
	UPDATE
		t_product
	SET
		num=#{num}
	WHERE
		id=#{pid}
&lt;/update&gt;
</code></pre> 
<p>接下来处理商品数据的业务层，先创建必要的异常类：</p> 
<pre><code>ProductNotFoundException
ProductOutOfStockException
</code></pre> 
<p>在<code>IProductService</code>接口中添加抽象方法：</p> 
<pre><code>// amount：减少的数量
void reduceNum(Integer pid, Integer amount);
</code></pre> 
<p>然后，在处理商品数量的业务层实现中，先通过私有方法调用持久层的更新商品数量的功能：</p> 
<pre><code>/**
 * 更新商品的库存
 * @param pid 商品的id
 * @param num 新的库存量
 * @throws UpdateException 更新商品数量失败
 */
private void updateNum(Integer pid, Integer num) {
	Integer rows = productMapper.updateNum(pid, num);
	if (rows != 1) {
		throw new UpdateException(
			"更新商品数量失败！更新数据时出现未知错误！");
	}
}
</code></pre> 
<p>再实现接口中的抽象方法：</p> 
<pre><code>public void reduceNum(Integer pid, Integer amount) {
	// 通过参数pid查询商品数据
	// 判断查询结果是否为null：ProductNotFoundException

	// 判断查询结果中的num(当前库存)是否小于参数amount(将要购买或减少的库存量)：ProductOutOfStockException

	// 执行减少库存
}
</code></pre> 
<p>代码实现：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reduceNum</span><span class="token punctuation">(</span>Integer pid<span class="token punctuation">,</span> Integer amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 通过参数pid查询商品数据</span>
		Product result <span class="token operator">=</span> <span class="token function">findById</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 判断查询结果是否为null：ProductNotFoundException</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProductNotFoundException</span><span class="token punctuation">(</span>
				<span class="token string">"更新商品库存失败！尝试访问的商品数量不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// 暂不考虑商品下架的问题</span>

		<span class="token comment">// 判断查询结果中的num(当前库存)是否小于参数amount(将要购买或减少的库存量)：ProductOutOfStockException</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProductOutOfStockException</span><span class="token punctuation">(</span>
				<span class="token string">"更新商品库存失败！当前商品库存已经不足！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 执行减少库存</span>
		<span class="token function">updateNum</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

完成后，执行测试：

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reduceNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			Integer pid <span class="token operator">=</span> <span class="token number">10000022</span><span class="token punctuation">;</span>
			Integer amount <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
			service<span class="token punctuation">.</span><span class="token function">reduceNum</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>最后，在<code>OrderServiceImpl</code>中，添加<code>@Autowired private IProductService productService；</code>，并在<code>create()</code>方法中，在循环插入订单商品数据的同时，减少对应的商品的库存：</p> 
<pre><code>// 销库存
productService.reduceNum(cart.getPid(), cart.getNum());
</code></pre> 
<h4><a id="_674"></a>--------------------------------</h4> 
<pre><code>public class xxThread extends Thread {

	public void run() {
		Thread.sleep(15 * 60 * 1000);

		// 检查订单状态是否为0
		// -- 修改订单状态
		// -- 回库存
	}

}
### 处理超时未支付
</code></pre> 
<p>当订单生成后，用户必须在指定时间内完成支付，如果在指定时间内未支付（到达约定时间后订单状态status依然为0，0-未支付，1-已支付，2-已取消，3-关闭），则应该关闭订单，关闭时，需要将订单状态进行修改，还需要归还该订单对应的库存。</p> 
<p>更改订单状态需要执行的SQL语句大致是：</p> 
<pre><code>update t_order set status=3 where oid=?
</code></pre> 
<p>归还库存时，可以先根据购买的商品的pid查询商品数据（该功能已完成）获取商品的当前数据，再结合订单中预计购买的数据num得到最终归还后的数量，并更新商品表中该商品的数量（该功能已完成）。</p> 
<p>所以，在持久层的处理，只需要在<code>OrderMapper.java</code>中添加：</p> 
<pre><code>Integer updateStatus(Integer oid, Integer status, String username, Date modifiedTime);
</code></pre> 
<p>然后，在<code>OrderMapper.xml</code>中配置映射：</p> 
<pre><code class="prism language-xml">	<span class="token comment">&lt;!-- 修改订单状态 --&gt;</span>
	<span class="token comment">&lt;!-- Integer updateStatus(
		@Param("oid") Integer oid, 
		@Param("status") Integer status, 
		@Param("username") String username, 
		@Param("modifiedTime") Date modifiedTime) --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateStatus<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		UPDATE
			t_order
		SET
			status=#{status},
			modified_user=#{username},
			modified_time=#{modifiedTime}
		WHERE
			oid=#{oid}
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>再在<code>OrderMapperTests</code>中编写并执行单元测试：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Integer oid <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
		Integer status <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
		String username <span class="token operator">=</span> <span class="token string">"系统"</span><span class="token punctuation">;</span>
		Date modifiedTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		Integer rows <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>oid<span class="token punctuation">,</span> status<span class="token punctuation">,</span> username<span class="token punctuation">,</span> modifiedTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
		System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rows="</span> <span class="token operator">+</span> rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>然后，还需要在持久层添加“根据订单id查询订单状态”的功能：</p> 
<pre><code>Order findByOid(Integer oid);
</code></pre> 
<p>并配置该方法的映射：</p> 
<pre><code class="prism language-xml">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OrderEntityMap<span class="token punctuation">"</span></span>
		 <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cn.tedu.store.entity.Order<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>oid<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>oid<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>uid<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>uid<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recv_name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recvName<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recv_phone<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recvPhone<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recv_province<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recvProvince<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recv_city<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recvCity<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recv_area<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recvArea<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recv_address<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recvAddress<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>total_price<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>totalPrice<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>status<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>status<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>order_time<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>orderTime<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>pay_time<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>payTime<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>created_user<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createdUser<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>created_time<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createdTime<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modified_user<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modifiedUser<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modified_time<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modifiedTime<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- 根据订单id查询订单详情 --&gt;</span>
	<span class="token comment">&lt;!-- Order findByOid(Integer oid) --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findByOid<span class="token punctuation">"</span></span>
		<span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OrderEntityMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		SELECT
			*
		FROM
			t_order
		WHERE
			oid=#{oid}
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>执行单元测试：</p> 
<pre><code>@Test
public void findByOid() {
	Integer oid = 6;
	Order result = mapper.findByOid(oid);
	System.err.println(result);
}
</code></pre> 
<p>与“归还库存”相关的数据操作已完成，在持久层并不需要添加新的数据处理功能。</p> 
<p>接下来，还应该在业务层中提供“修改订单状态”、“增加商品库存”这2项功能，这2项功能合并起来，就是“归还库存”功能。</p> 
<p>关于“修改订单状态”功能，应该在<code>IOrderService</code>中添加：</p> 
<pre><code>void changeStatus(Integer oid, Integer status, String username);
</code></pre> 
<p>在<code>OrderServiceImpl</code>中先添加私有方法：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * 修改订单状态
	 * @param oid 订单id
	 * @param status 状态值，0-未支付，1-已支付，2-已取消，3-关闭
	 * @param username 修改执行人
	 * @param modifiedTime 修改时间
	 * @throws UpdateException 更新数据异常
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span>Integer oid<span class="token punctuation">,</span> Integer status<span class="token punctuation">,</span> 
		String username<span class="token punctuation">,</span> Date modifiedTime<span class="token punctuation">)</span> <span class="token keyword">throws</span> UpdateException <span class="token punctuation">{<!-- --></span>
		Integer rows <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>oid<span class="token punctuation">,</span> status<span class="token punctuation">,</span> username<span class="token punctuation">,</span> modifiedTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UpdateException</span><span class="token punctuation">(</span>
				<span class="token string">"修改订单状态失败！更新数据时出现未知错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/**
	 * 根据订单id查询订单详情
	 * @param oid 订单id
	 * @return 匹配的订单详情，如果没有匹配的数据，则返回null
	 */</span>
	<span class="token keyword">private</span> Order <span class="token function">findByOid</span><span class="token punctuation">(</span>Integer oid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> orderMapper<span class="token punctuation">.</span><span class="token function">findByOid</span><span class="token punctuation">(</span>oid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

然后，重写接口中的抽象方法：

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeStatus</span><span class="token punctuation">(</span>Integer oid<span class="token punctuation">,</span> Integer status<span class="token punctuation">,</span> String username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 根据参数oid查询订单状态</span>
		<span class="token comment">// 判断查询结果是否不存在：OrderNotFoundException</span>

		<span class="token comment">// 执行修改订单状态</span>
	<span class="token punctuation">}</span>

实现：

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeStatus</span><span class="token punctuation">(</span>Integer oid<span class="token punctuation">,</span> Integer status<span class="token punctuation">,</span> String username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 根据参数oid查询订单状态</span>
		Order result <span class="token operator">=</span> <span class="token function">findByOid</span><span class="token punctuation">(</span>oid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 判断查询结果是否不存在：OrderNotFoundException</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OrderNotFoundException</span><span class="token punctuation">(</span>
				<span class="token string">"修改订单状态失败！尝试访问的数据不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 执行修改订单状态</span>
		<span class="token function">updateStatus</span><span class="token punctuation">(</span>oid<span class="token punctuation">,</span> status<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

完成后，测试：

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			Integer oid <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
			Integer status <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
			String username <span class="token operator">=</span> <span class="token string">"系统管理员"</span><span class="token punctuation">;</span>
			service<span class="token punctuation">.</span><span class="token function">changeStatus</span><span class="token punctuation">(</span>oid<span class="token punctuation">,</span> status<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OK."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>另外，还需要添加“增加商品库存”功能，该功能所需要持久层操作已经完全完成，需要在<code>IProductService</code>中添加该功能：</p> 
<pre><code>void addNum(Integer pid, Integer amount);
</code></pre> 
<p>具体实现方式可参考此前已经完成的<code>reduceNum()</code>功能，实现代码为：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addNum</span><span class="token punctuation">(</span>Integer pid<span class="token punctuation">,</span> Integer amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 通过参数pid查询商品数据</span>
		Product result <span class="token operator">=</span> <span class="token function">findById</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 判断查询结果是否为null：ProductNotFoundException</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProductNotFoundException</span><span class="token punctuation">(</span>
				<span class="token string">"更新商品库存失败！尝试访问的商品数量不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// 暂不考虑商品下架的问题</span>
		
		<span class="token comment">// 执行增加库存</span>
		<span class="token function">updateNum</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

测试：

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			Integer pid <span class="token operator">=</span> <span class="token number">10000022</span><span class="token punctuation">;</span>
			Integer amount <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
			service<span class="token punctuation">.</span><span class="token function">addNum</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>最后，在订单的业务层接口和实现类中添加“关闭订单”的操作：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token annotation punctuation">@Transactional</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span>Integer oid<span class="token punctuation">,</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>OrderItem<span class="token punctuation">&gt;</span></span> orderItems<span class="token punctuation">,</span> String username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 检查订单状态是否是“未支付”</span>
		Order result <span class="token operator">=</span> <span class="token function">findByOid</span><span class="token punctuation">(</span>oid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 检查查询结果是否不存在</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OrderNotFoundException</span><span class="token punctuation">(</span>
				<span class="token string">"关闭订单失败！尝试访问的数据不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// 检查订单当前状态</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Status<span class="token punctuation">.</span>UNPAID<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// 将订单状态修改为已关闭</span>
		<span class="token function">changeStatus</span><span class="token punctuation">(</span>oid<span class="token punctuation">,</span> Status<span class="token punctuation">.</span>CLOSED<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 归还订单中所有商品的库存</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>OrderItem orderItem <span class="token operator">:</span> orderItems<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			productService<span class="token punctuation">.</span><span class="token function">addNum</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OrderService：订单已关闭！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

并且在`<span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`创建订单的最后，添加计划任务：

	<span class="token comment">// 开启倒计时任务(Timer/Thread)，如果用户在规定时间内未支付，则关闭订单，并归还库存</span>
	<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OrderService：计划15分钟后检查订单状态，准备关闭订单"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OrderService：准备关闭单……"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">close</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getOid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItems<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8b59972335b7acfb07de660937d0bf8f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">aardio类的例子</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/63ceae0ad9f816792141c0818473874b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GN介绍</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>