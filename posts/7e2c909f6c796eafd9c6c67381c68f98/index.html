<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>spring集成flyway - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="spring集成flyway" />
<meta property="og:description" content="最近给公司项目集成flyway，由于我们sql教程项目移动端使用的是spring框架，网上看了很多博客，感觉这方面的东西还是很少的，毕竟java基础教程现在是springboot的天下，大多数都是springboot集成flyway。但是python基础教程还是有不少公司遗留有spring框架的项目。这里就自己肝一篇，希望能帮到更c#教程多想把flyway添加到spring项目中的人。
由于使用的是spring框架。因此vb.net教程我们选择低版本的flyway。
flyway各个版本请到这里去找：https://mvnrepository.com/artifact/org.flywaydb/flyway-core
我们的maven使用的是阿里云的仓库，阿里云仓库中没有低版本的依赖，我们我们需要下载jar包。这里下载的是3.0版本的jar包。
下载的包需要拷贝到项目webapp/WEB-INF/lib中(web项目都会有WEB-INF这个文件夹，只需要找到你项目中web文件夹就行，web文件夹，就是文件夹上有个蓝点的，具体看下图的webapp文件夹)
新建资源目录resources
在其下面建立db/migration（sql文件默认读取此路径下的文件夹中的.sql文件）
在pom.xml中添加，如果不添加，resources中的文件就无法打包到war包中。
&lt;resource&gt; &lt;directory&gt;src/main/resources&lt;/directory&gt; &lt;includes&gt; &lt;include&gt;**/*&lt;/include&gt; &lt;/includes&gt; &lt;/resource&gt; 添加flyway配置类，更多配置请看源代码
package com.dt.flyway; import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; import org.flywaydb.core.Flyway; import org.flywaydb.core.api.FlywayException; import javax.naming.Context; import javax.naming.InitialContext; import javax.naming.NamingException; import javax.sql.DataSource; /** * @Description: flyway配置类 * @author: * @Date: 2021/7/12 15:57 * @Copyright: Xi&#39;an Dian Tong Software Co., Ltd. All Rights Reserved. * @Version 1.0 */ public class DatabaseFlywayMigration { protected final static Logger log = LogManager.getLogger(&#34;DatabaseFlywayMigration&#34;); public void migrate() throws NamingException { log." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7e2c909f6c796eafd9c6c67381c68f98/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-13T13:28:37+08:00" />
<meta property="article:modified_time" content="2021-07-13T13:28:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">spring集成flyway</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>最近给公司项目集成flyway，由于我们<a href="https://www.xin3721.com/eschool/SQLxin3721/" rel="nofollow"><span style="color:#494949;">sql教程</span></a>项目移动端使用的是spring框架，网上看了很多博客，感觉这方面的东西还是很少的，毕竟<a href="https://www.xin3721.com/eschool/Javaxin3721/" rel="nofollow"><span style="color:#494949;">java基础教程</span></a>现在是springboot的天下，大多数都是springboot集成flyway。但是<a href="https://www.xin3721.com/eschool/pythonxin3721/" rel="nofollow"><span style="color:#494949;">python基础教程</span></a>还是有不少公司遗留有spring框架的项目。这里就自己肝一篇，希望能帮到更<a href="https://www.xin3721.com/eschool/CSharpxin3721/" rel="nofollow"><span style="color:#494949;">c#教程</span></a>多想把flyway添加到spring项目中的人。</p> 
<p></p> 
<p>由于使用的是spring框架。因此<a href="https://www.xin3721.com/eschool/VBNetxin3721/" rel="nofollow"><span style="color:#494949;">vb.net教程</span></a>我们选择低版本的flyway。</p> 
<p>flyway各个版本请到这里去找：https://mvnrepository.com/artifact/org.flywaydb/flyway-core<br> 我们的maven使用的是阿里云的仓库，阿里云仓库中没有低版本的依赖，我们我们需要下载jar包。这里下载的是3.0版本的jar包。</p> 
<p><br> 下载的包需要拷贝到项目webapp/WEB-INF/lib中(web项目都会有WEB-INF这个文件夹，只需要找到你项目中web文件夹就行，web文件夹，就是文件夹上有个蓝点的，具体看下图的webapp文件夹)<br><img alt="" src="https://images2.imgbox.com/7e/e6/f9eszqG7_o.png"></p> 
<p></p> 
<p><br> 新建资源目录resources<br> 在其下面建立db/migration（sql文件默认读取此路径下的文件夹中的.sql文件）<br><img alt="" src="https://images2.imgbox.com/88/b3/RLjupFsX_o.png"></p> 
<p><br> 在pom.xml中添加，如果不添加，resources中的文件就无法打包到war包中。</p> 
<pre>    &lt;resource&gt;
                &lt;directory&gt;src/main/resources&lt;/directory&gt;
                &lt;includes&gt;
                    &lt;include&gt;**/*&lt;/include&gt;
                &lt;/includes&gt;
    &lt;/resource&gt;</pre> 
<p><br> 添加flyway配置类，更多配置请看源代码</p> 
<p><img alt="复制代码" src="https://images2.imgbox.com/9d/ad/Emh11lpg_o.png"></p> 
<pre>package com.dt.flyway;


import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.flywaydb.core.Flyway;
import org.flywaydb.core.api.FlywayException;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import javax.sql.DataSource;


/**
 * @Description: flyway配置类
 * @author: 
 * @Date: 2021/7/12 15:57
 * @Copyright: Xi'an Dian Tong Software Co., Ltd. All Rights Reserved.
 * @Version 1.0
 */
public class DatabaseFlywayMigration {
    protected final static Logger log = LogManager.getLogger("DatabaseFlywayMigration");

    public void migrate() throws NamingException {
        log.info("DatabaseFlywayMigration--&gt;migrate:flyway开始执行，准备获取数据源");
        Context context = new InitialContext();
        //获取tomcat中的数据源
        DataSource dataSource = (DataSource) context.lookup("java:comp/env/jdbc/wxi");
        log.info("DatabaseFlywayMigration--&gt;migrate:获取数据源成功，准备执行flyway配置");
        Flyway flyway = new Flyway();
        // 设置sql脚本文件的编码
        flyway.setEncoding("UTF-8");
        flyway.setOutOfOrder(true);
        flyway.setDataSource(dataSource);
        // 设置接受flyway进行版本管理的多个数据库
        //flyway.setSchemas("flywaydemo");
        // 设置存放flyway metadata数据的表名
         flyway.setTable("flyway_schema_history");
        // 设置执行migrate操作之前的validation行为
        //flyway.setValidationMode(ValidationMode.ALL);
        // 设置当validation失败时的系统行为
        //flyway.setValidationErrorMode(ValidationErrorMode.FAIL);

        // 设置当validation失败时的系统行为
        try {
            flyway.setInitOnMigrate(true);
            log.info("DatabaseFlywayMigration--&gt;migrate:配置成功,即将执行sql语句");
            flyway.migrate();
            log.info("DatabaseFlywayMigration--&gt;migrate:sql语句执行成功,flyway---END");
        } catch (FlywayException e) {
            log.error("DatabaseFlywayMigration--&gt;migrate:执行sql语句失败,请查看日志排查错误");
            flyway.repair();
            e.printStackTrace();
        }
    }
}</pre> 
<p><img alt="复制代码" src="https://images2.imgbox.com/83/27/ZS9HHsKR_o.png"></p> 
<p><br> 在spring的xml中注入flyway配置类的bean(每个spring项目都会带有一个xml文件，用来注册bean，复制的时候注意项目中DatabaseFlywayMigration所在的路径)</p> 
<pre> &lt;!-- flayway --&gt;
&lt;bean id="flywayMigration1" class="com.dt.flyway.DatabaseFlywayMigration" lazy-init="false" init-method="migrate"&gt; &lt;/bean&gt;</pre> 
<p><br><img alt="" src="https://images2.imgbox.com/ea/6f/idW390oB_o.png"><br><br> 到这里，移动端整合flyway就完成了。<br> 以后这些sql语句，只需要放到resources/db/migration文件夹下面即可(但是这些sql命名都是不符合flyway的，需要进行名称的修改)<br><br><img alt="" src="https://images2.imgbox.com/fa/44/OpmwxxXm_o.png"></p> 
<p><br><strong>命名规则:</strong><br> 此处的SQL语句命名需要遵从一定的规范，否则运行的时候flyway会报错。命名规则主要有两种：<br><br>     仅需要被执行一次的SQL命名以大写的”V”开头，后面跟上”0~9”数字的组合,数字之间可以用“.”或者下划线”“分割开，然后再以两个下划线 _ 分割，其后跟文件名称，最后以.sql结尾。比如，V20210707__create_user.sql、V20210707__add_user.sql。<br>     可重复运行的SQL，则以大写的“R”开头，后面再以两个下划线分割，其后跟文件名称，最后以.sql结尾。。比如，R__truncate_user_dml.sql。<br><br> 其中，V开头的SQL执行优先级要比R开头的SQL优先级高。<br><br> V:固定大写<br><br> 20210707.01：20210707是日期，后面用.01代表序号<br><br> 因为flyway的执行是有个顺序的，比如你执行了V2021__create_user，有执行V2020_update_user。就会报错，原因就是2020&lt;2021。所以我们要保证序号是依次增大。<br><br> Flyway 是如何比较两个 SQL 文件的先后顺序呢？它采用 采用左对齐原则, 缺位用 0 代替 。举几个例子：</p> 
<pre>    1.0.1.1 比 1.0.1 版本高。
    1.0.10 比 1.0.9.4 版本高。
    1.0.10 和 1.0.010 版本号一样高, 每个版本号部分的前导 0 会被忽略。</pre> 
<p>    __:这个是两个 _<br>     例如：<br>     V2.0.9__upgrade.sql<br>     V2.0.11__upgrade.sql<br>     V2.0.13__upgrade.sql<br>     V2.0.14__upgrade.sql</p> 
<p>作者：天下没有收费的bug</p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c2c904f61b06cad0bc4ae364a192e343/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">进程和内存关系</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/22e042262ddcd2f6e5226c3615fd1370/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决TOMCAT乱码问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>