<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[MT8167S][Android 9.0]MTK平台的LCM流程分析——lk层 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[MT8167S][Android 9.0]MTK平台的LCM流程分析——lk层" />
<meta property="og:description" content="前言 在MTK平台点亮一块屏不是难事，因为MTK的LCM框架很完善，我们的屏驱动需要的工作不是很多。不过要想成为一个优秀的工程师，不能仅仅满足于此，至少要了解整个框架流程。
MTK平台的lcm流程分为Lk和kernel两个阶段，这篇文章我们先来分析lk阶段的流程。
正文 lk阶段起来后，display相关的初始化主要在platform_init()函数中完成。
vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\platform.c
void disp_thread_routine() { #ifdef LK_PROFILING unsigned int time_disp_init; time_disp_init = get_timer(0); #endif /* initialize the frame buffet information */ g_fb_size = mt_disp_get_vram_size(); --------------------- （1） /* framebuffer的起始地址 */ g_fb_base = mblock_reserve(&amp;g_boot_arg-&gt;mblock_info, g_fb_size, 0x10000, 0x100000000, RANKMAX); dprintf(CRITICAL, &#34;FB base = 0x%x, FB size = %d\n&#34;, g_fb_base, g_fb_size); #ifdef VDEC_LDVT_RESERVED_MEMORY_SIZE g_vdec_base = mblock_reserve(&amp;g_boot_arg-&gt;mblock_info, VDEC_LDVT_RESERVED_MEMORY_SIZE, 0x200000, 0x100000000, RANKMAX); g_vdec_base = ALIGN_TO(g_vdec_base,0x200000); dprintf(CRITICAL, &#34;VDEC base = 0x%x, VDEC size = %d\n&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1fba60974910a753c17ffb7caabbf65f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-15T15:57:04+08:00" />
<meta property="article:modified_time" content="2020-12-15T15:57:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[MT8167S][Android 9.0]MTK平台的LCM流程分析——lk层</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>前言</h3> 
<p>在MTK平台点亮一块屏不是难事，因为MTK的LCM框架很完善，我们的屏驱动需要的工作不是很多。不过要想成为一个优秀的工程师，不能仅仅满足于此，至少要了解整个框架流程。</p> 
<p>MTK平台的lcm流程分为Lk和kernel两个阶段，这篇文章我们先来分析lk阶段的流程。</p> 
<h3><a id="_6"></a>正文</h3> 
<p>lk阶段起来后，display相关的初始化主要在platform_init()函数中完成。</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\platform.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">disp_thread_routine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> LK_PROFILING</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> time_disp_init<span class="token punctuation">;</span>
	time_disp_init <span class="token operator">=</span> <span class="token function">get_timer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token comment">/* initialize the frame buffet information */</span>
	g_fb_size <span class="token operator">=</span> <span class="token function">mt_disp_get_vram_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> （<span class="token number">1</span>）

    <span class="token comment">/* framebuffer的起始地址 */</span>
	g_fb_base <span class="token operator">=</span> <span class="token function">mblock_reserve</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_boot_arg<span class="token operator">-&gt;</span>mblock_info<span class="token punctuation">,</span> g_fb_size<span class="token punctuation">,</span> <span class="token number">0x10000</span><span class="token punctuation">,</span> <span class="token number">0x100000000</span><span class="token punctuation">,</span> RANKMAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">dprintf</span><span class="token punctuation">(</span>CRITICAL<span class="token punctuation">,</span> <span class="token string">"FB base = 0x%x, FB size = %d\n"</span><span class="token punctuation">,</span> g_fb_base<span class="token punctuation">,</span> g_fb_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> VDEC_LDVT_RESERVED_MEMORY_SIZE</span>
	g_vdec_base <span class="token operator">=</span> <span class="token function">mblock_reserve</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_boot_arg<span class="token operator">-&gt;</span>mblock_info<span class="token punctuation">,</span> VDEC_LDVT_RESERVED_MEMORY_SIZE<span class="token punctuation">,</span> <span class="token number">0x200000</span><span class="token punctuation">,</span> <span class="token number">0x100000000</span><span class="token punctuation">,</span> RANKMAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	g_vdec_base <span class="token operator">=</span> <span class="token function">ALIGN_TO</span><span class="token punctuation">(</span>g_vdec_base<span class="token punctuation">,</span><span class="token number">0x200000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">dprintf</span><span class="token punctuation">(</span>CRITICAL<span class="token punctuation">,</span> <span class="token string">"VDEC base = 0x%x, VDEC size = %d\n"</span><span class="token punctuation">,</span> g_vdec_base<span class="token punctuation">,</span> <span class="token number">0x10000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token function">mt_disp_init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>g_fb_base<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> （<span class="token number">2</span>）
	<span class="token comment">/* show black picture fisrtly in case of  backlight is on before nothing is drawed*/</span>
	<span class="token function">mt_disp_fill_rect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> CFG_DISPLAY_WIDTH<span class="token punctuation">,</span> CFG_DISPLAY_HEIGHT<span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> （<span class="token number">3</span>）
	<span class="token function">mt_disp_update</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> CFG_DISPLAY_WIDTH<span class="token punctuation">,</span> CFG_DISPLAY_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将framebuffer的数据更新到LCM</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> LK_PROFILING</span>
	<span class="token function">dprintf</span><span class="token punctuation">(</span>INFO<span class="token punctuation">,</span> <span class="token string">"[PROFILE] ------- disp init takes %d ms -------- \n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">get_timer</span><span class="token punctuation">(</span>time_disp_init<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token function">drv_video_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment"> EVENT</span>
	<span class="token function">event_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>disp_ready_event<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">platform_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment"> THREAD CREATE</span>
	<span class="token function">thread_resume</span><span class="token punctuation">(</span><span class="token function">thread_create</span><span class="token punctuation">(</span><span class="token string">"disp"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>disp_thread_routine<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> DEFAULT_PRIORITY<span class="token punctuation">,</span> DEFAULT_STACK_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（1）</p> 
<p>首先是获取framebuffer的大小：</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\primary_display.c</p> 
</blockquote> 
<pre><code class="prism language-c">UINT32 <span class="token function">DISP_GetFBRamSize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">ALIGN_TO</span><span class="token punctuation">(</span><span class="token function">DISP_GetScreenWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MTK_FB_ALIGNMENT<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">DISP_GetScreenHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">DISP_GetScreenBpp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">DISP_GetPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">DISP_GetVRamSize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> UINT32 vramSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> vramSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		vramSize <span class="token operator">=</span> <span class="token function">DISP_GetFBRamSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		vramSize <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">DAL_GetLayerSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> 1</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>g_is_64bit_kernel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			vramSize <span class="token operator">=</span> <span class="token function">ALIGN_TO</span><span class="token punctuation">(</span>vramSize<span class="token punctuation">,</span> <span class="token number">0x400000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// both start addr and size needs 2MB align, so size must 4MB align</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			vramSize <span class="token operator">=</span> <span class="token function">ALIGN_TO</span><span class="token punctuation">(</span>vramSize<span class="token punctuation">,</span> <span class="token number">0x100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// both start addr and size needs 2MB align, so size must 4MB align</span>
		<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
		vramSize <span class="token operator">=</span> <span class="token function">ALIGN_TO</span><span class="token punctuation">(</span>vramSize<span class="token punctuation">,</span> <span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// just align to 64KB is OK</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

		<span class="token function">DISPMSG</span><span class="token punctuation">(</span><span class="token string">"^^ DISP_GetVRamSize: %u bytes\n"</span><span class="token punctuation">,</span> vramSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> vramSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>先调用DISP_GetFBRamSize()去计算整个buffer的大小，这就涉及到screen的width、height和bpp的值了。我们先看一下怎么获取width值：</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\primary_display.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">primary_display_get_width</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pgc<span class="token operator">-&gt;</span>plcm <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		pgc<span class="token operator">-&gt;</span>plcm <span class="token operator">=</span> <span class="token function">disp_lcm_probe</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> LCM_INTERFACE_NOTDEFINED<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">DISPMSG</span><span class="token punctuation">(</span><span class="token string">"lcm handle is null, after probe:0x%08x\n"</span><span class="token punctuation">,</span>pgc<span class="token operator">-&gt;</span>plcm<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pgc<span class="token operator">-&gt;</span>plcm <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>pgc<span class="token operator">-&gt;</span>plcm<span class="token operator">-&gt;</span>params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> pgc<span class="token operator">-&gt;</span>plcm<span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">DISPERR</span><span class="token punctuation">(</span><span class="token string">"lcm_params is null!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

UINT32 <span class="token function">DISP_GetScreenWidth</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">primary_display_get_width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于第一次注册，所以pgc-&gt;plcm是NULL，就先调用disp_lcm_probe()注册我们的lcm模块：</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\disp_lcm.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">_lcm_count</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> lcm_count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

disp_lcm_handle <span class="token operator">*</span><span class="token function">disp_lcm_probe</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>plcm_name<span class="token punctuation">,</span> LCM_INTERFACE_ID lcm_id<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DISPFUNC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	bool isLCMFound <span class="token operator">=</span> false<span class="token punctuation">;</span>
	bool isLCMConnected <span class="token operator">=</span> false<span class="token punctuation">;</span>
	bool isDriverIDFound <span class="token operator">=</span> false<span class="token punctuation">;</span>

	LCM_DRIVER <span class="token operator">*</span>lcm_drv <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	LCM_PARAMS <span class="token operator">*</span>lcm_param <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	disp_lcm_handle <span class="token operator">*</span>plcm <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_lcm_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">DISPERR</span><span class="token punctuation">(</span><span class="token string">"no lcm driver defined in linux kernel driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_lcm_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>  （<span class="token number">1.1</span>）
		lcm_drv <span class="token operator">=</span> lcm_driver_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		isLCMFound <span class="token operator">=</span> true<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>isLCMFound <span class="token operator">==</span> false<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">DISPERR</span><span class="token punctuation">(</span><span class="token string">"FATAL ERROR!!!No LCM Driver defined\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	plcm <span class="token operator">=</span> <span class="token operator">&amp;</span>_disp_lcm_driver<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	lcm_param <span class="token operator">=</span> <span class="token operator">&amp;</span>_disp_lcm_params<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>plcm <span class="token operator">&amp;&amp;</span> lcm_param<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		plcm<span class="token operator">-&gt;</span>params <span class="token operator">=</span> lcm_param<span class="token punctuation">;</span>
		plcm<span class="token operator">-&gt;</span>drv <span class="token operator">=</span> lcm_drv<span class="token punctuation">;</span> <span class="token comment">//指向我们自定义的LCM_DRIVER</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">DISPERR</span><span class="token punctuation">(</span><span class="token string">"FATAL ERROR!!!kzalloc plcm and plcm-&gt;params failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> FAIL<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">if</span> defined(MTK_LCM_DEVICE_TREE_SUPPORT)</span>
	<span class="token function">load_lcm_resources_from_DT</span><span class="token punctuation">(</span>plcm<span class="token operator">-&gt;</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	plcm<span class="token operator">-&gt;</span>drv<span class="token operator">-&gt;</span><span class="token function">get_params</span><span class="token punctuation">(</span>plcm<span class="token operator">-&gt;</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> （<span class="token number">1.2</span>）
	plcm<span class="token operator">-&gt;</span>lcm_if_id <span class="token operator">=</span> plcm<span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>lcm_if<span class="token punctuation">;</span> <span class="token comment">//get_params中没有设置</span>
	<span class="token comment">/* below code is for lcm driver forward compatible */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>plcm<span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>type <span class="token operator">==</span> LCM_TYPE_DSI <span class="token operator">&amp;&amp;</span> plcm<span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>lcm_if <span class="token operator">==</span> LCM_INTERFACE_NOTDEFINED<span class="token punctuation">)</span>
		plcm<span class="token operator">-&gt;</span>lcm_if_id <span class="token operator">=</span> LCM_INTERFACE_DSI0<span class="token punctuation">;</span> <span class="token comment">//get_params函数中可以看到设置为了DSI类型</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>plcm<span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>type <span class="token operator">==</span> LCM_TYPE_DPI <span class="token operator">&amp;&amp;</span> plcm<span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>lcm_if <span class="token operator">==</span> LCM_INTERFACE_NOTDEFINED<span class="token punctuation">)</span>
		plcm<span class="token operator">-&gt;</span>lcm_if_id <span class="token operator">=</span> LCM_INTERFACE_DPI0<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>plcm<span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>type <span class="token operator">==</span> LCM_TYPE_DBI <span class="token operator">&amp;&amp;</span> plcm<span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>lcm_if <span class="token operator">==</span> LCM_INTERFACE_NOTDEFINED<span class="token punctuation">)</span>
		plcm<span class="token operator">-&gt;</span>lcm_if_id <span class="token operator">=</span> LCM_INTERFACE_DBI0<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 1</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>LCM_TYPE_DSI <span class="token operator">==</span> plcm<span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		disp_path_handle handle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">char</span> buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		handle <span class="token operator">=</span> <span class="token function">_display_interface_path_init</span><span class="token punctuation">(</span>plcm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//暂时不分析</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
		<span class="token function">_display_interface_path_deinit</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	plcm<span class="token operator">-&gt;</span>is_connected <span class="token operator">=</span> isLCMConnected<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token function">_dump_lcm_info</span><span class="token punctuation">(</span>plcm<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> plcm<span class="token punctuation">;</span>

FAIL<span class="token punctuation">:</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（1.1）</p> 
<p>首先就是获取你注册的lcm驱动的数量，正常都是只注册一个，也就是你移植的屏驱动：</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\dev\lcm\mt65xx_lcm_list.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">extern</span> LCM_DRIVER hn116wx1_100_dsi_edp_A15_A17_lcm_drv<span class="token punctuation">;</span>

LCM_DRIVER <span class="token operator">*</span>lcm_driver_list<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined(HN116WX1_100_DSI_EDP_A15_A17)</span>
		<span class="token operator">&amp;</span>hn116wx1_100_dsi_edp_A15_A17_lcm_drv<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> lcm_count <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>lcm_driver_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>LCM_DRIVER <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在调试一款新的屏，MTK平台是有特定的套路的，比如这里就要我们自己的屏驱动LCM_DRIVER填充到lcm_driver_list列表中。而HN116WX1_100_DSI_EDP_A15_A17是在device/mediatek/mt8167/ProjectConfig.mk中的CUSTOM_LK_LCM和CUSTOM_UBOOT_LCM定义的。现在看一下我们实现的LCM_DRIVER hn116wx1_100_dsi_edp_A15_A17_lcm_drv。</p> 
<p>首先我们需要在vendor/mediatek/proprietary/bootable/bootloader/lk/dev/lcm/目录新建我们驱动的目录，比如我的代码目录HN116WX1_100_DSI_EDP_A15_A17，这个要和CUSTOM_LK_LCM定义的一致，否则编译不到我们的驱动。</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\dev\lcm\HN116WX1_100_DSI_EDP_A15_A17\HN116WX1_100_DSI_EDP_A15_A17.c</p> 
</blockquote> 
<pre><code class="prism language-c">LCM_DRIVER hn116wx1_100_dsi_edp_A15_A17_lcm_drv <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>name           <span class="token operator">=</span> <span class="token string">"hn116wx1_100_dsi_edp_A15_A17"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>set_util_funcs <span class="token operator">=</span> lcm_set_util_funcs<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>get_params     <span class="token operator">=</span> lcm_get_params<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>init           <span class="token operator">=</span> lcm_init<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>init_power     <span class="token operator">=</span> lcm_init_power<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>suspend        <span class="token operator">=</span> lcm_suspend<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>resume         <span class="token operator">=</span> lcm_resume<span class="token punctuation">,</span>
    <span class="token comment">//.esd_check      = IT6151_ESD_Check,</span>
    <span class="token comment">//.esd_recover    = IT6151_ESD_Recover,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>我们需要填充LCM_DRIVER结构体的成员，主要包括初始化、参数获取、睡眠和唤醒等函数。函数的具体作用我们后面再讲。</p> 
<p>（1.2）</p> 
<p>这一步就是调用我们屏驱动的.get_params函数，并赋值给变量_disp_lcm_params</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\dev\lcm\HN116WX1_100_DSI_EDP_A15_A17\HN116WX1_100_DSI_EDP_A15_A17.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">lcm_get_params</span><span class="token punctuation">(</span>LCM_PARAMS <span class="token operator">*</span>params<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">memset</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>LCM_PARAMS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    params<span class="token operator">-&gt;</span>type   <span class="token operator">=</span> LCM_TYPE_DSI<span class="token punctuation">;</span>

    params<span class="token operator">-&gt;</span>width  <span class="token operator">=</span> FRAME_WIDTH<span class="token punctuation">;</span>
    params<span class="token operator">-&gt;</span>height <span class="token operator">=</span> FRAME_HEIGHT<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> (LCM_DSI_CMD_MODE)</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>mode   <span class="token operator">=</span> CMD_MODE<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>mode   <span class="token operator">=</span> SYNC_PULSE_VDO_MODE<span class="token punctuation">;</span><span class="token comment">//SYNC_PULSE_VDO_MODE; //BURST_VDO_MODE; //SYNC_EVENT_VDO_MODE;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>LANE_NUM                <span class="token operator">=</span> LCM_FOUR_LANE<span class="token punctuation">;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>data_format<span class="token punctuation">.</span>format      <span class="token operator">=</span> LCM_DSI_FORMAT_RGB888<span class="token punctuation">;</span><span class="token comment">//LCM_DSI_FORMAT_RGB888;</span>

    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>PS <span class="token operator">=</span> LCM_PACKED_PS_24BIT_RGB888<span class="token punctuation">;</span> <span class="token comment">//LCM_PACKED_PS_24BIT_RGB888;//LCM_LOOSELY_PS_18BIT_RGB666;//LCM_PACKED_PS_18BIT_RGB666;</span>

    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>vertical_sync_active                <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">//4; //6; //(12-4-4); //1;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>vertical_backporch                  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//8; //6; //4; //6; //10;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>vertical_frontporch                 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//8;//6; //4//6; //10;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>vertical_active_line                <span class="token operator">=</span> FRAME_HEIGHT<span class="token punctuation">;</span>

    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>horizontal_sync_active              <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span><span class="token comment">//4; //40; //44; //(120-40-40); //1;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>horizontal_backporch                <span class="token operator">=</span> <span class="token number">65</span><span class="token punctuation">;</span><span class="token comment">//60;//43;//44; //40; //44; //57;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>horizontal_frontporch               <span class="token operator">=</span> <span class="token number">65</span><span class="token punctuation">;</span><span class="token comment">//60;//45;//108;//44; //40; //44; //32;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>horizontal_active_pixel             <span class="token operator">=</span> FRAME_WIDTH<span class="token punctuation">;</span>

    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>PLL_CLOCK <span class="token operator">=</span> <span class="token number">440</span><span class="token punctuation">;</span><span class="token comment">//180;//216;//240;//LCM_DSI_6589_PLL_CLOCK_NULL; //LCM_DSI_6589_PLL_CLOCK_396_5;</span>

    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>cont_clock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>ssc_disable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>edp_panel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里的参数都非常重要，设置不对就会影响屏幕点亮，我们分别了解一下各参数的意义。</p> 
<p>（a）LCM_TYPE_DSI</p> 
<p>MIPI标准中有DBI、DPI和DSI三种display接口，我们平台的显示屏是DSI接口的</p> 
<p>（b）FRAME_WIDTH和FRAME_HEIGHT</p> 
<p>显示屏的分辨率参数，比如我们平台的是1920*1080</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">define</span> FRAME_WIDTH  (1920) </span><span class="token comment">//(800)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FRAME_HEIGHT (1080) </span><span class="token comment">//(1280)</span>
</code></pre> 
<p>（c）SYNC_PULSE_VDO_MODE</p> 
<p>首先介绍一下，DSI的两种基本的操作模式：命令模式（Command Mode）和视频模式（Video Mode）。顾名思义，命令模式主要是用来进行命令操作的，如应用处理器向显示设备（如LCD）发送相关命令，显示设备返回对应的相关数据。显然，命令模式需要双向的数据通道，即需要Data Lane支持Bidirectional模式。视频模式则是用来传输用于显示的视频或图像数据的，且视频信息只能在HS模式下进行传输。</p> 
<p>因此，我们这里的dsi.mode设置为视频模式，而视频模式又分三种子模式：</p> 
<ul><li> <p>Non-Busrt Mode with Sync Pluses</p> </li><li> <p>Non-Burst Mode with Sync Events</p> </li><li> <p>Burst Mode</p> </li></ul> 
<p>下图是这三种模式的时序图：<br> <img src="https://images2.imgbox.com/d6/ac/Kqlos536_o.png" alt="在这里插入图片描述"></p> 
<p>Non-Busrt Mode with Sync Pluses模式主要是用于发送DPI（Display Pixel Interface）类型的数据，可以精确地匹配DPI的像素传输速率，以及时序事件的宽度（Widths of timing events），如同步脉冲。因此，Non-Busrt Mode with Sync Pluses模式的每一个Sync Start都必须都要有一个唯一的Sync End与之对应，比如VS都对应一个VSE，HSS都对应一个HSE。</p> 
<p>Non-Busrt Mode with Sync Events模式与Non-Busrt Mode with Sync Pluses模式类似，可以认为前者是后者的简化版本。因为Non-Busrt Mode with Sync Events模式不需要精确控制时序事件的宽度，所以Non-Busrt Mode with Sync Events只有Sync Start，而没有Sync End，所以只有VS和和HSS，没有对应的VSE和HSE。</p> 
<p>Burst Mode相比于Non-Burst Mode with Sync Events模式，可以更快完成一帧（或一行）图像像素的传输，因此可以节省更多的时间以进入LP模式，进而降低系统的功耗。但是，需要注意的是，Burst Mode需要使用的是经过时序压缩的数据格式（Time-compressed burst format），所以上图中Burst Mode的HACT部分会比Non-Burst Mode with Sync Events的短。<br> <img src="https://images2.imgbox.com/40/b4/Z5Jgk01i_o.png" alt="在这里插入图片描述"></p> 
<p>再回到我们自己的平台，一般情况我们的panel IC的datasheet会注明支持哪种模式：<br> <img src="https://images2.imgbox.com/4a/06/2qOO0KvR_o.png" alt="在这里插入图片描述"></p> 
<p>从上面的datasheet可以看出来，我这个panel IC同时支持3种video mode，这里我们通过宏SYNC_PULSE_VDO_MODE，将video mode设置为Non-Busrt Mode with Sync Pluses。</p> 
<p>（d）LCM_DSI_FORMAT_RGB888和LCM_PACKED_PS_24BIT_RGB888</p> 
<p>这个主要看panel IC支持什么格式，设置对应的格式就好。</p> 
<p>（e）“vertical_<em>"和"horizontal_</em>”</p> 
<pre><code class="prism language-c">    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>vertical_sync_active                <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">//4; //6; //(12-4-4); //1;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>vertical_backporch                  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//8; //6; //4; //6; //10;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>vertical_frontporch                 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//8;//6; //4//6; //10;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>vertical_active_line                <span class="token operator">=</span> FRAME_HEIGHT<span class="token punctuation">;</span>

    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>horizontal_sync_active              <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span><span class="token comment">//4; //40; //44; //(120-40-40); //1;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>horizontal_backporch                <span class="token operator">=</span> <span class="token number">65</span><span class="token punctuation">;</span><span class="token comment">//60;//43;//44; //40; //44; //57;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>horizontal_frontporch               <span class="token operator">=</span> <span class="token number">65</span><span class="token punctuation">;</span><span class="token comment">//60;//45;//108;//44; //40; //44; //32;</span>
    params<span class="token operator">-&gt;</span>dsi<span class="token punctuation">.</span>horizontal_active_pixel             <span class="token operator">=</span> FRAME_WIDTH<span class="token punctuation">;</span>
</code></pre> 
<p>这几个参数非常重要，不过我们可以很容易的向panel厂家获得。</p> 
<p>（f）dsi.PLL_CLOCK</p> 
<p>这个频率可以根据(e)提到的前后肩参数算出来，可以参考这篇文章：</p> 
<p>disp_lcm_probe()函数走完后，我们也就能获得screen的width值。我们再回到DISP_GetFBRamSize()函数：</p> 
<pre><code class="prism language-c">UINT32 <span class="token function">DISP_GetFBRamSize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">ALIGN_TO</span><span class="token punctuation">(</span><span class="token function">DISP_GetScreenWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MTK_FB_ALIGNMENT<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">DISP_GetScreenHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">DISP_GetScreenBpp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">DISP_GetPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同理，DISP_GetScreenHeight()和获取width值一样，都是在lcm_get_params()里面设置的。DISP_GetScreenBpp()设置了一个固定的BPP值为32，DISP_GetPages()的含义不是很清楚，不过从注释来看是设置了需要内存两倍大小的framebuffer？</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> UINT32 disp_fb_bpp <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>     <span class="token comment">///ARGB8888</span>
<span class="token keyword">static</span> UINT32 disp_fb_pages <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>     <span class="token comment">///double buffer</span>
UINT32 <span class="token function">DISP_GetScreenBpp</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> disp_fb_bpp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

UINT32 <span class="token function">DISP_GetPages</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> disp_fb_pages<span class="token punctuation">;</span>   <span class="token comment">// Double Buffers</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（2）</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\mt_disp_drv.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">mt_disp_init</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>lcdbase<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">primary_display_init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>mt_disp_init()顾名思义就是初始化显示相关的东西</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\primary_display.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">primary_display_init</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>lcm_name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    ret <span class="token operator">=</span> <span class="token function">disp_lcm_init</span><span class="token punctuation">(</span>pgc<span class="token operator">-&gt;</span>plcm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>disp_lcm_init()函数就是调用我们自己LCM驱动LCM_DRIVER中定义的函数</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\disp_lcm.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">disp_lcm_init</span><span class="token punctuation">(</span>disp_lcm_handle <span class="token operator">*</span>plcm<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DISPFUNC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCM_DRIVER <span class="token operator">*</span>lcm_drv <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	bool isLCMConnected <span class="token operator">=</span> false<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_is_lcm_inited</span><span class="token punctuation">(</span>plcm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		lcm_drv <span class="token operator">=</span> plcm<span class="token operator">-&gt;</span>drv<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>lcm_drv<span class="token operator">-&gt;</span>init_power<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			lcm_drv<span class="token operator">-&gt;</span><span class="token function">init_power</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>lcm_drv<span class="token operator">-&gt;</span>init<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">disp_lcm_is_inited</span><span class="token punctuation">(</span>plcm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				lcm_drv<span class="token operator">-&gt;</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">DISPERR</span><span class="token punctuation">(</span><span class="token string">"FATAL ERROR, lcm_drv-&gt;init is null\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">DISPERR</span><span class="token punctuation">(</span><span class="token string">"plcm is null\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再回忆一下我们的LCM驱动：</p> 
<pre><code class="prism language-c">LCM_DRIVER hn116wx1_100_dsi_edp_A15_A17_lcm_drv <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>name           <span class="token operator">=</span> <span class="token string">"hn116wx1_100_dsi_edp_A15_A17"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>set_util_funcs <span class="token operator">=</span> lcm_set_util_funcs<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>get_params     <span class="token operator">=</span> lcm_get_params<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>init           <span class="token operator">=</span> lcm_init<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>init_power     <span class="token operator">=</span> lcm_init_power<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>suspend        <span class="token operator">=</span> lcm_suspend<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>resume         <span class="token operator">=</span> lcm_resume<span class="token punctuation">,</span>
    <span class="token comment">//.esd_check      = IT6151_ESD_Check,</span>
    <span class="token comment">//.esd_recover    = IT6151_ESD_Recover,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>所以lcm_drv-&gt;init_power()其实就是调用的lcm_init_power，不过我们这个函数为空，没有实际动作。然后就是lcm_drv-&gt;init()初始化LCM，一般就是给LCM下发init code：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> LCM_setting_table lcm_initialization_setting<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
 
       <span class="token punctuation">{<!-- --></span><span class="token number">0xB0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x01</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//含义：命令, 参数个数, 参数</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token punctuation">{<!-- --></span><span class="token number">0xE2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x07</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

       <span class="token punctuation">{<!-- --></span><span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//DCS_Short_Write_NP(0x11) 不带参数的命令</span>
       <span class="token punctuation">{<!-- --></span>REGFLAG_DELAY<span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//Delay(120)，延时120微秒</span>
       <span class="token punctuation">{<!-- --></span><span class="token number">0x29</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//DCS_Short_Write_NP(0x29)</span>
       <span class="token punctuation">{<!-- --></span>REGFLAG_DELAY<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token punctuation">{<!-- --></span>REGFLAG_END_OF_TABLE<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment">//表示结束，都需要添加</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init_lcm_registers</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">push_table</span><span class="token punctuation">(</span>lcm_initialization_setting<span class="token punctuation">,</span>
		    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>lcm_initialization_setting<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> LCM_setting_table<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">lcm_init_lcm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> BUILD_LK</span>
	<span class="token function">cmdline_append</span><span class="token punctuation">(</span><span class="token string">"lcm_name=hx82790d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_lcm_registers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面的初始化代码是MTK平台很常见的，而struct LCM_setting_table lcm_initialization_setting就是我们需要下发给LCM的初始化参数，这个都是屏厂提供（我大概注释了一下屏参的格式含义）。</p> 
<p>（3）</p> 
<p>初始化完LCM后，在Lk阶段就可以显示logo了。</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\mt_logo.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Fill rectangle region for with black  or other color  
 *
 */</span>
<span class="token keyword">void</span> <span class="token function">mt_disp_fill_rect</span><span class="token punctuation">(</span>UINT32 left<span class="token punctuation">,</span> UINT32 top<span class="token punctuation">,</span>
                           UINT32 right<span class="token punctuation">,</span> UINT32 bottom<span class="token punctuation">,</span>
                           UINT32 color<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">dprintf</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"[lk logo: %s %d]\n"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token function">init_fb_screen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RECT_REGION_T rect <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token function">fill_rect_with_color</span><span class="token punctuation">(</span><span class="token function">mt_get_fb_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rect<span class="token punctuation">,</span> color<span class="token punctuation">,</span> phical_screen<span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token punctuation">}</span>
</code></pre> 
<p>从注释来看也知道，这是在初始化阶段先给framebuffer填全0数据，使屏幕显示黑色。另外我们也关注一下init_fb_screen()里面的初始化动作：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">init_fb_screen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">dprintf</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"[lk logo: %s %d]\n"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>MTK_LCM_PHYSICAL_ROTATION<span class="token punctuation">,</span> <span class="token string">"270"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span> 
        phical_screen<span class="token punctuation">.</span>rotation <span class="token operator">=</span> <span class="token number">270</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>MTK_LCM_PHYSICAL_ROTATION<span class="token punctuation">,</span> <span class="token string">"90"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
        phical_screen<span class="token punctuation">.</span>rotation <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>MTK_LCM_PHYSICAL_ROTATION<span class="token punctuation">,</span> <span class="token string">"180"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>phical_screen<span class="token punctuation">.</span>need180Adjust <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
        phical_screen<span class="token punctuation">.</span>rotation <span class="token operator">=</span> <span class="token number">180</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        phical_screen<span class="token punctuation">.</span>rotation <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>我们重点关注一下MTK_LCM_PHYSICAL_ROTATION，这是定义屏幕画面旋转角度的，比如我们平板是竖屏横用可能就需要旋转90度，可以在device/mediatek/mt8167/ProjectConfig.mk中定义MTK_LCM_PHYSICAL_ROTATION的值。</p> 
<p>通过漫长的初始化之后，我们准备开始显示logo画面，还是在platform_init()阶段</p> 
<blockquote> 
 <p>vendor\mediatek\proprietary\bootable\bootloader\lk\platform\mt8167\mt_logo.c</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Show first boot logo when phone boot up
 *
 */</span>
<span class="token keyword">void</span> <span class="token function">mt_disp_show_boot_logo</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">dprintf</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"[lk logo: %s %d]\n"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">mt_logo_get_custom_if</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>logo_cust_if<span class="token operator">-&gt;</span>show_boot_logo<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        logo_cust_if<span class="token operator">-&gt;</span><span class="token function">show_boot_logo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">///show_logo(0);</span>
        <span class="token function">init_fb_screen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fill_animation_logo</span><span class="token punctuation">(</span>BOOT_LOGO_INDEX<span class="token punctuation">,</span> <span class="token function">mt_get_fb_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mt_get_tempfb_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logo_addr<span class="token punctuation">,</span> phical_screen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mt_disp_update</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> CFG_DISPLAY_WIDTH<span class="token punctuation">,</span> CFG_DISPLAY_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>init_fb_screen()再次初始化屏幕，然后就是调用fill_animation_logo()填充framebuffer，然后再调用mt_disp_update()更新到LCM上。</p> 
<h3><a id="_587"></a>结语</h3> 
<p>至此，我们就暂时分析到这里，目的主要是为了分析我们自己移植的LCM驱动在display框架中的作用。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/37745792c54d6083c8bda1626f3dacc9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python计算思维、数组计算与曲线绘制_用Python学计算思维海龟作图小提示</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2b09823a8ca60bd67418b253c45459a8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java String类型的特性（复用性，值不可变性）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>