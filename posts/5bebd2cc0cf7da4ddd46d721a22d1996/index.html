<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>（五）Langchain PGVector 补充智能客服匹配式问答 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="（五）Langchain PGVector 补充智能客服匹配式问答" />
<meta property="og:description" content="文章目录 资料背景目标FAQ-匹配式问答安装PGVector 向量数据库text2vec-large-chineseLangchain-PGVector测试向量化文本写入QA问答对特别注意问题langchain pgvector表和数据相识性问题匹配 PGSQL扩展知识 结论 资料 NLP领域五大QA问答场景总结：FQA、DOC-QA、KBQA、TableQA、TaskQA等场景概述与对比解析Langchain PGVector使用文档pgvector 背景 最近在做智能客服，通过 https://github.com/imClumsyPanda/langchain-ChatGLM 可以完成DOC-QA 部分智能问答
摘要项目原理说明
本项目实现原理如下图所示，过程包括加载文件 -&gt; 读取文本 -&gt; 文本分割 -&gt; 文本向量化 -&gt; 问句向量化 -&gt; 在文本向量中匹配出与问句向量最相似的top k个 -&gt; 匹配出的文本作为上下文和问题一起添加到prompt中 -&gt; 提交给LLM生成回答。
其中注意介绍中的这一句，在文本向量中匹配出与问句向量最相似的top k个，也就是第7和第10个步骤，有几个问题在实践中需要解决
测试过程中大部分答案还是满意的，但是由于原始文档切割，部分答案会丢失上下文（切割没了，top k也没匹配出来）固定的问答对很难保障，比如操作流程，这种需求内容长且要求答案文本顺序不能乱文本上下文存在复杂的内容，比如图片，音频，视频，需要处理才能让大模型呈现FAISS 向量库不支持matedata过滤，在复杂度更高的场景失去灵活性FAISS 不支持单条语句删除或更新 为了问答质量效果，既要保障高质量语料，也得寻求匹配式问答解决方案，这才选择了Langchain PGVector 补充智能客服匹配式问答
目标 先让用户的问题，匹配问答中的问题（多问一答），相同的问题意图需要泛化，如果问题相识度满足一定的阈值，则返回问题对应的答案，如果不满足相关度阈值，则把问题提交给文档问答库（适合有一定的业务文档积累场景）作为兜底，同样的也需要满足一定的相关度top k
FAQ-匹配式问答 安装PGVector 向量数据库 什么是 pgvector ？ Postgres的开源向量相似性搜索，支持
精确和近似最近邻搜索L2 距离、内积和余弦距离任何带有Postgres客户端的语言 为了快速验证可行性，使用 https://github.com/pgvector/pgvector 中docker方法启动项目
FROM ankane/pgvector LABEL maintainer=&#34;Ben M &lt;git@bmagg.com&gt;&#34; CMD [&#34;postgres&#34;] EXPOSE 5432 构建启动docker
docker build -t pgvector ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5bebd2cc0cf7da4ddd46d721a22d1996/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-20T14:28:52+08:00" />
<meta property="article:modified_time" content="2023-06-20T14:28:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">（五）Langchain PGVector 补充智能客服匹配式问答</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">资料</a></li><li><a href="#_8" rel="nofollow">背景</a></li><li><a href="#_26" rel="nofollow">目标</a></li><li><a href="#FAQ_29" rel="nofollow">FAQ-匹配式问答</a></li><li><ul><li><a href="#PGVector__31" rel="nofollow">安装PGVector 向量数据库</a></li><li><a href="#text2veclargechinese_55" rel="nofollow">text2vec-large-chinese</a></li><li><a href="#LangchainPGVector_64" rel="nofollow">Langchain-PGVector</a></li><li><ul><li><a href="#_72" rel="nofollow">测试向量化文本</a></li><li><a href="#QA_89" rel="nofollow">写入QA问答对</a></li><li><a href="#_176" rel="nofollow">特别注意问题</a></li><li><a href="#langchain_pgvector_190" rel="nofollow">langchain pgvector表和数据</a></li><li><a href="#_197" rel="nofollow">相识性问题匹配</a></li></ul> 
   </li><li><a href="#PGSQL_249" rel="nofollow">PGSQL扩展知识</a></li></ul> 
  </li><li><a href="#_309" rel="nofollow">结论</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>资料</h2> 
<ul><li><a href="https://hub.baai.ac.cn/view/22888?share_token=dd08be32-b001-423f-b942-d6fdc6dee284" rel="nofollow">NLP领域五大QA问答场景总结：FQA、DOC-QA、KBQA、TableQA、TaskQA等场景概述与对比解析</a></li><li><a href="https://python.langchain.com/en/latest/modules/indexes/vectorstores/examples/pgvector.html" rel="nofollow">Langchain PGVector使用文档</a></li><li><a href="https://github.com/pgvector/pgvector">pgvector</a></li></ul> 
<h2><a id="_8"></a>背景</h2> 
<p>最近在做智能客服，通过 <a href="https://github.com/imClumsyPanda/langchain-ChatGLM">https://github.com/imClumsyPanda/langchain-ChatGLM</a> 可以完成DOC-QA 部分智能问答</p> 
<p>摘要项目原理说明</p> 
<blockquote> 
 <p>本项目实现原理如下图所示，过程包括加载文件 -&gt; 读取文本 -&gt; 文本分割 -&gt; 文本向量化 -&gt; 问句向量化 -&gt; 在文本向量中匹配出与问句向量最相似的top k个 -&gt; 匹配出的文本作为上下文和问题一起添加到prompt中 -&gt; 提交给LLM生成回答。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/3b/20/gGlDZScT_o.png" alt="在这里插入图片描述"><br> 其中注意介绍中的这一句，<code>在文本向量中匹配出与问句向量最相似的top k个</code>，也就是第7和第10个步骤，有几个问题在实践中需要解决</p> 
<ul><li>测试过程中大部分答案还是满意的，但是由于原始文档切割，部分答案会丢失上下文（切割没了，top k也没匹配出来）</li><li>固定的问答对很难保障，比如操作流程，这种需求内容长且要求答案文本顺序不能乱</li><li>文本上下文存在复杂的内容，比如图片，音频，视频，需要处理才能让大模型呈现</li><li>FAISS 向量库不支持matedata过滤，在复杂度更高的场景失去灵活性</li><li>FAISS 不支持单条语句删除或更新</li></ul> 
<p>为了问答质量效果，既要保障高质量语料，也得寻求匹配式问答解决方案，这才选择了<code>Langchain PGVector</code> 补充智能客服匹配式问答</p> 
<h2><a id="_26"></a>目标</h2> 
<p>先让用户的问题，匹配问答中的问题（多问一答），相同的问题意图需要泛化，如果问题相识度满足一定的阈值，则返回问题对应的答案，如果不满足相关度阈值，则把问题提交给文档问答库（适合有一定的业务文档积累场景）作为兜底，同样的也需要满足一定的相关度top k</p> 
<h2><a id="FAQ_29"></a>FAQ-匹配式问答</h2> 
<h3><a id="PGVector__31"></a>安装PGVector 向量数据库</h3> 
<p>什么是 pgvector ？ Postgres的开源向量相似性搜索，支持</p> 
<ul><li>精确和近似最近邻搜索</li><li>L2 距离、内积和余弦距离</li><li>任何带有Postgres客户端的语言</li></ul> 
<p>为了快速验证可行性，使用 <a href="https://github.com/pgvector/pgvector">https://github.com/pgvector/pgvector</a> 中docker方法启动项目</p> 
<pre><code>FROM ankane/pgvector

LABEL maintainer="Ben M &lt;git@bmagg.com&gt;"

CMD ["postgres"]

EXPOSE 5432

</code></pre> 
<p>构建启动docker</p> 
<pre><code>docker build -t pgvector .
docker run -itd pgvector -p 5432 -e POSTGRES_DB=default -e POSTGRES_USER=default -e POSTGRES_PASSWORD=secret
</code></pre> 
<h3><a id="text2veclargechinese_55"></a>text2vec-large-chinese</h3> 
<p>因为在实践过程中，如果用大模型能力去让文本向量化，貌似速度挺慢的，所以这里先使用<code>text2vec-large-chinese</code>作为向量模型</p> 
<p>huggingface下载地址，<a href="https://huggingface.co/GanymedeNil/text2vec-large-chinese" rel="nofollow">https://huggingface.co/GanymedeNil/text2vec-large-chinese</a></p> 
<p>放在测试项目的·<code>models/text2vec-large-chinese·</code></p> 
<p>国内下载慢的，可以在<a href="https://github.com/imClumsyPanda/langchain-ChatGLM/blob/master/docs/FAQ.md">https://github.com/imClumsyPanda/langchain-ChatGLM/blob/master/docs/FAQ.md</a>找到百度下载地址</p> 
<h3><a id="LangchainPGVector_64"></a>Langchain-PGVector</h3> 
<p>通过学习<a href="https://python.langchain.com/en/latest/modules/indexes/vectorstores/examples/pgvector.html" rel="nofollow">Langchain-PGVector</a>文档，首先安装langchain环境pgvector</p> 
<pre><code class="prism language-sh">pip install langchain pgvector -i http://mirrors.aliyun.com/pypi/simple/
</code></pre> 
<h4><a id="_72"></a>测试向量化文本</h4> 
<blockquote> 
 <p>Embedding 是一个浮点数向量（列表）。两个向量之间的距离用于测量它们之间的相关性。较小距离表示高相关性，较大距离表示低相关性。</p> 
</blockquote> 
<p>为了提高相关性，尽可能泛化问题</p> 
<pre><code class="prism language-py"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> HuggingFaceEmbeddings  

embeddings <span class="token operator">=</span> HuggingFaceEmbeddings<span class="token punctuation">(</span>model_name<span class="token operator">=</span><span class="token string">"models/text2vec-large-chinese"</span>
                              <span class="token punctuation">,</span>model_kwargs<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'device'</span><span class="token punctuation">:</span> <span class="token string">"cpu"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

sentence <span class="token operator">=</span> <span class="token string">'你是谁|介绍一下你自己|你叫什么名字'</span>
vec <span class="token operator">=</span> embeddings<span class="token punctuation">.</span>embed_documents<span class="token punctuation">(</span>sentence<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vec<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d2/01/A1NkKTaA_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="QA_89"></a>写入QA问答对</h4> 
<p>下面代码第一次是不会运行成功的，耐心往下看就知道原因</p> 
<p>需要注意和验证的问题是</p> 
<ul><li>问题都整合在一起效果更好还是分开？</li><li>分数越低，代表匹配相关性越高</li><li>向量化的是问题，答案作为metadata写入到数据库了</li></ul> 
<pre><code class="prism language-py"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> HuggingFaceEmbeddings  
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>vectorstores<span class="token punctuation">.</span>pgvector <span class="token keyword">import</span> PGVector
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>vectorstores<span class="token punctuation">.</span>pgvector <span class="token keyword">import</span> DistanceStrategy
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>docstore<span class="token punctuation">.</span>document <span class="token keyword">import</span> Document
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Tuple


embeddings <span class="token operator">=</span> HuggingFaceEmbeddings<span class="token punctuation">(</span>model_name<span class="token operator">=</span><span class="token string">"models/text2vec-large-chinese"</span>
                              <span class="token punctuation">,</span>model_kwargs<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'device'</span><span class="token punctuation">:</span> <span class="token string">"cpu"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># sentence = '你是谁|介绍一下你自己|你叫什么名字'</span>
<span class="token comment"># vec = embeddings.embed_documents(sentence)</span>
<span class="token comment"># print(vec)</span>


<span class="token keyword">import</span> os
PGVECTOR_CONNECTION_STRING <span class="token operator">=</span> PGVector<span class="token punctuation">.</span>connection_string_from_db_params<span class="token punctuation">(</span>
    driver<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_DRIVER"</span><span class="token punctuation">,</span> <span class="token string">"psycopg2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    host<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_HOST"</span><span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    port<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_PORT"</span><span class="token punctuation">,</span> <span class="token string">"5432"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    database<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_DATABASE"</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_USER"</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    password<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_PASSWORD"</span><span class="token punctuation">,</span> <span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"=====&gt;</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PGVECTOR_CONNECTION_STRING<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


data <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"你是谁|介绍一下你自己|你叫什么名字?"</span><span class="token punctuation">,</span> 
    <span class="token string">"商品支持退货吗？"</span><span class="token punctuation">,</span>
    <span class="token string">"购物车可以添加多少商品?"</span>
    <span class="token punctuation">]</span>

metadatas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"answer"</span><span class="token punctuation">:</span><span class="token string">"是智能助手, 一个由OpenAI训练的大型语言模型, 你旨在回答并解决人们的任何问题，并且可以使用多种语言与人交流。让我们一步步思考，并且尽可能用分点叙述的形式输出。我们开始聊天吧"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
             <span class="token punctuation">{<!-- --></span><span class="token string">"answer"</span><span class="token punctuation">:</span><span class="token string">"15天内商品支持退换货"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
             <span class="token punctuation">{<!-- --></span><span class="token string">"answer"</span><span class="token punctuation">:</span><span class="token string">"购物车可以添加100件商品"</span><span class="token punctuation">}</span>
             <span class="token punctuation">]</span>

PGVector<span class="token punctuation">.</span>from_texts<span class="token punctuation">(</span>texts <span class="token operator">=</span> data<span class="token punctuation">,</span>
                    embedding<span class="token operator">=</span>embeddings<span class="token punctuation">,</span>
                    collection_name<span class="token operator">=</span><span class="token string">"custom_qa"</span><span class="token punctuation">,</span>
                    connection_string<span class="token operator">=</span>PGVECTOR_CONNECTION_STRING<span class="token punctuation">,</span>
                    metadatas <span class="token operator">=</span> metadatas
                    <span class="token punctuation">)</span>

</code></pre> 
<p>运行代码报错了，不用着急</p> 
<p><code>PGVector.from_texts</code> 方法会自动创建表（<code>langchain_pg_embedding</code>，<code>langchain_pg_collection</code>），并录入数据（多次录入是新增逻辑）</p> 
<p><img src="https://images2.imgbox.com/a2/67/u4r2JYUM_o.png" alt="在这里插入图片描述"></p> 
<p>第一次langchain为我们自动创建</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">"public"</span><span class="token punctuation">.</span><span class="token string">"langchain_pg_collection"</span> <span class="token punctuation">(</span>
	<span class="token string">"uuid"</span> uuid <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token string">"name"</span> <span class="token keyword">varchar</span><span class="token punctuation">,</span>
	<span class="token string">"cmetadata"</span> json<span class="token punctuation">,</span>
	<span class="token keyword">CONSTRAINT</span> <span class="token string">"langchain_pg_collection_pkey"</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">"public"</span><span class="token punctuation">.</span><span class="token string">"langchain_pg_embedding"</span> <span class="token punctuation">(</span>
	<span class="token string">"uuid"</span> uuid <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token string">"collection_id"</span> uuid<span class="token punctuation">,</span>
	<span class="token string">"embedding"</span> vector<span class="token punctuation">(</span><span class="token number">1536</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token string">"document"</span> <span class="token keyword">varchar</span><span class="token punctuation">,</span>
	<span class="token string">"cmetadata"</span> json<span class="token punctuation">,</span>
	<span class="token string">"custom_id"</span> <span class="token keyword">varchar</span><span class="token punctuation">,</span>
	<span class="token keyword">CONSTRAINT</span> <span class="token string">"langchain_pg_embedding_pkey"</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_176"></a>特别注意问题</h4> 
<p><code>langchain pgvector</code>源码包使用的是<code>openai</code>的第二代<code>text-embedding-ada-002</code>模型，输出向量维度是<code>1536</code>，默认创建的表也是<code>"embedding" vector(1536),</code> 感兴趣的可以看 <a href="https://zhuanlan.zhihu.com/p/619233637" rel="nofollow">https://zhuanlan.zhihu.com/p/619233637</a></p> 
<p><img src="https://images2.imgbox.com/bb/45/RAXQg7vR_o.png" alt="在这里插入图片描述"><br> 这里和我们模型<code>text2vec-large-chinese</code>输出向量维度是<code>1024</code>, 数据存不进去，因为向量维度不同</p> 
<p>修改 <code>langchain.vectorstores.pgvector</code></p> 
<pre><code>ADA_TOKEN_COUNT = 1024 # openai 1536
</code></pre> 
<p><img src="https://images2.imgbox.com/15/8a/mcOOgQjj_o.png" alt="在这里插入图片描述"><br> 删除创建的pg表，我们重新运行代码即可，会重新创建表</p> 
<h4><a id="langchain_pgvector_190"></a>langchain pgvector表和数据</h4> 
<ul><li> <p>langchain_pg_collection<br> <img src="https://images2.imgbox.com/d4/a7/IIlQiX4i_o.png" alt="在这里插入图片描述"></p> </li><li> <p>langchain_pg_embedding<br> <img src="https://images2.imgbox.com/64/69/LQoqW3oK_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h4><a id="_197"></a>相识性问题匹配</h4> 
<pre><code class="prism language-py">
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> HuggingFaceEmbeddings  
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>vectorstores<span class="token punctuation">.</span>pgvector <span class="token keyword">import</span> PGVector
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>vectorstores<span class="token punctuation">.</span>pgvector <span class="token keyword">import</span> DistanceStrategy
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>docstore<span class="token punctuation">.</span>document <span class="token keyword">import</span> Document
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Tuple
<span class="token keyword">import</span> os

embeddings <span class="token operator">=</span> HuggingFaceEmbeddings<span class="token punctuation">(</span>model_name<span class="token operator">=</span><span class="token string">"models/text2vec-large-chinese"</span>
                              <span class="token punctuation">,</span>model_kwargs<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'device'</span><span class="token punctuation">:</span> <span class="token string">"cpu"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

PGVECTOR_CONNECTION_STRING <span class="token operator">=</span> PGVector<span class="token punctuation">.</span>connection_string_from_db_params<span class="token punctuation">(</span>
    driver<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_DRIVER"</span><span class="token punctuation">,</span> <span class="token string">"psycopg2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    host<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_HOST"</span><span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    port<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_PORT"</span><span class="token punctuation">,</span> <span class="token string">"5432"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    database<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_DATABASE"</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_USER"</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    password<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"PGVECTOR_PASSWORD"</span><span class="token punctuation">,</span> <span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"=====&gt;</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PGVECTOR_CONNECTION_STRING<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


query <span class="token operator">=</span> <span class="token string">"你们的购物车可以添加几个商品"</span>

store <span class="token operator">=</span> PGVector<span class="token punctuation">(</span>
    connection_string<span class="token operator">=</span>PGVECTOR_CONNECTION_STRING<span class="token punctuation">,</span> 
    embedding_function<span class="token operator">=</span>embeddings<span class="token punctuation">,</span> 
    collection_name<span class="token operator">=</span><span class="token string">"custom_qa"</span><span class="token punctuation">,</span>
    distance_strategy<span class="token operator">=</span>DistanceStrategy<span class="token punctuation">.</span>COSINE
<span class="token punctuation">)</span>

<span class="token comment"># retriever = store.as_retriever()</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
docs_with_score<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>Document<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> store<span class="token punctuation">.</span>similarity_search_with_score<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
<span class="token keyword">for</span> doc<span class="token punctuation">,</span> score <span class="token keyword">in</span> docs_with_score<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Score: "</span><span class="token punctuation">,</span> score<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>page_content<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>metadata<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ba/dc/VisTfsV3_o.png" alt="在这里插入图片描述"><br> 通过验证，如果将问题都糅合在一起，相关度score的值变大了（不那么相关）,所以设计的时候，应该将泛化的问题单独一行<br> <img src="https://images2.imgbox.com/f6/04/QxJGAYMx_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>索引性能优化部分不在本次探讨范围</p> 
</blockquote> 
<h3><a id="PGSQL_249"></a>PGSQL扩展知识</h3> 
<p>查询表结构不方便看vector参数，需要定义一下函数</p> 
<pre><code>CREATE OR REPLACE FUNCTION public.tabledef(text, text)
 RETURNS text
 LANGUAGE sql
 STRICT
AS $function$
WITH attrdef AS (
        SELECT n.nspname, c.relname, c.oid, pg_catalog.array_to_string(c.reloptions || array(select 'toast.' || x from pg_catalog.unnest(tc.reloptions) x), ', ') as relopts,
        c.relpersistence, a.attnum, a.attname, pg_catalog.format_type(a.atttypid, a.atttypmod) as atttype, 
        (SELECT substring(pg_catalog.pg_get_expr(d.adbin, d.adrelid, true) for 128) FROM pg_catalog.pg_attrdef d WHERE d.adrelid = a.attrelid AND d.adnum = a.attnum AND a.atthasdef) as attdefault,
        a.attnotnull, (SELECT c.collname FROM pg_catalog.pg_collation c, pg_catalog.pg_type t WHERE c.oid = a.attcollation AND t.oid = a.atttypid AND a.attcollation &lt;&gt; t.typcollation) as attcollation,
        a.attidentity, a.attgenerated 
        FROM pg_catalog.pg_attribute a 
        JOIN pg_catalog.pg_class c ON a.attrelid = c.oid 
        JOIN pg_catalog.pg_namespace n ON c.relnamespace = n.oid 
        LEFT JOIN pg_catalog.pg_class tc ON (c.reltoastrelid = tc.oid) 
        WHERE n.nspname = $1 AND c.relname = $2 AND a.attnum &gt; 0 AND NOT a.attisdropped 
        ORDER BY a.attnum
    ), coldef AS (
        SELECT attrdef.nspname, attrdef.relname, attrdef.oid, attrdef.relopts, attrdef.relpersistence, pg_catalog.format('%I %s%s%s%s%s', attrdef.attname, attrdef.atttype, 
        case when attrdef.attcollation is null then '' else pg_catalog.format(' COLLATE %I', attrdef.attcollation) end, 
        case when attrdef.attnotnull then ' NOT NULL' else '' end, 
        case when attrdef.attdefault is null then '' else case when attrdef.attgenerated = 's' then pg_catalog.format(' GENERATED ALWAYS AS (%s) STORED', attrdef.attdefault) when attrdef.attgenerated &lt;&gt; '' then ' GENERATED AS NOT_IMPLEMENTED' else pg_catalog.format(' DEFAULT %s', attrdef.attdefault)  end  end,           
        case when attrdef.attidentity&lt;&gt;'' then pg_catalog.format(' GENERATED %s AS IDENTITY', case attrdef.attidentity when 'd' then 'BY DEFAULT' when 'a' then 'ALWAYS' else 'NOT_IMPLEMENTED' end)       else '' end ) as col_create_sql    
        FROM attrdef
        ORDER BY attrdef.attnum
    ), tabdef AS (
         SELECT coldef.nspname, coldef.relname, coldef.oid, coldef.relopts, coldef.relpersistence, concat(string_agg(coldef.col_create_sql, E',\n    ') , (select concat(E',\n    ',pg_get_constraintdef(oid)) from pg_constraint where contype='p' and conrelid = coldef.oid))  as cols_create_sql
         FROM coldef 
         GROUP BY coldef.nspname, coldef.relname, coldef.oid, coldef.relopts, coldef.relpersistence
    )
SELECT FORMAT( 'CREATE%s TABLE %I.%I%s%s%s;', 
                case tabdef.relpersistence when 't' then ' TEMP' when 'u' then ' UNLOGGED' else '' end, 
                tabdef.nspname, 
                tabdef.relname, 
                coalesce( (
                        SELECT FORMAT( E'\n    PARTITION OF %I.%I %s\n', pn.nspname, pc.relname, pg_get_expr(c.relpartbound, c.oid) ) 
                        FROM pg_class c 
                        JOIN pg_inherits i ON c.oid = i.inhrelid
                        JOIN pg_class pc ON pc.oid = i.inhparent
                        JOIN pg_namespace pn ON pn.oid = pc.relnamespace
                        WHERE c.oid = tabdef.oid ),
                        FORMAT( E' (\n    %s\n)', tabdef.cols_create_sql) 
                ),
                case when tabdef.relopts &lt;&gt; '' then format(' WITH (%s)', tabdef.relopts) else '' end,
                coalesce(E'\nPARTITION BY '||pg_get_partkeydef(tabdef.oid), '') 
            ) as table_create_sql
FROM tabdef
$function$

</code></pre> 
<p>查询langchain_pg_embedding表结构</p> 
<pre><code>select tabledef('public', 'langchain_pg_embedding');
</code></pre> 
<h2><a id="_309"></a>结论</h2> 
<p>问题要泛化，答案尽可能多样化</p> 
<ul><li>可以使用pgvector完成FQA问答场景，doc-qa作为兜底方案</li><li>一个问题一行保存到pg，让socre尽可能的小，到时候可以结合业务设置相关度阈值，决定是否检索doc-qa</li><li>为了答案的多样性，可以写入多个答案，或者写入外键表id获取答案（answer写答案的id）</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bb81bc4d630f7609130557cd9d1f31da/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">阿里云对象存储OSS迁移流程(1)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bb89444512e17f8a909c11b0379a4c72/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mysql find_in_set()函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>