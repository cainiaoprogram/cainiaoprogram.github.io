<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ignite和SpringBoot整合时出现Failed to initialize system DB connection......MULTI_THREADED问题解决 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ignite和SpringBoot整合时出现Failed to initialize system DB connection......MULTI_THREADED问题解决" />
<meta property="og:description" content="需求 计网实验需要使用SpringBoot&#43;Ignite&#43;JWT完成一个登录并存储用户权限的功能。
前期准备 在github上找了一个源码仓库：Spring Boot整合JWT实现用户认证。和我的需求十分接近，遂下载下来准备在其基础上二次开发。但是其由于是两年前的仓库，一些依赖包的版本到今天已经更新了不少。于是我准备将这些依赖包都更新到新版本，同时使用gradle而非原来的maven作为构建工具。
在问题出现时，和Ignite有关的代码如下：
@Configuration public class IgniteCfg { /** * 初始化ignite节点信息 * @return Ignite */ @Bean public Ignite igniteInstance(){ // 配置一个节点的Configuration IgniteConfiguration cfg = new IgniteConfiguration(); // 设置该节点名称 cfg.setIgniteInstanceName(&#34;springDataNode&#34;); // 启用Peer类加载器 cfg.setPeerClassLoadingEnabled(true); // 创建一个Cache的配置，名称为PersonCache CacheConfiguration ccfg = new CacheConfiguration(&#34;PersonCache&#34;); // 设置这个Cache的键值对模型 ccfg.setIndexedTypes(Long.class, Person.class); // 把这个Cache放入springDataNode这个Node中 cfg.setCacheConfiguration(ccfg); // Ignite persistence configuration. // 创建一个持久化存储的设置 DataStorageConfiguration storageCfg = new DataStorageConfiguration(); // Enabling the persistence. // 是这个设置允许持久化存储 storageCfg.getDefaultDataRegionConfiguration().setPersistenceEnabled(true); // 设置持久化存储路径 storageCfg." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d29005a4e4b8ba9f4646555f5c68d402/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-07T22:21:40+08:00" />
<meta property="article:modified_time" content="2020-06-07T22:21:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ignite和SpringBoot整合时出现Failed to initialize system DB connection......MULTI_THREADED问题解决</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>需求</h2> 
<p>计网实验需要使用SpringBoot+Ignite+JWT完成一个登录并存储用户权限的功能。</p> 
<h2><a id="_2"></a>前期准备</h2> 
<p>在github上找了一个源码仓库：<a href="https://github.com/ltlayx/SpringBoot-Ignite">Spring Boot整合JWT实现用户认证</a>。和我的需求十分接近，遂下载下来准备在其基础上二次开发。但是其由于是两年前的仓库，一些依赖包的版本到今天已经更新了不少。于是我准备将这些依赖包都更新到新版本，同时使用gradle而非原来的maven作为构建工具。</p> 
<p>在问题出现时，和Ignite有关的代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IgniteCfg</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 初始化ignite节点信息
     * @return Ignite
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> Ignite <span class="token function">igniteInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 配置一个节点的Configuration</span>
        IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置该节点名称</span>
        cfg<span class="token punctuation">.</span><span class="token function">setIgniteInstanceName</span><span class="token punctuation">(</span><span class="token string">"springDataNode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 启用Peer类加载器</span>
        cfg<span class="token punctuation">.</span><span class="token function">setPeerClassLoadingEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建一个Cache的配置，名称为PersonCache</span>
        CacheConfiguration ccfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token string">"PersonCache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置这个Cache的键值对模型</span>
        ccfg<span class="token punctuation">.</span><span class="token function">setIndexedTypes</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Person<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 把这个Cache放入springDataNode这个Node中</span>
        cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>ccfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Ignite persistence configuration.</span>
        <span class="token comment">// 创建一个持久化存储的设置</span>
        DataStorageConfiguration storageCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStorageConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Enabling the persistence.</span>
        <span class="token comment">// 是这个设置允许持久化存储</span>
        storageCfg<span class="token punctuation">.</span><span class="token function">getDefaultDataRegionConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPersistenceEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置持久化存储路径</span>
        storageCfg<span class="token punctuation">.</span><span class="token function">setStoragePath</span><span class="token punctuation">(</span><span class="token string">"/opt/storage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Applying settings.</span>
        <span class="token comment">// 把这个Configuration放到springDataNode这个Node中</span>
        cfg<span class="token punctuation">.</span><span class="token function">setDataStorageConfiguration</span><span class="token punctuation">(</span>storageCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 启动这个节点</span>
        Ignite ignite <span class="token operator">=</span> Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 激活集群</span>
        ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ignite<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_65"></a>问题</h2> 
<p>我修改过的build.gradle配置文件如下。</p> 
<pre><code class="prism language-kotlin">plugins <span class="token punctuation">{<!-- --></span>
	id <span class="token string">'org.springframework.boot'</span> version <span class="token string">'2.3.0.RELEASE'</span>
	id <span class="token string">'io.spring.dependency-management'</span> version <span class="token string">'1.0.9.RELEASE'</span>
	id <span class="token string">'java'</span>
<span class="token punctuation">}</span>

group <span class="token operator">=</span> <span class="token string">'com.fwh'</span>
version <span class="token operator">=</span> <span class="token string">'0.0.1-SNAPSHOT'</span>
sourceCompatibility <span class="token operator">=</span> <span class="token string">'1.8'</span>

repositories <span class="token punctuation">{<!-- --></span>
    maven <span class="token punctuation">{<!-- --></span> url <span class="token string">'https://maven.aliyun.com/repository/public/'</span> <span class="token punctuation">}</span>
    maven <span class="token punctuation">{<!-- --></span> url <span class="token string">'https://maven.aliyun.com/repository/spring/'</span><span class="token punctuation">}</span>
	maven<span class="token punctuation">{<!-- --></span> url <span class="token string">'http://maven.aliyun.com/nexus/content/repositories/jcenter'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{<!-- --></span>
	implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
	compile group<span class="token operator">:</span> <span class="token string">'org.apache.ignite'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'ignite-core'</span><span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token string">'2.8.1'</span>
	compile group<span class="token operator">:</span> <span class="token string">'org.apache.ignite'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'ignite-spring'</span><span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token string">'2.8.1'</span>
	compile group<span class="token operator">:</span> <span class="token string">'org.apache.ignite'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'ignite-spring-data_2.2'</span><span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token string">'2.8.1'</span>
	compile group<span class="token operator">:</span> <span class="token string">'io.jsonwebtoken'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'jjwt'</span><span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token string">'0.9.1'</span>

	compile group<span class="token operator">:</span> <span class="token string">'com.h2database'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'h2'</span><span class="token punctuation">,</span> 

	<span class="token function">testImplementation</span><span class="token punctuation">(</span><span class="token string">'org.springframework.boot:spring-boot-starter-test'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		exclude group<span class="token operator">:</span> <span class="token string">'org.junit.vintage'</span><span class="token punctuation">,</span> module<span class="token operator">:</span> <span class="token string">'junit-vintage-engine'</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

test <span class="token punctuation">{<!-- --></span>
	<span class="token function">useJUnitPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>按理说应该已经基本上添加了能够想到的所有依赖。但是运行项目，报错。<br> <img src="https://images2.imgbox.com/8b/d2/if6NdR9v_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7a/dc/FU9jZddw_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_106"></a>问题分析</h2> 
<p>首先对上面的igniteInstance编写单元测试，Ignite在不与Spring Boot产生关系的情况下能正常运行，可以说明确实是在两者配合时发生了bug.</p> 
<p>首先就此问题询问一位已经完成的同学。<br> <img src="https://images2.imgbox.com/3b/f3/PB8lsH3J_o.png" alt="聊天记录-w40" width="300"><br> 关于h2的依赖问题，其实在网上有过广泛的讨论。在不久前的Ignite版本中，由于Ignite使用的h2依赖和Spring使用的h2依赖版本不一致，导致经常出现<code>h2 property NESTED_JOINS doesn't exist</code>问题。stackoverflow上的一个经典问答如下：<br> <a href="https://stackoverflow.com/questions/52652162/ignite-wont-start-with-spring-boot-2-0-5-h2-property-nested-joins-doesnt-exi" rel="nofollow">ignite won’t start with spring-boot 2.0.5 - h2 property NESTED_JOINS doesn’t exist</a></p> 
<p>但是，这个问题我已经排查过了，在上面的build.gradle中明确声明了h2依赖。另外在找资料时我发现有人提到在最新的Ignite2.8版本中已经没有这个问题了。<br> <img src="https://images2.imgbox.com/38/e8/2oKFRzd5_o.png" alt="在这里插入图片描述"><br> 该评论链接：<a href="https://yq.aliyun.com/articles/604252" rel="nofollow">ignite和springboot结合无法启动问题</a></p> 
<p>这边陷入死路，在网上查找了几个小时的相关资料无果。回过头来重新审视自己的build.gradle和那位做完实验的同学的pom.xml，似乎只有一点不一样，他加入了连接MySql的依赖而我没有。于是我也尝试加入了mySql-connector-java的依赖，然后发现错误竟然奇迹般的消失了。</p> 
<h2><a id="_120"></a>解决方法</h2> 
<p>在build.gradle中添加如下依赖：</p> 
<pre><code class="prism language-bash">compile group: <span class="token string">'mysql'</span>, name: <span class="token string">'mysql-connector-java'</span>, version: <span class="token string">'8.0.20'</span>
</code></pre> 
<h2><a id="_127"></a>问题反思</h2> 
<p>这个解决方法非常匪夷所思！因为我在整个代码中并没有用到MySQL。在问题出现时，我的项目中和Ignite相关的代码只有igniteInstance那几行。甚至还没有用到持久化，为什么会需要MySQL的依赖呢？</p> 
<p>一个猜想难道是由于Ignite内置的H2数据库或者说引擎本身不提供多线程的服务，导致了<code>Caused by : ...: : Unsupported connection setting "MULTI_THREADED"</code>。而声明了MySQL依赖后，Ignite改用了MySQL引擎，而MySQL可以提供相关的服务？</p> 
<p>这个问题目前就只能先这样留作疑问了，如果我之后有机会会对Ignite深入学习的话，也许我会来补充完这篇博客。</p> 
<h2><a id="_134"></a>其他</h2> 
<p>在解决问题的过程中，我尝试过将h2依赖更换为其他版本。但在我的机器上，除了1.4.197之外的版本都会直接在编译时报错。只有1.4.197可以编译成功（虽然其在运行时报出了上文中提到的错误）。</p> 
<p>一个Ignite的中文文档网站：<a href="https://blog.csdn.net/ltl112358/article/details/79399026">Apache Ignite技术服务网</a>，点击导航栏里的java就可以跳转到文档页。</p> 
<p>使用的github的作者的另一篇博客：<a href="https://blog.csdn.net/ltl112358/article/details/79399026">在Spring Boot上部署ignite数据库的小例子</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fb26cd91f1efaf4715f99ac4f6866165/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">IDEA命令行缩短器助你解决此问题：Command line is too long. Shorten command line...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/65f63e77dfcf522a86da078dd25d5a0e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在Ubuntu 20.04中安装ROS2最新版本Foxy Fitzroy</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>