<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于quartz的定时任务动态启停实现分析（人人平台为例） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于quartz的定时任务动态启停实现分析（人人平台为例）" />
<meta property="og:description" content="配置文件 位置在 module/job/config/ScheduleConfig
@Configuration public class ScheduleConfig { @Bean public SchedulerFactoryBean schedulerFactoryBean(DataSource dataSource) { SchedulerFactoryBean factory = new SchedulerFactoryBean(); factory.setDataSource(dataSource); //quartz参数 Properties prop = new Properties(); prop.put(&#34;org.quartz.scheduler.instanceName&#34;, &#34;RenrenScheduler&#34;); prop.put(&#34;org.quartz.scheduler.instanceId&#34;, &#34;AUTO&#34;); //线程池配置 prop.put(&#34;org.quartz.threadPool.class&#34;, &#34;org.quartz.simpl.SimpleThreadPool&#34;); prop.put(&#34;org.quartz.threadPool.threadCount&#34;, &#34;25&#34;); prop.put(&#34;org.quartz.threadPool.threadPriority&#34;, &#34;5&#34;); //JobStore配置 prop.put(&#34;org.quartz.jobStore.class&#34;, &#34;org.springframework.scheduling.quartz.LocalDataSourceJobStore&#34;); //集群配置 prop.put(&#34;org.quartz.jobStore.isClustered&#34;, &#34;true&#34;); prop.put(&#34;org.quartz.jobStore.clusterCheckinInterval&#34;, &#34;15000&#34;); prop.put(&#34;org.quartz.jobStore.maxMisfiresToHandleAtATime&#34;, &#34;1&#34;); // misfire 时间 单位 毫秒 prop.put(&#34;org.quartz.jobStore.misfireThreshold&#34;, &#34;12000&#34;); prop.put(&#34;org.quartz.jobStore.tablePrefix&#34;, &#34;QRTZ_&#34;); prop.put(&#34;org.quartz.jobStore.selectWithLockSQL&#34;, &#34;SELECT * FROM {0}LOCKS UPDLOCK WHERE LOCK_NAME = ?&#34;); //PostgreSQL数据库，需要打开此注释 //prop.put(&#34;org.quartz.jobStore.driverDelegateClass&#34;, &#34;org.quartz.impl.jdbcjobstore.PostgreSQLDelegate&#34;); factory." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a5367413779ae4770fd915676e5c2bd4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-02T15:44:14+08:00" />
<meta property="article:modified_time" content="2022-11-02T15:44:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于quartz的定时任务动态启停实现分析（人人平台为例）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_1"></a>配置文件</h3> 
<p>位置在 module/job/config/ScheduleConfig</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduleConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SchedulerFactoryBean</span> <span class="token function">schedulerFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SchedulerFactoryBean</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchedulerFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//quartz参数</span>
        <span class="token class-name">Properties</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.scheduler.instanceName"</span><span class="token punctuation">,</span> <span class="token string">"RenrenScheduler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.scheduler.instanceId"</span><span class="token punctuation">,</span> <span class="token string">"AUTO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//线程池配置</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.threadPool.class"</span><span class="token punctuation">,</span> <span class="token string">"org.quartz.simpl.SimpleThreadPool"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.threadPool.threadCount"</span><span class="token punctuation">,</span> <span class="token string">"25"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.threadPool.threadPriority"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//JobStore配置</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.jobStore.class"</span><span class="token punctuation">,</span> <span class="token string">"org.springframework.scheduling.quartz.LocalDataSourceJobStore"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//集群配置</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.jobStore.isClustered"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.jobStore.clusterCheckinInterval"</span><span class="token punctuation">,</span> <span class="token string">"15000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.jobStore.maxMisfiresToHandleAtATime"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// misfire 时间 单位 毫秒</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.jobStore.misfireThreshold"</span><span class="token punctuation">,</span> <span class="token string">"12000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.jobStore.tablePrefix"</span><span class="token punctuation">,</span> <span class="token string">"QRTZ_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"org.quartz.jobStore.selectWithLockSQL"</span><span class="token punctuation">,</span> <span class="token string">"SELECT * FROM {0}LOCKS UPDLOCK WHERE LOCK_NAME = ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//PostgreSQL数据库，需要打开此注释</span>
        <span class="token comment">//prop.put("org.quartz.jobStore.driverDelegateClass", "org.quartz.impl.jdbcjobstore.PostgreSQLDelegate");</span>

        factory<span class="token punctuation">.</span><span class="token function">setQuartzProperties</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        factory<span class="token punctuation">.</span><span class="token function">setSchedulerName</span><span class="token punctuation">(</span><span class="token string">"RenrenScheduler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//延时启动</span>
        factory<span class="token punctuation">.</span><span class="token function">setStartupDelay</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setApplicationContextSchedulerContextKey</span><span class="token punctuation">(</span><span class="token string">"applicationContextKey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//可选，QuartzScheduler 启动时更新己存在的Job，这样就不用每次修改targetObject后删除qrtz_job_details表对应记录了</span>
        factory<span class="token punctuation">.</span><span class="token function">setOverwriteExistingJobs</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置自动启动，默认为true</span>
        factory<span class="token punctuation">.</span><span class="token function">setAutoStartup</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意点：</p> 
<p>2.5.x版本以后 org.quartz.jobStore.class 需要手动配置</p> 
<p>org.quartz.threadPool.threadCount 线程池线程配置，默认是10，我这边调整到了 25，超过这个数字，会导致 misfire</p> 
<h3><a id="_59"></a>数据库存储</h3> 
<p>除去 quartz 的默认的表意外，renren 与定时任务相关的表有两张 <code>schedule_job</code>, <code>schedule_job_log</code>，前面一张表用来持久化储存我们的定时任务配置，后面一张表用来存储定时任务执行日志</p> 
<img src="https://images2.imgbox.com/16/bb/qYNQ0JF4_o.png" alt="image-20221102151815572"> 
<p>Schedule_job ，里面 bean_name 是我们后面继承job创建的 bean 的名称，param 可以传入定时任务执行参数，cron 表达式指定执行的时间</p> 
<img src="https://images2.imgbox.com/e4/0a/apfL90PE_o.png" alt="image-20221102151759432"> 
<p>日志表比较简单就不单独说了，后面说下日志记录是如何实现的</p> 
<h3><a id="quartz_71"></a>项目启动时是如何初始化quartz的</h3> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 项目启动时，初始化定时器
	 */</span>
	<span class="token annotation punctuation">@PostConstruct</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScheduleJobEntity</span><span class="token punctuation">&gt;</span></span> scheduleJobList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">ScheduleJobEntity</span> scheduleJob <span class="token operator">:</span> scheduleJobList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token class-name">CronTrigger</span> cronTrigger <span class="token operator">=</span> <span class="token class-name">ScheduleUtils</span><span class="token punctuation">.</span><span class="token function">getCronTrigger</span><span class="token punctuation">(</span>scheduler<span class="token punctuation">,</span> scheduleJob<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果不存在，则创建</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>cronTrigger <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">ScheduleUtils</span><span class="token punctuation">.</span><span class="token function">createScheduleJob</span><span class="token punctuation">(</span>scheduler<span class="token punctuation">,</span> scheduleJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">ScheduleUtils</span><span class="token punctuation">.</span><span class="token function">updateScheduleJob</span><span class="token punctuation">(</span>scheduler<span class="token punctuation">,</span> scheduleJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>项目启动时，会执行这段代码，加载 schedule_job 中的数据到 quartz 的表当中，确保 quartz 中执行的情况与我们自定义表中执行情况一样 schedule_job，但其实这里我觉得可能有个 bug，就是如果 quartz 中存在 我们自定义表中不存在的执行计划和任务呢，虽然这种情况一般是不太可能的</p> 
<h3><a id="_94"></a>如何创建一个定时任务</h3> 
<h4><a id="_ITask__run__96"></a>首先我们需要集成 ITask 接口创建一个类，并重写 run() 方法</h4> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 定时任务接口，所有定时任务都要实现该接口
 *
 * @author Mark sunlightcs@gmail.com
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ITask</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 执行定时任务接口
     *
     * @param params   参数，多参数使用JSON数据
     */</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"myTask"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token keyword">implements</span> <span class="token class-name">ITask</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">MyService</span> myService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span> params<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"myTask定时任务正在执行，执行参数是: "</span> <span class="token operator">+</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>记得需要用 @Component(“myTask”) 把我们的实现类注册成一个 bean</p> 
<h4><a id="_saveJob__132"></a>调用 saveJob 方法创建</h4> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 保存定时任务
	 */</span>
	<span class="token annotation punctuation">@SysLog</span><span class="token punctuation">(</span><span class="token string">"保存定时任务"</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/save"</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@RequiresPermissions</span><span class="token punctuation">(</span><span class="token string">"sys:schedule:save"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">ScheduleJobEntity</span> scheduleJob<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token class-name">ValidatorUtils</span><span class="token punctuation">.</span><span class="token function">validateEntity</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">)</span><span class="token punctuation">;</span>

		scheduleJobService<span class="token punctuation">.</span><span class="token function">saveJob</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token comment">// 保证事务</span>
	<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveJob</span><span class="token punctuation">(</span><span class="token class-name">ScheduleJobEntity</span> scheduleJob<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		scheduleJob<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		scheduleJob<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Constant<span class="token punctuation">.</span>ScheduleStatus</span><span class="token punctuation">.</span>NORMAL<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. 写 schedule_job 表 </span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 2. 同时在 quartz 中创建</span>
        <span class="token class-name">ScheduleUtils</span><span class="token punctuation">.</span><span class="token function">createScheduleJob</span><span class="token punctuation">(</span>scheduler<span class="token punctuation">,</span> scheduleJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">/**
     * 创建定时任务
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createScheduleJob</span><span class="token punctuation">(</span><span class="token class-name">Scheduler</span> scheduler<span class="token punctuation">,</span> <span class="token class-name">ScheduleJobEntity</span> scheduleJob<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//构建job信息</span>
            <span class="token class-name">JobDetail</span> jobDetail <span class="token operator">=</span> <span class="token class-name">JobBuilder</span><span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span><span class="token class-name">ScheduleJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token function">getJobKey</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//表达式调度构建器</span>
            <span class="token class-name">CronScheduleBuilder</span> scheduleBuilder <span class="token operator">=</span> <span class="token class-name">CronScheduleBuilder</span><span class="token punctuation">.</span><span class="token function">cronSchedule</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">.</span><span class="token function">getCronExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token comment">// 3. 注意下这里使用的 misfire 策略，超过触发时间，直接丢弃，misfire 这块关联前面配置文件配置</span>
            		<span class="token punctuation">.</span><span class="token function">withMisfireHandlingInstructionDoNothing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//按新的cronExpression表达式构建一个新的trigger</span>
            <span class="token class-name">CronTrigger</span> trigger <span class="token operator">=</span> <span class="token class-name">TriggerBuilder</span><span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token function">getTriggerKey</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span>scheduleBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//放入参数，运行时的方法可以获取</span>
            jobDetail<span class="token punctuation">.</span><span class="token function">getJobDataMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ScheduleJobEntity</span><span class="token punctuation">.</span>JOB_PARAM_KEY<span class="token punctuation">,</span> scheduleJob<span class="token punctuation">)</span><span class="token punctuation">;</span>

            scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//暂停任务</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Constant<span class="token punctuation">.</span>ScheduleStatus</span><span class="token punctuation">.</span>PAUSE<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            	<span class="token function">pauseJob</span><span class="token punctuation">(</span>scheduler<span class="token punctuation">,</span> scheduleJob<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SchedulerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RRException</span><span class="token punctuation">(</span><span class="token string">"创建定时任务失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>重点关注下 service 实现，首先写 schedule 库，然后写 quartz</p> 
<p>utils 使用的是 cron trigger，这种也是最灵活的方式，另外一种方式是 Simple</p> 
<p>定时任务创建好默认是关闭的，调用 resume 开启即可</p> 
<h3><a id="_198"></a>定时任务是如何记录日志的</h3> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 定时任务
 *
 * @author Mark sunlightcs@gmail.com
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduleJob</span> <span class="token keyword">extends</span> <span class="token class-name">QuartzJobBean</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">executeInternal</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JobExecutionException</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 1. context 中可以拿到 schedule 信息，每一次任务调度都会创建一个这样的 context</span>
        <span class="token class-name">ScheduleJobEntity</span> scheduleJob <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ScheduleJobEntity</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getMergedJobDataMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        		<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ScheduleJobEntity</span><span class="token punctuation">.</span>JOB_PARAM_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2. 在 Spring 容器中根据 beanName 获取 bean</span>
        <span class="token class-name">ScheduleJobLogService</span> scheduleJobLogService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ScheduleJobLogService</span><span class="token punctuation">)</span> <span class="token class-name">SpringContextUtils</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"scheduleJobLogService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//数据库保存执行记录</span>
        <span class="token class-name">ScheduleJobLogEntity</span> log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleJobLogEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">setJobId</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">setBeanName</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">setParams</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//任务开始时间</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//执行任务</span>
        	logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务准备执行，任务ID："</span> <span class="token operator">+</span> scheduleJob<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 3.这里根据 beanName 拿到 对象 然后调用反射执行</span>
			<span class="token class-name">Object</span> target <span class="token operator">=</span> <span class="token class-name">SpringContextUtils</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Method</span> method <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> scheduleJob<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//任务执行总时长</span>
			<span class="token keyword">long</span> times <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
			log<span class="token punctuation">.</span><span class="token function">setTimes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//任务状态    0：成功    1：失败</span>
			log<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务执行完毕，任务ID："</span> <span class="token operator">+</span> scheduleJob<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  总共耗时："</span> <span class="token operator">+</span> times <span class="token operator">+</span> <span class="token string">"毫秒"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"任务执行失败，任务ID："</span> <span class="token operator">+</span> scheduleJob<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//任务执行总时长</span>
			<span class="token keyword">long</span> times <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
			log<span class="token punctuation">.</span><span class="token function">setTimes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//任务状态    0：成功    1：失败</span>
			log<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			log<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
			scheduleJobLogService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们继承扩展 <code>QuartzJobBean</code>，重写 <code>executeInternal</code> 方法，实现扩展</p> 
<pre><code class="prism language-java"><span class="token comment">//构建job信息</span>
<span class="token class-name">JobDetail</span> jobDetail <span class="token operator">=</span> <span class="token class-name">JobBuilder</span><span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span><span class="token class-name">ScheduleJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token function">getJobKey</span><span class="token punctuation">(</span>scheduleJob<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>构造 JobDetail 的时候传入了我们扩展的 QuartzJobBean</p> 
<p>使用反射调用我们需要执行的方法，并传入 我们需要传入的参数（很巧妙），然后类似环绕通知的方式，在方法执行的前后记录日志，就实现定时任务日志记录的扩展了</p> 
<h3><a id="ps_272"></a>ps</h3> 
<p>参考博客</p> 
<p><a href="https://www.jianshu.com/p/2a5d3b6336ba" rel="nofollow">Quartz框架（一）—Quartz的基本配置 - 简书 (jianshu.com)</a></p> 
<p>关于quartz 集群模式下如何使用行锁竞争来实现</p> 
<p>关于 job 执行的状态机</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/15a3cdba5ac93f5c6e3e17231ecd6765/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Excel】乱序不同行数的两列数据对比匹配</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cd521fc6002fd1daebd056db99d79fef/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深入浅出MFC之6大技术 消息映射（ DECLARE_MESSAGE_MAP） 和命令传递 ON_NOTIFY ON_COMMAND ON_MESSAGE 三大难点解析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>