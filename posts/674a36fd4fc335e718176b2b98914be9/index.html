<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL优化篇：执行计划explain中key_len计算方式 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL优化篇：执行计划explain中key_len计算方式" />
<meta property="og:description" content="概述 key_len表示索引使用的字节数，根据这个值可以判断索引的使用情况，特别是在使用联合索引的时候，判断该索引有多少部分被使用到非常重要。
key_len的长度计算公式很重要（key_len越小，说明索引效果越好）
准备结构和数据 在MySQL数据库中，新建表，表名为key_len_demo
CREATE TABLE `key_len_demo` ( `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, `name` CHAR(20) NOT NULL DEFAULT &#39;&#39;, `address` CHAR(20) DEFAULT NULL, `remark` VARCHAR(20) NOT NULL DEFAULT &#39;&#39;, PRIMARY KEY (`id`), KEY `name` (`name`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8; 向表中插入几条示例数据，便于演示
INSERT INTO `jdbc`.`key_len_demo` (`id`, `name`, `address`, `remark`) VALUES (&#39;1&#39;, &#39;张三&#39;, &#39;上海道&#39;, &#39;测试1&#39;); INSERT INTO `jdbc`.`key_len_demo` (`id`, `name`, `address`, `remark`) VALUES (&#39;2&#39;, &#39;李四&#39;, &#39;杭州道&#39;, &#39;测试2&#39;); INSERT INTO `jdbc`.`key_len_demo` (`id`, `name`, `address`, `remark`) VALUES (&#39;3&#39;, &#39;王五&#39;, &#39;福建到道&#39;, &#39;3000&#39;); INSERT INTO `jdbc`." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/674a36fd4fc335e718176b2b98914be9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-02T15:22:33+08:00" />
<meta property="article:modified_time" content="2020-04-02T15:22:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL优化篇：执行计划explain中key_len计算方式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>概述</h3> 
<p>key_len表示索引使用的字节数，根据这个值可以判断索引的使用情况，特别是在使用联合索引的时候，判断该索引有多少部分被使用到非常重要。<br> key_len的长度计算公式很重要（<strong>key_len越小，说明索引效果越好）</strong></p> 
<h3><a id="_5"></a>准备结构和数据</h3> 
<p>在MySQL数据库中，新建表，表名为<code>key_len_demo</code></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>key_len_demo<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>address<span class="token punctuation">`</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>remark<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> 
<p>向表中插入几条示例数据，便于演示</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>jdbc<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>key_len_demo<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>remark<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'上海道'</span><span class="token punctuation">,</span> <span class="token string">'测试1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>jdbc<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>key_len_demo<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>remark<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token string">'杭州道'</span><span class="token punctuation">,</span> <span class="token string">'测试2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>jdbc<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>key_len_demo<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>remark<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token string">'福建到道'</span><span class="token punctuation">,</span> <span class="token string">'3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>jdbc<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>key_len_demo<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>remark<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'赵柳'</span><span class="token punctuation">,</span> <span class="token string">'杭州道'</span><span class="token punctuation">,</span> <span class="token string">'2500'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>上面的表结构非常简单，有一个主键索引（id字段），还有一个辅助索引（name字段）。下面将以此为例，来分析一下执行计划，看看key_len是如何计算的。</p> 
<ul><li> <p>如果是单列索引不用去计算，因为没有意义；</p> </li><li> <p>如果是组合索引，知道key_len的长度是非常有意义的。</p> </li><li> <p><strong>key_len越小，说明索引效果越好</strong></p> </li></ul> 
<h3><a id="key_len_37"></a>单列索引的key_len计算</h3> 
<p><img src="https://images2.imgbox.com/9b/e8/zAN1MkoG_o.png" alt="在这里插入图片描述"></p> 
<p>由上图可知，key_len的长度是60，那么这个60是如何计算出来的呢？</p> 
<p>在创建key_len_demo表的语句中，==<code>name</code> CHAR(20) NOT NULL DEFAULT ‘’==定义了name字段为char(20),且非空</p> 
<p>表用的是utf8字符集，我们知道<a href="https://blog.csdn.net/u012068483/article/details/105257523">utf8字符集占用3个字节</a>，name字段又是char(20)，所以可知60的来源是<code>key_len=20*3=60</code></p> 
<p><strong>同理，按照上面的思路可以验证其他单列索引key_len的情况</strong></p> 
<p><strong>1)整数类型</strong></p> 
<ul><li>tinyint类型的索引长度，在NOT NULL 和 NULL 的时候 分别是1和2,tinyint字段长度为1，因为NULL 需要额外一个字节标记为空</li><li>bigint类型的索引长度，同样是 NOT NULL 和 NULL值的时候，分别是8和9</li><li>smallint类型索引长度，同样是 NOT NULL 和 NULL值的时候，分别是2和3 smallint长度为2，允许为空需要一个字节标记</li><li>mediumint类型索引长度，同样是 NOT NULL 和 NULL值的时候，分别是3和4</li></ul> 
<p><strong>2)浮点数类型</strong></p> 
<ul><li> <p>float类型的索引长度，NOT NULL和NULL的时候，分别是4和5</p> </li><li> <p>double类型的索引长度，NOT NULL和NULL的时候，分别是8和9</p> </li></ul> 
<p><strong>3)时间类型</strong></p> 
<ul><li>date类型的索引长度，在NOT NULL和NULL的时候，分别是3和4</li><li>timestamp类型的时候索引长度，在NOT NULL 和 NULL的时候，分别是4和5</li></ul> 
<h3><a id="key_len_67"></a>联合索引的key_len计算</h3> 
<h4><a id="1_69"></a><strong>案例1</strong></h4> 
<p>现将key_len_demo表上name这个字段的索引去掉，添加一个联合索引key(name,address)</p> 
<p><img src="https://images2.imgbox.com/37/7a/iCRx45TS_o.jpg" alt="在这里插入图片描述"></p> 
<p>下面分别执行以下两条SQL语句，具体如下</p> 
<p><img src="https://images2.imgbox.com/31/28/dYldIUvb_o.png" alt="在这里插入图片描述"></p> 
<p>上图可知，第一条查询和第二条查询的执行计划中的key_len和ref不一样？为什么第二条SQL语句的key_len为121，这是如何计算的呢？</p> 
<p>在建表语句中，address字段信息为char(20) DEFAULT NULL,可以发现address字段的定义为DEFAULT NULL，其他没有变化。所以MySQL需要<code>1个字节</code>来标识NULL，所以第二条SQL的key_len=20*3+（20*3+1）=121，通过计算，可知2个字段的索引完全用上了。</p> 
<h4><a id="2_83"></a><strong>案例2</strong></h4> 
<p>在表key_len_demo中添加一个字段，并添加一个联合索引，便于进行范围查询，如下如下：</p> 
<p><img src="https://images2.imgbox.com/4d/b2/tuWyIvh1_o.png" alt="在这里插入图片描述"></p> 
<p>给表key_len_demo添加create_time字段，并建立联合索引(create_time,remark)</p> 
<p>接下来执行以下的SQL语句，分析执行计划中的key_len</p> 
<p><img src="https://images2.imgbox.com/ce/25/kdHS5rgI_o.png" alt="在这里插入图片描述"></p> 
<p>可以看出用到了创建的联合索引idx_key_create_time_remark，但是是否完全用到了呢？实际上，从type可知是一个范围查询，肯定没有完全用到。后面字段的索引就用不到，若果这里不order by null，还会看到Using filesort。</p> 
<p>我们知道timestamp占用4个字节，显而易见，看见key_len是4，说明只用到了联合索引idx_key_create_time_remark中的create_time字段。</p> 
<h4><a id="3_99"></a><strong>案例3</strong></h4> 
<p>再看分析由char字段和varchar字段组成的联合索引的情况，在表中新增联合索引，具体如下：</p> 
<p><img src="https://images2.imgbox.com/45/a6/Dccp15X3_o.png" alt="在这里插入图片描述"></p> 
<p>执行以下SQL语句，分析执行计划</p> 
<p><img src="https://images2.imgbox.com/d1/45/XQcboQyM_o.png" alt="在这里插入图片描述"></p> 
<p>可以看出key_len的长度是123。索引是否完全用到了呢？稍微了解索引内容的，可以知道完全用到了。那么key_len是如何计算的呢？</p> 
<blockquote> 
 <p><strong>address字段是char(20) DEFAULT NULL、remark字段是varchar(20) NOT NULL DEFAULT ''</strong></p> 
</blockquote> 
<p>从2个字段的定义来看，1个允许NULL，一个NOT NULL；一个char，一个varchar</p> 
<p>所以key_len=(20*3+1)+(20*3+2)=123，其中,+1是因为MySQL需要1个字节标识NULL，+2是因为remark字段为varchar，是变长字段需要+2。</p> 
<h4><a id="4_117"></a><strong>案例4</strong></h4> 
<p>再来分析一下，key_len<code>关注索引的位置</code>，是where 、order by、group by中的索引都关注呢还是只关注某一部分？</p> 
<p>建立联合索引idx_key_address_remark(address,remark)，执行下面的SQL语句，关注执行计划信息</p> 
<p><img src="https://images2.imgbox.com/63/df/UL6vwSjk_o.png" alt="在这里插入图片描述"></p> 
<p>如上图可知，key_len只指示了<strong>where</strong>中用于条件过滤时被选中的索引列，<mark>是不包含order by、group by这一部分被选中的索引列的。</mark></p> 
<h3><a id="_128"></a>总结</h3> 
<p>在计算key_len时，需要考虑以下几点：</p> 
<p>1)注意<strong>索引字段的附加信息</strong></p> 
<ul><li> <p>可以分为变长和定长数据类型，当索引字段为定长数据类型时，如char、int、datetime，需要有是否为空的标记，这个标记占用1个字节（对于not null的字段来说，则不需要这1个字节）</p> </li><li> <p>对于变长数据类型，比如varchar，除了是否为空的标记之外，还需要有长度信息，需要占用2个字节</p> </li></ul> 
<ol start="2"><li><strong>char、varchar、blob、text等字符集来说，key_len的长度还和字符集有关</strong></li></ol> 
<ul><li> <p>在latin1字符集中，一个字符占用<mark>1</mark>个字节</p> </li><li> <p>在GBK字符集中，一个字符占用<mark>2</mark>个字节</p> </li><li> <p>在utf8字符集中，一个字符占用<mark>3</mark>个字节</p> </li></ul> 
<p><strong>3) 整数类型、浮点数类型、时间类型的索引长度</strong></p> 
<ul><li>NOT NULL=字段本身的字段长度</li><li>NULL=字段本身的字段长度+1，因为需要有是否为空的标记，这个标记需要占1个字节</li><li>datetime类型在5.6中字段长度是5个字节</li></ul> 
<hr> 
<p><strong>varchr(20)变长字段且允许NULL</strong></p> 
<p><mark>20 * ( character set：utf8=3,gbk=2,latin1=1)+1(NULL)+2(变长字段)</mark></p> 
<p><strong>varchr(20)变长字段且不允许NULL</strong></p> 
<p><mark>20 *( character set：utf8=3,gbk=2,latin1=1)+2(变长字段)</mark></p> 
<p><strong>char(20)固定字段且允许NULL</strong></p> 
<p><mark>20 * ( character set：utf8=3,gbk=2,latin1=1)+1(NULL)</mark></p> 
<p><strong>char(20)固定字段且不允许NULL</strong></p> 
<p><mark>20 * ( character set：utf8=3,gbk=2,latin1=1)</mark></p> 
<hr> 
<p><strong>在MySQL数据库中，执行计划中的key_len长度计算公式如下：</strong></p> 
<table><thead><tr><th align="left">列类型</th><th align="left">key_len计算公式</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">int</td><td align="left">key_len=4 +1</td><td align="left">int占用4个字节，允许为NULL时，+1字节</td></tr><tr><td align="left">bigint not null</td><td align="left">ken_len =8</td><td align="left">bigint占8个字节</td></tr><tr><td align="left">char(30) utf8</td><td align="left">key_len=30*3+1</td><td align="left">utf8每个字符占3字节，允许为NULL时，+1字节</td></tr><tr><td align="left">varchar(30) not null utf8</td><td align="left">ken_len=30*3+2</td><td align="left">utf8每个字符为3字节，变长数据类型+2字节</td></tr><tr><td align="left">varchar(30) utf8</td><td align="left">ken_len=30*3+2+1</td><td align="left">utf8每个字符为3字节，允许为NULL时，+1字节，变长数据类型+2字节</td></tr></tbody></table>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e210b8dbf353dd57d8f99fa0ef812238/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">渗透测试工具对比表</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0af6e652563c9957119d8f43cbf0542a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Hadoop】YouTube 视频数据集分析实验 (原理&#43;过程&#43;代码)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>