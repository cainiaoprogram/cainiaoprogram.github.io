<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>latent diffusion model 复现问题记录 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="latent diffusion model 复现问题记录" />
<meta property="og:description" content="latent diffusion model 复现问题记录 按照官方github配置虚拟环境下载预训练模型ModuleNotFoundError: No module named &#39;ldm&#39;生成数据集效果展示参考链接 按照官方github配置虚拟环境 官方github地址：
latent diffusion model
下载environment.yaml和setup.py文件进行环境配置
conda env create -f environment.yaml
conda activate ldm
在配置环境的过程中，会出现报错
Installing pip dependencies: \ Ran pip subprocess with arguments: [&#39;/home/****/.conda/envs/ldm/bin/python&#39;, &#39;-m&#39;, &#39;pip&#39;, &#39;install&#39;, &#39;-U&#39;, &#39;-r&#39;, &#39;/mnt/****/****/latent-diffusion-main/condaenv.ie4dsr_m.requirements.txt&#39;] Pip subprocess output: Obtaining taming-transformers from git&#43;https://github.com/CompVis/taming-transformers.git@master#egg=taming-transformers (from -r /mnt/****/****/latent-diffusion-main/condaenv.ie4dsr_m.requirements.txt (line 13)) Cloning https://github.com/CompVis/taming-transformers.git (to revision master) to ./src/taming-transformers Pip subprocess error: ERROR: Command errored out with exit status 128: git clone -q https://github." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8361cf1f76ae42d4048808ac150f6927/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-28T17:02:48+08:00" />
<meta property="article:modified_time" content="2023-05-28T17:02:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">latent diffusion model 复现问题记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>latent diffusion model 复现问题记录</h4> 
 <ul><li><a href="#github_1" rel="nofollow">按照官方github配置虚拟环境</a></li><li><a href="#_42" rel="nofollow">下载预训练模型</a></li><li><a href="#ModuleNotFoundError_No_module_named_ldm_47" rel="nofollow">ModuleNotFoundError: No module named 'ldm'</a></li><li><a href="#_52" rel="nofollow">生成数据集</a></li><li><a href="#_68" rel="nofollow">效果展示</a></li><li><a href="#_72" rel="nofollow">参考链接</a></li></ul> 
</div> 
<p></p> 
<h2><a id="github_1"></a>按照官方github配置虚拟环境</h2> 
<p>官方github地址：<br> <a href="https://github.com/CompVis/latent-diffusion">latent diffusion model</a></p> 
<p>下载<strong>environment.yaml</strong>和<strong>setup.py</strong>文件进行环境配置<br> <code>conda env create -f environment.yaml</code><br> <code>conda activate ldm</code><br> 在配置环境的过程中，会出现报错</p> 
<pre><code class="prism language-powershell">Installing pip dependencies: \ Ran pip subprocess with arguments:
<span class="token punctuation">[</span><span class="token string">'/home/****/.conda/envs/ldm/bin/python'</span><span class="token punctuation">,</span> <span class="token string">'-m'</span><span class="token punctuation">,</span> <span class="token string">'pip'</span><span class="token punctuation">,</span> <span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token string">'-U'</span><span class="token punctuation">,</span> <span class="token string">'-r'</span><span class="token punctuation">,</span> <span class="token string">'/mnt/****/****/latent-diffusion-main/condaenv.ie4dsr_m.requirements.txt'</span><span class="token punctuation">]</span>
Pip subprocess output:
Obtaining taming-transformers <span class="token keyword">from</span> git+https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/CompVis/taming-transformers<span class="token punctuation">.</span>git@master<span class="token comment">#egg=taming-transformers (from -r /mnt/****/****/latent-diffusion-main/condaenv.ie4dsr_m.requirements.txt (line 13))</span>
  Cloning https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/CompVis/taming-transformers<span class="token punctuation">.</span>git <span class="token punctuation">(</span>to revision master<span class="token punctuation">)</span> to <span class="token punctuation">.</span><span class="token operator">/</span>src/taming-transformers

Pip subprocess error:
ERROR: Command errored out with <span class="token keyword">exit</span> status 128: git clone <span class="token operator">-</span>q https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/CompVis/taming-transformers<span class="token punctuation">.</span>git <span class="token operator">/</span>mnt/<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">/</span>latent-diffusion-main/src/taming-transformers Check the logs <span class="token keyword">for</span> full command output<span class="token punctuation">.</span>
                                                                                                                                                       failed

CondaEnvException: Pip failed
</code></pre> 
<p>这是由于<strong>environment.yaml</strong>的下面两行导致的</p> 
<pre><code class="prism language-powershell"><span class="token comment">#environment.yaml</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  	<span class="token operator">-</span> <span class="token operator">-</span>e git+https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/CompVis/taming-transformers<span class="token punctuation">.</span>git@master<span class="token comment">#egg=taming-transformers</span>
    <span class="token operator">-</span> <span class="token operator">-</span>e git+https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/openai/CLIP<span class="token punctuation">.</span>git@main<span class="token comment">#egg=clip</span>
    <span class="token operator">-</span> <span class="token operator">-</span>e <span class="token punctuation">.</span>

</code></pre> 
<p>这时候可以直接把这两行注释掉，利用下面的命令进行手动安装，<br> <code>pip install taming-transformers</code><br> <code>pip install clip</code><br> 在这个路径下可以看到两个安装的模型即<strong>安装成功</strong><br> <code>/home/user/.conda/envs/ldm/lib/python3.8/site-packages/xxx(taming, clip)/</code><br> 如果第一次安装出现了问题，可以使用以下命令<strong>更新环境</strong><br> <code>conda env update -n environment_name -f environment.yaml</code></p> 
<h2><a id="_42"></a>下载预训练模型</h2> 
<p>官方已经给出了各个数据集的预训练模型，直接点连接下载即可。<br> <img src="https://images2.imgbox.com/6a/a7/ifC2otBP_o.png" alt="预训练模型"><br> 下载的模型要进行一步解压，并且要从<code>/models/ldm/ffhq256/</code>下载一个<strong>config.yaml</strong>文件放到该目录下(之后会用到, 并且会省去很多不必要的麻烦)，目录结构如图所示<br> <img src="https://images2.imgbox.com/7a/57/ZYoTEBHG_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="ModuleNotFoundError_No_module_named_ldm_47"></a>ModuleNotFoundError: No module named ‘ldm’</h2> 
<p>按道理来说，环境到这里就算配置完成了，但是有一个巨坑一定要注意！！！！如果直接运行sample-diffusion.py，会出现<strong>ModuleNotFoundError: No module named 'ldm’<strong>的错误，这时候</strong>不要用pip install ldm手动安装</strong>，因为此ldm非彼ldm啊啊啊啊啊！<br> 这时候可以下载整个项目，把<strong>sample-diffusion.py放在和ldm文件夹的同一级目录下</strong>，才可以引包成功！！！试了半天绝对路径的调用方法，不如直接调换代码文件的位置来的快~<br> <img src="https://images2.imgbox.com/3e/f6/2EDNUcaB_o.png" alt="在这里插入图片描述"><br> 基于此，就可以按照官方给的指令运行代码，生成自己的数据集了</p> 
<h2><a id="_52"></a>生成数据集</h2> 
<pre><code class="prism language-powershell">CUDA_VISIBLE_DEVICES=&lt;GPU_ID&gt; python scripts/sample_diffusion<span class="token punctuation">.</span>py <span class="token operator">-</span>r models/ldm/&lt;model_spec&gt;<span class="token operator">/</span>model<span class="token punctuation">.</span>ckpt <span class="token operator">-</span>l &lt;logdir&gt; <span class="token operator">-</span>n &lt;\<span class="token comment">#samples&gt; --batch_size &lt;batch_size&gt; -c &lt;\#ddim steps&gt; -e &lt;\#eta&gt; </span>
</code></pre> 
<p>参数可以根据自己的需求设置<br> 在运行的过程中，如果出现<br> <img src="https://images2.imgbox.com/da/4c/SLDqa9X0_o.png" alt="在这里插入图片描述"><br> 或者<br> <img src="https://images2.imgbox.com/7d/45/7GcJROXG_o.png" alt="在这里插入图片描述"><br> 则说明自己的config.yaml文件没有放对位置，要放在和model.ckpt相同的目录下。<br> 此外，如果出现**ModuleNotFoundError: No module named ‘XXX’ **则说明包的版本不对，可以按照environment.yaml的要求，替换成正确的包。<br> 如果出现<br> <img src="https://images2.imgbox.com/f1/c3/gp2meW3z_o.png" alt="在这里插入图片描述"><br> 则把quantize.py替换成下面连接里的代码<br> <a href="https://github.com/CompVis/taming-transformers/blob/master/taming/modules/vqvae/quantize.py">quantize.py</a></p> 
<h2><a id="_68"></a>效果展示</h2> 
<p>到此为止，应该就可以生成自己的图片了生成效果如下</p> 
<p><img src="https://images2.imgbox.com/95/c5/Bjftb1Fy_o.png" alt="在这里插入图片描述"> <img src="https://images2.imgbox.com/80/72/wlG2UWRq_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_72"></a>参考链接</h2> 
<p>新手第一次上路，遇到了许多问题，感谢前人总结的经验！<br> <a href="https://blog.csdn.net/qq_37236149/article/details/127195766">复现问题记录 | Stable Diffusion(LDM) (in python3)（一）</a><br> <a href="https://blog.csdn.net/qq_44250700/article/details/125347656">ImportError: cannot import name ‘get_num_classes’ from ‘torchmetrics.utilities.data’</a><br> <a href="https://github.com/rinongal/textual_inversion/issues/58">ImportError: cannot import name ‘VectorQuantizer2’ from ‘taming.modules.vqvae.quantize’</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aeac64b1bfaeb284e17005e56dc8c963/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C&#43;&#43;】Map、Set 模拟实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5fb9dea20fed3f45eb39c190c00a8db1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">PCA主成分分析 | 机器学习</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>