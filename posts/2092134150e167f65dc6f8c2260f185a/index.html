<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>马房山实验报告大学Python大作业——YouTube视频趋势分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="马房山实验报告大学Python大作业——YouTube视频趋势分析" />
<meta property="og:description" content="武汉理工大学Python高级程序设计大作业——YouTube视频趋势分析 要求任务描述 源代码main_mac.pyconfig.py 要求 数据来源：https://www.kaggle.com/datasnaek/youtube-new
Kaggle提供的数据集包括4个国家的热门YouTube视频的每日记录。每个国家的数据文件为一个CSV文件及一个JSON文件。
任务描述 ① 绘制每个国家指定列的的top10，如category，channel_title等；
② 统计视频发布后上榜的天数；
③ 查看views, likes, dislikes, comment_count的关系；
④ 按月份统计不同国家发布的视频数量，并用柱状图进行可视化。
以及附加要求中还有关联读写数据库、进行数据清洗等要求。
源代码 代码直接cv过去是无法运行的，有一些关于环境的bug。理解为重，酌情cv。
代码参考：数据分析~案例：YouTube视频趋势分析
main_mac.py 在main_mac.py主程序文件中，虽然使用了MySQL数据库，实现了数据库的读写函数，但是实际上并没有从数据库读取或者写入。各位将读取文件的代码片转换成读取MySQL数据库的函数即可。
若使用MySQL Workbench等数据库GUI工具的话，可以直接通过图形界面将.csv文件和.json文件手动导入数据库中，无需代码导入，程序中只需完成读操作即可。
主程序在计算皮尔逊相关系数时，计算量较大，所花费的计算时间会较长，所以运行时在显示相关系数的图像之前需要等待一段时间。
#-*- coding: utf-8 -*- &#39;&#39;&#39; 由于macOS自带且默认使用Python 2.7，这里声明Python版本以避免某些bug； 或者在终端运行时使用python3。 &#39;&#39;&#39; #! python3 import os import platform import pandas as pd import numpy as np import json import matplotlib.pyplot as plt import seaborn as sns from pyecharts import Bar, Line, Overlap from matplotlib.font_manager import FontProperties # import MySQLdb import pymysql import csv import codecs # 由于我使用纯文本编辑器编写，这里使用pysnooper进行调试 import pysnooper # 导入config." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2092134150e167f65dc6f8c2260f185a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-08T23:51:06+08:00" />
<meta property="article:modified_time" content="2021-01-08T23:51:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">马房山实验报告大学Python大作业——YouTube视频趋势分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>武汉理工大学Python高级程序设计大作业——YouTube视频趋势分析</h4> 
 <ul><li><a href="#_2" rel="nofollow">要求</a></li><li><ul><li><a href="#_7" rel="nofollow">任务描述</a></li></ul> 
  </li><li><a href="#_18" rel="nofollow">源代码</a></li><li><ul><li><a href="#main_macpy_22" rel="nofollow">main_mac.py</a></li><li><a href="#configpy_334" rel="nofollow">config.py</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>要求</h2> 
<p>数据来源：<a href="https://www.kaggle.com/datasnaek/youtube-new" rel="nofollow">https://www.kaggle.com/datasnaek/youtube-new</a></p> 
<p>Kaggle提供的数据集包括4个国家的热门YouTube视频的每日记录。每个国家的数据文件为一个CSV文件及一个JSON文件。</p> 
<h3><a id="_7"></a>任务描述</h3> 
<p>① 绘制每个国家指定列的的top10，如category，channel_title等；</p> 
<p>② 统计视频发布后上榜的天数；</p> 
<p>③ 查看views, likes, dislikes, comment_count的关系；</p> 
<p>④ 按月份统计不同国家发布的视频数量，并用柱状图进行可视化。</p> 
<p>以及附加要求中还有关联读写数据库、进行数据清洗等要求。</p> 
<h2><a id="_18"></a>源代码</h2> 
<p>代码直接cv过去是无法运行的，有一些关于环境的bug。理解为重，酌情cv。<br> 代码参考：<a href="https://www.cnblogs.com/arthur-54271/p/9371231.html" rel="nofollow">数据分析~案例：YouTube视频趋势分析</a></p> 
<h3><a id="main_macpy_22"></a>main_mac.py</h3> 
<p>在main_mac.py主程序文件中，虽然使用了MySQL数据库，实现了数据库的读写函数，但是实际上并没有从数据库读取或者写入。各位将读取文件的代码片转换成读取MySQL数据库的函数即可。</p> 
<p>若使用MySQL Workbench等数据库GUI工具的话，可以直接通过图形界面将.csv文件和.json文件手动导入数据库中，无需代码导入，程序中只需完成读操作即可。</p> 
<p>主程序在计算皮尔逊相关系数时，计算量较大，所花费的计算时间会较长，所以运行时在显示相关系数的图像之前需要等待一段时间。</p> 
<pre><code class="prism language-python"><span class="token comment">#-*- coding: utf-8 -*-</span>
<span class="token triple-quoted-string string">'''
    由于macOS自带且默认使用Python 2.7，这里声明Python版本以避免某些bug；
    或者在终端运行时使用python3。
'''</span>
<span class="token comment">#! python3</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> platform
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> json
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns
<span class="token keyword">from</span> pyecharts <span class="token keyword">import</span> Bar<span class="token punctuation">,</span> Line<span class="token punctuation">,</span> Overlap
<span class="token keyword">from</span> matplotlib<span class="token punctuation">.</span>font_manager <span class="token keyword">import</span> FontProperties
<span class="token comment"># import MySQLdb</span>
<span class="token keyword">import</span> pymysql
<span class="token keyword">import</span> csv
<span class="token keyword">import</span> codecs
<span class="token comment"># 由于我使用纯文本编辑器编写，这里使用pysnooper进行调试</span>
<span class="token keyword">import</span> pysnooper
<span class="token comment"># 导入config.py文件</span>
<span class="token keyword">import</span> config


<span class="token comment"># 解决matplotlib显示中文问题</span>
<span class="token comment"># 仅适用于Mac</span>
<span class="token keyword">def</span> <span class="token function">get_chinese_font</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> sysstr
    <span class="token comment"># 若为macOS</span>
    <span class="token keyword">if</span> sysstr <span class="token operator">==</span> <span class="token string">'Darwin'</span><span class="token punctuation">:</span>
    <span class="token comment"># 使用 苹方-简 字体</span>
	    <span class="token keyword">return</span> FontProperties<span class="token punctuation">(</span>fname<span class="token operator">=</span><span class="token string">'/System/Library/Fonts/PingFang.ttc'</span><span class="token punctuation">)</span>
    <span class="token comment"># 若为Linux</span>
    <span class="token keyword">elif</span> sysstr <span class="token operator">==</span> <span class="token string">'Linux'</span><span class="token punctuation">:</span>
        <span class="token comment"># 在Ubuntu测试平台上没有出现中文字体显示错误的问题</span>
        <span class="token keyword">pass</span>


<span class="token comment"># 这里调用pysnooper监测MySQL是否连接成功</span>
@pysnooper<span class="token punctuation">.</span>snoop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">,</span> passwd<span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token string">'test_csv'</span><span class="token punctuation">,</span> charset<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> conn


<span class="token keyword">def</span> <span class="token function">insert_csv</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    
    
<span class="token keyword">def</span> <span class="token function">query_all</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> cur<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 将本地的.csv文件写入到MySQL数据库中</span>
<span class="token keyword">def</span> <span class="token function">read_csv_to_mysql</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> codecs<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token operator">=</span>filename<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        head <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span>
        conn <span class="token operator">=</span> get_conn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sql <span class="token operator">=</span> <span class="token string">'insert into tb_csv values(%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)'</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> reader<span class="token punctuation">:</span>
            <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>  <span class="token comment"># item[1]作为唯一键，不能为null</span>
                <span class="token keyword">continue</span>
            args <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
            <span class="token comment"># print(args)</span>
            insert<span class="token punctuation">(</span>cur<span class="token punctuation">,</span> sql<span class="token operator">=</span>sql<span class="token punctuation">,</span> args<span class="token operator">=</span>args<span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cur<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        

<span class="token comment"># 将MySQL数据库中的表格写入到本地文件中</span>
<span class="token triple-quoted-string string">'''
    适用于macOS、Linux的相对路径：
    ../data/filename
'''</span>
<span class="token keyword">def</span> <span class="token function">read_mysql_to_csv</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> codecs<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token operator">=</span>filename<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        write <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>f<span class="token punctuation">,</span> dialect<span class="token operator">=</span><span class="token string">'excel'</span><span class="token punctuation">)</span>
        conn <span class="token operator">=</span> get_conn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sql <span class="token operator">=</span> <span class="token string">'select * from tb_csv'</span>
        results <span class="token operator">=</span> query_all<span class="token punctuation">(</span>cur<span class="token operator">=</span>cur<span class="token punctuation">,</span> sql<span class="token operator">=</span>sql<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
            <span class="token comment"># print(result)</span>
            write<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        

<span class="token comment"># 从json文件中获取数据种类</span>
<span class="token keyword">def</span> <span class="token function">get_category_from_json</span><span class="token punctuation">(</span>json_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
    category_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_file<span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data<span class="token operator">=</span>json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        <span class="token keyword">for</span> category <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'items'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            category_dict<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>category<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span>category<span class="token punctuation">[</span><span class="token string">'snippet'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> category_dict


<span class="token comment"># 合并各个国家的数据</span>
<span class="token keyword">def</span> <span class="token function">combine_video_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    video_df_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> country <span class="token keyword">in</span> config<span class="token punctuation">.</span>countries<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'数据处理：'</span><span class="token punctuation">,</span> country<span class="token punctuation">)</span>
        csv_filename<span class="token operator">=</span>country<span class="token operator">+</span><span class="token string">'videos.csv'</span>
        json_filename<span class="token operator">=</span>country<span class="token operator">+</span><span class="token string">'_category_id.json'</span>

        video_df<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>dataset_path<span class="token punctuation">,</span>csv_filename<span class="token punctuation">)</span><span class="token punctuation">,</span> index_col<span class="token operator">=</span><span class="token string">'video_id'</span><span class="token punctuation">,</span>usecols<span class="token operator">=</span>config<span class="token punctuation">.</span>usecols<span class="token punctuation">)</span>
        
        
        <span class="token comment"># 处理时间列</span>
        video_df<span class="token punctuation">[</span><span class="token string">'trending_date'</span><span class="token punctuation">]</span><span class="token operator">=</span>pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>video_df<span class="token punctuation">[</span><span class="token string">'trending_date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%y.%d.%m'</span><span class="token punctuation">)</span>
        video_df<span class="token punctuation">[</span><span class="token string">'publish_time'</span><span class="token punctuation">]</span><span class="token operator">=</span>pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>video_df<span class="token punctuation">[</span><span class="token string">'publish_time'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%Y-%m-%dT%H:%M:%S.%fZ'</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取发布的日期</span>
        video_df<span class="token punctuation">[</span><span class="token string">'publish_time'</span><span class="token punctuation">]</span><span class="token operator">=</span>video_df<span class="token punctuation">[</span><span class="token string">'publish_time'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>date
        video_df<span class="token punctuation">[</span><span class="token string">'publish_date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>video_df<span class="token punctuation">[</span><span class="token string">'publish_time'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 先按想要的格式转为字符串，再转为日期格式</span>
        video_df<span class="token punctuation">[</span><span class="token string">'publish_time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> video_df<span class="token punctuation">.</span>publish_time<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            
        <span class="token comment"># 通过json文件获取category_id对应的名称</span>
        category_dict<span class="token operator">=</span>get_category_from_json<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>dataset_path<span class="token punctuation">,</span>json_filename<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 通过map操作添加category名称列</span>
        video_df<span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span> <span class="token operator">=</span> video_df<span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>category_dict<span class="token punctuation">)</span>

        <span class="token comment"># 添加country列</span>
        video_df<span class="token punctuation">[</span><span class="token string">'country'</span><span class="token punctuation">]</span> <span class="token operator">=</span> country
        video_df_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>video_df<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        # 预览数据
        print('数据预览：')
        print(video_df.head())
        print(video_df['publish_time'])
        '''</span>
    <span class="token comment">#各国家数据合并</span>
    all_video_df<span class="token operator">=</span>pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>video_df_list<span class="token punctuation">)</span>
    <span class="token comment"># 保存结果到一个数据集中</span>
    all_video_df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>output_path<span class="token punctuation">,</span><span class="token string">'all_video.csv'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> all_video_df


<span class="token keyword">def</span> <span class="token function">plot_top10_by_country</span><span class="token punctuation">(</span>video_df<span class="token punctuation">,</span>col_name<span class="token punctuation">,</span>title<span class="token punctuation">,</span>save_filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
           绘制每个国家指定列的的top10
           参数：
               - video_df:         处理后的数据
               - col_name:         列名
               - save_filename:    保存文件名
       """</span>
    fig<span class="token punctuation">,</span>axes<span class="token operator">=</span>plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>countries<span class="token punctuation">)</span><span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> sysstr <span class="token operator">==</span> <span class="token string">'Darwin'</span><span class="token punctuation">:</span>
        <span class="token comment"># 为整幅图添加标题</span>
        fig<span class="token punctuation">.</span>suptitle<span class="token punctuation">(</span>title<span class="token punctuation">,</span>fontproperties<span class="token operator">=</span>get_chinese_font<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span>country <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>countries<span class="token punctuation">)</span><span class="token punctuation">:</span>
        country_video_df<span class="token operator">=</span>video_df<span class="token punctuation">[</span>video_df<span class="token punctuation">[</span><span class="token string">'country'</span><span class="token punctuation">]</span><span class="token operator">==</span>country<span class="token punctuation">]</span>
        <span class="token comment"># 获取指定列的top10</span>
        top10_df<span class="token operator">=</span>country_video_df<span class="token punctuation">[</span>col_name<span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>

        <span class="token comment"># 处理x轴的刻度标签</span>
        x_labels<span class="token operator">=</span><span class="token punctuation">[</span>label<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'...'</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">10</span> <span class="token keyword">else</span> label <span class="token keyword">for</span> label <span class="token keyword">in</span> top10_df<span class="token punctuation">.</span>index<span class="token punctuation">]</span>

        <span class="token comment"># 制图</span>
        sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>x<span class="token operator">=</span>x_labels<span class="token punctuation">,</span>y<span class="token operator">=</span>top10_df<span class="token punctuation">.</span>values<span class="token punctuation">,</span>ax<span class="token operator">=</span>axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_xticklabels<span class="token punctuation">(</span>x_labels<span class="token punctuation">,</span> rotation<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">)</span>
        axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>country<span class="token punctuation">)</span>
    <span class="token comment">#布局紧凑，不会超出画布</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 为子图顶部增加间隔，防止子图的标题和整幅图的标题重叠</span>
    plt<span class="token punctuation">.</span>subplots_adjust<span class="token punctuation">(</span>top<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>
    <span class="token comment">#保存图片</span>
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>output_path<span class="token punctuation">,</span> save_filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">plot_days_to_trend</span><span class="token punctuation">(</span>video_df<span class="token punctuation">,</span> save_filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
        使用pyecharts统计视频发布后上榜的天数
        参数：
            - video_df: 处理后的数据
            - save_filename:    保存文件名
    """</span>
    <span class="token comment"># pandas的版本&gt;=0.20</span>
    video_df<span class="token punctuation">[</span><span class="token string">'diff'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>video_df<span class="token punctuation">[</span><span class="token string">'trending_date'</span><span class="token punctuation">]</span> <span class="token operator">-</span> video_df<span class="token punctuation">[</span><span class="token string">'publish_date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>days
    days_df <span class="token operator">=</span> video_df<span class="token punctuation">[</span><span class="token string">'diff'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 观察视频发布2个月内的情况</span>
    days_df <span class="token operator">=</span> days_df<span class="token punctuation">[</span><span class="token punctuation">(</span>days_df<span class="token punctuation">.</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>days_df<span class="token punctuation">.</span>index <span class="token operator">&lt;=</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    days_df <span class="token operator">=</span> days_df<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    bar<span class="token operator">=</span>Bar<span class="token punctuation">(</span><span class="token string">'视频发布2个月内的情况'</span><span class="token punctuation">)</span>
    bar<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">'柱状图'</span><span class="token punctuation">,</span> days_df<span class="token punctuation">.</span>index<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> days_df<span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            is_datazoom_show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 启用数据缩放功能</span>
            datazoom_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span>  <span class="token comment"># 百分比范围</span>
            <span class="token punctuation">)</span>

    line<span class="token operator">=</span>Line<span class="token punctuation">(</span><span class="token punctuation">)</span>
    line<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">'折线图'</span><span class="token punctuation">,</span> days_df<span class="token punctuation">.</span>index<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> days_df<span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    overlap<span class="token operator">=</span>Overlap<span class="token punctuation">(</span><span class="token punctuation">)</span>
    overlap<span class="token punctuation">.</span>add<span class="token punctuation">(</span>bar<span class="token punctuation">)</span>
    overlap<span class="token punctuation">.</span>add<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    overlap<span class="token punctuation">.</span>render<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>output_path<span class="token punctuation">,</span>save_filename<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">plot_relationship_of_cols</span><span class="token punctuation">(</span>all_video_df<span class="token punctuation">,</span> cols<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
         查看列之间的关系
    """</span>
    sel_video_df <span class="token operator">=</span> all_video_df<span class="token punctuation">[</span>cols <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">'country'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token comment">#变量间关系 pairplot</span>
    <span class="token comment"># #hue : 使用指定变量为分类变量画图。参数类型：string (变量名)</span>
    g<span class="token operator">=</span>sns<span class="token punctuation">.</span>pairplot<span class="token punctuation">(</span>data<span class="token operator">=</span>sel_video_df<span class="token punctuation">,</span>hue<span class="token operator">=</span><span class="token string">'country'</span><span class="token punctuation">)</span>
    g<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>output_path<span class="token punctuation">,</span><span class="token string">'pair_plot.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># heat map</span>
    <span class="token comment"># 计算每两个列之间的皮尔逊相关系数</span>
    <span class="token triple-quoted-string string">'''
    皮尔逊相关系数的变化范围为-1到1。 
    系数的值为1意味着 X 和 Y 可以很好的由直线方程来描述，
    所有的数据点都 很好的落在一条 直线上，且 Y 随着 X 的增加而增加。
    系数的值为−1意味着所有的数据点都落在直线上，且 Y 随着 X 的增加而减少。
    系数的值为0意味着两个变量之间没有线性关系。
    '''</span>
    corr_df<span class="token operator">=</span>sel_video_df<span class="token punctuation">.</span>corr<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sns<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>corr_df<span class="token punctuation">,</span>annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>output_path<span class="token punctuation">,</span><span class="token string">'heat_map.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    
<span class="token comment"># 按月统计各国视频上传量，并用柱状图进行可视化</span>
@pysnooper<span class="token punctuation">.</span>snoop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">plot_monpub_by_country</span><span class="token punctuation">(</span>video_df<span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fig<span class="token punctuation">,</span>axes<span class="token operator">=</span>plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>countries<span class="token punctuation">)</span><span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> sysstr <span class="token operator">==</span> <span class="token string">'Darwin'</span><span class="token punctuation">:</span>
        <span class="token comment"># 为整幅图添加标题</span>
        fig<span class="token punctuation">.</span>suptitle<span class="token punctuation">(</span>title<span class="token punctuation">,</span>fontproperties<span class="token operator">=</span>get_chinese_font<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span>country <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>countries<span class="token punctuation">)</span><span class="token punctuation">:</span>
        country_video_df<span class="token operator">=</span>video_df<span class="token punctuation">[</span>video_df<span class="token punctuation">[</span><span class="token string">'country'</span><span class="token punctuation">]</span><span class="token operator">==</span>country<span class="token punctuation">]</span>
        gp <span class="token operator">=</span> country_video_df<span class="token punctuation">.</span>publish_time<span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
            由于在数据集中，绝大多数的视频发布日期是2017-11月至2018-2月，极少数视频是在其它更早时间发布的，那些其余发布时间的视频数据就是我们此次需要清洗的数据。下面对的for循环作用是将总发布数量小于100的月份数据删除，完成清洗。
        '''</span>
        <span class="token keyword">for</span> aline <span class="token keyword">in</span> gp<span class="token punctuation">.</span>index<span class="token punctuation">:</span>
            <span class="token comment"># print(gp[aline])</span>
            <span class="token keyword">if</span> gp<span class="token punctuation">[</span>aline<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">:</span>
                gp<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span>aline<span class="token punctuation">]</span><span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> inplace <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>                
     
        <span class="token keyword">print</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
        <span class="token comment"># country_video_df.publish_time.value_counts().plot.bar()</span>
        <span class="token comment"># gp.plot.bar(width = 2)</span>
        <span class="token comment"># 处理x轴的刻度标签</span>
        x_labels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'...'</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">10</span> <span class="token keyword">else</span> label <span class="token keyword">for</span> label <span class="token keyword">in</span> gp<span class="token punctuation">.</span>index<span class="token punctuation">]</span>

        <span class="token comment"># 制图</span>
        sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>x<span class="token operator">=</span>x_labels<span class="token punctuation">,</span>y<span class="token operator">=</span>gp<span class="token punctuation">.</span>values<span class="token punctuation">,</span>ax<span class="token operator">=</span>axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_xticklabels<span class="token punctuation">(</span>x_labels<span class="token punctuation">,</span> rotation<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">)</span>
        axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>country<span class="token punctuation">)</span>
    <span class="token comment">#布局紧凑，不会超出画布</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 为子图顶部增加间隔，防止子图的标题和整幅图的标题重叠</span>
    plt<span class="token punctuation">.</span>subplots_adjust<span class="token punctuation">(</span>top<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>
    <span class="token comment">#保存图片</span>
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>output_path<span class="token punctuation">,</span> <span class="token string">'month2.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
        
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
           主函数
    """</span>
    <span class="token comment"># 处理表格数据</span>
    all_video_df <span class="token operator">=</span> combine_video_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 绘制每个国家指定列的的top10</span>
    plot_top10_by_country<span class="token punctuation">(</span>all_video_df<span class="token punctuation">,</span> <span class="token string">'category'</span><span class="token punctuation">,</span> <span class="token string">'各国的类别Top10'</span><span class="token punctuation">,</span> <span class="token string">'top10_category.png'</span><span class="token punctuation">)</span>
    plot_top10_by_country<span class="token punctuation">(</span>all_video_df<span class="token punctuation">,</span> <span class="token string">'channel_title'</span><span class="token punctuation">,</span> <span class="token string">'各国的频道Top10'</span><span class="token punctuation">,</span> <span class="token string">'top10_channel.png'</span><span class="token punctuation">)</span>

    <span class="token comment"># 统计视频发布后上榜的天数</span>
    plot_days_to_trend<span class="token punctuation">(</span>all_video_df<span class="token punctuation">,</span> <span class="token string">'publish_vs_trend.html'</span><span class="token punctuation">)</span>

    <span class="token comment"># 查看views,likes,dislikes,comment_count的关系</span>
    cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'views'</span><span class="token punctuation">,</span> <span class="token string">'likes'</span><span class="token punctuation">,</span> <span class="token string">'dislikes'</span><span class="token punctuation">,</span> <span class="token string">'comment_count'</span><span class="token punctuation">]</span>
    plot_relationship_of_cols<span class="token punctuation">(</span>all_video_df<span class="token punctuation">,</span> cols<span class="token punctuation">)</span>
    
    <span class="token comment"># 按月统计不同国家发布视频的数量，并用柱状图进行可视化</span>
    plot_monpub_by_country<span class="token punctuation">(</span>all_video_df<span class="token punctuation">,</span> <span class="token string">'月统计'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="configpy_334"></a>config.py</h3> 
<p>config.py为配置文件。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os

<span class="token comment"># 指定数据集路径</span>
dataset_path<span class="token operator">=</span><span class="token string">'./data'</span>

<span class="token comment"># 结果保存路径</span>
output_path<span class="token operator">=</span><span class="token string">'./output'</span>

<span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>output_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>output_path<span class="token punctuation">)</span>


countries<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'CA'</span><span class="token punctuation">,</span><span class="token string">'DE'</span><span class="token punctuation">,</span><span class="token string">'GB'</span><span class="token punctuation">,</span><span class="token string">'US'</span><span class="token punctuation">]</span>

<span class="token comment"># 使用的列</span>
usecols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'video_id'</span><span class="token punctuation">,</span> <span class="token string">'trending_date'</span><span class="token punctuation">,</span> <span class="token string">'channel_title'</span><span class="token punctuation">,</span> <span class="token string">'category_id'</span><span class="token punctuation">,</span> <span class="token string">'publish_time'</span><span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">,</span> <span class="token string">'likes'</span><span class="token punctuation">,</span>
           <span class="token string">'dislikes'</span><span class="token punctuation">,</span> <span class="token string">'comment_count'</span><span class="token punctuation">,</span> <span class="token string">'comments_disabled'</span><span class="token punctuation">,</span> <span class="token string">'ratings_disabled'</span><span class="token punctuation">,</span> <span class="token string">'video_error_or_removed'</span><span class="token punctuation">]</span>

<span class="token triple-quoted-string string">'''
video_id: 视频id，字符串
trending_date: 视频上榜的日期，字符串
title: 视频标题，字符串
channel_title: 所属频道标题，字符串
category_id: 所属类别编号，整型
publish_time: 视频发布时间，时间类型
tags: 视频标签，字符串
views: 观看次数，整型
likes: 点赞次数，整型
dislikes: 被踩次数，整型
comment_count: 评论次数，整型 
comments_disabled: 评论是否关闭，布尔值 
ratings_disabled: 打分是否关闭，布尔值 
video_error_or_removed: 视频出错或者被删，布尔值 
description: 视频详情，字符串
'''</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/08c9cc6232aad0fa3c0495109fab8a0d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JavaBean基础</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bc5e892e4033d462b8ee92040d4b7dd8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Win10家庭版安装组策略gpedit.msc</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>