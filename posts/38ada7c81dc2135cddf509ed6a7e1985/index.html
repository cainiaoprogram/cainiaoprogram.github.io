<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Spark的离线电影推荐 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于Spark的离线电影推荐" />
<meta property="og:description" content="文章目录 系统需求分析以及流程设计需求数据源流程图数据存储及表的设计 实验环境搭建主要环境 数据加载转换以及存储数据读取数据处理数据存储 TopN基于模型的推荐算法结果处理及存储 基于物品的推荐算法 系统需求分析以及流程设计 需求 基于spark集群实现离线电影推荐推荐结果可以可视化（未实现） 数据源 包括两个数据文件，分别是ratings.dat和movies.dat。
首先是ratings.dat,用户评分数据记录表。包含了用户对电影的评分信息。
然后是movies.dat,电影信息表。包含了电影名电影类型等基本信息。
流程图 数据存储及表的设计 底层存储hdfs
存储着原始数据
movies.dat
ratings.dat
数据仓库hive
读取hdfs数据并进行初步处理，再存入moviedata数据库相关表中。
（1） movies表
存放处理后的movies数据，有5个字段。movieid(Int电影id号)、moviename(String电影名称)和genre(String 电影类型)，ratingtimes(Int电影评分人数)和avgratings(Float 电影平均评分)。
（2） ratings表
存放处理后的ratings数据，有四个字段。userid（Int 用户id）, movieid（Int 电影id）, rating（Float 电影评分）, timestampss （Int 时间戳）。
业务数据库mysql
推荐产生的结果，以及用户信息和电影信息都存储在数据库movieslen中。
（1）moviesrecommend表
moviesrecommend存放基于模型的电影推荐结果。包含两个字段，分别是userid(用户id号)和moviesid(包含推荐电影id号的字符串)。
（2）movies表
movies表，电影基本信息表。有5个字段。movieid(电影id号)、moviename(电影名称)和genre(电影类型)，ratingtimes(电影评分人数)和avgratings(电影平均评分)。
（3）topn表
topn，存放综合排名前100的电影信息。表有五个字段。movieid(电影id号)、moviename(电影名称)和genre(电影类型)，ratingtimes(电影评分人数)和avgratings(电影平均评分)。用于未登录页面的信息展示。
（4）userinfo表
userinfo表存储用户信息，包含3个字段分别是userid(用户id号)、username(用户名)和userpass(用户密码)。
实验环境搭建 主要环境 本实验是基于Spark的电影推荐系统，Spark的运行模式采用Spark on Yarn模式。所以需要在虚拟机上部署分布式Hadoop集群，同时需要安装Hive作为数据仓库，Hive底层将数据存储在HDFS上，配置MySQL存储Hive元数据。
虚拟机：VMware
1）服务器规划（虚拟机为CentOS7）：
master 分配2G内存，1核
slave1 分配1G内存，1核
slave2 分配1G内存，1核
2）hdfs搭建
master 上搭建namenode,secondary namenode
slave1 上搭建datanode
slave2 上搭建datanode
3）Yarn搭建" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/38ada7c81dc2135cddf509ed6a7e1985/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-24T11:26:43+08:00" />
<meta property="article:modified_time" content="2021-06-24T11:26:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Spark的离线电影推荐</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">系统需求分析以及流程设计</a></li><li><ul><li><a href="#_2" rel="nofollow">需求</a></li><li><a href="#_6" rel="nofollow">数据源</a></li><li><a href="#_13" rel="nofollow">流程图</a></li><li><a href="#_17" rel="nofollow">数据存储及表的设计</a></li></ul> 
   </li><li><a href="#_61" rel="nofollow">实验环境搭建</a></li><li><ul><li><a href="#_63" rel="nofollow">主要环境</a></li></ul> 
   </li><li><a href="#_105" rel="nofollow">数据加载转换以及存储</a></li><li><ul><li><a href="#_132" rel="nofollow">数据读取</a></li><li><a href="#_160" rel="nofollow">数据处理</a></li><li><a href="#_191" rel="nofollow">数据存储</a></li></ul> 
   </li><li><a href="#TopN_226" rel="nofollow">TopN</a></li><li><a href="#_260" rel="nofollow">基于模型的推荐算法</a></li><li><ul><li><a href="#_300" rel="nofollow">结果处理及存储</a></li></ul> 
   </li><li><a href="#_328" rel="nofollow">基于物品的推荐算法</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>系统需求分析以及流程设计</h3> 
<h4><a id="_2"></a>需求</h4> 
<ol><li>基于spark集群实现离线电影推荐</li><li>推荐结果可以可视化（未实现）</li></ol> 
<h4><a id="_6"></a>数据源</h4> 
<p>包括两个数据文件，分别是ratings.dat和movies.dat。<br> 首先是ratings.dat,用户评分数据记录表。包含了用户对电影的评分信息。</p> 
<p><img src="https://images2.imgbox.com/de/93/OQCnDBxk_o.jpg" alt="在这里插入图片描述"><br> 然后是movies.dat,电影信息表。包含了电影名电影类型等基本信息。<br> <img src="https://images2.imgbox.com/28/fb/hBRHEAyP_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="_13"></a>流程图</h4> 
<p><img src="https://images2.imgbox.com/d9/14/qoXxLpg3_o.gif" alt="在这里插入图片描述"></p> 
<h4><a id="_17"></a>数据存储及表的设计</h4> 
<ol><li> <p>底层存储hdfs</p> <p>存储着原始数据</p> <p>movies.dat</p> <p>ratings.dat</p> </li><li> <p>数据仓库hive</p> <p>读取hdfs数据并进行初步处理，再存入moviedata数据库相关表中。</p> <p>（1） movies表</p> <p>存放处理后的movies数据，有5个字段。movieid(Int电影id号)、moviename(String电影名称)和genre(String 电影类型)，ratingtimes(Int电影评分人数)和avgratings(Float 电影平均评分)。</p> <p>（2） ratings表</p> <p>存放处理后的ratings数据，有四个字段。userid（Int 用户id）, movieid（Int 电影id）, rating（Float 电影评分）, timestampss （Int 时间戳）。</p> </li><li> <p>业务数据库mysql</p> <p>推荐产生的结果，以及用户信息和电影信息都存储在数据库movieslen中。</p> <p>（1）moviesrecommend表</p> <p>moviesrecommend存放基于模型的电影推荐结果。包含两个字段，分别是userid(用户id号)和moviesid(包含推荐电影id号的字符串)。<br> <img src="https://images2.imgbox.com/91/9b/PxICJhXk_o.gif" alt="在这里插入图片描述"><br> （2）movies表</p> <p>movies表，电影基本信息表。有5个字段。movieid(电影id号)、moviename(电影名称)和genre(电影类型)，ratingtimes(电影评分人数)和avgratings(电影平均评分)。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/f0/27/sTFwxADU_o.gif" alt="在这里插入图片描述"><br> （3）topn表</p> 
<p>topn，存放综合排名前100的电影信息。表有五个字段。movieid(电影id号)、moviename(电影名称)和genre(电影类型)，ratingtimes(电影评分人数)和avgratings(电影平均评分)。用于未登录页面的信息展示。<br> <img src="https://images2.imgbox.com/15/05/yMwV5lIb_o.gif" alt="在这里插入图片描述"><br> （4）userinfo表</p> 
<p>userinfo表存储用户信息，包含3个字段分别是userid(用户id号)、username(用户名)和userpass(用户密码)。<br> <img src="https://images2.imgbox.com/a2/a2/BHA8DRlw_o.gif" alt="在这里插入图片描述"></p> 
<h3><a id="_61"></a>实验环境搭建</h3> 
<h4><a id="_63"></a>主要环境</h4> 
<p>本实验是基于Spark的电影推荐系统，Spark的运行模式采用Spark on Yarn模式。所以需要在虚拟机上部署分布式Hadoop集群，同时需要安装Hive作为数据仓库，Hive底层将数据存储在HDFS上，配置MySQL存储Hive元数据。</p> 
<p>虚拟机：VMware</p> 
<p>1）服务器规划（虚拟机为CentOS7）：</p> 
<p>master 分配2G内存，1核</p> 
<p>slave1 分配1G内存，1核</p> 
<p>slave2 分配1G内存，1核</p> 
<p>2）hdfs搭建</p> 
<p>master 上搭建namenode,secondary namenode</p> 
<p>slave1 上搭建datanode</p> 
<p>slave2 上搭建datanode</p> 
<p>3）Yarn搭建</p> 
<p>master 上搭建resourcemanager</p> 
<p>slave1 上搭建nodemanager</p> 
<p>slave2 上搭建nodemanager</p> 
<p>4）MySQL搭建,在 master 上搭建</p> 
<p>5）Hive搭建,在 master 上搭建</p> 
<p>6）Spark 集群搭建，搭建 Spark on Yarn 模式</p> 
<p>可参考：https://blog.csdn.net/qq_43402639/article/details/115531789</p> 
<p>本机项目环境：Intellij Maven</p> 
<p>项目结构：<br> <img src="https://images2.imgbox.com/8e/df/WOJh6NAO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_105"></a>数据加载转换以及存储</h3> 
<p>实验都是在IDEA里编写的。要连接到集群中的hive数据库首先要将</p> 
<p>数据存储利用HDFS作为底层存储，Hive作为数据仓库。数据原始存储在HDFS上，然后借助<code>org.apache.spark.sql</code>中的SparkSession来构建完成数据的ETL工作。</p> 
<p><code>SparkSession</code>：从Spark2.0以上的版本开始，spark是使用全新的SparkSession接口代替Spark1.6中的SQLcontext和HiveContext来实现对数据的加载、转换、处理等工作，并且实现了SQLcontext和HiveContext的所有功能。我们在新版本中并不需要之前那么繁琐的创建很多对象，只需要创建一个SparkSession对象即可。</p> 
<p>SparkSession支持从不同的数据源加载数据，并把数据转换成DataFrame，并支持把DataFrame转换成SQLContext自身中的表。</p> 
<p>然后使用SQL语句来操作数据，也提供了HiveQL以及其他依赖于Hive的功能支持。</p> 
<p>创建SparkSession实例：</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> session<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder
   <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span>
   <span class="token comment">//.master("yarn")</span>
   <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token string">"HdfsToHive"</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span>enableHiveSupport<span class="token punctuation">(</span><span class="token punctuation">)</span> 
   <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>通过builder创建实例，同时设置master，appName等参数来确定运行模式以及application名称等，enableHiveSupport使得session支持对hive的查询访问。</p> 
<h4><a id="_132"></a>数据读取</h4> 
<p>可以看到数据格式是以 “::”字符分割的字符串，所以需要分割并提取出相关字段。</p> 
<p>因为SparkSession实例中自带SparkContext的实例，所以直接通过sessioin获取到sparkContext。<br> <img src="https://images2.imgbox.com/19/e8/HK8iTQiw_o.gif" alt="在这里插入图片描述"></p> 
<p><code>val sc: SparkContext = session.sparkContext</code></p> 
<p>为了方便后续数据的组织，定义两个案例类 Movie和Rating。</p> 
<pre><code class="prism language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> Movie<span class="token punctuation">(</span>movieid <span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> moviename <span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> genre <span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> Rating<span class="token punctuation">(</span>userid <span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> movieid <span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> rating <span class="token operator">:</span> <span class="token builtin">Float</span><span class="token punctuation">,</span> timestampss <span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span>
</code></pre> 
<p>通过SparkContext的textFile方法，读取到hdfs上的movies.dat以及ratings.dat文件。并通过map方法将数据映射成RDD[Movie]以及RDD[Rating]类型。</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> moviesInfo<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"hdfs://master:8020/moviedata/movies.dat"</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> moviesRes<span class="token operator">:</span> RDD<span class="token punctuation">[</span>Movie<span class="token punctuation">]</span> <span class="token operator">=</span> moviesInfo<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"::"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> Movie<span class="token punctuation">(</span>line<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> line<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> line<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> ratingsInfo<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"hdfs://master:8020/moviedata/ratings.dat"</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> ratingsRes<span class="token operator">:</span> RDD<span class="token punctuation">[</span>Rating<span class="token punctuation">]</span> <span class="token operator">=</span> ratingsInfo<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"::"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> Rating<span class="token punctuation">(</span>line<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> line<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> line<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toFloat<span class="token punctuation">,</span> line<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_160"></a>数据处理</h4> 
<p>在读取到的数据字段的基础上，增加电影平均评分和电影评分人数字段丰富电影信息。</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> ratingcount<span class="token operator">:</span> DataFrame <span class="token operator">=</span> ratingFrame
    <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"movieid"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>withColumnRenamed<span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">,</span><span class="token string">"ratingtimes"</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> ratingavg<span class="token operator">:</span> DataFrame <span class="token operator">=</span> ratingFrame
	<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"movieid"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>avg<span class="token punctuation">(</span><span class="token string">"rating"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>withColumnRenamed<span class="token punctuation">(</span><span class="token string">"avg(rating)"</span><span class="token punctuation">,</span><span class="token string">"avgratings"</span><span class="token punctuation">)</span>
</code></pre> 
<p>将新产生的字段连接到原DataFrame中，因为存在电影未被评分，所以选择左连接保留所有电影信息。</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> withCountMovieInfo<span class="token operator">:</span> DataFrame <span class="token operator">=</span> moviesFrame
	<span class="token punctuation">.</span>join<span class="token punctuation">(</span>ratingcount<span class="token punctuation">,</span>Seq<span class="token punctuation">(</span><span class="token string">"movieid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"left_outer"</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> withCountAndAvgMovieInfo<span class="token operator">:</span> DataFrame <span class="token operator">=</span> withCountMovieInfo
    <span class="token punctuation">.</span>join<span class="token punctuation">(</span>ratingavg<span class="token punctuation">,</span> Seq<span class="token punctuation">(</span><span class="token string">"movieid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"left_outer"</span><span class="token punctuation">)</span>
</code></pre> 
<p>同时需要将NULL值改为0：</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> movieInfo<span class="token operator">:</span> DataFrame <span class="token operator">=</span> withCountAndAvgMovieInfo<span class="token punctuation">.</span>na<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_191"></a>数据存储</h4> 
<p>最后将处理过后的数据存入到HIVE中。通过将一张表的数据导入到另一张表的方式来构建新表：insert into [table1] select * from [table1]。</p> 
<p>先在程序中构建临时视图temp1和temp2：</p> 
<pre><code class="prism language-scala">movieInfo<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">"temp1"</span><span class="token punctuation">)</span>
ratingFrame<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">"temp2"</span><span class="token punctuation">)</span>
</code></pre> 
<p>再将临时表中的数据导入到hive表中：</p> 
<pre><code class="prism language-scala">session<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"create table if not exists moviedata.movies"</span> <span class="token operator">+</span>
      <span class="token string">"(movieid Int, moviename String, genre String, ratingtimes Int, avgratings Float)"</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"insert into moviedata.movies select * from temp1"</span><span class="token punctuation">)</span>

session<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"create table if not exists moviedata.ratings"</span> <span class="token operator">+</span>
            <span class="token string">"(userid Int, movieid Int, rating Float, timestampss Int)"</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"insert into moviedata.ratings select * from temp2"</span><span class="token punctuation">)</span>
</code></pre> 
<p>同时还要将一份movies数据存入mysql中，用于网页上的展示。Spark的DataFrame支持write方法直接写入到mysql数据库中，写入模式只支持SaveMode.Append以及SaveMode.Overwrite。</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> url <span class="token operator">=</span> <span class="token string">"jdbc:mysql://localhost:3306/movieslen?serverTimezone=GMT"</span>

<span class="token keyword">val</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span>
prop<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"root"</span><span class="token punctuation">)</span>
prop<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span><span class="token string">"******"</span><span class="token punctuation">)</span>

movies<span class="token punctuation">.</span>write<span class="token punctuation">.</span>mode<span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Append<span class="token punctuation">)</span><span class="token punctuation">.</span>jdbc<span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token string">"movies"</span><span class="token punctuation">,</span>prop<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="TopN_226"></a>TopN</h3> 
<p>对于新出现的没有任何观影记录的用户，可以推荐Top电影榜。</p> 
<p>其中排序规则按照评分人数大于100且评分排名靠前的电影。（可以采用评分人数和平均评分加权的方式选取排名靠前的电影，产生的排名结果更合理）</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> top100Movies<span class="token operator">:</span> DataFrame <span class="token operator">=</span> session
      <span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select * from moviedata.movies where ratingtimes&gt;100 order by avgratings desc,ratingtimes desc limit 100"</span><span class="token punctuation">)</span>
</code></pre> 
<p>但在Hive中使用全局排序时，需要注意，Hive会将所有数据交给一个Reduce任务计算，实现查询结果的全局排序。所以如果数据量很大，只有一个Reduce会耗费大量时间。</p> 
<p>查询语句优化：（参考https://cloud.tencent.com/developer/article/1769598 https://blog.csdn.net/weixin_38629422/article/details/109745613）</p> 
<p>在每个Reduce中进行排序后，各自取得前N个数据，然后再对结果集进行全局排序，最终取得结果。</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> top100Movies<span class="token operator">:</span> DataFrame <span class="token operator">=</span> session
      <span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select * from (select * from moviedata.movies distribute by length(moviename) sort by avgratings desc,ratingtimes desc limit 100) temp order by avgratings desc,ratingtimes desc limit 100"</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果存入mysql中</p> 
<pre><code>// TODO ： 将top100数据存入 sql 表 topn中
val url = "jdbc:mysql://localhost:3306/movieslen?serverTimezone=GMT"
val prop = new Properties()
prop.put("user","root")
prop.put("password","200425")
top100Movies.write.mode(SaveMode.Append)
.jdbc(url,"topn",prop)
</code></pre> 
<h3><a id="_260"></a>基于模型的推荐算法</h3> 
<p>利用基于模型的推荐算法org.apache.spark.ml.recommendation.ALS来进行电影推荐。首先从Hive中获取到所需的ratings数据，然后训练模型，再用模型预测出每个用户预测分数排名前十的电影。最后将结果存入到mysql表中。</p> 
<ol><li> <p>基于模型的推荐算法ALS</p> <p>ALS算法是基于模型的推荐算法，基本思想是对稀疏矩阵进行模型分解，评估出缺失项的值，以此来得到一个基本的训练模型。它是协同过滤的一种，并被集成到Spark的Ml库中。</p> </li><li> <p>模型训练及评分预测</p> <p>ALS可调参数：</p> <p>· numBlocks 是用于并行化计算的用户和商品的分块个数 (默认为10)。</p> <p>· rank 是模型中隐义因子的个数（默认为10）。</p> <p>· maxIter 是迭代的次数（默认为10）。</p> <p>· regParam 是ALS的正则化参数（默认为1.0）。</p> <p>· implicitPrefs 决定了是用显性反馈ALS的版本还是用适用隐性反馈数据集的版本（默认是false，即用显性反馈）。</p> <p>· alpha 是一个针对于隐性反馈 ALS 版本的参数，这个参数决定了偏好行为强度的基准（默认为1.0）。</p> <p>· nonnegative 决定是否对最小二乘法使用非负的限制（默认为false）。</p> <p>受虚拟机限制没有调参过程，参数都为默认值。</p> </li></ol> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> als <span class="token operator">=</span> <span class="token keyword">new</span> ALS<span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span>setUserCol<span class="token punctuation">(</span><span class="token string">"userid"</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span>setItemCol<span class="token punctuation">(</span><span class="token string">"movieid"</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span>setRatingCol<span class="token punctuation">(</span><span class="token string">"rating"</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> model<span class="token operator">:</span> ALSModel <span class="token operator">=</span> als<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>ratings<span class="token punctuation">)</span>

<span class="token comment">// TODO: 为每个用户推荐十部电影</span>
<span class="token keyword">val</span> userRecommend<span class="token operator">:</span> DataFrame <span class="token operator">=</span> model<span class="token punctuation">.</span>recommendForAllUsers<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_300"></a>结果处理及存储</h4> 
<p>从每个用户的推荐集中选取出预测评分最高的十部电影，并且只保留moiveid，去除预测评分字段，同时将movieid转化成以”,”分割的字符串。</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> userAndMovies<span class="token operator">:</span> DataFrame <span class="token operator">=</span> userRecommend<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"userid"</span><span class="token punctuation">,</span> <span class="token string">"recommendations.movieid"</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> resToMysql <span class="token operator">=</span> userAndMovies<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>map<span class="token punctuation">(</span>row <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> userid<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>getInt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> movies<span class="token operator">:</span> mutable<span class="token punctuation">.</span>Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span>mutable<span class="token punctuation">.</span>Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>userid<span class="token punctuation">,</span> movies<span class="token punctuation">.</span>mkString<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">"userid"</span><span class="token punctuation">,</span><span class="token string">"moviesid"</span><span class="token punctuation">)</span>
</code></pre> 
<p>最后将处理后的推荐数据存入到mysql的moviesRecommend表中（产生的推荐结果可以剔除实际评分过低的电影以及评分人数过少的电影，以免推荐劣质电影）</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> url <span class="token operator">=</span> <span class="token string">"jdbc:mysql://localhost:3306/movieslen?serverTimezone=GMT"</span>

<span class="token keyword">val</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span>
prop<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"root"</span><span class="token punctuation">)</span>
prop<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span><span class="token string">"****"</span><span class="token punctuation">)</span>

resToMysql<span class="token punctuation">.</span>write<span class="token punctuation">.</span>mode<span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Append<span class="token punctuation">)</span><span class="token punctuation">.</span>jdbc<span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token string">"moviesRecommend"</span><span class="token punctuation">,</span>prop<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_328"></a>基于物品的推荐算法</h3> 
<p>同时根据点击的电影，可以同时推荐相似电影。基于物品的电影推荐是计算电影之间的相似度，这里选用余弦相似度，然后推荐相似度高的（同样的产生的推荐结果可以剔除实际评分过低的电影以及评分人数过少的电影，以免推荐劣质电影）。</p> 
<p>物品的特征矩阵可以通过ALS模型拟合后获得</p> 
<pre><code class="prism language-scala"><span class="token comment">// 余弦相似度</span>
<span class="token keyword">def</span> cosineSimilarity<span class="token punctuation">(</span>vec1<span class="token operator">:</span> FloatMatrix<span class="token punctuation">,</span> vec2<span class="token operator">:</span> FloatMatrix<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token builtin">Float</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    vec1<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>vec2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>vec1<span class="token punctuation">.</span>norm2<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> vec2<span class="token punctuation">.</span>norm2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-scala"><span class="token comment">// TODO : 训练模型</span>
<span class="token keyword">val</span> als <span class="token operator">=</span> <span class="token keyword">new</span> ALS<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>setUserCol<span class="token punctuation">(</span><span class="token string">"userid"</span><span class="token punctuation">)</span>	
    <span class="token punctuation">.</span>setItemCol<span class="token punctuation">(</span><span class="token string">"movieid"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>setRatingCol<span class="token punctuation">(</span><span class="token string">"rating"</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> model<span class="token operator">:</span> ALSModel <span class="token operator">=</span> als<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>ratings<span class="token punctuation">)</span>

<span class="token comment">// TODO : 得到物品特征矩阵</span>
<span class="token keyword">val</span> res<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> FloatMatrix<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> model<span class="token punctuation">.</span>itemFactors<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>map<span class="token punctuation">(</span>
  row <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> movieid<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>getInt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> features<span class="token operator">:</span> mutable<span class="token punctuation">.</span>Seq<span class="token punctuation">[</span><span class="token builtin">Float</span><span class="token punctuation">]</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span>mutable<span class="token punctuation">.</span>Seq<span class="token punctuation">[</span><span class="token builtin">Float</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> matrix <span class="token operator">=</span> <span class="token keyword">new</span> FloatMatrix<span class="token punctuation">(</span>features<span class="token punctuation">.</span>toArray<span class="token punctuation">)</span>
    <span class="token punctuation">(</span>movieid<span class="token punctuation">,</span> matrix<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">// TODO : 计算电影之间的相似度 用笛卡尔积组合所有(Int, FloatMatrix)对</span>
<span class="token keyword">val</span> moviesRec<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> FloatMatrix<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> FloatMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>cartesian<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token keyword">val</span> top10Recs<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> moviesRec
  <span class="token punctuation">.</span>filter <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
      a<span class="token punctuation">.</span>_1 <span class="token operator">!=</span> b<span class="token punctuation">.</span>_1
  <span class="token punctuation">}</span> <span class="token comment">// 过滤掉自己和自己的相似度数据</span>
  <span class="token punctuation">.</span>map <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">(</span>a<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> cosineSimilarity<span class="token punctuation">(</span>a<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> b<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token comment">// 计算两个特征向量之间的余弦相似度 （电影1，（电影2，相似度））</span>
  <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>_2 <span class="token operator">&gt;</span> <span class="token number">0.7</span><span class="token punctuation">)</span> <span class="token comment">// 先过滤掉一部分数据</span>
  <span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 根据movieid聚合</span>
  <span class="token punctuation">.</span>map <span class="token punctuation">{<!-- --></span> <span class="token comment">// 通过映射取出每部电影的相关度排名前十的相关电影，不需要保留相似度</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>mid<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> recs<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Float</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> recMids<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> recs<span class="token punctuation">.</span>toList<span class="token punctuation">.</span>sortWith<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2 <span class="token operator">&gt;</span> _<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
      <span class="token punctuation">(</span>mid<span class="token punctuation">,</span> recMids<span class="token punctuation">.</span>mkString<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">session<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
<span class="token keyword">val</span> resToMysql<span class="token operator">:</span> DataFrame <span class="token operator">=</span> top10Recs<span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">"movieid"</span><span class="token punctuation">,</span> <span class="token string">"moviesid"</span><span class="token punctuation">)</span>
</code></pre> 
<p>完整代码：<br> 链接：https://pan.baidu.com/s/1IxnT2If-qCzH01Zhq7z56A<br> 提取码：84me</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/080a6ee967cdc339742006fcf7db5736/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">STM32F405RG开发板控制OLED显示屏</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dc89056a6d96fa8f361915cdf7a6c3d2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">组装台式计算机型号怎么看,电脑配置怎么看,详细教您怎么查看电脑配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>