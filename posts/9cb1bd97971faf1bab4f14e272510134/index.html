<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>编译iOS上的libevent库 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="编译iOS上的libevent库" />
<meta property="og:description" content="前言：昨天正好在Android上把libevent跑通了，就是用了之前一篇文章中提到的流程方案。今天索性把iOS上的libevent也编译了下。iOS上的交叉编译比NDK的要顺利许多，大概是找到了对应比较好的文章做参考吧。
准备工作 有OS X系统，我这里装的是10.8 64-bit。 Xcode是4.5.2，对应的SDK版本为6.0 下载libevent版本，可是是官方最新的2.0.21或者是git上对应的那个for Android的版本，都可以。git上那份我记得是2.0.20的，差距应该不大。 下载openssl库，目前最新是1.0.1e的版本 编译 生成configure文件 如果是官方的2.0.21-stable版本，则文件中已经有configure文件生成了，这步骤可以跳过。如果没有，则执行目录下的autogen.sh脚本，生成configure。其间可能需要安装autoconf、automake和libtool等工具，直接下载对应的源码，然后编译安装即可。至于如何安装，我给个命令列表，有需要的看下即可： ./configure &amp;&amp; make sudo make install 经过以上的步骤，libevent源码目录下应该已经有configure等文件生成了。 编辑build_libevent.sh脚本 接下来就是编写编译脚本了，实际上就是使用configure工具，指定对应的生成目录。这里可以给一个洋葱浏览器的开源脚本，很强大，帮你直接在MAC OS X上下载编译libevent库。 https://github.com/mtigas/iOS-OnionBrowser/blob/master/build-libevent.sh 我的配置基本都是抄里面的，当然，如果直接用也没什么问题，他会帮你下载libevent和openssl库，然后编译，生成对应的静态库文件。值得一提的是，Mac上可以直接用lipo命令把多份静态库整合到一起，比如i386、armv7和armv7s三种CPU架构的静态库整合成一份，这实在让人很兴奋。如果Android上也能这么搞，那该多好，当然我还没去查阅过资料，不知道linux上是否支持lipo。 编译libevent的库有个要注意的地方（这个坑了我很久），就是如果需要openssl支持，那要先编译openssl库，否则是不会带libevent_openssl.a这个静态库的。 下面我索性把那两个bash脚本放上来，首先是libevent的 #!/bin/bash # Builds libevent for all three current iPhone targets: iPhoneSimulator-i386, # iPhoneOS-armv6, iPhoneOS-armv7. # # Copyright 2012 Mike Tigas &lt;mike@tig.as&gt; # # Based on work by Felix Schulze on 16.12.10. # Copyright 2010 Felix Schulze. All rights reserved. # # Licensed under the Apache License, Version 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9cb1bd97971faf1bab4f14e272510134/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-05-16T13:21:24+08:00" />
<meta property="article:modified_time" content="2013-05-16T13:21:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">编译iOS上的libevent库</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>前言：昨天正好在Android上把libevent跑通了，就是用了之前一篇文章中提到的流程方案。今天索性把iOS上的libevent也编译了下。iOS上的交叉编译比NDK的要顺利许多，大概是找到了对应比较好的文章做参考吧。</strong></p> 
<h2>准备工作</h2> 
<div>
  有OS X系统，我这里装的是10.8 64-bit。 
</div> 
<div>
  Xcode是4.5.2，对应的SDK版本为6.0 
</div> 
<div>
  下载libevent版本，可是是官方最新的2.0.21或者是git上对应的那个for Android的版本，都可以。git上那份我记得是2.0.20的，差距应该不大。 
</div> 
<div> 
 <br> 
</div> 
<div>
  下载openssl库，目前最新是1.0.1e的版本 
</div> 
<div> 
 <br> 
</div> 
<h2>编译</h2> 
<h3>生成configure文件</h3> 
<div>
  如果是官方的2.0.21-stable版本，则文件中已经有configure文件生成了，这步骤可以跳过。如果没有，则执行目录下的autogen.sh脚本，生成configure。其间可能需要安装autoconf、automake和libtool等工具，直接下载对应的源码，然后编译安装即可。至于如何安装，我给个命令列表，有需要的看下即可： 
</div> 
<div> 
 <pre><code class="language-plain">./configure &amp;&amp; make
sudo make install</code></pre> 
 <br> 经过以上的步骤，libevent源码目录下应该已经有configure等文件生成了。 
</div> 
<div> 
 <br> 
</div> 
<h3>编辑build_libevent.sh脚本</h3> 
<div> 
 <br> 
</div> 
<div>
  接下来就是编写编译脚本了，实际上就是使用configure工具，指定对应的生成目录。这里可以给一个洋葱浏览器的开源脚本，很强大，帮你直接在MAC OS X上下载编译libevent库。 
</div> 
<div> 
 <a href="https://github.com/mtigas/iOS-OnionBrowser/blob/master/build-libevent.sh">https://github.com/mtigas/iOS-OnionBrowser/blob/master/build-libevent.sh</a> 
 <br> 
</div> 
<div>
  我的配置基本都是抄里面的，当然，如果直接用也没什么问题，他会帮你下载libevent和openssl库，然后编译，生成对应的静态库文件。值得一提的是，Mac上可以直接用lipo命令把多份静态库整合到一起，比如i386、armv7和armv7s三种CPU架构的静态库整合成一份，这实在让人很兴奋。如果Android上也能这么搞，那该多好，当然我还没去查阅过资料，不知道linux上是否支持lipo。 
</div> 
<div> 
 <br> 
</div> 
<div>
  编译libevent的库有个要注意的地方（这个坑了我很久），就是如果需要openssl支持，那要先编译openssl库，否则是不会带libevent_openssl.a这个静态库的。 
</div> 
<div> 
 <br> 
</div> 
<div>
  下面我索性把那两个bash脚本放上来，首先是libevent的 
</div> 
<div> 
 <pre><code class="language-plain">#!/bin/bash
#  Builds libevent for all three current iPhone targets: iPhoneSimulator-i386,
#  iPhoneOS-armv6, iPhoneOS-armv7.
#
#  Copyright 2012 Mike Tigas &lt;mike@tig.as&gt;
#
#  Based on work by Felix Schulze on 16.12.10.
#  Copyright 2010 Felix Schulze. All rights reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#
###########################################################################
#  Choose your libevent version and your currently-installed iOS SDK version:
#
VERSION="2.0.21-stable"
SDKVERSION="6.1"
#
#
###########################################################################
#
# Don't change anything under this line!
#
###########################################################################

# No need to change this since xcode build will only compile in the
# necessary bits from the libraries we create
ARCHS="i386 armv7 armv7s"

DEVELOPER=`xcode-select -print-path`

cd "`dirname \"$0\"`"
REPOROOT=$(pwd)

# Where we'll end up storing things in the end
OUTPUTDIR="${REPOROOT}/dependencies"
mkdir -p ${OUTPUTDIR}/include
mkdir -p ${OUTPUTDIR}/lib


BUILDDIR="${REPOROOT}/build"

# where we will keep our sources and build from.
SRCDIR="${BUILDDIR}/src"
mkdir -p $SRCDIR
# where we will store intermediary builds
INTERDIR="${BUILDDIR}/built"
mkdir -p $INTERDIR

########################################

cd $SRCDIR

# Exit the script if an error happens
set -e

if [ ! -e "${SRCDIR}/libevent-${VERSION}.tar.gz" ]; then
	echo "Downloading libevent-${VERSION}.tar.gz"
    curl -LO https://github.com/downloads/libevent/libevent/libevent-${VERSION}.tar.gz
else
	echo "Using libevent-${VERSION}.tar.gz"
fi

tar zxf libevent-${VERSION}.tar.gz -C $SRCDIR
cd "${SRCDIR}/libevent-${VERSION}"

set +e # don't bail out of bash script if ccache doesn't exist
CCACHE=`which ccache`
if [ $? == "0" ]; then
    echo "Building with ccache: $CCACHE"
    CCACHE="${CCACHE} "
else
    echo "Building without ccache"
    CCACHE=""
fi
set -e # back to regular "bail out on error" mode

for ARCH in ${ARCHS}
do
	if [ "${ARCH}" == "i386" ];
	then
		PLATFORM="iPhoneSimulator"
        EXTRA_CONFIG=""
	else
		PLATFORM="iPhoneOS"
        EXTRA_CONFIG="--host=arm-apple-darwin11"
	fi

	mkdir -p "${INTERDIR}/${PLATFORM}${SDKVERSION}-${ARCH}.sdk"

	./configure --disable-shared --enable-static --disable-debug-mode ${EXTRA_CONFIG} \
    --prefix="${INTERDIR}/${PLATFORM}${SDKVERSION}-${ARCH}.sdk" \
    CC="${CCACHE}${DEVELOPER}/Platforms/${PLATFORM}.platform/Developer/usr/bin/gcc -arch ${ARCH}" \
    LDFLAGS="$LDFLAGS -L${OUTPUTDIR}/lib" \
    CFLAGS="$CFLAGS -I${OUTPUTDIR}/include -isysroot ${DEVELOPER}/Platforms/${PLATFORM}.platform/Developer/SDKs/${PLATFORM}${SDKVERSION}.sdk" \
    CPPFLAGS="$CPPFLAGS -I${OUTPUTDIR}/include -isysroot ${DEVELOPER}/Platforms/${PLATFORM}.platform/Developer/SDKs/${PLATFORM}${SDKVERSION}.sdk"

    # Build the application and install it to the fake SDK intermediary dir
    # we have set up. Make sure to clean up afterward because we will re-use
    # this source tree to cross-compile other targets.
	make -j4
	make install
	make clean
done

########################################

echo "Build library..."

# These are the libs that comprise libevent. `libevent_openssl` and `libevent_pthreads`
# may not be compiled if those dependencies aren't available.
OUTPUT_LIBS="libevent.a libevent_core.a libevent_extra.a libevent_openssl.a libevent_pthreads.a"
for OUTPUT_LIB in ${OUTPUT_LIBS}; do
    INPUT_LIBS=""
    for ARCH in ${ARCHS}; do
        if [ "${ARCH}" == "i386" ];
        then
            PLATFORM="iPhoneSimulator"
        else
            PLATFORM="iPhoneOS"
        fi
        INPUT_ARCH_LIB="${INTERDIR}/${PLATFORM}${SDKVERSION}-${ARCH}.sdk/lib/${OUTPUT_LIB}"
        if [ -e $INPUT_ARCH_LIB ]; then
            INPUT_LIBS="${INPUT_LIBS} ${INPUT_ARCH_LIB}"
        fi
    done
    # Combine the three architectures into a universal library.
    if [ -n "$INPUT_LIBS"  ]; then
        lipo -create $INPUT_LIBS \
        -output "${OUTPUTDIR}/lib/${OUTPUT_LIB}"
    else
        echo "$OUTPUT_LIB does not exist, skipping (are the dependencies installed?)"
    fi
done

for ARCH in ${ARCHS}; do
    if [ "${ARCH}" == "i386" ];
    then
        PLATFORM="iPhoneSimulator"
    else
        PLATFORM="iPhoneOS"
    fi
    cp -R ${INTERDIR}/${PLATFORM}${SDKVERSION}-${ARCH}.sdk/include/* ${OUTPUTDIR}/include/
    if [ $? == "0" ]; then
        # We only need to copy the headers over once. (So break out of forloop
        # once we get first success.)
        break
    fi
done


####################

echo "Building done."
echo "Cleaning up..."
rm -fr ${INTERDIR}
rm -fr "${SRCDIR}/libevent-${VERSION}"
echo "Done."</code></pre> 
 <br> 这里要注意的地方有两个： 
</div> 
<div> 
 <ol><li>最上面的库的版本和对应SDK的版本了（执行openssl编译的时候也一样），请根据你的需要去设定，特别是SDK的版本，默认这里是6.1的，我是用Xcode4.5.2，翻看了目录里面，只有6.0的SDK，所以这里要根据你自己的Xcode中SDK的版本设定，否则会找不到编译器</li><li>设定DEVELOPER变量的地方要注意，我的机器上通过xcode-select -print-path得到的路径是/Volumne/Xcode.app/Contents/Developer，但其实我是放在桌面的，如果这个目录不对可能会同样找不到编译器，这里可以写绝对路径（不要用相对路径，会报错的）</li></ol> 
</div> 
<div> 
 <br> 
</div> 
<div>
  直接在你的目录下运行这个bash即可。 
</div> 
<div> 
 <br> 
</div> 
<div>
  如果没有openssl的库，经过上面的编译，libevent_openssl.a 这个库是没有的，在configure过程中就会检测到openssl无效，Makefile中会把对应的代码注释掉。所以如果需要openssl的支持，那就要先运行build_ssl.sh这个脚本，同样，注意事项和build_libevent.sh一致。其实这两个脚本放到同一个libevent目录下即可。 
</div> 
<div> 
 <pre><code class="language-plain">#!/bin/bash
#  Builds openssl for all three current iPhone targets: iPhoneSimulator-i386,
#  iPhoneOS-armv6, iPhoneOS-armv7.
#
#  Copyright 2012 Mike Tigas &lt;mike@tig.as&gt;
#
#  Based on work by Felix Schulze on 16.12.10.
#  Copyright 2010 Felix Schulze. All rights reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#
###########################################################################
#  Choose your openssl version and your currently-installed iOS SDK version:
#
VERSION="1.0.1e"
SDKVERSION="6.1"
#
#
###########################################################################
#
# Don't change anything under this line!
#
###########################################################################

# No need to change this since xcode build will only compile in the
# necessary bits from the libraries we create
ARCHS="i386 armv7 armv7s"

DEVELOPER=`xcode-select -print-path`

cd "`dirname \"$0\"`"
REPOROOT=$(pwd)

# Where we'll end up storing things in the end
OUTPUTDIR="${REPOROOT}/dependencies"
mkdir -p ${OUTPUTDIR}/include
mkdir -p ${OUTPUTDIR}/lib


BUILDDIR="${REPOROOT}/build"

# where we will keep our sources and build from.
SRCDIR="${BUILDDIR}/src"
mkdir -p $SRCDIR
# where we will store intermediary builds
INTERDIR="${BUILDDIR}/built"
mkdir -p $INTERDIR

########################################

cd $SRCDIR

# Exit the script if an error happens
set -e

if [ ! -e "${SRCDIR}/openssl-${VERSION}.tar.gz" ]; then
	echo "Downloading openssl-${VERSION}.tar.gz"
    curl -O http://www.openssl.org/source/openssl-${VERSION}.tar.gz
else
	echo "Using openssl-${VERSION}.tar.gz"
fi

tar zxf openssl-${VERSION}.tar.gz -C $SRCDIR
cd "${SRCDIR}/openssl-${VERSION}"

set +e # don't bail out of bash script if ccache doesn't exist
CCACHE=`which ccache`
if [ $? == "0" ]; then
    echo "Building with ccache: $CCACHE"
    CCACHE="${CCACHE} "
else
    echo "Building without ccache"
    CCACHE=""
fi
set -e # back to regular "bail out on error" mode

for ARCH in ${ARCHS}
do
	if [ "${ARCH}" == "i386" ];
	then
		PLATFORM="iPhoneSimulator"
	else
		sed -ie "s!static volatile sig_atomic_t intr_signal;!static volatile intr_signal;!" "crypto/ui/ui_openssl.c"
		PLATFORM="iPhoneOS"
	fi
	
	echo "Building openssl-${VERSION} for ${PLATFORM} ${SDKVERSION} ${ARCH}"
	echo "Please stand by..."

	mkdir -p "${INTERDIR}/${PLATFORM}${SDKVERSION}-${ARCH}.sdk"
	#LOG="${INTERDIR}/${PLATFORM}${SDKVERSION}-${ARCH}.sdk/build-openssl-${VERSION}.log"

    export CC="${CCACHE}${DEVELOPER}/Platforms/${PLATFORM}.platform/Developer/usr/bin/gcc -arch ${ARCH}"
	./configure BSD-generic32 \
    --openssldir="${INTERDIR}/${PLATFORM}${SDKVERSION}-${ARCH}.sdk" #&gt; "${LOG}" 2&gt;&amp;1

	# add -isysroot to configure-generated CFLAGS
	sed -ie "s!^CFLAG=!CFLAG=-isysroot ${DEVELOPER}/Platforms/${PLATFORM}.platform/Developer/SDKs/${PLATFORM}${SDKVERSION}.sdk !" "Makefile"

    # Build the application and install it to the fake SDK intermediary dir
    # we have set up. Make sure to clean up afterward because we will re-use
    # this source tree to cross-compile other targets.
	make #&gt;&gt; "${LOG}" 2&gt;&amp;1
	make install #&gt;&gt; "${LOG}" 2&gt;&amp;1
	make clean #&gt;&gt; "${LOG}" 2&gt;&amp;1
done

########################################

echo "Build library..."
OUTPUT_LIBS="libssl.a libcrypto.a"
for OUTPUT_LIB in ${OUTPUT_LIBS}; do
    INPUT_LIBS=""
    for ARCH in ${ARCHS}; do
        if [ "${ARCH}" == "i386" ];
        then
            PLATFORM="iPhoneSimulator"
        else
            PLATFORM="iPhoneOS"
        fi
        INPUT_ARCH_LIB="${INTERDIR}/${PLATFORM}${SDKVERSION}-${ARCH}.sdk/lib/${OUTPUT_LIB}"
        if [ -e $INPUT_ARCH_LIB ]; then
            INPUT_LIBS="${INPUT_LIBS} ${INPUT_ARCH_LIB}"
        fi
    done
    # Combine the three architectures into a universal library.
    if [ -n "$INPUT_LIBS"  ]; then
        lipo -create $INPUT_LIBS \
        -output "${OUTPUTDIR}/lib/${OUTPUT_LIB}"
    else
        echo "$OUTPUT_LIB does not exist, skipping (are the dependencies installed?)"
    fi
done

for ARCH in ${ARCHS}; do
    if [ "${ARCH}" == "i386" ];
    then
        PLATFORM="iPhoneSimulator"
    else
        PLATFORM="iPhoneOS"
    fi
    cp -R ${INTERDIR}/${PLATFORM}${SDKVERSION}-${ARCH}.sdk/include/* ${OUTPUTDIR}/include/
    if [ $? == "0" ]; then
        # We only need to copy the headers over once. (So break out of forloop
        # once we get first success.)
        break
    fi
done

echo "Building done."
echo "Cleaning up..."
rm -fr ${INTERDIR}
rm -fr "${SRCDIR}/openssl-${VERSION}"
echo "Done."</code></pre> 
 <br> 再次感谢洋葱浏览器的作者，好强大的脚本啊，呵呵。 
</div> 
<div> 
 <br> 
</div> 
<div>
  编译完成后，对应的库文件存放在dependencies目录的lib目录中，外层的include是对应调用库时需要用到的头文件。好了，iOS上的libevent库就这样搞定了。 
</div> 
<div> 
 <br> 
</div> 
<div>
  顺便丢个编译好的库文件： 
 <a href="http://download.csdn.net/detail/sozell/5378807" target="_blank" rel="noopener noreferrer">下载</a> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/114ea7e49e79d6ee748beba33f96f43c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SQL集合操作符的用法（Oracle中）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/37827cab0e8e16f7feef7582a7af8c2f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Class.forName() 理解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>