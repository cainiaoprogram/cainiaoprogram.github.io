<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【AWS系列】巧用 G5g 畅游Android流媒体游戏 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【AWS系列】巧用 G5g 畅游Android流媒体游戏" />
<meta property="og:description" content="序言 Amazon EC2 G5g 实例由 AWS Graviton2 处理器提供支持，并配备 NVIDIA T4G Tensor Core GPU，可为 Android 游戏流媒体等图形工作负载提供 Amazon EC2 中最佳的性价比。它们是第一个具有 GPU 加速功能的基于 Arm 的实例。
借助 G5g 实例，游戏流媒体客户可以在基于 Arm 的实例上本地运行 Android 游戏，对渲染的图形进行编码，并通过网络将游戏流式传输到移动设备。
在这篇博客中，将在 G5g 实例上通过 Anbox Cloud Appliance 设置 Android 环境，通过 Anbox Cloud API 构建 Android 流媒体游戏应用程序，最后在手机上通过 Firefox 浏览器玩游戏！
一、架构解析 从上图中，我们可以看到此博客中设置的演示示例架构。该架构可以简单分为两部分，
左边：是客户端，手机上支持WebRTC的任何浏览器，右边：是基于G5g实例的服务器。 可以看到，首先需要在 G5g 实例上通过 Anbox Cloud Appliance 设置 Android 环境，然后需要设置一个 Web 服务器处理来自客户端的请求，之后配置 Android 应用程序并通过 Anbox Cloud 启动应用程序接口。
当Web服务器接受客户端的请求时，它会将请求转发给应用服务器，应用服务器将与Anbox流网关和Anbox Cloud API通信以启动Android容器，Android应用程序将托管在容器中并将游戏流传回给客户。
二、具体步骤 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/bdf670a3f2c3df561fdd3b928a05acd3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-05T17:05:44+08:00" />
<meta property="article:modified_time" content="2024-01-05T17:05:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【AWS系列】巧用 G5g 畅游Android流媒体游戏</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2><img alt="" src="https://images2.imgbox.com/70/1e/9BtW0nWo_o.gif"></h2> 
<h2>序言</h2> 
<div> 
 <div> 
  <div> 
   <blockquote> 
    <p style="margin-left:0;text-align:left;"><span style="background-color:#92d050;"><span style="color:#333333;">Amazon EC2 G5g 实例由 AWS Graviton2 处理器提供支持</span></span><span style="color:#333333;">，并配备 NVIDIA T4G Tensor Core GPU，可为 Android 游戏流媒体等图形工作负载提供 Amazon EC2 中最佳的性价比。它们是第一个具有 GPU 加速功能的基于 Arm 的实例。</span></p> 
    <p style="margin-left:0;text-align:left;"><span style="color:#333333;">借助 G5g 实例，游戏流媒体客户可以在基于 Arm 的实例上本地运行 Android 游戏，对渲染的图形进行编码，并通过网络将游戏流式传输到移动设备。</span></p> 
   </blockquote> 
   <blockquote> 
    <p style="margin-left:0;text-align:left;"><span style="color:#333333;">在这篇博客中，将在 G5g 实例上通过 Anbox Cloud Appliance 设置 Android 环境，通过 Anbox Cloud API 构建 Android 流媒体游戏应用程序，最后在手机上通过 Firefox 浏览器玩游戏！</span></p> 
   </blockquote> 
  </div> 
  <p></p> 
  <h2 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">一、架构解析</span></strong></h2> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="345" src="https://images2.imgbox.com/fc/9d/RdJ9pINc_o.png" width="723"></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <div> 
   <blockquote> 
    <p style="margin-left:0;text-align:left;"><span style="color:#333333;">从上图中，我们可以看到此博客中设置的演示示例架构。该架构可以简单分为两部分，</span></p> 
    <ul><li style="text-align:left;"><span style="color:#333333;">左边：是客户端，手机上支持WebRTC的任何浏览器，</span></li><li style="text-align:left;"><span style="color:#333333;">右边：是基于G5g实例的服务器。</span></li></ul> 
   </blockquote> 
  </div> 
  <p></p> 
  <blockquote> 
   <p style="margin-left:0;text-align:left;"><span style="color:#333333;">可以看到，首先需要在 G5g 实例上通过 Anbox Cloud Appliance 设置 Android 环境，然后需要设置一个 Web 服务器处理来自客户端的请求，之后配置 Android 应用程序并通过 Anbox Cloud 启动应用程序接口。</span></p> 
   <p style="margin-left:0;text-align:left;"><span style="color:#333333;">当Web服务器接受客户端的请求时，它会将请求转发给应用服务器，应用服务器将与Anbox流网关和Anbox Cloud API通信以启动Android容器，Android应用程序将托管在容器中并将游戏流传回给客户。</span></p> 
  </blockquote> 
  <h2 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">二、具体步骤</span></strong></h2> 
  <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">2.1 启动 Anbox Cloud Appliance</span></strong></h3> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">首先，在 G5g 实例上启动 Anbox Cloud Appliance</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">第一步，需要一个 Ubuntu SSO 帐户。如果还没有，请在此处</span><a href="https://login.ubuntu.com/" rel="nofollow" title="创建">创建</a><span style="color:#333333;">。</span></p> 
  <blockquote> 
   <p style="margin-left:0;text-align:left;"><span style="color:#333333;">可以通过 AWS Marketplace 安装 Anbox Cloud Appliance。前往 AWS Marketplace 然后购买 Anbox Cloud Appliance 的订阅，今天是将其安装在基于 Graviton 处理器的 G5g 实例上，需要选择 Arm 变体。</span><a href="https://aws.amazon.com/cn/partners/aws-marketplace/" rel="nofollow" title="marketplace">marketplace</a></p> 
  </blockquote> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="862" src="https://images2.imgbox.com/1a/8d/AbURhaGI_o.png" width="1200"></p> 
  <blockquote> 
   <p style="margin-left:0;text-align:left;"><span style="color:#333333;">在 Instance type 部分选择 G5g.8xlarge，选择密钥对，将网络设置保留为默认设置，如下添加存储，</span></p> 
   <ul><li style="text-align:left;"><span style="color:#333333;">至少 50 GB 的根磁盘（必需）</span></li><li style="text-align:left;"><span style="color:#333333;">至少100GB的额外EBS卷（强烈推荐）</span></li></ul> 
  </blockquote> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">推荐至少 100 GB 的原因是我选择作为演示的游戏是 Genshin Impact，它有一个相当大的游戏包，几乎在 50GB 左右。</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">最后，启动实例并等待它变为运行状态，然后我们可以SSH到实例并配置Android环境。</span></p> 
  <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">2.2 搭建Android环境</span></strong></h3> 
  <p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;"> 第二步，在G5g上搭建Android环境</span></span></p> 
  <blockquote> 
   <p style="margin-left:0;text-align:left;"><span style="color:#333333;">为了最好地确保 RPM 和 Debian 软件包存储库的安全性和可靠性，首先需要更新了 CUDA Linux GPG 存储库密钥</span></p> 
  </blockquote> 
  <table border="1" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1" style="vertical-align:middle;width:623px;"> <p style="margin-left:0;text-align:left;"><span style="color:#333333;">$ sudo apt-key del 7fa2af80</span></p> <p style="margin-left:0;text-align:left;"><span style="color:#333333;">$ wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/sbsa/cuda-keyring_1.0-1_all.deb</span></p> <p style="margin-left:0;text-align:left;"><span style="color:#333333;">$ sudo dpkg -i cuda-keyring_1.0-1_all.deb</span></p> <p style="margin-left:0;text-align:left;"></p> </td></tr></tbody></table> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">由于Anbox Cloud中的Android环境运行在LXD容器环境中，因此在设置Android之前，将LXD刷新到最新版本。</span></p> 
  <table border="1" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1" style="vertical-align:middle;width:623px;"> <p style="margin-left:0;text-align:left;"><span style="background-color:#f7f7f7;"><span style="color:#c0392b;">$ sudo snap refresh --channel=5.0/stable lxd</span></span></p> </td></tr></tbody></table> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">通过输入以下命令调用 Anbox 云设备的初始化过程：</span></p> 
  <table border="1" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1" style="vertical-align:middle;width:623px;"> <p style="margin-left:0;text-align:left;"><span style="background-color:#f7f7f7;"><span style="color:#c0392b;">$ sudo anbox-cloud-appliance init</span></span></p> </td></tr></tbody></table> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">只需保留几个问题作为默认答案，最后，可以在 https://$(ec2_public_DNS_name) 查看状态网页以获取进度信息。</span></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="1140" src="https://images2.imgbox.com/63/b4/z0ItyaI7_o.png" width="1200"></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">等待初始化过程完成，然后注册之前创建的 Ubuntu SSO 帐户，输出将显示 Android 环境仪表板地址。</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">$ anbox-cloud-appliance dashboard register &lt;your Ubuntu SSO email address&gt;</span>
</code></span></pre> 
  <p></p> 
  <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#333333;">2.3 构建 Android 流媒体游戏应用程序</span></strong></h3> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><span style="background-color:#92d050;"><span style="color:#333333;">通过 Anbox Cloud API 构建 Android 流媒体游戏应用程序</span></span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">参考 Anbox Cloud 存储库来构建游戏。首先，下载源代码：</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">$ git clone https://github.com/anbox-cloud/cloud-gaming-demo.git</span>

</code></span>
</pre> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">构建游戏门户的Web UI，Web UI是用Flutter构建的，需要安装Flutter然后部署它。</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">$ sudo snap install flutter --classic</span>
<span style="color:#000000;">$ cd ui &amp;&amp; flutter build web</span>
<span style="color:#000000;">$ mkdir -p backend/service/static</span>
<span style="color:#000000;">$ cp -av ui/build/web/* backend/service/static</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">接下来是构建后端服务，用于服务 Web UI 请求并与 Anbox Stream Gateway 交互以通过 Anbox Cloud API 创建游戏应用程序。从安装依赖项开始：</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">$ sudo apt-get install python3-pip</span>
<span style="color:#000000;">$ sudo pip3 install virtualenv</span>
<span style="color:#000000;">$ cd backend &amp;&amp; virtualenv venv</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">然后我们需要准备后端服务访问Anbox Stream Gateway的配置文件，配置文件中有两个参数，gateway-URL和gateway-token。可以从以下命令获取网关令牌：</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">$ anbox-cloud-appliance gateway account create &lt;account-name&gt;</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">创建一个名为 config.yaml 的文件，其中包含这两个配置项：</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">gateway-url: https:// &lt;EC2 public DNS name&gt;</span>
<span style="color:#000000;">gateway-token: &lt;gateway_token&gt;</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">然后将以下行添加到 backend/venv/bin/ 目录中的 activate hook，以便后端服务可以在其启动时读取 config.yaml：</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">$ export CONFIG_PATH=&lt;path_to_config_yaml&gt;</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">现在可以启动将在 TCP 端口 8002 提供服务的后端服务：</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">$ cd backend &amp;&amp; ./run.sh</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">在接下来的步骤中，我们将从互联网上下载一个免费的游戏来演示，并通过 Anbox Cloud API 构建它，我们需要一个可用的 Android APK 和一个配置文件。</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">在HOME目录下创建文件夹，并在文件夹中创建manifest.yaml文件。</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">name</span><span style="color:#000000;">:</span><span style="color:#000000;"> genshin</span>
<span style="color:#000000;">instance-type</span><span style="color:#000000;">:</span><span style="color:#000000;"> g10.3</span>
<span style="color:#000000;">resources</span><span style="color:#000000;">:</span>
  <span style="color:#000000;">cpus</span><span style="color:#000000;">:</span> <span style="color:#000000;">10</span>
  <span style="color:#000000;">memory</span><span style="color:#000000;">:</span><span style="color:#000000;"> 25GB</span>
  <span style="color:#000000;">disk-size</span><span style="color:#000000;">:</span><span style="color:#000000;"> 50GB</span>
  <span style="color:#000000;">gpu-slots</span><span style="color:#000000;">:</span> <span style="color:#000000;">15</span>
<span style="color:#000000;">features</span><span style="color:#000000;">:</span> <span style="color:#000000;">[</span><span style="color:#000000;">"enable_virtual_keyboard"</span><span style="color:#000000;">]</span>

</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">下面选择将以下内容添加到文件中，您可以参考此</span><a href="https://anbox-cloud.io/docs/ref/application-manifest" rel="nofollow" title="链接">链接</a><span style="color:#333333;">了解更多详细信息.</span></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="1200" src="https://images2.imgbox.com/63/7f/3yc4Cgq3_o.png" width="1200"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">另外，还需要准备一个Android APK，记得选择Graviton原生支持的arm64-v8a架构的APK。本次演示，是从网上下载了一款免费的安卓游戏，名为《原神》，一款由米哈游开发发行的动作角色扮演游戏。将 APK 下载到文件夹中并将其重命名为 app.apk。</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">总体而言，游戏文件夹的最终布局应如下所示：</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">.</span>
<span style="color:#000000;">├── app.apk</span>
<span style="color:#000000;">└── manifest.yaml</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">从文件夹中运行以下命令以创建应用程序</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">$ amc application create  .</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">通过使用以下命令监视应用程序创建的状态，等待应用程序更改为就绪状态：</span></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">$ amc application ls</span>
</code></span></pre> 
  <p></p> 
  <blockquote> 
   <p style="margin-left:0;text-align:left;"><span style="color:#333333;">然后我们可以继续编辑和重建 web UI 以显示游戏如下：</span></p> 
   <ol><li style="text-align:left;"><span style="color:#333333;">更新 ui/lib/homepage.dart 文件中定义的 gameids 变量以包含游戏名称（如清单文件中所声明）。</span></li><li style="text-align:left;"><span style="color:#333333;"> 向lib/api/application.dart文件中定义的静态appNameMap和appDesMap变量插入新的key/value对</span></li><li style="text-align:left;"><span style="color:#333333;">提供游戏截图（jpeg格式），重命名为&lt;game-name&gt;.jpeg，放入ui/lib/assets目录。</span></li></ol> 
  </blockquote> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">现在你可以重建网页界面，将 ui/build/web 文件夹中的内容复制到 backend/service/static 目录，然后刷新网页即可获得对应的游戏！</span></p> 
  <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">2.4  启动游戏</span></strong></h3> 
  <blockquote> 
   <p style="margin-left:0;text-align:left;"><span style="color:#333333;">拿出你的手机，打开Firefox浏览器或任何支持webRTC的浏览器，输入G5g实例的8002端口的公共DNS名称，然后你会看到游戏入口是这样的：</span></p> 
  </blockquote> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="1098" src="https://images2.imgbox.com/14/51/HRmTUfEL_o.png" width="1200"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">点击立即开始游戏按钮，稍等片刻在服务器端进行应用程序设置，然后开始游戏吧！</span></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="894" src="https://images2.imgbox.com/e3/34/8AXxmbJf_o.png" width="1200"></p> 
  <h2 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">三、结论</span></strong></h2> 
  <div> 
   <blockquote> 
    <p style="margin-left:0;text-align:left;"><span style="color:#333333;">G5g 是首个在大型云端采用 GPU 加速的基于 Arm 的实例，在 Amazon EC2 中为 Android 游戏流式传输提供最佳性价比。利用 G5g 实例，Android 游戏开发人员可以原生运行基于 Arm 的 GPU 实例，编码渲染的图形，通过网络将游戏流式传输到移动设备。这样可以帮助简化开发工作，降低每个流每小时成本高达 30%。</span></p> 
   </blockquote> 
   <blockquote> 
    <p style="margin-left:0;text-align:left;"><span style="color:#333333;">今天，我们在原生支持 Arm64 架构的 G5g 实例上构建了一个Android 游戏的演示。</span></p> 
    <p style="margin-left:0;text-align:left;"><span style="color:#333333;">其实，借助GPU加速功能，还可以尝试更多需要大规模图形渲染需求的游戏，让 Android 流媒体游戏的普及成为可能。</span></p> 
    <p style="margin-left:0;text-align:left;"><span style="color:#333333;">另外，如果对Amazon的其他内容感兴趣，可以点击该链接了解：</span><a href="https://aws.amazon.com/cn/free/?sc_channel=seo&amp;sc_campaign=blog1152" rel="nofollow" title="Amazon">Amazon</a></p> 
   </blockquote> 
  </div> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"></p> 
 </div> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e75bbc145baf8397f2065b4be5228115/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql如何取出json里某一个字段或计算两数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8b3c43a83523e341a13454d979bdf424/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CentOS 7 安装 PPTP</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>