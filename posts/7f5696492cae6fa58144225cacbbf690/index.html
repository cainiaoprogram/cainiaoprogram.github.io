<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Fragment全文详解(由浅入深_源码分析) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Fragment全文详解(由浅入深_源码分析)" />
<meta property="og:description" content="相信android开发者们一定或多或少的用过Fragment，但是对于其更深层次的原理我猜可能大部分应该都没有了解过，今天这里就由浅入深，整体对Fragment做一个全面解析。
基础介绍 Fragment是什么以及为什么要有Fragment呢？ Fragment直译为碎片，是Android 3.0引入的组件，Fragment不能单独使用，必须要依赖于Activity。 Fragment引入之前几乎所有的逻辑都被放置在Activity中，使得Activity臃肿而混乱，Fragment作为一个微小的Activity诞生。
另外Fragment还有以下几个特点：
模块化：我们可以按照模块将代码写入到不同的Fragment中，之后在根据需要嵌入到Activity。可重用：多个Activiy可以复用同一个Fragment。适配性：根据不同的布局样式，组合不同的Fragment。 Fragment生命周期 Fragment作为管理一组View的组件，也是有自己的生命周期的，和Activity类似，但又不完全一样。基本生命周期如下图所以：
onAttach：在Fragment和Activity关联时调用，仅仅只调用一次。我们可以对传递给Fragment的参数进行解析。onCreate：Fragment创建时调用，仅调用一次。onCreateView：构建Fragment View的时候进行调用，返回Fragment要绘制布局的根视图。onActivityCreated：在Activity执行完成onCreate之后进行调用。onStart：Fragment对用户可见的时候进行调用。onResume：Fragment可以和用户交互的时候进行调用。onPause：Fragment对用户不可交互的时候进行调用。onStop：Fragment对用户不可见时进行调用。onDestroyView：Fragment需要移除视图时进行调用。onDestroy：Fragment自身销毁时进行调用。onDetach：Fragment和Activity解除关系时进行调用。 Fragment常用类以及方法解析 FragmentManager：通过getSupportFragmentManager函数获取，用来管理Activity中的Fragment。
FragmentTransaction：事务。可以通过FragmentManager调用beginTransaction()方法来开启一个事务。通过事务，我们可以对Fragment进行一系列的操作。如下：
add：添加一个Fragment到Activity中。
remove：从Activity中移除一个Fragment。如果Fragment没有被加入回退栈中，则该Fragment会进行销毁。
replace：用另一个Fragment替换当前的Fragment，本质上时先remove再add。
hide：隐藏当前的Fragment，设置为不可见，不会销毁，与之对应的是show。本质是对View进行调用了View.GONE。
show：显示之前隐藏的Fragment，与之对应的是hide。本质是对View进行调用了View.VISIBLE。
detach：将视图进行移除，但是并不销毁Fragment，Fragment依旧由FragmentManager进行管理。
addToBackStack：将Fragment加入返回栈。当移除或替换一个Fragment并向返回栈添加事务时，系统会停止（而非销毁）移除的Fragment。如果没有addToBackStack，则被替换的Fragment会直接进行销毁。
//示例，如果用户执行回退操作进行Fragment的恢复，被替换的Fragment将重新启动。 ft.replace(R.id.fl_content, LearnFragment()).addToBackStack(null).commitAllowingStateLoss() setMaxLifecycle：设定Fragment生命周期最高上限。如果设置的生命周期上限低于当前的生命周期上限，则会进行回退设定的生命周期。
比如，当前生命周期为RESUME，如果设置MaxLifecycle为START，则生命周期则会回到RESUME。
说一个例子，在调用hide和show函数的时候，Frgament的生命周期并不会进行变化。但是我就是想要在show的时候让Fragment走到RESUME呢？此时可以进行如下操作。
//hide ft.setMaxLifecycle(fragment,Lifecycle.State.STARTED).hide(fragment) //show ft.setMaxLifecycle(fragment,Lifecycle.State.RESUMED).show(fragment) commit/commitAllowingStateLoss：提交一个事务。commit如果状态丢失则会抛异常，commitAllowingStateLoss则不会。
源码流程分析 接下来站在源码角度对Fragment进行一波分析，看看Fragment是如何实现的。相信可以对Fragment有更深层次的认识。
我们需要添加一个Fragment到Activity中时，一般会进行如下操作：
val fragmentManager = getSupportFragmentManager() // 获取fragmentManager val ft = fragmentManager.beginTransaction() // 开启事务 ft.add(R.id.fl_content, LearnFragment(), tag) // 添加 ft.commitAllowingStateLoss() // 提交事务 我相信上面的代码，大家可能都非常熟悉了，接下来就根据上述代码，一步一步进行源码跟踪分析。
获取到FragmentManager。 getSupportFragmentManager()方法，在FragmentActivity类中。
FragmentActivity final FragmentController mFragments = FragmentController.createController(new HostCallbacks()); public FragmentManager getSupportFragmentManager() { //通过mFragments 获取了FragmentManager 而mFragments即为 FragmentController return mFragments." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7f5696492cae6fa58144225cacbbf690/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-01T21:38:07+08:00" />
<meta property="article:modified_time" content="2023-01-01T21:38:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Fragment全文详解(由浅入深_源码分析)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>相信android开发者们一定或多或少的用过Fragment，但是对于其更深层次的原理我猜可能大部分应该都没有了解过，今天这里就由浅入深，整体对Fragment做一个全面解析。</p> 
</blockquote> 
<h3><a id="_3"></a>基础介绍</h3> 
<h4><a id="FragmentFragment_5"></a>Fragment是什么以及为什么要有Fragment呢？</h4> 
<p>Fragment直译为碎片，是Android 3.0引入的组件，Fragment不能单独使用，必须要依赖于Activity。 Fragment引入之前几乎所有的逻辑都被放置在Activity中，使得Activity臃肿而混乱，Fragment作为一个微小的Activity诞生。</p> 
<p>另外Fragment还有<strong>以下几个特点</strong>：</p> 
<ul><li>模块化：我们可以按照模块将代码写入到不同的Fragment中，之后在根据需要嵌入到Activity。</li><li>可重用：多个Activiy可以复用同一个Fragment。</li><li>适配性：根据不同的布局样式，组合不同的Fragment。</li></ul> 
<h4><a id="Fragment_15"></a>Fragment生命周期</h4> 
<p>Fragment作为管理一组View的组件，也是有自己的生命周期的，和Activity类似，但又不完全一样。基本生命周期如下图所以：</p> 
<p><img src="https://images2.imgbox.com/a3/57/EdDjmLhX_o.jpg" alt="在这里插入图片描述"></p> 
<ul><li>onAttach：在Fragment和Activity关联时调用，仅仅只调用一次。我们可以对传递给Fragment的参数进行解析。</li><li>onCreate：Fragment创建时调用，仅调用一次。</li><li>onCreateView：构建Fragment View的时候进行调用，返回Fragment要绘制布局的根视图。</li><li>onActivityCreated：在Activity执行完成onCreate之后进行调用。</li><li>onStart：Fragment对用户可见的时候进行调用。</li><li>onResume：Fragment可以和用户交互的时候进行调用。</li><li>onPause：Fragment对用户不可交互的时候进行调用。</li><li>onStop：Fragment对用户不可见时进行调用。</li><li>onDestroyView：Fragment需要移除视图时进行调用。</li><li>onDestroy：Fragment自身销毁时进行调用。</li><li>onDetach：Fragment和Activity解除关系时进行调用。</li></ul> 
<h4><a id="Fragment_36"></a>Fragment常用类以及方法解析</h4> 
<p><strong>FragmentManager</strong>：通过<code>getSupportFragmentManager</code>函数获取，用来管理Activity中的Fragment。</p> 
<p><strong>FragmentTransaction</strong>：事务。可以通过<code>FragmentManager</code>调用<code>beginTransaction()</code>方法来开启一个事务。通过事务，我们可以对Fragment进行一系列的操作。如下：</p> 
<ol><li> <p><strong>add</strong>：添加一个Fragment到Activity中。</p> </li><li> <p><strong>remove</strong>：从Activity中移除一个Fragment。如果Fragment没有被加入回退栈中，则该Fragment会进行销毁。</p> </li><li> <p><strong>replace</strong>：用另一个Fragment替换当前的Fragment，本质上时先remove再add。</p> </li><li> <p><strong>hide</strong>：隐藏当前的Fragment，设置为不可见，不会销毁，与之对应的是show。本质是对<code>View</code>进行调用了<code>View.GONE</code>。</p> </li><li> <p><strong>show</strong>：显示之前隐藏的Fragment，与之对应的是hide。本质是对<code>View</code>进行调用了<code>View.VISIBLE</code>。</p> </li><li> <p><strong>detach</strong>：将视图进行移除，但是并不销毁Fragment，Fragment依旧由FragmentManager进行管理。</p> </li><li> <p><strong>addToBackStack</strong>：将Fragment加入返回栈。<strong>当移除或替换一个Fragment并向返回栈添加事务时，系统会停止（而非销毁）移除的Fragment。如果没有addToBackStack，则被替换的Fragment会直接进行销毁</strong>。</p> <pre><code class="prism language-kotlin"><span class="token comment">//示例，如果用户执行回退操作进行Fragment的恢复，被替换的Fragment将重新启动。</span>
ft<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>fl_content<span class="token punctuation">,</span> <span class="token function">LearnFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addToBackStack</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitAllowingStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> </li><li> <p><strong>setMaxLifecycle</strong>：设定Fragment生命周期最高上限。如果设置的生命周期上限低于当前的生命周期上限，则会进行回退设定的生命周期。</p> <p>比如，当前生命周期为RESUME，如果设置MaxLifecycle为START，则生命周期则会回到RESUME。</p> <p>说一个例子，<strong>在调用<code>hide</code>和<code>show</code>函数的时候，Frgament的生命周期并不会进行变化。但是我就是想要在show的时候让Fragment走到RESUME呢</strong>？此时可以进行如下操作。</p> <pre><code class="prism language-kotlin"><span class="token comment">//hide</span>
ft<span class="token punctuation">.</span><span class="token function">setMaxLifecycle</span><span class="token punctuation">(</span>fragment<span class="token punctuation">,</span>Lifecycle<span class="token punctuation">.</span>State<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>
<span class="token comment">//show</span>
ft<span class="token punctuation">.</span><span class="token function">setMaxLifecycle</span><span class="token punctuation">(</span>fragment<span class="token punctuation">,</span>Lifecycle<span class="token punctuation">.</span>State<span class="token punctuation">.</span>RESUMED<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>
</code></pre> </li><li> <p><strong>commit/commitAllowingStateLoss</strong>：提交一个事务。commit如果状态丢失则会抛异常，commitAllowingStateLoss则不会。</p> </li></ol> 
<h3><a id="_78"></a>源码流程分析</h3> 
<p>接下来站在源码角度对Fragment进行一波分析，看看Fragment是如何实现的。相信可以对Fragment有更深层次的认识。</p> 
<p>我们需要添加一个Fragment到Activity中时，一般会进行如下操作：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">val</span> fragmentManager <span class="token operator">=</span> <span class="token function">getSupportFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 获取fragmentManager</span>
<span class="token keyword">val</span> ft <span class="token operator">=</span> fragmentManager<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 开启事务</span>
ft<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>fl_content<span class="token punctuation">,</span> <span class="token function">LearnFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span> <span class="token comment">// 添加</span>
ft<span class="token punctuation">.</span><span class="token function">commitAllowingStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 提交事务</span>
</code></pre> 
<p>我相信上面的代码，大家可能都非常熟悉了，接下来就根据上述代码，一步一步进行源码跟踪分析。</p> 
<h4><a id="FragmentManager_93"></a>获取到FragmentManager。</h4> 
<p><code>getSupportFragmentManager()</code>方法，在<code>FragmentActivity</code>类中。</p> 
<pre><code class="prism language-java"><span class="token class-name">FragmentActivity</span>
<span class="token keyword">final</span> <span class="token class-name">FragmentController</span> mFragments <span class="token operator">=</span> <span class="token class-name">FragmentController</span><span class="token punctuation">.</span><span class="token function">createController</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">FragmentManager</span> <span class="token function">getSupportFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//通过mFragments 获取了FragmentManager  而mFragments即为 FragmentController</span>
	<span class="token keyword">return</span> mFragments<span class="token punctuation">.</span><span class="token function">getSupportFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">FragmentController</span>
<span class="token comment">//FragmentController 通过createController函数创建，其实即为new了FragmentController对象，传入了HostCallbacks</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">FragmentController</span> <span class="token function">createController</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">FragmentHostCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FragmentController</span><span class="token punctuation">(</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> <span class="token string">"callbacks == null"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">FragmentManager</span> <span class="token function">getSupportFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//mHost即为传入的HostCallbacks，即通过HostCallbacks获取到了FragmentManager</span>
    <span class="token keyword">return</span> mHost<span class="token punctuation">.</span>mFragmentManager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//HostCallbacks 继承自 FragmentHostCallback，而mFragmentManager在FragmentHostCallback中进行了初始化。</span>
<span class="token class-name">FragmentHostCallback</span>
<span class="token keyword">final</span> <span class="token class-name">FragmentManager</span> mFragmentManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FragmentManagerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>所以在<code>FragmentActivity</code>中会持有<code>FragmentController</code>对象，而<code>FragmentController</code>其实是暴露在外的代理类，相关的逻辑均交由<code>HostCallbacks</code>完成，而<code>HostCallbacks</code>内部则构建了<code>FragmentManagerImpl</code>即我们所需要的<code>FragmentManager</code>对象。而<code>HostCallbacks</code>也提供了一些Fragment一些常用的参数，比如获取<code>Activity</code>、<code>Context</code>、<code>Handler</code>等，该对象会在Fragment进行attach的时候传递给Fragment。</p> 
<pre><code class="prism language-java"><span class="token class-name">Activity</span> <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> mActivity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Context</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> mContext<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Handler</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> mHandler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="beginTransaction_134"></a>beginTransaction干了什么事情</h4> 
<p>接下来看<code>beginTransaction</code>做了什么事情。</p> 
<pre><code class="prism language-java"><span class="token class-name">FragmentManager</span>
<span class="token keyword">public</span> <span class="token class-name">FragmentTransaction</span> <span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//仅仅返回了BackStackRecord对象</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BackStackRecord</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">BackStackRecord</span>
<span class="token class-name">BackStackRecord</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">FragmentManager</span> manager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>manager<span class="token punctuation">.</span><span class="token function">getFragmentFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> manager<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
    <span class="token operator">?</span> manager<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mManager <span class="token operator">=</span> manager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>beginTransaction</code>是FragmentManager的代码，所以自然在FragmentManager中寻找。但是我们发现很简单，<code>beginTransaction</code>其实就是简单的返回了一个<code>BackStackRecord</code>对象，同时它持有了<code>FragmentManager</code>对象。</p> 
<h4><a id="ADD_156"></a>ADD操作</h4> 
<p>我们接下来看一下add操作。通过上面我们知道<code>FragmentTransaction</code>其实是<code>BackStackRecord</code>对象。我们跟一下<code>add</code>操作。</p> 
<pre><code class="prism language-java"><span class="token class-name">FragmentTransaction</span>
<span class="token keyword">public</span> <span class="token class-name">FragmentTransaction</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@IdRes</span> <span class="token keyword">int</span> containerViewId<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">,</span>
<span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> tag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//调用doAddOp注意次数传入的最后一个参数为 OP_ADD</span>
    doAddOp <span class="token punctuation">(</span>containerViewId<span class="token punctuation">,</span> fragment<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> <span class="token constant">OP_ADD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">doAddOp</span><span class="token punctuation">(</span><span class="token keyword">int</span> containerViewId<span class="token punctuation">,</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> tag<span class="token punctuation">,</span> <span class="token keyword">int</span> opcmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//tag 赋值</span>
    fragment<span class="token punctuation">.</span>mTag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//容器Id 赋值</span>
    fragment<span class="token punctuation">.</span>mContainerId <span class="token operator">=</span> fragment<span class="token punctuation">.</span>mFragmentId <span class="token operator">=</span> containerViewId
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//将OP_ADD和fragment 放入Op对象中，调用addOp</span>
    <span class="token function">addOp</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Op</span><span class="token punctuation">(</span>opcmd<span class="token punctuation">,</span> fragment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Op</span><span class="token punctuation">&gt;</span></span> mOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">addOp</span><span class="token punctuation">(</span><span class="token class-name">Op</span> op<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//放入数组中</span>
    mOps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    op<span class="token punctuation">.</span>mEnterAnim <span class="token operator">=</span> mEnterAnim<span class="token punctuation">;</span>
    op<span class="token punctuation">.</span>mExitAnim <span class="token operator">=</span> mExitAnim<span class="token punctuation">;</span>
    op<span class="token punctuation">.</span>mPopEnterAnim <span class="token operator">=</span> mPopEnterAnim<span class="token punctuation">;</span>
    op<span class="token punctuation">.</span>mPopExitAnim <span class="token operator">=</span> mPopExitAnim<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>总结</strong>：<code>add</code>操作即将当前的命令和Fragment放到了集合里面存了起来。而Op则是最终存的对象，我们可以看一下其的数据结构。</p> 
<pre><code> static final class Op {
        int mCmd;//代表当前具体是什么操作，比如add、replace、remove、hide.....
        Fragment mFragment;
        int mEnterAnim;
        int mExitAnim;
        int mPopEnterAnim;
        int mPopExitAnim;
        Lifecycle.State mOldMaxState;
        Lifecycle.State mCurrentMaxState;
}
</code></pre> 
<h4><a id="COMMIT_205"></a>COMMIT干了什么</h4> 
<p>好了，不知不觉我们就到了最后一步，接下来看看<code>commit</code>干了什么吧。上源码。</p> 
<p>我相信现在经常用的是<code>commitAllowingStateLoss</code>吧，所以我们直接看它。</p> 
<pre><code class="prism language-java">    <span class="token class-name">BackStackRecord</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">commitAllowingStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//调用commitInternal allowStateLoss = true</span>
        <span class="token keyword">return</span> <span class="token function">commitInternal</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">commitInternal</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> allowStateLoss<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//调用到FragmentManager 的enqueueAction方法</span>
        mManager<span class="token punctuation">.</span><span class="token function">enqueueAction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> allowStateLoss<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> mIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token class-name">FragmentManager</span>
    <span class="token keyword">void</span> <span class="token function">enqueueAction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">OpGenerator</span> action<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowStateLoss<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowStateLoss<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//由于我们使用的是commitAllowingStateLoss 所以allowStateLoss = true，所以不会校验下面的东西，即不会抛出下面的异常。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mHost <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"FragmentManager has been destroyed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"FragmentManager has not been attached to a "</span>
                            <span class="token operator">+</span> <span class="token string">"host."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">checkStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPendingActions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">//加入数组</span>
            mPendingActions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//继续调用</span>
            <span class="token function">scheduleCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">scheduleCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPendingActions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">//核心 将mExecCommit 调度到主线程执行</span>
            mHost<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>mExecCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
    <span class="token keyword">private</span> <span class="token class-name">Runnable</span> mExecCommit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">execPendingActions</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">execPendingActions</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> allowStateLoss<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//将 mPendingActions 的BackStackRecord 对象放到了mTmpRecords数组中</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">generateOpsForPendingActions</span><span class="token punctuation">(</span>mTmpRecords<span class="token punctuation">,</span> mTmpIsPop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mExecutingActions <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//执行</span>
                <span class="token function">removeRedundantOperationsAndExecute</span><span class="token punctuation">(</span>mTmpRecords<span class="token punctuation">,</span> mTmpIsPop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">cleanupExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            didSomething <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p><code>Commit</code>的操作比较多一点，到这里首先总结一下。</p> 
<ol><li>最终<code>commit</code>操作会交给<code>FragmentManager</code>进行统一执行。</li><li>最终的执行操作被调度到了主线程进行。</li><li><code>commitAllowingStateLoss</code>和<code>commit</code>的本质区别是，不会对一些意外的状态进行校验而抛出异常，比如<code>mHost==null</code>或者已经<code>destroy</code>或者<code>activity 已经调用过onSaveInstanceState</code>了。</li></ol> 
<p>接下来继续调用到了<code>removeRedundantOperationsAndExecute</code>，中国调用链也比较复杂一点，所以这里直接放调用链了。</p> 
<pre><code class="prism language-java"><span class="token class-name">FragmentManager</span> removeRedundantOperationsAndExecute 
👇
<span class="token class-name">FragmentManager</span> executeOpsTogether
👇
<span class="token class-name">FragmentManager</span> executeOps
👇
<span class="token class-name">BackStackRecord</span> executeOps <span class="token comment">// 注意此时执行到了BackStackRecord的executePopOps</span>
</code></pre> 
<p>接下来比较重要一点，我们看一下<code>BackStackRecord</code>里面的<code>executePopOps</code>是如何进行实现的</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">executeOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> opNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> opNum <span class="token operator">&lt;</span> numOps<span class="token punctuation">;</span> opNum<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">Op</span> op <span class="token operator">=</span> mOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>opNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Fragment</span> f <span class="token operator">=</span> op<span class="token punctuation">.</span>mFragment<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                f<span class="token punctuation">.</span><span class="token function">setPopDirection</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">setNextTransition</span><span class="token punctuation">(</span>mTransition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">setSharedElementNames</span><span class="token punctuation">(</span>mSharedElementSourceNames<span class="token punctuation">,</span> mSharedElementTargetNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span>mCmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token constant">OP_ADD</span><span class="token operator">:</span>
                    f<span class="token punctuation">.</span><span class="token function">setAnimations</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>mEnterAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mExitAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mPopEnterAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mPopExitAnim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mManager<span class="token punctuation">.</span><span class="token function">setExitAnimationOrder</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//添加 内部fragment持有了当前的FragmentManager，同时构建了FragmentStateManager 将fragment放入到了FragmentStore的add和active中 fragment.removing 设置为了false</span>
                    mManager<span class="token punctuation">.</span><span class="token function">addFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">OP_REMOVE</span><span class="token operator">:</span>
                    f<span class="token punctuation">.</span><span class="token function">setAnimations</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>mEnterAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mExitAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mPopEnterAnim<span class="token punctuation">,</span> op<span class="token punctuation">.</span>mPopExitAnim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mManager<span class="token punctuation">.</span><span class="token function">removeFragment</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
             <span class="token comment">//重点  状态移动</span>
             mManager<span class="token punctuation">.</span><span class="token function">moveToState</span><span class="token punctuation">(</span>mManager<span class="token punctuation">.</span>mCurState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>还记得之前在<code>add</code>时候看到的数组吗？在<code>BackStackRecord</code>中被拿出来进行循环获取需要执行的命令。比如<code>add</code>，则执行了<code>addFragment</code>。其他的命令也一样在这个地方执行，就不一一列举了。</p> 
<pre><code class="prism language-java">	<span class="token class-name">FragmentManager</span>
    <span class="token class-name">FragmentStateManager</span> <span class="token function">addFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> fragment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">=</span> <span class="token function">createOrGetFragmentStateManager</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//持有FragmentManager</span>
        fragment<span class="token punctuation">.</span>mFragmentManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token comment">//fragmentStateManager 放入store的active数组</span>
        mFragmentStore<span class="token punctuation">.</span><span class="token function">makeActive</span><span class="token punctuation">(</span>fragmentStateManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span>mDetached<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//将fragment放入store</span>
            mFragmentStore<span class="token punctuation">.</span><span class="token function">addFragment</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置mRemoving 为false</span>
            fragment<span class="token punctuation">.</span>mRemoving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>mView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//设置mHiddenChanged为false</span>
                fragment<span class="token punctuation">.</span>mHiddenChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMenuAvailable</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mNeedMenuInvalidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> fragmentStateManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>接下来看一下<code>moveToState</code>函数</p> 
<pre><code class="prism language-java"><span class="token class-name">FragmentManager</span>
<span class="token keyword">void</span> <span class="token function">moveToState</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Fragment</span> f<span class="token punctuation">,</span> <span class="token keyword">int</span> newState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FragmentStateManager</span> fragmentStateManager <span class="token operator">=</span> mFragmentStore<span class="token punctuation">.</span><span class="token function">getFragmentStateManager</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>mWho<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        newState <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>newState<span class="token punctuation">,</span> fragmentStateManager<span class="token punctuation">.</span><span class="token function">computeExpectedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>mState <span class="token operator">&lt;=</span> newState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// If we are moving to the same state, we do not need to give up on the animation.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>mState <span class="token operator">&lt;</span> newState <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mExitAnimationCancellationSignals<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// The fragment is currently being animated...  but!  Now we</span>
                <span class="token comment">// want to move our state back up.  Give up on waiting for the</span>
                <span class="token comment">// animation and proceed from where we are.</span>
                <span class="token function">cancelExitAnimation</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>mState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">&gt;</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//attach</span>
                        fragmentStateManager<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// fall through</span>
                <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">ATTACHED</span><span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">&gt;</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">ATTACHED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//create</span>
                        fragmentStateManager<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// fall through</span>
                <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token operator">:</span>
                    <span class="token comment">// We want to unconditionally run this anytime we do a moveToState that</span>
                    <span class="token comment">// moves the Fragment above INITIALIZING, including cases such as when</span>
                    <span class="token comment">// we move from CREATED =&gt; CREATED as part of the case fall through above.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">&gt;</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        fragmentStateManager<span class="token punctuation">.</span><span class="token function">ensureInflatedView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">&gt;</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        fragmentStateManager<span class="token punctuation">.</span><span class="token function">createView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        	<span class="token keyword">switch</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>mState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">RESUMED</span><span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">&lt;</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">RESUMED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        fragmentStateManager<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// fall through</span>
                <span class="token keyword">case</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">STARTED</span><span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">&lt;</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">STARTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        fragmentStateManager<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        f<span class="token punctuation">.</span>mState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>找到了，最终在<code>Fragment</code>的<code>moveToState</code>函数中，对Fragment状态进行了流转。期望的状态通过<code>fragmentStateManager</code>的<code>computeExpectedState</code>进行计算。并且各个生命周期均调用到了<code>FragmentStateManager</code>进行处理。</p> 
<p>那么<code>Activity</code>的生命周期如何分发给Fragment了呢？还记得之前在Activity中的<code>FragmentController</code>了吗？其代理了<code>FragmentManager</code>。</p> 
<p>比如要告知<code>Activity</code>当前已经Create完成了，则是如下流程：</p> 
<pre><code class="prism language-java">    <span class="token class-name">FragmentActivity</span>
    protect <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mFragments<span class="token punctuation">.</span><span class="token function">dispatchActivityCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//👇</span>
    <span class="token comment">//FragmentController</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchActivityCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mHost<span class="token punctuation">.</span>mFragmentManager<span class="token punctuation">.</span><span class="token function">dispatchActivityCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//👇</span>
    <span class="token comment">//FragmentManager</span>
    <span class="token keyword">void</span> <span class="token function">dispatchActivityCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">dispatchStateChange</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_CREATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dispatchStateChange</span><span class="token punctuation">(</span><span class="token keyword">int</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    	<span class="token comment">//最终执行到了moveToState函数</span>
        <span class="token function">moveToState</span><span class="token punctuation">(</span>nextState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>都到这里了，那我们简单看一个Fragment的生命周期执行函数吧，比如我们看<code>CreateView</code>，则源代码在<code>FragmentStateManager</code>中进行执行。</p> 
<pre><code class="prism language-java">   <span class="token keyword">void</span> <span class="token function">createView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">LayoutInflater</span> layoutInflater <span class="token operator">=</span> mFragment<span class="token punctuation">.</span><span class="token function">performGetLayoutInflater</span><span class="token punctuation">(</span>
                mFragment<span class="token punctuation">.</span>mSavedFragmentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ViewGroup</span> container <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//获取到Fragment的容器</span>
        mFragment<span class="token punctuation">.</span>mContainer <span class="token operator">=</span> container<span class="token punctuation">;</span>
       <span class="token comment">//调用到createView，由开发者创建View</span>
        mFragment<span class="token punctuation">.</span><span class="token function">performCreateView</span><span class="token punctuation">(</span>layoutInflater<span class="token punctuation">,</span> container<span class="token punctuation">,</span> mFragment<span class="token punctuation">.</span>mSavedFragmentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//将view添加到Fragment容器 其实是调用了container.addView</span>
        <span class="token function">addViewToContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mFragment<span class="token punctuation">.</span>mState <span class="token operator">=</span> <span class="token class-name">Fragment</span><span class="token punctuation">.</span><span class="token constant">VIEW_CREATED</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>看吧，其实Fragment核心无非就是对View进行管理，让其有生命周期。最核心的一句还的是<code>addView</code>。</p> 
<h4><a id="_467"></a>总结</h4> 
<p>简单总结一下：</p> 
<ol><li><code>FragmentActivity</code> 支持fragment功能的最底层的activity。</li><li><code>FragmentActivity</code>周期的分发，通过<code>fragmentController</code>最终分发给了<code>FragmentManager</code>，调用<code>moveToState</code>。</li><li><code>moveToState</code>的一些状态管理操作则交由了<code>FragmentStateManager</code>进行统一处理。</li><li><code>FragmentTransition</code>是抽象类，具体实现为<code>BackStackRecord</code>，同时<code>beginTransaction</code>即为返回了<code>BackStackRecord</code>对象。</li><li>一个<code>BackStackRecord</code>对象可以进行多个操作，封装为<code>Op</code>对象存在数组中。最终通过<code>FragmentManager</code>相关的操作还是调度由自己的<code>executeOps</code>操作进行执行，比如add、remove、hide等等。</li><li>操作比较多，但是大同小异，可以根据自身需要查看不同的代码执行流程。比如hide、show等等。</li></ol> 
<p>🙆‍♀️。欢迎技术探讨噢！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/86c401c33da60915a53f0acfc1164bdc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python 中文显示乱码如何处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/eeed57de405a39d256000b6c2726e8c3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python&#43;opencv&#43;mediapipe&#43;tensorflow实现手势识别控制计算机</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>