<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8s 管理工具 kubectl 详解 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8s 管理工具 kubectl 详解" />
<meta property="og:description" content="文章目录 一、陈述式管理1. 陈述式资源管理方法2. k8s 相关信息查看2.1 查看版本信息2.2 查看资源对象简写2.3 查看集群信息2.4 配置kubectl自动补全2.5 查看日志2.6 基本信息查看2.6.1 查看master节点状态2.6.2 查看命名空间 2.7 命名空间操作2.7.1 查看default命名空间的所有资源2.7.2 创建命名空间app2.7.3 删除命名空间app 2.8 deployment/pod操作2.8.1 在命名空间kube-public创建副本控制器（deployment）来启动Pod（nginx-test）2.8.2 描述某个资源的详细信息2.8.3 查看命名空间kube-public中pod信息2.8.4 登录容器2.8.5 删除（重启）pod资源2.8.6 若无法删除，总是处于terminate状态，则要强行删除pod2.8.7 扩缩容2.8.7.1 扩容2.8.7.2 缩容 2.8.8 删除副本控制器 2.9 增加/删除label2.9.1 增加label2.9.2 删除label 3. K8S模拟项目3.1 项目的生命周期3.2 创建kubectl run命令3.3 发布kubectl expose命令3.3.1 Service的作用3.3.2 Service的类型3.3.3 查看Pod网络状态详细信息和Service暴露的端口3.3.4 查看关联后端的节点3.3.5 查看service的描述信息3.3.6 查看负载均衡端口3.3.7 访问查看3.3.8 查看访问日志 3.4 更新kubectl set3.4.1 获取修改模板3.4.2 查看当前nginx的版本号3.4.3 将nginx版本更新为1.153.4.4 监听pod状态3.4.5 查看pod的ip变化3.4.6 重新查看nginx版本号 3.5 回滚kubectl rollout3.5.1 查看历史版本3.5.2 执行回滚到上一个版本3.5.3 执行回滚到指定版本3.5.4 检查回滚状态 3.6 删除kubectl delete3.6.1 删除副本控制器3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c036cfa9de6e336f3e096ed2e862ff52/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-21T09:00:54+08:00" />
<meta property="article:modified_time" content="2022-06-21T09:00:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8s 管理工具 kubectl 详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_4" rel="nofollow">一、陈述式管理</a></li><li><ul><li><a href="#1__6" rel="nofollow">1. 陈述式资源管理方法</a></li><li><a href="#2_k8s__15" rel="nofollow">2. k8s 相关信息查看</a></li><li><ul><li><a href="#21__17" rel="nofollow">2.1 查看版本信息</a></li><li><a href="#22__37" rel="nofollow">2.2 查看资源对象简写</a></li><li><a href="#23__103" rel="nofollow">2.3 查看集群信息</a></li><li><a href="#24_kubectl_115" rel="nofollow">2.4 配置kubectl自动补全</a></li><li><a href="#25__125" rel="nofollow">2.5 查看日志</a></li><li><a href="#26__135" rel="nofollow">2.6 基本信息查看</a></li><li><ul><li><a href="#261_master_145" rel="nofollow">2.6.1 查看master节点状态</a></li><li><a href="#262__163" rel="nofollow">2.6.2 查看命名空间</a></li></ul> 
     </li><li><a href="#27__183" rel="nofollow">2.7 命名空间操作</a></li><li><ul><li><a href="#271_default_185" rel="nofollow">2.7.1 查看default命名空间的所有资源</a></li><li><a href="#272_app_196" rel="nofollow">2.7.2 创建命名空间app</a></li><li><a href="#273_app_216" rel="nofollow">2.7.3 删除命名空间app</a></li></ul> 
     </li><li><a href="#28_deploymentpod_233" rel="nofollow">2.8 deployment/pod操作</a></li><li><ul><li><a href="#281_kubepublicdeploymentPodnginxtest_235" rel="nofollow">2.8.1 在命名空间kube-public创建副本控制器（deployment）来启动Pod（nginx-test）</a></li><li><a href="#282__255" rel="nofollow">2.8.2 描述某个资源的详细信息</a></li><li><a href="#283_kubepublicpod_301" rel="nofollow">2.8.3 查看命名空间kube-public中pod信息</a></li><li><a href="#284__311" rel="nofollow">2.8.4 登录容器</a></li><li><a href="#285_pod_323" rel="nofollow">2.8.5 删除（重启）pod资源</a></li><li><a href="#286_terminatepod_338" rel="nofollow">2.8.6 若无法删除，总是处于terminate状态，则要强行删除pod</a></li><li><a href="#287__355" rel="nofollow">2.8.7 扩缩容</a></li><li><ul><li><a href="#2871__357" rel="nofollow">2.8.7.1 扩容</a></li><li><a href="#2872__371" rel="nofollow">2.8.7.2 缩容</a></li></ul> 
      </li><li><a href="#288__388" rel="nofollow">2.8.8 删除副本控制器</a></li></ul> 
     </li><li><a href="#29_label_403" rel="nofollow">2.9 增加/删除label</a></li><li><ul><li><a href="#291_label_405" rel="nofollow">2.9.1 增加label</a></li><li><a href="#292_label_420" rel="nofollow">2.9.2 删除label</a></li></ul> 
    </li></ul> 
    </li><li><a href="#3_K8S_435" rel="nofollow">3. K8S模拟项目</a></li><li><ul><li><a href="#31__437" rel="nofollow">3.1 项目的生命周期</a></li><li><a href="#32_kubectl_run_441" rel="nofollow">3.2 创建kubectl run命令</a></li><li><a href="#33_kubectl_expose_487" rel="nofollow">3.3 发布kubectl expose命令</a></li><li><ul><li><a href="#331_Service_500" rel="nofollow">3.3.1 Service的作用</a></li><li><a href="#332_Service_506" rel="nofollow">3.3.2 Service的类型</a></li><li><a href="#333_PodService_513" rel="nofollow">3.3.3 查看Pod网络状态详细信息和Service暴露的端口</a></li><li><a href="#334__529" rel="nofollow">3.3.4 查看关联后端的节点</a></li><li><a href="#335_service_540" rel="nofollow">3.3.5 查看service的描述信息</a></li><li><a href="#336__562" rel="nofollow">3.3.6 查看负载均衡端口</a></li><li><a href="#337__610" rel="nofollow">3.3.7 访问查看</a></li><li><a href="#338__675" rel="nofollow">3.3.8 查看访问日志</a></li></ul> 
     </li><li><a href="#34_kubectl_set_686" rel="nofollow">3.4 更新kubectl set</a></li><li><ul><li><a href="#341__691" rel="nofollow">3.4.1 获取修改模板</a></li><li><a href="#342_nginx_704" rel="nofollow">3.4.2 查看当前nginx的版本号</a></li><li><a href="#343_nginx115_721" rel="nofollow">3.4.3 将nginx版本更新为1.15</a></li><li><a href="#344_pod_730" rel="nofollow">3.4.4 监听pod状态</a></li><li><a href="#345_podip_774" rel="nofollow">3.4.5 查看pod的ip变化</a></li><li><a href="#346_nginx_788" rel="nofollow">3.4.6 重新查看nginx版本号</a></li></ul> 
     </li><li><a href="#35_kubectl_rollout_804" rel="nofollow">3.5 回滚kubectl rollout</a></li><li><ul><li><a href="#351__809" rel="nofollow">3.5.1 查看历史版本</a></li><li><a href="#352__821" rel="nofollow">3.5.2 执行回滚到上一个版本</a></li><li><a href="#353__857" rel="nofollow">3.5.3 执行回滚到指定版本</a></li><li><a href="#354__904" rel="nofollow">3.5.4 检查回滚状态</a></li></ul> 
     </li><li><a href="#36_kubectl_delete_913" rel="nofollow">3.6 删除kubectl delete</a></li><li><ul><li><a href="#361__915" rel="nofollow">3.6.1 删除副本控制器</a></li><li><a href="#362_service_929" rel="nofollow">3.6.2 删除service</a></li></ul> 
    </li></ul> 
    </li><li><a href="#4_Canary_Release_950" rel="nofollow">4. 金丝雀发布/灰度发布（Canary Release）</a></li><li><ul><li><a href="#41__952" rel="nofollow">4.1 金丝雀发布简介</a></li><li><a href="#42_deploymentdeployment_956" rel="nofollow">4.2 更新deployment的版本，并配置暂停deployment</a></li><li><ul><li><a href="#421_pods_958" rel="nofollow">4.2.1 创建pods</a></li><li><a href="#422__976" rel="nofollow">4.2.2 发布服务</a></li><li><a href="#423_nginx_989" rel="nofollow">4.2.3 查看nginx版本</a></li><li><a href="#424_CHANGECAUSE_1005" rel="nofollow">4.2.4 定义版本CHANGE-CAUSE</a></li><li><ul><li><a href="#4241__1007" rel="nofollow">4.2.4.1 查看历史版本</a></li><li><a href="#4242_CHANGECAUSE_1019" rel="nofollow">4.2.4.2 定义版本CHANGE-CAUSE</a></li><li><a href="#4243__1037" rel="nofollow">4.2.4.3 再次查看历史版本</a></li></ul> 
      </li><li><a href="#425_nginx115_1046" rel="nofollow">4.2.5 更新nginx版本为1.15并配置暂停</a></li><li><a href="#426__1056" rel="nofollow">4.2.6 观察更新状态</a></li><li><a href="#427__1065" rel="nofollow">4.2.7 监控更新的过程</a></li><li><a href="#428_nginx_1079" rel="nofollow">4.2.8 查看nginx版本</a></li><li><a href="#429_changecause_1141" rel="nofollow">4.2.9 查看并更新历史版本change-cause</a></li><li><a href="#4210_resume_1177" rel="nofollow">4.2.10 resume继续更新</a></li><li><a href="#4211__1187" rel="nofollow">4.2.11 查看最后的更新情况</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#_1218" rel="nofollow">二、声明式管理</a></li><li><ul><li><a href="#1__1220" rel="nofollow">1. 声明式管理方法</a></li><li><a href="#2__1228" rel="nofollow">2. 查看资源配置清单</a></li><li><a href="#3__1332" rel="nofollow">3. 解释资源配置清单</a></li><li><a href="#4__1383" rel="nofollow">4. 修改资源配置清单并应用</a></li><li><ul><li><a href="#41__1385" rel="nofollow">4.1 离线修改</a></li><li><a href="#42__1449" rel="nofollow">4.2 在线修改</a></li></ul> 
    </li><li><a href="#5__1478" rel="nofollow">5. 删除资源配置清单</a></li><li><ul><li><a href="#51__1480" rel="nofollow">5.1 陈述式删除</a></li><li><a href="#52__1492" rel="nofollow">5.2 声明式删除</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h3><a id="_4"></a>一、陈述式管理</h3> 
<h4><a id="1__6"></a>1. 陈述式资源管理方法</h4> 
<ul><li>kubernetes 集群管理集群资源的唯一入口是通过相应的方法调用 apiserver 的接口</li><li>kubectl 是官方的 CLI 命令行工具，用于与 apiserver 进行通信，将用户在命令行输入的命令，组织并转化为 apiserver 能识别的信息，进而实现管理 k8s 各种资源的一种有效途径</li><li>kubectl 的命令大全<br> <code>kubectl --help</code><br> <code>k8s官方中文文档：</code><a href="http://docs.kubernetes.org.cn/683.html" rel="nofollow">http://docs.kubernetes.org.cn/683.html</a></li><li>对资源的增、删、查操作比较容易，但对改的操作就不容易了</li></ul> 
<h4><a id="2_k8s__15"></a>2. k8s 相关信息查看</h4> 
<h5><a id="21__17"></a>2.1 查看版本信息</h5> 
<p><code>kubectl version</code></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl version</span>
Client Version: version.Info<span class="token punctuation">{<!-- --></span>Major:<span class="token string">"1"</span>, Minor:<span class="token string">"15"</span>, GitVersion:<span class="token string">"v1.15.1"</span>, GitCommit:<span class="token string">"4485c6f18cee9a5d3c3b4e523bd27972b1b53892"</span>, GitTreeState:<span class="token string">"clean"</span>, BuildDate:<span class="token string">"2019-07-18T09:18:22Z"</span>, GoVersion:<span class="token string">"go1.12.5"</span>, Compiler:<span class="token string">"gc"</span>, Platform:<span class="token string">"linux/amd64"</span><span class="token punctuation">}</span>
Server Version: version.Info<span class="token punctuation">{<!-- --></span>Major:<span class="token string">"1"</span>, Minor:<span class="token string">"15"</span>, GitVersion:<span class="token string">"v1.15.1"</span>, GitCommit:<span class="token string">"4485c6f18cee9a5d3c3b4e523bd27972b1b53892"</span>, GitTreeState:<span class="token string">"clean"</span>, BuildDate:<span class="token string">"2019-07-18T09:09:21Z"</span>, GoVersion:<span class="token string">"go1.12.5"</span>, Compiler:<span class="token string">"gc"</span>, Platform:<span class="token string">"linux/amd64"</span><span class="token punctuation">}</span>
</code></pre> 
<p><code>kubectl get nodes</code></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes </span>
NAME     STATUS   ROLES    AGE   VERSION
master   Ready    master   20h   v1.15.1
node01   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   20h   v1.15.1
node02   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   20h   v1.15.1
</code></pre> 
<h5><a id="22__37"></a>2.2 查看资源对象简写</h5> 
<p>kubectl api-resources</p> 
<pre><code>[root@master ~]# kubectl api-resources
NAME                              SHORTNAMES   APIGROUP                       NAMESPACED   KIND
bindings                                                                      true         Binding
componentstatuses                 cs                                          false        ComponentStatus
configmaps                        cm                                          true         ConfigMap
endpoints                         ep                                          true         Endpoints
events                            ev                                          true         Event
limitranges                       limits                                      true         LimitRange
namespaces                        ns                                          false        Namespace
nodes                             no                                          false        Node
persistentvolumeclaims            pvc                                         true         PersistentVolumeClaim
persistentvolumes                 pv                                          false        PersistentVolume
pods                              po                                          true         Pod
podtemplates                                                                  true         PodTemplate
replicationcontrollers            rc                                          true         ReplicationController
resourcequotas                    quota                                       true         ResourceQuota
secrets                                                                       true         Secret
serviceaccounts                   sa                                          true         ServiceAccount
services                          svc                                         true         Service
mutatingwebhookconfigurations                  admissionregistration.k8s.io   false        MutatingWebhookConfiguration
validatingwebhookconfigurations                admissionregistration.k8s.io   false        ValidatingWebhookConfiguration
customresourcedefinitions         crd,crds     apiextensions.k8s.io           false        CustomResourceDefinition
apiservices                                    apiregistration.k8s.io         false        APIService
controllerrevisions                            apps                           true         ControllerRevision
daemonsets                        ds           apps                           true         DaemonSet
deployments                       deploy       apps                           true         Deployment
replicasets                       rs           apps                           true         ReplicaSet
statefulsets                      sts          apps                           true         StatefulSet
tokenreviews                                   authentication.k8s.io          false        TokenReview
localsubjectaccessreviews                      authorization.k8s.io           true         LocalSubjectAccessReview
selfsubjectaccessreviews                       authorization.k8s.io           false        SelfSubjectAccessReview
selfsubjectrulesreviews                        authorization.k8s.io           false        SelfSubjectRulesReview
subjectaccessreviews                           authorization.k8s.io           false        SubjectAccessReview
horizontalpodautoscalers          hpa          autoscaling                    true         HorizontalPodAutoscaler
cronjobs                          cj           batch                          true         CronJob
jobs                                           batch                          true         Job
certificatesigningrequests        csr          certificates.k8s.io            false        CertificateSigningRequest
leases                                         coordination.k8s.io            true         Lease
events                            ev           events.k8s.io                  true         Event
daemonsets                        ds           extensions                     true         DaemonSet
deployments                       deploy       extensions                     true         Deployment
ingresses                         ing          extensions                     true         Ingress
networkpolicies                   netpol       extensions                     true         NetworkPolicy
podsecuritypolicies               psp          extensions                     false        PodSecurityPolicy
replicasets                       rs           extensions                     true         ReplicaSet
ingresses                         ing          networking.k8s.io              true         Ingress
networkpolicies                   netpol       networking.k8s.io              true         NetworkPolicy
runtimeclasses                                 node.k8s.io                    false        RuntimeClass
poddisruptionbudgets              pdb          policy                         true         PodDisruptionBudget
podsecuritypolicies               psp          policy                         false        PodSecurityPolicy
clusterrolebindings                            rbac.authorization.k8s.io      false        ClusterRoleBinding
clusterroles                                   rbac.authorization.k8s.io      false        ClusterRole
rolebindings                                   rbac.authorization.k8s.io      true         RoleBinding
roles                                          rbac.authorization.k8s.io      true         Role
priorityclasses                   pc           scheduling.k8s.io              false        PriorityClass
csidrivers                                     storage.k8s.io                 false        CSIDriver
csinodes                                       storage.k8s.io                 false        CSINode
storageclasses                    sc           storage.k8s.io                 false        StorageClass
volumeattachments                              storage.k8s.io                 false        VolumeAttachment
</code></pre> 
<h5><a id="23__103"></a>2.3 查看集群信息</h5> 
<p>kubectl cluster-info</p> 
<pre><code>[root@master ~]# kubectl cluster-info
Kubernetes master is running at https://192.168.122.10:6443
KubeDNS is running at https://192.168.122.10:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
 
To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
</code></pre> 
<h5><a id="24_kubectl_115"></a>2.4 配置kubectl自动补全</h5> 
<p>source &lt;(kubectl completion bash)</p> 
<pre><code>[root@master ~]# source &lt;(kubectl completion bash)
</code></pre> 
<p>可通过TAB键实现命令补全，建议将其写入 /etc/profile</p> 
<h5><a id="25__125"></a>2.5 查看日志</h5> 
<p>journalctl -u kubelet -f</p> 
<pre><code>[root@master ~]# journalctl -u kubelet -f
-- Logs begin at 一 2021-11-01 18:58:09 CST. --
......
</code></pre> 
<h5><a id="26__135"></a>2.6 基本信息查看</h5> 
<p>kubectl get [-o wide|json|yaml] [-n namespace]<br> 获取资源的相关信息，-n指定命名空间，-o指定输出格式<br> resource可以是具体资源名称，如"pod nhinx-xxx"；也可以是资源类型，如“pod,node,svc,deploy”多种资源使用逗号间隔；或者all（仅展示几种核心资源，并不完整）<br> –all-namespaces或-A：表示显示所有命名空间<br> –show-labels：显示所有标签<br> -l app：仅显示标签为app的资源<br> -l app=nginx：仅显示包含app标签，且值为nginx的资源</p> 
<h6><a id="261_master_145"></a>2.6.1 查看master节点状态</h6> 
<p>kubectl get componentstatuses<br> kubectl get cs</p> 
<pre><code>[root@master ~]# kubectl get componentstatuses
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok                  
controller-manager   Healthy   ok                  
etcd-0               Healthy   {"health":"true"}   
[root@master ~]# kubectl get cs
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok                  
controller-manager   Healthy   ok                  
etcd-0               Healthy   {"health":"true"}   
</code></pre> 
<h6><a id="262__163"></a>2.6.2 查看命名空间</h6> 
<p>kubectl get namespace<br> kubectl get ns</p> 
<pre><code>[root@master ~]# kubectl get namespace
NAME              STATUS   AGE
default           Active   26h
kube-node-lease   Active   26h
kube-public       Active   26h
kube-system       Active   26h
[root@master ~]# kubectl get ns
NAME              STATUS   AGE
default           Active   26h
kube-node-lease   Active   26h
kube-public       Active   26h
kube-system       Active   26h
</code></pre> 
<h5><a id="27__183"></a>2.7 命名空间操作</h5> 
<h6><a id="271_default_185"></a>2.7.1 查看default命名空间的所有资源</h6> 
<p>kubectl get all [-n default]<br> 由于deafult为缺省空间，当不指定命名空间时默认查看default命名空间</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/kubernetes   ClusterIP   <span class="token number">10.244</span>.64.1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   4h36m
</code></pre> 
<h6><a id="272_app_196"></a>2.7.2 创建命名空间app</h6> 
<p>kubectl create ns app</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create ns app</span>
namespace/app created
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns</span>
NAME                   STATUS   AGE
app                    Active   3s
default                Active   4h37m
ingress-controller     Active   4h34m
kube-node-lease        Active   4h37m
kube-public            Active   4h37m
kube-system            Active   4h37m
kubernetes-dashboard   Active   4h33m
</code></pre> 
<h6><a id="273_app_216"></a>2.7.3 删除命名空间app</h6> 
<p>kubectl delete ns app</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete ns app</span>
namespace <span class="token string">"app"</span> deleted
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns</span>
NAME                   STATUS   AGE
default                Active   4h37m
ingress-controller     Active   4h35m
kube-node-lease        Active   4h37m
kube-public            Active   4h37m
kube-system            Active   4h37m
kubernetes-dashboard   Active   4h33m
</code></pre> 
<h5><a id="28_deploymentpod_233"></a>2.8 deployment/pod操作</h5> 
<h6><a id="281_kubepublicdeploymentPodnginxtest_235"></a>2.8.1 在命名空间kube-public创建副本控制器（deployment）来启动Pod（nginx-test）</h6> 
<p>kubectl create deployment nginx-test --image=nginx -n kube-public</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public</span>
No resources found <span class="token keyword">in</span> kube-public namespace.
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment nginx-test --image=nginx -n kube-public </span>
deployment.apps/nginx-test created
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n kube-public</span>
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
nginx-test   <span class="token number">0</span>/1     <span class="token number">1</span>            <span class="token number">0</span>           23s
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n kube-public</span>
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
nginx-test   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           2m24s
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public</span>
NAME                          READY   STATUS    RESTARTS   AGE
nginx-test-795d659f45-n4nks   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m58s
</code></pre> 
<h6><a id="282__255"></a>2.8.2 描述某个资源的详细信息</h6> 
<p>kubectl describe deployment nginx-test -n kube-public</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe deployment nginx-test -n kube-public </span>
Name:                   nginx-test
Namespace:              kube-public
CreationTimestamp:      Thu, <span class="token number">16</span> Dec <span class="token number">2021</span> <span class="token number">20</span>:35:23 +0800
Labels:                 <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-test
Annotations:            deployment.kubernetes.io/revision: <span class="token number">1</span>
Selector:               <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-test
Replicas:               <span class="token number">1</span> desired <span class="token operator">|</span> <span class="token number">1</span> updated <span class="token operator">|</span> <span class="token number">1</span> total <span class="token operator">|</span> <span class="token number">1</span> available <span class="token operator">|</span> <span class="token number">0</span> unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        <span class="token number">0</span>
RollingUpdateStrategy:  <span class="token number">25</span>% max unavailable, <span class="token number">25</span>% max surge
Pod Template:
  Labels:  <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-test
  Containers:
   nginx:
    Image:        nginx
    Port:         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Host Port:    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Environment:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Mounts:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
  Volumes:        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
NewReplicaSet:   nginx-test-795d659f45 <span class="token punctuation">(</span><span class="token number">1</span>/1 replicas created<span class="token punctuation">)</span>
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  4m26s  deployment-controller  Scaled up replica <span class="token builtin class-name">set</span> nginx-test-795d659f45 to <span class="token number">1</span>
</code></pre> 
<p>kubectl describe pod nginx-test -n kube-public</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod nginx-test -n kube-public</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<h6><a id="283_kubepublicpod_301"></a>2.8.3 查看命名空间kube-public中pod信息</h6> 
<p>kubectl get pods -n kube-public</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
NAME                          READY   STATUS    RESTARTS   AGE
nginx-test-795d659f45-n4nks   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m4s
</code></pre> 
<h6><a id="284__311"></a>2.8.4 登录容器</h6> 
<p>kubectl exec 可以跨主机登录容器，docker exec 只能在容器所在主机登录</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it nginx-test-795d659f45-n4nks bash -n kube-public </span>
kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
root@nginx-test-795d659f45-n4nks:/<span class="token comment"># ls</span>
bin   dev		   docker-entrypoint.sh  home  lib64  mnt  proc  run   srv  tmp  var
boot  docker-entrypoint.d  etc			 lib   media  opt  root  sbin  sys  usr
</code></pre> 
<h6><a id="285_pod_323"></a>2.8.5 删除（重启）pod资源</h6> 
<p>由于存在 deployment/rc 之类的副本控制器，删除 pod 也会重新拉起来</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
NAME                          READY   STATUS    RESTARTS   AGE
nginx-test-795d659f45-n4nks   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod nginx-test-795d659f45-n4nks -n kube-public </span>
pod <span class="token string">"nginx-test-795d659f45-n4nks"</span> deleted
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
NAME                          READY   STATUS    RESTARTS   AGE
nginx-test-795d659f45-65pwr   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11s
</code></pre> 
<h6><a id="286_terminatepod_338"></a>2.8.6 若无法删除，总是处于terminate状态，则要强行删除pod</h6> 
<p>kubectl delete pod [] -n [] --force --grace-period=0<br> <code>grace-period表示过渡存活期，默认30s，在删除pod之前允许pod慢慢终止其上的容器进程，从而优雅的退出，0表示立即终止pod</code></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
NAME                          READY   STATUS    RESTARTS   AGE
nginx-test-795d659f45-r2jwz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13s
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod nginx-test-795d659f45-r2jwz -n kube-public --force --grace-period=0</span>
warning: Immediate deletion does not <span class="token function">wait</span> <span class="token keyword">for</span> confirmation that the running resource has been terminated. The resource may <span class="token builtin class-name">continue</span> to run on the cluster indefinitely.
pod <span class="token string">"nginx-test-795d659f45-r2jwz"</span> force deleted
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
NAME                          READY   STATUS              RESTARTS   AGE
nginx-test-795d659f45-6h9kj   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          9s
</code></pre> 
<h6><a id="287__355"></a>2.8.7 扩缩容</h6> 
<h6><a id="2871__357"></a>2.8.7.1 扩容</h6> 
<p>kubectl scale deployment nginx-test --replicas=3 -n kube-public</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl scale deployment nginx-test --replicas=3 -n kube-public</span>
deployment.apps/nginx-test scaled
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
NAME                          READY   STATUS              RESTARTS   AGE
nginx-test-795d659f45-6h9kj   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          7m
nginx-test-795d659f45-gl6z2   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          101s
nginx-test-795d659f45-p2q9s   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          101s
</code></pre> 
<h6><a id="2872__371"></a>2.8.7.2 缩容</h6> 
<p>kubectl scale deployment nginx-test --replicas=1 -n kube-public</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl scale deployment nginx-test --replicas=1 -n kube-public </span>
deployment.apps/nginx-test scaled
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
NAME                          READY   STATUS        RESTARTS   AGE
nginx-test-795d659f45-6h9kj   <span class="token number">1</span>/1     Running       <span class="token number">0</span>          8m4s
nginx-test-795d659f45-gl6z2   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          2m45s
nginx-test-795d659f45-p2q9s   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          2m45s
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
NAME                          READY   STATUS    RESTARTS   AGE
nginx-test-795d659f45-6h9kj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m19s
</code></pre> 
<h6><a id="288__388"></a>2.8.8 删除副本控制器</h6> 
<p>kubectl delete deployment nginx-test -n kube-public<br> kubectl delete deployment/nginx-test -n kube-public</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete deployment nginx-test -n kube-public</span>
deployment.apps <span class="token string">"nginx-test"</span> deleted
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
NAME                          READY   STATUS        RESTARTS   AGE
nginx-test-795d659f45-6h9kj   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          8m46s
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-public </span>
No resources found <span class="token keyword">in</span> kube-public namespace.
</code></pre> 
<h5><a id="29_label_403"></a>2.9 增加/删除label</h5> 
<h6><a id="291_label_405"></a>2.9.1 增加label</h6> 
<p>kubectl label deploy nginx-test version=nginx1.14</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy --show-labels</span>
NAME         READY   UP-TO-DATE   AVAILABLE   AGE   LABELS
nginx-test   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           19m   <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx-test
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl label deploy nginx-test version=nginx1.14</span>
deployment.extensions/nginx-test labeled
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy --show-labels</span>
NAME         READY   UP-TO-DATE   AVAILABLE   AGE   LABELS
nginx-test   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           19m   <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx-test,version<span class="token operator">=</span>nginx1.14
</code></pre> 
<h6><a id="292_label_420"></a>2.9.2 删除label</h6> 
<p>kubectl label deploy nginx-test version-</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy --show-labels</span>
NAME         READY   UP-TO-DATE   AVAILABLE   AGE   LABELS
nginx-test   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           19m   <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx-test,version<span class="token operator">=</span>nginx1.14
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl label deploy nginx-test version-</span>
deployment.extensions/nginx-test labeled
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy --show-labels</span>
NAME         READY   UP-TO-DATE   AVAILABLE   AGE   LABELS
nginx-test   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           20m   <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx-test
</code></pre> 
<h4><a id="3_K8S_435"></a>3. K8S模拟项目</h4> 
<p><a href="https://www.cnblogs.com/shenyuanhaojie/p/16392944.html" rel="nofollow">K8S 模拟项目 pod 发布</a></p> 
<h5><a id="31__437"></a>3.1 项目的生命周期</h5> 
<p>创建–&gt;发布–&gt;更新–&gt;回滚–&gt;删除</p> 
<h5><a id="32_kubectl_run_441"></a>3.2 创建kubectl run命令</h5> 
<p>● 创建并运行一个或多个容器镜像<br> ● 创建一个deployment或job来管理容器<br> kubectl run --help查看使用帮助</p> 
<p>启动nginx实例，暴露容器端口80，设置副本数3<br> kubectl run nginx --image=nginx:1.14 --port=80 --replicas=3</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx --image=nginx:1.14 --port=80 --replicas=3</span>
kubectl run --generator<span class="token operator">=</span>deployment/apps.v1 is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl run --generator<span class="token operator">=</span>run-pod/v1 or kubectl create instead.
deployment.apps/nginx created
</code></pre> 
<p>kubectl get pods</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME                     READY   STATUS    RESTARTS   AGE
nginx-65fc77987d-cwvwl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7s
nginx-65fc77987d-m7cnn   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7s
nginx-65fc77987d-z7hvx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7s
</code></pre> 
<p>kubectl get all</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                         READY   STATUS    RESTARTS   AGE
pod/nginx-65fc77987d-cwvwl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24s
pod/nginx-65fc77987d-m7cnn   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24s
pod/nginx-65fc77987d-z7hvx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24s


NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/kubernetes   ClusterIP   <span class="token number">10.1</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   82s


NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           24s

NAME                               DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-65fc77987d   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       24s
</code></pre> 
<h5><a id="33_kubectl_expose_487"></a>3.3 发布kubectl expose命令</h5> 
<p>● 将资源暴露为新的Service<br> kubectl expose --help查看使用帮助</p> 
<p>为Deployment的nginx创建Service，并通过Service的80端口转发至容器的80端口上，Service的名称为nginx-service，类型为NodePort<br> kubectl expose deployment nginx --port=80 --target-port=80 --name=nginx-service --type=NodePort</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl expose deployment nginx --port=80 --target-port=80 --name=nginx-service --type=NodePort</span>
service/nginx-service exposed
</code></pre> 
<h6><a id="331_Service_500"></a>3.3.1 Service的作用</h6> 
<p>Kubernetes之所以需要Service，一方面是因为Pod的IP不是固定的（Pod可能会重建），另一方面是因为一组Pod实例之间总会有负载均衡的需求。<br> Service通过Label Selector实现的对一组的Pod的访问。<br> 对于容器应用而言，Kubernetes提供了基于VIP（虚拟IP）的网桥的方式访问Service，再由Service重定向到相应的Pod。</p> 
<h6><a id="332_Service_506"></a>3.3.2 Service的类型</h6> 
<p><img src="https://images2.imgbox.com/12/54/SrQfnPgQ_o.png" alt="img"><br> ● ClusterIP:提供一个集群内部的虚拟IP以供Pod访问（Service默认类型）<br> ● NodePort:在每个Node上打开一个端口以供外部访问，Kubernetes将会在每个Node上打开一个端口并且每个Node的端口都是一样的，通过NodeIP:NodePort的方式<br> ● LoadBalancer:通过外部的负载均衡器来访问，通常在云平台部署LoadBalancer还需要额外的费用。</p> 
<h6><a id="333_PodService_513"></a>3.3.3 查看Pod网络状态详细信息和Service暴露的端口</h6> 
<p>kubectl get pods,svc -o wide</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods,svc -o wide</span>
NAME                         READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES
pod/nginx-65fc77987d-cwvwl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          61s   <span class="token number">10.244</span>.1.25   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
pod/nginx-65fc77987d-m7cnn   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          61s   <span class="token number">10.244</span>.1.24   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
pod/nginx-65fc77987d-z7hvx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          61s   <span class="token number">10.244</span>.2.15   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE    SELECTOR
service/kubernetes      ClusterIP   <span class="token number">10.1</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        119s   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
service/nginx-service   NodePort    <span class="token number">10.1</span>.155.154   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:32107/TCP   15s    <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx
</code></pre> 
<h6><a id="334__529"></a>3.3.4 查看关联后端的节点</h6> 
<p>kubectl get endpoints</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get endpoints</span>
NAME            ENDPOINTS                                      AGE
kubernetes      <span class="token number">192.168</span>.122.10:6443                            15m
nginx-service   <span class="token number">10.244</span>.1.24:80,10.244.1.25:80,10.244.2.15:80   13m
</code></pre> 
<h6><a id="335_service_540"></a>3.3.5 查看service的描述信息</h6> 
<p>kubectl describe svc nginx</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe svc nginx</span>
Name:                     nginx-service
Namespace:                default
Labels:                   <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx
Annotations:              <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:                 <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx
Type:                     NodePort
IP:                       <span class="token number">10.1</span>.155.154
Port:                     <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">80</span>/TCP
TargetPort:               <span class="token number">80</span>/TCP
NodePort:                 <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">32107</span>/TCP
Endpoints:                <span class="token number">10.244</span>.1.24:80,10.244.1.25:80,10.244.2.15:80
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<h6><a id="336__562"></a>3.3.6 查看负载均衡端口</h6> 
<p>在node01节点上操作</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node01 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y ipvsadm</span>
<span class="token punctuation">[</span>root@node01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>      
TCP  <span class="token number">192.168</span>.122.11:32107 rr
<span class="token comment">#外部访问的IP和端口</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.24:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.25:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.2.15:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>        
TCP  <span class="token number">10.1</span>.155.154:80 rr
<span class="token comment">#pod集群组内部访问的IP和端口</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.24:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.25:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.2.15:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>                
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>     
</code></pre> 
<p>在node02节点上操作</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@node02 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y ipvsadm</span>
<span class="token punctuation">[</span>root@node02 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
TCP  <span class="token number">192.168</span>.122.12:32107 rr
<span class="token comment">#外部访问的IP和端口</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.24:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.25:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.2.15:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
TCP  <span class="token number">10.1</span>.155.154:80 rr
<span class="token comment">#pod集群组内部访问的IP和端口</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.24:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.1.25:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.2.15:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>         
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<h6><a id="337__610"></a>3.3.7 访问查看</h6> 
<p>curl 10.1.155.154</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl 10.1.155.154</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
    body <span class="token punctuation">{<!-- --></span>
        width: 35em<span class="token punctuation">;</span>
        margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
        font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.org/"</span><span class="token operator">&gt;</span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>br/<span class="token operator">&gt;</span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.com/"</span><span class="token operator">&gt;</span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> 
<p>curl 192.168.122.11:32107</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl 192.168.122.11:32107</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
    body <span class="token punctuation">{<!-- --></span>
        width: 35em<span class="token punctuation">;</span>
        margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
        font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.org/"</span><span class="token operator">&gt;</span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>br/<span class="token operator">&gt;</span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.com/"</span><span class="token operator">&gt;</span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> 
<h6><a id="338__675"></a>3.3.8 查看访问日志</h6> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs nginx-65fc77987d-cwvwl</span>
<span class="token number">10.244</span>.0.0 - - <span class="token punctuation">[</span>02/Nov/2021:12:58:38 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"curl/7.29.0"</span> <span class="token string">"-"</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs nginx-65fc77987d-m7cnn</span>
<span class="token number">10.244</span>.1.1 - - <span class="token punctuation">[</span>02/Nov/2021:13:00:06 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"curl/7.29.0"</span> <span class="token string">"-"</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs nginx-65fc77987d-z7hvx</span>
<span class="token number">10.244</span>.2.1 - - <span class="token punctuation">[</span>02/Nov/2021:13:00:10 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"curl/7.29.0"</span> <span class="token string">"-"</span>
</code></pre> 
<h5><a id="34_kubectl_set_686"></a>3.4 更新kubectl set</h5> 
<p>● 更改现有应用资源一些信息。<br> kubectl set --help查看使用帮助</p> 
<h6><a id="341__691"></a>3.4.1 获取修改模板</h6> 
<p>kubectl set image --help获取</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image --help</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Examples:
  <span class="token comment"># Set a deployment's nginx container image to 'nginx:1.9.1', and its busybox container image to 'busybox'.</span>
  kubectl <span class="token builtin class-name">set</span> image deployment/nginx <span class="token assign-left variable">busybox</span><span class="token operator">=</span>busybox <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.9.1
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<h6><a id="342_nginx_704"></a>3.4.2 查看当前nginx的版本号</h6> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl -I 192.168.122.11:32107</span>
<span class="token comment">#通过报文头查看版本号</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.14.2
<span class="token comment">#nginx版本号为1.14.2</span>
Date: Tue, 02 Nov <span class="token number">2021</span> <span class="token number">13</span>:10:49 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Tue, 04 Dec <span class="token number">2018</span> <span class="token number">14</span>:44:49 GMT
Connection: keep-alive
ETag: <span class="token string">"5c0692e1-264"</span>
Accept-Ranges: bytes
</code></pre> 
<h6><a id="343_nginx115_721"></a>3.4.3 将nginx版本更新为1.15</h6> 
<p>kubectl set image deployment/nginx nginx=nginx:1.15</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image deployment/nginx nginx=nginx:1.15</span>
deployment.extensions/nginx image updated
</code></pre> 
<h6><a id="344_pod_730"></a>3.4.4 监听pod状态</h6> 
<p>处于动态监听pod状态，由于使用的是滚动更新方式，所以会先生成一个新的pod，然后删除一个旧的pod，往后以此类推<br> kubectl get pods -w</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -w</span>
NAME                     READY   STATUS              RESTARTS   AGE
nginx-65fc77987d-cwvwl   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          62m
nginx-65fc77987d-m7cnn   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          62m
nginx-65fc77987d-z7hvx   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          62m
nginx-6cbd4b987c-65qtx   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          23s
<span class="token comment">#新建第一个pod</span>
nginx-6cbd4b987c-65qtx   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          24s
nginx-65fc77987d-cwvwl   <span class="token number">1</span>/1     Terminating         <span class="token number">0</span>          63m
<span class="token comment">#第一个新pod运行后，删除一个旧pod</span>
nginx-6cbd4b987c-27qz7   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
nginx-6cbd4b987c-27qz7   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
nginx-6cbd4b987c-27qz7   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
<span class="token comment">#新建第二个pod</span>
nginx-65fc77987d-cwvwl   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-65fc77987d-cwvwl   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-65fc77987d-cwvwl   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-6cbd4b987c-27qz7   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          8s
nginx-65fc77987d-m7cnn   <span class="token number">1</span>/1     Terminating         <span class="token number">0</span>          63m
<span class="token comment">#第二个新pod运行后，删除第二个旧pod</span>
nginx-6cbd4b987c-m467f   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
nginx-6cbd4b987c-m467f   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
nginx-6cbd4b987c-m467f   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
<span class="token comment">#新建第三个pod</span>
nginx-65fc77987d-m7cnn   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-6cbd4b987c-m467f   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s
nginx-65fc77987d-z7hvx   <span class="token number">1</span>/1     Terminating         <span class="token number">0</span>          63m
<span class="token comment">#第三个新pod运行后，删除第三个旧pod</span>
nginx-65fc77987d-z7hvx   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-65fc77987d-m7cnn   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-65fc77987d-m7cnn   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-65fc77987d-z7hvx   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-65fc77987d-z7hvx   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m

</code></pre> 
<p>更新规则可通过“kubetl describe deployment nginx”的“RollingUpdateStrategy”查看，默认配置为“25% max unavailable, 25% max surge”，即按照25%的比例进行滚动更新。</p> 
<h6><a id="345_podip_774"></a>3.4.5 查看pod的ip变化</h6> 
<p>kubectl get pod -o wide</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -o wide</span>
NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE     NOMINATED NODE   READINESS GATES
nginx-6cbd4b987c-27qz7   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m19s   <span class="token number">10.244</span>.2.16   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-6cbd4b987c-65qtx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m43s   <span class="token number">10.244</span>.1.26   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-6cbd4b987c-m467f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m11s   <span class="token number">10.244</span>.1.27   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<p>pod更新后，ip改变</p> 
<h6><a id="346_nginx_788"></a>3.4.6 重新查看nginx版本号</h6> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl -I 192.168.122.11:32107</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.15.12
<span class="token comment">#nginx版本更新为1.15.12</span>
Date: Tue, 02 Nov <span class="token number">2021</span> <span class="token number">13</span>:22:29 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Tue, <span class="token number">16</span> Apr <span class="token number">2019</span> <span class="token number">13</span>:08:19 GMT
Connection: keep-alive
ETag: <span class="token string">"5cb5d3c3-264"</span>
Accept-Ranges: bytes
</code></pre> 
<h5><a id="35_kubectl_rollout_804"></a>3.5 回滚kubectl rollout</h5> 
<p>● 对资源进行回滚管理<br> kubectl rollout --help查看使用帮助</p> 
<h6><a id="351__809"></a>3.5.1 查看历史版本</h6> 
<p>kubectl rollout history deployment/nginx</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout history deployment/nginx</span>
deployment.extensions/nginx 
REVISION  CHANGE-CAUSE
<span class="token number">1</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
<span class="token number">2</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<h6><a id="352__821"></a>3.5.2 执行回滚到上一个版本</h6> 
<p>kubectl rollout undo deployment/nginx</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout undo deployment/nginx</span>
deployment.extensions/nginx rolled back
</code></pre> 
<p>查看pod的ip变化</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -o wide</span>
NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES
<span class="token comment">#回滚后ip再次改变</span>
nginx-65fc77987d-2525z   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          42s   <span class="token number">10.244</span>.2.17   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-65fc77987d-9qkzp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          40s   <span class="token number">10.244</span>.2.18   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-65fc77987d-qg75q   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41s   <span class="token number">10.244</span>.1.28   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<p>查看当前nginx版本</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl -I 192.168.122.11:32107</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.14.2
<span class="token comment">#nginx版本回到1.14.2</span>
Date: Tue, 02 Nov <span class="token number">2021</span> <span class="token number">13</span>:31:35 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Tue, 04 Dec <span class="token number">2018</span> <span class="token number">14</span>:44:49 GMT
Connection: keep-alive
ETag: <span class="token string">"5c0692e1-264"</span>
Accept-Ranges: bytes
</code></pre> 
<h6><a id="353__857"></a>3.5.3 执行回滚到指定版本</h6> 
<p>查看历史版本</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout history deployment/nginx</span>
deployment.extensions/nginx 
REVISION  CHANGE-CAUSE
<span class="token number">2</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
<span class="token number">3</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<p>回到revison2，即1.15版本<br> kubectl rollout undo deployment/nginx --to-revision=2</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout undo deployment/nginx --to-revision=2</span>
deployment.extensions/nginx rolled back
</code></pre> 
<p>查看pod的ip变化</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -o wide</span>
NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES
<span class="token comment">#回滚后ip再次改变</span>
nginx-6cbd4b987c-mhqbc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s   <span class="token number">10.244</span>.1.29   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-6cbd4b987c-tf462   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          36s   <span class="token number">10.244</span>.2.19   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-6cbd4b987c-z86d6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          35s   <span class="token number">10.244</span>.1.30   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<p>查看当前nginx版本</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl -I 192.168.122.11:32107</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.15.12
<span class="token comment">#nginx版本回到1.15.12</span>
Date: Tue, 02 Nov <span class="token number">2021</span> <span class="token number">13</span>:36:42 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Tue, <span class="token number">16</span> Apr <span class="token number">2019</span> <span class="token number">13</span>:08:19 GMT
Connection: keep-alive
ETag: <span class="token string">"5cb5d3c3-264"</span>
Accept-Ranges: bytes
</code></pre> 
<h6><a id="354__904"></a>3.5.4 检查回滚状态</h6> 
<p>kubectl rollout status deployment/nginx</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout status deployment/nginx</span>
deployment <span class="token string">"nginx"</span> successfully rolled out
</code></pre> 
<h5><a id="36_kubectl_delete_913"></a>3.6 删除kubectl delete</h5> 
<h6><a id="361__915"></a>3.6.1 删除副本控制器</h6> 
<p>kubectl delete deployment/nginx</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy</span>
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           88m
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete deployment/nginx</span>
deployment.extensions <span class="token string">"nginx"</span> deleted
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy</span>
No resources found.
</code></pre> 
<h6><a id="362_service_929"></a>3.6.2 删除service</h6> 
<p>kubectl delete svc/nginx-service</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
kubernetes      ClusterIP   <span class="token number">10.1</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        91m
nginx-service   NodePort    <span class="token number">10.1</span>.155.154   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:32107/TCP   89m
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete svc/nginx-service</span>
<span class="token function">service</span> <span class="token string">"nginx-service"</span> deleted
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.1</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   91m
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>


NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/kubernetes   ClusterIP   <span class="token number">10.1</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   92m
</code></pre> 
<h4><a id="4_Canary_Release_950"></a>4. 金丝雀发布/灰度发布（Canary Release）</h4> 
<h5><a id="41__952"></a>4.1 金丝雀发布简介</h5> 
<p>Deployment控制器支持自定义控制更新过程中的滚动节奏，如“暂停（pause）”或“继续（resume）”更新操作。比如等待第一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，在筛选一小部分的用户请求路由到新版本的Pod应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的Pod资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p> 
<h5><a id="42_deploymentdeployment_956"></a>4.2 更新deployment的版本，并配置暂停deployment</h5> 
<h6><a id="421_pods_958"></a>4.2.1 创建pods</h6> 
<p>kubectl run nginx-test --image=nginx:1.14 --replicas=3</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx-test --image=nginx:1.14 --replicas=3</span>
kubectl run --generator<span class="token operator">=</span>deployment/apps.v1 is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl run --generator<span class="token operator">=</span>run-pod/v1 or kubectl create instead.
deployment.apps/nginx-test created
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods,deploy -o wide</span>
NAME                              READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES
pod/nginx-test-6cc7cd5547-4xqcb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          51s   <span class="token number">10.244</span>.2.23   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
pod/nginx-test-6cc7cd5547-gcbh5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          51s   <span class="token number">10.244</span>.1.37   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
pod/nginx-test-6cc7cd5547-nw6k6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          51s   <span class="token number">10.244</span>.1.38   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

NAME                               READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES       SELECTOR
deployment.extensions/nginx-test   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           51s   nginx-test   nginx:1.14   <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx-test
</code></pre> 
<h6><a id="422__976"></a>4.2.2 发布服务</h6> 
<p>kubectl expose deploy nginx-test --port=80 --target-port=80 --name=nginx-service --type=NodePort</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl expose deploy nginx-test --port=80 --target-port=80 --name=nginx-service --type=NodePort</span>
service/nginx-service exposed
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -o wide</span>
NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE   SELECTOR
kubernetes      ClusterIP   <span class="token number">10.1</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        23h   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-service   NodePort    <span class="token number">10.1</span>.36.134   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30191/TCP   9s    <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx-test
</code></pre> 
<h6><a id="423_nginx_989"></a>4.2.3 查看nginx版本</h6> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl -I 192.168.122.11:30191</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.14.2
<span class="token comment">#版本号为1.14.2</span>
Date: Wed, 03 Nov <span class="token number">2021</span> <span class="token number">11</span>:54:11 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Tue, 04 Dec <span class="token number">2018</span> <span class="token number">14</span>:44:49 GMT
Connection: keep-alive
ETag: <span class="token string">"5c0692e1-264"</span>
Accept-Ranges: bytes
</code></pre> 
<h6><a id="424_CHANGECAUSE_1005"></a>4.2.4 定义版本CHANGE-CAUSE</h6> 
<h6><a id="4241__1007"></a>4.2.4.1 查看历史版本</h6> 
<p>在不定义CHANGE-CAUSE的情况下，缺省值为，当历史版本较多时，不便于咱们回滚时辨认版本号。因此，建议定义CHANGE-CAUSE为服务版本以帮助咱们辨认当前服务。<br> kubectl rollout history deploy/nginx-test</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout history deploy/nginx-test</span>
deployment.extensions/nginx-test 
REVISION  CHANGE-CAUSE
<span class="token number">1</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<h6><a id="4242_CHANGECAUSE_1019"></a>4.2.4.2 定义版本CHANGE-CAUSE</h6> 
<p>一般通过修改配置的方式定义change-cause</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit deploy/nginx-test</span>

<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
kind: Deployment
metadata:
  annotations:
<span class="token comment">#下行可定义历史版本revision</span>
    deployment.kubernetes.io/revision: <span class="token string">"1"</span>
<span class="token comment">#在Deployment的matadata项下的annotations中如下行定义change-cause</span>
    kubernetes.io/change-cause: <span class="token string">"nginx1.14"</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<h6><a id="4243__1037"></a>4.2.4.3 再次查看历史版本</h6> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout history deploy/nginx-test</span>
deployment.extensions/nginx-test 
REVISION  CHANGE-CAUSE
<span class="token number">1</span>         nginx1.14
</code></pre> 
<h6><a id="425_nginx115_1046"></a>4.2.5 更新nginx版本为1.15并配置暂停</h6> 
<p>kubectl set image deploy/nginx-test nginx-test=nginx:1.15 &amp;&amp; kubectl rollout pause deploy/nginx-test</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image deploy/nginx-test nginx-test=nginx:1.15 &amp;&amp; kubectl rollout pause deploy/nginx-test</span>
deployment.extensions/nginx-test image updated
deployment.extensions/nginx-test paused
</code></pre> 
<h6><a id="426__1056"></a>4.2.6 观察更新状态</h6> 
<p>kubectl rollout status deploy/nginx-test</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout status deploy/nginx-test</span>
Waiting <span class="token keyword">for</span> deployment <span class="token string">"nginx-test"</span> rollout to finish: <span class="token number">1</span> out of <span class="token number">3</span> new replicas have been updated<span class="token punctuation">..</span>.
</code></pre> 
<h6><a id="427__1065"></a>4.2.7 监控更新的过程</h6> 
<p>可以看到已经新增了一个pod，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令<br> kubectl get pods -w</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -o wide</span>
NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE     NOMINATED NODE   READINESS GATES
nginx-test-679dcbd68d-zw8w5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m28s   <span class="token number">10.244</span>.2.24   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-test-6cc7cd5547-4xqcb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          48m     <span class="token number">10.244</span>.2.23   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-test-6cc7cd5547-gcbh5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          48m     <span class="token number">10.244</span>.1.37   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-test-6cc7cd5547-nw6k6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          48m     <span class="token number">10.244</span>.1.38   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<h6><a id="428_nginx_1079"></a>4.2.8 查看nginx版本</h6> 
<p>kubectl get pod -o wide</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -o wide</span>
NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE     NOMINATED NODE   READINESS GATES
nginx-test-679dcbd68d-zw8w5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m28s   <span class="token number">10.244</span>.2.24   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-test-6cc7cd5547-4xqcb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          48m     <span class="token number">10.244</span>.2.23   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-test-6cc7cd5547-gcbh5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          48m     <span class="token number">10.244</span>.1.37   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-test-6cc7cd5547-nw6k6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          48m     <span class="token number">10.244</span>.1.38   node01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<p>查看nginx版本</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl -I 192.168.122.12:30191</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.14.2
Date: Wed, 03 Nov <span class="token number">2021</span> <span class="token number">12</span>:45:37 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Tue, 04 Dec <span class="token number">2018</span> <span class="token number">14</span>:44:49 GMT
Connection: keep-alive
ETag: <span class="token string">"5c0692e1-264"</span>
Accept-Ranges: bytes

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl -I 192.168.122.12:30191</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.14.2
Date: Wed, 03 Nov <span class="token number">2021</span> <span class="token number">12</span>:46:59 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Tue, 04 Dec <span class="token number">2018</span> <span class="token number">14</span>:44:49 GMT
Connection: keep-alive
ETag: <span class="token string">"5c0692e1-264"</span>
Accept-Ranges: bytes

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl -I 192.168.122.12:30191</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.14.2
Date: Wed, 03 Nov <span class="token number">2021</span> <span class="token number">12</span>:47:09 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Tue, 04 Dec <span class="token number">2018</span> <span class="token number">14</span>:44:49 GMT
Connection: keep-alive
ETag: <span class="token string">"5c0692e1-264"</span>
Accept-Ranges: bytes

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl -I 192.168.122.12:30191</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.15.12
<span class="token comment">#新pod为1.15</span>
Date: Wed, 03 Nov <span class="token number">2021</span> <span class="token number">12</span>:47:12 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Tue, <span class="token number">16</span> Apr <span class="token number">2019</span> <span class="token number">13</span>:08:19 GMT
Connection: keep-alive
ETag: <span class="token string">"5cb5d3c3-264"</span>
Accept-Ranges: bytes
</code></pre> 
<h6><a id="429_changecause_1141"></a>4.2.9 查看并更新历史版本change-cause</h6> 
<p>kubectl rollout history deploy/nginx-test</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout history deploy/nginx-test</span>
deployment.extensions/nginx-test 
REVISION  CHANGE-CAUSE
<span class="token number">1</span>         nginx1.14
<span class="token number">2</span>         nginx1.14
</code></pre> 
<p>kubectl edit deploy/nginx-test</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit deploy/nginx-test</span>

kind: Deployment
metadata:
  annotations:
<span class="token comment">#下行的revison自动更新为2</span>
    deployment.kubernetes.io/revision: <span class="token string">"2"</span>
<span class="token comment">#修改下行的change-cause为nginx1.15</span>
    kubernetes.io/change-cause: nginx1.15
</code></pre> 
<p>kubectl rollout history deploy/nginx-test</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout history deploy/nginx-test</span>
deployment.extensions/nginx-test 
REVISION  CHANGE-CAUSE
<span class="token number">1</span>         nginx1.14
<span class="token number">2</span>         nginx1.15
</code></pre> 
<h6><a id="4210_resume_1177"></a>4.2.10 resume继续更新</h6> 
<p>测试新版本没问题继续更新<br> kubectl rollout resume deploy/nginx-test</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout resume deploy/nginx-test</span>
deployment.extensions/nginx-test resumed
</code></pre> 
<h6><a id="4211__1187"></a>4.2.11 查看最后的更新情况</h6> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -w</span>
NAME                          READY   STATUS    RESTARTS   AGE
nginx-test-679dcbd68d-zw8w5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          61s
nginx-test-6cc7cd5547-4xqcb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41m
nginx-test-6cc7cd5547-gcbh5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41m
nginx-test-6cc7cd5547-nw6k6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41m
nginx-test-6cc7cd5547-gcbh5   <span class="token number">1</span>/1     Terminating   <span class="token number">0</span>          63m
nginx-test-679dcbd68d-cljzh   <span class="token number">0</span>/1     Pending       <span class="token number">0</span>          0s
nginx-test-679dcbd68d-cljzh   <span class="token number">0</span>/1     Pending       <span class="token number">0</span>          0s
nginx-test-679dcbd68d-cljzh   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
nginx-test-6cc7cd5547-gcbh5   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-6cc7cd5547-gcbh5   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-6cc7cd5547-gcbh5   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-679dcbd68d-cljzh   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          1s
nginx-test-6cc7cd5547-nw6k6   <span class="token number">1</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-679dcbd68d-s2gck   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
nginx-test-679dcbd68d-s2gck   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
nginx-test-679dcbd68d-s2gck   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
nginx-test-679dcbd68d-s2gck   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          1s
nginx-test-6cc7cd5547-4xqcb   <span class="token number">1</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-6cc7cd5547-nw6k6   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-6cc7cd5547-4xqcb   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-6cc7cd5547-nw6k6   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-6cc7cd5547-nw6k6   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-6cc7cd5547-4xqcb   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
nginx-test-6cc7cd5547-4xqcb   <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          63m
</code></pre> 
<h3><a id="_1218"></a>二、声明式管理</h3> 
<h4><a id="1__1220"></a>1. 声明式管理方法</h4> 
<ol><li>适合于对资源的修改操作</li><li>声明式资源管理方法依赖于资源配置清明文件对资源进行管理<br> 资源配置清单文件有两种格式：yaml（人性化，易读），json（易于api接口解析）</li><li>对资源的观念里，是通过实现定义在同一资源配置清单内，再通过陈述式命令应用到k8s集群里</li><li>语法格式：kubectl create/apply/delete -f -o yaml</li></ol> 
<h4><a id="2__1228"></a>2. 查看资源配置清单</h4> 
<p>kubectl get deploy/nginx-test -o yaml</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy/nginx-test -o yaml</span>
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: <span class="token string">"3"</span>
    kubernetes.io/change-cause: nginx1.14
  creationTimestamp: <span class="token string">"2021-11-03T11:47:56Z"</span>
  generation: <span class="token number">7</span>
  labels:
    run: nginx-test
  name: nginx-test
  namespace: default
  resourceVersion: <span class="token string">"105895"</span>
  selfLink: /apis/extensions/v1beta1/namespaces/default/deployments/nginx-test
  uid: 634d471e-3907-4717-a02e-f5cce101d2f4
spec:
  progressDeadlineSeconds: <span class="token number">600</span>
  replicas: <span class="token number">3</span>
  revisionHistoryLimit: <span class="token number">10</span>
  selector:
    matchLabels:
      run: nginx-test
  strategy:
    rollingUpdate:
      maxSurge: <span class="token number">25</span>%
      maxUnavailable: <span class="token number">25</span>%
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        run: nginx-test
    spec:
      containers:
      - image: nginx:1.14
        imagePullPolicy: IfNotPresent
        name: nginx-test
        resources: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      terminationGracePeriodSeconds: <span class="token number">30</span>
status:
  availableReplicas: <span class="token number">3</span>
  conditions:
  - lastTransitionTime: <span class="token string">"2021-11-03T11:47:58Z"</span>
    lastUpdateTime: <span class="token string">"2021-11-03T11:47:58Z"</span>
    message: Deployment has minimum availability.
    reason: MinimumReplicasAvailable
    status: <span class="token string">"True"</span>
    type: Available
  - lastTransitionTime: <span class="token string">"2021-11-03T12:50:56Z"</span>
    lastUpdateTime: <span class="token string">"2021-11-03T12:57:35Z"</span>
    message: ReplicaSet <span class="token string">"nginx-test-6cc7cd5547"</span> has successfully progressed.
    reason: NewReplicaSetAvailable
    status: <span class="token string">"True"</span>
    type: Progressing
  observedGeneration: <span class="token number">7</span>
  readyReplicas: <span class="token number">3</span>
  replicas: <span class="token number">3</span>
  updatedReplicas: <span class="token number">3</span>

</code></pre> 
<p>kubectl get service nginx-service -o yaml</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get service nginx-service -o yaml</span>
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: <span class="token string">"2021-11-03T11:52:40Z"</span>
  labels:
    run: nginx-test
  name: nginx-service
  namespace: default
  resourceVersion: <span class="token string">"100051"</span>
  selfLink: /api/v1/namespaces/default/services/nginx-service
  uid: b2ec9834-864a-4146-9296-5420ac15451d
spec:
  clusterIP: <span class="token number">10.1</span>.36.134
  externalTrafficPolicy: Cluster
  ports:
  - nodePort: <span class="token number">30191</span>
    port: <span class="token number">80</span>
    protocol: TCP
    targetPort: <span class="token number">80</span>
  selector:
    run: nginx-test
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3__1332"></a>3. 解释资源配置清单</h4> 
<p>kubectl explain deployment.metadata</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain deployment.metadata</span>
KIND:     Deployment
VERSION:  extensions/v1beta1

RESOURCE: metadata <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>

DESCRIPTION:
     Standard object metadata.

     ObjectMeta is metadata that all persisted resources must have, <span class="token function">which</span>
     includes all objects <span class="token function">users</span> must create.

FIELDS:
   annotations	<span class="token operator">&lt;</span>map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>string<span class="token operator">&gt;</span>
     Annotations is an unstructured key value map stored with a resource that
     may be <span class="token builtin class-name">set</span> by external tools to store and retrieve arbitrary metadata. They
     are not queryable and should be preserved when modifying objects. More
     info: http://kubernetes.io/docs/user-guide/annotations
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<p>kubectl explain service.metadata</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain service.metadata</span>
KIND:     Service
VERSION:  v1

RESOURCE: metadata <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>

DESCRIPTION:
     Standard object's metadata. More info:
     https://git.k8s.io/community/contributors/devel/api-conventions.md<span class="token comment">#metadata</span>

     ObjectMeta is metadata that all persisted resources must have, <span class="token function">which</span>
     includes all objects <span class="token function">users</span> must create.

FIELDS:
   annotations	<span class="token operator">&lt;</span>map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>string<span class="token operator">&gt;</span>
     Annotations is an unstructured key value map stored with a resource that
     may be <span class="token builtin class-name">set</span> by external tools to store and retrieve arbitrary metadata. They
     are not queryable and should be preserved when modifying objects. More
     info: http://kubernetes.io/docs/user-guide/annotations
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<h4><a id="4__1383"></a>4. 修改资源配置清单并应用</h4> 
<h5><a id="41__1385"></a>4.1 离线修改</h5> 
<p>修改yaml文件：并用kubectl apply -f xxxx.yaml文件使之生效<br> 注意：当apply不生效时，先使用delete清除资源，再apply创建资源<br> kubectl get service nginx-service -o yaml &gt; nginx-svc.yaml</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get service nginx-service -o yaml &gt; nginx-svc.yaml</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># vim nginx-svc.yaml </span>

apiVersion: v1
kind: Service
metadata:
  creationTimestamp: <span class="token string">"2021-11-03T11:52:40Z"</span>
  labels:
    run: nginx-test
  name: nginx-service
  namespace: default
  resourceVersion: <span class="token string">"100051"</span>
  selfLink: /api/v1/namespaces/default/services/nginx-service
  uid: b2ec9834-864a-4146-9296-5420ac15451d
spec:
  clusterIP: <span class="token number">10.1</span>.36.134
  externalTrafficPolicy: Cluster
  ports:
  - nodePort: <span class="token number">30191</span>
<span class="token comment">#修改port为80</span>
    port: <span class="token number">8080</span>
    protocol: TCP
    targetPort: <span class="token number">80</span>
  selector:
    run: nginx-test
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<p>删除资源<br> kubectl delete -f nginx-svc.yaml</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f nginx-svc.yaml</span>
<span class="token function">service</span> <span class="token string">"nginx-service"</span> deleted
</code></pre> 
<p>新建资源<br> kubectl apply -f nginx-svc.yaml</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f nginx-svc.yaml</span>
service/nginx-service created
</code></pre> 
<p>查看service资源<br> kubectl get svc</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kubernetes      ClusterIP   <span class="token number">10.1</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP          25h
nginx-service   NodePort    <span class="token number">10.1</span>.36.134   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30191/TCP   56s
</code></pre> 
<h5><a id="42__1449"></a>4.2 在线修改</h5> 
<p>直接使用kubectl edit service nginx-service在线编辑配置资源清单并保存退出即时生效（如port: 888）<br> PS：此修改方式不会对yaml文件内容修改<br> kubectl edit service nginx-service</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit service nginx-service</span>
 
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
  ports:
  - nodePort: <span class="token number">30191</span>
<span class="token comment">#修改port为888</span>
    port: <span class="token number">888</span>
    protocol: TCP
    targetPort: <span class="token number">80</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<p>查看service资源<br> kubectl get svc</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
kubernetes      ClusterIP   <span class="token number">10.1</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP         25h
nginx-service   NodePort    <span class="token number">10.1</span>.36.134   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">888</span>:30191/TCP   6m50s
</code></pre> 
<h4><a id="5__1478"></a>5. 删除资源配置清单</h4> 
<h5><a id="51__1480"></a>5.1 陈述式删除</h5> 
<p>kubectl delete service nginx-service</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete service nginx-service</span>
<span class="token function">service</span> <span class="token string">"nginx-service"</span> deleted
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.1</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   25h
</code></pre> 
<h5><a id="52__1492"></a>5.2 声明式删除</h5> 
<p>kubectl delete -f nginx-svc.yaml</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f nginx-svc.yaml </span>
service/nginx-service created
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kubernetes      ClusterIP   <span class="token number">10.1</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP          25h
nginx-service   NodePort    <span class="token number">10.1</span>.36.134   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30191/TCP   1s
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f nginx-svc.yaml </span>
<span class="token function">service</span> <span class="token string">"nginx-service"</span> deleted
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.1</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   25h
</code></pre> 
<hr>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/75564b7fae6d72a5b58d62a07a93d039/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java 多人聊天室</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f2d4c30e0f50e4eaea8f7e66a952540e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基站组网架构</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>