<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>JavaMail邮件发送不成功的那些坑人情况及分析说明 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="JavaMail邮件发送不成功的那些坑人情况及分析说明" />
<meta property="og:description" content="前言 JavaMail的使用本身并不难，网上有不少案例，简单易懂，而且有详细的中文注解。但是由于JavaMail的机制设置不够完善，特别是异常出错时的参考信息太少，给初学者造成了不少麻烦，而我就是其中之一。在此，把我遇到过得那些坑总结出来，以免大家重蹈覆辙，浪费时间。（注：后续还有遇到新的问题，我会持续更新到这里）
一、JavaMail概述 JavaMail是由Sun定义的一套收发电子邮件的API，不同的厂商可以提供自己的实现类。但它并没有包含在JDK中，而是作为JavaEE的一部分。 厂商所提供的JavaMail服务程序可以有选择地实现某些邮件协议，常见的邮件协议包括：
SMTP：简单邮件传输协议，用于发送电子邮件的传输协议；
POP3：用于接收电子邮件的标准协议；
IMAP：互联网消息协议，是POP3的替代协议。
这三种协议都有对应SSL加密传输的协议，分别是SMTPS，POP3S和IMAPS。除JavaMail服务提供程序之外，JavaMail还需要JAF(JavaBeans Activation Framework)来处理不是纯文本的邮件内容，这包括MIME（多用途互联网邮件扩展）、URL页面和文件附件等内容。下图描述了JavaMail的体系结构。
（图片来源：http://blog.csdn.net/t12x3456...）
mail.jar：此JAR文件包含JavaMail API和Sun提供的SMTP、IMAP和POP3服务提供程序；
activation.jar：此JAR文件包含JAF API和Sun的实现。
（有关JavaMail的介绍我只摘要部分，详细介绍请参考：http://blog.csdn.net/zapldy/a...）
二、各种问题及分析说明 后面列举出来的报错信息需要开启Session的debug模式，具体配置方式如下：
Session sendMailSession = Session.getInstance(pro, authenticator); sendMailSession.setDebug(true); 1、后台显示邮件发送成功但未收到邮件 问题现象 使用新浪邮箱发送邮件，尝试两种邮件发送方式，分别是“A@sina .cn发送给A@sina .cn”和“A@sina .cn发送给B@sina .cn”，摘要部分后台打印信息：
250 ok queue id 355937395546 QUIT 221 smtp-5-121.smtpsmail.fmail.xd.sinanode.com Sent message ***@sina.cn successfully.... 使用163邮箱发送邮件，尝试C@126.com发送给A@sina .cn，摘要部分后台打印信息：
250 Mail OK queued as smtp7,C8CowADnDNooqmNYHWsYGw--.30359S3 1482926655 QUIT 221 Bye Sent message ***@sina.cn successfully.... 登录新浪邮箱确认有smtp服务且处于开通状态，也尝试重新开启smtp服务，仍然邮件发送不成功。网上也有不少人反馈用手机客户端无法使用新浪邮箱发送邮件，随后我尝试用foxmail登录新浪邮箱，也出现只能接收邮件而不能发送邮件的情况。
问题分析 基本确定是新浪邮箱问题，至于是smtp服务问题，还是做什么限制就不清楚了。好像平时也没多少人用新浪邮箱发邮件，通过网页登录也是能发邮件的，凑合能用，毕竟是免费邮箱嘛。
这是用JavaMail发送邮件遭遇的第一个问题，案例都是参考别人原封不动拿过来用的，却发了收不到邮件。换了几个参考案例，问题现象相同。我开始怀疑别人给的案例代码问题，毕竟堂堂的新浪邮箱还不至于这么不靠谱。然后，就是基于这样的判断，我就吃了大亏，一直在分析代码和配置方式，也在各大论坛搜“发送邮件成功却收不到邮件”，发现出现问题的不在少数，而且多半给出的建议是检查代码有没有问题，然后提问的人也没了回复下文，这就导致了很大的误导性。这正是因为这个原因，我也白白地耗了好几天时间，直到最后发现原来原因是这么简单...有时别人的解答能够事半功倍，但是这种依赖性还是不靠谱的，有时自己的排错思路更重要。
2、向新浪邮箱发信被退信 问题现象 平时开发测试，不想用私人常用邮箱，于是注册了搜狐邮箱，并尝试向新浪邮箱发送邮件，不过很快搜狐邮箱收到退信（这种情况JavaMail是不会提示判断信息的），退信内容如下：
&lt;A@sina .cn&gt;: host freemx1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/81bdfc298d8c95a9f834ebe5a7946c6a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-01-06T05:28:35+08:00" />
<meta property="article:modified_time" content="2017-01-06T05:28:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">JavaMail邮件发送不成功的那些坑人情况及分析说明</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="article fmt article__content"> 
 <h3>前言</h3> 
 <p>  JavaMail的使用本身并不难，网上有不少案例，简单易懂，而且有详细的中文注解。但是由于JavaMail的机制设置不够完善，特别是异常出错时的参考信息太少，给初学者造成了不少麻烦，而我就是其中之一。在此，把我遇到过得那些坑总结出来，以免大家重蹈覆辙，浪费时间。（注：后续还有遇到新的问题，我会持续更新到这里）</p> 
 <h3>一、JavaMail概述</h3> 
 <p>  JavaMail是由Sun定义的一套收发电子邮件的API，不同的厂商可以提供自己的实现类。但它并没有包含在JDK中，而是作为JavaEE的一部分。 </p> 
 <p>  厂商所提供的JavaMail服务程序可以有选择地实现某些邮件协议，常见的邮件协议包括：</p> 
 <ul><li><p>SMTP：简单邮件传输协议，用于发送电子邮件的传输协议；</p></li><li><p>POP3：用于接收电子邮件的标准协议；</p></li><li><p>IMAP：互联网消息协议，是POP3的替代协议。</p></li></ul> 
 <p>  这三种协议都有对应SSL加密传输的协议，分别是SMTPS，POP3S和IMAPS。除JavaMail服务提供程序之外，JavaMail还需要JAF(JavaBeans Activation Framework)来处理不是纯文本的邮件内容，这包括MIME（多用途互联网邮件扩展）、URL页面和文件附件等内容。下图描述了JavaMail的体系结构。</p> 
 <p><span class="img-wrap"><img src="https://images2.imgbox.com/bd/09/FySXkdfq_o.png" alt="clipboard.png" title="clipboard.png"></span></p> 
 <p>（图片来源：<a href="http://blog.csdn.net/t12x3456/article/details/7636701">http://blog.csdn.net/t12x3456...</a>）</p> 
 <ul><li><p>mail.jar：此JAR文件包含JavaMail API和Sun提供的SMTP、IMAP和POP3服务提供程序；</p></li><li><p>activation.jar：此JAR文件包含JAF API和Sun的实现。</p></li></ul> 
 <p>（有关JavaMail的介绍我只摘要部分，详细介绍请参考：<a href="http://blog.csdn.net/zapldy/article/details/3971579">http://blog.csdn.net/zapldy/a...</a>）</p> 
 <h3>二、各种问题及分析说明</h3> 
 <p>  后面列举出来的报错信息需要开启Session的debug模式，具体配置方式如下：</p> 
 <pre><code>Session sendMailSession = Session.getInstance(pro, authenticator);
sendMailSession.setDebug(true);
</code></pre> 
 <h4>1、后台显示邮件发送成功但未收到邮件</h4> 
 <h5>问题现象</h5> 
 <p>  使用新浪邮箱发送邮件，尝试两种邮件发送方式，分别是“A<a href="/u/gzg" rel="nofollow">@sina</a> .cn发送给A<a href="/u/gzg" rel="nofollow">@sina</a> .cn”和“A<a href="/u/gzg" rel="nofollow">@sina</a> .cn发送给B<a href="/u/gzg" rel="nofollow">@sina</a> .cn”，摘要部分后台打印信息：</p> 
 <pre><code>250 ok queue id 355937395546
QUIT
221 smtp-5-121.smtpsmail.fmail.xd.sinanode.com
Sent message ***@sina.cn successfully....
</code></pre> 
 <p>  使用163邮箱发送邮件，尝试C@126.com发送给A<a href="/u/gzg" rel="nofollow">@sina</a> .cn，摘要部分后台打印信息：</p> 
 <pre><code>250 Mail OK queued as smtp7,C8CowADnDNooqmNYHWsYGw--.30359S3 1482926655
QUIT
221 Bye
Sent message ***@sina.cn successfully....
</code></pre> 
 <p>  登录新浪邮箱确认有smtp服务且处于开通状态，也尝试重新开启smtp服务，仍然邮件发送不成功。网上也有不少人反馈用手机客户端无法使用新浪邮箱发送邮件，随后我尝试用foxmail登录新浪邮箱，也出现只能接收邮件而不能发送邮件的情况。</p> 
 <h5>问题分析</h5> 
 <p>  基本确定是新浪邮箱问题，至于是smtp服务问题，还是做什么限制就不清楚了。好像平时也没多少人用新浪邮箱发邮件，通过网页登录也是能发邮件的，凑合能用，毕竟是免费邮箱嘛。</p> 
 <p>  这是用JavaMail发送邮件遭遇的第一个问题，案例都是参考别人原封不动拿过来用的，却发了收不到邮件。<code>换了几个参考案例，问题现象相同。我开始怀疑别人给的案例代码问题，毕竟堂堂的新浪邮箱还不至于这么不靠谱。然后，就是基于这样的判断，我就吃了大亏</code>，一直在分析代码和配置方式，也在各大论坛搜“发送邮件成功却收不到邮件”，发现出现问题的不在少数，而且多半给出的建议是检查代码有没有问题，然后提问的人也没了回复下文，这就导致了很大的误导性。这正是因为这个原因，我也白白地耗了好几天时间，直到最后发现原来原因是这么简单...<code>有时别人的解答能够事半功倍，但是这种依赖性还是不靠谱的，有时自己的排错思路更重要</code>。</p> 
 <h4>2、向新浪邮箱发信被退信</h4> 
 <h5>问题现象</h5> 
 <p>  平时开发测试，不想用私人常用邮箱，于是注册了搜狐邮箱，并尝试向新浪邮箱发送邮件，不过很快搜狐邮箱收到退信（这种情况JavaMail是不会提示判断信息的），退信内容如下：</p> 
 <blockquote> 
  <p>&lt;A<a href="/u/gzg" rel="nofollow">@sina</a> .cn&gt;: host freemx1.sinamail.sina.com.cn[202.108.35.47] said:<br>554 Rejected due to the sending MTA's poor reputation. Please refer<br><a href="http://mail.sina.com.cn/help2/rwmail.html." rel="nofollow">http://mail.sina.com.cn/help2...</a> Please refer to<br><a href="http://chengxin.mail.sina.com.cn/info/qa.php?p=ca1-554" rel="nofollow">http://chengxin.mail.sina.com...</a> 123.125.123.1<br>(in reply to DATA command)</p> 
 </blockquote> 
 <h5>问题分析</h5> 
 <p>  通过访问退信信息里面的链接（<a href="http://chengxin.mail.sina.com.cn/info/qa.php?p=ca1-554" rel="nofollow">新浪邮箱诚信平台</a>），基本确定搜狐邮箱服务器被拉黑了。当然，不是被新浪拉黑，而是进了RBL黑名单，新浪参考其数据进行了屏蔽。这个已经超出了个人能力范围，果断放弃新浪邮箱，改向其他邮箱发送。</p> 
 <p>【RBL黑名单】</p> 
 <blockquote> 
  <p>RBL是英文Realtime Blackhole<br>List的缩写，即实时黑名单列表。在该列表中的IP地址对外发布过垃圾邮件。是由第三方的反垃圾邮件组织提供的检查垃圾邮件发送者地址的服务。</p> 
 </blockquote> 
 <p>【查询网站】</p> 
 <blockquote> 
  <p>MXToolBox：<a href="http://mxtoolbox.com/" rel="nofollow">http://mxtoolbox.com/</a> <br>BlackListAlert：<a href="http://www.blacklistalert.org/" rel="nofollow">http://www.blacklistalert.org/</a></p> 
 </blockquote> 
 <h4>3、向163邮箱发信未收到且也无未退信</h4> 
 <h5>问题现象</h5> 
 <p>  通过搜狐邮箱向新浪邮箱发信遭遇退信后，我尝试自己发给自己，正常收到邮件。考虑模拟测试要尽量真实，我改向163邮箱发信，结果出现后台显示发信成功，163邮箱却没收到邮件，但本地邮箱并没收到退信通知。</p> 
 <h5>问题分析</h5> 
 <p>  这说明“<code>后台显示邮件发送成功但未收到邮件</code>”的情况，原因还是多种多样的，不仅可能发件服务器有问题，还可能是收件服务器的问题。收件服务器有的给你退信，有的还收了直接丢弃，真是什么奇葩情况都有，多加注意吧。</p> 
 <h4>4、jar包重叠存在javax.mail.*</h4> 
 <h5>问题现象</h5> 
 <p>  从Oracle官网下载下来JavaMail相关jar包是mail.jar，导入进去测试后报各种奇葩错误。下面的异常信息是在项目中已有geronimo-javamail_1.4_spec-1.3.jar的情况下导入mail.jar后报出来的：</p> 
 <pre><code>com.sun.mail.smtp.SMTPSendFailedException: 530 Authentication required
 at com.sun.mail.smtp.SMTPTransport.issueSendCommand(SMTPTransport.java:1388)
 at com.sun.mail.smtp.SMTPTransport.mailFrom(SMTPTransport.java:959)
 at com.sun.mail.smtp.SMTPTransport.sendMessage(SMTPTransport.java:583)
</code></pre> 
 <p>  不仔细看还以为是账号或密码填错了，其实只要把geronimo-javamail_1.4_spec-1.3.jar剔除，重新发邮件就正常了。</p> 
 <h5>问题分析</h5> 
 <p>  上面只是我贴出来的报错情况之一，这些报错是不一定能够复现，因为导包就存在问题，重叠存在javax.mail.*。我是在出现第一个问题（“<code>后台显示邮件发送成功但未收到邮件</code>”）的时候，在网上看到别人说的这种情况（<a href="http://download.csdn.net/detail/navy_ji/2689975">javaMail发送邮件成功却收不到邮件或收到邮件无主题无收件人乱码</a>），而后我就开始逐个排查定位，目前通过我所知道的情况来看，重叠存在javax.mail.*的jar有mail.jar、geronimo-javamail_1.4_spec-1.x.jar、mailapi.jar和javaee.jar。<br>  排查的方法也很简单，比如打开javax.mail.Session，然后定位它所在的jar，剔除后再找下一个jar包。</p> 
 <h4>5、jar包正确的情况下也出现报错</h4> 
 <h5>问题现象</h5> 
 <p>  在jar包正常且配置正确的情况下，我也遇到过不少报错情况。出现的情况基本是前几次发邮件都正常，然后再发一次又突然出现报错，再试一次问题又不复现，贴出几种报错信息如下： </p> 
 <p>（报错1）</p> 
 <pre><code>DEBUG SMTP: Sending failed because of invalid destination addresses
RSET
DEBUG SMTP: MessagingException while sending, THROW: 
javax.mail.SendFailedException: Invalid Addresses;
  nested exception is:
    com.sun.mail.smtp.SMTPAddressFailedException: 554 5.7.1 &lt;*@163.com&gt;: Relay access denied
    at com.sun.mail.smtp.SMTPTransport.rcptTo(SMTPTransport.java:1862)
    at com.sun.mail.smtp.SMTPTransport.sendMessage(SMTPTransport.java:1118)</code></pre> 
 <p>（报错2）</p> 
 <pre><code>Exception in thread "main" java.lang.RuntimeException: javax.mail.MessagingException: Could not convert socket to TLS;
  nested exception is:
    javax.net.ssl.SSLHandshakeException: sun.security.validator.ValidatorException: PKIX path validation failed: java.security.cert.CertPathValidatorException: timestamp check failed</code></pre> 
 <p>（报错3）</p> 
 <pre><code>javax.mail.SendFailedException: Send failure (javax.mail.MessagingException: Could not connect to SMTP host: smtp.sohu.com, port: 25 (java.net.ConnectException: Connection timed out: connect))
    at javax.mail.Transport.send(Transport.java:163)
    at javax.mail.Transport.send(Transport.java:48)
    at javamail.EmailSender.sendMail(EmailSender.java:91)
    at javamail.EmailSender.main(EmailSender.java:64)</code></pre> 
 <p>（报错4）</p> 
 <pre><code>250-zw_71_47
250-AUTH PLAIN LOGIN
250 STARTTLS
DEBUG SMTP: Found extension "AUTH", arg "PLAIN LOGIN"
DEBUG SMTP: Found extension "STARTTLS", arg ""
DEBUG SMTP: Attempt to authenticate using mechanisms: LOGIN PLAIN DIGEST-MD5 NTLM 
DEBUG SMTP: AUTH LOGIN command trace suppressed
</code></pre> 
 <h5>问题分析</h5> 
 <p>  因为这些报错不具有可复现性，测试过程中我也司空见惯，当然90%以上的情况邮件发送都是正常，代码方面也是综合了多个案例提炼出来的，而且代码大同小异，也看过官方提供的样例，配置内容都差不多，代码问题可能性较小，也不排除smtp服务器抽风了，目前我暂时忽略。 <br>  当然，如果有分析出是代码问题，也欢迎留言告知分享。（注：后面文章我会将我的代码粘贴出来共享）</p> 
 <h4>6、发信成功后，回应的信息不同</h4> 
 <h5>问题现象</h5> 
 <p>  我将JavaMail代码在外网测试邮件发送成功时，后台打印信息结尾内容基本如下：</p> 
 <pre><code>250 Mail OK queued as smtp7,C8CowADnDNooqmNYHWsYGw--.30359S3 1482926655
QUIT
221 Bye</code></pre> 
 <p>  当我将JavaMail代码移植到内部环境测试邮件发送成功时，后台打印信息结尾内容如下：</p> 
 <pre><code>250 Message accepted for delivery
QUIT
221 srv201.mail.*.* SMTP Service closing transmission channel
</code></pre> 
 <h5>问题分析</h5> 
 <p>  通过上网查询资料得知，250和221这样的编码实际是smtp交互的消息编码，其中221代表邮件会话即将结束，这意味着所有消息都已被处理。编码后面的信息“srv201.mail.<em>.</em> SMTP Service closing transmission channel”和“Bye”的意思类似，可以忽略具体内容，知道221代表邮件发送正常即可。</p> 
 <h3>三、附录</h3> 
 <p>1、<a href="http://blog.csdn.net/chenfei_5201213/article/details/10138969">SMTP错误码及建议解决方法</a><br>2、<a href="http://www.serversmtp.com/en/smtp-error" rel="nofollow">SMTP errors and reply codes</a><br>3、<a href="http://download.csdn.net/detail/navy_ji/2689975">javaMail发送邮件成功却收不到邮件或收到邮件无主题无收件人乱码</a><br>4、<a href="http://chengxin.mail.sina.com.cn/info/qa.php?p=ca1-554" rel="nofollow">新浪邮箱诚信平台</a></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8602ad6300cee75a0cfa190e1d423eb9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Data REST入门（一）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d5d06d4209a7559e8add8d7185811287/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LaTex 加粗（加黑）的方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>