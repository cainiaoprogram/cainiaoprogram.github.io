<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32&#43;雷龙SD NAND(贴片SD卡)完成FATFS文件系统移植与测试 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32&#43;雷龙SD NAND(贴片SD卡)完成FATFS文件系统移植与测试" />
<meta property="og:description" content="一、前言 在STM32项目开发中，经常会用到存储芯片存储数据。 比如：关机时保存机器运行过程中的状态数据，上电再从存储芯片里读取数据恢复；在存储芯片里也会存放很多资源文件。比如，开机音乐，界面上的菜单图标，字库文件，方便设备开机加载。
为了让单片机更加方便的读写这些资源文件，通常都会加文件系统，如果没有文件系统，直接读取写扇区的方式，对数据不好管理。 这篇文章就手把手教大家，在STM32上完成FATFS文件系统的移植；主控芯片采用STM32F103ZET6， 存储芯片我这里采用（雷龙） CS创世 SD NAND 。 SD NAND 简单来说就是贴片式SD卡，使用起来与普通的SD卡一样，简单的区别就是：比TF卡稳定，比eMMC便宜。 下面章节里会详细介绍下 CS创世 SD NAND。
下面是CS创世 SD NAND 与STM32开发的板的接线实物图：
这是读写扇区测试的结果：
二、SD NAND 介绍 我当前使用的SD NAND型号是，CSNP32GCR01-AOW，容量是4GB。
下面是通过编写STM32代码读取的存储信息：
Card Type:SDHC V2.0 Card ManufacturerID:102 Card RCA:5000 Card Capacity:3696 MB Card BlockSize:512 芯片的详细参数如下：
【1】不用写驱动程序自带坏块管理 【2】尺寸小巧，简单易用，兼容性强，稳定可靠，固件可定制，LGA-8封装 【3】标准SDIO接口，兼容SPI，兼容拔插式TF卡/SD卡，可替代普通TF卡/SD卡 【4】尺寸6.2x8mm，直接贴片，不占空间 【5】内置平均读写算法，通过1万次随机掉电测试 【6】耐高低温，机贴手贴都非常方便 【7】速度级别Class10（读取速度23.5MB/S写入速度12.3MB/S） 【8】支持标准的SD 2.0协议，用户可以直接移植标准驱动代码，省去了驱动代码编程环节。支持TF卡启动的SOC都可以用SD NAND 【9】比TF卡稳定，比eMMC便宜 **下面是芯片的实物图： ** 这是官网申请的样品，焊接了转接板，可以直接插在SD卡卡槽上测试。 最终选型之后，设计PCB板时，设计接口，直接贴片上去使用，非常稳定，抖动也不会导致，外置卡TF卡这种容易松动的问题。
这是雷龙的官网： http://www.longsto.com/product/35.html
三、编写SD NAND驱动代码 SD NAND 的驱动代码与正常的SD卡协议是一样的，支持标准的SD 2.0协议，下面我就直接贴出写好的驱动代码。
包括了模拟SPI，硬件SPI，SDIO等3种方式，完成对SD NAND 的读写。我当前使用的主控板子是STM32F103ZET6，如果你使用的板子不是这一款，可能还是其他的CPU也没关系；我这里直接贴出了SPI模拟时序的驱动代码，可以直接移植到任何单片机上使用，代码拷贝过去也只需要修改GPIO口即可，非常方便。
3.1 SPI模拟时序驱动方式 （1）整体工程代码 这是当前工程的截图: 代码采用寄存器风格编写，非常简洁。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4c0d143576f205841f1575510fc673c0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-06T23:10:06+08:00" />
<meta property="article:modified_time" content="2022-12-06T23:10:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32&#43;雷龙SD NAND(贴片SD卡)完成FATFS文件系统移植与测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一、前言</h3> 
<p>在STM32项目开发中，经常会用到存储芯片存储数据。 比如：关机时保存机器运行过程中的状态数据，上电再从存储芯片里读取数据恢复；在存储芯片里也会存放很多资源文件。比如，开机音乐，界面上的菜单图标，字库文件，方便设备开机加载。</p> 
<p>为了让单片机更加方便的读写这些资源文件，通常都会加文件系统，如果没有文件系统，直接读取写扇区的方式，对数据不好管理。 这篇文章就手把手教大家，在STM32上完成FATFS文件系统的移植；主控芯片采用STM32F103ZET6， 存储芯片我这里采用（雷龙） CS创世 SD NAND 。 SD NAND 简单来说就是贴片式SD卡，使用起来与普通的SD卡一样，简单的区别就是：比TF卡稳定，比eMMC便宜。 下面章节里会详细介绍下 CS创世 SD NAND。</p> 
<p><strong>下面是CS创世 SD NAND 与STM32开发的板的接线实物图：</strong></p> 
<p><img src="https://images2.imgbox.com/ea/3a/ZUvpPdo8_o.png" alt="image-20221206191450735"></p> 
<p><img src="https://images2.imgbox.com/d3/05/UD2Jum3M_o.png" alt="image-20221206191527228"></p> 
<p><strong>这是读写扇区测试的结果：</strong></p> 
<p><img src="https://images2.imgbox.com/18/75/lRu5L0ZO_o.png" alt="image-20221206193549509"></p> 
<h3><a id="SD_NAND__22"></a>二、SD NAND 介绍</h3> 
<p>我当前使用的SD NAND型号是，CSNP32GCR01-AOW，容量是4GB。</p> 
<p><img src="https://images2.imgbox.com/96/d6/WkYndYUa_o.png" alt="image-20221201164524580"></p> 
<p><strong>下面是通过编写STM32代码读取的存储信息：</strong></p> 
<pre><code class="prism language-cpp">Card Type<span class="token operator">:</span>SDHC V2<span class="token punctuation">.</span><span class="token number">0</span>
Card ManufacturerID<span class="token operator">:</span><span class="token number">102</span>
Card RCA<span class="token operator">:</span><span class="token number">5000</span>
Card Capacity<span class="token operator">:</span><span class="token number">3696</span> MB
Card BlockSize<span class="token operator">:</span><span class="token number">512</span>
</code></pre> 
<p><strong>芯片的详细参数如下：</strong></p> 
<pre><code class="prism language-cpp">【<span class="token number">1</span>】不用写驱动程序自带坏块管理
【<span class="token number">2</span>】尺寸小巧，简单易用，兼容性强，稳定可靠，固件可定制，LGA<span class="token operator">-</span><span class="token number">8</span>封装
【<span class="token number">3</span>】标准SDIO接口，兼容SPI，兼容拔插式TF卡<span class="token operator">/</span>SD卡，可替代普通TF卡<span class="token operator">/</span>SD卡
【<span class="token number">4</span>】尺寸<span class="token number">6.2</span>x8mm，直接贴片，不占空间
【<span class="token number">5</span>】内置平均读写算法，通过<span class="token number">1</span>万次随机掉电测试
【<span class="token number">6</span>】耐高低温，机贴手贴都非常方便
【<span class="token number">7</span>】速度级别Class10（读取速度<span class="token number">23.5</span>MB<span class="token operator">/</span>S写入速度<span class="token number">12.3</span>MB<span class="token operator">/</span>S）
【<span class="token number">8</span>】支持标准的SD <span class="token number">2.0</span>协议，用户可以直接移植标准驱动代码，省去了驱动代码编程环节。支持TF卡启动的SOC都可以用SD NAND
【<span class="token number">9</span>】比TF卡稳定，比eMMC便宜
</code></pre> 
<p>**下面是芯片的实物图： ** 这是官网申请的样品，焊接了转接板，可以直接插在SD卡卡槽上测试。 最终选型之后，设计PCB板时，设计接口，直接贴片上去使用，非常稳定，抖动也不会导致，外置卡TF卡这种容易松动的问题。</p> 
<p><strong>这是雷龙的官网：</strong> http://www.longsto.com/product/35.html</p> 
<p><img src="https://images2.imgbox.com/85/d7/bfDcPsBp_o.png" alt="image-20221201170132109"></p> 
<p><img src="https://images2.imgbox.com/07/6c/KOOHTIVA_o.png" alt="image-20221201163718601"></p> 
<p><img src="https://images2.imgbox.com/db/7c/OwuV1ZJq_o.png" alt="image-20221201163735081"></p> 
<p><img src="https://images2.imgbox.com/65/65/U0VGrEOa_o.png" alt="image-20221201163748859"></p> 
<h3><a id="SD_NAND_68"></a>三、编写SD NAND驱动代码</h3> 
<p>SD NAND 的驱动代码与正常的SD卡协议是一样的，支持标准的SD 2.0协议，下面我就直接贴出写好的驱动代码。</p> 
<p>包括了模拟SPI，硬件SPI，SDIO等3种方式，完成对SD NAND 的读写。我当前使用的主控板子是STM32F103ZET6，如果你使用的板子不是这一款，可能还是其他的CPU也没关系；我这里直接贴出了SPI模拟时序的驱动代码，可以直接移植到任何单片机上使用，代码拷贝过去也只需要修改GPIO口即可，非常方便。</p> 
<h4><a id="31_SPI_76"></a>3.1 SPI模拟时序驱动方式</h4> 
<h5><a id="1_78"></a>（1）整体工程代码</h5> 
<p><strong>这是当前工程的截图:</strong> 代码采用寄存器风格编写，非常简洁。</p> 
<p>当前工程完成SD NAND卡初始化，扇区的读写，测试芯片基本的使用情况。</p> 
<p><img src="https://images2.imgbox.com/2b/45/xYajYSM5_o.png" alt="image-20221201181308223"></p> 
<h5><a id="2_sdc_88"></a>（2） sd.c</h5> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sdcard.h"</span>			   </span>
<span class="token keyword">static</span> u8  SD_Type<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//存放SD卡的类型</span>

<span class="token comment">/*
函数功能：SD卡底层接口,通过SPI时序向SD卡读写一个字节
函数参数：data是要写入的数据
返 回 值：读到的数据
*/</span>
u8 <span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>u8 DataTx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		 
    u8 i<span class="token punctuation">;</span>
    u8 data<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        SDCARD_SCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>DataTx<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span>SDCARD_MOSI<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> SDCARD_MOSI<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        SDCARD_SCK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        DataTx<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
        
        data<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>SDCARD_MISO<span class="token punctuation">)</span>data<span class="token operator">|=</span><span class="token number">0x01</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//4种: 边沿两种、电平是两种</span>
<span class="token comment">/*
函数功能：底层SD卡接口初始化

本程序SPI接口如下：
PC11  片选 SDCardCS
PC12  时钟 SDCardSCLK
PD2   输出 SPI_MOSI--主机输出从机输入
PC8   输入 SPI_MISO--主机输入从机输出
*/</span>
<span class="token keyword">void</span> <span class="token function">SDCardSpiInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/*1. 开启时钟*/</span>
 	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>		    <span class="token comment">//使能PORTD时钟</span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>		    <span class="token comment">//使能PORTC时钟</span>
  
  <span class="token comment">/*2. 配置GPIO口模式*/</span>
  GPIOC<span class="token operator">-&gt;</span>CRH<span class="token operator">&amp;=</span><span class="token number">0xFFF00FF0</span><span class="token punctuation">;</span>
  GPIOC<span class="token operator">-&gt;</span>CRH<span class="token operator">|=</span><span class="token number">0x00033008</span><span class="token punctuation">;</span>
  
  GPIOD<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token number">0xFFFFF0FF</span><span class="token punctuation">;</span>
  GPIOD<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">0x00000300</span><span class="token punctuation">;</span>
  
  <span class="token comment">/*3. 上拉*/</span>
  GPIOC<span class="token operator">-&gt;</span>ODR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>
  GPIOC<span class="token operator">-&gt;</span>ODR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">;</span>
  GPIOC<span class="token operator">-&gt;</span>ODR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">;</span>
  GPIOD<span class="token operator">-&gt;</span>ODR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
函数功能：取消选择,释放SPI总线
*/</span>
<span class="token keyword">void</span> <span class="token function">SDCardCancelCS</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SDCARD_CS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
 	<span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提供额外的8个时钟</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
函数 功 能：选择sd卡,并且等待卡准备OK
函数返回值：0,成功;1,失败;
*/</span>
<span class="token keyword">void</span> <span class="token function">SDCardSelectCS</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SDCARD_CS<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDCardWaitBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待成功</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数 功 能：等待卡准备好
函数返回值：0,准备好了;其他,错误代码
*/</span>
<span class="token keyword">void</span> <span class="token function">SDCardWaitBusy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0XFF</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0XFF</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能：等待SD卡回应
函数参数：
					Response:要得到的回应值
返 回 值：
					0,成功得到了该回应值
					其他,得到回应值失败
*/</span>
u8 <span class="token function">SDCardGetAck</span><span class="token punctuation">(</span>u8 Response<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u16 Count<span class="token operator">=</span><span class="token number">0xFFFF</span><span class="token punctuation">;</span><span class="token comment">//等待次数	   						  </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0XFF</span><span class="token punctuation">)</span><span class="token operator">!=</span>Response<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>Count<span class="token punctuation">)</span>Count<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//等待得到准确的回应  	  </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Count<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SDCard_RESPONSE_FAILURE<span class="token punctuation">;</span><span class="token comment">//得到回应失败   </span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> SDCard_RESPONSE_NO_ERROR<span class="token punctuation">;</span><span class="token comment">//正确回应</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能：从sd卡读取一个数据包的内容
函数参数：
				buf:数据缓存区
				len:要读取的数据长度.
返回值：
			0,成功;其他,失败;	
*/</span>
u8 <span class="token function">SDCardRecvData</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u16 len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>			  	  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SDCardGetAck</span><span class="token punctuation">(</span><span class="token number">0xFE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//等待SD卡发回数据起始令牌0xFE</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>len<span class="token operator">--</span><span class="token punctuation">)</span><span class="token comment">//开始接收数据</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>buf<span class="token operator">=</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//下面是2个伪CRC（dummy CRC）</span>
    <span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>									  					    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//读取成功</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能：向sd卡写入一个数据包的内容 512字节
函数参数：
					buf 数据缓存区
					cmd 指令
返 回 值：0表示成功;其他值表示失败;
*/</span>
u8 <span class="token function">SDCardSendData</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u8 cmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	u16 t<span class="token punctuation">;</span>		  	  
	<span class="token function">SDCardWaitBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//等待忙状态</span>
	<span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>cmd<span class="token operator">!=</span><span class="token number">0XFD</span><span class="token punctuation">)</span><span class="token comment">//不是结束指令</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span><span class="token number">512</span><span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提高速度,减少函数传参时间</span>
	    <span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//忽略crc</span>
	    <span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		  t<span class="token operator">=</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//接收响应</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token operator">&amp;</span><span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token comment">//响应错误									  					    </span>
	<span class="token punctuation">}</span>						 									  					    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//写入成功</span>
<span class="token punctuation">}</span>



<span class="token comment">/*
函数功能：向SD卡发送一个命令
函数参数：
				u8 cmd   命令 
				u32 arg  命令参数
				u8 crc   crc校验值	
返回值:SD卡返回的响应
*/</span>												  
u8 <span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>u8 cmd<span class="token punctuation">,</span> u32 arg<span class="token punctuation">,</span> u8 crc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 r1<span class="token punctuation">;</span>	
	<span class="token function">SDCardCancelCS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//取消上次片选</span>
	<span class="token function">SDCardSelectCS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//选中SD卡</span>
	<span class="token comment">//发送数据</span>
	<span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>cmd <span class="token operator">|</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//分别写入命令</span>
	<span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>arg <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>arg <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>arg <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>	  
	<span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>crc<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>cmd<span class="token operator">==</span>SDCard_CMD12<span class="token punctuation">)</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Skip a stuff byte when stop reading</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		r1<span class="token operator">=</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>r1<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  <span class="token comment">//等待响应，或超时退出</span>
   <span class="token keyword">return</span> r1<span class="token punctuation">;</span>	<span class="token comment">//返回状态值</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能：获取SD卡的CID信息，包括制造商信息
函数参数：u8 *cid_data(存放CID的内存，至少16Byte）	  
返 回 值：
					0：成功，1：错误				
*/</span>
u8 <span class="token function">GetSDCardCISDCardOutnfo</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>cid_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 r1<span class="token punctuation">;</span>	   
    <span class="token comment">//发SDCard_CMD10命令，读CID</span>
    r1<span class="token operator">=</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD10<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token operator">==</span><span class="token number">0x00</span><span class="token punctuation">)</span>
	  <span class="token punctuation">{<!-- --></span>
			r1<span class="token operator">=</span><span class="token function">SDCardRecvData</span><span class="token punctuation">(</span>cid_data<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收16个字节的数据	 </span>
    <span class="token punctuation">}</span>
	<span class="token function">SDCardCancelCS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取消片选</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>	


<span class="token comment">/*
函数说明：
					获取SD卡的CSD信息，包括容量和速度信息
函数参数：
					u8 *cid_data(存放CID的内存，至少16Byte）	    
返 回 值：
					0：成功，1：错误	
*/</span>
u8 <span class="token function">GetSDCardCSSDCardOutnfo</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>csd_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 r1<span class="token punctuation">;</span>	 
	r1<span class="token operator">=</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD9<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//发SDCard_CMD9命令，读CSD</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		r1<span class="token operator">=</span><span class="token function">SDCardRecvData</span><span class="token punctuation">(</span>csd_data<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收16个字节的数据 </span>
	<span class="token punctuation">}</span>
	<span class="token function">SDCardCancelCS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取消片选</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  


<span class="token comment">/*
函数功能：获取SD卡的总扇区数（扇区数）   
返 回 值：
				0表示容量检测出错，其他值表示SD卡的容量(扇区数/512字节)
说   明：
				每扇区的字节数必为512字节，如果不是512字节，则初始化不能通过.	
*/</span>
u32 <span class="token function">GetSDCardSectorCount</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 csd<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32 Capacity<span class="token punctuation">;</span>  
	  u16 csize<span class="token punctuation">;</span>  					    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">GetSDCardCSSDCardOutnfo</span><span class="token punctuation">(</span>csd<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//取CSD信息，如果期间出错，返回0</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>csd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xC0</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0x40</span><span class="token punctuation">)</span>  <span class="token comment">//SDHC卡，按照下面方式计算</span>
    <span class="token punctuation">{<!-- --></span>	
			csize <span class="token operator">=</span> csd<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>csd<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
			Capacity <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span>csize <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//得到扇区数	 		   </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Capacity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能： 初始化SD卡
返 回 值： 非0表示初始化失败!
*/</span>
u8 <span class="token function">SDCardDeviceInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  u8 r1<span class="token punctuation">;</span>      <span class="token comment">// 存放SD卡的返回值</span>
  u8 buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
	u16 i<span class="token punctuation">;</span>
	<span class="token function">SDCardSpiInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化底层IO口</span>
 	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送最少74个脉冲</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		r1<span class="token operator">=</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x95</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进入IDLE状态 闲置</span>
	<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>r1<span class="token operator">!=</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
 	SD_Type<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//默认无卡</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token operator">==</span><span class="token number">0X01</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD8<span class="token punctuation">,</span><span class="token number">0x1AA</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//SD V2.0</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0XFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0X01</span><span class="token operator">&amp;&amp;</span>buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0XAA</span><span class="token punctuation">)</span>    <span class="token comment">//卡是否支持2.7~3.6V</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">do</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD55<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    <span class="token comment">//发送SDCard_CMD55</span>
					r1<span class="token operator">=</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD41<span class="token punctuation">,</span><span class="token number">0x40000000</span><span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送SDCard_CMD41</span>
				<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD58<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//鉴别SD2.0卡版本开始</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span><span class="token number">0XFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到OCR值</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x40</span><span class="token punctuation">)</span>SD_Type<span class="token operator">=</span>SDCard_TYPE_V2HC<span class="token punctuation">;</span>    <span class="token comment">//检查CCS</span>
					<span class="token keyword">else</span> SD_Type<span class="token operator">=</span>SDCard_TYPE_V2<span class="token punctuation">;</span>   
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SD_Type=0x%X\r\n"</span><span class="token punctuation">,</span>SD_Type<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDCardCancelCS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//取消片选</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SD_Type<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//初始化成功返回0</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token keyword">return</span> r1<span class="token punctuation">;</span> <span class="token comment">//返回值错误值	   </span>
	<span class="token keyword">return</span> <span class="token number">0xaa</span><span class="token punctuation">;</span>          <span class="token comment">//其他错误</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能：读SD卡
函数参数：
				buf:数据缓存区
				sector:扇区
				cnt:扇区数
返回值:
				0,ok;其他,失败.
说  明：
				SD卡一个扇区大小512字节
*/</span>
u8 <span class="token function">SDCardReadData</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u32 sector<span class="token punctuation">,</span>u32 cnt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 r1<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SD_Type<span class="token operator">!=</span>SDCard_TYPE_V2HC<span class="token punctuation">)</span>sector<span class="token operator">&lt;&lt;=</span><span class="token number">9</span><span class="token punctuation">;</span><span class="token comment">//转换为字节地址</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		r1<span class="token operator">=</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD17<span class="token punctuation">,</span>sector<span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读命令</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>												  <span class="token comment">//指令发送成功</span>
		<span class="token punctuation">{<!-- --></span>
			r1<span class="token operator">=</span><span class="token function">SDCardRecvData</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//接收512个字节	   </span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		r1<span class="token operator">=</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD18<span class="token punctuation">,</span>sector<span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//连续读命令</span>
		<span class="token keyword">do</span>
		<span class="token punctuation">{<!-- --></span>
			r1<span class="token operator">=</span><span class="token function">SDCardRecvData</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收512个字节	 </span>
			buf<span class="token operator">+=</span><span class="token number">512</span><span class="token punctuation">;</span>  
		<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">--</span>cnt <span class="token operator">&amp;&amp;</span> r1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	
		<span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD12<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送停止命令</span>
	<span class="token punctuation">}</span>   
	<span class="token function">SDCardCancelCS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取消片选</span>
	<span class="token keyword">return</span> r1<span class="token punctuation">;</span><span class="token comment">//</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
函数功能：向SD卡写数据
函数参数：
				buf:数据缓存区
				sector:起始扇区
				cnt:扇区数
返回值：
				0,ok;其他,失败.
说  明：
				SD卡一个扇区大小512字节
*/</span>
u8 <span class="token function">SDCardWriteData</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u32 sector<span class="token punctuation">,</span>u32 cnt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 r1<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SD_Type<span class="token operator">!=</span>SDCard_TYPE_V2HC<span class="token punctuation">)</span>sector <span class="token operator">*=</span> <span class="token number">512</span><span class="token punctuation">;</span><span class="token comment">//转换为字节地址</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		r1<span class="token operator">=</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD24<span class="token punctuation">,</span>sector<span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读命令</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//指令发送成功</span>
		<span class="token punctuation">{<!-- --></span>
			r1<span class="token operator">=</span><span class="token function">SDCardSendData</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0xFE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写512个字节	   </span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>SD_Type<span class="token operator">!=</span>SDCard_TYPE_MMC<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD55<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
			<span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD23<span class="token punctuation">,</span>cnt<span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送指令	</span>
		<span class="token punctuation">}</span>
 		r1<span class="token operator">=</span><span class="token function">SendSDCardCmd</span><span class="token punctuation">(</span>SDCard_CMD25<span class="token punctuation">,</span>sector<span class="token punctuation">,</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//连续读命令</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">do</span>
			<span class="token punctuation">{<!-- --></span>
				r1<span class="token operator">=</span><span class="token function">SDCardSendData</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0xFC</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收512个字节	 </span>
				buf<span class="token operator">+=</span><span class="token number">512</span><span class="token punctuation">;</span>  
			<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">--</span>cnt <span class="token operator">&amp;&amp;</span> r1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			r1<span class="token operator">=</span><span class="token function">SDCardSendData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0xFD</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接收512个字节 </span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>   
	<span class="token function">SDCardCancelCS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取消片选</span>
	<span class="token keyword">return</span> r1<span class="token punctuation">;</span><span class="token comment">//</span>
<span class="token punctuation">}</span>	
</code></pre> 
<h5><a id="3_sdh_468"></a>（3） sd.h</h5> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_H_</span>	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>

<span class="token comment">/*----------------------------------------------
本程序SPI接口如下：
PC11  片选 SDCardCS
PC12  时钟 SDCardSCLK
PD2   输出 SPI_MOSI--主机输出从机输入
PC8   输入 SPI_MISO--主机输入从机输出
------------------------------------------------*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCARD_CS</span> <span class="token expression"><span class="token function">PCout</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCARD_SCK</span> <span class="token expression"><span class="token function">PCout</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCARD_MOSI</span> <span class="token expression"><span class="token function">PDout</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCARD_MISO</span> <span class="token expression"><span class="token function">PCin</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span></span></span>


<span class="token comment">// SD卡类型定义  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_TYPE_ERR</span>     <span class="token expression"><span class="token number">0X00</span>  </span><span class="token comment">//卡类型错误</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_TYPE_MMC</span>     <span class="token expression"><span class="token number">0X01</span>  </span><span class="token comment">//MMC卡</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_TYPE_V1</span>      <span class="token expression"><span class="token number">0X02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_TYPE_V2</span>      <span class="token expression"><span class="token number">0X04</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_TYPE_V2HC</span>    <span class="token expression"><span class="token number">0X06</span>	   </span></span>

<span class="token comment">// SD卡指令表  	   </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD0</span>    <span class="token expression"><span class="token number">0</span>       </span><span class="token comment">//卡复位</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD1</span>    <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD8</span>    <span class="token expression"><span class="token number">8</span>       </span><span class="token comment">//命令8 ，SEND_IF_COND</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD9</span>    <span class="token expression"><span class="token number">9</span>       </span><span class="token comment">//命令9 ，读CSD数据</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD10</span>   <span class="token expression"><span class="token number">10</span>      </span><span class="token comment">//命令10，读CID数据</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD12</span>   <span class="token expression"><span class="token number">12</span>      </span><span class="token comment">//命令12，停止数据传输</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD13</span>   <span class="token expression"><span class="token number">16</span>      </span><span class="token comment">//命令16，设置扇区大小 应返回0x00</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD17</span>   <span class="token expression"><span class="token number">17</span>      </span><span class="token comment">//命令17，读扇区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD18</span>   <span class="token expression"><span class="token number">18</span>      </span><span class="token comment">//命令18，读Multi 扇区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD23</span>   <span class="token expression"><span class="token number">23</span>      </span><span class="token comment">//命令23，设置多扇区写入前预先擦除N个block</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD24</span>   <span class="token expression"><span class="token number">24</span>      </span><span class="token comment">//命令24，写扇区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD25</span>   <span class="token expression"><span class="token number">25</span>      </span><span class="token comment">//命令25，写多个扇区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD41</span>   <span class="token expression"><span class="token number">41</span>      </span><span class="token comment">//命令41，应返回0x00</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD55</span>   <span class="token expression"><span class="token number">55</span>      </span><span class="token comment">//命令55，应返回0x01</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD58</span>   <span class="token expression"><span class="token number">58</span>      </span><span class="token comment">//命令58，读OCR信息</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_CMD59</span>   <span class="token expression"><span class="token number">59</span>      </span><span class="token comment">//命令59，使能/禁止CRC，应返回0x00、</span></span>

<span class="token comment">/*SD卡回应标记字*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_RESPONSE_NO_ERROR</span>      <span class="token expression"><span class="token number">0x00</span>   </span><span class="token comment">//正确回应</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_SD_IN_IDLE_STATE</span>       <span class="token expression"><span class="token number">0x01</span>   </span><span class="token comment">//闲置状态</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_SD_ERASE_RESET</span>         <span class="token expression"><span class="token number">0x02</span>   </span><span class="token comment">//擦除复位</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDCard_RESPONSE_FAILURE</span>       <span class="token expression"><span class="token number">0xFF</span>   </span><span class="token comment">//响应失败</span></span>
  
<span class="token comment">//函数声明              </span>
u8 <span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>u8 data<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//底层接口，SPI读写字节函数</span>
<span class="token keyword">void</span> <span class="token function">SDCardWaitBusy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							           		<span class="token comment">//等待SD卡准备</span>
u8 <span class="token function">SDCardGetAck</span><span class="token punctuation">(</span>u8 Response<span class="token punctuation">)</span><span class="token punctuation">;</span>					       				<span class="token comment">//获得应答</span>
u8 <span class="token function">SDCardDeviceInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							            <span class="token comment">//初始化</span>
u8 <span class="token function">SDCardReadData</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u32 sector<span class="token punctuation">,</span>u32 cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>		    <span class="token comment">//读块(扇区)</span>
u8 <span class="token function">SDCardWriteData</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u32 sector<span class="token punctuation">,</span>u32 cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>		  <span class="token comment">//写块(扇区)</span>
u32 <span class="token function">GetSDCardSectorCount</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   					        <span class="token comment">//读扇区数</span>
u8 <span class="token function">GetSDCardCISDCardOutnfo</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>cid_data<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//读SD卡CID</span>
u8 <span class="token function">GetSDCardCSSDCardOutnfo</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>csd_data<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//读SD卡CSD</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h5><a id="4_534"></a>（4）运行效果</h5> 
<p><img src="https://images2.imgbox.com/ff/d7/wSpFVtou_o.png" alt="image-20221201181738815"></p> 
<h4><a id="32_SPI_540"></a>3.2 SPI硬件时序方式</h4> 
<p>上面的3.1小节是采用SPI模拟时序驱动SD NAND，STM32本身集成有SPI硬件模块，可以直接利用STM32硬件SPI接口读写。</p> 
<p>下面贴出底层的适配代码。 上面贴出的驱动代码里，已经将驱动接口部分和协议逻辑部分区分开了，替换底层的SIP读写代码非常方便。</p> 
<h5><a id="1_546"></a>（1）主要替换的代码</h5> 
<pre><code class="prism language-cpp"><span class="token comment">/*
函数功能：SPI初始化(模拟SPI)
硬件连接：
MISO---&gt;PB14
MOSI---&gt;PB15
SCLK---&gt;PB13
*/</span>
<span class="token keyword">void</span> <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/*开启时钟*/</span>
	RCC<span class="token operator">-&gt;</span>APB1ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">;</span>   <span class="token comment">//开启SPI2时钟</span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>    <span class="token comment">//PB</span>
	GPIOB<span class="token operator">-&gt;</span>CRH<span class="token operator">&amp;=</span><span class="token number">0X000FFFFF</span><span class="token punctuation">;</span> <span class="token comment">//清除寄存器</span>
	GPIOB<span class="token operator">-&gt;</span>CRH<span class="token operator">|=</span><span class="token number">0XB8B00000</span><span class="token punctuation">;</span>
	GPIOB<span class="token operator">-&gt;</span>ODR<span class="token operator">|=</span><span class="token number">0X7</span><span class="token operator">&lt;&lt;</span><span class="token number">13</span><span class="token punctuation">;</span>    	<span class="token comment">//PB13/14/15上拉--输出高电平</span>
	<span class="token comment">/*SPI2基本配置*/</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">=</span><span class="token number">0X0</span><span class="token punctuation">;</span> 		<span class="token comment">//清空寄存器</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">//选择“双线双向”模式</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">;</span> <span class="token comment">//使用8位数据帧格式进行发送/接收；</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">//全双工(发送和接收)；</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span>  <span class="token comment">//启用软件从设备管理</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">//NSS</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">;</span>  <span class="token comment">//帧格式，先发送高位</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0x0</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//当总线频率为36MHZ时，SPI速度为18MHZ，高速。</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">//配置为主设备</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//空闲状态时， SCK保持高电平。</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//数据采样从第二个时钟边沿开始。</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span>  <span class="token comment">//开启SPI设备。</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能：SPI读写一个字节
*/</span>
u8 <span class="token function">SPI_ReadWriteOneByte</span><span class="token punctuation">(</span>u8 data_tx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u16 cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				 
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SPI2<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>		 <span class="token comment">//等待发送区空--等待发送缓冲为空	</span>
    <span class="token punctuation">{<!-- --></span>
      cnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">&gt;=</span><span class="token number">65530</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 	  <span class="token comment">//超时退出  u16=2个字节</span>
    <span class="token punctuation">}</span>	
    SPI2<span class="token operator">-&gt;</span>DR<span class="token operator">=</span>data_tx<span class="token punctuation">;</span>	 	  		      <span class="token comment">//发送一个byte </span>
    cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SPI2<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 		<span class="token comment">//等待接收完一个byte   </span>
    <span class="token punctuation">{<!-- --></span>
      cnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">&gt;=</span><span class="token number">65530</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	   <span class="token comment">//超时退出</span>
    <span class="token punctuation">}</span>	  						    
    <span class="token keyword">return</span> SPI2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>          		<span class="token comment">//返回收到的数据	</span>
<span class="token punctuation">}</span>

函数功能：SD卡底层接口<span class="token punctuation">,</span>通过SPI时序向SD卡读写一个字节
函数参数：data是要写入的数据
返 回 值：读到的数据
<span class="token operator">*</span><span class="token operator">/</span>
u8 <span class="token function">SDCardReadWriteOneByte</span><span class="token punctuation">(</span>u8 DataTx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		 
    <span class="token keyword">return</span> <span class="token function">SPI_ReadWriteOneByte</span><span class="token punctuation">(</span>DataTx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2_611"></a>（2）运行效果</h5> 
<p><img src="https://images2.imgbox.com/45/a2/KJKG53c4_o.png" alt="image-20221201182330399"></p> 
<h4><a id="33_SDIO_617"></a>3.3 SDIO方式</h4> 
<p>如果想提高SD NAND的读写速度，可以采用SDIO协议，STM32本身有SDIO的硬件支持，配置好SDIO的寄存器即可完成SD NAND的操作。 SDIO的数据线都比SPI多，读写速度自然没法比的。</p> 
<p>下面贴出STM32F103ZE上面编写的SDIO协议读写SD NAND的驱动代码。</p> 
<h5><a id="1_623"></a>（1）整体工程代码</h5> 
<p><img src="https://images2.imgbox.com/94/04/itnl1gcS_o.png" alt="image-20221201185519368"></p> 
<h5><a id="2sdioc_627"></a>（2）sdio.c</h5> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sdio_sdcard.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span>	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span>	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span>	 </span>

<span class="token keyword">static</span> u8 CardType<span class="token operator">=</span>SDIO_STD_CAPACITY_SD_CARD_V1_1<span class="token punctuation">;</span>		<span class="token comment">//SD卡类型（默认为1.x卡）</span>
<span class="token keyword">static</span> u32 CSD_Tab<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>CID_Tab<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>RCA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>					      <span class="token comment">//SD卡CSD,CID以及相对地址(RCA)数据</span>
<span class="token keyword">static</span> u8 DeviceMode<span class="token operator">=</span>SD_DMA_MODE<span class="token punctuation">;</span>		   				        <span class="token comment">//工作模式,注意,工作模式必须通过SDIO_SdCardSetDeviceMode,后才算数.这里只是定义一个默认的模式(SD_DMA_MODE)</span>
<span class="token keyword">static</span> u8 StopCondition<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 								            <span class="token comment">//是否发送停止传输标志位,DMA多块读写的时候用到  </span>
<span class="token keyword">volatile</span> SDIO_SD_ERROR_INFO TransferError<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>		  <span class="token comment">//数据传输错误标志,DMA读写时使用	    </span>
<span class="token keyword">volatile</span> u8 TransferEnd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>								            <span class="token comment">//传输结束标志,DMA读写时使用</span>
SD_CardInfo SDCardInfo<span class="token punctuation">;</span>									              <span class="token comment">//SD卡信息</span>

<span class="token comment">//SDIO_SdCardReadDiskSector/SDIO_SdCardWriteDiskSector函数专用buf,当这两个函数的数据缓存区地址不是4字节对齐的时候,</span>
<span class="token comment">//需要用到该数组,确保数据缓存区地址是4字节对齐的.</span>
<span class="token function">__align</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> u8 SDIO_DATA_BUFFER<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>						  
 
 
<span class="token comment">/*
SD卡与开发板的SDIO方式接线关系如下:
		DATA0---PC8
		DATA1---PC9
		DATA2---PC10
		DATA3---PC11
		CLK-----PC1
		CMD-----PD2
*/</span>

<span class="token comment">/*
函数功能:SDIO方式初始化SD卡 
返回值  :错误代码;(0,无错误)
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 clkdiv<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>	   
	<span class="token comment">//SDIO IO口初始化</span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>    	<span class="token comment">//使能PORTC时钟	   	 </span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>    	<span class="token comment">//使能PORTD时钟</span>
  RCC<span class="token operator">-&gt;</span>AHBENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>    	<span class="token comment">//使能SDIO时钟	   	 </span>
 	RCC<span class="token operator">-&gt;</span>AHBENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>    	<span class="token comment">//使能DMA2时钟</span>

	GPIOC<span class="token operator">-&gt;</span>CRH<span class="token operator">&amp;=</span><span class="token number">0XFFF00000</span><span class="token punctuation">;</span> 
	GPIOC<span class="token operator">-&gt;</span>CRH<span class="token operator">|=</span><span class="token number">0X000BBBBB</span><span class="token punctuation">;</span>	<span class="token comment">//PC.8~12 复用输出</span>

	GPIOD<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token number">0XFFFFF0FF</span><span class="token punctuation">;</span> 
	GPIOD<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">0X00000B00</span><span class="token punctuation">;</span>	<span class="token comment">//PD2复用输出,PD7 上拉输入</span>
 	
  <span class="token comment">//SDIO外设寄存器设置为默认值 			   </span>
	SDIO<span class="token operator">-&gt;</span>POWER<span class="token operator">=</span><span class="token number">0x00000000</span><span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">=</span><span class="token number">0x00000000</span><span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>ARG<span class="token operator">=</span><span class="token number">0x00000000</span><span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>CMD<span class="token operator">=</span><span class="token number">0x00000000</span><span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>DTIMER<span class="token operator">=</span><span class="token number">0x00000000</span><span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>DLEN<span class="token operator">=</span><span class="token number">0x00000000</span><span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">=</span><span class="token number">0x00000000</span><span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0x00C007FF</span><span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">=</span><span class="token number">0x00000000</span><span class="token punctuation">;</span>	  
 	<span class="token function">STM32_NVIC_SetPriority</span><span class="token punctuation">(</span>SDIO_IRQn<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//SDIO中断配置</span>
  errorstatus<span class="token operator">=</span><span class="token function">SDIO_SdPowerON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			            <span class="token comment">//SD卡上电</span>
 	<span class="token function">SDIO_SdCardInitializeCards</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			        <span class="token comment">//初始化SD卡														  </span>
  <span class="token function">SDIO_SdCardGetInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SDCardInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>	            <span class="token comment">//获取卡信息</span>
 	<span class="token function">SDIO_SdCardSelectAddr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">(</span>SDCardInfo<span class="token punctuation">.</span>RCA<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//选中SD卡   </span>
  <span class="token function">SDIO_SdCardEnableWideBusOperation</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	            <span class="token comment">//4位宽度,如果是MMC卡,则不能用4位模式 </span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>errorstatus<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_MULTIMEDIA_CARD<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>  		    
    <span class="token keyword">if</span><span class="token punctuation">(</span>SDCardInfo<span class="token punctuation">.</span>CardType<span class="token operator">==</span>SDIO_STD_CAPACITY_SD_CARD_V1_1<span class="token operator">||</span>SDCardInfo<span class="token punctuation">.</span>CardType<span class="token operator">==</span>SDIO_STD_CAPACITY_SD_CARD_V2_0<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      clkdiv<span class="token operator">=</span>SDIO_TRANSFER_CLK_DIV<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">;</span>	  <span class="token comment">//V1.1/V2.0卡，设置最高72/12=6Mhz</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> clkdiv<span class="token operator">=</span>SDIO_TRANSFER_CLK_DIV<span class="token punctuation">;</span>	<span class="token comment">//SDHC等其他卡，设置最高72/6=12Mhz</span>
    <span class="token function">SDIO_ClockSet</span><span class="token punctuation">(</span>clkdiv<span class="token punctuation">)</span><span class="token punctuation">;</span>				      <span class="token comment">//设置时钟频率,SDIO时钟计算公式:SDIO_CK时钟=SDIOCLK/[clkdiv+2];其中,SDIOCLK固定为48Mhz </span>
    errorstatus<span class="token operator">=</span><span class="token function">SDIO_SdCardSetDeviceMode</span><span class="token punctuation">(</span>SD_POLLING_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置为查询模式</span>
  <span class="token punctuation">}</span>
	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>		 
<span class="token punctuation">}</span>

<span class="token comment">/*
函数功能: SDIO时钟初始化设置
函数参数:
        clkdiv:时钟分频系数
        CK时钟=SDIOCLK/[clkdiv+2];(SDIOCLK时钟固定为48Mhz)
*/</span>
<span class="token keyword">void</span> <span class="token function">SDIO_ClockSet</span><span class="token punctuation">(</span>u8 clkdiv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 tmpreg<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token punctuation">;</span> 
  tmpreg<span class="token operator">&amp;=</span><span class="token number">0XFFFFFF00</span><span class="token punctuation">;</span> 
 	tmpreg<span class="token operator">|=</span>clkdiv<span class="token punctuation">;</span>   
	SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">=</span>tmpreg<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 


<span class="token comment">/*
函数功能: SDIO发送命令函数
函数参数:
         cmdindex:命令索引,低六位有效
         waitrsp:期待的相应.00/10,无响应;01,短响应;11,长响应
         arg:参数
*/</span>
<span class="token keyword">void</span> <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>u8 cmdindex<span class="token punctuation">,</span>u8 waitrsp<span class="token punctuation">,</span>u32 arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>			
	u32 tmpreg<span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>ARG<span class="token operator">=</span>arg<span class="token punctuation">;</span>
	tmpreg<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>CMD<span class="token punctuation">;</span> 
	tmpreg<span class="token operator">&amp;=</span><span class="token number">0XFFFFF800</span><span class="token punctuation">;</span>		<span class="token comment">//清除index和waitrsp</span>
	tmpreg<span class="token operator">|=</span>cmdindex<span class="token operator">&amp;</span><span class="token number">0X3F</span><span class="token punctuation">;</span>	<span class="token comment">//设置新的index			 </span>
	tmpreg<span class="token operator">|=</span>waitrsp<span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span>		<span class="token comment">//设置新的wait rsp </span>
	tmpreg<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>			<span class="token comment">//无等待</span>
  tmpreg<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>			<span class="token comment">//命令通道状态机使能</span>
	SDIO<span class="token operator">-&gt;</span>CMD<span class="token operator">=</span>tmpreg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
函数功能: SDIO发送数据配置函数
函数参数:
        datatimeout:超时时间设置
        datalen:传输数据长度,低25位有效,必须为块大小的整数倍
        blksize:块大小.实际大小为:2^blksize字节
        dir:数据传输方向:0,控制器到卡;1,卡到控制器;      
*/</span>
<span class="token keyword">void</span> <span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>u32 datatimeout<span class="token punctuation">,</span>u32 datalen<span class="token punctuation">,</span>u8 blksize<span class="token punctuation">,</span>u8 dir<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 tmpreg<span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>DTIMER<span class="token operator">=</span>datatimeout<span class="token punctuation">;</span>
  	SDIO<span class="token operator">-&gt;</span>DLEN<span class="token operator">=</span>datalen<span class="token operator">&amp;</span><span class="token number">0X1FFFFFF</span><span class="token punctuation">;</span>	<span class="token comment">//低25位有效</span>
	tmpreg<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token punctuation">;</span> 
	tmpreg<span class="token operator">&amp;=</span><span class="token number">0xFFFFFF08</span><span class="token punctuation">;</span>		<span class="token comment">//清除之前的设置.</span>
	tmpreg<span class="token operator">|=</span>blksize<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>		<span class="token comment">//设置块大小</span>
	tmpreg<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>			<span class="token comment">//块数据传输</span>
	tmpreg<span class="token operator">|=</span><span class="token punctuation">(</span>dir<span class="token operator">&amp;</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//方向控制</span>
	tmpreg<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//数据传输使能,DPSM状态机</span>
	SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">=</span>tmpreg<span class="token punctuation">;</span>		
<span class="token punctuation">}</span>  


<span class="token comment">/*
函数功能:卡上电
        查询所有SDIO接口上的卡设备,并查询其电压和配置时钟
返回值:错误代码;(0,无错误)
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdPowerON</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
	u32 response<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>validvoltage<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u32 SDType<span class="token operator">=</span>SD_STD_CAPACITY<span class="token punctuation">;</span>
	<span class="token comment">//配置CLKCR寄存器 </span>
	SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//清空CLKCR之前的设置</span>
	SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span>			<span class="token comment">//非省电模式</span>
	SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>			<span class="token comment">//关闭旁路,CK根据分频设置输出</span>
	SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">;</span>			<span class="token comment">//1位数据宽度</span>
	SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">13</span><span class="token punctuation">;</span>			<span class="token comment">//SDIOCLK上升沿产生SDIOCK</span>
	SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">;</span>			<span class="token comment">//关闭硬件流控制    </span>
	<span class="token function">SDIO_ClockSet</span><span class="token punctuation">(</span>SDIO_INIT_CLK_DIV<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置时钟频率(初始化的时候,不能超过400Khz)			 </span>
 	SDIO<span class="token operator">-&gt;</span>POWER<span class="token operator">=</span><span class="token number">0X03</span><span class="token punctuation">;</span>			<span class="token comment">//上电状态,开启卡时钟    </span>
  SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>			<span class="token comment">//SDIOCK使能   </span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">74</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_GO_IDLE_STATE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送CMD0进入IDLE STAGE模式命令.												  </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdErrorCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
 	<span class="token punctuation">}</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span><span class="token comment">//返回错误状态</span>
	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SDIO_SEND_IF_COND<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>SD_CHECK_PATTERN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送CMD8,短响应,检查SD卡接口特性.</span>
 														<span class="token comment">//arg[11:8]:01,支持电压范围,2.7~3.6V</span>
														<span class="token comment">//arg[7:0]:默认0XAA</span>
														<span class="token comment">//返回响应7</span>
  errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp7Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//等待R7响应</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span> 								<span class="token comment">//R7响应正常</span>
	<span class="token punctuation">{<!-- --></span>
		CardType<span class="token operator">=</span>SDIO_STD_CAPACITY_SD_CARD_V2_0<span class="token punctuation">;</span>		<span class="token comment">//SD 2.0卡</span>
		SDType<span class="token operator">=</span>SD_HIGH_CAPACITY<span class="token punctuation">;</span>			   			      <span class="token comment">//高容量卡</span>
	<span class="token punctuation">}</span>
	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					    <span class="token comment">//发送CMD55,短响应	 </span>
	errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//等待R1响应   </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span><span class="token comment">//SD2.0/SD 1.1</span>
	<span class="token punctuation">{<!-- --></span>																  
		<span class="token comment">//SD卡,发送ACMD41 SD_APP_OP_COND,参数为:0x80100000 </span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>validvoltage<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>count<span class="token operator">&lt;</span>SD_MAX_VOLT_TRIAL<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>	   										   
			<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				      <span class="token comment">//发送CMD55,短响应	 </span>
			errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span> 	 	<span class="token comment">//等待R1响应   </span>
 			<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误</span>
			<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SD_APP_OP_COND<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>SD_VOLTAGE_WINDOW_SD<span class="token operator">|</span>SDType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送ACMD41,短响应	 </span>
			errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp3Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 					        <span class="token comment">//等待R3响应   </span>
 			<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误  </span>
			response<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token punctuation">;</span><span class="token punctuation">;</span>			   				        <span class="token comment">//得到响应</span>
			validvoltage<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>response<span class="token operator">&gt;&gt;</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			  <span class="token comment">//判断SD卡上电是否完成</span>
			count<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">&gt;=</span>SD_MAX_VOLT_TRIAL<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			errorstatus<span class="token operator">=</span>SD_INVALID_VOLTRANGE<span class="token punctuation">;</span>
			<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>	 
		<span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token operator">&amp;=</span>SD_HIGH_CAPACITY<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			CardType<span class="token operator">=</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
 	<span class="token punctuation">}</span>
  <span class="token keyword">return</span><span class="token punctuation">(</span>errorstatus<span class="token punctuation">)</span><span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

<span class="token comment">/*
函数功能: SD卡断电
返回值:错误代码;(0,无错误)
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SD_PowerOFF</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  SDIO<span class="token operator">-&gt;</span>POWER<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SDIO电源关闭,时钟停止	</span>
	<span class="token keyword">return</span> SD_OK<span class="token punctuation">;</span>		  
<span class="token punctuation">}</span> 


<span class="token comment">/*
函数功能:初始化所有的卡,并让卡进入就绪状态
返回值:错误代码
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardInitializeCards</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 	SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
	u16 rca <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>POWER<span class="token operator">&amp;</span><span class="token number">0X03</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_REQUEST_NOT_APPLICABLE<span class="token punctuation">;</span><span class="token comment">//检查电源状态,确保为上电状态</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO_SECURE_DIGITAL_IO_CARD<span class="token operator">!=</span>CardType<span class="token punctuation">)</span>			  <span class="token comment">//非SECURE_DIGITAL_IO_CARD</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_ALL_SEND_CID<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			  <span class="token comment">//发送CMD2,取得CID,长响应	 </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp2Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 					        <span class="token comment">//等待R2响应   </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误		    </span>
 		CID_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token punctuation">;</span>
		CID_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP2<span class="token punctuation">;</span>
		CID_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP3<span class="token punctuation">;</span>
		CID_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP4<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V1_1<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V2_0<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_SECURE_DIGITAL_IO_COMBO_CARD<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//判断卡类型</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SET_REL_ADDR<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//发送CMD3,短响应 </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp6Error</span><span class="token punctuation">(</span>SD_CMD_SET_REL_ADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>rca<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待R6响应 </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误		    </span>
	<span class="token punctuation">}</span>   
  <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO_MULTIMEDIA_CARD<span class="token operator">==</span>CardType<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SET_REL_ADDR<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">(</span>rca<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送CMD3,短响应 	   </span>
    errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp2Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 					<span class="token comment">//等待R2响应   </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误	 </span>
  <span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO_SECURE_DIGITAL_IO_CARD<span class="token operator">!=</span>CardType<span class="token punctuation">)</span>			<span class="token comment">//非SECURE_DIGITAL_IO_CARD</span>
	<span class="token punctuation">{<!-- --></span>
		RCA <span class="token operator">=</span> rca<span class="token punctuation">;</span>
		<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SEND_CSD<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">(</span>rca<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送CMD9+卡RCA,取得CSD,长响应 	   </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp2Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 					<span class="token comment">//等待R2响应   </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误		    </span>
  	CSD_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token punctuation">;</span>
		CSD_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP2<span class="token punctuation">;</span>
		CSD_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP3<span class="token punctuation">;</span>						
		CSD_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP4<span class="token punctuation">;</span>					    
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> SD_OK<span class="token punctuation">;</span><span class="token comment">//卡初始化成功</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能:得到卡信息
函数参数:
        cardinfo:卡信息存储区
返回值:错误状态
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardGetInfo</span><span class="token punctuation">(</span>SD_CardInfo <span class="token operator">*</span>cardinfo<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 	SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
	u8 tmp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	   
	cardinfo<span class="token operator">-&gt;</span>CardType<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span>CardType<span class="token punctuation">;</span> 				<span class="token comment">//卡类型</span>
	cardinfo<span class="token operator">-&gt;</span>RCA<span class="token operator">=</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>RCA<span class="token punctuation">;</span>							    <span class="token comment">//卡RCA值</span>
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>CSDStruct<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0xC0</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">;</span>		<span class="token comment">//CSD结构</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>SysSpecVersion<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x3C</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">2</span><span class="token punctuation">;</span>	<span class="token comment">//2.0协议还没定义这部分(为保留),应该是后续协议定义的</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>Reserved1<span class="token operator">=</span>tmp<span class="token operator">&amp;</span><span class="token number">0x03</span><span class="token punctuation">;</span>			<span class="token comment">//2个保留位  </span>
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//第1个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>TAAC<span class="token operator">=</span>tmp<span class="token punctuation">;</span>				   		<span class="token comment">//数据读时间1</span>
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0000FF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  		<span class="token comment">//第2个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>NSAC<span class="token operator">=</span>tmp<span class="token punctuation">;</span>		  				<span class="token comment">//数据读时间2</span>
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//第3个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>MaxBusClkFrec<span class="token operator">=</span>tmp<span class="token punctuation">;</span>		  		<span class="token comment">//传输速度	   </span>
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//第4个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>CardComdClasses<span class="token operator">=</span>tmp<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>    	<span class="token comment">//卡指令类高四位</span>
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 		<span class="token comment">//第5个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>CardComdClasses<span class="token operator">|=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0xF0</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//卡指令类低四位</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>RdBlockLen<span class="token operator">=</span>tmp<span class="token operator">&amp;</span><span class="token number">0x0F</span><span class="token punctuation">;</span>	    	<span class="token comment">//最大读取数据长度</span>
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0000FF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//第6个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>PartBlockRead<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>	<span class="token comment">//允许分块读</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>WrBlockMisalign<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">;</span>	<span class="token comment">//写块错位</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>RdBlockMisalign<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">5</span><span class="token punctuation">;</span>	<span class="token comment">//读块错位</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DSRImpl<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">4</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>Reserved2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 					<span class="token comment">//保留</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CardType<span class="token operator">==</span>SDIO_STD_CAPACITY_SD_CARD_V1_1<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>CardType<span class="token operator">==</span>SDIO_STD_CAPACITY_SD_CARD_V2_0<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_MULTIMEDIA_CARD<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//标准1.1/2.0卡/MMC卡</span>
	<span class="token punctuation">{<!-- --></span>
		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSize<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>	<span class="token comment">//C_SIZE(12位)</span>
	 	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 			<span class="token comment">//第7个字节	</span>
		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSize<span class="token operator">|=</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>
 		tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第8个字节	</span>
		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSize<span class="token operator">|=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0xC0</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">;</span>
 		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>MaxRdCurrentVDDMin<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">3</span><span class="token punctuation">;</span>
		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>MaxRdCurrentVDDMax<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x07</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 		tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第9个字节	</span>
		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>MaxWrCurrentVDDMin<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0xE0</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">5</span><span class="token punctuation">;</span>
		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>MaxWrCurrentVDDMax<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x1C</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">2</span><span class="token punctuation">;</span>
		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSizeMul<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//C_SIZE_MULT</span>
 		tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0000FF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  	<span class="token comment">//第10个字节	</span>
		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSizeMul<span class="token operator">|=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>
 		cardinfo<span class="token operator">-&gt;</span>CardCapacity<span class="token operator">=</span><span class="token punctuation">(</span>cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSize<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算卡容量</span>
		cardinfo<span class="token operator">-&gt;</span>CardCapacity<span class="token operator">*=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSizeMul<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		cardinfo<span class="token operator">-&gt;</span>CardBlockSize<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>RdBlockLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//块大小</span>
		cardinfo<span class="token operator">-&gt;</span>CardCapacity<span class="token operator">*=</span>cardinfo<span class="token operator">-&gt;</span>CardBlockSize<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>CardType<span class="token operator">==</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token punctuation">)</span>	<span class="token comment">//高容量卡</span>
	<span class="token punctuation">{<!-- --></span>
 		tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//第7个字节	</span>
		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSize<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x3F</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span><span class="token comment">//C_SIZE</span>
 		tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//第8个字节	</span>
 		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSize<span class="token operator">|=</span><span class="token punctuation">(</span>tmp<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 		tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//第9个字节	</span>
 		cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSize<span class="token operator">|=</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
 		tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0000FF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//第10个字节	</span>
 		cardinfo<span class="token operator">-&gt;</span>CardCapacity<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>DeviceSize<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">512</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span><span class="token comment">//计算卡容量</span>
		cardinfo<span class="token operator">-&gt;</span>CardBlockSize<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">;</span> 			<span class="token comment">//块大小固定为512字节</span>
	<span class="token punctuation">}</span>	  
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>EraseGrSize<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>EraseGrMul<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x3F</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>	   
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//第11个字节	</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>EraseGrMul<span class="token operator">|=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>WrProtectGrSize<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x7F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第12个字节	</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>WrProtectGrEnable<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>ManDeflECC<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">5</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>WrSpeedFact<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x1C</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">2</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>MaxWrBlockLen<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>	 
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第13个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>MaxWrBlockLen<span class="token operator">|=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0xC0</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>WriteBlockPaPartial<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">5</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>Reserved3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>ContentProtectAppli<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0000FF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第14个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>FileFormatGrouop<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>CopyFlag<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>PermWrProtect<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">5</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>TempWrProtect<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">4</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>FileFormat<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x0C</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">2</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>ECC<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>CSD_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//第15个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>CSD_CRC<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0xFE</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_csd<span class="token punctuation">.</span>Reserved4<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>		 
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第0个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ManufacturerID<span class="token operator">=</span>tmp<span class="token punctuation">;</span>		    
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第1个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>OEM_AppliID<span class="token operator">=</span>tmp<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>	  
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第2个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>OEM_AppliID<span class="token operator">|=</span>tmp<span class="token punctuation">;</span>	    
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//第3个字节	</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdName1<span class="token operator">=</span>tmp<span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">;</span>				  
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//第4个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdName1<span class="token operator">|=</span>tmp<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>	  
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   	<span class="token comment">//第5个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdName1<span class="token operator">|=</span>tmp<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>		 
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0000FF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第6个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdName1<span class="token operator">|=</span>tmp<span class="token punctuation">;</span>		   
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  		<span class="token comment">//第7个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdName2<span class="token operator">=</span>tmp<span class="token punctuation">;</span>			  
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//第8个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdRev<span class="token operator">=</span>tmp<span class="token punctuation">;</span>		 
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第9个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdSN<span class="token operator">=</span>tmp<span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">;</span>	   
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0000FF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//第10个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdSN<span class="token operator">|=</span>tmp<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>	   
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   			<span class="token comment">//第11个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdSN<span class="token operator">|=</span>tmp<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>		   
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//第12个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ProdSN<span class="token operator">|=</span>tmp<span class="token punctuation">;</span>			     
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 	<span class="token comment">//第13个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>Reserved1<span class="token operator">|=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0xF0</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">4</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ManufactDate<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>    
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0000FF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//第14个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>ManufactDate<span class="token operator">|=</span>tmp<span class="token punctuation">;</span>		 	  
	tmp<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>CID_Tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//第15个字节</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>CID_CRC<span class="token operator">=</span><span class="token punctuation">(</span>tmp<span class="token operator">&amp;</span><span class="token number">0xFE</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">;</span>
	cardinfo<span class="token operator">-&gt;</span>SD_cid<span class="token punctuation">.</span>Reserved2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	 
	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 设置SDIO总线宽度
函数参数:
        wmode:位宽模式.0,1位数据宽度;1,4位数据宽度;2,8位数据宽度
返回值:SD卡错误状态
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardEnableWideBusOperation</span><span class="token punctuation">(</span>u32 wmode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V1_1<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V2_0<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>wmode<span class="token operator">&gt;=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_UNSUPPORTED_FEATURE<span class="token punctuation">;</span><span class="token comment">//不支持8位模式</span>
      <span class="token keyword">else</span>   
      <span class="token punctuation">{<!-- --></span>
        errorstatus<span class="token operator">=</span><span class="token function">SDIO_SdCardEnWideBus</span><span class="token punctuation">(</span>wmode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>SD_OK<span class="token operator">==</span>errorstatus<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
          SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//清除之前的位宽设置    </span>
          SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">|=</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>wmode<span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">;</span><span class="token comment">//1位/4位总线宽度 </span>
          SDIO<span class="token operator">-&gt;</span>CLKCR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">;</span>			<span class="token comment">//不开启硬件流控制</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能:设置SD卡工作模式
返回值:错误状态
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardSetDeviceMode</span><span class="token punctuation">(</span>u32 Mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SDIO_SD_ERROR_INFO errorstatus <span class="token operator">=</span> SD_OK<span class="token punctuation">;</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Mode<span class="token operator">==</span>SD_DMA_MODE<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>Mode<span class="token operator">==</span>SD_POLLING_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span>DeviceMode<span class="token operator">=</span>Mode<span class="token punctuation">;</span>
	<span class="token keyword">else</span> errorstatus<span class="token operator">=</span>SD_INVALID_PARAMETER<span class="token punctuation">;</span>
	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>	    
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能:选卡,发送CMD7,选择相对地址(rca)为addr的卡,取消其他卡.如果为0,则都不选择.
函数参数:
        addr:卡的RCA地址
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardSelectAddr</span><span class="token punctuation">(</span>u32 addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SEL_DESEL_CARD<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD7,选择卡,短响应	 	   </span>
  <span class="token keyword">return</span> <span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SEL_DESEL_CARD<span class="token punctuation">)</span><span class="token punctuation">;</span>	  
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: SD卡读取一个块
函数参数: 
        buf:读数据缓存区(必须4字节对齐!!)
        addr:读取地址
        blksize:块大小
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardReadBlock</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span> addr<span class="token punctuation">,</span>u16 blksize<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	  
    SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
    u8 power<span class="token punctuation">;</span>
    u32 count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">*</span>tempbuff<span class="token operator">=</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span><span class="token comment">//转换为u32指针 </span>
    u32 timeout<span class="token operator">=</span>SDIO_DATATIMEOUT<span class="token punctuation">;</span>   
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token operator">==</span>buf<span class="token punctuation">)</span><span class="token keyword">return</span> SD_INVALID_PARAMETER<span class="token punctuation">;</span> 
    SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">;</span>	<span class="token comment">//数据控制寄存器清零(关DMA)   </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>CardType<span class="token operator">==</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token punctuation">)</span><span class="token comment">//大容量卡</span>
    <span class="token punctuation">{<!-- --></span>
      blksize<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">;</span>
      addr<span class="token operator">&gt;&gt;=</span><span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
    <span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>SD_DATATIMEOUT<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清除DPSM状态机配置</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token operator">&amp;</span>SD_CARD_LOCKED<span class="token punctuation">)</span><span class="token keyword">return</span> SD_LOCK_UNLOCK_FAILED<span class="token punctuation">;</span><span class="token comment">//卡锁了</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blksize<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>blksize<span class="token operator">&lt;=</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blksize<span class="token operator">&amp;</span><span class="token punctuation">(</span>blksize<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      power<span class="token operator">=</span><span class="token function">convert_from_bytes_to_power_of_two</span><span class="token punctuation">(</span>blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>	    	   
      <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD16+设置数据长度为blksize,短响应 	   </span>
      errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待R1响应   </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误	 </span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> SD_INVALID_PARAMETER<span class="token punctuation">;</span>	  	  									    
      <span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>SD_DATATIMEOUT<span class="token punctuation">,</span>blksize<span class="token punctuation">,</span>power<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//blksize,卡到控制器	  </span>
      <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_READ_SINGLE_BLOCK<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送CMD17+从addr地址出读取数据,短响应 	   </span>
    errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_READ_SINGLE_BLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待R1响应   </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   		<span class="token comment">//响应错误	 </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>DeviceMode<span class="token operator">==</span>SD_POLLING_MODE<span class="token punctuation">)</span>						<span class="token comment">//查询模式,轮询数据	 </span>
    <span class="token punctuation">{<!-- --></span>
       <span class="token comment">//	INTX_DISABLE();//关闭总中断(POLLING模式,严禁中断打断SDIO读写操作!!!)</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//无上溢/CRC/超时/完成(标志)/起始位错误</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>						<span class="token comment">//接收区半满,表示至少存了8个字</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>count<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>count<span class="token operator">++</span><span class="token punctuation">)</span>			<span class="token comment">//循环读取数据</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span><span class="token punctuation">(</span>tempbuff<span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>FIFO<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          tempbuff<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">;</span>	 
          timeout<span class="token operator">=</span><span class="token number">0X7FFFFF</span><span class="token punctuation">;</span> 	<span class="token comment">//读数据溢出时间</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> 	<span class="token comment">//处理超时</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>
          timeout<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//数据超时错误</span>
      <span class="token punctuation">{<!-- --></span>										   
        SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
        <span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//数据块CRC错误</span>
      <span class="token punctuation">{<!-- --></span>
        SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
        <span class="token keyword">return</span> SD_DATA_CRC_FAIL<span class="token punctuation">;</span>		   
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//接收fifo上溢错误</span>
      <span class="token punctuation">{<!-- --></span>
        SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
        <span class="token keyword">return</span> SD_RX_OVERRUN<span class="token punctuation">;</span>		 
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//接收起始位错误</span>
      <span class="token punctuation">{<!-- --></span>
        SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
        <span class="token keyword">return</span> SD_START_BIT_ERR<span class="token punctuation">;</span>		 
      <span class="token punctuation">}</span>   
      <span class="token keyword">while</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//FIFO里面,还存在可用数据</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>tempbuff<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>FIFO<span class="token punctuation">;</span>	<span class="token comment">//循环读取数据</span>
        tempbuff<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment">//	INTX_ENABLE();//开启总中断</span>
      SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 		<span class="token comment">//清除所有标记</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>DeviceMode<span class="token operator">==</span>SD_DMA_MODE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">SDIO_SdCard_DMAConfig</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span>blksize<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      TransferError<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
      StopCondition<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//单块读,不需要发送停止传输指令</span>
      TransferEnd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//传输结束标置位，在中断服务置1</span>
      SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//配置需要的中断 </span>
      SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>		 	<span class="token comment">//SDIO DMA使能 </span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMA2<span class="token operator">-&gt;</span>ISR<span class="token operator">&amp;</span><span class="token number">0X2000</span><span class="token punctuation">)</span><span class="token operator">==</span>RESET<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>TransferEnd<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>TransferError<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>timeout<span class="token punctuation">)</span>timeout<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//等待传输完成 </span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span><span class="token comment">//超时</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>TransferError<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span>errorstatus<span class="token operator">=</span>TransferError<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>   
    <span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: SD卡读取多个块
函数参数: 
        buf:读数据缓存区
        addr:读取地址
        blksize:块大小
        nblks:要读取的块数
返回值:错误状态
*/</span>
<span class="token function">__align</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> u32 <span class="token operator">*</span>tempbuff<span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardReadMultiBlocks</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span> addr<span class="token punctuation">,</span>u16 blksize<span class="token punctuation">,</span>u32 nblks<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
	u8 power<span class="token punctuation">;</span>
  u32 count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u32 timeout<span class="token operator">=</span>SDIO_DATATIMEOUT<span class="token punctuation">;</span>  
	tempbuff<span class="token operator">=</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span> <span class="token comment">//转换为u32指针</span>
  SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">;</span>		<span class="token comment">//数据控制寄存器清零(关DMA)   </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>CardType<span class="token operator">==</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token punctuation">)</span><span class="token comment">//大容量卡</span>
	<span class="token punctuation">{<!-- --></span>
		blksize<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">;</span>
		addr<span class="token operator">&gt;&gt;=</span><span class="token number">9</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>  
  <span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>SD_DATATIMEOUT<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清除DPSM状态机配置</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token operator">&amp;</span>SD_CARD_LOCKED<span class="token punctuation">)</span><span class="token keyword">return</span> SD_LOCK_UNLOCK_FAILED<span class="token punctuation">;</span><span class="token comment">//卡锁了</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blksize<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>blksize<span class="token operator">&lt;=</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blksize<span class="token operator">&amp;</span><span class="token punctuation">(</span>blksize<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		power<span class="token operator">=</span><span class="token function">convert_from_bytes_to_power_of_two</span><span class="token punctuation">(</span>blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>	    
		<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD16+设置数据长度为blksize,短响应 	   </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待R1响应   </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误	 </span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> SD_INVALID_PARAMETER<span class="token punctuation">;</span>	  
	<span class="token keyword">if</span><span class="token punctuation">(</span>nblks<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span>											<span class="token comment">//多块读  </span>
	<span class="token punctuation">{<!-- --></span>									    
 	  <span class="token keyword">if</span><span class="token punctuation">(</span>nblks<span class="token operator">*</span>blksize<span class="token operator">&gt;</span>SD_MAX_DATA_LENGTH<span class="token punctuation">)</span><span class="token keyword">return</span> SD_INVALID_PARAMETER<span class="token punctuation">;</span><span class="token comment">//判断是否超过最大接收长度</span>
		<span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>SD_DATATIMEOUT<span class="token punctuation">,</span>nblks<span class="token operator">*</span>blksize<span class="token punctuation">,</span>power<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//nblks*blksize,512块大小,卡到控制器	  </span>
	  <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_READ_MULT_BLOCK<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD18+从addr地址出读取数据,短响应 	   </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_READ_MULT_BLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待R1响应   </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误	  </span>
 		<span class="token keyword">if</span><span class="token punctuation">(</span>DeviceMode<span class="token operator">==</span>SD_POLLING_MODE<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
<span class="token comment">//			INTX_DISABLE();//关闭总中断(POLLING模式,严禁中断打断SDIO读写操作!!!)</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//无上溢/CRC/超时/完成(标志)/起始位错误</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>						<span class="token comment">//接收区半满,表示至少存了8个字</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">for</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>count<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>count<span class="token operator">++</span><span class="token punctuation">)</span>			<span class="token comment">//循环读取数据</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token operator">*</span><span class="token punctuation">(</span>tempbuff<span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>FIFO<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					tempbuff<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">;</span>	 
					timeout<span class="token operator">=</span><span class="token number">0X7FFFFF</span><span class="token punctuation">;</span> 	<span class="token comment">//读数据溢出时间</span>
				<span class="token punctuation">}</span><span class="token keyword">else</span> 	<span class="token comment">//处理超时</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>
					timeout<span class="token operator">--</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>  
			<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//数据超时错误</span>
			<span class="token punctuation">{<!-- --></span>										   
		 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
				<span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>
		 	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//数据块CRC错误</span>
			<span class="token punctuation">{<!-- --></span>
		 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
				<span class="token keyword">return</span> SD_DATA_CRC_FAIL<span class="token punctuation">;</span>		   
			<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//接收fifo上溢错误</span>
			<span class="token punctuation">{<!-- --></span>
		 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
				<span class="token keyword">return</span> SD_RX_OVERRUN<span class="token punctuation">;</span>		 
			<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//接收起始位错误</span>
			<span class="token punctuation">{<!-- --></span>
		 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
				<span class="token keyword">return</span> SD_START_BIT_ERR<span class="token punctuation">;</span>		 
			<span class="token punctuation">}</span>   
			<span class="token keyword">while</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//FIFO里面,还存在可用数据</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token operator">*</span>tempbuff<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>FIFO<span class="token punctuation">;</span>	<span class="token comment">//循环读取数据</span>
				tempbuff<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
	 		<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//接收结束</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V1_1<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V2_0<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_STOP_TRANSMISSION<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送CMD12+结束传输 	   </span>
					errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_STOP_TRANSMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待R1响应   </span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>	 
				<span class="token punctuation">}</span>
 			<span class="token punctuation">}</span>
		<span class="token comment">//	INTX_ENABLE();//开启总中断</span>
	 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 		<span class="token comment">//清除所有标记 </span>
 		<span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>DeviceMode<span class="token operator">==</span>SD_DMA_MODE<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
	 	    <span class="token function">SDIO_SdCard_DMAConfig</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span>nblks<span class="token operator">*</span>blksize<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	   		TransferError<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
			StopCondition<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>			<span class="token comment">//多块读,需要发送停止传输指令 </span>
			TransferEnd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//传输结束标置位，在中断服务置1</span>
			SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//配置需要的中断 </span>
		 	SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>		 						<span class="token comment">//SDIO DMA使能 </span>
	 		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMA2<span class="token operator">-&gt;</span>ISR<span class="token operator">&amp;</span><span class="token number">0X2000</span><span class="token punctuation">)</span><span class="token operator">==</span>RESET<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>timeout<span class="token punctuation">)</span>timeout<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//等待传输完成 </span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span><span class="token comment">//超时</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TransferEnd<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>TransferError<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
			<span class="token keyword">if</span><span class="token punctuation">(</span>TransferError<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span>errorstatus<span class="token operator">=</span>TransferError<span class="token punctuation">;</span>  	 
		<span class="token punctuation">}</span>		 
  	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>	


<span class="token comment">/*
函数功能:SD卡写1个块
函数参数:
        buf:数据缓存区
        addr:写地址
        blksize:块大小
返回值:错误状态
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardWriteBlock</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span> addr<span class="token punctuation">,</span>  u16 blksize<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SDIO_SD_ERROR_INFO errorstatus <span class="token operator">=</span> SD_OK<span class="token punctuation">;</span>
	u8  power<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>cardstate<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u32 timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>bytestransferred<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u32 cardstatus<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>restwords<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u32	tlen<span class="token operator">=</span>blksize<span class="token punctuation">;</span>						<span class="token comment">//总长度(字节)</span>
	u32<span class="token operator">*</span>tempbuff<span class="token operator">=</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>								 
 	<span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_INVALID_PARAMETER<span class="token punctuation">;</span><span class="token comment">//参数错误   </span>
  	SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">;</span>							<span class="token comment">//数据控制寄存器清零(关DMA)   </span>
  	<span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>SD_DATATIMEOUT<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清除DPSM状态机配置</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token operator">&amp;</span>SD_CARD_LOCKED<span class="token punctuation">)</span><span class="token keyword">return</span> SD_LOCK_UNLOCK_FAILED<span class="token punctuation">;</span><span class="token comment">//卡锁了</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>CardType<span class="token operator">==</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token punctuation">)</span>	<span class="token comment">//大容量卡</span>
	<span class="token punctuation">{<!-- --></span>
		blksize<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">;</span>
		addr<span class="token operator">&gt;&gt;=</span><span class="token number">9</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>    
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blksize<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>blksize<span class="token operator">&lt;=</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blksize<span class="token operator">&amp;</span><span class="token punctuation">(</span>blksize<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		power<span class="token operator">=</span><span class="token function">convert_from_bytes_to_power_of_two</span><span class="token punctuation">(</span>blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>	    
		<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD16+设置数据长度为blksize,短响应 	   </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待R1响应   </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误	 </span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> SD_INVALID_PARAMETER<span class="token punctuation">;</span>	 
  <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SEND_STATUS<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RCA<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD13,查询卡的状态,短响应 	   </span>
	errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SEND_STATUS<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//等待R1响应   		   </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
	cardstatus<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token punctuation">;</span>													  
	timeout<span class="token operator">=</span>SD_DATATIMEOUT<span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cardstatus<span class="token operator">&amp;</span><span class="token number">0x00000100</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>timeout<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//检查READY_FOR_DATA位是否置位</span>
	<span class="token punctuation">{<!-- --></span>
		timeout<span class="token operator">--</span><span class="token punctuation">;</span>
	   	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SEND_STATUS<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RCA<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送CMD13,查询卡的状态,短响应 	   </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SEND_STATUS<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待R1响应   		   </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>				    
		cardstatus<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token punctuation">;</span>													  
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_ERROR<span class="token punctuation">;</span>
   	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_WRITE_SINGLE_BLOCK<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD24,写单块指令,短响应 	   </span>
	errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_WRITE_SINGLE_BLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待R1响应   		   </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	  
	StopCondition<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>									<span class="token comment">//单块写,不需要发送停止传输指令 </span>
 	<span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>SD_DATATIMEOUT<span class="token punctuation">,</span>blksize<span class="token punctuation">,</span>power<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//blksize, 控制器到卡	  </span>
	timeout<span class="token operator">=</span>SDIO_DATATIMEOUT<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>DeviceMode <span class="token operator">==</span> SD_POLLING_MODE<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//	INTX_DISABLE();//关闭总中断(POLLING模式,严禁中断打断SDIO读写操作!!!)</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//数据块发送成功/下溢/CRC/超时/起始位错误</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">)</span>							<span class="token comment">//发送区半空,表示至少存了8个字</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tlen<span class="token operator">-</span>bytestransferred<span class="token punctuation">)</span><span class="token operator">&lt;</span>SD_HALFFIFOBYTES<span class="token punctuation">)</span><span class="token comment">//不够32字节了</span>
				<span class="token punctuation">{<!-- --></span>
					restwords<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tlen<span class="token operator">-</span>bytestransferred<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">4</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tlen<span class="token operator">-</span>bytestransferred<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tlen<span class="token operator">-</span>bytestransferred<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					
					<span class="token keyword">for</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>count<span class="token operator">&lt;</span>restwords<span class="token punctuation">;</span>count<span class="token operator">++</span><span class="token punctuation">,</span>tempbuff<span class="token operator">++</span><span class="token punctuation">,</span>bytestransferred<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						SDIO<span class="token operator">-&gt;</span>FIFO<span class="token operator">=</span><span class="token operator">*</span>tempbuff<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token keyword">else</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">for</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>count<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>count<span class="token operator">++</span><span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						SDIO<span class="token operator">-&gt;</span>FIFO<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>tempbuff<span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					tempbuff<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">;</span>
					bytestransferred<span class="token operator">+=</span><span class="token number">32</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				timeout<span class="token operator">=</span><span class="token number">0X3FFFFFFF</span><span class="token punctuation">;</span>	<span class="token comment">//写数据溢出时间</span>
			<span class="token punctuation">}</span><span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>
				timeout<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> 
		<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//数据超时错误</span>
		<span class="token punctuation">{<!-- --></span>										   
	 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
			<span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>
	 	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//数据块CRC错误</span>
		<span class="token punctuation">{<!-- --></span>
	 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
			<span class="token keyword">return</span> SD_DATA_CRC_FAIL<span class="token punctuation">;</span>		   
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//接收fifo下溢错误</span>
		<span class="token punctuation">{<!-- --></span>
	 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
			<span class="token keyword">return</span> SD_TX_UNDERRUN<span class="token punctuation">;</span>		 
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//接收起始位错误</span>
		<span class="token punctuation">{<!-- --></span>
	 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
			<span class="token keyword">return</span> SD_START_BIT_ERR<span class="token punctuation">;</span>		 
		<span class="token punctuation">}</span>   
<span class="token comment">//		INTX_ENABLE();//开启总中断</span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 		<span class="token comment">//清除所有标记	  </span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>DeviceMode<span class="token operator">==</span>SD_DMA_MODE<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">SDIO_SdCard_DMAConfig</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span>blksize<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SDIO DMA配置</span>
   		TransferError<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
		StopCondition<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//单块写,不需要发送停止传输指令 </span>
		TransferEnd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//传输结束标置位，在中断服务置1</span>
		SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//配置产生数据接收完成中断</span>
 	 	SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>								<span class="token comment">//SDIO DMA使能.  </span>
 		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMA2<span class="token operator">-&gt;</span>ISR<span class="token operator">&amp;</span><span class="token number">0X2000</span><span class="token punctuation">)</span><span class="token operator">==</span>RESET<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>timeout<span class="token punctuation">)</span>timeout<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//等待传输完成 </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
  			<span class="token function">SDIO_SdCardInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 					<span class="token comment">//重新初始化SD卡,可以解决写入死机的问题</span>
			<span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>			<span class="token comment">//超时	 </span>
 		<span class="token punctuation">}</span>
		timeout<span class="token operator">=</span>SDIO_DATATIMEOUT<span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TransferEnd<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>TransferError<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>timeout<span class="token punctuation">)</span>timeout<span class="token operator">--</span><span class="token punctuation">;</span>
 		<span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>			<span class="token comment">//超时	 </span>
  		<span class="token keyword">if</span><span class="token punctuation">(</span>TransferError<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> TransferError<span class="token punctuation">;</span>
 	<span class="token punctuation">}</span>  
 	SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 		<span class="token comment">//清除所有标记</span>
 	errorstatus<span class="token operator">=</span><span class="token function">SDIO_SdCardProgrammingState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cardstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>errorstatus<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cardstate<span class="token operator">==</span>SD_CARD_PROGRAMMING<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>cardstate<span class="token operator">==</span>SD_CARD_RECEIVING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_SdCardProgrammingState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cardstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>   
	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能:SD卡写多个块 
函数参数:
        buf:数据缓存区
        addr:写地址
        blksize:块大小
        nblks:要写入的块数
返回值:错误状态
*/</span>											   
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardWriteMultiBlocks</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span> addr<span class="token punctuation">,</span>u16 blksize<span class="token punctuation">,</span>u32 nblks<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SDIO_SD_ERROR_INFO errorstatus <span class="token operator">=</span> SD_OK<span class="token punctuation">;</span>
	u8  power <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> cardstate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	u32 timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>bytestransferred<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u32 count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> restwords <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	u32 tlen<span class="token operator">=</span>nblks<span class="token operator">*</span>blksize<span class="token punctuation">;</span>				<span class="token comment">//总长度(字节)</span>
	u32 <span class="token operator">*</span>tempbuff <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>  
  <span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_INVALID_PARAMETER<span class="token punctuation">;</span> <span class="token comment">//参数错误  </span>
  SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">;</span>							<span class="token comment">//数据控制寄存器清零(关DMA)   </span>
  <span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>SD_DATATIMEOUT<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清除DPSM状态机配置</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token operator">&amp;</span>SD_CARD_LOCKED<span class="token punctuation">)</span><span class="token keyword">return</span> SD_LOCK_UNLOCK_FAILED<span class="token punctuation">;</span><span class="token comment">//卡锁了</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>CardType<span class="token operator">==</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token punctuation">)</span><span class="token comment">//大容量卡</span>
	<span class="token punctuation">{<!-- --></span>
		blksize<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">;</span>
		addr<span class="token operator">&gt;&gt;=</span><span class="token number">9</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>    
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blksize<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>blksize<span class="token operator">&lt;=</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blksize<span class="token operator">&amp;</span><span class="token punctuation">(</span>blksize<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		power<span class="token operator">=</span><span class="token function">convert_from_bytes_to_power_of_two</span><span class="token punctuation">(</span>blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>	    
		<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD16+设置数据长度为blksize,短响应 	   </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待R1响应   </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>   	<span class="token comment">//响应错误	 </span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> SD_INVALID_PARAMETER<span class="token punctuation">;</span>	 
	<span class="token keyword">if</span><span class="token punctuation">(</span>nblks<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>					  
		<span class="token keyword">if</span><span class="token punctuation">(</span>nblks<span class="token operator">*</span>blksize<span class="token operator">&gt;</span>SD_MAX_DATA_LENGTH<span class="token punctuation">)</span><span class="token keyword">return</span> SD_INVALID_PARAMETER<span class="token punctuation">;</span>   
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V1_1<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V2_0<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//提高性能</span>
	 	   	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RCA<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送ACMD55,短响应 	   </span>
			errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//等待R1响应   		   </span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>				    
	 	   	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCK_COUNT<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>nblks<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD23,设置块数量,短响应 	   </span>
			errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCK_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待R1响应   		   </span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>				    
		<span class="token punctuation">}</span> 
		<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_WRITE_MULT_BLOCK<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送CMD25,多块写指令,短响应 	   </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_WRITE_MULT_BLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待R1响应   		   </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
 	 	<span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>SD_DATATIMEOUT<span class="token punctuation">,</span>nblks<span class="token operator">*</span>blksize<span class="token punctuation">,</span>power<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//blksize, 控制器到卡	</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>DeviceMode<span class="token operator">==</span>SD_POLLING_MODE<span class="token punctuation">)</span>
	  <span class="token punctuation">{<!-- --></span>
			timeout<span class="token operator">=</span>SDIO_DATATIMEOUT<span class="token punctuation">;</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//下溢/CRC/数据结束/超时/起始位错误</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">)</span>							<span class="token comment">//发送区半空,表示至少存了8字(32字节)</span>
				<span class="token punctuation">{<!-- --></span>	  
					<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tlen<span class="token operator">-</span>bytestransferred<span class="token punctuation">)</span><span class="token operator">&lt;</span>SD_HALFFIFOBYTES<span class="token punctuation">)</span><span class="token comment">//不够32字节了</span>
					<span class="token punctuation">{<!-- --></span>
						restwords<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tlen<span class="token operator">-</span>bytestransferred<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">4</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tlen<span class="token operator">-</span>bytestransferred<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tlen<span class="token operator">-</span>bytestransferred<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">for</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>count<span class="token operator">&lt;</span>restwords<span class="token punctuation">;</span>count<span class="token operator">++</span><span class="token punctuation">,</span>tempbuff<span class="token operator">++</span><span class="token punctuation">,</span>bytestransferred<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span>
						<span class="token punctuation">{<!-- --></span>
							SDIO<span class="token operator">-&gt;</span>FIFO<span class="token operator">=</span><span class="token operator">*</span>tempbuff<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span><span class="token keyword">else</span> 										<span class="token comment">//发送区半空,可以发送至少8字(32字节)数据</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token keyword">for</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>count<span class="token operator">&lt;</span>SD_HALFFIFO<span class="token punctuation">;</span>count<span class="token operator">++</span><span class="token punctuation">)</span>
						<span class="token punctuation">{<!-- --></span>
							SDIO<span class="token operator">-&gt;</span>FIFO<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>tempbuff<span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						tempbuff<span class="token operator">+=</span>SD_HALFFIFO<span class="token punctuation">;</span>
						bytestransferred<span class="token operator">+=</span>SD_HALFFIFOBYTES<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					timeout<span class="token operator">=</span><span class="token number">0X3FFFFFFF</span><span class="token punctuation">;</span>	<span class="token comment">//写数据溢出时间</span>
				<span class="token punctuation">}</span><span class="token keyword">else</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span> 
					timeout<span class="token operator">--</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> 
			<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//数据超时错误</span>
			<span class="token punctuation">{<!-- --></span>										   
		 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
				<span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>
		 	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//数据块CRC错误</span>
			<span class="token punctuation">{<!-- --></span>
		 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
				<span class="token keyword">return</span> SD_DATA_CRC_FAIL<span class="token punctuation">;</span>		   
			<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//接收fifo下溢错误</span>
			<span class="token punctuation">{<!-- --></span>
		 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
				<span class="token keyword">return</span> SD_TX_UNDERRUN<span class="token punctuation">;</span>		 
			<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//接收起始位错误</span>
			<span class="token punctuation">{<!-- --></span>
		 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span> 		<span class="token comment">//清错误标志</span>
				<span class="token keyword">return</span> SD_START_BIT_ERR<span class="token punctuation">;</span>		 
			<span class="token punctuation">}</span>   										   
			<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//发送结束</span>
			<span class="token punctuation">{<!-- --></span>															 
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V1_1<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_STD_CAPACITY_SD_CARD_V2_0<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>SDIO_HIGH_CAPACITY_SD_CARD<span class="token operator">==</span>CardType<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_STOP_TRANSMISSION<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送CMD12+结束传输 	   </span>
					errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_STOP_TRANSMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待R1响应   </span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>	 
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
<span class="token comment">//			INTX_ENABLE();//开启总中断</span>
        SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 		<span class="token comment">//清除所有标记 </span>
	    <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>DeviceMode<span class="token operator">==</span>SD_DMA_MODE<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token function">SDIO_SdCard_DMAConfig</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span>nblks<span class="token operator">*</span>blksize<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SDIO DMA配置</span>
        TransferError<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
        StopCondition<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>			<span class="token comment">//多块写,需要发送停止传输指令 </span>
        TransferEnd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//传输结束标置位，在中断服务置1</span>
        SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//配置产生数据接收完成中断</span>
        SDIO<span class="token operator">-&gt;</span>DCTRL<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>								<span class="token comment">//SDIO DMA使能. </span>
        timeout<span class="token operator">=</span>SDIO_DATATIMEOUT<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMA2<span class="token operator">-&gt;</span>ISR<span class="token operator">&amp;</span><span class="token number">0X2000</span><span class="token punctuation">)</span><span class="token operator">==</span>RESET<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>timeout<span class="token punctuation">)</span>timeout<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//等待传输完成 </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>	 								<span class="token comment">//超时</span>
        <span class="token punctuation">{<!-- --></span>									  
          <span class="token function">SDIO_SdCardInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 					<span class="token comment">//重新初始化SD卡,可以解决写入死机的问题</span>
          <span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>			<span class="token comment">//超时	 </span>
        <span class="token punctuation">}</span>
        timeout<span class="token operator">=</span>SDIO_DATATIMEOUT<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TransferEnd<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>TransferError<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>timeout<span class="token punctuation">)</span>timeout<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>			<span class="token comment">//超时	 </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>TransferError<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> TransferError<span class="token punctuation">;</span>	 
      <span class="token punctuation">}</span>
  	<span class="token punctuation">}</span>
 	SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 		<span class="token comment">//清除所有标记</span>
 	errorstatus<span class="token operator">=</span><span class="token function">SDIO_SdCardProgrammingState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cardstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>errorstatus<span class="token operator">==</span>SD_OK<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cardstate<span class="token operator">==</span>SD_CARD_PROGRAMMING<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>cardstate<span class="token operator">==</span>SD_CARD_RECEIVING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_SdCardProgrammingState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cardstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>   
	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>	   
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: SDIO中断服务函数
*/</span>	  
<span class="token keyword">void</span> <span class="token function">SDIO_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>											
    <span class="token function">SDIO_SdCardProcessIRQSrc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理所有SDIO相关中断</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: SDIO中断处理函数
函数参数: 处理SDIO传输过程中的各种中断事务
返回值:错误代码
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardProcessIRQSrc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//接收完成中断</span>
	<span class="token punctuation">{<!-- --></span>	 
		<span class="token keyword">if</span><span class="token punctuation">(</span>StopCondition<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_STOP_TRANSMISSION<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送CMD12,结束传输 	   </span>
			TransferError<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_STOP_TRANSMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span> TransferError <span class="token operator">=</span> SD_OK<span class="token punctuation">;</span>	
 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token comment">//清除完成中断标记</span>
		SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭相关中断</span>
 		TransferEnd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">(</span>TransferError<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//数据CRC错误</span>
	<span class="token punctuation">{<!-- --></span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//清除中断标记</span>
		SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭相关中断</span>
	  TransferError <span class="token operator">=</span> SD_DATA_CRC_FAIL<span class="token punctuation">;</span>
	  <span class="token keyword">return</span><span class="token punctuation">(</span>SD_DATA_CRC_FAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//数据超时错误</span>
	<span class="token punctuation">{<!-- --></span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//清除中断标记</span>
		SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭相关中断</span>
	  TransferError <span class="token operator">=</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>
	  <span class="token keyword">return</span><span class="token punctuation">(</span>SD_DATA_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//FIFO上溢错误</span>
	<span class="token punctuation">{<!-- --></span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//清除中断标记</span>
		SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭相关中断</span>
	  TransferError <span class="token operator">=</span> SD_RX_OVERRUN<span class="token punctuation">;</span>
	  <span class="token keyword">return</span><span class="token punctuation">(</span>SD_RX_OVERRUN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//FIFO下溢错误</span>
	<span class="token punctuation">{<!-- --></span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//清除中断标记</span>
		SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭相关中断</span>
	  TransferError <span class="token operator">=</span> SD_TX_UNDERRUN<span class="token punctuation">;</span>
	  <span class="token keyword">return</span><span class="token punctuation">(</span>SD_TX_UNDERRUN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//起始位错误</span>
	<span class="token punctuation">{<!-- --></span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span><span class="token comment">//清除中断标记</span>
		SDIO<span class="token operator">-&gt;</span>MASK<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭相关中断</span>
	  TransferError <span class="token operator">=</span> SD_START_BIT_ERR<span class="token punctuation">;</span>
	  <span class="token keyword">return</span><span class="token punctuation">(</span>SD_START_BIT_ERR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span><span class="token punctuation">(</span>SD_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 检查CMD0的执行状态
返回值:   sd卡错误码
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdErrorCheck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    SDIO_SD_ERROR_INFO errorstatus <span class="token operator">=</span> SD_OK<span class="token punctuation">;</span>
    u32 timeout<span class="token operator">=</span>SDIO_CMD0TIMEOUT<span class="token punctuation">;</span>	   
    <span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>	<span class="token comment">//命令已发送(无需响应)	 </span>
    <span class="token punctuation">}</span>	    
    <span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> SD_CMD_RSP_TIMEOUT<span class="token punctuation">;</span>  
    SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>				<span class="token comment">//清除标记</span>
    <span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 检查R7响应的错误状态
函数参数: 返回值:sd卡错误码
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp7Error</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
	u32 status<span class="token punctuation">;</span>
	u32 timeout<span class="token operator">=</span>SDIO_CMD0TIMEOUT<span class="token punctuation">;</span>
 	<span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		status<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//CRC错误/命令响应超时/已经收到响应(CRC校验成功)	</span>
	<span class="token punctuation">}</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//响应超时</span>
	<span class="token punctuation">{<!-- --></span>																				    
		errorstatus<span class="token operator">=</span>SD_CMD_RSP_TIMEOUT<span class="token punctuation">;</span>	<span class="token comment">//当前卡不是2.0兼容卡,或者不支持设定的电压范围</span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>				<span class="token comment">//清除命令响应超时标志</span>
		<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	 
	<span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span>						<span class="token comment">//成功接收到响应</span>
	<span class="token punctuation">{<!-- --></span>								   
		errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span>				<span class="token comment">//清除响应标志</span>
 	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能:检查R1响应的错误状态
函数参数:
        cmd:当前命令
返回值:sd卡错误码    
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>u8 cmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	  
    u32 status<span class="token punctuation">;</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      status<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//CRC错误/命令响应超时/已经收到响应(CRC校验成功)</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>					<span class="token comment">//响应超时</span>
    <span class="token punctuation">{<!-- --></span>																				    
      SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>					<span class="token comment">//清除命令响应超时标志</span>
      <span class="token keyword">return</span> SD_CMD_RSP_TIMEOUT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
    <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>					<span class="token comment">//CRC错误</span>
    <span class="token punctuation">{<!-- --></span>																				    
      SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>					<span class="token comment">//清除标志</span>
      <span class="token keyword">return</span> SD_CMD_CRC_FAIL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>		
    <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>RESPCMD<span class="token operator">!=</span>cmd<span class="token punctuation">)</span><span class="token keyword">return</span> SD_ILLEGAL_CMD<span class="token punctuation">;</span><span class="token comment">//命令不匹配 </span>
      SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 				<span class="token comment">//清除标记</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>SDIO_SD_ERROR_INFO<span class="token punctuation">)</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token operator">&amp;</span>SD_OCR_ERRORBITS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回卡响应</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 检查R3响应的错误状态
返回值:   错误状态
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp3Error</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 status<span class="token punctuation">;</span>						 
 	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		status<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//CRC错误/命令响应超时/已经收到响应(CRC校验成功)	</span>
	<span class="token punctuation">}</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>					<span class="token comment">//响应超时</span>
	<span class="token punctuation">{<!-- --></span>											 
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>				<span class="token comment">//清除命令响应超时标志</span>
		<span class="token keyword">return</span> SD_CMD_RSP_TIMEOUT<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	 
  SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 				<span class="token comment">//清除标记</span>
 	<span class="token keyword">return</span> SD_OK<span class="token punctuation">;</span>								  
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 检查R2响应的错误状态
返回值:错误状态
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp2Error</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
    u32 status<span class="token punctuation">;</span>
    u32 timeout<span class="token operator">=</span>SDIO_CMD0TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      status<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//CRC错误/命令响应超时/已经收到响应(CRC校验成功)	</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//响应超时</span>
    <span class="token punctuation">{<!-- --></span>																				    
      errorstatus<span class="token operator">=</span>SD_CMD_RSP_TIMEOUT<span class="token punctuation">;</span> 
      SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>				<span class="token comment">//清除命令响应超时标志</span>
      <span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	 
    <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>						<span class="token comment">//CRC错误</span>
    <span class="token punctuation">{<!-- --></span>								   
      errorstatus<span class="token operator">=</span>SD_CMD_CRC_FAIL<span class="token punctuation">;</span>
      SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//清除响应标志</span>
    <span class="token punctuation">}</span>
    SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 				<span class="token comment">//清除标记</span>
    <span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>								    		 
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 检查R6响应的错误状态
函数参数:
        cmd:之前发送的命令
        prca:卡返回的RCA地址
返回值:错误状态
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp6Error</span><span class="token punctuation">(</span>u8 cmd<span class="token punctuation">,</span>u16<span class="token operator">*</span>prca<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SDIO_SD_ERROR_INFO errorstatus<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
	u32 status<span class="token punctuation">;</span>					    
	u32 rspr1<span class="token punctuation">;</span>
 	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		status<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//CRC错误/命令响应超时/已经收到响应(CRC校验成功)	</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>					<span class="token comment">//响应超时</span>
	<span class="token punctuation">{<!-- --></span>																				    
 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>				<span class="token comment">//清除命令响应超时标志</span>
		<span class="token keyword">return</span> SD_CMD_RSP_TIMEOUT<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	 	 
	<span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>						<span class="token comment">//CRC错误</span>
	<span class="token punctuation">{<!-- --></span>								   
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//清除响应标志</span>
 		<span class="token keyword">return</span> SD_CMD_CRC_FAIL<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>RESPCMD<span class="token operator">!=</span>cmd<span class="token punctuation">)</span>		<span class="token comment">//判断是否响应cmd命令</span>
	<span class="token punctuation">{<!-- --></span>
 		<span class="token keyword">return</span> SD_ILLEGAL_CMD<span class="token punctuation">;</span> 		
	<span class="token punctuation">}</span>	    
	SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 				<span class="token comment">//清除所有标记</span>
	rspr1<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token punctuation">;</span>					<span class="token comment">//得到响应 	 </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>SD_ALLZERO<span class="token operator">==</span><span class="token punctuation">(</span>rspr1<span class="token operator">&amp;</span><span class="token punctuation">(</span>SD_R6_GENERAL_UNKNOWN_ERROR<span class="token operator">|</span>SD_R6_ILLEGAL_CMD<span class="token operator">|</span>SD_R6_COM_CRC_FAILED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>prca<span class="token operator">=</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span><span class="token punctuation">(</span>rspr1<span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//右移16位得到,rca</span>
		<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
   	<span class="token keyword">if</span><span class="token punctuation">(</span>rspr1<span class="token operator">&amp;</span>SD_R6_GENERAL_UNKNOWN_ERROR<span class="token punctuation">)</span><span class="token keyword">return</span> SD_GENERAL_UNKNOWN_ERROR<span class="token punctuation">;</span>
   	<span class="token keyword">if</span><span class="token punctuation">(</span>rspr1<span class="token operator">&amp;</span>SD_R6_ILLEGAL_CMD<span class="token punctuation">)</span><span class="token keyword">return</span> SD_ILLEGAL_CMD<span class="token punctuation">;</span>
   	<span class="token keyword">if</span><span class="token punctuation">(</span>rspr1<span class="token operator">&amp;</span>SD_R6_COM_CRC_FAILED<span class="token punctuation">)</span><span class="token keyword">return</span> SD_COM_CRC_FAILED<span class="token punctuation">;</span>
	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能:SDIO使能宽总线模式
函数参数:
         enx:0,不使能;1,使能;
返回值:错误状态
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardEnWideBus</span><span class="token punctuation">(</span>u8 enx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SDIO_SD_ERROR_INFO errorstatus <span class="token operator">=</span> SD_OK<span class="token punctuation">;</span>
 	u32 scr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	u8 arg<span class="token operator">=</span><span class="token number">0X00</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>enx<span class="token punctuation">)</span>arg<span class="token operator">=</span><span class="token number">0X02</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> arg<span class="token operator">=</span><span class="token number">0X00</span><span class="token punctuation">;</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token operator">&amp;</span>SD_CARD_LOCKED<span class="token punctuation">)</span><span class="token keyword">return</span> SD_LOCK_UNLOCK_FAILED<span class="token punctuation">;</span><span class="token comment">//SD卡处于LOCKED状态		    </span>
 	errorstatus<span class="token operator">=</span><span class="token function">SDIO_SdCardFindSCR</span><span class="token punctuation">(</span>RCA<span class="token punctuation">,</span>scr<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//得到SCR寄存器数据</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>scr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>SD_WIDE_BUS_SUPPORT<span class="token punctuation">)</span><span class="token operator">!=</span>SD_ALLZERO<span class="token punctuation">)</span>		<span class="token comment">//支持宽总线</span>
	<span class="token punctuation">{<!-- --></span>
	 	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RCA<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD55+RCA,短响应											  </span>
	 	errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span> 
	 	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_APP_SD_SET_BUSWIDTH<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送ACMD6,短响应,参数:10,4位;00,1位.											  </span>
		errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_APP_SD_SET_BUSWIDTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> SD_REQUEST_NOT_APPLICABLE<span class="token punctuation">;</span>				<span class="token comment">//不支持宽总线设置 	 </span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 检查卡是否正在执行写操作
函数参数: pstatus:当前状态
返回值:错误代码
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardProgrammingState</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pstatus<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 	vu32 respR1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
  <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SEND_STATUS<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RCA<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送CMD13 	   </span>
  status<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>status<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token punctuation">;</span><span class="token comment">//等待操作完成</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>			<span class="token comment">//CRC检测失败</span>
	<span class="token punctuation">{<!-- --></span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//清除错误标记</span>
		<span class="token keyword">return</span> SD_CMD_CRC_FAIL<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>			<span class="token comment">//命令超时 </span>
	<span class="token punctuation">{<!-- --></span>
		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>		<span class="token comment">//清除错误标记</span>
		<span class="token keyword">return</span> SD_CMD_RSP_TIMEOUT<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>RESPCMD<span class="token operator">!=</span>SD_CMD_SEND_STATUS<span class="token punctuation">)</span><span class="token keyword">return</span> SD_ILLEGAL_CMD<span class="token punctuation">;</span>
	SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 		<span class="token comment">//清除所有标记</span>
	respR1<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token punctuation">;</span>
	<span class="token operator">*</span>pstatus<span class="token operator">=</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>respR1<span class="token operator">&gt;&gt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x0000000F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> SD_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 读取当前卡状态
函数参数: 
        pcardstatus:卡状态
返回值 :错误代码
*/</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardSendStatus</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> <span class="token operator">*</span>pcardstatus<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SDIO_SD_ERROR_INFO errorstatus <span class="token operator">=</span> SD_OK<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pcardstatus<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		errorstatus<span class="token operator">=</span>SD_INVALID_PARAMETER<span class="token punctuation">;</span>
		<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SEND_STATUS<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>RCA<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD13,短响应		 </span>
	errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SEND_STATUS<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//查询响应状态 </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
	<span class="token operator">*</span>pcardstatus<span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>RESP1<span class="token punctuation">;</span><span class="token comment">//读取响应值</span>
	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 返回SD卡的状态
返回值  : SD卡状态
*/</span>
SDCardState <span class="token function">SDIO_SdCardGetState</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 resp1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SDIO_SdCardSendStatus</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>resp1<span class="token punctuation">)</span><span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> SD_CARD_ERROR<span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>SDCardState<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resp1<span class="token operator">&gt;&gt;</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能:查找SD卡的SCR寄存器值
函数参数:
        rca:卡相对地址
        pscr:数据缓存区(存储SCR内容)
返回值:错误状态	
*/</span>   
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardFindSCR</span><span class="token punctuation">(</span>u16 rca<span class="token punctuation">,</span>u32 <span class="token operator">*</span>pscr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
	u32 index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
	SDIO_SD_ERROR_INFO errorstatus <span class="token operator">=</span> SD_OK<span class="token punctuation">;</span>
	u32 tempscr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  
 	<span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//发送CMD16,短响应,设置Block Size为8字节											  </span>
 	errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SET_BLOCKLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>	    
  <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>rca<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送CMD55,短响应 									  </span>
 	errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_APP_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
	<span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>SD_DATATIMEOUT<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//8个字节长度,block为8字节,SD卡到SDIO.</span>
  <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>SD_CMD_SD_APP_SEND_SCR<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送ACMD51,短响应,参数为0											  </span>
 	errorstatus<span class="token operator">=</span><span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>SD_CMD_SD_APP_SEND_SCR<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>errorstatus<span class="token operator">!=</span>SD_OK<span class="token punctuation">)</span><span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>							   
 	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span>SDIO_FLAG_RXOVERR<span class="token operator">|</span>SDIO_FLAG_DCRCFAIL<span class="token operator">|</span>SDIO_FLAG_DTIMEOUT<span class="token operator">|</span>SDIO_FLAG_DBCKEND<span class="token operator">|</span>SDIO_FLAG_STBITERR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span> 
		<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//接收FIFO数据可用</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token operator">*</span><span class="token punctuation">(</span>tempscr<span class="token operator">+</span>index<span class="token punctuation">)</span><span class="token operator">=</span>SDIO<span class="token operator">-&gt;</span>FIFO<span class="token punctuation">;</span>	<span class="token comment">//读取FIFO内容</span>
			index<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>index<span class="token operator">&gt;=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 	<span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//接收数据超时</span>
	<span class="token punctuation">{<!-- --></span>										 
 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>		<span class="token comment">//清除标记</span>
		<span class="token keyword">return</span> SD_DATA_TIMEOUT<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//已发送/接收的数据块CRC校验错误</span>
	<span class="token punctuation">{<!-- --></span>
 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//清除标记</span>
		<span class="token keyword">return</span> SD_DATA_CRC_FAIL<span class="token punctuation">;</span>   
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//接收FIFO溢出</span>
	<span class="token punctuation">{<!-- --></span>
 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>		<span class="token comment">//清除标记</span>
		<span class="token keyword">return</span> SD_RX_OVERRUN<span class="token punctuation">;</span>   	   
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>SDIO<span class="token operator">-&gt;</span>STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//起始位检测错误</span>
	<span class="token punctuation">{<!-- --></span>
 		SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span>		<span class="token comment">//清除标记</span>
		<span class="token keyword">return</span> SD_START_BIT_ERR<span class="token punctuation">;</span>    
	<span class="token punctuation">}</span>
  SDIO<span class="token operator">-&gt;</span>ICR<span class="token operator">=</span><span class="token number">0X5FF</span><span class="token punctuation">;</span>	 		<span class="token comment">//清除标记	 </span>
	<span class="token comment">//把数据顺序按8位为单位倒过来.   	</span>
	<span class="token operator">*</span><span class="token punctuation">(</span>pscr<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tempscr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>SD_0TO7BITS<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tempscr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>SD_8TO15BITS<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tempscr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>SD_16TO23BITS<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tempscr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>SD_24TO31BITS<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span><span class="token punctuation">(</span>pscr<span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tempscr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>SD_0TO7BITS<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tempscr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>SD_8TO15BITS<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tempscr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>SD_16TO23BITS<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tempscr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>SD_24TO31BITS<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token keyword">return</span> errorstatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 得到NumberOfBytes以2为底的指数
函数参数: NumberOfBytes:字节数
返回值:以2为底的指数值
*/</span>
u8 <span class="token function">convert_from_bytes_to_power_of_two</span><span class="token punctuation">(</span>u16 NumberOfBytes<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>NumberOfBytes<span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		NumberOfBytes<span class="token operator">&gt;&gt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
		count<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 配置SDIO DMA  
函数参数: 
        mbuf:存储器地址
        bufsize:传输数据量
        dir:方向;1,存储器--&gt;SDIO(写数据);0,SDIO--&gt;存储器(读数据);
*/</span>
<span class="token keyword">void</span> <span class="token function">SDIO_SdCard_DMAConfig</span><span class="token punctuation">(</span>u32<span class="token operator">*</span>mbuf<span class="token punctuation">,</span>u32 bufsize<span class="token punctuation">,</span>u8 dir<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		 
 	DMA2<span class="token operator">-&gt;</span>IFCR<span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">0XF</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//清除DMA2通道4的各种标记</span>
 	DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//关闭DMA 通道4</span>
  DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0X7FF</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清除之前的设置,DIR,CIRC,PINC,MINC,PSIZE,MSIZE,PL,MEM2MEM</span>
 	DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">|=</span>dir<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>  		<span class="token comment">//从存储器读   </span>
	DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>  			<span class="token comment">//普通模式</span>
	DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> 			<span class="token comment">//外设地址非增量模式</span>
	DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">;</span>  			<span class="token comment">//存储器增量模式</span>
	DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">|=</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>  			<span class="token comment">//外设数据宽度为32位</span>
	DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">|=</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> 			<span class="token comment">//存储器数据宽度32位</span>
	DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">|=</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">;</span> 			<span class="token comment">//高优先级	  </span>
  DMA2_Channel4<span class="token operator">-&gt;</span>CNDTR<span class="token operator">=</span>bufsize<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">;</span>   	<span class="token comment">//DMA2,传输数据量	  </span>
 	DMA2_Channel4<span class="token operator">-&gt;</span>CPAR<span class="token operator">=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token operator">&amp;</span>SDIO<span class="token operator">-&gt;</span>FIFO<span class="token punctuation">;</span><span class="token comment">//DMA2 外设地址 </span>
	DMA2_Channel4<span class="token operator">-&gt;</span>CMAR<span class="token operator">=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>mbuf<span class="token punctuation">;</span> 		<span class="token comment">//DMA2,存储器地址</span>
 	DMA2_Channel4<span class="token operator">-&gt;</span>CCR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span> 			<span class="token comment">//开启DMA通道</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 读SD卡
函数参数:
        buf:读数据缓存区
        sector:扇区地址
        cnt:扇区个数
返回值:错误状态;0,正常;其他,错误代码;				
*/</span> 				 
u8 <span class="token function">SDIO_SdCardReadDiskSector</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u32 sector<span class="token punctuation">,</span>u8 cnt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 sta<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token keyword">long</span> lsector<span class="token operator">=</span>sector<span class="token punctuation">;</span>
	u8 n<span class="token punctuation">;</span>
	lsector<span class="token operator">&lt;&lt;=</span><span class="token number">9</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>buf<span class="token operator">%</span><span class="token number">4</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
	 	<span class="token keyword">for</span><span class="token punctuation">(</span>n<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>n<span class="token operator">&lt;</span>cnt<span class="token punctuation">;</span>n<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
		 	sta<span class="token operator">=</span><span class="token function">SDIO_SdCardReadBlock</span><span class="token punctuation">(</span>SDIO_DATA_BUFFER<span class="token punctuation">,</span>lsector<span class="token operator">+</span><span class="token number">512</span><span class="token operator">*</span>n<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//单个sector的读操作</span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>SDIO_DATA_BUFFER<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			buf<span class="token operator">+=</span><span class="token number">512</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> 
	<span class="token punctuation">}</span><span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>sta<span class="token operator">=</span><span class="token function">SDIO_SdCardReadBlock</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>lsector<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    	<span class="token comment">//单个sector的读操作</span>
		<span class="token keyword">else</span> sta<span class="token operator">=</span><span class="token function">SDIO_SdCardReadMultiBlocks</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>lsector<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">,</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//多个sector  </span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> sta<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能:写SD卡 
函数参数:
        buf:写数据缓存区
        sector:扇区地址
        cnt:扇区个数
返回值:错误状态;0,正常;其他,错误代码;	
*/</span>
u8 <span class="token function">SDIO_SdCardWriteDiskSector</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u32 sector<span class="token punctuation">,</span>u8 cnt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 sta<span class="token operator">=</span>SD_OK<span class="token punctuation">;</span>
	u8 n<span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token keyword">long</span> lsector<span class="token operator">=</span>sector<span class="token punctuation">;</span>
	lsector<span class="token operator">&lt;&lt;=</span><span class="token number">9</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>buf<span class="token operator">%</span><span class="token number">4</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
	 	<span class="token keyword">for</span><span class="token punctuation">(</span>n<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>n<span class="token operator">&lt;</span>cnt<span class="token punctuation">;</span>n<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span>SDIO_DATA_BUFFER<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 	sta<span class="token operator">=</span><span class="token function">SDIO_SdCardWriteBlock</span><span class="token punctuation">(</span>SDIO_DATA_BUFFER<span class="token punctuation">,</span>lsector<span class="token operator">+</span><span class="token number">512</span><span class="token operator">*</span>n<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//单个sector的写操作</span>
			buf<span class="token operator">+=</span><span class="token number">512</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> 
	<span class="token punctuation">}</span><span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>sta<span class="token operator">=</span><span class="token function">SDIO_SdCardWriteBlock</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>lsector<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    	<span class="token comment">//单个sector的写操作</span>
		<span class="token keyword">else</span> sta<span class="token operator">=</span><span class="token function">SDIO_SdCardWriteMultiBlocks</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>lsector<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">,</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//多个sector  </span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> sta<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="3sdioh_2038"></a>（3）sdio.h</h5> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SDIO_SDCARD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SDIO_SDCARD_H</span>																			   </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span> 													   </span>

<span class="token comment">//SDIO相关标志位</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_CCRCFAIL</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000001</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_DCRCFAIL</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000002</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_CTIMEOUT</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000004</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_DTIMEOUT</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000008</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_TXUNDERR</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000010</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_RXOVERR</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000020</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_CMDREND</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000040</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_CMDSENT</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000080</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_DATAEND</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000100</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_STBITERR</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000200</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_DBCKEND</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000400</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_CMDACT</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000800</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_TXACT</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00001000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_RXACT</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00002000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_TXFIFOHE</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00004000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_RXFIFOHF</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00008000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_TXFIFOF</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00010000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_RXFIFOF</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00020000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_TXFIFOE</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00040000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_RXFIFOE</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00080000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_TXDAVL</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00100000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_RXDAVL</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00200000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_SDIOIT</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00400000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FLAG_CEATAEND</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00800000</span><span class="token punctuation">)</span></span></span>


<span class="token comment">//用户配置区			  </span>
<span class="token comment">//SDIO时钟计算公式:SDIO_CK时钟=SDIOCLK/[clkdiv+2];其中,SDIOCLK一般为72Mhz</span>
<span class="token comment">//使用DMA模式的时候,传输速率可以到24Mhz,不过如果你的卡不是高速卡,可能也会出错</span>
<span class="token comment">//出错就请降低时钟,使用查询模式的话,推荐SDIO_TRANSFER_CLK_DIV设置为3或者更大</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_INIT_CLK_DIV</span>        <span class="token expression"><span class="token number">0xB2</span> 		</span><span class="token comment">//SDIO初始化频率，最大400Kh  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_TRANSFER_CLK_DIV</span>    <span class="token expression"><span class="token number">0x04</span>		</span><span class="token comment">//SDIO传输频率,该值太小可能会导致读写文件出错 </span></span>
										 

<span class="token comment"> </span>
<span class="token comment">//SDIO工作模式定义,通过SDIO_SdCardSetDeviceMode函数设置.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_POLLING_MODE</span>    	<span class="token expression"><span class="token number">0</span>  	</span><span class="token comment">//查询模式,该模式下,如果读写有问题,建议增大SDIO_TRANSFER_CLK_DIV的设置.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_DMA_MODE</span>    		<span class="token expression"><span class="token number">1</span>	</span><span class="token comment">//DMA模式,该模式下,如果读写有问题,建议增大SDIO_TRANSFER_CLK_DIV的设置.   </span></span>

<span class="token comment">//SDIO 各种错误枚举定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>	 
	<span class="token comment">//特殊错误定义 </span>
	SD_CMD_CRC_FAIL                    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Command response received (but CRC check failed) */</span>
	SD_DATA_CRC_FAIL                   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Data bock sent/received (CRC check Failed) */</span>
	SD_CMD_RSP_TIMEOUT                 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Command response timeout */</span>
	SD_DATA_TIMEOUT                    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Data time out */</span>
	SD_TX_UNDERRUN                     <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Transmit FIFO under-run */</span>
	SD_RX_OVERRUN                      <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Receive FIFO over-run */</span>
	SD_START_BIT_ERR                   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Start bit not detected on all data signals in widE bus mode */</span>
	SD_CMD_OUT_OF_RANGE                <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; CMD's argument was out of range.*/</span>
	SD_ADDR_MISALIGNED                 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Misaligned address */</span>
	SD_BLOCK_LEN_ERR                   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Transferred block length is not allowed for the card or the number of transferred bytes does not match the block length */</span>
	SD_ERASE_SEQ_ERR                   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; An error in the sequence of erase command occurs.*/</span>
	SD_BAD_ERASE_PARAM                 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; An Invalid selection for erase groups */</span>
	SD_WRITE_PROT_VIOLATION            <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Attempt to program a write protect block */</span>
	SD_LOCK_UNLOCK_FAILED              <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Sequence or password error has been detected in unlock command or if there was an attempt to access a locked card */</span>
	SD_COM_CRC_FAILED                  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; CRC check of the previous command failed */</span>
	SD_ILLEGAL_CMD                     <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Command is not legal for the card state */</span>
	SD_CARD_ECC_FAILED                 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Card internal ECC was applied but failed to correct the data */</span>
	SD_CC_ERROR                        <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Internal card controller error */</span>
	SD_GENERAL_UNKNOWN_ERROR           <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; General or Unknown error */</span>
	SD_STREAM_READ_UNDERRUN            <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; The card could not sustain data transfer in stream read operation. */</span>
	SD_STREAM_WRITE_OVERRUN            <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; The card could not sustain data programming in stream mode */</span>
	SD_CID_CSD_OVERWRITE               <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; CID/CSD overwrite error */</span>
	SD_WP_ERASE_SKIP                   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; only partial address space was erased */</span>
	SD_CARD_ECC_DISABLED               <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Command has been executed without using internal ECC */</span>
	SD_ERASE_RESET                     <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Erase sequence was cleared before executing because an out of erase sequence command was received */</span>
	SD_AKE_SEQ_ERROR                   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*!&lt; Error in sequence of authentication. */</span>
	SD_INVALID_VOLTRANGE               <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_ADDR_OUT_OF_RANGE               <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_SWITCH_ERROR                    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_SDIO_DISABLED                   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_SDIO_FUNCTION_BUSY              <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_SDIO_FUNCTION_FAILED            <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_SDIO_UNKNOWN_FUNCTION           <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">//标准错误定义</span>
	SD_INTERNAL_ERROR<span class="token punctuation">,</span> 
	SD_NOT_CONFIGURED<span class="token punctuation">,</span>
	SD_REQUEST_PENDING<span class="token punctuation">,</span> 
	SD_REQUEST_NOT_APPLICABLE<span class="token punctuation">,</span> 
	SD_INVALID_PARAMETER<span class="token punctuation">,</span>  
	SD_UNSUPPORTED_FEATURE<span class="token punctuation">,</span>  
	SD_UNSUPPORTED_HW<span class="token punctuation">,</span>  
	SD_ERROR<span class="token punctuation">,</span>  
	SD_OK <span class="token operator">=</span> <span class="token number">0</span> 
<span class="token punctuation">}</span> SDIO_SD_ERROR_INFO<span class="token punctuation">;</span>		  

<span class="token comment">//SD卡CSD寄存器数据		  </span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
	u8  CSDStruct<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; CSD structure */</span>
	u8  SysSpecVersion<span class="token punctuation">;</span>       <span class="token comment">/*!&lt; System specification version */</span>
	u8  Reserved1<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; Reserved */</span>
	u8  TAAC<span class="token punctuation">;</span>                 <span class="token comment">/*!&lt; Data read access-time 1 */</span>
	u8  NSAC<span class="token punctuation">;</span>                 <span class="token comment">/*!&lt; Data read access-time 2 in CLK cycles */</span>
	u8  MaxBusClkFrec<span class="token punctuation">;</span>        <span class="token comment">/*!&lt; Max. bus clock frequency */</span>
	u16 CardComdClasses<span class="token punctuation">;</span>      <span class="token comment">/*!&lt; Card command classes */</span>
	u8  RdBlockLen<span class="token punctuation">;</span>           <span class="token comment">/*!&lt; Max. read data block length */</span>
	u8  PartBlockRead<span class="token punctuation">;</span>        <span class="token comment">/*!&lt; Partial blocks for read allowed */</span>
	u8  WrBlockMisalign<span class="token punctuation">;</span>      <span class="token comment">/*!&lt; Write block misalignment */</span>
	u8  RdBlockMisalign<span class="token punctuation">;</span>      <span class="token comment">/*!&lt; Read block misalignment */</span>
	u8  DSRImpl<span class="token punctuation">;</span>              <span class="token comment">/*!&lt; DSR implemented */</span>
	u8  Reserved2<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; Reserved */</span>
	u32 DeviceSize<span class="token punctuation">;</span>           <span class="token comment">/*!&lt; Device Size */</span>
	u8  MaxRdCurrentVDDMin<span class="token punctuation">;</span>   <span class="token comment">/*!&lt; Max. read current @ VDD min */</span>
	u8  MaxRdCurrentVDDMax<span class="token punctuation">;</span>   <span class="token comment">/*!&lt; Max. read current @ VDD max */</span>
	u8  MaxWrCurrentVDDMin<span class="token punctuation">;</span>   <span class="token comment">/*!&lt; Max. write current @ VDD min */</span>
	u8  MaxWrCurrentVDDMax<span class="token punctuation">;</span>   <span class="token comment">/*!&lt; Max. write current @ VDD max */</span>
	u8  DeviceSizeMul<span class="token punctuation">;</span>        <span class="token comment">/*!&lt; Device size multiplier */</span>
	u8  EraseGrSize<span class="token punctuation">;</span>          <span class="token comment">/*!&lt; Erase group size */</span>
	u8  EraseGrMul<span class="token punctuation">;</span>           <span class="token comment">/*!&lt; Erase group size multiplier */</span>
	u8  WrProtectGrSize<span class="token punctuation">;</span>      <span class="token comment">/*!&lt; Write protect group size */</span>
	u8  WrProtectGrEnable<span class="token punctuation">;</span>    <span class="token comment">/*!&lt; Write protect group enable */</span>
	u8  ManDeflECC<span class="token punctuation">;</span>           <span class="token comment">/*!&lt; Manufacturer default ECC */</span>
	u8  WrSpeedFact<span class="token punctuation">;</span>          <span class="token comment">/*!&lt; Write speed factor */</span>
	u8  MaxWrBlockLen<span class="token punctuation">;</span>        <span class="token comment">/*!&lt; Max. write data block length */</span>
	u8  WriteBlockPaPartial<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; Partial blocks for write allowed */</span>
	u8  Reserved3<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; Reserded */</span>
	u8  ContentProtectAppli<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; Content protection application */</span>
	u8  FileFormatGrouop<span class="token punctuation">;</span>     <span class="token comment">/*!&lt; File format group */</span>
	u8  CopyFlag<span class="token punctuation">;</span>             <span class="token comment">/*!&lt; Copy flag (OTP) */</span>
	u8  PermWrProtect<span class="token punctuation">;</span>        <span class="token comment">/*!&lt; Permanent write protection */</span>
	u8  TempWrProtect<span class="token punctuation">;</span>        <span class="token comment">/*!&lt; Temporary write protection */</span>
	u8  FileFormat<span class="token punctuation">;</span>           <span class="token comment">/*!&lt; File Format */</span>
	u8  ECC<span class="token punctuation">;</span>                  <span class="token comment">/*!&lt; ECC code */</span>
	u8  CSD_CRC<span class="token punctuation">;</span>              <span class="token comment">/*!&lt; CSD CRC */</span>
	u8  Reserved4<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; always 1*/</span>
<span class="token punctuation">}</span> SD_CSD<span class="token punctuation">;</span>   

<span class="token comment">//SD卡CID寄存器数据</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
	u8  ManufacturerID<span class="token punctuation">;</span>       <span class="token comment">/*!&lt; ManufacturerID */</span>
	u16 OEM_AppliID<span class="token punctuation">;</span>          <span class="token comment">/*!&lt; OEM/Application ID */</span>
	u32 ProdName1<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; Product Name part1 */</span>
	u8  ProdName2<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; Product Name part2*/</span>
	u8  ProdRev<span class="token punctuation">;</span>              <span class="token comment">/*!&lt; Product Revision */</span>
	u32 ProdSN<span class="token punctuation">;</span>               <span class="token comment">/*!&lt; Product Serial Number */</span>
	u8  Reserved1<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; Reserved1 */</span>
	u16 ManufactDate<span class="token punctuation">;</span>         <span class="token comment">/*!&lt; Manufacturing Date */</span>
	u8  CID_CRC<span class="token punctuation">;</span>              <span class="token comment">/*!&lt; CID CRC */</span>
	u8  Reserved2<span class="token punctuation">;</span>            <span class="token comment">/*!&lt; always 1 */</span>
<span class="token punctuation">}</span> SD_CID<span class="token punctuation">;</span>	 

<span class="token comment">//SD卡状态</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
	SD_CARD_READY                  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000001</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_CARD_IDENTIFICATION         <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000002</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_CARD_STANDBY                <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000003</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_CARD_TRANSFER               <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000004</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_CARD_SENDING                <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000005</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_CARD_RECEIVING              <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000006</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_CARD_PROGRAMMING            <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000007</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_CARD_DISCONNECTED           <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000008</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	SD_CARD_ERROR                  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>SDCardState<span class="token punctuation">;</span>

<span class="token comment">//SD卡信息,包括CSD,CID等数据</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
  SD_CSD SD_csd<span class="token punctuation">;</span>
  SD_CID SD_cid<span class="token punctuation">;</span>
  <span class="token keyword">long</span> <span class="token keyword">long</span> CardCapacity<span class="token punctuation">;</span>  	<span class="token comment">//SD卡容量,单位:字节,最大支持2^64字节大小的卡.</span>
  u32 CardBlockSize<span class="token punctuation">;</span> 		<span class="token comment">//SD卡块大小	</span>
  u16 RCA<span class="token punctuation">;</span>					<span class="token comment">//卡相对地址</span>
  u8 CardType<span class="token punctuation">;</span>				<span class="token comment">//卡类型</span>
<span class="token punctuation">}</span> SD_CardInfo<span class="token punctuation">;</span>
<span class="token keyword">extern</span> SD_CardInfo SDCardInfo<span class="token punctuation">;</span><span class="token comment">//SD卡信息			 </span>
<span class="token comment"></span>
<span class="token comment">//SDIO 指令集</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_GO_IDLE_STATE</span>                       <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SEND_OP_COND</span>                        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_ALL_SEND_CID</span>                        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SET_REL_ADDR</span>                        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">3</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; SDIO_SEND_REL_ADDR for SD Card */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SET_DSR</span>                             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SDIO_SEN_OP_COND</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">5</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_HS_SWITCH</span>                           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">6</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SEL_DESEL_CARD</span>                      <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">7</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_HS_SEND_EXT_CSD</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">8</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SEND_CSD</span>                            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">9</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SEND_CID</span>                            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">10</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_READ_DAT_UNTIL_STOP</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">11</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; SD Card doesn't support it */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_STOP_TRANSMISSION</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">12</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SEND_STATUS</span>                         <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">13</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_HS_BUSTEST_READ</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">14</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_GO_INACTIVE_STATE</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">15</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SET_BLOCKLEN</span>                        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">16</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_READ_SINGLE_BLOCK</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">17</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_READ_MULT_BLOCK</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">18</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_HS_BUSTEST_WRITE</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">19</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_WRITE_DAT_UNTIL_STOP</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">20</span><span class="token punctuation">)</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SET_BLOCK_COUNT</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">23</span><span class="token punctuation">)</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_WRITE_SINGLE_BLOCK</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">24</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_WRITE_MULT_BLOCK</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">25</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_PROG_CID</span>                            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">26</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_PROG_CSD</span>                            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">27</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SET_WRITE_PROT</span>                      <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">28</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_CLR_WRITE_PROT</span>                      <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">29</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SEND_WRITE_PROT</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">30</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_ERASE_GRP_START</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">32</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; To set the address of the first write
                                                                  block to be erased. (For SD card only) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_ERASE_GRP_END</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">33</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; To set the address of the last write block of the
                                                                  continuous range to be erased. (For SD card only) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_ERASE_GRP_START</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">35</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; To set the address of the first write block to be erased.
                                                                  (For MMC card only spec 3.31) */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_ERASE_GRP_END</span>                       <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">36</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; To set the address of the last write block of the
                                                                  continuous range to be erased. (For MMC card only spec 3.31) */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_ERASE</span>                               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">38</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_FAST_IO</span>                             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">39</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; SD Card doesn't support it */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_GO_IRQ_STATE</span>                        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">40</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; SD Card doesn't support it */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_LOCK_UNLOCK</span>                         <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">42</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_APP_CMD</span>                             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">55</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_GEN_CMD</span>                             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">56</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_NO_CMD</span>                              <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">64</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/** 
  * @brief Following commands are SD Card Specific commands.
  *        SDIO_APP_CMD ：CMD55 should be sent before sending these commands. 
  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_APP_SD_SET_BUSWIDTH</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">6</span><span class="token punctuation">)</span>  </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_STAUS</span>                        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">13</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_SEND_NUM_WRITE_BLOCKS</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">22</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_OP_COND</span>                      <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">41</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_SET_CLR_CARD_DETECT</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">42</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_SEND_SCR</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">51</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SDIO_RW_DIRECT</span>                      <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">52</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD I/O Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SDIO_RW_EXTENDED</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">53</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD I/O Card only */</span></span>

<span class="token comment">/** 
  * @brief Following commands are SD Card Specific security commands.
  *        SDIO_APP_CMD should be sent before sending these commands. 
  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_GET_MKB</span>                      <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">43</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_GET_MID</span>                      <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">44</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_SET_CER_RN1</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">45</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_GET_CER_RN2</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">46</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_SET_CER_RES2</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">47</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_GET_CER_RES1</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">48</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_SECURE_READ_MULTIPLE_BLOCK</span>   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">18</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_SECURE_WRITE_MULTIPLE_BLOCK</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">25</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_SECURE_ERASE</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">38</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_CHANGE_SECURE_AREA</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">49</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CMD_SD_APP_SECURE_WRITE_MKB</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token number">48</span><span class="token punctuation">)</span> </span><span class="token comment">/*!&lt; For SD Card only */</span></span>
  			   
<span class="token comment">//支持的SD卡定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_STD_CAPACITY_SD_CARD_V1_1</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_STD_CAPACITY_SD_CARD_V2_0</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000001</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_HIGH_CAPACITY_SD_CARD</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000002</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_MULTIMEDIA_CARD</span>                       <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000003</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_SECURE_DIGITAL_IO_CARD</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000004</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_HIGH_SPEED_MULTIMEDIA_CARD</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000005</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_SECURE_DIGITAL_IO_COMBO_CARD</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000006</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_HIGH_CAPACITY_MMC_CARD</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000007</span><span class="token punctuation">)</span></span></span>

<span class="token comment">//SDIO相关参数定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NULL</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_STATIC_FLAGS</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x000005FF</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_CMD0TIMEOUT</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00010000</span><span class="token punctuation">)</span>	  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_DATATIMEOUT</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span>	  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_FIFO_Address</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x40018080</span><span class="token punctuation">)</span></span></span>

<span class="token comment">//Mask for errors Card Status R1 (OCR Register)  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_ADDR_OUT_OF_RANGE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x80000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_ADDR_MISALIGNED</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x40000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_BLOCK_LEN_ERR</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x20000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_ERASE_SEQ_ERR</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x10000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_BAD_ERASE_PARAM</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x08000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_WRITE_PROT_VIOLATION</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x04000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_LOCK_UNLOCK_FAILED</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x01000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_COM_CRC_FAILED</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00800000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_ILLEGAL_CMD</span>              <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00400000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_CARD_ECC_FAILED</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00200000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_CC_ERROR</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00100000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_GENERAL_UNKNOWN_ERROR</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00080000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_STREAM_READ_UNDERRUN</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00040000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_STREAM_WRITE_OVERRUN</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00020000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_CID_CSD_OVERWRIETE</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00010000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_WP_ERASE_SKIP</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00008000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_CARD_ECC_DISABLED</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00004000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_ERASE_RESET</span>              <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00002000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_AKE_SEQ_ERROR</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000008</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_OCR_ERRORBITS</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0xFDFFE008</span><span class="token punctuation">)</span></span></span>

<span class="token comment">//Masks for R6 Response </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_R6_GENERAL_UNKNOWN_ERROR</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00002000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_R6_ILLEGAL_CMD</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00004000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_R6_COM_CRC_FAILED</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00008000</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_VOLTAGE_WINDOW_SD</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x80100000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_HIGH_CAPACITY</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x40000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_STD_CAPACITY</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CHECK_PATTERN</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x000001AA</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_VOLTAGE_WINDOW_MMC</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x80FF8000</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_MAX_VOLT_TRIAL</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x0000FFFF</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_ALLZERO</span>                      <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000000</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_WIDE_BUS_SUPPORT</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00040000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_SINGLE_BUS_SUPPORT</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00010000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CARD_LOCKED</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x02000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CARD_PROGRAMMING</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000007</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CARD_RECEIVING</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000006</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_DATATIMEOUT</span>                  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_0TO7BITS</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_8TO15BITS</span>                    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x0000FF00</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_16TO23BITS</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00FF0000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_24TO31BITS</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_MAX_DATA_LENGTH</span>              <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x01FFFFFF</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_HALFFIFO</span>                     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000008</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_HALFFIFOBYTES</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000020</span><span class="token punctuation">)</span></span></span>

<span class="token comment">//Command Class Supported  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CCCC_LOCK_UNLOCK</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000080</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CCCC_WRITE_PROT</span>              <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000040</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD_CCCC_ERASE</span>                   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000020</span><span class="token punctuation">)</span></span></span>
																	 
<span class="token comment">//CMD8指令</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDIO_SEND_IF_COND</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token number">0x00000008</span><span class="token punctuation">)</span></span></span>
<span class="token comment"></span>
<span class="token comment">//相关函数定义</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SDIO_ClockSet</span><span class="token punctuation">(</span>u8 clkdiv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SDIO_SendCmd</span><span class="token punctuation">(</span>u8 cmdindex<span class="token punctuation">,</span>u8 waitrsp<span class="token punctuation">,</span>u32 arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SDIO_SendDataConfig</span><span class="token punctuation">(</span>u32 datatimeout<span class="token punctuation">,</span>u32 datalen<span class="token punctuation">,</span>u8 blksize<span class="token punctuation">,</span>u8 dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdPowerON</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
SDIO_SD_ERROR_INFO <span class="token function">SD_PowerOFF</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardInitializeCards</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardGetInfo</span><span class="token punctuation">(</span>SD_CardInfo <span class="token operator">*</span>cardinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>		  
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardEnableWideBusOperation</span><span class="token punctuation">(</span>u32 wmode<span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardSetDeviceMode</span><span class="token punctuation">(</span>u32 mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardSelectAddr</span><span class="token punctuation">(</span>u32 addr<span class="token punctuation">)</span><span class="token punctuation">;</span> 
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardSendStatus</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> <span class="token operator">*</span>pcardstatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
SDCardState <span class="token function">SDIO_SdCardGetState</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardReadBlock</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span> addr<span class="token punctuation">,</span>u16 blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>  
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardReadMultiBlocks</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span>  addr<span class="token punctuation">,</span>u16 blksize<span class="token punctuation">,</span>u32 nblks<span class="token punctuation">)</span><span class="token punctuation">;</span>  
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardWriteBlock</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span> addr<span class="token punctuation">,</span>  u16 blksize<span class="token punctuation">)</span><span class="token punctuation">;</span>	
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardWriteMultiBlocks</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span> addr<span class="token punctuation">,</span>u16 blksize<span class="token punctuation">,</span>u32 nblks<span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardProcessIRQSrc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdErrorCheck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp7Error</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp1Error</span><span class="token punctuation">(</span>u8 cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp3Error</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp2Error</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SDIO_SD_ERROR_INFO <span class="token function">SDIO_CmdResp6Error</span><span class="token punctuation">(</span>u8 cmd<span class="token punctuation">,</span>u16<span class="token operator">*</span>prca<span class="token punctuation">)</span><span class="token punctuation">;</span>  
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardEnWideBus</span><span class="token punctuation">(</span>u8 enx<span class="token punctuation">)</span><span class="token punctuation">;</span>	  
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardProgrammingState</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pstatus<span class="token punctuation">)</span><span class="token punctuation">;</span> 
SDIO_SD_ERROR_INFO <span class="token function">SDIO_SdCardFindSCR</span><span class="token punctuation">(</span>u16 rca<span class="token punctuation">,</span>u32 <span class="token operator">*</span>pscr<span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">convert_from_bytes_to_power_of_two</span><span class="token punctuation">(</span>u16 NumberOfBytes<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">void</span> <span class="token function">SDIO_SdCard_DMAConfig</span><span class="token punctuation">(</span>u32<span class="token operator">*</span>mbuf<span class="token punctuation">,</span>u32 bufsize<span class="token punctuation">,</span>u8 dir<span class="token punctuation">)</span><span class="token punctuation">;</span> 
u8 <span class="token function">SDIO_SdCardReadDiskSector</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u32 sector<span class="token punctuation">,</span>u8 cnt<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//读SD卡,fatfs/usb调用</span>
u8 <span class="token function">SDIO_SdCardWriteDiskSector</span><span class="token punctuation">(</span>u8<span class="token operator">*</span>buf<span class="token punctuation">,</span>u32 sector<span class="token punctuation">,</span>u8 cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//写SD卡,fatfs/usb调用</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="FATFS_2407"></a>四、移植FATFS文件系统</h3> 
<p>前面第3章，完成了SD NAND的驱动代码编写，这一章节实现FATFS文件的移植。</p> 
<h4><a id="41_FATFS_2411"></a>4.1 FATFS文件系统介绍</h4> 
<h5><a id="1_2413"></a>（1）介绍</h5> 
<p>FatFs 是一种完全免费开源的 FAT 文件系统模块，专门为小型的嵌入式系统而设计。它完全用标准C 语言编写，所以具有良好的硬件平台独立性，可以移植到 8051、 PIC、 AVR、 SH、 Z80、 H8、 ARM 等系列单片机上而只需做简单的修改。它支持 FATl2、 FATl6 和 FAT32，支持多个存储媒介；有独立的缓冲区，可以对多个文件进行读／写，并特别对 8 位单片机和 16 位单片机做了优化。</p> 
<h5><a id="2_2417"></a>（2）特点</h5> 
<p>【1】Windows兼容的FAT文件系统<br> 【2】不依赖于平台，易于移植<br> 【3】代码和工作区占用空间非常小<br> 【4】多种配置选项<br> 【5】多卷(物理驱动器和分区)<br> 【6】多ANSI/OEM代码页，包括DBCS<br> 【7】在ANSI/OEM或Unicode中长文件名的支持<br> 【8】RTOS的支持<br> 【9】多扇区大小的支持<br> 【10】只读，最少API，I/O缓冲区等等</p> 
<h5><a id="3_2430"></a>（3）移植性</h5> 
<p>fatfs模块是ANSI C(C89)编写的。 没有平台的依赖, 编译器只要符合ANSI C标准就可以编译。</p> 
<p>fatf模块假设大小的字符/短/长8/16/32位和int是16或32位。 这些数据类型在integer.h文件中定义。这些数据类型在大多数的编译器中定义都符合要求。 如果现有的定义与编译器有任何冲突发生时，需要自己解决。</p> 
<h4><a id="42__2438"></a>4.2 下载源码</h4> 
<p>下载地址：http://elm-chan.org/fsw/ff/00index_e.html</p> 
<p><img src="https://images2.imgbox.com/de/88/cdpMEnu8_o.png" alt="image-20221201191123204"></p> 
<p>FATFS有两个版本，一个大版本，一个小版本。小版本主要用于8位机(内存小)使用。</p> 
<p>下载图：</p> 
<p><img src="https://images2.imgbox.com/25/34/zaX3h4Ts_o.png" alt="image-20221201191144911"></p> 
<h4><a id="43__2452"></a>4.3 源码结构介绍</h4> 
<p>将下载的源码解压后可以得到两个文件夹： doc 和 src。 doc 里面主要是对 FATFS 的介绍(离线文档—英文和日文)，而 src 里面才是我们需要的源码。</p> 
<p>其中，与平台无关的是：</p> 
<pre><code class="prism language-cpp">ffconf<span class="token punctuation">.</span>h     FATFS配置文件
ff<span class="token punctuation">.</span>h        应用层头文件
ff<span class="token punctuation">.</span>c        应用层源文件
diskio<span class="token punctuation">.</span>h    硬件层头文件
interger<span class="token punctuation">.</span>h  数据类型定义头文件
option      可选的外部功能（比如支持中文等）
</code></pre> 
<p><strong>与平台相关的代码：</strong></p> 
<pre><code class="prism language-cpp">diskio<span class="token punctuation">.</span>c     底层接口文件（需要用户提供）
</code></pre> 
<p>FATFS 模块在移植的时候，我们一般只需要修改 2 个文件，即 ffconf.h 和 diskio.c。</p> 
<p>FATFS模块的所有配置项都是存放在 ffconf.h 里面，我们可以通过配置里面的一些选项，来满足自己的需求。</p> 
<p><img src="https://images2.imgbox.com/a7/07/JGeyA8q7_o.png" alt="image-20221201191424011"></p> 
<p>最顶层是应用层，使用者无需理会 FATFS 的内部结构和复杂的 FAT 协议，只需要调用FATFS 模块提供给用户的一系列应用接口函数，如 f_open， f_read， f_write 和 f_close 等，就可以像在 PC 上读写文件那样简单。</p> 
<p>中间层 FATFS 模块， 实现了 FAT 文件读／写协议。 FATFS 模块提供的是 ff.c 和 ff.h。除非有必要，使用者一般不用修改，使用时将头文件直接包含进去即可。</p> 
<p>需要我们编写移植代码的是 FATFS 模块提供的底层接口，它包括存储媒介读／写接口 （ disk、I/O） 和供给文件创建修改时间的实时时钟。</p> 
<h4><a id="44__2487"></a>4.4 下载源码并加入到工程</h4> 
<p>先准备好一个有SD NAND驱动代码的STM32工程（代码前面第3章已经贴了），接着就完成下面的步骤。</p> 
<p><img src="https://images2.imgbox.com/a5/ac/x1rNMcHL_o.png" alt="image-20221201191530152"></p> 
<p>打开KEIL工程，添加FATFS文件源码：</p> 
<p><img src="https://images2.imgbox.com/a5/f2/AY4og8R1_o.png" alt="image-20221201191606087"></p> 
<p><img src="https://images2.imgbox.com/91/89/tmMmOsTS_o.png" alt="image-20221201191619365"></p> 
<p>加入.h文件主要是方便配。cc936.c 用于支持中文。</p> 
<h4><a id="45__2503"></a>4.5 修改代码进行移植</h4> 
<h5><a id="1diskioc_2505"></a>（1）修改diskio.c文件</h5> 
<p><img src="https://images2.imgbox.com/f2/6f/4txJq3pD_o.png" alt="image-20221201191824668"></p> 
<p>注释掉现在不需要的用到的文件，因为我们现在用的是SD卡，与USB，ATA，MMC卡没关系。</p> 
<p>并加入一个新的宏 :</p> 
<p><code>#define SD 0 </code></p> 
<p>定义SD卡的物理驱动器号为0。</p> 
<p>修改 disk_status函数，该函数主要是用来获取磁盘状态。现在未用到，可以直接函数体内代码删除。</p> 
<p><strong>修改截图：</strong></p> 
<p><img src="https://images2.imgbox.com/d2/f5/3qssl1i2_o.png" alt="image-20221201191925588"></p> 
<p><strong>代码示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"diskio.h"</span>		  <span class="token comment">/* fatf底层API */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sd.h"</span>		      <span class="token comment">/* SD卡驱动头文件  */</span></span>
<span class="token comment">/* 定义每个驱动器的物理驱动器号*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SD</span>    <span class="token expression"><span class="token number">0</span></span></span>

<span class="token comment">/*-----------------------------------------------------------------------*/</span>
<span class="token comment">/* 获取设备(磁盘)状态                                                     */</span>
<span class="token comment">/*-----------------------------------------------------------------------*/</span>

DSTATUS <span class="token function">disk_status</span> <span class="token punctuation">(</span>
	BYTE pdrv		<span class="token comment">/* 物理驱动识别 */</span>
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//该函数现在无需用到，直接返回0</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>修改disk_initialize函数，添加SD卡的初始化，其他不用到的代码直接删掉，该函数成功返回0，失败返回1。</p> 
<p>修改截图：</p> 
<p><img src="https://images2.imgbox.com/78/34/KmV1LFHR_o.png" alt="image-20221201192033155"></p> 
<p><strong>代码示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">/*-----------------------------------------------------------------------*/</span>
<span class="token comment">/* 初始化磁盘驱动                                                        */</span>
<span class="token comment">/*-----------------------------------------------------------------------*/</span>

DSTATUS <span class="token function">disk_initialize</span> <span class="token punctuation">(</span>
	BYTE pdrv				<span class="token comment">/* 物理驱动识别 */</span>
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	DSTATUS stat<span class="token punctuation">;</span>
	<span class="token keyword">int</span> result<span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>pdrv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> SD <span class="token operator">:</span>            <span class="token comment">//选择SD卡</span>
		stat<span class="token operator">=</span><span class="token function">SD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//初始化SD卡-用户自己提供</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token keyword">return</span> STA_NOINIT<span class="token punctuation">;</span>  <span class="token comment">//磁盘未初始化</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//初始化成功</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>修改disk_read函数，加入SD卡读任意扇区的函数(需要用户自己提供)，其他不用到的选项可以删掉。</p> 
<p><img src="https://images2.imgbox.com/ba/82/XnakZ3o8_o.png" alt="image-20221201192136957"></p> 
<p><strong>修改代码如下：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">/*-----------------------------------------------------------------------*/</span>
<span class="token comment">/* 读扇区                                                                */</span>
<span class="token comment">/*-----------------------------------------------------------------------*/</span>
DRESULT <span class="token function">disk_read</span> <span class="token punctuation">(</span>
	BYTE pdrv<span class="token punctuation">,</span>		<span class="token comment">/* 物理驱动编号 - 范围0-9*/</span>
	BYTE <span class="token operator">*</span>buff<span class="token punctuation">,</span>		<span class="token comment">/* 数据缓冲区存储读取数据 */</span>
	DWORD sector<span class="token punctuation">,</span>  	<span class="token comment">/* 扇区地址*/</span>
	UINT count		<span class="token comment">/* 需要读取的扇区数*/</span>
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	DRESULT res<span class="token punctuation">;</span>
	<span class="token keyword">int</span> result<span class="token punctuation">;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>pdrv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> SD<span class="token operator">:</span>
		  res<span class="token operator">=</span><span class="token function">SD_Read_Data</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>buff<span class="token punctuation">,</span>sector<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//读SD扇区函数--用户提供</span>
		  <span class="token keyword">return</span> res<span class="token punctuation">;</span> <span class="token comment">//在此处可以判错误</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> RES_PARERR<span class="token punctuation">;</span>  <span class="token comment">//无效参数</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>修改disk_write 函数，添加写扇区函数：</p> 
<p><img src="https://images2.imgbox.com/51/ac/OGvs92b7_o.png" alt="image-20221201192230352"></p> 
<p>代码：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*-----------------------------------------------------------------------*/</span>
<span class="token comment">/* 写扇区                                                                */</span>
<span class="token comment">/*-----------------------------------------------------------------------*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_USE_WRITE</span></span>
DRESULT <span class="token function">disk_write</span> <span class="token punctuation">(</span>
	BYTE pdrv<span class="token punctuation">,</span>			  <span class="token comment">/* 物理驱动号*/</span>
	<span class="token keyword">const</span> BYTE <span class="token operator">*</span>buff<span class="token punctuation">,</span>	       <span class="token comment">/* 要写入数据的首地址 */</span>
	DWORD sector<span class="token punctuation">,</span>		   <span class="token comment">/* 扇区地址 */</span>
	UINT count			   <span class="token comment">/* 扇区数量*/</span>
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	DRESULT res<span class="token punctuation">;</span>
	<span class="token keyword">int</span> result<span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>pdrv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> SD<span class="token operator">:</span>
			res<span class="token operator">=</span><span class="token function">SD_Write_Data</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>buff<span class="token punctuation">,</span>sector<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写入扇区</span>
		  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> RES_PARERR<span class="token punctuation">;</span>  <span class="token comment">//无效参数</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>修改disk_ioctl 函数，填充ioctl命令功能。这些功能是标准的命令，在diskio.h有定义。</p> 
<p><img src="https://images2.imgbox.com/76/f1/bBQo8Jps_o.png" alt="image-20221201192311549"></p> 
<p>代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*-----------------------------------------------------------------------*/</span>
<span class="token comment">/* 其他函数                                              */</span>
<span class="token comment">/*-----------------------------------------------------------------------*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_USE_IOCTL</span></span>
DRESULT <span class="token function">disk_ioctl</span> <span class="token punctuation">(</span>
	BYTE pdrv<span class="token punctuation">,</span>		<span class="token comment">/* 物理驱动号 */</span>
	BYTE cmd<span class="token punctuation">,</span>		  <span class="token comment">/* 控制码  */</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>buff		<span class="token comment">/* 发送/接收数据缓冲区地址 */</span>
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	DRESULT res<span class="token punctuation">;</span>
	<span class="token keyword">int</span> result<span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>pdrv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> SD<span class="token operator">:</span>
			 <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
			 <span class="token punctuation">{<!-- --></span>
				 <span class="token keyword">case</span> CTRL_SYNC<span class="token operator">:</span>      <span class="token comment">//等待写过程</span>
					 <span class="token function">SD_CS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//选中SD卡</span>
					 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SD_Wait_Ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>result <span class="token operator">=</span> RES_ERROR<span class="token punctuation">;</span><span class="token comment">/*等待卡准备好*/</span>
				     <span class="token keyword">else</span> res <span class="token operator">=</span> RES_OK<span class="token punctuation">;</span>     <span class="token comment">//成功</span>
					 <span class="token function">SD_CS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//释放SD卡</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>	 
				 
			 <span class="token keyword">case</span> GET_SECTOR_SIZE<span class="token operator">:</span><span class="token comment">//获取扇区大小</span>
			   <span class="token operator">*</span><span class="token punctuation">(</span>DWORD<span class="token operator">*</span><span class="token punctuation">)</span>buff <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span> 
		        res <span class="token operator">=</span> RES_OK<span class="token punctuation">;</span>     <span class="token comment">//成功</span>
		        <span class="token keyword">break</span><span class="token punctuation">;</span>	
				 
			 <span class="token keyword">case</span> GET_BLOCK_SIZE<span class="token operator">:</span>    <span class="token comment">//获取块大小</span>
				<span class="token operator">*</span><span class="token punctuation">(</span>WORD<span class="token operator">*</span><span class="token punctuation">)</span>buff <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>      <span class="token comment">//块大小(扇区为单位)，一块等于8个扇区</span>
		         res <span class="token operator">=</span> RES_OK<span class="token punctuation">;</span>
		         <span class="token keyword">break</span><span class="token punctuation">;</span>
				 
			 <span class="token keyword">case</span> GET_SECTOR_COUNT<span class="token operator">:</span> <span class="token comment">//获取总扇区数量</span>
		        <span class="token operator">*</span><span class="token punctuation">(</span>DWORD<span class="token operator">*</span><span class="token punctuation">)</span>buff <span class="token operator">=</span> <span class="token function">SD_Get_Sector_Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		        res <span class="token operator">=</span> RES_OK<span class="token punctuation">;</span>
		        <span class="token keyword">break</span><span class="token punctuation">;</span>
				 
			<span class="token keyword">default</span><span class="token operator">:</span>  <span class="token comment">//命令错误</span>
		        res <span class="token operator">=</span> RES_PARERR<span class="token punctuation">;</span>
		        <span class="token keyword">break</span><span class="token punctuation">;</span>
			 <span class="token punctuation">}</span>
		<span class="token keyword">return</span> res<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> RES_PARERR<span class="token punctuation">;</span>  <span class="token comment">//返回状态</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="2ffconfh_2693"></a>（2）修改ffconf.h文件</h5> 
<p><strong>需要注意的一些宏配置：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CODE_PAGE</span>	<span class="token expression"><span class="token number">936</span>   </span><span class="token comment">//采用中文GBK编码       (64行)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_USE_LFN</span>	<span class="token expression"><span class="token number">3</span>     </span><span class="token comment">//动态的堆上工作             （93行）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_MAX_LFN</span>	<span class="token expression"><span class="token number">255</span>   </span><span class="token comment">/*_USE_LFN选项开关LFN(长文件名)特性。
#define _VOLUMES	1     /* 支持的磁盘数量(逻辑驱动器)。 */</span>   <span class="token expression"><span class="token punctuation">(</span><span class="token number">142</span>行<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_MIN_SS</span>		<span class="token expression"><span class="token number">512</span>                                  <span class="token punctuation">(</span><span class="token number">165</span>行<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_MAX_SS</span>		<span class="token expression"><span class="token number">512</span>   </span><span class="token comment">/*这些选项配置支持扇区大小的范围。(512,1024, 4096*/</span>　</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FS_NORTC</span>	    <span class="token expression"><span class="token number">0</span>    </span><span class="token comment">/*启用RTC时间功能*/</span>   <span class="token expression"><span class="token punctuation">(</span><span class="token number">202</span>行<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_NORTC_MON</span>	    <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_NORTC_MDAY</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_NORTC_YEAR</span>	<span class="token expression"><span class="token number">2015</span> </span><span class="token comment">//年  </span></span>
<span class="token comment">/*需要实现：get_fattime()函数*/</span>
</code></pre> 
<p><strong>ffconf.h 文件源码：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">/*---------------------------------------------------------------------------/
/  FatFs - FAT文件系统模块配置文件  R0.11a (C)ChaN, 2015
/---------------------------------------------------------------------------*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FFCONF</span> <span class="token expression"><span class="token number">64180</span>	</span><span class="token comment">/* 版本识别*/</span></span>

<span class="token comment">/*---------------------------------------------------------------------------/
/ 功能配置
/---------------------------------------------------------------------------*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FS_READONLY</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/* 这个选项开关只读配置。(0:读/写或1:只读) 　　
/只读配置删除编写API函数,f_write(),f_sync(), 　　
/ f_unlink(),f_mkdir(),f_chmod(),f_rename(),f_truncate(),f_getfree() 　　
/写和可选的功能. */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FS_MINIMIZE</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/*此选项定义删除一些基本的API函数极小化水平。　　
/ 　　
/ 0:所有基本功能都是激活的。　　
/ 1:f_stat(),f_getfree(),f_unlink(),f_mkdir(),f_chmod(),f_utime(), 　　
/ f_truncate()和f_rename()函数删除。　　
/ 2:f_opendir(),f_readdir()和f_closedir()中除了1。　　
/ 3:f_lseek()函数删除除了2。*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_USE_STRFUNC</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token comment">/*这个选项开关字符串函数,f_gets(),f_putc(),f_puts()和　
/ f_printf()。　　
/ 　　
/ 0:禁用字符串函数。　　
/ 1:启用没有LF-CRLF转换。　　
/ 2:启用LF-CRLF(回车换行)转换。*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_USE_FIND</span>		<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/*这个选项开关过滤目录读取特性和相关功能, 　　
/ f_findfirst()和f_findnext()。(0:禁用或1:启用)*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_USE_MKFS</span>		<span class="token expression"><span class="token number">1</span></span></span>
<span class="token comment">/* 这个选项开关f_mkfs()函数。(0:禁用或1:启用) */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_USE_FASTSEEK</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token comment">/* 这个选项开关快速寻求功能。(0:禁用或1:启用) */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_USE_LABEL</span>		<span class="token expression"><span class="token number">1</span></span></span>
<span class="token comment">/* 　　磁盘卷标这个选项开关功能,f_getlabel()和f_setlabel()。　　
/(0:禁用或1:启用) */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_USE_FORWARD</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/* 　这个选项开关f_forward()函数。(0:禁用或1:启用) 　　
/启用它,也_FS_TINY需要设置为1. */</span>


<span class="token comment">/*---------------------------------------------------------------------------/
/ 语言环境和名称空间配置
/---------------------------------------------------------------------------*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CODE_PAGE</span>	<span class="token expression"><span class="token number">936</span>  </span><span class="token comment">//采用中文GBK编码</span></span>
<span class="token comment">/*　这个选项指定OEM代码页在目标系统上使用。　　
/不正确的代码页的设置会导致文件打开失败.
/
/   1   - ASCII (没有扩展字符。Non-LFN cfg。只有)
/   437 - U.S.
/   720 - 阿拉伯语
/   737 - 希腊语；
/   771 - 阿富汗
/   775 - 波罗的海
/   850 - 拉丁1
/   852 - 拉丁2
/   855 - 西里尔字母
/   857 - 土耳其语
/   860 - 葡萄牙语
/   861 - 冰岛语
/   862 - 希伯来人
/   863 - 加拿大法语
/   864 - 阿拉伯语
/   865 - 日耳曼民族的
/   866 - 俄语
/   869 - 希腊 2
/   932 - 日本人 (DBCS)
/   936 - 简体中文(DBCS)
/   949 - 韩国人 (DBCS)
/   950 - 繁体中文(DBCS)
*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_USE_LFN</span>	<span class="token expression"><span class="token number">3</span> </span><span class="token comment">//动态的堆上工作</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_MAX_LFN</span>	<span class="token expression"><span class="token number">255</span></span></span>
<span class="token comment">/*_USE_LFN选项开关LFN(长文件名)特性。
/
/ 0:禁用LFN特性。_MAX_LFN没有影响。　　
/ 1:启用LFN BSS静态工作缓冲区。总是不是线程安全的。　　
/ 2:启用LFN与动态缓冲栈上的工作。　　
/ 3:使LFN与动态缓冲区在堆上工作。
/
/  当启用LFN（长文件名）特性,Unicode(选项/ unicode.c)必须处理功能　　
/被添加到项目中。LFN工作缓冲区占用(_MAX_LFN + 1)* 2字节。　　
/当使用堆栈缓冲区,照顾堆栈溢出。当使用堆　　
/工作缓冲区内存,内存管理功能,ff_memalloc()和　　
/ ff_memfree(),必须添加到项目中。 */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_LFN_UNICODE</span>	<span class="token expression"><span class="token number">0</span> </span></span>
<span class="token comment">/* 这个选项开关字符编码的API。(0:ANSI / OEM或1:Unicode) 　　
路径名/使用Unicode字符串,并设置_LFN_UNICODE启用LFN特性　　
/1。这个选项也会影响行为的字符串的I / O功能。
*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_STRF_ENCODE</span>	<span class="token expression"><span class="token number">3</span></span></span>
<span class="token comment">/* 当_LFN(长文件名)_UNICODE是1,这个选项选择文件的字符编码　　
/通过字符串读取/写入I /O功能,f_gets(),f_putc(),f_puts和f_printf().
/
/  0: ANSI/OEM
/  1: UTF-16LE
/  2: UTF-16BE
/  3: UTF-8
/
/ 当_LFN_UNICODE = 0时,该选项没有影响。*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FS_RPATH</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/*　这个选项配置相对路径的功能。　　/ 　　
/ 0:禁用相对路径特性和删除相关功能。　　
/ 1:启用相对路径特性。f_chdir()和f_chdrive()是可用的。　　
/ 2:f_getcwd()函数可用除了1。　　/ 　　
/注意,目录项读通过f_readdir()这个选项。 
*/</span>

<span class="token comment">/*---------------------------------------------------------------------------/
/ 驱动/卷配置
/---------------------------------------------------------------------------*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_VOLUMES</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token comment">/* 支持的磁盘数量(逻辑驱动器)。 */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_STR_VOLUME_ID</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_VOLUME_STRS</span>	<span class="token string">"RAM"</span><span class="token expression"><span class="token punctuation">,</span></span><span class="token string">"NAND"</span><span class="token expression"><span class="token punctuation">,</span></span><span class="token string">"CF"</span><span class="token expression"><span class="token punctuation">,</span></span><span class="token string">"SD1"</span><span class="token expression"><span class="token punctuation">,</span></span><span class="token string">"SD2"</span><span class="token expression"><span class="token punctuation">,</span></span><span class="token string">"USB1"</span><span class="token expression"><span class="token punctuation">,</span></span><span class="token string">"USB2"</span><span class="token expression"><span class="token punctuation">,</span></span><span class="token string">"USB3"</span></span>
<span class="token comment">/* STR_VOLUME_ID选项开关卷ID字符串功能。　　
/当_STR_VOLUME_ID设置为1时,也可以使用预先定义的字符串在路径名称/数量。
为每个_VOLUME_STRS定义驱动ID字符串　　
/逻辑驱动器。条目的数量必须等于_VOLUMES。有效字符　　
/驱动ID字符串:a - z和0 - 9。*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_MULTI_PARTITION</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/* 　这个选项开关多分区的特性。在默认情况下(0),每个逻辑驱动器　　
/号绑定到相同的物理驱动器号　　
/物理驱动器将被安装。当启用分区特性(1), 　　
/每个逻辑驱动器号是绑定到任意物理驱动器和分区　　
/中列出VolToPart[]。还f_fdisk()函数可用. */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_MIN_SS</span>		<span class="token expression"><span class="token number">512</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_MAX_SS</span>		<span class="token expression"><span class="token number">512</span></span></span>
<span class="token comment">/* 　这些选项配置支持扇区大小的范围。(512,1024, 　　
/ 2048或4096)总是为大多数系统设置两个512,卡和所有类型的内存　　
/硬盘。但是可能需要更大的值为车载闪存和一些　　
/类型的光学媒体。当_MAX_SS大于_MIN_SS,fatf配置　　
/变量扇区大小和GET_SECTOR_SIZE命令必须执行　　disk_ioctl()函数. */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_USE_TRIM</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/* 这个选项开关ATA-TRIM特性。(0:禁用或1:启用) 　　
/启用削减特性,也应该实现CTRL_TRIM命令　　
/ disk_ioctl()函数。*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FS_NOFSINFO</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/* 　　
如果你需要知道正确的自由空间体积FAT32,设置一些0 　　
/选项,f_getfree()函数在第一次后体积将迫使山　　
/全脂肪扫描。位1控制使用的集群数量分配。　　/ 　　
/ bit0 = 0:使用免费的集群计算FSINFO如果可用。　　
/ bit0 = 1:不相信自由FSINFO集群计算。　　
/ bit1 = 0:最后使用集群可用FSINFO如果数量分配。　　
/ bit1 = 1:不相信最后分配FSINFO集群数量.
*/</span>



<span class="token comment">/*---------------------------------------------------------------------------/
/ 系统配置列表
/---------------------------------------------------------------------------*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_FS_TINY</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/* 这个选项开关小缓冲区配置。(0:正常或1:小) 　　
/小配置,文件对象的大小(FIL)_MAX_SS减少字节。而不是私人部门从文件对象,缓冲了　　
/公共部门缓冲文件系统中的对象(fatf)是用于该文件　　
/数据传输. */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FS_NORTC</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_NORTC_MON</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_NORTC_MDAY</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_NORTC_YEAR</span>	<span class="token expression"><span class="token number">2015</span> </span><span class="token comment">//年</span></span>
<span class="token comment">/* _FS_NORTC选项开关时间戳的特性。如果系统没有/
 RTC函数或不需要有效的时间戳,_FS_NORTC 1设置为禁用/
 时间戳的特性。所有对象修改fatf将有一个固定的时间戳。/
  固定的时间定义为_NORTC_MON _NORTC_MDAY _NORTC_YEAR。　　

/当启用时间戳特性(_FS_NORTC = = 0),需要实现get_fattime()函数。　　/
 添加到项目RTC读当前时间形式。_NORTC_MON, 　　/
_NORTC_MDAY和_NORTC_YEAR没有效果。　　
/这些选项没有影响只读配置(_FS_READONLY = = 1)。 */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_FS_LOCK</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/* 　_FS_LOCK选项开关控制复制的文件打开的文件锁定功能　　
/和非法操作打开对象。这个选项_FS_READONLY时必须是0 　　
/是1。　　/ 　　
/ 0:禁用文件锁定功能。为了避免体积腐败、应用程序　　
/应该避免非法打开,删除和重命名的开放对象。　　
/ &gt; 0:启用文件锁定功能。值定义了多少文件/子目录　　
可以同时打开的/文件锁的控制之下。注意,这个文件独立于re-entrancy /锁功能。 */</span>



<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FS_REENTRANT</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FS_TIMEOUT</span>		<span class="token expression"><span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">_SYNC_t</span>			<span class="token expression">HANDLE</span></span>
<span class="token comment">/* 　_FS_REENTRANT选项开关re-entrancy fatf的(线程安全) 　　
/模块本身。注意,不管这个选项,文件访问不同　　
/体积始终是凹角和音量控制功能,f_mount(),f_mkfs() 　　
/和f_fdisk()函数,总是不凹角。只有文件/目录的访问　　
/相同的体积是这个功能的控制。　　
/ 　　
/ 0:禁用re-entrancy。_FS_TIMEOUT和_SYNC_t没有效果。　　
/ 1:启用re-entrancy。还提供用户同步处理程序, 　　
/ ff_req_grant(),ff_rel_grant(),ff_del_syncobj()和ff_cre_syncobj() 　　
/函数,必须添加到项目中。样品中可用　　
/选项
/ syscall.c。
/
/  _FS_TIMEOUT定义超时时间单位的滴答声。　　
/ _SYNC_t定义了O 
/ S依赖同步对象类型。例如处理、ID、OS_EVENT * 　　
/ SemaphoreHandle_t等. .O / S的头文件定义需要　　
/包括在ff.c的范围。 */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_WORD_ACCESS</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/* _WORD_ACCESS选项是一个只有依赖于平台的选择。
它定义了这个词/访问方法是用来体积上的数据。
/
/ 0:逐字节的访问。总是兼容所有平台。　　
/ 1:词的访问。不要选择这个,除非在下列条件。　　
/ 　　
/ *地址对齐内存访问总是允许所有指令。　　
/ *字节顺序的记忆是低位优先。　　
/ 　　
/如果是这样的情况,_WORD_ACCESS也可以减少代码的大小设置为1。　　
/下表显示允许设置某种类型的处理器。
/
/  ARM7TDMI   0   *2          ColdFire   0    *1         V850E      0    *2
/  Cortex-M3  0   *3          Z80        0/1             V850ES     0/1
/  Cortex-M0  0   *2          x86        0/1             TLCS-870   0/1
/  AVR        0/1             RX600(LE)  0/1             TLCS-900   0/1
/  AVR32      0   *1          RL78       0    *2         R32C       0    *2
/  PIC18      0/1             SH-2       0    *1         M16C       0/1
/  PIC24      0   *2          H8S        0    *1         MSP430     0    *2
/  PIC32      0   *1          H8/300H    0    *1         8051       0/1
/
/  　
* 1:高位优先。　　/ 
* 2:不支持不连续的内存访问。　　/ 
* 3:一些编译器生成LDM(逻辑磁盘管理器 ) / STM mem_cpy(内存拷贝)函数。
*/</span>
</code></pre> 
<h5><a id="3_2993"></a>（3）实现动态内存分配函数与时间函数</h5> 
<p>ff.h文件有动态内存的释放，动态内存申请，时间获取函数接口。</p> 
<p><img src="https://images2.imgbox.com/17/89/0yWZeM1Q_o.png" alt="image-20221201192603132"></p> 
<p>在diskio.c文件实现函数功能：</p> 
<p><img src="https://images2.imgbox.com/c6/7b/pHIblGBR_o.png" alt="image-20221201192626227"></p> 
<p><strong>代码实现如下：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">//动态内存分配</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">ff_memalloc</span> <span class="token punctuation">(</span>UINT msize<span class="token punctuation">)</span>			    <span class="token comment">/* 分配内存块 */</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>msize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//分配空间</span>
<span class="token punctuation">}</span>


<span class="token comment">//动态内存释放</span>
<span class="token keyword">void</span> <span class="token function">ff_memfree</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> mblock<span class="token punctuation">)</span>			    <span class="token comment">/* 空闲内存块 */</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">free</span><span class="token punctuation">(</span>mblock<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//释放空间</span>
<span class="token punctuation">}</span>


<span class="token comment">//返回FATFS时间</span>
<span class="token comment">//获得时间  </span>
DWORD <span class="token function">get_fattime</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token comment">//Get_RTC_Timer(); //获取一次RTC时间</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>RTC_Timer<span class="token punctuation">.</span>year<span class="token operator">-</span><span class="token number">1980</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">25</span><span class="token operator">|</span>   <span class="token comment">//年</span>
			  RTC_Timer<span class="token punctuation">.</span>month<span class="token operator">&lt;&lt;</span><span class="token number">21</span><span class="token operator">|</span>  <span class="token comment">//月</span>
		       RTC_Timer<span class="token punctuation">.</span>day<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token operator">|</span>    <span class="token comment">//日</span>
		       RTC_Timer<span class="token punctuation">.</span>hour<span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token operator">|</span>   <span class="token comment">//时</span>
		       RTC_Timer<span class="token punctuation">.</span>minute<span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token operator">|</span>  <span class="token comment">//分</span>
		       RTC_Timer<span class="token punctuation">.</span>sec<span class="token punctuation">;</span>        <span class="token comment">//秒</span>
<span class="token punctuation">}</span>



<span class="token comment">/*
Return Value
Currnet local time is returned with packed into a DWORD value. The bit field is as follows:
bit31:25
Year origin from the 1980 (0..127)
bit24:21
Month (1..12)
bit20:16
Day of the month(1..31)
bit15:11
Hour (0..23)
bit10:5
Minute (0..59)
bit4:0
Second / 2 (0..29)
*/</span>
</code></pre> 
<h5><a id="4_3055"></a>（4）修改堆栈空间</h5> 
<p>完成了上述的修改，还需要修改堆栈空间，因为长文件支持需要占用堆空间。</p> 
<p>修改STM32启动文件如下：</p> 
<p><img src="https://images2.imgbox.com/61/fb/AmUN82Ze_o.png" alt="image-20221201192757035"></p> 
<h5><a id="5_3065"></a>（5）编译工程测试</h5> 
<p>修改完毕之后，给开发板插上SD卡，调用API函数在SD卡创建一个文件，并写入数据，测试是否成功：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ff.h"</span></span>
FATFS fs<span class="token punctuation">;</span>  <span class="token comment">// 用户定义的文件系统结构体</span>
FIL  file<span class="token punctuation">;</span>  <span class="token comment">// 用户定义的文件系统结构体</span>
u8 buff<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"123 知识！！"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 data<span class="token punctuation">;</span>                <span class="token comment">//检测SD卡容量</span>
	u8 i<span class="token punctuation">,</span>res<span class="token punctuation">;</span>
    <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//LED灯初始化</span>
    <span class="token function">Delay_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">USART1_Init</span><span class="token punctuation">(</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">USART2_Init</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">FLASH_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">Set_Font_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//字库地址初始化</span>
	  <span class="token function">FSMC_SRAM_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">RTC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//RTC时钟初始化</span>
	  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">SD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//检测不到SD卡,SD相关硬件初始化</span>
		<span class="token punctuation">{<!-- --></span>
			i<span class="token operator">=</span><span class="token operator">!</span>i<span class="token punctuation">;</span>
			<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"SD Card Error!  Please Check SD Card!!"</span><span class="token punctuation">,</span><span class="token number">0xf800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					
			<span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">LED1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment">//DS0闪烁</span>
		<span class="token punctuation">}</span>
		
       <span class="token function">f_mount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fs<span class="token punctuation">,</span><span class="token string">"0"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 注册工作区，驱动器号 0，初始化后其他函数可使用里面的参数</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"注册工作区！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">f_mkfs</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//格式化SD卡</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"格式化失败！！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"格式化成功！！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		res <span class="token operator">=</span> <span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>file<span class="token punctuation">,</span> <span class="token string">"/file.c"</span><span class="token punctuation">,</span> FA_OPEN_ALWAYS <span class="token operator">|</span> FA_READ <span class="token operator">|</span> FA_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件创建成功！！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件创建失败！！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		res <span class="token operator">=</span><span class="token function">f_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>file<span class="token punctuation">,</span>buff<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buff<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"数据写入成功！！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"数据写入失败！！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"成功写入%d字节数据\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">f_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//关闭文件</span>
		<span class="token comment">//_FS_RPATH</span>
		
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">LED1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">LED1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_3143"></a>五、案例使用</h3> 
<h4><a id="51_GBKLCD_3145"></a>5.1 读取GBK字库文件(LCD汉字显示)</h4> 
<p>产品开发中，如果设备带有LCD显示屏，一般会显示各种文字提示，或者机器操作说明，显示中文需要字库，为了方便字模的提取，可以将字库文件制作好之后放到SD NAND上，通过文件系统打开字库文件，读取字模进行显示。</p> 
<p>下面贴出文件系统读取字模的核心代码：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
函数功能: 显示GBK字库数据
          u32 x  范围0~319
          u32 y  范围0~479
          u32 size  数据的宽度(必须是8的倍数)  是正方形
          u8 *p  中文
说明: 取模横向坐标必须保证是8的倍数
*/</span>

<span class="token keyword">void</span> <span class="token function">ILI9341_DisplayGBKData</span><span class="token punctuation">(</span>u32 x<span class="token punctuation">,</span>u32 y<span class="token punctuation">,</span>u32 size<span class="token punctuation">,</span>u8 <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		FIL fp<span class="token punctuation">;</span>
		UINT br<span class="token punctuation">;</span>
		u8 L<span class="token punctuation">,</span>H<span class="token punctuation">;</span>
	  u32 Addr<span class="token punctuation">;</span>
	  u16 font_size<span class="token operator">=</span>size<span class="token operator">/</span><span class="token number">8</span><span class="token operator">*</span>size<span class="token punctuation">;</span> <span class="token comment">//字体占用的点阵码字节大小</span>
	  u8 <span class="token operator">*</span>buff<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
		H<span class="token operator">=</span><span class="token operator">*</span>p<span class="token punctuation">;</span>
		L<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>L<span class="token operator">&lt;</span><span class="token number">0x7f</span><span class="token punctuation">)</span>L<span class="token operator">=</span>L<span class="token operator">-</span><span class="token number">0x40</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> L<span class="token operator">=</span>L<span class="token operator">-</span><span class="token number">0x41</span><span class="token punctuation">;</span>
		H<span class="token operator">=</span>H<span class="token operator">-</span><span class="token number">0x81</span><span class="token punctuation">;</span>
		Addr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">190</span><span class="token operator">*</span>H<span class="token operator">+</span>L<span class="token punctuation">)</span><span class="token operator">*</span>font_size<span class="token punctuation">;</span> <span class="token comment">//中文在字库里的偏移量</span>
		buff<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span>font_size<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//使用的堆空间</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>buff<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>

		<span class="token keyword">switch</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> <span class="token number">16</span><span class="token operator">:</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">,</span><span class="token string">"0:/font/gbk16.DZK"</span><span class="token punctuation">,</span>FA_READ<span class="token punctuation">)</span><span class="token operator">!=</span>FR_OK<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"f_open error.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
				<span class="token function">f_lseek</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">,</span>Addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">f_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>font_size<span class="token punctuation">,</span><span class="token operator">&amp;</span>br<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">f_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
               
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">24</span><span class="token operator">:</span>
                <span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">,</span><span class="token string">"0:/font/gbk24.DZK"</span><span class="token punctuation">,</span>FA_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">f_lseek</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">,</span>Addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">f_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>font_size<span class="token punctuation">,</span><span class="token operator">&amp;</span>br<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">f_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">32</span><span class="token operator">:</span>
				
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//显示中文</span>
		<span class="token function">ILI9341_DisplayData</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>size<span class="token punctuation">,</span>size<span class="token punctuation">,</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//释放空间</span>
		<span class="token function">free</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>这是读取字模，显示的效果：</strong></p> 
<p><img src="https://images2.imgbox.com/cf/c4/E7OphoRF_o.png" alt="image-20221201194230582"></p> 
<h4><a id="52_MP3_3218"></a>5.2 读取MP3文件播放(开机音乐)</h4> 
<p>这个例子是演示文件系统的目录扫描函数使用方式，读取指定目录下的MP3文件进行播放。</p> 
<pre><code class="prism language-cpp">u8 <span class="token function">PlayerMP3</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
FATFS FatFs<span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">BEEP_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">KeyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">USARTx_Init</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  
  <span class="token function">SDCardDeviceInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化SD卡</span>
  
<span class="token comment">//  res=f_mkfs("0:",FM_ANY,0,work,sizeof work);</span>
<span class="token comment">//  if(res)printf("格式化失败!\n");</span>
<span class="token comment">//  else printf("格式化成功!\n");</span>
  <span class="token function">f_mount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>FatFs<span class="token punctuation">,</span> <span class="token string">"0:"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//注册工作区</span>
  
  <span class="token function">PlayerMP3</span><span class="token punctuation">(</span><span class="token string">"0:/MP3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
    <span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LED0<span class="token operator">=</span><span class="token operator">!</span>LED0<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 扫描目录mp3播放
0表示成功 1表示失败
*/</span>
u8 <span class="token function">PlayerMP3</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    DIR dir<span class="token punctuation">;</span>
    FRESULT res<span class="token punctuation">;</span> 
    FILINFO fno<span class="token punctuation">;</span> <span class="token comment">//存放读取的文件信息</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>abs_path<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>  
    
    <span class="token comment">/*1. 打开目录*/</span>    
    res<span class="token operator">=</span><span class="token function">f_opendir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dir<span class="token punctuation">,</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">!=</span>FR_OK<span class="token punctuation">)</span><span class="token keyword">return</span> res<span class="token punctuation">;</span>
    
    <span class="token comment">/*2. 循环读取目录*/</span>
     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
        res<span class="token operator">=</span><span class="token function">f_readdir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dir<span class="token punctuation">,</span><span class="token operator">&amp;</span>fno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> res<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件名称: %s,文件大小: %ld 字节\r\n"</span><span class="token punctuation">,</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">,</span>fno<span class="token punctuation">.</span>fsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*过滤目录*/</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">,</span><span class="token string">".mp3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//申请存放文件名称的长度</span>
            abs_path<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">strlen</span><span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>abs_path<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
             
            <span class="token function">strcpy</span><span class="token punctuation">(</span>abs_path<span class="token punctuation">,</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>abs_path<span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>abs_path<span class="token punctuation">,</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"abs_path=%s\n"</span><span class="token punctuation">,</span>abs_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">VS1053_MP3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>abs_path<span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token function">free</span><span class="token punctuation">(</span>abs_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*3. 关闭目录*/</span>
    <span class="token function">f_closedir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d0849985a829886e046991605538327f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">30米分辨率的DEM地形数据——STRM高程数据</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5890797c7abdebb02638848ebe77de6b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">什么是HTTPS证书</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>