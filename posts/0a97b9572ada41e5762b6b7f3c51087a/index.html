<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>openFeign学习笔记(一) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="openFeign学习笔记(一)" />
<meta property="og:description" content="OpenFegin Feign是什么？openFeign是什么？Feign和openFeign有什么区别？环境搭建创建服务提供者创建服务消费者1、添加依赖2、添加注解3、新建openFeign接口4、新建一个Controller调试 openFeign如何传参？1、传递JSON数据2、POJO表单传参3、URL中携带参数4、普通表单参数 超时处理1、设置Ribbon的超时时间2、设置openFeign的超时时间 如何开启日志增强？1、配置类中配置日志级别2、yaml文件中设置接口日志级别3、演示效果 如何替换默认的httpclient？1、添加ApacheHttpClient依赖2、配置文件中开启3、如何验证已经替换成功？ 如何通讯优化？如何熔断降级？1、添加Sentinel依赖2、配置文件中开启sentinel熔断降级3、添加降级回调类4、添加fallback属性 Feign是什么？ Feign旨在使得Java Http客户端变得更容易。Feign集成了Ribbon、RestTemplate实现了负载均衡的执行Http调用，只不过对原有的方式（Ribbon&#43;RestTemplate）进行了封装，开发者不必手动使用RestTemplate调服务，而是定义一个接口，在这个接口中标注一个注解即可完成服务调用，这样更加符合面向接口编程的宗旨，简化了开发。
openFeign是什么？ 简单点来说：OpenFeign是springcloud在Feign的基础上支持了SpringMVC的注解，如@RequestMapping等等。OpenFeign的@FeignClient可以解析SpringMVC的@RequestMapping注解下的接口，并通过动态代理的方式产生实现类，实现类中做负载均衡并调用其他服务。
Feign和openFeign有什么区别？ 环境搭建 注册中心使用Nacos，创建个微服务，分别为服务提供者Produce，服务消费者Consumer。
创建服务提供者 既然是微服务之间的相互调用，那么一定会有服务提供者了，创建openFeign-provider9005，注册进入Nacos中，配置如下：
server: port: 9005 spring: application: ## 指定服务名称，在nacos中的名字 name: openFeign-provider cloud: nacos: discovery: # nacos的服务地址，nacos-server中IP地址:端口号 server-addr: 127.0.0.1:8848 management: endpoints: web: exposure: ## yml文件中存在特殊字符，必须用单引号包含，否则启动报错 include: &#39;*&#39; 注意：此处的spring.application.name指定的名称将会在openFeign接口调用中使用。
创建服务消费者 新建一个模块openFeign-consumer9006作为消费者服务，步骤如下。
1、添加依赖 除了Nacos的注册中心的依赖，还要添加openFeign的依赖，如下：
&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt; &lt;/dependency&gt; 2、添加注解 添加注解@EnableFeignClients开启openFeign功能
@SpringBootApplication @EnableDiscoveryClient @EnableFeignClients public class OpenFeignConsumer9006Application { public static void main(String[] args) { SpringApplication.run(OpenFeignConsumer9006Application.class, args); } } 3、新建openFeign接口 新建一个openFeign接口，使用@FeignClient注解标注，如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0a97b9572ada41e5762b6b7f3c51087a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-12T23:22:46+08:00" />
<meta property="article:modified_time" content="2022-04-12T23:22:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">openFeign学习笔记(一)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>OpenFegin</h4> 
 <ul><li><a href="#Feign_2" rel="nofollow">Feign是什么？</a></li><li><a href="#openFeign_7" rel="nofollow">openFeign是什么？</a></li><li><a href="#FeignopenFeign_10" rel="nofollow">Feign和openFeign有什么区别？</a></li><li><a href="#_13" rel="nofollow">环境搭建</a></li><li><a href="#_18" rel="nofollow">创建服务提供者</a></li><li><a href="#_42" rel="nofollow">创建服务消费者</a></li><li><ul><li><a href="#1_44" rel="nofollow">1、添加依赖</a></li><li><a href="#2_54" rel="nofollow">2、添加注解</a></li><li><a href="#3openFeign_69" rel="nofollow">3、新建openFeign接口</a></li><li><a href="#4Controller_79" rel="nofollow">4、新建一个Controller调试</a></li></ul> 
  </li><li><a href="#openFeign_92" rel="nofollow">openFeign如何传参？</a></li><li><ul><li><a href="#1JSON_93" rel="nofollow">1、传递JSON数据</a></li><li><a href="#2POJO_124" rel="nofollow">2、POJO表单传参</a></li><li><a href="#3URL_154" rel="nofollow">3、URL中携带参数</a></li><li><a href="#4_181" rel="nofollow">4、普通表单参数</a></li></ul> 
  </li><li><a href="#_210" rel="nofollow">超时处理</a></li><li><ul><li><a href="#1Ribbon_238" rel="nofollow">1、设置Ribbon的超时时间</a></li><li><a href="#2openFeign_250" rel="nofollow">2、设置openFeign的超时时间</a></li></ul> 
  </li><li><a href="#_286" rel="nofollow">如何开启日志增强？</a></li><li><ul><li><a href="#1_294" rel="nofollow">1、配置类中配置日志级别</a></li><li><a href="#2yaml_298" rel="nofollow">2、yaml文件中设置接口日志级别</a></li><li><a href="#3_308" rel="nofollow">3、演示效果</a></li></ul> 
  </li><li><a href="#httpclient_313" rel="nofollow">如何替换默认的httpclient？</a></li><li><ul><li><a href="#1ApacheHttpClient_320" rel="nofollow">1、添加ApacheHttpClient依赖</a></li><li><a href="#2_341" rel="nofollow">2、配置文件中开启</a></li><li><a href="#3_352" rel="nofollow">3、如何验证已经替换成功？</a></li></ul> 
  </li><li><a href="#_356" rel="nofollow">如何通讯优化？</a></li><li><a href="#_398" rel="nofollow">如何熔断降级？</a></li><li><ul><li><a href="#1Sentinel_399" rel="nofollow">1、添加Sentinel依赖</a></li><li><a href="#2sentinel_409" rel="nofollow">2、配置文件中开启sentinel熔断降级</a></li><li><a href="#3_417" rel="nofollow">3、添加降级回调类</a></li><li><a href="#4fallback_421" rel="nofollow">4、添加fallback属性</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Feign_2"></a>Feign是什么？</h2> 
<ul><li>Feign旨在使得Java Http客户端变得更容易。</li><li>Feign集成了<strong>Ribbon、RestTemplate</strong>实现了<strong>负载均衡</strong>的执行Http调用，只不过对原有的方式（Ribbon+RestTemplate）进行了封装，开发者不必手动使用RestTemplate调服务，而是定义一个接口，在这个接口中标注一个注解即可完成服务调用，这样更加符合面向接口编程的宗旨，简化了开发。<br> <img src="https://images2.imgbox.com/cf/5a/ebxdwUSp_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="openFeign_7"></a>openFeign是什么？</h2> 
<p>简单点来说：<strong>OpenFeign是springcloud在Feign的基础上支持了SpringMVC的注解</strong>，如<code>@RequestMapping</code>等等。<strong>OpenFeign的@FeignClient可以解析SpringMVC的@RequestMapping注解下的接口，并通过动态代理的方式产生实现类，实现类中做负载均衡并调用其他服务。</strong></p> 
<h2><a id="FeignopenFeign_10"></a>Feign和openFeign有什么区别？</h2> 
<p><img src="https://images2.imgbox.com/24/52/9SS47Pgn_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_13"></a>环境搭建</h2> 
<p><img src="https://images2.imgbox.com/f5/3e/yTQkozDi_o.png" alt="图片: https://uploader.shimo.im/f/q694ywN8WI0H4LAi.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJhdWQiOiJhY2Nlc3NfcmVzb3VyY2UiLCJleHAiOjE2NDk3NzIyMDQsImciOiJtOEFaVmoxRHJFaURQMkFiIiwiaWF0IjoxNjQ5NzcxOTA0LCJ1c2VySWQiOjc0OTQ1MzI3fQ.zF902dDO4rL_norkpluGK8sOLV_O82X-7_gkYAgn3Fo"></p> 
<blockquote> 
 <p>注册中心使用Nacos，创建个微服务，分别为服务提供者Produce，服务消费者Consumer。</p> 
</blockquote> 
<h2><a id="_18"></a>创建服务提供者</h2> 
<p>既然是微服务之间的相互调用，那么一定会有服务提供者了，创建<code>openFeign-provider9005</code>，注册进入<code>Nacos</code>中，配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9005</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment">## 指定服务名称，在nacos中的名字</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> openFeign<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token comment"># nacos的服务地址，nacos-server中IP地址:端口号</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token comment">## yml文件中存在特殊字符，必须用单引号包含，否则启动报错</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'*'</span>
</code></pre> 
<p><strong>注意：此处的<code>spring.application.name</code>指定的名称将会在<code>openFeign</code>接口调用中使用。</strong></p> 
<h2><a id="_42"></a>创建服务消费者</h2> 
<p>新建一个模块<code>openFeign-consumer9006</code>作为消费者服务，步骤如下。</p> 
<h3><a id="1_44"></a>1、添加依赖</h3> 
<p>除了Nacos的注册中心的依赖，还要添加openFeign的依赖，如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="2_54"></a>2、添加注解</h3> 
<p>添加注解<code>@EnableFeignClients</code>开启openFeign功能</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenFeignConsumer9006Application</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OpenFeignConsumer9006Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3openFeign_69"></a>3、新建openFeign接口</h3> 
<p>新建一个openFeign接口，使用<code>@FeignClient</code>注解标注，如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"openFeign-provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OpenFeignService</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：该注解<code>@FeignClient</code>中的<code>value</code>属性指定了<strong>服务提供者在nacos注册中心的服务名</strong>。</p> 
<h3><a id="4Controller_79"></a>4、新建一个Controller调试</h3> 
<p>新建一个controller用来调试接口，直接调用openFeign的接口，如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/openfeign"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenFeignController</span> <span class="token punctuation">{<!-- --></span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p><font color="red"><strong>在使用openFeign远程调用，作为服务提供者provider的一方不需要调加openFeign依赖与在主启动类身上添加@EnableFeignClients注解。</strong></font></p> 
<h2><a id="openFeign_92"></a>openFeign如何传参？</h2> 
<h3><a id="1JSON_93"></a>1、传递JSON数据</h3> 
<p>这个也是接口开发中常用的传参规则，在Spring Boot 中通过<code>@RequestBody</code>标识入参。<br> <strong>provider接口中JSON传参方法如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/openfeign/provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenFeignProviderController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/order2"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">createOrder2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>consumer中openFeign接口中传参代码如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"openFeign-provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OpenFeignService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 参数默认是@RequestBody标注的，这里的@RequestBody可以不填
     * 方法名称任意
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/openfeign/provider/order2"</span><span class="token punctuation">)</span>
    <span class="token class-name">Order</span> <span class="token function">createOrder2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font color="red">注意：openFeign默认的传参方式就是JSON传参（@RequestBody），因此定义接口的时候可以不用@RequestBody注解标注，不过为了规范，一般都填上。</font></p> 
<h3><a id="2POJO_124"></a>2、POJO表单传参</h3> 
<p>这种传参方式也是比较常用，参数使用<strong>POJO</strong>对象接收。<br> <strong>provider服务提供者代码如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/openfeign/provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenFeignProviderController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/order1"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">createOrder1</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>consumer消费者openFeign代码如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"openFeign-provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OpenFeignService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 参数默认是@RequestBody标注的，如果通过POJO表单传参的，使用@SpringQueryMap标注
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/openfeign/provider/order1"</span><span class="token punctuation">)</span>
    <span class="token class-name">Order</span> <span class="token function">createOrder1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@SpringQueryMap</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8c/f8/0pS8ZEq6_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3URL_154"></a>3、URL中携带参数</h3> 
<p>此种方式针对<code>restful</code>方式中的<code>GET</code>请求，也是比较常用请求方式。<br> <strong>provider服务提供者代码如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/openfeign/provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenFeignProviderController</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"accept one msg id="</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>consumer消费者openFeign接口如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"openFeign-provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OpenFeignService</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/openfeign/provider/test/{id}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>使用注解@PathVariable接收url中的占位符</strong>，这种方式很好理解。</p> 
<h3><a id="4_181"></a>4、普通表单参数</h3> 
<p>此种方式传参不建议使用，但是也有很多开发在用。<br> <strong>provider服务提供者代码如下</strong>：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/openfeign/provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenFeignProviderController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/test2"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">MessageFormat</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"accept on msg id={0}，name={1}"</span><span class="token punctuation">,</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>consumer消费者openFeign接口传参如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"openFeign-provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OpenFeignService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 必须要@RequestParam注解标注，且value属性必须填上参数名
     * 方法参数名可以任意，但是@RequestParam注解中的value属性必须和provider中的参数名相同
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/openfeign/provider/test2"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> arg1<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_210"></a>超时处理</h2> 
<p><strong>要理解超时处理，先看一个例子：我将provider服务接口睡眠3秒钟，接口如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/test2"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token class-name">MessageFormat</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"accept on msg id={0}，name={1}"</span><span class="token punctuation">,</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此时，我们调用consumer的openFeign接口返回结果如下图<br> <img src="https://images2.imgbox.com/93/0e/bhRvQ9zZ_o.png" alt="在这里插入图片描述"><br> 明显的看出程序异常了，返回了接口调用超时。</p> 
<p><strong>openFeign其实是有默认的超时时间的，默认分别是连接超时时间10秒、读超时时间60秒</strong>，源码在<code>feign.Request.Options#Options()</code>这个方法中，如下图：<br> <img src="https://images2.imgbox.com/69/a0/v6uaLQU2_o.png" alt="在这里插入图片描述"></p> 
<p>那么问题来了：为什么我只设置了睡眠3秒就报超时呢？<br> 其实<strong>openFeign集成了Ribbon，Ribbon的默认超时连接时间、读超时时间都是是1秒</strong>，源码在<code>org.springframework.cloud.openfeign.ribbon.FeignLoadBalancer#execute()</code>方法中，如下图：<br> <img src="https://images2.imgbox.com/a8/04/wsJ6IO2c_o.png" alt="在这里插入图片描述"><br> <strong>源码大致意思：如果openFeign没有设置对应得超时时间，那么将会采用Ribbon的默认超时时间。</strong></p> 
<p>理解了超时设置的原理，由之产生两种方案也是很明了了，如下：</p> 
<ul><li>设置openFeign的超时时间</li><li>设置Ribbon的超时时间</li></ul> 
<h3><a id="1Ribbon_238"></a>1、设置Ribbon的超时时间</h3> 
<ul><li>不建议使用</li><li>在配置文件中添加如下设置：</li></ul> 
<pre><code class="prism language-yaml"><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token comment"># 值的是建立链接所用的时间，适用于网络状况正常的情况下， 两端链接所用的时间</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token comment"># 指的是建立链接后从服务器读取可用资源所用的时间</span>
  <span class="token key atrule">ConectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre> 
<h3><a id="2openFeign_250"></a>2、设置openFeign的超时时间</h3> 
<p>openFeign设置超时时间非常简单，只需要在配置文件中配置，如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token comment">## default 设置的全局超时时间，指定服务名称可以设置单个服务的超时时间</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre> 
<blockquote> 
 <p>default设置的是全局超时时间，对所有的openFeign接口服务都生效</p> 
</blockquote> 
<p>但是正常的业务逻辑中可能涉及到多个openFeign接口的调用，如下图：<br> <img src="https://images2.imgbox.com/95/95/NeiKmKyZ_o.png" alt="在这里插入图片描述"></p> 
<p><strong>此时我们可以给serviceC这个服务单独配置一个超时时间，配置如下：</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token comment">## default 设置的全局超时时间，指定服务名称可以设置单个服务的超时时间</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
      <span class="token comment">## 为serviceC这个服务单独配置超时时间</span>
      <span class="token key atrule">serviceC</span><span class="token punctuation">:</span>
        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">30000</span>
        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">30000</span>
</code></pre> 
<blockquote> 
 <p>注意：<strong>单个配置的超时时间将会覆盖全局配置。</strong></p> 
</blockquote> 
<h2><a id="_286"></a>如何开启日志增强？</h2> 
<p>openFeign虽然提供了日志增强功能，但是<strong>默认是不显示任何日志的</strong>，不过开发者在调试阶段可以自己配置日志的级别。<br> openFeign的日志级别如下：</p> 
<ul><li><code>NONE</code>：默认的，不显示任何日志;</li><li><code>BASIC</code>：仅记录请求方法、URL、响应状态码及执行时间;</li><li><code>HEADERS</code>：除了BASIC中定义的信息之外，还有请求和响应的头信息;</li><li><code>FULL</code>：除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据。</li></ul> 
<h3><a id="1_294"></a>1、配置类中配置日志级别</h3> 
<p><strong>需要自定义一个配置类，在其中设置日志级别，如下</strong>：<br> <img src="https://images2.imgbox.com/41/18/mqPVcDWf_o.png" alt=""></p> 
<h3><a id="2yaml_298"></a>2、yaml文件中设置接口日志级别</h3> 
<p>只需要在配置文件中调整指定包或者openFeign的接口日志级别，如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">cn.zhu.service</span><span class="token punctuation">:</span> debug
</code></pre> 
<p>这里的<code>cn.zhu.service</code>是<code>openFeign</code>接口所在的<strong>包名</strong>，当然你也可以配置一个特定的openFeign接口。</p> 
<h3><a id="3_308"></a>3、演示效果</h3> 
<p>上述步骤将日志设置成了FULL，此时发出请求，日志效果如下图：<br> <img src="https://images2.imgbox.com/88/28/aRkdqJ9Z_o.png" alt=""><br> 日志中详细的打印出了请求头、请求体的内容。</p> 
<h2><a id="httpclient_313"></a>如何替换默认的httpclient？</h2> 
<p>Feign在默认情况下使用的是JDK原生的<code>URLConnection</code>发送<code>HTTP</code>请求，没有连接池，但是对每个地址会保持一个长连接，即利用<code>HTTP</code>的<code>persistence connection</code>。<br> 在生产环境中，通常不使用默认的<code>http client</code>，通常有如下两种选择：</p> 
<ul><li>使用<strong>ApacheHttpClient</strong></li><li>使用<strong>OkHttp</strong></li></ul> 
<p><strong>那么如何替换掉呢？其实很简单，下面演示使用ApacheHttpClient替换。</strong></p> 
<h3><a id="1ApacheHttpClient_320"></a>1、添加ApacheHttpClient依赖</h3> 
<p><strong>在openFeign接口服务的pom文件添加如下依赖：</strong></p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--     使用Apache HttpClient替换Feign原生httpclient--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>为什么要添加上面的依赖呢？从源码中不难看出，请看<code>org.springframework.cloud.openfeign.FeignAutoConfiguration.HttpClientFeignConfiguration</code>这个类，代码如下：<br> <img src="https://images2.imgbox.com/1e/ad/AWTPgwVu_o.png" alt="在这里插入图片描述"></p> 
<p>上述红色框中的生成条件，其中的<code>@ConditionalOnClass(ApacheHttpClient.class)</code>，必须要有<code>ApacheHttpClient</code>这个类才会生效，并且<code>feign.httpclient.enabled</code>这个配置要设置为<code>true</code>。</p> 
<h3><a id="2_341"></a>2、配置文件中开启</h3> 
<p>在配置文件中要配置开启，代码如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
      <span class="token comment"># 开启 Http Client</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<h3><a id="3_352"></a>3、如何验证已经替换成功？</h3> 
<p>其实很简单，在<code>feign.SynchronousMethodHandler#executeAndDecode()</code>这个方法中可以清楚的看出调用哪个<code>client</code>，如下图：<br> <img src="https://images2.imgbox.com/41/96/W6x0fY0J_o.png" alt="在这里插入图片描述"><br> <strong>可以看到最终调用的是ApacheHttpClient。</strong></p> 
<h2><a id="_356"></a>如何通讯优化？</h2> 
<ul><li><code>gzip</code>是一种数据格式，采用用<code>deflate</code>算法压缩数据；</li><li><code>gzip</code>是一种流行的数据压缩算法，应用十分广泛，尤其是在Linux平台。</li></ul> 
<p><strong>当GZIP压缩到一个纯文本数据时，效果是非常明显的，大约可以减少70％以上的数据大小。</strong></p> 
<p>网络数据经过压缩后实际上<strong>降低了网络传输的字节数</strong>，最明显的好处就是<strong>可以加快网页加载的速度</strong>。网页加载速度加快的好处不言而喻，除了节省流量，改善用户的浏览体验外，另一个潜在的好处是GZIP与搜索引擎的抓取工具有着更好的关系。例如 Google就可以通过直接读取GZIP文件来比普通手工抓取更快地检索网页。</p> 
<p><strong>GZIP压缩传输的原理如下图：</strong><br> <img src="https://images2.imgbox.com/75/82/ofmB3nGI_o.png" alt=""></p> 
<p>按照上图拆解出的步骤如下：</p> 
<ul><li>客户端向服务器请求头中带有：<code>Accept-Encoding:gzip,deflate </code>字段，向服务器表示，<strong>客户端支持的压缩格式（gzip或者deflate)，如果不发送该消息头，服务器是不会压缩的。</strong></li><li>服务端在收到请求之后，如果发现<strong>请求头中含有Accept-Encoding字段</strong>，<strong>并且支持该类型的压缩，就对响应报文压缩之后返回给客户端</strong>，并且携带<code>Content-Encoding:gzip</code>消息头，表示<strong>响应报文是根据该格式压缩过的。</strong></li><li>客户端接收到响应之后，先判断<strong>是否有Content-Encoding消息头</strong>，如果有，按该格式解压报文。否则按正常报文处理。</li></ul> 
<p><code>openFeign</code>支持<strong>请求/响应</strong>开启<code>GZIP压缩</code>，整体的流程如下图：<br> <img src="https://images2.imgbox.com/92/83/ReQ7E7Me_o.png" alt="在这里插入图片描述"></p> 
<p>上图中涉及到GZIP传输的只有两块，分别是<code>Application client -&gt; Application Service</code>、 <code>Application Service-&gt;Application client</code>。</p> 
<p>注意：openFeign支持的GZIP仅仅是在openFeign接口的请求和响应，即是<font color="red">openFeign消费者调用服务提供者的接口。</font></p> 
<p><strong>openFeign开启GZIP步骤也是很简单，只需要在配置文件中开启如下配置：</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token comment">## 开启压缩</span>
  <span class="token key atrule">compression</span><span class="token punctuation">:</span>
    <span class="token key atrule">request</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment">## 开启压缩的阈值，单位字节，默认2048，即是2k，这里为了演示效果设置成10字节</span>
      <span class="token key atrule">min-request-size</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">mime-types</span><span class="token punctuation">:</span> text/xml<span class="token punctuation">,</span>application/xml<span class="token punctuation">,</span>application/json
    <span class="token key atrule">response</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p>上述配置完成之后，发出请求，可以清楚看到请求头中已经携带了<strong>GZIP压缩</strong>，如下图：<br> <img src="https://images2.imgbox.com/a4/45/ut3eOMLr_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_398"></a>如何熔断降级？</h2> 
<h3><a id="1Sentinel_399"></a>1、添加Sentinel依赖</h3> 
<p>在openFeign-consumer9006消费者的pom文件添加sentinel依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="2sentinel_409"></a>2、配置文件中开启sentinel熔断降级</h3> 
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<h3><a id="3_417"></a>3、添加降级回调类</h3> 
<p><strong>这个类一定要和openFeign接口实现同一个类，如下图：</strong> <img src="https://images2.imgbox.com/9d/d9/E7Z2O9TU_o.png" alt=""><br> <code>OpenFeignFallbackService</code>这个是<strong>降级回调的类</strong>，一旦<code>OpenFeignService</code>中对应得接口出现了异常则会调用这个类中对应得方法进行降级处理。</p> 
<h3><a id="4fallback_421"></a>4、添加fallback属性</h3> 
<p>在<code>@FeignClient</code>中添加<code>fallback</code>属性，属性值是<strong>降级回调的类</strong>，如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"openFeign-provider"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">OpenFeignFallbackService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OpenFeignService</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<p>通过postman调用http://localhost:9006/openfeign/order3这个接口，正常逻辑返回如下图：<img src="https://images2.imgbox.com/65/a6/tzbWXIkb_o.png" alt=""><br> 手动造个异常，在服务提供的接口中抛出异常<img src="https://images2.imgbox.com/72/04/4w5Klu1C_o.png" alt="在这里插入图片描述"><br> 重新调用http://localhost:9006/openfeign/order3<img src="https://images2.imgbox.com/5f/a9/exCi4At8_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/39e2a199a3d300d99cfc30452e2d5ca2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">《入坑百度飞桨OCR及打包代码到开源库》</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9633e659414f7eb4cc8134d07ca3f7ee/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Error in v-on handler: “ReferenceError:xxx is not defined</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>