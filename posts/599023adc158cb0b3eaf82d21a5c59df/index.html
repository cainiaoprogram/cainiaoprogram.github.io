<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>excel 动态表头与合并列 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="excel 动态表头与合并列" />
<meta property="og:description" content="零、希望Springboot-java导出excel文件，包括动态表头与下边合并的列 使用 org.apache.poi 与自己封装工具类实现相关功能。代码如下
一、代码 1、依赖 implementation(group: &#39;org.apache.poi&#39;,name: &#39;poi-ooxml&#39;,version: &#39;4.1.0&#39;) implementation(group: &#39;org.apache.poi&#39;,name: &#39;poi&#39;,version: &#39;4.1.0&#39;) implementation(group: &#39;cn.hutool&#39;, name: &#39;hutool-all&#39;, version: &#39;5.8.3&#39;) 2、工具类 ExcelMergeUtil.java import cn.hutool.json.JSONUtil; import com.longze.fengqx.HeaderNode; import com.longze.fengqx.PoiModel; import com.google.common.collect.Lists; import com.google.common.collect.Maps; import org.apache.poi.ss.usermodel.*; import org.apache.poi.ss.util.CellRangeAddress; import org.apache.poi.ss.util.RegionUtil; import org.apache.poi.xssf.streaming.SXSSFCell; import org.apache.poi.xssf.streaming.SXSSFSheet; import org.apache.poi.xssf.streaming.SXSSFWorkbook; import java.util.List; import java.util.Map; import java.util.stream.Collectors; import java.util.stream.IntStream; /** * @author Fengqx * @version 1.0 * @description: excel文件合并 * @date 2023/8/20 13:13 */ public class ExcelMergeUtil { public static SXSSFSheet createExcelHead(SXSSFWorkbook book, String sheetName, String headJson){ List&lt;HeaderNode&gt; headerNodes = JSONUtil." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/599023adc158cb0b3eaf82d21a5c59df/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-20T16:29:47+08:00" />
<meta property="article:modified_time" content="2023-08-20T16:29:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">excel 动态表头与合并列</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>零、希望Springboot-java导出excel文件，包括动态表头与下边合并的列</h4> 
<p>使用 org.apache.poi 与自己封装工具类实现相关功能。代码如下</p> 
<p><img alt="" height="176" src="https://images2.imgbox.com/b8/81/hElJgJFp_o.png" width="1200"></p> 
<p></p> 
<h4>一、代码</h4> 
<h5>1、依赖</h5> 
<pre><code>    implementation(group: 'org.apache.poi',name: 'poi-ooxml',version: '4.1.0')
    implementation(group: 'org.apache.poi',name: 'poi',version: '4.1.0')
    implementation(group: 'cn.hutool', name: 'hutool-all', version: '5.8.3')
</code></pre> 
<h5>2、工具类 ExcelMergeUtil.java</h5> 
<pre><code>
import cn.hutool.json.JSONUtil;
import com.longze.fengqx.HeaderNode;
import com.longze.fengqx.PoiModel;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.ss.util.CellRangeAddress;
import org.apache.poi.ss.util.RegionUtil;
import org.apache.poi.xssf.streaming.SXSSFCell;
import org.apache.poi.xssf.streaming.SXSSFSheet;
import org.apache.poi.xssf.streaming.SXSSFWorkbook;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

/**
 * @author Fengqx
 * @version 1.0
 * @description: excel文件合并
 * @date 2023/8/20 13:13
 */
public class ExcelMergeUtil {
    public static SXSSFSheet createExcelHead(SXSSFWorkbook book, String sheetName, String headJson){
        List&lt;HeaderNode&gt; headerNodes = JSONUtil.toList(headJson, HeaderNode.class);
        SXSSFSheet sxssfSheet = book.createSheet(sheetName);
        CellStyle headStyle = book.createCellStyle();
        defaultHeadStyle(headStyle);
        //表头层级
        int deep = headerNodes.stream().map(HeaderNode::getRow).reduce(Integer::max).orElse(1);
        for (int i = 0; i &lt; deep; i++) {
            sxssfSheet.createRow(i);
        }
        //创建单元格
        for (HeaderNode headerNode : headerNodes) {
            int row = headerNode.getRow();
            int col = headerNode.getColumn();
            SXSSFCell sxssfCell = sxssfSheet.getRow(row).createCell(col);
            sxssfSheet.setColumnWidth(col, headerNode.getWidth() * 256);
            sxssfCell.setCellStyle(headStyle);
            sxssfCell.setCellValue(headerNode.getHeaderName());

            CellRangeAddress region;
            //是否跨列
            if (headerNode.isOverNode()) {
                region = new CellRangeAddress(row, deep, col, col);
            } else {
                region = new CellRangeAddress(row, row, col, (col + headerNode.getOverNodeCount() - 1));
            }
            if (region.getNumberOfCells() &gt; 1) {
                sxssfSheet.addMergedRegionUnsafe(region);
                //合并后设置下边框
                RegionUtil.setBorderTop(BorderStyle.THIN, region, sxssfSheet);
                RegionUtil.setBorderLeft(BorderStyle.THIN, region, sxssfSheet);
                RegionUtil.setBorderBottom(BorderStyle.THIN, region, sxssfSheet);
                RegionUtil.setBorderRight(BorderStyle.THIN, region, sxssfSheet);
            }
        }
        return sxssfSheet;
    }
    public static void mergeCellFunc(Sheet sheet, String[] title, String[] field, List&lt;Map&lt;String, String&gt;&gt; list, Integer deep,List&lt;Integer&gt; mergeIndex){
        Map&lt;String, List&lt;Map&lt;String, String&gt;&gt;&gt; map = Maps.newHashMap();
        map.put("测试合并数据", list);
        // 模拟大数据量情况下，任务中心可分页查询接口，分批返回数据
        List&lt;List&lt;Map&lt;String, String&gt;&gt;&gt; listList =excelPageByNum(list, 5);
        // 数据总数 + 表头
        int size = listList.stream().mapToInt(List::size).sum() + deep;

        List&lt;PoiModel&gt; poiModels = Lists.newArrayList();
        for (List&lt;Map&lt;String, String&gt;&gt; listmid : listList) {
            for (Map&lt;String, String&gt; mapMid : listmid) {
                int index = sheet.getLastRowNum()+1;
                Row row = sheet.createRow(index);
                for (int i = 0; i &lt; title.length; i++) {
                    String titleField = field[i];
                    String old = null;
                    if (index &gt; deep+1) {
                        old = poiModels.get(i) == null ? null : poiModels.get(i).getContent();
                    }
                    for (int k : mergeIndex) {
                        if (index == deep+1) {
                            PoiModel poiModel =new PoiModel(mapMid.get(titleField),mapMid.get(titleField),null,deep+1,i);
                            poiModels.add(poiModel);
                            break;
                        }
                        PoiModel poiModel = poiModels.get(i);
                        String content = mapMid.get(titleField);
                        // 当前行的当前列与上一行的当前列的内容不一致时，则把当前行以上的合并
                        if (i &gt; 0 &amp;&amp; k == i) {
                            // 如果不需要考虑当前行与上一行内容相同，但是它们的前一列内容不一样则不合并的情况，把或条件删除
                            if (!StringUtils.equalsIgnoreCase(content, poiModel.getContent())
//                                    || (StringUtils.equalsIgnoreCase(content, poiModel.getContent()) &amp;&amp; !StringUtils.equalsIgnoreCase(poiModels.get(i - 1).getOldContent(),mapMid.get(field[i - 1])))
                            ) {
                                get(poiModel, content, index, i, sheet);
                            }
                        }
                        // 处理第一列的情况
                        if (k == i &amp;&amp; i == 0 &amp;&amp; !StringUtils.equalsIgnoreCase(content,poiModel.getContent())) {
                            get(poiModel, content, index, i, sheet);
                        }
                        // 最后一行没有后续的行与之比较，所有当到最后一行时则直接合并对应列的相同内容
                        if (k == i &amp;&amp; index == size &amp;&amp; poiModels.get(i).getRowIndex() != index) {
                            CellRangeAddress cra = new CellRangeAddress(poiModels.get(i).getRowIndex(), index, poiModels.get(i).getCellIndex(), poiModels.get(i).getCellIndex());
                            sheet.addMergedRegion(cra);
                        }
                    }
                    Cell cell = row.createCell(i);
                    cell.setCellValue(mapMid.get(titleField));
                    poiModels.get(i).setOldContent(old);
                }
            }
        }
    }

    /**
     * 表头样式
     *
     * @param headStyle
     */
    private static void defaultHeadStyle(CellStyle headStyle) {
        headStyle.setBorderTop(BorderStyle.THIN);
        headStyle.setBorderLeft(BorderStyle.THIN);
        headStyle.setBorderBottom(BorderStyle.THIN);
        headStyle.setBorderRight(BorderStyle.THIN);
        headStyle.setAlignment(HorizontalAlignment.CENTER);
        headStyle.setVerticalAlignment(VerticalAlignment.CENTER);
        headStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        headStyle.setFillForegroundColor(IndexedColors.YELLOW.getIndex());
    }
    //合并单元格
    private static void get(PoiModel poiModel, String content, int index, int i, Sheet sheet) {
        if (poiModel.getRowIndex() != index - 1) {
            CellRangeAddress cra = new CellRangeAddress(poiModel.getRowIndex(), index - 1, poiModel.getCellIndex(), poiModel.getCellIndex());
            //在sheet里增加合并单元格
            sheet.addMergedRegion(cra);
        }
        /*重新记录该列的内容为当前内容，行标记改为当前行标记，列标记则为当前列*/
        poiModel.setContent(content);
        poiModel.setRowIndex(index);
        poiModel.setCellIndex(i);
    }
    public static &lt;T&gt; List&lt;List&lt;T&gt;&gt; excelPageByNum(List&lt;T&gt; list, int pageSize) {
        return IntStream.range(0, list.size()).boxed().filter(t -&gt; t % pageSize == 0).map(t -&gt; list.stream().skip(t).limit(pageSize).collect(Collectors.toList())).collect(Collectors.toList());
    }
}
</code></pre> 
<h5>3、实体对象</h5> 
<p>HeaderNode.java  和 PoiModel.java</p> 
<pre><code>public class PoiModel {
    private String content;

    private String oldContent;

    private String primaryKey;

    private int rowIndex;

    private int cellIndex;

    public PoiModel() {
    }

    public PoiModel(String content, String oldContent, String primaryKey, int rowIndex, int cellIndex) {
        this.content = content;
        this.oldContent = oldContent;
        this.primaryKey = primaryKey;
        this.rowIndex = rowIndex;
        this.cellIndex = cellIndex;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public String getOldContent() {
        return oldContent;
    }

    public void setOldContent(String oldContent) {
        this.oldContent = oldContent;
    }

    public String getPrimaryKey() {
        return primaryKey;
    }

    public void setPrimaryKey(String primaryKey) {
        this.primaryKey = primaryKey;
    }

    public int getRowIndex() {
        return rowIndex;
    }

    public void setRowIndex(int rowIndex) {
        this.rowIndex = rowIndex;
    }

    public int getCellIndex() {
        return cellIndex;
    }

    public void setCellIndex(int cellIndex) {
        this.cellIndex = cellIndex;
    }
}




public class HeaderNode {

    /**
     * 标题头
     */
    private String headerName;

    /**
     * 层级
     */
    private int row;

    /**
     * 非叶子节点列跨度
     */
    private int overNodeCount;
    /**
     * 当前列没有子节点
     */
    private boolean overNode = true;

    /**
     * 列
     */
    private int column;

    /**
     * 宽度
     */
    private int width = 13;

    public String getHeaderName() {
        return headerName;
    }

    public void setHeaderName(String headerName) {
        this.headerName = headerName;
    }

    public int getRow() {
        return row;
    }

    public void setRow(int row) {
        this.row = row;
    }

    public int getOverNodeCount() {
        return overNodeCount;
    }

    public void setOverNodeCount(int overNodeCount) {
        this.overNodeCount = overNodeCount;
    }

    public boolean isOverNode() {
        return overNode;
    }

    public void setOverNode(boolean overNode) {
        this.overNode = overNode;
    }

    public int getColumn() {
        return column;
    }

    public void setColumn(int column) {
        this.column = column;
    }

    public int getWidth() {
        return width;
    }

    public void setWidth(int width) {
        this.width = width;
    }
}
</code></pre> 
<h5>4、下载Controller</h5> 
<pre><code> @GetMapping(value = "/downExcel")
    @ResponseBody
    public void downExcel(HttpServletResponse response,@RequestParam(required = true) String type) throws Exception {
        try {
            tengxunService.downExcel(response, type);
        } catch (Exception ex) {
            throw ex;
        }
    }</code></pre> 
<h5>5、下载service</h5> 
<pre><code>  @Override
    public void downloadExcel(HttpServletResponse response, String type)throws Exception {
        response.setContentType("application/vnd.ms-excel");
        response.setCharacterEncoding("utf-8");
        // 这里URLEncoder.encode可以防止中文乱码
        String fileName = URLEncoder.encode("腾讯充值文件", "UTF-8");
        response.setHeader("Content-disposition", "attachment;filename=" + fileName + ".xlsx");
 OutputStream os = response.getOutputStream();
//加工数据
        List&lt;Map&lt;String, String&gt;&gt; list = Lists.newArrayList();
  for(int i=0;i&lt;chongzhiList.size();i++){
            Chongzhi dto=new Chongzhi ();
            list.add(JSONObject.parseObject(JSON.toJSONString(dto),Map.class));
        }

        String weekStart ="08.01";
        String weekEnd ="08.07";
        String nextWeekStart = "08.08";
        String nextWeekEnd ="08.15";
        //合并单元格方法
        try {
            String customizeLabel = "[{\"headerName\":\"区域\",\"column\":0,\"row\":0}," +
                    "{\"headerName\":\"用户姓名\",\"column\":1,\"row\":0}," +
                    "{\"headerName\":\"本周（"+weekStart+"-"+weekEnd+"）充值记录\",\"column\":2,\"row\":0}," +
                    "{\"headerName\":\"本周（"+weekStart+"-"+weekEnd+"）充值详情\",\"column\":3,\"row\":0,\"overNodeCount\":4,\"overNode\":false},{\"headerName\":\"充值时间\",\"column\":3,\"row\":1}," +
                    "{\"headerName\":\"充值项目\",\"column\":4,\"row\":\"1\"}," +
                    "{\"headerName\":\"充值方式\",\"column\":5,\"row\":1}," +
                    "{\"headerName\":\"充值金额\",\"column\":6,\"row\":1}," +
                    "{\"headerName\":\"下周（"+nextWeekStart+"-"+nextWeekEnd+"）充值计划\",\"column\":7,\"row\":0}]";
            //1、生book
            SXSSFWorkbook book = new SXSSFWorkbook();
            //2、生成动态标题
            SXSSFSheet sxssfSheet = ExcelMerge.createExcelHead(book,"Sheet1", customizeLabel);
            //3、取数据对应字段值  汇总
            String[] title = {"区域", "用户姓名", "本周（"+weekStart+"-"+weekEnd+"）充值记录", "充值时间", "充值项目", "充值方式", "充值金额", "下周（"+nextWeekStart+"-"+nextWeekEnd+"）充值计划"};
            //4、取数据对应属性的字段值  汇总
            String[] field = {"areaName", "name", "chongzjilu", "chongzTime", "chongzProject", "chongzMethod", "chongzMoney", "nextChongz"};
            //5、需要合并的列
            List&lt;Integer&gt; mergeIndex = Arrays.asList(0,1,7);
            //6、合并
            ExcelMerge.mergeCellFunc(sxssfSheet,title,field, list, sxssfSheet.getLastRowNum(),mergeIndex);
            //创建excel文件 下载
            book.write(os);
        } catch (IOException e){
            logger.error("文件导出失败,错误信息{}",e);
            // 重置response
            response.reset();
            response.setContentType("application/json");
            response.setCharacterEncoding("utf-8");
            Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
            map.put("statusCode", "500");
            map.put("message", "下载文件失败" + e.getMessage());
            response.getWriter().println(JSON.toJSONString(map));
        }finally {
            try {
                os.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }</code></pre> 
<h4>三、下载</h4> 
<p>完事通过controller调用下载接口，直接可以下载出文件</p> 
<p>可以任意改表头，与选择是否要合并的字段，当做参数传入，将需要合并的列顺序传入即可完成合并，一步到位，十分方便</p> 
<blockquote> 
 <pre>//5、需要合并的列  
List&lt;Integer&gt; mergeIndex = Arrays.asList(0,1,7);</pre> 
 <pre>ExcelMerge.mergeCellFunc(sxssfSheet,title,field, list, sxssfSheet.getLastRowNum(),mergeIndex);</pre> 
</blockquote> 
<p></p> 
<p>截图如下</p> 
<p><img alt="" height="221" src="https://images2.imgbox.com/f8/30/M0HQN8na_o.png" width="1200"></p> 
<p></p> 
<p><span style="color:#fe2c24;">荆轲刺秦王！</span></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6edf0e00f627d9af107326b47006478e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">google插件开发流程和示例，google插件开发过程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/90ab9772305ac2062b42479b99ea7517/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">iOS 中 UIViewController 加载之后，将其中的 UITableView 滑到最底部以及遇到的问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>