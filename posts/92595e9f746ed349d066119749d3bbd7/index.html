<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>videojs 实现视频流切换和分屏播放 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="videojs 实现视频流切换和分屏播放" />
<meta property="og:description" content="在做项目时，遇到视频流加载切换和分屏播放的问题。在这里简单记录一下：
实现效果：
一、获取视频流 （1）通过后台请求获得；
一般在通过 axios 请求，在onMounted 中获取数据；
（2）本地组装视频列表；
let root = [ { id: 1, label: &#34;分屏画面&#34;, parentId: null } ]; let equpment = [ { name: &#34;画面一&#34;, url: &#34;https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/177cdd67413748f7ae3cbbbb07ae6481/main.m3u8?maxbr=2048&amp;contentid=15120519184043&#34; }, { name: &#34;画面二&#34;, url: &#34;https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/aa2c5c39961342809a3cbad11011d2c4/main.m3u8?maxbr=2048&amp;contentid=15120519184043&#34; }, { name: &#34;画面三&#34;, url: &#34;https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/51f949219dae487baa50137b2a1c67d5/main.m3u8?maxbr=2048&amp;contentid=15120519184043&#34; }, { name: &#34;画面四&#34;, url: &#34;https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/c06812c1aab74b268c79ed2df65386d2/main.m3u8?maxbr=2048&amp;contentid=15120519184043&#34; }, ] let newEqup = equpment.map((item: any, index: any) =&gt; ( { id: index &#43; 2, label: item.name, url: item.url, parentId: 1, } )) let resList = [." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/92595e9f746ed349d066119749d3bbd7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-09T17:33:11+08:00" />
<meta property="article:modified_time" content="2023-09-09T17:33:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">videojs 实现视频流切换和分屏播放</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>在做项目时，遇到视频流加载切换和分屏播放的问题。在这里简单记录一下：</p> 
<p>实现效果：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/c5/df/yXBkRZff_o.png"></p> 
<h3><strong>一、获取视频流</strong></h3> 
<p>（1）通过后台请求获得；</p> 
<p>一般在通过 axios 请求，在onMounted 中获取数据；</p> 
<p>（2）本地组装视频列表；</p> 
<pre><code class="language-javascript">let root = [
  {
    id: 1,
    label: "分屏画面",
    parentId: null
  }
];

let equpment = [
  {
    name: "画面一",
    url: "https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/177cdd67413748f7ae3cbbbb07ae6481/main.m3u8?maxbr=2048&amp;contentid=15120519184043"
  },
  {
    name: "画面二",
    url: "https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/aa2c5c39961342809a3cbad11011d2c4/main.m3u8?maxbr=2048&amp;contentid=15120519184043"
  },
  {
    name: "画面三",
    url: "https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/51f949219dae487baa50137b2a1c67d5/main.m3u8?maxbr=2048&amp;contentid=15120519184043"
  },
  {
    name: "画面四",
    url: "https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/c06812c1aab74b268c79ed2df65386d2/main.m3u8?maxbr=2048&amp;contentid=15120519184043"
  },
]

let newEqup = equpment.map((item: any, index: any) =&gt; (
  {
    id: index + 2,
    label: item.name,
    url: item.url,
    parentId: 1,
  }
))

let resList = [...root, ...newEqup];

// 得到的结果
(5)[{…}, {…}, {…}, {…}, {…}]
[
    {id: 1, label: "分屏画面", parentId: null},
    {id: 2, label: "画面一", parentId: 1,url: "xxxxxxxxxxxxxxx"},
    {id: 3, label: "画面二", parentId: 1,url: "xxxxxxxxxxxxxxx"},
    {id: 4, label: "画面三", parentId: 1,url: "xxxxxxxxxxxxxxx"},
    {id: 5, label: "画面四", parentId: 1,url: "xxxxxxxxxxxxxxx"},
]</code></pre> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/6d/43/hPBKwVXR_o.png"></p> 
<h3 style="background-color:transparent;">二、组装成树结构（按项目要求）</h3> 
<p>因为使用了 el-tree 组件列表需要分级显示，所以需要将列表转树结构；</p> 
<pre><code class="language-javascript">// 列表转树结构
function listToTree(list: any) {
  let tree = [];
  let dict = {};
  for (let item of list) {
    dict[item.id] = { ...item, children: [] };
  }
  for (let item of list) {
    let parent = dict[item.parentId];
    if (parent) {
      dict[item.id].parent = parent;
      parent.children.push(dict[item.id]);
    } else {
      tree.push(dict[item.id]);
    }
  }
  return tree;
}
tree = listToTree(resList);</code></pre> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/13/ef/mYKdk2wl_o.png"></p> 
<h4 style="background-color:transparent;">三、实现分屏功能</h4> 
<p>这里的分屏切换，是通过  el-row 和 el-row 实现的；</p> 
<pre><code class="language-javascript">let col = [24,12,8,6];
// 分别对应 一列，两列，三列，四列
&lt;el-row&gt;
   &lt;el-col :span="24"&gt;&lt;div class="grid-content ep-bg-purple-dark" /&gt;&lt;/el-col&gt;
&lt;/el-row&gt;</code></pre> 
<p>通过改变 span 的数值，从而得到想要的列数； 再通过 v-for 遍历得到想要的行列；</p> 
<h4 style="background-color:transparent;">四、点击切换视频流 </h4> 
<p>因为需要点击切换显示多个视频流画面，所以采用了动态生成 video DOM 的方式；这样每次切换都是新的视频；</p> 
<pre><code class="language-javascript">let dom: any = document.getElementById(innerId.replace("videoDom", "videoPlayer"));
  // 向Dom中写入视频组件
  dom.innerHTML = "";
  const html = `&lt;video id="${innerId}" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" style="width: 100%;height:100%;object-fit:fill;"&gt;
        &lt;source id="source" src="${url}" type="application/x-mpegURL"&gt;
    &lt;/video&gt;`;

  dom.innerHTML = html;

videojs.hook("beforeerror", (player: any, err: any) =&gt; {
    // Video.js 在切换/指定 source 后立即会触发一个 err=null 的错误，这里过滤一下
    if (err !== null) {
      playerObj.src(url);
    }
    // 清除错误，避免 error 事件在控制台抛出错误
    return null;
  });
  playerObj.play();</code></pre> 
<p>这里有一个注意点：一个视频对应一个 ID，如果出现 <span style="color:#fe2c24;">VIDEOJS: WARN: Player “myVideo“ is already initialised. Options will not be applied. </span><span style="color:#0d0016;">那就是 ID 重复了，就会报错；所以需要循环动态地设置 ID；</span></p> 
<pre><code class="language-javascript">&lt;el-row :class="btnOne === 0 ? 'rowOne' : btnOne === 1 ? 'rowTwo' : btnOne === 2 ? 'rowThree' : 'rowFour'" 
       v-for="(item, index) in btnOne + 1"&gt;
     &lt;el-col class="col" :span="btnOne === 0 ? 24 : btnOne === 1 ? 12 : btnOne === 2 ? 8 : 6" 
       v-for="(inner, innerId) in btnOne + 1" @click="currentVideo('videoDom' + index + innerId, $event)"&gt;
          &lt;div ref="videoList" :id="'videoPlayer' + index + innerId" class="video-item"&gt;&lt;/div&gt;
   &lt;/el-col&gt;
&lt;/el-row&gt;</code></pre> 
<p>接下来切换视频流进行播放：我这里是先选择视频窗口，选中对应的video id，然后将 url 设置到 sources 里；</p> 
<pre><code class="language-javascript">
// 获取当前 DOM id 并添加选中边框
function currentVideo(id: any, e: any) {
  innerId.value = id;
  videoList.value.forEach((item: any) =&gt; (item.style.border = "none"));
  e.target.style.border = "1px solid rgb(27 183 75)";
}

/**
 * 获取选中的树节点 url
 * @param data 选中的树节点
 */
const handleNodeClick = (data: any) =&gt; {
  let videoUrl:any = resList.find((item: any) =&gt; item.label === data.label);
  if(videoUrl.url) {
    showUrl.value = videoUrl.url;
    if(innerId.value) {
      initVideo(innerId.value,showUrl.value);
    } else {
      alert('请先选择视屏窗口！')
    }
  }
};</code></pre> 
<h4 style="background-color:transparent;">五、完整代码</h4> 
<pre><code class="language-javascript">&lt;template&gt;
  &lt;div class="ahome"&gt;
    &lt;div class="home-content"&gt;
      &lt;div class="equipment"&gt;
        &lt;div class="equipContent"&gt;
          &lt;div class="equipLeft"&gt;
            &lt;div class="treelist"&gt;
              &lt;p class="list"&gt;设备列表&lt;/p&gt;
              &lt;el-tree :data="tree" node-key="id" :props="defaultProps" @node-click="handleNodeClick"
                :default-expanded-keys="[0]" /&gt;
            &lt;/div&gt;
            &lt;div class="online"&gt;
              &lt;p class="list"&gt;设备在线率&lt;/p&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          &lt;div class="equipCenter"&gt;
            &lt;div v-if="showVideo[btnOne]" class="videoShowBox"&gt;
              &lt;el-row :class="btnOne === 0
                ? 'rowOne'
                : btnOne === 1
                  ? 'rowTwo'
                  : btnOne === 2
                    ? 'rowThree'
                    : 'rowFour'
                " v-for="(item, index) in btnOne + 1"&gt;
                &lt;el-col class="col" :span="btnOne === 0 ? 24 : btnOne === 1 ? 12 : btnOne === 2 ? 8 : 6
                  " v-for="(inner, innerId) in btnOne + 1" @click="currentVideo('videoDom' + index + innerId, $event)"&gt;
                  &lt;div ref="videoList" :id="'videoPlayer' + index + innerId" class="video-item"&gt;&lt;/div&gt;
                &lt;/el-col&gt;
              &lt;/el-row&gt;
            &lt;/div&gt;
            &lt;div class="selectCard"&gt;
              &lt;div class="pic pic1" @click="onSubmit(0)"&gt;单画面&lt;/div&gt;
              &lt;div class="pic pic2" @click="onSubmit(1)"&gt;4画面&lt;/div&gt;
              &lt;div class="pic pic2" @click="onSubmit(2)"&gt;9画面&lt;/div&gt;
              &lt;div class="pic pic3" @click="onSubmit(3)"&gt;16画面&lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
&lt;script lang="ts" setup&gt;
import { onMounted, onUnmounted, ref, computed } from "vue";
import videojs from 'video.js';
import 'video.js/dist/video-js.css'

let myPlayer = ref();
let myPlayerArr: any = ref([]);
let btnOne = ref(0);
let innerId = ref("");
let videoList = ref();

let showVideo = ref([true, true, true, true]);

// 定义树结构
const defaultProps = {
  label: "label",
  children: "children"
};
const tree: any = ref();

let showUrl = ref("");
let root = [
  {
    id: 1,
    label: "分屏画面",
    parentId: null
  }
];
let equpment = [
  {
    name: "画面一",
    url: "https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/177cdd67413748f7ae3cbbbb07ae6481/main.m3u8?maxbr=2048&amp;contentid=15120519184043"
  },
  {
    name: "画面二",
    url: "https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/aa2c5c39961342809a3cbad11011d2c4/main.m3u8?maxbr=2048&amp;contentid=15120519184043"
  },
  {
    name: "画面三",
    url: "https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/51f949219dae487baa50137b2a1c67d5/main.m3u8?maxbr=2048&amp;contentid=15120519184043"
  },
  {
    name: "画面四",
    url: "https://dh5.cntv.myalicdn.com/asp/h5e/hls/main/0303000a/3/default/c06812c1aab74b268c79ed2df65386d2/main.m3u8?maxbr=2048&amp;contentid=15120519184043"
  },
]
let newEqup = equpment.map((item: any, index: any) =&gt; (
  {
    id: index + 2,
    label: item.name,
    url: item.url,
    parentId: 1,
  }
))

let resList = [...root, ...newEqup];
console.log(resList);

function listToTree(list: any) {
  let tree = [];
  let dict = {};
  for (let item of list) {
    dict[item.id] = { ...item, children: [] };
  }
  for (let item of list) {
    let parent = dict[item.parentId];
    if (parent) {
      dict[item.id].parent = parent;
      parent.children.push(dict[item.id]);
    } else {
      tree.push(dict[item.id]);
    }
  }
  return tree;
}
tree.value = listToTree(resList);
console.log(tree.value);


/**
 * 获取选中的树节点 url
 * @param data 选中的树节点
 */
const handleNodeClick = (data: any) =&gt; {
  let videoUrl:any = resList.find((item: any) =&gt; item.label === data.label);
  if(videoUrl.url) {
    showUrl.value = videoUrl.url;
    if(innerId.value) {
      initVideo(innerId.value,showUrl.value);
    } else {
      alert('请先选择视屏窗口！')
    }
  }
};

// 获取当前 DOM id 并添加选中边框
function currentVideo(id: any, e: any) {
  innerId.value = id;
  videoList.value.forEach((item: any) =&gt; (item.style.border = "none"));
  e.target.style.border = "1px solid rgb(27 183 75)";
}

const initVideo = (innerId: string, url: string) =&gt; {
  myPlayerArr.value.forEach((item: any, index: any) =&gt; {
    if (item.id === innerId) {
      item.player.pause();
      item.player.dispose();
      myPlayerArr.value.splice(index, 1);
    }
  });
  console.log("myPlayerArr.value", myPlayerArr.value);
  let dom: any = document.getElementById(innerId.replace("videoDom", "videoPlayer"));
  // 向Dom中写入视频组件
  dom.innerHTML = "";
  const html = `&lt;video id="${innerId}" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" style="width: 100%;height:100%;object-fit:fill;"&gt;
        &lt;source id="source" src="${url}" type="application/x-mpegURL"&gt;
    &lt;/video&gt;`;

  dom.innerHTML = html;
  // 初始化声明
  let playerObj = videojs(innerId, {
    autoplay: true, //自动播放
    sources: [
      {
        src: url,
        type: "application/x-mpegURL"
      }
    ]
  });
  videojs.hook("beforeerror", (player: any, err: any) =&gt; {
    // Video.js 在切换/指定 source 后立即会触发一个 err=null 的错误，这里过滤一下
    if (err !== null) {
      playerObj.src(url);
    }
    // 清除错误，避免 error 事件在控制台抛出错误
    return null;
  });
  playerObj.play();
  myPlayerArr.value.push({ id: innerId, player: playerObj });
};

// 分屏切换
const onSubmit = (num: any) =&gt; btnOne.value = num;
&lt;/script&gt;
&lt;style scoped lang="scss"&gt;
.ahome {
  position: relative;
  width: 100%;
  height: 100%;

  // background-image: url("../image/back.png");
  background-color: #091a36;
  background-position: center center;
  background-size: 100% 100%;
  overflow: hidden;

  .home-content {
    height: 95vh;
    margin-top: 5vh;

    .equipment {
      color: #0cd9e1;
      height: 92vh;
      display: flex;
      padding: 0 20px 20px 20px;

      // background: linear-gradient(90deg, #142964, #0d396940, #283e7a);
      .equipContent {
        width: 96%;
        height: 96%;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;

        .equipLeft {
          flex: 1;
          border: 2px solid #2056bc;
          border-radius: 10px;

          .list {
            font-size: 24px;
            font-family: PingFangSC;
            font-weight: 600;
            line-height: 1.8;
            color: rgb(22, 174, 255);
            margin-left: 6px;
          }

          .treelist {
            height: 50%;

            ::v-deep .el-tree {
              background: transparent;
              color: #fff;
              width: 98%;

              .el-tree-node {
                margin: 6px 0;

                .el-tree-node__content {
                  height: 25px !important;
                  background: linear-gradient(86deg,
                      #2056bc 0%,
                      rgba(32, 86, 188, 0.2) 100%) !important;
                }
              }
            }
          }

          .online {
            height: 50%;
          }
        }

        .equipCenter {
          flex: 4;
          border: 1px solid rgb(67, 85, 110);
          border: 2px solid #2056bc;
          border-radius: 10px;
          margin: 0 10px;
          padding: 10px;

          .videoShowBox {
            height: 86%;
            background: #000;
            border-bottom: 1px solid rgb(101, 95, 37);
            border-right: 1px solid rgb(101, 95, 37);

            .rowOne {
              height: 100%;

              .col {
                border-top: 1px solid rgb(101, 95, 37);
                border-left: 1px solid rgb(101, 95, 37);
                width: 100%;
                height: 100%;
              }
            }

            .rowTwo {
              height: 50%;

              .col {
                border-top: 1px solid rgb(101, 95, 37);
                border-left: 1px solid rgb(101, 95, 37);
                width: 100%;
                height: 100%;

                video {
                  width: 100% !important;
                  height: 100% !important;
                }
              }
            }

            .rowThree {
              height: 33.33%;

              .col {
                border-top: 1px solid rgb(101, 95, 37);
                border-left: 1px solid rgb(101, 95, 37);
                width: 100%;
                height: 100%;

                video {
                  width: 100% !important;
                  height: 100% !important;
                }
              }
            }

            .rowFour {
              height: 25%;

              .col {
                border-top: 1px solid rgb(101, 95, 37);
                border-left: 1px solid rgb(101, 95, 37);
                width: 100%;
                height: 100%;

                video {
                  width: 100% !important;
                  height: 100% !important;
                }
              }
            }
          }

          .selectCard {
            width: 100%;
            height: 15%;
            display: flex;
            justify-content: space-evenly;
            align-items: center;

            .pic {
              width: 16%;
              padding: 18px;
              text-align: center;
              font-size: 20px;
              font-weight: lighter;
              cursor: pointer;
            }

            .pic1,
            .pic2,
            .pic3 {
              box-shadow: inset 0 0 10px #00d0ff;
              border-radius: 6px;
              background-size: 100% 100%;
            }

            .pic1:hover,
            .pic2:hover,
            .pic3:hover {
              color: rgb(22, 174, 255);
              box-shadow: inset 0 0 10px #6586a9;
            }
          }
        }
      }
    }
  }
}

.video-item {
  width: 100% !important;
  height: 100% !important;

  video {
    width: 100% !important;
    height: 100% !important;
  }
}
&lt;/style&gt;</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2be2e9cddebaf428a146a4a51a7aef93/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mac电脑使用万能头文件教程（详细）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e28f76c1c25bc39c8b88a79e38ecf46e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">微信支付-Native支付（网页二维码扫码微信支付）简单示例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>