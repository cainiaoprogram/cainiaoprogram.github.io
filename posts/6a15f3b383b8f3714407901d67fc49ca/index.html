<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Autoware.universe部署06：使用DBC文件进行UDP的CAN通信代码编写 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Autoware.universe部署06：使用DBC文件进行UDP的CAN通信代码编写" />
<meta property="og:description" content="目录标题 一、安装DBC文件编辑工具VectorCANdb&#43;&#43;二、编写DBC文件2.1 CAN通信协议2.2 编写DBC文件2.2.1 根据CAN协议设置signals2.2.2 设置报文2.2.3 建立节点 三、根据DBC文件编写ROS2驱动程序四、实际通信调试 根据CAN协议编写DBC文件，通过DBC文件编写ROS2包进行UDP通信，获取底盘速度转发至Autoware.Universe以及订阅Autoware.Universe控制命令，下发至CAN控制底盘运动（本文适用于CAN盒通过网线连接进行UDP通信），本系列其他文章：
Autoware.universe部署01：Ubuntu20.04安装Autoware.universe并与Awsim联调
Autoware.universe部署02：高精Lanelet2地图的绘制
Autoware.universe部署03：与Carla（二进制版）联调
Autoware.universe部署04：universe传感器ROS2驱动
Autoware.universe部署05：实车调试
一、安装DBC文件编辑工具VectorCANdb&#43;&#43; 在windows系统下安装VectorCANdb&#43;&#43;，下载链接：https://www.vector.com/cn/zh/download/candb-31-sp3/
下载完成后常规安装，选择安装路径，其他过程一路Next：
安装完成后在左下角程序列表中可以找到
二、编写DBC文件 2.1 CAN通信协议 下面是松灵的HUNTER SE通信协议，是一款阿克曼模型可编程UGV（ UNMANNED GROUND VEHICLE ），它是一款采用阿克曼转向设计的底盘。下面只列举了三帧数据，每一帧数据包含一系列字节（例如：0x01, 0x11, 0x00,0x96, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00）的数据，我们需要注意的是每一帧数据的发送与接收节点，帧ID（例如：0x01, 0x11），数据长度，以及功能数据（例如：0x00,0x96, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00）：
2.2 编写DBC文件 有了通讯协议之后，打开VectorCANdb&#43;&#43;，点击File-&gt;Create Database-&gt;CANTemplate.dbc后点击OK，创建文件名：
2.2.1 根据CAN协议设置signals 点击signals-&gt;new
以运动回馈帧的数据为例，根据上面的通讯协议数据帧包含8个字节byte，即8个信号signals，每个字节signals包含8个比特bit，协议中第3、4、5、6个字节没有定义数据，就默认为0，以速度高位为例：
Value Type高位选择有符号数据signed，低位选择无符号选择UnsignedLength（信号bit长度）8Factor（数据精度）一般为1Minimum与Maximum根据表格来填，表格是-4800～4800包含的是两位数据，这里单个信号是不一样的。协议中给出的是十六进制数，而这边的最大值最小值范围是十进制数，转化一下：如果是有符号的字节符号占一位，那么转化成十进制就是-127～127，如果是无符号的就是0～255。如果要遵守协议即-4800～4800，那么高位最好写成-18～18『（4800-256）/256=17.5』，写大一点没问题
按照协议写好所有的信号如下：
2.2.2 设置报文 在Messages下新建报文：注意帧ID以及数据字节数
之后建立报文与信号的关系，鼠标左键按住设置好的signals，拖动到新建的Messages上面，注意顺序要与协议文件中顺序一致
如果顺序错了，双击signals设置开始bit数可以更改
全都拖好了，双击新建的Messages，然后点击Layout，如下图所示，可以检查一下报文设置是否正确（图片上的字节顺序，从右至左，从上到下，依次增大）
2.2.3 建立节点 （1）建立发送和接受节点
右键点击Network nodes -&gt; New，只需输入创建的网络节点名字进行新建操作
（2）需要发送的报文直接拖到目标节点下的Tx Messages下面即可
（3）需要接收的报文添加：双击打开Receive，选择Mapped Rx Sig." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6a15f3b383b8f3714407901d67fc49ca/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-22T14:49:54+08:00" />
<meta property="article:modified_time" content="2023-11-22T14:49:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Autoware.universe部署06：使用DBC文件进行UDP的CAN通信代码编写</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录标题</h4> 
 <ul><li><a href="#DBCVectorCANdb_10" rel="nofollow">一、安装DBC文件编辑工具VectorCANdb++</a></li><li><a href="#DBC_16" rel="nofollow">二、编写DBC文件</a></li><li><ul><li><a href="#21_CAN_17" rel="nofollow">2.1 CAN通信协议</a></li><li><a href="#22_DBC_22" rel="nofollow">2.2 编写DBC文件</a></li><li><ul><li><a href="#221_CANsignals_25" rel="nofollow">2.2.1 根据CAN协议设置signals</a></li><li><a href="#222__37" rel="nofollow">2.2.2 设置报文</a></li><li><a href="#223__46" rel="nofollow">2.2.3 建立节点</a></li></ul> 
  </li></ul> 
  </li><li><a href="#DBCROS2_186" rel="nofollow">三、根据DBC文件编写ROS2驱动程序</a></li><li><a href="#_520" rel="nofollow">四、实际通信调试</a></li></ul> 
</div> 
<p></p> 
<hr> 
<p>根据CAN协议编写DBC文件，通过DBC文件编写ROS2包进行UDP通信，获取底盘速度转发至Autoware.Universe以及订阅Autoware.Universe控制命令，下发至CAN控制底盘运动（本文适用于CAN盒通过网线连接进行UDP通信），本系列其他文章：<br> <strong><a href="https://blog.csdn.net/zardforever123/article/details/132029636?spm=1001.2014.3001.5501">Autoware.universe部署01：Ubuntu20.04安装Autoware.universe并与Awsim联调</a></strong><br> <strong><a href="https://blog.csdn.net/zardforever123/article/details/132528899?spm=1001.2014.3001.5502">Autoware.universe部署02：高精Lanelet2地图的绘制</a></strong><br> <strong><a href="https://blog.csdn.net/zardforever123/article/details/132357436?spm=1001.2014.3001.5501">Autoware.universe部署03：与Carla（二进制版）联调</a></strong><br> <strong><a href="https://blog.csdn.net/zardforever123/article/details/132529492?spm=1001.2014.3001.5501">Autoware.universe部署04：universe传感器ROS2驱动</a></strong><br> <strong><a href="https://blog.csdn.net/zardforever123/article/details/132538871">Autoware.universe部署05：实车调试</a></strong></p> 
<h2><a id="DBCVectorCANdb_10"></a>一、安装DBC文件编辑工具VectorCANdb++</h2> 
<p>在<code>windows</code>系统下安装VectorCANdb++，下载链接：<a href="https://www.vector.com/cn/zh/download/candb-31-sp3/" rel="nofollow">https://www.vector.com/cn/zh/download/candb-31-sp3/</a><br> <img src="https://images2.imgbox.com/e0/73/rysNyCnq_o.png" alt="在这里插入图片描述"><br> 下载完成后常规安装，选择安装路径，其他过程一路Next：<br> <img src="https://images2.imgbox.com/37/9b/AoxvvXgf_o.png" alt="在这里插入图片描述"><br> 安装完成后在左下角程序列表中可以找到</p> 
<h2><a id="DBC_16"></a>二、编写DBC文件</h2> 
<h3><a id="21_CAN_17"></a>2.1 CAN通信协议</h3> 
<p>下面是松灵的HUNTER SE通信协议，是一款阿克曼模型可编程UGV（ UNMANNED GROUND VEHICLE ），它是一款采用阿克曼转向设计的底盘。下面只列举了三帧数据，每一帧数据包含一系列字节（例如：0x01, 0x11, 0x00,0x96, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00）的数据，我们需要注意的是每一帧数据的发送与接收节点，帧ID（例如：0x01, 0x11），数据长度，以及功能数据（例如：0x00,0x96, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00）：<br> <img src="https://images2.imgbox.com/fc/95/2PzkI2Cd_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/36/73/KjGbKFrs_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b2/ea/EukBrrao_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22_DBC_22"></a>2.2 编写DBC文件</h3> 
<p>有了通讯协议之后，打开VectorCANdb++，点击File-&gt;Create Database-&gt;CANTemplate.dbc后点击OK，创建文件名：<br> <img src="https://images2.imgbox.com/ae/2a/ucfqdKPl_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="221_CANsignals_25"></a>2.2.1 根据CAN协议设置signals</h4> 
<p>点击signals-&gt;new<br> <img src="https://images2.imgbox.com/7f/f8/i4CGNglp_o.png" alt="在这里插入图片描述"><br> 以运动回馈帧的数据为例，根据上面的通讯协议数据帧包含8个字节byte，即8个信号signals，每个字节signals包含8个比特bit，协议中第3、4、5、6个字节没有定义数据，就默认为0，以速度高位为例：</p> 
<ul><li>Value Type高位选择有符号数据signed，低位选择无符号选择Unsigned</li><li>Length（信号bit长度）8</li><li>Factor（数据精度）一般为1</li><li>Minimum与Maximum根据表格来填，表格是-4800～4800包含的是两位数据，这里单个信号是不一样的。协议中给出的是十六进制数，而这边的最大值最小值范围是十进制数，转化一下：如果是有符号的字节符号占一位，那么转化成十进制就是-127～127，如果是无符号的就是0～255。如果要遵守协议即-4800～4800，那么高位最好写成-18～18『（4800-256）/256=17.5』，写大一点没问题<br> <img src="https://images2.imgbox.com/5b/6c/UF436xc9_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4f/b6/F3pqnHYu_o.png" alt="在这里插入图片描述"><br> 按照协议写好所有的信号如下：<br> <img src="https://images2.imgbox.com/fa/c3/FLwoXhPc_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="222__37"></a>2.2.2 设置报文</h4> 
<p>在Messages下新建报文：注意帧ID以及数据字节数<br> <img src="https://images2.imgbox.com/00/0e/L4FGe9q1_o.png" alt="在这里插入图片描述"><br> 之后建立报文与信号的关系，鼠标左键按住设置好的signals，拖动到新建的Messages上面，注意顺序要与协议文件中顺序一致<br> <img src="https://images2.imgbox.com/d6/9f/16LZczJa_o.png" alt="在这里插入图片描述"><br> 如果顺序错了，双击signals设置开始bit数可以更改<br> <img src="https://images2.imgbox.com/b0/73/SdvAbRjp_o.png" alt="在这里插入图片描述"><br> 全都拖好了，双击新建的Messages，然后点击Layout，如下图所示，可以检查一下报文设置是否正确（图片上的字节顺序，从右至左，从上到下，依次增大）<br> <img src="https://images2.imgbox.com/7f/6e/LycyYFIo_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="223__46"></a>2.2.3 建立节点</h4> 
<p>（1）建立发送和接受节点<br> 右键点击Network nodes -&gt; New，只需输入创建的网络节点名字进行新建操作<br> （2）需要发送的报文直接拖到目标节点下的Tx Messages下面即可<br> （3）需要接收的报文添加：双击打开Receive，选择Mapped Rx Sig.，然后选择Add:all from one message添加我们建立的报文，会将信号添加如下：<br> <img src="https://images2.imgbox.com/5e/1e/5Kqh2Isu_o.png" alt="在这里插入图片描述"><br> 检查节点间的收发关系：在”View”中选择”Communication Matrix…”，可以看到各个节点的收发信号：<br> <img src="https://images2.imgbox.com/4e/fe/iAHBtqWc_o.png" alt="在这里插入图片描述"><br> 在”File”中选择”Consistency Check”,此时会在一致性检查窗口中输出检查结果。会有状态信息及对应的说明，以供我们检查出错/警告报警的原因。下面是我们建立的没有问题的dbc<br> <img src="https://images2.imgbox.com/33/30/WDb7aJEx_o.png" alt="在这里插入图片描述"><br> 编写完成后即可保存，其内容如下：</p> 
<pre><code class="prism language-bash">VERSION <span class="token string">""</span>


NS_ <span class="token builtin class-name">:</span> 
	NS_DESC_
	CM_
	BA_DEF_
	BA_
	VAL_
	CAT_DEF_
	CAT_
	FILTER
	BA_DEF_DEF_
	EV_DATA_
	ENVVAR_DATA_
	SGTYPE_
	SGTYPE_VAL_
	BA_DEF_SGTYPE_
	BA_SGTYPE_
	SIG_TYPE_REF_
	VAL_TABLE_
	SIG_GROUP_
	SIG_VALTYPE_
	SIGTYPE_VALTYPE_
	BO_TX_BU_
	BA_DEF_REL_
	BA_REL_
	BA_DEF_DEF_REL_
	BU_SG_REL_
	BU_EV_REL_
	BU_BO_REL_
	SG_MUL_VAL_

BS_:

BU_: Base_CAN Base Control


BO_ <span class="token number">1057</span> Control_mode: <span class="token number">1</span> Control
 SG_ Control_mode <span class="token builtin class-name">:</span> <span class="token number">0</span><span class="token operator">|</span><span class="token number">1</span>@1+ <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token string">""</span>  Base

BO_ <span class="token number">273</span> Motion_Control: <span class="token number">8</span> Control
 SG_ Steer_Angle_control_L <span class="token builtin class-name">:</span> <span class="token number">56</span><span class="token operator">|</span><span class="token number">8</span>@1+ <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">255</span><span class="token punctuation">]</span> <span class="token string">""</span>  Base
 SG_ Steer_Angle_control_H <span class="token builtin class-name">:</span> <span class="token number">48</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>-127<span class="token operator">|</span><span class="token number">127</span><span class="token punctuation">]</span> <span class="token string">""</span>  Base
 SG_ Stay_7 <span class="token builtin class-name">:</span> <span class="token number">40</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token string">""</span>  Base
 SG_ Stay_6 <span class="token builtin class-name">:</span> <span class="token number">32</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token string">""</span>  Base
 SG_ Stay_5 <span class="token builtin class-name">:</span> <span class="token number">24</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token string">""</span>  Base
 SG_ Stay_4 <span class="token builtin class-name">:</span> <span class="token number">16</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token string">""</span>  Base
 SG_ Velocity_control_Low <span class="token builtin class-name">:</span> <span class="token number">8</span><span class="token operator">|</span><span class="token number">8</span>@1+ <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">255</span><span class="token punctuation">]</span> <span class="token string">""</span>  Base
 SG_ Velocity_control_High <span class="token builtin class-name">:</span> <span class="token number">0</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>-127<span class="token operator">|</span><span class="token number">127</span><span class="token punctuation">]</span> <span class="token string">""</span>  Base

BO_ <span class="token number">545</span> Motion_Feedback: <span class="token number">8</span> Base_CAN
 SG_ Steer_Angle_L <span class="token builtin class-name">:</span> <span class="token number">56</span><span class="token operator">|</span><span class="token number">8</span>@1+ <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">255</span><span class="token punctuation">]</span> <span class="token string">""</span>  Control
 SG_ Steer_Angle_H <span class="token builtin class-name">:</span> <span class="token number">48</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>-127<span class="token operator">|</span><span class="token number">127</span><span class="token punctuation">]</span> <span class="token string">""</span>  Control
 SG_ Stay_3 <span class="token builtin class-name">:</span> <span class="token number">40</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token string">""</span>  Control
 SG_ Stay_2 <span class="token builtin class-name">:</span> <span class="token number">32</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token string">""</span>  Control
 SG_ Stay_1 <span class="token builtin class-name">:</span> <span class="token number">24</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token string">""</span>  Control
 SG_ Stay_0 <span class="token builtin class-name">:</span> <span class="token number">16</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token string">""</span>  Control
 SG_ Velocity_Low <span class="token builtin class-name">:</span> <span class="token number">8</span><span class="token operator">|</span><span class="token number">8</span>@1+ <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">255</span><span class="token punctuation">]</span> <span class="token string">""</span>  Control
 SG_ Velocity_High <span class="token builtin class-name">:</span> <span class="token number">0</span><span class="token operator">|</span><span class="token number">8</span>@1- <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>-127<span class="token operator">|</span><span class="token number">127</span><span class="token punctuation">]</span> <span class="token string">""</span>  Control



BA_DEF_  <span class="token string">"MultiplexExtEnabled"</span> ENUM  <span class="token string">"No"</span>,<span class="token string">"Yes"</span><span class="token punctuation">;</span>
BA_DEF_  <span class="token string">"BusType"</span> STRING <span class="token punctuation">;</span>
BA_DEF_DEF_  <span class="token string">"MultiplexExtEnabled"</span> <span class="token string">"No"</span><span class="token punctuation">;</span>
BA_DEF_DEF_  <span class="token string">"BusType"</span> <span class="token string">"CAN"</span><span class="token punctuation">;</span>
</code></pre> 
<p>重点关注报文以及信号：</p> 
<pre><code class="prism language-bash">报文格式：
BO_ MessageId MessageName: MessageSize Transmitter
			
		MessageId 			为10进制表示的报文ID，类型为longlogn型，即CAN ID
		MessageName 		报文的名字，与C语言命令规范相同
		MessageSize 		报文数据段字节数
		Transmitter 		该报文的网络节点，如果该报文没有指定发送节点，则该值需设置为”Vector__XXX”

举例：
以下是DBC中代表一条消息的描述信息
BO_ <span class="token number">545</span> Motion_Feedback: <span class="token number">8</span> Base_CAN


解释
BO_								代表一条消息的起始标识
<span class="token number">545</span>  							消息ID的十进制形式，<span class="token operator">=</span>0x3f7
Motion_Feedback					消息名
<span class="token number">8</span>								消息报文长度，帧字节数
Base_CAN						发出该消息的网络节点，标识为Vector__XXX时未指明具体节点
</code></pre> 
<pre><code class="prism language-bash">信号格式
SG_ SignalName <span class="token punctuation">(</span>SigTypeDefinition<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> StartBit<span class="token operator">|</span>SignalSize@ByteOrder ValueType <span class="token punctuation">(</span>Factor,Offset<span class="token punctuation">)</span> <span class="token punctuation">[</span>Min<span class="token operator">|</span>Max<span class="token punctuation">]</span> Unit Receiver

		SignalName <span class="token punctuation">(</span>SigTypeDefinition<span class="token punctuation">)</span> 	表示该信号的名字 和 多路选择信号的定义
		SigTypeDefinition	是可选项，有3种格式：
				a<span class="token operator">&gt;</span> 空
				b<span class="token operator">&gt;</span> M 表示多路选择器信号
				c<span class="token operator">&gt;</span> m50 表示被多路选择器选择的信号，50表示当‘M’定义的信号的值等于50的时候，该报文使用此通路
		StartBit<span class="token operator">|</span>SignalSize 表示该信号的起始位及信号长度
		ByteOrder 	表示信号的字节顺序：0代表Motorola格式，1代表Inter格式
		ValueType 	表示该信号的数值类型：+表示无符号数，-表示有符号数
		Factor,Offset 	表示因子，偏移量；这两个值用于信号的原始值与物理值之间的转换。 转换公式：物理值<span class="token operator">=</span>原始值*因子+偏移量
		Min<span class="token operator">|</span>Max 	表示该信号的最小值和最大值，即指定了该信号值的范围；这两个值为double类型
		Unit 	表示该信号的物理单位，为字符串类型
		Receiver 表示该信号的接收节点<span class="token punctuation">(</span>可以是多个节点<span class="token punctuation">)</span>；若该信号没有指定的接收节点，则必须设置为” Vector__XXX”

举例：
每条报文消息里面有多个报文信号，报文信号的信息的起始标识为<span class="token string">"SG_"</span>, 
它以一个<span class="token string">"BO_"</span>开始至下一<span class="token string">"BO_"</span>之间的内容止，详细报文消息以缩进1或2个空格符形式类似树图子节点的方式呈现。
一条消息下的一个信号的信息，此处缩进一个空格
 SG_ Steer_Angle_L <span class="token builtin class-name">:</span> <span class="token number">56</span><span class="token operator">|</span><span class="token number">8</span>@1+ <span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">255</span><span class="token punctuation">]</span> <span class="token string">""</span>  Control

解释：
SG_							代表一个信号信息的起始标识
Steer_Angle_L	     	 	信号名，分长名与短名，此处是短名。长名非必须存在，可以不定义
<span class="token number">56</span>							信号起始bit
<span class="token operator">|</span>							分割符号
<span class="token number">8</span>							信号总bit长度
@1+							@0表示是Motorola格式（Intel格式是1），+表示是无符号数据
<span class="token punctuation">(</span><span class="token number">1,0</span><span class="token punctuation">)</span>						<span class="token punctuation">(</span>精度值，偏移值）
<span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">255</span><span class="token punctuation">]</span>						<span class="token punctuation">[</span>最小值<span class="token operator">|</span>最大值<span class="token punctuation">]</span>， 物理意义的最小与最大，现实世界的有物理意义的值，比如此处仪表续航里程最大999KM
<span class="token string">""</span>						<span class="token string">"单位"</span>
Control						接收处理此信号的节点，同样可以不指明，写为Vector__XXX
</code></pre> 
<h2><a id="DBCROS2_186"></a>三、根据DBC文件编写ROS2驱动程序</h2> 
<p>在得到了dbc文件之后，即可调用cantools库进行UDP通信的程序编写</p> 
<pre><code class="prism language-bash">pip3 <span class="token function">install</span> <span class="token assign-left variable">cantools</span><span class="token operator">==</span><span class="token number">39.0</span>.0
</code></pre> 
<p>参考栏目其他文章，Autoware.universe需要接收底盘反馈的速度<code>/vehicle/status/velocity_status</code>等消息，同时发送自定义的速度控制消息<code>twist_cmd_feedback</code>到底盘以控制小车运动，代码编写如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> math
<span class="token keyword">import</span> time
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> cantools
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> rclpy
<span class="token keyword">from</span> rclpy<span class="token punctuation">.</span>node <span class="token keyword">import</span> Node
<span class="token keyword">from</span> builtin_interfaces<span class="token punctuation">.</span>msg <span class="token keyword">import</span> Time
<span class="token keyword">from</span> binascii <span class="token keyword">import</span> hexlify
<span class="token keyword">from</span> geometry_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> TwistStamped<span class="token punctuation">,</span> Twist
<span class="token keyword">from</span> autoware_auto_control_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> AckermannControlCommand
<span class="token keyword">from</span> autoware_auto_vehicle_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> ControlModeReport<span class="token punctuation">,</span> GearReport<span class="token punctuation">,</span> SteeringReport<span class="token punctuation">,</span> VelocityReport

<span class="token comment"># 创建UDP socket套接字</span>
<span class="token comment"># AF_INET表示使用ipv4,默认不变，SOCK_DGRAM表示使用UDP通信协议</span>
udp_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>

<span class="token comment"># 绑定UDP的本机端口port</span>
local_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"192.168.1.102"</span><span class="token punctuation">,</span> <span class="token number">8882</span><span class="token punctuation">)</span>  <span class="token comment"># 本地ip，端口号</span>
udp_socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>local_addr<span class="token punctuation">)</span>  <span class="token comment"># 绑定端口</span>

<span class="token comment"># 指定要接收的前五个字节的CAN协议数据</span>
EXPECTED_DATA <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 控制小车以0.15m/S的速度前进(0x96-&gt;150mm/s,150/100=0.15m/s)</span>
test1 <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
              <span class="token number">0x96</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 控制小车转向0.2rad(0xC8-&gt;200x0.001rad-&gt;0.2rad)</span>
test2 <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
              <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xC8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 运动控制消息</span>
data_Control_mode <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'Velocity_control_High'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Velocity_control_Low'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                     <span class="token string">'Stay_4'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Stay_5'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Stay_6'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Stay_7'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                     <span class="token string">'Steer_Angle_control_H'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Steer_Angle_control_L'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>

<span class="token comment"># 运动反馈消息</span>
data_Motion_Feedback <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'Velocity_High'</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">'Velocity_Low'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token string">'Stay_0'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Stay_1'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Stay_2'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Stay_3'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token string">'Steer_Angle_H'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Steer_Angle_L'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">}</span>

<span class="token comment"># Control_mode的帧信息与帧ID</span>
message_Control_mode_front <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># ---------------------------------------------------------接收底盘数据</span>
<span class="token keyword">def</span> <span class="token function">calculate_speed</span><span class="token punctuation">(</span>linear_speed<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 根据通讯协议将线速度m/s转化为int16的高低位</span>
    <span class="token comment"># 车体行进速度，单位mm/s(有效值+ -4800)</span>
    <span class="token keyword">if</span> linear_speed <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> linear_speed <span class="token operator">&gt;</span> <span class="token number">4.8</span><span class="token punctuation">:</span>
            linear_speed <span class="token operator">=</span> <span class="token number">4.8</span>
        Speed_H<span class="token punctuation">,</span> Speed_L <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>linear_speed <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Velocity_control_Low'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Speed_L
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Velocity_control_High'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Speed_H
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> linear_speed <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">4.8</span><span class="token punctuation">:</span>
            linear_speed <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4.8</span>
        Speed_H<span class="token punctuation">,</span> Speed_L <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token operator">-</span>linear_speed <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Velocity_control_Low'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Speed_L
        <span class="token comment"># 设置最高位为1表示负数</span>
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Velocity_control_High'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x80</span> <span class="token operator">|</span> Speed_H

    <span class="token comment"># print('EV_Speed_H:%f' % EV_Speed_H)</span>
    <span class="token comment"># print('EV_Speed_L:%f' % EV_Speed_L)</span>


<span class="token keyword">def</span> <span class="token function">calculate_angle</span><span class="token punctuation">(</span>linear_speed<span class="token punctuation">,</span> angular_speed<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 转向内转角角度单位：0.001rad (有效值+-400)</span>
    <span class="token comment"># 转弯的角度 = arctan(( 角速度 / 线速度 ) * 车长 )</span>
    Steer_Angle <span class="token operator">=</span> math<span class="token punctuation">.</span>atan<span class="token punctuation">(</span><span class="token punctuation">(</span>angular_speed<span class="token operator">/</span>linear_speed<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># print('Steer_Angle:%f' % Steer_Angle)</span>

    <span class="token keyword">if</span> Steer_Angle <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> Steer_Angle <span class="token operator">&gt;</span> <span class="token number">0.4</span><span class="token punctuation">:</span>
            Steer_Angle <span class="token operator">=</span> <span class="token number">0.4</span>
        Steer_Angle_H<span class="token punctuation">,</span> Steer_Angle_L <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>Steer_Angle <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Steer_Angle_control_L'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Steer_Angle_L
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Steer_Angle_control_H'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Steer_Angle_H
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> linear_speed <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">:</span>
            linear_speed <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.4</span>
        Steer_Angle_H<span class="token punctuation">,</span> Steer_Angle_L <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token operator">-</span>Steer_Angle <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Steer_Angle_control_L'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Steer_Angle_L
        <span class="token comment"># 设置最高位为1表示负数</span>
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Steer_Angle_control_H'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x80</span> <span class="token operator">|</span> Steer_Angle_H


<span class="token keyword">def</span> <span class="token function">calculate_angle</span><span class="token punctuation">(</span>Steer_Angle<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># print("Steer_Angle:", Steer_Angle)</span>
    <span class="token keyword">if</span> Steer_Angle <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> Steer_Angle <span class="token operator">&gt;</span> <span class="token number">0.4</span><span class="token punctuation">:</span>
            Steer_Angle <span class="token operator">=</span> <span class="token number">0.4</span>
        Steer_Angle_H<span class="token punctuation">,</span> Steer_Angle_L <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>Steer_Angle <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Steer_Angle_control_L'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Steer_Angle_L
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Steer_Angle_control_H'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Steer_Angle_H
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> linear_speed <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">:</span>
            linear_speed <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.4</span>
        Steer_Angle_H<span class="token punctuation">,</span> Steer_Angle_L <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token operator">-</span>Steer_Angle <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Steer_Angle_control_L'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Steer_Angle_L
        <span class="token comment"># 设置最高位为1表示负数</span>
        data_Control_mode<span class="token punctuation">[</span><span class="token string">'Steer_Angle_control_H'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x80</span> <span class="token operator">|</span> Steer_Angle_H


<span class="token comment"># udp向底盘发送can协议</span>
<span class="token keyword">def</span> <span class="token function">udp_send_can</span><span class="token punctuation">(</span>message_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 底盘ip和端口号</span>
    udp_socket<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>message_name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"192.168.1.10"</span><span class="token punctuation">,</span> <span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 处理接收到的CAN消息的函数</span>
<span class="token keyword">def</span> <span class="token function">process_can_message</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 解码CAN消息</span>
    can_data <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 从第6个字节开始是CAN数据</span>
    message <span class="token operator">=</span> node<span class="token punctuation">.</span>db<span class="token punctuation">.</span>decode_message<span class="token punctuation">(</span><span class="token string">"Motion_Feedback"</span><span class="token punctuation">,</span> can_data<span class="token punctuation">)</span>

    <span class="token comment"># 打印解码结果</span>
    <span class="token comment"># print(message)</span>
    <span class="token comment"># print('Steer_Angle_L:', message['Steer_Angle_L'])</span>
    <span class="token comment"># print('Steer_Angle_H:', message['Steer_Angle_H'])</span>
    <span class="token comment"># print('DM_Speed_L:', message['Velocity_Low'])</span>
    <span class="token comment"># print('DM_Speed_H:', message['Velocity_High'])</span>

    <span class="token comment"># 处理CAN中接收到的数据，转化成线速度和角速度</span>
    feedback_twist_linear_x <span class="token operator">=</span> <span class="token punctuation">(</span>
        message<span class="token punctuation">[</span><span class="token string">'Velocity_High'</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> message<span class="token punctuation">[</span><span class="token string">'Velocity_Low'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span>
    Steer_Angle <span class="token operator">=</span> <span class="token punctuation">(</span>message<span class="token punctuation">[</span><span class="token string">'Steer_Angle_H'</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span>
                   message<span class="token punctuation">[</span><span class="token string">'Steer_Angle_L'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span>
    
    <span class="token comment"># 角速度 = tan(转向角度) * 线速度 / 前后轮轴距</span>
    feedback_twist_angular_z <span class="token operator">=</span> math<span class="token punctuation">.</span>tan<span class="token punctuation">(</span>Steer_Angle<span class="token punctuation">)</span> <span class="token operator">*</span> feedback_twist_linear_x <span class="token operator">/</span> <span class="token number">1</span>

    <span class="token comment"># 发布处理后的Twist消息到另一个话题</span>
    node<span class="token punctuation">.</span>publish_data<span class="token punctuation">(</span>feedback_twist_linear_x<span class="token punctuation">,</span> feedback_twist_angular_z<span class="token punctuation">)</span>
    node<span class="token punctuation">.</span>pubilsh_control_mode<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    node<span class="token punctuation">.</span>pubilsh_gear<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    node<span class="token punctuation">.</span>pubilsh_steering<span class="token punctuation">(</span>Steer_Angle<span class="token punctuation">)</span>
    node<span class="token punctuation">.</span>pubilsh_velocity<span class="token punctuation">(</span><span class="token string">"base_link"</span><span class="token punctuation">,</span> feedback_twist_linear_x<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span>


<span class="token comment"># 接收数据的线程函数</span>
<span class="token keyword">def</span> <span class="token function">receive_data</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> rclpy<span class="token punctuation">.</span>ok<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 一帧指令有多少字节</span>
        data<span class="token punctuation">,</span> addr <span class="token operator">=</span> udp_socket<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>
        <span class="token comment"># print(hexlify(data).decode('ascii'))</span>

        <span class="token comment"># 确保接收到的数据满足预期的CAN数据</span>
        <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> EXPECTED_DATA<span class="token punctuation">:</span>
            <span class="token comment"># 在新的线程中处理CAN消息，以保证实时性</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>process_can_message<span class="token punctuation">,</span>
                             args<span class="token operator">=</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># -----------------------------------------------------------控制底盘</span>
<span class="token keyword">class</span> <span class="token class-name">TopicSubscriberPublisher</span><span class="token punctuation">(</span>Node<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token string">'cmd_vel_to_can_hunter'</span><span class="token punctuation">)</span>
        <span class="token comment"># 加载dbc文件</span>
        self<span class="token punctuation">.</span>declare_parameter<span class="token punctuation">(</span><span class="token string">"dbc_hunter"</span><span class="token punctuation">)</span>
        dbcfile <span class="token operator">=</span> self<span class="token punctuation">.</span>get_parameter<span class="token punctuation">(</span>
            <span class="token string">"dbc_hunter"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_parameter_value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string_value
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> cantools<span class="token punctuation">.</span>database<span class="token punctuation">.</span>load_file<span class="token punctuation">(</span>dbcfile<span class="token punctuation">)</span>

        <span class="token comment"># CAN指令模式：08 00 00 04 21 01</span>
        self<span class="token punctuation">.</span>can_command <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>subscriber <span class="token operator">=</span> self<span class="token punctuation">.</span>create_subscription<span class="token punctuation">(</span>
            AckermannControlCommand<span class="token punctuation">,</span> <span class="token string">'control/command/control_cmd'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>sub_callback<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>publisher_data <span class="token operator">=</span> self<span class="token punctuation">.</span>create_publisher<span class="token punctuation">(</span>
            Twist<span class="token punctuation">,</span> <span class="token string">'twist_cmd_feedback'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>publisher_control_mode <span class="token operator">=</span> self<span class="token punctuation">.</span>create_publisher<span class="token punctuation">(</span>
            ControlModeReport<span class="token punctuation">,</span> <span class="token string">'/vehicle/status/control_mode'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>publisher_gear <span class="token operator">=</span> self<span class="token punctuation">.</span>create_publisher<span class="token punctuation">(</span>
            GearReport<span class="token punctuation">,</span> <span class="token string">'/vehicle/status/gear_status'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>publisher_steering <span class="token operator">=</span> self<span class="token punctuation">.</span>create_publisher<span class="token punctuation">(</span>
            SteeringReport<span class="token punctuation">,</span> <span class="token string">'/vehicle/status/steering_status'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>publisher_velocity <span class="token operator">=</span> self<span class="token punctuation">.</span>create_publisher<span class="token punctuation">(</span>
            VelocityReport<span class="token punctuation">,</span> <span class="token string">'/vehicle/status/velocity_status'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token comment"># self.get_logger().info('TopicSubscriberPublisher node initialized')</span>

    <span class="token keyword">def</span> <span class="token function">sub_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. 发送CAN指令模式：08 00 00 04 21 01</span>
        udp_send_can<span class="token punctuation">(</span>self<span class="token punctuation">.</span>can_command<span class="token punctuation">)</span>

        <span class="token comment"># 2. 接收autoware传来的线速度和角速度</span>
        Speed <span class="token operator">=</span> msg<span class="token punctuation">.</span>longitudinal<span class="token punctuation">.</span>speed
        <span class="token comment"># angular_velocity = msg.lateral.steering_tire_rotation_rate</span>
        angular_rad <span class="token operator">=</span> msg<span class="token punctuation">.</span>lateral<span class="token punctuation">.</span>steering_tire_angle
        <span class="token comment"># print('angular_velocity:%f' % angular_velocity)</span>
        <span class="token comment"># print('angular_rad:%f' % angular_rad)</span>

        <span class="token comment"># 3. 计算速度、角度</span>
        calculate_speed<span class="token punctuation">(</span>Speed<span class="token punctuation">)</span>
        <span class="token comment"># calculate_angle(1, angular_velocity)</span>
        calculate_angle<span class="token punctuation">(</span>Speed<span class="token punctuation">,</span> angular_rad<span class="token punctuation">)</span>

        <span class="token comment"># 4. 发送can消息</span>
        message_Motion_Control <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>encode_message<span class="token punctuation">(</span>
            <span class="token string">"Motion_Control"</span><span class="token punctuation">,</span> data_Control_mode<span class="token punctuation">)</span>
        message_linear_velocity <span class="token operator">=</span> message_Control_mode_front <span class="token operator">+</span> message_Motion_Control
        <span class="token comment"># print(hexlify(message_linear_velocity).decode('ascii'))</span>
        udp_send_can<span class="token punctuation">(</span>message_linear_velocity<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">publish_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data1<span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> Twist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        msg<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x <span class="token operator">=</span> data1
        msg<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>z <span class="token operator">=</span> data2
        self<span class="token punctuation">.</span>publisher_data<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">pubilsh_control_mode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> ControlModeReport<span class="token punctuation">(</span><span class="token punctuation">)</span>
        msg<span class="token punctuation">.</span>mode <span class="token operator">=</span> data
        self<span class="token punctuation">.</span>publisher_control_mode<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">pubilsh_gear</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> GearReport<span class="token punctuation">(</span><span class="token punctuation">)</span>
        msg<span class="token punctuation">.</span>report <span class="token operator">=</span> data
        self<span class="token punctuation">.</span>publisher_gear<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">pubilsh_steering</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> SteeringReport<span class="token punctuation">(</span><span class="token punctuation">)</span>
        msg<span class="token punctuation">.</span>steering_tire_angle <span class="token operator">=</span> data
        self<span class="token punctuation">.</span>publisher_steering<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">pubilsh_velocity</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data1<span class="token punctuation">,</span> data2<span class="token punctuation">,</span> data3<span class="token punctuation">,</span> data4<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> VelocityReport<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取当前时间</span>
        <span class="token comment"># 秒</span>
        sec_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 纳秒</span>
        nanosec_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>sec_<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1e9</span><span class="token punctuation">)</span>
        msg<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> Time<span class="token punctuation">(</span>sec<span class="token operator">=</span>sec_<span class="token punctuation">,</span> nanosec<span class="token operator">=</span>nanosec_<span class="token punctuation">)</span>
        msg<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> data1
        msg<span class="token punctuation">.</span>longitudinal_velocity <span class="token operator">=</span> data2
        msg<span class="token punctuation">.</span>lateral_velocity <span class="token operator">=</span> data3
        msg<span class="token punctuation">.</span>heading_rate <span class="token operator">=</span> data4
        self<span class="token punctuation">.</span>publisher_velocity<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化</span>
    rclpy<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 新建一个节点</span>
    node <span class="token operator">=</span> TopicSubscriberPublisher<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 启动接收CAN数据的线程</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>receive_data<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 在CAN指令模式下，需要保证0X111指令帧以小于500MS的周期（建议周期20MS）发送，否则HUNTER</span>
    <span class="token comment"># SE会判定为控制信号心跳丢失而进入报错（0X211反馈上层通讯失联），系统报错后会进入待机模式</span>
    <span class="token comment"># 保持节点运行，检测是否收到退出指令（Ctrl+C）</span>
    rclpy<span class="token punctuation">.</span>spin<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

    <span class="token comment"># 清理并关闭ros2节点</span>
    node<span class="token punctuation">.</span>destroy_node<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rclpy<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>编写setup.py和launch文件</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> setuptools <span class="token keyword">import</span> setup

package_name <span class="token operator">=</span> <span class="token string">'can_ros2_bridge'</span>

setup<span class="token punctuation">(</span>
    name<span class="token operator">=</span>package_name<span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token string">'0.0.0'</span><span class="token punctuation">,</span>
    packages<span class="token operator">=</span><span class="token punctuation">[</span>package_name<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment"># 安装文件至install</span>
    data_files<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token string">'share/ament_index/resource_index/packages'</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">'resource/'</span> <span class="token operator">+</span> package_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'share/'</span> <span class="token operator">+</span> package_name<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'package.xml'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'share/'</span> <span class="token operator">+</span>package_name<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'launch/can_hunter.launch.py'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'share/'</span> <span class="token operator">+</span>package_name<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'config/Hunter.dbc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    install_requires<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'setuptools'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    zip_safe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    maintainer<span class="token operator">=</span><span class="token string">'car'</span><span class="token punctuation">,</span>
    maintainer_email<span class="token operator">=</span><span class="token string">'car@todo.todo'</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">'TODO: Package description'</span><span class="token punctuation">,</span>
    license<span class="token operator">=</span><span class="token string">'TODO: License declaration'</span><span class="token punctuation">,</span>
    tests_require<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'pytest'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment"># 可执行文件</span>
    entry_points<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">'console_scripts'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">'cmd_vel_to_can_hunter = can_ros2_bridge.send_message_hunter:main'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> launch <span class="token keyword">import</span> LaunchDescription
<span class="token keyword">from</span> launch_ros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> Node
<span class="token keyword">import</span> os
<span class="token keyword">from</span> ament_index_python<span class="token punctuation">.</span>packages <span class="token keyword">import</span> get_package_share_directory

<span class="token keyword">def</span> <span class="token function">generate_launch_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 去install找配置文件</span>
    config_hunter <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
      get_package_share_directory<span class="token punctuation">(</span><span class="token string">'can_ros2_bridge'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'Hunter.dbc'</span>
      <span class="token punctuation">)</span>

    can_ros2_bridge <span class="token operator">=</span> Node<span class="token punctuation">(</span>
        package<span class="token operator">=</span><span class="token string">'can_ros2_bridge'</span><span class="token punctuation">,</span>
        executable<span class="token operator">=</span><span class="token string">'cmd_vel_to_can_hunter'</span><span class="token punctuation">,</span>
        name<span class="token operator">=</span><span class="token string">'can'</span><span class="token punctuation">,</span>
        parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'dbc_hunter'</span><span class="token punctuation">:</span> config_hunter<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        output<span class="token operator">=</span><span class="token string">"both"</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> LaunchDescription<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            can_ros2_bridge<span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_520"></a>四、实际通信调试</h2> 
<p>上述代码中，有两个需要注意的，分别是主机和CAN盒的IP以及端口，CAN盒的IP以及端口是固定的（可能需要在上位机中修改），可以在盒子上看到，需要设置本机IP与CAN盒在同一局域网下，例如CAN盒的是"192.168.1.10", 6666，那么设置主机静态IP，最后一位不同即可：<br> <img src="https://images2.imgbox.com/6a/58/aE0RMNIp_o.png" alt="在这里插入图片描述"><br> 接着安装wireshark网络调试工具：</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> wireshark
</code></pre> 
<p>然后打开wireshark</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> wireshark
</code></pre> 
<p>可以看到底盘反馈的数据：6666-&gt;8882端口，192.168.4.101-&gt;192.168.4.101（图不是我的因此IP不一样，关键是数据传输路线）<br> <img src="https://images2.imgbox.com/00/1d/7ilymgZm_o.png" alt="在这里插入图片描述"><br> 数据通了之后修改代码IP和端口，即可实现CAN通信</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/27e86d90da08213fe02c4746699cb39a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">前端js调取摄像头并实现拍照功能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9f6de3471b4224f18e59c4edcc36696d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringBoot使用ObjectMapper之Long和BigDemical类型的属性字符串处理，防止前端丢失数值精度</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>