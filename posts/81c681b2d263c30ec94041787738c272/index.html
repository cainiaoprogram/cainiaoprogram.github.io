<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s-docker二进制(1.28)的搭建 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s-docker二进制(1.28)的搭建" />
<meta property="og:description" content="二进制文件-docker方式 1、准备的服务器 角色ip组件k8s-master1192.168.11.111kube-apiserver,kube-controller-manager,kube-scheduler,etcdk8s-master2192.168.11.112kube-apiserver,kube-controller-manager,kube-scheduler,etcdk8s-node1192.168.11.113kubelet,kube-proxy,dockerk8s-node2192.168.11.114kubelet,kube-proxy,dockerLoad Balancer(Master)192.168.11.115keepalived,haproxyLoad Balancer(Backup)192.168.11.116keepalived,haproxylb192.168.11.100(VIP) 2、系统初始化 1、设置host 根据上面的规划执行 #安装集群环境所需要的依赖 yum install wget sed vim tree jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y hostnamectl set-hostname k8s-master1 #在master执行 hostnamectl set-hostname 其他省略 2、关闭防火墙 #关闭现有防火墙firewalld systemctl disable firewalld systemctl stop firewalld firewall-cmd --state 3、关闭selinux #关闭selinux setenforce 0 #临时 sed -ri &#39;s/SELINUX=enforcing/SELINUX=disabled/&#39; /etc/selinux/config #永久（一定要重启操作系统） sestatus 4、交换分区设置 #关闭 swap swapoff -a #临时 sed -ri &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab #永久 echo &#34;vm.swappiness=0&#34; &gt;&gt; /etc/sysctl.conf #永久 当前操作系统没办法重启。执行此操作 sysctl -p 5、主机与IP地址解析(全部执行) #添加hosts[所有节点都添加] cat &gt; /etc/hosts &lt;&lt; EOF 127." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/81c681b2d263c30ec94041787738c272/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-10T11:37:48+08:00" />
<meta property="article:modified_time" content="2023-11-10T11:37:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s-docker二进制(1.28)的搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2>二进制文件-docker方式</h2> 
<h2><a id="1_2"></a>1、准备的服务器</h2> 
<table><thead><tr><th align="center">角色</th><th align="center">ip</th><th align="center">组件</th></tr></thead><tbody><tr><td align="center">k8s-master1</td><td align="center">192.168.11.111</td><td align="center">kube-apiserver,kube-controller-manager,kube-scheduler,etcd</td></tr><tr><td align="center">k8s-master2</td><td align="center">192.168.11.112</td><td align="center">kube-apiserver,kube-controller-manager,kube-scheduler,etcd</td></tr><tr><td align="center">k8s-node1</td><td align="center">192.168.11.113</td><td align="center">kubelet,kube-proxy,docker</td></tr><tr><td align="center">k8s-node2</td><td align="center">192.168.11.114</td><td align="center">kubelet,kube-proxy,docker</td></tr><tr><td align="center">Load Balancer(Master)</td><td align="center">192.168.11.115</td><td align="center">keepalived,haproxy</td></tr><tr><td align="center">Load Balancer(Backup)</td><td align="center">192.168.11.116</td><td align="center">keepalived,haproxy</td></tr><tr><td align="center">lb</td><td align="center">192.168.11.100(VIP)</td><td align="center"></td></tr></tbody></table> 
<h2><a id="2_14"></a>2、系统初始化</h2> 
<h3><a id="1host__15"></a>1、设置host 根据上面的规划执行</h3> 
<pre><code class="prism language-shell"><span class="token comment">#安装集群环境所需要的依赖</span>
yum <span class="token function">install</span> <span class="token function">wget</span> <span class="token function">sed</span>  <span class="token function">vim</span> tree jq psmisc <span class="token function">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> <span class="token parameter variable">-y</span>
hostnamectl set-hostname k8s-master1 <span class="token comment">#在master执行</span>
hostnamectl set-hostname 其他省略
</code></pre> 
<h3><a id="2_22"></a>2、关闭防火墙</h3> 
<pre><code class="prism language-shell"><span class="token comment">#关闭现有防火墙firewalld</span>
systemctl disable firewalld
systemctl stop firewalld
firewall-cmd <span class="token parameter variable">--state</span>
</code></pre> 
<h3><a id="3selinux_29"></a>3、关闭selinux</h3> 
<pre><code class="prism language-shell"><span class="token comment">#关闭selinux</span>
setenforce <span class="token number">0</span> <span class="token comment">#临时</span>
<span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> /etc/selinux/config <span class="token comment">#永久（一定要重启操作系统）</span>
sestatus
</code></pre> 
<h3><a id="4_36"></a>4、交换分区设置</h3> 
<pre><code class="prism language-shell"><span class="token comment">#关闭 swap</span>
swapoff <span class="token parameter variable">-a</span> <span class="token comment">#临时</span>
<span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab <span class="token comment">#永久</span>
<span class="token builtin class-name">echo</span> <span class="token string">"vm.swappiness=0"</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf <span class="token comment">#永久 当前操作系统没办法重启。执行此操作</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span>
</code></pre> 
<h3><a id="5IP_44"></a>5、主机与IP地址解析(全部执行)</h3> 
<pre><code class="prism language-shell"><span class="token comment">#添加hosts[所有节点都添加]</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.11.111 k8s-master1
192.168.11.112 k8s-master2
192.168.11.113 k8s-node1
192.168.11.114 k8s-node2
192.168.11.115 k8s-lb1
192.168.11.116 k8s-lb2
EOF</span>
<span class="token comment">#重启生效</span>
<span class="token function">sysctl</span> <span class="token parameter variable">--system</span> <span class="token comment">#生效</span>
</code></pre> 
<h3><a id="6_60"></a>6、主机系统时间同步</h3> 
<pre><code class="prism language-shell"><span class="token comment">#时间同步</span>
yum <span class="token function">install</span> ntpdate <span class="token parameter variable">-y</span>
ntpdate time.windows.com
<span class="token comment">#制定时间同步计划任务 一个小时做一次时间同步</span>
<span class="token comment">#1、创建命令</span>
<span class="token function">crontab</span> <span class="token parameter variable">-e</span>
<span class="token comment">#2、按a进入编辑状态</span>
a
<span class="token comment">#3、编辑一下内容</span>
<span class="token number">0</span> */1 * * * ntpdate time1.aliyun.com
<span class="token comment">#4、wq保存即可</span>
wq
</code></pre> 
<h3><a id="7ipvs_75"></a>7、主机ipvs管理工具安装及模块加载</h3> 
<p><font color="red"><code>为集群节点安装，负载均衡节点不用安装(ha1、ha2不安装)</code></font></p> 
<pre><code class="prism language-shell">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> ipvsadm ipset sysstat conntrack libseccomp
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&lt;&lt;</span><span class="token string">EOF
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
EOF</span>
<span class="token comment">#授权、运行、检查是否加载</span>
<span class="token function">chmod</span> <span class="token number">755</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&amp;&amp;</span> lsmod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-e</span> ip_vs <span class="token parameter variable">-e</span> nf_conntrack
</code></pre> 
<h3><a id="8_89"></a>8、主机系统优化</h3> 
<pre><code class="prism language-shell"><span class="token comment">#ulimit -SHn 65535  #临时的</span>
<span class="token comment">#永久的</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;&gt;</span> /etc/security/limits.conf</span>
* soft nofile 655360
* hard nofile 131072
* soft nproc 655350
* hard nproc 655350
* soft memlock unlimited
* hard memlock unlimited
EOF</span>
</code></pre> 
<h3><a id="9Linux_102"></a>9、Linux内核升级</h3> 
<pre><code class="prism language-shell"><span class="token comment">#安装perl</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> perl
<span class="token comment">#导入el</span>
<span class="token function">rpm</span> <span class="token parameter variable">--import</span> https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
<span class="token comment">#将elrepo导入到linux系统中(yam源)</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm
<span class="token comment">#安装kernel-lt版本，ml为最新稳定版本，lt为长期维护版本</span>
yum <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">"elrepo-kernel"</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> kernel-lt.x86_64
<span class="token comment">#设置刚才升级的为内核优先启动项</span>
grub2-set-default <span class="token number">0</span>
<span class="token comment">#执行生效操作</span>
grub2-mkconfig <span class="token parameter variable">-o</span> /boot/grub2/grub.cfg
</code></pre> 
<h3><a id="10_117"></a>10、开启主机内核路由转发及网桥过滤</h3> 
<ul><li>所有主机均需要操作。<br> 配置内核加载<code>br_netfilter</code>和<code>iptables</code>放行<code>ipv6</code>和<code>ipv4</code>的流量，确保集群内的容器能够正常通信。</li></ul> 
<pre><code class="prism language-shell"><span class="token comment">#内核优化k8s.conf</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf</span>
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward = 1
vm.swappiness = 0
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 131072
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
EOF</span>
<span class="token comment">#设置生效</span>
<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>
<span class="token comment">#加载br_netfilter</span>
modprobe br_netfilter
<span class="token comment">#查看是否加载</span>
lsmod <span class="token operator">|</span> <span class="token function">grep</span> br_netfilter
</code></pre> 
<h3><a id="9_157"></a>9、免密登录</h3> 
<p><font color="red">作用：用于服务器之间的相互拷贝、免去密码校验等。不是环境搭建的相关知识点,可省略</font></p> 
<pre><code class="prism language-shell"><span class="token comment">#生成密钥(在k8s-master1上执行)</span>
ssh-keygen
<span class="token comment">#然后将生成的秘钥复制到需要传输文件的服务器上</span>
ssh-copy-id root@k8s-master2
ssh-copy-id root@k8s-master3
ssh-copy-id root@k8s-worker1
<span class="token comment">#配置成功后，尝试登录某个服务器，校验是否生成成功</span>
<span class="token function">ssh</span> root@k8s-master1
</code></pre> 
<h2><a id="2ETCD_169"></a>2、ETCD集群部署</h2> 
<p><a href="https://blog.csdn.net/www1056481167/article/details/134328864">查看 kubernetes2-binary-system(ca-etcd-apiserver).md文档</a></p> 
<h2><a id="3_171"></a>3、负载均衡器安装</h2> 
<p><font color="red">ha1和ha2上执行</font></p> 
<h3><a id="1haproxykeepalived_173"></a>1、安装haproxy与keepalived</h3> 
<pre><code class="prism language-shell">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> haproxy keepalived
</code></pre> 
<h3><a id="2_HAProxy_177"></a>2、 HAProxy配置</h3> 
<p><font color="red">注意住下面的k8s-master对应的master所有节点ip</font></p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/haproxy/haproxy.cfg<span class="token operator">&lt;&lt;</span><span class="token string">"EOF"
global
 maxconn 2000
 ulimit-n 16384
 log 127.0.0.1 local0 err
 stats timeout 30s

defaults
 log global
 mode http
 option httplog
 timeout connect 5000
 timeout client 50000
 timeout server 50000
 timeout http-request 15s
 timeout http-keep-alive 15s

frontend monitor-in
 bind *:33305
 mode http
 option httplog
 monitor-uri /monitor

frontend k8s-master
 bind 0.0.0.0:6443
 bind 127.0.0.1:6443
 mode tcp
 option tcplog
 tcp-request inspect-delay 5s
 default_backend k8s-master

backend k8s-master
 mode tcp
 option tcplog
 option tcp-check
 balance roundrobin
 default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
 #此处将所有的master配置到此处
 server  k8s-master1  192.168.11.111:6443 check
 server  k8s-master2  192.168.11.112:6443 check
EOF</span>
</code></pre> 
<h3><a id="3KeepAlived_222"></a>3、KeepAlived</h3> 
<p><font color="red">主从配置不一致。需要修改好对应的信息</font></p> 
<h4><a id="1ha1_224"></a>1、ha1配置以下文件</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/keepalived/keepalived.conf<span class="token operator">&lt;&lt;</span><span class="token string">"EOF"
! Configuration File for keepalived
global_defs {
   router_id LVS_DEVEL
script_user root
   enable_script_security
}
vrrp_script chk_apiserver {
   script "/etc/keepalived/check_apiserver.sh"
   interval 5
   weight -5
   fall 2 
rise 1
}
vrrp_instance VI_1 {
   #指定当前为主的master
   state MASTER
   interface ens33
   #广播的话暴漏的ip此处为当前ip地址
   mcast_src_ip 192.168.11.115
   virtual_router_id 51
   #优先级100大于从服务的99
   priority 100
   advert_int 2
   authentication {
       auth_type PASS
       auth_pass K8SHA_KA_AUTH
   }
   virtual_ipaddress {
       #配置规划的虚拟ip
       192.168.11.100
   }
   #配置对ha1进行监控的脚本
   track_script {
      #指定执行脚本的名称(vrrp_script chk_apiserver此处做了配置)
      chk_apiserver
   }
}
EOF</span>
</code></pre> 
<h4><a id="2ha2_266"></a>2、ha2配置以下文件</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/keepalived/keepalived.conf<span class="token operator">&lt;&lt;</span><span class="token string">"EOF"
! Configuration File for keepalived
global_defs {
   router_id LVS_DEVEL
script_user root
   enable_script_security
}
vrrp_script chk_apiserver {
   script "/etc/keepalived/check_apiserver.sh"
  interval 5
   weight -5
   fall 2 
rise 1
}
vrrp_instance VI_1 {
   state BACKUP
   interface ens33
   mcast_src_ip 192.168.11.116
   virtual_router_id 51
   priority 99
   advert_int 2
   authentication {
       auth_type PASS
       auth_pass K8SHA_KA_AUTH
   }
   virtual_ipaddress {
       192.168.11.100
   }
   #配置对ha1进行监控的脚本
   track_script {
      #指定执行脚本的名称(vrrp_script chk_apiserver此处做了配置)
      chk_apiserver
   }
}
EOF</span>
</code></pre> 
<h3><a id="4_304"></a>4、健康检查脚本</h3> 
<p><font color="red">ha1及ha2均要配置</font></p> 
<h4><a id="1_306"></a>1、准备检查脚本</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/keepalived/check_apiserver.sh <span class="token operator">&lt;&lt;</span><span class="token string">"EOF"
#!/bin/bash
err=0
for k in $(seq 1 3)
do
   check_code=$(pgrep haproxy)
   if [[ $check_code == "" ]]; then
       err=$(expr $err + 1)
       sleep 1
       continue
   else
       err=0
       break
   fi
done

if [[ $err != "0" ]]; then
   echo "systemctl stop keepalived"
   /usr/bin/systemctl stop keepalived
   exit 1
else
   exit 0
fi
EOF</span>
</code></pre> 
<h4><a id="2_333"></a>2、赋予权限</h4> 
<pre><code class="prism language-shell"><span class="token function">chmod</span> +x /etc/keepalived/check_apiserver.sh
</code></pre> 
<h3><a id="5_337"></a>5、启动服务并验证</h3> 
<pre><code class="prism language-shell">systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> haproxy
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> keepalived
<span class="token comment">#查看启动状态</span>
systemctl status keepalived haproxy
<span class="token comment">#查看虚拟ip是否配置成功了</span>
<span class="token function">ip</span> address show
</code></pre> 
<h2><a id="4Master_347"></a>4、部署Master</h2> 
<p><font color="red">在master1上执行，分发到其他需要的节点</font></p> 
<h3><a id="1kubernetes_349"></a>1、下载kubernetes二进制文件</h3> 
<h4><a id="1_350"></a>1、创建工作目录</h4> 
<pre><code class="prism language-shell"><span class="token comment">#创建临时工作目录.用于将所有需要的文件都整理好放到此处，然后整体打包复制到工作目录中，并且分发给master和对应的worker节点上</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /usr/local/kubernetes/k8s
<span class="token comment">#真正的工作目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/<span class="token punctuation">{<!-- --></span>ssl,cfg,logs<span class="token punctuation">}</span>
<span class="token builtin class-name">cd</span> /usr/local/kubernetes/k8s
<span class="token comment">#创建日志目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/log/kubernetes
</code></pre> 
<h4><a id="2_360"></a>2、软件包下载</h4> 
<pre><code class="prism language-shell"><span class="token comment">#官网地址</span>
<span class="token comment">#https://github.com/kubernetes/kubernetes/releases</span>
<span class="token comment">#wget https://dl.k8s.io/v1.21.10/kubernetes-server-linux-amd64.tar.gz</span>
<span class="token comment">#wget https://dl.k8s.io/v1.27.3/kubernetes-server-linux-amd64.tar.gz</span>
<span class="token function">wget</span> https://dl.k8s.io/v1.28.0/kubernetes-server-linux-amd64.tar.gz
<span class="token comment">#解压缩</span>
<span class="token function">tar</span> <span class="token parameter variable">-xvf</span> kubernetes-server-linux-amd64.tar.gz
<span class="token comment">#进入目录</span>
<span class="token builtin class-name">cd</span> kubernetes/server/bin/
<span class="token comment">#复制到系统可执行目录中</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> kube-apiserver kube-controller-manager kube-scheduler kubectl kubelet kube-proxy /usr/local/bin/
</code></pre> 
<h4><a id="3_374"></a>3、包分发</h4> 
<p><code>分发给master节点</code></p> 
<pre><code class="prism language-shell"><span class="token comment">#master节点创建目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /usr/local/bin
<span class="token comment">#传输文件</span>
<span class="token function">scp</span> kube-apiserver kube-controller-manager kube-scheduler kubectl k8s-master2:/usr/local/bin/
</code></pre> 
<p><code>分发给node节点</code></p> 
<pre><code class="prism language-shell"><span class="token comment">#node节点创建工作目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /usr/local/bin
<span class="token comment">#4、分发kubelet、kube-proxy到服务器(分发给worker主机)</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-node1 k8s-node2<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> kubelet kube-proxy <span class="token variable">$i</span>:/usr/local/bin<span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre> 
<h4><a id="4tokencvs_389"></a>4、生成token.cvs</h4> 
<p><code>Master上的apiserver启用TLS认证后，Node节点kubelet和kube-proxy要和kube-apiserver进行通信，必须使用CA签发的有效整数才可以，当Node节点很多的时候，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化操作流程，k8s引入了TLS Bootstrapping机制来自动颁发客户端证书，kubelet会以一个低权限用户向apiserver申请证书，kubelet的证书由apiserver动态签署.</code></p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/token.csv <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
<span class="token variable"><span class="token variable">$(</span><span class="token function">head</span> <span class="token parameter variable">-c</span> <span class="token number">16</span> /dev/urandom <span class="token operator">|</span> od <span class="token parameter variable">-An</span> <span class="token parameter variable">-t</span> x <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">' '</span><span class="token variable">)</span></span>,kubelet-bootstrap,10001,"system:kubelet-bootstrap"
EOF</span>
</code></pre> 
<h3><a id="2apiserver_396"></a>2、部署apiserver</h3> 
<h4><a id="1apiserver_397"></a>1、准备apiserver证书文件</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span>  /usr/local/kubernetes/etcd
<span class="token comment">#1、使用自签CA签发kube-apiserver HTTPS证书</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> kube-apiserver-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
{
"CN": "kubernetes",
  "hosts": [
    "127.0.0.1",
    "192.168.11.111",
    "192.168.11.112",
    "192.168.11.113",
    "192.168.11.114",
    "192.168.11.115",
    "192.168.11.116",
    "192.168.11.100",
    "10.96.0.1",
    "kubernetes",
    "kubernetes.default",
    "kubernetes.default.svc",
    "kubernetes.default.svc.cluster",
    "kubernetes.default.svc.cluster.local"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "kubemsb",
      "OU": "CN"
    }
  ]
}
EOF</span>
</code></pre> 
<h4><a id="2apiserver_436"></a>2、生成apiserver证书</h4> 
<pre><code class="prism language-shell"><span class="token comment">#生成证书文件(生成kube-apiserver-key.pem、kube-apiserver.pem、kube-apiserver.csr)</span>
cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes kube-apiserver-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> kube-apiserver

<span class="token comment">#存放apiserver的ssl相关文件</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/ssl/api-server
<span class="token comment">#将生成的密钥文件移动到临时工作目录中</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> ca*.pem kube-apiserver*.pem /opt/kubernetes/ssl/api-server
</code></pre> 
<h4><a id="3kubeapiserverconf_446"></a>3、kube-apiserver.conf配制文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#apiserver</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kube-apiserver.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
KUBE_APISERVER_OPTS="--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota <span class="token entity" title="\\">\\</span>
  --anonymous-auth=false <span class="token entity" title="\\">\\</span>
  --bind-address=192.168.11.111 <span class="token entity" title="\\">\\</span>
  --advertise-address=192.168.11.111 <span class="token entity" title="\\">\\</span>
  --secure-port=6443 <span class="token entity" title="\\">\\</span>
  --authorization-mode=Node,RBAC <span class="token entity" title="\\">\\</span>
  --runtime-config=api/all=true <span class="token entity" title="\\">\\</span>
  --enable-bootstrap-token-auth <span class="token entity" title="\\">\\</span>
  --service-cluster-ip-range=10.96.0.0/16 <span class="token entity" title="\\">\\</span>
  --token-auth-file=/opt/kubernetes/cfg/token.csv <span class="token entity" title="\\">\\</span>
  --service-node-port-range=1-32767 <span class="token entity" title="\\">\\</span>
  --tls-cert-file=/opt/kubernetes/ssl/api-server/kube-apiserver.pem  <span class="token entity" title="\\">\\</span>
  --tls-private-key-file=/opt/kubernetes/ssl/api-server/kube-apiserver-key.pem <span class="token entity" title="\\">\\</span>
  --client-ca-file=/opt/kubernetes/ssl/api-server/ca.pem <span class="token entity" title="\\">\\</span>
  --kubelet-client-certificate=/opt/kubernetes/ssl/api-server/kube-apiserver.pem <span class="token entity" title="\\">\\</span>
  --kubelet-client-key=/opt/kubernetes/ssl/api-server/kube-apiserver-key.pem <span class="token entity" title="\\">\\</span>
  --service-account-key-file=/opt/kubernetes/ssl/api-server/ca-key.pem <span class="token entity" title="\\">\\</span>
  --service-account-signing-key-file=/opt/kubernetes/ssl/api-server/ca-key.pem  <span class="token entity" title="\\">\\</span>
  --service-account-issuer=api <span class="token entity" title="\\">\\</span>
  --etcd-cafile=/opt/etcd/ssl/ca.pem <span class="token entity" title="\\">\\</span>
  --etcd-certfile=/opt/etcd/ssl/etcd.pem <span class="token entity" title="\\">\\</span>
  --etcd-keyfile=/opt/etcd/ssl/etcd-key.pem <span class="token entity" title="\\">\\</span>
  --etcd-servers=https://192.168.11.111:2379,https://192.168.11.112:2379 <span class="token entity" title="\\">\\</span>
  --enable-swagger-ui=true <span class="token entity" title="\\">\\</span>
  --allow-privileged=true <span class="token entity" title="\\">\\</span>
  --apiserver-count=3 <span class="token entity" title="\\">\\</span>
  --audit-log-maxage=30 <span class="token entity" title="\\">\\</span>
  --audit-log-maxbackup=3 <span class="token entity" title="\\">\\</span>
  --audit-log-maxsize=100 <span class="token entity" title="\\">\\</span>
  --audit-log-path=/var/log/kube-apiserver-audit.log <span class="token entity" title="\\">\\</span>
  --event-ttl=1h <span class="token entity" title="\\">\\</span>
  --v=4"
EOF</span>
</code></pre> 
<h4><a id="4kubeapiserverservice_484"></a>4、kube-apiserver.service启动文件</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=etcd.service
Wants=etcd.service

[Service]
EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver.conf
ExecStart=/usr/local/bin/kube-apiserver <span class="token variable">$KUBE_APISERVER_OPTS</span>
Restart=on-failure
RestartSec=5
Type=notify
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<p><font color="red">切记查看启动是否有该文件$KUBE_APISERVER_OPTS</font></p> 
<h4><a id="5master_506"></a>5、分发给其他master节点</h4> 
<p><code>注意：修改对应kube-apiserver.conf的ip地址</code></p> 
<pre><code class="prism language-shell"><span class="token comment">#在对应的master上创建文件夹</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/cfg/
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/ssl/api-server
<span class="token comment">#复制所有的文件到对应服务器上</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span>  /opt/kubernetes/cfg/ k8s-master2:/opt/kubernetes/cfg/
<span class="token function">scp</span> <span class="token parameter variable">-r</span>  /usr/lib/systemd/system/kube-apiserver.service k8s-master2:/usr/lib/systemd/system/
<span class="token function">scp</span> <span class="token parameter variable">-r</span>  /opt/kubernetes/ssl/api-server/* k8s-master2:/opt/kubernetes/ssl/api-server
</code></pre> 
<h4><a id="6kubeapiserver_517"></a>6、启动kube-apiserver</h4> 
<pre><code class="prism language-shell">systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-apiserver
systemctl status kube-apiserver
</code></pre> 
<h3><a id="3kubectl_523"></a>3、部署kubectl</h3> 
<h4><a id="1kubectl_524"></a>1、生成kubectl证书</h4> 
<pre><code class="prism language-shell"><span class="token comment">#创建存放kubectl的证书文件的工作目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/ssl/kubectl
<span class="token comment">#切换到工作目录下</span>
<span class="token builtin class-name">cd</span> /usr/local/kubernetes/etcd/
<span class="token function">cat</span> <span class="token operator">&gt;</span> admin-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
{
  "CN": "admin",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:masters",             
      "OU": "system"
    }
  ]
}
EOF</span>
</code></pre> 
<p>说明：</p> 
<pre><code class="prism language-text">后续 kube-apiserver 使用 RBAC 对客户端(如 kubelet、kube-proxy、Pod)请求进行授权；
kube-apiserver 预定义了一些 RBAC 使用的 RoleBindings，如 cluster-admin 将 Group system:masters 与 Role cluster-admin 绑定，该 Role 授予了调用kube-apiserver 的所有 API的权限；
O指定该证书的 Group 为 system:masters，kubelet 使用该证书访问 kube-apiserver 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 system:masters，所以被授予访问所有 API 的权限；
注：
这个admin 证书，是将来生成管理员用的kubeconfig 配置文件用的，现在我们一般建议使用RBAC 来对kubernetes 进行角色权限控制， kubernetes 将证书中的CN 字段 作为User， O 字段作为 Group；
"O": "system:masters", 必须是system:masters，否则后面kubectl create clusterrolebinding报错。
</code></pre> 
<h4><a id="2kubectladmin_559"></a>2、生成kubectl的admin相关证书文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#生成证书文件</span>
cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes admin-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> admin
<span class="token comment">#查看生成的文件</span>
<span class="token function">ls</span> admin*.pem ca*.pem
admin-key.pem  admin.pem  ca-key.pem  ca.pem
<span class="token comment">#复制生成的证书文件到工作目录下</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> ca*.pem admin*.pem /opt/kubernetes/ssl/kubectl/
</code></pre> 
<h4><a id="3kubeconfig_569"></a>3、生成kubeconfig配置文件</h4> 
<p><font color="red">kube.config 为 kubectl 的配置文件，包含访问 apiserver 的所有信息，如 apiserver 地址、CA 证书和自身使用的证书</font><br> 切记：下面的ip以及配置文件别写错了</p> 
<pre><code class="prism language-shell"><span class="token comment">#当前命令在/usr/local/kubernetes/etcd下执行</span>
<span class="token builtin class-name">cd</span> /usr/local/kubernetes/etcd/
<span class="token comment">#此处的ip配置的是VIP的地址</span>
kubectl config set-cluster kubernetes --certificate-authority<span class="token operator">=</span>ca.pem --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.11.100:6443 <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube.config

kubectl config set-credentials admin --client-certificate<span class="token operator">=</span>admin.pem --client-key<span class="token operator">=</span>admin-key.pem --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube.config

kubectl config set-context kubernetes <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token parameter variable">--user</span><span class="token operator">=</span>admin <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube.config

kubectl config use-context kubernetes <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube.config
</code></pre> 
<h4><a id="4kubectl_584"></a>4、准备kubectl配置文件并进行角色绑定</h4> 
<pre><code class="prism language-shell"><span class="token comment">#创建root下的文件夹</span>
<span class="token function">mkdir</span> ~/.kube
<span class="token comment">#将上面第四步生成的文件复制到文件夹下面</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> kube.config ~/.kube/config
<span class="token comment">#集群角色的绑定 并且通过/root/.kube/config文件进行控制</span>
kubectl create clusterrolebinding kube-apiserver:kubelet-apis <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>system:kubelet-api-admin <span class="token parameter variable">--user</span> kubernetes <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/root/.kube/config
</code></pre> 
<h4><a id="5_593"></a>5、将配置文件导入到系统环境变量中</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/.kube/config
</code></pre> 
<h4><a id="6master_597"></a>6、同步配置文件到其他master节点</h4> 
<p><font color="red">注意：需要在master2和master3上提前创建/root/.kube,然后文件传输过去，即可使用kubectl客户端工具</font></p> 
<pre><code class="prism language-shell"><span class="token comment"># 在master2和master3上创建该目录</span>
<span class="token comment"># mkdir /root/.kube</span>
<span class="token function">scp</span> /root/.kube/config k8s-master2:/root/.kube/
<span class="token function">scp</span> /root/.kube/config k8s-master3:/root/.kube/
<span class="token comment">#导入系统环境变量中</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/.kube/config
</code></pre> 
<h4><a id="7_607"></a>7、集群状态查看</h4> 
<pre><code class="prism language-shell"><span class="token comment">#查看集群信息</span>
kubectl cluster-info
<span class="token comment">#查看集群组件状态</span>
kubectl get componentstatuses
<span class="token comment">#查看命名空间中资源对象</span>
kubectl get all --all-namespaces
</code></pre> 
<h4><a id="8kubectl_616"></a>8、配置kubectl命令补全(可选)</h4> 
<pre><code class="prism language-shell">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> bash-completion
<span class="token builtin class-name">source</span> /usr/share/bash-completion/bash_completion
<span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">bash</span><span class="token punctuation">)</span>
kubectl completion <span class="token function">bash</span> <span class="token operator">&gt;</span> ~/.kube/completion.bash.inc
<span class="token builtin class-name">source</span> <span class="token string">'/root/.kube/completion.bash.inc'</span>  
<span class="token builtin class-name">source</span> <span class="token environment constant">$HOME</span>/.bash_profile
</code></pre> 
<h3><a id="4kubecontrollermanager_625"></a>4、部署kube-controller-manager</h3> 
<h4><a id="1kubecontrollermanager_626"></a>1、准备kube-controller-manager证书文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#创建工作目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/ssl/kube-controller-manager
<span class="token comment">#创建kube-controller-manager文件</span>
<span class="token builtin class-name">cd</span> /usr/local/kubernetes/etcd/
<span class="token function">cat</span> <span class="token operator">&gt;</span> kube-controller-manager-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
{
    "CN": "system:kube-controller-manager",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "hosts": [
      "127.0.0.1",
      "192.168.11.111",
      "192.168.11.112"
    ],
    "names": [
      {
        "C": "CN",
        "ST": "Beijing",
        "L": "Beijing",
        "O": "system:kube-controller-manager",
        "OU": "system"
      }
    ]
}
EOF</span>
</code></pre> 
<h4><a id="2kubecontrollermanager_656"></a>2、生成kube-controller-manager证书</h4> 
<pre><code class="prism language-shell">cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes kube-controller-manager-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> kube-controller-manager
<span class="token comment">#复制文件到工作目录中</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-r</span> ca*.pem kube-controller-manager*.pem /opt/kubernetes/ssl/kube-controller-manager
</code></pre> 
<h4><a id="3kubecontrollermanagerkubeconfig_662"></a>3、创建kube-controller-manager.kubeconfig文件</h4> 
<pre><code class="prism language-shell">kubectl config set-cluster kubernetes --certificate-authority<span class="token operator">=</span>ca.pem --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.11.100:6443 <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-controller-manager.kubeconfig

kubectl config set-credentials system:kube-controller-manager --client-certificate<span class="token operator">=</span>kube-controller-manager.pem --client-key<span class="token operator">=</span>kube-controller-manager-key.pem --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-controller-manager.kubeconfig

kubectl config set-context system:kube-controller-manager <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-controller-manager <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-controller-manager.kubeconfig

kubectl config use-context system:kube-controller-manager <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-controller-manager.kubeconfig
<span class="token comment">## 将生成的文件复制到工作目录中</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> kube-controller-manager.kubeconfig /opt/kubernetes/cfg/kube-controller-manager.kubeconfig
</code></pre> 
<h4><a id="4kubecontrollermanagerconf_674"></a>4、创建kube-controller-manager.conf配置文件</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kube-controller-manager.conf <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
KUBE_CONTROLLER_MANAGER_OPTS="--secure-port=10257 \
  --bind-address=127.0.0.1 \
  --kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \
  --service-cluster-ip-range=10.96.0.0/16 \
  --cluster-name=kubernetes \
  --cluster-signing-cert-file=/opt/kubernetes/ssl/kube-controller-manager/ca.pem \
  --cluster-signing-key-file=/opt/kubernetes/ssl/kube-controller-manager/ca-key.pem \
  --allocate-node-cidrs=true \
  --cluster-cidr=10.244.0.0/16 \
  --root-ca-file=/opt/kubernetes/ssl/kube-controller-manager/ca.pem \
  --service-account-private-key-file=/opt/kubernetes/ssl/kube-controller-manager/ca-key.pem \
  --leader-elect=true \
  --feature-gates=RotateKubeletServerCertificate=true \
  --controllers=*,bootstrapsigner,tokencleaner \
  --tls-cert-file=/opt/kubernetes/ssl/kube-controller-manager/kube-controller-manager.pem \
  --tls-private-key-file=/opt/kubernetes/ssl/kube-controller-manager/kube-controller-manager-key.pem \
  --use-service-account-credentials=true \
  --v=2"
EOF</span>
</code></pre> 
<h4><a id="5kubecontrollermanagerservice_697"></a>5、创建kube-controller-manager.service服务</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-controller-manager.service <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=-/opt/kubernetes/cfg/kube-controller-manager.conf
ExecStart=/usr/local/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<h4><a id="6master_714"></a>6、同步到其他master节点</h4> 
<pre><code class="prism language-shell"><span class="token comment">#在其他的master上执行</span>
<span class="token comment">#mkdir -vp /opt/kubernetes/ssl/kube-controller-manager</span>
<span class="token comment">#复制所有的文件到对应服务器上</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span>  /opt/kubernetes/cfg/kube-controller-manager* k8s-master2:/opt/kubernetes/cfg/
<span class="token function">scp</span> <span class="token parameter variable">-r</span>  /usr/lib/systemd/system/kube-controller-manager.service k8s-master2:/usr/lib/systemd/system/
<span class="token function">scp</span> <span class="token parameter variable">-r</span>  /opt/kubernetes/ssl/kube-controller-manager/* k8s-master2:/opt/kubernetes/ssl/kube-controller-manager
</code></pre> 
<h4><a id="7kubecontrollermanager_723"></a>7、启动kube-controller-manager</h4> 
<pre><code class="prism language-shell">systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-controller-manager
systemctl status kube-controller-manager
</code></pre> 
<h3><a id="5kubescheduler_729"></a>5、部署kube-scheduler</h3> 
<h4><a id="1kubescheduler_730"></a>1、准备kube-scheduler证书文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#创建证书工作目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/ssl/kube-scheduler
<span class="token builtin class-name">cd</span> /usr/local/kubernetes/etcd
<span class="token function">cat</span> <span class="token operator">&gt;</span> kube-scheduler-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
{
    "CN": "system:kube-scheduler",
    "hosts": [
      "127.0.0.1",
      "192.168.11.111",
      "192.168.11.112"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
      {
        "C": "CN",
        "ST": "Beijing",
        "L": "Beijing",
        "O": "system:kube-scheduler",
        "OU": "system"
      }
    ]
}
EOF</span>
</code></pre> 
<h4><a id="2kubescheduler_759"></a>2、生成kube-scheduler证书</h4> 
<pre><code class="prism language-shell">cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes kube-scheduler-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> kube-scheduler
<span class="token comment">#复制生成的ssl证书文件到工作目录中</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> ca*.pem kube-scheduler*.pem /opt/kubernetes/ssl/kube-scheduler
</code></pre> 
<h4><a id="3kubeschedulerkubeconfig_765"></a>3、创建kube-scheduler.kubeconfig文件</h4> 
<pre><code class="prism language-shell">kubectl config set-cluster kubernetes --certificate-authority<span class="token operator">=</span>ca.pem --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.11.100:6443 <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-scheduler.kubeconfig

kubectl config set-credentials system:kube-scheduler --client-certificate<span class="token operator">=</span>kube-scheduler.pem --client-key<span class="token operator">=</span>kube-scheduler-key.pem --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-scheduler.kubeconfig

kubectl config set-context system:kube-scheduler <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-scheduler <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-scheduler.kubeconfig

kubectl config use-context system:kube-scheduler <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-scheduler.kubeconfig
<span class="token comment">#将生成的文件复制到工作目录下</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> kube-scheduler.kubeconfig /opt/kubernetes/cfg/kube-scheduler.kubeconfig

</code></pre> 
<h4><a id="4kubeschedulerconf_778"></a>4、创建kube-scheduler.conf配置文件</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kube-scheduler.conf <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
KUBE_SCHEDULER_OPTS=" \
--leader-elect=true \
--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \
--v=2"
EOF</span>
</code></pre> 
<h4><a id="5kubeschedulerservice_787"></a>5、创建kube-scheduler.service</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-scheduler.service <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf
ExecStart=/usr/local/bin/kube-scheduler $KUBE_SCHEDULER_OPTS
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<h4><a id="6_804"></a>6、分发依赖</h4> 
<pre><code class="prism language-shell"><span class="token comment">#在其他的master上执行</span>
<span class="token comment">#mkdir -vp /opt/kubernetes/ssl/kube-scheduler</span>
<span class="token comment">#复制所有的文件到对应服务器上</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span>  /opt/kubernetes/cfg/kube-scheduler* k8s-master2:/opt/kubernetes/cfg/
<span class="token function">scp</span> <span class="token parameter variable">-r</span>  /usr/lib/systemd/system/kube-scheduler.service k8s-master2:/usr/lib/systemd/system/
<span class="token function">scp</span> <span class="token parameter variable">-r</span>  /opt/kubernetes/ssl/kube-scheduler/* k8s-master2:/opt/kubernetes/ssl/kube-scheduler
</code></pre> 
<h4><a id="7kubescheduler_813"></a>7、启动kube-scheduler</h4> 
<pre><code class="prism language-shell">systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-scheduler
systemctl status kube-scheduler
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/eb/859nyJhP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6_820"></a>6、集群状态查询</h3> 
<pre><code class="prism language-shell"><span class="token comment">#查看集群信息</span>
kubectl cluster-info
<span class="token comment">#查看集群组件状态</span>
kubectl get componentstatuses
<span class="token comment">#查看命名空间中资源对象</span>
kubectl get all --all-namespaces
</code></pre> 
<h2><a id="5Node_829"></a>5、部署Node</h2> 
<h3><a id="1docker_830"></a>1、安装docker</h3> 
<p><img src="https://images2.imgbox.com/04/1a/yxTN6AHE_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1docker_832"></a>1、安装docker</h4> 
<pre><code class="prism language-shell"><span class="token comment">#1、更新yum</span>
yum update
<span class="token comment">#2、安装需要的软件包</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2
<span class="token comment">#3、设置阿里云镜像</span>
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span class="token comment">## 查看相关版本</span>
<span class="token comment"># yum list installed | grep docker</span>
<span class="token comment">#http://mirrors.163.com/docker-ce/linux/centos/7.6/x86_64/stable/Packages/</span>
<span class="token comment">#下载k8s匹配的版本(k8s为1.27 docker为v20.10.18...v20.10.21)</span>
<span class="token comment">#yum install docker-ce-20.10.20-3.el7</span>
yum <span class="token function">install</span> docker-ce
<span class="token function">docker</span> <span class="token parameter variable">-v</span>
<span class="token comment">#6、设置开机启动</span>
systemctl daemon-reload  
<span class="token comment">#设置docker开机自启</span>
systemctl <span class="token builtin class-name">enable</span>  <span class="token parameter variable">--now</span> <span class="token function">docker</span>
systemctl start <span class="token function">docker</span> 
systemctl status <span class="token function">docker</span>
<span class="token comment">#关闭docker开机自启</span>
<span class="token comment">#systemctl disable docker  </span>
</code></pre> 
<h4><a id="2_856"></a>2、环境配置</h4> 
<ul><li>1.24之后官方弃用docker说明：<br> https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#docker<br> <code>注意</code>exec-opts是启动kubelet需要的参数,和kubelet.json的"cgroupDriver"保持一致</li></ul> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker
<span class="token comment">#准备docker的环境配置以及工作目录</span>
<span class="token comment">#k8s 1.24之后需要指定守护进程加载方式native.cgroupdriver=systemd</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
{
   "data-root":"/usr/local/dockerWorkspace/",
   "exec-opts": ["native.cgroupdriver=systemd"],
   "registry-mirrors" : [
    "https://registry.docker-cn.com",
    "http://hub-mirror.c.163.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://cr.console.aliyun.com"
  ]
}
EOF</span>
<span class="token comment">#重启docker</span>
systemctl restart <span class="token function">docker</span>
</code></pre> 
<pre><code class="prism language-text">1.Docker中国区官方镜像    https://registry.docker-cn.com
2.网易    http://hub-mirror.c.163.com
3.ustc    https://docker.mirrors.ustc.edu.cn
4.中国科技大学    https://docker.mirrors.ustc.edu.cn
</code></pre> 
<h4><a id="3cridockerd_885"></a>3、cri-dockerd安装</h4> 
<pre><code class="prism language-shell"><span class="token comment">#下载文件</span>
<span class="token function">wget</span> https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.4/cri-dockerd-0.3.4-3.el7.x86_64.rpm
<span class="token comment">#安装cri-dockerd</span>
yum <span class="token function">install</span> cri-dockerd-0.3.4-3.el7.x86_64.rpm
<span class="token comment">#然后编辑cri-dockerd.service[安装后文件存在此处]</span>
<span class="token function">vim</span> /usr/lib/systemd/system/cri-docker.service
<span class="token comment">#修改ExecStart配置</span>
<span class="token comment">#ExecStart=/usr/bin/cri-dockerd --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7 --container-runtime-endpoint fd://</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/cri-dockerd --pod-infra-container-image<span class="token operator">=</span>registry.aliyuncs.com/google_containers/pause:3.8 --container-runtime-endpoint fd://
<span class="token comment">#启动cri-docker</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span>  cri-docker
<span class="token comment">#查看启动状态</span>
systemctl status  cri-docker
</code></pre> 
<h3><a id="2kubelet_901"></a>2、安装kubelet</h3> 
<p><font color="red">(因为CA、cfssl都在master1上，所以在master1上生成证书相关内容，复制并分发到node节点上)</font><br> <img src="https://images2.imgbox.com/4f/71/v0nw8x9n_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1ca_904"></a>1、复制ca证书</h4> 
<p>node节点上，安装以下内容<font color="red">kubelet、kube-proxy、docker[或者containerd]</font></p> 
<pre><code class="prism language-shell"><span class="token comment">#创建工作目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/ssl/<span class="token punctuation">{<!-- --></span>kubelet,kube-proxy<span class="token punctuation">}</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> /usr/local/kubernetes/etcd/ca*.pem /opt/kubernetes/ssl/kubelet/
</code></pre> 
<h4><a id="2kubeletbootstrapkubeconfig_911"></a>2、生成kubelet-bootstrap.kubeconfig配置文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#进入工作目录</span>
<span class="token builtin class-name">cd</span> /usr/local/kubernetes/etcd
<span class="token comment">#获取token.csv文件的值取出来赋值给下面的 可以用$BOOTSTRAP_TOKEN查看</span>
<span class="token assign-left variable">BOOTSTRAP_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">awk</span> <span class="token parameter variable">-F</span> <span class="token string">","</span> <span class="token string">'{print $1}'</span> /opt/kubernetes/cfg/token.csv<span class="token variable">)</span></span>
<span class="token comment">#设置管理的集群</span>
kubectl config set-cluster kubernetes --certificate-authority<span class="token operator">=</span>ca.pem --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.11.100:6443 <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kubelet-bootstrap.kubeconfig
<span class="token comment">#设置集群证书</span>
kubectl config set-credentials kubelet-bootstrap <span class="token parameter variable">--token</span><span class="token operator">=</span><span class="token variable">${BOOTSTRAP_TOKEN}</span> <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kubelet-bootstrap.kubeconfig
<span class="token comment">#创建安全上下文</span>
kubectl config set-context default <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token parameter variable">--user</span><span class="token operator">=</span>kubelet-bootstrap <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kubelet-bootstrap.kubeconfig
<span class="token comment">#设置 使用刚才设置的安全上下文</span>
kubectl config use-context default <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kubelet-bootstrap.kubeconfig

<span class="token comment">#设置集群的角色</span>
kubectl create clusterrolebinding cluster-system-anonymous <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin <span class="token parameter variable">--user</span><span class="token operator">=</span>kubelet-bootstrap
<span class="token comment">#将角色和用户绑定</span>
kubectl create clusterrolebinding kubelet-bootstrap <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>system:node-bootstrapper <span class="token parameter variable">--user</span><span class="token operator">=</span>kubelet-bootstrap <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kubelet-bootstrap.kubeconfig

<span class="token comment">#将生成的配置文件复制到工作目录中</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> kubelet-bootstrap.kubeconfig /opt/kubernetes/cfg/

<span class="token comment">#查看 对角色cluster-system-anonymous的描述</span>
kubectl describe clusterrolebinding cluster-system-anonymous
<span class="token comment">#查看kubelet-bootstrap角色用户信息</span>
kubectl describe clusterrolebinding kubelet-bootstrap 
</code></pre> 
<p><code>注意：</code> 如果执行中出现某个角色已存在，删除即可</p> 
<pre><code class="prism language-shell">kubectl delete clusterrolebinding kubelet-bootstrap
</code></pre> 
<p><img src="https://images2.imgbox.com/c0/56/w6bmWiXS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3node_944"></a>3、同步证书文件到集群node节点上</h4> 
<p><font color="red">注意：需要的证书文件都已生成，复制到k8s-node1节点上后，步骤四准备kubelet.json等后续操作就不在k8s-master1上继续执行了。去k8s-node1上执行。此处谨记</font><br> <code>在对应的node上创建工作目录</code></p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/<span class="token punctuation">{<!-- --></span>cfg,ssl,bin<span class="token punctuation">}</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/ssl/kubelet/
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#复制配置文件config和角色权限配置文件</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-node1 k8s-node2<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> /opt/kubernetes/cfg/kubelet* <span class="token variable">$i</span>:/opt/kubernetes/cfg/<span class="token punctuation">;</span><span class="token keyword">done</span>
<span class="token comment">#复制ssl文件</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-node1 k8s-node2<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> /opt/kubernetes/ssl/kubelet/* <span class="token variable">$i</span>:/opt/kubernetes/ssl/kubelet/<span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre> 
<h4><a id="4kubeletjsonfont_colorrednodefont_958"></a>4、准备kubelet.json文件<font color="red">node上执行</font></h4> 
<p><font color="red">里面的#注释去掉，否则启动失败</font></p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kubelet.json <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
{
  "kind": "KubeletConfiguration",
  "apiVersion": "kubelet.config.k8s.io/v1beta1",
  "authentication": {
    "x509": {
      "clientCAFile": "/opt/kubernetes/ssl/kubelet/ca.pem"
    },
    "webhook": {
      "enabled": true,
      "cacheTTL": "2m0s"
    },
    "anonymous": {
      "enabled": false
    }
  },
  "authorization": {
    "mode": "Webhook",
    "webhook": {
      "cacheAuthorizedTTL": "5m0s",
      "cacheUnauthorizedTTL": "30s"
    }
  },
  #本机ip(集群则需要注意,配置当前node节点ip)
  "address": "192.168.11.113",
  "port": 10250,
  "readOnlyPort": 10255,
  #和config.toml的systemd_cgroup = true对应的cgroup保持一致
  "cgroupDriver": "systemd",                    
  "hairpinMode": "promiscuous-bridge",
  "serializeImagePulls": false,
  "clusterDomain": "cluster.local.",
  "clusterDNS": ["10.96.0.2"]
}
EOF</span>
</code></pre> 
<h4><a id="5kubeletservice_997"></a>5、准备kubelet.service文件</h4> 
<p><code>--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig</code> <font color="red">此处没有该文件，后续启动会自动生成该文件</font></p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kubelet.service <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
#After=containerd.service
#Requires=containerd.service
#启动的容器是docker则配置docker，如果是containerd则配置containerd.service
After=docker.service
Requires=docker.service

[Service]
WorkingDirectory=/var/lib/kubelet
ExecStart=/usr/local/bin/kubelet \
  --bootstrap-kubeconfig=/opt/kubernetes/cfg/kubelet-bootstrap.kubeconfig \
  --cert-dir=/opt/kubernetes/ssl/kubelet \
  --kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \
  --config=/opt/kubernetes/cfg/kubelet.json \
  --rotate-certificates \
  --container-runtime-endpoint=unix:///run/cri-dockerd.sock \
  --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.8 \
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<ul><li><font color="red">注意</font><br> <font color="red">containerd</font>指定为：<font color="red">–container-runtime-endpoint=unix:///run/containerd/containerd.sock</font><br> <font color="red">docker</font>指定为：<font color="red">–container-runtime-endpoint=unix:///run/cri-dockerd.sock</font><br> <font color="red">Unit</font>：特别注意指定的docker容器，还是contained容器<br> 下载异常使用如下配置 --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.8 \</li></ul> 
<h4><a id="6node_1033"></a>6、同步到其他node节点</h4> 
<pre><code class="prism language-shell"><span class="token comment">#切记，一定要修改里面的ip地址</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-node2 k8s-node3<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> /opt/kubernetes/cfg/kubelet.json <span class="token variable">$i</span>:/opt/kubernetes/cfg <span class="token punctuation">;</span><span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-node2 k8s-node3<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> /usr/lib/systemd/system/kubelet.service <span class="token variable">$i</span>:/usr/lib/systemd/system <span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre> 
<h4><a id="7_1039"></a>7、创建目录并启动</h4> 
<p><code>(在对应的node机器上执行，别在master上执行)</code></p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/kubelet
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/log/kubernetes

systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kubelet
systemctl status kubelet
</code></pre> 
<h4><a id="8_1049"></a>8、启动报错排查</h4> 
<p><code>Aug 4 19:12:40 k8s-master03 kubelet: E0804 19:12:40.726264 21343 run.go:74] "command failed" err="failed to run Kubelet: validate service connection: CRI v1 runtime API is not implemented for endpoint \"unix:///run/containerd/containerd.sock\": rpc error: code = Unimplemented desc = unknown service runtime.v1.RuntimeService"</code><br> 使用命令查看容器启动情况ps -ef|grep containerd<br> <img src="https://images2.imgbox.com/99/b5/F83uN1y1_o.png" alt="在这里插入图片描述"><br> 删除对应的docker即可 然后重启kubelet</p> 
<h3><a id="3kubeproxy_1054"></a>3、安装kube-proxy</h3> 
<p><font color="red">(因为CA、cfssl都在master1上，所以在master1上生成证书相关内容，复制并分发到node节点上)</font><br> <code>kube-proxy:</code><em><strong>为容器提供现相应的网络支持</strong></em></p> 
<h4><a id="1kubeproxy_1057"></a>1、创建kube-proxy证书请求文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#生成工作目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/ssl/kube-proxy
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/yaml
<span class="token builtin class-name">cd</span>  /usr/local/kubernetes/etcd
<span class="token comment">#ca-config文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> kube-proxy-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
{
  "CN": "system:kube-proxy",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "kubemsb",
      "OU": "CN"
    }
  ]
}
EOF</span>
</code></pre> 
<h4><a id="2_1083"></a>2、生成证书</h4> 
<pre><code class="prism language-shell"><span class="token comment">#生成证书</span>
cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes kube-proxy-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> kube-proxy
<span class="token comment">#复制到工作目录中</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span> ca*.pem  kube-proxy*.pem /opt/kubernetes/ssl/kube-proxy
</code></pre> 
<h4><a id="3kubeproxykubeconfig_1090"></a>3、创建kube-proxy.kubeconfig文件</h4> 
<pre><code class="prism language-shell">kubectl config set-cluster kubernetes --certificate-authority<span class="token operator">=</span>ca.pem --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.11.100:6443 <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-proxy.kubeconfig

kubectl config set-credentials kube-proxy --client-certificate<span class="token operator">=</span>kube-proxy.pem --client-key<span class="token operator">=</span>kube-proxy-key.pem --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-proxy.kubeconfig

kubectl config set-context default <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token parameter variable">--user</span><span class="token operator">=</span>kube-proxy <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-proxy.kubeconfig

kubectl config use-context default <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>kube-proxy.kubeconfig

<span class="token comment">#将生成的证书文件复制到工作目录中</span>
<span class="token punctuation">\</span>cp <span class="token parameter variable">-R</span>  kube-proxy.kubeconfig /opt/kubernetes/cfg/
</code></pre> 
<h4><a id="4node_1103"></a>4、同步证书文件到集群node节点上</h4> 
<p><font color="red">注意：需要的证书文件都已生成，复制到k8s-node1节点上后，步骤四准备kubelet.json等后续操作就不在k8s-master1上继续执行了。去k8s-node1上执行。此处谨记</font><br> <code>在对应的node上创建工作目录</code></p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/ssl/kube-proxy
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/yaml
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#复制配置文件config和角色权限配置文件</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-node1 k8s-node2<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> /opt/kubernetes/cfg/kube-proxy* <span class="token variable">$i</span>:/opt/kubernetes/cfg/<span class="token punctuation">;</span><span class="token keyword">done</span>
<span class="token comment">#复制ssl文件</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-node1 k8s-node2<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> /opt/kubernetes/ssl/kube-proxy/* <span class="token variable">$i</span>:/opt/kubernetes/ssl/kube-proxy/<span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre> 
<h4><a id="5kubeproxyservicefont_colorrednodefont_1116"></a>5、创建kube-proxy.service服务配置文件<font color="red">node上执行</font></h4> 
<p><code>注意：</code>每台服务器记得修改对应的ip地址</p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/yaml/kube-proxy.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 192.168.11.113
clientConnection:
  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
clusterCIDR: 10.244.0.0/16
healthzBindAddress: 192.168.11.113:10256
kind: KubeProxyConfiguration
metricsBindAddress: 192.168.11.113:10249
mode: "ipvs"
EOF</span>
</code></pre> 
<h4><a id="6kubeproxyservice_1131"></a>6、创建kube-proxy.service服务管理文件</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span>  /usr/lib/systemd/system/kube-proxy.service <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
[Unit]
Description=Kubernetes Kube-Proxy Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
WorkingDirectory=/var/lib/kube-proxy
ExecStart=/usr/local/bin/kube-proxy \
  --config=/opt/kubernetes/yaml/kube-proxy.yaml \
  --v=2
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> 
<h4><a id="6_1152"></a>6、同步文件到集群节点</h4> 
<p><code>在对应的node上创建工作目录</code></p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/yaml
</code></pre> 
<pre><code class="prism language-shell"><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-node1 k8s-node2<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> /usr/lib/systemd/system/kubelet.service <span class="token variable">$i</span>:/usr/lib/systemd/system/<span class="token punctuation">;</span><span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-node1 k8s-node2<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">scp</span> /opt/kubernetes/yaml/kube-proxy.yaml <span class="token variable">$i</span>:/opt/kubernetes/yaml/<span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre> 
<h4><a id="7_1162"></a>7、服务启动</h4> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/kube-proxy
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-proxy
systemctl status kube-proxy
</code></pre> 
<h2><a id="6CNIfont_colorredmasterfont_1169"></a>6、部署CNI网络<font color="red">master安装</font></h2> 
<p><font color="red">flannel和cacico(推荐)任选其一</font></p> 
<h3><a id="1_1171"></a>1、创建工作目录</h3> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-vp</span> /opt/kubernetes/systemYaml
<span class="token builtin class-name">cd</span> /opt/kubernetes/systemYaml
</code></pre> 
<h3><a id="2flannel_1176"></a>2、flannel的安装</h3> 
<ul><li>CNI网络插件的主要功能就是为了实现pod资源能够跨宿主机进行通信<s>要在每个pod节点上安装</s></li></ul> 
<pre><code class="prism language-text">Flannel 由CoreOS开发，用于解决docker集群跨主机通讯的覆盖网络(overlay network)，它的主要思路是：预先留出一个网段，每个主机使用其中一部分，
然后每个容器被分配不同的ip；让所有的容器认为大家在同一个直连的网络，底层通过UDP/VxLAN/Host-GW等进行报文的封装和转发

解决Pod内容器与容器之间的通信

Flannel实质上是一种“覆盖网络(overlaynetwork)”，也就是将TCP数据包装在另一种网络包里面进行路由转发和通信，目前已经支持udp、vxlan、host-gw、aws-vpc、gce
和alloc路由等数据转发方式，默认的节点间数据通信方式是UDP转发。

它的功能是让集群中的不同节点主机创建的Docker容器都具有全集群唯一的虚拟IP地址。
Flannel的设计目的就是为集群中的所有节点重新规划IP地址的使用规则，从而使得不同节点上的容器能够获得同属一个内网且不重复的IP地址，并让属于不同节点上的容器能够
直接通过内网IP通信。
</code></pre> 
<ul><li>Flannel工作原理</li></ul> 
<pre><code class="prism language-text">node1上的pod1 要和node2上的pod1进行通信

1.数据从node1上的Pod1源容器中发出，经由所在主机的docker0 虚拟网卡转发到flannel0虚拟网卡；

2.再由flanneld把pod ip封装到udp中（里面封装的是源pod IP和目的pod IP);

3.根据在etcd保存的路由表信息，通过物理网卡发送给目的node2的flanneld，来进行解封装暴露出udp里的pod IP;

4.最后根据目的pod IP经flannel0虚拟网卡和docker0虚拟网卡转发到目的pod中，最后完成通信
</code></pre> 
<h4><a id="110flannelconflistist_1203"></a>1、配置10-flannel.conflistist</h4> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/cni/net.d
<span class="token comment">#下载cni</span>
<span class="token comment">#wget https://github.com/containernetworking/plugins/releases/download/v0.8.2/cni-plugins-linux-amd64-v0.8.2.tgz</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/cni/net.d/10-flannel.conflist <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
{
  "name": "cbr0",
  "plugins": [
    {
      "type": "flannel",
      "delegate": {
        "hairpinMode": true,
        "isDefaultGateway": true
      }
    },
    {
      "type": "portmap",
      "capabilities": {
        "portMappings": true
      }
    }
  ]
}
EOF</span>
</code></pre> 
<h4><a id="2github_1229"></a>2、github下载(网速较慢)</h4> 
<pre><code class="prism language-shell"><span class="token function">wget</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre> 
<h4><a id="3yamlfont_colorredfont_1233"></a>3、手动创建yaml文件(<font color="red">推荐使用</font>)</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span>  /opt/kubernetes/systemYaml/kube-flannel.yml <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
---
kind: Namespace
apiVersion: v1
metadata:
  name: kube-flannel
  labels:
    k8s-app: flannel
    pod-security.kubernetes.io/enforce: privileged
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  labels:
    k8s-app: flannel
  name: flannel
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - nodes/status
  verbs:
  - patch
- apiGroups:
  - networking.k8s.io
  resources:
  - clustercidrs
  verbs:
  - list
  - watch
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  labels:
    k8s-app: flannel
  name: flannel
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flannel
subjects:
- kind: ServiceAccount
  name: flannel
  namespace: kube-flannel
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: flannel
  name: flannel
  namespace: kube-flannel
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: kube-flannel-cfg
  namespace: kube-flannel
  labels:
    tier: node
    k8s-app: flannel
    app: flannel
data:
  cni-conf.json: |
    {
      "name": "cbr0",
      "cniVersion": "0.3.1",
      "plugins": [
        {
          "type": "flannel",
          "delegate": {
            "hairpinMode": true,
            "isDefaultGateway": true
          }
        },
        {
          "type": "portmap",
          "capabilities": {
            "portMappings": true
          }
        }
      ]
    }
  net-conf.json: |
    {
      "Network": "10.244.0.0/16",
      "Backend": {
        "Type": "vxlan"
      }
    }
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-flannel-ds
  namespace: kube-flannel
  labels:
    tier: node
    app: flannel
    k8s-app: flannel
spec:
  selector:
    matchLabels:
      app: flannel
  template:
    metadata:
      labels:
        tier: node
        app: flannel
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values:
                - linux
      hostNetwork: true
      priorityClassName: system-node-critical
      tolerations:
      - operator: Exists
        effect: NoSchedule
      serviceAccountName: flannel
      initContainers:
      - name: install-cni-plugin
        image: docker.io/flannel/flannel-cni-plugin:v1.2.0
        command:
        - cp
        args:
        - -f
        - /flannel
        - /opt/cni/bin/flannel
        volumeMounts:
        - name: cni-plugin
          mountPath: /opt/cni/bin
      - name: install-cni
        image: docker.io/flannel/flannel:v0.22.1
        command:
        - cp
        args:
        - -f
        - /etc/kube-flannel/cni-conf.json
        - /etc/cni/net.d/10-flannel.conflist
        volumeMounts:
        - name: cni
          mountPath: /etc/cni/net.d
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
      containers:
      - name: kube-flannel
        image: docker.io/flannel/flannel:v0.22.1
        command:
        - /opt/bin/flanneld
        args:
        - --ip-masq
        - --kube-subnet-mgr
        resources:
          requests:
            cpu: "100m"
            memory: "50Mi"
        securityContext:
          privileged: false
          capabilities:
            add: ["NET_ADMIN", "NET_RAW"]
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: EVENT_QUEUE_DEPTH
          value: "5000"
        volumeMounts:
        - name: run
          mountPath: /run/flannel
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
        - name: xtables-lock
          mountPath: /run/xtables.lock
      volumes:
      - name: run
        hostPath:
          path: /run/flannel
      - name: cni-plugin
        hostPath:
          path: /opt/cni/bin
      - name: cni
        hostPath:
          path: /etc/cni/net.d
      - name: flannel-cfg
        configMap:
          name: kube-flannel-cfg
      - name: xtables-lock
        hostPath:
          path: /run/xtables.lock
          type: FileOrCreate
EOF</span>
</code></pre> 
<h4><a id="4_1453"></a>4、部署应用</h4> 
<pre><code class="prism language-shell"><span class="token comment">#下载网络插件</span>
kubectl apply <span class="token parameter variable">-f</span> kube-flannel.yml
<span class="token comment">#查看下载、以及运行情况</span>
kubectl get pods <span class="token parameter variable">-n</span> kube-flannel
<span class="token comment">#查看集群运行情况</span>
kubectl get nodes
</code></pre> 
<h4><a id="5font_colorredfont_1462"></a>5、<font color="red">注意</font></h4> 
<p><code>注意</code>：<br> 1、本人在部署flannel的时候，出现了好多问题，<font color="red">error getting ClusterInformation: connection is unauthorized: Unauthorized</font><br> 其过程是安装了calico后，卸载掉，重新安装flannel出现安装不上的问题，报以上错误，后来经过查询，找到解决办法<br> <font color="red">解决办法是删除掉 /etc/cni/net.d/ 目录下的 calico 配置文件即可。所有的master和node节点都排查一遍</font><br> 2、特别注意的是第一步的10-flannel.conflistist要执行，。不然读取不到配置文件会报错</p> 
<h3><a id="3calico_1468"></a>3、下载calico</h3> 
<p><code>说明：</code> <em><strong>集群网络插件</strong></em></p> 
<p>安装参考网址：https://projectcalico.docs.tigera.io/about/about-calico</p> 
<h4><a id="1calicoyaml_1473"></a>1、下载calico.yaml</h4> 
<pre><code class="prism language-shell"><span class="token comment">#官网版本</span>
https://docs.tigera.io/archive
<span class="token comment">#下载指定版本  </span>
<span class="token comment">#应用operator资源清单文件</span>
<span class="token function">wget</span> https://raw.githubusercontent.com/projectcalico/calico/master/manifests/calico.yaml --no-check-certificate
<span class="token comment">#放开此配置</span>
<span class="token number">4894</span>            - name: CALICO_IPV4POOL_CIDR
<span class="token number">4895</span>              value: <span class="token string">"10.244.0.0/16"</span>
</code></pre> 
<p>文件位置： <font color="red">doc/kubernetes/calicoFile/calico.yaml</font></p> 
<h4><a id="2_1485"></a>2、修改应用文件</h4> 
<p><font color="red">k8s和calico的版本对应关系官网查看：https://projectcalico.docs.tigera.io/archive/v3.20/getting-started/kubernetes/requirements</font></p> 
<pre><code class="prism language-shell"><span class="token comment">#启动应用</span>
kubectl apply <span class="token parameter variable">-f</span> calico.yaml
<span class="token comment">#查看下载、以及运行情况</span>
kubectl get pods <span class="token parameter variable">-n</span> kube-system
<span class="token comment">#查看集群运行情况</span>
kubectl get nodes
</code></pre> 
<h3><a id="4_1495"></a>4、注意</h3> 
<p><code>如果是使用flannel网络插件，这两个cidr可以不一样，无所谓啦，因为它用的是iptables，那如果是calico，用的是ipvs,cidr必须保持一致</code><br> 在二进制方式安装的，这个cidr一般是定义在kube-proxy和kube-controller-manager这两个核心服务的配置文件内的。<br> <font color="red">kube-controller-manager.conf文件的–cluster-cidr=和kube-proxy.yaml的clusterCIDR必须保持一致，否则pod报错</font></p> 
<h2><a id="7CoreDNS_1499"></a>7、部署CoreDNS</h2> 
<p><code>提供pod的域名解析</code></p> 
<pre><code class="prism language-text">coredns在K8S中的用途,主要是用作服务发现，也就是服务(应用)之间相互定位的过程。
</code></pre> 
<p>官网：https://github.com/coredns/coredns/tags</p> 
<p>https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/coredns/coredns.yaml.base</p> 
<h3><a id="5corednsyaml184_1508"></a>5、创建coredns.yaml(此版本为1.8.4)</h3> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span>  /opt/kubernetes/systemYaml/coredns.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
apiVersion: v1
kind: ServiceAccount
metadata:
  name: coredns
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:coredns
rules:
  - apiGroups:
    - ""
    resources:
    - endpoints
    - services
    - pods
    - namespaces
    verbs:
    - list
    - watch
  - apiGroups:
    - discovery.k8s.io
    resources:
    - endpointslices
    verbs:
    - list
    - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:coredns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:coredns
subjects:
- kind: ServiceAccount
  name: coredns
  namespace: kube-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health {
          lameduck 5s
        }
        ready
        kubernetes cluster.local  in-addr.arpa ip6.arpa {
          fallthrough in-addr.arpa ip6.arpa
        }
        prometheus :9153
        forward . /etc/resolv.conf {
          max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coredns
  namespace: kube-system
  labels:
    k8s-app: kube-dns
    kubernetes.io/name: "CoreDNS"
spec:
  # replicas: not specified here:
  # 1. Default is 1.
  # 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  selector:
    matchLabels:
      k8s-app: kube-dns
  template:
    metadata:
      labels:
        k8s-app: kube-dns
    spec:
      priorityClassName: system-cluster-critical
      serviceAccountName: coredns
      tolerations:
        - key: "CriticalAddonsOnly"
          operator: "Exists"
      nodeSelector:
        kubernetes.io/os: linux
      affinity:
         podAntiAffinity:
           preferredDuringSchedulingIgnoredDuringExecution:
           - weight: 100
             podAffinityTerm:
               labelSelector:
                 matchExpressions:
                   - key: k8s-app
                     operator: In
                     values: ["kube-dns"]
               topologyKey: kubernetes.io/hostname
      containers:
      - name: coredns
        image: coredns/coredns:1.10.1
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 170Mi
          requests:
            cpu: 100m
            memory: 70Mi
        args: [ "-conf", "/etc/coredns/Corefile" ]
        volumeMounts:
        - name: config-volume
          mountPath: /etc/coredns
          readOnly: true
        ports:
        - containerPort: 53
          name: dns
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        - containerPort: 9153
          name: metrics
          protocol: TCP
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - all
          readOnlyRootFilesystem: true
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 60
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /ready
            port: 8181
            scheme: HTTP
      dnsPolicy: Default
      volumes:
        - name: config-volume
          configMap:
            name: coredns
            items:
            - key: Corefile
              path: Corefile
---
apiVersion: v1
kind: Service
metadata:
  name: kube-dns
  namespace: kube-system
  annotations:
    prometheus.io/port: "9153"
    prometheus.io/scrape: "true"
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: "true"
    kubernetes.io/name: "CoreDNS"
spec:
  selector:
    k8s-app: kube-dns
  clusterIP: 10.96.0.2
  ports:
  - name: dns
    port: 53
    protocol: UDP
  - name: dns-tcp
    port: 53
    protocol: TCP
  - name: metrics
    port: 9153
    protocol: TCP
EOF</span>
</code></pre> 
<h3><a id="6_1711"></a>6、启动并应用</h3> 
<pre><code class="prism language-shell">kubectl apply <span class="token parameter variable">-f</span> coredns.yaml

kubectl get pods <span class="token parameter variable">-A</span>
kubectl get pods <span class="token parameter variable">-n</span> kube-system
</code></pre> 
<h2><a id="8Web_UI_1718"></a>8、部署Web UI</h2> 
<h3><a id="1_1719"></a>1、下载部署</h3> 
<pre><code class="prism language-shell"><span class="token comment">#进入到系统相关的yaml的工作目录</span>
<span class="token builtin class-name">cd</span> /opt/kubernetes/systemYaml
<span class="token comment">#官网地址</span>
https://github.com/kubernetes/dashboard
https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard
<span class="token comment">#下载</span>
<span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml --no-check-certificate
<span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml --no-check-certificate
<span class="token comment">#找对应支持的版本号</span>
kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.2/aio/deploy/recommended.yaml

</code></pre> 
<h3><a id="2_1733"></a>2、修改配置信息</h3> 
<pre><code class="prism language-shell"><span class="token comment">#修改如下内容</span>
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort
  ports:
    - port: <span class="token number">443</span>
      targetPort: <span class="token number">8443</span>
      nodePort: <span class="token number">8443</span>
  selector:
    k8s-app: kubernetes-dashboard
</code></pre> 
<h3><a id="3_1752"></a>3、启动部署</h3> 
<pre><code class="prism language-shell"><span class="token comment">#启动</span>
kubectl apply <span class="token parameter variable">-f</span> recommended.yaml
<span class="token comment">#查看启动情况</span>
kubectl get svc <span class="token parameter variable">-n</span> kubernetes-dashboard
kubectl get pods <span class="token parameter variable">-n</span> kubernetes-dashboard
<span class="token comment">#访问</span>
https://IP+SVCPort
</code></pre> 
<p><img src="https://images2.imgbox.com/cd/41/M6r7JFZT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b1/36/M5bdtvwh_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4Token_1765"></a>4、通过Token令牌登入</h3> 
<h4><a id="1_1766"></a>1、下载文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#创建一个 ClusterRoleBinding 对象，并赋予cluster-admin权限，即访问整个集群的权限，包括查看和修改所有资源的权限</span>
kubectl create clusterrolebinding dashboard-cluster-admin <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>kubernetes-dashboard:kubernetes-dashboard
<span class="token comment">#查看secret </span>
kubectl get secret <span class="token parameter variable">-n</span> kubernetes-dashboard
<span class="token comment">#获取token</span>
kubectl describe secret <span class="token variable"><span class="token variable">$(</span>kubectl get secret <span class="token parameter variable">-n</span> kubernetes-dashboard<span class="token operator">|</span><span class="token function">grep</span> kubernetes-dashboard-token*<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token variable">)</span></span> <span class="token parameter variable">-n</span> kubernetes-dashboard<span class="token operator">|</span><span class="token function">egrep</span>  <span class="token parameter variable">-w</span> token:
</code></pre> 
<p><img src="https://images2.imgbox.com/2e/6f/KfwWVTbP_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/40/bd/eJypq5Cl_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_1779"></a>2、复制登录接口</h4> 
<pre><code class="prism language-text">eyJhbGciOiJSUzI1NiIsImtpZCI6Ik53ZnFsLXZOQmJrZnl3NkE0MGpmczJLZGt6N0JsNlNWb0FuVXFZQm55eVUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1tOWJoeCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjI1Njg0NzJjLTYyOTQtNDdmNS04NWRlLWUyYWYxNTg4NmYwOSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.pZlDEHlbAYEwmNtL8NKt1hxEwNW5ZvOVb_e1uIaVHs5FI7EDTPezm-_4pi1ITkyoRn6gjILe_XnKRpNLSK39EvRQFO0YWY_huxFnPxOmIG-YNN8Xxy3PTK65O1cMFpzK2BrKTrAd8-5IaNigALmOT7cVzvlK2HBn3bAoL-lVVXjFjFzvJM62P36e7aqpCdZ4pZjyKPN2FWLQtqagd2Omitoqc_kyF_L67wMnf2bPcDu7xGqDnTctHRsBve_LtKyfQUVJTn-wuQxX3YOrfYLXON0qmzpT4SBdYNoAoKMEYmdzT-LnSrjbSm3pHz4IdFEI-KB1zpW7lCHFm6HzpELJ5g
</code></pre> 
<h3><a id="5Kubeconfig_1783"></a>5、Kubeconfig登录</h3> 
<pre><code class="prism language-shell"><span class="token comment">#1、创建cluster集群</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-vp</span>  /etc/kubernetes/webUi
<span class="token comment">#进入ca生成证书所在的目录，ca.crt的目录</span>
<span class="token builtin class-name">cd</span> /usr/local/kubernetes/etcd/
<span class="token comment">#--server指定的是访问apiserver的地址，此处我的是keepalived代理地址</span>
kubectl config set-cluster kubernetes --certificate-authority<span class="token operator">=</span>ca.csr <span class="token parameter variable">--server</span><span class="token operator">=</span><span class="token string">"https://192.168.11.100:6443"</span> --embed-certs<span class="token operator">=</span>true <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/opt/kubernetes/webUi/dashboard-admin.conf

<span class="token comment">#创建credentials</span>
<span class="token assign-left variable">TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get secret <span class="token punctuation">$(</span>kubectl get secret <span class="token parameter variable">-n</span> kubernetes-dashboard<span class="token operator">|</span><span class="token function">grep</span> kubernetes-dashboard-token*<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token punctuation">)</span> <span class="token parameter variable">-n</span> kubernetes-dashboard  <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>.data.token<span class="token punctuation">}</span><span class="token operator">|</span>base64 <span class="token parameter variable">-d</span><span class="token variable">)</span></span>

kubectl config set-credentials dashboard-admin <span class="token parameter variable">--token</span><span class="token operator">=</span><span class="token variable">$TOKEN</span> <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/opt/kubernetes/webUi/dashboard-admin.conf

<span class="token comment">#创建context</span>
kubectl config set-context dashboard-admin@kubernetes <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token parameter variable">--user</span><span class="token operator">=</span>dashboard-admin <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/opt/kubernetes/webUi/dashboard-admin.conf
<span class="token comment">#切换context的current-context是dashboard-admin@kubernetes</span>
kubectl config use-context dashboard-admin@kubernetes <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/opt/kubernetes/webUi/dashboard-admin.conf
<span class="token comment">#然后进入/opt/kubernetes/webUi目录下，下载到本地，</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a3/5e/l8qEOHol_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="9nginx_1804"></a>9、部署nginx</h2> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/yaml/nginx-test.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">"EOF"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: default       # 指定命名空间，如果不想指定，可以将此行删除
  labels:
    app: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              protocol: TCP
              containerPort: 80
          resources:
            limits:
              cpu: "1.0"
              memory: 512Mi
            requests:
              cpu: "0.5"
              memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
  annotations:
  name: nginx-test-service
  namespace: default      # 指定命名空间，如果不想指定，可以将此行删除**
spec:
  ports:
    - port: 80
      targetPort: 80
      nodePort: 80
      protocol: TCP
  selector:
    app: nginx
  sessionAffinity: None
  type: NodePort
EOF</span>
<span class="token comment">#部署应用</span>
kubectl apply <span class="token parameter variable">-f</span> nginx-test.yaml 
<span class="token comment">#查看对外暴漏的外网端口</span>
kubectl get pod,svc
</code></pre> 
<p><img src="https://images2.imgbox.com/c2/c0/ttNB0Ox9_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f4aac3c89f56021f28d8f51a34c79ae5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">芯片IC的mask位置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/60f41e73ce87783e67bb24516ee1f850/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">最新GitHub学生认证，可以愉快的使用Copilot了(保姆级教程)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>