<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32CubeMX配置HAL库实现SPI-DMA的递归调用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32CubeMX配置HAL库实现SPI-DMA的递归调用" />
<meta property="og:description" content="对于快速入门STM32CubeMX，可以参考 【STM32】HAL库 STM32CubeMX系列学习教程 —————————— 一、硬件参数与配置： 核心：STM32F407ZET6 外设ADC：ADS1258 数量：3个 ※ 核心与3个ADC使用SPI总线 “一主多从” 方式连接，PCB布线的方式与下图一致。
※ 在电路板上STM32与三个ADS1258在同一直线上分布，STM32在一端，三个ADC依次排布。
※ 离STM32最远ADC的DRDY硬件管脚与STM32的EXTI line4 interrupt连接。
1.1 STM32CubeMX的设置 1.1.1 时钟树配置如下： 1.1.2 ADC输入的CLK由STM32的定时器TIM4控制，时钟树中APB1 Timer Clock = 84MHz，由下图配置生成PWM来当作ADC输入的CLK，CLK的频率为84/8 = 10.5MHz，
1.1.3 使用STM32的SPI3通讯协议，SPI3_RX的DMA Request与DMA1 Stream0连接，SPI3_TX的DMA Request与DMA1 Stream0连接。由于ADS1258的Datasheet中对SPI速率的要求，确定了STM32与ADC之间的SPI通讯速率为5.25MBits/s，即SCLK = 5.25MBits/s
1.2 ADS1258的设置 1.2.1 在整个系统初始化时，STM32向ADS1258发送一系列寄存器指令，将ADS1258的采样模式设置为Auto-Scan Mode、在该模式下使能需要采样的模拟信号输入管脚（已使能管脚按ADS1258 datasheet中的Channel ID，自动转换至待采样的模拟信号输入管脚）。
1.2.2 ADS1258在Auto-Scan Mode的Data Rate的计算公式如下，初始化设置中fclk = 10.5MHz，DR = 10b，TD = 8，CHOP = 0，计算得Data Rate = 5043Hz，即每个ADC的每次采样完成后DRDY引脚输出的信号频率为5043Hz。
二、运行逻辑 2.1 功能概述 在电路设计上，三个ADC的采样启停通过硬件连接由STM32的同步控制，且ADS1258的采样模式为Auto-Scan Mode，因此三个ADC能够同时将预定的输入模拟信号进行采样并转换为数字量，即在任一ADC的两个DRDY信号之间，三个ADC均在硬件上一一对应的模拟信号输入管脚进行采样。在两个DRDY之间，STM32需要通过SPI协议接收三组 4 Bytes 的数字量，为了在接收数据的同时不占用核心的处理，所以选择了非阻塞式的SPI-DMA传输，可以按照三个ADC的硬件摆放顺序，将三组数字量依次且完整接收。
2.2 功能实现 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9bd1ba132b5af38fbacfe9b7cb293a29/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-09T11:56:12+08:00" />
<meta property="article:modified_time" content="2023-02-09T11:56:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32CubeMX配置HAL库实现SPI-DMA的递归调用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>对于快速入门STM32CubeMX，可以参考</h2> 
<h2><a class="link-info" href="https://blog.csdn.net/as480133937/article/details/99935090" title="【STM32】HAL库 STM32CubeMX系列学习教程">【STM32】HAL库 STM32CubeMX系列学习教程</a></h2> 
<h2></h2> 
<h2>——————————</h2> 
<h2>一、硬件参数与配置：</h2> 
<h4><strong>核心：</strong>STM32F407ZET6  </h4> 
<h4><strong>外设ADC：</strong>ADS1258   数量：3个 </h4> 
<p> ※ 核心与3个ADC使用SPI总线 “一主多从” 方式连接，PCB布线的方式与下图一致。</p> 
<p>※ 在电路板上STM32与三个ADS1258在同一直线上分布，STM32在一端，三个ADC依次排布。</p> 
<p>※ 离STM32最远ADC的DRDY硬件管脚与STM32的EXTI line4 interrupt连接。</p> 
<p><img alt="" height="313" src="https://images2.imgbox.com/66/68/Wv9hzFD1_o.png" width="395"></p> 
<p> </p> 
<h3>1.1 STM32CubeMX的设置 </h3> 
<p>1.1.1 时钟树配置如下： </p> 
<p><img alt="" height="378" src="https://images2.imgbox.com/9a/27/dxl7ETCZ_o.png" width="808"></p> 
<p></p> 
<p> 1.1.2 ADC输入的CLK由STM32的定时器TIM4控制，时钟树中APB1 Timer Clock = 84MHz，由下图配置生成PWM来当作ADC输入的CLK，<strong>CLK的频率为84/8 = 10.5MHz</strong>，<img alt="" height="244" src="https://images2.imgbox.com/cc/4a/vXl6WNxB_o.png" width="506"></p> 
<p></p> 
<p>1.1.3 使用STM32的SPI3通讯协议，SPI3_RX的DMA Request与DMA1 Stream0连接，SPI3_TX的DMA Request与DMA1 Stream0连接。由于ADS1258的Datasheet中对SPI速率的要求，确定了STM32与ADC之间的SPI通讯速率为<strong>5.25MBits/s，即SCLK = 5.25MBits/s</strong></p> 
<p><img alt="" height="68" src="https://images2.imgbox.com/e6/6d/4B5opoEC_o.png" width="467"></p> 
<p><img alt="" height="240" src="https://images2.imgbox.com/13/e1/jo6KQ75W_o.png" width="453"></p> 
<p></p> 
<h3>1.2 ADS1258的设置</h3> 
<p>1.2.1 在整个系统初始化时，STM32向ADS1258发送一系列寄存器指令，将ADS1258的采样模式设置为Auto-Scan Mode、在该模式下使能需要采样的模拟信号输入管脚（已使能管脚按ADS1258 datasheet中的Channel ID，自动转换至待采样的模拟信号输入管脚）。</p> 
<p></p> 
<p>1.2.2 ADS1258在Auto-Scan Mode的Data Rate的计算公式如下，初始化设置中fclk = 10.5MHz，DR = 10b，TD = 8，CHOP = 0，计算得<strong>Data Rate = 5043Hz</strong>，即每个ADC的每次采样完成后DRDY引脚输出的信号频率为5043Hz。</p> 
<p><img alt="" height="90" src="https://images2.imgbox.com/16/c5/zRb26fQx_o.png" width="389"></p> 
<p></p> 
<p></p> 
<h2> 二、运行逻辑</h2> 
<h4>2.1 功能概述</h4> 
<p>在电路设计上，三个ADC的采样启停通过硬件连接由STM32的同步控制，且ADS1258的采样模式为Auto-Scan Mode，因此三个ADC能够同时将预定的输入模拟信号进行采样并转换为数字量，即在任一ADC的两个DRDY信号之间，三个ADC均在硬件上一一对应的模拟信号输入管脚进行采样。在两个DRDY之间，STM32需要通过SPI协议接收三组 4 Bytes 的数字量，为了在接收数据的同时不占用核心的处理，所以选择了非阻塞式的SPI-DMA传输，可以按照三个ADC的硬件摆放顺序，将三组数字量依次且完整接收。</p> 
<p></p> 
<h4>2.2 功能实现</h4> 
<p>2.2.1 主要函数分析</p> 
<p>使用EXTI line4 interrupt中断，离STM32最远ADC的DRDY管脚为中断信号源，在STM32的外部中断回调函数中，使用HAL库中的HAL_SPI_TransmitReceive_DMA函数，在两个DRDY信号之间（即下一次ADC采样完成前），通过类似递归的逻辑，将三个ADC的采样数据通过SPI协议传输至STM32。</p> 
<pre><code class="language-cpp">HAL_StatusTypeDef HAL_SPI_TransmitReceive_DMA(SPI_HandleTypeDef *hspi, uint8_t *pTxData, uint8_t *pRxData, uint16_t Size)</code></pre> 
<p></p> 
<p>使用 HAL_SPI_TransmitReceive_DMA函数，STM32需要发送1个字节的“通道数据读取指令”，紧接着便可接收4个字节ADC的采样数据，其中接收的第1个字节为状态字节，后3个字节为24位采样数据（通讯时序图见ADS1258的datasheet）。通过对HAL_SPI_TransmitReceive_DMA函数的源码、断点调试及相应寄存器的分析，确定了在stm32f4xx_it.c文件中的DMA1_Stream5_IRQHandler函数中用户可编辑代码段，可成功调用HAL_SPI_TransmitReceive_DMA函数。</p> 
<pre><code class="language-cpp">void DMA1_Stream5_IRQHandler(void)</code></pre> 
<p></p> 
<p></p> 
<p>2.2.2 中断函数</p> 
<p>相关中断的中断向量表如下图。</p> 
<p><img alt="" height="75" src="https://images2.imgbox.com/96/c7/p2jBQ32O_o.png" width="258"></p> 
<p>在HAL_SPI_TransmitReceive_DMA函数中会产生DMA1_Stream0_IRQHandler中断服务函数和DMA5_Stream0_IRQHandler中断服务函数的中断信号，即在外部中断服务函数执行完成后，会依次执行DMA1_Stream0_IRQHandler中断服务函数和DMA5_Stream0_IRQHandler中断服务函数。这两个中断服务函数中默认执行HAL_DMA_IRQHandler函数，其分别与SPI3_RX和SPI3_TX相应的&amp;hdma_spi3_rx和&amp;hdma_spi3_tx句柄绑定（下图为1.1.3 图表中设置生成的代码）。</p> 
<p><img alt="" height="181" src="https://images2.imgbox.com/7d/e2/UyjaZB5D_o.png" width="459"></p> 
<p><img alt="" height="364" src="https://images2.imgbox.com/20/b5/ZQqJ91fJ_o.png" width="666"> </p> 
<p>在HAL_DMA_IRQHandler(&amp;hdma_spi3_rx)前加入延时，一是为了避免当HAL_SPI_TransmitReceive_DMA函数正在运行过程中再次调用该函数，而导致DMA相关寄存器未复位，最终导致硬件执行错误；二是为了避免STM32还未完整接收某一个ADC传输的数据时，紧邻的ADC就开始发送数据，而导致的数据冲突。</p> 
<p>在HAL_DMA_IRQHandler(&amp;hdma_spi3_tx)后加入上述程序，是当外部中断回调函数中的HAL_SPI_TransmitReceive_DMA函数成功执行后，即第一个ADC发送数据并被STM32完整接收后，开始准备接收第二个和第三个ADC的数据。adDataChannel变量是“递归”的条件判断，即当三个ADC的数据全部发送并被STM32完整接收后，开始准备下一轮的数据接收。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6a2c107141d2207c47e380aa8a7dd6c2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python深度学习实战PyQt5信号与槽的连接</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/edca5443298e6df12d543d35320430d8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">对抗生成网络GAN系列——DCGAN简介及人脸图像生成案例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>