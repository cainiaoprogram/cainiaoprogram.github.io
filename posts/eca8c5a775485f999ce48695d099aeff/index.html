<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>尚硅谷k8s笔记（未完结） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="尚硅谷k8s笔记（未完结）" />
<meta property="og:description" content="一、安装说明 准备四台服务器，并每台服务器的配置最低为 2G2核 否则无法安装。
系统Centos7。
注意安装k8s最低配置为，2核，否则在初始化节点的时候会报错。
请先下载准备好的相关文件
文件链接：https://pan.baidu.com/s/1re9043zu6qq4UuElBAw2sg 提取码：gvmx
二、系统初始化 本节各节点都要执行
1.设置系统名称 三台服务器分别叫 k8s-master01，k8s-node01,k8s-master02。
hostnamectl set-hostname k8s-master01 2.修改hosts vi /etc/hosts 配置各节点映射，以及flannel下载时的网络映射。
如：
192.168.149.128 k8s-master01 192.168.149.129 k8s-node01 192.168.149.130 k8s-node02 199.232.68.133 raw.githubusercontent.com 3.安装工具依赖包 yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git 4.设置防火墙 关闭防火墙
systemctl stop firewalld &amp;&amp; systemctl disable firewalld 设置规则为空
yum -y install iptables-services &amp;&amp; systemctl start iptables &amp;&amp; systemctl enable iptables &amp;&amp; iptables -F &amp;&amp; service iptables save 5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/eca8c5a775485f999ce48695d099aeff/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-16T17:00:42+08:00" />
<meta property="article:modified_time" content="2021-09-16T17:00:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">尚硅谷k8s笔记（未完结）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一、安装说明</h3> 
<p>准备四台服务器，并每台服务器的配置最低为 2G2核 否则无法安装。<br> 系统Centos7。<br> 注意安装k8s最低配置为，2核，否则在初始化节点的时候会报错。<br> <img src="https://images2.imgbox.com/c9/1d/eAe8uiVM_o.png" alt="在这里插入图片描述"><br> 请先下载准备好的相关文件<br> 文件链接：https://pan.baidu.com/s/1re9043zu6qq4UuElBAw2sg 提取码：gvmx</p> 
<h3><a id="_7"></a>二、系统初始化</h3> 
<blockquote> 
 <p>本节各节点都要执行</p> 
</blockquote> 
<h4><a id="1_12"></a>1.设置系统名称</h4> 
<p>三台服务器分别叫 k8s-master01，k8s-node01,k8s-master02。</p> 
<pre><code class="prism language-powershell">hostnamectl  <span class="token function">set-hostname</span>  k8s<span class="token operator">-</span>master01
</code></pre> 
<h4><a id="2hosts_18"></a>2.修改hosts</h4> 
<pre><code class="prism language-powershell">vi <span class="token operator">/</span>etc<span class="token operator">/</span>hosts
</code></pre> 
<p>配置各节点映射，以及flannel下载时的网络映射。<br> 如：</p> 
<pre><code class="prism language-powershell">192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>149<span class="token punctuation">.</span>128 k8s<span class="token operator">-</span>master01
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>149<span class="token punctuation">.</span>129 k8s<span class="token operator">-</span>node01
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>149<span class="token punctuation">.</span>130 k8s<span class="token operator">-</span>node02

199<span class="token punctuation">.</span>232<span class="token punctuation">.</span>68<span class="token punctuation">.</span>133 raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com
</code></pre> 
<h4><a id="3_33"></a>3.安装工具依赖包</h4> 
<pre><code class="prism language-powershell">yum install <span class="token operator">-</span>y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net<span class="token operator">-</span>tools git
</code></pre> 
<h4><a id="4_38"></a>4.设置防火墙</h4> 
<p>关闭防火墙</p> 
<pre><code class="prism language-powershell">systemctl  stop firewalld  &amp;&amp;  systemctl  disable firewalld
</code></pre> 
<p>设置规则为空</p> 
<pre><code class="prism language-powershell">yum <span class="token operator">-</span>y install iptables<span class="token operator">-</span>services  &amp;&amp;  systemctl  <span class="token function">start</span> iptables  &amp;&amp;  systemctl  enable iptables  &amp;&amp;  iptables <span class="token operator">-</span>F  &amp;&amp;  service iptables save
</code></pre> 
<h4><a id="5_SELINUX_48"></a>5. 关闭SELINUX</h4> 
<pre><code class="prism language-powershell">swapoff <span class="token operator">-</span>a &amp;&amp; sed <span class="token operator">-</span>i <span class="token string">'/ swap / s/^\(.*\)$/#\1/g'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>fstab
</code></pre> 
<pre><code class="prism language-powershell">setenforce 0 &amp;&amp; sed <span class="token operator">-</span>i <span class="token string">'s/^SELINUX=.*/SELINUX=disabled/'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>config
</code></pre> 
<h4><a id="6k8s_57"></a>6.调整k8s内核参数配置</h4> 
<p>① 编写</p> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> &gt; kubernetes<span class="token punctuation">.</span>conf &lt;&lt;EOF
net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge<span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>iptables=1
net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge<span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>ip6tables=1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>ip_forward=1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>tcp_tw_recycle=0
vm<span class="token punctuation">.</span>swappiness=0 <span class="token comment"># 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span>
vm<span class="token punctuation">.</span>overcommit_memory=1 <span class="token comment"># 不检查物理内存是否够用</span>
vm<span class="token punctuation">.</span>panic_on_oom=0 <span class="token comment"># 开启 OOM  </span>
fs<span class="token punctuation">.</span>inotify<span class="token punctuation">.</span>max_user_instances=8192
fs<span class="token punctuation">.</span>inotify<span class="token punctuation">.</span>max_user_watches=1048576
fs<span class="token punctuation">.</span>file<span class="token operator">-</span>max=52706963
fs<span class="token punctuation">.</span>nr_open=52706963
net<span class="token punctuation">.</span>ipv6<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>disable_ipv6=1
net<span class="token punctuation">.</span>netfilter<span class="token punctuation">.</span>nf_conntrack_max=2310720
EOF
</code></pre> 
<p>② 复制文件</p> 
<pre><code class="prism language-powershell"><span class="token function">cp</span> kubernetes<span class="token punctuation">.</span>conf  <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>d<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>conf
</code></pre> 
<p>③ 生效内核参数</p> 
<pre><code class="prism language-powershell">sysctl <span class="token operator">-</span>p <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>d<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>conf
</code></pre> 
<h4><a id="7_rsyslogd__systemd_journald_84"></a>7.设置 rsyslogd 和 systemd journald</h4> 
<p>① 创建持久化保存日志的目录</p> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>journal
mkdir <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>journald<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>d
</code></pre> 
<p>② 参数配置编写</p> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> &gt; <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>journald<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span>99<span class="token operator">-</span>prophet<span class="token punctuation">.</span>conf &lt;&lt;EOF
<span class="token namespace">[Journal]</span>
<span class="token comment"># 持久化保存到磁盘</span>
Storage=persistent
 
<span class="token comment"># 压缩历史日志</span>
Compress=yes
 
SyncIntervalSec=5m
RateLimitInterval=30s
RateLimitBurst=1000
 
<span class="token comment"># 最大占用空间 10G</span>
SystemMaxUse=10G
 
<span class="token comment"># 单日志文件最大 200M</span>
SystemMaxFileSize=200M
 
<span class="token comment"># 日志保存时间 2 周</span>
MaxRetentionSec=2week
 
<span class="token comment"># 不将日志转发到 syslog</span>
ForwardToSyslog=no
EOF
</code></pre> 
<p>③ 参数生效</p> 
<pre><code class="prism language-powershell">systemctl restart systemd<span class="token operator">-</span>journald
</code></pre> 
<h4><a id="8_121"></a>8.内核升级</h4> 
<p>升级原因：CentOS 7.x 系统自带的 3.10.x 内核存在一些 Bugs，导致运行的 Docker、Kubernetes 不稳定。</p> 
<p>① 下载rpm</p> 
<pre><code class="prism language-powershell">rpm <span class="token operator">-</span>Uvh http:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>elrepo<span class="token punctuation">.</span>org<span class="token operator">/</span>elrepo<span class="token operator">-</span>release<span class="token operator">-</span>7<span class="token punctuation">.</span>0<span class="token operator">-</span>3<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>elrepo<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm
</code></pre> 
<p>② 安装</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 安装完成后检查 /boot/grub2/grub.cfg 中对应内核 menuentry 中是否包含 initrd16 配置，如果没有再安装一次！</span>
yum <span class="token operator">--</span>enablerepo=elrepo<span class="token operator">-</span>kernel install <span class="token operator">-</span>y kernel<span class="token operator">-lt</span>
</code></pre> 
<p>③ 设置内核</p> 
<pre><code class="prism language-powershell">grub2<span class="token operator">-</span><span class="token function">set-default</span> <span class="token string">'CentOS Linux (4.4.189-1.el7.elrepo.x86_64) 7 (Core)'</span>
</code></pre> 
<h3><a id="Kubeadm_138"></a>三、Kubeadm部署安装</h3> 
<blockquote> 
 <p>本节中1、2和3步各节点都要执行</p> 
</blockquote> 
<h4><a id="1_kubeproxyipvs_142"></a>1. kube-proxy开启ipvs的前置条件</h4> 
<p>模块加载</p> 
<pre><code class="prism language-powershell">modprobe br_netfilter
</code></pre> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> &gt; <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>modules<span class="token operator">/</span>ipvs<span class="token punctuation">.</span>modules &lt;&lt;EOF
<span class="token comment">#!/bin/bash</span>
modprobe <span class="token operator">--</span> ip_vs
modprobe <span class="token operator">--</span> ip_vs_rr
modprobe <span class="token operator">--</span> ip_vs_wrr
modprobe <span class="token operator">--</span> ip_vs_sh
modprobe <span class="token operator">--</span> nf_conntrack_ipv4
EOF
</code></pre> 
<p>赋予权限</p> 
<pre><code class="prism language-powershell">chmod 755 <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>modules<span class="token operator">/</span>ipvs<span class="token punctuation">.</span>modules
</code></pre> 
<h4><a id="2docker_161"></a>2.docker安装</h4> 
<pre><code class="prism language-powershell">yum install <span class="token operator">-</span>y yum<span class="token operator">-</span>utils device<span class="token operator">-</span>mapper<span class="token operator">-</span>persistent<span class="token operator">-</span><span class="token keyword">data</span> lvm2

yum<span class="token operator">-</span>config<span class="token operator">-</span>manager \
  <span class="token operator">--</span><span class="token function">add-repo</span> \
  http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token operator">/</span>linux<span class="token operator">/</span>centos<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span>repo

yum update <span class="token operator">-</span>y &amp;&amp;  yum install <span class="token operator">-</span>y docker<span class="token operator">-</span>ce<span class="token operator">-</span>18<span class="token punctuation">.</span>09<span class="token punctuation">.</span>5<span class="token operator">-</span>3<span class="token punctuation">.</span>el7

<span class="token comment">## 创建 /etc/docker 目录</span>
mkdir <span class="token operator">/</span>etc<span class="token operator">/</span>docker

<span class="token comment"># 配置 daemon</span>
<span class="token function">cat</span> &gt; <span class="token operator">/</span>etc<span class="token operator">/</span>docker<span class="token operator">/</span>daemon<span class="token punctuation">.</span>json &lt;&lt;EOF
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"exec-opts"</span>: <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"log-driver"</span>: <span class="token string">"json-file"</span><span class="token punctuation">,</span>
  <span class="token string">"log-opts"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"max-size"</span>: <span class="token string">"100m"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
EOF

mkdir <span class="token operator">-</span>p <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>docker<span class="token punctuation">.</span>service<span class="token punctuation">.</span>d

<span class="token comment"># 重启docker服务</span>
systemctl daemon<span class="token operator">-</span>reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl enable docker
</code></pre> 
<h4><a id="3_Kubeadm_192"></a>3. Kubeadm安装（主从配置）</h4> 
<ul><li><em>各个服务器都执行下面的操作。</em></li></ul> 
<blockquote> 
 <p>离线安装docker的镜像<br> 1.先下载好准备的文件（👇） 后解压，解压指令：tar -zvxf 文件名<br> 文件链接：https://pan.baidu.com/s/1re9043zu6qq4UuElBAw2sg 提取码：gvmx<br> <br><br> 2.编写安装脚本<br> vi load-images.sh<br> ==================================================<br> 脚本内容如下：<br> #!/bin/bash<br> ls /root/kubeadm-basic.images &gt; /tmp/images-list.txt<br> cd /root/kubeadm-basic.images<br> for i in $( cat /tmp/images-list.txt )<br> do<br> docker load -i $i<br> done<br> rm -rf /tmp/images-list.txt<br> ==================================================<br> <br><br> 3.赋予权限并执行脚本<br> chmod a+x load-images.sh &amp;&amp; ./load-images.sh<br> <br><br> 提示：<br>     上面的安装包脚本等都可以通过scp传到其它子节点服务器上。<br>     如：scp -r kubeadm-basic.images load-images.sh root@192.168.149.129:/root/</p> 
</blockquote> 
<hr> 
<p>配置源</p> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> &lt;&lt;EOF &gt; <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>repo
<span class="token namespace">[kubernetes]</span>
name=Kubernetes
baseurl=http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>repos<span class="token operator">/</span>kubernetes<span class="token operator">-</span>el7<span class="token operator">-</span>x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>yum<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg 
http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>rpm<span class="token operator">-</span>package<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg
EOF
</code></pre> 
<p>安装kubeadm、kubectl和kubelet</p> 
<pre><code class="prism language-powershell">yum <span class="token operator">-</span>y  install  kubeadm<span class="token operator">-</span>1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>1 kubectl<span class="token operator">-</span>1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>1 kubelet<span class="token operator">-</span>1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>1
</code></pre> 
<p>开机自启</p> 
<pre><code class="prism language-powershell">systemctl enable kubelet<span class="token punctuation">.</span>service
</code></pre> 
<h4><a id="4_244"></a>4.初始化主节点</h4> 
<p>生成配置文件</p> 
<pre><code class="prism language-powershell">kubeadm config print init<span class="token operator">-</span>defaults &gt; kubeadm<span class="token operator">-</span>config<span class="token punctuation">.</span>yaml
</code></pre> 
<p>修改配置文件<br> vi kubeadm-config.yaml</p> 
<blockquote> 
 <p>修改内容如下：</p> 
 <ul><li>第12行配置主节点IP地址</li><li>第34行修改版本为 v.1.15.1</li><li>第37行新增 podSubnet: “10.244.0.0/16”</li><li>并在尾末加入下方配置：</li></ul> 
</blockquote> 
<pre><code class="prism language-powershell">apiVersion: kubeproxy<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">/</span>v1alpha1
    kind: KubeProxyConfiguration
    featureGates:
      SupportIPVSProxyMode: true
    mode: ipvs
</code></pre> 
<p>具体参考下图：<br> <img src="https://images2.imgbox.com/68/50/mEDJcHfZ_o.png" alt="在这里插入图片描述"><br> 执行</p> 
<pre><code class="prism language-powershell">kubeadm init <span class="token operator">--</span>config=kubeadm<span class="token operator">-</span>config<span class="token punctuation">.</span>yaml <span class="token operator">--</span>experimental<span class="token operator">-</span>upload<span class="token operator">-</span>certs <span class="token punctuation">|</span> <span class="token function">tee</span> kubeadm<span class="token operator">-</span>init<span class="token punctuation">.</span>log
</code></pre> 
<p>查看日志</p> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> kubeadm<span class="token operator">-</span>init<span class="token punctuation">.</span>log
</code></pre> 
<p><img src="https://images2.imgbox.com/78/ce/mDAdv9Ju_o.png" alt="在这里插入图片描述"><br> 根据日志提示需要我们执行的命令如下：</p> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">-</span>p <span class="token variable">$HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube
sudo <span class="token function">cp</span> <span class="token operator">-</span>i <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>admin<span class="token punctuation">.</span>conf <span class="token variable">$HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube<span class="token operator">/</span>config
sudo chown $<span class="token punctuation">(</span>id <span class="token operator">-</span>u<span class="token punctuation">)</span>:$<span class="token punctuation">(</span>id <span class="token operator">-</span>g<span class="token punctuation">)</span> <span class="token variable">$HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube<span class="token operator">/</span>config
</code></pre> 
<p>整理下配置文件，创建文件夹</p> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">-</span>p <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>install<span class="token operator">-</span>k8s<span class="token operator">/</span>core &amp;&amp; mkdir <span class="token operator">-</span>p <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>install<span class="token operator">-</span>k8s<span class="token operator">/</span>plugin<span class="token operator">/</span>flannel
</code></pre> 
<p>移动配置文件到core下</p> 
<pre><code class="prism language-powershell"><span class="token function">mv</span> kubeadm<span class="token operator">-</span>init<span class="token punctuation">.</span>log kubeadm<span class="token operator">-</span>config<span class="token punctuation">.</span>yaml <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>install<span class="token operator">-</span>k8s<span class="token operator">/</span>core
</code></pre> 
<p>生成不失效的token</p> 
<pre><code class="prism language-powershell">kubeadm token create <span class="token operator">--</span>ttl 0 <span class="token operator">--</span>print<span class="token operator">-</span><span class="token function">join-command</span>
</code></pre> 
<h4><a id="5__300"></a>5. 网络部署</h4> 
<p>进入目录</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>install<span class="token operator">-</span>k8s<span class="token operator">/</span>plugin<span class="token operator">/</span>flannel
</code></pre> 
<p>下载kube-flannel.yml</p> 
<pre><code class="prism language-powershell">wget https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>coreos<span class="token operator">/</span>flannel<span class="token operator">/</span>master<span class="token operator">/</span>Documentation<span class="token operator">/</span>kube<span class="token operator">-</span>flannel<span class="token punctuation">.</span>yml
</code></pre> 
<p>注意，如果提示下载失败，请配置hosts：</p> 
<pre><code class="prism language-powershell">sudo vi <span class="token operator">/</span>etc<span class="token operator">/</span>hosts

<span class="token comment"># 新增下👇</span>
199<span class="token punctuation">.</span>232<span class="token punctuation">.</span>68<span class="token punctuation">.</span>133 raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com
</code></pre> 
<hr> 
<p>创建 flannel</p> 
<pre><code class="prism language-powershell">kubectl create <span class="token operator">-</span>f kube<span class="token operator">-</span>flannel<span class="token punctuation">.</span>yml
</code></pre> 
<p>查看组件</p> 
<pre><code class="prism language-powershell">kubectl get pod <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token operator">-</span>o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/12/e0/ZbPJ4bAP_o.png" alt="在这里插入图片描述"><br> 注意：如果安装了flannel但是状态一直是Init:0/1，那么可以删除掉这个pod，会重新安装一个，状态过一会就成了Running，节点状态也成了Ready。<br> 删除pod：</p> 
<pre><code class="prism language-powershell">kubectl delete pod kube<span class="token operator">-</span>flannel<span class="token operator">-</span>ds<span class="token operator">-</span>dbvxm <span class="token operator">-</span>n kube<span class="token operator">-</span>system
</code></pre> 
<p><img src="https://images2.imgbox.com/2c/cc/WmMsBqk4_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="6__339"></a>6. 子节点加入</h4> 
<p>接下来就是让另外的子节点加入到主节点。命令在init的log中。</p> 
<pre><code class="prism language-powershell">cd <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>core<span class="token operator">/</span> &amp;&amp; vi kubeadm<span class="token operator">-</span>init<span class="token punctuation">.</span>log
</code></pre> 
<p>进入日志后的最后一行。<br> <img src="https://images2.imgbox.com/6a/b5/CoN93avX_o.png" alt="在这里插入图片描述"><br> 在子节点服务器上执行，加入主节点的命令<br> <img src="https://images2.imgbox.com/bd/4a/mzX4yO6q_o.png" alt="在这里插入图片描述"><br> 回到主节点服务器查看节点状况</p> 
<pre><code class="prism language-powershell">kubectl get node
</code></pre> 
<p><img src="https://images2.imgbox.com/45/72/DqPGDhxY_o.png" alt="在这里插入图片描述"><br> 现在两个节点都是NotReady，可以查看pod的网络是否准备好了</p> 
<pre><code class="prism language-powershell">kubectl get pod <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token operator">-</span>o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/69/6a/SoFYFWVE_o.png" alt="在这里插入图片描述"><br> 过一会pod的状态会从Init变成Running，发现集群状态也正常了,如果一直不变，就delete，会自带重新创建一个新的pod。<br> <img src="https://images2.imgbox.com/06/f1/dJ6ZuTuD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_364"></a>四、配置私有仓库</h3> 
<blockquote> 
 <p>创建第四台服务器，并安装docker。</p> 
</blockquote> 
<h4><a id="1_367"></a>1.准备工作</h4> 
<p>① 修改doker的/etc/docker/daemon.json文件<br> 新增(相当于忽略这个url，放行，url随你怎么写，注意用","分隔)<br> 如：</p> 
<pre><code class="prism language-powershell"><span class="token string">"insecure-registries"</span>: <span class="token punctuation">[</span><span class="token string">"www.hub.elwin.com"</span><span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/09/b7/GvjdJiKd_o.png" alt="在这里插入图片描述"></p> 
<p>② 安装lrzsz</p> 
<pre><code class="prism language-powershell">yum <span class="token operator">-</span>y install lrzsz
</code></pre> 
<p>③ 将准备的docker-compose文件上传至服务器的/usr/local/bin下<br> 然后赋予权限：</p> 
<pre><code class="prism language-powershell">chmod a<span class="token operator">+</span>x <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>docker<span class="token operator">-</span>compose
</code></pre> 
<p>④ 上传harbor-offline-installer-v1.2.0.tgz文件到/usr/local/目录下并解压</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span> &amp;&amp; tar <span class="token operator">-</span>zxvf harbor<span class="token operator">-</span>offline<span class="token operator">-</span>installer<span class="token operator">-</span>v1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>tgz
</code></pre> 
<p>⑤ 修改解压目录harbor下的harbor.cfg</p> 
<blockquote> 
 <p>第5行：修改刚刚daemon.json的url（具体看第一步）<br> 第9行：改成https 也是根据daemon.json的url配置来的<br><br> 如图：<br> <img src="https://images2.imgbox.com/21/aa/Ma4LDozQ_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h4><a id="2_399"></a>2.证书创建</h4> 
<p>① 创建证书目录，并进入目录</p> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>cert<span class="token operator">/</span> &amp;&amp; cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>cert
</code></pre> 
<p>② 创建证书</p> 
<pre><code class="prism language-powershell">openssl genrsa <span class="token operator">-</span>des3 <span class="token operator">-</span>out server<span class="token punctuation">.</span>key 2048
</code></pre> 
<p>生成私钥并设置密码，如若生错，请删除重来</p> 
<p>③ 创建证书请求，密码输入刚刚生成的私钥密码，以及各个信息</p> 
<pre><code class="prism language-powershell">openssl req <span class="token operator">-</span>new <span class="token operator">-</span>key server<span class="token punctuation">.</span>key <span class="token operator">-</span>out server<span class="token punctuation">.</span>csr
</code></pre> 
<p>如图：<br> <img src="https://images2.imgbox.com/00/67/hOs32XAN_o.png" alt="在这里插入图片描述"><br> ④ 备份私钥</p> 
<pre><code class="prism language-powershell"><span class="token function">cp</span> server<span class="token punctuation">.</span>key server<span class="token punctuation">.</span>key<span class="token punctuation">.</span>org
</code></pre> 
<p>⑤ 退出私钥密码，输入密码</p> 
<pre><code class="prism language-powershell">openssl rsa <span class="token operator">-in</span> server<span class="token punctuation">.</span>key<span class="token punctuation">.</span>org <span class="token operator">-</span>out server<span class="token punctuation">.</span>key
</code></pre> 
<p><img src="https://images2.imgbox.com/5e/8f/LiMvucb0_o.png" alt="在这里插入图片描述"></p> 
<p>⑥ 签名</p> 
<pre><code class="prism language-powershell">openssl x509 <span class="token operator">-</span>req <span class="token operator">-</span>days 365 <span class="token operator">-in</span> server<span class="token punctuation">.</span>csr <span class="token operator">-</span>signkey server<span class="token punctuation">.</span>key <span class="token operator">-</span>out server<span class="token punctuation">.</span>crt
</code></pre> 
<p>⑦ 赋予权限</p> 
<pre><code class="prism language-powershell">chmod a<span class="token operator">+</span>x <span class="token operator">*</span>
</code></pre> 
<h4><a id="3_442"></a>3.安装</h4> 
<p>① 回到harbor目录</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>harbor<span class="token operator">/</span> 
</code></pre> 
<p>② 修改所有服务器(所有节点以及hub这台)的hosts</p> 
<pre><code class="prism language-powershell">vi <span class="token operator">/</span>etc<span class="token operator">/</span>hosts
</code></pre> 
<p>如<br> <img src="https://images2.imgbox.com/2d/93/zMz2wRK3_o.png" alt="在这里插入图片描述"></p> 
<p>③ 安装启动</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">.</span><span class="token operator">/</span>install<span class="token punctuation">.</span>sh
</code></pre> 
<p><img src="https://images2.imgbox.com/35/7f/ZVtgIjhs_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="k8s_463"></a>五、k8s简单使用</h3> 
<h4><a id="1pod_464"></a>1.创建pod</h4> 
<blockquote> 
 <p>格式：kubectl run pod名 --image==docker镜像 --port=80 --replicas=副本数（奇数个）</p> 
</blockquote> 
<p>如：</p> 
<pre><code class="prism language-powershell">kubectl run nginx<span class="token operator">-</span>demo <span class="token operator">--</span>image==hub<span class="token punctuation">.</span>elwin<span class="token punctuation">.</span>com<span class="token operator">/</span>library<span class="token operator">/</span>myapp:v1 <span class="token operator">--</span>port=80 <span class="token operator">--</span>replicas=1
</code></pre> 
<h4><a id="2rs_472"></a>2.查看rs</h4> 
<pre><code class="prism language-powershell">kubectl get rs
</code></pre> 
<h4><a id="3pod_478"></a>3.查看pod</h4> 
<pre><code class="prism language-powershell">kubectl get pod <span class="token operator">-</span>o wide

kubectl get po <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token operator">-</span>o wide
</code></pre> 
<h4><a id="4pod_486"></a>4.删除pod</h4> 
<pre><code class="prism language-powershell"> kubectl delete pod pod名
</code></pre> 
<h4><a id="5_491"></a>5.修改副本数</h4> 
<pre><code class="prism language-powershell">kubectl scale <span class="token operator">--</span>replicas=3 deployment<span class="token operator">/</span>myapp
</code></pre> 
<h4><a id="6pod_497"></a>6.pod负载均衡</h4> 
<p>当有多个副本提供服务时，k8s提供了统一一个ip来进行自动负载均衡。</p> 
<pre><code class="prism language-powershell"> kubectl expose deployment myapp <span class="token operator">--</span>port=30000 <span class="token operator">--</span>target<span class="token operator">-</span>port=80
</code></pre> 
<h4><a id="7svc_504"></a>7.获取svc</h4> 
<pre><code class="prism language-powershell"> kubectl get svc
</code></pre> 
<p><img src="https://images2.imgbox.com/52/47/SRk52Q7y_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="8_511"></a>8.对外提供访问</h4> 
<p>根据获取的svc名进行对应的修改</p> 
<pre><code class="prism language-powershell">kubectl edit svc myapp
</code></pre> 
<p>修改type为NodePort<br> <img src="https://images2.imgbox.com/84/43/C6uOgPhZ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1e/44/zfqYQlN8_o.png" alt="在这里插入图片描述"><br> 外部可以通过当前服务器ip+映射端口访问，如上图就是http://192.168.149.128:30764/</p> 
<h3><a id="pods_520"></a>六、pods</h3> 
<h4><a id="1pod_521"></a>1.pod基本概念</h4> 
<ul><li>可以创建和管理的最先单元</li><li>包含多个容器，即在一个pod中可以安装多个docker容器</li><li>pod中容器与容器之间网络是互通的</li><li>生命周期短暂比如，当 Pod 所在节点发生故障，那么该节点上的 Pod<br> 会被调度到其他节点，但需要注意的是，被重新调度的 Pod 是一个全新的 Pod,跟之前的<br> Pod 没有半毛钱关系</li></ul> 
<h4><a id="2pod_530"></a>2.pod的实现机制</h4> 
<blockquote> 
 <p>每个 Pod 中有一个 Pause 容器保存所有的容器状态。通过管理 pause 容器，达到管理 pod 中所有容器的效果。</p> 
</blockquote> 
<p>共享网络：<br>       多个容器共享同一 network namespace，由此在一个 Pod 里的多个容器共享 Pod 的 IP 和端口 namespace，所以一个 Pod 内的多个容器之间可以通过 localhost 来进行通信,但需要注意的是容器间的端口不要冲突。</p> 
<p>共享存储：<br>       容器间存储是共享的，使用数据卷进行持久化存储。</p> 
<h4><a id="3__540"></a>3. 镜像拉取</h4> 
<p>pod里是由一个或多个容器组成，那么我们可以指定要拉取的镜像。</p> 
<blockquote> 
 <p>拉取策略</p> 
 <ul><li>IfNotPresent: 默认值。镜像在宿主机上不存在时拉取，但:latest标签的镜像默认为Always</li><li>Always: 每次创建都会去拉取镜像</li><li>Nerver: 永远不主动拉取这个镜像</li></ul> 
</blockquote> 
<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>spec.containers[].image</td><td>镜像拉取地址以及版本</td></tr><tr><td>spec.containers[].name</td><td>容器名称</td></tr><tr><td>spec.containers[].imagePullPolicy</td><td>拉取策略</td></tr></tbody></table> 
<p>如：</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Deployment
metadata:
  name: web
spec:
  containers:
    <span class="token operator">-</span> image: nginx
      name: nginx
      imagePullPolicy: IfNotPresent
</code></pre> 
<h4><a id="4pod_568"></a>4.pod资源限制</h4> 
<p>pod设置可以将请求调度到资源充足的Node上，limit设置上限。</p> 
<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>spec.containers[].resources.requests.cpu</td><td>调度请求的CPU，可以超过</td></tr><tr><td>spec.containers[].resources.requests.memory</td><td>调度请求的内存，可以超过；但如果超过，容器可能会在Node内存不足时清理</td></tr><tr><td>spec.containers[].resources.limits.cpu</td><td>CPU上限，可以短暂超过，容器也不会被停止</td></tr><tr><td>spec.containers[].resources.limits.memory</td><td>内存上限，不可以超过；如果超过，容器可能会被停止或调度到其他资源充足的机器上</td></tr></tbody></table> 
<p>如：</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Deployment
metadata:
  name: web
spec:
  containers:
    <span class="token operator">-</span> image: nginx
      name: nginx
      resources:
        requests:
          cpu: <span class="token string">"300m"</span>
          memory: <span class="token string">"56Mi"</span>
        limits:
          cpu: <span class="token string">"500m"</span>
          memory: <span class="token string">"128Mi"</span>
</code></pre> 
<h4><a id="5_595"></a>5.重启策略</h4> 
<p>此处重启是指在Pod所在Node上面本地重启，并不会调度到其他Node上去。</p> 
<blockquote> 
 <p>RestartPolicy</p> 
 <ul><li>Always：只要退出就重启,默认策略</li><li>OnFailure：失败退出（exit code不等于0）时重启</li><li>Never：只要退出就不再重启</li></ul> 
</blockquote> 
<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>spec.restartPolicy</td><td>重启策略</td></tr></tbody></table> 
<p>如：</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Deployment
metadata:
  name: web
spec:
  restartPolicy: Always
</code></pre> 
<h4><a id="6_616"></a>6.调度策略</h4> 
<blockquote> 
 <p>资源设置可以影响pod调度，详细请看上面的第6.4节。 本次主要说明 节点选择器 影响pod调度。</p> 
</blockquote> 
<p>有时候我们想让某些服务部署在指定节点上，那么我们可以用节点选择器实现。<br> 首先指定node节点标签，如：叫node1叫dev，叫node2叫test。如果说node节点标签已经起名字了，就再加个–overwrite</p> 
<pre><code class="prism language-powershell">kubectl label nodes &lt;节点名&gt; disktype=&lt;标签名&gt; <span class="token punctuation">[</span><span class="token operator">--</span>overwrite<span class="token punctuation">]</span>
</code></pre> 
<p>再指定yaml的节点选择器，只让该pod在指定节点上生成。</p> 
<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>spec.nodeSelector.disktype</td><td>节点选择</td></tr></tbody></table> 
<p>如：</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Deployment
metadata:
  name: web
spec:
  nodeSelector:
    disktype: dev
</code></pre> 
<h4><a id="7yaml_643"></a>7.快速生成模板yaml文件</h4> 
<pre><code class="prism language-powershell">kubectl create deployment web <span class="token operator">--</span>image=nginx <span class="token operator">-</span>o yaml <span class="token operator">--</span>dry<span class="token operator">-</span>run &gt;my<span class="token punctuation">.</span>yaml
</code></pre> 
<h4><a id="8podyaml_647"></a>8.将已经生成的pod转存yaml</h4> 
<pre><code class="prism language-powershell">kubectl get deployment myapp <span class="token operator">-</span>o=yaml <span class="token operator">--</span>export &gt;myapp<span class="token punctuation">.</span>yaml
</code></pre> 
<h4><a id="9yamlpod_654"></a>9.根据yaml文件创建pod</h4> 
<pre><code class="prism language-powershell">kubectl create <span class="token operator">-</span>f myapp<span class="token punctuation">.</span>yaml
</code></pre> 
<h3><a id="controller_659"></a>七、controller</h3> 
<h4><a id="1_660"></a>1.简单介绍</h4> 
<p>管理和运行容器的对象。Kubernetes 通过各种 Controller 来管理 Pod 的生命周期。为了满足不同业务场景，Kubernetes 开发了 Deployment、ReplicaSet、DaemonSet、StatefuleSet、Job 等多种 Controller</p> 
<h4><a id="2_Deployment_663"></a>2. Deployment</h4> 
<h3><a id="_665"></a>八、安装时遇到的问题</h3> 
<h4><a id="1_666"></a>1.子节点加入主节点的时候加入不进去</h4> 
<p>报错：error execution phase preflight: unable to fetch the kubeadm-config ConfigMap<br> 解决方案：因为主节点的token过期了，重新生成不过期的token，用新的token加入即可。<br> 生成命令：</p> 
<pre><code class="prism language-powershell">kubeadm token create <span class="token operator">--</span>ttl 0 <span class="token operator">--</span>print<span class="token operator">-</span><span class="token function">join-command</span>
</code></pre> 
<h4><a id="2_kubeflannelInit01_675"></a>2. kube-flannel一直Init:0/1</h4> 
<p>显示：kube-flannel-ds-gpf6l 0/1 Init:0/1<br> 解决方案：删除该pod，自动重新生成。或者继续等待<br> 删除命令：</p> 
<pre><code class="prism language-powershell">kubectl delete pod kube<span class="token operator">-</span>flannel<span class="token operator">-</span>ds<span class="token operator">-</span>xxxx <span class="token operator">-</span>n kube<span class="token operator">-</span>system
</code></pre> 
<h4><a id="3_kubeflannelyml_683"></a>3. kube-flannel.yml文件下载不下来</h4> 
<p>报错：==============连接失败<br> 解决方案：修改hosts文件，在文件末尾处新增一行添加：<em>199.232.68.133 raw.githubusercontent.com</em> ，后重新尝试下载。<br> 指令：<br> ① 修改</p> 
<pre><code class="prism language-powershell">vi <span class="token operator">/</span>etc<span class="token operator">/</span>hosts
</code></pre> 
<p>② 下载</p> 
<pre><code class="prism language-powershell">wget https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>coreos<span class="token operator">/</span>flannel<span class="token operator">/</span>master<span class="token operator">/</span>Documentation<span class="token operator">/</span>kube<span class="token operator">-</span>flannel<span class="token punctuation">.</span>yml
</code></pre> 
<h4><a id="4k8s_696"></a>4.安装k8s报错</h4> 
<p>报错：[ERROR NumCPU]: the number of available CPUs 1 is less than the required 2 [<br> <img src="https://images2.imgbox.com/9b/af/crSvAj9k_o.png" alt="在这里插入图片描述">解决方案：因为k8s最低2核，所以要将服务器内核数调整至2核以上。<br> <img src="https://images2.imgbox.com/88/07/ZiNKUksz_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="5svcpod_700"></a>5.svc访问其他节点pod不通</h4> 
<p>先看看各个节点防火墙是不是关的。<br> 参考地址：https://www.bianchengquan.com/article/409663.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cb986aa14fdecf278f77ce3f6eb709f9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">汇编语言：将AX中的数以无符号十进制形式输出显示。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80292d14072b18160de2713e9a712472/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">带你了解vue的$refs和ref（附带常见问题）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>