<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>å°šç¡…è°·k8sç¬”è®°ï¼ˆæœªå®Œç»“ï¼‰ - èœé¸Ÿç¨‹åºå‘˜åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="å°šç¡…è°·k8sç¬”è®°ï¼ˆæœªå®Œç»“ï¼‰" />
<meta property="og:description" content="ä¸€ã€å®‰è£…è¯´æ˜ å‡†å¤‡å››å°æœåŠ¡å™¨ï¼Œå¹¶æ¯å°æœåŠ¡å™¨çš„é…ç½®æœ€ä½ä¸º 2G2æ ¸ å¦åˆ™æ— æ³•å®‰è£…ã€‚
ç³»ç»ŸCentos7ã€‚
æ³¨æ„å®‰è£…k8sæœ€ä½é…ç½®ä¸ºï¼Œ2æ ¸ï¼Œå¦åˆ™åœ¨åˆå§‹åŒ–èŠ‚ç‚¹çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚
è¯·å…ˆä¸‹è½½å‡†å¤‡å¥½çš„ç›¸å…³æ–‡ä»¶
æ–‡ä»¶é“¾æ¥ï¼šhttps://pan.baidu.com/s/1re9043zu6qq4UuElBAw2sg æå–ç ï¼šgvmx
äºŒã€ç³»ç»Ÿåˆå§‹åŒ– æœ¬èŠ‚å„èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ
1.è®¾ç½®ç³»ç»Ÿåç§° ä¸‰å°æœåŠ¡å™¨åˆ†åˆ«å« k8s-master01ï¼Œk8s-node01,k8s-master02ã€‚
hostnamectl set-hostname k8s-master01 2.ä¿®æ”¹hosts vi /etc/hosts é…ç½®å„èŠ‚ç‚¹æ˜ å°„ï¼Œä»¥åŠflannelä¸‹è½½æ—¶çš„ç½‘ç»œæ˜ å°„ã€‚
å¦‚ï¼š
192.168.149.128 k8s-master01 192.168.149.129 k8s-node01 192.168.149.130 k8s-node02 199.232.68.133 raw.githubusercontent.com 3.å®‰è£…å·¥å…·ä¾èµ–åŒ… yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git 4.è®¾ç½®é˜²ç«å¢™ å…³é—­é˜²ç«å¢™
systemctl stop firewalld &amp;&amp; systemctl disable firewalld è®¾ç½®è§„åˆ™ä¸ºç©º
yum -y install iptables-services &amp;&amp; systemctl start iptables &amp;&amp; systemctl enable iptables &amp;&amp; iptables -F &amp;&amp; service iptables save 5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/eca8c5a775485f999ce48695d099aeff/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-16T17:00:42+08:00" />
<meta property="article:modified_time" content="2021-09-16T17:00:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="èœé¸Ÿç¨‹åºå‘˜åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">èœé¸Ÿç¨‹åºå‘˜åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">å°šç¡…è°·k8sç¬”è®°ï¼ˆæœªå®Œç»“ï¼‰</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>ä¸€ã€å®‰è£…è¯´æ˜</h3> 
<p>å‡†å¤‡å››å°æœåŠ¡å™¨ï¼Œå¹¶æ¯å°æœåŠ¡å™¨çš„é…ç½®æœ€ä½ä¸º 2G2æ ¸ å¦åˆ™æ— æ³•å®‰è£…ã€‚<br> ç³»ç»ŸCentos7ã€‚<br> æ³¨æ„å®‰è£…k8sæœ€ä½é…ç½®ä¸ºï¼Œ2æ ¸ï¼Œå¦åˆ™åœ¨åˆå§‹åŒ–èŠ‚ç‚¹çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚<br> <img src="https://images2.imgbox.com/c9/1d/eAe8uiVM_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> è¯·å…ˆä¸‹è½½å‡†å¤‡å¥½çš„ç›¸å…³æ–‡ä»¶<br> æ–‡ä»¶é“¾æ¥ï¼šhttps://pan.baidu.com/s/1re9043zu6qq4UuElBAw2sg æå–ç ï¼šgvmx</p> 
<h3><a id="_7"></a>äºŒã€ç³»ç»Ÿåˆå§‹åŒ–</h3> 
<blockquote> 
 <p>æœ¬èŠ‚å„èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ</p> 
</blockquote> 
<h4><a id="1_12"></a>1.è®¾ç½®ç³»ç»Ÿåç§°</h4> 
<p>ä¸‰å°æœåŠ¡å™¨åˆ†åˆ«å« k8s-master01ï¼Œk8s-node01,k8s-master02ã€‚</p> 
<pre><code class="prism language-powershell">hostnamectl  <span class="token function">set-hostname</span>  k8s<span class="token operator">-</span>master01
</code></pre> 
<h4><a id="2hosts_18"></a>2.ä¿®æ”¹hosts</h4> 
<pre><code class="prism language-powershell">vi <span class="token operator">/</span>etc<span class="token operator">/</span>hosts
</code></pre> 
<p>é…ç½®å„èŠ‚ç‚¹æ˜ å°„ï¼Œä»¥åŠflannelä¸‹è½½æ—¶çš„ç½‘ç»œæ˜ å°„ã€‚<br> å¦‚ï¼š</p> 
<pre><code class="prism language-powershell">192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>149<span class="token punctuation">.</span>128 k8s<span class="token operator">-</span>master01
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>149<span class="token punctuation">.</span>129 k8s<span class="token operator">-</span>node01
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>149<span class="token punctuation">.</span>130 k8s<span class="token operator">-</span>node02

199<span class="token punctuation">.</span>232<span class="token punctuation">.</span>68<span class="token punctuation">.</span>133 raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com
</code></pre> 
<h4><a id="3_33"></a>3.å®‰è£…å·¥å…·ä¾èµ–åŒ…</h4> 
<pre><code class="prism language-powershell">yum install <span class="token operator">-</span>y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net<span class="token operator">-</span>tools git
</code></pre> 
<h4><a id="4_38"></a>4.è®¾ç½®é˜²ç«å¢™</h4> 
<p>å…³é—­é˜²ç«å¢™</p> 
<pre><code class="prism language-powershell">systemctl  stop firewalld  &amp;&amp;  systemctl  disable firewalld
</code></pre> 
<p>è®¾ç½®è§„åˆ™ä¸ºç©º</p> 
<pre><code class="prism language-powershell">yum <span class="token operator">-</span>y install iptables<span class="token operator">-</span>services  &amp;&amp;  systemctl  <span class="token function">start</span> iptables  &amp;&amp;  systemctl  enable iptables  &amp;&amp;  iptables <span class="token operator">-</span>F  &amp;&amp;  service iptables save
</code></pre> 
<h4><a id="5_SELINUX_48"></a>5. å…³é—­SELINUX</h4> 
<pre><code class="prism language-powershell">swapoff <span class="token operator">-</span>a &amp;&amp; sed <span class="token operator">-</span>i <span class="token string">'/ swap / s/^\(.*\)$/#\1/g'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>fstab
</code></pre> 
<pre><code class="prism language-powershell">setenforce 0 &amp;&amp; sed <span class="token operator">-</span>i <span class="token string">'s/^SELINUX=.*/SELINUX=disabled/'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>config
</code></pre> 
<h4><a id="6k8s_57"></a>6.è°ƒæ•´k8så†…æ ¸å‚æ•°é…ç½®</h4> 
<p>â‘  ç¼–å†™</p> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> &gt; kubernetes<span class="token punctuation">.</span>conf &lt;&lt;EOF
net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge<span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>iptables=1
net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge<span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>ip6tables=1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>ip_forward=1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>tcp_tw_recycle=0
vm<span class="token punctuation">.</span>swappiness=0 <span class="token comment"># ç¦æ­¢ä½¿ç”¨ swap ç©ºé—´ï¼Œåªæœ‰å½“ç³»ç»Ÿ OOM æ—¶æ‰å…è®¸ä½¿ç”¨å®ƒ</span>
vm<span class="token punctuation">.</span>overcommit_memory=1 <span class="token comment"># ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨</span>
vm<span class="token punctuation">.</span>panic_on_oom=0 <span class="token comment"># å¼€å¯ OOM  </span>
fs<span class="token punctuation">.</span>inotify<span class="token punctuation">.</span>max_user_instances=8192
fs<span class="token punctuation">.</span>inotify<span class="token punctuation">.</span>max_user_watches=1048576
fs<span class="token punctuation">.</span>file<span class="token operator">-</span>max=52706963
fs<span class="token punctuation">.</span>nr_open=52706963
net<span class="token punctuation">.</span>ipv6<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>disable_ipv6=1
net<span class="token punctuation">.</span>netfilter<span class="token punctuation">.</span>nf_conntrack_max=2310720
EOF
</code></pre> 
<p>â‘¡ å¤åˆ¶æ–‡ä»¶</p> 
<pre><code class="prism language-powershell"><span class="token function">cp</span> kubernetes<span class="token punctuation">.</span>conf  <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>d<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>conf
</code></pre> 
<p>â‘¢ ç”Ÿæ•ˆå†…æ ¸å‚æ•°</p> 
<pre><code class="prism language-powershell">sysctl <span class="token operator">-</span>p <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>d<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>conf
</code></pre> 
<h4><a id="7_rsyslogd__systemd_journald_84"></a>7.è®¾ç½® rsyslogd å’Œ systemd journald</h4> 
<p>â‘  åˆ›å»ºæŒä¹…åŒ–ä¿å­˜æ—¥å¿—çš„ç›®å½•</p> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>journal
mkdir <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>journald<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>d
</code></pre> 
<p>â‘¡ å‚æ•°é…ç½®ç¼–å†™</p> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> &gt; <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>journald<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span>99<span class="token operator">-</span>prophet<span class="token punctuation">.</span>conf &lt;&lt;EOF
<span class="token namespace">[Journal]</span>
<span class="token comment"># æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜</span>
Storage=persistent
 
<span class="token comment"># å‹ç¼©å†å²æ—¥å¿—</span>
Compress=yes
 
SyncIntervalSec=5m
RateLimitInterval=30s
RateLimitBurst=1000
 
<span class="token comment"># æœ€å¤§å ç”¨ç©ºé—´ 10G</span>
SystemMaxUse=10G
 
<span class="token comment"># å•æ—¥å¿—æ–‡ä»¶æœ€å¤§ 200M</span>
SystemMaxFileSize=200M
 
<span class="token comment"># æ—¥å¿—ä¿å­˜æ—¶é—´ 2 å‘¨</span>
MaxRetentionSec=2week
 
<span class="token comment"># ä¸å°†æ—¥å¿—è½¬å‘åˆ° syslog</span>
ForwardToSyslog=no
EOF
</code></pre> 
<p>â‘¢ å‚æ•°ç”Ÿæ•ˆ</p> 
<pre><code class="prism language-powershell">systemctl restart systemd<span class="token operator">-</span>journald
</code></pre> 
<h4><a id="8_121"></a>8.å†…æ ¸å‡çº§</h4> 
<p>å‡çº§åŸå› ï¼šCentOS 7.x ç³»ç»Ÿè‡ªå¸¦çš„ 3.10.x å†…æ ¸å­˜åœ¨ä¸€äº› Bugsï¼Œå¯¼è‡´è¿è¡Œçš„ Dockerã€Kubernetes ä¸ç¨³å®šã€‚</p> 
<p>â‘  ä¸‹è½½rpm</p> 
<pre><code class="prism language-powershell">rpm <span class="token operator">-</span>Uvh http:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>elrepo<span class="token punctuation">.</span>org<span class="token operator">/</span>elrepo<span class="token operator">-</span>release<span class="token operator">-</span>7<span class="token punctuation">.</span>0<span class="token operator">-</span>3<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>elrepo<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm
</code></pre> 
<p>â‘¡ å®‰è£…</p> 
<pre><code class="prism language-powershell"><span class="token comment"># å®‰è£…å®Œæˆåæ£€æŸ¥ /boot/grub2/grub.cfg ä¸­å¯¹åº”å†…æ ¸ menuentry ä¸­æ˜¯å¦åŒ…å« initrd16 é…ç½®ï¼Œå¦‚æœæ²¡æœ‰å†å®‰è£…ä¸€æ¬¡ï¼</span>
yum <span class="token operator">--</span>enablerepo=elrepo<span class="token operator">-</span>kernel install <span class="token operator">-</span>y kernel<span class="token operator">-lt</span>
</code></pre> 
<p>â‘¢ è®¾ç½®å†…æ ¸</p> 
<pre><code class="prism language-powershell">grub2<span class="token operator">-</span><span class="token function">set-default</span> <span class="token string">'CentOS Linux (4.4.189-1.el7.elrepo.x86_64) 7 (Core)'</span>
</code></pre> 
<h3><a id="Kubeadm_138"></a>ä¸‰ã€Kubeadméƒ¨ç½²å®‰è£…</h3> 
<blockquote> 
 <p>æœ¬èŠ‚ä¸­1ã€2å’Œ3æ­¥å„èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ</p> 
</blockquote> 
<h4><a id="1_kubeproxyipvs_142"></a>1. kube-proxyå¼€å¯ipvsçš„å‰ç½®æ¡ä»¶</h4> 
<p>æ¨¡å—åŠ è½½</p> 
<pre><code class="prism language-powershell">modprobe br_netfilter
</code></pre> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> &gt; <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>modules<span class="token operator">/</span>ipvs<span class="token punctuation">.</span>modules &lt;&lt;EOF
<span class="token comment">#!/bin/bash</span>
modprobe <span class="token operator">--</span> ip_vs
modprobe <span class="token operator">--</span> ip_vs_rr
modprobe <span class="token operator">--</span> ip_vs_wrr
modprobe <span class="token operator">--</span> ip_vs_sh
modprobe <span class="token operator">--</span> nf_conntrack_ipv4
EOF
</code></pre> 
<p>èµ‹äºˆæƒé™</p> 
<pre><code class="prism language-powershell">chmod 755 <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>modules<span class="token operator">/</span>ipvs<span class="token punctuation">.</span>modules
</code></pre> 
<h4><a id="2docker_161"></a>2.dockerå®‰è£…</h4> 
<pre><code class="prism language-powershell">yum install <span class="token operator">-</span>y yum<span class="token operator">-</span>utils device<span class="token operator">-</span>mapper<span class="token operator">-</span>persistent<span class="token operator">-</span><span class="token keyword">data</span> lvm2

yum<span class="token operator">-</span>config<span class="token operator">-</span>manager \
  <span class="token operator">--</span><span class="token function">add-repo</span> \
  http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token operator">/</span>linux<span class="token operator">/</span>centos<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span>repo

yum update <span class="token operator">-</span>y &amp;&amp;  yum install <span class="token operator">-</span>y docker<span class="token operator">-</span>ce<span class="token operator">-</span>18<span class="token punctuation">.</span>09<span class="token punctuation">.</span>5<span class="token operator">-</span>3<span class="token punctuation">.</span>el7

<span class="token comment">## åˆ›å»º /etc/docker ç›®å½•</span>
mkdir <span class="token operator">/</span>etc<span class="token operator">/</span>docker

<span class="token comment"># é…ç½® daemon</span>
<span class="token function">cat</span> &gt; <span class="token operator">/</span>etc<span class="token operator">/</span>docker<span class="token operator">/</span>daemon<span class="token punctuation">.</span>json &lt;&lt;EOF
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"exec-opts"</span>: <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"log-driver"</span>: <span class="token string">"json-file"</span><span class="token punctuation">,</span>
  <span class="token string">"log-opts"</span>: <span class="token punctuation">{<!-- --></span>
    <span class="token string">"max-size"</span>: <span class="token string">"100m"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
EOF

mkdir <span class="token operator">-</span>p <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>docker<span class="token punctuation">.</span>service<span class="token punctuation">.</span>d

<span class="token comment"># é‡å¯dockeræœåŠ¡</span>
systemctl daemon<span class="token operator">-</span>reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl enable docker
</code></pre> 
<h4><a id="3_Kubeadm_192"></a>3. Kubeadmå®‰è£…ï¼ˆä¸»ä»é…ç½®ï¼‰</h4> 
<ul><li><em>å„ä¸ªæœåŠ¡å™¨éƒ½æ‰§è¡Œä¸‹é¢çš„æ“ä½œã€‚</em></li></ul> 
<blockquote> 
 <p>ç¦»çº¿å®‰è£…dockerçš„é•œåƒ<br> 1.å…ˆä¸‹è½½å¥½å‡†å¤‡çš„æ–‡ä»¶ï¼ˆğŸ‘‡ï¼‰ åè§£å‹ï¼Œè§£å‹æŒ‡ä»¤ï¼štar -zvxf æ–‡ä»¶å<br> æ–‡ä»¶é“¾æ¥ï¼šhttps://pan.baidu.com/s/1re9043zu6qq4UuElBAw2sg æå–ç ï¼šgvmx<br> <br><br> 2.ç¼–å†™å®‰è£…è„šæœ¬<br> vi load-images.sh<br> ==================================================<br> è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š<br> #!/bin/bash<br> ls /root/kubeadm-basic.images &gt; /tmp/images-list.txt<br> cd /root/kubeadm-basic.images<br> for i in $( cat /tmp/images-list.txt )<br> do<br> docker load -i $i<br> done<br> rm -rf /tmp/images-list.txt<br> ==================================================<br> <br><br> 3.èµ‹äºˆæƒé™å¹¶æ‰§è¡Œè„šæœ¬<br> chmod a+x load-images.sh &amp;&amp; ./load-images.sh<br> <br><br> æç¤ºï¼š<br> Â Â Â Â ä¸Šé¢çš„å®‰è£…åŒ…è„šæœ¬ç­‰éƒ½å¯ä»¥é€šè¿‡scpä¼ åˆ°å…¶å®ƒå­èŠ‚ç‚¹æœåŠ¡å™¨ä¸Šã€‚<br> Â Â Â Â å¦‚ï¼šscp -r kubeadm-basic.images load-images.sh root@192.168.149.129:/root/</p> 
</blockquote> 
<hr> 
<p>é…ç½®æº</p> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> &lt;&lt;EOF &gt; <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>repo
<span class="token namespace">[kubernetes]</span>
name=Kubernetes
baseurl=http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>repos<span class="token operator">/</span>kubernetes<span class="token operator">-</span>el7<span class="token operator">-</span>x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>yum<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg 
http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>rpm<span class="token operator">-</span>package<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg
EOF
</code></pre> 
<p>å®‰è£…kubeadmã€kubectlå’Œkubelet</p> 
<pre><code class="prism language-powershell">yum <span class="token operator">-</span>y  install  kubeadm<span class="token operator">-</span>1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>1 kubectl<span class="token operator">-</span>1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>1 kubelet<span class="token operator">-</span>1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>1
</code></pre> 
<p>å¼€æœºè‡ªå¯</p> 
<pre><code class="prism language-powershell">systemctl enable kubelet<span class="token punctuation">.</span>service
</code></pre> 
<h4><a id="4_244"></a>4.åˆå§‹åŒ–ä¸»èŠ‚ç‚¹</h4> 
<p>ç”Ÿæˆé…ç½®æ–‡ä»¶</p> 
<pre><code class="prism language-powershell">kubeadm config print init<span class="token operator">-</span>defaults &gt; kubeadm<span class="token operator">-</span>config<span class="token punctuation">.</span>yaml
</code></pre> 
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶<br> vi kubeadm-config.yaml</p> 
<blockquote> 
 <p>ä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p> 
 <ul><li>ç¬¬12è¡Œé…ç½®ä¸»èŠ‚ç‚¹IPåœ°å€</li><li>ç¬¬34è¡Œä¿®æ”¹ç‰ˆæœ¬ä¸º v.1.15.1</li><li>ç¬¬37è¡Œæ–°å¢ podSubnet: â€œ10.244.0.0/16â€</li><li>å¹¶åœ¨å°¾æœ«åŠ å…¥ä¸‹æ–¹é…ç½®ï¼š</li></ul> 
</blockquote> 
<pre><code class="prism language-powershell">apiVersion: kubeproxy<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">/</span>v1alpha1
    kind: KubeProxyConfiguration
    featureGates:
      SupportIPVSProxyMode: true
    mode: ipvs
</code></pre> 
<p>å…·ä½“å‚è€ƒä¸‹å›¾ï¼š<br> <img src="https://images2.imgbox.com/68/50/mEDJcHfZ_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> æ‰§è¡Œ</p> 
<pre><code class="prism language-powershell">kubeadm init <span class="token operator">--</span>config=kubeadm<span class="token operator">-</span>config<span class="token punctuation">.</span>yaml <span class="token operator">--</span>experimental<span class="token operator">-</span>upload<span class="token operator">-</span>certs <span class="token punctuation">|</span> <span class="token function">tee</span> kubeadm<span class="token operator">-</span>init<span class="token punctuation">.</span>log
</code></pre> 
<p>æŸ¥çœ‹æ—¥å¿—</p> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> kubeadm<span class="token operator">-</span>init<span class="token punctuation">.</span>log
</code></pre> 
<p><img src="https://images2.imgbox.com/78/ce/mDAdv9Ju_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> æ ¹æ®æ—¥å¿—æç¤ºéœ€è¦æˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">-</span>p <span class="token variable">$HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube
sudo <span class="token function">cp</span> <span class="token operator">-</span>i <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>admin<span class="token punctuation">.</span>conf <span class="token variable">$HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube<span class="token operator">/</span>config
sudo chown $<span class="token punctuation">(</span>id <span class="token operator">-</span>u<span class="token punctuation">)</span>:$<span class="token punctuation">(</span>id <span class="token operator">-</span>g<span class="token punctuation">)</span> <span class="token variable">$HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube<span class="token operator">/</span>config
</code></pre> 
<p>æ•´ç†ä¸‹é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºæ–‡ä»¶å¤¹</p> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">-</span>p <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>install<span class="token operator">-</span>k8s<span class="token operator">/</span>core &amp;&amp; mkdir <span class="token operator">-</span>p <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>install<span class="token operator">-</span>k8s<span class="token operator">/</span>plugin<span class="token operator">/</span>flannel
</code></pre> 
<p>ç§»åŠ¨é…ç½®æ–‡ä»¶åˆ°coreä¸‹</p> 
<pre><code class="prism language-powershell"><span class="token function">mv</span> kubeadm<span class="token operator">-</span>init<span class="token punctuation">.</span>log kubeadm<span class="token operator">-</span>config<span class="token punctuation">.</span>yaml <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>install<span class="token operator">-</span>k8s<span class="token operator">/</span>core
</code></pre> 
<p>ç”Ÿæˆä¸å¤±æ•ˆçš„token</p> 
<pre><code class="prism language-powershell">kubeadm token create <span class="token operator">--</span>ttl 0 <span class="token operator">--</span>print<span class="token operator">-</span><span class="token function">join-command</span>
</code></pre> 
<h4><a id="5__300"></a>5. ç½‘ç»œéƒ¨ç½²</h4> 
<p>è¿›å…¥ç›®å½•</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>install<span class="token operator">-</span>k8s<span class="token operator">/</span>plugin<span class="token operator">/</span>flannel
</code></pre> 
<p>ä¸‹è½½kube-flannel.yml</p> 
<pre><code class="prism language-powershell">wget https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>coreos<span class="token operator">/</span>flannel<span class="token operator">/</span>master<span class="token operator">/</span>Documentation<span class="token operator">/</span>kube<span class="token operator">-</span>flannel<span class="token punctuation">.</span>yml
</code></pre> 
<p>æ³¨æ„ï¼Œå¦‚æœæç¤ºä¸‹è½½å¤±è´¥ï¼Œè¯·é…ç½®hostsï¼š</p> 
<pre><code class="prism language-powershell">sudo vi <span class="token operator">/</span>etc<span class="token operator">/</span>hosts

<span class="token comment"># æ–°å¢ä¸‹ğŸ‘‡</span>
199<span class="token punctuation">.</span>232<span class="token punctuation">.</span>68<span class="token punctuation">.</span>133 raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com
</code></pre> 
<hr> 
<p>åˆ›å»º flannel</p> 
<pre><code class="prism language-powershell">kubectl create <span class="token operator">-</span>f kube<span class="token operator">-</span>flannel<span class="token punctuation">.</span>yml
</code></pre> 
<p>æŸ¥çœ‹ç»„ä»¶</p> 
<pre><code class="prism language-powershell">kubectl get pod <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token operator">-</span>o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/12/e0/ZbPJ4bAP_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> æ³¨æ„ï¼šå¦‚æœå®‰è£…äº†flannelä½†æ˜¯çŠ¶æ€ä¸€ç›´æ˜¯Init:0/1ï¼Œé‚£ä¹ˆå¯ä»¥åˆ é™¤æ‰è¿™ä¸ªpodï¼Œä¼šé‡æ–°å®‰è£…ä¸€ä¸ªï¼ŒçŠ¶æ€è¿‡ä¸€ä¼šå°±æˆäº†Runningï¼ŒèŠ‚ç‚¹çŠ¶æ€ä¹Ÿæˆäº†Readyã€‚<br> åˆ é™¤podï¼š</p> 
<pre><code class="prism language-powershell">kubectl delete pod kube<span class="token operator">-</span>flannel<span class="token operator">-</span>ds<span class="token operator">-</span>dbvxm <span class="token operator">-</span>n kube<span class="token operator">-</span>system
</code></pre> 
<p><img src="https://images2.imgbox.com/2c/cc/WmMsBqk4_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h4><a id="6__339"></a>6. å­èŠ‚ç‚¹åŠ å…¥</h4> 
<p>æ¥ä¸‹æ¥å°±æ˜¯è®©å¦å¤–çš„å­èŠ‚ç‚¹åŠ å…¥åˆ°ä¸»èŠ‚ç‚¹ã€‚å‘½ä»¤åœ¨initçš„logä¸­ã€‚</p> 
<pre><code class="prism language-powershell">cd <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>core<span class="token operator">/</span> &amp;&amp; vi kubeadm<span class="token operator">-</span>init<span class="token punctuation">.</span>log
</code></pre> 
<p>è¿›å…¥æ—¥å¿—åçš„æœ€åä¸€è¡Œã€‚<br> <img src="https://images2.imgbox.com/6a/b5/CoN93avX_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> åœ¨å­èŠ‚ç‚¹æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼ŒåŠ å…¥ä¸»èŠ‚ç‚¹çš„å‘½ä»¤<br> <img src="https://images2.imgbox.com/bd/4a/mzX4yO6q_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> å›åˆ°ä¸»èŠ‚ç‚¹æœåŠ¡å™¨æŸ¥çœ‹èŠ‚ç‚¹çŠ¶å†µ</p> 
<pre><code class="prism language-powershell">kubectl get node
</code></pre> 
<p><img src="https://images2.imgbox.com/45/72/DqPGDhxY_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> ç°åœ¨ä¸¤ä¸ªèŠ‚ç‚¹éƒ½æ˜¯NotReadyï¼Œå¯ä»¥æŸ¥çœ‹podçš„ç½‘ç»œæ˜¯å¦å‡†å¤‡å¥½äº†</p> 
<pre><code class="prism language-powershell">kubectl get pod <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token operator">-</span>o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/69/6a/SoFYFWVE_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> è¿‡ä¸€ä¼špodçš„çŠ¶æ€ä¼šä»Initå˜æˆRunningï¼Œå‘ç°é›†ç¾¤çŠ¶æ€ä¹Ÿæ­£å¸¸äº†,å¦‚æœä¸€ç›´ä¸å˜ï¼Œå°±deleteï¼Œä¼šè‡ªå¸¦é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„podã€‚<br> <img src="https://images2.imgbox.com/06/f1/dJ6ZuTuD_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h3><a id="_364"></a>å››ã€é…ç½®ç§æœ‰ä»“åº“</h3> 
<blockquote> 
 <p>åˆ›å»ºç¬¬å››å°æœåŠ¡å™¨ï¼Œå¹¶å®‰è£…dockerã€‚</p> 
</blockquote> 
<h4><a id="1_367"></a>1.å‡†å¤‡å·¥ä½œ</h4> 
<p>â‘  ä¿®æ”¹dokerçš„/etc/docker/daemon.jsonæ–‡ä»¶<br> æ–°å¢(ç›¸å½“äºå¿½ç•¥è¿™ä¸ªurlï¼Œæ”¾è¡Œï¼Œurléšä½ æ€ä¹ˆå†™ï¼Œæ³¨æ„ç”¨","åˆ†éš”)<br> å¦‚ï¼š</p> 
<pre><code class="prism language-powershell"><span class="token string">"insecure-registries"</span>: <span class="token punctuation">[</span><span class="token string">"www.hub.elwin.com"</span><span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/09/b7/GvjdJiKd_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>â‘¡ å®‰è£…lrzsz</p> 
<pre><code class="prism language-powershell">yum <span class="token operator">-</span>y install lrzsz
</code></pre> 
<p>â‘¢ å°†å‡†å¤‡çš„docker-composeæ–‡ä»¶ä¸Šä¼ è‡³æœåŠ¡å™¨çš„/usr/local/binä¸‹<br> ç„¶åèµ‹äºˆæƒé™ï¼š</p> 
<pre><code class="prism language-powershell">chmod a<span class="token operator">+</span>x <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>docker<span class="token operator">-</span>compose
</code></pre> 
<p>â‘£ ä¸Šä¼ harbor-offline-installer-v1.2.0.tgzæ–‡ä»¶åˆ°/usr/local/ç›®å½•ä¸‹å¹¶è§£å‹</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span> &amp;&amp; tar <span class="token operator">-</span>zxvf harbor<span class="token operator">-</span>offline<span class="token operator">-</span>installer<span class="token operator">-</span>v1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>tgz
</code></pre> 
<p>â‘¤ ä¿®æ”¹è§£å‹ç›®å½•harborä¸‹çš„harbor.cfg</p> 
<blockquote> 
 <p>ç¬¬5è¡Œï¼šä¿®æ”¹åˆšåˆšdaemon.jsonçš„urlï¼ˆå…·ä½“çœ‹ç¬¬ä¸€æ­¥ï¼‰<br> ç¬¬9è¡Œï¼šæ”¹æˆhttps ä¹Ÿæ˜¯æ ¹æ®daemon.jsonçš„urlé…ç½®æ¥çš„<br><br> å¦‚å›¾ï¼š<br> <img src="https://images2.imgbox.com/21/aa/Ma4LDozQ_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
</blockquote> 
<h4><a id="2_399"></a>2.è¯ä¹¦åˆ›å»º</h4> 
<p>â‘  åˆ›å»ºè¯ä¹¦ç›®å½•ï¼Œå¹¶è¿›å…¥ç›®å½•</p> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>cert<span class="token operator">/</span> &amp;&amp; cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>cert
</code></pre> 
<p>â‘¡ åˆ›å»ºè¯ä¹¦</p> 
<pre><code class="prism language-powershell">openssl genrsa <span class="token operator">-</span>des3 <span class="token operator">-</span>out server<span class="token punctuation">.</span>key 2048
</code></pre> 
<p>ç”Ÿæˆç§é’¥å¹¶è®¾ç½®å¯†ç ï¼Œå¦‚è‹¥ç”Ÿé”™ï¼Œè¯·åˆ é™¤é‡æ¥</p> 
<p>â‘¢ åˆ›å»ºè¯ä¹¦è¯·æ±‚ï¼Œå¯†ç è¾“å…¥åˆšåˆšç”Ÿæˆçš„ç§é’¥å¯†ç ï¼Œä»¥åŠå„ä¸ªä¿¡æ¯</p> 
<pre><code class="prism language-powershell">openssl req <span class="token operator">-</span>new <span class="token operator">-</span>key server<span class="token punctuation">.</span>key <span class="token operator">-</span>out server<span class="token punctuation">.</span>csr
</code></pre> 
<p>å¦‚å›¾ï¼š<br> <img src="https://images2.imgbox.com/00/67/hOs32XAN_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> â‘£ å¤‡ä»½ç§é’¥</p> 
<pre><code class="prism language-powershell"><span class="token function">cp</span> server<span class="token punctuation">.</span>key server<span class="token punctuation">.</span>key<span class="token punctuation">.</span>org
</code></pre> 
<p>â‘¤ é€€å‡ºç§é’¥å¯†ç ï¼Œè¾“å…¥å¯†ç </p> 
<pre><code class="prism language-powershell">openssl rsa <span class="token operator">-in</span> server<span class="token punctuation">.</span>key<span class="token punctuation">.</span>org <span class="token operator">-</span>out server<span class="token punctuation">.</span>key
</code></pre> 
<p><img src="https://images2.imgbox.com/5e/8f/LiMvucb0_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>â‘¥ ç­¾å</p> 
<pre><code class="prism language-powershell">openssl x509 <span class="token operator">-</span>req <span class="token operator">-</span>days 365 <span class="token operator">-in</span> server<span class="token punctuation">.</span>csr <span class="token operator">-</span>signkey server<span class="token punctuation">.</span>key <span class="token operator">-</span>out server<span class="token punctuation">.</span>crt
</code></pre> 
<p>â‘¦ èµ‹äºˆæƒé™</p> 
<pre><code class="prism language-powershell">chmod a<span class="token operator">+</span>x <span class="token operator">*</span>
</code></pre> 
<h4><a id="3_442"></a>3.å®‰è£…</h4> 
<p>â‘  å›åˆ°harborç›®å½•</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>harbor<span class="token operator">/</span> 
</code></pre> 
<p>â‘¡ ä¿®æ”¹æ‰€æœ‰æœåŠ¡å™¨(æ‰€æœ‰èŠ‚ç‚¹ä»¥åŠhubè¿™å°)çš„hosts</p> 
<pre><code class="prism language-powershell">vi <span class="token operator">/</span>etc<span class="token operator">/</span>hosts
</code></pre> 
<p>å¦‚<br> <img src="https://images2.imgbox.com/2d/93/zMz2wRK3_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>â‘¢ å®‰è£…å¯åŠ¨</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">.</span><span class="token operator">/</span>install<span class="token punctuation">.</span>sh
</code></pre> 
<p><img src="https://images2.imgbox.com/35/7f/ZVtgIjhs_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h3><a id="k8s_463"></a>äº”ã€k8sç®€å•ä½¿ç”¨</h3> 
<h4><a id="1pod_464"></a>1.åˆ›å»ºpod</h4> 
<blockquote> 
 <p>æ ¼å¼ï¼škubectl run podå --image==dockeré•œåƒ --port=80 --replicas=å‰¯æœ¬æ•°ï¼ˆå¥‡æ•°ä¸ªï¼‰</p> 
</blockquote> 
<p>å¦‚ï¼š</p> 
<pre><code class="prism language-powershell">kubectl run nginx<span class="token operator">-</span>demo <span class="token operator">--</span>image==hub<span class="token punctuation">.</span>elwin<span class="token punctuation">.</span>com<span class="token operator">/</span>library<span class="token operator">/</span>myapp:v1 <span class="token operator">--</span>port=80 <span class="token operator">--</span>replicas=1
</code></pre> 
<h4><a id="2rs_472"></a>2.æŸ¥çœ‹rs</h4> 
<pre><code class="prism language-powershell">kubectl get rs
</code></pre> 
<h4><a id="3pod_478"></a>3.æŸ¥çœ‹pod</h4> 
<pre><code class="prism language-powershell">kubectl get pod <span class="token operator">-</span>o wide

kubectl get po <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token operator">-</span>o wide
</code></pre> 
<h4><a id="4pod_486"></a>4.åˆ é™¤pod</h4> 
<pre><code class="prism language-powershell"> kubectl delete pod podå
</code></pre> 
<h4><a id="5_491"></a>5.ä¿®æ”¹å‰¯æœ¬æ•°</h4> 
<pre><code class="prism language-powershell">kubectl scale <span class="token operator">--</span>replicas=3 deployment<span class="token operator">/</span>myapp
</code></pre> 
<h4><a id="6pod_497"></a>6.podè´Ÿè½½å‡è¡¡</h4> 
<p>å½“æœ‰å¤šä¸ªå‰¯æœ¬æä¾›æœåŠ¡æ—¶ï¼Œk8sæä¾›äº†ç»Ÿä¸€ä¸€ä¸ªipæ¥è¿›è¡Œè‡ªåŠ¨è´Ÿè½½å‡è¡¡ã€‚</p> 
<pre><code class="prism language-powershell"> kubectl expose deployment myapp <span class="token operator">--</span>port=30000 <span class="token operator">--</span>target<span class="token operator">-</span>port=80
</code></pre> 
<h4><a id="7svc_504"></a>7.è·å–svc</h4> 
<pre><code class="prism language-powershell"> kubectl get svc
</code></pre> 
<p><img src="https://images2.imgbox.com/52/47/SRk52Q7y_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h4><a id="8_511"></a>8.å¯¹å¤–æä¾›è®¿é—®</h4> 
<p>æ ¹æ®è·å–çš„svcåè¿›è¡Œå¯¹åº”çš„ä¿®æ”¹</p> 
<pre><code class="prism language-powershell">kubectl edit svc myapp
</code></pre> 
<p>ä¿®æ”¹typeä¸ºNodePort<br> <img src="https://images2.imgbox.com/84/43/C6uOgPhZ_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/1e/44/zfqYQlN8_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> å¤–éƒ¨å¯ä»¥é€šè¿‡å½“å‰æœåŠ¡å™¨ip+æ˜ å°„ç«¯å£è®¿é—®ï¼Œå¦‚ä¸Šå›¾å°±æ˜¯http://192.168.149.128:30764/</p> 
<h3><a id="pods_520"></a>å…­ã€pods</h3> 
<h4><a id="1pod_521"></a>1.podåŸºæœ¬æ¦‚å¿µ</h4> 
<ul><li>å¯ä»¥åˆ›å»ºå’Œç®¡ç†çš„æœ€å…ˆå•å…ƒ</li><li>åŒ…å«å¤šä¸ªå®¹å™¨ï¼Œå³åœ¨ä¸€ä¸ªpodä¸­å¯ä»¥å®‰è£…å¤šä¸ªdockerå®¹å™¨</li><li>podä¸­å®¹å™¨ä¸å®¹å™¨ä¹‹é—´ç½‘ç»œæ˜¯äº’é€šçš„</li><li>ç”Ÿå‘½å‘¨æœŸçŸ­æš‚æ¯”å¦‚ï¼Œå½“ Pod æ‰€åœ¨èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹ä¸Šçš„ Pod<br> ä¼šè¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¢«é‡æ–°è°ƒåº¦çš„ Pod æ˜¯ä¸€ä¸ªå…¨æ–°çš„ Pod,è·Ÿä¹‹å‰çš„<br> Pod æ²¡æœ‰åŠæ¯›é’±å…³ç³»</li></ul> 
<h4><a id="2pod_530"></a>2.podçš„å®ç°æœºåˆ¶</h4> 
<blockquote> 
 <p>æ¯ä¸ª Pod ä¸­æœ‰ä¸€ä¸ª Pause å®¹å™¨ä¿å­˜æ‰€æœ‰çš„å®¹å™¨çŠ¶æ€ã€‚é€šè¿‡ç®¡ç† pause å®¹å™¨ï¼Œè¾¾åˆ°ç®¡ç† pod ä¸­æ‰€æœ‰å®¹å™¨çš„æ•ˆæœã€‚</p> 
</blockquote> 
<p>å…±äº«ç½‘ç»œï¼š<br> Â Â Â Â Â Â å¤šä¸ªå®¹å™¨å…±äº«åŒä¸€ network namespaceï¼Œç”±æ­¤åœ¨ä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨å…±äº« Pod çš„ IP å’Œç«¯å£ namespaceï¼Œæ‰€ä»¥ä¸€ä¸ª Pod å†…çš„å¤šä¸ªå®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡ localhost æ¥è¿›è¡Œé€šä¿¡,ä½†éœ€è¦æ³¨æ„çš„æ˜¯å®¹å™¨é—´çš„ç«¯å£ä¸è¦å†²çªã€‚</p> 
<p>å…±äº«å­˜å‚¨ï¼š<br> Â Â Â Â Â Â å®¹å™¨é—´å­˜å‚¨æ˜¯å…±äº«çš„ï¼Œä½¿ç”¨æ•°æ®å·è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚</p> 
<h4><a id="3__540"></a>3. é•œåƒæ‹‰å–</h4> 
<p>podé‡Œæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŒ‡å®šè¦æ‹‰å–çš„é•œåƒã€‚</p> 
<blockquote> 
 <p>æ‹‰å–ç­–ç•¥</p> 
 <ul><li>IfNotPresent: é»˜è®¤å€¼ã€‚é•œåƒåœ¨å®¿ä¸»æœºä¸Šä¸å­˜åœ¨æ—¶æ‹‰å–ï¼Œä½†:latestæ ‡ç­¾çš„é•œåƒé»˜è®¤ä¸ºAlways</li><li>Always: æ¯æ¬¡åˆ›å»ºéƒ½ä¼šå»æ‹‰å–é•œåƒ</li><li>Nerver: æ°¸è¿œä¸ä¸»åŠ¨æ‹‰å–è¿™ä¸ªé•œåƒ</li></ul> 
</blockquote> 
<table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>spec.containers[].image</td><td>é•œåƒæ‹‰å–åœ°å€ä»¥åŠç‰ˆæœ¬</td></tr><tr><td>spec.containers[].name</td><td>å®¹å™¨åç§°</td></tr><tr><td>spec.containers[].imagePullPolicy</td><td>æ‹‰å–ç­–ç•¥</td></tr></tbody></table> 
<p>å¦‚ï¼š</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Deployment
metadata:
  name: web
spec:
  containers:
    <span class="token operator">-</span> image: nginx
      name: nginx
      imagePullPolicy: IfNotPresent
</code></pre> 
<h4><a id="4pod_568"></a>4.podèµ„æºé™åˆ¶</h4> 
<p>podè®¾ç½®å¯ä»¥å°†è¯·æ±‚è°ƒåº¦åˆ°èµ„æºå……è¶³çš„Nodeä¸Šï¼Œlimitè®¾ç½®ä¸Šé™ã€‚</p> 
<table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>spec.containers[].resources.requests.cpu</td><td>è°ƒåº¦è¯·æ±‚çš„CPUï¼Œå¯ä»¥è¶…è¿‡</td></tr><tr><td>spec.containers[].resources.requests.memory</td><td>è°ƒåº¦è¯·æ±‚çš„å†…å­˜ï¼Œå¯ä»¥è¶…è¿‡ï¼›ä½†å¦‚æœè¶…è¿‡ï¼Œå®¹å™¨å¯èƒ½ä¼šåœ¨Nodeå†…å­˜ä¸è¶³æ—¶æ¸…ç†</td></tr><tr><td>spec.containers[].resources.limits.cpu</td><td>CPUä¸Šé™ï¼Œå¯ä»¥çŸ­æš‚è¶…è¿‡ï¼Œå®¹å™¨ä¹Ÿä¸ä¼šè¢«åœæ­¢</td></tr><tr><td>spec.containers[].resources.limits.memory</td><td>å†…å­˜ä¸Šé™ï¼Œä¸å¯ä»¥è¶…è¿‡ï¼›å¦‚æœè¶…è¿‡ï¼Œå®¹å™¨å¯èƒ½ä¼šè¢«åœæ­¢æˆ–è°ƒåº¦åˆ°å…¶ä»–èµ„æºå……è¶³çš„æœºå™¨ä¸Š</td></tr></tbody></table> 
<p>å¦‚ï¼š</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Deployment
metadata:
  name: web
spec:
  containers:
    <span class="token operator">-</span> image: nginx
      name: nginx
      resources:
        requests:
          cpu: <span class="token string">"300m"</span>
          memory: <span class="token string">"56Mi"</span>
        limits:
          cpu: <span class="token string">"500m"</span>
          memory: <span class="token string">"128Mi"</span>
</code></pre> 
<h4><a id="5_595"></a>5.é‡å¯ç­–ç•¥</h4> 
<p>æ­¤å¤„é‡å¯æ˜¯æŒ‡åœ¨Podæ‰€åœ¨Nodeä¸Šé¢æœ¬åœ°é‡å¯ï¼Œå¹¶ä¸ä¼šè°ƒåº¦åˆ°å…¶ä»–Nodeä¸Šå»ã€‚</p> 
<blockquote> 
 <p>RestartPolicy</p> 
 <ul><li>Alwaysï¼šåªè¦é€€å‡ºå°±é‡å¯,é»˜è®¤ç­–ç•¥</li><li>OnFailureï¼šå¤±è´¥é€€å‡ºï¼ˆexit codeä¸ç­‰äº0ï¼‰æ—¶é‡å¯</li><li>Neverï¼šåªè¦é€€å‡ºå°±ä¸å†é‡å¯</li></ul> 
</blockquote> 
<table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>spec.restartPolicy</td><td>é‡å¯ç­–ç•¥</td></tr></tbody></table> 
<p>å¦‚ï¼š</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Deployment
metadata:
  name: web
spec:
  restartPolicy: Always
</code></pre> 
<h4><a id="6_616"></a>6.è°ƒåº¦ç­–ç•¥</h4> 
<blockquote> 
 <p>èµ„æºè®¾ç½®å¯ä»¥å½±å“podè°ƒåº¦ï¼Œè¯¦ç»†è¯·çœ‹ä¸Šé¢çš„ç¬¬6.4èŠ‚ã€‚ æœ¬æ¬¡ä¸»è¦è¯´æ˜ èŠ‚ç‚¹é€‰æ‹©å™¨ å½±å“podè°ƒåº¦ã€‚</p> 
</blockquote> 
<p>æœ‰æ—¶å€™æˆ‘ä»¬æƒ³è®©æŸäº›æœåŠ¡éƒ¨ç½²åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨å®ç°ã€‚<br> é¦–å…ˆæŒ‡å®šnodeèŠ‚ç‚¹æ ‡ç­¾ï¼Œå¦‚ï¼šå«node1å«devï¼Œå«node2å«testã€‚å¦‚æœè¯´nodeèŠ‚ç‚¹æ ‡ç­¾å·²ç»èµ·åå­—äº†ï¼Œå°±å†åŠ ä¸ªâ€“overwrite</p> 
<pre><code class="prism language-powershell">kubectl label nodes &lt;èŠ‚ç‚¹å&gt; disktype=&lt;æ ‡ç­¾å&gt; <span class="token punctuation">[</span><span class="token operator">--</span>overwrite<span class="token punctuation">]</span>
</code></pre> 
<p>å†æŒ‡å®šyamlçš„èŠ‚ç‚¹é€‰æ‹©å™¨ï¼Œåªè®©è¯¥podåœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šç”Ÿæˆã€‚</p> 
<table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>spec.nodeSelector.disktype</td><td>èŠ‚ç‚¹é€‰æ‹©</td></tr></tbody></table> 
<p>å¦‚ï¼š</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Deployment
metadata:
  name: web
spec:
  nodeSelector:
    disktype: dev
</code></pre> 
<h4><a id="7yaml_643"></a>7.å¿«é€Ÿç”Ÿæˆæ¨¡æ¿yamlæ–‡ä»¶</h4> 
<pre><code class="prism language-powershell">kubectl create deployment web <span class="token operator">--</span>image=nginx <span class="token operator">-</span>o yaml <span class="token operator">--</span>dry<span class="token operator">-</span>run &gt;my<span class="token punctuation">.</span>yaml
</code></pre> 
<h4><a id="8podyaml_647"></a>8.å°†å·²ç»ç”Ÿæˆçš„podè½¬å­˜yaml</h4> 
<pre><code class="prism language-powershell">kubectl get deployment myapp <span class="token operator">-</span>o=yaml <span class="token operator">--</span>export &gt;myapp<span class="token punctuation">.</span>yaml
</code></pre> 
<h4><a id="9yamlpod_654"></a>9.æ ¹æ®yamlæ–‡ä»¶åˆ›å»ºpod</h4> 
<pre><code class="prism language-powershell">kubectl create <span class="token operator">-</span>f myapp<span class="token punctuation">.</span>yaml
</code></pre> 
<h3><a id="controller_659"></a>ä¸ƒã€controller</h3> 
<h4><a id="1_660"></a>1.ç®€å•ä»‹ç»</h4> 
<p>ç®¡ç†å’Œè¿è¡Œå®¹å™¨çš„å¯¹è±¡ã€‚Kubernetes é€šè¿‡å„ç§ Controller æ¥ç®¡ç† Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚ä¸ºäº†æ»¡è¶³ä¸åŒä¸šåŠ¡åœºæ™¯ï¼ŒKubernetes å¼€å‘äº† Deploymentã€ReplicaSetã€DaemonSetã€StatefuleSetã€Job ç­‰å¤šç§ Controller</p> 
<h4><a id="2_Deployment_663"></a>2. Deployment</h4> 
<h3><a id="_665"></a>å…«ã€å®‰è£…æ—¶é‡åˆ°çš„é—®é¢˜</h3> 
<h4><a id="1_666"></a>1.å­èŠ‚ç‚¹åŠ å…¥ä¸»èŠ‚ç‚¹çš„æ—¶å€™åŠ å…¥ä¸è¿›å»</h4> 
<p>æŠ¥é”™ï¼šerror execution phase preflight: unable to fetch the kubeadm-config ConfigMap<br> è§£å†³æ–¹æ¡ˆï¼šå› ä¸ºä¸»èŠ‚ç‚¹çš„tokenè¿‡æœŸäº†ï¼Œé‡æ–°ç”Ÿæˆä¸è¿‡æœŸçš„tokenï¼Œç”¨æ–°çš„tokenåŠ å…¥å³å¯ã€‚<br> ç”Ÿæˆå‘½ä»¤ï¼š</p> 
<pre><code class="prism language-powershell">kubeadm token create <span class="token operator">--</span>ttl 0 <span class="token operator">--</span>print<span class="token operator">-</span><span class="token function">join-command</span>
</code></pre> 
<h4><a id="2_kubeflannelInit01_675"></a>2. kube-flannelä¸€ç›´Init:0/1</h4> 
<p>æ˜¾ç¤ºï¼škube-flannel-ds-gpf6l 0/1 Init:0/1<br> è§£å†³æ–¹æ¡ˆï¼šåˆ é™¤è¯¥podï¼Œè‡ªåŠ¨é‡æ–°ç”Ÿæˆã€‚æˆ–è€…ç»§ç»­ç­‰å¾…<br> åˆ é™¤å‘½ä»¤ï¼š</p> 
<pre><code class="prism language-powershell">kubectl delete pod kube<span class="token operator">-</span>flannel<span class="token operator">-</span>ds<span class="token operator">-</span>xxxx <span class="token operator">-</span>n kube<span class="token operator">-</span>system
</code></pre> 
<h4><a id="3_kubeflannelyml_683"></a>3. kube-flannel.ymlæ–‡ä»¶ä¸‹è½½ä¸ä¸‹æ¥</h4> 
<p>æŠ¥é”™ï¼š==============è¿æ¥å¤±è´¥<br> è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹hostsæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶æœ«å°¾å¤„æ–°å¢ä¸€è¡Œæ·»åŠ ï¼š<em>199.232.68.133 raw.githubusercontent.com</em> ï¼Œåé‡æ–°å°è¯•ä¸‹è½½ã€‚<br> æŒ‡ä»¤ï¼š<br> â‘  ä¿®æ”¹</p> 
<pre><code class="prism language-powershell">vi <span class="token operator">/</span>etc<span class="token operator">/</span>hosts
</code></pre> 
<p>â‘¡ ä¸‹è½½</p> 
<pre><code class="prism language-powershell">wget https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>coreos<span class="token operator">/</span>flannel<span class="token operator">/</span>master<span class="token operator">/</span>Documentation<span class="token operator">/</span>kube<span class="token operator">-</span>flannel<span class="token punctuation">.</span>yml
</code></pre> 
<h4><a id="4k8s_696"></a>4.å®‰è£…k8sæŠ¥é”™</h4> 
<p>æŠ¥é”™ï¼š[ERROR NumCPU]: the number of available CPUs 1 is less than the required 2 [<br> <img src="https://images2.imgbox.com/9b/af/crSvAj9k_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°">è§£å†³æ–¹æ¡ˆï¼šå› ä¸ºk8sæœ€ä½2æ ¸ï¼Œæ‰€ä»¥è¦å°†æœåŠ¡å™¨å†…æ ¸æ•°è°ƒæ•´è‡³2æ ¸ä»¥ä¸Šã€‚<br> <img src="https://images2.imgbox.com/88/07/ZiNKUksz_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h4><a id="5svcpod_700"></a>5.svcè®¿é—®å…¶ä»–èŠ‚ç‚¹podä¸é€š</h4> 
<p>å…ˆçœ‹çœ‹å„ä¸ªèŠ‚ç‚¹é˜²ç«å¢™æ˜¯ä¸æ˜¯å…³çš„ã€‚<br> å‚è€ƒåœ°å€ï¼šhttps://www.bianchengquan.com/article/409663.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cb986aa14fdecf278f77ce3f6eb709f9/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">æ±‡ç¼–è¯­è¨€ï¼šå°†AXä¸­çš„æ•°ä»¥æ— ç¬¦å·åè¿›åˆ¶å½¢å¼è¾“å‡ºæ˜¾ç¤ºã€‚</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80292d14072b18160de2713e9a712472/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">å¸¦ä½ äº†è§£vueçš„$refså’Œrefï¼ˆé™„å¸¦å¸¸è§é—®é¢˜ï¼‰</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 èœé¸Ÿç¨‹åºå‘˜åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>