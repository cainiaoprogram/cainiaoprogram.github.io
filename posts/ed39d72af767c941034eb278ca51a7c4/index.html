<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>百万级数据excel导出功能如何实现？ - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="百万级数据excel导出功能如何实现？" />
<meta property="og:description" content="前言 最近我做过一个MySQL百万级别数据的excel导出功能，已经正常上线使用了。
这个功能挺有意思的，里面需要注意的细节还真不少，现在拿出来跟大家分享一下，希望对你会有所帮助。
原始需求：用户在UI界面上点击全部导出按钮，就能导出所有商品数据。
咋一看，这个需求挺简单的。
但如果我告诉你，导出的记录条数，可能有一百多万，甚至两百万呢？
这时你可能会倒吸一口气。
因为你可能会面临如下问题：
如果同步导数据，接口很容易超时。如果把所有数据一次性装载到内存，很容易引起OOM。数据量太大sql语句必定很慢。相同商品编号的数据要放到一起。如果走异步，如何通知用户导出结果？如果excel文件太大，目标用户打不开怎么办？ 我们要如何才能解决这些问题，实现一个百万级别的excel数据快速导出功能呢？
1.异步处理 做一个MySQL百万数据级别的excel导出功能，如果走接口同步导出，该接口肯定会非常容易超时。
因此，我们在做系统设计的时候，第一选择应该是接口走异步处理。
说起异步处理，其实有很多种，比如：使用开启一个线程，或者使用线程池，或者使用job，或者使用mq等。
为了防止服务重启时数据的丢失问题，我们大多数情况下，会使用job或者mq来实现异步功能。
1.1 使用job 如果使用job的话，需要增加一张执行任务表，记录每次的导出任务。
用户点击全部导出按钮，会调用一个后端接口，该接口会向表中写入一条记录，该记录的状态为：待执行。
有个job，每隔一段时间（比如：5分钟），扫描一次执行任务表，查出所有状态是待执行的记录。
然后遍历这些记录，挨个执行。
需要注意的是：如果用job的话，要避免重复执行的情况。比如job每隔5分钟执行一次，但如果数据导出的功能所花费的时间超过了5分钟，在一个job周期内执行不完，就会被下一个job执行周期执行。
所以使用job时可能会出现重复执行的情况。
为了防止job重复执行的情况，该执行任务需要增加一个执行中的状态。
具体的状态变化如下：
执行任务被刚记录到执行任务表，是待执行状态。当job第一次执行该执行任务时，该记录再数据库中的状态改为：执行中。当job跑完了，该记录的状态变成：完成或失败。 这样导出数据的功能，在第一个job周期内执行不完，在第二次job执行时，查询待处理状态，并不会查询出执行中状态的数据，也就是说不会重复执行。
此外，使用job还有一个硬伤即：它不是立马执行的，有一定的延迟。
如果对时间不太敏感的业务场景，可以考虑使用该方案。
1.2 使用mq 用户点击全部导出按钮，会调用一个后端接口，该接口会向mq服务端，发送一条mq消息。
有个专门的mq消费者，消费该消息，然后就可以实现excel的数据导出了。
相较于job方案，使用mq方案的话，实时性更好一些。
对于mq消费者处理失败的情况，可以增加补偿机制，自动发起重试。
RocketMQ自带了失败重试功能，如果失败次数超过了一定的阀值，则会将该消息自动放入死信队列。
2.使用easyexcel 我们知道在Java中解析和生成Excel，比较有名的框架有Apache POI和jxl。
但它们都存在一个严重的问题就是：非常耗内存，POI有一套SAX模式的API可以一定程度的解决一些内存溢出的问题，但POI还是有一些缺陷，比如07版Excel解压缩以及解压后存储都是在内存中完成的，内存消耗依然很大。
百万级别的excel数据导出功能，如果使用传统的Apache POI框架去处理，可能会消耗很大的内存，容易引发OOM问题。
而easyexcel重写了POI对07版Excel的解析，之前一个3M的excel用POI sax解析，需要100M左右内存，如果改用easyexcel可以降低到几M，并且再大的Excel也不会出现内存溢出；03版依赖POI的sax模式，在上层做了模型转换的封装，让使用者更加简单方便。
需要在maven的pom.xml文件中引入easyexcel的jar包：
&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;easyexcel&lt;/artifactId&gt; &lt;version&gt;3.0.2&lt;/version&gt; &lt;/dependency&gt; 之后，使用起来非常方便。
读excel数据非常方便：
@Test public void simpleRead() { String fileName = TestFileUtil.getPath() &#43; &#34;demo&#34; &#43; File.separator &#43; &#34;demo.xlsx&#34;; // 这里 需要指定读用哪个class去读，然后读取第一个sheet 文件流会自动关闭 EasyExcel." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ed39d72af767c941034eb278ca51a7c4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-27T13:38:09+08:00" />
<meta property="article:modified_time" content="2023-12-27T13:38:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">百万级数据excel导出功能如何实现？</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>前言</h3> 
<p>最近我做过一个MySQL<code>百万级别</code>数据的<code>excel</code>导出功能，已经正常上线使用了。</p> 
<p>这个功能挺有意思的，里面需要注意的细节还真不少，现在拿出来跟大家分享一下，希望对你会有所帮助。</p> 
<p>原始需求：用户在<code>UI界面</code>上点击<code>全部导出</code>按钮，就能导出所有商品数据。</p> 
<p>咋一看，这个需求挺简单的。</p> 
<p>但如果我告诉你，导出的记录条数，可能有一百多万，甚至两百万呢？</p> 
<p>这时你可能会倒吸一口气。</p> 
<p>因为你可能会面临如下问题：</p> 
<ol><li>如果同步导数据，接口很容易超时。</li><li>如果把所有数据一次性装载到内存，很容易引起OOM。</li><li>数据量太大sql语句必定很慢。</li><li>相同商品编号的数据要放到一起。</li><li>如果走异步，如何通知用户导出结果？</li><li>如果excel文件太大，目标用户打不开怎么办？</li></ol> 
<p>我们要如何才能解决这些问题，实现一个百万级别的excel数据快速导出功能呢？</p> 
<p><img src="https://images2.imgbox.com/94/87/qnui2kgt_o.png" alt=""></p> 
<h3><a id="1_25"></a>1.异步处理</h3> 
<p>做一个MySQL百万数据级别的excel导出功能，如果走接口同步导出，该接口肯定会非常容易<code>超时</code>。</p> 
<p>因此，我们在做<code>系统设计</code>的时候，第一选择应该是接口走<code>异步</code>处理。</p> 
<p>说起异步处理，其实有很多种，比如：使用开启一个<code>线程</code>，或者使用<code>线程池</code>，或者使用<code>job</code>，或者使用<code>mq</code>等。</p> 
<p>为了防止服务重启时数据的丢失问题，我们大多数情况下，会使用<code>job</code>或者<code>mq</code>来实现异步功能。</p> 
<h4><a id="11_job_33"></a>1.1 使用job</h4> 
<p>如果使用job的话，需要增加一张<code>执行任务表</code>，记录每次的导出任务。</p> 
<p>用户点击全部导出按钮，会调用一个后端接口，该接口会向表中写入一条记录，该记录的状态为：<code>待执行</code>。</p> 
<p>有个job，每隔一段时间（比如：5分钟），扫描一次执行任务表，查出所有状态是待执行的记录。</p> 
<p>然后遍历这些记录，挨个执行。</p> 
<p>需要注意的是：如果用job的话，要避免重复执行的情况。比如job每隔5分钟执行一次，但如果数据导出的功能所花费的时间超过了5分钟，在一个job周期内执行不完，就会被下一个job执行周期执行。</p> 
<p>所以使用job时可能会出现重复执行的情况。</p> 
<p>为了防止job重复执行的情况，该执行任务需要增加一个<code>执行中</code>的状态。</p> 
<p>具体的状态变化如下：</p> 
<ol><li>执行任务被刚记录到执行任务表，是<code>待执行</code>状态。</li><li>当job第一次执行该执行任务时，该记录再数据库中的状态改为：<code>执行中</code>。</li><li>当job跑完了，该记录的状态变成：<code>完成</code>或<code>失败</code>。</li></ol> 
<p>这样导出数据的功能，在第一个job周期内执行不完，在第二次job执行时，查询<code>待处理</code>状态，并不会查询出<code>执行中</code>状态的数据，也就是说不会重复执行。</p> 
<p>此外，使用job还有一个硬伤即：它不是立马执行的，有一定的延迟。</p> 
<p>如果对时间不太敏感的业务场景，可以考虑使用该方案。</p> 
<h4><a id="12_mq_59"></a>1.2 使用mq</h4> 
<p>用户点击全部导出按钮，会调用一个后端接口，该接口会向<code>mq服务端</code>，发送一条<code>mq消息</code>。</p> 
<p>有个专门的<code>mq消费者</code>，消费该消息，然后就可以实现excel的数据导出了。</p> 
<p>相较于job方案，使用mq方案的话，实时性更好一些。</p> 
<p>对于mq消费者处理失败的情况，可以增加<code>补偿机制</code>，自动发起<code>重试</code>。</p> 
<p><code>RocketMQ</code>自带了<code>失败重试功能</code>，如果失败次数超过了一定的<code>阀值</code>，则会将该消息自动放入<code>死信队列</code>。</p> 
<h3><a id="2easyexcel_71"></a>2.使用easyexcel</h3> 
<p>我们知道在<code>Java</code>中解析和生成<code>Excel</code>，比较有名的框架有<code>Apache POI</code>和<code>jxl</code>。</p> 
<p>但它们都存在一个严重的问题就是：<code>非常耗内存</code>，POI有一套SAX模式的API可以一定程度的解决一些<code>内存溢出</code>的问题，但POI还是有一些缺陷，比如07版Excel解压缩以及解压后存储都是在内存中完成的，<code>内存消耗</code>依然很大。</p> 
<p>百万级别的excel数据导出功能，如果使用传统的Apache POI框架去处理，可能会消耗很大的内存，容易引发<code>OOM</code>问题。</p> 
<p>而<code>easyexcel</code>重写了POI对07版Excel的解析，之前一个3M的excel用POI sax解析，需要100M左右内存，如果改用easyexcel可以降低到几M，并且再大的Excel也不会出现内存溢出；03版依赖POI的sax模式，在上层做了模型转换的封装，让使用者更加简单方便。</p> 
<p>需要在<code>maven</code>的<code>pom.xml</code>文件中引入easyexcel的jar包：</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alibaba<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>easyexcel<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">3.0</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>之后，使用起来非常方便。</p> 
<p>读excel数据非常方便：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">simpleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token class-name">TestFileUtil</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"demo"</span> <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token string">"demo.xlsx"</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里 需要指定读用哪个class去读，然后读取第一个sheet 文件流会自动关闭</span>
    <span class="token class-name">EasyExcel</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token class-name">DemoData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DemoDataListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>写excel数据也非常方便：</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">simpleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token class-name">TestFileUtil</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"write"</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".xlsx"</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里 需要指定写用哪个class去读，然后写到第一个sheet，名字为模板 然后文件流会自动关闭</span>
    <span class="token comment">// 如果这里想使用03 则 传入excelType参数即可</span>
    <span class="token class-name">EasyExcel</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token class-name">DemoData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sheet</span><span class="token punctuation">(</span><span class="token string">"模板"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>easyexcel能大大减少占用内存的主要原因是：在解析Excel时没有将文件数据<code>一次性全部加载到内存中</code>，而是从磁盘上一行行读取数据，逐个解析。</p> 
<h3><a id="3_111"></a>3.分页查询</h3> 
<p>百万级别的数据，从数据库一次性查询出来，是一件非常耗时的工作。</p> 
<p>即使我们可以从数据库中一次性查询出所有数据，没出现连接超时问题，这么多的数据全部加载到应用服务的内存中，也有可能会导致应用服务出现<code>OOM</code>问题。</p> 
<p>因此，我们从数据库中查询数据时，有必要使用<code>分页查询</code>。比如：每页5000条记录，分为200页查询。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchUser</span><span class="token punctuation">(</span><span class="token class-name">SearchModel</span> searchModel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">searchUser</span><span class="token punctuation">(</span>searchModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> pageResponse <span class="token operator">=</span> <span class="token class-name">Page</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userList<span class="token punctuation">,</span> searchModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pageResponse<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">searchUserCount</span><span class="token punctuation">(</span>searchModel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pageResponse<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>每页大小<code>pageSize</code>和页码<code>pageNo</code>，是SearchModel类中的成员变量，在创建searchModel对象时，可以设置设置这两个参数。</p> 
<p>然后在<code>Mybatis</code>的sql文件中，通过<code>limit</code>语句实现分页功能：</p> 
<pre><code class="prism language-java">limit #<span class="token punctuation">{<!-- --></span>pageStart<span class="token punctuation">}</span><span class="token punctuation">,</span> #<span class="token punctuation">{<!-- --></span>pageSize<span class="token punctuation">}</span>
</code></pre> 
<p>其中的pagetStart参数，是通过pageNo和pageSize动态计算出来的，比如：</p> 
<pre><code class="prism language-java">pageStart <span class="token operator">=</span> <span class="token punctuation">(</span>pageNo <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="4sheet_137"></a>4.多个sheet</h3> 
<p>我们知道，excel对一个sheet存放的最大数据量，是有做限制的，一个sheet最多可以保存<code>1048576</code>行数据。否则在保存数据时会直接报错：</p> 
<pre><code class="prism language-java">invalid row number <span class="token punctuation">(</span><span class="token number">1048576</span><span class="token punctuation">)</span> outside allowable range <span class="token punctuation">(</span><span class="token number">0.</span><span class="token number">.1048575</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果你想导出一百万以上的数据，excel的一个sheet肯定是存放不下的。<br> <img src="https://images2.imgbox.com/25/fe/6ON2SZZV_o.png" alt=""></p> 
<p>因此我们需要把数据保存到多个sheet中。<br> <img src="https://images2.imgbox.com/5d/d1/Q8sRhFGP_o.png" alt=""></p> 
<h3><a id="5limit_149"></a>5.计算limit的起始位置</h3> 
<p>我之前说过，我们一般是通过<code>limit</code>语句来实现分页查询功能的：</p> 
<pre><code class="prism language-java">limit #<span class="token punctuation">{<!-- --></span>pageStart<span class="token punctuation">}</span><span class="token punctuation">,</span> #<span class="token punctuation">{<!-- --></span>pageSize<span class="token punctuation">}</span>
</code></pre> 
<p>其中的pagetStart参数，是通过pageNo和pageSize动态计算出来的，比如：</p> 
<pre><code class="prism language-java">pageStart <span class="token operator">=</span> <span class="token punctuation">(</span>pageNo <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>
</code></pre> 
<p>如果只有一个sheet可以这么玩，但如果有多个sheet就会有问题。因此，我们需要重新计算<code>limit</code>的起始位置。</p> 
<p>例如：</p> 
<pre><code class="prism language-java"><span class="token class-name">ExcelWriter</span> excelWriter <span class="token operator">=</span> <span class="token class-name">EasyExcelFactory</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> totalPage <span class="token operator">=</span> <span class="token function">searchUserTotalPage</span><span class="token punctuation">(</span>searchModel<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>totalPage <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token class-name">Page</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>searchModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> sheet <span class="token operator">=</span> <span class="token punctuation">(</span>totalPage <span class="token operator">%</span> maxSheetCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> totalPage <span class="token operator">/</span> maxSheetCount<span class="token operator">:</span> <span class="token punctuation">(</span>totalPage <span class="token operator">/</span> maxSheetCount<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>sheet<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">WriterSheet</span> writeSheet <span class="token operator">=</span> <span class="token function">buildSheet</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token string">"sheet"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> startPageNo <span class="token operator">=</span> i<span class="token operator">*</span><span class="token punctuation">(</span>maxSheetCount<span class="token operator">/</span>pageSize<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> endPageNo <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>maxSheetCount<span class="token operator">/</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span>startPageNo <span class="token operator">&amp;&amp;</span> page<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span>endPageNo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        page <span class="token operator">=</span> <span class="token function">searchUser</span><span class="token punctuation">(</span>searchModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        excelWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>writeSheet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setPageNo</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样就能实现分页查询，将数据导出到不同的excel的sheet当中。</p> 
<h3><a id="6OSS_186"></a>6.文件上传到OSS</h3> 
<p>由于现在我们导出excel数据的方案改成了<code>异步</code>，所以没法直接将excel文件，同步返回给用户。</p> 
<p>因此我们需要先将excel文件存放到一个地方，当用户有需要时，可以访问到。</p> 
<p>这时，我们可以直接将文件上传到<code>OSS</code>文件服务器上。</p> 
<p>通过OSS提供的上传接口，将excel上传成功后，会返回<code>文件名称</code>和<code>访问路径</code>。</p> 
<p>我们可以将excel名称和访问路径保存到<code>表</code>中，这样的话，后面就可以直接通过<code>浏览器</code>，访问<code>远程</code>excel文件了。</p> 
<p>而如果将excel文件保存到<code>应用服务器</code>，可能会占用比较多的<code>磁盘空间</code>。</p> 
<p>一般建议将<code>应用服务器</code>和<code>文件服务器</code>分开，应用服务器需要更多的<code>内存资源</code>或者<code>CPU资源</code>，而<code>文件服务器</code>需要更多的<code>磁盘资源</code>。</p> 
<p>最近我建了新的技术交流群，打算将它打造成高质量的活跃群，欢迎小伙伴们加入。</p> 
<p>我以往的技术群里技术氛围非常不错，大佬很多。</p> 
<p><img src="https://images2.imgbox.com/c6/ef/qSBZaRPq_o.png" alt="在这里插入图片描述"></p> 
<p>加微信：su_san_java，备注：加群，即可加入该群。</p> 
<h3><a id="7WebSocket_209"></a>7.通过WebSocket推送通知</h3> 
<p>通过上面的功能已经导出了excel文件，并且上传到了<code>OSS</code>文件服务器上。</p> 
<p>接下来的任务是要本次excel导出结果，成功还是失败，通知目标用户。</p> 
<p>有种做法是在页面上提示：<code>正在导出excel数据，请耐心等待</code>。</p> 
<p>然后用户可以主动刷新当前页面，获取本地导出excel的结果。</p> 
<p>但这种用户交互功能，不太友好。</p> 
<p>还有一种方式是通过<code>webSocket</code>建立长连接，进行实时通知推送。</p> 
<p>如果你使用了<code>SpringBoot</code>框架，可以直接引入webSocket的相关jar包：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-websocket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>使用起来挺方便的。</p> 
<p>我们可以加一张专门的<code>通知表</code>，记录通过webSocket推送的通知的标题、用户、附件地址、阅读状态、类型等信息。</p> 
<p>能更好的追溯通知记录。</p> 
<p>webSocket给客户端推送一个通知之后，用户的右上角的收件箱上，实时出现了一个小窗口，提示本次导出excel功能是成功还是失败，并且有文件下载链接。</p> 
<p>当前通知的阅读状态是<code>未读</code>。</p> 
<p>用户点击该窗口，可以看到通知的详细内容，然后通知状态变成<code>已读</code>。</p> 
<h3><a id="8_241"></a>8.总条数可配置</h3> 
<p>我们在做导百万级数据这个需求时，是给用户用的，也有可能是给运营同学用的。</p> 
<p>其实我们应该站在实际用户的角度出发，去思考一下，这个需求是否合理。</p> 
<p>用户拿到这个百万级别的excel文件，到底有什么用途，在他们的电脑上能否打开该excel文件，电脑是否会出现太大的卡顿了，导致文件使用不了。</p> 
<p>如果该功能上线之后，真的发生发生这些情况，那么导出excel也没有啥意义了。</p> 
<p>因此，非常有必要把记录的<code>总条数</code>，做成<code>可配置</code>的，可以根据用户的实际情况调整这个配置。</p> 
<p>比如：用户发现excel中有50万的数据，可以正常访问和操作excel，这时候我们可以将总条数调整成500000，把多余的数据截取掉。</p> 
<p>其实，在<code>用户的操作界面</code>，增加更多的查询条件，用户通过修改查询条件，多次导数据，可以实现将所有数据都导出的功能，这样可能更合理一些。</p> 
<p>此外，分页查询时，<code>每页的大小</code>，也建议做成可配置的。</p> 
<p>通过总条数和每页大小，可以动态调整记录数量和分页查询次数，有助于更好满足用户的需求。</p> 
<h3><a id="9order_by_262"></a>9.order by商品编号</h3> 
<p>之前的需求是要将相同商品编号的数据放到一起。</p> 
<p>例如：</p> 
<table><thead><tr><th align="left">编号</th><th align="center">商品名称</th><th align="right">仓库名称</th><th align="center">价格</th></tr></thead><tbody><tr><td align="left">1</td><td align="center">笔记本</td><td align="right">北京仓</td><td align="center">7234</td></tr><tr><td align="left">1</td><td align="center">笔记本</td><td align="right">上海仓</td><td align="center">7235</td></tr><tr><td align="left">1</td><td align="center">笔记本</td><td align="right">武汉仓</td><td align="center">7236</td></tr><tr><td align="left">2</td><td align="center">平板电脑</td><td align="right">成都仓</td><td align="center">7236</td></tr><tr><td align="left">2</td><td align="center">平板电脑</td><td align="right">大连仓</td><td align="center">3339</td></tr></tbody></table> 
<p>但我们做了分页查询的功能，没法将数据一次性查询出来，直接在Java内存中分组或者排序。</p> 
<p>因此，我们需要考虑在sql语句中使用<code>order by</code> 商品编号，先把数据排好顺序，再查询出数据，这样就能将相同商品编号，仓库不同的数据放到一起。</p> 
<p>此外，还有一种情况需要考虑一下，通过配置的总记录数将全部数据做了截取。</p> 
<p>但如果最后一个商品编号在最后一页中没有查询完，可能会导致导出的最后一个商品的数据不完整。</p> 
<p>因此，我们需要在程序中处理一下，将最后一个商品删除。</p> 
<p>但加了order by关键字进行排序之后，如果查询sql中<code>join</code>了很多张表，可能会导致查询性能变差。</p> 
<p>那么，该怎么办呢？</p> 
<h3><a id="_290"></a>总结</h3> 
<p>最后用两张图，总结一下excel异步导数据的流程。</p> 
<p>如果是使用mq导数据：<br> <img src="https://images2.imgbox.com/3d/75/z1ySImGM_o.png" alt=""></p> 
<p>如果是使用job导数据：<br> <img src="https://images2.imgbox.com/90/2d/gZ5WB4oO_o.png" alt=""></p> 
<p>这两种方式都可以，可以根据实际情况选择使用。</p> 
<p><a href="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247500139&amp;idx=1&amp;sn=4a00b3e9cd5e3735d04c7af8e1f65a9d&amp;chksm=c0e81983f79f909524a41dac23b1618a571b310ac752858ef3a4d59438562fbba7e023bc01e3&amp;token=561003558&amp;lang=zh_CN#rd" rel="nofollow">2023年我干了一件很有价值的事情</a></p> 
<h3><a id="_304"></a>最后说一句(求关注，别白嫖我)</h3> 
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙扫描下发二维码关注一下，您的支持是我坚持写作最大的动力。</p> 
<p>求一键三连：点赞、转发、在看。</p> 
<p>关注公众号：【苏三说技术】，在公众号中回复：面试、代码神器、开发手册、时间管理有超赞的粉丝福利，另外回复：加群，可以跟很多BAT大厂的前辈交流和学习。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/50f9affb67ec33f443114853e854a225/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">windows脚本 批量删除指定文件夹、指定文件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/311da9b323716d2c44cb8c749ade7229/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">面试必考：秒杀系统的9个核心知识点，一次性打包给你</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>