<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C&#43;&#43; dlopen mini HOWTO - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C&#43;&#43; dlopen mini HOWTO" />
<meta property="og:description" content="注意：本文为转帖，原文在这里，这是英文原文。
问题所在
有时你想在运行时加载一个库（并使用其中的函数），这在你为你的程序写一些插件或模块架构的时候经常发生。
在C语言中，加载一个库轻而易举（调用dlopen、dlsym和dlclose就够了），但对C&#43;&#43;来说，情况稍微复杂。动态加载一个C&#43;&#43;库的困难一部分是因为C&#43;&#43;的name mangling（译者注：也有人把它翻译为“名字毁坏”，我觉得还是不翻译好），另一部分是因为dlopen API是用C语言实现的，因而没有提供一个合适的方式来装载类。
在解释如何装载C&#43;&#43;库之前，最好再详细了解一下name mangling。我推荐您了解一下它，即使您对它不感兴趣。因为这有助于您理解问题是如何产生的，如何才能解决它们。
Name Mangling
在每个C&#43;&#43;程序（或库、目标文件）中，所有非静态（non-static）函数在二进制文件中都是以“符号（symbol）”形式出现的。这些符号都是唯一的字符串，从而把各个函数在程序、库、目标文件中区分开来。
在C中，符号名正是函数名：strcpy函数的符号名就是“strcpy”，等等。这可能是因为两个非静态函数的名字一定各不相同的缘故。
而C&#43;&#43;允许重载（不同的函数有相同的名字但不同的参数），并且有很多C所没有的特性──比如类、成员函数、异常说明──几乎不可能直接用函数名作符号名。为了解决这个问题，C&#43;&#43;采用了所谓的name mangling。它把函数名和一些信息（如参数数量和大小）杂糅在一起，改造成奇形怪状，只有编译器才懂的符号名。例如，被mangle后的foo可能看起来像foo@4%6^，或者，符号名里头甚至不包括“foo”。
其中一个问题是，C&#43;&#43;标准（目前是[ISO14882]）并没有定义名字必须如何被mangle，所以每个编译器都按自己的方式来进行name mangling。有些编译器甚至在不同版本间更换mangling算法（尤其是g&#43;&#43; 2.x和3.x）。即使您搞清楚了您的编译器到底怎么进行mangling的，从而可以用dlsym调用函数了，但可能仅仅限于您手头的这个编译器而已，而无法在下一版编译器下工作。
类
使用dlopen API的另一个问题是，它只支持加载函数。但在C&#43;&#43;中，您可能要用到库中的一个类，而这需要创建该类的一个实例，这不容易做到。
解决方案
extern &#34;C&#34;
C&#43;&#43;有个特定的关键字用来声明采用C binding的函数：extern &#34;C&#34; 。 用 extern &#34;C&#34;声明的函数将使用函数名作符号名，就像C函数一样。因此，只有非成员函数才能被声明为extern &#34;C&#34;，并且不能被重载。尽管限制多多，extern &#34;C&#34;函数还是非常有用，因为它们可以象C函数一样被dlopen动态加载。冠以extern &#34;C&#34;限定符后，并不意味着函数中无法使用C&#43;&#43;代码了，相反，它仍然是一个完全的C&#43;&#43;函数，可以使用任何C&#43;&#43;特性和各种类型的参数。
加载函数
在C&#43;&#43;中，函数用dlsym加载，就像C中一样。不过，该函数要用extern &#34;C&#34;限定符声明以防止其符号名被mangle。
示例1.加载函数
代码:
//----------
//main.cpp:
//----------
#include &lt;iostream&gt;
#include &lt;dlfcn.h&gt;
int main() {
using std::cout;
using std::cerr;
cout &lt;&lt; &#34;C&#43;&#43; dlopen demo &#34;;
// open the library
cout &lt;&lt; &#34;Opening hello.so... &#34;;
void* handle = dlopen(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b4345b0867e6eaec74acc446411e5a9f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2007-12-18T16:14:00+08:00" />
<meta property="article:modified_time" content="2007-12-18T16:14:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C&#43;&#43; dlopen mini HOWTO</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <font size="3">注意：本文为转帖，<a href="http://www.linuxsir.org/bbs/printthread.php?t=266890" rel="nofollow">原文在这里</a>，<a href="http://www.isotton.com/devel/docs/C++-dlopen-mini-HOWTO/C++-dlopen-mini-HOWTO.html" rel="nofollow">这是英文原文</a>。<br><br>问题所在<br>　　有时你想在运行时加载一个库（并使用其中的函数），这在你为你的程序写一些插件或模块架构的时候经常发生。<br>　　在C语言中，加载一个库轻而易举（调用dlopen、dlsym和dlclose就够了），但对C++来说，情况稍微复杂。动态加载一个C++库的困难一部分是因为C++的name mangling（译者注：也有人把它翻译为“名字毁坏”，我觉得还是不翻译好），另一部分是因为dlopen API是用C语言实现的，因而没有提供一个合适的方式来装载类。<br>　　在解释如何装载C++库之前，最好再详细了解一下name mangling。我推荐您了解一下它，即使您对它不感兴趣。因为这有助于您理解问题是如何产生的，如何才能解决它们。<br><br>　　Name Mangling<br>　　在每个C++程序（或库、目标文件）中，所有非静态（non-static）函数在二进制文件中都是以“符号（symbol）”形式出现的。这些符号都是唯一的字符串，从而把各个函数在程序、库、目标文件中区分开来。<br>　　在C中，符号名正是函数名：strcpy函数的符号名就是“strcpy”，等等。这可能是因为两个非静态函数的名字一定各不相同的缘故。<br>　　而C++允许重载（不同的函数有相同的名字但不同的参数），并且有很多C所没有的特性──比如类、成员函数、异常说明──几乎不可能直接用函数名作符号名。为了解决这个问题，C++采用了所谓的name mangling。它把函数名和一些信息（如参数数量和大小）杂糅在一起，改造成奇形怪状，只有编译器才懂的符号名。例如，被mangle后的foo可能看起来像foo@4%6^，或者，符号名里头甚至不包括“foo”。<br>　　其中一个问题是，C++标准（目前是[ISO14882]）并没有定义名字必须如何被mangle，所以每个编译器都按自己的方式来进行name mangling。有些编译器甚至在不同版本间更换mangling算法（尤其是g++ 2.x和3.x）。即使您搞清楚了您的编译器到底怎么进行mangling的，从而可以用dlsym调用函数了，但可能仅仅限于您手头的这个编译器而已，而无法在下一版编译器下工作。<br><br>　　类<br>　　使用dlopen API的另一个问题是，它只支持加载函数。但在C++中，您可能要用到库中的一个类，而这需要创建该类的一个实例，这不容易做到。<br><br>解决方案<br><br>　　extern "C"<br>　　C++有个特定的关键字用来声明采用C binding的函数：extern "C" 。 用 extern "C"声明的函数将使用函数名作符号名，就像C函数一样。因此，只有非成员函数才能被声明为extern "C"，并且不能被重载。尽管限制多多，extern "C"函数还是非常有用，因为它们可以象C函数一样被dlopen动态加载。冠以extern "C"限定符后，并不意味着函数中无法使用C++代码了，相反，它仍然是一个完全的C++函数，可以使用任何C++特性和各种类型的参数。<br><br>　　加载函数<br>　　在C++中，函数用dlsym加载，就像C中一样。不过，该函数要用extern "C"限定符声明以防止其符号名被mangle。<br>　　<br>　　示例1.加载函数<br>代码:<br></font> 
<div style="border: 0.5pt solid windowtext; padding: 4px 5.4pt; background: rgb(230, 230, 230) none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; width: 95%;"> 
 <div> 
  <font size="3"><img align="top" alt="" src="https://images2.imgbox.com/b9/e4/Q7gjEn8g_o.gif"><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">----------<br><img align="top" alt="" src="https://images2.imgbox.com/60/7a/6SJXUQO5_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">main.cpp:<br><img align="top" alt="" src="https://images2.imgbox.com/78/b8/4DFnGk4P_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">----------</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/6a/85/V10HQymG_o.gif"></span><span style="color: rgb(0, 0, 0);">#include </span><span style="color: rgb(0, 0, 0);">&lt;</span><span style="color: rgb(0, 0, 0);">iostream</span><span style="color: rgb(0, 0, 0);">&gt;</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/0e/0b/1OSgh3pA_o.gif">#include </span><span style="color: rgb(0, 0, 0);">&lt;</span><span style="color: rgb(0, 0, 0);">dlfcn.h</span><span style="color: rgb(0, 0, 0);">&gt;</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/2e/53/JsdxnaYt_o.gif"><br><img align="top" alt="" id="_89_946_Open_Image" src="https://images2.imgbox.com/5e/47/Jhrd8d2t_o.gif"><img align="top" alt="" id="_89_946_Closed_Image" src="https://images2.imgbox.com/c8/18/SO1PFeiv_o.gif" style="display: none;"></span><span style="color: rgb(0, 0, 255);">int</span><span style="color: rgb(0, 0, 0);"> main() </span><span id="_89_946_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/c3/10/CZ8rNyn8_o.gif">    </span><span style="color: rgb(0, 0, 255);">using</span><span style="color: rgb(0, 0, 0);"> std::cout;<br><img align="top" alt="" src="https://images2.imgbox.com/46/dc/PKODH26g_o.gif">    </span><span style="color: rgb(0, 0, 255);">using</span><span style="color: rgb(0, 0, 0);"> std::cerr;<br><img align="top" alt="" src="https://images2.imgbox.com/09/5d/yEJMbcTE_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/9a/d4/Ode5aJZ2_o.gif">    cout </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">C++ dlopen demo </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/50/5c/nHWM726q_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/e8/fd/k9WiLWnL_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> open the library</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/25/de/Defd1uSL_o.gif"></span><span style="color: rgb(0, 0, 0);">    cout </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">Opening hello.so... </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/92/9d/qe7pBokP_o.gif">    </span><span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> handle </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> dlopen(</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">./hello.so</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">, RTLD_LAZY);<br><img align="top" alt="" src="https://images2.imgbox.com/42/f2/CJaNWq3K_o.gif">  <br><img align="top" alt="" id="_303_389_Open_Image" src="https://images2.imgbox.com/35/39/J9tVSOWQ_o.gif"><img align="top" alt="" id="_303_389_Closed_Image" src="https://images2.imgbox.com/3f/4b/KNfELsJZ_o.gif" style="display: none;">    </span><span style="color: rgb(0, 0, 255);">if</span><span style="color: rgb(0, 0, 0);"> (</span><span style="color: rgb(0, 0, 0);">!</span><span style="color: rgb(0, 0, 0);">handle) </span><span id="_303_389_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span><span id="_303_389_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/22/de/TNzsK68B_o.gif">        cerr </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">Cannot open library: </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> dlerror() </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/c6/ba/heS9WxEe_o.gif">        </span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">1</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/a3/0e/n1lEsZ0i_o.gif">    }</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/d4/6d/3OhCocT7_o.gif">  <br><img align="top" alt="" src="https://images2.imgbox.com/f5/05/ELjQbsSp_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> load the symbol</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/a0/72/iklDPiZK_o.gif"></span><span style="color: rgb(0, 0, 0);">    cout </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">Loading symbol hello... </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/59/89/eN2582PF_o.gif">    typedef </span><span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);"> (</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">hello_t)();<br><img align="top" alt="" src="https://images2.imgbox.com/e5/bc/fEqrABVe_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/68/36/h3ScJOk6_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> reset errors</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/fa/b5/JqR0ARCR_o.gif"></span><span style="color: rgb(0, 0, 0);">    dlerror();<br><img align="top" alt="" src="https://images2.imgbox.com/76/b8/XxCru1uX_o.gif">    hello_t hello </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> (hello_t) dlsym(handle, </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">hello</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">);<br><img align="top" alt="" src="https://images2.imgbox.com/a3/66/GFd66bub_o.gif">    </span><span style="color: rgb(0, 0, 255);">const</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 255);">char</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">dlsym_error </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> dlerror();<br><img align="top" alt="" id="_641_773_Open_Image" src="https://images2.imgbox.com/a4/4b/4CAT0Qrx_o.gif"><img align="top" alt="" id="_641_773_Closed_Image" src="https://images2.imgbox.com/56/41/d4KzpdjL_o.gif" style="display: none;">    </span><span style="color: rgb(0, 0, 255);">if</span><span style="color: rgb(0, 0, 0);"> (dlsym_error) </span><span id="_641_773_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span><span id="_641_773_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/6c/fc/ZxHJWtZj_o.gif">        cerr </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">Cannot load symbol 'hello': </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> dlsym_error </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/4b/b0/gbwE2NS9_o.gif">            </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/31/a2/R9ctLHDY_o.gif">        dlclose(handle);<br><img align="top" alt="" src="https://images2.imgbox.com/f4/cf/Af9aKLfg_o.gif">        </span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">1</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/04/e9/PEbTDNe7_o.gif">    }</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/2a/34/GPPWAbkU_o.gif">  <br><img align="top" alt="" src="https://images2.imgbox.com/f0/cc/zA5Gzqxw_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> use it to do the calculation</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/fd/38/GxYtcbU8_o.gif"></span><span style="color: rgb(0, 0, 0);">    cout </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">Calling hello... </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/44/48/a5qlx4Fx_o.gif">    hello();<br><img align="top" alt="" src="https://images2.imgbox.com/28/f9/1TtbBh2M_o.gif">  <br><img align="top" alt="" src="https://images2.imgbox.com/f0/26/j96JI3jo_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> close the library</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/20/11/oPIguoOG_o.gif"></span><span style="color: rgb(0, 0, 0);">    cout </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">Closing library... </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/60/73/O98ZsLFm_o.gif">    dlclose(handle);<br><img align="top" alt="" src="https://images2.imgbox.com/a5/e2/X4eg7Ich_o.gif">}</span></span></font> 
  <span id="_89_946_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span> 
 </div> 
</div> 
<font size="3"><br><br></font> 
<div style="border: 0.5pt solid windowtext; padding: 4px 5.4pt; background: rgb(230, 230, 230) none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; width: 95%;"> 
 <div> 
  <font size="3"><img align="top" alt="" src="https://images2.imgbox.com/d0/2e/1NuzHdbn_o.gif"><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">----------<br><img align="top" alt="" src="https://images2.imgbox.com/48/3d/VrqAlRHs_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> hello.cpp:<br><img align="top" alt="" src="https://images2.imgbox.com/29/a4/ActDI2bX_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">----------</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/4c/1b/gai6ZzO2_o.gif"></span><span style="color: rgb(0, 0, 0);">#include </span><span style="color: rgb(0, 0, 0);">&lt;</span><span style="color: rgb(0, 0, 0);">iostream</span><span style="color: rgb(0, 0, 0);">&gt;</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/fc/12/4GkeQPpp_o.gif"><br><img align="top" alt="" id="_85_121_Open_Image" src="https://images2.imgbox.com/c0/39/w6hnoE7N_o.gif"><img align="top" alt="" id="_85_121_Closed_Image" src="https://images2.imgbox.com/11/2b/c0n5vfix_o.gif" style="display: none;"></span><span style="color: rgb(0, 0, 255);">extern</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">C</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);"> hello() </span><span id="_85_121_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/d9/a8/RoIC3a0R_o.gif">    std::cout </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">hello</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/0d/c9/No0XdgOz_o.gif">}</span></span></font> 
  <span id="_85_121_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span> 
 </div> 
</div> 
<font size="3"><br>　　在hello.cpp中函数hello被定义为extern "C"。它在main.cpp中被dlsym调用。函数必须以extern "C"限定，否则我们无从知晓其符号名。<br>　　警告：<br>　　extern "C"的声明形式有两种：上面示例中使用的那种内联（inline）形式extern "C" ， 还有才用花括号的extern "C" { ... }这种。 第一种内联形式声明包含两层意义：外部链接(extern linkage)和C语言链接(language linkage)，而第二种仅影响语言链接。<br>　　下面两种声明形式等价：<br>代码:<br>extern "C" int foo;<br>extern "C" void bar();<br>和<br>代码:<br>extern "C" {<!-- --><br>    extern int foo;<br>    extern void bar();<br>}<br>　　对于函数来说，extern和non-extern的函数声明没有区别，但对于变量就有不同了。如果您声明变量，请牢记：<br>代码:<br>extern "C" int foo;<br>和<br>代码:<br>extern "C" {<!-- --><br>    int foo;<br>}<br>　　是不同的物事(译者注：简言之，前者是个声明; 而后者不仅是声明，也可以是定义)。<br>　　进一步的解释请参考[ISO14882],7.5, 特别注意第7段; 或者参考[STR2000]，9.2.4。在用extern的变量寻幽访胜之前，请细读“其他”一节中罗列的文档。<br><br>　　加载类<br>　　加载类有点困难，因为我们需要类的一个实例，而不仅仅是一个函数指针。我们无法通过new来创建类的实例，因为类不是在可执行文件中定义的，况且（有时候）我们连它的名字都不知道。<br>　　解决方案是：利用多态性！ 我们在可执行文件中定义一个带虚成员函数的接口基类，而在模块中定义派生实现类。通常来说，接口类是抽象的（如果一个类含有虚函数，那它就是抽象的）。<br>　　因为动态加载类往往用于实现插件，这意味着必须提供一个清晰定义的接口──我们将定义一个接口类和派生实现类。<br>　　接下来，在模块中，我们会定义两个附加的helper函数，就是众所周知的“类工厂函数（class factory functions）（译者注：或称对象工厂函数）”。其中一个函数创建一个类实例，并返回其指针; 另一个函数则用以销毁该指针。这两个函数都以extern "C"来限定修饰。<br>　　为了使用模块中的类，我们用dlsym像示例1中加载hello函数那样加载这两个函数，然后我们就可以随心所欲地创建和销毁实例了。<br><br>　　示例2.加载类<br>　　我们用一个一般性的多边形类作为接口，而继承它的三角形类（译者注：正三角形类）作为实现。<br>代码:<br></font> 
<div style="border: 0.5pt solid windowtext; padding: 4px 5.4pt; background: rgb(230, 230, 230) none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; width: 95%;"> 
 <div> 
  <font size="3"><img align="top" alt="" src="https://images2.imgbox.com/c4/8f/xLSGwXh1_o.gif"><span style="color: rgb(0, 0, 0);">//----------</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/51/69/yV5Br4s0_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">main.cpp:<br><img align="top" alt="" src="https://images2.imgbox.com/4d/9f/Vpo1wYBF_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">----------</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/ea/84/lYq49PmF_o.gif"></span><span style="color: rgb(0, 0, 0);">#include </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">polygon.hpp</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/39/57/5dsR2vUZ_o.gif">#include </span><span style="color: rgb(0, 0, 0);">&lt;</span><span style="color: rgb(0, 0, 0);">iostream</span><span style="color: rgb(0, 0, 0);">&gt;</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/42/a8/XobziC2m_o.gif">#include </span><span style="color: rgb(0, 0, 0);">&lt;</span><span style="color: rgb(0, 0, 0);">dlfcn.h</span><span style="color: rgb(0, 0, 0);">&gt;</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/66/35/cPDZMzoR_o.gif"><br><img align="top" alt="" id="_111_1171_Open_Image" src="https://images2.imgbox.com/99/52/Gi7eSUA6_o.gif"><img align="top" alt="" id="_111_1171_Closed_Image" src="https://images2.imgbox.com/fe/ef/MJpKgjW5_o.gif" style="display: none;"></span><span style="color: rgb(0, 0, 255);">int</span><span style="color: rgb(0, 0, 0);"> main() </span><span id="_111_1171_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/73/a4/FAufho1W_o.gif">    </span><span style="color: rgb(0, 0, 255);">using</span><span style="color: rgb(0, 0, 0);"> std::cout;<br><img align="top" alt="" src="https://images2.imgbox.com/9b/49/fS0RFZrd_o.gif">    </span><span style="color: rgb(0, 0, 255);">using</span><span style="color: rgb(0, 0, 0);"> std::cerr;<br><img align="top" alt="" src="https://images2.imgbox.com/a4/ae/FNjoHNNu_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/b4/fb/Iz3CTkZZ_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> load the triangle library</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/76/bf/BvyiR0mu_o.gif"></span><span style="color: rgb(0, 0, 0);">    </span><span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> triangle </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> dlopen(</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">./triangle.so</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">, RTLD_LAZY);<br><img align="top" alt="" id="_265_351_Open_Image" src="https://images2.imgbox.com/82/c3/YET3QwNi_o.gif"><img align="top" alt="" id="_265_351_Closed_Image" src="https://images2.imgbox.com/32/9a/FPJAlVOu_o.gif" style="display: none;">    </span><span style="color: rgb(0, 0, 255);">if</span><span style="color: rgb(0, 0, 0);"> (</span><span style="color: rgb(0, 0, 0);">!</span><span style="color: rgb(0, 0, 0);">triangle) </span><span id="_265_351_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span><span id="_265_351_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/a9/18/gBqVtISg_o.gif">        cerr </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">Cannot load library: </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> dlerror() </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/66/c1/JVWF9OWF_o.gif">        </span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">1</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/b5/6b/l1aJaMP5_o.gif">    }</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/37/55/cicXvQPg_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/79/b3/p6Fa06sY_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> reset errors</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/3f/f5/HD6JRcR8_o.gif"></span><span style="color: rgb(0, 0, 0);">    dlerror();<br><img align="top" alt="" src="https://images2.imgbox.com/ac/40/YUZQQtIo_o.gif">  <br><img align="top" alt="" src="https://images2.imgbox.com/d4/d6/gJfj364D_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> load the symbols</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/1c/66/8MJ6UUtn_o.gif"></span><span style="color: rgb(0, 0, 0);">    create_t</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> create_triangle </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> (create_t</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">) dlsym(triangle, </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">create</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">);<br><img align="top" alt="" src="https://images2.imgbox.com/a3/54/pjjKY2Tw_o.gif">    </span><span style="color: rgb(0, 0, 255);">const</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 255);">char</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> dlsym_error </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> dlerror();<br><img align="top" alt="" id="_549_643_Open_Image" src="https://images2.imgbox.com/00/a9/nv9P7RiM_o.gif"><img align="top" alt="" id="_549_643_Closed_Image" src="https://images2.imgbox.com/d3/13/ertx56PW_o.gif" style="display: none;">    </span><span style="color: rgb(0, 0, 255);">if</span><span style="color: rgb(0, 0, 0);"> (dlsym_error) </span><span id="_549_643_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span><span id="_549_643_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/fb/71/nwhtVKwI_o.gif">        cerr </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">Cannot load symbol create: </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> dlsym_error </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/9f/d0/fGQK1afV_o.gif">        </span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">1</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/ba/ec/h3sq0fVK_o.gif">    }</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/e3/33/YkSPTqh3_o.gif">  <br><img align="top" alt="" src="https://images2.imgbox.com/c7/81/we1HLtI7_o.gif">    destroy_t</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> destroy_triangle </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> (destroy_t</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">) dlsym(triangle, </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">destroy</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">);<br><img align="top" alt="" src="https://images2.imgbox.com/e7/54/hlhcWLmw_o.gif">    dlsym_error </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> dlerror();<br><img align="top" alt="" id="_773_868_Open_Image" src="https://images2.imgbox.com/2e/e8/x7GUyt3O_o.gif"><img align="top" alt="" id="_773_868_Closed_Image" src="https://images2.imgbox.com/fc/b0/kiH8B58q_o.gif" style="display: none;">    </span><span style="color: rgb(0, 0, 255);">if</span><span style="color: rgb(0, 0, 0);"> (dlsym_error) </span><span id="_773_868_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span><span id="_773_868_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/94/4b/NmS9hEJz_o.gif">        cerr </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">Cannot load symbol destroy: </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> dlsym_error </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/7d/87/Y0Li82yq_o.gif">        </span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">1</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/7f/78/nuWGPQ4r_o.gif">    }</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/4d/f2/64yvK7bl_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/0b/f1/dWNezk0B_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> create an instance of the class</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/55/62/bBzktoBZ_o.gif"></span><span style="color: rgb(0, 0, 0);">    polygon</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> poly </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> create_triangle();<br><img align="top" alt="" src="https://images2.imgbox.com/e6/32/pzApUOMk_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/9e/3a/ULsC0kWc_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> use the class</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/72/41/hoNuaWXZ_o.gif"></span><span style="color: rgb(0, 0, 0);">    poly</span><span style="color: rgb(0, 0, 0);">-&gt;</span><span style="color: rgb(0, 0, 0);">set_side_length(</span><span style="color: rgb(0, 0, 0);">7</span><span style="color: rgb(0, 0, 0);">);<br><img align="top" alt="" src="https://images2.imgbox.com/bb/24/Z4ZA0aUj_o.gif">        cout </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">The area is: </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> poly</span><span style="color: rgb(0, 0, 0);">-&gt;</span><span style="color: rgb(0, 0, 0);">area() </span><span style="color: rgb(0, 0, 0);">&lt;&lt;</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">'</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/4a/d4/yfAYWSlC_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/b3/67/fSePhNMF_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> destroy the class</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/6c/e3/KJbelAGt_o.gif"></span><span style="color: rgb(0, 0, 0);">    destroy_triangle(poly);<br><img align="top" alt="" src="https://images2.imgbox.com/2e/0f/bXBSqvGq_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/0a/76/JdaP6qjS_o.gif">    </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> unload the triangle library</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/86/b0/tRMtx3xF_o.gif"></span><span style="color: rgb(0, 0, 0);">    dlclose(triangle);<br><img align="top" alt="" src="https://images2.imgbox.com/4b/5f/dTm2QhzJ_o.gif">}</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/a3/05/ZopJd72l_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/ae/30/X47EQDxf_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/38/71/gfbihN7O_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">----------<br><img align="top" alt="" src="https://images2.imgbox.com/d0/86/vZvS5PSe_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">polygon.hpp:<br><img align="top" alt="" src="https://images2.imgbox.com/1a/d8/ovEzNBby_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">----------</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/2f/58/8Fncs52u_o.gif"></span><span style="color: rgb(0, 0, 0);">#ifndef POLYGON_HPP<br><img align="top" alt="" src="https://images2.imgbox.com/b7/b2/IYo9c3b6_o.gif"></span><span style="color: rgb(0, 0, 255);">#define</span><span style="color: rgb(0, 0, 0);"> POLYGON_HPP</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/98/46/T0Tz5QbL_o.gif"><br><img align="top" alt="" id="_1271_1516_Open_Image" src="https://images2.imgbox.com/b3/2e/L197Pg19_o.gif"><img align="top" alt="" id="_1271_1516_Closed_Image" src="https://images2.imgbox.com/74/25/zXnSNtqE_o.gif" style="display: none;"></span><span style="color: rgb(0, 0, 255);">class</span><span style="color: rgb(0, 0, 0);"> polygon </span><span id="_1271_1516_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/6b/af/wXQJ5TeA_o.gif"></span><span style="color: rgb(0, 0, 255);">protected</span><span style="color: rgb(0, 0, 0);">:<br><img align="top" alt="" src="https://images2.imgbox.com/94/a9/Jja8RlTq_o.gif">    </span><span style="color: rgb(0, 0, 255);">double</span><span style="color: rgb(0, 0, 0);"> side_length_;<br><img align="top" alt="" src="https://images2.imgbox.com/d0/f5/WTUki7B8_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/db/36/kfLxbolC_o.gif"></span><span style="color: rgb(0, 0, 255);">public</span><span style="color: rgb(0, 0, 0);">:<br><img align="top" alt="" src="https://images2.imgbox.com/87/fb/YpdjCas5_o.gif">    polygon()<br><img align="top" alt="" id="_1358_1359_Open_Image" src="https://images2.imgbox.com/11/c8/93c5Merc_o.gif"><img align="top" alt="" id="_1358_1359_Closed_Image" src="https://images2.imgbox.com/7c/c7/tYg15cUC_o.gif" style="display: none;">        : side_length_(</span><span style="color: rgb(0, 0, 0);">0</span><span style="color: rgb(0, 0, 0);">) </span><span id="_1358_1359_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span><span id="_1358_1359_Open_Text"><span style="color: rgb(0, 0, 0);">{}</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/a7/41/pwv4R7eV_o.gif"><br><img align="top" alt="" id="_1385_1386_Open_Image" src="https://images2.imgbox.com/5c/65/hTt5oJ5c_o.gif"><img align="top" alt="" id="_1385_1386_Closed_Image" src="https://images2.imgbox.com/ee/4b/4O8xUOvs_o.gif" style="display: none;">    </span><span style="color: rgb(0, 0, 255);">virtual</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">~</span><span style="color: rgb(0, 0, 0);">polygon() </span><span id="_1385_1386_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span><span id="_1385_1386_Open_Text"><span style="color: rgb(0, 0, 0);">{}</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/70/b0/S59yY65g_o.gif"><br><img align="top" alt="" id="_1434_1476_Open_Image" src="https://images2.imgbox.com/e0/98/C4dKgFRK_o.gif"><img align="top" alt="" id="_1434_1476_Closed_Image" src="https://images2.imgbox.com/bd/71/ltpdGGjX_o.gif" style="display: none;">    </span><span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);"> set_side_length(</span><span style="color: rgb(0, 0, 255);">double</span><span style="color: rgb(0, 0, 0);"> side_length) </span><span id="_1434_1476_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span><span id="_1434_1476_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/b8/73/v4VfrMUt_o.gif">        side_length_ </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> side_length;<br><img align="top" alt="" src="https://images2.imgbox.com/a6/95/NyKrxvv7_o.gif">    }</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/9d/51/GXlcELkx_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/de/51/2TJhvt11_o.gif">    </span><span style="color: rgb(0, 0, 255);">virtual</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 255);">double</span><span style="color: rgb(0, 0, 0);"> area() </span><span style="color: rgb(0, 0, 255);">const</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">0</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/c7/6c/KJ99cevn_o.gif">}</span></span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/6c/a9/S9mCcaKu_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/6a/88/QvTwMz3W_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> the types of the class factories</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/7b/4a/MVi8csJC_o.gif"></span><span style="color: rgb(0, 0, 0);">typedef polygon</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> create_t();<br><img align="top" alt="" src="https://images2.imgbox.com/61/e5/3U5YCUKe_o.gif">typedef </span><span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);"> destroy_t(polygon</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">);<br><img align="top" alt="" src="https://images2.imgbox.com/5d/5e/kYHciqZ8_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/52/47/JArCbu95_o.gif"></span><span style="color: rgb(0, 0, 255);">#endif</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/a5/0a/9fCtGx4t_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/2d/5b/BAqevjPV_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">----------<br><img align="top" alt="" src="https://images2.imgbox.com/ee/00/3JYI5Ln5_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">triangle.cpp:<br><img align="top" alt="" src="https://images2.imgbox.com/d3/d1/KLLJqfGa_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">----------</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/94/25/7iWTP1KQ_o.gif"></span><span style="color: rgb(0, 0, 0);">#include </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">polygon.hpp</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/2e/52/GSl5H7qY_o.gif">#include </span><span style="color: rgb(0, 0, 0);">&lt;</span><span style="color: rgb(0, 0, 0);">cmath</span><span style="color: rgb(0, 0, 0);">&gt;</span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/6d/f4/EDwGk23J_o.gif"><br><img align="top" alt="" id="_1743_1851_Open_Image" src="https://images2.imgbox.com/5c/cb/EnWbLO8x_o.gif"><img align="top" alt="" id="_1743_1851_Closed_Image" src="https://images2.imgbox.com/06/77/0IumWlPT_o.gif" style="display: none;"></span><span style="color: rgb(0, 0, 255);">class</span><span style="color: rgb(0, 0, 0);"> triangle : </span><span style="color: rgb(0, 0, 255);">public</span><span style="color: rgb(0, 0, 0);"> polygon </span><span id="_1743_1851_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/db/0c/EFtC0aqw_o.gif"></span><span style="color: rgb(0, 0, 255);">public</span><span style="color: rgb(0, 0, 0);">:<br><img align="top" alt="" id="_1785_1849_Open_Image" src="https://images2.imgbox.com/0b/48/1Svb97Jl_o.gif"><img align="top" alt="" id="_1785_1849_Closed_Image" src="https://images2.imgbox.com/1c/c0/ORPyLOKz_o.gif" style="display: none;">    </span><span style="color: rgb(0, 0, 255);">virtual</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 255);">double</span><span style="color: rgb(0, 0, 0);"> area() </span><span style="color: rgb(0, 0, 255);">const</span><span style="color: rgb(0, 0, 0);"> </span><span id="_1785_1849_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span><span id="_1785_1849_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/55/8c/sNTzohR9_o.gif">        </span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);"> side_length_ </span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> side_length_ </span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> sqrt(</span><span style="color: rgb(0, 0, 0);">3</span><span style="color: rgb(0, 0, 0);">) </span><span style="color: rgb(0, 0, 0);">/</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">2</span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/76/0a/hKM84mDC_o.gif">    }</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/99/b7/MXTvBdd4_o.gif">}</span></span><span style="color: rgb(0, 0, 0);">;<br><img align="top" alt="" src="https://images2.imgbox.com/8c/e6/H7df36dr_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/46/a7/BsEPCCAS_o.gif"><br><img align="top" alt="" src="https://images2.imgbox.com/18/09/bPCB8plT_o.gif"></span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> the class factories</span><span style="color: rgb(0, 128, 0);"><br><img align="top" alt="" id="_1908_1935_Open_Image" src="https://images2.imgbox.com/8d/6a/ndSmaHAR_o.gif"><img align="top" alt="" id="_1908_1935_Closed_Image" src="https://images2.imgbox.com/77/da/a3Eiw2zZ_o.gif" style="display: none;"></span><span style="color: rgb(0, 0, 255);">extern</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">C</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> polygon</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> create() </span><span id="_1908_1935_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/16/c1/kboFbMPe_o.gif">    </span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 255);">new</span><span style="color: rgb(0, 0, 0);"> triangle;<br><img align="top" alt="" src="https://images2.imgbox.com/a9/7d/T0Oiidjg_o.gif">}</span></span><span style="color: rgb(0, 0, 0);"><br><img align="top" alt="" src="https://images2.imgbox.com/f1/e7/8evj3J9H_o.gif"><br><img align="top" alt="" id="_1974_1990_Open_Image" src="https://images2.imgbox.com/0b/4f/8eQA1STh_o.gif"><img align="top" alt="" id="_1974_1990_Closed_Image" src="https://images2.imgbox.com/ef/07/NSdJA4on_o.gif" style="display: none;"></span><span style="color: rgb(0, 0, 255);">extern</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">C</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);"> </span><span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);"> destroy(polygon</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);"> p) </span><span id="_1974_1990_Open_Text"><span style="color: rgb(0, 0, 0);">{<!-- --><br><img align="top" alt="" src="https://images2.imgbox.com/bf/cf/i8yb32DO_o.gif">    delete p;<br><img align="top" alt="" src="https://images2.imgbox.com/ff/4b/ffLJLOMW_o.gif">}</span></span></font> 
  <span id="_111_1171_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span> 
  <span id="_1271_1516_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span> 
  <span id="_1743_1851_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span> 
  <span id="_1908_1935_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span> 
  <span id="_1974_1990_Closed_Text" style="border: 1px solid rgb(128, 128, 128); background-color: rgb(255, 255, 255); display: none;">...</span> 
 </div> 
</div> 
<font size="3"><br>　　加载类时有一些值得注意的地方：<br>　　◆ 你必须（译者注：在模块或者说共享库中）同时提供一个创造函数和一个销毁函数，且不能在执行文件内部使用delete来销毁实例，只能把实例指针传递给模块的销毁函数处理。这是因为C++里头，new操作符可以被重载;这容易导致new-delete的不匹配调用，造成莫名其妙的内存泄漏和段错误。这在用不同的标准库链接模块和可执行文件时也一样。<br>　　◆ 接口类的析构函数在任何情况下都必须是虚函数（virtual）。因为即使出错的可能极小，近乎杞人忧天了，但仍旧不值得去冒险，反正额外的开销微不足道。如果基类不需要析构函数，定义一个空的（但必须虚的）析构函数吧，否则你迟早要遇到问题，我向您保证。你可以在comp.lang.c++ FAQ( http://www.parashift.com/c++-faq-lite/ )的第20节了解到更多关于该问题的信息。<br><br>源代码<br>　　<a href="http://www.isotton.com/howtos/C++-dlopen-mini-HOWTO/examples.tar.gz" rel="nofollow">你可以下载所有包含在本文档中的代码包</a>.<br><br></font>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9dd27a2f88efedb0019d7068eb8d5437/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mac OS X 环境变量设置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a2ee6cb3f0604b0c90ff936722243df8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">交互式编程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>