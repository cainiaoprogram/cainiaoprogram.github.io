<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>四轮两驱小车（一）：STM32驱动AS4950 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="四轮两驱小车（一）：STM32驱动AS4950" />
<meta property="og:description" content="目录 前言：
效果展示：
车体展示：
前言：
在前两周的时间里，我对上个版本的小车进行了一个更新换代，将原本的4驱小车换成了4轮两驱小车，舍弃了树莓派4B作为上位机。新版小车采用两个520直流减速电机搭配AS4950电机芯片来差速行进，后面采用两个万向轮带着，5路灰度传感器循迹，用HC_SR04超声波模块中断式测距，用HC_08蓝牙模块与手机进行通信，同时搭载MPU6050模块来拐直角弯。
效果展示： 新版小车功能效果展示
车体展示： 正文开始： 本次改进依旧沿用上次制作的电路板，板载了AS4950电机芯片，在这款电机芯片的帮助下，我甚至连死区时间都不用配置，AS4950自行帮我们处理。
如图就是AS4950及其原理图
根据AS4950的数据手册，我们可以整理一下，得到一个表格
IN1IN2电机驱动状态任意任意停止00停止01正转10反转11刹车 从这里，我们就可以看到AS4950有4种驱动状态：
1：IN1端口输入PWM，IN2端口输入低电平，芯片输出正电流，电机正转；
2：IN1端口输入低电平，IN2端口输入PWM，芯片输出负电流，电机反转；
3：IN1端口输入高电平，IN2端口输入PWM，芯片输出正电流，电机正传；
4；IN1端口输入PWM，IN2端口输入高电平，芯片输出负电流，电机反转；
我这里就选择了方式1和方式4来控制电机正反转，利用两轮差速来循迹和拐弯，使用TIM8的CH2（PC7）CH3(PC8)作为PWM输出，CH2N（PB0）CH3N(PB1)作为推挽输出。在输出PWM上，我选择了输出比较模式，通过修改CCR寄存器来调整占空比
代码部分： void Motor3_Init() { //PC7 -&gt; TIM8_CH2 GPIO_InitTypeDef GPIO_InitStructure; TIM_TimeBaseInitTypeDef	TIM_TimeBaseStructure; TIM_OCInitTypeDef	TIM_OCInitStructure; RCC_APB2PeriphClockCmd(RCC_APB2Periph_TIM8|RCC_APB2Periph_GPIOB|RCC_APB2Periph_GPIOC,ENABLE); GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;//PC7为PWM GPIO_InitStructure.GPIO_Pin = GPIO_Pin_7; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; GPIO_Init(GPIOC, &amp;GPIO_InitStructure);//PC7 GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;//PB0用做推挽输出 GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; GPIO_Init(GPIOB, &amp;GPIO_InitStructure);//PB0 GPIO_WriteBit(GPIOB, GPIO_Pin_0, Bit_RESET);// 0 0 状态是AS4950休眠状态 TIM_TimeBaseStructure.TIM_ClockDivision = 0x0; TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up; TIM_TimeBaseStructure.TIM_Period = 9999; TIM_TimeBaseStructure." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5b67f357c88c64fca11d88cbf1b7b7e7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-17T11:31:17+08:00" />
<meta property="article:modified_time" content="2022-12-17T11:31:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">四轮两驱小车（一）：STM32驱动AS4950</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 id="%E5%89%8D%E8%A8%80%EF%BC%9A"><strong>目录</strong></h2> 
<p id="%E5%89%8D%E8%A8%80%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E5%89%8D%E8%A8%80%EF%BC%9A" rel="nofollow">        </a> <a href="#%E5%89%8D%E8%A8%80%EF%BC%9A" rel="nofollow">前言：</a></p> 
<p id="%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA%EF%BC%9A" rel="nofollow">效果展示：</a></p> 
<p id="%E8%BD%A6%E4%BD%93%E5%B1%95%E7%A4%BA%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E8%BD%A6%E4%BD%93%E5%B1%95%E7%A4%BA%EF%BC%9A" rel="nofollow">车体展示：</a></p> 
<hr id="hr-toc"> 
<p>前言：</p> 
<blockquote> 
 <p>        在前两周的时间里，我对上个版本的小车进行了一个更新换代，将原本的4驱小车换成了4轮两驱小车，舍弃了树莓派4B作为上位机。新版小车采用两个520直流减速电机搭配AS4950电机芯片来差速行进，后面采用两个万向轮带着，5路灰度传感器循迹，用HC_SR04超声波模块中断式测距，用HC_08蓝牙模块与手机进行通信，同时搭载MPU6050模块来拐直角弯。</p> 
</blockquote> 
<h3 id="%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA%EF%BC%9A">效果展示：</h3> 
<p style="text-align:center;"><a class="link-info" href="https://www.bilibili.com/video/BV1y44y1m7MA/?vd_source=3b1c4eb4d3ec2d429c12982ccfb9d120" rel="nofollow" title="新版小车功能效果展示">新版小车功能效果展示</a></p> 
<h3 id="%E8%BD%A6%E4%BD%93%E5%B1%95%E7%A4%BA%EF%BC%9A">车体展示：</h3> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/51/f6/kqQgGsHn_o.jpg" width="1200"></p> 
<p> <img alt="" height="1200" src="https://images2.imgbox.com/21/25/ESE4UcR7_o.jpg" width="1200"></p> 
<h3> 正文开始：</h3> 
<p>        本次改进依旧沿用上次制作的电路板，板载了AS4950电机芯片，在这款电机芯片的帮助下，我甚至连死区时间都不用配置，AS4950自行帮我们处理。</p> 
<p style="text-align:center;">如图就是AS4950及其原理图</p> 
<p><img alt="" height="1139" src="https://images2.imgbox.com/4e/a7/Hce9yAXz_o.png" width="1200"></p> 
<p></p> 
<p class="img-center"><img alt="" height="417" src="https://images2.imgbox.com/3a/fa/xushCmOu_o.png" width="450"></p> 
<p><img alt="" height="436" src="https://images2.imgbox.com/27/9c/9EqHY6Bc_o.png" width="713"></p> 
<p><img alt="" height="297" src="https://images2.imgbox.com/49/1a/t3UylG0E_o.png" width="1097"></p> 
<p>          根据AS4950的数据手册，我们可以整理一下，得到一个表格</p> 
<table border="1" cellpadding="1" cellspacing="1" style="width:500px;"><tbody><tr><td style="text-align:center;">IN1</td><td style="text-align:center;">IN2</td><td style="text-align:center;">电机驱动状态</td></tr><tr><td style="text-align:center;">任意</td><td style="text-align:center;">任意</td><td style="text-align:center;">停止</td></tr><tr><td style="text-align:center;">0</td><td style="text-align:center;">0</td><td style="text-align:center;">停止</td></tr><tr><td style="text-align:center;">0</td><td style="text-align:center;">1</td><td style="text-align:center;">正转</td></tr><tr><td style="text-align:center;">1</td><td style="text-align:center;">0</td><td style="text-align:center;">反转</td></tr><tr><td style="text-align:center;">1</td><td style="text-align:center;">1</td><td style="text-align:center;">刹车</td></tr></tbody></table> 
<p></p> 
<p>从这里，我们就可以看到AS4950有4种驱动状态：</p> 
<p>1：IN1端口输入PWM，IN2端口输入低电平，芯片输出正电流，电机正转；</p> 
<p>2：IN1端口输入低电平，IN2端口输入PWM，芯片输出负电流，电机反转；</p> 
<p>3：IN1端口输入高电平，IN2端口输入PWM，芯片输出正电流，电机正传；</p> 
<p>4；IN1端口输入PWM，IN2端口输入高电平，芯片输出负电流，电机反转；</p> 
<p>我这里就选择了方式1和方式4来控制电机正反转，利用两轮差速来循迹和拐弯，使用TIM8的CH2（PC7）CH3(PC8)作为PWM输出，CH2N（PB0）CH3N(PB1)作为推挽输出。在输出PWM上，我选择了输出比较模式，通过修改CCR寄存器来调整占空比</p> 
<h3>代码部分：</h3> 
<pre><code class="language-cs">void Motor3_Init()
{
	//PC7 	    -&gt; TIM8_CH2
	GPIO_InitTypeDef GPIO_InitStructure;
	TIM_TimeBaseInitTypeDef	TIM_TimeBaseStructure;
	TIM_OCInitTypeDef	TIM_OCInitStructure;
	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_TIM8|RCC_APB2Periph_GPIOB|RCC_APB2Periph_GPIOC,ENABLE);
	
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;//PC7为PWM
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_7;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOC, &amp;GPIO_InitStructure);//PC7
	
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;//PB0用做推挽输出
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);//PB0
	GPIO_WriteBit(GPIOB, GPIO_Pin_0, Bit_RESET);// 0 0 状态是AS4950休眠状态
	
	TIM_TimeBaseStructure.TIM_ClockDivision = 0x0;
	TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;
	TIM_TimeBaseStructure.TIM_Period = 9999;
	TIM_TimeBaseStructure.TIM_Prescaler = (uint16_t) (SystemCoreClock / 1000000) - 1;
	TIM_TimeBaseInit(TIM8, &amp;TIM_TimeBaseStructure);
	
	TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1; //选择定时器模式:TIM脉冲宽度调制模式1
	TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable; //比较输出使能
//	TIM_OCInitStructure.TIM_OCNIdleState = TIM_OutputNState_Disable;//CH2N通道失能
//	TIM_OCInitStructure.TIM_OCPolarity = ;
	TIM_OCInitStructure.TIM_Pulse = 0;                            //设置待装入捕获比较寄存器的脉冲值
	TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High;     //输出极性:TIM输出比较极性高
	TIM_OC2Init(TIM8, &amp;TIM_OCInitStructure);  //根据TIM_OCInitStruct中指定的参数初始化外设TIMx
	TIM_CtrlPWMOutputs(TIM8,ENABLE);	//MOE 主输出使能	

	TIM_OC2PreloadConfig(TIM8, TIM_OCPreload_Disable);  //CH2预装载使能	  
	
	TIM_ARRPreloadConfig(TIM8, ENABLE); //使能TIMx在ARR上的预装载寄存器
	
	TIM_Cmd(TIM8, ENABLE);  //使能TIM8
}
void Motor4_Init()
{
	//PC8 	    -&gt; TIM8_CH3
	GPIO_InitTypeDef GPIO_InitStructure;
	TIM_TimeBaseInitTypeDef	TIM_TimeBaseStructure;
	TIM_OCInitTypeDef	TIM_OCInitStructure;
	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_TIM8|RCC_APB2Periph_GPIOB|RCC_APB2Periph_GPIOC,ENABLE);
	
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;//PC8作为PWM
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOC, &amp;GPIO_InitStructure);//PC8
	
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;//PB1作为输出
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_1;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);//PB1
	GPIO_WriteBit(GPIOB, GPIO_Pin_1, Bit_RESET);// 0 0 状态是AS4950休眠状态
	
	TIM_TimeBaseStructure.TIM_ClockDivision = 0x0;
	TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;
	TIM_TimeBaseStructure.TIM_Period = 9999;
	TIM_TimeBaseStructure.TIM_Prescaler = (uint16_t) (SystemCoreClock / 1000000) - 1;
	TIM_TimeBaseInit(TIM8, &amp;TIM_TimeBaseStructure);
	
	TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1; //选择定时器模式:TIM脉冲宽度调制模式1
	TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable; //比较输出使能
	TIM_OCInitStructure.TIM_Pulse = 0;                            //设置待装入捕获比较寄存器的脉冲值
	TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High;     //输出极性:TIM输出比较极性高
	TIM_OC3Init(TIM8, &amp;TIM_OCInitStructure);  //根据TIM_OCInitStruct中指定的参数初始化外设TIMx
	TIM_CtrlPWMOutputs(TIM8,ENABLE);	//MOE 主输出使能	

	TIM_OC3PreloadConfig(TIM8, TIM_OCPreload_Disable);  //CH3预装载使能	  
	
	TIM_ARRPreloadConfig(TIM8, ENABLE); //使能TIMx在ARR上的预装载寄存器
	
	TIM_Cmd(TIM8, ENABLE);  //使能TIM8
}</code></pre> 
<pre><code class="language-cs">#define Motor3_reverse(pulse)        {TIM8-&gt;CCR2 = pulse; GPIO_WriteBit(GPIOB, GPIO_Pin_0, Bit_RESET);}    
#define Motor4_reverse(pulse)        {TIM8-&gt;CCR3 = pulse; GPIO_WriteBit(GPIOB, GPIO_Pin_1, Bit_RESET);}
#define Motor3_stop()  	 			 {TIM8-&gt;CCR2 = 0; GPIO_WriteBit(GPIOB, GPIO_Pin_0, Bit_SET);}
#define Motor4_stop()  				 {TIM8-&gt;CCR3 = 0; GPIO_WriteBit(GPIOB, GPIO_Pin_1, Bit_SET);}
#define Motor3_forward(pulse)        {TIM8-&gt;CCR2 = pulse; GPIO_WriteBit(GPIOB, GPIO_Pin_0, Bit_SET);}
#define Motor4_forward(pulse)        {TIM8-&gt;CCR3 = pulse; GPIO_WriteBit(GPIOB, GPIO_Pin_1, Bit_SET);}
#define Move_stop()					 {Motor3_stop();Motor4_stop();}</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5fba9221bdef143c9d4b3073f076fd0c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringBoot&#43;Prometheus&#43;Grafana 实现自定义监控</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/50ffe15edc1c1a2c931cdf78424f0388/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">fiddler手机抓包/模拟器抓包配置代理没有网络问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>