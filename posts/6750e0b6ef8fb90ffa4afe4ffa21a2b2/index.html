<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flowable 之事件和网关 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flowable 之事件和网关" />
<meta property="og:description" content="文章目录 一、网关1.1 排他网关1.2 并行网关1.3 包容网关1.4 事件网关 二、事件2.1 定时器事件2.1.1 定时器启动事件2.1.2 中间计时器捕获事件2.1.3 边界计时器事件 2.2 消息事件2.2.1 消息启动事件2.2.2 中间消息捕获事件2.2.3 边界消息事件 2.3 错误事件2.3.1 异常启动事件2.3.2 结束错误事件2.3.3 边界错误事件 2.4 信号事件2.4.1 信号启动事件2.4.2 中间信号捕获事件2.4.3 中间信号抛出事件2.4.4 边界信号事件 2.5 结束事件2.5.1 结束错误事件2.5.2 结束终止事件2.5.3 结束取消事件 2.6 补偿事件 提示：以下是本篇文章正文内容，Java 系列学习将会持续更新 一、网关 1.1 排他网关 排他网关（exclusive gateway）（也叫异或网关 XOR gateway，或者更专业的，基于数据的排他网关 exclusive data-based gateway），用于对流程中的决策建模。当执行到达这个网关时，会按照所有出口顺序流定义的顺序对它们进行计算。选择第一个条件计算为true的顺序流（当没有设置条件时，认为顺序流为true）继续流程。
使用排他网关时，只会选择一条顺序流。当多条顺序流的条件都计算为 true 时，会且仅会选择在XML中最先定义的顺序流继续流程。如果没有可选的顺序流，会抛出异常。 public class Test5 extends FlowableBootStudyApplicationTests { @Resource private RepositoryService repositoryService; @Resource private RuntimeService runtimeService; @Resource private TaskService taskService; /** * 部署流程 */ @Test public void deploy(){ Deployment deploy = repositoryService." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6750e0b6ef8fb90ffa4afe4ffa21a2b2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-21T10:18:29+08:00" />
<meta property="article:modified_time" content="2023-09-21T10:18:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flowable 之事件和网关</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="mulu"> </h3> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_10" rel="nofollow">一、网关</a></li><li><ul><li><a href="#11__12" rel="nofollow">1.1 排他网关</a></li><li><a href="#12__97" rel="nofollow">1.2 并行网关</a></li><li><a href="#13__183" rel="nofollow">1.3 包容网关</a></li><li><a href="#14__255" rel="nofollow">1.4 事件网关</a></li></ul> 
  </li><li><a href="#_267" rel="nofollow">二、事件</a></li><li><ul><li><a href="#21__277" rel="nofollow">2.1 定时器事件</a></li><li><ul><li><a href="#211__282" rel="nofollow">2.1.1 定时器启动事件</a></li><li><a href="#212__296" rel="nofollow">2.1.2 中间计时器捕获事件</a></li><li><a href="#213__301" rel="nofollow">2.1.3 边界计时器事件</a></li></ul> 
   </li><li><a href="#22__315" rel="nofollow">2.2 消息事件</a></li><li><ul><li><a href="#221__317" rel="nofollow">2.2.1 消息启动事件</a></li><li><a href="#222__342" rel="nofollow">2.2.2 中间消息捕获事件</a></li><li><a href="#223__386" rel="nofollow">2.2.3 边界消息事件</a></li></ul> 
   </li><li><a href="#23__410" rel="nofollow">2.3 错误事件</a></li><li><ul><li><a href="#231__412" rel="nofollow">2.3.1 异常启动事件</a></li><li><a href="#232__447" rel="nofollow">2.3.2 结束错误事件</a></li><li><a href="#233__460" rel="nofollow">2.3.3 边界错误事件</a></li></ul> 
   </li><li><a href="#24__471" rel="nofollow">2.4 信号事件</a></li><li><ul><li><a href="#241__472" rel="nofollow">2.4.1 信号启动事件</a></li><li><a href="#242__494" rel="nofollow">2.4.2 中间信号捕获事件</a></li><li><a href="#243__510" rel="nofollow">2.4.3 中间信号抛出事件</a></li><li><a href="#244__525" rel="nofollow">2.4.4 边界信号事件</a></li></ul> 
   </li><li><a href="#25__534" rel="nofollow">2.5 结束事件</a></li><li><ul><li><a href="#251__535" rel="nofollow">2.5.1 结束错误事件</a></li><li><a href="#252__545" rel="nofollow">2.5.2 结束终止事件</a></li><li><a href="#253__553" rel="nofollow">2.5.3 结束取消事件</a></li></ul> 
   </li><li><a href="#26__566" rel="nofollow">2.6 补偿事件</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<font color="#999AAA">提示：以下是本篇文章正文内容，Java 系列学习将会持续更新 </font> 
<p></p> 
<p><img src="https://images2.imgbox.com/8c/ba/jXKP4reQ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_10"></a>一、网关</h2> 
<p><img src="https://images2.imgbox.com/06/08/E604SjJt_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="11__12"></a>1.1 排他网关</h3> 
<p>排他网关（exclusive gateway）（也叫<em>异或网关 XOR gateway</em>，或者更专业的，<em>基于数据的排他网关 exclusive data-based gateway</em>），用于对流程中的<strong>决策</strong>建模。当执行到达这个网关时，会按照所有出口顺序流定义的顺序对它们进行计算。选择第一个条件计算为true的顺序流（当没有设置条件时，认为顺序流为<em>true</em>）继续流程。</p> 
<ul><li>使用排他网关时，<strong>只会选择一条顺序流</strong>。</li><li>当多条顺序流的条件都计算为 true 时，会且仅会选择在XML中<strong>最先定义</strong>的顺序流继续流程。</li><li><strong>如果没有可选的顺序流，会抛出异常</strong>。</li></ul> 
<p><img src="https://images2.imgbox.com/fe/31/iicJmd72_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test5</span> <span class="token keyword">extends</span> <span class="token class-name">FlowableBootStudyApplicationTests</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RepositoryService</span> repositoryService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RuntimeService</span> runtimeService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TaskService</span> taskService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 部署流程
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Deployment</span> deploy <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createDeployment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addClasspathResource</span><span class="token punctuation">(</span><span class="token string">"请假流程-排他网关.bpmn20.xml"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"请假流程-排他网关"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"deploy.getId() = "</span> <span class="token operator">+</span> deploy<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>deploy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 启动流程实例
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">runProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceById</span><span class="token punctuation">(</span><span class="token string">"holiday-exclusive:1:c92d6bb0-4c91-11ee-9806-200db0c7aa5b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 完成任务-提出请假申请
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"holiday-exclusive:1:c92d6bb0-4c91-11ee-9806-200db0c7aa5b"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 完成任务-审批请假申请
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">complete2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"holiday-exclusive:1:c92d6bb0-4c91-11ee-9806-200db0c7aa5b"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"主管"</span><span class="token punctuation">)</span> <span class="token comment">// 主管 或 总经理</span>
                <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>注意</strong>：如果从网关出去的线所有条件都不满足的情况下会抛出系统异常！<br> <img src="https://images2.imgbox.com/d7/8b/MCxLabgz_o.png" alt="在这里插入图片描述"><br> 但是，原来的任务还在没有丢 <font color="red">(如果没有排他网关，没有可走的分支时任务就会结束)</font>，我们可以重置流程变量。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 给流程定义中的UEL表达式赋值</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span><span class="token string">"3b987f19-4c92-11ee-84c8-200db0c7aa5b"</span><span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里传流程实例executionId</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="12__97"></a>1.2 并行网关</h3> 
<p>并行网关允许将流程分成多条分支，也可以把多条分支汇聚到一起，并行网关的功能是基于进入和外出顺序流的。</p> 
<ul><li><strong>fork 分支</strong>：并行后的所有外出顺序流，为每个顺序流都创建一个并发分支。</li><li><strong>join 汇聚</strong>：所有到达并行网关，在此等待的进入分支， 直到所有进入顺序流的分支都到达以后， 流程就会通过汇聚网关。</li></ul> 
<p><strong>注意</strong>：如果同一个并行网关有多个进入和多个外出顺序流， 它就同时具有分支和汇聚功能。 这时，网关会先汇聚所有进入的顺序流，然后再切分成多个并行分支。</p> 
<p><strong>与其他网关的主要区别是，并行网关不会解析条件。</strong> <strong>即使顺序流中定义了条件，也会被忽略。</strong><br> <img src="https://images2.imgbox.com/bc/43/BqCAMYno_o.png" alt="在这里插入图片描述"></p> 
<p><strong>①流程的部署和启动</strong>。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 部署流程
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Deployment</span> deploy <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createDeployment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addClasspathResource</span><span class="token punctuation">(</span><span class="token string">"请假流程-并行网关.bpmn20.xml"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"请假流程-并行网关"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"deploy.getId() = "</span> <span class="token operator">+</span> deploy<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>deploy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 启动流程实例
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">runProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceById</span><span class="token punctuation">(</span><span class="token string">"holiday-parallel:1:7593cd7a-4c96-11ee-9b26-200db0c7aa5b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动流程后，act_ru_task 表中有了一条待执行的任务，执行人是 “张三”。<br> <img src="https://images2.imgbox.com/0f/7c/A6vRLfpx_o.png" alt="在这里插入图片描述"></p> 
<p><strong>②张三完成任务——提出请假申请</strong>。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"holiday-parallel:1:7593cd7a-4c96-11ee-9b26-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>进入并行网关后产生了两条分支。act_ru_task 表中有了两条待执行的任务，执行人分别是 “王经理” 和 “李经理”。<br> <img src="https://images2.imgbox.com/8b/37/osPQblIE_o.png" alt="在这里插入图片描述"></p> 
<p><strong>③完成其中一个分支任务——项目经理审批</strong>。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"holiday-parallel:1:7593cd7a-4c96-11ee-9b26-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"李经理"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>流程没有结束，act_ru_task 表中还有一条待执行的任务，执行人分别是 “王经理”。<br> <img src="https://images2.imgbox.com/36/46/OmlKkjqT_o.png" alt="在这里插入图片描述"></p> 
<p><strong>④完成所有分支任务——技术经理审批</strong>。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"holiday-parallel:1:7593cd7a-4c96-11ee-9b26-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"王经理"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>完成所有分支任务后，流程结束！<br> <img src="https://images2.imgbox.com/17/e8/MmMWLq26_o.png" alt="在这里插入图片描述"></p> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="13__183"></a>1.3 包容网关</h3> 
<p>包含网关可以看做是排他网关和并行网关的结合体。 和排他网关一样，你可以在外出顺序流上定义条件，包含网关会解析它们。 但是主要的区别是包含网关可以选择多于一条顺序流，这和并行网关一样。</p> 
<p>包含网关的功能是基于进入和外出顺序流的：</p> 
<ul><li><strong>分支</strong>：所有外出顺序流的条件都会被解析，结果为 true 的顺序流会以并行方式继续执行， 会为每个顺序流创建一个分支。</li><li><strong>汇聚</strong>：所有并行分支到达包含网关，会进入等待状态， 直到每个分支都到达。 换句话说，包含网关<strong>只会等待被选中执行的顺序流</strong>。 在汇聚之后，流程会穿过包含网关继续执行。</li></ul> 
<p><img src="https://images2.imgbox.com/6c/1b/Fl4Q4Amf_o.png" alt="在这里插入图片描述"></p> 
<p><strong>①通过包容网关，进入两条分支</strong>。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 部署流程
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Deployment</span> deploy <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createDeployment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addClasspathResource</span><span class="token punctuation">(</span><span class="token string">"请假流程-包容网关.bpmn20.xml"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"请假流程-包容网关"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"deploy.getId() = "</span> <span class="token operator">+</span> deploy<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>deploy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 启动流程实例
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">runProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceById</span><span class="token punctuation">(</span><span class="token string">"holiday-inclusive:1:7381b94e-4c9a-11ee-8aff-200db0c7aa5b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 完成任务-提出请假申请
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"holiday-inclusive:1:7381b94e-4c9a-11ee-8aff-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>经过包容网关后，act_ru_task 表中有两条待执行的任务 <font color="red">(如果num&gt;5则会有三条任务)</font>。<br> <img src="https://images2.imgbox.com/39/65/ZcglpxpC_o.png" alt="在这里插入图片描述"></p> 
<p><strong>②完成所有分支任务——王经理和李经理</strong>。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 完成任务-审批请假申请
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">complete2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"holiday-inclusive:1:7381b94e-4c9a-11ee-8aff-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"李经理"</span><span class="token punctuation">)</span> <span class="token comment">// 王经理和李经理</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>完成所有分支任务后，流程结束！<br> <img src="https://images2.imgbox.com/e9/3f/ZXMbpOo8_o.png" alt="在这里插入图片描述"></p> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="14__255"></a>1.4 事件网关</h3> 
<p>事件网关允许<strong>根据事件判断流向</strong>。网关的每个外出顺序流都要连接到一个中间捕获事件。当流程到达一个基于事件网关，网关会进入等待状态，会暂停执行。与此同时，会为每个外出顺序流创建相对的事件订阅。</p> 
<p>事件网关的外出顺序流和普通顺序流不同，这些顺序流不会真的 “执行”， 相反它们让流程引擎去决定执行到事件网关的流程需要订阅哪些事件。</p> 
<ul><li>事件网关必须有两条或以上外出顺序流；</li><li>事件网关后，只能使用 <code>intermediateCatchEvent</code> 类型（activiti 不支持基于事件网关后连接 ReceiveTask）</li><li>连接到事件网关的中间捕获事件必须只有一个入口顺序流。</li></ul> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h2><a id="_267"></a>二、事件</h2> 
<p>事件 (event) 通常用于为流程生命周期中发生的事情建模。事件总是图形化为圆圈。在 BPMN 2.0 中，有两种主要的事件分类：<code>捕获 (catching)</code> 与<code>抛出 (throwing)</code> 事件。</p> 
<ul><li><strong>捕获</strong>: 当流程执行到达这个事件时，会等待直到触发器动作。触发器的类型由其中的图标，或者说XML中的类型声明而定义。捕获事件与抛出事件显示上的区别，是其内部的图标没有填充（即是白色的）。</li><li><strong>抛出</strong>: 当流程执行到达这个事件时，会触发一个触发器。触发器的类型，由其中的图标，或者说XML中的类型声明而定义。抛出事件与捕获事件显示上的区别，是其内部的图标填充为黑色。</li></ul> 
<p><img src="https://images2.imgbox.com/ff/2d/UT9iVs07_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="21__277"></a>2.1 定时器事件</h3> 
<pre><code class="prism language-yaml"><span class="token key atrule">flowable</span><span class="token punctuation">:</span>
  <span class="token key atrule">async-executor-activate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启定时任务</span>
</code></pre> 
<h4><a id="211__282"></a>2.1.1 定时器启动事件</h4> 
<p>定时器启动事件（timer start event）在指定时间创建流程实例。在流程只需要启动一次，或者流程需要在特定的时间间隔重复启动时，都可以使用。</p> 
<p><strong>注意</strong>：</p> 
<ul><li>子流程不能有定时器启动事件。</li><li>定时器启动事件，<strong>在流程部署的同时就开始计时</strong>。不需要调用 <code>startProcessInstanceByXXX</code> 就会在时间启动。调用 <code>startProcessInstanceByXXX</code> 时会在定时启动之外额外启动一个流程。</li><li>当部署带有定时器启动事件的流程的更新版本时，上一版本的定时器作业会被移除。这是因为通常并不希望旧版本的流程仍然自动启动新的流程实例。</li></ul> 
<p>定时器启动事件，用其中有一个钟表图标的圆圈来表示。<br> <img src="https://images2.imgbox.com/18/d8/WlIvlkb5_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8d/7f/fvjCsv00_o.png" alt="在这里插入图片描述"></p> 
<p>我们只需要部署该流程，没有启动流程实例的情况下，到 15:20:30 时自动帮助我们创建了一个流程实例。</p> 
<h4><a id="212__296"></a>2.1.2 中间计时器捕获事件</h4> 
<p>当第一个人工处理完成后，第二个人工处理的任务需要在 2023-09-07T15:20:30 之后执行。<br> <img src="https://images2.imgbox.com/95/69/xdYAR16R_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f1/cb/8yWa3SsJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/23/f4/z6RLzW2I_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="213__301"></a>2.1.3 边界计时器事件</h4> 
<p><strong>注意</strong>：边界计时器事件也分为中断和非中断，<strong>默认是中断事件</strong>。设置了属性 <code>cancelActivity="false"</code> 的时候为非中断事件。</p> 
<ul><li><font color="red">中断事件是中断当前的活动沿着事件触发</font>。<br> 人工处理1如果在定义的 dueDate 这个时间之前还没有处理，那么就会触发定时边界事件进入人工处理3，而人工处理1和2就不执行了。<br> <img src="https://images2.imgbox.com/c7/85/RFWr98jW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e4/f1/i4jGwBTC_o.png" alt="在这里插入图片描述"></li><li><font color="orang">非中断事件是不影响当前活动，并沿着事件触发</font>。<br> 人工处理1如果在定义的 dueDate 这个时间之前还没有处理，那么就会触发定时边界事件进入人工处理3，但不影响原本人工处理1和2的执行流程，相当于可以走两条分支。<br> <img src="https://images2.imgbox.com/a7/93/R9KWMl0P_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dc/95/WnqaQ9CK_o.png" alt="在这里插入图片描述"></li></ul> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="22__315"></a>2.2 消息事件</h3> 
<p>消息事件 (message event)，是指引用具名消息的事件。消息具有名字与载荷。与信号不同，消息事件只有一个接收者。</p> 
<h4><a id="221__317"></a>2.2.1 消息启动事件</h4> 
<p>消息启动事件，也就是我们通过接收到某些消息后来启动流程实例，比如接收到了一封邮件，一条短信等。<br> <img src="https://images2.imgbox.com/b1/07/BoB62X5H_o.png" alt="在这里插入图片描述"></p> 
<p><strong>①我们先定义一个消息</strong>。<br> <img src="https://images2.imgbox.com/95/32/JOd9XMjX_o.png" alt="在这里插入图片描述"></p> 
<p><strong>②然后在消息开始节点出引用</strong>。<br> <img src="https://images2.imgbox.com/18/df/FSjyWeEC_o.png" alt="在这里插入图片描述"></p> 
<p><strong>③部署后，通过发送消息来启动流程实例</strong>。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">runProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token comment">//    runtimeService.startProcessInstanceById("message-event:1:a161b852-4d5c-11ee-892c-200db0c7aa5b");</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceByMessage</span><span class="token punctuation">(</span><span class="token string">"第一个消息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>发送消息后，可以发现 act_ru_task 中有了一条任务，说明流程实例成功启动了。<br> <img src="https://images2.imgbox.com/6e/8b/DhAdpiM5_o.png" alt="在这里插入图片描述"></p> 
<p><strong>注意</strong>：发送消息发送的应该是消息的名称而不是消息的ID。如果名称错误，就会出现以下报错：<br> <img src="https://images2.imgbox.com/0a/02/BuAZPYj0_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="222__342"></a>2.2.2 中间消息捕获事件</h4> 
<p>消息中间事件就是在流程运作中需要消息来触发的场景，案例演示，<code>用户任务1</code>处理完成后，需要接收特定的消息之后才能进入到 <code>用户任务2</code> 中。<br> <img src="https://images2.imgbox.com/4d/06/JT9rxZYV_o.png" alt="在这里插入图片描述"></p> 
<p>①启动流程实例，完成用户任务1</p> 
<pre><code class="prism language-java"><span class="token comment">// 启动流程实例</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">runProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceById</span><span class="token punctuation">(</span><span class="token string">"message-event:1:4ed49371-4d5f-11ee-b5d5-200db0c7aa5b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 完成任务</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span><span class="token string">"message-event:1:4ed49371-4d5f-11ee-b5d5-200db0c7aa5b"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此时，用户任务1执行完成了，act_ru_task 表中没有任务信息。<br> <img src="https://images2.imgbox.com/ca/14/OAfxixYp_o.png" alt="在这里插入图片描述"></p> 
<p>②发布消息，触发中间事件。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 中间事件-发布消息
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">recevedMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 需要拿到流程实例的执行编号</span>
    <span class="token class-name">String</span> executionId <span class="token operator">=</span> <span class="token string">"69a61d4d-4d5f-11ee-be8d-200db0c7aa5b"</span><span class="token punctuation">;</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">messageEventReceived</span><span class="token punctuation">(</span><span class="token string">"第一个消息"</span><span class="token punctuation">,</span> executionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此时，通过了中间事件，act_ru_task 表中有了第二条任务信息。<br> <img src="https://images2.imgbox.com/1a/1c/iQTgxvhv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="223__386"></a>2.2.3 边界消息事件</h4> 
<p>如果在消息触发时，用户任务1还没有完成，则会触发边界消息事件后执行用户任务3，而用户任务1和2就不执行了。<br> <img src="https://images2.imgbox.com/04/5c/y0oqOiwt_o.png" alt="在这里插入图片描述"></p> 
<p>①当部署流程和启动实例后，等待执行用户任务1。<br> <img src="https://images2.imgbox.com/7e/8d/WYLsLR2H_o.png" alt="在这里插入图片描述"></p> 
<p>②当触发边界事件时，直接走了用户任务3的方向。<br> <img src="https://images2.imgbox.com/ff/47/QYKaiU4F_o.png" alt="在这里插入图片描述"></p> 
<p><strong>注意</strong>：这里的 executionId 一定是边界事件所在流程分支的实例ID。(只有在用户任务1的节点且未完成的情况下，才可以触发边界事件)</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">recevedMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 需要拿到流程实例的执行编号</span>
    <span class="token class-name">String</span> executionId <span class="token operator">=</span> <span class="token string">"5f44e48e-4d65-11ee-b739-200db0c7aa5b"</span><span class="token punctuation">;</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">messageEventReceived</span><span class="token punctuation">(</span><span class="token string">"第一个消息"</span><span class="token punctuation">,</span> executionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/25/dc/mMhpzyap_o.png" alt="在这里插入图片描述"></p> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="23__410"></a>2.3 错误事件</h3> 
<p>错误事件可以用做一个流程的开始事件或者作为一个任务或者子流程的边界事件，错误事件没有提供作用中间事件的功能，这一点和前面介绍的定时器事件和消息事件还有区别的。</p> 
<h4><a id="231__412"></a>2.3.1 异常启动事件</h4> 
<p>错误启动事件（error start event），可用于触发事件子流程（Event Sub-Process）。<strong>错误启动事件不能用于启动流程实例</strong>。错误启动事件总是中断。</p> 
<p><strong>两种方式触发错误开始事件的方式</strong>：</p> 
<ul><li>错误结束事件抛出错误（注：错误结束事件也选择的是同一个错误定义）</li><li>自动执行主流程的服务任务抛出错误，接下来子流程的错误开始事件捕获到错误后执行。</li></ul> 
<p><img src="https://images2.imgbox.com/40/61/8E20pGUv_o.png" alt="在这里插入图片描述"></p> 
<p>①在 FlowableUI 中没找到错误定义的选项，所以我们需要在流程文件中自己添加，并绑定错误事件。<br> <img src="https://images2.imgbox.com/a2/d4/huUpO34N_o.png" alt="在这里插入图片描述"></p> 
<p>②创建服务任务的执行类。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyOneDelegate</span> <span class="token keyword">implements</span> <span class="token class-name">JavaDelegate</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">DelegateExecution</span> delegateExecution<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 休眠10秒看效果</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"自动完成服务任务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 此处的errorCode和定义的error中的errorCode一致</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BpmnError</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>③部署并启动流程实例后，act_ru_task 表中还是空的，因为主流程中没有用户任务，此时正在自动执行服务任务。<br> <img src="https://images2.imgbox.com/fa/98/UsmCTQDs_o.png" alt="在这里插入图片描述"></p> 
<p>④当服务任务抛出异常后，触发了子流程的异常启动事件，可以从 act_ru_task 和 act_ru_actinst 表中可以看出整个过程。<br> <img src="https://images2.imgbox.com/4f/60/LDTyzL1D_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/11/2f/OUzDxLyk_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="232__447"></a>2.3.2 结束错误事件</h4> 
<p>接下来我们以第一种触发错误开始事件的方式为例讲解，需要在错误结束事件和异常启动事件上绑定同一个错误：<br> <img src="https://images2.imgbox.com/ab/e5/hBr66bnu_o.png" alt="在这里插入图片描述"></p> 
<p>在 FlowableUI 中没找到错误定义的选项，所以我们需要在流程文件中自己添加。<br> <img src="https://images2.imgbox.com/31/d4/vygtMUsH_o.png" alt="在这里插入图片描述"></p> 
<p>当我们启动流程实例时，act_ru_task 表中有一条任务等待执行。<br> <img src="https://images2.imgbox.com/02/33/MYTG9R1k_o.png" alt="在这里插入图片描述"></p> 
<p>当主流程任务执行完，走向了结束错误事件，从而触发了子流程的异常启动事件。<br> <img src="https://images2.imgbox.com/fa/d0/tDpGjW6a_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="233__460"></a>2.3.3 边界错误事件</h4> 
<p><img src="https://images2.imgbox.com/b6/9d/edbCyfLw_o.png" alt="在这里插入图片描述"></p> 
<p>当子流程中没有发生特定错误时，不会触发边界错误事件，流程会走向用户任务1。<br> <img src="https://images2.imgbox.com/55/7f/GIvoemD7_o.png" alt="在这里插入图片描述"></p> 
<p>当子流程中发生特定错误时，会触发边界错误事件，流程会走向用户任务2。<br> <img src="https://images2.imgbox.com/73/30/dRhmdnZA_o.png" alt="在这里插入图片描述"></p> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="24__471"></a>2.4 信号事件</h3> 
<h4><a id="241__472"></a>2.4.1 信号启动事件</h4> 
<p><img src="https://images2.imgbox.com/55/cf/lHgRwYGM_o.png" alt="在这里插入图片描述"><br> 自定义信号，并绑定到信号启动事件上。<br> <img src="https://images2.imgbox.com/64/c7/mWBAIEnp_o.png" alt="在这里插入图片描述"></p> 
<p>通过释放对应的信号来触发流程的启动。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">runProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    runtimeService<span class="token punctuation">.</span><span class="token function">signalEventReceived</span><span class="token punctuation">(</span><span class="token string">"第一个信号"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4a/7b/hc2k4TDp_o.png" alt="在这里插入图片描述"></p> 
<p><strong>注意</strong>：我们可以把信息的作用域由原来的 <code>golbal</code> 全局的调整为 <code>processInstance</code>，测试后发现还是可以执行，说明在启动事件中信号的作用域是不起作用的。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>signal</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>signal01<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>第一个信号<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">flowable:</span>scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>global<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>signal</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>signal</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>signal01<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>第一个信号<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">flowable:</span>scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>processInstance<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>signal</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="242__494"></a>2.4.2 中间信号捕获事件</h4> 
<p>当我们启动事件后，会阻塞在这个消息获取中间事件处，等待相关信号后才会继续流转。<br> <img src="https://images2.imgbox.com/e1/2d/lpJWoXQS_o.png" alt="在这里插入图片描述"></p> 
<p>此时，对于两种信号作用域需要分情况讨论：</p> 
<p>1、当定义的信号作用域为 <code>global</code> 时，我们发送 global 信号就可以捕获。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    runtimeService<span class="token punctuation">.</span><span class="token function">signalEventReceived</span><span class="token punctuation">(</span><span class="token string">"第一个信号"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2、当定义的信号作用域为 <code>processInstance</code> 时，我们发送 global 信号就不会被捕获，而是需要我们在流程实例内部抛出信号。</p> 
<h4><a id="243__510"></a>2.4.3 中间信号抛出事件</h4> 
<p>信号中间抛出事件也就是在流程执行中的某个节点抛出了对应的信号，然后对应的信号中间捕获事件就会触发。<br> <img src="https://images2.imgbox.com/b0/9d/m7s01pbD_o.png" alt="在这里插入图片描述"></p> 
<p>我们将信号的作用域定义为 <code>processInstance</code> 的，并且将这两个事件引用同一个信号。来查看该作用域的信号如何被捕获？</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span>signal id<span class="token operator">=</span><span class="token string">"signal01"</span> name<span class="token operator">=</span><span class="token string">"第一个信号"</span> flowable<span class="token operator">:</span>scope<span class="token operator">=</span><span class="token string">"processInstance"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>signal<span class="token operator">&gt;</span>
</code></pre> 
<p>①当启动流程后，通过并行网关产生两条分支，第一条分支有一个待执行的任务，第二条分支需要等待捕获信号。<br> <img src="https://images2.imgbox.com/04/c4/Ig9mNovW_o.png" alt="在这里插入图片描述"></p> 
<p>②当执行完任务1时，触发了该分支上的信号抛出事件，抛出的信号被第二条分支的信号捕获事件所捕获，成功走向的任务2的节点。<br> <img src="https://images2.imgbox.com/42/34/PUf6cJdr_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="244__525"></a>2.4.4 边界信号事件</h4> 
<p><img src="https://images2.imgbox.com/98/b3/72RNhYdP_o.png" alt="在这里插入图片描述"><br> ①启动流程后，走到了用户任务1，等待执行或等待信号。<br> <img src="https://images2.imgbox.com/ef/2f/b1xPzBm2_o.png" alt="在这里插入图片描述"><br> ②捕获到了信号，走向了用户任务3，不用再执行任务1和2了。<br> <img src="https://images2.imgbox.com/aa/7b/ZbbiFBGz_o.png" alt="在这里插入图片描述"></p> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="25__534"></a>2.5 结束事件</h3> 
<h4><a id="251__535"></a>2.5.1 结束错误事件</h4> 
<p>当流程执行到达**错误结束事件（error end event）**时，结束执行的当前分支，并抛出错误。这个错误可以由匹配的错误边界中间事件捕获。如果找不到匹配的错误边界事件，将会抛出异常。<br> <img src="https://images2.imgbox.com/7e/2d/sLop9nSr_o.png" alt="在这里插入图片描述"></p> 
<ol><li>启动流程实例后，走到了用户任务1的节点，等待执行。执行时需要传递 num 变量，以决定后续的走向。</li><li>携带 num 通过排他网关： 
  <ul><li>如果 num=0，则子流程正常结束，接下来会走到用户任务2的节点。</li><li>如果 num&gt;0，则子流程触发结束错误事件。并且被边界错误事件所捕获，最终走到了用户任务3的节点。</li><li>如果 num&lt;0，则子流程异常报错，流程不会结束，异常也不会被捕获。</li></ul> </li><li>错误结束事件的作用就是在执行到错误结束的节点位置会抛出对应的错误，供需要获取的事件来处理。</li></ol> 
<h4><a id="252__545"></a>2.5.2 结束终止事件</h4> 
<p>终止结束事件主要是对流程进行终止的事件，可以在一个复杂的流程中，如果某方想要提前中断这个流程，可以采用这个事件来处理，可以在并行处理任务中。</p> 
<ul><li> <p>如果你是在流程实例层处理，整个流程都会被中断。<br> <img src="https://images2.imgbox.com/bd/c1/TeY4QdUk_o.png" alt="在这里插入图片描述"></p> </li><li> <p>如果是在子流程中使用，那么当前作用和作用域内的所有的内部流程都会被终止，但是不会终止整个流程。<br> <img src="https://images2.imgbox.com/43/b0/SIUQcLuP_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h4><a id="253__553"></a>2.5.3 结束取消事件</h4> 
<p>取消结束事件 (cancel end event) 只能与 BPMN 事务子流程 (BPMN transaction subprocess) 一起使用。当到达取消结束事件时，会抛出取消事件，且必须由取消边界事件 (cancel boundary event) 捕获。取消边界事件将取消事务，并触发补偿 (compensation)。</p> 
<p>结束取消事件我们只能在<strong>事务子流程</strong>中使用，在 FlowableUI 中暂时没有找到这个组件，所以在 Eclipse 中来绘制。<br> <img src="https://images2.imgbox.com/5a/56/4hLEdENK_o.png" alt="在这里插入图片描述"></p> 
<ol><li>流程中定义了一个事务子流程和<strong>两个自动服务任务</strong>。事务子流程中定义了两个人工任务用一个排他网关连接，<code>flag&lt;=0</code> 的情况下会触发<strong>结束取消事件</strong>。</li><li>触发结束取消事件后，会被<strong>边界取消事件</strong>所捕获，从而执行外部的<strong>自动取消服务</strong>。</li><li>同时也会触发<strong>边界补偿事件</strong>，从而执行<strong>自动补偿服务</strong>。</li></ol> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<h3><a id="26__566"></a>2.6 补偿事件</h3> 
<p>通过补偿达到控制业务流程的目的就是补偿事件，比如我们正常的买机票的流程下订单购买，然后同时弹出支付流程页面。支付成功后就可以等待出票了，但是如果我们支付失败的话，这时要么重新支付，更换支付方式或者取消预订，这时取消预订就可以通过补偿事件来实现。</p> 
<p>我们以下面的例子学习边界补偿事件和中间补偿投掷事件的使用：<br> <img src="https://images2.imgbox.com/de/f3/RocByjl4_o.png" alt="在这里插入图片描述"></p> 
<p><strong>预定机票的服务类</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlaceOrderDelegate</span> <span class="token keyword">implements</span> <span class="token class-name">JavaDelegate</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">DelegateExecution</span> delegateExecution<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : 正在预定机票中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>微信支付的服务类</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WechatPayDelegate</span> <span class="token keyword">implements</span> <span class="token class-name">JavaDelegate</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">DelegateExecution</span> delegateExecution<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : 微信支付中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> error <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : 微信支付失败！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BpmnError</span><span class="token punctuation">(</span><span class="token string">"支付失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>取消预订的服务类</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeleteOrderDelegate</span> <span class="token keyword">implements</span> <span class="token class-name">JavaDelegate</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">DelegateExecution</span> delegateExecution<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : 正在取消订单"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>我们直接部署启动，整个流程执行的过程</strong>：</p> 
<ol><li>任务开始后会并行的执行<strong>机票预订</strong>和<strong>微信支付</strong>，然后在微信支付是抛出 pay-error 错误，同时<strong>错误边界事件</strong>会捕获到这个错误。</li><li>然后执行到<strong>中间补偿投掷事件</strong>，之后在机票预订的 <strong>边界补偿事件</strong> 被触发，对应的补偿触发器会执行对应的代码。</li></ol> 
<p><strong>执行结果</strong>：<br> <img src="https://images2.imgbox.com/b9/43/EKNjJY8A_o.png" alt="在这里插入图片描述"></p> 
<p><a href="#mulu" rel="nofollow">回到目录…</a></p> 
<hr> 
<p><strong>总结</strong>:<br> <font color="#999AAA">提示：这里对文章进行总结：<br> 本文是对flowable的学习，学习了排他、并行、包含、事件这四种网关的使用，并且对事件进行了详细的学习和案例讲解，如定时器事件、消息事件、错误事件、信号事件和结束事件。之后的学习内容将持续更新！！！</font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/48342c1132c3bd80f97d14ed768687b1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">将Excel数据读取后存入Redis， 多线程操作</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/38af4fe1ef33097bd308e57ce732d408/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android RIL介绍</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>