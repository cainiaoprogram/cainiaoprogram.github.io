<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Horizon学习笔记 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Horizon学习笔记" />
<meta property="og:description" content="Horizon吊炸天！之前，一直认为horizon只不过是一个面板，没啥好研究的，而且我对django又不是很熟，一直懒的看horizon，今晚硬着头皮看了下去，没想到，越看越有劲，眼睛差点跟不上我的思路了！我觉得horizon牛不在对django的运用，而是对事物高度的抽象能力:D
程序的入口点在horizon/openstack_dashboard/urls.py中：
url(r&#39;&#39;, include(horizon.urls)) 然后由Horizon这个单例的Site对象，开始加载urls，自动发现并注册dashboard，然后对每一个dashboard，再自动发现并注册panel:
Horizon._lazy_url 程序的入口看起来那么平常不过，进入之后发现这大千世界，让人惊叹不已!!!
可以在horizon/base/_urls()方法中，一窥全貌：
``` def _urls(self): &#34;&#34;&#34;Constructs the URLconf for Horizon from registered Dashboards.&#34;&#34;&#34; urlpatterns = self._get_default_urlpatterns() self._autodiscover() # 自动发现并注册dashboard，其实就是从INSTALL_APPS中加载dashboard # Discover each dashboard&#39;s panels. for dash in self._registry.values(): dash._autodiscover() # 自动发现并注册panel，这个是根据路径来发现的 # Allow for override modules if self._conf.get(&#34;customization_module&#34;, None): customization_module = self._conf[&#34;customization_module&#34;] bits = customization_module.split(&#39;.&#39;) mod_name = bits.pop() package = &#39;.&#39;.join(bits) mod = import_module(package) try: before_import_registry = copy.copy(self._registry) import_module(&#39;%s.%s&#39; % (package, mod_name)) except Exception: self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/62b256d4be92da2bed455ad08e9758bd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2014-05-16T00:52:55+08:00" />
<meta property="article:modified_time" content="2014-05-16T00:52:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Horizon学习笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>Horizon吊炸天！之前，一直认为horizon只不过是一个面板，没啥好研究的，而且我对django又不是很熟，一直懒的看horizon，今晚硬着头皮看了下去，没想到，越看越有劲，眼睛差点跟不上我的思路了！我觉得horizon牛不在对django的运用，而是对事物高度的抽象能力:D</p> 
<p><br> </p> 
<p>程序的入口点在horizon/openstack_dashboard/urls.py中：</p> 
<pre><code class="language-python">url(r'', include(horizon.urls))</code></pre> 
<p><br> </p> 
<p>然后由Horizon这个单例的Site对象，开始加载urls，自动发现并注册dashboard，然后对每一个dashboard，再自动发现并注册panel:</p> 
<pre><code class="language-python">Horizon._lazy_url</code></pre> 
<br> 
<p>程序的入口看起来那么平常不过，进入之后发现这大千世界，让人惊叹不已!!!</p> 
<p><br> </p> 
<p><img src="https://images2.imgbox.com/f1/4d/6XMt6mFH_o.png" alt=""><br> </p> 
<p><br> </p> 
<p>可以在horizon/base/_urls()方法中，一窥全貌：<br> </p> 
<pre><code class="language-python">```
    def _urls(self):  
        """Constructs the URLconf for Horizon from registered Dashboards."""
        urlpatterns = self._get_default_urlpatterns()
        self._autodiscover() # 自动发现并注册dashboard，其实就是从INSTALL_APPS中加载dashboard
        
        # Discover each dashboard's panels.
        for dash in self._registry.values():
            dash._autodiscover()  # 自动发现并注册panel，这个是根据路径来发现的
            
        # Allow for override modules
        if self._conf.get("customization_module", None):
            customization_module = self._conf["customization_module"]
            bits = customization_module.split('.')
            mod_name = bits.pop()
            package = '.'.join(bits)
            mod = import_module(package)
            try: 
                before_import_registry = copy.copy(self._registry)
                import_module('%s.%s' % (package, mod_name))
            except Exception:
                self._registry = before_import_registry
                if module_has_submodule(mod, mod_name):
                    raise
                 
        # Compile the dynamic urlconf.
        for dash in self._registry.values():
            urlpatterns += patterns('',
                    url(r'^%s/' % dash.slug, include(dash._decorated_urls)))
                    
        # Return the three arguments to django.conf.urls.defaults.include
        return urlpatterns, self.namespace, self.slug
```</code></pre> 
<br> 默认的，一个HorizonSite中有三个Dashboard: project, admin, setting，在HorizonSite的autodiscover过程中，注册在HorizonSite中： 
<br> 
<pre><code class="language-python">```
(Pdb) pp self._registry
{&lt;class 'openstack_dashboard.dashboards.project.dashboard.Project'&gt;: &lt;Dashboard: project&gt;,
 &lt;class 'openstack_dashboard.dashboards.admin.dashboard.Admin'&gt;: &lt;Dashboard: admin&gt;,
 &lt;class 'openstack_dashboard.dashboards.settings.dashboard.Settings'&gt;: &lt;Dashboard: settings&gt;}
```</code></pre> 
<br> 然后再对每一个Dashboard进行autodiscover，将Panel注册在Dashboard中，从上面的类图中可以看到Dashboard和HorizonSite都是Registry的子类，它们都具有**注册**的能力： 
<br> 
<pre><code class="language-python">```
(Pdb) pp self._registry.values()[0]._registry
{&lt;class 'openstack_dashboard.dashboards.project.overview.panel.Overview'&gt;: &lt;Panel: overview&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.containers.panel.Containers'&gt;: &lt;Panel: containers&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.instances.panel.Instances'&gt;: &lt;Panel: instances&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.network_topology.panel.NetworkTopology'&gt;: &lt;Panel: network_topology&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.images_and_snapshots.panel.ImagesAndSnapshots'&gt;: &lt;Panel: images_and_snapshots&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.networks.panel.Networks'&gt;: &lt;Panel: networks&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.access_and_security.panel.AccessAndSecurity'&gt;: &lt;Panel: access_and_security&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.firewalls.panel.Firewall'&gt;: &lt;Panel: firewalls&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.volumes.panel.Volumes'&gt;: &lt;Panel: volumes&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.routers.panel.Routers'&gt;: &lt;Panel: routers&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.loadbalancers.panel.LoadBalancer'&gt;: &lt;Panel: loadbalancers&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.vpn.panel.VPN'&gt;: &lt;Panel: vpn&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.database_backups.panel.Backups'&gt;: &lt;Panel: database_backups&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.stacks.panel.Stacks'&gt;: &lt;Panel: stacks&gt;,
 &lt;class 'openstack_dashboard.dashboards.project.databases.panel.Databases'&gt;: &lt;Panel: databases&gt;}
```</code></pre> 
<br> 在注册每一个Panel的时候，还会将每一个Panel的template路径，保存到loaders模块中： 
<br> 
<pre><code class="language-python">```
(Pdb) pp loaders.panel_template_dirs
{'admin/defaults': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/defaults/templates',
 'admin/flavors': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/flavors/templates',
 'admin/hypervisors': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/hypervisors/templates',
 'admin/images': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/images/templates',
 'admin/info': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/info/templates',
 'admin/instances': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/instances/templates',
 'admin/metering': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/metering/templates',
 'admin/networks': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/networks/templates',
 'admin/overview': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/overview/templates',
 'admin/projects': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/projects/templates',
 'admin/routers': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/routers/templates',
 'admin/users': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/users/templates',
 'admin/volumes': '/opt/stack/horizon/openstack_dashboard/dashboards/admin/volumes/templates',
 'project/access_and_security': '/opt/stack/horizon/openstack_dashboard/dashboards/project/access_and_security/templates',
 'project/containers': '/opt/stack/horizon/openstack_dashboard/dashboards/project/containers/templates',
 'project/database_backups': '/opt/stack/horizon/openstack_dashboard/dashboards/project/database_backups/templates',
 'project/databases': '/opt/stack/horizon/openstack_dashboard/dashboards/project/databases/templates',
 'project/firewalls': '/opt/stack/horizon/openstack_dashboard/dashboards/project/firewalls/templates',
 'project/images_and_snapshots': '/opt/stack/horizon/openstack_dashboard/dashboards/project/images_and_snapshots/templates',
 'project/instances': '/opt/stack/horizon/openstack_dashboard/dashboards/project/instances/templates',
 'project/loadbalancers': '/opt/stack/horizon/openstack_dashboard/dashboards/project/loadbalancers/templates',
 'project/network_topology': '/opt/stack/horizon/openstack_dashboard/dashboards/project/network_topology/templates',
 'project/networks': '/opt/stack/horizon/openstack_dashboard/dashboards/project/networks/templates',
 'project/overview': '/opt/stack/horizon/openstack_dashboard/dashboards/project/overview/templates',
 'project/routers': '/opt/stack/horizon/openstack_dashboard/dashboards/project/routers/templates',
 'project/stacks': '/opt/stack/horizon/openstack_dashboard/dashboards/project/stacks/templates',
 'project/volumes': '/opt/stack/horizon/openstack_dashboard/dashboards/project/volumes/templates',
 'project/vpn': '/opt/stack/horizon/openstack_dashboard/dashboards/project/vpn/templates',
 'settings/password': '/opt/stack/horizon/openstack_dashboard/dashboards/settings/password/templates',
 'settings/user': '/opt/stack/horizon/openstack_dashboard/dashboards/settings/user/templates'}
```
</code></pre> 
<br> 接下来就是最关键的urlpatterns，整个horizon所有的路径，并不是写到一个url.py文件中的，而是分散在每一个dashboard, 每一个panel中，有层级的关系。首先找dashboard的url，到每一个dashboard，再找每一个panel的url，所以url的路径关系为: ./dashboard/panel 
<br> 
<pre><code class="language-python">urlpatterns in site:
```
(Pdb) pp urlpatterns
[&lt;RegexURLPattern user_home ^home/$&gt;,
 &lt;RegexURLPattern jsi18n ^i18n/js/(?P&lt;packages&gt;\S+?)/$&gt;,
 &lt;RegexURLPattern set_language ^i18n/setlang/$&gt;,
 &lt;RegexURLResolver &lt;module 'django.conf.urls.i18n' from '/usr/local/lib/python2.7/dist-packages/django/conf/urls/i18n.pyc'&gt; (None:None) ^i18n/&gt;,
 &lt;RegexURLPattern qunit_tests ^qunit/$&gt;,
 &lt;RegexURLResolver &lt;RegexURLResolver list&gt; (admin:admin) ^admin/&gt;,
 &lt;RegexURLResolver &lt;RegexURLResolver list&gt; (settings:settings) ^settings/&gt;,
 &lt;RegexURLResolver &lt;RegexURLResolver list&gt; (project:project) ^project/&gt;]
```


urlpatterns in dashboard
```
(Pdb) pp urlpatterns[-1].urlconf_name
[&lt;RegexURLResolver &lt;RegexURLPattern list&gt; (instances:instances) ^instances/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (routers:routers) ^routers/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (databases:databases) ^databases/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (firewalls:firewalls) ^firewalls/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (containers:containers) ^containers/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (access_and_security:access_and_security) ^access_and_security/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (network_topology:network_topology) ^network_topology/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (database_backups:database_backups) ^database_backups/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (loadbalancers:loadbalancers) ^loadbalancers/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (vpn:vpn) ^vpn/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (volumes:volumes) ^volumes/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (stacks:stacks) ^stacks/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (networks:networks) ^networks/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (images_and_snapshots:images_and_snapshots) ^images_and_snapshots/&gt;,
 &lt;RegexURLResolver &lt;RegexURLPattern list&gt; (overview:overview) &gt;]
```


urlpatterns in panel
```
(Pdb) pp urlpatterns[-1].urlconf_name[-1].urlconf_name
[&lt;RegexURLPattern index ^$&gt;, &lt;RegexURLPattern warning ^warning$&gt;]
```</code></pre> 
<br> 
<br> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a8df4538fc901d2b0c203a648f07bbbf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SQL Server 中日期比较</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a472c6c716d2b8080cafb9fe26f58f69/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">To &#34;windows mobile 5.0 pocket pc device&#34; connection failed 这个产品的配置数据已损坏,请与技术支持人员联系</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>