<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TensorFlow：tensorflow.keras.Model.fit（）报错： TypeError: Failed to convert elements of xxx - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="TensorFlow：tensorflow.keras.Model.fit（）报错： TypeError: Failed to convert elements of xxx" />
<meta property="og:description" content="一、问题 在使用TensorFlow进行数据训练的时候，报了下面这样的一个错误。
代码如下：
import tensorflow as tf from utilz import * import numpy as np acoustic = load_features(&#39;C:/Test/MSA Datasets/data/acoustic_wav2vec.pkl&#39;) label = load_features(&#39;C:/Test/MSA Datasets/data/labels.pkl&#39;) shapeReturn = np.shape(acoustic[&#39;train&#39;]) print(shapeReturn) x = tf.keras.layers.Input((128, 512)) h = tf.keras.layers.LSTM(32, dropout=0.5)(x) res = tf.keras.layers.Dense(3, &#39;softmax&#39;)(h) model = tf.keras.Model(inputs=x, outputs=res) # 问题出现在下面这一行 model.compile(optimizer=&#39;Adam&#39;, loss=tf.keras.losses.SparseCategoricalCrossentropy) model.summary() print(model.summary()) output_layer = model.layers[-1] print(output_layer.activation) callback_list = [tf.keras.callbacks.ModelCheckpoint(filepath=&#39;C:/Test/MSA Datasets/res_tmp/model.tf&#39;, monitor=&#39;val_loss&#39;, save_best_only=True, save_freq=&#39;epoch&#39;)] model.fit(x=np.asarray(acoustic[&#39;train&#39;]), y=np.asarray(label[&#39;train&#39;]), batch_size=16, epochs=30, validation_data=[np.asarray(acoustic[&#39;valid&#39;]), np.asarray(label[&#39;valid&#39;])], callbacks=callback_list) 报错如下：
Traceback (most recent call last): File &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7dc2ea885cfce9cd4e98d7994af16424/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-25T17:16:24+08:00" />
<meta property="article:modified_time" content="2023-08-25T17:16:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">TensorFlow：tensorflow.keras.Model.fit（）报错： TypeError: Failed to convert elements of xxx</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>一、问题</h3> 
<p>在使用<strong>TensorFlow</strong>进行数据训练的时候，报了下面这样的一个错误。</p> 
<p>代码如下：</p> 
<pre><code class="hljs">import tensorflow as tf
from utilz import *
import numpy as np

acoustic = load_features('C:/Test/MSA Datasets/data/acoustic_wav2vec.pkl')
label = load_features('C:/Test/MSA Datasets/data/labels.pkl')

shapeReturn = np.shape(acoustic['train'])
print(shapeReturn)

x = tf.keras.layers.Input((128, 512))
h = tf.keras.layers.LSTM(32, dropout=0.5)(x)
res = tf.keras.layers.Dense(3, 'softmax')(h)

model = tf.keras.Model(inputs=x, outputs=res)
# 问题出现在下面这一行
model.compile(optimizer='Adam', loss=tf.keras.losses.SparseCategoricalCrossentropy)
model.summary()
print(model.summary())
output_layer = model.layers[-1]
print(output_layer.activation)



callback_list = [tf.keras.callbacks.ModelCheckpoint(filepath='C:/Test/MSA Datasets/res_tmp/model.tf', monitor='val_loss', save_best_only=True, save_freq='epoch')]
model.fit(x=np.asarray(acoustic['train']), y=np.asarray(label['train']), batch_size=16, epochs=30,
          validation_data=[np.asarray(acoustic['valid']), np.asarray(label['valid'])],
          callbacks=callback_list)</code></pre> 
<p>报错如下：</p> 
<pre><code class="hljs">Traceback (most recent call last):
  File "E:\WorkSpace\1v6_code_fs\ser_exp.py", line 20, in &lt;module&gt;
    model.fit(x=np.asarray(acoustic['train']), y=np.asarray(label['train']), batch_size=16, epochs=30,     TypeError: Failed to convert elements of &lt;keras.src.losses.SparseCategoricalCrossentropy object at 0x000001BF851EF6D0&gt; to Tensor. Consider casting elements to a supported type. See https://www.tensorflow.org/api_docs/python/tf/dtypes for supported TF dtypes.</code></pre> 
<h3>二、原因</h3> 
<p>从错误信息来看，问题似乎与损失函数的定义有关。错误提示<strong> <code>SparseCategoricalCrossentropy</code></strong> 对象无法转换为<strong> Tensor</strong>。</p> 
<p>首先，确保你正确地实例化了 <strong><code>SparseCategoricalCrossentropy</code></strong>。当你在<strong> <code>model.compile</code> </strong>中设置损失函数时，确保你是这样做的：</p> 
<pre><code class="hljs">loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True)
</code></pre> 
<p>或者：</p> 
<pre><code class="hljs">loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=False)
</code></pre> 
<p> 其中 <strong><code>from_logits</code> </strong>参数取决于你的模型输出是否已经经过 <strong>softmax </strong>激活。如果模型的输出层使用了 <strong>softmax </strong>激活函数，则 <strong><code>from_logits</code> </strong>应设置为 <strong><code>False</code></strong>。否则，设置为 <strong><code>True</code></strong>。</p> 
<h3>三、如何检查模型的输出层使用了 <strong>softmax </strong>激活函数</h3> 
<ol><li><strong>使用模型的 summary 方法</strong>: <code>model.summary()</code> 会打印模型的所有层及其详细信息。你可以查看输出层的激活函数。 <pre><code class="hljs">print(model.summary())
</code></pre> <p></p> </li><li> <p><strong>直接检查输出层的激活属性</strong>: 如果你知道模型的输出层的索引或名称，你可以直接检查其激活属性。</p> <p>例如，如果输出层是模型的最后一层，你可以这样做：</p> <pre><code class="hljs">output_layer = model.layers[-1]
print(output_layer.activation)
</code></pre> <p>如果输出是 <code>softmax</code>，那么你应该会看到类似 <code>&lt;function softmax at 0x7f...&gt;</code> 的输出。</p> </li><li> <p>我这里代码检查的结果是使用了softmax。</p> <pre><code class="hljs">&lt;function softmax at 0x00000248078FC940&gt;</code></pre> </li><li> <p>那么上面的值就要设置为False。</p> <pre><code class="hljs">model.compile(optimizer='Adam', loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=False))
</code></pre> <p></p> </li></ol> 
<p>再跑代码的话，就成功解决了问题。 </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/891a15b742d8429ea645c8767f047f98/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何区分ChatGPT4.0对比3.5</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8b357777e9fb58ebeb484c19ed2c7c0a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">新手云服务器上搭建个人网站&#43;数据库（宝塔面板）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>