<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>邮件：事务失败。 服务器响应为:DT:SPM 163 smtp - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="邮件：事务失败。 服务器响应为:DT:SPM 163 smtp" />
<meta property="og:description" content="几年前我做的一个项目，日发邮件最高峰时几十万。自以为对邮件发送方面已经有了一定认识，所以近期机缘巧合之下，又有项目需要发送邮件，不禁自信满满，暗自庆幸能不手到擒来乎？
不想老革命遇到新问题。我原先的邮件发送机制，是生成eml文件，然后扔到windows自带的smtp服务器的pickup目录下，系统即自动发送（见拙作：邮件发送一点心得）。
但今时今日，这些好像都是老皇历了。IIS7默认并没有SMTP，如果操作系统是server，还可以通过添加功能加上去，但WIN7就不行了。偏偏，我们的系统就部署在WIN7下。
我第一个应对之道是看WIN7能不能装那个自带的SMTP，结果是不行，死活没找到。
第二个办法是装个第三方的SMTP，找来找去，找到一个叫做什么FREE SMTP的，装上去以后，打开看，好像忒简单了点。根本没有啥PICK目录的，应该是只能通过代码，搞什么几次握手之类的方法来进行调用。我很烦这个东西。
最后，决定还是直接使用smtp.163.com。网上例子比比皆是。
public interface IEmail { bool Send(EmailParam param); string Mess { get; } } public class EmailParam { public string From { get; set; } public string To { get; set; }//接收人；多个邮箱用分号隔开 public string CC { get; set; }//抄送；多个邮箱用分号隔开 public string Subject { get; set; }//标题 public string Body { get; set; }//邮件正文 } public class Sender : IEmail { SmtpClient client; public Sender() { // &lt;add key=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1854e7532c7f6a9cdb2d7034f8389cd1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-01-03T19:21:14+08:00" />
<meta property="article:modified_time" content="2017-01-03T19:21:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">邮件：事务失败。 服务器响应为:DT:SPM 163 smtp</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>几年前我做的一个项目，日发邮件最高峰时几十万。自以为对邮件发送方面已经有了一定认识，所以近期机缘巧合之下，又有项目需要发送邮件，不禁自信满满，暗自庆幸能不手到擒来乎？</p> 
<p>不想老革命遇到新问题。我原先的邮件发送机制，是生成eml文件，然后扔到windows自带的smtp服务器的pickup目录下，系统即自动发送（见拙作：<a href="http://blog.csdn.net/leftfist/article/details/2078034">邮件发送一点心得</a>）。</p> 
<p>但今时今日，这些好像都是老皇历了。IIS7默认并没有SMTP，如果操作系统是server，还可以通过添加功能加上去，但WIN7就不行了。偏偏，我们的系统就部署在WIN7下。</p> 
<p>我第一个应对之道是看WIN7能不能装那个自带的SMTP，结果是不行，死活没找到。</p> 
<p>第二个办法是装个第三方的SMTP，找来找去，找到一个叫做什么FREE SMTP的，装上去以后，打开看，好像忒简单了点。根本没有啥PICK目录的，应该是只能通过代码，搞什么几次握手之类的方法来进行调用。我很烦这个东西。</p> 
<p>最后，决定还是直接使用smtp.163.com。网上例子比比皆是。</p> 
<pre class="prettyprint"><code class="language-C# hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> IEmail
{
    <span class="hljs-keyword">bool</span> Send(EmailParam param);
    <span class="hljs-keyword">string</span> Mess { <span class="hljs-keyword">get</span>; }
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> EmailParam
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> From { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> To { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<span class="hljs-comment">//接收人；多个邮箱用分号隔开</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> CC { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<span class="hljs-comment">//抄送；多个邮箱用分号隔开</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Subject { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<span class="hljs-comment">//标题</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Body { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<span class="hljs-comment">//邮件正文</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> Sender : IEmail
{
    SmtpClient client;
    <span class="hljs-keyword">public</span> <span class="hljs-title">Sender</span>()
    {
        <span class="hljs-comment">// &lt;add key="eml_host" value="smtp.163.com"/&gt;</span>
        <span class="hljs-comment">// &lt;add key="eml_account" value="chendaqu"/&gt;</span>
        <span class="hljs-comment">// &lt;add key="eml_pwd" value="1234abcd"/&gt;</span>
        <span class="hljs-keyword">string</span> host = ConfigurationManager.AppSettings[<span class="hljs-string">"eml_host"</span>];
        <span class="hljs-keyword">string</span> account = ConfigurationManager.AppSettings[<span class="hljs-string">"eml_account"</span>];
        <span class="hljs-keyword">string</span> pwd = ConfigurationManager.AppSettings[<span class="hljs-string">"eml_pwd"</span>];

        client = <span class="hljs-keyword">new</span> SmtpClient();
        client.Host = host;
        client.UseDefaultCredentials = <span class="hljs-keyword">false</span>;
        client.DeliveryMethod = SmtpDeliveryMethod.Network;
        client.Credentials = <span class="hljs-keyword">new</span> System.Net.NetworkCredential(account,pwd);
        client.Port = <span class="hljs-number">25</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Mess { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">Send</span>(EmailParam param)
    {
        MailMessage mail = <span class="hljs-keyword">new</span> MailMessage();

        mail.From = <span class="hljs-keyword">new</span> MailAddress(param.From);
        getCollection(mail.To,param.To);
        getCollection(mail.CC, param.CC);
        mail.Subject = param.Subject;
        mail.Body = param.Body;
        mail.SubjectEncoding = Encoding.UTF8;
        mail.BodyEncoding = Encoding.UTF8;
        mail.Priority = MailPriority.Normal;
        mail.IsBodyHtml = <span class="hljs-keyword">true</span>;
        mail.DeliveryNotificationOptions = DeliveryNotificationOptions.OnFailure;

        <span class="hljs-keyword">try</span>
        {
            client.Send(mail);
        }
        <span class="hljs-keyword">catch</span>(Exception ex)
        {
            Mess = ex.Message;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }
    MailAddressCollection getCollection(MailAddressCollection collection,<span class="hljs-keyword">string</span> arstring)
    {
        <span class="hljs-keyword">if</span> (!String.IsNullOrEmpty(arstring))
        {
            <span class="hljs-keyword">string</span>[] ar = arstring.Split(<span class="hljs-string">';'</span>);
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">string</span> item <span class="hljs-keyword">in</span> ar)
            {
                <span class="hljs-keyword">if</span> (String.IsNullOrEmpty(item)) <span class="hljs-keyword">continue</span>;
                collection.Add(item);
            }
        }
        <span class="hljs-keyword">return</span> collection;
    }
}</code></pre> 
<p>使用单元测试进行调用：</p> 
<pre class="prettyprint"><code class="language-C# hljs cs">[TestMethod()]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendTest</span>()
{
    IEmail sender = <span class="hljs-keyword">new</span> Sender();

    <span class="hljs-keyword">bool</span> ok = sender.Send(<span class="hljs-keyword">new</span> EmailParam()
    {
        Subject = <span class="hljs-string">"邮件测试7"</span>,
        Body = <span class="hljs-string">"Hello World!"</span>,
        From = <span class="hljs-string">"chendaqu@163.com"</span>,
        To = <span class="hljs-string">"178879771@qq.com;461198190@qq.com"</span>,
    });

    Assert.AreEqual(<span class="hljs-keyword">true</span>, ok);
}</code></pre> 
<p>结果刚开始非常顺利，都能收到邮件；但该单元测试运行了几次以后，就发送失败了。提示：</p> 
<pre class="prettyprint"><code class=" hljs ruby">错误：邮件：事务失败。 服务器响应为<span class="hljs-symbol">:DT</span><span class="hljs-symbol">:SPM</span> <span class="hljs-number">163</span> smtp11,<span class="hljs-constant">D8CowACXNqusR1pYQe3vGA</span>--.<span class="hljs-number">16469</span>S2 <span class="hljs-number">1482311598</span>,please see <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/mail.163.com/help</span><span class="hljs-regexp">/help_spam_16.htm?ip=219.136.75.223&amp;hostid=smtp11&amp;time=1482311598</span></code></pre> 
<p>开始时以为是因为163邮箱的反垃圾邮件机制，猛查资料，结果一无所获。焦虑攻心之下，我第二天居然感冒了。后来才知道是QQ邮箱的发垃圾邮件机制所致。同一个发送请求中，有一个地址失败，其他的都失败了，所以称为“事务”？</p> 
<p>后来就是莫名其妙地好了，可能是邮件内容有所变化，QQ又认为它不是垃圾了。靠。</p> 
<p>注： <br> 我这个163邮箱，开启了客户端授权，未清楚对应对反垃圾机制是否有用，好像不开启这个客户端授权也能发送。开启了这个客户端授权后，代码中的密码要使用这个客户端授权密码，而不是登录邮箱的密码。 <br> <img src="https://images2.imgbox.com/34/06/9bmQLXEi_o.png" alt="这里写图片描述" title=""></p> 
<p>================================== <br> 以上就是垃圾。这个问题等于没解决。163的SMTP一言不合就将你的邮件当成垃圾邮件，直到第二天才解封。但是很奇怪，采用foxmail作为客户端来发送同样的邮件，却没有问题，说到底还是代码的问题？（outlook没试过，估计也不会有问题）</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/50db37f80300d9143b3f8bd02cb90339/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">浅谈服务治理与微服务</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/692f9acf9bcb2d63a7732ae2bd2b9521/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android中AlarmManager的几个重要方法详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>