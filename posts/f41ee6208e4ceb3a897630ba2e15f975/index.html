<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-构建会员服务-005：令牌登陆&amp;扫码关注&amp;细分接口安全领域 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-构建会员服务-005：令牌登陆&amp;扫码关注&amp;细分接口安全领域" />
<meta property="og:description" content="005：令牌登陆&amp;扫码关注&amp;细分接口安全领域 1 会员、令牌登陆服务接口的演示2 为什么我们接口需要定义dto与do转换3 定义会员注册接口的dto参数4 定义dto与do的转换工具类封装5 会员服务注册接口测试运行6 令牌登录接口的基本实现7 基于令牌获取用户信息接口8 使用多线程异步的形式处理日志操作9 @Async整合可能存在的问题10 源码角度分析@Async为什么会失效11 @Async需要注意那些事项 1 会员、令牌登陆服务接口的演示 今日课程任务
如何细分rpc接口需要细分参数安全领域为什么要dto、do之间实现互转构建会员服务用户注册的接口构建会员服务令牌登录接口基于多线程的形式异步写入登录日志@Async注解的失效之谜分析基于令牌查询用户的信息实现用户脱敏 2 为什么我们接口需要定义dto与do转换 构建会员服务接口
数据库表设计
CREATE TABLE `meite_user` ( `USER_ID` int(12) NOT NULL AUTO_INCREMENT COMMENT &#39;user_id&#39;, `MOBILE` varchar(11) NOT NULL COMMENT &#39;手机号&#39;, `EMAIL` varchar(50) DEFAULT NULL COMMENT &#39;邮箱号&#39;, `PASSWORD` varchar(64) NOT NULL COMMENT &#39;密码&#39;, `USER_NAME` varchar(50) DEFAULT NULL COMMENT &#39;用户名&#39;, `SEX` tinyint(1) DEFAULT &#39;0&#39; COMMENT &#39;性别 1男 2女&#39;, `AGE` tinyint(3) DEFAULT &#39;0&#39; COMMENT &#39;年龄&#39;, `CREATE_TIME` timestamp NULL DEFAULT NULL COMMENT &#39;注册时间&#39;, `UPDATE_TIME` timestamp NULL DEFAULT NULL COMMENT &#39;修改时间&#39;, `IS_AVAILABLE` tinyint(1) DEFAULT &#39;1&#39; COMMENT &#39;是否可用 1正常 2冻结&#39;, `PIC_IMG` varchar(255) DEFAULT NULL COMMENT &#39;用户头像&#39;, `QQ_OPENID` varchar(50) DEFAULT NULL COMMENT &#39;QQ联合登陆id&#39;, `WX_OPENID` varchar(50) DEFAULT NULL COMMENT &#39;微信公众号关注id&#39;, PRIMARY KEY (`USER_ID`), UNIQUE KEY `MOBILE_UNIQUE` (`MOBILE`), UNIQUE KEY `EMAIL_UNIQUE` (`EMAIL`) ) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=utf8 COMMENT=&#39;用户会员表&#39;; CREATE TABLE `user_login_log` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) DEFAULT NULL, `login_ip` varchar(255) DEFAULT NULL, `login_time` datetime DEFAULT NULL, `login_token` varchar(255) DEFAULT NULL, `channel` varchar(255) DEFAULT NULL, `equipment` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f41ee6208e4ceb3a897630ba2e15f975/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-21T22:37:03+08:00" />
<meta property="article:modified_time" content="2021-05-21T22:37:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-构建会员服务-005：令牌登陆&amp;扫码关注&amp;细分接口安全领域</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>005：令牌登陆&amp;扫码关注&amp;细分接口安全领域</h4> 
 <ul><li><ul><li><a href="#1__1" rel="nofollow">1 会员、令牌登陆服务接口的演示</a></li><li><a href="#2_dtodo_11" rel="nofollow">2 为什么我们接口需要定义dto与do转换</a></li><li><a href="#3_dto_59" rel="nofollow">3 定义会员注册接口的dto参数</a></li><li><a href="#4_dtodo_153" rel="nofollow">4 定义dto与do的转换工具类封装</a></li><li><a href="#5__283" rel="nofollow">5 会员服务注册接口测试运行</a></li><li><a href="#6__399" rel="nofollow">6 令牌登录接口的基本实现</a></li><li><a href="#7__560" rel="nofollow">7 基于令牌获取用户信息接口</a></li><li><a href="#8__701" rel="nofollow">8 使用多线程异步的形式处理日志操作</a></li><li><a href="#9_Async_823" rel="nofollow">9 @Async整合可能存在的问题</a></li><li><a href="#10_Async_896" rel="nofollow">10 源码角度分析@Async为什么会失效</a></li><li><a href="#11_Async_975" rel="nofollow">11 @Async需要注意那些事项</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1__1"></a>1 会员、令牌登陆服务接口的演示</h3> 
<p><strong>今日课程任务</strong></p> 
<ol><li>如何细分rpc接口需要细分参数安全领域</li><li>为什么要dto、do之间实现互转</li><li>构建会员服务用户注册的接口</li><li>构建会员服务令牌登录接口</li><li>基于多线程的形式异步写入登录日志</li><li>@Async注解的失效之谜分析</li><li>基于令牌查询用户的信息实现用户脱敏</li></ol> 
<h3><a id="2_dtodo_11"></a>2 为什么我们接口需要定义dto与do转换</h3> 
<p><strong>构建会员服务接口<br> 数据库表设计</strong></p> 
<pre><code>CREATE TABLE `meite_user` (
  `USER_ID` int(12) NOT NULL AUTO_INCREMENT COMMENT 'user_id',
  `MOBILE` varchar(11) NOT NULL COMMENT '手机号',
  `EMAIL` varchar(50) DEFAULT NULL COMMENT '邮箱号',
  `PASSWORD` varchar(64) NOT NULL COMMENT '密码',
  `USER_NAME` varchar(50) DEFAULT NULL COMMENT '用户名',
  `SEX` tinyint(1) DEFAULT '0' COMMENT '性别  1男  2女',
  `AGE` tinyint(3) DEFAULT '0' COMMENT '年龄',
  `CREATE_TIME` timestamp NULL DEFAULT NULL COMMENT '注册时间',
  `UPDATE_TIME` timestamp NULL DEFAULT NULL COMMENT '修改时间',
  `IS_AVAILABLE` tinyint(1) DEFAULT '1' COMMENT '是否可用 1正常  2冻结',
  `PIC_IMG` varchar(255) DEFAULT NULL COMMENT '用户头像',
  `QQ_OPENID` varchar(50) DEFAULT NULL COMMENT 'QQ联合登陆id',
  `WX_OPENID` varchar(50) DEFAULT NULL COMMENT '微信公众号关注id',
  PRIMARY KEY (`USER_ID`),
  UNIQUE KEY `MOBILE_UNIQUE` (`MOBILE`),
  UNIQUE KEY `EMAIL_UNIQUE` (`EMAIL`)
) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=utf8 COMMENT='用户会员表';

CREATE TABLE `user_login_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) DEFAULT NULL,
  `login_ip` varchar(255) DEFAULT NULL,
  `login_time` datetime DEFAULT NULL,
  `login_token` varchar(255) DEFAULT NULL,
  `channel` varchar(255) DEFAULT NULL,
  `equipment` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET="utf8";
</code></pre> 
<p><strong>细分接口安全领域</strong><br> 为什么接口需要细分接口安全领域，在rpc远程调用中直接传递do参数，容易造成数据库攻击。</p> 
<p><strong>DO(Data Object)</strong>：此对象与数据库表结构一一对应，通过DAO层向上传输数据源对象。<br> <strong>DTO(Data Transfer Object)</strong>：数据传输对象，Service或Manager向外传输的对象。<br> <strong>BO(Business Object)</strong>：业务对象，由Service层输出的封装业务逻辑的对象。<br> <strong>AO(Application Object)</strong>：应用对象，在Web层与Service层之间抽象的复用对象模型，极为贴近展示层，复用度不高。<br> <strong>VO（View Object）</strong>：显示层对象，通常是Web向模板渲染引擎层传输的对象。<br> <strong>Query</strong>：数据查询对象，各层接收上层的查询请求。注意超过2个参数的查询封装，禁止使用Map类。<br> 参考阿里云官方开发手册。</p> 
<p>用户会员注册如果采用数据库层实体类接受和响应参数，会暴露参数、容易被人参数攻击，不安全<br> RPC通讯中接收与响应参数封装，使用dto对象</p> 
<h3><a id="3_dto_59"></a>3 定义会员注册接口的dto参数</h3> 
<p><strong>UserDO&amp;UserReqRegisterDTO</strong></p> 
<pre><code class="prism language-javascript">@Data
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDO</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * userid
     */</span>

    <span class="token keyword">private</span> Long userId<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 手机号码
     */</span>

    <span class="token keyword">private</span> String mobile<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 邮箱
     */</span>

    <span class="token keyword">private</span> String email<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 密码
     */</span>

    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 用户名称
     */</span>

    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 性别 0 男 1女
     */</span>

    <span class="token keyword">private</span> char sex<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 年龄
     */</span>

    <span class="token keyword">private</span> Long age<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 注册时间
     */</span>

    <span class="token keyword">private</span> Date createTime<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 修改时间
     *
     */</span>

    <span class="token keyword">private</span> Date updateTime<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 账号是否可以用 1 正常 0冻结
     */</span>

    <span class="token keyword">private</span> char isAvailable<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 用户头像
     */</span>

    <span class="token keyword">private</span> String picImg<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 用户关联 QQ 开放ID
     */</span>

    <span class="token keyword">private</span> String qqOpenid<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 用户关联 微信 开放ID
     */</span>
    <span class="token keyword">private</span> String wxOpenId<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@Data
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserReqRegisterDTO</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 手机号码
     */</span>
    @<span class="token function">ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"手机号码"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"mobile"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String mobile<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 密码
     */</span>
    @<span class="token function">ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"密码"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"password"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>

<span class="token comment">//    private String smsCode;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4_dtodo_153"></a>4 定义dto与do的转换工具类封装</h3> 
<p><strong>DTO转换DO、DO转换DTO工具类</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MeiteBeanUtils</span><span class="token operator">&lt;</span>Dto<span class="token punctuation">,</span> Do<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * dot 转换为Do 工具类
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>Do<span class="token operator">&gt;</span> Do <span class="token function">dtoToDo</span><span class="token punctuation">(</span>Object dtoEntity<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span>Do<span class="token operator">&gt;</span> doClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断dto是否为空!</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dtoEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断DoClass 是否为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>doClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Do newInstance <span class="token operator">=</span> doClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>dtoEntity<span class="token punctuation">,</span> newInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Dto转换Do</span>
            <span class="token keyword">return</span> newInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * do 转换为Dto 工具类
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>Dto<span class="token operator">&gt;</span> Dto <span class="token function">doToDto</span><span class="token punctuation">(</span>Object doEntity<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span>Dto<span class="token operator">&gt;</span> dtoClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断dto是否为空!</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>doEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断DoClass 是否为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dtoClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Dto newInstance <span class="token operator">=</span> dtoClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>doEntity<span class="token punctuation">,</span> newInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Dto转换Do</span>
            <span class="token keyword">return</span> newInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>封装进BaseApiService中</strong></p> 
<pre><code class="prism language-javascript">@Data
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseApiService</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token function">setResultError</span><span class="token punctuation">(</span>Integer code<span class="token punctuation">,</span> String msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">setResult</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回错误，可以传msg
     *
     * @param msg
     * @return
     */</span>
    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token function">setResultError</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">setResult</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span><span class="token constant">HTTP_RES_CODE_500</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/***
     * 返回成功，可以传data值
     * @param data
     * @return
     */</span>
    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token function">setResultSuccess</span><span class="token punctuation">(</span><span class="token constant">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">setResult</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span><span class="token constant">HTTP_RES_CODE_200</span><span class="token punctuation">,</span> Constants<span class="token punctuation">.</span><span class="token constant">HTTP_RES_CODE_200_VALUE</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回成功，沒有data值
     *
     * @return
     */</span>
    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token function">setResultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">setResult</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span><span class="token constant">HTTP_RES_CODE_200</span><span class="token punctuation">,</span> Constants<span class="token punctuation">.</span><span class="token constant">HTTP_RES_CODE_200_VALUE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 通用封装 通用封装
     *
     * @param code
     * @param msg
     * @param data
     * @return
     */</span>

    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token function">setResult</span><span class="token punctuation">(</span>Integer code<span class="token punctuation">,</span> String msg<span class="token punctuation">,</span> <span class="token constant">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BaseResponse</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * dto转换do
     *
     * @param dtoEntity
     * @param doClass
     * @param &lt;Do&gt;
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>Do<span class="token operator">&gt;</span> Do <span class="token function">dtoToDo</span><span class="token punctuation">(</span>Object dtoEntity<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span>Do<span class="token operator">&gt;</span> doClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> MeiteBeanUtils<span class="token punctuation">.</span><span class="token function">dtoToDo</span><span class="token punctuation">(</span>dtoEntity<span class="token punctuation">,</span> doClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * do转dto
     * @param doEntity
     * @param dtoClass
     * @param &lt;Dto&gt;
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>Dto<span class="token operator">&gt;</span> Dto <span class="token function">doToDto</span><span class="token punctuation">(</span>Object doEntity<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span>Dto<span class="token operator">&gt;</span> dtoClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> MeiteBeanUtils<span class="token punctuation">.</span><span class="token function">doToDto</span><span class="token punctuation">(</span>doEntity<span class="token punctuation">,</span> dtoClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token function">setResult</span><span class="token punctuation">(</span>int dbCount<span class="token punctuation">,</span> <span class="token constant">T</span> successMsg<span class="token punctuation">,</span> String errorMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> dbCount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token function">setResultSuccess</span><span class="token punctuation">(</span>successMsg<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">setResultError</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5__283"></a>5 会员服务注册接口测试运行</h3> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token punctuation">{<!-- --></span>

    @<span class="token function">Insert</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO `meite_user` VALUES (null, #{mobile},null, #{password}, null, '0', '0', now(),"</span> <span class="token operator">+</span>
            <span class="token string">" now(),'1',null , null, null);\n"</span><span class="token punctuation">)</span>
    int <span class="token function">register</span><span class="token punctuation">(</span>UserDo userDo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    @<span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">"SELECT USER_ID AS USERID ,MOBILE AS MOBILE ,password as password\n"</span> <span class="token operator">+</span>
            <span class="token string">",user_name as username ,user_name as username,sex as sex \n"</span> <span class="token operator">+</span>
            <span class="token string">",age as age ,create_time as createtime,IS_AVAILABLE as isAvailable\n"</span> <span class="token operator">+</span>
            <span class="token string">",\n"</span> <span class="token operator">+</span>
            <span class="token string">"pic_img  as picimg,qq_openid as qqopenid ,wx_openid as wxopenid\n"</span> <span class="token operator">+</span>
            <span class="token string">"\n"</span> <span class="token operator">+</span>
            <span class="token string">"from meite_user  where MOBILE=#{mobile}"</span><span class="token punctuation">)</span>
    UserDo <span class="token function">login</span><span class="token punctuation">(</span>String mobile<span class="token punctuation">,</span> String passWord<span class="token punctuation">)</span><span class="token punctuation">;</span>

    @<span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">"SELECT USER_ID AS USERID ,MOBILE AS MOBILE ,password as password\n"</span> <span class="token operator">+</span>
            <span class="token string">",user_name as username ,user_name as username,sex as sex \n"</span> <span class="token operator">+</span>
            <span class="token string">",age as age ,create_time as createtime,IS_AVAILABLE as isAvailable\n"</span> <span class="token operator">+</span>
            <span class="token string">",\n"</span> <span class="token operator">+</span>
            <span class="token string">"pic_img  as picimg,qq_openid as qqopenid ,wx_openid as wxopenid\n"</span> <span class="token operator">+</span>
            <span class="token string">"\n"</span> <span class="token operator">+</span>
            <span class="token string">"from meite_user  where MOBILE=#{mobile}"</span><span class="token punctuation">)</span>
    UserDo <span class="token function">existMobile</span><span class="token punctuation">(</span>String mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">"SELECT USER_ID AS USERID ,MOBILE AS MOBILE ,password as password\n"</span> <span class="token operator">+</span>
            <span class="token string">",user_name as username ,user_name as username,sex as sex \n"</span> <span class="token operator">+</span>
            <span class="token string">",age as age ,create_time as createtime,IS_AVAILABLE as isAvailable\n"</span> <span class="token operator">+</span>
            <span class="token string">",\n"</span> <span class="token operator">+</span>
            <span class="token string">"pic_img  as picimg,qq_openid as qqopenid ,wx_openid as wxopenid\n"</span> <span class="token operator">+</span>
            <span class="token string">"\n"</span> <span class="token operator">+</span>
            <span class="token string">"from meite_user  where USER_ID=#{userId}"</span><span class="token punctuation">)</span>
    UserDo <span class="token function">findByUser</span><span class="token punctuation">(</span>Long userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MD5Util</span> <span class="token punctuation">{<!-- --></span>

   <span class="token keyword">public</span> final <span class="token keyword">static</span> String <span class="token constant">MD5</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      char hexDigits<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'F'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
         byte<span class="token punctuation">[</span><span class="token punctuation">]</span> btInput <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 获得MD5摘要算法的 MessageDigest 对象</span>
         MessageDigest mdInst <span class="token operator">=</span> MessageDigest<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 使用指定的字节更新摘要</span>
         mdInst<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>btInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 获得密文</span>
         byte<span class="token punctuation">[</span><span class="token punctuation">]</span> md <span class="token operator">=</span> mdInst<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 把密文转换成十六进制的字符串形式</span>
         int j <span class="token operator">=</span> md<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
         char str<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">char</span><span class="token punctuation">[</span>j <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         int k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            byte byte0 <span class="token operator">=</span> md<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            str<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> hexDigits<span class="token punctuation">[</span>byte0 <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">4</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            str<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> hexDigits<span class="token punctuation">[</span>byte0 <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@<span class="token function">Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">"会员注册服务接口"</span><span class="token punctuation">)</span>
@ApiModel
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberRegisterService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 会员注册接口
     * @param userReqRegisterDto
     * @return
     */</span>
    @<span class="token function">PostMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
    BaseResponse<span class="token operator">&lt;</span>JSONObject<span class="token operator">&gt;</span> <span class="token function">register</span><span class="token punctuation">(</span>@RequestBody UserReqRegisterDTO userReqRegisterDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@RestController
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberRegisterServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">BaseApiService</span> <span class="token keyword">implements</span> <span class="token class-name">MemberRegisterService</span> <span class="token punctuation">{<!-- --></span>

    @Autowired
    <span class="token keyword">private</span> UserMapper userMapper<span class="token punctuation">;</span>

    @Override
    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span>JSONObject<span class="token operator">&gt;</span> <span class="token function">register</span><span class="token punctuation">(</span>UserReqRegisterDTO userReqRegisterDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 参数验证</span>
        String mobile <span class="token operator">=</span> userReqRegisterDto<span class="token punctuation">.</span><span class="token function">getMobile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"mobile参数不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String password <span class="token operator">=</span> userReqRegisterDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"password参数不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 先检查手机号码是否存在</span>
        UserDO userDbDo <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">existMobile</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userDbDo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"该手机号码已经存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// dto转换成vo</span>
        UserDO userDo <span class="token operator">=</span> <span class="token function">dtoToDo</span><span class="token punctuation">(</span>userReqRegisterDto<span class="token punctuation">,</span> UserDO<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String newPassword <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token constant">MD5</span><span class="token punctuation">(</span>password <span class="token operator">+</span> <span class="token string">"salt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加盐 提前定义一个常量 可以用一张表定义每个用户对应的盐值</span>
        userDo<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>newPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        int register <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>userDo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        return register &gt; 0 ? setResultSuccess("注册成功") : setResultError("注册失败");</span>
        <span class="token keyword">return</span> <span class="token function">setResult</span><span class="token punctuation">(</span>register<span class="token punctuation">,</span> <span class="token string">"注册成功"</span><span class="token punctuation">,</span> <span class="token string">"注册失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>测试效果：</strong><br> <img src="https://images2.imgbox.com/2c/0d/KXaTLdX1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6__399"></a>6 令牌登录接口的基本实现</h3> 
<p><strong>前端vue如何绑定会话信息？</strong><br> 前端vue使用ajax调用后端登录接口，获取令牌存放到缓存中，每次调用其他接口的时候都会传递该令牌。</p> 
<p>登录接口：登录成功之后返回令牌给客户端保存，客户端后期使用该令牌绑定会话信息。<br> 令牌：类似于sessionId，一般存放在redis中解决session共享问题<br> 令牌 通行证 有效期 生成临时且唯一<br> Redis.set(“userToken”,”userId”);</p> 
<p><strong>TokenUtil</strong></p> 
<pre><code class="prism language-javascript">@Component
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenUtil</span> <span class="token punctuation">{<!-- --></span>

    @Autowired
    <span class="token keyword">private</span> RedisUtil redisUtil<span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">createToken</span><span class="token punctuation">(</span>String prefix<span class="token punctuation">,</span> String value<span class="token punctuation">,</span> Long timeOut<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.生成令牌</span>
        String token <span class="token operator">=</span> prefix <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.将该token存入到redis中</span>
        redisUtil<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> value<span class="token punctuation">,</span> timeOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">createToken</span><span class="token punctuation">(</span>String prefix<span class="token punctuation">,</span> String value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">createToken</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getTokenValue</span><span class="token punctuation">(</span>String token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisUtil<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>RedisUtil</strong></p> 
<pre><code class="prism language-javascript">@Component
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisUtil</span> <span class="token punctuation">{<!-- --></span>
    @Autowired
    <span class="token keyword">private</span> StringRedisTemplate stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 存放string类型
     *
     * @param key     key
     * @param data    数据
     * @param timeout 超时间
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setString</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> String data<span class="token punctuation">,</span> Long timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 存放string类型
     *
     * @param key  key
     * @param data 数据
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setString</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> String data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setString</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据key查询string类型
     *
     * @param key
     * @return
     */</span>
    <span class="token keyword">public</span> String <span class="token function">getString</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String value <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据对应的key删除key
     *
     * @param key
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delKey</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>引入redis相关maven依赖</strong></p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>data<span class="token operator">-</span>redis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p><strong>登录接口及实现类</strong></p> 
<pre><code class="prism language-javascript">@Data
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserLoginDTO</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 手机号码
     */</span>
    @<span class="token function">ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"手机号码"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"mobile"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String mobile<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 密码
     */</span>
    @<span class="token function">ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"密码"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"password"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@<span class="token function">Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">"会员登录接口"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberLoginService</span> <span class="token punctuation">{<!-- --></span>

    @<span class="token function">PostMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    BaseResponse<span class="token operator">&lt;</span>JSONObject<span class="token operator">&gt;</span> <span class="token function">login</span><span class="token punctuation">(</span>@RequestBody UserLoginDTO userLoginDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@RestController
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberLoginServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">BaseApiService</span> <span class="token keyword">implements</span> <span class="token class-name">MemberLoginService</span> <span class="token punctuation">{<!-- --></span>

    @Autowired
    <span class="token keyword">private</span> UserMapper userMapper<span class="token punctuation">;</span>

    @Autowired
    <span class="token keyword">private</span> TokenUtil tokenUtil<span class="token punctuation">;</span>

    @<span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"${mayikt.login.token.prefix}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String loginTokenPrefix<span class="token punctuation">;</span>

    @Override
    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span>JSONObject<span class="token operator">&gt;</span> <span class="token function">login</span><span class="token punctuation">(</span>UserLoginDTO userLoginDTO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 参数验证</span>
        String mobile <span class="token operator">=</span> userLoginDTO<span class="token punctuation">.</span><span class="token function">getMobile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"mobile参数不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String password <span class="token operator">=</span> userLoginDTO<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"password参数不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 查询数据库</span>
        String newPassword <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token constant">MD5</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        UserDO loginUserDO <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>mobile<span class="token punctuation">,</span> newPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUserDO <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"手机号码或者密码不正确"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Long userId <span class="token operator">=</span> loginUserDO<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String userToken <span class="token operator">=</span> tokenUtil<span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>loginTokenPrefix<span class="token punctuation">,</span> userId <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        JSONObject resultJSON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"userToken"</span><span class="token punctuation">,</span> userToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">setResultSuccess</span><span class="token punctuation">(</span>resultJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>测试效果：</strong><br> <img src="https://images2.imgbox.com/99/9a/8Yip2TqO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="7__560"></a>7 基于令牌获取用户信息接口</h3> 
<p><strong>字段脱敏工具类DesensitizationUtil</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DesensitizationUtil</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 只显示第一个汉字，其他隐藏为2个星号&lt;例子：李**&gt;
     *
     * @param fullName
     * @param index    1 为第index位开始脱敏
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">left</span><span class="token punctuation">(</span>String fullName<span class="token punctuation">,</span> int index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String name <span class="token operator">=</span> StringUtils<span class="token punctuation">.</span><span class="token function">left</span><span class="token punctuation">(</span>fullName<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> StringUtils<span class="token punctuation">.</span><span class="token function">rightPad</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 110****58，前面保留3位明文，后面保留2位明文
     *
     * @param name
     * @param index 3
     * @param end   2
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">around</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> int index<span class="token punctuation">,</span> int end<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> StringUtils<span class="token punctuation">.</span><span class="token function">left</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">removeStart</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">leftPad</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">right</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"***"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 后四位，其他隐藏&lt;例子：****1234&gt;
     *
     * @param num
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">right</span><span class="token punctuation">(</span>String num<span class="token punctuation">,</span> int end<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> StringUtils<span class="token punctuation">.</span><span class="token function">leftPad</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">right</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 手机号码前三后四脱敏</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">mobileEncrypt</span><span class="token punctuation">(</span>String mobile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>mobile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mobile<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mobile<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"(\\d{3})\\d{4}(\\d{4})"</span><span class="token punctuation">,</span> <span class="token string">"$1****$2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//身份证前三后四脱敏</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">idEncrypt</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> id<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"(?&lt;=\\w{3})\\w(?=\\w{4})"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//护照前2后3位脱敏，护照一般为8或9位</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">idPassport</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> id<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">char</span><span class="token punctuation">[</span>id<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"\0"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span> <span class="token operator">+</span> id<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 证件后几位脱敏
     *
     * @param id
     * @param sensitiveSize
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">idPassport</span><span class="token punctuation">(</span>String id<span class="token punctuation">,</span> int sensitiveSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        int length <span class="token operator">=</span> StringUtils<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> StringUtils<span class="token punctuation">.</span><span class="token function">rightPad</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">left</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> length <span class="token operator">-</span> sensitiveSize<span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>根据token查看用户信息接口&amp;实现</strong></p> 
<pre><code class="prism language-javascript">@<span class="token function">Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">"用户会员信息基本接口"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberInfoService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 根据用户token查询用户信息
     *
     * @param token
     * @return
     */</span>
    @<span class="token function">GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getTokenUser"</span><span class="token punctuation">)</span>
    @<span class="token function">ApiOperation</span><span class="token punctuation">(</span><span class="token string">"根据token查看用户信息"</span><span class="token punctuation">)</span>
    @<span class="token function">ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"token"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"token"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    BaseResponse<span class="token operator">&lt;</span>UserRespDTO<span class="token operator">&gt;</span> <span class="token function">getTokenUser</span><span class="token punctuation">(</span>@<span class="token function">RequestParam</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span> String token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@RestController
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberInfoServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">BaseApiService</span> <span class="token keyword">implements</span> <span class="token class-name">MemberInfoService</span> <span class="token punctuation">{<!-- --></span>

    @Autowired
    <span class="token keyword">private</span> TokenUtil tokenUtil<span class="token punctuation">;</span>
    @Autowired
    <span class="token keyword">private</span> UserMapper userMapper<span class="token punctuation">;</span>

    @Override
    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span>UserRespDTO<span class="token operator">&gt;</span> <span class="token function">getTokenUser</span><span class="token punctuation">(</span>String token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"token不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 从Redis中获取到userId</span>
        String redisValue <span class="token operator">=</span> tokenUtil<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>redisValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"token已经过期"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        long userId <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>redisValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据userId查询用户信息</span>
        UserDO userDO <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">findByUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userDO <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"token已经过期或者错误!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        UserRespDTO userRespDTO <span class="token operator">=</span> <span class="token function">doToDto</span><span class="token punctuation">(</span>userDO<span class="token punctuation">,</span> UserRespDTO<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String mobile <span class="token operator">=</span> userRespDTO<span class="token punctuation">.</span><span class="token function">getMobile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRespDTO<span class="token punctuation">.</span><span class="token function">setMobile</span><span class="token punctuation">(</span>DesensitizationUtil<span class="token punctuation">.</span><span class="token function">mobileEncrypt</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">setResultSuccess</span><span class="token punctuation">(</span>userRespDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>测试效果：</strong><br> <img src="https://images2.imgbox.com/0d/4f/wAESqhYD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="8__701"></a>8 使用多线程异步的形式处理日志操作</h3> 
<p>为了能够提高登录接口的响应速度，应该采用异步的形式写入日志<br> 注意：单独开启线程的业务逻辑@Async不应该放在接口实现类里面，容易造成冲突。<br> 启动类加上注解@EnableAsync开启注解权限</p> 
<p><strong>实体类UserLoginLogDo</strong></p> 
<pre><code class="prism language-javascript">@Data
@AllArgsConstructor
@NoArgsConstructor
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserLoginLogDo</span> <span class="token punctuation">{<!-- --></span>
    Long id<span class="token punctuation">;</span>
    Long userId<span class="token punctuation">;</span>
    String loginIp<span class="token punctuation">;</span>
    Date loginTime<span class="token punctuation">;</span>
    String loginToken<span class="token punctuation">;</span>
    String channel<span class="token punctuation">;</span>
    String equipment<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">UserLoginLogDo</span><span class="token punctuation">(</span>Long userId<span class="token punctuation">,</span> String loginIp<span class="token punctuation">,</span> Date loginTime<span class="token punctuation">,</span> String loginToken<span class="token punctuation">,</span> String channel<span class="token punctuation">,</span> String equipment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loginIp <span class="token operator">=</span> loginIp<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loginTime <span class="token operator">=</span> loginTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loginToken <span class="token operator">=</span> loginToken<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> channel<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>equipment <span class="token operator">=</span> equipment<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"UserLoginLogDo{"</span> <span class="token operator">+</span>
                <span class="token string">"userId="</span> <span class="token operator">+</span> userId <span class="token operator">+</span>
                <span class="token string">", loginIp='"</span> <span class="token operator">+</span> loginIp <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", loginTime="</span> <span class="token operator">+</span> loginTime <span class="token operator">+</span>
                <span class="token string">", loginToken='"</span> <span class="token operator">+</span> loginToken <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", channel='"</span> <span class="token operator">+</span> channel <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", equipment='"</span> <span class="token operator">+</span> equipment <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>UserLoginLogMapper</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserLoginLogMapper</span> <span class="token punctuation">{<!-- --></span>


    @<span class="token function">Insert</span><span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span>
            <span class="token string">"insert into  user_login_log values(null,#{userId},#{loginIp},now(),#{loginToken},#{channel},#{equipment});\n"</span><span class="token punctuation">)</span>
    int <span class="token function">insertUserLoginLog</span><span class="token punctuation">(</span>UserLoginLogDo userLoginLogDo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>登录实现类MemberLoginServiceImpl加上log日志</strong></p> 
<pre><code class="prism language-javascript">@RestController
@Slf4j
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberLoginServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">BaseApiService</span> <span class="token keyword">implements</span> <span class="token class-name">MemberLoginService</span> <span class="token punctuation">{<!-- --></span>

    @Autowired
    <span class="token keyword">private</span> UserMapper userMapper<span class="token punctuation">;</span>

    @Autowired
    <span class="token keyword">private</span> TokenUtil tokenUtil<span class="token punctuation">;</span>

    @<span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"${mayikt.login.token.prefix}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String loginTokenPrefix<span class="token punctuation">;</span>

    @Autowired
    <span class="token keyword">private</span> AsyncLoginLogManage asyncLoginLogManage<span class="token punctuation">;</span>

    @Override
    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span>JSONObject<span class="token operator">&gt;</span> <span class="token function">login</span><span class="token punctuation">(</span>UserLoginDTO userLoginDTO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 参数验证</span>
        String mobile <span class="token operator">=</span> userLoginDTO<span class="token punctuation">.</span><span class="token function">getMobile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"mobile参数不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String password <span class="token operator">=</span> userLoginDTO<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"password参数不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 查询数据库</span>
        String newPassword <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token constant">MD5</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        UserDO loginUserDO <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>mobile<span class="token punctuation">,</span> newPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUserDO <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"手机号码或者密码不正确"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Long userId <span class="token operator">=</span> loginUserDO<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String userToken <span class="token operator">=</span> tokenUtil<span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>loginTokenPrefix<span class="token punctuation">,</span> userId <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        JSONObject resultJSON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"userToken"</span><span class="token punctuation">,</span> userToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 写入日志</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 处理流程1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        asyncLoginLogManage<span class="token punctuation">.</span><span class="token function">loginLog</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">"192.168.212.110"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userToken
                <span class="token punctuation">,</span> <span class="token string">"PC"</span><span class="token punctuation">,</span> <span class="token string">"windows 谷歌浏览器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 处理流程3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">setResultSuccess</span><span class="token punctuation">(</span>resultJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>AsyncLoginLogManage开启异步日志记录</strong></p> 
<pre><code class="prism language-javascript">@Component
@Slf4j
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncLoginLogManage</span> <span class="token punctuation">{<!-- --></span>

    @Autowired
    <span class="token keyword">private</span> UserLoginLogMapper userLoginLogMapper<span class="token punctuation">;</span>

    @Async
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loginLog</span><span class="token punctuation">(</span>Long userId<span class="token punctuation">,</span> String loginIp<span class="token punctuation">,</span> Date loginTime<span class="token punctuation">,</span> String loginToken<span class="token punctuation">,</span> String channel<span class="token punctuation">,</span>
                         String equipment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        UserLoginLogDo userLoginLogDo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserLoginLogDo</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> loginIp<span class="token punctuation">,</span> loginTime<span class="token punctuation">,</span> loginToken<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> equipment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",userLoginLogDo:"</span> <span class="token operator">+</span> userLoginLogDo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",流程2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userLoginLogMapper<span class="token punctuation">.</span><span class="token function">insertUserLoginLog</span><span class="token punctuation">(</span>userLoginLogDo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 处理流程2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>测试效果：</strong><br> <img src="https://images2.imgbox.com/2d/65/rc83FB5o_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="9_Async_823"></a>9 @Async整合可能存在的问题</h3> 
<p>直接在实现类中方法上加上@Async注解，可能导致两个问题</p> 
<ol><li>@Async导致SpringMVC请求404(接口实现类)</li><li>@Async不生效</li></ol> 
<p>加入@Async后，该接口没有注册到SpringMVC中<br> 建议最好使用单独一个类调用</p> 
<p><strong>@Async整合线程池的配置</strong></p> 
<pre><code class="prism language-javascript">@Configuration
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MayiktTaskExecutorConfig</span> <span class="token keyword">implements</span> <span class="token class-name">AsyncConfigurer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 设置ThreadPoolExecutor的核心池大小。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> final int <span class="token constant">CORE_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 设置ThreadPoolExecutor的最大池大小。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> final int <span class="token constant">MAX_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 设置ThreadPoolExecutor的BlockingQueue的容量。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> final int <span class="token constant">QUEUE_CAPACITY</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 通过重写getAsyncExecutor方法，制定默认的任务执行由该方法产生
     * &lt;p&gt;
     * 配置类实现AsyncConfigurer接口并重写getAsyncExcutor方法，并返回一个ThreadPoolTaskExevutor
     * 这样我们就获得了一个基于线程池的TaskExecutor
     */</span>
    @Override
    <span class="token keyword">public</span> Executor <span class="token function">getAsyncExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ThreadPoolTaskExecutor taskExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token constant">CORE_POOL_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token constant">MAX_POOL_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token constant">QUEUE_CAPACITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> taskExecutor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>MayiktLoginServiceImpl</strong></p> 
<pre><code class="prism language-javascript">@RestController
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MayiktLoginServiceImpl</span> <span class="token punctuation">{<!-- --></span>

    @<span class="token function">GetMapping</span><span class="token punctuation">(</span><span class="token string">"myLogin"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">myLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;myLogin threadName:"</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">myLoginService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"myLogin"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Async
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myLoginService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;myLoginService threadName:"</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>测试效果：</strong><br> <img src="https://images2.imgbox.com/c8/4c/OHX8aNtD_o.png" alt="在这里插入图片描述"><br> <strong>@Async导致404或者失效问题总结：</strong></p> 
<ol><li>如果控制类实现了接口，在使用@Async异步注解的时候会导致当前的控制类所有注册的url映射全部为404；</li><li>如果控制类没有实现接口，直接使用@Async异步注解，会失效</li></ol> 
<p>自定义注解如何能够生效：AOP技术</p> 
<p><strong>原理分析：</strong><br> 当在方法上加上用@Async的时候，就会对当前这个类生成一个代理类，必须通过代理类.myLoginService才能走Aop切面帮助创建线程进行处理。</p> 
<h3><a id="10_Async_896"></a>10 源码角度分析@Async为什么会失效</h3> 
<pre><code class="prism language-javascript">@Component
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringBeanContext</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> final Logger log <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>SpringBeanContext<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> ApplicationContext applicationContext<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SpringBeanContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span>ApplicationContext applicationContext1<span class="token punctuation">)</span> throws BeansException <span class="token punctuation">{<!-- --></span>
        applicationContext <span class="token operator">=</span> applicationContext1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">getBean</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"未初始化Spring上下文"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>applicationContext<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Spring上下文中不存在要查找的对象[{}]"</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token constant">T</span> <span class="token function">getBean</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"未初始化Spring上下文"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token constant">T</span> <span class="token function">getBean</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"未初始化Spring上下文"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@RestController
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MayiktLoginServiceImpl</span> <span class="token punctuation">{<!-- --></span>

    @<span class="token function">GetMapping</span><span class="token punctuation">(</span><span class="token string">"myLogin"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">myLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;myLogin threadName:"</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取cglib方式生成的代理类对象</span>
        MayiktLoginServiceImpl mayiktLoginServiceImpl <span class="token operator">=</span> <span class="token punctuation">(</span>MayiktLoginServiceImpl<span class="token punctuation">)</span> SpringBeanContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"mayiktLoginServiceImpl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mayiktLoginServiceImpl<span class="token punctuation">.</span><span class="token function">myLoginService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"myLogin"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Async
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myLoginService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;myLoginService threadName:"</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>测试效果：</strong><br> <img src="https://images2.imgbox.com/7d/fc/Bsz9tGbX_o.png" alt="在这里插入图片描述"><br> 如果控制类没有实现过接口的情况下，采用cglib动态代理，可以成功的注册到SpringMVC的容器中；<br> 如果控制类有实现接口，走jdk动态代理技术，无法将该动态代理类注册到SpringMVC容器中。（相当于@Controll注解和@Async注解生成代理类产生冲突）</p> 
<p><strong>自理解</strong>：方法上加上@Async异步注解，会采用动态代理方式创建代理类。如果实现过接口，采用jdk动态代理生成的代理类不符合SpringMVC控制类类型，不能注册到SpringMVC中；如果没有实现接口，采用cglib动态代理生成代理类，不会改变控制类性质，同样可以注册SpringMVC容器中，但是执行异步方法myLoginService();的时候要先获取代理类对象执行才能生效，否则无效。</p> 
<p><strong>为什么加上@Async会导致控制类中定义的Mapping为404？</strong><br> AbstractHandlerMethodMapping查看到afterPropertiesSet方法中initHandlerMethods()关联SpringMVCBean。</p> 
<h3><a id="11_Async_975"></a>11 @Async需要注意那些事项</h3> 
<p><strong>使用@Async注意事项：</strong></p> 
<ol><li>异步需要执行的业务逻辑建议单独开一个类实现或者从容器中直接获取到该代理类执行；</li><li>异步的方法上不要加上static（不会走aop）；</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/451c04979b1fc23aa8b88c313d947cb0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用 JavaScript 实现手势库 — 事件派发与 Flick 事件【前端组件化】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d8e0e4dc45207cf854a96c4cf97d6f03/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">1 3 5 n的和c语言编程,输入正整数n，计算1-1/3&#43;1/5-1/7&#43;....的前n项之和。用C语言程序解答...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>