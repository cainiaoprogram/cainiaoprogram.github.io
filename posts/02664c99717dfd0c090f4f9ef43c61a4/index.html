<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PX4无人机 - 键盘控制飞行代码 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PX4无人机 - 键盘控制飞行代码" />
<meta property="og:description" content="PX4无人机 - 键盘控制飞行代码 仿真效果
实机效果
由于图片限制5M以内，只能上传一小段了，整段视频请点击链接 Pixhawk 6c | 无人机 | 键盘控制无人机 | Offboard模式
核心： 发布 mavros/setpoint_velocity/cmd_vel_unstamped 话题，控制x y z三个方向的速度
运行前先运行PX4自带仿真，例如
roslaunch px4 mavros_posix_sitl.launch 接着运行以下代码（根据WHEELTEC麦克纳姆轮小车的键盘控制代码改写）
注意： 空格：降落 5 ：开启offboard模式 6 ：解锁，准备起飞 7 ：起飞 控制顺序：
先按 5 开启offboard 模式
再按 6 解锁，会看到浆液开始转动
再按 7 起飞 （这里起飞后就不在 offboard 模式）
再按一次 5 切换到 offboard 模式（之后就可以通过键盘控制前后运动，左右旋转了）
控制运动键如下
i 键：前进
K 键：停止运动
, 键：后退
J 键：向左转
L键：向右转
R键：上升
F键：下降
运动速度调整键如下
常用键如下：
W 键：增加运动线速度
X 键：减少运动线速度" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/02664c99717dfd0c090f4f9ef43c61a4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-25T10:56:28+08:00" />
<meta property="article:modified_time" content="2023-05-25T10:56:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PX4无人机 - 键盘控制飞行代码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="PX4___0"></a>PX4无人机 - 键盘控制飞行代码</h3> 
<p><mark><strong>仿真效果</strong></mark><br> <img src="https://images2.imgbox.com/aa/10/Mmb4pWKq_o.gif" alt="在这里插入图片描述"></p> 
<p><mark><strong>实机效果</strong></mark><br> 由于图片限制5M以内，只能上传一小段了，整段视频请点击链接 <a href="https://www.bilibili.com/video/BV1TT411C7Up/?spm_id_from=333.999.0.0" rel="nofollow">Pixhawk 6c | 无人机 | 键盘控制无人机 | Offboard模式</a><br> <img src="https://images2.imgbox.com/ad/57/gvKBGfur_o.gif" alt="在这里插入图片描述"></p> 
<p><mark><strong>核心：</strong></mark> 发布 <strong>mavros/setpoint_velocity/cmd_vel_unstamped</strong> 话题，控制x y z三个方向的速度<br> 运行前先运行PX4自带仿真，例如</p> 
<pre><code class="prism language-bash">roslaunch px4 mavros_posix_sitl.launch
</code></pre> 
<p>接着运行以下代码（根据WHEELTEC麦克纳姆轮小车的键盘控制代码改写）</p> 
<h3><a id="_15"></a>注意：</h3> 
<h3><a id="_16"></a>空格：降落</h3> 
<h3><a id="5__offboard_17"></a>5 ：开启offboard模式</h3> 
<h3><a id="6___18"></a>6 ：解锁，准备起飞</h3> 
<h3><a id="7___19"></a>7 ：起飞</h3> 
<p>控制顺序：<br> 先按 5 开启offboard 模式<br> 再按 6 解锁，会看到浆液开始转动<br> 再按 7 起飞 （这里起飞后就不在 offboard 模式）<br> 再按一次 5 切换到 offboard 模式（之后就可以通过键盘控制前后运动，左右旋转了）</p> 
<p><mark><strong>控制运动键如下</strong></mark><br> i 键：前进<br> K 键：停止运动<br> , 键：后退<br> J 键：向左转<br> L键：向右转<br> R键：上升<br> F键：下降</p> 
<p><mark><strong>运动速度调整键如下</strong></mark><br> 常用键如下：<br> W 键：增加运动线速度<br> X 键：减少运动线速度<br> E 键：增加旋转角速度<br> C 键：减少旋转角速度</p> 
<p><mark><strong>降落</strong></mark><br> 空格键</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># coding=utf-8</span>

<span class="token keyword">import</span> rospy

<span class="token keyword">from</span> geometry_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> Twist
<span class="token keyword">from</span> geometry_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> PoseStamped
<span class="token keyword">from</span> mavros_msgs<span class="token punctuation">.</span>srv <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> mavros_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> State
<span class="token keyword">import</span> math
<span class="token keyword">import</span> sys<span class="token punctuation">,</span> select<span class="token punctuation">,</span> termios<span class="token punctuation">,</span> tty

<span class="token comment"># 空格：降落</span>
<span class="token comment"># 5  ：开启offboard模式</span>
<span class="token comment"># 6  ：解锁，准备起飞</span>
<span class="token comment"># 7  ：起飞</span>

msg <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
Control Your Turtlebot!
---------------------------
Moving around:
   u    i    o
   j    k    l
   m    ,    .

q/z : increase/decrease max speeds by 10%
w/x : increase/decrease only linear speed by 10%
e/c : increase/decrease only angular speed by 10%
space key, k : force stop
anything else : stop smoothly
b : switch to OmniMode/CommonMode
CTRL-C to quit
"""</span>
Omni <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">#全向移动模式</span>

<span class="token comment">#键值对应移动/转向方向</span>
moveBindings <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'i'</span><span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'o'</span><span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'j'</span><span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'l'</span><span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'u'</span><span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">','</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'.'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'m'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">}</span>

<span class="token comment">#键值对应速度增量</span>
speedBindings<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">'q'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'z'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'w'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'x'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'e'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'c'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>

<span class="token comment">#获取键值函数</span>
<span class="token keyword">def</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tty<span class="token punctuation">.</span>setraw<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    rlist<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> select<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token punctuation">[</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> rlist<span class="token punctuation">:</span>
        key <span class="token operator">=</span> sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> <span class="token string">''</span>

    termios<span class="token punctuation">.</span>tcsetattr<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">,</span> termios<span class="token punctuation">.</span>TCSADRAIN<span class="token punctuation">,</span> settings<span class="token punctuation">)</span>
    <span class="token keyword">return</span> key


speed <span class="token operator">=</span> <span class="token number">0.2</span> <span class="token comment">#默认移动速度 m/s</span>
turn  <span class="token operator">=</span> <span class="token number">1</span>   <span class="token comment">#默认转向速度 rad/s</span>
<span class="token comment">#以字符串格式返回当前速度</span>
<span class="token keyword">def</span> <span class="token function">vels</span><span class="token punctuation">(</span>speed<span class="token punctuation">,</span>turn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"currently:\tspeed %s\tturn %s "</span> <span class="token operator">%</span> <span class="token punctuation">(</span>speed<span class="token punctuation">,</span>turn<span class="token punctuation">)</span>

sita <span class="token operator">=</span> <span class="token number">0.0</span>  <span class="token comment"># 朝向</span>
z <span class="token operator">=</span> <span class="token number">0</span>
w <span class="token operator">=</span> <span class="token number">0</span>
zf <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment"># 回调函数:订阅无人机位姿</span>
<span class="token keyword">def</span> <span class="token function">pose_cb</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> sita
    <span class="token keyword">global</span> z
    <span class="token keyword">global</span> w
    <span class="token keyword">global</span> zf
    z <span class="token operator">=</span> m<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z
    w <span class="token operator">=</span> m<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w
    <span class="token comment"># 计算朝向在x轴的上方还是下方</span>
    <span class="token keyword">if</span> z<span class="token operator">*</span>w <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        zf <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        zf <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    sita <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span>math<span class="token punctuation">.</span>acos<span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">180</span><span class="token operator">/</span>math<span class="token punctuation">.</span>pi
    <span class="token comment"># rospy.loginfo('%.2f\r',sita)</span>

current_state <span class="token operator">=</span> State<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 回调函数：订阅mavros状态</span>
<span class="token keyword">def</span> <span class="token function">state_cb</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> current_state
    current_state <span class="token operator">=</span> state

<span class="token comment">#主函数</span>
<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    settings <span class="token operator">=</span> termios<span class="token punctuation">.</span>tcgetattr<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span> <span class="token comment">#获取键值初始化，读取终端相关属性</span>
    
    rospy<span class="token punctuation">.</span>init_node<span class="token punctuation">(</span><span class="token string">'turtlebot_teleop'</span><span class="token punctuation">)</span> <span class="token comment">#创建ROS节点</span>
    pub <span class="token operator">=</span> rospy<span class="token punctuation">.</span>Publisher<span class="token punctuation">(</span><span class="token string">'mavros/setpoint_velocity/cmd_vel_unstamped'</span><span class="token punctuation">,</span> Twist<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">#创建速度话题发布者</span>
    <span class="token comment"># 订阅无人机位姿</span>
    rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span><span class="token string">'mavros/local_position/pose'</span><span class="token punctuation">,</span>PoseStamped<span class="token punctuation">,</span> pose_cb<span class="token punctuation">)</span>

    <span class="token comment"># 订阅mavros状态</span>
    rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span><span class="token string">'mavros/state'</span><span class="token punctuation">,</span>State<span class="token punctuation">,</span>state_cb<span class="token punctuation">)</span>

    <span class="token comment"># 定义起飞降落服务客户端（起飞，降落）</span>
    setModeServer <span class="token operator">=</span> rospy<span class="token punctuation">.</span>ServiceProxy<span class="token punctuation">(</span><span class="token string">'mavros/set_mode'</span><span class="token punctuation">,</span>SetMode<span class="token punctuation">)</span>

    armServer <span class="token operator">=</span> rospy<span class="token punctuation">.</span>ServiceProxy<span class="token punctuation">(</span><span class="token string">'/mavros/cmd/arming'</span><span class="token punctuation">,</span> CommandBool<span class="token punctuation">)</span>

    x      <span class="token operator">=</span> <span class="token number">0</span>   <span class="token comment">#前进后退方向</span>
    y      <span class="token operator">=</span> <span class="token number">0</span>   <span class="token comment">#左右移动方向</span>
    z      <span class="token operator">=</span> <span class="token number">0</span>   <span class="token comment">#上下移动方向</span>
    th     <span class="token operator">=</span> <span class="token number">0</span>   <span class="token comment">#转向/横向移动方向</span>
    count  <span class="token operator">=</span> <span class="token number">0</span>   <span class="token comment">#键值不再范围计数</span>
    target_speed <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">#前进后退目标速度</span>
    target_z_speed <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">#上下运动目标速度</span>
    target_turn  <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">#转向目标速度</span>
    control_speed <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">#前进后退实际控制速度</span>
    control_z_speed <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">#上下运动实际控制速度</span>
    control_turn  <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">#转向实际控制速度</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token comment">#打印控制说明</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>vels<span class="token punctuation">(</span>speed<span class="token punctuation">,</span>turn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#打印当前速度</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            key <span class="token operator">=</span> getKey<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#获取键值</span>

            <span class="token comment"># if key:</span>
            <span class="token comment">#     print('key = ',key)</span>
            
            <span class="token comment">#判断键值是否在移动/转向方向键值内</span>
            <span class="token comment"># if key in moveBindings.keys():</span>
            <span class="token comment">#     x  = moveBindings[key][0]</span>
            <span class="token comment">#     th = moveBindings[key][1]</span>
            <span class="token comment">#     count = 0</span>

            <span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token string">'i'</span><span class="token punctuation">:</span>   <span class="token comment">#前进</span>
                count <span class="token operator">=</span> <span class="token number">0</span>
                x <span class="token operator">=</span> <span class="token number">1</span>
                z <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">','</span><span class="token punctuation">:</span> <span class="token comment">#后退 </span>
                count <span class="token operator">=</span> <span class="token number">0</span>
                x <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
                z <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">'j'</span><span class="token punctuation">:</span> <span class="token comment">#往左转</span>
                count <span class="token operator">=</span> <span class="token number">0</span>
                th <span class="token operator">=</span> <span class="token number">1</span>
                z <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">'l'</span><span class="token punctuation">:</span> <span class="token comment">#往右转</span>
                count <span class="token operator">=</span> <span class="token number">0</span>
                th <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
                z <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">'r'</span><span class="token punctuation">:</span> <span class="token comment">#上升</span>
                count <span class="token operator">=</span> <span class="token number">0</span>
                z <span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">'f'</span><span class="token punctuation">:</span> <span class="token comment">#下降</span>
                count <span class="token operator">=</span> <span class="token number">0</span>
                z <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
            <span class="token comment">#判断键值是否在速度增量键值内</span>
            <span class="token keyword">elif</span> key <span class="token keyword">in</span> speedBindings<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                speed <span class="token operator">=</span> speed <span class="token operator">*</span> speedBindings<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                turn  <span class="token operator">=</span> turn  <span class="token operator">*</span> speedBindings<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                count <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>vels<span class="token punctuation">(</span>speed<span class="token punctuation">,</span>turn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#速度发生变化，打印出来</span>

            <span class="token comment">#空键值/'k',相关变量置0</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">'k'</span> <span class="token punctuation">:</span>
                x  <span class="token operator">=</span> <span class="token number">0</span>
                y  <span class="token operator">=</span> <span class="token number">0</span>
                z  <span class="token operator">=</span> <span class="token number">0</span>
                th <span class="token operator">=</span> <span class="token number">0</span>
                control_speed <span class="token operator">=</span> <span class="token number">0</span>
                control_z_speed <span class="token operator">=</span> <span class="token number">0</span>
                control_turn  <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token comment"># 降落</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">' '</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Vehicle Land"</span><span class="token punctuation">)</span>
                setModeServer<span class="token punctuation">(</span>custom_mode<span class="token operator">=</span><span class="token string">'AUTO.LAND'</span><span class="token punctuation">)</span>
            <span class="token comment"># 开启offboard模式</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">'5'</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> current_state<span class="token punctuation">.</span>mode <span class="token operator">!=</span> <span class="token string">"OFFBOARD"</span> <span class="token punctuation">:</span>
                    setModeServer<span class="token punctuation">(</span>custom_mode<span class="token operator">=</span><span class="token string">'OFFBOARD'</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Offboard enabled"</span><span class="token punctuation">)</span>
            <span class="token comment"># 解锁，准备起飞</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">'6'</span><span class="token punctuation">:</span>
                armServer<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span> 
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Vehicle armed"</span><span class="token punctuation">)</span>
            <span class="token comment"># 起飞</span>
            <span class="token keyword">elif</span> key <span class="token operator">==</span> <span class="token string">'7'</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Vehicle Takeoff"</span><span class="token punctuation">)</span>
                setModeServer<span class="token punctuation">(</span>custom_mode<span class="token operator">=</span><span class="token string">'AUTO.TAKEOFF'</span><span class="token punctuation">)</span>

            <span class="token comment">#长期识别到不明键值，相关变量置0</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">:</span>
                    x  <span class="token operator">=</span> <span class="token number">0</span>
                    y  <span class="token operator">=</span> <span class="token number">0</span>
                    z  <span class="token operator">=</span> <span class="token number">0</span>
                    th <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'\x03'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">break</span>

            <span class="token comment">#根据速度与方向计算目标速度</span>
            target_speed <span class="token operator">=</span> speed <span class="token operator">*</span> x
            target_z_speed <span class="token operator">=</span> speed <span class="token operator">*</span> z
            target_turn  <span class="token operator">=</span> turn <span class="token operator">*</span> th

            <span class="token comment">#x方向平滑控制，计算前进后退实际控制速度</span>
            <span class="token keyword">if</span> target_speed <span class="token operator">&gt;</span> control_speed<span class="token punctuation">:</span>
                control_speed <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span> target_speed<span class="token punctuation">,</span> control_speed <span class="token operator">+</span> <span class="token number">0.1</span> <span class="token punctuation">)</span>
            <span class="token keyword">elif</span> target_speed <span class="token operator">&lt;</span> control_speed<span class="token punctuation">:</span>
                control_speed <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span> target_speed<span class="token punctuation">,</span> control_speed <span class="token operator">-</span> <span class="token number">0.1</span> <span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                control_speed <span class="token operator">=</span> target_speed
            
            <span class="token comment">#z方向平滑控制，实际控制速度</span>
            <span class="token keyword">if</span> target_z_speed <span class="token operator">&gt;</span> control_z_speed<span class="token punctuation">:</span>
                control_z_speed <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span> target_z_speed<span class="token punctuation">,</span> control_z_speed <span class="token operator">+</span> <span class="token number">0.1</span> <span class="token punctuation">)</span>
            <span class="token keyword">elif</span> target_z_speed <span class="token operator">&lt;</span> control_z_speed<span class="token punctuation">:</span>
                control_z_speed <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span> target_z_speed<span class="token punctuation">,</span> control_z_speed <span class="token operator">-</span> <span class="token number">0.1</span> <span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                control_z_speed <span class="token operator">=</span> target_z_speed

            <span class="token comment">#平滑控制，计算转向实际控制速度</span>
            <span class="token keyword">if</span> target_turn <span class="token operator">&gt;</span> control_turn<span class="token punctuation">:</span>
                control_turn <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span> target_turn<span class="token punctuation">,</span> control_turn <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token punctuation">)</span>
            <span class="token keyword">elif</span> target_turn <span class="token operator">&lt;</span> control_turn<span class="token punctuation">:</span>
                control_turn <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span> target_turn<span class="token punctuation">,</span> control_turn <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                control_turn <span class="token operator">=</span> target_turn
         
            <span class="token comment"># 计算出y方向的sin值</span>
            y_sita <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>sita<span class="token operator">/</span><span class="token number">180</span><span class="token operator">*</span>math<span class="token punctuation">.</span>pi<span class="token punctuation">)</span>
            <span class="token comment"># 如果小于0，则改为正数</span>
            <span class="token keyword">if</span> y_sita <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                y_sita <span class="token operator">=</span> <span class="token operator">-</span>y_sita
            <span class="token comment"># 乘以y分量的正负（通过四元数z*w获得，z*w&gt;0,y分量在x轴上方）</span>
            y_sita <span class="token operator">=</span> y_sita <span class="token operator">*</span> zf

            twist <span class="token operator">=</span> Twist<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#创建ROS速度话题变量</span>
            twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x <span class="token operator">=</span> control_speed <span class="token operator">*</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>sita<span class="token operator">/</span><span class="token number">180</span><span class="token operator">*</span>math<span class="token punctuation">.</span>pi<span class="token punctuation">)</span>
            twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>y <span class="token operator">=</span> control_speed <span class="token operator">*</span> y_sita  <span class="token comment"># 朝向速度乘以y轴sin值</span>
            twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>z <span class="token operator">=</span> control_z_speed
            twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span>
            twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span>
            twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>z <span class="token operator">=</span> control_turn

            pub<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>twist<span class="token punctuation">)</span> <span class="token comment">#ROS发布速度话题</span>

    <span class="token comment">#运行出现问题则程序终止并打印相关错误信息</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

    <span class="token comment">#程序结束前发布速度为0的速度话题</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        twist <span class="token operator">=</span> Twist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0</span>
        twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>z <span class="token operator">=</span> control_turn
        pub<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>twist<span class="token punctuation">)</span>

    <span class="token comment">#程序结束前设置终端相关属性</span>
    termios<span class="token punctuation">.</span>tcsetattr<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">,</span> termios<span class="token punctuation">.</span>TCSADRAIN<span class="token punctuation">,</span> settings<span class="token punctuation">)</span>

</code></pre> 
<p>跑实机的话，就不需要运行gazebo仿真了，直接运行mavros的px4.launch文件</p> 
<pre><code class="prism language-bash">roslaunch mavros px4.launch
</code></pre> 
<p>再运行上面代码即可控制实机（我用的飞控是 Pixhawk6C）<br> <mark><strong>实机操作有风险，请各位有十足把握后再尝试实机</strong></mark></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/716ea2d2264486db8efd68bcf4b6c826/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">简单几步配置Mac下超好用的终端工具(iTerm2&#43;Oh My Zsh)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6ca0e9c4bd83c97816d04a2e2c3cd85c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">配置阿里的yum源</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>