<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Elasticsearch基础概念和Python操作 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Elasticsearch基础概念和Python操作" />
<meta property="og:description" content="文章目录 一、Elasticsearch 基础概念**1.1 基本概念****1.2 REST API**1.3 数据类型1.4 数据类型总结 二、Elasticsearch 基础操作2.1 对index操作2.2 对document操作 三、Elasticsearch 查询 DSL3.1 query 部分3.2 其他部分**3.2.1 排序字段**3.2.2 聚合字段3.2.3 size和scroll 四、批量操作数据4.1 批量插入/更新/删除数据4.2 更新插入数据upsert 五、文本分析5.1 测试分析器5.2 内置的分析器5.3 自定义分析器5.3.1 配置5.3.2 自定义分析器示例 5.4 指定分析器的方式 把事情简单化5.4.1 Elasticsearch 索引分析器5.4.2 Elasticsearch 搜索分析器 六、别名alias6.1 别名类型6.2 添加别名6.3 删除别名6.4 别名多个操作6.5 其他操作6.3 删除别名6.4 别名多个操作6.5 其他操作 一、Elasticsearch 基础概念 1.1 基本概念 Elasticsearch 是一个分布式文档存储。Elasticsearch 不是将信息存储为列式数据行，而是存储已序列化为 JSON 文档的复杂数据结构。当集群中有多个 Elasticsearch 节点时，存储的文档会分布在整个集群中，并且可以从任何节点立即访问。
存储文档后，它会在近乎实时的时间内被索引并完全可搜索——在1 秒内。Elasticsearch 使用一种称为倒排索引的数据结构，它支持非常快速的全文搜索。倒排索引列出了出现在任何文档中的每个唯一单词，并标识了每个单词出现的所有文档。
1.2 REST API Elasticsearch 提供了一个简单、连贯的 REST API，用于管理集群以及索引和搜索数据。
Elasticsearch REST API 支持结构化查询、全文查询和将两者结合的复杂查询。结构化查询类似于你可以在 SQL 中构造的查询类型。例如，你可以搜索索引中的gender和age字段并按字段employee作为索引，使用hire_date进行排序。全文查询查找与查询字符串匹配的所有文档，并按相关性排序返回它们——它们与你的搜索词的匹配程度。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/21af86debb977b2623887ff80b9120a5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-08T21:10:56+08:00" />
<meta property="article:modified_time" content="2023-03-08T21:10:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Elasticsearch基础概念和Python操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#Elasticsearch__3" rel="nofollow">一、Elasticsearch 基础概念</a></li><li><ul><li><a href="#11__5" rel="nofollow">**1.1 基本概念**</a></li><li><a href="#12_REST_API_15" rel="nofollow">**1.2 REST API**</a></li><li><a href="#13__37" rel="nofollow">1.3 数据类型</a></li><li><a href="#14__347" rel="nofollow">1.4 数据类型总结</a></li></ul> 
    </li><li><a href="#Elasticsearch__430" rel="nofollow">二、Elasticsearch 基础操作</a></li><li><ul><li><a href="#21_index_472" rel="nofollow">2.1 对index操作</a></li><li><a href="#22_document_541" rel="nofollow">2.2 对document操作</a></li></ul> 
    </li><li><a href="#Elasticsearch__DSL_596" rel="nofollow">三、Elasticsearch 查询 DSL</a></li><li><ul><li><a href="#31_query__637" rel="nofollow">3.1 query 部分</a></li><li><a href="#32__860" rel="nofollow">3.2 其他部分</a></li><li><ul><li><a href="#321__862" rel="nofollow">**3.2.1 排序字段**</a></li><li><a href="#322__882" rel="nofollow">3.2.2 聚合字段</a></li><li><a href="#323_sizescroll_888" rel="nofollow">3.2.3 size和scroll</a></li></ul> 
    </li></ul> 
    </li><li><a href="#_922" rel="nofollow">四、批量操作数据</a></li><li><ul><li><a href="#41__926" rel="nofollow">4.1 批量插入/更新/删除数据</a></li><li><a href="#42_upsert_991" rel="nofollow">4.2 更新插入数据upsert</a></li></ul> 
    </li><li><a href="#_1090" rel="nofollow">五、文本分析</a></li><li><ul><li><a href="#51__1104" rel="nofollow">5.1 测试分析器</a></li><li><a href="#52__1335" rel="nofollow">5.2 内置的分析器</a></li><li><a href="#53__1437" rel="nofollow">5.3 自定义分析器</a></li><li><ul><li><a href="#531__1447" rel="nofollow">5.3.1 配置</a></li><li><a href="#532__1461" rel="nofollow">5.3.2 自定义分析器示例</a></li></ul> 
     </li><li><a href="#54__1692" rel="nofollow">5.4 指定分析器的方式</a></li></ul> 
    </li><li><a href="#_1701" rel="nofollow">把事情简单化</a></li><li><ul><li><ul><li><a href="#541_Elasticsearch__1715" rel="nofollow">5.4.1 Elasticsearch 索引分析器</a></li><li><a href="#542_Elasticsearch__1773" rel="nofollow">5.4.2 Elasticsearch 搜索分析器</a></li></ul> 
    </li></ul> 
    </li><li><a href="#alias_1885" rel="nofollow">六、别名alias</a></li><li><ul><li><a href="#61__1893" rel="nofollow">6.1 别名类型</a></li><li><a href="#62__1904" rel="nofollow">6.2 添加别名</a></li><li><a href="#63__1954" rel="nofollow">6.3 删除别名</a></li><li><a href="#64__1982" rel="nofollow">6.4 别名多个操作</a></li><li><a href="#65__2012" rel="nofollow">6.5 其他操作</a></li><li><a href="#63__2107" rel="nofollow">6.3 删除别名</a></li><li><a href="#64__2135" rel="nofollow">6.4 别名多个操作</a></li><li><a href="#65__2165" rel="nofollow">6.5 其他操作</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="Elasticsearch__3"></a>一、Elasticsearch 基础概念</h4> 
<h5><a id="11__5"></a><strong>1.1 基本概念</strong></h5> 
<p>Elasticsearch 是一个分布式文档存储。Elasticsearch 不是将信息存储为列式数据行，而是存储已序列化为 JSON 文档的复杂数据结构。当集群中有多个 Elasticsearch 节点时，存储的文档会分布在整个集群中，并且可以从任何节点立即访问。</p> 
<p>存储文档后，它会在近乎实时的时间内被索引并完全可搜索——在1 秒内。Elasticsearch 使用一种称为倒排索引的数据结构，它支持非常快速的全文搜索。倒排索引列出了出现在任何文档中的每个唯一单词，并标识了<strong>每个单词</strong>出现的所有文档。</p> 
<h5><a id="12_REST_API_15"></a><strong>1.2 REST API</strong></h5> 
<p>Elasticsearch 提供了一个简单、连贯的 REST API，用于管理集群以及索引和搜索数据。</p> 
<p>Elasticsearch REST API 支持结构化查询、全文查询和将两者结合的复杂查询。结构化查询类似于你可以在 SQL 中构造的查询类型。例如，你可以搜索索引中的<code>gender</code>和<code>age</code>字段并按字段<code>employee</code>作为索引，使用<code>hire_date</code>进行排序。全文查询查找与查询字符串匹配的所有文档，并按<strong>相关性</strong>排序返回它们——它们与你的搜索词的匹配程度。</p> 
<p>除了搜索单个术语外，你还可以执行短语搜索、相似性搜索和前缀搜索，并获得自动完成建议。</p> 
<p>有要搜索的地理空间或其他数字数据吗？Elasticsearch 在支持高性能地理和数字查询的优化数据结构中索引非文本数据。</p> 
<p>您可以使用 Elasticsearch 全面的 JSON 样式查询语言 ( <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" rel="nofollow">Query DSL</a> ) 访问所有这些搜索功能。您还可以构建<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sql-overview.html" rel="nofollow">SQL 样式的查询</a>以在 Elasticsearch 内本地搜索和聚合数据，而 JDBC 和 ODBC 驱动程序使广泛的第三方应用程序能够通过 SQL 与 Elasticsearch 进行交互。</p> 
<h5><a id="13__37"></a>1.3 数据类型</h5> 
<p>Elasticsearch 在mappings参数中定义字段的，类似与数据库中的表结构的定义。</p> 
<p>Elasticsearch 主要的<strong>基本数据</strong>类型有：</p> 
<ol><li> <p>字符类型：text、keyword</p> 
  <ul><li>text： 全文搜索，会被分词处理，如果进行聚合、排序计算需要开启fielddata进行内存预加载，不建议此使用方法。</li><li>keyword：精准值，不会被分词。进行过滤、排序、聚合等操作时, 就应该使用keyword类型。</li></ul> </li><li> <p>数字类型：long、integer、short、byte、double、float、 half_float、 scaled_float</p> <p>尽可能选择范围小的数据类型, 字段的长度越短, 索引和搜索的效率越高,尽可能避免浮点类型，如果必须使用优先考虑使用带缩放因子的浮点类型。</p> </li><li> <p>日期：date</p> <p>由于json中无日期类型，所以es中日期可能是：</p> 
  <ul><li>包含格式化日期的字符串, “2018-10-01”, 或"2018/10/01 12:10:30"</li><li>代表时间毫秒数的长整型数字</li><li>代表时间秒数的整数</li><li>注意日期格式</li></ul> <p><strong>es系统初始化需要指定时区</strong><br> 如果时区未指定, 日期将被转换为UTC格式, 但存储的却是长整型的毫秒值.<br> 可以自定义日期格式, 若未指定, 则使用默认格式: strict_date_optional_time||epoch_millis</p> <p>设置多种日期格式</p> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"blog"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span><span class="token punctuation">,</span>  <span class="token comment">// 可以接受如下类型的格式</span>
                    <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>日期 纳秒：date_nanos</p> </li><li> <p>布尔型：boolean</p> <p>true/false</p> </li><li> <p>二进制：binary</p> </li><li> <p>范围数据类型range： integer_range,、float_range、 long_range、double_range,、date_range、ip_range</p> <p>例子：</p> <pre><code class="prism language-json"><span class="token comment">// 添加映射create</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"department"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"expected_number"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">// 预期员工数</span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"integer_range"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"time_frame"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>       <span class="token comment">// 发展时间线</span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"date_range"</span><span class="token punctuation">,</span> 
                    <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"ip_whitelist"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>     <span class="token comment">// ip白名单</span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"ip_range"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 添加数据index</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"expected_number"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"gte"</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token string-property property">"lte"</span> <span class="token operator">:</span> <span class="token number">20</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"time_frame"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token string-property property">"gte"</span> <span class="token operator">:</span> <span class="token string">"2018-10-01 12:00:00"</span><span class="token punctuation">,</span> 
        <span class="token string-property property">"lte"</span> <span class="token operator">:</span> <span class="token string">"2018-11-01"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token string-property property">"ip_whitelist"</span><span class="token operator">:</span> <span class="token string">"192.168.0.0/16"</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询数据search</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"expected_number"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token number">12</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"time_frame"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"gte"</span><span class="token operator">:</span> <span class="token string">"208-08-01"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"lte"</span><span class="token operator">:</span> <span class="token string">"2018-12-01"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"relation"</span><span class="token operator">:</span> <span class="token string">"within"</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p><strong>复杂的数据类型</strong></p> 
<ol><li> <p>对象类型：object</p> <p>JSON文档是分层的: 文档可以包含内部对象, 内部对象也可以包含内部对象。例如：</p> <pre><code class="prism language-json"><span class="token comment">// json</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"ma_shoufeng"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"address"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"region"</span><span class="token operator">:</span> <span class="token string">"China"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"location"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"province"</span><span class="token operator">:</span> <span class="token string">"GuangDong"</span><span class="token punctuation">,</span> <span class="token string-property property">"city"</span><span class="token operator">:</span> <span class="token string">"GuangZhou"</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// es存储方式</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span>                       <span class="token string">"ma_shoufeng"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"address.region"</span><span class="token operator">:</span>             <span class="token string">"China"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"address.location.province"</span><span class="token operator">:</span>  <span class="token string">"GuangDong"</span><span class="token punctuation">,</span> 
    <span class="token string-property property">"address.location.city"</span><span class="token operator">:</span>      <span class="token string">"GuangZhou"</span>
<span class="token punctuation">}</span>

<span class="token comment">// 此文档的映射mappings方式如下：</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"developer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"aggress"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"region"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span> <span class="token string-property property">"index"</span><span class="token operator">:</span><span class="token string">"true"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"location"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token string-property property">"province"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span> <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token string-property property">"city"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span> <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>嵌套类型：nested</p> <p>嵌套类型是对象数据类型的一个特例, 可以让array类型的对象被独立索引和搜索.</p> <pre><code class="prism language-json"><span class="token comment">// array类型，数据结构</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"group"</span><span class="token operator">:</span> <span class="token string">"stark"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"performer"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"first"</span><span class="token operator">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string-property property">"last"</span><span class="token operator">:</span> <span class="token string">"Snow"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"first"</span><span class="token operator">:</span> <span class="token string">"Sansa"</span><span class="token punctuation">,</span> <span class="token string-property property">"last"</span><span class="token operator">:</span> <span class="token string">"Stark"</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部存储结构</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"group"</span><span class="token operator">:</span>              <span class="token string">"stark"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"performer.first"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"john"</span><span class="token punctuation">,</span> <span class="token string">"sansa"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"performer.last"</span><span class="token operator">:</span>  <span class="token punctuation">[</span> <span class="token string">"snow"</span><span class="token punctuation">,</span> <span class="token string">"stark"</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <p>可以看出, user.first和user.last会被平铺为多值字段, 这样一来, John和Snow之间的关联性就丢失了。在查询时, 可能出现John Stark的结果。</p> <p>用nested类型解决object类型的不足<br> 如果需要对以最对象进行索引, 且保留数组中每个对象的独立性, 就应该使用嵌套数据类型.<br> —— 嵌套对象实质是将每个对象分离出来, 作为隐藏文档进行索引.</p> <pre><code class="prism language-json"><span class="token comment">// 创建映射create</span>
<span class="token constant">PUT</span> game_of_thrones
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"role"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"performer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"nested"</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 添加数据index</span>
<span class="token constant">PUT</span> game_of_thrones<span class="token operator">/</span>role<span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"group"</span> <span class="token operator">:</span> <span class="token string">"stark"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"performer"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"first"</span><span class="token operator">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string-property property">"last"</span><span class="token operator">:</span> <span class="token string">"Snow"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"first"</span><span class="token operator">:</span> <span class="token string">"Sansa"</span><span class="token punctuation">,</span> <span class="token string-property property">"last"</span><span class="token operator">:</span> <span class="token string">"Stark"</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 搜索数据search</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"performer"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"performer.first"</span><span class="token operator">:</span> <span class="token string">"John"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"performer.last"</span><span class="token operator">:</span> <span class="token string">"Snow"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"inner_hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"performer.first"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> </li><li> <p>地理数据类型</p> 
  <ol><li> <p>Geo-point： 地理点类型，地理点类型用于存储地理位置的经纬度对, 可用于:</p> 
    <ul><li>查找一定范围内的地理点;</li><li>通过地理位置或相对某个中心点的距离聚合文档;</li><li>将距离整合到文档的相关性评分中;</li><li>通过距离对文档进行排序.</li></ul> <pre><code class="prism language-json"><span class="token comment">// 添加映射</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"developer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"location"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>Geo-shape: 地理形状类型</p> </li></ol> </li></ol> 
<p>​</p> 
<ol start="4"><li> <p>特殊数据类型</p> 
  <ol><li>IP: ip (IPv4 和 IPv6 地址)</li><li>Completion：completion （to provide auto-complete suggestions）</li><li>Token count：token_count (to count the number of tokens in a string)</li><li>mapper-murmur3：murmur3(to compute hashes of values at index-time and store them in the index)</li><li>mapper-annotated-text：annotated-text （to index text containing special markup (typically used for identifying named entities)）</li><li>Percolator：（Accepts queries from the query-dsl）</li><li>Join：（Defines parent/child relation for documents within the same index）</li><li>Alias：（Defines an alias to an existing field.）</li><li>Rank feature：（Record numeric feature to boost hits at query time.）</li><li>Rank features：（Record numeric features to boost hits at query time.）</li><li>Dense vector：（Record dense vectors of float values.）</li><li>Sparse vector：（Record sparse vectors of float values.）</li><li>Search-as-you-type：（A text-like field optimized for queries to implement as-you-type completion）</li></ol> </li><li> <p>数组类型</p> <p>在Elasticsearch中，数组不需要一个特定的数据类型，任何字段都默认可以包含一个或多个值，当然，这多个值都必须是字段指定的数据类型。</p> </li><li> <p>Multi-fields</p> <p>Multi-fields 通常用来以不同的方式或目的索引同一个字段。比如，一个字符串类型字段可以同时被映射为 text 类型以用于全文检索、 keyword字段用于排序或聚合。又或者，你可以用standard分析器、english分析器和french分析器来索引同一个 text字段。</p> </li></ol> 
<h5><a id="14__347"></a>1.4 数据类型总结</h5> 
<p><strong>数字类型</strong></p> 
<table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>byte</td><td>有符号的8位整数，范围：[-128~127]</td></tr><tr><td>short</td><td>有符号的16位整数，范围：[-32768 ~ 32767]</td></tr><tr><td>integer</td><td>有符号的32位整数，范围：[<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
          
            − 
           
           
           
             2 
            
           
             31 
            
           
          
         
           -2^{31} 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8974em; vertical-align: -0.0833em;"></span><span class="mord">−</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span></span></span></span></span></span></span></span></span> ~ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
           
           
             2 
            
           
             31 
            
           
          
         
           2^{31} 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span></span></span></span></span></span></span></span></span>-1]</td></tr><tr><td>long</td><td>有符号的64位整数，范围：[<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
          
            − 
           
           
           
             2 
            
           
             63 
            
           
          
         
           -2^{63} 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8974em; vertical-align: -0.0833em;"></span><span class="mord">−</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">63</span></span></span></span></span></span></span></span></span></span></span></span></span> ~ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
           
           
             2 
            
           
             63 
            
           
          
         
           2^{63} 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">63</span></span></span></span></span></span></span></span></span></span></span></span></span>-1]</td></tr><tr><td>float</td><td>32位单精度浮点数</td></tr><tr><td>double</td><td>64位双精度浮点数</td></tr><tr><td>half_float</td><td>16位半精度IEEE754浮点类型</td></tr><tr><td>scaled_float</td><td>缩放类型的的浮点数，比如price:字段只需精确到分，57.34缩放因子为100，存储结果为5734</td></tr></tbody></table> 
<p><strong>文本类型</strong></p> 
<table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>text</td><td>会被分词处理。如果进行聚合、排序计算需要开启fielddata进行内存预加载，不建议此使用方法。</td></tr><tr><td>keyword</td><td>精准值，不会被分词。进行过滤、排序、聚合等操作时, 就应该使用keyword类型。</td></tr></tbody></table> 
<p><strong>范围类型</strong></p> 
<table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>integer_range</td><td>整数范围</td></tr><tr><td>long_range</td><td>长整数范围</td></tr><tr><td>float_range</td><td>浮点数范围</td></tr><tr><td>double_range</td><td>长浮点数范围</td></tr><tr><td>date_range</td><td>日期范围</td></tr><tr><td>ip_range</td><td>ip地址范围</td></tr></tbody></table> 
<p><strong>其他类型</strong></p> 
<table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>date</td><td>日期类型，可以设置日期的格式</td></tr><tr><td>date_nanos</td><td>日期纳秒类型</td></tr><tr><td>boolean</td><td>布尔类型</td></tr><tr><td>binary</td><td>二进制</td></tr></tbody></table> 
<p><strong>复杂类型</strong></p> 
<table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>object</td><td>json对象嵌套类型。文档可以包含内部对象, 内部对象也可以包含内部对象</td></tr><tr><td>nested</td><td>嵌套类型是对象数据类型的一个特例, 可以让array类型的对象被独立索引和搜索.</td></tr><tr><td>数组</td><td>数组不需要一个特定的数据类型，任何字段都默认可以包含一个或多个值，当然，这多个值都必须是字段指定的数据类型。</td></tr><tr><td>geo-point</td><td>地理点类型，地理点类型用于存储地理位置的经纬度。</td></tr><tr><td>geo-shape</td><td>地理形状类型</td></tr><tr><td>multi-fields</td><td>Multi-fields 通常用来以不同的方式或目的索引同一个字段。比如，一个字符串类型字段可以同时被映射为 text 类型以用于全文检索、 keyword字段用于排序或聚合。</td></tr></tbody></table> 
<p><strong>特殊类型</strong></p> 
<table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>ip</td><td>ip (IPv4 和 IPv6 地址)</td></tr><tr><td>completion</td><td>to provide auto-complete suggestions</td></tr><tr><td>token_count</td><td>to count the number of tokens in a string</td></tr><tr><td>murmur3</td><td>to compute hashes of values at index-time and store them in the index</td></tr><tr><td>annotated-text</td><td>to index text containing special markup (typically used for identifying named entities)</td></tr><tr><td>percolator</td><td>Accepts queries from the query-dsl</td></tr><tr><td>join</td><td>Defines parent/child relation for documents within the same index</td></tr><tr><td>alias</td><td>Defines an alias to an existing field</td></tr><tr><td>rank feature</td><td>Record numeric feature to boost hits at query time.</td></tr><tr><td>rank features</td><td>Record numeric features to boost hits at query time</td></tr><tr><td>dense vector</td><td>Record dense vectors of float values</td></tr><tr><td>sparse vector</td><td>Record sparse vectors of float values.</td></tr><tr><td>search-as-you-type</td><td>A text-like field optimized for queries to implement as-you-type completion</td></tr></tbody></table> 
<h4><a id="Elasticsearch__430"></a>二、Elasticsearch 基础操作</h4> 
<p>使用REST API可以对进行Elasticsearch 操作，详细的操作，查看官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" rel="nofollow">Elasticsearch 官方文档</a></p> 
<p>接下来，使用Elasticsearch python客户端对es 操作。</p> 
<p>首先安装Elasticsearch python库</p> 
<pre><code class="prism language-shell">pip <span class="token function">install</span> elasticsearch-dsl elasticsearch 
</code></pre> 
<p><code>elasticsearch-dsl</code>是对<code>elasticsearch</code>库进一步封装，也添加了<code>elasticsearch</code>中没有的复杂数据类型。</p> 
<p>这两个库的官方文档如下：</p> 
<p><a href="https://elasticsearch-py.readthedocs.io/en/v8.1.3/" rel="nofollow">elasticsearch 官方文档</a></p> 
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/index.html" rel="nofollow">elasticsearch 官方文档2</a></p> 
<p><a href="https://elasticsearch-dsl.readthedocs.io/en/latest/index.html" rel="nofollow">elasticsearch-dsl 官方文档</a></p> 
<p>首先启动一个elasticsearch环境：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch<span class="token punctuation">,</span> helpers
<span class="token keyword">from</span> elasticsearch_dsl <span class="token keyword">import</span> Search<span class="token punctuation">,</span> Q

hosts <span class="token operator">=</span> <span class="token string">'http://localhost:9200'</span>
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span>hosts<span class="token operator">=</span>hosts<span class="token punctuation">)</span>
s <span class="token operator">=</span> Search<span class="token punctuation">(</span>using<span class="token operator">=</span>es<span class="token punctuation">)</span>

<span class="token comment"># elasticsearch的启动信息</span>
es<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="21_index_472"></a>2.1 对index操作</h5> 
<p>elasticsearch库中，对index进行操作，都是在<code>es.indices.</code>下面的方法中进行操作的。</p> 
<p>下面是简单的对index增加、删除和判断是否存在的操作：</p> 
<pre><code class="prism language-python"><span class="token comment"># 判断index是否存在</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">)</span>

<span class="token comment"># 创建index</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'blog'</span><span class="token punctuation">)</span>

<span class="token comment"># 删除index</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'blog'</span><span class="token punctuation">)</span>
</code></pre> 
<p>有时我们需要设置数据结构和类型，来创建index，需要设置<code>mappings</code>：</p> 
<pre><code class="prism language-python"><span class="token comment"># 设置创建数据的结构和类型，以及index的参数</span>
body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"mappings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"group"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"performer"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"nested"</span><span class="token punctuation">}</span>  <span class="token comment"># 嵌套数据类型</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"demo3"</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>
</code></pre> 
<p>有时我们需要根据模板创建index，首先创建一个模板<code>es.indices.put_template</code>，<code>mappings</code>中是数据的结构和类型：</p> 
<pre><code class="prism language-python"><span class="token comment"># 创建模板</span>
body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"mappings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"@timestamp"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"date"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"settings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment"># 设置</span>
        <span class="token string">"number_of_shards"</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 分片数量</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"index_patterns"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"te*"</span><span class="token punctuation">,</span> <span class="token string">"bar*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment"># "priority": 500, # 优先级</span>
    <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment"># 版本号</span>

<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>put_template<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'template_1'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>

<span class="token comment"># 判断模板是否存在</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>exists_template<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'template_1'</span><span class="token punctuation">)</span>

<span class="token comment"># 根据模板创建索引</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'test1'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="22_document_541"></a>2.2 对document操作</h5> 
<p>对文档数据进行操作，在<code>es.</code>下面进行操作：</p> 
<pre><code class="prism language-python"><span class="token comment"># 插入数据，一般只需要设置id和document就可以了</span>
<span class="token comment"># 若没有index，则会动态创建一个index，并插入数据</span>
dody <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">"document"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"wangwu"</span><span class="token punctuation">,</span>
        <span class="token string">"age"</span><span class="token punctuation">:</span><span class="token number">20</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>index<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>dody<span class="token punctuation">)</span>

<span class="token comment"># 更新数据，</span>
<span class="token comment"># id是需要更新的文档id；doc是需要更新的数据。</span>
body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">"doc"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">25</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>update<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>

<span class="token comment"># 删除数据，删除对应id的文档</span>
es<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>查询数据：</p> 
<pre><code class="prism language-python"><span class="token comment"># get是获取一条文档</span>
es<span class="token punctuation">.</span>get<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'3'</span><span class="token punctuation">)</span>


<span class="token comment"># search是根据查询语句，对index进行查询</span>
<span class="token comment"># index可省略，这样是在全局进行搜索。</span>
body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match_all"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>
</code></pre> 
<p>搜索语句的语法在下面详细说明。</p> 
<h4><a id="Elasticsearch__DSL_596"></a>三、Elasticsearch 查询 DSL</h4> 
<p>Elasticsearch 查询 DSL大致关键字，首先浏览一下：</p> 
<pre><code>query:      查询语句
    match   匹配，可进行模糊匹配
    match_phrase    完全匹配
    match_all   全部输出
    term    完全匹配
    terms   一个字段，多值完全匹配
    multi_match     多字段，一个值匹配
        query
        fields
    prefix  前缀
    wildcard  模糊匹配 ?代表一个字符，*代表0个或多个字符
    regexp      正则匹配
    bool    条件查询
        must    全都满足，相当于and，计入得分
        filter  全都满足，相当于and，不计入得分
        must_not    全都不满足
        should      有一个满足，相当于or
    exists      字段存在
    range   范围查询
        field   具体字段
            gte     大于等于
            lt      小于

sort    排序语句
    field   具体字段
        order: desc/asc   升降序

aggs    聚合字段
    num

size    limit，限制输出的量
scroll  滚动输出，设置滚动存在的时间
</code></pre> 
<h5><a id="31_query__637"></a>3.1 query 部分</h5> 
<ul><li><strong>match</strong></li></ul> 
<p>match是模糊匹配，是对分词之后的结果（text类型）进行匹配。</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'match'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'hello'</span> <span class="token comment"># 只要message中包括hello，就会返回数据</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li><strong>match_phrase</strong></li></ul> 
<p>match_phrase是完全匹配， 对分词之前的文本进行匹配</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'match_phrase'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'hello'</span> <span class="token comment"># message为hello的文档，才会返回</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li><strong>match_all</strong></li></ul> 
<p>match_all全部输出。</p> 
<ul><li><strong>term</strong></li></ul> 
<p>term 完全匹配，才会返回文档。</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'term'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'hello'</span> <span class="token comment"># message为hello的文档，才会返回</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li><strong>terms</strong></li></ul> 
<p>一个字段多值匹配的</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'terms'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'world'</span><span class="token punctuation">]</span> <span class="token comment"># message为 hello或world 的文档，才会返回</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li><strong>multi_match</strong></li></ul> 
<p>multi_match: 多字段匹配某个值</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'multi_match'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span>
            <span class="token string">'fields'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li><strong>prefix</strong></li></ul> 
<p>prefix根据前缀进行模糊匹配</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'prefix'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'zhang'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li><strong>wildcard</strong></li></ul> 
<p>wildcard 模糊匹配，?代表一个字符，*代表0个或多个字符</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'wildcard'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'?hang*'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li><strong>regexp</strong></li></ul> 
<p>regexp：根据正则表达式进行匹配。</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'regexp'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'\w+'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li> <p><strong>bool</strong></p> <p>bool ：条件查询。其中有四种类型：must、filter、must_not、should</p> 
  <ul><li>must ：全部条件都需要满足，相当于and，返回结果计入得分。</li><li>filter：全部条件都需要满足，相当于and，返回结果<strong>不</strong>计入得分。</li><li>must_not：全都不满足</li><li>should：有一个满足就可以，相当于or</li></ul> </li></ul> 
<pre><code class="prism language-python">query <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'bool'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'must'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'regexp'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'\w+'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'term'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'should'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'regexp'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'wangwu'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'term'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'must_not'</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'match'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'wangwu'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'term'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'should'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'match'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'lisi'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'terms'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span>query<span class="token operator">=</span>query<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li><strong>exists</strong></li></ul> 
<p>exists：查询有某个字段的文档</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'exists'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'field'</span><span class="token punctuation">:</span> <span class="token string">'name'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>
</code></pre> 
<ul><li><strong>range</strong></li></ul> 
<p>range 范围查询。<code>gte</code>:大于等于；<code>lt</code>: 小于</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'range'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'gte'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
                <span class="token string">'lt'</span><span class="token punctuation">:</span> <span class="token number">30</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>
</code></pre> 
<p>…其他查询</p> 
<h5><a id="32__860"></a>3.2 其他部分</h5> 
<h6><a id="321__862"></a><strong>3.2.1 排序字段</strong></h6> 
<p>sort，可设置输出文档的顺序。</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'match_all'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'sort'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'order'</span><span class="token punctuation">:</span> <span class="token string">'desc'</span> <span class="token comment"># 根据年龄降序排序</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>
</code></pre> 
<h6><a id="322__882"></a>3.2.2 聚合字段</h6> 
<h6><a id="323_sizescroll_888"></a>3.2.3 size和scroll</h6> 
<p>size，相当于limit，限制输出的条数。</p> 
<p>scroll，滚动数据，当一个查询的结果有很多数据时，可以使用滚动查询。此参数是设置滚动查询存在的时间。</p> 
<pre><code class="prism language-python"><span class="token comment"># 翻页查询 scroll</span>
query <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'match_all'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
size <span class="token operator">=</span> <span class="token number">2</span>

data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment"># 第一次查询</span>
<span class="token comment"># 参数scroll的值是设置的 scroll 存活的时间，这里设置了2m，也就是2分钟</span>
res <span class="token operator">=</span> es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> query<span class="token operator">=</span>query<span class="token punctuation">,</span> scroll<span class="token operator">=</span><span class="token string">'2m'</span><span class="token punctuation">,</span> size<span class="token operator">=</span>size<span class="token punctuation">)</span>
data<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 计算需要翻页查询的次数</span>
total_num <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'total'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span>
times <span class="token operator">=</span> total_num<span class="token operator">//</span>size <span class="token keyword">if</span> total_num<span class="token operator">%</span>size <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> total_num<span class="token operator">//</span>size<span class="token operator">+</span><span class="token number">1</span>

<span class="token comment"># 滚动查询</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>times<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> es<span class="token punctuation">.</span>scroll<span class="token punctuation">(</span>scroll_id <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token string">'_scroll_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scroll<span class="token operator">=</span><span class="token string">'1m'</span><span class="token punctuation">)</span>
    data<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_922"></a>四、批量操作数据</h4> 
<h5><a id="41__926"></a>4.1 批量插入/更新/删除数据</h5> 
<p>使用<code>helpers.bulk(es, action)</code>可以批量处理数据。</p> 
<p>其中action是一个包含操作的迭代器，尽量使用生成器， 这样大批量的数据就不用加载到内存中了。</p> 
<p>actions, 中迭代的对象，尽量与search()返回值相同，类似如下：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span>
  <span class="token string">'_index'</span><span class="token punctuation">:</span> <span class="token string">'index-name'</span><span class="token punctuation">,</span>
  <span class="token string">'_id'</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
  <span class="token string">'_routing'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token string">'pipeline'</span><span class="token punctuation">:</span> <span class="token string">'my-ingest-pipeline'</span><span class="token punctuation">,</span>
  <span class="token string">'_source'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Hello World!"</span><span class="token punctuation">,</span>
    <span class="token string">"body"</span><span class="token punctuation">:</span> <span class="token string">"..."</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果_source不存在，它会从文档中弹出所有元数据字段，并将其余部分用作文档数据：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"_id"</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
  <span class="token string">"_routing"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Hello World!"</span><span class="token punctuation">,</span>
  <span class="token string">"body"</span><span class="token punctuation">:</span> <span class="token string">"..."</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>除了默认的添加文档，可以设置_op_type值，为index/delete/update，用于删除或更新值，如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># 添加</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">'_op_type'</span><span class="token punctuation">:</span> <span class="token string">'index'</span><span class="token punctuation">,</span>
  <span class="token string">'_index'</span><span class="token punctuation">:</span> <span class="token string">'index-name'</span><span class="token punctuation">,</span>
  <span class="token string">'_id'</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
  <span class="token string">'_source'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'question'</span><span class="token punctuation">:</span> <span class="token string">'The life, universe and everything.'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 更新</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">'_op_type'</span><span class="token punctuation">:</span> <span class="token string">'update'</span><span class="token punctuation">,</span>
  <span class="token string">'_index'</span><span class="token punctuation">:</span> <span class="token string">'index-name'</span><span class="token punctuation">,</span>
  <span class="token string">'_id'</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
  <span class="token string">'_source'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'question'</span><span class="token punctuation">:</span> <span class="token string">'The life.'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 删除</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">'_op_type'</span><span class="token punctuation">:</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token string">'_index'</span><span class="token punctuation">:</span> <span class="token string">'index-name'</span><span class="token punctuation">,</span>
  <span class="token string">'_id'</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="42_upsert_991"></a>4.2 更新插入数据upsert</h5> 
<p>在一个kafka同步es的项目中，有两个topic需要消费，且需要把这个两个数据合并，于是就有了下面的需求：</p> 
<ul><li>当数据不存在时，插入数据。</li><li>当数据存在时，更新数据。</li></ul> 
<p>对于每条数据都进行判断的话，效率太低，于是就有了<code>upsert</code>这个方法。</p> 
<p><strong>方法一：</strong></p> 
<p>具体参考：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"_op_type"</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token string-property property">'_index'</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token string-property property">'_id'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">'_source'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">'upsert'</span><span class="token operator">:</span> data<span class="token punctuation">,</span>
        <span class="token string-property property">'script'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">'source'</span><span class="token operator">:</span> script<span class="token punctuation">,</span>
            <span class="token string-property property">'params'</span><span class="token operator">:</span> data
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行的逻辑是：</p> 
<ul><li>若id不存在，则直接插入<code>upsert</code>的数据。</li><li>若id存在，则执行<code>script</code>脚本。</li></ul> 
<p>所以把script脚本写成更新脚本，就可以起到更新数据的效果。</p> 
<p>具体实现：</p> 
<pre><code class="prism language-python">data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'zhang'</span>
<span class="token punctuation">}</span>

<span class="token comment"># 创建更新脚本</span>
script <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> k <span class="token keyword">in</span> data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    script <span class="token operator">+=</span> <span class="token string">'ctx._source.{0}=params.{0};'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>

action <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">'_op_type'</span><span class="token punctuation">:</span> <span class="token string">'update'</span><span class="token punctuation">,</span>
    <span class="token string">'_index'</span><span class="token punctuation">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
    <span class="token string">'_id'</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'_source'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'upsert'</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
        <span class="token string">'script'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'source'</span><span class="token punctuation">:</span> script<span class="token punctuation">,</span>
            <span class="token string">'params'</span><span class="token punctuation">:</span> data
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

helpers<span class="token punctuation">.</span>bulk<span class="token punctuation">(</span>es<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
</code></pre> 
<p>方法二(简单)：</p> 
<p>具体参考：<a href="https://blog.csdn.net/yyd19921214/article/details/72626241">elasticsearch中批量的upsert</a></p> 
<p>可以设置参数<code>"doc_as_upsert" : true</code></p> 
<p>具体实现：</p> 
<pre><code class="prism language-python">data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'zhang'</span>
<span class="token punctuation">}</span>

action <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">'_op_type'</span><span class="token punctuation">:</span> <span class="token string">'update'</span><span class="token punctuation">,</span>
    <span class="token string">'_index'</span><span class="token punctuation">:</span> <span class="token string">'world'</span><span class="token punctuation">,</span>
    <span class="token string">'_id'</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'doc_as_upsert'</span> <span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">'doc'</span><span class="token punctuation">:</span> data
<span class="token punctuation">}</span><span class="token punctuation">]</span>

helpers<span class="token punctuation">.</span>bulk<span class="token punctuation">(</span>es<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_1090"></a>五、文本分析</h4> 
<p>基本定义内容：[text analyze](./text analyze.md)</p> 
<p>默认情况下，Elasticsearch 使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-standard-analyzer.html" rel="nofollow"><code>standard</code>分析器</a>进行所有文本分析。该<code>standard</code>分析器为您提供对大多数自然语言和用例的开箱即用支持。如果您选择按原样使用<code>standard</code> 分析器，则无需进一步配置。</p> 
<p>如果标准分析器不符合您的需求，请查看并测试 Elasticsearch 的其他内置<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html" rel="nofollow">分析器</a>。内置分析器不需要配置，但有一些支持选项可用于调整其行为。例如，您可以使用<code>standard</code>要删除的自定义停用词列表配置分析器。</p> 
<p>如果没有适合您需求的内置分析器，您可以测试并创建自定义分析器。自定义分析器涉及选择和组合不同的 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer-anatomy.html" rel="nofollow">分析器组件</a>，让您更好地控制过程。</p> 
<h5><a id="51__1104"></a>5.1 测试分析器</h5> 
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-analyze.html" rel="nofollow"><code>analyze</code>API</a>是查看分析器生成术语的工具。可以在请求中内联指定内置分析器：</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> _analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"whitespace"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"text"</span><span class="token operator">:</span>     <span class="token string">"The quick brown fox."</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在python API中使用：</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'analyzer'</span><span class="token punctuation">:</span> <span class="token string">'whitespace'</span><span class="token punctuation">,</span>
    <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token string">"The quick brown fox."</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>analyze<span class="token punctuation">(</span>body<span class="token operator">=</span>body<span class="token punctuation">)</span>
</code></pre> 
<p>它将返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"tokens"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span><span class="token operator">:</span> <span class="token string">"The"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span><span class="token operator">:</span> <span class="token string">"quick"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span><span class="token operator">:</span> <span class="token string">"brown"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span><span class="token operator">:</span> <span class="token string">"fox."</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中包括分词的结果，开始分词的偏移量，结束分词的偏移量，类型和分词流的位置。</p> 
<p>一个分析器包括：</p> 
<ul><li> <p>零个或多个字符过滤器<code>char_filter</code></p> </li><li> <p>一个分词器<code>tokenizer</code></p> </li><li> <p>零个或多个令牌过滤器<code>filter</code></p> </li></ul> 
<p>比如使用自定义的分析器：</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> _analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"filter"</span><span class="token operator">:</span>  <span class="token punctuation">[</span> <span class="token string">"lowercase"</span><span class="token punctuation">,</span> <span class="token string">"asciifolding"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"text"</span><span class="token operator">:</span>      <span class="token string">"Is this déja vu?"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python API</p> 
<pre><code class="prism language-PYTHON">body = {
  "tokenizer": "standard",
  "filter":  [ "lowercase", "asciifolding" ],
  "text":      "Is this déja vu?"
}
es.indices.analyze(body=body)
</code></pre> 
<p>它将返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"tokens"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span><span class="token operator">:</span> <span class="token string">"is"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"&lt;ALPHANUM&gt;"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span><span class="token operator">:</span> <span class="token string">"this"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"&lt;ALPHANUM&gt;"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span><span class="token operator">:</span> <span class="token string">"deja"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"&lt;ALPHANUM&gt;"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span><span class="token operator">:</span> <span class="token string">"vu"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span><span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"&lt;ALPHANUM&gt;"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><strong>位置和字符偏移</strong></p> 
 <p>从<code>analyze</code>API 的输出可以看出，Analyzer 不仅将词转换为词，还记录每个词的顺序或相对位置（用于短语查询或词邻近查询），以及每个词的开始和结束字符偏移量。</p> 
</blockquote> 
<p>当然也可以在特定索引上运行<code>analyze</code>,API可以参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-custom-analyzer.html" rel="nofollow"><code>custom</code>分析器</a>：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"std_folded"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"custom"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"lowercase"</span><span class="token punctuation">,</span>
            <span class="token string">"asciifolding"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"my_text"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"std_folded"</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">GET</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_analyze 
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"std_folded"</span><span class="token punctuation">,</span> 
  <span class="token string-property property">"text"</span><span class="token operator">:</span>     <span class="token string">"Is this déjà vu?"</span>
<span class="token punctuation">}</span>

<span class="token constant">GET</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_analyze 
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"my_text"</span><span class="token punctuation">,</span> 
  <span class="token string-property property">"text"</span><span class="token operator">:</span>  <span class="token string">"Is this déjà vu?"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python API</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"analysis"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"analyzer"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"std_folded"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"custom"</span><span class="token punctuation">,</span>
          <span class="token string">"tokenizer"</span><span class="token punctuation">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
          <span class="token string">"filter"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"lowercase"</span><span class="token punctuation">,</span>
            <span class="token string">"asciifolding"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"mappings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"my_text"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string">"analyzer"</span><span class="token punctuation">:</span> <span class="token string">"std_folded"</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 创建index</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'my-index-000001'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>


<span class="token comment"># 可以指定分析器，或者指定某个text字段（使用它的分析器）</span>
body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string">"analyzer"</span><span class="token punctuation">:</span> <span class="token string">"std_folded"</span><span class="token punctuation">,</span> 
  <span class="token string">"text"</span><span class="token punctuation">:</span>     <span class="token string">"Is this déjà vu?"</span>
<span class="token punctuation">}</span>
body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string">"field"</span><span class="token punctuation">:</span> <span class="token string">"my_text"</span><span class="token punctuation">,</span> 
  <span class="token string">"text"</span><span class="token punctuation">:</span>  <span class="token string">"Is this déjà vu?"</span>
<span class="token punctuation">}</span>
<span class="token comment"># 使用index中的分析器</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>analyze<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'my-index-000001'</span><span class="token punctuation">,</span> body<span class="token operator">=</span>body<span class="token punctuation">)</span>
</code></pre> 
<p>输出结果和上面单独使用analyze一样。</p> 
<h5><a id="52__1335"></a>5.2 内置的分析器</h5> 
<p>内置分析器无需任何配置即可直接使用。但是，其中一些支持配置选项以改变其行为。例如，可以将<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-standard-analyzer.html" rel="nofollow"><code>standard</code>分析器</a>配置为支持停用词列表：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"std_english"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token string-property property">"type"</span><span class="token operator">:</span>      <span class="token string">"standard"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"stopwords"</span><span class="token operator">:</span> <span class="token string">"_english_"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"my_text"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span>     <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span> 
        <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"english"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"type"</span><span class="token operator">:</span>     <span class="token string">"text"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"std_english"</span> 
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"my_text"</span><span class="token punctuation">,</span> 
  <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"The old brown cow"</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"my_text.english"</span><span class="token punctuation">,</span> 
  <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"The old brown cow"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python API:</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"analysis"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"analyzer"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"std_english"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token string">"type"</span><span class="token punctuation">:</span>      <span class="token string">"standard"</span><span class="token punctuation">,</span>
          <span class="token string">"stopwords"</span><span class="token punctuation">:</span> <span class="token string">"_english_"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"mappings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"my_text"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token punctuation">:</span>     <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string">"analyzer"</span><span class="token punctuation">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span> 
        <span class="token string">"fields"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"english"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token punctuation">:</span>     <span class="token string">"text"</span><span class="token punctuation">,</span>
            <span class="token string">"analyzer"</span><span class="token punctuation">:</span> <span class="token string">"std_english"</span> 
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'my-index-000001'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>


body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'field'</span><span class="token punctuation">:</span> <span class="token string">'my_text'</span><span class="token punctuation">,</span>
    <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token string">'The old brown cow'</span>
<span class="token punctuation">}</span>
<span class="token comment"># and</span>
body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'field'</span><span class="token punctuation">:</span> <span class="token string">'my_text.english'</span><span class="token punctuation">,</span>
    <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token string">'The old brown cow'</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>analyze<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'my-index-000001'</span><span class="token punctuation">,</span> body<span class="token operator">=</span>body<span class="token punctuation">)</span>
</code></pre> 
<p>我们将<code>std_english</code>分析器定义为基于<code>standard</code> 分析器，但配置为删除预定义的英语停用词列表。</p> 
<p>该<code>my_text</code>字段<code>standard</code>直接使用分析仪，无需任何配置。不会从此字段中删除停用词。 分词的结果是：<code>[ the, old, brown, cow ]</code></p> 
<p>该<code>my_text.english</code>字段使用<code>std_english</code>分析器，因此将删除英文停用词。分词的结果是：<code> [ old, brown, cow ]</code></p> 
<h5><a id="53__1437"></a>5.3 自定义分析器</h5> 
<p>当内置分析器不能满足您的需求时，您可以创建一个 <code>custom</code>，它需要满足：</p> 
<ul><li>零个或多个<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-charfilters.html" rel="nofollow">字符过滤器</a></li><li>分<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html" rel="nofollow">词器</a></li><li>零个或多个<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenfilters.html" rel="nofollow">令牌过滤器</a>。</li></ul> 
<h6><a id="531__1447"></a>5.3.1 配置</h6> 
<p><code>custom</code>分析器接受以下参数：</p> 
<table><thead><tr><th>配置</th><th>说明</th></tr></thead><tbody><tr><td><code>type</code></td><td>分析仪类型。接受<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html" rel="nofollow">内置分析器类型</a>。对于自定义分析器，使用<code>custom</code>或省略此参数。</td></tr><tr><td><code>tokenizer</code></td><td>内置或定制的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html" rel="nofollow">分词器</a>。（必需的）</td></tr><tr><td><code>char_filter</code></td><td>可选的内置或自定义 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-charfilters.html" rel="nofollow">字符过滤器</a>数组。</td></tr><tr><td><code>filter</code></td><td>可选的内置或自定义 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenfilters.html" rel="nofollow">令牌过滤器</a>数组。</td></tr><tr><td><code>position_increment_gap</code></td><td>当索引一个文本值数组时，Elasticsearch 在一个值的最后一个词和下一个值的第一个词之间插入一个假的“间隙”，以确保一个短语查询不匹配来自不同数组元素的两个词。默认为<code>100</code>. 查看<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/position-increment-gap.html" rel="nofollow"><code>position_increment_gap</code></a>更多</td></tr></tbody></table> 
<h6><a id="532__1461"></a>5.3.2 自定义分析器示例</h6> 
<p><strong>示例一</strong></p> 
<p>这是一个结合了以下内容的示例：</p> 
<ul><li> <p><strong>字符过滤器</strong></p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-htmlstrip-charfilter.html" rel="nofollow">HTML 带字符过滤器</a></p> </li><li> <p><strong>分词器</strong></p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-standard-tokenizer.html" rel="nofollow">标准分词器</a></p> </li><li> <p><strong>令牌过滤器</strong></p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-lowercase-tokenfilter.html" rel="nofollow">小写标记过滤器</a></p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-asciifolding-tokenfilter.html" rel="nofollow">ASCII 折叠令牌过滤器</a></p> </li></ul> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"my_custom_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"custom"</span><span class="token punctuation">,</span> 
          <span class="token string-property property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"html_strip"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"lowercase"</span><span class="token punctuation">,</span>
            <span class="token string">"asciifolding"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_custom_analyzer"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"Is this &lt;b&gt;déjà vu&lt;/b&gt;?"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python API</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"analysis"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"analyzer"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"my_custom_analyzer"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"custom"</span><span class="token punctuation">,</span> 
          <span class="token string">"tokenizer"</span><span class="token punctuation">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
          <span class="token string">"char_filter"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"html_strip"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"filter"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"lowercase"</span><span class="token punctuation">,</span>
            <span class="token string">"asciifolding"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>put_settings<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'my-index-000001'</span><span class="token punctuation">,</span> body<span class="token operator">=</span>body<span class="token punctuation">)</span>
<span class="token comment"># 使用上面的put_settings时，需要先关闭index ,使用时再打开index</span>
<span class="token comment"># es.indices.close(index='')</span>
<span class="token comment"># es.indices.open(index='')</span>

body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string">"analyzer"</span><span class="token punctuation">:</span> <span class="token string">"my_custom_analyzer"</span><span class="token punctuation">,</span>
  <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"Is this &lt;b&gt;déjà vu&lt;/b&gt;?"</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>analyze<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'my-index-000001'</span><span class="token punctuation">,</span> body<span class="token operator">=</span>body<span class="token punctuation">)</span>
</code></pre> 
<p>返回的结果是：</p> 
<pre><code class="prism language-text">[ is, this, deja, vu ]
</code></pre> 
<blockquote> 
 <p>关闭索引，可以修改index的分析器和相关性参数</p> 
 <p>python api使用<code>put_settings</code>和<code>put_mappings</code></p> 
</blockquote> 
<p>前面的示例使用了标记器、标记过滤器和字符过滤器及其默认配置，但可以创建每个配置的版本并在自定义分析器中使用它们。</p> 
<p><strong>示例二</strong></p> 
<p>这是一个更复杂的示例，它结合了以下内容：</p> 
<ul><li> <p><strong>字符过滤器</strong></p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-mapping-charfilter.html" rel="nofollow">映射字符过滤器</a>，配置为替换<code>:)</code>为<code>_happy_</code>和<code>:(``_sad_</code></p> </li><li> <p><strong>分词器</strong></p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-pattern-tokenizer.html" rel="nofollow">Pattern Tokenizer</a>，配置为在标点符号上拆分</p> </li><li> <p><strong>令牌过滤器</strong></p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-lowercase-tokenfilter.html" rel="nofollow">小写标记过滤器</a></p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-stop-tokenfilter.html" rel="nofollow">Stop Token Filter</a>，配置为使用预定义的英文停用词列表</p> </li></ul> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"my_custom_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token string-property property">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"emoticons"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string-property property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"punctuation"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"lowercase"</span><span class="token punctuation">,</span>
            <span class="token string">"english_stop"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"tokenizer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"punctuation"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"pattern"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"pattern"</span><span class="token operator">:</span> <span class="token string">"[ .,!?]"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"emoticons"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"mapping"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">":) =&gt; _happy_"</span><span class="token punctuation">,</span>
            <span class="token string">":( =&gt; _sad_"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"english_stop"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"stop"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"stopwords"</span><span class="token operator">:</span> <span class="token string">"_english_"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_custom_analyzer"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"I'm a :) person, and you?"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python API:</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'settings'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'analysis'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'analyzer'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'my_custom_analyzer'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">'char_filter'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'emoticons'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">'tokenizer'</span><span class="token punctuation">:</span> <span class="token string">'punctuation'</span><span class="token punctuation">,</span>
                    <span class="token string">'filter'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'lowercase'</span><span class="token punctuation">,</span> <span class="token string">'english_stop'</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">'tokenizer'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'punctuation'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'pattern'</span><span class="token punctuation">,</span>
                    <span class="token string">'pattern'</span><span class="token punctuation">:</span> <span class="token string">'[ .,!?]'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">'char_filter'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'emoticons'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'mapping'</span><span class="token punctuation">,</span>
                    <span class="token string">'mappings'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">':) =&gt; _happy_'</span><span class="token punctuation">,</span>
                        <span class="token string">':( =&gt; _sad_'</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">'filter'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'english_stop'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'stop'</span><span class="token punctuation">,</span>
                    <span class="token string">'stopwords'</span><span class="token punctuation">:</span> <span class="token string">'_english_'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>put_settings<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'my-index-000001'</span><span class="token punctuation">,</span> body<span class="token operator">=</span>body<span class="token punctuation">)</span>
<span class="token comment"># 记得先关闭index</span>

body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'analyzer'</span><span class="token punctuation">:</span> <span class="token string">'my_custom_analyzer'</span><span class="token punctuation">,</span>
    <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token string">"I'm a :) person, and you?"</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>analyze<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'my-index-000001'</span><span class="token punctuation">,</span> body<span class="token operator">=</span>body<span class="token punctuation">)</span>
</code></pre> 
<p>为索引分配一个默认的自定义分析器，<code>my_custom_analyzer</code>. 此分析器使用稍后在请求中定义的自定义标记器、字符过滤器和标记过滤器。该分析器也省略了<code>type</code>参数。</p> 
<p>它将返回：</p> 
<pre><code class="prism language-text">[ i'm, _happy_, person, you ]
</code></pre> 
<h5><a id="54__1692"></a>5.4 指定分析器的方式</h5> 
<p>Elasticsearch 提供了多种方法来指定内置或自定义分析器：</p> 
<ul><li>按<code>text</code>字段，分词</li><li>对于索引的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-index-search-time.html" rel="nofollow">搜索时间</a></li></ul> 
<blockquote> 
 <h4><a id="_1701"></a>把事情简单化</h4> 
 <p>在不同级别和不同时间指定分析仪的灵活性非常好……但仅在需要时。</p> 
 <p>在大多数情况下，一个简单的方法效果最好：为每个 <code>text</code>字段指定一个分析器，如为字段<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/specify-analyzer.html#specify-index-field-analyzer" rel="nofollow">指定分析器中所述</a>。</p> 
 <p>这种方法适用于 Elasticsearch 的默认行为，让您可以使用相同的分析器进行索引和搜索。它还可以让您使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-get-mapping.html" rel="nofollow">get mapping API</a>快速查看哪个分析器适用于哪个字段。</p> 
 <p>如果您通常不为索引创建映射，则可以使用 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-templates.html" rel="nofollow">索引模板</a>来实现类似的效果。</p> 
</blockquote> 
<h6><a id="541_Elasticsearch__1715"></a>5.4.1 Elasticsearch 索引分析器</h6> 
<p>Elasticsearch 通过依次检查以下参数来确定要使用的索引分析器：</p> 
<ol><li>字段的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer.html" rel="nofollow"><code>analyzer</code></a>映射参数。请参阅<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/specify-analyzer.html#specify-index-field-analyzer" rel="nofollow">为字段指定分析器</a>。</li><li><code>analysis.analyzer.default</code>索引设置 。请参阅<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/specify-analyzer.html#specify-index-time-default-analyzer" rel="nofollow">为索引指定默认分析器</a>。</li></ol> 
<p>如果没有指定这些参数， 则使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-standard-analyzer.html" rel="nofollow"><code>standard</code>分析器</a>。</p> 
<p><strong>5.4.1.1 指定字段的分析器</strong></p> 
<p>映射索引时，可以使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer.html" rel="nofollow"><code>analyzer</code></a>映射参数为每个<code>text</code>字段指定一个分析器。</p> 
<p>以下<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html" rel="nofollow">创建索引 API</a>请求将 <code>whitespace</code>分析器设置为<code>title</code>字段的分析器。</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"whitespace"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>5.4.1.2 指定索引的默认分析器</strong></p> 
<p>除了字段级分析器之外，您还可以设置备用分析器以使用该<code>analysis.analyzer.default</code>设置。</p> 
<p>以下<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html" rel="nofollow">创建索引 API</a>请求将 <code>simple</code>分析器设置为<code>my-index-000001</code>.</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"default"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"simple"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="542_Elasticsearch__1773"></a>5.4.2 Elasticsearch 搜索分析器</h6> 
<p>在大多数情况下，不需要指定不同的搜索分析器。这样做可能会对相关性产生负面影响并导致意外的搜索结果。</p> 
<p>如果您选择指定单独的搜索分析器，我们建议您在部署到生产环境之前彻底<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/test-analyzer.html" rel="nofollow">测试您的分析配置</a>。</p> 
<p>在搜索时，Elasticsearch 通过依次检查以下参数来确定要使用的分析器：</p> 
<ol><li>搜索查询中的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer.html" rel="nofollow"><code>analyzer</code></a>参数。请参阅<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/specify-analyzer.html#specify-search-query-analyzer" rel="nofollow">为查询指定搜索分析器</a>。</li><li>字段的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-analyzer.html" rel="nofollow"><code>search_analyzer</code></a>映射参数。请参阅<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/specify-analyzer.html#specify-search-field-analyzer" rel="nofollow">为字段指定搜索分析器</a>。</li><li><code>analysis.analyzer.default_search</code>索引设置 。请参阅<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/specify-analyzer.html#specify-search-default-analyzer" rel="nofollow">为索引指定默认搜索分析器</a>。</li><li>字段的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer.html" rel="nofollow"><code>analyzer</code></a>映射参数。请参阅<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/specify-analyzer.html#specify-index-field-analyzer" rel="nofollow">为字段指定分析器</a>。</li></ol> 
<p>如果没有指定这些参数， 则使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-standard-analyzer.html" rel="nofollow"><code>standard</code>分析器</a>。</p> 
<p><strong>5.4.2.1 指定查询的搜索分析器</strong></p> 
<p>编写<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html" rel="nofollow">全文查询</a>时，可以使用<code>analyzer</code> 参数指定搜索分析器。如果提供，它将覆盖任何其他搜索分析器。</p> 
<p>以下<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html" rel="nofollow">搜索 API</a>请求将<code>stop</code>分析器设置为<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html" rel="nofollow"><code>match</code></a>查询的搜索分析器。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"Quick foxes"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"stop"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python API</p> 
<pre><code class="prism language-python">body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'match'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'query'</span><span class="token punctuation">:</span> <span class="token string">'Quick foxes'</span><span class="token punctuation">,</span>
                <span class="token string">'analyzer'</span><span class="token punctuation">:</span> <span class="token string">'stop'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'my-index-000001'</span><span class="token punctuation">,</span> <span class="token operator">**</span>body<span class="token punctuation">)</span>
</code></pre> 
<p><strong>5.4.2.2 指定字段的搜索分析器</strong></p> 
<p>映射索引时，您可以使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer.html" rel="nofollow"><code>search_analyzer</code></a>映射参数为每个<code>text</code>字段指定搜索分析器。</p> 
<p><strong>如果提供了搜索分析器，则还必须使用<code>analyzer</code>参数指定索引分析器。</strong></p> 
<p>以下<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html" rel="nofollow">创建索引 API</a>请求将 <code>simple</code>分析器设置为<code>title</code>字段的搜索分析器。</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"whitespace"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"simple"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>5.4.2.3 指定索引的默认搜索分析器</strong></p> 
<p>创建<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html" rel="nofollow">索引</a>时，您可以使用该设置设置默认搜索分析器<code>analysis.analyzer.default_search</code>。</p> 
<p><strong>如果提供了搜索分析器，则还必须使用该<code>analysis.analyzer.default</code>设置指定默认索引分析器。</strong></p> 
<p>以下 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html" rel="nofollow">创建索引 API</a>请求将 <code>whitespace</code>分析器设置为<code>my-index-000001</code>索引的默认搜索分析器。</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"default"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"simple"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"default_search"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"whitespace"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="alias_1885"></a>六、别名alias</h4> 
<p>别名是一组数据流或索引的辅助名称。大多数 Elasticsearch API 接受别名来代替数据流或索引名称。</p> 
<p>您可以随时更改别名的数据流或索引。如果您在应用程序的 Elasticsearch 请求中使用别名，则可以在不停机或更改应用程序代码的情况下重新索引数据。</p> 
<h5><a id="61__1893"></a>6.1 别名类型</h5> 
<p>有两种类型的别名：</p> 
<ul><li><strong>数据流别名</strong>指向一个或多个数据流 。</li><li><strong>索引别名</strong>指向一个或多个索引 。</li></ul> 
<p>别名不能同时指向数据流和索引。也不能将数据流的支持索引添加到索引别名。</p> 
<h5><a id="62__1904"></a>6.2 添加别名</h5> 
<p>要将现有数据流或索引添加到别名，请使用 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-aliases.html" rel="nofollow">aliases API</a>的<code>add</code>操作。如果别名不存在，则请求创建它.</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> _aliases
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"add"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"logs-nginx.access-prod"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"logs"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python api</p> 
<pre><code class="prism language-python">es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>put_alias<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'world-test1'</span><span class="token punctuation">)</span>
</code></pre> 
<p>API的index和indices参数支持通配符(*)。同时匹配数据流和索引的通配符模式将返回错误。</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> _aliases
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"add"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"logs-*"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"logs"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python api</p> 
<pre><code class="prism language-python">es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>put_alias<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'wor*'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'world-test1'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="63__1954"></a>6.3 删除别名</h5> 
<p>要删除别名，使用 aliases API 的<code>remove</code>操作。</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> _aliases
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"remove"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"logs-nginx.access-prod"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"logs"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python api</p> 
<pre><code class="prism language-python">es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>delete_alias<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'world-test1'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="64__1982"></a>6.4 别名多个操作</h5> 
<p>可以使用aliases API 在单个原子操作中执行多个操作。</p> 
<p>例如，<code>logs</code>别名指向单个数据流。以下请求将流交换为别名。在此交换期间，<code>logs</code>别名没有停机时间，并且永远不会同时指向两个流。</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> _aliases
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"remove"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"logs-nginx.access-prod"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"logs"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"add"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"logs-my_app-default"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"logs"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="65__2012"></a>6.5 其他操作</h5> 
<p>具体详见：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/aliases.html#remove-alias" rel="nofollow">官方别名操作</a></p> 
<p>引用：</p> 
<p><a href="https://blog.csdn.net/god8816/article/details/109845894">3.elasticsearch数据类型总结</a></p> 
<p>“whitespace”<br> }<br> }<br> }<br> }<br> }</p> 
<pre><code>




### 六、别名alias

别名是一组数据流或索引的辅助名称。大多数 Elasticsearch API 接受别名来代替数据流或索引名称。

您可以随时更改别名的数据流或索引。如果您在应用程序的 Elasticsearch 请求中使用别名，则可以在不停机或更改应用程序代码的情况下重新索引数据。



#### 6.1 别名类型

有两种类型的别名：

- **数据流别名**指向一个或多个数据流 。
- **索引别名**指向一个或多个索引 。

别名不能同时指向数据流和索引。也不能将数据流的支持索引添加到索引别名。



#### 6.2 添加别名

要将现有数据流或索引添加到别名，请使用 [aliases API](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-aliases.html)的`add`操作。如果别名不存在，则请求创建它.

```json
POST _aliases
{
  "actions": [
    {
      "add": {
        "index": "logs-nginx.access-prod",
        "alias": "logs"
      }
    }
  ]
}
</code></pre> 
<p>python api</p> 
<pre><code class="prism language-python">es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>put_alias<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'world-test1'</span><span class="token punctuation">)</span>
</code></pre> 
<p>API的index和indices参数支持通配符(*)。同时匹配数据流和索引的通配符模式将返回错误。</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> _aliases
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"add"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"logs-*"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"logs"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python api</p> 
<pre><code class="prism language-python">es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>put_alias<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'wor*'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'world-test1'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="63__2107"></a>6.3 删除别名</h5> 
<p>要删除别名，使用 aliases API 的<code>remove</code>操作。</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> _aliases
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"remove"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"logs-nginx.access-prod"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"logs"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>python api</p> 
<pre><code class="prism language-python">es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>delete_alias<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'world'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'world-test1'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="64__2135"></a>6.4 别名多个操作</h5> 
<p>可以使用aliases API 在单个原子操作中执行多个操作。</p> 
<p>例如，<code>logs</code>别名指向单个数据流。以下请求将流交换为别名。在此交换期间，<code>logs</code>别名没有停机时间，并且永远不会同时指向两个流。</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> _aliases
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"remove"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"logs-nginx.access-prod"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"logs"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"add"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"logs-my_app-default"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"alias"</span><span class="token operator">:</span> <span class="token string">"logs"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="65__2165"></a>6.5 其他操作</h5> 
<p>具体详见：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/aliases.html#remove-alias" rel="nofollow">官方别名操作</a></p> 
<p>引用：</p> 
<p><a href="https://blog.csdn.net/god8816/article/details/109845894">3.elasticsearch数据类型总结</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/81e77dcf8ac3cf4aa5edf050530fba3b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringBoot 如何将配置文件挂到 jar 包外面？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8343c8a05629e2fa55402a069c2c8563/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">实现Postman&#43;Newman&#43;Git&#43;Jenkins&#43;钉钉/邮件提醒接口自动化测试持续集成</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>