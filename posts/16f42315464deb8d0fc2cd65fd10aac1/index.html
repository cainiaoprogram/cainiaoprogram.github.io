<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>一文看懂目标检测之RCNN（NMS和Soft-NMS算法） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="一文看懂目标检测之RCNN（NMS和Soft-NMS算法）" />
<meta property="og:description" content="目标检测之RCNN 1. RCNN:Regions with CNN features[2014 Ross] 图片输入区域建议(region proposal)特征提取(feature extraction)分类&#43;2次定位(classification(SVM) &#43; detection(线性模型Linear 正则化项)) 2. 区域建议 算法：selective search前景分割，将纹理、形状、颜色相似的合在一起，目前比较少人用，数学公式复杂，难用，效果还不太好，不建议看大概2K多个候选框，包括很多感兴趣尽可能囊括到候选框，粗筛2k个候选框的图片，每个做resize到固定大小，固定大小里有无物体，进入分类网络判断 3. 特征提取 a.在数据集ILSVRC2012 dataset上预训练好的分类网络(AlexNet)直接拿来用，将大约2k个图片一个个送到分类网络（backbone），只拿了特征提取层，扔掉了最后的1*1000的分类层。b.在真实数据集上finetune微调，主要更新后两层全连接dense层c.训练样本正样本和负样本比例为1:3c.IOU小于0.5,给定比较宽松的限制条件，对应较为复杂的网络，样本才不会显得过于少提取CNN特征前必须resize到统一大小,因为后面有FC层，参数是固定的问题：resize后改变了图片本身信息——长方形的旗杆resize压缩成成正方形后，他还是旗杆吗？这个仍然需要改善 4. SVM分类器分类 &#43; NMS算法筛选 &#43; 边界框回归(BBox Regression) 4.1. SVM分类(少样本模型) 给每个样本做分类正样本：Groud True负样本：IOU &lt; 0.3[others ignored]Q：和AlexNet网络训练相比，svm分类时IOU的阈值threshould为什么不一样？A：训练CNN需要更多数据样本，更多数据样本不一定质量高，svm分类时需要质量高数据样本Q：为什么用SVM,为什么不直接用AlexNet最后的softmax？A：AlexNet专注于分类, 不好用少数样本来做定位。数据多，质量差；数据少，质量高，数据少时用SVM相对好一些 4.2. NMS(Non-Maximum Suppression)非极大值抑制算法(很重要) NMS广泛应用于目标检测算法中。其目的是为了消除多余的候选框，找到最佳的物体检测位置。
每个类别置信程度score越高，越能说明物体在框里面取score值最高的一个框，将其他的框和他的iou越大，越可能是同一个物体，所以去掉其他和该框iou高于某一阀值候选框代码实现 import numpy as np def NMS(lists, thre): if len(lists) == 0: return {} lists = np.array(lists) res = [] #取得第i列，第0列为x1,第1列为y1... x1, y1, x2, y2, score = [lists[:, i] for i in range(5)] area = (x2 - x1 &#43; 1) * (y2 - y1 &#43; 1) # get sorted index in ascending order idxs = np." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/16f42315464deb8d0fc2cd65fd10aac1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-07T20:50:02+08:00" />
<meta property="article:modified_time" content="2020-05-07T20:50:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">一文看懂目标检测之RCNN（NMS和Soft-NMS算法）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="RCNN_1"></a>目标检测之RCNN</h2> 
<h3><a id="1_RCNNRegions_with_CNN_featureshttpsarxivorgabs13112524v32014_Ross_2"></a>1. <a href="https://arxiv.org/abs/1311.2524v3" rel="nofollow">RCNN:Regions with CNN features</a>[2014 Ross]</h3> 
<p><img src="https://images2.imgbox.com/be/b1/VXwoTnKw_o.png" alt="RCNN.md.png"></p> 
<ol><li>图片输入</li><li>区域建议(region proposal)</li><li>特征提取(feature extraction)</li><li>分类+2次定位(classification(SVM) + detection(线性模型Linear 正则化项))</li></ol> 
<h3><a id="2__10"></a>2. 区域建议</h3> 
<ul><li>算法：<a href="https://blog.csdn.net/niaolianjiulin/article/details/52950797">selective search</a>前景分割，将纹理、形状、颜色相似的合在一起，目前比较少人用，数学公式复杂，难用，效果还不太好，不建议看</li><li>大概2K多个候选框，包括很多感兴趣尽可能囊括到候选框，粗筛</li><li>2k个候选框的图片，每个做resize到固定大小，固定大小里有无物体，进入分类网络判断</li></ul> 
<p><img src="https://images2.imgbox.com/fc/b4/6CHBR5kB_o.png" alt="selective-search.md.png"></p> 
<h3><a id="3__16"></a>3. 特征提取</h3> 
<p><img src="https://images2.imgbox.com/86/8b/SIGLKNC1_o.png" alt="feature-extration.png"></p> 
<ul><li>a.在数据集ILSVRC2012 dataset上预训练好的分类网络(AlexNet)直接拿来用，将大约2k个图片一个个送到分类网络（backbone），只拿了特征提取层，扔掉了最后的1*1000的分类层。</li><li>b.在真实数据集上finetune微调，主要更新后两层全连接dense层</li><li>c.训练样本正样本和负样本比例为1:3</li><li>c.IOU小于0.5,给定比较宽松的限制条件，对应较为复杂的网络，样本才不会显得过于少</li><li>提取CNN特征前必须resize到统一大小,因为后面有FC层，参数是固定的</li><li>问题：resize后改变了图片本身信息——长方形的旗杆resize压缩成成正方形后，他还是旗杆吗？这个仍然需要改善</li></ul> 
<h3><a id="4_SVM__NMS__BBox_Regression_26"></a>4. SVM分类器分类 + NMS算法筛选 + 边界框回归(BBox Regression)</h3> 
<h4><a id="41_SVM_27"></a>4.1. SVM分类(少样本模型)</h4> 
<ul><li>给每个样本做分类</li><li>正样本：Groud True</li><li>负样本：IOU &lt; 0.3[others ignored]</li><li>Q：和AlexNet网络训练相比，svm分类时IOU的阈值threshould为什么不一样？A：训练CNN需要更多数据样本，更多数据样本不一定质量高，svm分类时需要质量高数据样本</li><li>Q：为什么用SVM,为什么不直接用AlexNet最后的softmax？A：AlexNet专注于分类, 不好用少数样本来做定位。数据多，质量差；数据少，质量高，数据少时用SVM相对好一些</li></ul> 
<h4><a id="42_NMSNonMaximum_Suppressionhttpswwwcnblogscommakefilepnmshtml_34"></a>4.2. <a href="https://www.cnblogs.com/makefile/p/nms.html" rel="nofollow">NMS(Non-Maximum Suppression)</a>非极大值抑制算法(很重要)</h4> 
<p>NMS广泛应用于目标检测算法中。其目的是为了消除多余的候选框，找到最佳的物体检测位置。</p> 
<ol><li>每个类别置信程度score越高，越能说明物体在框里面</li><li>取score值最高的一个框，将其他的框和他的iou越大，越可能是同一个物体，所以去掉其他和该框iou高于某一阀值候选框</li><li>代码实现</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">NMS</span><span class="token punctuation">(</span>lists<span class="token punctuation">,</span> thre<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>lists<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    lists <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>lists<span class="token punctuation">)</span>
    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">#取得第i列，第0列为x1,第1列为y1...</span>
    x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> score <span class="token operator">=</span> <span class="token punctuation">[</span>lists<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    area <span class="token operator">=</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># get sorted index in ascending order</span>
    idxs <span class="token operator">=</span> np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span>score<span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>idxs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        last <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>idxs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
        i <span class="token operator">=</span> idxs<span class="token punctuation">[</span>last<span class="token punctuation">]</span>
        res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>

        xmin <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>x1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> x1<span class="token punctuation">[</span>idxs<span class="token punctuation">[</span><span class="token punctuation">:</span>last<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        ymin <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>y1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> y1<span class="token punctuation">[</span>idxs<span class="token punctuation">[</span><span class="token punctuation">:</span>last<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        xmax <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>x2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> x2<span class="token punctuation">[</span>idxs<span class="token punctuation">[</span><span class="token punctuation">:</span>last<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        ymax <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>y2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> y2<span class="token punctuation">[</span>idxs<span class="token punctuation">[</span><span class="token punctuation">:</span>last<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        w <span class="token operator">=</span> xmax <span class="token operator">-</span> xmin <span class="token operator">+</span> <span class="token number">1</span>
        h <span class="token operator">=</span> ymax <span class="token operator">-</span> ymin <span class="token operator">+</span> <span class="token number">1</span>
        inner_area <span class="token operator">=</span> w <span class="token operator">*</span> h
        <span class="token comment"># 其他所有边界框bbox和得分score最高的bbox做iou计算</span>
        iou <span class="token operator">=</span> inner_area <span class="token operator">/</span> <span class="token punctuation">(</span>area<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> area<span class="token punctuation">[</span>idxs<span class="token punctuation">[</span><span class="token punctuation">:</span>last<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">-</span> inner_area<span class="token punctuation">)</span>

        <span class="token comment"># 去除iou计算阈值大于指定值的bbox</span>
        idxs <span class="token operator">=</span> np<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>idxs<span class="token punctuation">,</span>
                         np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>last<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                         np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>iou <span class="token operator">&gt;</span> thre<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                         <span class="token comment"># here "where" will return us a tuple idxs==&gt;[0 3]</span>
                                         <span class="token comment"># [0] means to extract array from a tuple</span>
    <span class="token keyword">return</span> lists<span class="token punctuation">[</span>res<span class="token punctuation">]</span>
    
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    boxes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    scores <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.72</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    thre <span class="token operator">=</span> <span class="token number">0.5</span>
    
    scores1 <span class="token operator">=</span> scores<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
    lists <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> scores1<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    result_boxes_scores <span class="token operator">=</span> NMS<span class="token punctuation">(</span>lists<span class="token punctuation">,</span> thre<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result_boxes_scores<span class="token punctuation">)</span>

</code></pre> 
<ol start="4"><li>问题：</li></ol> 
<ul><li>当图片中物体比较密集的情况下，会出现新的问题</li><li>下图中，两个不一样的对象，在NMS算法中可能就输出一个对象，哪个score高输出哪个，去掉另外一个；很显然，和我们两个对象都要保存输出的真实结果是违背的<br><br> <img src="https://images2.imgbox.com/96/e9/4Kmh4Asl_o.png" alt="NMS_rethink.md.png"></li></ul> 
<h4><a id="43_NMS_96"></a>4.3. NMS发展历史/种类</h4> 
<p>1.<a href="https://arxiv.org/pdf/1704.04503.pdf" rel="nofollow">Soft-NMS</a>[2017]<br> <img src="https://images2.imgbox.com/73/2e/IpAiLrjw_o.png" alt="NMS-SOFT.md.png"><br></p> 
<ul><li>B表示原始没有经过过滤的BBox边界框，S表示每个边界框的分数score,Nt表示NMS的阈值</li><li>设置一个空集D={}表示我们要用NMS筛选后输出的检测框</li><li>取分数S最高的对应的边界框M，加入到集合D中，同时B集合中把边界框M去除（循环）</li><li>NMS:做一个遍历，所有B中的边界框和M做IOU计算，当计算结果大于某一阈值时，把B集合中对应的边界框B和分数S都删除 
  <ul><li>其数学语言可以表达为：<br><br> <img src="https://images2.imgbox.com/e4/f5/u1IozVq3_o.png" alt="NMS-math-formulate.md.png"><br></li><li>如上图，相比于下图的Soft-NMS，NMS硬的地方体现在阈值高于某设定值时，score值简单粗暴地设置为0<br> <img src="https://images2.imgbox.com/e2/8b/AO7bdTqT_o.png" alt="NMS-SOFT-formula.png"><br></li></ul> </li></ul> 
<ol start="2"><li> <p><a href="https://arxiv.org/pdf/1807.11590.pdf" rel="nofollow">IoU-Net</a>[2018]</p> </li><li> <p><a href="https://arxiv.org/pdf/1809.08545.pdf" rel="nofollow">soft-NMS</a>[2019]</p> </li><li> <p><em><strong>NMS总结</strong></em></p> 
  <ul><li>算法复杂，用cpu计算，不能用gpu加速，影响运行速度</li><li>阈值的确认依赖经验，较难确认</li><li>soft-NMS不需要设定IOU阈值，训练时不用，测试时用提升较为明显</li></ul> </li></ol> 
<h4><a id="44_Bbox_RegressionBbox_119"></a>4.4. Bbox Regression(Bbox回归)</h4> 
<ol><li>回归的目标,偏移量(dx,dy,dw,dh)</li><li>坐标需要归一化</li></ol> 
<h3><a id="5_RCNN_123"></a>5. RCNN总结</h3> 
<ul><li>慢：做了2k个区域建议，resize到固定尺寸，将固定尺寸的图输入到CNN网络中，在做分类和位置回归，每个区域建议的图都要做卷积</li><li>SVM和回归方法不太合适，SVM和CNN混合较为奇怪，训练较为复杂，过程较为臃肿</li></ul> 
<h4><a id="_127"></a>最后</h4> 
<p><a href="http://www.yubajin.cn/2020/05/03/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%EF%BC%88%E4%B8%8A%EF%BC%89/" rel="nofollow">原文链接</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2c37597e40df53e400ad5c2fe8f74b29/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">unigui百度地图交互</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5db849380df71fb85a905592855e24b5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Github 上传和删除文件夹</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>