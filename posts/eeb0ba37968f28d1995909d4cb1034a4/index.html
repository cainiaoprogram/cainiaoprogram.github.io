<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>服务注册配置中心Nacos - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="服务注册配置中心Nacos" />
<meta property="og:description" content="文章目录 一. 前言二. 下载安装1. 下载安装包2. Windows环境安装3. Linux环境安装1. 单击模式启动2. 集群模式启动3. 远程web控制4. 注册为系统服务 三. 基本使用1. 添加依赖2. 服务注册3. 配置实例集群属性4. 实例权重负载均衡5. 环境隔离6. 临时实例与非临时实例 四. Nacos配置管理1. Nacos实现配置热更新2. Nacos多环境配置共享 五. Nacos集群搭建1. 搭建数据库2. 启动3. 安装Nginx 一. 前言 PS: 本篇博客为作者学习笔记实际技术参考意义不大，小编将持续更新完善本篇文章。
Nacos服务注册配置中心，一个更易于构建云原生应用的动态服务发现，配置管理和服务管理平台，属于Springcloud Alibaba 体系中的组件之一，也是目前企业开发中最流行的服务注册与配置中心。
更多详细信息各位小伙伴可以参照Springcloud Alibaba官网: 点击跳转官网
Nacos源码地址: 点击跳转源码地址
Nacos官网地址: 点击跳转官网
一些注册中心特性对比:
二. 下载安装 1. 下载安装包 Nacos既可以在Windows上使用，也可以在Linux上面使用，下面两种系统的Nacos安装小编都会介绍到，首先我们要准备好Nacos的安装包，点进入Nacos的仓库 点击跳转。
点击 【发行版】就可以看到Nacos的全部历史版本
点击 【标签】可以选择想要的版本下载
选择好版本点击最右边的【下载】后翻到最下面就可以看到对应的下载文件，【zip】则是windows版本 【tar.gz】就是Linux使用的版本。
2. Windows环境安装 准备好Windows环境下的安装包后，就可以开始Windows环境下Nacos的安装了。
将准备好的安装包解压到任意目录下(最好是全英文的路径)解压后文件夹内结构如下:
bin目录是存放启动脚本的目录 conf目录是存放Nacos配置文件的目录。
关于端口配置，Nacos的默认端口是8848，如果你电脑上的其它进程占用了8848端口，请先尝试关闭该进程。如果无法关闭占用8848端口的进程，也可以进入nacos的conf目录，修改配置文件中Nacos默认启动占用的端口：
确认端口没有问题后就可以进入bin目录启动cmd窗口，使用下面的命令启动Nacos:
startup.cmd -m standalone 也可以直接双击startup.cmd文件启动Nacos
看到上面这个样子就是启动成功了，也标明了启动占用的端口和后台的访问地址。
我们用浏览器直接访问 http://127." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/eeb0ba37968f28d1995909d4cb1034a4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-24T14:42:44+08:00" />
<meta property="article:modified_time" content="2022-12-24T14:42:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">服务注册配置中心Nacos</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#__4" rel="nofollow">一. 前言</a></li><li><a href="#__13" rel="nofollow">二. 下载安装</a></li><li><ul><li><ul><li><a href="#1__14" rel="nofollow">1. 下载安装包</a></li><li><a href="#2_Windows_22" rel="nofollow">2. Windows环境安装</a></li><li><a href="#3_Linux_40" rel="nofollow">3. Linux环境安装</a></li><li><ul><li><a href="#1__51" rel="nofollow">1. 单击模式启动</a></li><li><a href="#2__66" rel="nofollow">2. 集群模式启动</a></li><li><a href="#3_web_96" rel="nofollow">3. 远程web控制</a></li><li><a href="#4__108" rel="nofollow">4. 注册为系统服务</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#__152" rel="nofollow">三. 基本使用</a></li><li><ul><li><ul><li><a href="#1__153" rel="nofollow">1. 添加依赖</a></li><li><a href="#2__177" rel="nofollow">2. 服务注册</a></li><li><a href="#3__188" rel="nofollow">3. 配置实例集群属性</a></li><li><a href="#4__209" rel="nofollow">4. 实例权重负载均衡</a></li><li><a href="#5__214" rel="nofollow">5. 环境隔离</a></li><li><a href="#6__233" rel="nofollow">6. 临时实例与非临时实例</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_Nacos_250" rel="nofollow">四. Nacos配置管理</a></li><li><ul><li><ul><li><a href="#1_Nacos_251" rel="nofollow">1. Nacos实现配置热更新</a></li><li><a href="#2_Nacos_293" rel="nofollow">2. Nacos多环境配置共享</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_Nacos_314" rel="nofollow">五. Nacos集群搭建</a></li><li><ul><li><ul><li><a href="#1__337" rel="nofollow">1. 搭建数据库</a></li><li><a href="#2__359" rel="nofollow">2. 启动</a></li><li><a href="#3_Nginx_376" rel="nofollow">3. 安装Nginx</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="__4"></a>一. 前言</h2> 
<p><code>PS</code>: 本篇博客为作者学习笔记实际技术参考意义不大，小编将持续更新完善本篇文章。<br> Nacos服务注册配置中心，一个更易于构建云原生应用的动态服务发现，配置管理和服务管理平台，属于Springcloud Alibaba 体系中的组件之一，也是目前企业开发中最流行的服务注册与配置中心。<br> <img src="https://images2.imgbox.com/4a/bb/N1OzMRPx_o.png" alt="在这里插入图片描述"><br> 更多详细信息各位小伙伴可以参照Springcloud Alibaba官网: <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/2.2.x/README-zh.md">点击跳转官网</a><br> Nacos源码地址: <a href="https://github.com/alibaba/Nacos">点击跳转源码地址</a><br> Nacos官网地址: <a href="https://nacos.io/zh-cn/" rel="nofollow">点击跳转官网</a><br> 一些注册中心特性对比:<br> <img src="https://images2.imgbox.com/ba/08/ENnYwOYu_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="__13"></a>二. 下载安装</h2> 
<h4><a id="1__14"></a>1. 下载安装包</h4> 
<p>Nacos既可以在Windows上使用，也可以在Linux上面使用，下面两种系统的Nacos安装小编都会介绍到，首先我们要准备好Nacos的安装包，点进入Nacos的仓库 <a href="https://github.com/alibaba/nacos">点击跳转</a>。<br> 点击 【发行版】就可以看到Nacos的全部历史版本<br> <img src="https://images2.imgbox.com/a5/c6/xO1Gl8NE_o.png" alt="在这里插入图片描述"><br> 点击 【标签】可以选择想要的版本下载<br> <img src="https://images2.imgbox.com/72/71/nfgoSqKV_o.png" alt="在这里插入图片描述"><br> 选择好版本点击最右边的【下载】后翻到最下面就可以看到对应的下载文件，【zip】则是windows版本 【tar.gz】就是Linux使用的版本。<br> <img src="https://images2.imgbox.com/58/4b/eVW3tjO8_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_Windows_22"></a>2. Windows环境安装</h4> 
<p>准备好Windows环境下的安装包后，就可以开始Windows环境下Nacos的安装了。<br> 将准备好的安装包解压到任意目录下(最好是全英文的路径)解压后文件夹内结构如下:<br> <img src="https://images2.imgbox.com/7d/cc/yU2OhBOE_o.png" alt="在这里插入图片描述"><br> bin目录是存放启动脚本的目录 conf目录是存放Nacos配置文件的目录。<br> 关于端口配置，Nacos的默认端口是<code>8848</code>，如果你电脑上的其它进程占用了8848端口，请先尝试关闭该进程。<strong>如果无法关闭占用8848端口的进程</strong>，也可以进入nacos的conf目录，修改配置文件中Nacos默认启动占用的端口：<br> <img src="https://images2.imgbox.com/35/2c/HBb6DSzo_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/aa/16/rTEyn6EZ_o.png" alt="在这里插入图片描述"><br> 确认端口没有问题后就可以进入bin目录启动cmd窗口，使用下面的命令启动Nacos:</p> 
<pre><code class="prism language-javascript">startup<span class="token punctuation">.</span>cmd <span class="token operator">-</span>m standalone
</code></pre> 
<p>也可以直接双击startup.cmd文件启动Nacos<br> <img src="https://images2.imgbox.com/89/fe/hV2l4bOr_o.png" alt="在这里插入图片描述"><br> 看到上面这个样子就是启动成功了，也标明了启动占用的端口和后台的访问地址。<br> 我们用浏览器直接访问 <code>http://127.0.0.1:8848/nacos</code> 即可，正常情况下会看到下面的内容:<br> <img src="https://images2.imgbox.com/14/a1/5oM7cAHK_o.png" alt="在这里插入图片描述"><br> 默认的用户名和密码都是 nacos 直接登录即可，至此Windows环境下安装Nacos就完成了</p> 
<h4><a id="3_Linux_40"></a>3. Linux环境安装</h4> 
<p>对于Linux环境下Nacos安装相对于Windows环境下的安装要复杂一点，首先要准备好Linux版本的Nacos安装包，其次Nacos依赖于JDK运行，索引Linux上也需要安装JDK才行。<br> 没有安装java环境的小伙伴可以参考小编这篇文章 <a href="https://blog.csdn.net/Siebert_Angers/article/details/127119622">点击跳转</a> 配置好java环境后就可以开始我们的安装了。<br> 首先将我们准备好的安装包上传到任意目录，列如 <code>/usr/local/</code> 然后使用下面的命令进行解压:</p> 
<pre><code class="prism language-powershell">tar <span class="token operator">-</span>xvf nacos-server-1<span class="token punctuation">.</span>4<span class="token punctuation">.</span>1<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
</code></pre> 
<p>然后执行下面的命令删除安装包:</p> 
<pre><code class="prism language-javascript">rm <span class="token operator">-</span>rf nacos<span class="token operator">-</span>server<span class="token operator">-</span><span class="token number">1.4</span><span class="token number">.1</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
</code></pre> 
<h5><a id="1__51"></a>1. 单击模式启动</h5> 
<p>首先进入到已经解压好的Nacos目录的bin目录下:</p> 
<pre><code class="prism language-javascript">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nacos<span class="token operator">/</span>bin
</code></pre> 
<p>执行下面的命令启动Nacos:</p> 
<pre><code class="prism language-powershell">sh startup<span class="token punctuation">.</span>sh <span class="token operator">-</span>m standalone
</code></pre> 
<p>下面的情况是正常启动了<br> <img src="https://images2.imgbox.com/ab/74/M6YX8DeA_o.png" alt="在这里插入图片描述"><br> 停止Nacos的命令:</p> 
<pre><code class="prism language-powershell">sh shutdown<span class="token punctuation">.</span>sh
</code></pre> 
<h5><a id="2__66"></a>2. 集群模式启动</h5> 
<p>集群模式的启动需要先创建数据库，脚本位置: <code>/usr/local/nacos/conf/nacos-mysql.sql</code> 利用该脚本创建数据库。<br> 紧接着我们需要配置一下Nacos的配置文件:</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr/local/nacos/conf
vim application<span class="token punctuation">.</span>properties
</code></pre> 
<p>修改下面的内容（将原来的注释放开，）</p> 
<pre><code class="prism language-puppet">spring<span class="token punctuation">.</span><span class="token function">datasource</span><span class="token punctuation">.</span><span class="token function">platform</span><span class="token operator">=</span>mysql
db<span class="token punctuation">.</span><span class="token function">num</span><span class="token operator">=</span><span class="token number">1</span>
db<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">=</span>jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">10.114</span><span class="token punctuation">.</span><span class="token number">12.177</span><span class="token punctuation">:</span><span class="token number">3306</span><span class="token operator">/</span>nacos<span class="token operator">?</span>serverTimezone<span class="token operator">=</span>GMT<span class="token operator">%</span>2B8&amp;characterEncoding<span class="token operator">=</span>utf8&amp;connectTimeout<span class="token operator">=</span><span class="token number">1000</span>&amp;socketTimeout<span class="token operator">=</span><span class="token number">3000</span>&amp;autoReconnect<span class="token operator">=</span><span class="token boolean">true</span>
db<span class="token punctuation">.</span><span class="token function">user</span><span class="token operator">=</span>root
db<span class="token punctuation">.</span><span class="token function">password</span><span class="token operator">=</span>root
</code></pre> 
<p>注意: <code>此处的ip地址、端口号、数据库名、账号和密码都需要按照自己的实际情况进行修改</code>。<br> 启动:</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr/local/nacos/bin
</code></pre> 
<pre><code class="prism language-powershell">sh startup<span class="token punctuation">.</span>sh
</code></pre> 
<p>查看启动日志:</p> 
<pre><code class="prism language-javascript">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nacos<span class="token operator">/</span>logs
</code></pre> 
<pre><code class="prism language-powershell">vim <span class="token function">start</span><span class="token punctuation">.</span>out
</code></pre> 
<h5><a id="3_web_96"></a>3. 远程web控制</h5> 
<p>我们可以执行下面的命令放行当前主机的8848端口，以便我们访问远程的web控制台:</p> 
<pre><code class="prism language-powershell">firewall-cmd <span class="token operator">--</span>zone=public <span class="token operator">--</span><span class="token function">add-port</span>=8848/tcp <span class="token operator">--</span>permanent
</code></pre> 
<p>放行完端口再执行下面的命令重启一下当前主机的防火墙:</p> 
<pre><code class="prism language-powershell">firewall-cmd <span class="token operator">--</span>reload
</code></pre> 
<p>紧接着我们就可以访问 <code>http://当前主机地址:8848/nacos</code> 就会出现下面的情况:<br> <img src="https://images2.imgbox.com/85/74/wUHg1GY1_o.png" alt="在这里插入图片描述"><br> 默认的用户名是: nacos 默认的密码也是: nacos</p> 
<h5><a id="4__108"></a>4. 注册为系统服务</h5> 
<p>为了更加方便的管理Nacos，最好是将其注册为系统服务<br> 首先使用下面的命令修改 /usr/local/nacos/bin/startup.sh 启动文件</p> 
<pre><code class="prism language-powershell">vim <span class="token operator">/</span>usr/local/nacos/bin/startup<span class="token punctuation">.</span>sh
</code></pre> 
<p><img src="https://images2.imgbox.com/b9/28/p8pNyGtq_o.png" alt="在这里插入图片描述"><br> 将路径修改为当前系统中存放jdk的路径：<br> <img src="https://images2.imgbox.com/06/60/tXtLYXGM_o.png" alt="在这里插入图片描述"><br> 使用下面的命令创建并编辑<code>nacos.service</code>文件:</p> 
<pre><code class="prism language-powershell">vim <span class="token operator">/</span>lib/systemd/system/nacos<span class="token punctuation">.</span>service
</code></pre> 
<p>向文件中添加下面的内容:</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
Description<span class="token operator">=</span>nacos
After<span class="token operator">=</span>network<span class="token punctuation">.</span>target
 
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
Type<span class="token operator">=</span>forking
ExecStart<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nacos<span class="token operator">/</span>bin<span class="token operator">/</span>startup<span class="token punctuation">.</span>sh <span class="token operator">-</span>m standalone
ExecReload<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nacos<span class="token operator">/</span>bin<span class="token operator">/</span>shutdown<span class="token punctuation">.</span>sh
ExecStop<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nacos<span class="token operator">/</span>bin<span class="token operator">/</span>shutdown<span class="token punctuation">.</span>sh
PrivateTmp<span class="token operator">=</span><span class="token boolean">true</span>
 
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>  
WantedBy<span class="token operator">=</span>multi<span class="token operator">-</span>user<span class="token punctuation">.</span>target
</code></pre> 
<p>保存退出后执行下面的命令重载一下系统服务:</p> 
<pre><code class="prism language-powershell">systemctl daemon-reload
</code></pre> 
<p>就完成了Nacos的系统服务注册，服务名就叫<code>nacos</code>。<br> 之后我们就可以使用操作系统服务的命令对Nacos进行操作了，下面是一些常用命令:</p> 
<pre><code class="prism language-javascript">systemctl start nacos<span class="token punctuation">.</span>service <span class="token comment">// 启动nacos服务</span>
systemctl stop nacos<span class="token punctuation">.</span>service <span class="token comment">// 停止nacos服务</span>
systemctl status nacos<span class="token punctuation">.</span>service <span class="token comment">// 查看nacos服务状态</span>
systemctl enable nacos<span class="token punctuation">.</span>service <span class="token comment">// 设置为开机自启</span>
systemctl restart nacos<span class="token punctuation">.</span>service <span class="token comment">// 重启nacos服务</span>
systemctl reload nacos<span class="token punctuation">.</span>service <span class="token comment">// 重载nacos服务 (推荐使用)</span>
</code></pre> 
<h2><a id="__152"></a>三. 基本使用</h2> 
<h4><a id="1__153"></a>1. 添加依赖</h4> 
<p>要想使用Nacos首先要在<code>父工程</code>的POM文件中添加下面的依赖:</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><img src="https://images2.imgbox.com/56/b6/QcRpdwOF_o.png" alt="在这里插入图片描述"><br> 然后修改子工程的POM文件，将下面的依赖加入其中:</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- nacos客户端依赖包 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="2__177"></a>2. 服务注册</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">application</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> orderservice  <span class="token comment"># 服务名</span>
	<span class="token key atrule">cloud</span><span class="token punctuation">:</span>
	 <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
	 	<span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 服务地址</span>
</code></pre> 
<p>再启动服务就可以在后台管理界面中的【服务列表】选项卡的子选项卡 【服务列表】中找到我们注册的服务。<br> 在消费者进行服务调用的时候也就可以通过服务名进行调用了(orderservice代替id地址和端口)，且Nacos自带了负载均衡。</p> 
<h4><a id="3__188"></a>3. 配置实例集群属性</h4> 
<p>配置当前服务的实例归属于哪个集群<br> 修改模块的Yml配置文件:</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">application</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> orderservice  <span class="token comment"># 服务名 可以通过相同的服务名部署多个实例</span>
	<span class="token key atrule">cloud</span><span class="token punctuation">:</span>
	 <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
	 	<span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 服务地址</span>
	 	<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
	 	  <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> hangzhou <span class="token comment"># 集群名</span>
</code></pre> 
<p>在web控制台中可以看到集群的信息，再编辑Yml配置文件设置负载均衡的1Rule为NacosRule,这个规则优先会寻找与自己同集群的服务，本地集群找不到提供者，才去其它集群寻找，并且会报警告。<br> 确定了可用实例列表后，再采用随机负载均衡挑选实例。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">userservice</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  	<span class="token comment"># 优先请求同集群的实例</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.alibaba.cloud.nacos.ribbon.NacosRule
</code></pre> 
<h4><a id="4__209"></a>4. 实例权重负载均衡</h4> 
<p>实际部署中会出现这样的场景：服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求。<br> Nacos提供了权重配置来控制访问频率，权重越大则访问频率越高。<br> <img src="https://images2.imgbox.com/64/9c/s3QV2JyE_o.png" alt="在这里插入图片描述"><br> 默认权重都是1，在服务升级和优化时可以将该服务权重设置成0，该服务就不会再收到请求。</p> 
<h4><a id="5__214"></a>5. 环境隔离</h4> 
<p>Nacos中服务存储和数据存储的最外层都是一个名为namespacel的东西，用来做最外层隔离。<br> <img src="https://images2.imgbox.com/d7/e4/47pSSZoa_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4b/0d/MPM1kxri_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8c/a8/Mb2WMv17_o.png" alt="在这里插入图片描述"><br> 修改实例的命名空间需要修改服务的配置文件，默认都是存储在public(保留空间中):</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">application</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> orderservice  <span class="token comment"># 服务名 可以通过相同的服务名部署多个实例</span>
	<span class="token key atrule">cloud</span><span class="token punctuation">:</span>
	 <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
	 	<span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 服务地址</span>
	 	<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
	 	  <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> hangzhou <span class="token comment"># 集群名</span>
	 	  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 4d6ce343<span class="token punctuation">-</span>9e1b<span class="token punctuation">-</span>44df<span class="token punctuation">-</span>a90f<span class="token punctuation">-</span>2cf2b6b3d177 <span class="token comment"># dev环境 命名空间Id</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/47/47/iTEWNn7G_o.png" alt="在这里插入图片描述"><br> <code>注意</code>: 只有相同命名空间的服务实例才可以相互调用</p> 
<h4><a id="6__233"></a>6. 临时实例与非临时实例</h4> 
<p>默认在Nacos中注册的实例都是临时实例，那么临时实例与非临时实例有什么区别呢?<br> <strong>临时实例</strong>: 采用心跳检测(服务每隔一段时间就会发送一次请求给注册中心Nacos确保实例的可用性)当长时间没有向Nacos发送心跳请求Nacos就会在服务列表中将该实例剔除。<br> <strong>非临时实例</strong>: 不会拥有心跳检测机制，而是由Nacos主动发送请求询问实例，如果检测到非临时实例Nacos不会将其剔除，而是标记为不健康状态除非手动删除，否则会一直等待其恢复健康状态。<br> 对于配置实例是否为临时实例需要配置实例的YAM配置文件:</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">application</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> orderservice  <span class="token comment"># 服务名 可以通过相同的服务名部署多个实例</span>
	<span class="token key atrule">cloud</span><span class="token punctuation">:</span>
	 <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
	 	<span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 服务地址</span>
	 	<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
	 	  <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> hangzhou <span class="token comment"># 集群名</span>
	 	  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 4d6ce343<span class="token punctuation">-</span>9e1b<span class="token punctuation">-</span>44df<span class="token punctuation">-</span>a90f<span class="token punctuation">-</span>2cf2b6b3d177 <span class="token comment"># dev环境 命名空间Id</span>
	 	  <span class="token key atrule">ephemeral</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否为临时实例 默认是true</span>
</code></pre> 
<h2><a id="_Nacos_250"></a>四. Nacos配置管理</h2> 
<h4><a id="1_Nacos_251"></a>1. Nacos实现配置热更新</h4> 
<p>Nacos处理可以担任服务注册中心，还可以担任服务的配置中心，首先我们需要在模块的POM文件中添加Nacos的配置管理依赖:</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--nacos的配置管理依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>然后我们在后台管理界面中点击【配置管理】的【配置列表】模块右上角的加号先添加一个。<br> <img src="https://images2.imgbox.com/5d/6d/jF3krqxu_o.png" alt="在这里插入图片描述"><br> 【Data ID】其实就是配置文件名 (必须唯一) 一般以“<code>服务名-运行环境.后缀</code>” 作为文件名<br> <code>列如</code>:userservice-dev.yaml<br> 【Group】组ID 这个自定义<br> 【配置格式】一般都是使用YAML，根据后缀自定义<br> 【配置内容】根据选择的文件格式书写有热更新需求的配置<br> <img src="https://images2.imgbox.com/ef/44/3RsSMUL0_o.png" alt="在这里插入图片描述"><br> 修改完成后点击右下角的【发布】即可，由于在读取Nacos中的配置文件之前我们实例就需要知道Nacos的服务地址等信息，所以我们一般将Naocs的配置放在加载优先级更高的<code>bootstrap.yml</code>文件中<br> <img src="https://images2.imgbox.com/e4/e1/acBR4Wex_o.png" alt="在这里插入图片描述"><br> <code>注</code>: bootstrap.yml又叫引导文件，加载优先级比application.yml要高<br> 可以在resources目录中添加一个bootstrap.yml，需要添加的配置如下:</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice <span class="token comment"># 服务名</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev <span class="token comment"># 环境</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos地址</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># 文件后缀名</span>
</code></pre> 
<p>其中“<code>服务名</code>”、“<code>环境</code>”、“<code>文件后缀名</code>” 其实就是我们上面在后台创建的配置文件名，相应的就会读取后台相应配置文件内容，在项目中我们也可以使用value注解读取配置文件中的内容，列如:</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${pattern.dateformat}"</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span>
</code></pre> 
<p>要想实现配置热更新还差最后一步，Ncos中的配置文件变更后，微服务无需重启就可以感知。不过需要通过下面两种配置实现：<br> <img src="https://images2.imgbox.com/a7/2e/qER6wcaY_o.png" alt="在这里插入图片描述"><br> 需要 prefix指定的前缀名跟变量名拼接和后台管理系统中的属性一致才可生效，一般第一种方式用的比较多。<br> <img src="https://images2.imgbox.com/1d/f7/58YrTww3_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_Nacos_293"></a>2. Nacos多环境配置共享</h4> 
<p>假设一个业务场景，一个配置在开发环境，生产环境都需要用到，那么每份配置都配置一次显然是相当麻烦的。<br> <img src="https://images2.imgbox.com/b6/f2/1UDs404f_o.png" alt="在这里插入图片描述"><br> 这样无论是生产还是测试相同的配置都写在userservice.yaml中，这样给我们带来了极大的便利</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice <span class="token comment"># 服务名</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev <span class="token comment"># 环境</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos地址</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># 文件后缀名</span>
</code></pre> 
<p>这样即可以读取到userservice-dev.yaml 配置文件的内容，也可以读取到userservice.yaml配置文件中的内容，即使环境为test环境也可以读取到userservice.yaml配置文件的内容。<br> 如果两个文件中有一个相同的属性，或者说application.yml也有一个属性相同，那么文件的加载优先级是:</p> 
<pre><code class="prism language-javascript">userservice<span class="token operator">-</span>dev<span class="token punctuation">.</span>yaml <span class="token operator">&gt;</span> userservice<span class="token punctuation">.</span>yaml <span class="token operator">&gt;</span> application<span class="token punctuation">.</span>yml
</code></pre> 
<h2><a id="_Nacos_314"></a>五. Nacos集群搭建</h2> 
<p>官方给出的Nacos集群图：<br> <img src="https://images2.imgbox.com/cd/28/KYHgYkBy_o.png" alt="请添加图片描述"><br> 其中包含3个nacos节点，然后一个负载均衡器代理3个Nacos。这里负载均衡器可以使用nginx。<br> 我们计划的集群结构:<br> <img src="https://images2.imgbox.com/f0/d2/GRN8ng9T_o.png" alt="请添加图片描述"></p> 
<p>三个nacos节点的地址：</p> 
<table><thead><tr><th>节点</th><th>ip</th><th>port</th></tr></thead><tbody><tr><td>nacos1</td><td>192.168.150.1</td><td>8845</td></tr><tr><td>nacos2</td><td>192.168.150.1</td><td>8846</td></tr><tr><td>nacos3</td><td>192.168.150.1</td><td>8847</td></tr></tbody></table> 
<p>搭建集群的基本步骤：</p> 
<ul><li>搭建数据库，初始化数据库表结构</li><li>下载nacos安装包</li><li>配置nacos</li><li>启动nacos集群</li><li>nginx反向代理</li></ul> 
<h4><a id="1__337"></a>1. 搭建数据库</h4> 
<p>Nacos默认数据存储在内嵌数据库Derby中，不属于生产可用的数据库，官方推荐的最佳实践是使用带有主从的高可用数据库集群<br> 这里我们以单点的数据库为例来讲解。<br> 将Nacos解压后，首先启动本机mysql，创建nacos数据库，并在nacos_config数据库下执行nacos-mysql.sql脚本 （脚本存放位置nacos/cont/nacos-mysql.sql）：</p> 
<pre><code class="prism language-javascript">mysql<span class="token operator">&gt;</span> source <span class="token operator">/</span>opt<span class="token operator">/</span>nacos<span class="token operator">/</span>cont<span class="token operator">/</span>nacos<span class="token operator">-</span>mysql<span class="token punctuation">.</span>sql<span class="token punctuation">;</span>
</code></pre> 
<p>进入nacos的conf目录，修改配置文件cluster.conf.example，重命名为cluster.conf：<br> 然后添加内容:</p> 
<pre><code class="prism language-javascript"><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8845</span>
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token number">.8846</span>
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token number">.8847</span>
</code></pre> 
<p>然后修改application.properties文件，添加数据库配置：</p> 
<pre><code class="prism language-javascript">spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>platform<span class="token operator">=</span>mysql
db<span class="token punctuation">.</span>num<span class="token operator">=</span><span class="token number">1</span>
db<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>nacos<span class="token operator">?</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>connectTimeout<span class="token operator">=</span><span class="token number">1000</span><span class="token operator">&amp;</span>socketTimeout<span class="token operator">=</span><span class="token number">3000</span><span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>useUnicode<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token constant">UTC</span>
db<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">=</span>root
db<span class="token punctuation">.</span>password<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">=</span><span class="token number">123</span>
</code></pre> 
<h4><a id="2__359"></a>2. 启动</h4> 
<p>将nacos文件夹复制三份，分别命名为：nacos1、nacos2、nacos3<br> 然后分别修改三个文件夹中的application.properties，<br> nacos1:</p> 
<pre><code class="prism language-properties">server.port=8845
</code></pre> 
<p>nacos2:</p> 
<pre><code class="prism language-properties">server.port=8846
</code></pre> 
<p>nacos3:</p> 
<pre><code class="prism language-properties">server.port=8847
</code></pre> 
<p>然后我们就可以分别将他们都启动起来</p> 
<h4><a id="3_Nginx_376"></a>3. 安装Nginx</h4> 
<p>关于Nginx的安装小编的专栏里面有对应的文章。<br> 修改conf/nginx.conf文件，配置如下：</p> 
<pre><code class="prism language-javascript">upstream nacos<span class="token operator">-</span>cluster <span class="token punctuation">{<!-- --></span>
    server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8845</span><span class="token punctuation">;</span>
	server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8846</span><span class="token punctuation">;</span>
	server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8847</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{<!-- --></span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  localhost<span class="token punctuation">;</span>

    location <span class="token operator">/</span>nacos <span class="token punctuation">{<!-- --></span>
        proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>nacos<span class="token operator">-</span>cluster<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而后在浏览器访问：http://localhost/nacos即可。<br> 代码中application.yml文件配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">80</span> <span class="token comment"># Nacos地址</span>
</code></pre> 
<p>实际部署时，需要给做反向代理的nginx服务器设置一个域名，这样后续如果有服务器迁移nacos的客户端也无需更改配置,Nacos的各个节点应该部署到多个不同服务器，做好容灾和隔离。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fb657e5f9f21bb63b5b948fe645ceaac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">前端面试常考 | 事件循环-eventloop</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b76ae3639f6e871af2c0fba277a03d73/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【前端面试整理 | vue相关知识整理 】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>