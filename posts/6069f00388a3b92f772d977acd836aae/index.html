<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>kafka原理三之partition - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="kafka原理三之partition" />
<meta property="og:description" content="目录 前言核心概念开发准备分区策略Kafka ProducerKafka Consumer消费者代码生产者代码分区消费关系顺序消费Kafka 集群扩容Kafka 集群缩容kafka中不同topic使用同一个Group Id会出现的问题分析 参考 前言 在上一篇中讲述了 kafka 的架构一之入门，以及如何搭建kafka集群，本篇则讲述如何简单的使用 kafka 。
核心概念 Partition主题分区数
kafka通过分区策略，将不同的分区分配在一个集群中的broker上，一般会分散在不同的broker上，当只有一个broker时，所有的分区就只分配到该Broker上。消息会通过负载均衡发布到不同的分区上，消费者会监测偏移量来获取哪个分区有新数据，从而从该分区上拉取消息数据。分区数越多，在一定程度上会提升消息处理的吞吐量，因为kafka是基于文件进行读写，因此也需要打开更多的文件句柄，也会增加一定的性能开销。如果分区过多，那么日志分段也会很多，写的时候由于是批量写，其实就会变成随机写了，随机 I/O 这个时候对性能影响很大。所以一般来说 Kafka 不能有太多的 Partition。
Push vs. Pull
作为一个messaging system，Kafka遵循了传统的方式，选择由producer向broker push消息并由consumer从broker pull消息。事实上，push模式和pull模式各有优劣。
push模式很难适应消费速率不同的消费者，因为消息发送速率是由broker决定的。push模式的目标是尽可能以最快速度传递消息，但是这样很容易造成consumer来不及处理消息，典型的表现就是拒绝服务以及网络拥塞。而pull模式则可以根据consumer的消费能力以适当的速率消费消息。
Topic &amp; Partition
Topic在逻辑上可以被认为是一个queue，每条消息都必须指定它的topic，可以简单理解为必须指明把这条消息放进哪个queue里。为了使得Kafka的吞吐率可以水平扩展，物理上把topic分成一个或多个partition，每个partition在物理上对应一个文件夹，该文件夹下存储这个partition的所有消息和索引文件。
开发准备 创建主题
使用kafka-topics.sh创建一个 主题为test1， Partition 为3的topic。 ./bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 3 --partitions 3 --topic test1 Maven依赖
这里用的开发语言是Java，构建工具Maven。
Maven的依赖如下: &lt;dependency&gt; &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt; &lt;artifactId&gt;kafka_2.12&lt;/artifactId&gt; &lt;version&gt;1.0.0&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt; &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt; &lt;version&gt;1.0.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt; &lt;artifactId&gt;kafka-streams&lt;/artifactId&gt; &lt;version&gt;1.0.0&lt;/version&gt; &lt;/dependency&gt; 分区策略 如果消息的 key 为 null，此时 producer 会使用默认的 partitioner 分区器将消息随机分布到 topic 的可用 partition 中。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6069f00388a3b92f772d977acd836aae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-15T11:37:46+08:00" />
<meta property="article:modified_time" content="2023-11-15T11:37:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">kafka原理三之partition</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_3" rel="nofollow">核心概念</a></li><li><a href="#_14" rel="nofollow">开发准备</a></li><li><a href="#_42" rel="nofollow">分区策略</a></li><li><a href="#Kafka_Producer_179" rel="nofollow">Kafka Producer</a></li><li><a href="#Kafka_Consumer_228" rel="nofollow">Kafka Consumer</a></li><li><a href="#_293" rel="nofollow">消费者代码</a></li><li><a href="#_360" rel="nofollow">生产者代码</a></li><li><a href="#_413" rel="nofollow">分区消费关系</a></li><li><a href="#_536" rel="nofollow">顺序消费</a></li><li><a href="#Kafka__615" rel="nofollow">Kafka 集群扩容</a></li><li><a href="#Kafka__644" rel="nofollow">Kafka 集群缩容</a></li><li><ul><li><a href="#kafkatopicGroup_Id_661" rel="nofollow">kafka中不同topic使用同一个Group Id会出现的问题分析</a></li></ul> 
   </li><li><a href="#_664" rel="nofollow">参考</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>前言</h3> 
<p>在上一篇中讲述了 <a href="https://blog.csdn.net/yangyanping20108/article/details/110481935">kafka 的架构一之入门</a>，以及如何搭建kafka集群，本篇则讲述如何简单的使用 kafka 。</p> 
<h3><a id="_3"></a>核心概念</h3> 
<ul><li> <p>Partition主题分区数<br> kafka通过分区策略，将不同的分区分配在一个集群中的broker上，一般会分散在不同的broker上，当只有一个broker时，所有的分区就只分配到该Broker上。消息会通过负载均衡发布到不同的分区上，消费者会监测偏移量来获取哪个分区有新数据，从而从该分区上拉取消息数据。分区数越多，在一定程度上会提升消息处理的吞吐量，因为kafka是基于文件进行读写，因此也需要打开更多的文件句柄，也会增加一定的性能开销。如果分区过多，那么日志分段也会很多，写的时候由于是批量写，其实就会变成随机写了，随机 I/O 这个时候对性能影响很大。所以一般来说 Kafka 不能有太多的 Partition。</p> </li><li> <p>Push vs. Pull<br> 作为一个messaging system，Kafka遵循了传统的方式，选择由producer向broker push消息并由consumer从broker pull消息。事实上，push模式和pull模式各有优劣。<br> push模式很难适应消费速率不同的消费者，因为消息发送速率是由broker决定的。push模式的目标是尽可能以最快速度传递消息，但是这样很容易造成consumer来不及处理消息，典型的表现就是拒绝服务以及网络拥塞。而pull模式则可以根据consumer的消费能力以适当的速率消费消息。</p> </li><li> <p>Topic &amp; Partition<br> Topic在逻辑上可以被认为是一个queue，每条消息都必须指定它的topic，可以简单理解为必须指明把这条消息放进哪个queue里。为了使得Kafka的吞吐率可以水平扩展，物理上把topic分成一个或多个partition，每个partition在物理上对应一个文件夹，该文件夹下存储这个partition的所有消息和索引文件。</p> </li></ul> 
<h3><a id="_14"></a>开发准备</h3> 
<ul><li>创建主题<br> 使用kafka-topics.sh创建一个 主题为test1， Partition 为3的topic。</li></ul> 
<pre><code class="prism language-bash">./bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> localhost:2181 --replication-factor <span class="token number">3</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token parameter variable">--topic</span> test1
</code></pre> 
<ul><li>Maven依赖<br> 这里用的开发语言是Java，构建工具Maven。<br> Maven的依赖如下:</li></ul> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-streams<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="_42"></a>分区策略</h3> 
<p>如果消息的 key 为 null，此时 producer 会使用默认的 partitioner 分区器将消息随机分布到 topic 的可用 partition 中。<br> 如果 key 不为 null，并且使用了默认的分区器，kafka 会使用自己的 hash 算法对 key 取 hash 值，使用 hash 值与 partition 数量取模，从而确定发送到哪个分区。注意：此时 key 相同的消息会发送到相同的分区(只要 partition 的数量不变化)。</p> 
<ul><li>默认分区策略</li></ul> 
<pre><code class="prism language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>internals<span class="token punctuation">.</span></span>DefaultPartitioner</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">&gt;</span></span> topicCounterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultPartitioner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> nextValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">nextValue</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> availablePartitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">availablePartitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> part <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span> <span class="token operator">%</span> availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">)</span>availablePartitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">nextValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AtomicInteger</span> counter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicCounterMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> counter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            counter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AtomicInteger</span> currentCounter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicCounterMap<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentCounter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                counter <span class="token operator">=</span> currentCounter<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> counter<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>自定义分区器： 在这里我们规定：key值不允许为null。在实际项目中，key为null的消息*，可以发送到同一个分区</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Hash分区算法
 * @author yangyanping 
 * @date 2020-12-18
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 计算partition
     *
     * @param topic      The topic name
     * @param key        The key to partition on (or null if no key)
     * @param keyBytes   serialized key to partition on (or null if no key)
     * @param value      The value to partition on or null
     * @param valueBytes serialized value to partition on or null
     * @param cluster    The current cluster metadata
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitionInfos <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitionInfos<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     
        <span class="token comment">/**
         *由于我们按key分区，在这里我们规定：key值不允许为null。在实际项目中，key为null的消息*，可以发送到同一个分区。
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRecordException</span><span class="token punctuation">(</span><span class="token string">"key cannot be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果消息的key值不为1，那么使用hash值取模，确定分区。</span>
        <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 轮询分区算法
 * @author yangyanping
 * @date 2020-12-18
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoundRobinPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicLong</span> next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * @param topic      The topic name
     * @param key        The key to partition on (or null if no key)
     * @param keyBytes   serialized key to partition on (or null if no key)
     * @param value      The value to partition on or null
     * @param valueBytes serialized value to partition on or null
     * @param cluster    The current cluster metadata
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topicName<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> o1<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes1<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span> nextIndex <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitionInfos <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topicName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> partitionCount <span class="token operator">=</span> partitionInfos<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> nextIndex <span class="token operator">%</span> partitionCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>在kafka配置参数时设置分区器的类</li></ul> 
<pre><code class="prism language-java"><span class="token comment">//设置自定义分区</span>
kafkaProps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"partitioner.class"</span><span class="token punctuation">,</span> <span class="token string">"com.study.kafka.HashPartitioner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="Kafka_Producer_179"></a>Kafka Producer</h3> 
<p>在开发生产者的时候，先简单的介绍下kafka各种配置说明：</p> 
<ul><li>bootstrap.servers： kafka的地址。</li><li>acks:消息的确认机制，默认值是0。</li><li>acks=0：如果设置为0，生产者不会等待kafka的响应。</li><li>acks=1：这个配置意味着kafka会把这条消息写到本地日志文件中，但是不会等待集群中其他机器的成功响应。</li><li>acks=all：这个配置意味着leader会等待所有的follower同步完成。这个确保消息不会丢失，除非kafka集群中所有机器挂掉。这是最强的可用性保证。</li><li>retries：配置为大于0的值的话，客户端会在消息发送失败时重新发送。</li><li>batch.size:当多条消息需要发送到同一个分区时，生产者会尝试合并网络请求。这会提高client和生产者的效率。</li><li>key.serializer: 键序列化，默认org.apache.kafka.common.serialization.StringDeserializer。</li><li>value.deserializer:值序列化，默认org.apache.kafka.common.serialization.StringDeserializer。</li></ul> 
<p>还有更多配置，可以去查看官方文档，这里就不在说明了。<br> 那么我们kafka 的producer配置如下(集群搭建参考 <a href="https://blog.csdn.net/yangyanping20108/article/details/110481935">kafka 的架构一之入门</a>)</p> 
<pre><code class="prism language-java">		<span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:9092,127.0.0.1:9093,127.0.0.1:9094"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"acks"</span><span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"retries"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"batch.size"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在写好生产者程序之后，那我们先来生产吧！<br> 我这里发送的消息为:</p> 
<p>String message = “你好，这是第” + i + “条数据”;<br> 并且只发送10条就退出，结果如下:</p> 
<pre><code class="prism language-bash">发送的信息:你好，这是第0条数据
发送的信息:你好，这是第1条数据
发送的信息:你好，这是第2条数据
发送的信息:你好，这是第3条数据
发送的信息:你好，这是第4条数据
发送的信息:你好，这是第5条数据
发送的信息:你好，这是第6条数据
发送的信息:你好，这是第7条数据
发送的信息:你好，这是第8条数据
发送的信息:你好，这是第9条数据
</code></pre> 
<p>可以看到信息成功的打印了。<br> 如果不想用程序进行验证程序是否发送成功，以及消息发送的准确性，可以在kafka服务器上使用命令查看。</p> 
<h3><a id="Kafka_Consumer_228"></a>Kafka Consumer</h3> 
<p>kafka消费这块应该来说是重点，毕竟大部分的时候，我们主要使用的是将数据进行消费。</p> 
<p>kafka消费的配置如下:</p> 
<ul><li>bootstrap.servers： kafka的地址。</li><li>group.id：组名 不同组名可以重复消费。例如你先使用了组名A消费了kafka的1000条数据，但是你还想再次进行消费这1000条数据，并且不想重新去产生，那么这里你只需要更改组名就可以重复消费了。</li><li>enable.auto.commit：是否自动提交，默认为true。</li><li>auto.commit.interval.ms: 从poll(拉)的回话处理时长。</li><li>session.timeout.ms:超时时间。</li><li>max.poll.records:一次最大拉取的条数。</li><li>auto.offset.reset：消费规则，默认earliest 。</li><li>earliest: 当各分区下有已提交的offset时，从提交的offset开始消费；无提交的offset时，从头开始消费 。</li><li>latest: 当各分区下有已提交的offset时，从提交的offset开始消费；无提交的offset时，消费新产生的该分区下的数据 。</li><li>none: topic各分区都存在已提交的offset时，从offset后开始消费；只要有一个分区不存在已提交的offset，则抛出异常。</li><li>key.serializer: 键序列化，默认org.apache.kafka.common.serialization.StringDeserializer。</li><li>value.deserializer:值序列化，默认org.apache.kafka.common.serialization.StringDeserializer。</li></ul> 
<p>那么我们kafka 的consumer配置如下:</p> 
<pre><code class="prism language-java">        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:9092,127.0.0.1:9093,127.0.0.1:9094"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"GroupA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"enable.auto.commit"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"auto.commit.interval.ms"</span><span class="token punctuation">,</span> <span class="token string">"1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"session.timeout.ms"</span><span class="token punctuation">,</span> <span class="token string">"30000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"auto.offset.reset"</span><span class="token punctuation">,</span> <span class="token string">"earliest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> topicName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>由于我这是设置的自动提交，所以消费代码如下:<br> 我们需要先订阅一个topic，也就是指定消费哪一个topic。</p> 
<pre><code class="prism language-java">consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>订阅之后，我们再从kafka中拉取数据:</p> 
<pre><code class="prism language-java"><span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> msgList<span class="token operator">=</span>consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>一般来说进行消费会使用监听，这里我们就用for(;;)来进行监听， 并且设置消费100条就退出！<br> 结果如下:</p> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第1条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第4条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第7条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">4</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第0条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">5</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第3条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">6</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第6条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">7</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第9条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">8</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第2条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">9</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第5条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">10</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第8条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
</code></pre> 
<p>可以看到我们这里已经成功消费了生产的数据了。</p> 
<h3><a id="_293"></a>消费者代码</h3> 
<p>我们编写四个消费者类，分别为ConsumerA，ConsumerB，ConsumerC，ConsumerD，四个类的代码一样，类名不同。<br> ConsumerA 的代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringDeserializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerA</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> msgList<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GROUPID</span> <span class="token operator">=</span> <span class="token string">"GroupA"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">KafkaConsumerTestB</span><span class="token punctuation">(</span><span class="token class-name">String</span> topicName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:9092,127.0.0.1:9093"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token constant">GROUPID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"enable.auto.commit"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"auto.commit.interval.ms"</span><span class="token punctuation">,</span> <span class="token string">"1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"session.timeout.ms"</span><span class="token punctuation">,</span> <span class="token string">"30000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"auto.offset.reset"</span><span class="token punctuation">,</span> <span class="token string">"earliest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> topicName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> messageNo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"---------开始消费---------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                msgList <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> msgList <span class="token operator">&amp;&amp;</span> msgList<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> msgList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//消费100条就打印 ,但打印的数据不一定是这个规律的</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messageNo <span class="token operator">+</span> <span class="token string">"=======receive: key = "</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", value = "</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" offset==="</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" partition=="</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        messageNo<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">KafkaConsumerTestB</span> test1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumerTestB</span><span class="token punctuation">(</span><span class="token string">"test1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_360"></a>生产者代码</h3> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerTest</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">KafkaProducerTest</span><span class="token punctuation">(</span><span class="token class-name">String</span> topicName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:9092,127.0.0.1:9093,127.0.0.1:9094"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"acks"</span><span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"retries"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"batch.size"</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> topicName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> messageStr <span class="token operator">=</span> <span class="token string">"你好，这是第"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">;</span>
                producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>  messageStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//生产了100条就打印</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送的信息:"</span> <span class="token operator">+</span> messageStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">KafkaProducerTest</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducerTest</span><span class="token punctuation">(</span><span class="token string">"test1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_413"></a>分区消费关系</h3> 
<ul><li>我们先启动生产者KafkaProducerTest，生产10条数据，数据内容如下：</li></ul> 
<pre><code class="prism language-bash">发送的信息:你好，这是第0条数据
发送的信息:你好，这是第1条数据
发送的信息:你好，这是第2条数据
发送的信息:你好，这是第3条数据
发送的信息:你好，这是第4条数据
发送的信息:你好，这是第5条数据
发送的信息:你好，这是第6条数据
发送的信息:你好，这是第7条数据
发送的信息:你好，这是第8条数据
发送的信息:你好，这是第9条数据
</code></pre> 
<ul><li>只启动消费者ConsumerA，消费数据内容如下，发现消费者ConsumerA消费了三个分区的所有的10条数据。</li></ul> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第1条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第4条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第7条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">4</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第0条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">5</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第3条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">6</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第6条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">7</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第9条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">8</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第2条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">9</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第5条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">10</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第8条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
</code></pre> 
<p>消费者和分区的关系如图：<br> <img src="https://images2.imgbox.com/f9/bb/3oIHYoM8_o.jpg" width="50%"></p> 
<ul><li>启动ConsumerA 和 ConsumerB 消费者<br> ConsumerA 消费数据内容如下，ConsumerA消费了分区partition_0和分区partition_1共7条数据</li></ul> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第1条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第4条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第7条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">4</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第0条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">5</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第3条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">6</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第6条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">7</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第9条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">6</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
</code></pre> 
<p>ConsumerB 消费数据内容如下，ConsumerB消费分区partition_2共3条数据</p> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第2条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第5条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第8条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">6</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
</code></pre> 
<p>从消费信息中可以看出，ConsumerA 和 ConsumerB 一起消费了所有消息。<br> 消费者和分区的关系如图：<br> <img src="https://images2.imgbox.com/19/d0/tom3777u_o.jpg" width="50%"></p> 
<ul><li>启动ConsumerA 和 ConsumerB，ConsumerC 三个消费者<br> ConsumerA 消费数据内容如下，ConsumerA 消费分区partition_0共4条数据</li></ul> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第0条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">6</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第3条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">7</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第6条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">8</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">4</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第9条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">9</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
</code></pre> 
<p>ConsumerB 消费数据内容如下，ConsumerB 消费分区partition_1共3条数据</p> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第2条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">7</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第5条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">8</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第8条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">9</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
</code></pre> 
<p>ConsumerC 消费数据内容如下，ConsumerC 消费分区partition_2共3条数据</p> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第1条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">7</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第4条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">8</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第7条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">9</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
</code></pre> 
<p>从消费信息中可以看出，ConsumerA 和 ConsumerB ，ConsumerC一起消费了所有消息。消费者和分区的关系如图：<br> <img src="https://images2.imgbox.com/6f/2c/THKuA8Oo_o.jpg" width="50%"></p> 
<ul><li>启动ConsumerA 和 ConsumerB，ConsumerC ，ConsumerD 四个消费者<br> ConsumerA 消费数据内容如下，ConsumerA 消费分区partition_1共4条数据</li></ul> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第0条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">10</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第3条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">11</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第6条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">12</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
<span class="token assign-left variable">4</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第9条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">13</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">1</span>
</code></pre> 
<p>ConsumerB 消费数据内容如下，ConsumerB 消费分区partition_2共3条数据</p> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第2条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">10</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第5条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">11</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第8条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">12</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
</code></pre> 
<p>ConsumerC 消费数据内容如下，ConsumerC 消费分区partition_0共3条数据</p> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第1条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">10</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第4条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">11</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> null, value <span class="token operator">=</span> 你好，这是第7条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">12</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">0</span>
</code></pre> 
<p>ConsumerD 没有消费任何数据</p> 
<pre><code class="prism language-bash">---------开始消费---------

</code></pre> 
<img src="https://images2.imgbox.com/7f/a8/z6MpIPeG_o.jpg" width="50%"> 
<ul><li>结论<br> 一个topic 可以配置几个Partition，Producer发送的消息分发到不同的Partition中，Consumer接受数据的时候是按照group来接受，kafka确保每个Partition只能同一个group中的同一个Consumer消费，如果想要重复消费，那么需要其他的组来消费。<br> <img src="https://images2.imgbox.com/99/eb/wEr78vTI_o.jpg" alt="在这里插入图片描述"></li></ul> 
<h3><a id="_536"></a>顺序消费</h3> 
<p>Kafka比传统消息系统有更强的顺序性保证，它使用主题的分区作为消息处理的并行单元。Kafka以分区作为最小的粒度，将每个分区分配给消费者组中不同的而且是唯一的消费者，并确保一个分区只属于一个消费者，即这个消费者就是这个分区的唯一读取线程。那么，只要分区的消息是有序的，消费者处理的消息顺序就有保证。每个主题有多个分区，不同的消费者处理不同的分区，所以Kafka不仅保证了消息的有序性，也做到了消费者的负载均衡。<br> 使用 producer.send(new ProducerRecord&lt;String, String&gt;(topic,“test”, messageStr)) 发送消息，消息被发送到同一个分区。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerTest</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">KafkaProducerTest</span><span class="token punctuation">(</span><span class="token class-name">String</span> topicName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:9092,127.0.0.1:9093,127.0.0.1:9094"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"acks"</span><span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"retries"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"batch.size"</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> topicName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> messageStr <span class="token operator">=</span> <span class="token string">"你好，这是第"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">;</span>
                producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">,</span> messageStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//生产了100条就打印</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送的信息:"</span> <span class="token operator">+</span> messageStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token class-name">KafkaProducerTest</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducerTest</span><span class="token punctuation">(</span><span class="token string">"test1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-bash">发送的信息:你好，这是第1条数据
发送的信息:你好，这是第2条数据
发送的信息:你好，这是第3条数据
发送的信息:你好，这是第4条数据
发送的信息:你好，这是第5条数据
发送的信息:你好，这是第6条数据
发送的信息:你好，这是第7条数据
发送的信息:你好，这是第8条数据
发送的信息:你好，这是第9条数据
发送的信息:你好，这是第10条数据
</code></pre> 
<p>ConsumerA 和 ConsumerB没有消费任何消息</p> 
<pre><code class="prism language-bash">---------开始消费---------
</code></pre> 
<p>ConsumerC 消费所有10条消息，10条消息都被发送到partition=2 中</p> 
<pre><code class="prism language-bash">---------开始消费---------
<span class="token assign-left variable">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第1条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">333</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第2条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">334</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">3</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第3条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">335</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">4</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第4条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">336</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">5</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第5条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">337</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">6</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第6条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">338</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">7</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第7条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">339</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">8</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第8条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">340</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">9</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第9条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">341</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
<span class="token assign-left variable">10</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>receive: key <span class="token operator">=</span> test, value <span class="token operator">=</span> 你好，这是第10条数据 <span class="token assign-left variable">offset</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">342</span> <span class="token assign-left variable">partition</span><span class="token operator">==</span><span class="token number">2</span>
</code></pre> 
<h3><a id="Kafka__615"></a>Kafka 集群扩容</h3> 
<ul><li>修改config/server.properties文件里的broker.id必须在集群中唯一，修改其他必要的配置项，其中zookeeper.connect配置项，写上kafka集群现在使用的zookeeper集群的地址。然后启动kafka就可以加入到集群中了。但是新加入的机器只能对新产生的topic起作用，对已有的topic在没有做处理前，是不会承担任何任务的，所以不会分担集群的压力。</li></ul> 
<pre><code class="prism language-bash"><span class="token comment"># The id of the broker. This must be set to a unique integer for each broker.</span>
<span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://:9095
<span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/Users/yangyanping/Downloads/server/kafka/log/node4
<span class="token assign-left variable">offsets.topic.replication.factor</span><span class="token operator">=</span><span class="token number">3</span>
</code></pre> 
<p>在log文件夹下创建node4，然后启动新增的Broker</p> 
<pre><code class="prism language-bash">****-2f32839f6:node4 yangyanping$ ./bin/kafka-server-start.sh config/server.properties 
</code></pre> 
<p>使用zkCli.sh 查看节点信息，broker.id=3已添加到集群中。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token function">ls</span> /brokers/ids
<span class="token punctuation">[</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span>
</code></pre> 
<p>查看test1 消息主题信息，发现新增的Broker4 没有承担任何工作</p> 
<pre><code class="prism language-bash">ZBMAC-2f32839f6:node4 yangyanping$ ./bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> localhost:2181 <span class="token parameter variable">--topic</span> test1
Topic: test1	PartitionCount: <span class="token number">3</span>	ReplicationFactor: <span class="token number">3</span>	Configs: 
	Topic: test1	Partition: <span class="token number">0</span>	Leader: <span class="token number">0</span>	Replicas: <span class="token number">0,1</span>,2	Isr: <span class="token number">0,1</span>,2
	Topic: test1	Partition: <span class="token number">1</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,2</span>,0	Isr: <span class="token number">1,2</span>,0
	Topic: test1	Partition: <span class="token number">2</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,0</span>,1	Isr: <span class="token number">2,0</span>,1
</code></pre> 
<h3><a id="Kafka__644"></a>Kafka 集群缩容</h3> 
<p>我们来模拟Broker节点宕机的情况，查找Broker3节点的进程Id = 5393</p> 
<pre><code class="prism language-bash">***-2f32839f6:~ yangyanping$ <span class="token function">ps</span> <span class="token parameter variable">-e</span> <span class="token operator">|</span><span class="token function">grep</span> kafka
***-2f32839f6:~ yangyanping$ <span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token number">5393</span>
</code></pre> 
<p>查看test1 消息主题信息，发现Leader 中没有Broker2</p> 
<pre><code class="prism language-bash">****-2f32839f6:node4 yangyanping$ ./bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> localhost:2181 <span class="token parameter variable">--topic</span> test1
    Topic: test1	PartitionCount: <span class="token number">3</span>	ReplicationFactor: <span class="token number">3</span>	Configs: 
	Topic: test1	Partition: <span class="token number">0</span>	Leader: <span class="token number">0</span>	Replicas: <span class="token number">0,1</span>,2	Isr: <span class="token number">0,1</span>
	Topic: test1	Partition: <span class="token number">1</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,2</span>,0	Isr: <span class="token number">1,0</span>
	Topic: test1	Partition: <span class="token number">2</span>	Leader: <span class="token number">0</span>	Replicas: <span class="token number">2,0</span>,1	Isr: <span class="token number">0,1</span>
</code></pre> 
<h4><a id="kafkatopicGroup_Id_661"></a>kafka中不同topic使用同一个Group Id会出现的问题分析</h4> 
<p>在 Kafka 中，消费者组（consumer group）是一组逻辑上相同的消费者，它们共同消费订阅的 topic 中的消息。如果不同 topic 使用同一个 Group ID，那么它们将视为*同一组消费者，相当于每个消费者实例只能消费组中的一个主题，而其他主题的分区将不会被消费。同时，如果消息被放置在某个主题的分区中，在该主题下任何消费者组中的消费者都有可能消费到该消息，这可能导致数据重复消费或者数据消费不均，会降低整个消费群组的消费效率。因此，在实际应用中，应该为每个 topic 创建一个独立的 Group ID，以确保消费者能够正确地消费对应 topic 下的所有消息。</p> 
<h3><a id="_664"></a>参考</h3> 
<p>https://blog.csdn.net/fy_java1995/article/details/106399318<br> https://blog.csdn.net/qq_41941497/article/details/131070576</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/82a7d7e5e2cff4efbf7fde0ffc63dee5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">html：lang属性设置为中文zh-CN</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ea65fbc20dce6d38cf58de3568c1bde2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">用javascript制作简易计算器,用js做一个计算器代码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>