<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>@FeignClient注解的接口，用@Autowired可能获取不到实例 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="@FeignClient注解的接口，用@Autowired可能获取不到实例" />
<meta property="og:description" content="背景：
Spring-Boot 2.0.8.RELEASE
Spring-Cloud 2.0.4.RELEASE
OpenFeign 2.0.4.RELEASE
JDK 1.8
启动类：
package com.xxx.tfb; import java.sql.SQLException; import org.apache.commons.logging.Log; import org.apache.commons.logging.LogFactory; import org.camunda.bpm.spring.boot.starter.annotation.EnableProcessApplication; import org.h2.tools.Server; import org.mybatis.spring.annotation.MapperScan; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker; import org.springframework.cloud.netflix.eureka.EnableEurekaClient; import org.springframework.cloud.netflix.hystrix.EnableHystrix; import org.springframework.cloud.openfeign.EnableFeignClients; import org.springframework.context.annotation.ComponentScan; import org.springframework.context.annotation.FilterType; import com.xxx.framework.config.SecondDataSourceConfiguration; import springfox.documentation.swagger2.annotations.EnableSwagger2; @EnableEurekaClient @EnableFeignClients(basePackages=&#34;com.xxx&#34;) @EnableCircuitBreaker @EnableProcessApplication @EnableHystrix @SpringBootApplication @EnableSwagger2 @MapperScan(basePackages = { &#34;com.xxx.**.mapper&#34; }) @MapperScan(basePackages = { &#34;com.xxx.**.oramapper&#34; }) @ComponentScan(excludeFilters = {@ComponentScan.Filter(type = FilterType.ASSIGNABLE_TYPE, classes = {SecondDataSourceConfiguration.class})}) @ComponentScan(basePackages = { &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ec416125803693b121d1f5e9d5d9401e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-02T23:33:28+08:00" />
<meta property="article:modified_time" content="2021-03-02T23:33:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">@FeignClient注解的接口，用@Autowired可能获取不到实例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>背景：</p> 
<p>Spring-Boot 2.0.8.RELEASE</p> 
<p>Spring-Cloud 2.0.4.RELEASE</p> 
<p>OpenFeign 2.0.4.RELEASE</p> 
<p>JDK 1.8</p> 
<p>启动类：</p> 
<pre><code class="language-java">package com.xxx.tfb;

import java.sql.SQLException;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.camunda.bpm.spring.boot.starter.annotation.EnableProcessApplication;
import org.h2.tools.Server;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.hystrix.EnableHystrix;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.FilterType;

import com.xxx.framework.config.SecondDataSourceConfiguration;

import springfox.documentation.swagger2.annotations.EnableSwagger2;

@EnableEurekaClient
@EnableFeignClients(basePackages="com.xxx")
@EnableCircuitBreaker
@EnableProcessApplication
@EnableHystrix
@SpringBootApplication
@EnableSwagger2
@MapperScan(basePackages = { "com.xxx.**.mapper" })
@MapperScan(basePackages = { "com.xxx.**.oramapper" })
@ComponentScan(excludeFilters = {@ComponentScan.Filter(type = FilterType.ASSIGNABLE_TYPE, classes = {SecondDataSourceConfiguration.class})})
@ComponentScan(basePackages = { "com.xxx.framework","com.xxx.workflow",
		"com.xxx.tradeengine","com.xxx.component",
		"com.xxx.controller", "com.xxx.bizservice",
		"com.xxx.rpc","com.xxx.dto.rpc",
		"com.xxx.fallbackservice","com.xxx.helper" })
@SuppressWarnings("all")
public class TfbOrBizServiceApplication 
{
	private static Log log=LogFactory.getLog(TfbOrBizServiceApplication.class);
	
	public static void main(String[] args) {
		SpringApplication.run(TfbOrBizServiceApplication.class, args);
	}
}
</code></pre> 
<p>Feign客户端：</p> 
<pre><code class="language-java">package com.xxx.rpc;

import java.util.List;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import com.xxx.dto.tfb.function.UnitBizRequestDto;
import com.xxx.dto.tfb.function.UnitBizResponseDto;
import com.xxx.framework.dto.PaginationDto;
import com.xxx.framework.web.controller.PageRequestDto;
import com.xxx.framework.web.controller.ResponseDto;

@FeignClient(value = "tfb-biz-common-service-app", path="/tfb-biz-common-service-app")
public interface CommonBizRpc {
	
	/**
	 * 获取交易日期
	 */
	@RequestMapping(value = "/leftQuery/queryAcctDate", method = RequestMethod.POST)
	public ResponseDto&lt;String&gt; queryAcctDate();
}
</code></pre> 
<p>使用的地方：</p> 
<pre><code class="language-java">package com.xxx.tfb.component.or;

import org.springframework.context.annotation.DependsOn;
import org.springframework.stereotype.Component;

import com.xxx.TradeDto;
import com.xxx.bizenum.tfb.CommonEnum;
import com.xxx.framework.utils.SpringContextUtil;
import com.xxx.rpc.CommonBizRpc;
import com.xxx.tradeengine.dto.DataContext;
import com.xxx.tradeengine.parser.TradeComponent;

@Component
@DependsOn("springContextUtil")
public class OrOpenFxccDataInitComponentImpl implements TradeComponent {
	//公共交易服务
	CommonBizRpc commonBizRpc = SpringContextUtil.getBean("commonBizRpc");
			
	@Override
	public void exec(DataContext dataContext) {
		//交易日期
		orDto.setTxDt(commonBizRpc.queryAcctDate().getData());
	}

}
    </code></pre> 
<p>SpringContextUtil工具类：</p> 
<pre><code class="language-java">
@Component
public class SpringContextUtil implements ApplicationContextAware {
	private static ApplicationContext applicationContext; // Spring应用上下文环境

    
	/**
	 * 实现ApplicationContextAware接口的回调方法，设置上下文环境
	 * 
	 * @param applicationContext @
	 */
	@Override
	public void setApplicationContext(ApplicationContext applicationContext) {
		SpringContextUtil.applicationContext = applicationContext;
	}

	/**
	 * 获取对象
	 * 
	 * @param name
	 * @return Object 一个以所给名字注册的bean的实例 @
	 */
	@SuppressWarnings("unchecked")
	public static &lt;T&gt; T getBean(String name) {
		return (T) applicationContext.getBean(name);
	}

}</code></pre> 
<p>这样的配置，应用启动的时候报错了：</p> 
<pre><code>Constructor in com.xxx.tfb.component.or.OrOpenFxccDataInitComponentImpl required a bean named 'commonBizRpc' that could not be found.

Action:

Consider defining a bean named 'commonBizRpc' in your configuration.</code></pre> 
<p>报错的意思是不存在name为commonBizRpc的实例。已经在@EnableFeignClients(basePackages="com.xxx")配置了basePackages，而且可以确定该@FeignClient已经被扫描到了。</p> 
<p>为什么提示找不到呢？</p> 
<p>分析下源码：</p> 
<p>@EnableFeignClients 注解：</p> 
<pre><code class="language-java">@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@Documented
@Import(FeignClientsRegistrar.class)
public @interface EnableFeignClients {<!-- --></code></pre> 
<p>注意上面导入的FeignClientsRegistrar类，该类实现了将@FeignClient注解的接口加入到Spring管理的容器里：</p> 
<p> </p> 
<pre><code class="language-java">	@Override
	public void registerBeanDefinitions(AnnotationMetadata metadata,
			BeanDefinitionRegistry registry) {
		registerDefaultConfiguration(metadata, registry);
		registerFeignClients(metadata, registry);
	}
public void registerFeignClients(AnnotationMetadata metadata,
			BeanDefinitionRegistry registry) {
		ClassPathScanningCandidateComponentProvider scanner = getScanner();
		scanner.setResourceLoader(this.resourceLoader);

		Set&lt;String&gt; basePackages;

		Map&lt;String, Object&gt; attrs = metadata
				.getAnnotationAttributes(EnableFeignClients.class.getName());
		AnnotationTypeFilter annotationTypeFilter = new AnnotationTypeFilter(
				FeignClient.class);
		final Class&lt;?&gt;[] clients = attrs == null ? null
				: (Class&lt;?&gt;[]) attrs.get("clients");
		if (clients == null || clients.length == 0) {
			scanner.addIncludeFilter(annotationTypeFilter);
			basePackages = getBasePackages(metadata);
		}
		else {
			final Set&lt;String&gt; clientClasses = new HashSet&lt;&gt;();
			basePackages = new HashSet&lt;&gt;();
			for (Class&lt;?&gt; clazz : clients) {
				basePackages.add(ClassUtils.getPackageName(clazz));
				clientClasses.add(clazz.getCanonicalName());
			}
			AbstractClassTestingTypeFilter filter = new AbstractClassTestingTypeFilter() {
				@Override
				protected boolean match(ClassMetadata metadata) {
					String cleaned = metadata.getClassName().replaceAll("\\$", ".");
					return clientClasses.contains(cleaned);
				}
			};
			scanner.addIncludeFilter(
					new AllTypeFilter(Arrays.asList(filter, annotationTypeFilter)));
		}

		for (String basePackage : basePackages) {
			Set&lt;BeanDefinition&gt; candidateComponents = scanner
					.findCandidateComponents(basePackage);
			for (BeanDefinition candidateComponent : candidateComponents) {
				if (candidateComponent instanceof AnnotatedBeanDefinition) {
					// verify annotated class is an interface
					AnnotatedBeanDefinition beanDefinition = (AnnotatedBeanDefinition) candidateComponent;
					AnnotationMetadata annotationMetadata = beanDefinition.getMetadata();
					Assert.isTrue(annotationMetadata.isInterface(),
							"@FeignClient can only be specified on an interface");

					Map&lt;String, Object&gt; attributes = annotationMetadata
							.getAnnotationAttributes(
									FeignClient.class.getCanonicalName());

					String name = getClientName(attributes);
					registerClientConfiguration(registry, name,
							attributes.get("configuration"));

					registerFeignClient(registry, annotationMetadata, attributes);
				}
			}
		}
	}

private void registerFeignClient(BeanDefinitionRegistry registry,
			AnnotationMetadata annotationMetadata, Map&lt;String, Object&gt; attributes) {
		String className = annotationMetadata.getClassName();
		BeanDefinitionBuilder definition = BeanDefinitionBuilder
				.genericBeanDefinition(FeignClientFactoryBean.class);
		validate(attributes);
		definition.addPropertyValue("url", getUrl(attributes));
		definition.addPropertyValue("path", getPath(attributes));
		String name = getName(attributes);
		definition.addPropertyValue("name", name);
        // className为带有包路径的类名
		definition.addPropertyValue("type", className);
		definition.addPropertyValue("decode404", attributes.get("decode404"));
		definition.addPropertyValue("fallback", attributes.get("fallback"));
		definition.addPropertyValue("fallbackFactory", attributes.get("fallbackFactory"));
		definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);

        // 默认的别名
        // 这里的name是服务方的名称，本示例为注册到Eureka里的服务名
		String alias = name + "FeignClient";
		AbstractBeanDefinition beanDefinition = definition.getBeanDefinition();

		boolean primary = (Boolean)attributes.get("primary"); // has a default, won't be null

		beanDefinition.setPrimary(primary);

        // 如果注解里加了qualifier，别名就使用qualifier里的名称
		String qualifier = getQualifier(attributes);
		if (StringUtils.hasText(qualifier)) {
			alias = qualifier;
		}

		BeanDefinitionHolder holder = new BeanDefinitionHolder(beanDefinition, className,
				new String[] { alias });
		BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);
	}</code></pre> 
<p>注意上面的registerFeignClients方法，交给Spring容器管理的实例的name默认是className，即带有包路径的name，本次示例为"com.xxx.rpc.CommonBizRpc"，默认的别名：<br>         // 这里的name是服务方的名称，本示例为注册到Eureka里的服务名，tfb-biz-common-service-appFeignClient<br>         String alias = name + "FeignClient";</p> 
<p><br>         // 如果注解里加了qualifier，别名就使用qualifier里的名称<br>         String qualifier = getQualifier(attributes);<br>         if (StringUtils.hasText(qualifier)) {<!-- --><br>             alias = qualifier;<br>         }</p> 
<p>这样在注入的时候，要么使用的name是com.xxx.rpc.CommonBizRpc而不能是CommonBizRpc，或tfb-biz-common-service-appFeignClient（如果该服务注册多个客户端，可能会报错），或使用CommonBizRpc.class</p> 
<p>SpringContextUtil.getBean();</p> 
<p>@AutoWired也一样</p> 
<p> </p> 
<p>为了方便使用，建议在每个@FeignClient里配置上qualifier，修改后的代码如下：</p> 
<pre><code class="language-java">package com.xxx.rpc;


import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;


@FeignClient(value = "tfb-biz-common-service-app", path="/tfb-biz-common-service-app", qualifier="commonBizRpc")
public interface CommonBizRpc {
	
	/**
	 * 获取交易日期
	 */
	@RequestMapping(value = "/leftQuery/queryAcctDate", method = RequestMethod.POST)
	public ResponseDto&lt;String&gt; queryAcctDate();
}
</code></pre> 
<p> </p> 
<p>注意事项：</p> 
<p>1.@EnableFeignClients(basePackages="com.xxx") 如果不配置basePackages的话，那么默认只会扫描当前启动类包及其子包的@FeignClient注解</p> 
<p>2.@FeignClient里的path最好写上，而且是服务端的contextPath(value = "tfb-biz-common-service-app", path="/tfb-biz-common-service-app", qualifier="commonBizRpc")</p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/070ca799296b6529e54d0756d95f4b8f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Flowable 6.6.0 Eclipse设计器 - 3.BPMN 特性</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/41e1c98c39a1f8687b4e66832e17824f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mac下启动jupyter notebook</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>