<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Airtestæºç è§£æ - èœé¸Ÿç¨‹åºå‘˜åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Airtestæºç è§£æ" />
<meta property="og:description" content="Airtestå›¾åƒè¯†åˆ« Airtestä»‹ç»æºç touchæ–¹æ³•æµ‹è¯•ä»£ç ä¸ç»“æœï¼šAKAZEå±€éƒ¨åŒ¹é…ä»‹ç»ä»£ç æ¯”è¾ƒ æœ€ç»ˆç”¨åˆ°çš„å°±æ˜¯OpenCVçš„ä¸¤ä¸ªæ–¹æ³•ï¼šæ¨¡ç‰ˆåŒ¹é…å’Œç‰¹å¾åŒ¹é… Airtestä»‹ç» Airtestæ˜¯ä¸€æ¬¾ç½‘æ˜“å‡ºå“çš„åŸºäºå›¾åƒè¯†åˆ«é¢å‘æ‰‹æ¸¸UIæµ‹è¯•çš„å·¥å…·ï¼Œä¹Ÿæ”¯æŒåŸç”ŸAndroid AppåŸºäºå…ƒç´ è¯†åˆ«çš„UIè‡ªåŠ¨åŒ–æµ‹è¯•(ç°åœ¨æ”¯æŒAndroidã€iosã€Windows)ã€‚ä¸»è¦åŒ…å«äº†ä¸‰éƒ¨åˆ†ï¼šAirtest IDEã€Airtestï¼ˆç”¨æˆªå›¾å†™è„šæœ¬ï¼‰å’Œ Pocoï¼ˆç”¨ç•Œé¢UIå…ƒç´ æ¥å†™è„šæœ¬ï¼‰ã€‚æ¥è‡ªGoogleçš„è¯„ä»·ï¼šAirtest æ˜¯å®‰å“æ¸¸æˆå¼€å‘æœ€å¼ºå¤§ã€æœ€å…¨é¢çš„è‡ªåŠ¨æµ‹è¯•æ–¹æ¡ˆä¹‹ä¸€ã€‚
æºç  Airtest
ä¸‹è½½åï¼Œå¦‚æœï¼Œåªæ˜¯ä»£ç é˜…è¯»ï¼Œå¯ä»¥ä¸ç”¨éƒ¨ç½²ç¯å¢ƒã€‚è¿è¡Œéœ€è¦å‚ç…§readmeï¼Œæœ‰ä¸­æ–‡ç‰ˆå¾ˆè´´å¿ƒ ğŸ˜ƒ
touchæ–¹æ³• å¦‚å›¾ç¤ºæ‰€ç¤ºï¼Œä»touchå›¾ç‰‡å¼€å§‹ï¼Œå³ä¸ºç‚¹å‡»æŸä¸ªä¼ å…¥çš„å›¾ç‰‡ï¼Œæºç åœ¨api.pyé‡Œé¢ï¼š
@logwrap def touch(v, times=1, **kwargs): &#34;&#34;&#34; Perform the touch action on the device screen :param v: target to touch, either a ``Template`` instance or absolute coordinates (x, y) :param times: how many touches to be performed :param kwargs: platform specific `kwargs`, please refer to corresponding docs :return: finial position to be clicked :platforms: Android, Windows, iOS :Example: Click absolute coordinates:: &gt;&gt;&gt; touch((100, 100)) Click the center of the picture(Template object):: &gt;&gt;&gt; touch(Template(r&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5019b2d6b4990fa27a6725f91fa12068/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-10T14:31:24+08:00" />
<meta property="article:modified_time" content="2021-06-10T14:31:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="èœé¸Ÿç¨‹åºå‘˜åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">èœé¸Ÿç¨‹åºå‘˜åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Airtestæºç è§£æ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Airtestå›¾åƒè¯†åˆ«</h4> 
 <ul><li><a href="#Airtest_2" rel="nofollow">Airtestä»‹ç»</a></li><li><ul><li><a href="#_6" rel="nofollow">æºç </a></li><li><a href="#touch_10" rel="nofollow">touchæ–¹æ³•</a></li><li><ul><li><a href="#_244" rel="nofollow">æµ‹è¯•ä»£ç ä¸ç»“æœï¼š</a></li><li><a href="#AKAZE_324" rel="nofollow">AKAZEå±€éƒ¨åŒ¹é…ä»‹ç»</a></li><li><ul><li><a href="#_337" rel="nofollow">ä»£ç æ¯”è¾ƒ</a></li></ul> 
    </li><li><a href="#OpenCV_593" rel="nofollow">æœ€ç»ˆç”¨åˆ°çš„å°±æ˜¯OpenCVçš„ä¸¤ä¸ªæ–¹æ³•ï¼šæ¨¡ç‰ˆåŒ¹é…å’Œç‰¹å¾åŒ¹é…</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Airtest_2"></a>Airtestä»‹ç»</h2> 
<p>Airtestæ˜¯ä¸€æ¬¾ç½‘æ˜“å‡ºå“çš„åŸºäºå›¾åƒè¯†åˆ«é¢å‘æ‰‹æ¸¸UIæµ‹è¯•çš„å·¥å…·ï¼Œä¹Ÿæ”¯æŒåŸç”ŸAndroid AppåŸºäºå…ƒç´ è¯†åˆ«çš„UIè‡ªåŠ¨åŒ–æµ‹è¯•(ç°åœ¨æ”¯æŒAndroidã€iosã€Windows)ã€‚ä¸»è¦åŒ…å«äº†ä¸‰éƒ¨åˆ†ï¼šAirtest IDEã€Airtestï¼ˆç”¨æˆªå›¾å†™è„šæœ¬ï¼‰å’Œ Pocoï¼ˆç”¨ç•Œé¢UIå…ƒç´ æ¥å†™è„šæœ¬ï¼‰ã€‚æ¥è‡ªGoogleçš„è¯„ä»·ï¼šAirtest æ˜¯å®‰å“æ¸¸æˆå¼€å‘æœ€å¼ºå¤§ã€æœ€å…¨é¢çš„è‡ªåŠ¨æµ‹è¯•æ–¹æ¡ˆä¹‹ä¸€ã€‚</p> 
<h3><a id="_6"></a>æºç </h3> 
<p><a href="https://github.com/AirtestProject/Airtest">Airtest</a><br> ä¸‹è½½åï¼Œå¦‚æœï¼Œåªæ˜¯ä»£ç é˜…è¯»ï¼Œå¯ä»¥ä¸ç”¨éƒ¨ç½²ç¯å¢ƒã€‚è¿è¡Œéœ€è¦å‚ç…§readmeï¼Œæœ‰ä¸­æ–‡ç‰ˆå¾ˆè´´å¿ƒ ğŸ˜ƒ</p> 
<h3><a id="touch_10"></a>touchæ–¹æ³•</h3> 
<p>å¦‚å›¾ç¤ºæ‰€ç¤ºï¼Œä»touchå›¾ç‰‡å¼€å§‹ï¼Œå³ä¸ºç‚¹å‡»æŸä¸ªä¼ å…¥çš„å›¾ç‰‡ï¼Œæºç åœ¨api.pyé‡Œé¢ï¼š<br> <img src="https://images2.imgbox.com/4b/3d/aaEnhWlZ_o.png" alt="Alt"></p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@logwrap</span>
<span class="token keyword">def</span> <span class="token function">touch</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> times<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Perform the touch action on the device screen

    :param v: target to touch, either a ``Template`` instance or absolute coordinates (x, y)
    :param times: how many touches to be performed
    :param kwargs: platform specific `kwargs`, please refer to corresponding docs
    :return: finial position to be clicked
    :platforms: Android, Windows, iOS
    :Example:
        Click absolute coordinates::

        &gt;&gt;&gt; touch((100, 100))

        Click the center of the picture(Template object)::

        &gt;&gt;&gt; touch(Template(r"tpl1606730579419.png", target_pos=5))

        Click 2 times::

        &gt;&gt;&gt; touch((100, 100), times=2)

        Under Android and Windows platforms, you can set the click duration::

        &gt;&gt;&gt; touch((100, 100), duration=2)

        Right click(Windows)::

        &gt;&gt;&gt; touch((100, 100), right_click=True)

    """</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> Template<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pos <span class="token operator">=</span> loop_find<span class="token punctuation">(</span>v<span class="token punctuation">,</span> timeout<span class="token operator">=</span>ST<span class="token punctuation">.</span>FIND_TIMEOUT<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        try_log_screen<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pos <span class="token operator">=</span> v
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>times<span class="token punctuation">)</span><span class="token punctuation">:</span>
        G<span class="token punctuation">.</span>DEVICE<span class="token punctuation">.</span>touch<span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span>
    delay_after_operation<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pos
</code></pre> 
<p>è¿™ä¸ªå‡½æ•°æ‰§è¡Œç‚¹å‡»æ“ä½œçš„æ˜¯ G.DEVICE.touch(pos, **kwargs)ï¼Œè€Œposå°±æ˜¯å›¾ç‰‡åŒ¹é…è¿”å›çš„åæ ‡ä½ç½®ï¼Œé‡ç‚¹çœ‹loop_findè¿™ä¸ªå‡½æ•°æ˜¯æ€æ ·è¯†åˆ«å¹¶è¿”å›åæ ‡æ•°æ®çš„ï¼š</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@logwrap</span>
<span class="token keyword">def</span> <span class="token function">loop_find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> timeout<span class="token operator">=</span>ST<span class="token punctuation">.</span>FIND_TIMEOUT<span class="token punctuation">,</span> threshold<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> interval<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> intervalfunc<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Search for image template in the screen until timeout

    Args:
        query: image template to be found in screenshot
        timeout: time interval how long to look for the image template
        threshold: default is None
        interval: sleep interval before next attempt to find the image template
        intervalfunc: function that is executed after unsuccessful attempt to find the image template

    Raises:
        TargetNotFoundError: when image template is not found in screenshot

    Returns:
        TargetNotFoundError if image template not found, otherwise returns the position where the image template has
        been found in screenshot

    """</span>
    G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Try finding: %s"</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        screen <span class="token operator">=</span> G<span class="token punctuation">.</span>DEVICE<span class="token punctuation">.</span>snapshot<span class="token punctuation">(</span>filename<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> quality<span class="token operator">=</span>ST<span class="token punctuation">.</span>SNAPSHOT_QUALITY<span class="token punctuation">)</span>

        <span class="token keyword">if</span> screen <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"Screen is None, may be locked"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> threshold<span class="token punctuation">:</span>
                query<span class="token punctuation">.</span>threshold <span class="token operator">=</span> threshold
            match_pos <span class="token operator">=</span> query<span class="token punctuation">.</span>match_in<span class="token punctuation">(</span>screen<span class="token punctuation">)</span>
            <span class="token keyword">if</span> match_pos<span class="token punctuation">:</span>
                try_log_screen<span class="token punctuation">(</span>screen<span class="token punctuation">)</span>
                <span class="token keyword">return</span> match_pos

        <span class="token keyword">if</span> intervalfunc <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            intervalfunc<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># è¶…æ—¶åˆ™raiseï¼Œæœªè¶…æ—¶åˆ™è¿›è¡Œä¸‹æ¬¡å¾ªç¯:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">&gt;</span> timeout<span class="token punctuation">:</span>
            try_log_screen<span class="token punctuation">(</span>screen<span class="token punctuation">)</span>
            <span class="token keyword">raise</span> TargetNotFoundError<span class="token punctuation">(</span><span class="token string">'Picture %s not found in screen'</span> <span class="token operator">%</span> query<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
</code></pre> 
<p>è§£è¯»ä¸‹è¿™ä¸ªloop_findè¿™ä¸ªæ–¹æ³•ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">loop_find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> timeout<span class="token operator">=</span>ST<span class="token punctuation">.</span>FIND_TIMEOUT<span class="token punctuation">,</span> threshold<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> interval

<span class="token triple-quoted-string string">"""
å‚æ•°ï¼š

æŸ¥è¯¢ï¼šæˆªå›¾ä¸­æ‰¾åˆ°çš„å›¾åƒæ¨¡æ¿

è¶…æ—¶ï¼šæŸ¥æ‰¾å›¾åƒæ¨¡æ¿çš„æ—¶é—´é—´éš”

é˜ˆå€¼ï¼šé»˜è®¤å€¼ä¸ºâ€œæ— â€

é—´éš”ï¼šä¸‹æ¬¡å°è¯•æŸ¥æ‰¾å›¾åƒæ¨¡æ¿ä¹‹å‰çš„ç¡çœ é—´éš”

intervalfuncï¼šåœ¨attå¤±è´¥åæ‰§è¡Œçš„å‡½æ•°
"""</span>
</code></pre> 
<p>1ã€é¦–å…ˆä¼šè·å–æ‰‹æœºå±å¹•æˆªå›¾ï¼›</p> 
<p>2ã€ç„¶åå¯¹æ¯”è„šæœ¬ä¼ å…¥å›¾ç‰‡è·å–åŒ¹é…ä¸Šçš„ä½ç½®ï¼›</p> 
<p>3ã€ä¸€ç›´é‡å¤ä¸Šé¢ä¸¤æ­¥éª¤ç›´åˆ°åŒ¹é…ä¸Šæˆ–è€…è¶…æ—¶ã€‚</p> 
<p>è·Ÿè„šæœ¬ä¼ å…¥å›¾ç‰‡è¿›è¡ŒåŒ¹é…çš„ä»£ç åœ¨è¿™ä¸€è¡Œ match_pos = query.match_in(screen)</p> 
<p>åœ¨cv.py é‡Œé¢æ‰¾åˆ° Templateç±»çš„ match_inæ–¹æ³•ï¼š</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">match_in</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> screen<span class="token punctuation">)</span><span class="token punctuation">:</span>
        match_result <span class="token operator">=</span> self<span class="token punctuation">.</span>_cv_match<span class="token punctuation">(</span>screen<span class="token punctuation">)</span>
        G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"match result: %s"</span><span class="token punctuation">,</span> match_result<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> match_result<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        focus_pos <span class="token operator">=</span> TargetPos<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getXY<span class="token punctuation">(</span>match_result<span class="token punctuation">,</span> self<span class="token punctuation">.</span>target_pos<span class="token punctuation">)</span>
        <span class="token keyword">return</span> focus_pos
</code></pre> 
<p>è§£è¯»ä¸‹ match_inæ–¹æ³•ï¼š</p> 
<p>1ã€è°ƒç”¨è‡ªå·±çš„_cv_mathæ–¹æ³•ï¼Œæ‰¾åˆ°åŒ¹é…åˆ°çš„åæ ‡ç»“æœï¼›</p> 
<p>2ã€æ ¹æ®å›¾ç‰‡åæ ‡è¿”å›ç‚¹å‡»åæ ‡ï¼Œé»˜è®¤ç‚¹å‡»å›¾ç‰‡ä¸­å¿ƒä½ç½®ã€‚</p> 
<p>æ¥ä¸‹æ¥çœ‹ self._cv_match(screen) ä¹Ÿåœ¨cv.py é‡Œé¢ï¼š</p> 
<pre><code class="prism language-python"> <span class="token decorator annotation punctuation">@logwrap</span>
    <span class="token keyword">def</span> <span class="token function">_cv_match</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> screen<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># in case image file not exist in current directory:</span>
        image <span class="token operator">=</span> self<span class="token punctuation">.</span>_imread<span class="token punctuation">(</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> self<span class="token punctuation">.</span>_resize_image<span class="token punctuation">(</span>image<span class="token punctuation">,</span> screen<span class="token punctuation">,</span> ST<span class="token punctuation">.</span>RESIZE_METHOD<span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">for</span> method <span class="token keyword">in</span> ST<span class="token punctuation">.</span>CVSTRATEGY<span class="token punctuation">:</span>
            <span class="token comment"># get function definition and execute:</span>
            func <span class="token operator">=</span> MATCHING_METHODS<span class="token punctuation">.</span>get<span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> func <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> InvalidMatchingMethodError<span class="token punctuation">(</span><span class="token string">"Undefined method in CVSTRATEGY: '%s', try 'kaze'/'brisk'/'akaze'/'orb'/'surf'/'sift'/'brief' instead."</span> <span class="token operator">%</span> method<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                ret <span class="token operator">=</span> self<span class="token punctuation">.</span>_try_match<span class="token punctuation">(</span>func<span class="token punctuation">,</span> image<span class="token punctuation">,</span> screen<span class="token punctuation">,</span> threshold<span class="token operator">=</span>self<span class="token punctuation">.</span>threshold<span class="token punctuation">,</span> rgb<span class="token operator">=</span>self<span class="token punctuation">.</span>rgb<span class="token punctuation">)</span>
            <span class="token keyword">if</span> ret<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        <span class="token keyword">return</span> ret
</code></pre> 
<p>è§£è¯»ä¸‹_cv_matchä»£ç ï¼š</p> 
<p>1ã€å°†ç”¨ä¾‹ä¼ å…¥çš„æˆªå›¾è¿›è¡Œç¼©æ”¾ï¼ˆå†™ç”¨ä¾‹è®¾å¤‡ä¸è¿è¡Œç”¨ä¾‹è®¾å¤‡å¯èƒ½ä¸ä¸€è‡´ï¼‰ï¼›</p> 
<p>2ã€éå†é…ç½®é¡¹é‡Œé¢çš„æ–¹æ³•ï¼Œè¿›è¡ŒåŒ¹é…ã€‚åŒ¹é…æ–¹æ³•æ˜¯_try_match()</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">_try_match</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"try match with %s"</span> <span class="token operator">%</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            ret <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">.</span>find_best_result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> aircv<span class="token punctuation">.</span>NoModuleError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
            G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"'surf'/'sift'/'brief' is in opencv-contrib module. You can use 'tpl'/'kaze'/'brisk'/'akaze'/'orb' in CVSTRATEGY, or reinstall opencv with the contrib module."</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">except</span> aircv<span class="token punctuation">.</span>BaseError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
            G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> ret
</code></pre> 
<p>é€šè¿‡ï¼Œfind_best_result()æ–¹æ³•å¾—åˆ°ç»“æœï¼š</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@print_run_time</span>
    <span class="token keyword">def</span> <span class="token function">find_best_result</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""åŸºäºkazeè¿›è¡Œå›¾åƒè¯†åˆ«ï¼Œåªç­›é€‰å‡ºæœ€ä¼˜åŒºåŸŸ."""</span>
        <span class="token triple-quoted-string string">"""å‡½æ•°åŠŸèƒ½ï¼šæ‰¾åˆ°æœ€ä¼˜ç»“æœ."""</span>
        <span class="token comment"># ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒå›¾åƒè¾“å…¥</span>
        check_source_larger_than_search<span class="token punctuation">(</span>self<span class="token punctuation">.</span>im_source<span class="token punctuation">,</span> self<span class="token punctuation">.</span>im_search<span class="token punctuation">)</span>
        <span class="token comment"># ç¬¬äºŒæ­¥ï¼šè®¡ç®—æ¨¡æ¿åŒ¹é…çš„ç»“æœçŸ©é˜µres</span>
        res <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_template_result_matrix<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># ç¬¬ä¸‰æ­¥ï¼šä¾æ¬¡è·å–åŒ¹é…ç»“æœ</span>
        min_val<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> min_loc<span class="token punctuation">,</span> max_loc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        h<span class="token punctuation">,</span> w <span class="token operator">=</span> self<span class="token punctuation">.</span>im_search<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token comment"># æ±‚å–å¯ä¿¡åº¦:</span>
        confidence <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_confidence_from_matrix<span class="token punctuation">(</span>max_loc<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
        <span class="token comment"># æ±‚å–è¯†åˆ«ä½ç½®: ç›®æ ‡ä¸­å¿ƒ + ç›®æ ‡åŒºåŸŸ:</span>
        middle_point<span class="token punctuation">,</span> rectangle <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_target_rectangle<span class="token punctuation">(</span>max_loc<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
        best_match <span class="token operator">=</span> generate_result<span class="token punctuation">(</span>middle_point<span class="token punctuation">,</span> rectangle<span class="token punctuation">,</span> confidence<span class="token punctuation">)</span>
        LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"[%s] threshold=%s, result=%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>METHOD_NAME<span class="token punctuation">,</span> self<span class="token punctuation">.</span>threshold<span class="token punctuation">,</span> best_match<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> best_match <span class="token keyword">if</span> confidence <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>threshold <span class="token keyword">else</span> <span class="token boolean">None</span>
</code></pre> 
<p>æ¦‚æ‹¬æ¥è¯´find_best_result ä¸»è¦åšäº†è¿™å‡ ä»¶äº‹æƒ…ï¼š</p> 
<p>1ã€æ ¡éªŒå›¾åƒè¾“å…¥ï¼›</p> 
<p>2ã€è®¡ç®—æ¨¡æ¿åŒ¹é…çš„ç»“æœçŸ©é˜µresï¼›</p> 
<p>3ã€ä¾æ¬¡è·å–åŒ¹é…ç»“æœï¼›</p> 
<p>4ã€æ±‚å–å¯ä¿¡åº¦ï¼›</p> 
<p>5ã€æ±‚å–è¯†åˆ«ä½ç½®ã€‚<br> åŸºäºkazeè¿›è¡Œå›¾åƒè¯†åˆ«ï¼Œåªç­›é€‰å‡ºæœ€ä¼˜åŒºåŸŸ.<br> KAZEæ˜¯å‘è¡¨åœ¨ECCV2012çš„ä¸€ç§ç‰¹å¾ç‚¹æ£€æµ‹ç®—æ³•ï¼Œç›¸æ¯”äºSIFTå’ŒSURFï¼ŒKAZEå»ºç«‹çš„é«˜æ–¯é‡‘å­—å¡”æ˜¯éçº¿æ€§çš„å°ºåº¦ç©ºé—´ï¼Œé‡‡ç”¨åŠ æ€§ç®—å­åˆ†è£‚ç®—æ³•(Additive Operator Splitting, AOS)æ¥è¿›è¡Œéçº¿æ€§æ‰©æ•£æ»¤æ³¢ã€‚ä¸€ä¸ªå¾ˆæ˜¾è‘—çš„ç‰¹ç‚¹æ˜¯åœ¨æ¨¡ç³Šå›¾åƒçš„åŒæ—¶è¿˜èƒ½ä¿ç•™è¾¹ç¼˜ç»†èŠ‚ã€‚<br> KAZEè®ºæ–‡ä¸­ç»™å‡ºäº†è‹¥å¹²å®éªŒå›¾è¡¨æ•°æ®ï¼Œä¸SURFã€SIFTå’ŒSTARç›¸æ¯”ï¼ŒKAZEæœ‰æ›´å¥½çš„å°ºåº¦å’Œæ—‹è½¬ä¸å˜æ€§ï¼Œå¹¶ä¸”ç¨³å®šã€å¯é‡å¤æ£€æµ‹ã€‚ä¸»è¦çš„å®éªŒåŒ…æ‹¬ï¼š</p> 
<blockquote> 
 <p>ï¼ˆ1ï¼‰é‡å¤æ£€æµ‹è¯•éªŒ<br> è¿™é‡Œä¸»è¦ä»æ—‹è½¬ç¼©æ”¾ã€è§†è§’å˜æ¢ã€å™ªå£°å¹²æ‰°ã€æ¨¡ç³Šå›¾åƒã€å‹ç¼©å›¾åƒç­‰æ–¹é¢è¿›è¡Œäº†æµ‹è¯•ï¼Œå¯ä»¥çœ‹å‡ºKAZEçš„å¯é‡å¤æ€§æ˜æ˜¾ä¼˜äºå…¶å®ƒç‰¹å¾ã€‚<br> <img src="https://images2.imgbox.com/14/1d/pREGsQ6f_o.png" alt="Alt"><br> ï¼ˆ2ï¼‰ç‰¹å¾æ£€æµ‹ä¸åŒ¹é…è¯•éªŒ<br> è¿™é‡Œä¹Ÿæ˜¯ä»æ—‹è½¬ç¼©æ”¾ã€è§†è§’å˜æ¢ã€å™ªå£°å¹²æ‰°ã€æ¨¡ç³Šå›¾åƒã€å‹ç¼©å›¾åƒç­‰æ–¹é¢è¿›è¡Œäº†æµ‹è¯•ï¼Œç»™å‡ºäº†ç‰¹å¾åŒ¹é…çš„Precision-Recallå›¾ã€‚ä½¿ç”¨çš„åŒ¹é…ç®—æ³•æ˜¯æœ€è¿‘é‚»åŒ¹é…ã€‚è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œåœ¨å›¾åƒæ¨¡ç³Šã€å™ªå£°å¹²æ‰°å’Œå‹ç¼©é‡æ„ç­‰é€ æˆçš„ä¿¡æ¯ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼ŒKAZEç‰¹å¾çš„é²æ£’æ€§æ˜æ˜¾ä¼˜äºå…¶å®ƒç‰¹å¾ã€‚<br> <img src="https://images2.imgbox.com/d3/ce/rf22G3H6_o.png" alt="Alt"><br> ï¼ˆ3ï¼‰è¡¨é¢å½¢å˜ç›®æ ‡çš„ç‰¹å¾åŒ¹é…<br> è¿™é‡Œå¯ä»¥çœ‹å‡ºåŸºäºg2ä¼ å¯¼å‡½æ•°çš„KAZEç‰¹å¾æ€§èƒ½æœ€å¥½ã€‚<br> <img src="https://images2.imgbox.com/7b/29/FPrIwQ97_o.png" alt="Alt"><br> ï¼ˆ4ï¼‰ æ£€æµ‹æ•ˆç‡æµ‹è¯•<br> è¿™é‡Œå¯ä»¥çœ‹å‡ºKAZEçš„ç‰¹å¾æ£€æµ‹æ—¶é—´é«˜äºSURFå’ŒSTARï¼Œä½†ä¸SIFTç›¸è¿‘ã€‚è¿™é‡Œæ¯”è¾ƒèŠ±æ—¶é—´çš„æ˜¯éçº¿æ€§å°ºåº¦ç©ºé—´çš„æ„å»ºã€‚<br> <img src="https://images2.imgbox.com/a9/69/URXdGPyJ_o.png" alt="Alt"></p> 
</blockquote> 
<h4><a id="_244"></a>æµ‹è¯•ä»£ç ä¸ç»“æœï¼š</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>


<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Mat img1 <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"C:/Users/wenhaofu/Desktop/picture/gril1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat img2 <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"C:/Users/wenhaofu/Desktop/picture/gril2.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>img1<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> img2<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"could not load images...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"box image"</span><span class="token punctuation">,</span> img1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"scene image"</span><span class="token punctuation">,</span> img2<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// extract kaze features</span>
    Ptr<span class="token operator">&lt;</span>KAZE<span class="token operator">&gt;</span> detector <span class="token operator">=</span> <span class="token class-name">KAZE</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keypoints_obj<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keypoints_scene<span class="token punctuation">;</span>
    Mat descriptor_obj<span class="token punctuation">,</span> descriptor_scene<span class="token punctuation">;</span>
    <span class="token keyword">double</span> t1 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    detector<span class="token operator">-&gt;</span><span class="token function">detectAndCompute</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keypoints_obj<span class="token punctuation">,</span> descriptor_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    detector<span class="token operator">-&gt;</span><span class="token function">detectAndCompute</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keypoints_scene<span class="token punctuation">,</span> descriptor_scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> t2 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> tkaze <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span> <span class="token operator">/</span> cv<span class="token operator">::</span><span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">" KAZE Time consume(ms): "</span> <span class="token operator">&lt;&lt;</span> tkaze <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">// matching</span>
    <span class="token comment">//FlannBasedMatcher matcher(new flann::LshIndexParams(20, 10, 2));</span>
    <span class="token comment">//FlannBasedMatcher matcher;</span>
    BFMatcher matcher<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> matches<span class="token punctuation">;</span>
    matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>descriptor_obj<span class="token punctuation">,</span> descriptor_scene<span class="token punctuation">,</span> matches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// draw matches(key points)</span>
    Mat akazeMatchesImg<span class="token punctuation">;</span>
    
    <span class="token function">drawMatches</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> keypoints_obj<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> keypoints_scene<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> akazeMatchesImg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"akaze match result"</span><span class="token punctuation">,</span> akazeMatchesImg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> goodMatches<span class="token punctuation">;</span>
    <span class="token keyword">double</span> minDist <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">,</span> maxDist <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> descriptor_obj<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> dist <span class="token operator">=</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> minDist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            minDist <span class="token operator">=</span> dist<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&gt;</span> maxDist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            maxDist <span class="token operator">=</span> dist<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"min distance : %f"</span><span class="token punctuation">,</span> minDist<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> descriptor_obj<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> dist <span class="token operator">=</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
        <span class="token comment">//max(1.5 * minDist, 0.02)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> <span class="token number">1.3</span> <span class="token operator">*</span> minDist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            goodMatches<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"goodmatche size : "</span> <span class="token operator">&lt;&lt;</span> goodMatches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    Mat kazematchimg<span class="token punctuation">;</span>
    <span class="token function">drawMatches</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> keypoints_obj<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> keypoints_scene<span class="token punctuation">,</span> goodMatches<span class="token punctuation">,</span> kazematchimg<span class="token punctuation">,</span> <span class="token class-name">Scalar</span><span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Scalar</span><span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DrawMatchesFlags<span class="token operator">::</span>NOT_DRAW_SINGLE_POINTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"good match result"</span><span class="token punctuation">,</span> kazematchimg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/b8/3e/tHrI6BHE_o.png" alt="Alt"><br> <img src="https://images2.imgbox.com/94/5e/Vk8STDgK_o.png" alt="Alt"><br> <img src="https://images2.imgbox.com/a5/e3/p6Cc7bCm_o.png" alt="Alt"></p> 
<h4><a id="AKAZE_324"></a>AKAZEå±€éƒ¨åŒ¹é…ä»‹ç»</h4> 
<p>AOSæ„é€ å°ºåº¦ç©ºé—´<br> HessiançŸ©é˜µç‰¹å¾ç‚¹æ£€æµ‹<br> æ–¹å‘æŒ‡å®šåŸºäºä¸€é˜¶å¾®åˆ†å›¾åƒ<br> æè¿°å­ç”Ÿæˆ<br> AKAZEä¸KAZEçš„åŒºåˆ«å¸¦Kæ˜¯å¿«é€Ÿçš„<br> ä¸SIFT/SURFæ¯”è¾ƒ</p> 
<p>æ›´åŠ ç¨³å®š<br> éçº¿æ€§å°ºåº¦ç©ºé—´<br> AKAZEé€Ÿåº¦æ›´åŠ å¿«<br> æ¯”è¾ƒæ–°çš„ç®—æ³•ï¼Œåªæœ‰åœ¨opencvæ–°ç‰ˆæœ¬ä¸­æ‰æœ‰<br> KAZEæ˜¯æ—¥è¯­éŸ³è¯‘è¿‡æ¥çš„ ï¼Œ KAZEä¸SIFTã€SURFæœ€å¤§çš„åŒºåˆ«åœ¨äºæ„é€ å°ºåº¦ç©ºé—´ï¼ŒKAZEæ˜¯åˆ©ç”¨éçº¿æ€§æ–¹å¼æ„é€ ï¼Œå¾—åˆ°çš„å…³é”®ç‚¹ä¹Ÿå°±æ›´å‡†ç¡®ï¼ˆå°ºåº¦ä¸å˜æ€§ ï¼‰ï¼›</p> 
<h5><a id="_337"></a>ä»£ç æ¯”è¾ƒ</h5> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token comment">//#include &lt;opencv2/xfeatures2d.hpp&gt;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIC_PATH</span> <span class="token string">"C:/Users/wenhaofu/Desktop/picture/"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIC_NAME</span> <span class="token string">"tubiao3.png"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIC_PATH1</span> <span class="token string">"C:/Users/wenhaofu/Desktop/picture/"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIC_NAME1</span> <span class="token string">"tubiao1.png"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Mat subimg<span class="token punctuation">,</span> mainimg<span class="token punctuation">;</span>

    <span class="token comment">//è·å–å®Œæ•´çš„å›¾ç‰‡è·¯å¾„åŠåç§°</span>
    string pic1 <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>PIC_PATH<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>PIC_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    string pic2 <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>PIC_PATH1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>PIC_NAME1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//æ‰“å°å›¾ç‰‡è·¯å¾„</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"subimg  path is :"</span> <span class="token operator">&lt;&lt;</span> pic1 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"mainimg path is :"</span> <span class="token operator">&lt;&lt;</span> pic2 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">//è¯»å–å›¾ç‰‡</span>
    subimg <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>pic1<span class="token punctuation">,</span> IMREAD_GRAYSCALE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mainimg <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>pic2<span class="token punctuation">,</span> IMREAD_GRAYSCALE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//åˆ¤æ–­å›¾ç‰‡æ˜¯å¦å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subimg<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> mainimg<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"pic is not exist!!!!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//æ˜¾ç¤ºå›¾ç‰‡</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    <span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"subimg pic"</span><span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"subimg pic"</span><span class="token punctuation">,</span> subimg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"mainimg pic"</span><span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"mainimg pic"</span><span class="token punctuation">,</span> mainimg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    Mat kpimg<span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>AKAZE<span class="token operator">&gt;</span> detector <span class="token operator">=</span> <span class="token class-name">AKAZE</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keypoints_sub<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keypoints_main<span class="token punctuation">;</span>

    Mat descript_sub<span class="token punctuation">,</span> descript_main<span class="token punctuation">;</span>
    <span class="token keyword">double</span> t1 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    detector<span class="token operator">-&gt;</span><span class="token function">detectAndCompute</span><span class="token punctuation">(</span>subimg<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keypoints_sub<span class="token punctuation">,</span> descript_sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    detector<span class="token operator">-&gt;</span><span class="token function">detectAndCompute</span><span class="token punctuation">(</span>mainimg<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keypoints_main<span class="token punctuation">,</span> descript_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> t2 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> tkaze <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span> <span class="token operator">/</span> cv<span class="token operator">::</span><span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"AKAZE Time consume(ms): "</span> <span class="token operator">&lt;&lt;</span> tkaze <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token comment">//è¿™é‡Œä½¿ç”¨æš´åŠ›åŒ¹é…ä¸flannåŒ¹é…éƒ½å¯ä»¥ flannåŒ¹é…æ—¶æ³¨æ„è°ƒæ•´ä»¥ä¸‹å‚æ•°å¦åˆ™ä¼šæŠ¥é”™</span>
    <span class="token comment">//FlannBasedMatcher matcher(new flann::LshIndexParams(20,10,2));</span>
    BFMatcher matcher<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> matches<span class="token punctuation">;</span>
    matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>descript_sub<span class="token punctuation">,</span> descript_main<span class="token punctuation">,</span> matches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Mat akazeimg<span class="token punctuation">;</span>
    <span class="token function">drawMatches</span><span class="token punctuation">(</span>subimg<span class="token punctuation">,</span> keypoints_sub<span class="token punctuation">,</span> mainimg<span class="token punctuation">,</span> keypoints_main<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> akazeimg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"akazeimg display"</span><span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"akazeimg display"</span><span class="token punctuation">,</span> akazeimg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//åŒ¹é…ç‚¹è¿‡å¤š</span>


    <span class="token comment">//ä¼˜åŒ–åŒ¹é…ç‚¹ å¯»æ‰¾æœ€ä¼˜åŒ¹é…</span>
    <span class="token keyword">float</span> maxdist <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> mindist <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token comment">//é€šè¿‡é€æ­¥æ”¶æ•›çš„åŠæ³•æŸ¥æ‰¾åˆ°æœ€å¤§å€¼æœ€å°å€¼</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> descript_sub<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> distance <span class="token operator">=</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
        <span class="token comment">//cout &lt;&lt; "distance: " &lt;&lt; distance &lt;&lt; endl;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&gt;</span> maxdist<span class="token punctuation">)</span>
            maxdist <span class="token operator">=</span> distance<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&lt;</span> mindist<span class="token punctuation">)</span>
            mindist <span class="token operator">=</span> distance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//å°†æœ€å¤§å€¼ æœ€å°å€¼æ‰“å°å‡ºæ¥</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"maxdist: "</span> <span class="token operator">&lt;&lt;</span> maxdist <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"mindist: "</span> <span class="token operator">&lt;&lt;</span> mindist <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> goodmatches<span class="token punctuation">;</span>   <span class="token comment">//å®šä¹‰æœ€ä¼˜çš„è·ç¦»ç‚¹é›†åˆ</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> descript_sub<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> distance <span class="token operator">=</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&lt;=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1.5</span> <span class="token operator">*</span> mindist<span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//å°†æŸ¥æ‰¾åˆ°çš„æœ€å°è·ç¦»æ·»åŠ åˆ°goodmatchesä¸­</span>
            goodmatches<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"goodmatche size : "</span> <span class="token operator">&lt;&lt;</span> goodmatches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


    Mat goodmatchimages<span class="token punctuation">;</span>
    <span class="token comment">//ç»˜åˆ¶åŒ¹é…ç‚¹ ç‚¹æ•°å¤§å¤§å‡å°‘</span>
    <span class="token function">drawMatches</span><span class="token punctuation">(</span>subimg<span class="token punctuation">,</span> keypoints_sub<span class="token punctuation">,</span> mainimg<span class="token punctuation">,</span> keypoints_main<span class="token punctuation">,</span> goodmatches<span class="token punctuation">,</span> goodmatchimages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"goodmatchimages"</span><span class="token punctuation">,</span> goodmatchimages<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">destroyAllWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/79/5d/HelzVYS4_o.png" alt="Alt"><br> ä¸KAZEå¯¹æ¯”AKAZEé€Ÿåº¦ç¡®å®æå‡ï¼Œä½†æ˜¯ï¼ŒåŒ¹é…ç²¾åº¦è¿‡äºä¸¥è‹›ã€‚</p> 
<p>confidence å¯ä¿¡åº¦å¯ä»¥ç®€å•ç†è§£ä¸ºç›¸ä¼¼åº¦ï¼Œè¿™é‡Œé»˜è®¤çš„é˜ˆå€¼æ˜¯threshold=0.8 å¦‚æœåŒ¹é…çš„ç»“æœå¤§äºè¿™ä¸ª0.8å°±æŠŠæœ€ä½³åŒ¹é…çš„åæ ‡è¿”å›ï¼Œå¦åˆ™è®¤ä¸ºæ²¡æœ‰åŒ¹é…ä¸Šè¿”å›Noneï¼Œåœ¨å†™è„šæœ¬çš„æ—¶å€™å¯ä»¥ä¼ å…¥thresholdè¿™ä¸ªå‚æ•°æ¥æé«˜æˆ–é™ä½åŒ¹é…ç²¾åº¦ã€‚best_match å°±æ˜¯æœ€ä½³åŒ¹é…çš„åæ ‡ï¼Œé‡ç‚¹çœ‹ _get_template_result_matrixæ˜¯æ€æ ·å¾—åˆ°åŒ¹é…ç»“æœçš„ï¼š</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">_get_confidence_from_matrix</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_loc<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ ¹æ®ç»“æœçŸ©é˜µæ±‚å‡ºconfidence."""</span>
        <span class="token comment"># æ±‚å–å¯ä¿¡åº¦:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rgb<span class="token punctuation">:</span>
            <span class="token comment"># å¦‚æœæœ‰é¢œè‰²æ ¡éªŒ,å¯¹ç›®æ ‡åŒºåŸŸè¿›è¡ŒBGRä¸‰é€šé“æ ¡éªŒ:</span>
            img_crop <span class="token operator">=</span> self<span class="token punctuation">.</span>im_source<span class="token punctuation">[</span>max_loc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>max_loc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> h<span class="token punctuation">,</span> max_loc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span> max_loc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w<span class="token punctuation">]</span>
            confidence <span class="token operator">=</span> cal_rgb_confidence<span class="token punctuation">(</span>img_crop<span class="token punctuation">,</span> self<span class="token punctuation">.</span>im_search<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            confidence <span class="token operator">=</span> max_val

        <span class="token keyword">return</span> confidence
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">cal_rgb_confidence</span><span class="token punctuation">(</span>img_src_rgb<span class="token punctuation">,</span> img_sch_rgb<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åŒå¤§å°å½©å›¾è®¡ç®—ç›¸ä¼¼åº¦."""</span>
    <span class="token comment"># æ‰©å±•ç½®ä¿¡åº¦è®¡ç®—åŒºåŸŸ</span>
    img_sch_rgb <span class="token operator">=</span> cv2<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>img_sch_rgb<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>BORDER_REPLICATE<span class="token punctuation">)</span>
    <span class="token comment"># è½¬HSVå¼ºåŒ–é¢œè‰²çš„å½±å“</span>
    img_src_rgb <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img_src_rgb<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2HSV<span class="token punctuation">)</span>
    img_sch_rgb <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img_sch_rgb<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2HSV<span class="token punctuation">)</span>
    src_bgr<span class="token punctuation">,</span> sch_bgr <span class="token operator">=</span> cv2<span class="token punctuation">.</span>split<span class="token punctuation">(</span>img_src_rgb<span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>split<span class="token punctuation">(</span>img_sch_rgb<span class="token punctuation">)</span>

    <span class="token comment"># è®¡ç®—BGRä¸‰é€šé“çš„confidenceï¼Œå­˜å…¥bgr_confidence:</span>
    bgr_confidence <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        res_temp <span class="token operator">=</span> cv2<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>src_bgr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> sch_bgr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>TM_CCOEFF_NORMED<span class="token punctuation">)</span>
        min_val<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> min_loc<span class="token punctuation">,</span> max_loc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>res_temp<span class="token punctuation">)</span>
        bgr_confidence<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> max_val

    <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>bgr_confidence<span class="token punctuation">)</span>
</code></pre> 
<p>å¯ä»¥çœ‹å‡ºï¼Œç›´æ¥ç”¨çš„OpenCVçš„æ¨¡æ¿åŒ¹é…æ–¹æ³•ã€‚</p> 
<p>ç¬¬äºŒç§find_best_result()æ–¹æ³•ï¼š</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@print_run_time</span>
    <span class="token keyword">def</span> <span class="token function">find_best_result</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""åŸºäºkazeè¿›è¡Œå›¾åƒè¯†åˆ«ï¼Œåªç­›é€‰å‡ºæœ€ä¼˜åŒºåŸŸ."""</span>
        <span class="token comment"># ç¬¬ä¸€æ­¥ï¼šæ£€éªŒå›¾åƒæ˜¯å¦æ­£å¸¸ï¼š</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> check_image_valid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>im_source<span class="token punctuation">,</span> self<span class="token punctuation">.</span>im_search<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

        <span class="token comment"># ç¬¬äºŒæ­¥ï¼šè·å–ç‰¹å¾ç‚¹é›†å¹¶åŒ¹é…å‡ºç‰¹å¾ç‚¹å¯¹: è¿”å›å€¼ good, pypts, kp_sch, kp_src</span>
        self<span class="token punctuation">.</span>kp_sch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kp_src<span class="token punctuation">,</span> self<span class="token punctuation">.</span>good <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_key_points<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®åŒ¹é…ç‚¹å¯¹(good),æå–å‡ºæ¥è¯†åˆ«åŒºåŸŸ:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>good<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…ç‚¹å¯¹ä¸º0,æ— æ³•æå–è¯†åˆ«åŒºåŸŸ;ä¸º1åˆ™æ— æ³•è·å–ç›®æ ‡åŒºåŸŸ,ç›´æ¥è¿”å›Noneä½œä¸ºåŒ¹é…ç»“æœ:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>good<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…ç‚¹å¯¹ä¸º2æˆ–3,æ ¹æ®ç‚¹å¯¹æ±‚å‡ºç›®æ ‡åŒºåŸŸ,æ®æ­¤ç®—å‡ºå¯ä¿¡åº¦:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>good<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
                origin_result <span class="token operator">=</span> self<span class="token punctuation">.</span>_handle_two_good_points<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kp_sch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kp_src<span class="token punctuation">,</span> self<span class="token punctuation">.</span>good<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                origin_result <span class="token operator">=</span> self<span class="token punctuation">.</span>_handle_three_good_points<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kp_sch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kp_src<span class="token punctuation">,</span> self<span class="token punctuation">.</span>good<span class="token punctuation">)</span>
            <span class="token comment"># æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ç›´æ¥è¿”å›Noneä½œä¸ºåŒ¹é…ç»“æœ:</span>
            <span class="token keyword">if</span> origin_result <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> origin_result
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                middle_point<span class="token punctuation">,</span> pypts<span class="token punctuation">,</span> w_h_range <span class="token operator">=</span> origin_result
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…ç‚¹å¯¹ &gt;= 4ä¸ªï¼Œä½¿ç”¨å•çŸ©é˜µæ˜ å°„æ±‚å‡ºç›®æ ‡åŒºåŸŸï¼Œæ®æ­¤ç®—å‡ºå¯ä¿¡åº¦ï¼š</span>
            middle_point<span class="token punctuation">,</span> pypts<span class="token punctuation">,</span> w_h_range <span class="token operator">=</span> self<span class="token punctuation">.</span>_many_good_pts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kp_sch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kp_src<span class="token punctuation">,</span> self<span class="token punctuation">.</span>good<span class="token punctuation">)</span>

        <span class="token comment"># ç¬¬å››æ­¥ï¼šæ ¹æ®è¯†åˆ«åŒºåŸŸï¼Œæ±‚å‡ºç»“æœå¯ä¿¡åº¦ï¼Œå¹¶å°†ç»“æœè¿›è¡Œè¿”å›:</span>
        <span class="token comment"># å¯¹è¯†åˆ«ç»“æœè¿›è¡Œåˆç†æ€§æ ¡éªŒ: å°äº5ä¸ªåƒç´ çš„ï¼Œæˆ–è€…ç¼©æ”¾è¶…è¿‡5å€çš„ï¼Œä¸€å¾‹è§†ä¸ºä¸åˆæ³•ç›´æ¥raise.</span>
        self<span class="token punctuation">.</span>_target_error_check<span class="token punctuation">(</span>w_h_range<span class="token punctuation">)</span>
        <span class="token comment"># å°†æˆªå›¾å’Œè¯†åˆ«ç»“æœç¼©æ”¾åˆ°å¤§å°ä¸€è‡´,å‡†å¤‡è®¡ç®—å¯ä¿¡åº¦</span>
        x_min<span class="token punctuation">,</span> x_max<span class="token punctuation">,</span> y_min<span class="token punctuation">,</span> y_max<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> w_h_range
        target_img <span class="token operator">=</span> self<span class="token punctuation">.</span>im_source<span class="token punctuation">[</span>y_min<span class="token punctuation">:</span>y_max<span class="token punctuation">,</span> x_min<span class="token punctuation">:</span>x_max<span class="token punctuation">]</span>
        resize_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>target_img<span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> self<span class="token punctuation">.</span>_cal_confidence<span class="token punctuation">(</span>resize_img<span class="token punctuation">)</span>

        best_match <span class="token operator">=</span> generate_result<span class="token punctuation">(</span>middle_point<span class="token punctuation">,</span> pypts<span class="token punctuation">,</span> confidence<span class="token punctuation">)</span>
        LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"[%s] threshold=%s, result=%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>METHOD_NAME<span class="token punctuation">,</span> self<span class="token punctuation">.</span>threshold<span class="token punctuation">,</span> best_match<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> best_match <span class="token keyword">if</span> confidence <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>threshold <span class="token keyword">else</span> <span class="token boolean">None</span>
</code></pre> 
<p>æ¦‚æ‹¬æ¥è¯´find_best_result()ä¸»è¦åšäº†è¿™å‡ ä»¶äº‹æƒ…ï¼š</p> 
<p>1ã€æ£€éªŒå›¾ç‰‡æ˜¯å¦æ­£å¸¸ï¼›</p> 
<p>2ã€è·å–ç‰¹å¾ç‚¹é›†å¹¶åŒ¹é…å‡ºç‰¹å¾ç‚¹å¯¹ï¼›</p> 
<p>3ã€æ ¹æ®åŒ¹é…ç‚¹å¯¹(good),æå–å‡ºæ¥è¯†åˆ«åŒºåŸŸï¼›</p> 
<p>4ã€æ ¹æ®è¯†åˆ«åŒºåŸŸï¼Œæ±‚å‡ºç»“æœå¯ä¿¡åº¦ã€‚</p> 
<p>æ¥ä¸‹æ¥çœ‹å¦‚ä½•æ‰¾åˆ°ç‰¹å¾ç‚¹é›†ï¼š</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">_get_key_points</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ ¹æ®ä¼ å…¥å›¾åƒ,è®¡ç®—å›¾åƒæ‰€æœ‰çš„ç‰¹å¾ç‚¹,å¹¶å¾—åˆ°åŒ¹é…ç‰¹å¾ç‚¹å¯¹."""</span>
        <span class="token comment"># å‡†å¤‡å·¥ä½œ: åˆå§‹åŒ–ç®—å­</span>
        self<span class="token punctuation">.</span>init_detector<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># ç¬¬ä¸€æ­¥ï¼šè·å–ç‰¹å¾ç‚¹é›†ï¼Œå¹¶åŒ¹é…å‡ºç‰¹å¾ç‚¹å¯¹: è¿”å›å€¼ good, pypts, kp_sch, kp_src</span>
        kp_sch<span class="token punctuation">,</span> des_sch <span class="token operator">=</span> self<span class="token punctuation">.</span>get_keypoints_and_descriptors<span class="token punctuation">(</span>self<span class="token punctuation">.</span>im_search<span class="token punctuation">)</span>
        kp_src<span class="token punctuation">,</span> des_src <span class="token operator">=</span> self<span class="token punctuation">.</span>get_keypoints_and_descriptors<span class="token punctuation">(</span>self<span class="token punctuation">.</span>im_source<span class="token punctuation">)</span>
        <span class="token comment"># When apply knnmatch , make sure that number of features in both test and</span>
        <span class="token comment">#       query image is greater than or equal to number of nearest neighbors in knn match.</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>kp_sch<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>kp_src<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> NoMatchPointError<span class="token punctuation">(</span><span class="token string">"Not enough feature points in input images !"</span><span class="token punctuation">)</span>
        <span class="token comment"># match descriptors (ç‰¹å¾å€¼åŒ¹é…)</span>
        matches <span class="token operator">=</span> self<span class="token punctuation">.</span>match_keypoints<span class="token punctuation">(</span>des_sch<span class="token punctuation">,</span> des_src<span class="token punctuation">)</span>

        <span class="token comment"># goodä¸ºç‰¹å¾ç‚¹åˆé€‰ç»“æœï¼Œå‰”é™¤æ‰å‰ä¸¤ååŒ¹é…å¤ªæ¥è¿‘çš„ç‰¹å¾ç‚¹ï¼Œä¸æ˜¯ç‹¬ç‰¹ä¼˜ç§€çš„ç‰¹å¾ç‚¹ç›´æ¥ç­›é™¤(å¤šç›®æ ‡è¯†åˆ«æƒ…å†µç›´æ¥ä¸é€‚ç”¨)</span>
        good <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> m<span class="token punctuation">,</span> n <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
            <span class="token keyword">if</span> m<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>FILTER_RATIO <span class="token operator">*</span> n<span class="token punctuation">.</span>distance<span class="token punctuation">:</span>
                good<span class="token punctuation">.</span>append<span class="token punctuation">(</span>m<span class="token punctuation">)</span>
        <span class="token comment"># goodç‚¹éœ€è¦å»é™¤é‡å¤çš„éƒ¨åˆ†ï¼Œï¼ˆè®¾å®šæºå›¾åƒä¸èƒ½æœ‰é‡å¤ç‚¹ï¼‰å»é‡æ—¶å°†srcå›¾åƒä¸­çš„é‡å¤ç‚¹æ‰¾å‡ºå³å¯</span>
        <span class="token comment"># å»é‡ç­–ç•¥ï¼šå…è®¸æœç´¢å›¾åƒå¯¹æºå›¾åƒçš„ç‰¹å¾ç‚¹æ˜ å°„ä¸€å¯¹å¤šï¼Œä¸å…è®¸å¤šå¯¹ä¸€é‡å¤ï¼ˆå³ä¸èƒ½æºå›¾åƒä¸Šä¸€ä¸ªç‚¹å¯¹åº”æœç´¢å›¾åƒçš„å¤šä¸ªç‚¹ï¼‰</span>
        good_diff<span class="token punctuation">,</span> diff_good_point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> good<span class="token punctuation">:</span>
            diff_point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>kp_src<span class="token punctuation">[</span>m<span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>kp_src<span class="token punctuation">[</span>m<span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> diff_point <span class="token keyword">not</span> <span class="token keyword">in</span> diff_good_point<span class="token punctuation">:</span>
                good_diff<span class="token punctuation">.</span>append<span class="token punctuation">(</span>m<span class="token punctuation">)</span>
                diff_good_point<span class="token punctuation">.</span>append<span class="token punctuation">(</span>diff_point<span class="token punctuation">)</span>
        good <span class="token operator">=</span> good_diff

        <span class="token keyword">return</span> kp_sch<span class="token punctuation">,</span> kp_src<span class="token punctuation">,</span> good
</code></pre> 
<p>matches = self.matcher.knnMatch(des_sch, des_src, k=2)è¿™å°±æ˜¯åœ¨å¯¹å›¾åƒçš„ç‰¹å¾ç‚¹è¿›è¡ŒåŒ¹é…ï¼ŒknnMatch æ˜¯ç­›é€‰åŒ¹é…ç‚¹ã€‚è‡³äºè¿™ä¸ªåˆå§‹åŒ–ç®—å­æ˜¯ä»€ä¹ˆå¯¹è±¡ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–åˆ°å›¾åƒç‰¹å¾ç‚¹ï¼š</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">init_detector</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Init keypoint detector object."""</span>
        self<span class="token punctuation">.</span>detector <span class="token operator">=</span> cv2<span class="token punctuation">.</span>KAZE_create<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># create BFMatcher object:</span>
        self<span class="token punctuation">.</span>matcher <span class="token operator">=</span> cv2<span class="token punctuation">.</span>BFMatcher<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>NORM_L1<span class="token punctuation">)</span>  <span class="token comment"># cv2.NORM_L1 cv2.NORM_L2 cv2.NORM_HAMMIN</span>
</code></pre> 
<h4><a id="OpenCV_593"></a>æœ€ç»ˆç”¨åˆ°çš„å°±æ˜¯OpenCVçš„ä¸¤ä¸ªæ–¹æ³•ï¼šæ¨¡ç‰ˆåŒ¹é…å’Œç‰¹å¾åŒ¹é…</h4> 
<p>1.æ¨¡æ¿åŒ¹é…ï¼š</p> 
<pre><code class="prism language-python">cv2<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>i_gray<span class="token punctuation">,</span> s_gray<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>TM_CCOEFF_NORMED<span class="token punctuation">)</span>
</code></pre> 
<p>2.ç‰¹å¾åŒ¹é…ï¼š</p> 
<pre><code class="prism language-python">cv2<span class="token punctuation">.</span>FlannBasedMatcher<span class="token punctuation">(</span>index_params<span class="token punctuation">,</span>search_params<span class="token punctuation">)</span><span class="token punctuation">.</span>knnMatch<span class="token punctuation">(</span>des1<span class="token punctuation">,</span>des2<span class="token punctuation">,</span>k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>å“ªä¸ªä¼˜å…ˆåŒ¹é…ä¸Šäº†ï¼Œå°±ç›´æ¥è¿”å›ç»“æœï¼Œå¯ä»¥çœ‹åˆ°ç”¨çš„éƒ½æ˜¯OpenCVçš„å›¾åƒè¯†åˆ«ç®—æ³•ã€‚</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1788ede0013169fd6e1a251bf46ae955/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">cadence17.4åˆ¶ä½œé€šå­”ç„Šç›˜ï¼ˆå­”å¾„1mmï¼‰</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/867b8c99dfc0efa0bb7a8cf1380c4069/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">å›¾ç‰‡æ‚¬æµ®åˆ‡æ¢</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 èœé¸Ÿç¨‹åºå‘˜åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>