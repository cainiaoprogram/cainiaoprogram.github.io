<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Airtest源码解析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Airtest源码解析" />
<meta property="og:description" content="Airtest图像识别 Airtest介绍源码touch方法测试代码与结果：AKAZE局部匹配介绍代码比较 最终用到的就是OpenCV的两个方法：模版匹配和特征匹配 Airtest介绍 Airtest是一款网易出品的基于图像识别面向手游UI测试的工具，也支持原生Android App基于元素识别的UI自动化测试(现在支持Android、ios、Windows)。主要包含了三部分：Airtest IDE、Airtest（用截图写脚本）和 Poco（用界面UI元素来写脚本）。来自Google的评价：Airtest 是安卓游戏开发最强大、最全面的自动测试方案之一。
源码 Airtest
下载后，如果，只是代码阅读，可以不用部署环境。运行需要参照readme，有中文版很贴心 😃
touch方法 如图示所示，从touch图片开始，即为点击某个传入的图片，源码在api.py里面：
@logwrap def touch(v, times=1, **kwargs): &#34;&#34;&#34; Perform the touch action on the device screen :param v: target to touch, either a ``Template`` instance or absolute coordinates (x, y) :param times: how many touches to be performed :param kwargs: platform specific `kwargs`, please refer to corresponding docs :return: finial position to be clicked :platforms: Android, Windows, iOS :Example: Click absolute coordinates:: &gt;&gt;&gt; touch((100, 100)) Click the center of the picture(Template object):: &gt;&gt;&gt; touch(Template(r&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5019b2d6b4990fa27a6725f91fa12068/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-10T14:31:24+08:00" />
<meta property="article:modified_time" content="2021-06-10T14:31:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Airtest源码解析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Airtest图像识别</h4> 
 <ul><li><a href="#Airtest_2" rel="nofollow">Airtest介绍</a></li><li><ul><li><a href="#_6" rel="nofollow">源码</a></li><li><a href="#touch_10" rel="nofollow">touch方法</a></li><li><ul><li><a href="#_244" rel="nofollow">测试代码与结果：</a></li><li><a href="#AKAZE_324" rel="nofollow">AKAZE局部匹配介绍</a></li><li><ul><li><a href="#_337" rel="nofollow">代码比较</a></li></ul> 
    </li><li><a href="#OpenCV_593" rel="nofollow">最终用到的就是OpenCV的两个方法：模版匹配和特征匹配</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Airtest_2"></a>Airtest介绍</h2> 
<p>Airtest是一款网易出品的基于图像识别面向手游UI测试的工具，也支持原生Android App基于元素识别的UI自动化测试(现在支持Android、ios、Windows)。主要包含了三部分：Airtest IDE、Airtest（用截图写脚本）和 Poco（用界面UI元素来写脚本）。来自Google的评价：Airtest 是安卓游戏开发最强大、最全面的自动测试方案之一。</p> 
<h3><a id="_6"></a>源码</h3> 
<p><a href="https://github.com/AirtestProject/Airtest">Airtest</a><br> 下载后，如果，只是代码阅读，可以不用部署环境。运行需要参照readme，有中文版很贴心 😃</p> 
<h3><a id="touch_10"></a>touch方法</h3> 
<p>如图示所示，从touch图片开始，即为点击某个传入的图片，源码在api.py里面：<br> <img src="https://images2.imgbox.com/4b/3d/aaEnhWlZ_o.png" alt="Alt"></p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@logwrap</span>
<span class="token keyword">def</span> <span class="token function">touch</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> times<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Perform the touch action on the device screen

    :param v: target to touch, either a ``Template`` instance or absolute coordinates (x, y)
    :param times: how many touches to be performed
    :param kwargs: platform specific `kwargs`, please refer to corresponding docs
    :return: finial position to be clicked
    :platforms: Android, Windows, iOS
    :Example:
        Click absolute coordinates::

        &gt;&gt;&gt; touch((100, 100))

        Click the center of the picture(Template object)::

        &gt;&gt;&gt; touch(Template(r"tpl1606730579419.png", target_pos=5))

        Click 2 times::

        &gt;&gt;&gt; touch((100, 100), times=2)

        Under Android and Windows platforms, you can set the click duration::

        &gt;&gt;&gt; touch((100, 100), duration=2)

        Right click(Windows)::

        &gt;&gt;&gt; touch((100, 100), right_click=True)

    """</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> Template<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pos <span class="token operator">=</span> loop_find<span class="token punctuation">(</span>v<span class="token punctuation">,</span> timeout<span class="token operator">=</span>ST<span class="token punctuation">.</span>FIND_TIMEOUT<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        try_log_screen<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pos <span class="token operator">=</span> v
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>times<span class="token punctuation">)</span><span class="token punctuation">:</span>
        G<span class="token punctuation">.</span>DEVICE<span class="token punctuation">.</span>touch<span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span>
    delay_after_operation<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pos
</code></pre> 
<p>这个函数执行点击操作的是 G.DEVICE.touch(pos, **kwargs)，而pos就是图片匹配返回的坐标位置，重点看loop_find这个函数是怎样识别并返回坐标数据的：</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@logwrap</span>
<span class="token keyword">def</span> <span class="token function">loop_find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> timeout<span class="token operator">=</span>ST<span class="token punctuation">.</span>FIND_TIMEOUT<span class="token punctuation">,</span> threshold<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> interval<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> intervalfunc<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Search for image template in the screen until timeout

    Args:
        query: image template to be found in screenshot
        timeout: time interval how long to look for the image template
        threshold: default is None
        interval: sleep interval before next attempt to find the image template
        intervalfunc: function that is executed after unsuccessful attempt to find the image template

    Raises:
        TargetNotFoundError: when image template is not found in screenshot

    Returns:
        TargetNotFoundError if image template not found, otherwise returns the position where the image template has
        been found in screenshot

    """</span>
    G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Try finding: %s"</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        screen <span class="token operator">=</span> G<span class="token punctuation">.</span>DEVICE<span class="token punctuation">.</span>snapshot<span class="token punctuation">(</span>filename<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> quality<span class="token operator">=</span>ST<span class="token punctuation">.</span>SNAPSHOT_QUALITY<span class="token punctuation">)</span>

        <span class="token keyword">if</span> screen <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"Screen is None, may be locked"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> threshold<span class="token punctuation">:</span>
                query<span class="token punctuation">.</span>threshold <span class="token operator">=</span> threshold
            match_pos <span class="token operator">=</span> query<span class="token punctuation">.</span>match_in<span class="token punctuation">(</span>screen<span class="token punctuation">)</span>
            <span class="token keyword">if</span> match_pos<span class="token punctuation">:</span>
                try_log_screen<span class="token punctuation">(</span>screen<span class="token punctuation">)</span>
                <span class="token keyword">return</span> match_pos

        <span class="token keyword">if</span> intervalfunc <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            intervalfunc<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 超时则raise，未超时则进行下次循环:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">&gt;</span> timeout<span class="token punctuation">:</span>
            try_log_screen<span class="token punctuation">(</span>screen<span class="token punctuation">)</span>
            <span class="token keyword">raise</span> TargetNotFoundError<span class="token punctuation">(</span><span class="token string">'Picture %s not found in screen'</span> <span class="token operator">%</span> query<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
</code></pre> 
<p>解读下这个loop_find这个方法：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">loop_find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> timeout<span class="token operator">=</span>ST<span class="token punctuation">.</span>FIND_TIMEOUT<span class="token punctuation">,</span> threshold<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> interval

<span class="token triple-quoted-string string">"""
参数：

查询：截图中找到的图像模板

超时：查找图像模板的时间间隔

阈值：默认值为“无”

间隔：下次尝试查找图像模板之前的睡眠间隔

intervalfunc：在att失败后执行的函数
"""</span>
</code></pre> 
<p>1、首先会获取手机屏幕截图；</p> 
<p>2、然后对比脚本传入图片获取匹配上的位置；</p> 
<p>3、一直重复上面两步骤直到匹配上或者超时。</p> 
<p>跟脚本传入图片进行匹配的代码在这一行 match_pos = query.match_in(screen)</p> 
<p>在cv.py 里面找到 Template类的 match_in方法：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">match_in</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> screen<span class="token punctuation">)</span><span class="token punctuation">:</span>
        match_result <span class="token operator">=</span> self<span class="token punctuation">.</span>_cv_match<span class="token punctuation">(</span>screen<span class="token punctuation">)</span>
        G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"match result: %s"</span><span class="token punctuation">,</span> match_result<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> match_result<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        focus_pos <span class="token operator">=</span> TargetPos<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getXY<span class="token punctuation">(</span>match_result<span class="token punctuation">,</span> self<span class="token punctuation">.</span>target_pos<span class="token punctuation">)</span>
        <span class="token keyword">return</span> focus_pos
</code></pre> 
<p>解读下 match_in方法：</p> 
<p>1、调用自己的_cv_math方法，找到匹配到的坐标结果；</p> 
<p>2、根据图片坐标返回点击坐标，默认点击图片中心位置。</p> 
<p>接下来看 self._cv_match(screen) 也在cv.py 里面：</p> 
<pre><code class="prism language-python"> <span class="token decorator annotation punctuation">@logwrap</span>
    <span class="token keyword">def</span> <span class="token function">_cv_match</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> screen<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># in case image file not exist in current directory:</span>
        image <span class="token operator">=</span> self<span class="token punctuation">.</span>_imread<span class="token punctuation">(</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> self<span class="token punctuation">.</span>_resize_image<span class="token punctuation">(</span>image<span class="token punctuation">,</span> screen<span class="token punctuation">,</span> ST<span class="token punctuation">.</span>RESIZE_METHOD<span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">for</span> method <span class="token keyword">in</span> ST<span class="token punctuation">.</span>CVSTRATEGY<span class="token punctuation">:</span>
            <span class="token comment"># get function definition and execute:</span>
            func <span class="token operator">=</span> MATCHING_METHODS<span class="token punctuation">.</span>get<span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> func <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> InvalidMatchingMethodError<span class="token punctuation">(</span><span class="token string">"Undefined method in CVSTRATEGY: '%s', try 'kaze'/'brisk'/'akaze'/'orb'/'surf'/'sift'/'brief' instead."</span> <span class="token operator">%</span> method<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                ret <span class="token operator">=</span> self<span class="token punctuation">.</span>_try_match<span class="token punctuation">(</span>func<span class="token punctuation">,</span> image<span class="token punctuation">,</span> screen<span class="token punctuation">,</span> threshold<span class="token operator">=</span>self<span class="token punctuation">.</span>threshold<span class="token punctuation">,</span> rgb<span class="token operator">=</span>self<span class="token punctuation">.</span>rgb<span class="token punctuation">)</span>
            <span class="token keyword">if</span> ret<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        <span class="token keyword">return</span> ret
</code></pre> 
<p>解读下_cv_match代码：</p> 
<p>1、将用例传入的截图进行缩放（写用例设备与运行用例设备可能不一致）；</p> 
<p>2、遍历配置项里面的方法，进行匹配。匹配方法是_try_match()</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">_try_match</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"try match with %s"</span> <span class="token operator">%</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            ret <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">.</span>find_best_result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> aircv<span class="token punctuation">.</span>NoModuleError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
            G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"'surf'/'sift'/'brief' is in opencv-contrib module. You can use 'tpl'/'kaze'/'brisk'/'akaze'/'orb' in CVSTRATEGY, or reinstall opencv with the contrib module."</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">except</span> aircv<span class="token punctuation">.</span>BaseError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
            G<span class="token punctuation">.</span>LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> ret
</code></pre> 
<p>通过，find_best_result()方法得到结果：</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@print_run_time</span>
    <span class="token keyword">def</span> <span class="token function">find_best_result</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""基于kaze进行图像识别，只筛选出最优区域."""</span>
        <span class="token triple-quoted-string string">"""函数功能：找到最优结果."""</span>
        <span class="token comment"># 第一步：校验图像输入</span>
        check_source_larger_than_search<span class="token punctuation">(</span>self<span class="token punctuation">.</span>im_source<span class="token punctuation">,</span> self<span class="token punctuation">.</span>im_search<span class="token punctuation">)</span>
        <span class="token comment"># 第二步：计算模板匹配的结果矩阵res</span>
        res <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_template_result_matrix<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 第三步：依次获取匹配结果</span>
        min_val<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> min_loc<span class="token punctuation">,</span> max_loc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        h<span class="token punctuation">,</span> w <span class="token operator">=</span> self<span class="token punctuation">.</span>im_search<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token comment"># 求取可信度:</span>
        confidence <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_confidence_from_matrix<span class="token punctuation">(</span>max_loc<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
        <span class="token comment"># 求取识别位置: 目标中心 + 目标区域:</span>
        middle_point<span class="token punctuation">,</span> rectangle <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_target_rectangle<span class="token punctuation">(</span>max_loc<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
        best_match <span class="token operator">=</span> generate_result<span class="token punctuation">(</span>middle_point<span class="token punctuation">,</span> rectangle<span class="token punctuation">,</span> confidence<span class="token punctuation">)</span>
        LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"[%s] threshold=%s, result=%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>METHOD_NAME<span class="token punctuation">,</span> self<span class="token punctuation">.</span>threshold<span class="token punctuation">,</span> best_match<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> best_match <span class="token keyword">if</span> confidence <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>threshold <span class="token keyword">else</span> <span class="token boolean">None</span>
</code></pre> 
<p>概括来说find_best_result 主要做了这几件事情：</p> 
<p>1、校验图像输入；</p> 
<p>2、计算模板匹配的结果矩阵res；</p> 
<p>3、依次获取匹配结果；</p> 
<p>4、求取可信度；</p> 
<p>5、求取识别位置。<br> 基于kaze进行图像识别，只筛选出最优区域.<br> KAZE是发表在ECCV2012的一种特征点检测算法，相比于SIFT和SURF，KAZE建立的高斯金字塔是非线性的尺度空间，采用加性算子分裂算法(Additive Operator Splitting, AOS)来进行非线性扩散滤波。一个很显著的特点是在模糊图像的同时还能保留边缘细节。<br> KAZE论文中给出了若干实验图表数据，与SURF、SIFT和STAR相比，KAZE有更好的尺度和旋转不变性，并且稳定、可重复检测。主要的实验包括：</p> 
<blockquote> 
 <p>（1）重复检测试验<br> 这里主要从旋转缩放、视角变换、噪声干扰、模糊图像、压缩图像等方面进行了测试，可以看出KAZE的可重复性明显优于其它特征。<br> <img src="https://images2.imgbox.com/14/1d/pREGsQ6f_o.png" alt="Alt"><br> （2）特征检测与匹配试验<br> 这里也是从旋转缩放、视角变换、噪声干扰、模糊图像、压缩图像等方面进行了测试，给出了特征匹配的Precision-Recall图。使用的匹配算法是最近邻匹配。这里可以看出，在图像模糊、噪声干扰和压缩重构等造成的信息丢失的情况下，KAZE特征的鲁棒性明显优于其它特征。<br> <img src="https://images2.imgbox.com/d3/ce/rf22G3H6_o.png" alt="Alt"><br> （3）表面形变目标的特征匹配<br> 这里可以看出基于g2传导函数的KAZE特征性能最好。<br> <img src="https://images2.imgbox.com/7b/29/FPrIwQ97_o.png" alt="Alt"><br> （4） 检测效率测试<br> 这里可以看出KAZE的特征检测时间高于SURF和STAR，但与SIFT相近。这里比较花时间的是非线性尺度空间的构建。<br> <img src="https://images2.imgbox.com/a9/69/URXdGPyJ_o.png" alt="Alt"></p> 
</blockquote> 
<h4><a id="_244"></a>测试代码与结果：</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>


<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Mat img1 <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"C:/Users/wenhaofu/Desktop/picture/gril1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat img2 <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"C:/Users/wenhaofu/Desktop/picture/gril2.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>img1<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> img2<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"could not load images...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"box image"</span><span class="token punctuation">,</span> img1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"scene image"</span><span class="token punctuation">,</span> img2<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// extract kaze features</span>
    Ptr<span class="token operator">&lt;</span>KAZE<span class="token operator">&gt;</span> detector <span class="token operator">=</span> <span class="token class-name">KAZE</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keypoints_obj<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keypoints_scene<span class="token punctuation">;</span>
    Mat descriptor_obj<span class="token punctuation">,</span> descriptor_scene<span class="token punctuation">;</span>
    <span class="token keyword">double</span> t1 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    detector<span class="token operator">-&gt;</span><span class="token function">detectAndCompute</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keypoints_obj<span class="token punctuation">,</span> descriptor_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    detector<span class="token operator">-&gt;</span><span class="token function">detectAndCompute</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keypoints_scene<span class="token punctuation">,</span> descriptor_scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> t2 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> tkaze <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span> <span class="token operator">/</span> cv<span class="token operator">::</span><span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">" KAZE Time consume(ms): "</span> <span class="token operator">&lt;&lt;</span> tkaze <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">// matching</span>
    <span class="token comment">//FlannBasedMatcher matcher(new flann::LshIndexParams(20, 10, 2));</span>
    <span class="token comment">//FlannBasedMatcher matcher;</span>
    BFMatcher matcher<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> matches<span class="token punctuation">;</span>
    matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>descriptor_obj<span class="token punctuation">,</span> descriptor_scene<span class="token punctuation">,</span> matches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// draw matches(key points)</span>
    Mat akazeMatchesImg<span class="token punctuation">;</span>
    
    <span class="token function">drawMatches</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> keypoints_obj<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> keypoints_scene<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> akazeMatchesImg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"akaze match result"</span><span class="token punctuation">,</span> akazeMatchesImg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> goodMatches<span class="token punctuation">;</span>
    <span class="token keyword">double</span> minDist <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">,</span> maxDist <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> descriptor_obj<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> dist <span class="token operator">=</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> minDist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            minDist <span class="token operator">=</span> dist<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&gt;</span> maxDist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            maxDist <span class="token operator">=</span> dist<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"min distance : %f"</span><span class="token punctuation">,</span> minDist<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> descriptor_obj<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> dist <span class="token operator">=</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
        <span class="token comment">//max(1.5 * minDist, 0.02)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> <span class="token number">1.3</span> <span class="token operator">*</span> minDist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            goodMatches<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"goodmatche size : "</span> <span class="token operator">&lt;&lt;</span> goodMatches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    Mat kazematchimg<span class="token punctuation">;</span>
    <span class="token function">drawMatches</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> keypoints_obj<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> keypoints_scene<span class="token punctuation">,</span> goodMatches<span class="token punctuation">,</span> kazematchimg<span class="token punctuation">,</span> <span class="token class-name">Scalar</span><span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Scalar</span><span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DrawMatchesFlags<span class="token operator">::</span>NOT_DRAW_SINGLE_POINTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"good match result"</span><span class="token punctuation">,</span> kazematchimg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/b8/3e/tHrI6BHE_o.png" alt="Alt"><br> <img src="https://images2.imgbox.com/94/5e/Vk8STDgK_o.png" alt="Alt"><br> <img src="https://images2.imgbox.com/a5/e3/p6Cc7bCm_o.png" alt="Alt"></p> 
<h4><a id="AKAZE_324"></a>AKAZE局部匹配介绍</h4> 
<p>AOS构造尺度空间<br> Hessian矩阵特征点检测<br> 方向指定基于一阶微分图像<br> 描述子生成<br> AKAZE与KAZE的区别带K是快速的<br> 与SIFT/SURF比较</p> 
<p>更加稳定<br> 非线性尺度空间<br> AKAZE速度更加快<br> 比较新的算法，只有在opencv新版本中才有<br> KAZE是日语音译过来的 ， KAZE与SIFT、SURF最大的区别在于构造尺度空间，KAZE是利用非线性方式构造，得到的关键点也就更准确（尺度不变性 ）；</p> 
<h5><a id="_337"></a>代码比较</h5> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token comment">//#include &lt;opencv2/xfeatures2d.hpp&gt;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIC_PATH</span> <span class="token string">"C:/Users/wenhaofu/Desktop/picture/"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIC_NAME</span> <span class="token string">"tubiao3.png"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIC_PATH1</span> <span class="token string">"C:/Users/wenhaofu/Desktop/picture/"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIC_NAME1</span> <span class="token string">"tubiao1.png"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Mat subimg<span class="token punctuation">,</span> mainimg<span class="token punctuation">;</span>

    <span class="token comment">//获取完整的图片路径及名称</span>
    string pic1 <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>PIC_PATH<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>PIC_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    string pic2 <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>PIC_PATH1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>PIC_NAME1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//打印图片路径</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"subimg  path is :"</span> <span class="token operator">&lt;&lt;</span> pic1 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"mainimg path is :"</span> <span class="token operator">&lt;&lt;</span> pic2 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">//读取图片</span>
    subimg <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>pic1<span class="token punctuation">,</span> IMREAD_GRAYSCALE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mainimg <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>pic2<span class="token punctuation">,</span> IMREAD_GRAYSCALE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断图片是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subimg<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> mainimg<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"pic is not exist!!!!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//显示图片</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    <span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"subimg pic"</span><span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"subimg pic"</span><span class="token punctuation">,</span> subimg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"mainimg pic"</span><span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"mainimg pic"</span><span class="token punctuation">,</span> mainimg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    Mat kpimg<span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>AKAZE<span class="token operator">&gt;</span> detector <span class="token operator">=</span> <span class="token class-name">AKAZE</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keypoints_sub<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keypoints_main<span class="token punctuation">;</span>

    Mat descript_sub<span class="token punctuation">,</span> descript_main<span class="token punctuation">;</span>
    <span class="token keyword">double</span> t1 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    detector<span class="token operator">-&gt;</span><span class="token function">detectAndCompute</span><span class="token punctuation">(</span>subimg<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keypoints_sub<span class="token punctuation">,</span> descript_sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    detector<span class="token operator">-&gt;</span><span class="token function">detectAndCompute</span><span class="token punctuation">(</span>mainimg<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keypoints_main<span class="token punctuation">,</span> descript_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> t2 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> tkaze <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span> <span class="token operator">/</span> cv<span class="token operator">::</span><span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"AKAZE Time consume(ms): "</span> <span class="token operator">&lt;&lt;</span> tkaze <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token comment">//这里使用暴力匹配与flann匹配都可以 flann匹配时注意调整以下参数否则会报错</span>
    <span class="token comment">//FlannBasedMatcher matcher(new flann::LshIndexParams(20,10,2));</span>
    BFMatcher matcher<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> matches<span class="token punctuation">;</span>
    matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>descript_sub<span class="token punctuation">,</span> descript_main<span class="token punctuation">,</span> matches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Mat akazeimg<span class="token punctuation">;</span>
    <span class="token function">drawMatches</span><span class="token punctuation">(</span>subimg<span class="token punctuation">,</span> keypoints_sub<span class="token punctuation">,</span> mainimg<span class="token punctuation">,</span> keypoints_main<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> akazeimg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"akazeimg display"</span><span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"akazeimg display"</span><span class="token punctuation">,</span> akazeimg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//匹配点过多</span>


    <span class="token comment">//优化匹配点 寻找最优匹配</span>
    <span class="token keyword">float</span> maxdist <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> mindist <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token comment">//通过逐步收敛的办法查找到最大值最小值</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> descript_sub<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> distance <span class="token operator">=</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
        <span class="token comment">//cout &lt;&lt; "distance: " &lt;&lt; distance &lt;&lt; endl;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&gt;</span> maxdist<span class="token punctuation">)</span>
            maxdist <span class="token operator">=</span> distance<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&lt;</span> mindist<span class="token punctuation">)</span>
            mindist <span class="token operator">=</span> distance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//将最大值 最小值打印出来</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"maxdist: "</span> <span class="token operator">&lt;&lt;</span> maxdist <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"mindist: "</span> <span class="token operator">&lt;&lt;</span> mindist <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> goodmatches<span class="token punctuation">;</span>   <span class="token comment">//定义最优的距离点集合</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> descript_sub<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> distance <span class="token operator">=</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&lt;=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1.5</span> <span class="token operator">*</span> mindist<span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//将查找到的最小距离添加到goodmatches中</span>
            goodmatches<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"goodmatche size : "</span> <span class="token operator">&lt;&lt;</span> goodmatches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


    Mat goodmatchimages<span class="token punctuation">;</span>
    <span class="token comment">//绘制匹配点 点数大大减少</span>
    <span class="token function">drawMatches</span><span class="token punctuation">(</span>subimg<span class="token punctuation">,</span> keypoints_sub<span class="token punctuation">,</span> mainimg<span class="token punctuation">,</span> keypoints_main<span class="token punctuation">,</span> goodmatches<span class="token punctuation">,</span> goodmatchimages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"goodmatchimages"</span><span class="token punctuation">,</span> goodmatchimages<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">destroyAllWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/79/5d/HelzVYS4_o.png" alt="Alt"><br> 与KAZE对比AKAZE速度确实提升，但是，匹配精度过于严苛。</p> 
<p>confidence 可信度可以简单理解为相似度，这里默认的阈值是threshold=0.8 如果匹配的结果大于这个0.8就把最佳匹配的坐标返回，否则认为没有匹配上返回None，在写脚本的时候可以传入threshold这个参数来提高或降低匹配精度。best_match 就是最佳匹配的坐标，重点看 _get_template_result_matrix是怎样得到匹配结果的：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">_get_confidence_from_matrix</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_loc<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""根据结果矩阵求出confidence."""</span>
        <span class="token comment"># 求取可信度:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rgb<span class="token punctuation">:</span>
            <span class="token comment"># 如果有颜色校验,对目标区域进行BGR三通道校验:</span>
            img_crop <span class="token operator">=</span> self<span class="token punctuation">.</span>im_source<span class="token punctuation">[</span>max_loc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>max_loc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> h<span class="token punctuation">,</span> max_loc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span> max_loc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w<span class="token punctuation">]</span>
            confidence <span class="token operator">=</span> cal_rgb_confidence<span class="token punctuation">(</span>img_crop<span class="token punctuation">,</span> self<span class="token punctuation">.</span>im_search<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            confidence <span class="token operator">=</span> max_val

        <span class="token keyword">return</span> confidence
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">cal_rgb_confidence</span><span class="token punctuation">(</span>img_src_rgb<span class="token punctuation">,</span> img_sch_rgb<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""同大小彩图计算相似度."""</span>
    <span class="token comment"># 扩展置信度计算区域</span>
    img_sch_rgb <span class="token operator">=</span> cv2<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>img_sch_rgb<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>BORDER_REPLICATE<span class="token punctuation">)</span>
    <span class="token comment"># 转HSV强化颜色的影响</span>
    img_src_rgb <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img_src_rgb<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2HSV<span class="token punctuation">)</span>
    img_sch_rgb <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img_sch_rgb<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2HSV<span class="token punctuation">)</span>
    src_bgr<span class="token punctuation">,</span> sch_bgr <span class="token operator">=</span> cv2<span class="token punctuation">.</span>split<span class="token punctuation">(</span>img_src_rgb<span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>split<span class="token punctuation">(</span>img_sch_rgb<span class="token punctuation">)</span>

    <span class="token comment"># 计算BGR三通道的confidence，存入bgr_confidence:</span>
    bgr_confidence <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        res_temp <span class="token operator">=</span> cv2<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>src_bgr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> sch_bgr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>TM_CCOEFF_NORMED<span class="token punctuation">)</span>
        min_val<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> min_loc<span class="token punctuation">,</span> max_loc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>res_temp<span class="token punctuation">)</span>
        bgr_confidence<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> max_val

    <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>bgr_confidence<span class="token punctuation">)</span>
</code></pre> 
<p>可以看出，直接用的OpenCV的模板匹配方法。</p> 
<p>第二种find_best_result()方法：</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@print_run_time</span>
    <span class="token keyword">def</span> <span class="token function">find_best_result</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""基于kaze进行图像识别，只筛选出最优区域."""</span>
        <span class="token comment"># 第一步：检验图像是否正常：</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> check_image_valid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>im_source<span class="token punctuation">,</span> self<span class="token punctuation">.</span>im_search<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

        <span class="token comment"># 第二步：获取特征点集并匹配出特征点对: 返回值 good, pypts, kp_sch, kp_src</span>
        self<span class="token punctuation">.</span>kp_sch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kp_src<span class="token punctuation">,</span> self<span class="token punctuation">.</span>good <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_key_points<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 第三步：根据匹配点对(good),提取出来识别区域:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>good<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># 匹配点对为0,无法提取识别区域;为1则无法获取目标区域,直接返回None作为匹配结果:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>good<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># 匹配点对为2或3,根据点对求出目标区域,据此算出可信度:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>good<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
                origin_result <span class="token operator">=</span> self<span class="token punctuation">.</span>_handle_two_good_points<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kp_sch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kp_src<span class="token punctuation">,</span> self<span class="token punctuation">.</span>good<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                origin_result <span class="token operator">=</span> self<span class="token punctuation">.</span>_handle_three_good_points<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kp_sch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kp_src<span class="token punctuation">,</span> self<span class="token punctuation">.</span>good<span class="token punctuation">)</span>
            <span class="token comment"># 某些特殊情况下直接返回None作为匹配结果:</span>
            <span class="token keyword">if</span> origin_result <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> origin_result
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                middle_point<span class="token punctuation">,</span> pypts<span class="token punctuation">,</span> w_h_range <span class="token operator">=</span> origin_result
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 匹配点对 &gt;= 4个，使用单矩阵映射求出目标区域，据此算出可信度：</span>
            middle_point<span class="token punctuation">,</span> pypts<span class="token punctuation">,</span> w_h_range <span class="token operator">=</span> self<span class="token punctuation">.</span>_many_good_pts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kp_sch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kp_src<span class="token punctuation">,</span> self<span class="token punctuation">.</span>good<span class="token punctuation">)</span>

        <span class="token comment"># 第四步：根据识别区域，求出结果可信度，并将结果进行返回:</span>
        <span class="token comment"># 对识别结果进行合理性校验: 小于5个像素的，或者缩放超过5倍的，一律视为不合法直接raise.</span>
        self<span class="token punctuation">.</span>_target_error_check<span class="token punctuation">(</span>w_h_range<span class="token punctuation">)</span>
        <span class="token comment"># 将截图和识别结果缩放到大小一致,准备计算可信度</span>
        x_min<span class="token punctuation">,</span> x_max<span class="token punctuation">,</span> y_min<span class="token punctuation">,</span> y_max<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> w_h_range
        target_img <span class="token operator">=</span> self<span class="token punctuation">.</span>im_source<span class="token punctuation">[</span>y_min<span class="token punctuation">:</span>y_max<span class="token punctuation">,</span> x_min<span class="token punctuation">:</span>x_max<span class="token punctuation">]</span>
        resize_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>target_img<span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> self<span class="token punctuation">.</span>_cal_confidence<span class="token punctuation">(</span>resize_img<span class="token punctuation">)</span>

        best_match <span class="token operator">=</span> generate_result<span class="token punctuation">(</span>middle_point<span class="token punctuation">,</span> pypts<span class="token punctuation">,</span> confidence<span class="token punctuation">)</span>
        LOGGING<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"[%s] threshold=%s, result=%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>METHOD_NAME<span class="token punctuation">,</span> self<span class="token punctuation">.</span>threshold<span class="token punctuation">,</span> best_match<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> best_match <span class="token keyword">if</span> confidence <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>threshold <span class="token keyword">else</span> <span class="token boolean">None</span>
</code></pre> 
<p>概括来说find_best_result()主要做了这几件事情：</p> 
<p>1、检验图片是否正常；</p> 
<p>2、获取特征点集并匹配出特征点对；</p> 
<p>3、根据匹配点对(good),提取出来识别区域；</p> 
<p>4、根据识别区域，求出结果可信度。</p> 
<p>接下来看如何找到特征点集：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">_get_key_points</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""根据传入图像,计算图像所有的特征点,并得到匹配特征点对."""</span>
        <span class="token comment"># 准备工作: 初始化算子</span>
        self<span class="token punctuation">.</span>init_detector<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 第一步：获取特征点集，并匹配出特征点对: 返回值 good, pypts, kp_sch, kp_src</span>
        kp_sch<span class="token punctuation">,</span> des_sch <span class="token operator">=</span> self<span class="token punctuation">.</span>get_keypoints_and_descriptors<span class="token punctuation">(</span>self<span class="token punctuation">.</span>im_search<span class="token punctuation">)</span>
        kp_src<span class="token punctuation">,</span> des_src <span class="token operator">=</span> self<span class="token punctuation">.</span>get_keypoints_and_descriptors<span class="token punctuation">(</span>self<span class="token punctuation">.</span>im_source<span class="token punctuation">)</span>
        <span class="token comment"># When apply knnmatch , make sure that number of features in both test and</span>
        <span class="token comment">#       query image is greater than or equal to number of nearest neighbors in knn match.</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>kp_sch<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>kp_src<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> NoMatchPointError<span class="token punctuation">(</span><span class="token string">"Not enough feature points in input images !"</span><span class="token punctuation">)</span>
        <span class="token comment"># match descriptors (特征值匹配)</span>
        matches <span class="token operator">=</span> self<span class="token punctuation">.</span>match_keypoints<span class="token punctuation">(</span>des_sch<span class="token punctuation">,</span> des_src<span class="token punctuation">)</span>

        <span class="token comment"># good为特征点初选结果，剔除掉前两名匹配太接近的特征点，不是独特优秀的特征点直接筛除(多目标识别情况直接不适用)</span>
        good <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> m<span class="token punctuation">,</span> n <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
            <span class="token keyword">if</span> m<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>FILTER_RATIO <span class="token operator">*</span> n<span class="token punctuation">.</span>distance<span class="token punctuation">:</span>
                good<span class="token punctuation">.</span>append<span class="token punctuation">(</span>m<span class="token punctuation">)</span>
        <span class="token comment"># good点需要去除重复的部分，（设定源图像不能有重复点）去重时将src图像中的重复点找出即可</span>
        <span class="token comment"># 去重策略：允许搜索图像对源图像的特征点映射一对多，不允许多对一重复（即不能源图像上一个点对应搜索图像的多个点）</span>
        good_diff<span class="token punctuation">,</span> diff_good_point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> good<span class="token punctuation">:</span>
            diff_point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>kp_src<span class="token punctuation">[</span>m<span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>kp_src<span class="token punctuation">[</span>m<span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> diff_point <span class="token keyword">not</span> <span class="token keyword">in</span> diff_good_point<span class="token punctuation">:</span>
                good_diff<span class="token punctuation">.</span>append<span class="token punctuation">(</span>m<span class="token punctuation">)</span>
                diff_good_point<span class="token punctuation">.</span>append<span class="token punctuation">(</span>diff_point<span class="token punctuation">)</span>
        good <span class="token operator">=</span> good_diff

        <span class="token keyword">return</span> kp_sch<span class="token punctuation">,</span> kp_src<span class="token punctuation">,</span> good
</code></pre> 
<p>matches = self.matcher.knnMatch(des_sch, des_src, k=2)这就是在对图像的特征点进行匹配，knnMatch 是筛选匹配点。至于这个初始化算子是什么对象，就是通过这个对象获取到图像特征点：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">init_detector</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Init keypoint detector object."""</span>
        self<span class="token punctuation">.</span>detector <span class="token operator">=</span> cv2<span class="token punctuation">.</span>KAZE_create<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># create BFMatcher object:</span>
        self<span class="token punctuation">.</span>matcher <span class="token operator">=</span> cv2<span class="token punctuation">.</span>BFMatcher<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>NORM_L1<span class="token punctuation">)</span>  <span class="token comment"># cv2.NORM_L1 cv2.NORM_L2 cv2.NORM_HAMMIN</span>
</code></pre> 
<h4><a id="OpenCV_593"></a>最终用到的就是OpenCV的两个方法：模版匹配和特征匹配</h4> 
<p>1.模板匹配：</p> 
<pre><code class="prism language-python">cv2<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>i_gray<span class="token punctuation">,</span> s_gray<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>TM_CCOEFF_NORMED<span class="token punctuation">)</span>
</code></pre> 
<p>2.特征匹配：</p> 
<pre><code class="prism language-python">cv2<span class="token punctuation">.</span>FlannBasedMatcher<span class="token punctuation">(</span>index_params<span class="token punctuation">,</span>search_params<span class="token punctuation">)</span><span class="token punctuation">.</span>knnMatch<span class="token punctuation">(</span>des1<span class="token punctuation">,</span>des2<span class="token punctuation">,</span>k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>哪个优先匹配上了，就直接返回结果，可以看到用的都是OpenCV的图像识别算法。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1788ede0013169fd6e1a251bf46ae955/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">cadence17.4制作通孔焊盘（孔径1mm）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/867b8c99dfc0efa0bb7a8cf1380c4069/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">图片悬浮切换</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>