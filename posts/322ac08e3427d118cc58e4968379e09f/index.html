<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【docker】部署minio对象存储并用rclone同步 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【docker】部署minio对象存储并用rclone同步" />
<meta property="og:description" content="docker部署minio对象存储并用rclone同步
本文首发于 ❄️慕雪的寒舍
1.什么是minio？ minio是一个开源的对象存储服务器，兼容S3协议。
官网：https://min.io/
官方在开源的基础上也提供云端S3服务，分为个人和企业，有不同的收费标准。
1.1 自建对象存储的好处？ 当然，本文写下来肯定不是让你去买它的对象存储服务的，而是在我们自己的服务器/Nas上部署一个minio的docker，来拥有一个我们自己的对象存储服务器！
对象存储服务器可以用来做图床、静态资源缓存，亦或者是直接当作一个网盘来使用。
自建的对象存储的好处是所有源文件我们都能亲手管理，且无需为付费的对象存储的奇怪的计价文档感到手足无措，也不需要担心有人恶意刷流把你一套房子给套走。
缺点就是，自建的稳定性肯定不如已有厂家提供的服务，且自购的服务器/Nas上传带宽一般都很低，文件一多，访问速度就很慢了。
对于我个人而言，自建minio的唯一作用，就是备份七牛云/阿里云对象存储中的文件。考虑到2023下半年，各大厂接连boom云服务，国外的谷歌还出现了云盘里面用户的数据回滚到几月前的恶性问题，这可是可能导致用户数据丢失的大问题啊！
谷歌公布方案，修复 Drive 云盘文件丢失问题谷歌承认云端硬盘Google Drive存在BUG，3月内用户文件可能丢失 所以，将数据在自己本地留一份总是安心一些。数据安全靠的是备份，不是云服务厂家给你提供的99.99999%可用性的一面之词。
如果你对数据备份这个话题感兴趣，可以看看我的另外一篇博客：谈谈如何进行有效数据备份，3&#43;2&#43;1
温馨提醒：如果你想在云服务器上安装minio来备份已有S3中的文件的话，最好是使用一个和已有S3不在同一个地域、非同一个服务商的云服务器，避免某些服务商云服务器和对象存储一起boom的情况……
2.docker安装minio 2.1 安装docker docker安装的教程详见我的另外一篇博客
【Docker】deepin/centos安装docker | 慕雪的寒舍
2.2 安装minio 这里推荐使用由VMware维护的minio docker版本bitnami/minio，更新很频繁。
hub.docker.com/r/bitnami/minio
创建容器的命令如下，非常简单
docker run -it -d --name minio \ -p 9000:9000 \ -p 9001:9001 \ --restart=always \ -v /minio/data:/bitnami/minio/data \ -e MINIO_ROOT_USER=&#34;minio_root&#34; \ -e MINIO_ROOT_PASSWORD=&#34;minio_123456&#34; \ -e TZ=&#39;Asia/Shanghai&#39; \ bitnami/minio:latest 该创建容器操作基于如下hash的docker镜像（更新于2023-12-12），创建容器的命令后续可能会有变动，请参考docker-hub中的官方文档
bitnami/minio latest 552af9bd3d6d 2 days ago 212MB 对这个docker命令进行解释" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/322ac08e3427d118cc58e4968379e09f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-16T10:24:01+08:00" />
<meta property="article:modified_time" content="2023-12-16T10:24:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【docker】部署minio对象存储并用rclone同步</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>docker部署minio对象存储并用rclone同步</p> 
<blockquote> 
 <p>本文首发于 <a href="https://blog.musnow.top/?f=csdn" rel="nofollow">❄️慕雪的寒舍</a></p> 
</blockquote> 
<h2><a id="1minio_5"></a>1.什么是minio？</h2> 
<p>minio是一个开源的对象存储服务器，兼容S3协议。</p> 
<p>官网：https://min.io/</p> 
<p>官方在开源的基础上也提供云端S3服务，分为个人和企业，有不同的收费标准。</p> 
<p><img src="https://images2.imgbox.com/a3/99/IEB2VRcA_o.png" alt="5ae0c978272b7ca6732817920adae0f5.png"></p> 
<h3><a id="11__15"></a>1.1 自建对象存储的好处？</h3> 
<p>当然，本文写下来肯定不是让你去买它的对象存储服务的，而是在我们自己的服务器/Nas上部署一个minio的docker，来拥有一个我们自己的对象存储服务器！</p> 
<p>对象存储服务器可以用来做图床、静态资源缓存，亦或者是直接当作一个网盘来使用。</p> 
<p>自建的对象存储的好处是所有源文件我们都能亲手管理，且无需为付费的对象存储的奇怪的计价文档感到手足无措，也不需要担心有人恶意刷流把你一套房子给套走。</p> 
<p>缺点就是，自建的稳定性肯定不如已有厂家提供的服务，且自购的服务器/Nas上传带宽一般都很低，文件一多，访问速度就很慢了。</p> 
<p>对于我个人而言，自建minio的唯一作用，就是备份七牛云/阿里云对象存储中的文件。考虑到2023下半年，各大厂接连boom云服务，国外的谷歌还出现了云盘里面用户的数据回滚到几月前的恶性问题，这可是可能导致用户数据丢失的大问题啊！</p> 
<ul><li><a href="https://www.ithome.com/0/737/538.htm" rel="nofollow">谷歌公布方案，修复 Drive 云盘文件丢失问题</a></li><li><a href="https://news.zol.com.cn/845/8455073.html" rel="nofollow">谷歌承认云端硬盘Google Drive存在BUG，3月内用户文件可能丢失</a></li></ul> 
<p>所以，将数据在自己本地留一份总是安心一些。数据安全靠的是备份，不是云服务厂家给你提供的<code>99.99999%</code>可用性的一面之词。</p> 
<p>如果你对数据备份这个话题感兴趣，可以看看我的另外一篇博客：<a href="https://blog.musnow.top/posts/3543423459/?f=minio" rel="nofollow">谈谈如何进行有效数据备份，3+2+1</a></p> 
<blockquote> 
 <p>温馨提醒：如果你想在<strong>云服务器</strong>上安装minio来备份已有S3中的文件的话，最好是使用一个和已有S3<strong>不在同一个地域、非同一个服务商</strong>的云服务器，避免某些服务商云服务器和对象存储一起boom的情况……</p> 
</blockquote> 
<h2><a id="2dockerminio_35"></a>2.docker安装minio</h2> 
<h3><a id="21_docker_37"></a>2.1 安装docker</h3> 
<p>docker安装的教程详见我的另外一篇博客</p> 
<p><a href="https://blog.musnow.top/posts/2069190154/?f=minio" rel="nofollow">【Docker】deepin/centos安装docker | 慕雪的寒舍</a></p> 
<h3><a id="22_minio_43"></a>2.2 安装minio</h3> 
<p>这里推荐使用由VMware维护的minio docker版本<code>bitnami/minio</code>，更新很频繁。</p> 
<p><a href="https://hub.docker.com/r/bitnami/minio" rel="nofollow">hub.docker.com/r/bitnami/minio</a></p> 
<p>创建容器的命令如下，非常简单</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> minio <span class="token punctuation">\</span>
	<span class="token parameter variable">-p</span> <span class="token number">9000</span>:9000 <span class="token punctuation">\</span>
	<span class="token parameter variable">-p</span> <span class="token number">9001</span>:9001 <span class="token punctuation">\</span>
	<span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span>
	<span class="token parameter variable">-v</span> /minio/data:/bitnami/minio/data <span class="token punctuation">\</span>
	<span class="token parameter variable">-e</span> <span class="token assign-left variable">MINIO_ROOT_USER</span><span class="token operator">=</span><span class="token string">"minio_root"</span> <span class="token punctuation">\</span>
	<span class="token parameter variable">-e</span> <span class="token assign-left variable">MINIO_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token string">"minio_123456"</span> <span class="token punctuation">\</span>
	<span class="token parameter variable">-e</span> <span class="token assign-left variable">TZ</span><span class="token operator">=</span><span class="token string">'Asia/Shanghai'</span> <span class="token punctuation">\</span>
	bitnami/minio:latest
</code></pre> 
<p>该创建容器操作基于如下hash的docker镜像（更新于2023-12-12），创建容器的命令后续可能会有变动，请参考docker-hub中的官方文档</p> 
<pre><code>bitnami/minio  latest    552af9bd3d6d   2 days ago     212MB
</code></pre> 
<p>对这个docker命令进行解释</p> 
<ul><li><code>-it -d</code>，it提供交互能力，d代表后台运行</li><li><code>--restart=always</code>，始终重启docker（docker服务重启后，镜像会自动启动）</li><li><code>-p 9000:9000</code>，将docker内的9000端口（右侧）映射给宿主机（左侧）的9000端口，端口9001的映射同理。 
  <ul><li>容器内9000端口是minio的api端口（用于S3协议操作）</li><li>容器内9001端口是minio的web管理界面端口</li><li>根据你的需要，修改<strong>冒号左侧</strong>的宿主机端口即可。</li></ul> </li><li><code>-v /minio/data:/bitnami/minio/data</code>，将docker内<code>/bitnami/minio/data</code>路径映射给主机<code>/minio/data</code>路径，主机上的路径（左侧）请自行修改；这个路径是bucket和minio配置文件的存储路径。</li><li>两个<code>-e</code>设置的是环境变量，分别设置的是minio管理员的账户和管理员的密码。请注意，在这里配置了管理员用户名和密码后，<strong>进入minio管理系统的密码无法被修改</strong>。如果你的minio服务需要暴露在公网上，请一定要设置一个<strong>高强度</strong>的密码！</li><li><code>-e TZ='Asia/Shanghai'</code> 设置时区为东八区（后续定时备份需要有正确时区）</li><li>最后的<code>bitnami/minio:latest</code>代表我们需要创建<code>bitnami/minio</code>这个docker镜像的latest版本，如果本地没有这个镜像，则会自动去docker-hub拉取。</li><li>如果你卡在了pull镜像的步骤，请自行百度如何<a href="https://blog.musnow.top/posts/2069190154/?f=minio" rel="nofollow">替换docker的镜像源</a>。</li></ul> 
<p>如下是我在一个没有安装过minio的云服务上测试的结果，成功安装并启动minio</p> 
<pre><code>[root:~/docker]# docker run -it -d --name minio \
&gt; -p 19000:9000 \
&gt; -p 19001:9001 \
&gt; --restart=always \
&gt; -v /root/docker/minio:/bitnami/minio/data \
&gt; -e MINIO_ROOT_USER="minio_root" \
&gt; -e MINIO_ROOT_PASSWORD="minio_123456" \
&gt; bitnami/minio:latest
Unable to find image 'bitnami/minio:latest' locally
latest: Pulling from bitnami/minio
ef5975039511: Pull complete 
Digest: sha256:3bb81d101dea57a5382a2d01eda6991e75ce69669d2d49c4646d82721b7c258e
Status: Downloaded newer image for bitnami/minio:latest
afefbb9514de0f4a1c02b7f4212b1e05eee5ef342ed4ce27e03de10071914060
</code></pre> 
<p>容器正常启动，处于Running状态，STATUS正常！</p> 
<pre><code>CONTAINER ID   IMAGE                                  COMMAND                  CREATED         STATUS         PORTS                                                                                      NAMES
afefbb9514de   bitnami/minio:latest                   "/opt/bitnami/script…"   3 minutes ago   Up 3 minutes   0.0.0.0:19000-&gt;9000/tcp, :::19000-&gt;9000/tcp, 0.0.0.0:19001-&gt;9001/tcp, :::19001-&gt;9001/tcp   minio
</code></pre> 
<p>这样还不够，请在后续创建了bucket并上传测试文件后，查看本地映射的路径中是否有对应文件夹和文件，<strong>避免路径映射失败</strong>！（如果路径没有成功映射到本地，那么你当前创建的minio被删除之后，文件就很难找回来了）</p> 
<blockquote> 
 <p>顺带一提，在我这边测试发现，如果你错误使用浏览器访问了9000这个api端口，会被自动重定向到9001 web管理页面端口（前提是映射的宿主机端口和docker内端口一致）</p> 
</blockquote> 
<h3><a id="23_web_113"></a>2.3 web管理</h3> 
<p>使用 <code>http://IP:端口</code> 打开minio的9001端口对应的宿主机端口，访问minio的web管理页面。输入刚刚创建容器时，在环境变量里面配置的用户名和密码进行登录，即可进入控制台。</p> 
<p><img src="https://images2.imgbox.com/4a/4b/HkyVfeYo_o.png" alt="image.png"></p> 
<p>minio的界面比较简单，基本要做的操作只有两个，创建bucket存储桶，和accesskey用于api调用。</p> 
<blockquote> 
 <p>更高阶的配置项和操作我没有尝试过，请自行参考minio的文档或者其他教程。</p> 
</blockquote> 
<h4><a id="231_bucket_124"></a>2.3.1 创建bucket</h4> 
<p>第一个界面就是大大的Object Browser，在这里我们可以创建存储桶</p> 
<p><img src="https://images2.imgbox.com/b6/5d/lXifLgA2_o.png" alt="image.png"></p> 
<p>点击创建bucket，会进入如下配置项，除了bucket的名字，还有三个选项</p> 
<ul><li>Versioning：版本控制，开启后，该bucket将处于多版本模式下，文件会保留修改的历史记录。</li><li>Object Locking：避免文件被删除，需要支持保留和合法保留（这两个啥意思我不明白），该选项只能在bucket创建时打开。</li><li>Quota：限制容器中文件大小（总容量）</li></ul> 
<p>对于我的备份需求来说，这三个额外选项都不需要，直接创建就行了</p> 
<p><img src="https://images2.imgbox.com/ee/b3/mukASoZp_o.png" alt="image.png"></p> 
<p>创建之后，在bucket页面可以看到刚刚创建的test存储桶，这里会统计存储容量和文件数量</p> 
<p><img src="https://images2.imgbox.com/10/1f/CsIEt0D6_o.png" alt="image-20231213232421462"></p> 
<h4><a id="232_accessKey_145"></a>2.3.2 创建accessKey</h4> 
<p>accessKey是用于操作api的token凭证。创建完毕后，他只会显示一次，后续将不会显示出来。</p> 
<p><img src="https://images2.imgbox.com/1d/60/aLpwxQ6w_o.png" alt="image.png"></p> 
<p>如果你不想创建太多个密钥，那就把这个密钥的文件下载下来，免得到时候不知道是什么了。点击右下角的import文件就可以下载，会下载一个<code>json</code>文件，内部包含密钥和其他一些相关信息</p> 
<p><img src="https://images2.imgbox.com/93/cd/qZHyDjhX_o.png" alt="image.png"></p> 
<p>因为我这只是做个测试，一会就会把这个minio的docker删除，所以展示密钥无所谓。如果你是在生产环境下使用，请一定不要暴露你的密钥给任何人。</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"url"</span><span class="token operator">:</span> <span class="token string">"http://公网IP:19001/api/v1/service-account-credentials"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"accessKey"</span><span class="token operator">:</span> <span class="token string">"aXpBxrUceV30Id6gOouG"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"secretKey"</span><span class="token operator">:</span> <span class="token string">"dIWl9IFL05UtaI08PZfPXE66zPGu2zWrGFfSTaUm"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"api"</span><span class="token operator">:</span> <span class="token string">"s3v4"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"auto"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>密钥创建完毕，就能在列表看到它。</p> 
<p><img src="https://images2.imgbox.com/e5/02/2nPr7MKV_o.png" alt="image.png"></p> 
<h2><a id="3rclone_172"></a>3.rclone备份</h2> 
<p>rclone是一个全平台的命令行工具，其可以用于多种云端/本地存储之间的数据拷贝、同步、加密同步等功能。详见rclone官网：<a href="https://rclone.org/" rel="nofollow">rclone.org</a></p> 
<p>因为我的目标就是我的七牛云bucket里面的图床文件备份到本地，rclone绝对是不二之选。</p> 
<h3><a id="31_docker_178"></a>3.1 进入docker容器内终端</h3> 
<p>你可以选择在<strong>宿主机</strong>上安装rclone，也可以选择直接在minio的容器内安装rclone。</p> 
<p>前排提醒：部分nas品牌的系统（比如群晖）已经提供了<strong>执行定时脚本</strong>的功能，这种情况下直接使用系统提供的定时任务来执行<code>rclone sync</code>即可，<strong>即直接在nas里面安装rclone和使用定时任务</strong>，不要在minio的docker里面安装rclone。</p> 
<p>如你选择了在宿主机上安装rclone，则可以直接<strong>跳过本3.1步骤</strong>，阅读3.2及后续步骤</p> 
<h4><a id="docker_186"></a>docker特权模式</h4> 
<p>注意，如果在minio的容器内安装rclone，那么minio容器被删除后，<strong>rclone和它的配置文件自然也不在了</strong>。</p> 
<p><strong>且如果需要用minio的容器进行crontab定时任务</strong>，则必须用<strong>特权模式</strong>安装minio的docker，在minio的docker创建命令里面加如下这条，设置特权模式（不需要定时任务可以不设置）。</p> 
<pre><code>--privileged
</code></pre> 
<p>在绿联nas的docker管理界面，创建docker的时候给定所有权限，也是一样的效果。（因为我不太了解这里具体每个权限的作用，干脆全给了）</p> 
<p><img src="https://images2.imgbox.com/5c/ad/RUj8OJNe_o.png" alt="image.png"></p> 
<p><img src="https://images2.imgbox.com/15/e4/0hvFJTtS_o.png" alt="image.png"></p> 
<h4><a id="ssh_203"></a>ssh连接宿主设备</h4> 
<p>不同nas机型进入ssh的方式不太一样，请参考你的nas或设备品牌搜索对应类型教程。</p> 
<p><strong>连接到宿主设备的ssh后</strong>，参考：<a href="https://www.cnblogs.com/langgeligelang/p/13628821.html" rel="nofollow">以指定用户启动和进入docker容器 - langyong - 博客园</a> 一文，使用如下docker命令进入minio的容器终端中。</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">-u</span> 用户名 容器名 /bin/bash
<span class="token comment"># 示例如下</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">-u</span> root minio /bin/bash
</code></pre> 
<p>如果你使用的是绿联、极空间这类不太方便进入ssh的nas，可以在nas的docker管理页里面操作，如下图所示，选择<code>/bin/bash</code>后点击链接即可进入容器内终端。</p> 
<p><img src="https://images2.imgbox.com/03/fb/FmSpUnCu_o.png" alt="image.png"></p> 
<h3><a id="32_rclone_219"></a>3.2 下载安装rclone</h3> 
<p>进入终端后，默认所在路径是docker容器的工作路径<code>/opt/bitnami/minio-client</code>。</p> 
<p>为了避免影响容器运行，我们不要在工作路径里面做操作，请使用如下命令，创建一个新的rclone文件夹，进入root用户的家目录进行操作。</p> 
<p>如果你是在宿主机上操作，也是一样的道理，为rclone单独创建一个文件夹，来存放它的软件包、配置文件、执行日志。</p> 
<pre><code>mkdir /root/rclone
cd /root/rclone
</code></pre> 
<blockquote> 
 <p>如果是docker内操作，你可以在创建minio容器的时候，就把<code>/root/rclone</code>路径给映射到宿主机上，方便后续查看rclone备份的日志。</p> 
</blockquote> 
<p>下载安装rclone的命令如下</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-O</span> https://downloads.rclone.org/rclone-current-linux-amd64.zip
<span class="token function">unzip</span> rclone-current-linux-amd64.zip
<span class="token builtin class-name">cd</span> rclone-*-linux-amd64
 
<span class="token function">sudo</span> <span class="token function">cp</span> rclone /usr/bin/
<span class="token function">sudo</span> <span class="token function">chown</span> root:root /usr/bin/rclone
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">755</span> /usr/bin/rclone
</code></pre> 
<p>minio的docker内没有unzip命令，需要安装一下</p> 
<pre><code>apt-get update &amp;&amp; apt-get install -y unzip
</code></pre> 
<p>minio的docker内也没有sudo，将上述安装命令中的sudo去掉就可以了。</p> 
<p>完成安装命令后，执行一下<code>rclone</code>，出现rclone命令的使用提示，那就是安装成功了！</p> 
<pre><code>root@878a0dd03ec4:/root/rclone/rclone-v1.65.0-linux-amd64# rclone
Usage:
  rclone [flags]
  rclone [command]
  ...
</code></pre> 
<h3><a id="33_rclone_265"></a>3.3 rclone对象存储配置</h3> 
<p>rclone的官网上有不同云端存储协议和不同S3服务商的配置教程，跟着官方的来就可以了。</p> 
<p>执行<code>rclone config</code>命令，工具会自动在<code>/.config/rclone/rclone.conf</code>下创建一个config文件，你可以根据<a href="https://rclone.org/" rel="nofollow">官方的向导</a>，在此处添加新的remote;</p> 
<pre><code>root@878a0dd03ec4:/root/rclone/rclone-v1.65.0-linux-amd64# rclone config
2023/12/14 04:38:44 NOTICE: Config file "/.config/rclone/rclone.conf" not found - using defaults
No remotes found, make a new one?
n) New remote
s) Set configuration password
q) Quit config
n/s/q&gt; q
</code></pre> 
<p>下面给出minio和七牛云的配置文件，你可以直接修改这个配置文件中的内容为你的配置，然后写入<code>/.config/rclone/rclone.conf</code>即可。</p> 
<ul><li><a href="https://rclone.org/s3/#minio" rel="nofollow">rclone.org/s3/#minio</a></li><li><a href="https://rclone.org/s3/#qiniu" rel="nofollow">rclone.org/s3/#qiniu</a></li></ul> 
<p>其中minio的region在minio的控制台里面可以修改，如果你没有修改过，默认使用的是<code>us-east-1</code>。因为rclone是直接在minio的docker里面执行的，所以endpoint只需要写成<code>127.0.0.1</code>和minio的api端口9000就可以了。</p> 
<p>如果你的minio在公网或者其他设备上，请修改对应的IP地址和端口。</p> 
<p>七牛云的region和endpoint在<strong>七牛云bucket页面</strong>找到<strong>S3域名</strong>就可以看到。</p> 
<p><img src="https://images2.imgbox.com/62/7f/MsgAaSc4_o.png" alt="image.png"></p> 
<blockquote> 
 <p>请注意，七牛云/阿里云这类存储服务商，如果你有多个bucket，且他们的地域不一样，则需要新增对应地域的配置项。通过修改<code>[]</code>里面的<strong>配置名</strong>进行区分。</p> 
</blockquote> 
<pre><code>[minio]
type = s3
provider = Minio
env_auth = false
access_key_id = 控制台获取的key_id
secret_access_key = 控制台获取的secret_key
region = us-east-1
endpoint = http://127.0.0.1:9000
location_constraint =
server_side_encryption =

[qiniu]
type = s3
provider = Qiniu
access_key_id = 七牛云控制台获取key_id
secret_access_key = 七牛云控制台获取secret_key
region = cn-east-1
endpoint = s3-cn-east-1.qiniucs.com
location_constraint = cn-east-1
acl = private
storage_class = STANDARD
</code></pre> 
<p>执行如下命令，安装nano编辑器，然后使用nano编辑器打开rclone配置文件进行编辑。</p> 
<pre><code>apt-get update &amp;&amp; apt-get install -y nano
nano /.config/rclone/rclone.conf
</code></pre> 
<p>linux下的粘贴命令是<code>CTRL+SHIFT+V</code>或<code>CTRL+INSERT</code>，你可以在本地修改了配置文件后，通过nano编辑器，直接粘贴到docker容器内。编辑完毕后，使用<code>CTRL+X</code>退出nano的编辑模式，并按Y确认保存，随后直接回车，即完成编辑。</p> 
<p><img src="https://images2.imgbox.com/01/6f/sXdwFWo9_o.png" alt="image.png"></p> 
<p><img src="https://images2.imgbox.com/a7/29/7UXFQ0hr_o.png" alt="image.png"></p> 
<p>这个配置文件建议备份一个，免得每次都得重新弄</p> 
<h3><a id="34_rclone_335"></a>3.4 rclone基本命令</h3> 
<h4><a id="copy_337"></a>copy</h4> 
<p>拷贝命令如下，配置名称是在config文件中<code>[]</code>里面的文字，桶名就是你的S3服务里面的对象存储桶，还可以在桶名后面用<code>/</code>来追加指定上传的路径。</p> 
<pre><code> rclone copy 本地文件路径 配置名称:桶名
 rclone copy 本地文件路径 配置名称:桶名/桶内目录
</code></pre> 
<p>这里我在docker内创建了一个<code>test.txt</code>文件，尝试将其拷贝到minio里面。</p> 
<pre><code>touch test.txt
rclone copy ./test.txt minio:1panel-bak
</code></pre> 
<p>命令没有错误输出，即拷贝成功！</p> 
<pre><code>root@878a0dd03ec4:/root/rclone# touch test.txt
root@878a0dd03ec4:/root/rclone# rclone copy ./test.txt minio:1panel-bak
root@878a0dd03ec4:/root/rclone# 
</code></pre> 
<p><img src="https://images2.imgbox.com/5d/df/r51KXMG6_o.png" alt="image.png"></p> 
<p>尝试在拷贝的时候指定远端仓库内的路径</p> 
<pre><code>rclone copy ./test.txt minio:qiniu-muxue-sy/test
</code></pre> 
<p>成功指定，文件被上传到了test文件夹里面。</p> 
<p><img src="https://images2.imgbox.com/17/a6/D5ojiMSx_o.png" alt="image.png"></p> 
<h4><a id="sync_373"></a>sync</h4> 
<p>备份命令如下，可以在任意目的地（本地-远端，远端-本地，远端-远端）里面执行这个命令，左侧是源路径，右侧是目标。</p> 
<pre><code>rclone sync 本地源文件路径  目的地配置名称:桶名 
rclone sync 源配置名称:桶名 目的地配置名称:桶名
rclone sync 源配置名称:桶名 目的地的本地文件路径
</code></pre> 
<p>rclone sync有两个常用的选项，刚开始使用的时候，建议带上 <code>--dry-run</code> 命令来确认自己的配置没有问题</p> 
<ul><li><code>-P</code> 显示详细同步进度条</li><li><code>--dry-run</code> 用作命令测试，不会真正的执行同步</li></ul> 
<p>指定<code>-P</code>命令后的进度输出如下，可以看到实时网速和文件数量/大小。</p> 
<p><img src="https://images2.imgbox.com/b8/57/wGeXlW8t_o.png" alt="image.png"></p> 
<p>目前发现的问题是minio显示的文件总量和数据存储量会<strong>有一定滞后</strong>，刚开始我还以为是rclone没有跑完呢，sync完毕过了几分钟minio里面才刷出正确的文件数量来。</p> 
<h3><a id="35_cron_393"></a>3.5 cron定时同步</h3> 
<p>前排提醒：部分nas品牌的系统（比如群晖）已经提供了<strong>执行定时脚本</strong>的功能，这种情况下直接使用系统提供的定时任务来执行<code>rclone sync</code>即可，无序安装其他服务。<strong>即直接在nas里面安装rclone和使用定时任务</strong>，不要在minio的docker里面安装rclone和cron。</p> 
<ul><li>群晖官网关于定时任务的说明： https://kb.synology.cn/zh-cn/DSM/help/DSM/AdminCenter/system_taskscheduler?version=6</li><li>绿联nas的环境中已有crontab，但我没有试过使用它。考虑到绿联这个nas的系统还是一点都不稳定，还是别动它的系统里面的东西了，不知道绿联官方有没有可能把定时任务加到控制页里面去吧（我估计是没戏，这个系统的限制太多了）。</li></ul> 
<p>如果你使用的是群晖、威联通等提供了执行定时任务的功能的nas，请在nas内配置好rclone后，自行百度执行定时任务相关教程。</p> 
<h4><a id="minio_dockercron_401"></a>minio docker内安装cron服务</h4> 
<p>下面介绍在minio的docker内cron服务的安装和使用。</p> 
<p>在minio的docker里面直接安装crontab服务和nano文本编辑器</p> 
<pre><code>apt-get update
apt-get install -y cron nano
</code></pre> 
<p>但这还不够，cron服务的运行还依赖于其他组件，需要一并安装。</p> 
<pre><code>apt-get install -y rsyslog  postfix
service rsyslog start
</code></pre> 
<p>安装postfix的时候会提示让你选择配置文件，键入1选择无配置就够了。</p> 
<p><img src="https://images2.imgbox.com/c2/24/Bdlyp59G_o.png" alt="image.png"></p> 
<p>postfix还需要额外配置，否则可能会遇到如下错误</p> 
<pre><code>Dec 16 01:07:01 878a0dd03ec4 postfix/sendmail[1859]: fatal: open /etc/postfix/main.cf: No such file or directory
Dec 16 01:12:02 878a0dd03ec4 postfix/postdrop[1912]: warning: unable to look up public/pickup: No such file or directory
</code></pre> 
<p>配置命令如下</p> 
<pre><code>touch /etc/postfix/main.cf
mkfifo /var/spool/postfix/public/pickup
</code></pre> 
<h4><a id="crontab_436"></a>crontab配置定时任务测试</h4> 
<p>安装完毕后，使用<code>crontab -e</code>看看是否能打开crontab的配置编辑页面，如果可以打开如下配置界面，则代表cron安装成功。</p> 
<p><img src="https://images2.imgbox.com/b6/e2/qFzVAURP_o.png" alt="image.png"></p> 
<p>这个配置文件需要写入的格式如下，一行对应一个配置。</p> 
<pre><code>五位cron表达式 需要执行的命令
</code></pre> 
<p>cron表达式可以用在线工具<a href="https://tool.lu/crontab/" rel="nofollow">crontab执行时间计算 - 在线工具</a></p> 
<p>先用如下的配置来检测cron服务是否能正常运行，以及是否能成功输出日志</p> 
<pre><code>*/1 * * * * echo "$(date) This is a test command" &gt;&gt; /root/rclone/log.txt
</code></pre> 
<p>该配置的含义是每分钟执行一次echo命令，打印当前时间和对应内容到<code>/root/rclone/log.txt</code>文件中。</p> 
<p>修改了配置文件后，启动cron服务，测试我们的配置是否有效，cron服务是否能正常运行。</p> 
<pre><code>service cron start 
</code></pre> 
<p>该命令执行效果如下</p> 
<pre><code>root@878a0dd03ec4:/root/rclone# service cron start
Starting periodic command scheduler: cron.
</code></pre> 
<p>等待数分钟，看看cron命令是否成功输出内容到指定文件里面了，有内容则代表配置和运行成功！默认情况下，<strong>使用cron执行的echo命令内的date</strong>采用了<strong>UTC时间</strong>的输出，但这并不影响我们的使用，给小时加8就能得到东八区的时间了。</p> 
<pre><code>root@878a0dd03ec4:/root/rclone# cat /root/rclone/log.txt
Sat Dec 16 01:18:01 UTC 2023 This is a test command
Sat Dec 16 01:18:01 UTC 2023 This is a test command
Sat Dec 16 01:19:01 UTC 2023 This is a test command
Sat Dec 16 01:19:01 UTC 2023 This is a test command
</code></pre> 
<p>在syslog里面也能看到cron的服务日志，该服务日志组件依赖于先前安装的rsyslog</p> 
<pre><code>cat /var/log/syslog
</code></pre> 
<p>文件<code>/var/log/syslog</code>内部cron执行日志如下</p> 
<pre><code>Dec 16 01:25:01 878a0dd03ec4 CRON[2059]: (root) CMD (echo "$(date) This is a test command" &gt;&gt; /root/rclone/log.txt)
Dec 16 01:25:01 878a0dd03ec4 CRON[2058]: (root) CMD (echo "$(date) This is a test command" &gt;&gt; /root/rclone/log.txt)
</code></pre> 
<blockquote> 
 <p>请注意，默认情况下，minio的docker是<strong>没有时区配置</strong>的，请一定要在创建docker容器的时候，使用<strong>TZ环境变量</strong>来设置时区，否则crontab不会执行！<br> 原因也很简单，cron表达式有一个指定时间，比如每周一执行、几点执行，如果没有配置时区，cron没有办法明确你的cron表达式到底应该什么时候跑，干脆就不跑了！</p> 
</blockquote> 
<p>如果你的docker已经创建，不想重新创建，可以通过修改配置文件来设置时区，修改后重启docker容器即可。</p> 
<pre><code>nano /etc/environment
# 在文件末尾写入如下内容
TZ='Asia/Shanghai'
</code></pre> 
<h4><a id="crontabrclone_sync_504"></a>crontab配置定时rclone sync</h4> 
<p>确认cron服务可用，就可以来配置rclone sync的自动执行命令了。</p> 
<p>对于rclone的sync备份而言，写入如下内容即可；</p> 
<pre><code>0 3 * * 1,5 rclone sync qiniu-e1:muxue-sy  minio:qiniu-muxue-sy &gt;&gt; /root/rclone/rclone.log 2&gt;&amp;1
0 2 * * 1,5 rclone sync qiniu-e2:muxue-img  minio:qiniu-muxue-img &gt;&gt; /root/rclone/rclone.log 2&gt;&amp;1
</code></pre> 
<p>解析如下</p> 
<ul><li><code>0 3 * * 1,5</code> 代表每周一和周五的凌晨3点执行一次</li><li><code>0 2 * * 1,5</code> 代表每周一和周五的凌晨2点执行一次</li><li><code>&gt;&gt; /root/rclone/rclone.log 2&gt;&amp;1</code> 代表将rclone命令的输出结果写入到 <code>/root/rclone/rclone.log</code> 文件中。</li></ul> 
<p>因为我对备份的频次要求不高，一周备份两次就够了。</p> 
<p>写入完毕后，<code>CTRL+X</code>关闭nano编辑模式，按Y和回车即完成nano编辑。编辑完成后会有如下输出。</p> 
<pre><code>root@878a0dd03ec4:/root/rclone# crontab -e
no crontab for root - using an empty one
crontab: installing new crontab
</code></pre> 
<p>后续crontab执行的命令结果都会输入到<code>/root/rclone/rclone.log</code>日志文件中。rclone命令只有在出现ERROR的时候才会输出。如果这个文件里面什么都么有，就代表运行没有出错！</p> 
<p>配置好了之后，使用如下命令重新启动cron服务</p> 
<pre><code>service cron restart
</code></pre> 
<p>用如下命令查看cron服务状态</p> 
<pre><code>root@878a0dd03ec4:/root/rclone# service cron status
cron is running.
</code></pre> 
<h4><a id="_550"></a>优化日志</h4> 
<p>为了让日志更加合理，可以在执行rclone命令之前，打印当前时间，这样可以知道crontab到底有没有正常执行定时任务。</p> 
<p>打印时间的基本命令如下，echo命令会将当前时间和相关的说明信息写入<code>test.txt</code>文件中</p> 
<pre><code>echo "$(date) This is a test command" &gt;&gt; test.txt
</code></pre> 
<p>执行效果如下，打印了时间和对应的日志信息</p> 
<pre><code>root@878a0dd03ec4:/root/rclone# echo "$(date) This is a test command" &gt;&gt; test.txt
root@878a0dd03ec4:/root/rclone# cat test.txt
Sat Dec 16 09:36:06 CST 2023 This is a test command
</code></pre> 
<blockquote> 
 <p>再次提醒，minio的docker内<strong>必须指定TZ环境变量</strong>，否则crontab不会执行！且date命令时区和东八区不符。</p> 
</blockquote> 
<p>echo打印的时候，可以临时指定TZ环境变量来打印不同时区的date</p> 
<pre><code>echo "$(TZ='Asia/Shanghai' date) 这是东八区" &gt;&gt; test.txt
</code></pre> 
<p>执行效果如下，因为我的docker内已经设置了TZ环境变量为东八区，所以不加这个TZ也是打印的东八区的时间。</p> 
<pre><code>root@878a0dd03ec4:/root/rclone# echo "$(TZ='Asia/Shanghai' date) 这是东八区" &gt;&gt; test.txt
root@878a0dd03ec4:/root/rclone# cat test.txt
Sat Dec 16 09:36:06 CST 2023 This is a test command
Sat Dec 16 09:37:39 CST 2023 这是东八区
</code></pre> 
<p>但是需要注意的是，使用cron命令执行的时候，它依旧会打印UTC时间，前文已经提到过了。</p> 
<p>将原本的crontab命令改成如下形式（<code>crontab -e</code>编辑配置文件），使用<code>&amp;&amp;</code>来链接echo和rclone命令，这样在每次执行rclone之前都会有一个当前时间和sync的是什么内容的的输出，能让我们知道crontab是否正常执行。</p> 
<pre><code>0 3 * * 1,5 echo "$(TZ='Asia/Shanghai' date) sync muxue-sy" &gt;&gt; /root/rclone/rclone.log &amp;&amp; rclone sync qiniu-e1:muxue-sy  minio:qiniu-muxue-sy &gt;&gt; /root/rclone/rclone.log 2&gt;&amp;1

0 2 * * 1,5 echo "$(TZ='Asia/Shanghai' date) sync muxue-img" &gt;&gt; /root/rclone/rclone.log &amp;&amp; rclone sync qiniu-e2:muxue-img  minio:qiniu-muxue-img &gt;&gt; /root/rclone/rclone.log 2&gt;&amp;1
</code></pre> 
<p>你可以修改cron表达式为<code>*/1 * * * *</code>，让crontab表达式立即执行一次，确认一下输出是否正确，以及rclone命令是否正常执行。</p> 
<pre><code>*/1 * * * * echo "$(date) sync muxue-img" &gt;&gt; /root/rclone/rclone.log &amp;&amp; rclone sync qiniu-e2:muxue-img  minio:qiniu-muxue-img &gt;&gt; /root/rclone/rclone.log 2&gt;&amp;1
</code></pre> 
<p>我的测试结果如下，rclone sync成功被cron执行（这个ERROR是因为我的bucket里面有个无效的文件，正常情况下应该不会有ERROR）</p> 
<pre><code>Sat Dec 16 01:45:01 UTC 2023 sync muxue-img
2023/12/16 01:45:02 ERROR : : Entry doesn't belong in directory "" (same as directory) - ignoring
</code></pre> 
<p>测试结束后，<strong>记得还原配置项</strong>。</p> 
<p>每次修改配置文件后，都需要重启cron服务！</p> 
<pre><code>root@878a0dd03ec4:/root/rclone# service cron restart
Restarting periodic command scheduler: cronStopping periodic command scheduler: cron.
Starting periodic command scheduler: cron.
</code></pre> 
<h2><a id="The_end_619"></a>The end</h2> 
<p>本文的教程结束，有问题欢迎在评论区提出。</p> 
<p>数据无价，多一份备份，多一份安心</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/63454399a3dda085f57a0f2a635d7ba8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">DW手表如何更换电池？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2a9682e896839b8fced8c079201454e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">js过滤数组的filter用法（附与find的区别）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>