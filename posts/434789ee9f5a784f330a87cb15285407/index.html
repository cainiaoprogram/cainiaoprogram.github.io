<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>IPSec协议抓包详解和IPSec NAT穿越报文解析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="IPSec协议抓包详解和IPSec NAT穿越报文解析" />
<meta property="og:description" content="目录
协议概述
2、IPSec作用
3、认证方式
3.1、预共享密钥
3.2、数字证书
4、ESP加密算法
4.1、ESP完整性检测
4.2、ESP防重放
4.3、ESP防窃听
5、IPSec工作原理
5.1、传输模式
5.2、隧道模式
6.1、主动模式
6.1.1、Ikev1协商
6.1.2、IPSec加密协商
6.2、野蛮模式
7、IPsec穿越NAT
7.1、IPSec穿越NAT遇到的问题
7.2、IKE身份确认及协商
7.3、穿越NAT原理抓包解释
协议概述 IP Sec全称：IP Security
IPSec协议，不是一个单独的协议，而是一系列为IP网络提供完整安全性的协议和服务的集合。
IPSec协议是一个工作在IP网络层的协议
作为一个隧道协议实现了VPN通信
第三层隧道协议，可以在IP层上创建一个安全的隧道，使两个异地的私有网络连接起来，或者使公网上的计算机可以访问远程的企业私有网络。
2、IPSec作用 1、保证数据来源可靠
在IPSec通信之前双方要先用IKE认证对方身份并协商密钥，只有IKE协商成功之后才能通信。由于第三方不可能知道验证和加密的算法以及相关密钥，因此无法冒充发送方，即使冒充，也会被接收方检测出来。
2、保证数据完整性
IPSec通过验证算法保证数据从发送方到接收方的传送过程中的任何数据篡改和丢失都可以被检测。
3、保证数据机密性
IPSec通过加密算法使只有真正的接收方才能获取真正的发送内容，而他人无法获知数据的真正内容
3、认证方式 3.1、预共享密钥 预共享密钥认证是IPSec双方配置时手工指定的密钥，无需在网络中互相告知密钥
3.2、数字证书 响应端发送数字证书到客户端发送端收到响应端的数字证书后，会取出附带的数字证书，并读取证书中的发布机构（Issuer），然后从操作系统的受信任证书机构列表中查找该证书办发机构的公钥，如果找不到，说明这个证书颁发机构是个不受信任的，响应端发过来的信息是不安全的。使用上一步取到的证书颁发机构的公钥，解出数字证书，得到响应端的用户信息和数字签名发送端通过证书中指定的加密算法对响应端的用户信息进行hash加密加密后的结果和证书中解出的数字签名进行对比，如果相同，就说明这份用户信息确实是响应端的，也就是说用户信息中包含的公钥确实是响应端的后续响应端使用私钥加密数据，发送端使用公钥解密。发送端使用公钥加密，响应端使用私钥解密 4、ESP加密算法 4.1、ESP完整性检测 ESP报文最后有一个验证数据字段，数据验证字段包含完整性校验值 (ICV)，也称为消息身份验证码，用于验证消息身份验证与完整性。接收方计算 ICV 值并对照发送方计算的值校验它，以验证完整性。ICV 是通过 ESP 报头、负载数据与 ESP 尾端计算的。
4.2、ESP防重放 作为可选功能，ESP还能进行防重放保护。防重放保护验证每个报文是唯一的且没有被复制，这种保护确保黑客不能拦截报文和在数据流中插入改变后的报文。
防重放的工作原理：
跟踪报文顺序号并在目的端使用一个滑动窗口。当在源和目的间建立了一条连接时，两端的计数器被初始化为0。每次有报文发送时，源给报文追加一个顺序号，目的端使用滑动窗口确定预期的顺序号。目的端验证的报文的顺序号不是复制的，并且以正确的顺序被接收。 例：
1、客户端发送ESP封装报文到服务端，序列号为81
2、服务端响应报文通过ESP加密，响应报文的序列号为81
3、客户端收到服务端发送的ESP报文后，查看ESP序列号，序列号排序正确则没有重放，排序错误则出现重放。
4.3、ESP防窃听 ESP通过3DES、DES、AES机密算法加密数据，做到防窃听功能
5、IPSec工作原理 ESP有两种模式：隧道模式和传输模式。
隧道模式将发送的整个数据报文作为一个数据整体来处理，在整段数据前加上新的IP进行传输，不修改原报文。
对于传输模式而言，需要拆解报文，对原报文的数据部分进行处理，加上ESP头部后，再装上原报文的IP部分。
5.1、传输模式 ESP处理流程：
1、 将原IP报文的IP头和数据报文部分分离，在数据报文部分的尾部添加ESP尾部。ESP尾部包含：选择的加密算法需要对明文进行填充的数据Padding、填充长度Padding Length、下一头部Next Header标注被加密的数据报文类型，例如TCP协议。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/434789ee9f5a784f330a87cb15285407/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-04-11T18:44:40+08:00" />
<meta property="article:modified_time" content="2019-04-11T18:44:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">IPSec协议抓包详解和IPSec NAT穿越报文解析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px;"> </p> 
<p id="%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%BF%B0-toc" style="margin-left:0px;"><a href="#%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%BF%B0" rel="nofollow">协议概述</a></p> 
<p id="2%E3%80%81IPSec%E4%BD%9C%E7%94%A8-toc" style="margin-left:0px;"><a href="#2%E3%80%81IPSec%E4%BD%9C%E7%94%A8" rel="nofollow">2、IPSec作用</a></p> 
<p id="3%E3%80%81%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F-toc" style="margin-left:0px;"><a href="#3%E3%80%81%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F" rel="nofollow">3、认证方式</a></p> 
<p id="3.1%E3%80%81%E9%A2%84%E5%85%B1%E4%BA%AB%E5%AF%86%E9%92%A5-toc" style="margin-left:40px;"><a href="#3.1%E3%80%81%E9%A2%84%E5%85%B1%E4%BA%AB%E5%AF%86%E9%92%A5" rel="nofollow">3.1、预共享密钥</a></p> 
<p id="3.2%E3%80%81%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6-toc" style="margin-left:40px;"><a href="#3.2%E3%80%81%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6" rel="nofollow">3.2、数字证书</a></p> 
<p id="4%E3%80%81ESP%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95-toc" style="margin-left:0px;"><a href="#4%E3%80%81ESP%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95" rel="nofollow">4、ESP加密算法</a></p> 
<p id="4.1%E3%80%81ESP%E5%AE%8C%E6%95%B4%E6%80%A7%E6%A3%80%E6%B5%8B-toc" style="margin-left:40px;"><a href="#4.1%E3%80%81ESP%E5%AE%8C%E6%95%B4%E6%80%A7%E6%A3%80%E6%B5%8B" rel="nofollow">4.1、ESP完整性检测</a></p> 
<p id="4.2%E3%80%81ESP%E9%98%B2%E9%87%8D%E6%94%BE-toc" style="margin-left:40px;"><a href="#4.2%E3%80%81ESP%E9%98%B2%E9%87%8D%E6%94%BE" rel="nofollow">4.2、ESP防重放</a></p> 
<p id="4.3%E3%80%81ESP%E9%98%B2%E7%AA%83%E5%90%AC-toc" style="margin-left:40px;"><a href="#4.3%E3%80%81ESP%E9%98%B2%E7%AA%83%E5%90%AC" rel="nofollow">4.3、ESP防窃听</a></p> 
<p id="5%E3%80%81IPSec%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-toc" style="margin-left:0px;"><a href="#5%E3%80%81IPSec%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" rel="nofollow">5、IPSec工作原理</a></p> 
<p id="5.1%E3%80%81%E4%BC%A0%E8%BE%93%E6%A8%A1%E5%BC%8F-toc" style="margin-left:40px;"><a href="#5.1%E3%80%81%E4%BC%A0%E8%BE%93%E6%A8%A1%E5%BC%8F" rel="nofollow">5.1、传输模式</a></p> 
<p id="5.2%E3%80%81%E9%9A%A7%E9%81%93%E6%A8%A1%E5%BC%8F-toc" style="margin-left:40px;"><a href="#5.2%E3%80%81%E9%9A%A7%E9%81%93%E6%A8%A1%E5%BC%8F" rel="nofollow">5.2、隧道模式</a></p> 
<p id="6.1%E3%80%81%E4%B8%BB%E5%8A%A8%E6%A8%A1%E5%BC%8F-toc" style="margin-left:40px;"><a href="#6.1%E3%80%81%E4%B8%BB%E5%8A%A8%E6%A8%A1%E5%BC%8F" rel="nofollow">6.1、主动模式</a></p> 
<p id="6.1.1%E3%80%81Ikev1%E5%8D%8F%E5%95%86-toc" style="margin-left:80px;"><a href="#6.1.1%E3%80%81Ikev1%E5%8D%8F%E5%95%86" rel="nofollow">6.1.1、Ikev1协商</a></p> 
<p id="6.1.2%E3%80%81IPSec%E5%8A%A0%E5%AF%86%E5%8D%8F%E5%95%86-toc" style="margin-left:80px;"><a href="#6.1.2%E3%80%81IPSec%E5%8A%A0%E5%AF%86%E5%8D%8F%E5%95%86" rel="nofollow">6.1.2、IPSec加密协商</a></p> 
<p id="6.2%E3%80%81%E9%87%8E%E8%9B%AE%E6%A8%A1%E5%BC%8F-toc" style="margin-left:40px;"><a href="#6.2%E3%80%81%E9%87%8E%E8%9B%AE%E6%A8%A1%E5%BC%8F" rel="nofollow">6.2、野蛮模式</a></p> 
<p id="7%E3%80%81IPsec%E7%A9%BF%E8%B6%8ANAT-toc" style="margin-left:0px;"><a href="#7%E3%80%81IPsec%E7%A9%BF%E8%B6%8ANAT" rel="nofollow">7、IPsec穿越NAT</a></p> 
<p id="7.1%E3%80%81IPSec%E7%A9%BF%E8%B6%8ANAT%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98-toc" style="margin-left:40px;"><a href="#7.1%E3%80%81IPSec%E7%A9%BF%E8%B6%8ANAT%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98" rel="nofollow">7.1、IPSec穿越NAT遇到的问题</a></p> 
<p id="7.2%E3%80%81IKE%E8%BA%AB%E4%BB%BD%E7%A1%AE%E8%AE%A4%E5%8F%8A%E5%8D%8F%E5%95%86-toc" style="margin-left:40px;"><a href="#7.2%E3%80%81IKE%E8%BA%AB%E4%BB%BD%E7%A1%AE%E8%AE%A4%E5%8F%8A%E5%8D%8F%E5%95%86" rel="nofollow">7.2、IKE身份确认及协商</a></p> 
<p id="7.3%E3%80%81%E7%A9%BF%E8%B6%8ANAT%E5%8E%9F%E7%90%86%E6%8A%93%E5%8C%85%E8%A7%A3%E9%87%8A-toc" style="margin-left:40px;"><a href="#7.3%E3%80%81%E7%A9%BF%E8%B6%8ANAT%E5%8E%9F%E7%90%86%E6%8A%93%E5%8C%85%E8%A7%A3%E9%87%8A" rel="nofollow">7.3、穿越NAT原理抓包解释</a></p> 
<hr id="hr-toc"> 
<h2 id="%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%BF%B0"><strong><strong><strong>协议概述</strong></strong></strong></h2> 
<p style="margin-left:0pt;">IP Sec全称：IP Security</p> 
<p style="margin-left:0pt;">IPSec协议，不是一个单独的协议，而是一系列为IP网络提供完整安全性的协议和服务的集合。</p> 
<p style="margin-left:0pt;">IPSec协议是一个工作在IP网络层的协议</p> 
<p style="margin-left:0pt;">作为一个隧道协议实现了VPN通信</p> 
<p style="margin-left:0pt;">第三层隧道协议，可以在IP层上创建一个安全的隧道，使两个异地的私有网络连接起来，或者使公网上的计算机可以访问远程的企业私有网络。</p> 
<h2 id="2%E3%80%81IPSec%E4%BD%9C%E7%94%A8"><strong><strong><strong>2、IPSec作用</strong></strong></strong></h2> 
<p style="margin-left:0pt;"><strong><strong>1、</strong></strong><strong><strong>保证数据来源可靠</strong></strong></p> 
<p style="margin-left:0pt;">在IPSec通信之前双方要先用IKE认证对方身份并协商密钥，只有IKE协商成功之后才能通信。由于第三方不可能知道验证和加密的算法以及相关密钥，因此无法冒充发送方，即使冒充，也会被接收方检测出来。</p> 
<p style="margin-left:0pt;"><strong><strong>2、</strong></strong><strong><strong>保证数据完整性</strong></strong></p> 
<p style="margin-left:0pt;">IPSec通过验证算法保证数据从发送方到接收方的传送过程中的任何数据篡改和丢失都可以被检测。</p> 
<p style="margin-left:0pt;"><strong><strong>3、</strong></strong><strong><strong>保证数据机密性</strong></strong></p> 
<p style="margin-left:0pt;">IPSec通过加密算法使只有真正的接收方才能获取真正的发送内容，而他人无法获知数据的真正内容</p> 
<h2 id="3%E3%80%81%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><strong><strong><strong>3、认证方式</strong></strong></strong></h2> 
<h3 id="3.1%E3%80%81%E9%A2%84%E5%85%B1%E4%BA%AB%E5%AF%86%E9%92%A5"><strong><strong><strong>3.1、预共享密钥</strong></strong></strong></h3> 
<p style="margin-left:0pt;">预共享密钥认证是IPSec双方配置时手工指定的密钥，无需在网络中互相告知密钥</p> 
<h3 id="3.2%E3%80%81%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6"><strong><strong><strong>3.2、数字证书</strong></strong></strong></h3> 
<ol><li>响应端发送数字证书到客户端</li><li>发送端收到响应端的数字证书后，会取出附带的数字证书，并读取证书中的发布机构（Issuer），然后从操作系统的受信任证书机构列表中查找该证书办发机构的公钥，如果找不到，说明这个证书颁发机构是个不受信任的，响应端发过来的信息是不安全的。</li><li>使用上一步取到的证书颁发机构的公钥，解出数字证书，得到响应端的用户信息和数字签名</li><li>发送端通过证书中指定的加密算法对响应端的用户信息进行hash加密</li><li>加密后的结果和证书中解出的数字签名进行对比，如果相同，就说明这份用户信息确实是响应端的，也就是说用户信息中包含的公钥确实是响应端的</li><li>后续响应端使用私钥加密数据，发送端使用公钥解密。</li><li>发送端使用公钥加密，响应端使用私钥解密</li></ol> 
<h2 id="4%E3%80%81ESP%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><strong><strong><strong>4、ESP加密算法</strong></strong></strong></h2> 
<h3 id="4.1%E3%80%81ESP%E5%AE%8C%E6%95%B4%E6%80%A7%E6%A3%80%E6%B5%8B"><strong><strong><strong>4.1、ESP完整性检测</strong></strong></strong></h3> 
<p style="margin-left:0pt;">ESP报文最后有一个验证数据字段，数据验证字段包含完整性校验值 (ICV)，也称为消息身份验证码，用于验证消息身份验证与完整性。接收方计算 ICV 值并对照发送方计算的值校验它，以验证完整性。ICV 是通过 ESP 报头、负载数据与 ESP 尾端计算的。</p> 
<h3 id="4.2%E3%80%81ESP%E9%98%B2%E9%87%8D%E6%94%BE"><strong><strong><strong>4.2、ESP防重放</strong></strong></strong></h3> 
<p style="margin-left:0pt;">作为可选功能，ESP还能进行防重放保护。防重放保护验证每个报文是唯一的且没有被复制，这种保护确保黑客不能拦截报文和在数据流中插入改变后的报文。</p> 
<p style="margin-left:0pt;">防重放的工作原理：</p> 
<ol><li>跟踪报文顺序号并在目的端使用一个滑动窗口。当在源和目的间建立了一条连接时，两端的计数器被初始化为0。</li><li>每次有报文发送时，源给报文追加一个顺序号，目的端使用滑动窗口确定预期的顺序号。目的端验证的报文的顺序号不是复制的，并且以正确的顺序被接收。</li></ol> 
<p style="margin-left:0pt;"><strong><strong>例：</strong></strong></p> 
<p style="margin-left:0pt;">1、客户端发送ESP封装报文到服务端，序列号为81</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="118" src="https://images2.imgbox.com/50/05/ifVtUKRb_o.png" width="554"></p> 
<p style="margin-left:0pt;">2、服务端响应报文通过ESP加密，响应报文的序列号为81</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="105" src="https://images2.imgbox.com/d3/a8/bVQMPWfU_o.png" width="554"></p> 
<p style="margin-left:0pt;">3、客户端收到服务端发送的ESP报文后，查看ESP序列号，序列号排序正确则没有重放，排序错误则出现重放。</p> 
<h3 id="4.3%E3%80%81ESP%E9%98%B2%E7%AA%83%E5%90%AC"><strong><strong><strong>4.3、ESP防窃听</strong></strong></strong></h3> 
<p style="margin-left:0pt;">ESP通过3DES、DES、AES机密算法加密数据，做到防窃听功能</p> 
<h2 id="5%E3%80%81IPSec%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><strong><strong><strong>5、IPSec工作原理</strong></strong></strong></h2> 
<p style="margin-left:0pt;">ESP有两种模式：隧道模式和传输模式。</p> 
<p style="margin-left:0pt;">隧道模式将发送的整个数据报文作为一个数据整体来处理，在整段数据前加上新的IP进行传输，不修改原报文。</p> 
<p style="margin-left:0pt;">对于传输模式而言，需要拆解报文，对原报文的数据部分进行处理，加上ESP头部后，再装上原报文的IP部分。</p> 
<h3 id="5.1%E3%80%81%E4%BC%A0%E8%BE%93%E6%A8%A1%E5%BC%8F"><strong><strong><strong>5.1、传输模式</strong></strong></strong></h3> 
<p style="margin-left:0pt;"><strong><strong>ESP处理流程：</strong></strong></p> 
<p style="margin-left:0pt;">1、  将原IP报文的IP头和数据报文部分分离，在数据报文部分的尾部添加ESP尾部。ESP尾部包含：选择的加密算法需要对明文进行填充的数据Padding、填充长度Padding Length、下一头部Next Header标注被加密的数据报文类型，例如TCP协议。</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="110" src="https://images2.imgbox.com/ec/28/yjzgOt89_o.png" width="381"></p> 
<p style="margin-left:0pt;">2、  对第一步得到的整体信息（原数据报文和ESP尾部）进行加密。具体的加密算法以及密钥由SA给出。</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="160" src="https://images2.imgbox.com/2b/18/0YxQciYk_o.png" width="379"></p> 
<p style="margin-left:0pt;">3、对第二步得到的已经加密的信息添加ESP头部(SPI和序列号)，组装成Enchilada。</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="100" src="https://images2.imgbox.com/2d/74/rVVff6TL_o.png" width="351"></p> 
<p style="margin-left:0pt;">4、对第三步得到的Enchilada做摘要，得到完整性度量结果(ICV)，附加在Enchilada尾部</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="142" src="https://images2.imgbox.com/e2/2e/i7TsHFEm_o.png" width="432"></p> 
<p style="margin-left:0pt;">5、在第四步得到的数据前加上原IP头，将原IP头中的Protocol中的值改成50，代表ESP</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="76" src="https://images2.imgbox.com/5a/8a/f38QMZUQ_o.png" width="548"></p> 
<h3 id="5.2%E3%80%81%E9%9A%A7%E9%81%93%E6%A8%A1%E5%BC%8F"><strong><strong><strong>5.2、隧道模式</strong></strong></strong></h3> 
<p style="margin-left:0pt;"><strong><strong>ESP处理流程：</strong></strong></p> 
<p style="margin-left:0pt;">1. 在原IP报文末尾添加尾部(ESP trailer)信息。如上图所示,尾部包含三部分。由所选加密算法可能是块加密,那么当最后一块长度不够时就需要进行填充(padding),附上填充长度(Pad length)方便解包时顺利找出用来填充的那一段数据。而Next header则用来标明被加密的数据报文的类型，例如TCP协议。 </p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="115" src="https://images2.imgbox.com/1c/61/PlJyiIuj_o.png" width="417"></p> 
<p style="margin-left:0pt;">2. 将原IP报文以及第1步得到的ESP尾部作为一个整体进行加密。具体的加密算法与密钥由SA给出。</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="129" src="https://images2.imgbox.com/71/33/RyvASbjw_o.png" width="365"></p> 
<p style="margin-left:0pt;">3. 为第2步得到的加密数据添加ESP头部。如上图所示,ESP头由两部分组成,SPI和序号(Sequence number)。加密数据与ESP头合称为“enchilada”。 </p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="161" src="https://images2.imgbox.com/d4/d4/gNUzzo1A_o.png" width="385"></p> 
<p>4. 附加完整性度量结果(ICV,Integrity check value)。对第三步得到的“enchilada”做摘要,得到一个完整性度量值,并附在ESP报文的尾部。</p> 
<p><img alt="" class="has" height="177" src="https://images2.imgbox.com/10/16/zoAaVatB_o.png" width="496"></p> 
<p>5. 加上新的IP头。新构造的IP头附在ESP报文的前面组成一个新的IP报文。注意这个新的IP头的目的地址跟源地址可以不一样。协议类型为50,说明它里面装的是一个IPsec报文。</p> 
<p><img alt="" class="has" height="85" src="https://images2.imgbox.com/a9/a0/m0kVIyjh_o.png" width="485"></p> 
<ol><li><strong><strong><strong>IPSec协商模式</strong></strong></strong></li></ol> 
<p style="margin-left:0pt;">IPSec建立分为两个阶段，第一接端为IKE协商，第二阶段为IPSec协商。</p> 
<h3 id="6.1%E3%80%81%E4%B8%BB%E5%8A%A8%E6%A8%A1%E5%BC%8F"><strong><strong><strong>6.1、主动模式</strong></strong></strong></h3> 
<h4 id="6.1.1%E3%80%81Ikev1%E5%8D%8F%E5%95%86"><strong><strong><strong>6.1.1、Ikev1协商</strong></strong></strong></h4> 
<p style="margin-left:0pt;">包1：发起端协商SA，使用的是UDP协议，端口号是500，上层协议是ISAKMP，该协议提供的是一个框架，里面的负载Next payload类似模块，可以自由使用。可以看到发起端提供了自己的cookie值，以及SA的加密套件，加密套件主要是加密算法，哈希算法，认证算法，生存时间等。</p> 
<ul><li>Initiator SPI：b0b5887b632a532b</li></ul> 
<p style="margin-left:0pt;">发起者的SPI值，告知响应端主机要使用IPSEC的哪一把密钥来加密这个封包。</p> 
<ul><li>Responder SPI：</li></ul> 
<p style="margin-left:0pt;">响应者的SPI值，第一个包只有发起者没有响应者所以响应者的SPI为空</p> 
<ul><li>Version：1.0</li></ul> 
<p style="margin-left:0pt;">IKE版本号，1.0表示使用ikev1建立连接</p> 
<ul><li>Exchange type:Identity Protection (Main Mode) (2)</li></ul> 
<p style="margin-left:0pt;"> IKE协商模式为主模式</p> 
<ul><li><span style="color:#2e3033;">IKE Attribute (t=12,l=4): Life-Duration: 86400</span></li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">密钥周期86400，密钥周期超过86400后会重新协商IKE</span></p> 
<ul><li><span style="color:#2e3033;">IKE Attribute (t=1,l=2): Encryption-Algorithm: DES-CBC</span></li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">IKE使用DES-CBC加密算法加密数据</span></p> 
<ul><li><span style="color:#2e3033;">IKE Attribute (t=2,l=2): Hash-Algorithm: MD5</span></li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">IKE使用MD5算法校验数据完整性</span></p> 
<ul><li><span style="color:#2e3033;">IKE Attribute (t=3,l=2): Authentication-Method: Pre-shared key</span></li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">使用预共享密钥认证</span></p> 
<ul><li><span style="color:#2e3033;">IKE Attribute (t=4,l=2): Group-Description: Alternate 1024-bit MODP group</span></li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">Diffie-Hellman (DH) 组在密钥交换进程中使用的1024 bit的密钥的强度。</span></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="339" src="https://images2.imgbox.com/f4/2d/RfKmQNLR_o.png" width="554"></p> 
<p style="margin-left:0pt;">包2：响应端收到发送端发送的加密套件后，对比自己是否有相对应的加密套件，如果有就使用和发送端相同的加密套件加密数据，把自己的cookie值和选择好的加密套件发送给发送端；如果没有相同加密套件则IKE建立失败响应。</p> 
<ul><li>Initiator SPI：b0b5887b632a532b</li></ul> 
<p style="margin-left:0pt;">发送端的SPI值，告知响应端主机要使用IPSEC的哪一把密钥来加密这个封包。</p> 
<ul><li>Responder SPI：e5dd838c8d5138b9</li></ul> 
<p style="margin-left:0pt;">响应者的SPI值，告知发送端使用哪一把密钥加密数据包</p> 
<ul><li>Version：1.0</li></ul> 
<p style="margin-left:0pt;">IKE版本号，1.0表示使用ikev1建立连接</p> 
<ul><li>Exchange type:Identity Protection (Main Mode) (2)</li></ul> 
<p style="margin-left:0pt;"> IKE协商模式为主模式</p> 
<ul><li><span style="color:#2e3033;">IKE Attribute (t=12,l=4): Life-Duration: 86400</span></li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">密钥周期86400，密钥周期超过86400后会重新协商IKE</span></p> 
<ul><li><span style="color:#2e3033;">IKE Attribute (t=1,l=2): Encryption-Algorithm: DES-CBC</span></li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">IKE使用DES-CBC加密算法加密数据</span></p> 
<ul><li><span style="color:#2e3033;">IKE Attribute (t=2,l=2): Hash-Algorithm: MD5</span></li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">IKE使用MD5算法校验数据完整性</span></p> 
<ul><li><span style="color:#2e3033;">IKE Attribute (t=3,l=2): Authentication-Method: Pre-shared key</span></li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">使用预共享密钥认证</span></p> 
<ul><li>IKE Attribute (t=4,l=2): Group-Description: Alternate 1024-bit MODP group</li></ul> 
<p style="margin-left:0pt;"><span style="color:#2e3033;">Diffie-Hellman (DH) 组在密钥交换进程中使用的1024 bit的密钥的强度。</span></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="324" src="https://images2.imgbox.com/1a/2a/46syxlWD_o.png" width="553"></p> 
<p style="margin-left:0pt;">包3：发送端生成随机数和DH公共值，包3的主要目的是向响应端发送自己的DH公共值和Nonce随机数。用于生成加密时所需要的KEY值。</p> 
<ul><li>Version：1.0</li></ul> 
<p style="margin-left:0pt;">IKE版本号，1.0表示使用ikev1建立连接</p> 
<ul><li>Exchange type:Identity Protection (Main Mode) (2)</li></ul> 
<p style="margin-left:0pt;"> IKE协商模式为主模式</p> 
<ul><li>Key Exchange Data: aba538345be9d5bfa1dff1e169b2db2a72d3771038f4cc8e...</li></ul> 
<p style="margin-left:0pt;">DH公共值，DH公共值通过Diffie-Hellman算法计算出来；在包1和包2中所协商的算法，它们必须需要一个相同的KEY（即，共享密钥中设置的密码），但同时这个KEY不能在链路中传递。所以，该过程的目的是分别在两个对等体间独立地生成一个DH公共值，然后在报文中发送给对端，对端通过公式计算出相同的KEY值</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="243" src="https://images2.imgbox.com/09/5a/iW7586Jv_o.png" width="554"></p> 
<p style="margin-left:0pt;">包4：响应端收到包3后，自己生成一个随机数，然后通过Diffie-Hellman算法计算出DH公共值，把随机数和DH公共值传输给发送端。</p> 
<ul><li>Version：1.0</li></ul> 
<p style="margin-left:0pt;">IKE版本号，1.0表示使用ikev1建立连接</p> 
<ul><li>Exchange type:Identity Protection (Main Mode) (2)</li></ul> 
<p style="margin-left:0pt;"> IKE协商模式为主模式</p> 
<ul><li>Key Exchange Data：74d204991cd082a20289989380d3b953e1505fc21af6bafc...</li></ul> 
<p style="margin-left:0pt;">DH公共值，用于生成加密时所需要的KEY值</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="207" src="https://images2.imgbox.com/16/2a/VjszCOPW_o.png" width="553"></p> 
<p style="margin-left:0pt;">包5：发起方发起身份验证，报文中带有认证的数据（预共享密钥或者数字签名）。由于包1和包2已经协商好了加密算法，包3和包4协商好了加密的KEY值，所以包5的消息被加密了。</p> 
<ul><li>Version：1.0</li></ul> 
<p style="margin-left:0pt;">IKE版本号，1.0表示使用ikev1建立连接</p> 
<ul><li>Exchange type:Identity Protection (Main Mode) (2)</li></ul> 
<p style="margin-left:0pt;"> IKE协商模式为主模式</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="194" src="https://images2.imgbox.com/e0/d0/XIBBOTiW_o.png" width="554"></p> 
<p style="margin-left:0pt;">包6：响应端回应报文，同样发送认证的数据（预共享密钥或者数字签名），验证对方身份信息。包6的数据同样使用包1、包2协商的算法和包3、包4协商的key值加密数据，所以包6的认证数据是加密的。双方身份验证通过后，IKE协商结束。</p> 
<ul><li>Version：1.0</li></ul> 
<p style="margin-left:0pt;">IKE版本号，1.0表示使用ikev1建立连接</p> 
<ul><li>Exchange type:Identity Protection (Main Mode) (2)</li></ul> 
<p style="margin-left:0pt;"> IKE协商模式为主模式</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="198" src="https://images2.imgbox.com/29/39/DmDS5Gmt_o.png" width="554"></p> 
<h4 id="6.1.2%E3%80%81IPSec%E5%8A%A0%E5%AF%86%E5%8D%8F%E5%95%86"><strong><strong><strong>6.1.2、IPSec加密协商</strong></strong></strong></h4> 
<p style="margin-left:0pt;">包7：发起方主要是进行IPSEC SA的协商，建立安全联盟，报文内容主要是协商用的封装方式以及后面的加密算法以及生存时间和感兴趣流等等。由于数据加密所以无法查看。</p> 
<ul><li>Initiator SPI：b0b5887b632a532b</li></ul> 
<p style="margin-left:0pt;">发起者的SPI值是由上阶段IKE协商时已经确定的，所以IPSec协商依然使用上阶段的SPI</p> 
<ul><li>Responder SPI：e5dd838c8d5138b9</li></ul> 
<p style="margin-left:0pt;">响应者的SPI值是由上阶段IKE协商时已经确定的，所以IPSec协商依然使用上阶段的SPI</p> 
<ul><li>Version：1.0</li></ul> 
<p style="margin-left:0pt;">IKE版本号，1.0表示使用ikev1建立连接</p> 
<ul><li>Exchange type：Quick Mode（32）</li></ul> 
<p style="margin-left:0pt;">交换类型使用快速模式，IPSec协商时只有快速模式</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="230" src="https://images2.imgbox.com/9f/da/ROzw9q60_o.png" width="554"></p> 
<p style="margin-left:0pt;">包8：响应方回包，同意包7发送的封装方式、加密算法、生存时间、感兴趣流等等，同时，也能起到确认收到对端消息的作用。由于数据加密所以无法查看。</p> 
<ul><li>Version：1.0</li></ul> 
<p style="margin-left:0pt;">IKE版本号，1.0表示使用ikev1建立连接</p> 
<ul><li>Exchange type：Quick Mode（32）</li></ul> 
<p style="margin-left:0pt;">交换类型使用快速模式，IPSec协商时只有快速模式</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="219" src="https://images2.imgbox.com/3f/12/1sBMOeUH_o.png" width="554"></p> 
<p style="margin-left:0pt;">包9：发送确认报文。其中包含一个HASH，其作用是确认接收方的消息以及证明发送方处于主动状态（表示发送方的第一条消息不是伪造的）。由于数据加密所以无法查看。</p> 
<ul><li>Version：1.0</li></ul> 
<p style="margin-left:0pt;">IKE版本号，1.0表示使用ikev1建立连接</p> 
<ul><li>Exchange type：Quick Mode（32）</li></ul> 
<p style="margin-left:0pt;">交换类型使用快速模式，IPSec协商时只有快速模式</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="218" src="https://images2.imgbox.com/f6/1b/EK8LRzqD_o.png" width="554"></p> 
<h3 id="6.2%E3%80%81%E9%87%8E%E8%9B%AE%E6%A8%A1%E5%BC%8F"><strong><strong><strong>6.2、野蛮模式</strong></strong></strong></h3> 
<p style="margin-left:0pt;">野蛮模式使用3个报文进行交换加密方式等消息</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="45" src="https://images2.imgbox.com/4d/e4/BRwISvVR_o.png" width="554"></p> 
<ol><li>发起端协商SA，发起端提供了自己的cookie值，以及SA的传输集</li><li>响应端收到后，会将自己的sa协商消息附上签名认证信息后发回给sa的发起者</li><li>发起端发送自己的数字签名认证等信息</li></ol> 
<p style="margin-left:0pt;">野蛮模式无论是共享密钥认证还是证书认证都支持NAT穿越</p> 
<h2 id="7%E3%80%81IPsec%E7%A9%BF%E8%B6%8ANAT"><strong><strong><strong>7、IPsec穿越NAT</strong></strong></strong></h2> 
<h3 id="7.1%E3%80%81IPSec%E7%A9%BF%E8%B6%8ANAT%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><strong><strong><strong>7.1、IPSec穿越NAT遇到的问题</strong></strong></strong></h3> 
<p style="margin-left:0pt;"><strong><strong>1、穿越NAT后的身份确认问题</strong></strong></p> 
<p style="margin-left:0pt;">IPSec VPN中标准身份标识是IP地址，NAT处理过程中会改变IP地址，因此IPSec的身份确认机制必须能够适应IP地址变化；</p> 
<p style="margin-left:0pt;">解决此问题的方法主要有两种：第一种是使用数字证书替代IP地址作为身份标识，第二种是使用字符串取代IP地址作为身份标识。</p> 
<p style="margin-left:0pt;"><strong><strong>2、IP地址复用</strong></strong></p> 
<p style="margin-left:0pt;">IPSec由AH和ESP两个协议组成。</p> 
<p style="margin-left:0pt;">因为AH对数据进行完整性检查，会对包括IP地址在内的整个IP包进行Hash运算。而NAT会改变IP地址，从而破坏AH的Hash值。因此AH报文无法通过NAT网关。</p> 
<p style="margin-left:0pt;">ESP对数据进行完整性检查，不包括外部的IP头，IP地址转换不会破坏ESP的Hash值。但ESP报文中TCP的端口已经加密无法修改，所以对于同时转换端口的NAT来说，ESP没法支持。</p> 
<h3 id="7.2%E3%80%81IKE%E8%BA%AB%E4%BB%BD%E7%A1%AE%E8%AE%A4%E5%8F%8A%E5%8D%8F%E5%95%86"><strong><strong><strong>7.2、IKE身份确认及协商</strong></strong></strong></h3> 
<p style="margin-left:0pt;">IPSec的身份确认最常见是通过IKE协议代劳，IKE支持的身份认证机制有两种：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;">1、数字证书方式，通过CA数字证书体系确认身份，是最为安全、可靠的方式。</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="380" src="https://images2.imgbox.com/8c/e7/Njz9owaH_o.png" width="488"></p> 
<p style="margin-left:0pt;">2、身份标识+预共享密钥方式，通过发起方和响应方预先配置相同的密钥，如bigtree，完成双方对彼此身份的认证，这是最为常见的方式；在预共享秘密钥认证机制中，身份标识则可以分为几类：</p> 
<p style="margin-left:0pt;">a&gt; 指定IP地址，使用IP地址作为身份标识，是IKE的默认方式，响应方只允许指定IP地址发起协商，安全性比较高；</p> 
<p style="margin-left:0pt;"><strong><strong>认证成功：</strong></strong></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="235" src="https://images2.imgbox.com/da/f3/aK1OUnRa_o.png" width="481"></p> 
<p style="margin-left:0pt;"><strong><strong>认证失败：</strong></strong></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="202" src="https://images2.imgbox.com/80/12/jHyHuO56_o.png" width="484"></p> 
<p style="margin-left:0pt;">b&gt; 指定IP地址范围，这种方式依然使用IP地址作为身份标识，由于发起方必须要指定IP地址，否则无法发起协商，指定IP地址范围是响应方特性，如响应方可以指定2.0.0.0/8范围内的地址都可以发起协商，而不是只允许2.1.1.2发起协商，能够减少配置，但安全性略有下降；</p> 
<p style="margin-left:0pt;"><strong><strong>认证成功：</strong></strong></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="225" src="https://images2.imgbox.com/2b/58/aK4PQ6MN_o.png" width="470"></p> 
<p style="margin-left:0pt;"><strong><strong>认证失败：</strong></strong></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="204" src="https://images2.imgbox.com/02/0f/icHY9ZtD_o.png" width="471"></p> 
<p style="margin-left:0pt;">c&gt; 什么都不指定，也是使用IP地址作为身份标识，但允许任意IP地址发起协商，只要预共享密钥一致，双方就能够通过身份确认，这种方式虽然不是非常安全，但是可以简化配置，安全性再次下降；</p> 
<p style="margin-left:0pt;"><strong><strong>认证成功：</strong></strong></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="267" src="https://images2.imgbox.com/a8/21/gaFIrnsa_o.png" width="554"></p> 
<p style="margin-left:0pt;"><strong><strong>认证失败：</strong></strong></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="231" src="https://images2.imgbox.com/4d/80/ayNpo1ih_o.png" width="554"></p> 
<p style="margin-left:0pt;">d&gt; 指定对端名字，发起方和响应方都预先配置好本端名字，使用该名字作为身份标识，与指定IP地址类似，通过指定对端名字方式，即使双方预共享密钥一致，只要对端名字不合法，立即中断协商，由于名字未与IP地址进行绑定，而且名字在网络中明文传递，故安全性不如指定IP地址方式高，但这种身份标识方式可以穿越NAT。</p> 
<p style="margin-left:0pt;"><strong><strong>认证成功：</strong></strong></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="263" src="https://images2.imgbox.com/eb/00/RHtduUdi_o.png" width="554"></p> 
<p style="margin-left:0pt;"><strong><strong>认证失败：</strong></strong></p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="226" src="https://images2.imgbox.com/ed/ee/md0GB4iw_o.png" width="554"></p> 
<h3 id="7.3%E3%80%81%E7%A9%BF%E8%B6%8ANAT%E5%8E%9F%E7%90%86%E6%8A%93%E5%8C%85%E8%A7%A3%E9%87%8A"><strong><strong><strong>7.3、穿越NAT原理抓包解释</strong></strong></strong></h3> 
<p style="margin-left:0pt;">1. 开启NAT穿越时，IKEv1协商第一阶段的前两个消息会发送标识NAT穿越（NAT Traversal，简称NAT-T）能力的Vendor ID载荷（主模式和野蛮模式都是）。用于检查通信双方是否支持NAT-T。</p> 
<p style="margin-left:0pt;"><img alt="" class="has" height="231" src="https://images2.imgbox.com/85/23/5aygLNLw_o.png" width="457"></p> 
<p style="margin-left:0pt;">当双方都在各自的消息中包含了该载荷时，才会进行相关的NAT-T协商。</p> 
<p>2. 主模式消息3和消息4（野蛮模式消息2和消息3）中发送NAT-D（NAT Discovery）载荷。NAT-D载荷用于探测两个要建立IPSec隧道的网关之间是否存在NAT网关以及NAT网关的位置。</p> 
<p><img alt="" class="has" height="197" src="https://images2.imgbox.com/b7/2b/iPqADuDN_o.png" width="554"></p> 
<p style="margin-left:0pt;">通过协商双方向对端发送源和目的的IP地址与端口的Hash值，就可以检测到地址和端口在传输过程中是否发生变化。若果协商双方计算出来的Hash值与它收到的Hash值一样，则表示它们之间没有NAT。否则，则说明传输过程中对IP或端口进行了NAT转换。</p> 
<p style="margin-left:0pt;">第一个NAT-D载荷为对端IP和端口的Hash值，第二个NAT-D载荷为本端IP和端口的Hash值。</p> 
<p>3. 发现NAT网关后，后续ISAKMP消息（主模式从消息5、野蛮模式从消息3开始）的端口号转换为4500。ISAKMP报文标识了“Non-ESP Marker”。</p> 
<p><img alt="" class="has" height="212" src="https://images2.imgbox.com/10/39/tMI29fbd_o.png" width="554"></p> 
<p>4. 在第二阶段会启用NAT穿越协商。在IKE中增加了两种IPSec报文封装模式：UDP封装隧道模式报文（UDP-Encapsulated-Tunnel）和UDP封装传输模式报文（UDP-Encapsulated-Transport）通过为ESP报文封装UDP头，当封装后的报文通过NAT设备时，NAT设备对该报文的外层IP头和增加的UDP头进行地址和端口号转换。UDP报文端口号修改为4500。</p> 
<p><img alt="" class="has" height="93" src="https://images2.imgbox.com/bd/76/V1fjTRNV_o.png" width="554"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2e5d39c1e4ae2bbd4b892f1e79d33575/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">算法 | 单链表的五个常见操作</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7eba29800dc533356468d5a73f49259e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">cuda9.0--cudnn7.1下载地址（百度云）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>