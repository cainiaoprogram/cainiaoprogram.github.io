<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C# 处理内存泄漏问题 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C# 处理内存泄漏问题" />
<meta property="og:description" content="C# 处理内存泄漏问题 背景什么是 CLR？什么是内存泄漏？如何知道产生了内存泄漏？ 调试方法什么是调试器？调试的原理调试示例 内存泄漏检测方法：SOSDumpHeap 背景 参考链接：nvestigating .NET Memory Management and Garbage Collection
在 CLR 中，GC（垃圾收集器，Garbage Collection） 管理一切内存。之所以会有内存泄漏，是因为 GC 不能总是正确的释放内存。本文最后将介绍如何使用 SOS（Son of Strike）来检查内存和对象分配
什么是 CLR？ 参考：CLR
CLR（Common Language Runtime）是公共语言运行时环境
.NET 提供了一个称为公共语言运行时的运行时环境，可以编写利用托管执行环境的代码。 使用面向运行时的语言编译器开发的代码称为托管代码。
简而言之，就是类似于 Java 虚拟机，你写的代码运行在这上面，你申请的内存，释放的内存都由 CLR 进行管理。
托管代码具有许多优点
垃圾回收。性能改进能够轻松使用用其他语言开发的组件类库提供的可扩展类型语言功能，如面向对象的编程的继承、接口和重载允许创建多线程的可缩放应用程序的显式自由线程处理支持结构化异常处理支持自定义特性支持使用委托取代函数指针，从而增强了类型安全和安全性 什么是内存泄漏？ 简单来说，就是在分配内存时，无论出于何种原因，你的程序运行后都不会释放该内存，于是就导致了内存泄漏。 在.NET语言中，您可以通过创建对象来分配内存，并通过允许对该对象的引用出现范围来释放内存。例如：
void MethodName() { Object o = new Object(); //Create a new Object and store a reference to it as o DoSomethingWith(o); //Use the new Object by passing the reference to o o = null; //Lose the reference to the new Object, it is now eligible for freeing } //o is now out of scope so can be freed 当 o 在作用域范围内，GC 可以检查对象是否有任何引用。 如果没有什么引用对象，则可以释放。 如果 DoSomethingWith 方法存储对象 o 的引用，那么当 GC 检查是否正在使用时，仍然会有引用，因此它将无法释放内存。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/61e86a1ad2de2acfc3d3f430b3914791/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-12T19:58:48+08:00" />
<meta property="article:modified_time" content="2023-02-12T19:58:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C# 处理内存泄漏问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>C# 处理内存泄漏问题</h4> 
 <ul><li><a href="#_2" rel="nofollow">背景</a></li><li><ul><li><a href="#_CLR_7" rel="nofollow">什么是 CLR？</a></li><li><a href="#_27" rel="nofollow">什么是内存泄漏？</a></li><li><a href="#_47" rel="nofollow">如何知道产生了内存泄漏？</a></li></ul> 
  </li><li><a href="#_63" rel="nofollow">调试方法</a></li><li><ul><li><a href="#_66" rel="nofollow">什么是调试器？</a></li><li><a href="#_77" rel="nofollow">调试的原理</a></li><li><a href="#_185" rel="nofollow">调试示例</a></li></ul> 
  </li><li><a href="#SOS_234" rel="nofollow">内存泄漏检测方法：SOS</a></li><li><ul><li><a href="#DumpHeap_253" rel="nofollow">DumpHeap</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>背景</h2> 
<p>参考链接：<a href="https://www.red-gate.com/simple-talk/development/dotnet-development/investigating-net-memory-management-and-garbage-collection/" rel="nofollow">nvestigating .NET Memory Management and Garbage Collection</a></p> 
<p>在 CLR 中，GC（垃圾收集器，Garbage Collection） 管理一切内存。之所以会有内存泄漏，是因为 GC 不能总是正确的释放内存。本文最后将介绍如何使用 SOS（Son of Strike）来检查内存和对象分配</p> 
<h3><a id="_CLR_7"></a>什么是 CLR？</h3> 
<p>参考：<a href="https://learn.microsoft.com/zh-cn/dotnet/standard/clr" rel="nofollow">CLR</a></p> 
<p>CLR（Common Language Runtime）是公共语言运行时环境</p> 
<p>.NET 提供了一个称为公共语言运行时的运行时环境，可以编写利用托管执行环境的代码。 使用面向运行时的语言编译器开发的代码称为<strong>托管代码</strong>。</p> 
<blockquote> 
 <p>简而言之，就是类似于 Java 虚拟机，你写的代码运行在这上面，你申请的内存，释放的内存都由 CLR 进行管理。</p> 
</blockquote> 
<p>托管代码具有许多优点</p> 
<ul><li>垃圾回收。</li><li>性能改进</li><li>能够轻松使用用其他语言开发的组件</li><li>类库提供的可扩展类型</li><li>语言功能，如面向对象的编程的继承、接口和重载</li><li>允许创建多线程的可缩放应用程序的显式自由线程处理支持</li><li>结构化异常处理支持</li><li>自定义特性支持</li><li>使用委托取代函数指针，从而增强了类型安全和安全性</li></ul> 
<h3><a id="_27"></a>什么是内存泄漏？</h3> 
<p>简单来说，就是在分配内存时，无论出于何种原因，你的程序运行后都不会释放该内存，于是就导致了内存泄漏。 在.NET语言中，您可以通过创建对象来分配内存，并通过允许对该对象的引用出现范围来释放内存。例如：</p> 
<pre><code class="prism language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Create a new Object and store a reference to it as o</span>
    <span class="token function">DoSomethingWith</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Use the new Object by passing the reference to o</span>
    o <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//Lose the reference to the new Object, it is now eligible for freeing</span>
<span class="token punctuation">}</span>
<span class="token comment">//o is now out of scope so can be freed</span>
</code></pre> 
<p>当 o 在作用域范围内，GC 可以检查对象是否有任何引用。 如果没有什么引用对象，则可以释放。 如果 <code>DoSomethingWith</code> 方法存储对象 o 的引用，那么当 GC 检查是否正在使用时，仍然会有引用，因此它将无法释放内存。</p> 
<p>这里多次提到了<strong>引用</strong>一词， 当新建对象时，实际上不会返回对象，而是对在堆空间中创建的新对象的引用</p> 
<p>只要 <code>DoSomethingWith</code> 不存储对对象的引用，当该对象到达该方法的末尾并超出范围时，引用将丢失，并且垃圾收集器可以释放内存。 因此，在这种情况下，没有内存泄漏</p> 
<h3><a id="_47"></a>如何知道产生了内存泄漏？</h3> 
<p>方法很简单，如果程序有内存泄漏，那么程序运行一段时间后，会捕获 OutofMemory（OOM）异常。 或者使用以下的方法实时监视内存增长情况：</p> 
<pre><code class="prism language-csharp">Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name"><span class="token keyword">string</span></span> memory <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
		<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Process</span> proc <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name"><span class="token keyword">long</span></span> currentMemory <span class="token operator">=</span> proc<span class="token punctuation">.</span>PrivateMemorySize64<span class="token punctuation">;</span>
			memory <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"Memory: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">currentMemory</span><span class="token punctuation">}</span></span><span class="token string"> B"</span></span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_63"></a>调试方法</h2> 
<p>参考链接：<a href="https://www.red-gate.com/simple-talk/development/dotnet-development/net-debugging-dont-give-me-none-of-your-vs/" rel="nofollow">debugging</a></p> 
<h3><a id="_66"></a>什么是调试器？</h3> 
<p>关于调试器：<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/" rel="nofollow">Debugging Tools for Windows (WinDbg, KD, CDB, NTSD)</a></p> 
<p>有两种类型的调试器（debugger）：<strong>内核和用户模式</strong>（kernel 和 user-mode）。内核调试器被用来调试驱动程序和Windows内核。 用户模式调试者用于应用程序和服务。</p> 
<p>本文只讨论用户模式下的 debugger，Windows调试工具包中有两个调试器，下载地址：<a href="https://developer.microsoft.com/zh-cn/windows/downloads/windows-sdk/" rel="nofollow">Windows Debugger</a></p> 
<ul><li>WinDbg：GUI 工具</li><li>cdb：命令行工具</li></ul> 
<p>这两个调试器都提供了对 dbgEng.dll 的封装，即调试的核心方法，它们的调试命令和返回值都是相同的，因此只需选择您喜欢的工具并坚持下去即可。这里推荐CDB。</p> 
<h3><a id="_77"></a>调试的原理</h3> 
<p>.NET 应用程序的编写执行过程如下</p> 
<ol><li>.NET支持多种语言编写：C＃，VB.NET或任何其他符合CLI的语言</li><li>此代码被编译成通用的MSIL格式</li><li>在运行时，将MSIL转换为为对应的CPU架构的二进制文件（JITed），才能执行</li></ol> 
<p>举个列子：</p> 
<p>① .net 代码</p> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"Number: {0}"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>② 编译成 MSIL</p> 
<pre><code class="prism language-c"><span class="token punctuation">.</span>method private hidebysig <span class="token keyword">static</span> <span class="token keyword">void</span>  <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> cil managed  
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Code size       43 (0x2b)</span>
  <span class="token punctuation">.</span>maxstack  <span class="token number">2</span>
  <span class="token punctuation">.</span>locals <span class="token function">init</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> int32 i<span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> bool CS$<span class="token number">4</span>$<span class="token number">0000</span><span class="token punctuation">)</span>
  IL_0000<span class="token operator">:</span>  nop
  IL_0001<span class="token operator">:</span>  ldc<span class="token punctuation">.</span>i4<span class="token punctuation">.</span><span class="token number">0</span>
  IL_0002<span class="token operator">:</span>  stloc<span class="token punctuation">.</span><span class="token number">0</span>
  IL_0003<span class="token operator">:</span>  br<span class="token punctuation">.</span>s       IL_0021
  IL_0005<span class="token operator">:</span>  nop
  IL_0006<span class="token operator">:</span>  ldstr      <span class="token string">"Number: {0}"</span>
  IL_000b<span class="token operator">:</span>  ldloc<span class="token punctuation">.</span><span class="token number">0</span>
  IL_000c<span class="token operator">:</span>  box        <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Int32
  IL_0011<span class="token operator">:</span>  call       string <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>String<span class="token operator">::</span><span class="token function">Format</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span>
                                                              object<span class="token punctuation">)</span>
  IL_0016<span class="token operator">:</span>  call       <span class="token keyword">void</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Console<span class="token operator">::</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>
  IL_001b<span class="token operator">:</span>  nop
  IL_001c<span class="token operator">:</span>  nop
  IL_001d<span class="token operator">:</span>  ldloc<span class="token punctuation">.</span><span class="token number">0</span>
  IL_001e<span class="token operator">:</span>  ldc<span class="token punctuation">.</span>i4<span class="token punctuation">.</span><span class="token number">1</span>
  IL_001f<span class="token operator">:</span>  add
  IL_0020<span class="token operator">:</span>  stloc<span class="token punctuation">.</span><span class="token number">0</span>
  IL_0021<span class="token operator">:</span>  ldloc<span class="token punctuation">.</span><span class="token number">0</span>
  IL_0022<span class="token operator">:</span>  ldc<span class="token punctuation">.</span>i4<span class="token punctuation">.</span>s   <span class="token number">10</span>
  IL_0024<span class="token operator">:</span>  clt
  IL_0026<span class="token operator">:</span>  stloc<span class="token punctuation">.</span><span class="token number">1</span>
  IL_0027<span class="token operator">:</span>  ldloc<span class="token punctuation">.</span><span class="token number">1</span>
  IL_0028<span class="token operator">:</span>  brtrue<span class="token punctuation">.</span>s   IL_0005
  IL_002a<span class="token operator">:</span>  ret
<span class="token punctuation">}</span> <span class="token comment">// end of method Program::DoSomething</span>
</code></pre> 
<p>③ 转换成二进制文件</p> 
<pre><code class="prism language-c"><span class="token number">55</span> <span class="token number">8</span>b ec <span class="token number">83</span> ec <span class="token number">18</span> <span class="token number">83</span> <span class="token number">3</span>d <span class="token number">14</span> <span class="token number">2</span>e <span class="token number">92</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">74</span> <span class="token number">05</span> e8 c5 a3 f4 <span class="token number">76</span> <span class="token number">33</span> d2 <span class="token number">89</span> <span class="token number">55</span><span class="token operator">-</span>fc c7 <span class="token number">45</span> f8 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">90</span> <span class="token number">33</span> d2 <span class="token number">89</span> <span class="token number">55</span> fc <span class="token number">90</span> eb <span class="token number">41</span> <span class="token number">90</span> b9 <span class="token number">38</span> <span class="token number">2</span>b <span class="token number">33</span> <span class="token number">79</span> e8 <span class="token number">40</span> <span class="token number">1f</span> <span class="token number">79</span> fd <span class="token number">89</span> <span class="token number">45</span> f4 <span class="token number">8</span>b <span class="token number">05</span> <span class="token number">30</span> <span class="token number">20</span> fb <span class="token number">01</span> <span class="token number">89</span> <span class="token number">45</span> ec <span class="token number">8</span>b <span class="token number">45</span> f4 <span class="token number">8</span>b <span class="token number">55</span> fc <span class="token number">89</span> <span class="token number">50</span> <span class="token number">04</span> <span class="token number">8</span>b <span class="token number">45</span> f4 <span class="token number">89</span> <span class="token number">45</span> e8 <span class="token number">8</span>b <span class="token number">4</span>d ec <span class="token number">8</span>b <span class="token number">55</span> e8 e8 ee <span class="token number">72</span> <span class="token number">13</span> <span class="token number">76</span> <span class="token number">89</span> <span class="token number">45</span> f0 <span class="token number">8</span>b <span class="token number">4</span>d f0 e8 cb <span class="token number">36</span> <span class="token number">61</span> <span class="token number">76</span> <span class="token number">90</span> <span class="token number">90</span> ff <span class="token number">45</span> fc <span class="token number">83</span> <span class="token number">7</span>d fc <span class="token number">0</span>a <span class="token number">0f</span> <span class="token number">9</span>c c0 <span class="token number">0f</span> b6 c0 <span class="token number">89</span> <span class="token number">45</span> f8 <span class="token number">83</span><span class="token operator">-</span><span class="token number">7</span>d f8 <span class="token number">00</span> <span class="token number">75</span> ac <span class="token number">90</span> <span class="token number">8</span>b e5 <span class="token number">5</span>d c3
</code></pre> 
<p>debugger 会解码字节并显示程序集，如下所示，注意到第二列显示了上述字节</p> 
<pre><code class="prism language-c"><span class="token number">031800</span>a8 <span class="token number">55</span>              push    ebp  
<span class="token number">031800</span>a9 <span class="token number">8</span>bec            mov     ebp<span class="token punctuation">,</span>esp
<span class="token number">031800</span>ab <span class="token number">83</span>ec18          sub     esp<span class="token punctuation">,</span><span class="token number">18</span>h
<span class="token number">031800</span>ae <span class="token number">833</span>d142e920000  cmp     dword ptr ds<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">922E14</span>h<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token number">031800</span>b5 <span class="token number">7405</span>            je      <span class="token number">031800</span>bc
<span class="token number">031800</span>b7 e8c5a3f476      call    mscorwks<span class="token operator">!</span><span class="token function">JIT_DbgIsJustMyCode</span> <span class="token punctuation">(</span><span class="token number">7</span>a0ca481<span class="token punctuation">)</span>
<span class="token number">031800</span>bc <span class="token number">33</span>d2            xor     edx<span class="token punctuation">,</span>edx
<span class="token number">031800</span>be <span class="token number">8955f</span>c          mov     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>edx
<span class="token number">031800</span>c1 c745f800000000  mov     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token number">031800</span>c8 <span class="token number">90</span>              nop
<span class="token number">031800</span>c9 <span class="token number">33</span>d2            xor     edx<span class="token punctuation">,</span>edx
<span class="token number">031800</span>cb <span class="token number">8955f</span>c          mov     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>edx
<span class="token number">031800</span>ce <span class="token number">90</span>              nop
<span class="token number">031800</span>cf eb41            jmp     <span class="token number">03180112</span>
<span class="token number">031800</span>d1 <span class="token number">90</span>              nop
<span class="token number">031800</span>d2 b9382b3379      mov     ecx<span class="token punctuation">,</span>offset mscorlib_ni<span class="token operator">+</span><span class="token number">0x272b38</span> <span class="token punctuation">(</span><span class="token number">79332</span>b38<span class="token punctuation">)</span> <span class="token punctuation">(</span>MT<span class="token operator">:</span> System<span class="token punctuation">.</span>Int32<span class="token punctuation">)</span>
<span class="token number">031800</span>d7 e8401f79fd      call    <span class="token number">0091201</span>c <span class="token punctuation">(</span>JitHelp<span class="token operator">:</span> CORINFO_HELP_NEWSFAST<span class="token punctuation">)</span>
<span class="token number">031800</span>dc <span class="token number">8945f</span><span class="token number">4</span>          mov     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0</span>Ch<span class="token punctuation">]</span><span class="token punctuation">,</span>eax
<span class="token number">031800</span>df <span class="token number">8</span>b053020fb01    mov     eax<span class="token punctuation">,</span>dword ptr ds<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1F</span>B2030h<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">"Number: {0}"</span><span class="token punctuation">)</span>
<span class="token number">031800e5</span> <span class="token number">8945</span>ec          mov     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">14</span>h<span class="token punctuation">]</span><span class="token punctuation">,</span>eax
<span class="token number">031800e8</span> <span class="token number">8</span>b45f4          mov     eax<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0</span>Ch<span class="token punctuation">]</span>
<span class="token number">031800</span>eb <span class="token number">8</span>b55fc          mov     edx<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token number">031800</span>ee <span class="token number">895004</span>          mov     dword ptr <span class="token punctuation">[</span>eax<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>edx
<span class="token number">031800f</span><span class="token number">1</span> <span class="token number">8</span>b45f4          mov     eax<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0</span>Ch<span class="token punctuation">]</span>
<span class="token number">031800f</span><span class="token number">4</span> <span class="token number">8945e8</span>          mov     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">18</span>h<span class="token punctuation">]</span><span class="token punctuation">,</span>eax
<span class="token number">031800f</span><span class="token number">7</span> <span class="token number">8</span>b4dec          mov     ecx<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">14</span>h<span class="token punctuation">]</span>
<span class="token number">031800f</span>a <span class="token number">8</span>b55e8          mov     edx<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">18</span>h<span class="token punctuation">]</span>
<span class="token number">031800f</span>d e8ee721376      call    mscorlib_ni<span class="token operator">+</span><span class="token number">0x1f73f0</span> <span class="token punctuation">(</span><span class="token number">792</span>b73f0<span class="token punctuation">)</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">,</span> mdToken<span class="token operator">:</span> <span class="token number">060001</span>bd<span class="token punctuation">)</span>
<span class="token number">03180102</span> <span class="token number">8945f</span><span class="token number">0</span>          mov     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">10</span>h<span class="token punctuation">]</span><span class="token punctuation">,</span>eax
<span class="token number">03180105</span> <span class="token number">8</span>b4df0          mov     ecx<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">10</span>h<span class="token punctuation">]</span>
<span class="token number">03180108</span> e8cb366176      call    mscorlib_ni<span class="token operator">+</span><span class="token number">0x6d37d8</span> <span class="token punctuation">(</span><span class="token number">797937</span>d8<span class="token punctuation">)</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>String<span class="token punctuation">)</span><span class="token punctuation">,</span> mdToken<span class="token operator">:</span> <span class="token number">060007</span>c8<span class="token punctuation">)</span>
<span class="token number">0318010</span>d <span class="token number">90</span>              nop
<span class="token number">0318010</span>e <span class="token number">90</span>              nop
<span class="token number">0318010f</span> ff45fc          inc     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token number">03180112</span> <span class="token number">837</span>dfc0a        cmp     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span>Ah
<span class="token number">03180116</span> <span class="token number">0f</span><span class="token number">9</span>cc0          setl    al
<span class="token number">03180119</span> <span class="token number">0f</span>b6c0          movzx   eax<span class="token punctuation">,</span>al
<span class="token number">0318011</span>c <span class="token number">8945f</span><span class="token number">8</span>          mov     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>eax
<span class="token number">0318011f</span> <span class="token number">837</span>df800        cmp     dword ptr <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token number">03180123</span> <span class="token number">75</span>ac            jne     <span class="token number">031800</span>d1
<span class="token operator">&lt;</span><span class="token operator">?</span>XML<span class="token operator">:</span>NAMESPACE PREFIX <span class="token operator">=</span> SKYPE <span class="token operator">/</span><span class="token operator">&gt;</span> <span class="token number">03180125</span> <span class="token number">90</span>               nop
<span class="token number">03180126</span> <span class="token number">8</span>be5            mov     esp<span class="token punctuation">,</span>ebp
<span class="token number">03180128</span> <span class="token number">5</span>d              pop     ebp
<span class="token number">03180129</span> c3              ret
</code></pre> 
<p>当使用上述方式进行调试，而不是用 Visual Studio 进行调试时，正在查看的代码不再是编写的 CLI 语言，它已被优化成为CPU可以理解的东西</p> 
<h3><a id="_185"></a>调试示例</h3> 
<p>了解汇编语言的基础知识有助于进行此级别的调试。如下是一个控制台应用程序</p> 
<pre><code class="prism language-csharp"><span class="token keyword">try</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">AppSettingsReader</span> asr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AppSettingsReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> date <span class="token operator">=</span> asr<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token string">"DateFormat"</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">string</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RunCommand</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//HA HA HA No one can hear you scream in here!!!!!!</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>debugger 下载后，安装目录如下所示</p> 
<table><thead><tr><th>类型</th><th>目录</th></tr></thead><tbody><tr><td>安装位置</td><td>C:\Program Files (x86)\Windows Kits\10</td></tr><tr><td>windbg.exe 位置</td><td>C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe</td></tr><tr><td>windbg.exe 位置</td><td>C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\cdb.exe</td></tr></tbody></table> 
<p>我们可以把目录 <code>C:\Program Files (x86)\Windows Kits\10\Debuggers\x64</code> 添加到环境变量中，这样子在新打开的 cmd 窗口中即可直接使用 cdb 或者 windbg 命令</p> 
<h2><a id="SOS_234"></a>内存泄漏检测方法：SOS</h2> 
<p>使用SOS检查内存中的对象很简单。</p> 
<p>命令 1：查找未被引用的对象</p> 
<pre><code>!DumpObject
</code></pre> 
<p>命令 2：检测是否持有某个对象的引用</p> 
<pre><code>!GCRoot
</code></pre> 
<p>命令 3：检查某个对象是否位于内存中</p> 
<pre><code>!DumpHeap
</code></pre> 
<p>检查内存泄露的时候，需要明确两件事情：</p> 
<ol><li>哪些对象正在使用内存</li><li>是什么创造并保持对这些对象的引用</li></ol> 
<h3><a id="DumpHeap_253"></a>DumpHeap</h3> 
<p>DumpHeap 有 2 个参数：</p> 
<ul><li><code>-stat</code>：打开 debugger，并加载 SOS，查找所有的对象并根据类型分组展示，并根据内存总量降序排列</li><li><code>-type</code></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b5f72dca2540de540a4988ede2e67dc9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Flutter Windows端解决应用多次被打开问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d41d205bf9f52dc42f4e6a9dbcd1ff36/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">R语言用加性多元线性回归、随机森林、弹性网络模型预测鲍鱼年龄和可视化</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>