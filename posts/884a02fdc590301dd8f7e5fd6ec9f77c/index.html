<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s——ingress - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s——ingress" />
<meta property="og:description" content="k8s——ingress Ingress简介service的作用外部访问k8s集群内的服务 Ingress组成ingressingress-controller Ingress工作原理部署nginx-ingress-controller部署ingress-controller pod及相关资源修改clusterRole资源配置 ingress暴露服务的方式采用方式二:DaemonSet&#43;HostNetwork&#43;nodeselector指定nginx-ingress-controller运行在node02节点修改Deployment为Daemonset,指定节点运行，并开启 hostNetwork所有node节点上传nginx-ingress-controller镜像压缩包ingree.contro.tar.gz.到/opt/ingress目录，并解压和加载镜像启动nginx-ingress-controller创建ingress规则创建一个deployment和svc创建ingress 做端口映射并访问测试查看nginx-ingress-controller 采用方式三：Deployment&#43;NodePort模式的Service下载nginx-ingress-controller和ingress-nginx暴露端口配置文件在所有node节点上传镜像包ingress-controller-0.30.0.tar到/opt/ingress-nodeport目录，并加载镜像启动nginx-ingress-controller创建deployment、service和ingress的yaml资源做端口映射并访问测试 ingress http代理访问虚拟主机ingress https代理访问创建工作目录创建ssl证书创建secret资源进行存储创建deployment、service和ingress的yaml资源做端口映射并访问测试 nginx进行BasicAuth（访问前输入用户和密码）创建工作目录生成用户密码文件，创建secret资源进行存储创建ingress资源做端口映射并访问测试 nginx进行重写配置说明编写yaml文件做端口映射并访问测试 Ingress简介 service的作用 对集群内部，它不断跟踪pod的变化，更新endpoint中对应pod的对象，提供了ip不断变化的pod的服务发现机制对集群外部，他类似负载均衡器，可以在集群内外部对pod进行访问 外部访问k8s集群内的服务 NodePort:测试环境使用还行，当有几十上百的服务在集群中运行时，NodePort的端口管理就是个灾难LoadBalancer:受限于云平台，且通常在云平台部署LoadBalancer还需要额外的费用Ingress:可以简单理解为service的service，它其实就是一组基于域名和URL路径，把用户的请求转发到一个或多个service的规则 Ingress组成 ingress ingress是一个APr对象，通过yaml文件来配置，ingress对象的作用是定义请求如何转发到service的规则，可以理解为配置模板ingress通过http或https暴露集群内部service，给service提供外部URL、负载均衡、SSL/TLs能力以及基于域名的反向代理。ingress要依靠ingress-controller来具体实现以上功能 ingress-controller ingress-controller是具体实现反向代理及负载均衡的程序，对ingress定义的规则进行解析，根据配置的规则来实现请求转发ingress -controller并不是kes自带的组件，实际上ingress-controller只是一个统称，用户可以选择不同的ingress-controller实现，目前，由k8s维护的ingress-controller只有google云的ccz与ingress-nginx两个，其他还有很多第三方维护的ingres-controller，具体可以参考官方文档。但是不管哪一种ingress-controller，实现的机制都大同小异，只是在具体配置上有差异一般来说，ingress-controller的形式都是一个pod,里面跑着daemon程序和反向代理程序。daemcn负责不断监控集群的变化，根据ingress对象生成配置并应用新配置到反向代理，比如ingress -nginx就是动态生成nginx配置，动态更新upstrea，并在需要的时候reloada程序应用新配置。为了方便，后面的例子都以k8s官方维护的ingress-nginx为例Ingress-Nginx github 地址:https://github.com/kubernetes/ingress-nginx**
Ingress-Nginx官方网站:https:/kubernetes.github.io/ingress-nginx/
5.总结: ingress-controller才是负责具体转发的组件，通过各种方式将它暴露在集群入口，外部对集群的请求流量会先到 Ingress工作原理 ingress-controller通过和 kubernetes APIServer 交互，动态的去感知集群中ingress规则变化然后读取它，按照自定义的规则，规则就是写明了哪个域名对应哪个service，生成一段nginx配置再写到nginx-ingress-controller的pod里，这个ingress-controller的pod里运行着一个nginx服务，控制器会把生成的nginx配置写入/etc/nginx.conf文件中然后reload一下使配置生效。以此达到域名区分配置和动态更新的作用 部署nginx-ingress-controller 部署ingress-controller pod及相关资源 1.mkdir /opt/ingress 2.cd /opt/ingress ========================================================== 官方下载地址： wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.25.0/deploy/static/mandatory.yaml 上面可能无法下载，可用国内的gitee 3.wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.25.0/deploy/static/mandatory.yaml wget https://gitee.com/mirrors/ingress-nginx/raw/nginx-0.30.0/deploy/static/mandatory.yaml #mandatory.yaml文件中包含了很多资源的创建，包括namespace、configMap、role，ServiceAccount等等所有部署ingress-controller需要的资源 修改clusterRole资源配置 vim mandatory.yaml .... - apiGroups: - &#34;&#34; resources: -services verbs: - get - list - watch - apiGroups: - &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/884a02fdc590301dd8f7e5fd6ec9f77c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-13T09:30:42+08:00" />
<meta property="article:modified_time" content="2022-04-13T09:30:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s——ingress</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>k8s——ingress</h4> 
 <ul><li><a href="#Ingress_2" rel="nofollow">Ingress简介</a></li><li><ul><li><a href="#service_4" rel="nofollow">service的作用</a></li><li><a href="#k8s_9" rel="nofollow">外部访问k8s集群内的服务</a></li></ul> 
  </li><li><a href="#Ingress_15" rel="nofollow">Ingress组成</a></li><li><ul><li><a href="#ingress_17" rel="nofollow">ingress</a></li><li><a href="#ingresscontroller_22" rel="nofollow">ingress-controller</a></li></ul> 
  </li><li><a href="#Ingress_31" rel="nofollow">Ingress工作原理</a></li><li><a href="#nginxingresscontroller_38" rel="nofollow">部署nginx-ingress-controller</a></li><li><ul><li><a href="#ingresscontroller_pod_40" rel="nofollow">部署ingress-controller pod及相关资源</a></li><li><a href="#clusterRole_59" rel="nofollow">修改clusterRole资源配置</a></li></ul> 
  </li><li><a href="#ingress_99" rel="nofollow">ingress暴露服务的方式</a></li><li><a href="#DaemonSetHostNetworknodeselector_121" rel="nofollow">采用方式二:DaemonSet+HostNetwork+nodeselector</a></li><li><ul><li><a href="#nginxingresscontrollernode02_123" rel="nofollow">指定nginx-ingress-controller运行在node02节点</a></li><li><a href="#DeploymentDaemonset_hostNetwork_133" rel="nofollow">修改Deployment为Daemonset,指定节点运行，并开启 hostNetwork</a></li><li><a href="#nodenginxingresscontrolleringreecontrotargzoptingress_150" rel="nofollow">所有node节点上传nginx-ingress-controller镜像压缩包ingree.contro.tar.gz.到/opt/ingress目录，并解压和加载镜像</a></li><li><a href="#nginxingresscontroller_161" rel="nofollow">启动nginx-ingress-controller</a></li><li><a href="#ingress_182" rel="nofollow">创建ingress规则</a></li><li><ul><li><a href="#deploymentsvc_184" rel="nofollow">创建一个deployment和svc</a></li><li><a href="#ingress_231" rel="nofollow">创建ingress</a></li></ul> 
   </li><li><a href="#_257" rel="nofollow">做端口映射并访问测试</a></li><li><a href="#nginxingresscontroller_267" rel="nofollow">查看nginx-ingress-controller</a></li></ul> 
  </li><li><a href="#DeploymentNodePortService_279" rel="nofollow">采用方式三：Deployment+NodePort模式的Service</a></li><li><ul><li><a href="#nginxingresscontrolleringressnginx_281" rel="nofollow">下载nginx-ingress-controller和ingress-nginx暴露端口配置文件</a></li><li><a href="#nodeingresscontroller0300taroptingressnodeport_299" rel="nofollow">在所有node节点上传镜像包ingress-controller-0.30.0.tar到/opt/ingress-nodeport目录，并加载镜像</a></li><li><a href="#nginxingresscontroller_311" rel="nofollow">启动nginx-ingress-controller</a></li><li><a href="#deploymentserviceingressyaml_320" rel="nofollow">创建deployment、service和ingress的yaml资源</a></li><li><a href="#_374" rel="nofollow">做端口映射并访问测试</a></li></ul> 
  </li><li><a href="#ingress_http_384" rel="nofollow">ingress http代理访问虚拟主机</a></li><li><a href="#ingress_https_501" rel="nofollow">ingress https代理访问</a></li><li><ul><li><a href="#_503" rel="nofollow">创建工作目录</a></li><li><a href="#ssl_510" rel="nofollow">创建ssl证书</a></li><li><a href="#secret_518" rel="nofollow">创建secret资源进行存储</a></li><li><a href="#deploymentserviceingressyaml_530" rel="nofollow">创建deployment、service和ingress的yaml资源</a></li><li><a href="#_588" rel="nofollow">做端口映射并访问测试</a></li></ul> 
  </li><li><a href="#nginxBasicAuth_599" rel="nofollow">nginx进行BasicAuth（访问前输入用户和密码）</a></li><li><ul><li><a href="#_601" rel="nofollow">创建工作目录</a></li><li><a href="#secret_608" rel="nofollow">生成用户密码文件，创建secret资源进行存储</a></li><li><a href="#ingress_620" rel="nofollow">创建ingress资源</a></li><li><a href="#_654" rel="nofollow">做端口映射并访问测试</a></li></ul> 
  </li><li><a href="#nginx_665" rel="nofollow">nginx进行重写</a></li><li><ul><li><a href="#_667" rel="nofollow">配置说明</a></li><li><a href="#yaml_675" rel="nofollow">编写yaml文件</a></li><li><a href="#_702" rel="nofollow">做端口映射并访问测试</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Ingress_2"></a>Ingress简介</h2> 
<h3><a id="service_4"></a>service的作用</h3> 
<ol><li>对集群内部，它不断跟踪pod的变化，更新endpoint中对应pod的对象，提供了ip不断变化的pod的服务发现机制</li><li>对集群外部，他类似负载均衡器，可以在集群内外部对pod进行访问</li></ol> 
<h3><a id="k8s_9"></a>外部访问k8s集群内的服务</h3> 
<ol><li>NodePort:测试环境使用还行，当有几十上百的服务在集群中运行时，NodePort的端口管理就是个灾难</li><li>LoadBalancer:受限于云平台，且通常在云平台部署LoadBalancer还需要额外的费用</li><li>Ingress:可以简单理解为service的service，它其实就是一组基于域名和URL路径，把用户的请求转发到一个或多个service的规则</li></ol> 
<h2><a id="Ingress_15"></a>Ingress组成</h2> 
<h3><a id="ingress_17"></a>ingress</h3> 
<ol><li>ingress是一个APr对象，通过yaml文件来配置，ingress对象的作用是定义请求如何转发到service的规则，可以理解为配置模板</li><li>ingress通过http或https暴露集群内部service，给service提供外部URL、负载均衡、SSL/TLs能力以及基于域名的反向代理。ingress要依靠ingress-controller来具体实现以上功能</li></ol> 
<h3><a id="ingresscontroller_22"></a>ingress-controller</h3> 
<ol><li>ingress-controller是具体实现反向代理及负载均衡的程序，对ingress定义的规则进行解析，根据配置的规则来实现请求转发</li><li>ingress -controller并不是kes自带的组件，实际上ingress-controller只是一个统称，用户可以选择不同的ingress-controller实现，目前，由k8s维护的ingress-controller只有google云的ccz与ingress-nginx两个，其他还有很多第三方维护的ingres-controller，具体可以参考官方文档。但是不管哪一种ingress-controller，实现的机制都大同小异，只是在具体配置上有差异</li><li>一般来说，ingress-controller的形式都是一个pod,里面跑着daemon程序和反向代理程序。daemcn负责不断监控集群的变化，根据ingress对象生成配置并应用新配置到反向代理，比如ingress -nginx就是动态生成nginx配置，动态更新upstrea，并在需要的时候reloada程序应用新配置。为了方便，后面的例子都以k8s官方维护的ingress-nginx为例</li><li>Ingress-Nginx github 地址:https://github.com/kubernetes/ingress-nginx**<br> <strong>Ingress-Nginx官方网站:https:/kubernetes.github.io/ingress-nginx/</strong><br> <strong>5.总结: ingress-controller才是负责具体转发的组件，通过各种方式将它暴露在集群入口，外部对集群的请求流量会先到</strong></li></ol> 
<h2><a id="Ingress_31"></a>Ingress工作原理</h2> 
<ol><li>ingress-controller通过和 kubernetes APIServer 交互，动态的去感知集群中ingress规则变化</li><li>然后读取它，按照自定义的规则，规则就是写明了哪个域名对应哪个service，生成一段nginx配置</li><li>再写到nginx-ingress-controller的pod里，这个ingress-controller的pod里运行着一个nginx服务，控制器会把生成的nginx配置写入/etc/nginx.conf文件中</li><li>然后reload一下使配置生效。以此达到域名区分配置和动态更新的作用</li></ol> 
<h2><a id="nginxingresscontroller_38"></a>部署nginx-ingress-controller</h2> 
<h3><a id="ingresscontroller_pod_40"></a>部署ingress-controller pod及相关资源</h3> 
<pre><code class="prism language-ruby"><span class="token number">1.</span>mkdir <span class="token operator">/</span>opt<span class="token operator">/</span>ingress
<span class="token number">2.</span>cd <span class="token operator">/</span>opt<span class="token operator">/</span>ingress
<span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">=</span>
官方下载地址：
wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>ingress<span class="token operator">-</span>nginx<span class="token operator">/</span>nginx<span class="token operator">-</span><span class="token number">0.25</span><span class="token number">.0</span><span class="token operator">/</span>deploy<span class="token operator">/</span>static<span class="token operator">/</span>mandatory<span class="token punctuation">.</span>yaml

上面可能无法下载，可用国内的gitee
<span class="token number">3.</span>wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>mirrors<span class="token operator">/</span>ingress<span class="token operator">-</span>nginx<span class="token operator">/</span>raw<span class="token operator">/</span>nginx<span class="token operator">-</span><span class="token number">0.25</span><span class="token number">.0</span><span class="token operator">/</span>deploy<span class="token operator">/</span>static<span class="token operator">/</span>mandatory<span class="token punctuation">.</span>yaml

wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>mirrors<span class="token operator">/</span>ingress<span class="token operator">-</span>nginx<span class="token operator">/</span>raw<span class="token operator">/</span>nginx<span class="token operator">-</span><span class="token number">0.30</span><span class="token number">.0</span><span class="token operator">/</span>deploy<span class="token operator">/</span>static<span class="token operator">/</span>mandatory<span class="token punctuation">.</span>yaml

<span class="token comment">#mandatory.yaml文件中包含了很多资源的创建，包括namespace、configMap、role，ServiceAccount等等所有部署ingress-controller需要的资源</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/22/8PGKodUA_o.png" alt="img"></p> 
<h3><a id="clusterRole_59"></a>修改clusterRole资源配置</h3> 
<pre><code class="prism language-yaml">vim mandatory.yaml
<span class="token punctuation">...</span>.
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span>services
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> get
    <span class="token punctuation">-</span> list
    <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"extensions"</span>
    <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span><span class="token comment">#增加（0.25版本）</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ingresses
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> get
    <span class="token punctuation">-</span> list
    <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> events
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> create
    <span class="token punctuation">-</span> patch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"extensions"</span>
    <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span><span class="token comment">#增加（o.25版本)</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ingresses/ status
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> update
</code></pre> 
<p><img src="https://images2.imgbox.com/b2/8d/Tkt8YgUm_o.png" alt="img"></p> 
<h2><a id="ingress_99"></a>ingress暴露服务的方式</h2> 
<ol><li>Deployment+LoadBalancer模式的Service</li></ol> 
<pre><code class="prism language-haskell">如果要把<span class="token hvariable">ingress</span>部署在公有云，那用这种方式比较合适。用<span class="token constant">Deployment</span>部署<span class="token hvariable">ingress</span><span class="token operator">-</span><span class="token hvariable">controller</span>，创建一个<span class="token keyword">type</span>为 <span class="token constant">LoadBalancer</span>的 <span class="token hvariable">service</span>关联这组<span class="token hvariable">pod</span>。大部分公有云，都会为 <span class="token constant">LoadBalancer</span>的 <span class="token hvariable">service</span>自动创建一个负载均衡器，通常还绑定了公网地址。只要把域名解析指向该地址，就实现了集群服务的对外暴露
</code></pre> 
<ol start="2"><li>DaemonSet+HostNetwork+nodeselector</li></ol> 
<pre><code class="prism language-undefined">用DaemonSet结合nodeselector来部署ingress-controller到特定的node 上，然后使用Hostiletwork直接把该pod与宿主机node的网络打通，直接使用宿主机的80/433端口就能访问服务。这时，ingress-controller所在的node机器就很类似传统架构的边缘节点，比如机房入口的nginx服务器。该方式整个请求链路最简单，性能相对NodePort模式更好。缺点是由于直接利用宿主机节点的网络和端口，一个node只能部署一个ingress-controller pod。比较适合大并发的生产环境使用
</code></pre> 
<ol start="3"><li>Deployment+NodePort模式的Service</li></ol> 
<pre><code class="prism language-armasm">1)同样用deployment模式部署ingres-controller，并创建对应的服务，但是type为NodePort。这样，ingress就会暴露在集群节点ip的特定端口上
2)由于nodeport暴露的端口是随机端口，一般会在前面再搭建一套负载均衡器来转发请求。该方式一般用于宿主机是相对固定的环境ip地址不变的场景
3)NodePort方式暴露ingress虽然简单方便，但是NodePort多了一层NAT，在请求量级很大时可能对性能会有一定影响
</code></pre> 
<h2><a id="DaemonSetHostNetworknodeselector_121"></a>采用方式二:DaemonSet+HostNetwork+nodeselector</h2> 
<h3><a id="nginxingresscontrollernode02_123"></a>指定nginx-ingress-controller运行在node02节点</h3> 
<pre><code class="prism language-sql">kubectl label node node02 ingress<span class="token operator">=</span><span class="token boolean">true</span>

kubectl get nodes <span class="token comment">--show-labels</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f9/73/U1q1yeSD_o.png" alt="img"></p> 
<h3><a id="DeploymentDaemonset_hostNetwork_133"></a>修改Deployment为Daemonset,指定节点运行，并开启 hostNetwork</h3> 
<pre><code class="prism language-yaml">vim mandatory.yaml
<span class="token punctuation">...</span>
<span class="token key atrule">apiversion</span><span class="token punctuation">:</span> apps/vl
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Daemonset   <span class="token comment">#修改kind</span>
<span class="token punctuation">...</span>
<span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment">#使用主机网络</span>
<span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span> <span class="token string">"true"</span>   <span class="token comment">#选择节点运行</span>
<span class="token punctuation">...</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b0/50/3JCKI1ca_o.png" alt="img"><br> <img src="https://images2.imgbox.com/44/3e/IYDiO2IU_o.png" alt="img"></p> 
<h3><a id="nodenginxingresscontrolleringreecontrotargzoptingress_150"></a>所有node节点上传nginx-ingress-controller镜像压缩包ingree.contro.tar.gz.到/opt/ingress目录，并解压和加载镜像</h3> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> /opt/ingress
<span class="token builtin class-name">cd</span> /opt/ingress
<span class="token function">tar</span> zxvf ingree.contro.tar.gz
<span class="token function">docker</span> load -i ingree.contro.tar
</code></pre> 
<p><img src="https://images2.imgbox.com/39/2c/w9H8c14M_o.png" alt="img"></p> 
<h3><a id="nginxingresscontroller_161"></a>启动nginx-ingress-controller</h3> 
<pre><code class="prism language-csharp"><span class="token preprocessor property">#主节点</span>
kubectl apply <span class="token operator">-</span>f mandatory<span class="token punctuation">.</span>yaml

kubectl <span class="token keyword">get</span> pod <span class="token operator">-</span>n ingress<span class="token operator">-</span>nginx <span class="token operator">-</span>o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/26/70/ZJzRj4Fh_o.png" alt="img"></p> 
<pre><code class="prism language-markdown">到node02节点查看
netstat -natp | grep nginx
==========================================================
由于配置了hostnetwork， nginx已经在 node主机本地监听团/443/8181端口。其中 8181 是nginx-controller默认配置的一个defaultbackend (Ingress资源没有匹配的 rule 对象时，流量就会被导向这个default backend)
这样，只要访问 node主机有公网 TP，就可以直接映射域名来对外网暴露服务了。如果要nginx高可用的话，可以在多个node39上部署，并在前面再搭建一套LVS+keepalive做负载均衡。
</code></pre> 
<p><img src="https://images2.imgbox.com/c6/e7/fO3ly3lU_o.png" alt="img"></p> 
<h3><a id="ingress_182"></a>创建ingress规则</h3> 
<h4><a id="deploymentsvc_184"></a>创建一个deployment和svc</h4> 
<pre><code class="prism language-yaml">在主节点创建
vim service<span class="token punctuation">-</span>nginx.yaml
==========================================================
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>app
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>app
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>app
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span> <span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span> <span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7777</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span> <span class="token punctuation">:</span>
   <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
==========================================================
kubectl apply <span class="token punctuation">-</span>f service<span class="token punctuation">-</span>nginx.yaml

kubectl get pod<span class="token punctuation">,</span>svc
</code></pre> 
<p><img src="https://images2.imgbox.com/51/f2/bKvVymM3_o.png" alt="img"></p> 
<h4><a id="ingress_231"></a>创建ingress</h4> 
<pre><code class="prism language-yaml">vim ingress<span class="token punctuation">-</span>1.yaml
==========================================================
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> www.gxd.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service  <span class="token comment">#指定你创建的svc的名称</span>
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
==========================================================
kubectl apply <span class="token punctuation">-</span>f ingress<span class="token punctuation">-</span>1.yaml

kubectl get pod<span class="token punctuation">,</span>svc<span class="token punctuation">,</span>ingress
</code></pre> 
<p><img src="https://images2.imgbox.com/5a/20/dq741Vuh_o.png" alt="img"></p> 
<h3><a id="_257"></a>做端口映射并访问测试</h3> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'192.168.10.30 www.gxd.com'</span> <span class="token operator">&gt;&gt;</span> /etc/hosts

<span class="token function">curl</span> www.gxd.com
</code></pre> 
<p><img src="https://images2.imgbox.com/1d/aa/cadYHTMk_o.png" alt="img"></p> 
<h3><a id="nginxingresscontroller_267"></a>查看nginx-ingress-controller</h3> 
<pre><code class="prism language-sql">kubectl get pod <span class="token operator">-</span>n ingress<span class="token operator">-</span>nginx <span class="token operator">-</span>o wide

kubectl <span class="token keyword">exec</span> <span class="token operator">-</span>it nginx<span class="token operator">-</span>ingress<span class="token operator">-</span>controller<span class="token operator">-</span>k5vvf  <span class="token operator">-</span>n ingress<span class="token operator">-</span>nginx bash
</code></pre> 
<p><img src="https://images2.imgbox.com/df/a7/9n2g55kd_o.png" alt="img"><br> <img src="https://images2.imgbox.com/c7/05/vwg3RUk5_o.png" alt="img"><br> <img src="https://images2.imgbox.com/56/bd/ZjA760bm_o.png" alt="img"></p> 
<h2><a id="DeploymentNodePortService_279"></a>采用方式三：Deployment+NodePort模式的Service</h2> 
<h3><a id="nginxingresscontrolleringressnginx_281"></a>下载nginx-ingress-controller和ingress-nginx暴露端口配置文件</h3> 
<pre><code class="prism language-ruby">在主节点
mkdir <span class="token operator">/</span>opt<span class="token operator">/</span>ingress<span class="token operator">-</span>nodeport
cd <span class="token operator">/</span>opt<span class="token operator">/</span>ingress<span class="token operator">-</span>nodeport

官方下载地址：
wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>ingress<span class="token operator">-</span>nginx<span class="token operator">/</span>nginx<span class="token operator">-</span><span class="token number">0.30</span><span class="token number">.0</span><span class="token operator">/</span>deploy<span class="token operator">/</span>static<span class="token operator">/</span>mandatory<span class="token punctuation">.</span>yaml
wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>ingress<span class="token operator">-</span>nginx<span class="token operator">/</span>nginx<span class="token operator">-</span><span class="token number">0.30</span><span class="token number">.0</span><span class="token operator">/</span>deploy<span class="token operator">/</span>static<span class="token operator">/</span>provider<span class="token operator">/</span>baremetal<span class="token operator">/</span>service<span class="token operator">-</span>nodeport<span class="token punctuation">.</span>yaml

国内 gitee 资源地址：
wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>mirrors<span class="token operator">/</span>ingress<span class="token operator">-</span>nginx<span class="token operator">/</span>raw<span class="token operator">/</span>nginx<span class="token operator">-</span><span class="token number">0.30</span><span class="token number">.0</span><span class="token operator">/</span>deploy<span class="token operator">/</span>static<span class="token operator">/</span>mandatory<span class="token punctuation">.</span>yaml
wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>mirrors<span class="token operator">/</span>ingress<span class="token operator">-</span>nginx<span class="token operator">/</span>raw<span class="token operator">/</span>nginx<span class="token operator">-</span><span class="token number">0.30</span><span class="token number">.0</span><span class="token operator">/</span>deploy<span class="token operator">/</span>static<span class="token operator">/</span>provider<span class="token operator">/</span>baremetal<span class="token operator">/</span>service<span class="token operator">-</span>nodeport<span class="token punctuation">.</span>yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/d0/0c/Bx7b9fVj_o.png" alt="img"></p> 
<h3><a id="nodeingresscontroller0300taroptingressnodeport_299"></a>在所有node节点上传镜像包ingress-controller-0.30.0.tar到/opt/ingress-nodeport目录，并加载镜像</h3> 
<pre><code class="prism language-bash">在所有node节点
<span class="token function">mkdir</span> /opt/ingress-nodeport
<span class="token builtin class-name">cd</span> /opt/ingress-nodeport
<span class="token function">tar</span> zxvf ingree.contro-0.30.0.tar.gz
<span class="token function">docker</span> load -i ingree.contro-0.30.0.tar
</code></pre> 
<p><img src="https://images2.imgbox.com/c4/f9/d37Jqyp2_o.png" alt="img"></p> 
<h3><a id="nginxingresscontroller_311"></a>启动nginx-ingress-controller</h3> 
<pre><code class="prism language-powershell">kubectl apply <span class="token operator">-</span>f mandatory<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f service-nodeport<span class="token punctuation">.</span>yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/0d/e9/R5FZsLls_o.png" alt="img"></p> 
<h3><a id="deploymentserviceingressyaml_320"></a>创建deployment、service和ingress的yaml资源</h3> 
<pre><code class="prism language-yaml">vim ingress<span class="token punctuation">-</span>nginx.yaml 
==========================================================
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>app
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> www.gxd111.com
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
          <span class="token key atrule">backend</span><span class="token punctuation">:</span>
            <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
            <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
==========================================================kubectl apply <span class="token punctuation">-</span>f ingress<span class="token punctuation">-</span>nginx.yaml                       
kubectl get pod<span class="token punctuation">,</span>svc<span class="token punctuation">,</span>ingress <span class="token punctuation">-</span>owide
</code></pre> 
<p><img src="https://images2.imgbox.com/1b/18/bMpqySjJ_o.png" alt="img"></p> 
<h3><a id="_374"></a>做端口映射并访问测试</h3> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'192.168.10.30 www.gxd111.com'</span> <span class="token operator">&gt;&gt;</span> /etc/hosts

<span class="token function">curl</span> www.gxd111.com
</code></pre> 
<p><img src="https://images2.imgbox.com/81/c3/bwv3tYZf_o.png" alt="img"></p> 
<h2><a id="ingress_http_384"></a>ingress http代理访问虚拟主机</h2> 
<pre><code class="prism language-yaml">mkdir /opt/ingress<span class="token punctuation">-</span>nodeport/vhost
cd /opt/ingress<span class="token punctuation">-</span>nodeport/vhost
==========================================================
<span class="token comment">#创建虚拟主机1资源</span>
vim demo1.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deployment1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx1
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span><span class="token number">1</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx1
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
==========================================================
<span class="token comment">#创建虚拟主机2资源</span>
vim demo2.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deployment2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx2
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx2
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span><span class="token number">2</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx2
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
==========================================================
创建ingress资源
vim ingress<span class="token punctuation">-</span>nginx.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> www1.gxd.com
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
          <span class="token key atrule">backend</span><span class="token punctuation">:</span>
            <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span><span class="token number">1</span>
            <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> www2.gxd.com
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
          <span class="token key atrule">backend</span><span class="token punctuation">:</span>
            <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span><span class="token number">2</span>
            <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
==========================================================
kubectl apply <span class="token punctuation">-</span>f demo1.yaml
kubectl apply <span class="token punctuation">-</span>f demo2.yaml
kubectl apply <span class="token punctuation">-</span>f ingress<span class="token punctuation">-</span>nginx.yaml
kubectl get pod<span class="token punctuation">,</span>svc<span class="token punctuation">,</span>ingress
</code></pre> 
<p><img src="https://images2.imgbox.com/be/d7/85pbAOft_o.png" alt="img"></p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'192.168.10.30 www1.gxd.com '</span> <span class="token operator">&gt;&gt;</span> /etc/hosts
<span class="token builtin class-name">echo</span> <span class="token string">'192.168.10.30 www2.gxd.com '</span> <span class="token operator">&gt;&gt;</span> /etc/hosts
<span class="token function">curl</span> www1.gxd.com:31396
<span class="token function">curl</span> www2.gxd.com:31396
</code></pre> 
<p><img src="https://images2.imgbox.com/90/c7/2IKEM8Dv_o.png" alt="img"></p> 
<h2><a id="ingress_https_501"></a>ingress https代理访问</h2> 
<h3><a id="_503"></a>创建工作目录</h3> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> /opt/ingress-nodeport/https
<span class="token builtin class-name">cd</span> /opt/ingress-nodeport/https
</code></pre> 
<h3><a id="ssl_510"></a>创建ssl证书</h3> 
<pre><code class="prism language-mipsasm">openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj  "/CN=nginXsvc/O=nginxsvc"
</code></pre> 
<p><img src="https://images2.imgbox.com/3c/22/m4DWA6Ww_o.png" alt="img"></p> 
<h3><a id="secret_518"></a>创建secret资源进行存储</h3> 
<pre><code class="prism language-sql">kubectl <span class="token keyword">create</span> secret tls tls<span class="token operator">-</span>secret <span class="token comment">--key tls.key --cert tls.crt</span>

kubectl get secret

kubectl <span class="token keyword">describe</span> secret tls<span class="token operator">-</span>secret
</code></pre> 
<p><img src="https://images2.imgbox.com/1e/e5/PX71WMF5_o.png" alt="img"></p> 
<h3><a id="deploymentserviceingressyaml_530"></a>创建deployment、service和ingress的yaml资源</h3> 
<pre><code class="prism language-yaml">vim demo3.yaml 
==========================================================
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>app
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span><span class="token number">3</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress3
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> www.gxd222.com
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>secret
  <span class="token key atrule">rules</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> www.gxd222.com
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
          <span class="token key atrule">backend</span><span class="token punctuation">:</span>
            <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span><span class="token number">3</span>
            <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
==========================================================kubectl apply <span class="token punctuation">-</span>f demo3.yaml                       
kubectl get pod<span class="token punctuation">,</span>svc<span class="token punctuation">,</span>ingress 
</code></pre> 
<p><img src="https://images2.imgbox.com/09/71/YohBSTGi_o.png" alt="img"></p> 
<h3><a id="_588"></a>做端口映射并访问测试</h3> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'192.168.10.30 www.gxd222.com'</span> <span class="token operator">&gt;&gt;</span> /etc/hosts

在浏览器访问 https://www.gxd222.com:31067
点击高级选项，确认安全例外即可
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/14/aOUgYPP8_o.png" alt="img"></p> 
<h2><a id="nginxBasicAuth_599"></a>nginx进行BasicAuth（访问前输入用户和密码）</h2> 
<h3><a id="_601"></a>创建工作目录</h3> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> /opt/ingress-nodeport/basic-auth
<span class="token builtin class-name">cd</span> /opt/ingress-nodeport/basic-auth
</code></pre> 
<h3><a id="secret_608"></a>生成用户密码文件，创建secret资源进行存储</h3> 
<pre><code class="prism language-sql">yum install <span class="token operator">-</span>y httpd
htpasswd <span class="token operator">-</span>c auth gxd
kubectl <span class="token keyword">create</span> secret generic basic<span class="token operator">-</span>auth <span class="token comment">--from-file=auth</span>
kubectl get secret
kubectl <span class="token keyword">describe</span> secret basic<span class="token operator">-</span>auth
</code></pre> 
<p><img src="https://images2.imgbox.com/97/21/yz3Ki1yw_o.png" alt="img"></p> 
<h3><a id="ingress_620"></a>创建ingress资源</h3> 
<pre><code class="prism language-yaml">//具体详细设置方法可参考官网https<span class="token punctuation">:</span>//kubernetes.github.io/ingress<span class="token punctuation">-</span>nginx/examples/auth/basic/

vim ingress<span class="token punctuation">-</span>auth.yaml
==========================================================
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>auth
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token comment">#设置认证类型basic</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-type</span><span class="token punctuation">:</span> basic
    <span class="token comment">#设置secret资源名称basic-auth</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-secret</span><span class="token punctuation">:</span> basic<span class="token punctuation">-</span>auth
    <span class="token comment">#设置认证窗口提示信息</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-realm</span><span class="token punctuation">:</span> <span class="token string">'Authentication Required - gxd'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> auth.gxd.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span><span class="token number">2</span>  <span class="token comment">#之前指定创建过的svc</span>
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
==========================================================
kubectl apply <span class="token punctuation">-</span>f ingress<span class="token punctuation">-</span>auth.yaml 
kubectl get ingress
</code></pre> 
<p><img src="https://images2.imgbox.com/f9/34/lUEd9nNe_o.png" alt="img"></p> 
<h3><a id="_654"></a>做端口映射并访问测试</h3> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'192.168.10.30 auth.gxd.com'</span> <span class="token operator">&gt;&gt;</span> /etc/hosts

在浏览器访问 http://auth.gxd.com:31396
</code></pre> 
<p><img src="https://images2.imgbox.com/99/2b/j02AeDkc_o.png" alt="img"><br> <img src="https://images2.imgbox.com/e6/b4/dKqn8gRy_o.png" alt="img"></p> 
<h2><a id="nginx_665"></a>nginx进行重写</h2> 
<h3><a id="_667"></a>配置说明</h3> 
<pre><code class="prism language-bash">nginx.ingress.kubernetes.io/rewrite-target:<span class="token operator">&lt;</span>字符串<span class="token operator">&gt;</span><span class="token comment">#必须重定向流量的目标URI</span>
nginx.ingress <span class="token builtin class-name">.</span> kubernetes.io/ssl-redirect:<span class="token operator">&lt;</span>布尔值<span class="token operator">&gt;</span>指示位置部分是否仅可访问sSL<span class="token punctuation">(</span>当Ingress包含证书时，默认为true<span class="token punctuation">)</span>nginx.ingress <span class="token builtin class-name">.</span> kubernetes.io/force-ssl-redirect:<span class="token operator">&lt;</span>布尔值<span class="token operator">&gt;</span><span class="token comment">#即使Ingress未启用rLS，也强制重定向到HTTPS</span>
nginx.ingress .kubernetes.io/app-root:<span class="token operator">&lt;</span>字符串<span class="token operator">&gt;</span><span class="token comment">#定义controller必须重定向的应用程序根，如果它在'/'上下文中·nginx.ingress, kubernetes.io/use-regex:&lt;布尔值&gt;#指示Ingress.上定义的路径是否使用正则表达式</span>
</code></pre> 
<h3><a id="yaml_675"></a>编写yaml文件</h3> 
<pre><code class="prism language-yaml">vim ingress<span class="token punctuation">-</span>rewrite.yaml
==========================================================
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>rewrite
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//auth.gxd.com<span class="token punctuation">:</span><span class="token number">31396</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> rewrite.gxd.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> ggggg  <span class="token comment">#由于rewrite.gxd.com只是用于跳转不需要真实站点存在，因此svc资源名称可随意定义</span>
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">1111</span> 
==========================================================
kubectl apply <span class="token punctuation">-</span>f ingress<span class="token punctuation">-</span>rewrite.yaml
kubectl get ingress
</code></pre> 
<p><img src="https://images2.imgbox.com/ec/3c/DZElOMsY_o.png" alt="img"></p> 
<h3><a id="_702"></a>做端口映射并访问测试</h3> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'192.168.10.30 rewrite.gxd.com'</span> <span class="token operator">&gt;&gt;</span> /etc/hosts

在浏览器访问 http://rewrite.gxd.com
</code></pre> 
<p><img src="https://images2.imgbox.com/ff/95/vxPh7IRQ_o.png" alt="img"><br> <img src="https://images2.imgbox.com/73/4f/bjDyBttI_o.png" alt="img"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8f80633849489feca1445e50e17c3ecd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">k8s——污点、容忍&#43;3个存储卷（emptyDir、hostpath和nfs）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/44eba8a60bc994155e95d47175b8a41a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【数据结构】单链表的创建、插入、删除及合并</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>