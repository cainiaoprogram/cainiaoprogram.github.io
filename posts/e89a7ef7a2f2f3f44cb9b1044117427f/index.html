<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>rest_framework_django学习笔记三(异常、登录认证) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="rest_framework_django学习笔记三(异常、登录认证)" />
<meta property="og:description" content="rest_framework_django学习笔记三(异常、登录认证) 一、异常 REST framework 定义的异常
异常名称说明APIException所有异常的父类ParseError解析错误AuthenticationFailed认证失败NotAuthenticated尚未认证PermissionDenied权限拒绝NotFound未找到MethodNotAllowed请求方式不支持NotAcceptable要获取的数据格式不支持Throttled超过限流次数ValidationError校验失败 1、自定义异常 REST framework 提供了异常处理，我们可以自定义异常处理函数
from rest_framework.views import exception_handler def custom_exception_handler(exc,context): # 先调用 REST framework 默认的异常处理方法获得标准错误响应对象 response = exception_handler(exc,context) # 补充自定义的异常处理 if response is not None: response.data[&#39;status_code&#39;] = response.status_code return response 在配置文件中声明自定义的异常处理
REST_FRAMEWORK = { &#34;EXCEPTION_HANDLER&#34;: &#34;demo_app.utils.custom_exception_handler&#34;, # 自定义的异常处理 } 2、补充异常处理 from rest_framework import status from django.db import DatabaseError from rest_framework.response import Response def custom_exception_handler(exc,context): # 先调用 REST framework 默认的异常处理方法获得标准错误响应对象 response = exception_handler(exc,context) # 补充自定义的异常处理 if response is None: view = context[&#39;view&#39;] if isinstance(exc,DatabaseError): print(&#39;[%s]:%s&#39;%(view,exc)) response = Response({&#39;detail&#39;:&#39;服务器错误&#39;},status=status." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e89a7ef7a2f2f3f44cb9b1044117427f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-01T07:54:53+08:00" />
<meta property="article:modified_time" content="2023-12-01T07:54:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">rest_framework_django学习笔记三(异常、登录认证)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="rest_framework_django_0"></a>rest_framework_django学习笔记三(异常、登录认证)</h2> 
<h2><a id="_3"></a>一、异常</h2> 
<p>REST framework 定义的异常</p> 
<table><thead><tr><th>异常名称</th><th>说明</th></tr></thead><tbody><tr><td>APIException</td><td>所有异常的父类</td></tr><tr><td>ParseError</td><td>解析错误</td></tr><tr><td>AuthenticationFailed</td><td>认证失败</td></tr><tr><td>NotAuthenticated</td><td>尚未认证</td></tr><tr><td>PermissionDenied</td><td>权限拒绝</td></tr><tr><td>NotFound</td><td>未找到</td></tr><tr><td>MethodNotAllowed</td><td>请求方式不支持</td></tr><tr><td>NotAcceptable</td><td>要获取的数据格式不支持</td></tr><tr><td>Throttled</td><td>超过限流次数</td></tr><tr><td>ValidationError</td><td>校验失败</td></tr></tbody></table> 
<h3><a id="1_20"></a>1、自定义异常</h3> 
<p>REST framework 提供了异常处理，我们可以自定义异常处理函数</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span>  rest_framework<span class="token punctuation">.</span>views <span class="token keyword">import</span> exception_handler
<span class="token keyword">def</span> <span class="token function">custom_exception_handler</span><span class="token punctuation">(</span>exc<span class="token punctuation">,</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 先调用 REST framework 默认的异常处理方法获得标准错误响应对象</span>
	response <span class="token operator">=</span> exception_handler<span class="token punctuation">(</span>exc<span class="token punctuation">,</span>context<span class="token punctuation">)</span>
	<span class="token comment"># 补充自定义的异常处理</span>
	<span class="token keyword">if</span> response <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
		response<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'status_code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>status_code
	<span class="token keyword">return</span> response
</code></pre> 
<p>在配置文件中声明自定义的异常处理</p> 
<pre><code class="prism language-python">REST_FRAMEWORK <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"EXCEPTION_HANDLER"</span><span class="token punctuation">:</span> <span class="token string">"demo_app.utils.custom_exception_handler"</span><span class="token punctuation">,</span>  <span class="token comment"># 自定义的异常处理</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2_45"></a>2、补充异常处理</h3> 
<pre><code class="prism language-python"><span class="token keyword">from</span>  rest_framework <span class="token keyword">import</span> status
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> DatabaseError
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response
<span class="token keyword">def</span> <span class="token function">custom_exception_handler</span><span class="token punctuation">(</span>exc<span class="token punctuation">,</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 先调用 REST framework 默认的异常处理方法获得标准错误响应对象</span>
	response <span class="token operator">=</span> exception_handler<span class="token punctuation">(</span>exc<span class="token punctuation">,</span>context<span class="token punctuation">)</span>
	<span class="token comment"># 补充自定义的异常处理</span>
	<span class="token keyword">if</span> response <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
		view <span class="token operator">=</span> context<span class="token punctuation">[</span><span class="token string">'view'</span><span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>exc<span class="token punctuation">,</span>DatabaseError<span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[%s]:%s'</span><span class="token operator">%</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span>exc<span class="token punctuation">)</span><span class="token punctuation">)</span>
			response <span class="token operator">=</span> Response<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'detail'</span><span class="token punctuation">:</span><span class="token string">'服务器错误'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>status<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_500_INTERNAL_SERVER_ERROR<span class="token punctuation">)</span>
	<span class="token keyword">return</span> response
</code></pre> 
<h3><a id="3_63"></a>3、统一异常拦截</h3> 
<pre><code class="prism language-python">REST_FRAMEWORK <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"EXCEPTION_HANDLER"</span><span class="token punctuation">:</span> <span class="token string">"demo_app.exception.CustomExceptionHandler"</span><span class="token punctuation">,</span>  <span class="token comment"># 自定义的异常处理</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_71"></a>统一响应</h4> 
<pre><code class="prism language-python"><span class="token comment"># json_response.py</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response
<span class="token keyword">class</span> <span class="token class-name">SuccessResponse</span><span class="token punctuation">(</span>Response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    标准响应成功的返回, SuccessResponse(data)或者SuccessResponse(data=data)
    (1)默认code返回2000, 不支持指定其他返回码
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">'success'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> template_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> exception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 content_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>page<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>limit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>total<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"page"</span><span class="token punctuation">:</span> page<span class="token punctuation">,</span>
                <span class="token string">"limit"</span><span class="token punctuation">:</span> limit<span class="token punctuation">,</span>
                <span class="token string">"total"</span><span class="token punctuation">:</span> total<span class="token punctuation">,</span>
                <span class="token string">"data"</span><span class="token punctuation">:</span> data
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"msg"</span><span class="token punctuation">:</span> msg
        <span class="token punctuation">}</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>std_data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">DetailResponse</span><span class="token punctuation">(</span>Response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    不包含分页信息的接口返回,主要用于单条数据查询
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 msg<span class="token operator">=</span><span class="token string">'success'</span><span class="token punctuation">,</span>
                 status<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 template_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 exception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 content_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
            <span class="token string">"msg"</span><span class="token punctuation">:</span> msg
        <span class="token punctuation">}</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>std_data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ErrorResponse</span><span class="token punctuation">(</span>Response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    标准响应错误的返回,ErrorResponse(msg='xxx')
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">'error'</span><span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> template_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 exception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> content_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> code<span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
            <span class="token string">"msg"</span><span class="token punctuation">:</span> msg
        <span class="token punctuation">}</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>std_data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>

</code></pre> 
<h4><a id="_131"></a>自定义异常处理</h4> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># exception</span>
<span class="token triple-quoted-string string">"""自定义异常处理"""</span>
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> traceback

<span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> ProtectedError<span class="token punctuation">,</span> RestrictedError
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> Http404
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> APIException <span class="token keyword">as</span> DRFAPIException<span class="token punctuation">,</span> AuthenticationFailed<span class="token punctuation">,</span> PermissionDenied
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>status <span class="token keyword">import</span> HTTP_407_PROXY_AUTHENTICATION_REQUIRED<span class="token punctuation">,</span> HTTP_401_UNAUTHORIZED
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>views <span class="token keyword">import</span> set_rollback<span class="token punctuation">,</span> exception_handler
<span class="token keyword">from</span> <span class="token punctuation">.</span>json_response <span class="token keyword">import</span> ErrorResponse
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">CustomExceptionHandler</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    统一异常拦截处理
    目的:(1)取消所有的500异常响应,统一响应为标准错误返回
        (2)准确显示错误信息
    :param ex:
    :param context:
    :return:
    """</span>
    msg <span class="token operator">=</span> <span class="token string">""</span>
    code <span class="token operator">=</span> <span class="token number">999</span>
    <span class="token comment"># 调用默认的异常处理函数</span>
    response <span class="token operator">=</span> exception_handler<span class="token punctuation">(</span>ex<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> AuthenticationFailed<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 如果是身份验证错误</span>
        <span class="token keyword">if</span> response <span class="token keyword">and</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"detail"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Given token not valid for any token type"</span><span class="token punctuation">:</span>
            code <span class="token operator">=</span> <span class="token number">401</span>
            msg <span class="token operator">=</span> ex<span class="token punctuation">.</span>detail
        <span class="token keyword">elif</span> response <span class="token keyword">and</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"detail"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Token is blacklisted"</span><span class="token punctuation">:</span>
            <span class="token comment"># token在黑名单</span>
            <span class="token keyword">return</span> ErrorResponse<span class="token punctuation">(</span>status<span class="token operator">=</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            code <span class="token operator">=</span> <span class="token number">401</span>
            msg <span class="token operator">=</span> ex<span class="token punctuation">.</span>detail
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> Http404<span class="token punctuation">)</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> <span class="token number">400</span>
        msg <span class="token operator">=</span> <span class="token string">"接口地址不正确"</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> DRFAPIException<span class="token punctuation">)</span><span class="token punctuation">:</span>
        set_rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> ex<span class="token punctuation">.</span>detail
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> PermissionDenied<span class="token punctuation">)</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>msg<span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>context<span class="token punctuation">[</span><span class="token string">"request"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>method<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>context<span class="token punctuation">[</span><span class="token string">"request"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">}</span></span><span class="token string">)'</span></span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> msg<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> v<span class="token punctuation">:</span>
                    msg <span class="token operator">=</span> <span class="token string">"%s:%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token punctuation">(</span>ProtectedError<span class="token punctuation">,</span> RestrictedError<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        set_rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token string">"无法删除:该条数据与其他数据有相关绑定"</span>
    <span class="token comment"># elif isinstance(ex, DatabaseError):</span>
    <span class="token comment">#     set_rollback()</span>
    <span class="token comment">#     msg = "接口服务器异常,请联系管理员"</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ErrorResponse<span class="token punctuation">(</span>msg<span class="token operator">=</span>msg<span class="token punctuation">,</span> code<span class="token operator">=</span>code<span class="token punctuation">)</span>

</code></pre> 
<h2><a id="rest_framework__198"></a>二、rest_framework 认证</h2> 
<h3><a id="1_200"></a>1、全局</h3> 
<p>可以在配置文件中配置<strong>全局默认</strong>的认证方案</p> 
<pre><code class="prism language-python"><span class="token comment"># settings.py</span>
REST_FRAMEWORK <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"DATETIME_FORMAT"</span><span class="token punctuation">:</span> <span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">,</span>  <span class="token comment"># 日期时间格式配置</span>
    <span class="token string">"DATE_FORMAT"</span><span class="token punctuation">:</span> <span class="token string">"%Y-%m-%d"</span><span class="token punctuation">,</span>
    <span class="token string">"DEFAULT_AUTHENTICATION_CLASSES"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>
        <span class="token comment"># "rest_framework_simplejwt.authentication.JWTAuthentication",# JWT 认证 # pip install djangorestframework-simplejwt</span>
        <span class="token string">"rest_framework.authentication.BasicAuthentication"</span><span class="token punctuation">,</span> <span class="token comment"># 基础认证</span>
        <span class="token string">"rest_framework.authentication.SessionAuthentication"</span><span class="token punctuation">,</span> <span class="token comment"># session 认证</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2_217"></a>2、局部</h3> 
<p>也可以在视图中通过设置 authentication_classess 属性来设置 <strong>局部认证</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Q
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> ModelViewSet
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> action
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>authentication <span class="token keyword">import</span> SessionAuthentication<span class="token punctuation">,</span>BasicAuthentication
<span class="token keyword">from</span> <span class="token punctuation">.</span>serializers <span class="token keyword">import</span> BookSerializer
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Book
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response
<span class="token keyword">class</span> <span class="token class-name">BookModelViewSet</span><span class="token punctuation">(</span>ModelViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span>
	authentication_classes <span class="token operator">=</span> <span class="token punctuation">(</span>SessionAuthentication<span class="token punctuation">,</span>BasicAuthentication<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>认证失败会有两种可能的返回值</p> 
<ul><li>401 Unauthorized 未认证</li><li>403 Permission Denied 权限被禁止</li></ul> 
<h2><a id="JWT__239"></a>三、JWT 认证</h2> 
<h3><a id="1_241"></a>1、安装包</h3> 
<pre><code class="prism language-sh">pip <span class="token function">install</span> djangorestframework-simplejwt
</code></pre> 
<h3><a id="2settingspy_247"></a>2、settings.py配置</h3> 
<pre><code class="prism language-python"><span class="token comment"># settings.py</span>
INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># ...</span>
    <span class="token string">'rest_framework_simplejwt'</span><span class="token punctuation">,</span>
    <span class="token comment"># 下面这个app用于刷新refresh_token后，将旧的加到到blacklist时使用</span>
    <span class="token string">'rest_framework_simplejwt.token_blacklist'</span>
    <span class="token comment"># ...</span>
<span class="token punctuation">]</span>
<span class="token comment"># ================================================= #</span>
<span class="token comment"># ***************** REST_FRAMEWORK配置 ************ #</span>
<span class="token comment"># ================================================= #</span>
REST_FRAMEWORK <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token string">"DEFAULT_AUTHENTICATION_CLASSES"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token string">"rest_framework_simplejwt.authentication.JWTAuthentication"</span><span class="token punctuation">,</span><span class="token comment"># JWT 认证 # pip install djangorestframework-simplejwt</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># ================================================= #</span>
<span class="token comment"># ****************** simplejwt配置 ***************** #</span>
<span class="token comment"># ================================================= #</span>
<span class="token comment"># 选择自己需要配置即可</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta
SIMPLE_JWT <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'ACCESS_TOKEN_LIFETIME'</span><span class="token punctuation">:</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Access Token的有效期</span>
    <span class="token string">'REFRESH_TOKEN_LIFETIME'</span><span class="token punctuation">:</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Refresh Token的有效期</span>

    <span class="token comment"># 对于大部分情况，设置以上两项就可以了，以下为默认配置项目，可根据需要进行调整</span>

    <span class="token comment"># 是否自动刷新Refresh Token</span>
    <span class="token string">'ROTATE_REFRESH_TOKENS'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token comment"># 刷新Refresh Token时是否将旧Token加入黑名单，如果设置为False，则旧的刷新令牌仍然可以用于获取新的访问令牌。需要将'rest_framework_simplejwt.token_blacklist'加入到'INSTALLED_APPS'的配置中</span>
    <span class="token string">'BLACKLIST_AFTER_ROTATION'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token string">'ALGORITHM'</span><span class="token punctuation">:</span> <span class="token string">'HS256'</span><span class="token punctuation">,</span>  <span class="token comment"># 加密算法</span>
    <span class="token string">'SIGNING_KEY'</span><span class="token punctuation">:</span> SECRET_KEY<span class="token punctuation">,</span>  <span class="token comment"># 签名密匙，这里使用Django的SECRET_KEY</span>

    <span class="token comment"># 如为True，则在每次使用访问令牌进行身份验证时，更新用户最后登录时间</span>
    <span class="token string">"UPDATE_LAST_LOGIN"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token comment"># 用于验证JWT签名的密钥返回的内容。可以是字符串形式的密钥，也可以是一个字典。</span>
    <span class="token string">"VERIFYING_KEY"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"AUDIENCE"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># JWT中的"Audience"声明,用于指定该JWT的预期接收者。</span>
    <span class="token string">"ISSUER"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># JWT中的"Issuer"声明，用于指定该JWT的发行者。</span>
    <span class="token string">"JSON_ENCODER"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># 用于序列化JWT负载的JSON编码器。默认为Django的JSON编码器。</span>
    <span class="token string">"JWK_URL"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># 包含公钥的URL，用于验证JWT签名。</span>
    <span class="token string">"LEEWAY"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment"># 允许的时钟偏差量，以秒为单位。用于在验证JWT的过期时间和生效时间时考虑时钟偏差。</span>

    <span class="token comment"># 用于指定JWT在HTTP请求头中使用的身份验证方案。默认为"Bearer"</span>
    <span class="token string">"AUTH_HEADER_TYPES"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 包含JWT的HTTP请求头的名称。默认为"HTTP_AUTHORIZATION"</span>
    <span class="token string">"AUTH_HEADER_NAME"</span><span class="token punctuation">:</span> <span class="token string">"HTTP_AUTHORIZATION"</span><span class="token punctuation">,</span>
    <span class="token comment"># 用户模型中用作用户ID的字段。默认为"id"。</span>
    <span class="token string">"USER_ID_FIELD"</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
    <span class="token comment"># JWT负载中包含用户ID的声明。默认为"user_id"。</span>
    <span class="token string">"USER_ID_CLAIM"</span><span class="token punctuation">:</span> <span class="token string">"user_id"</span><span class="token punctuation">,</span>

    <span class="token comment"># 用于指定用户身份验证规则的函数或方法。默认使用Django的默认身份验证方法进行身份验证。</span>
    <span class="token string">"USER_AUTHENTICATION_RULE"</span><span class="token punctuation">:</span> <span class="token string">"rest_framework_simplejwt.authentication.default_user_authentication_rule"</span><span class="token punctuation">,</span>

    <span class="token comment">#  用于指定可以使用的令牌类。默认为"rest_framework_simplejwt.tokens.AccessToken"。</span>
    <span class="token string">"AUTH_TOKEN_CLASSES"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"rest_framework_simplejwt.tokens.AccessToken"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># JWT负载中包含令牌类型的声明。默认为"token_type"。</span>
    <span class="token string">"TOKEN_TYPE_CLAIM"</span><span class="token punctuation">:</span> <span class="token string">"token_type"</span><span class="token punctuation">,</span>
    <span class="token comment"># 用于指定可以使用的用户模型类。默认为"rest_framework_simplejwt.models.TokenUser"。</span>
    <span class="token string">"TOKEN_USER_CLASS"</span><span class="token punctuation">:</span> <span class="token string">"rest_framework_simplejwt.models.TokenUser"</span><span class="token punctuation">,</span>

    <span class="token comment"># JWT负载中包含JWT ID的声明。默认为"jti"。</span>
    <span class="token string">"JTI_CLAIM"</span><span class="token punctuation">:</span> <span class="token string">"jti"</span><span class="token punctuation">,</span>

    <span class="token comment"># 在使用滑动令牌时，JWT负载中包含刷新令牌过期时间的声明。默认为"refresh_exp"。</span>
    <span class="token string">"SLIDING_TOKEN_REFRESH_EXP_CLAIM"</span><span class="token punctuation">:</span> <span class="token string">"refresh_exp"</span><span class="token punctuation">,</span>
    <span class="token comment"># 滑动令牌的生命周期。默认为5分钟。</span>
    <span class="token string">"SLIDING_TOKEN_LIFETIME"</span><span class="token punctuation">:</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 滑动令牌可以用于刷新的时间段。默认为1天。</span>
    <span class="token string">"SLIDING_TOKEN_REFRESH_LIFETIME"</span><span class="token punctuation">:</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 用于生成访问令牌和刷新令牌的序列化器。</span>
    <span class="token string">"TOKEN_OBTAIN_SERIALIZER"</span><span class="token punctuation">:</span> <span class="token string">"rest_framework_simplejwt.serializers.TokenObtainPairSerializer"</span><span class="token punctuation">,</span>
    <span class="token comment"># 用于刷新访问令牌的序列化器。默认</span>
    <span class="token string">"TOKEN_REFRESH_SERIALIZER"</span><span class="token punctuation">:</span> <span class="token string">"rest_framework_simplejwt.serializers.TokenRefreshSerializer"</span><span class="token punctuation">,</span>
    <span class="token comment"># 用于验证令牌的序列化器。</span>
    <span class="token string">"TOKEN_VERIFY_SERIALIZER"</span><span class="token punctuation">:</span> <span class="token string">"rest_framework_simplejwt.serializers.TokenVerifySerializer"</span><span class="token punctuation">,</span>
    <span class="token comment"># 用于列出或撤销已失效JWT的序列化器。</span>
    <span class="token string">"TOKEN_BLACKLIST_SERIALIZER"</span><span class="token punctuation">:</span> <span class="token string">"rest_framework_simplejwt.serializers.TokenBlacklistSerializer"</span><span class="token punctuation">,</span>
    <span class="token comment"># 用于生成滑动令牌的序列化器。</span>
    <span class="token string">"SLIDING_TOKEN_OBTAIN_SERIALIZER"</span><span class="token punctuation">:</span> <span class="token string">"rest_framework_simplejwt.serializers.TokenObtainSlidingSerializer"</span><span class="token punctuation">,</span>
    <span class="token comment"># 用于刷新滑动令牌的序列化器。</span>
    <span class="token string">"SLIDING_TOKEN_REFRESH_SERIALIZER"</span><span class="token punctuation">:</span> <span class="token string">"rest_framework_simplejwt.serializers.TokenRefreshSlidingSerializer"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment"># ================================================= #</span>
<span class="token comment"># ****************** simplejwt配置 ***************** #</span>
<span class="token comment"># ================================================= #</span>
<span class="token comment"># 我选择的</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta
SIMPLE_JWT <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment"># token有效时长</span>
    <span class="token string">"ACCESS_TOKEN_LIFETIME"</span><span class="token punctuation">:</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># token刷新后的有效时间</span>
    <span class="token string">"REFRESH_TOKEN_LIFETIME"</span><span class="token punctuation">:</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 设置前缀</span>
    <span class="token string">"AUTH_HEADER_TYPES"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"JWT"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment"># </span>
    <span class="token comment"># 是否自动刷新Refresh Token</span>
    <span class="token string">"ROTATE_REFRESH_TOKENS"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token comment"># 刷新Refresh Token时是否将旧Token加入黑名单，如果设置为False，则旧的刷新令牌仍然可以用于获取新的访问令牌。需要将'rest_framework_simplejwt.token_blacklist'加入到'INSTALLED_APPS'的配置中</span>
    <span class="token string">'BLACKLIST_AFTER_ROTATION'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token comment">#  用于指定可以使用的令牌类。默认为"rest_framework_simplejwt.tokens.AccessToken"</span>
    <span class="token string">'AUTH_TOKEN_CLASSES'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">'rest_framework_simplejwt.tokens.AccessToken'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行数据库迁移：</p> 
<pre><code class="prism language-shell">python manage.py  makemigrations
python manage.py  migrate
</code></pre> 
<h4><a id="1_AUTH_HEADER_TYPES_369"></a>注意1 AUTH_HEADER_TYPES：</h4> 
<p>当配置了 <strong>AUTH_HEADER_TYPES</strong> 指定JWT在HTTP请求头中使用的身份验证方案。默认为"Bearer"；在使用 postman和其他的一些自带的认证中会在请求同中增加Bearer + token 字符串。在自定义Header 中可以自己进行增加内容。如我使用的是JWT开头的那么在 postman中</p> 
<p><img src="https://images2.imgbox.com/cb/6f/tzbZDmly_o.png" alt="在这里插入图片描述"></p> 
<p><strong>源码查看</strong></p> 
<p>每次访问该视图时，都会调用<code>**JSONWebTokenAuthentication.authenticate**</code> 进行认证.</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> rest_framework_simplejwt<span class="token punctuation">.</span>authentication <span class="token keyword">import</span> JWTAuthentication
user<span class="token punctuation">,</span> tokrn <span class="token operator">=</span> JWTAuthentication<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>authenticate<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
</code></pre> 
<p>在源码 authenticate 方法中获取</p> 
<p><img src="https://images2.imgbox.com/e3/7b/D3mxgiYP_o.png" alt="在这里插入图片描述"></p> 
<p>当不匹配时携带请求头会出现： <strong>身份认证信息未提供。</strong></p> 
<p><img src="https://images2.imgbox.com/cb/e1/C7mapBop_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b8/fe/6eAZzHWG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3tokenurl_400"></a>3、提供获取和刷新token的url</h3> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span>include<span class="token punctuation">,</span>re_path
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>documentation <span class="token keyword">import</span> include_docs_urls

<span class="token keyword">from</span> rest_framework_simplejwt<span class="token punctuation">.</span>views <span class="token keyword">import</span> <span class="token punctuation">(</span>
    TokenObtainPairView<span class="token punctuation">,</span>
    TokenRefreshView<span class="token punctuation">,</span>
    TokenVerifyView
<span class="token punctuation">)</span>
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># jwt 认证</span>
    path<span class="token punctuation">(</span><span class="token string">'token/'</span><span class="token punctuation">,</span> TokenObtainPairView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'token_obtain_pair'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'token/refresh/'</span><span class="token punctuation">,</span> TokenRefreshView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'token_refresh'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 下面这个是用来验证 token 的，根据需要进行配置</span>
    path<span class="token punctuation">(</span><span class="token string">'token/verify/'</span><span class="token punctuation">,</span> TokenVerifyView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'token_verify'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/e7/47/iLsO0vog_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/10/bc/WWOyq6N9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_427"></a>4、自定义返回信息</h3> 
<p>该序列化器需继承TokenObtainPairSerializer类，可以在任意一个app中的seralizers.py中增加该自定义的序列化器，并重写了get_token()方法。在这个方法中，我们可以自定义Payload，将用户的信息添加到Token中。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> rest_framework_simplejwt<span class="token punctuation">.</span>serializers <span class="token keyword">import</span> TokenObtainPairSerializer
<span class="token keyword">from</span> rest_framework_simplejwt<span class="token punctuation">.</span>views <span class="token keyword">import</span> TokenObtainPairView
<span class="token keyword">class</span> <span class="token class-name">LoginSerializer</span><span class="token punctuation">(</span>TokenObtainPairSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get_token</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">:</span>
        token <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_token<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        <span class="token comment"># 增加想要加到token中的信息</span>
        token<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>username
        token<span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>email
        <span class="token keyword">return</span> token
<span class="token comment"># 改写simple JWT提供的默认视图，在app01/views中新增一个视图，该视图需继承至默认的视图类TokenObtainPairView</span>
<span class="token keyword">class</span> <span class="token class-name">LoginView</span><span class="token punctuation">(</span>TokenObtainPairView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    登录接口
    """</span>
    serializer_class <span class="token operator">=</span> LoginSerializer
    permission_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment">#urls.py</span>
<span class="token keyword">from</span> demo_app<span class="token punctuation">.</span>login <span class="token keyword">import</span> LoginView

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># 登录</span>
    path<span class="token punctuation">(</span><span class="token string">'login/'</span><span class="token punctuation">,</span>LoginView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/f6/b7/dObm4L5V_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/6f/2f/jmcEZDPy_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_471"></a>5、简单实现登录</h3> 
<h4><a id="51__473"></a>5.1 账号或密码错误</h4> 
<p>TokenObtainSerializer 中登录登录失败提示：</p> 
<p><img src="https://images2.imgbox.com/10/0c/8ofAJaK6_o.png" alt="在这里插入图片描述"></p> 
<p>重写登陆提示：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> rest_framework_simplejwt<span class="token punctuation">.</span>serializers <span class="token keyword">import</span> TokenObtainPairSerializer
<span class="token keyword">from</span> rest_framework_simplejwt<span class="token punctuation">.</span>views <span class="token keyword">import</span> TokenObtainPairView
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User <span class="token comment"># 使用的是默认的django 用户</span>
<span class="token keyword">class</span> <span class="token class-name">LoginSerializer</span><span class="token punctuation">(</span>TokenObtainPairSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> User
        fields <span class="token operator">=</span> <span class="token string">"__all__"</span>
        read_only_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token string">"username"</span><span class="token punctuation">,</span><span class="token string">"email"</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">get_token</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 重写 获取 token中保存的内容 '''</span>
        token <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_token<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        <span class="token comment"># 增加想要加到token中的信息</span>
        token<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>username
        token<span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>email
        <span class="token keyword">return</span> token
    <span class="token comment"># 登录失败提示</span>
    default_error_messages <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"no_active_account"</span><span class="token punctuation">:</span> <span class="token string">'账号/密码错误'</span><span class="token punctuation">}</span>
    <span class="token comment"># 重写登录方法</span>
    <span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">''' 重写登录方法 '''</span>
      <span class="token comment"># 获取传入的 用户名和密码</span>
      username <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
      password <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"username:"</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span><span class="token string">"\npassword:"</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span>
      data <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>validate<span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token comment">#获取 返回的 token内容</span>
      <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> data<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">LoginView</span><span class="token punctuation">(</span>TokenObtainPairView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    登录接口
    """</span>
    serializer_class <span class="token operator">=</span> LoginSerializer
    permission_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f3/c4/MEQFSQdp_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="52___520"></a>5.2 增加统一返回</h4> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># 统一返回格式</span>
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response
<span class="token keyword">class</span> <span class="token class-name">SuccessResponse</span><span class="token punctuation">(</span>Response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    标准响应成功的返回, SuccessResponse(data)或者SuccessResponse(data=data)
    (1)默认code返回2000, 不支持指定其他返回码
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">'success'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> template_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> exception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 content_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>page<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>limit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>total<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"page"</span><span class="token punctuation">:</span> page<span class="token punctuation">,</span>
                <span class="token string">"limit"</span><span class="token punctuation">:</span> limit<span class="token punctuation">,</span>
                <span class="token string">"total"</span><span class="token punctuation">:</span> total<span class="token punctuation">,</span>
                <span class="token string">"data"</span><span class="token punctuation">:</span> data
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"msg"</span><span class="token punctuation">:</span> msg
        <span class="token punctuation">}</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>std_data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">DetailResponse</span><span class="token punctuation">(</span>Response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    不包含分页信息的接口返回,主要用于单条数据查询
    (1)默认code返回 200, 不支持指定其他返回码
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 msg<span class="token operator">=</span><span class="token string">'success'</span><span class="token punctuation">,</span>
                 status<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 template_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 exception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 content_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
            <span class="token string">"msg"</span><span class="token punctuation">:</span> msg
        <span class="token punctuation">}</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>std_data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ErrorResponse</span><span class="token punctuation">(</span>Response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    标准响应错误的返回,ErrorResponse(msg='xxx')
    (1)默认错误码返回 500, 也可以指定其他返回码:ErrorResponse(code=xxx)
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">'error'</span><span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> template_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 exception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> content_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> code<span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
            <span class="token string">"msg"</span><span class="token punctuation">:</span> msg
        <span class="token punctuation">}</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>std_data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response

<span class="token keyword">class</span> <span class="token class-name">SuccessResponse</span><span class="token punctuation">(</span>Response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    标准响应成功的返回, SuccessResponse(data)或者SuccessResponse(data=data)
    (1)默认code返回2000, 不支持指定其他返回码
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">'success'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> template_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> exception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 content_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>page<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>limit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>total<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"page"</span><span class="token punctuation">:</span> page<span class="token punctuation">,</span>
                <span class="token string">"limit"</span><span class="token punctuation">:</span> limit<span class="token punctuation">,</span>
                <span class="token string">"total"</span><span class="token punctuation">:</span> total<span class="token punctuation">,</span>
                <span class="token string">"data"</span><span class="token punctuation">:</span> data
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"msg"</span><span class="token punctuation">:</span> msg
        <span class="token punctuation">}</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>std_data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">DetailResponse</span><span class="token punctuation">(</span>Response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    不包含分页信息的接口返回,主要用于单条数据查询
    (1)默认code返回 200, 不支持指定其他返回码
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 msg<span class="token operator">=</span><span class="token string">'success'</span><span class="token punctuation">,</span>
                 status<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 template_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 exception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 content_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
            <span class="token string">"msg"</span><span class="token punctuation">:</span> msg
        <span class="token punctuation">}</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>std_data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ErrorResponse</span><span class="token punctuation">(</span>Response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    标准响应错误的返回,ErrorResponse(msg='xxx')
    (1)默认错误码返回 500, 也可以指定其他返回码:ErrorResponse(code=xxx)
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">'error'</span><span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> template_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 exception<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> content_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> code<span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
            <span class="token string">"msg"</span><span class="token punctuation">:</span> msg
        <span class="token punctuation">}</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>std_data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>

</code></pre> 
<p>异常处理</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token triple-quoted-string string">"""自定义异常处理"""</span>
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> traceback

<span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> ProtectedError<span class="token punctuation">,</span> RestrictedError
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> Http404
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> APIException <span class="token keyword">as</span> DRFAPIException<span class="token punctuation">,</span> AuthenticationFailed<span class="token punctuation">,</span> PermissionDenied
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>status <span class="token keyword">import</span> HTTP_407_PROXY_AUTHENTICATION_REQUIRED<span class="token punctuation">,</span> HTTP_401_UNAUTHORIZED
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>views <span class="token keyword">import</span> set_rollback<span class="token punctuation">,</span> exception_handler
<span class="token keyword">from</span> <span class="token punctuation">.</span>json_response <span class="token keyword">import</span> ErrorResponse
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">CustomExceptionHandler</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    统一异常拦截处理
    目的:(1)取消所有的500异常响应,统一响应为标准错误返回
        (2)准确显示错误信息
    :param ex:
    :param context:
    :return:
    """</span>
    msg <span class="token operator">=</span> <span class="token string">""</span>
    code <span class="token operator">=</span> <span class="token number">500</span>
    <span class="token comment"># 调用默认的异常处理函数</span>
    response <span class="token operator">=</span> exception_handler<span class="token punctuation">(</span>ex<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> AuthenticationFailed<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 如果是身份验证错误</span>
        <span class="token keyword">if</span> response <span class="token keyword">and</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"detail"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Given token not valid for any token type"</span><span class="token punctuation">:</span>
            code <span class="token operator">=</span> <span class="token number">401</span>
            msg <span class="token operator">=</span> ex<span class="token punctuation">.</span>detail
        <span class="token keyword">elif</span> response <span class="token keyword">and</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"detail"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Token is blacklisted"</span><span class="token punctuation">:</span>
            <span class="token comment"># token在黑名单</span>
            <span class="token keyword">return</span> ErrorResponse<span class="token punctuation">(</span>status<span class="token operator">=</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            code <span class="token operator">=</span> <span class="token number">401</span>
            msg <span class="token operator">=</span> ex<span class="token punctuation">.</span>detail
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> Http404<span class="token punctuation">)</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> <span class="token number">400</span>
        msg <span class="token operator">=</span> <span class="token string">"接口地址不正确"</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> DRFAPIException<span class="token punctuation">)</span><span class="token punctuation">:</span>
        set_rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> ex<span class="token punctuation">.</span>detail
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> PermissionDenied<span class="token punctuation">)</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>msg<span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>context<span class="token punctuation">[</span><span class="token string">"request"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>method<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>context<span class="token punctuation">[</span><span class="token string">"request"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">}</span></span><span class="token string">)'</span></span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> msg<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> v<span class="token punctuation">:</span>
                    msg <span class="token operator">=</span> <span class="token string">"%s:%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token punctuation">(</span>ProtectedError<span class="token punctuation">,</span> RestrictedError<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        set_rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token string">"无法删除:该条数据与其他数据有相关绑定"</span>
    <span class="token comment"># elif isinstance(ex, DatabaseError):</span>
    <span class="token comment">#     set_rollback()</span>
    <span class="token comment">#     msg = "接口服务器异常,请联系管理员"</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ErrorResponse<span class="token punctuation">(</span>msg<span class="token operator">=</span>msg<span class="token punctuation">,</span> code<span class="token operator">=</span>code<span class="token punctuation">)</span>
</code></pre> 
<p>登录</p> 
<pre><code class="prism language-python"><span class="token comment"># coding=utf-8</span>
<span class="token triple-quoted-string string">'''
@date：2023/11/29 11:15
@mail：xiaochun235@qq.com
@Content:
'''</span>
<span class="token keyword">from</span> rest_framework_simplejwt<span class="token punctuation">.</span>serializers <span class="token keyword">import</span> TokenObtainPairSerializer
<span class="token keyword">from</span> rest_framework_simplejwt<span class="token punctuation">.</span>views <span class="token keyword">import</span> TokenObtainPairView
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User
<span class="token keyword">from</span> rest_framework_simplejwt<span class="token punctuation">.</span>tokens <span class="token keyword">import</span> RefreshToken<span class="token punctuation">,</span> AccessToken
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> APIException
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>views <span class="token keyword">import</span> APIView
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User
<span class="token keyword">from</span> <span class="token punctuation">.</span>json_response <span class="token keyword">import</span> DetailResponse
<span class="token keyword">class</span> <span class="token class-name">LoginSerializer</span><span class="token punctuation">(</span>TokenObtainPairSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> User
        fields <span class="token operator">=</span> <span class="token string">"__all__"</span>
        read_only_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token string">"username"</span><span class="token punctuation">,</span><span class="token string">"email"</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">get_token</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 重写 获取 token中保存的内容 '''</span>
        token <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_token<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        <span class="token comment"># 增加想要加到token中的信息</span>
        token<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>username
        token<span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>email
        <span class="token keyword">return</span> token

    default_error_messages <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"no_active_account"</span><span class="token punctuation">:</span> <span class="token string">'账号/密码错误'</span><span class="token punctuation">}</span>
    <span class="token comment"># 重写登录方法</span>
    <span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">''' 重写登录方法 '''</span>
      <span class="token comment">#</span>
      username <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
      password <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"username:"</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span><span class="token string">"\npassword:"</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span>
      <span class="token comment"># 可以 增加图片验证码验证，短信验证码验证等登录验证因子</span>
      <span class="token comment"># if True:</span>
      <span class="token comment">#     raise CustomValidationError("验证码不正确")</span>
      <span class="token comment"># 获取 返回的 token内容</span>
      data <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>validate<span class="token punctuation">(</span>attrs<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"请求成功"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> data<span class="token punctuation">}</span>


<span class="token comment"># 改写simple JWT提供的默认视图，在app01/views中新增一个视图，该视图需继承至默认的视图类TokenObtainPairView</span>
<span class="token keyword">class</span> <span class="token class-name">LoginView</span><span class="token punctuation">(</span>TokenObtainPairView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    登录接口
    """</span>
    serializer_class <span class="token operator">=</span> LoginSerializer
    permission_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">CustomValidationError</span><span class="token punctuation">(</span>APIException<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    继承并重写验证器返回的结果,避免暴露字段
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> detail<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>detail <span class="token operator">=</span> detail
</code></pre> 
<p><img src="https://images2.imgbox.com/7c/2c/l1tGJ8AZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6_776"></a>6、修改登录配置</h3> 
<p>settings.py 中修改登录配置</p> 
<pre><code class="prism language-python"><span class="token comment"># ================================================= #</span>
<span class="token comment"># ******************** 登录方式配置 ******************** #</span>
<span class="token comment"># ================================================= #</span>
AUTHENTICATION_BACKENDS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"demo_app.backends.CustomBackend"</span><span class="token punctuation">]</span>
</code></pre> 
<p>重写等</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>backends <span class="token keyword">import</span> ModelBackend
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>hashers <span class="token keyword">import</span> check_password
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Q
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> APIException
<span class="token keyword">class</span> <span class="token class-name">CustomValidationError</span><span class="token punctuation">(</span>APIException<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    继承并重写验证器返回的结果,避免暴露字段
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> detail<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>detail <span class="token operator">=</span> detail
<span class="token keyword">class</span> <span class="token class-name">CustomBackend</span><span class="token punctuation">(</span>ModelBackend<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    重写认证登录
    """</span>
    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 查询用户对象  可通过密码和邮箱登录</span>
        user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Q<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">)</span> <span class="token operator">|</span> Q<span class="token punctuation">(</span>email<span class="token operator">=</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 判断 用户,密码, 是否是管理员</span>
        <span class="token keyword">if</span> user <span class="token keyword">and</span> check_password<span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token keyword">and</span> user<span class="token punctuation">.</span>is_staff<span class="token punctuation">:</span>
            <span class="token keyword">return</span> user  <span class="token comment"># 验证通过返回对象 否则返回None</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> CustomValidationError<span class="token punctuation">(</span><span class="token string">"登录用户账号或密码错误!"</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/02/8f/QxlZ18tH_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_815"></a>其他笔记</h2> 
<h3><a id="httpsblogcsdnnetweixin_51715424articledetails134681145_816"></a><a href="https://blog.csdn.net/weixin_51715424/article/details/134681145">序列化器</a></h3> 
<h3><a id="httpsblogcsdnnetweixin_51715424articledetails134681622_817"></a><a href="https://blog.csdn.net/weixin_51715424/article/details/134681622">视图路由</a></h3> 
<h3><a id="_818"></a>异常、登录认证</h3> 
<h3><a id="httpsblogcsdnnetweixin_51715424articledetails134708188_819"></a><a href="https://blog.csdn.net/weixin_51715424/article/details/134708188">权限、限流</a></h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a1dc83d6a144093773015a023621da9c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MATLAB--控制语句--数组操作--符号运算--绘图--文件和数据的处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5261f5e157b586a51dc0d440995e288c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AUTOSAR专栏——总目录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>