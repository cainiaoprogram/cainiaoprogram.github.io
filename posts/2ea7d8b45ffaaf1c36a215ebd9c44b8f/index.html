<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>API文档自动生成工具调研 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="API文档自动生成工具调研" />
<meta property="og:description" content="API文档自动生成工具调研 项目背景 项目的版本为python2.7，django1.11，采用的前后端交互方式是人工手写接口文档，交给前端，人工写postman接口测试，没有一套高效的自动接口文档生成和自动化测试的流程。
调研过程 //依赖库 djangorestframework==3.9.4 coreapi==2.3.3 django-rest-swagger==2.2.0 drf-yasg 实现方式：Django Rest Swagger生成api文档
实现思路：
修改settings配置，添加依赖库,添加swagger配置修改urls.py 添加swagger文档路由，添加视图路由添加视图类实现序列化类实现模型类 djangorestframework 这种模式在postman就能实现，没必要再自己再重新造一套。
这种接口文档的形式，可以满足需求，但还是没有swagger优雅简洁。
在实现这种模式的时候也遇到不少坑，最终没有呈现出这个效果。
django-rest-swagger：deprecated (2019-06-04) Django 1.8&#43;Django REST framework 3.5.1&#43;Python 2.7, 3.5, 3.6 核心库还是在coreapi，djangorestframework。
依赖于上述核心库的编码方式，换成了swagger的ui
非常容易实现。
drf-yasg Django Rest Framework: 3.10, 3.11, 3.12Django: 2.2, 3.0, 3.1Python: 3.6, 3.7, 3.8, 3.9 特征：
完全支持嵌套序列化器和模式响应模式和描述模型定义与代码生成工具兼容在规范生成过程中的所有点上的定制挂钩JSON和YAML格式的规范捆绑了最新版本的swagger-ui和redoc，用于查看生成的文档架构视图是可立即缓存的生成的Swagger模式可以通过Swagger -spec-validator自动验证通过URLPathVersioning和NamespaceVersioning支持Django REST框架API版本化;目前不支持其他DRF或自定义版本方案 swagger模式
redoc模式
总结：提供了更加强大，更多的功能，以及在可视化ui上做得更好，本质上还是使用了djangorestframework的编码风格
问题：由于python2.7的Django Rest Framework最高只支持3.9版本，所以不兼容3.10&#43;的要求。故可预测该方案不可行。
优缺点： 优点：
更规范科学的开发模式，自动生成api文档，节约大量在文档上编辑以及测试耗费的时间。更直观的管理接口 缺点：
跟原项目的编码风格有较大出入，比如序列化过程，原项目并没有。而是直接从urls到service调用数据库。难以在项目开发规范中推广。需要踩大量坑，由于原项目的python跟django版本较低，在刚尝试使用这种模式就遇到大量坑，很难预测之后会遇到什么坑。增加今后潜在的开发成本需要配置session，目前还没有将项目内的接口跑通，测试成本还在增加。代码侵入性较强，没办法简便的对已开发的接口进行改造，只能考虑后续加入的接口。 总结: 对于当前项目的python和django版本，当前查到的资料都脱离不开Django Rest Framework的编码风格，对于之前已经开发的接口难以引入，同事想要的是一款尽量只改变路由就能实现文档生成，而不是进行大量代码的侵入，所以并不能采用上述的库，当前探索先告一段落。
踩坑记录： django1的urls.py中不支持path，改为url格式（django2才支持path）django修改settings或修改requirement没必要将整个docker-compose重启，项目自动重启失败可以手动重启，也可以直接进docker上直接执行pipyou cannot access body after reding from request’s data stream 一旦对序列化类修改post传入的字段时，就会出现这个问题，查阅资料是说django不能让中间件修改request的post，所以用request." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2ea7d8b45ffaaf1c36a215ebd9c44b8f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-02T16:42:13+08:00" />
<meta property="article:modified_time" content="2021-09-02T16:42:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">API文档自动生成工具调研</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="API_1"></a>API文档自动生成工具调研</h3> 
<h3><a id="_3"></a>项目背景</h3> 
<p>项目的版本为python2.7，django1.11，采用的前后端交互方式是人工手写接口文档，交给前端，人工写postman接口测试，没有一套高效的自动接口文档生成和自动化测试的流程。</p> 
<h3><a id="_7"></a>调研过程</h3> 
<pre><code>//依赖库
djangorestframework==3.9.4
coreapi==2.3.3
django-rest-swagger==2.2.0
drf-yasg
</code></pre> 
<p>实现方式：<a href="https://blog.csdn.net/sinat_41622641/article/details/81636682">Django Rest Swagger生成api文档</a></p> 
<p><strong>实现思路：</strong></p> 
<ol><li>修改settings配置，添加依赖库,添加swagger配置</li><li>修改urls.py 添加swagger文档路由，添加视图路由</li><li>添加视图类</li><li>实现序列化类</li><li>实现模型类</li></ol> 
<h4><a id="djangorestframework_27"></a>djangorestframework</h4> 
<p><img src="https://images2.imgbox.com/ce/e6/zmQBDJFM_o.png" alt=""><br> <img src="https://images2.imgbox.com/c0/cb/ZBG2jeqh_o.png" alt="在这里插入图片描述"></p> 
<p>这种模式在postman就能实现，没必要再自己再重新造一套。</p> 
<p><img src="https://images2.imgbox.com/15/f1/DKCOm9yk_o.png" alt="在这里插入图片描述"></p> 
<p>这种接口文档的形式，可以满足需求，但还是没有swagger优雅简洁。</p> 
<p>在实现这种模式的时候也遇到不少坑，最终没有呈现出这个效果。</p> 
<h4><a id="djangorestswaggerdeprecated_20190604_42"></a>django-rest-swagger：deprecated (2019-06-04)</h4> 
<ul><li>Django 1.8+</li><li>Django REST framework 3.5.1+</li><li>Python 2.7, 3.5, 3.6</li></ul> 
<p><img src="https://images2.imgbox.com/b4/66/49gr7dl5_o.png" alt="在这里插入图片描述"></p> 
<p>核心库还是在coreapi，djangorestframework。</p> 
<p>依赖于上述核心库的编码方式，换成了swagger的ui</p> 
<p>非常容易实现。</p> 
<h4><a id="drfyasg_57"></a>drf-yasg</h4> 
<ul><li><strong>Django Rest Framework</strong>: 3.10, 3.11, 3.12</li><li><strong>Django</strong>: 2.2, 3.0, 3.1</li><li><strong>Python</strong>: 3.6, 3.7, 3.8, 3.9</li></ul> 
<p><strong>特征：</strong></p> 
<ul><li>完全支持嵌套序列化器和模式</li><li>响应模式和描述</li><li>模型定义与代码生成工具兼容</li><li>在规范生成过程中的所有点上的定制挂钩</li><li>JSON和YAML格式的规范</li><li>捆绑了最新版本的swagger-ui和redoc，用于查看生成的文档</li><li>架构视图是可立即缓存的</li><li>生成的Swagger模式可以通过Swagger -spec-validator自动验证</li><li>通过URLPathVersioning和NamespaceVersioning支持Django REST框架API版本化;目前不支持其他DRF或自定义版本方案</li></ul> 
<p><strong>swagger模式</strong><br> <img src="https://images2.imgbox.com/12/41/7lq4nMbg_o.png" alt="在这里插入图片描述"></p> 
<p><strong>redoc模式</strong></p> 
<p><img src="https://images2.imgbox.com/56/d7/kIg5pJHn_o.png" alt="在这里插入图片描述"></p> 
<p>总结：提供了更加强大，更多的功能，以及在可视化ui上做得更好，本质上还是使用了djangorestframework的编码风格</p> 
<p>问题：由于python2.7的Django Rest Framework最高只支持3.9版本，所以不兼容3.10+的要求。故可预测该方案不可行。</p> 
<h4><a id="_87"></a>优缺点：</h4> 
<p>优点：</p> 
<ul><li>更规范科学的开发模式，自动生成api文档，节约大量在文档上编辑以及测试耗费的时间。</li><li>更直观的管理接口</li></ul> 
<p>缺点：</p> 
<ul><li>跟原项目的编码风格有较大出入，比如序列化过程，原项目并没有。而是直接从urls到service调用数据库。难以在项目开发规范中推广。</li><li>需要踩大量坑，由于原项目的python跟django版本较低，在刚尝试使用这种模式就遇到大量坑，很难预测之后会遇到什么坑。增加今后潜在的开发成本</li><li>需要配置session，目前还没有将项目内的接口跑通，测试成本还在增加。</li><li>代码侵入性较强，没办法简便的对已开发的接口进行改造，只能考虑后续加入的接口。</li></ul> 
<h4><a id="_101"></a>总结:</h4> 
<p>对于当前项目的python和django版本，当前查到的资料都脱离不开Django Rest Framework的编码风格，对于之前已经开发的接口难以引入，同事想要的是一款尽量只改变路由就能实现文档生成，而不是进行大量代码的侵入，所以并不能采用上述的库，当前探索先告一段落。</p> 
<h4><a id="_105"></a>踩坑记录：</h4> 
<ol><li>django1的urls.py中不支持path，改为url格式（django2才支持path）</li><li>django修改settings或修改requirement没必要将整个docker-compose重启，项目自动重启失败可以手动重启，也可以直接进docker上直接执行pip</li><li>you cannot access body after reding from request’s data stream</li></ol> 
<p>一旦对序列化类修改post传入的字段时，就会出现这个问题，查阅资料是说django不能让中间件修改request的post，所以用request.data而不是用request.body 或者将body的值用变量存起来再进行操作。</p> 
<p>4.实现GET路径传参、POST传参，需要重写schema_views.py</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>permissions <span class="token keyword">import</span> AllowAny
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>schemas <span class="token keyword">import</span> SchemaGenerator
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>schemas<span class="token punctuation">.</span>generators <span class="token keyword">import</span> LinkNode<span class="token punctuation">,</span> insert_into
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>renderers <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> rest_framework_swagger <span class="token keyword">import</span> renderers
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>views <span class="token keyword">import</span> APIView
<span class="token comment"># from rest_framework.schemas import SchemaGenerator</span>

<span class="token keyword">class</span> <span class="token class-name">MySchemaGenerator</span><span class="token punctuation">(</span>SchemaGenerator<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">get_links</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># from rest_framework.schemas.generators import LinkNode,</span>
        links <span class="token operator">=</span> LinkNode<span class="token punctuation">(</span><span class="token punctuation">)</span>

        paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        view_endpoints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> callback <span class="token keyword">in</span> self<span class="token punctuation">.</span>endpoints<span class="token punctuation">:</span>
            view <span class="token operator">=</span> self<span class="token punctuation">.</span>create_view<span class="token punctuation">(</span>callback<span class="token punctuation">,</span> method<span class="token punctuation">,</span> request<span class="token punctuation">)</span>
            path <span class="token operator">=</span> self<span class="token punctuation">.</span>coerce_path<span class="token punctuation">(</span>path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> view<span class="token punctuation">)</span>
            paths<span class="token punctuation">.</span>append<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
            view_endpoints<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Only generate the path prefix for paths that will be included</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> paths<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        prefix <span class="token operator">=</span> self<span class="token punctuation">.</span>determine_path_prefix<span class="token punctuation">(</span>paths<span class="token punctuation">)</span>

        <span class="token keyword">for</span> path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> view <span class="token keyword">in</span> view_endpoints<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>has_view_permissions<span class="token punctuation">(</span>path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            link <span class="token operator">=</span> view<span class="token punctuation">.</span>schema<span class="token punctuation">.</span>get_link<span class="token punctuation">(</span>path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> base_url<span class="token operator">=</span>self<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
            <span class="token comment"># 添加下面这一行方便在views编写过程中自定义参数.</span>
            link<span class="token punctuation">.</span>_fields <span class="token operator">+=</span> self<span class="token punctuation">.</span>get_core_fields<span class="token punctuation">(</span>view<span class="token punctuation">)</span>

            subpath <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            keys <span class="token operator">=</span> self<span class="token punctuation">.</span>get_keys<span class="token punctuation">(</span>subpath<span class="token punctuation">,</span> method<span class="token punctuation">,</span> view<span class="token punctuation">)</span>

            <span class="token comment"># from rest_framework.schemas.generators import LinkNode, insert_into</span>
            insert_into<span class="token punctuation">(</span>links<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> link<span class="token punctuation">)</span>

        <span class="token keyword">return</span> links

    <span class="token comment"># 从类中取出我们自定义的参数, 交给swagger 以生成接口文档.</span>
    <span class="token keyword">def</span> <span class="token function">get_core_fields</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token string">'coreapi_fields'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">SwaggerSchemaView</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    _ignore_model_permissions <span class="token operator">=</span> <span class="token boolean">True</span>
    exclude_from_schema <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token comment"># from rest_framework.permissions import AllowAny</span>
    permission_classes <span class="token operator">=</span> <span class="token punctuation">[</span>AllowAny<span class="token punctuation">]</span>
    <span class="token comment"># from rest_framework_swagger import renderers</span>
    <span class="token comment"># from rest_framework.renderers import *</span>
    renderer_classes <span class="token operator">=</span> <span class="token punctuation">[</span>
        CoreJSONRenderer<span class="token punctuation">,</span>
        renderers<span class="token punctuation">.</span>OpenAPIRenderer<span class="token punctuation">,</span>
        renderers<span class="token punctuation">.</span>SwaggerUIRenderer
  <span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    generator <span class="token operator">=</span> MySchemaGenerator<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">'接口文档'</span><span class="token punctuation">,</span>
                                  description<span class="token operator">=</span><span class="token triple-quoted-string string">'''接口文档'''</span><span class="token punctuation">)</span>

    schema <span class="token operator">=</span> generator<span class="token punctuation">.</span>get_schema<span class="token punctuation">(</span>request<span class="token operator">=</span>request<span class="token punctuation">)</span>

    <span class="token comment"># from rest_framework.response import Response</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span>schema<span class="token punctuation">)</span>
</code></pre> 
<p>post传参</p> 
<pre><code class="prism language-python">schema <span class="token operator">=</span> AutoSchema<span class="token punctuation">(</span>
            manual_fields<span class="token operator">=</span><span class="token punctuation">[</span>
                coreapi<span class="token punctuation">.</span>Field<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'code'</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token string">'form'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
</code></pre> 
<p>get请求</p> 
<pre><code class="prism language-python">coreapi_fields<span class="token operator">=</span><span class="token punctuation">(</span>
        DocParam<span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>5.“msg”: “‘CreateWhitelistGroupView’ object has no attribute ‘session’”,</p> 
<p>需要配置swagger登录获取session</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ab3344c397b36c04673580f4fdb4516c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">EPON技术基础知识</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a2c8386e8a4498581201e0cff2ebccf5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">The C Programming Language</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>