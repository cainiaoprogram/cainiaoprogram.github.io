<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>初探qiankunjs - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="初探qiankunjs" />
<meta property="og:description" content="qiankun对比single-spa qiankun基于single-spa，新增了很多特性。
预先加载的功能，利用空闲时间加载其他应用，使用import-html-entry包沙箱功能（创建一个sandbox，让脚本执行在sandbox里面），css沙箱（影子dom，scopedcss(加前缀))）获取导出的接入协议（在沙箱中执行的），进行扩展（比如设置全局变量。） 源码浅读：
// index.ts export { loadMicroApp, registerMicroApps, start } from &#39;./apis&#39;; export { initGlobalState } from &#39;./globalState&#39;; export { getCurrentRunningApp as __internalGetCurrentRunningApp } from &#39;./sandbox&#39;; export * from &#39;./errorHandler&#39;; export * from &#39;./effects&#39;; export * from &#39;./interfaces&#39;; export { prefetchImmediately as prefetchApps } from &#39;./prefetch&#39;; qiankun提供的registerMicroApps，注册应用的方法，实际上也是基于singe-spa的registerApplication方法
export function registerMicroApps&lt;T extends ObjectType&gt;( apps: Array&lt;RegistrableApp&lt;T&gt;&gt;, // 本次要注册的应用 lifeCycles?: FrameworkLifeCycles&lt;T&gt;, //自己编写的生命周期 ) { // Each app only needs to be registered once // 拿到没有注册过的应用，name属性用来区分不同应用 const unregisteredApps = apps." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f20af4df539d2ac0d515bf84b8009f28/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-08T09:59:43+08:00" />
<meta property="article:modified_time" content="2023-08-08T09:59:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">初探qiankunjs</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="qiankunsinglespa_0"></a>qiankun对比single-spa</h5> 
<p>qiankun基于single-spa，新增了很多特性。</p> 
<ul><li>预先加载的功能，利用空闲时间加载其他应用，使用import-html-entry包</li><li>沙箱功能（创建一个sandbox，让脚本执行在sandbox里面），css沙箱（影子dom，scopedcss(加前缀))）</li><li>获取导出的接入协议（在沙箱中执行的），进行扩展（比如设置全局变量。）</li></ul> 
<p>源码浅读：</p> 
<pre><code class="prism language-typescript"><span class="token comment">// index.ts</span>
<span class="token keyword">export</span> <span class="token punctuation">{<!-- --></span> loadMicroApp<span class="token punctuation">,</span> registerMicroApps<span class="token punctuation">,</span> start <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./apis'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{<!-- --></span> initGlobalState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./globalState'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{<!-- --></span> getCurrentRunningApp <span class="token keyword">as</span> __internalGetCurrentRunningApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./sandbox'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./errorHandler'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./effects'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./interfaces'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{<!-- --></span> prefetchImmediately <span class="token keyword">as</span> prefetchApps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./prefetch'</span><span class="token punctuation">;</span>

</code></pre> 
<p>qiankun提供的registerMicroApps，注册应用的方法，实际上也是基于singe-spa的registerApplication方法</p> 
<pre><code class="prism language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">registerMicroApps</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> ObjectType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  apps<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RegistrableApp<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 本次要注册的应用</span>
  lifeCycles<span class="token operator">?</span><span class="token operator">:</span> FrameworkLifeCycles<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">//自己编写的生命周期</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Each app only needs to be registered once</span>
  <span class="token comment">// 拿到没有注册过的应用，name属性用来区分不同应用</span>
  <span class="token keyword">const</span> unregisteredApps <span class="token operator">=</span> apps<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>microApps<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>registeredApp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> registeredApp<span class="token punctuation">.</span>name <span class="token operator">===</span> app<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 保存全部应用</span>
  microApps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>microApps<span class="token punctuation">,</span> <span class="token operator">...</span>unregisteredApps<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// 循环注册未注册的应用。</span>
  unregisteredApps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> name<span class="token punctuation">,</span> activeRule<span class="token punctuation">,</span> loader <span class="token operator">=</span> noop<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>appConfig <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>

    <span class="token comment">// single-spa的注册应用方法。(路由劫持)</span>
    <span class="token function">registerApplication</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      name<span class="token punctuation">,</span>
      <span class="token function-variable function">app</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">loader</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待调用start方法后才会执行</span>
        <span class="token keyword">await</span> frameworkStartedDefer<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> mount<span class="token punctuation">,</span> <span class="token operator">...</span>otherMicroAppConfigs <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
          <span class="token comment">// (loadApp())()</span>
          <span class="token keyword">await</span> <span class="token function">loadApp</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>appConfig <span class="token punctuation">}</span><span class="token punctuation">,</span> frameworkConfiguration<span class="token punctuation">,</span> lifeCycles<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 返回接入协议 </span>
          mount<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">toArray</span><span class="token punctuation">(</span>mount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token operator">...</span>otherMicroAppConfigs<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      activeWhen<span class="token operator">:</span> activeRule<span class="token punctuation">,</span>
      customProps<span class="token operator">:</span> props<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如上（single-spa路由拦截，匹配acriveRule，执行app方法）。其次看start方法</p> 
<pre><code class="prism language-typescript"><span class="token comment">/**
 * qiankun对比single-spa。多了预加载，和沙箱功能
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span>opts<span class="token operator">:</span> FrameworkConfiguration <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  frameworkConfiguration <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> prefetch<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> singular<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> sandbox<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">...</span>opts <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//默认参数，预加载，单例，沙盒</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> prefetch<span class="token punctuation">,</span> urlRerouteOnly <span class="token operator">=</span> defaultUrlRerouteOnly<span class="token punctuation">,</span> <span class="token operator">...</span>importEntryOpts <span class="token punctuation">}</span> <span class="token operator">=</span> frameworkConfiguration<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>prefetch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 预拉取</span>
    <span class="token function">doPrefetchStrategy</span><span class="token punctuation">(</span>microApps<span class="token punctuation">,</span> prefetch<span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对沙箱做降级处理 有的沙箱不支持proxy</span>
  frameworkConfiguration <span class="token operator">=</span> <span class="token function">autoDowngradeForLowVersionBrowser</span><span class="token punctuation">(</span>frameworkConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// single-spa开启应用</span>
  <span class="token function">startSingleSpa</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> urlRerouteOnly <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  frameworkStartedDefer<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>start方法中有一个预加载的功能，就是利用浏览器空闲时间去请求其他子应用的资源。doPrefetchStartegy最终调用</p> 
<pre><code class="prism language-typescript">
<span class="token keyword">function</span> <span class="token function">prefetchAfterFirstMounted</span><span class="token punctuation">(</span>apps<span class="token operator">:</span> AppMetadata<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opts<span class="token operator">?</span><span class="token operator">:</span> ImportEntryOpts<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 第一个应用mount之后触发</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'single-spa:first-mount'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> notLoadedApps <span class="token operator">=</span> apps<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getAppStatus</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">NOT_LOADED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> mountedApps <span class="token operator">=</span> <span class="token function">getMountedApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] prefetch starting after </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>mountedApps<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> mounted...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> notLoadedApps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    notLoadedApps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> entry <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">prefetch</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'single-spa:first-mount'</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">prefetch</span><span class="token punctuation">(</span>entry<span class="token operator">:</span> Entry<span class="token punctuation">,</span> opts<span class="token operator">?</span><span class="token operator">:</span> ImportEntryOpts<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>navigator<span class="token punctuation">.</span>onLine <span class="token operator">||</span> isSlowNetwork<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Don't prefetch if in a slow network or offline</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// import-html-entry包，获取url的脚本和样式等数据,加载html,注释掉css和js</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> getExternalScripts<span class="token punctuation">,</span> getExternalStyleSheets <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">importEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>getExternalStyleSheets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>getExternalScripts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> 
<p>该方法主要在监听第一个应用mouint之后，调用prefetch方法去预拉资源。而prefetch方法主要是利用requestIdLeCallback和import-html-entry包去获取资源。</p> 
<p>最后start方法调取single-spa的</p> 
<pre><code class="prism language-typescript">  <span class="token comment">// single-spa开启应用</span>
  <span class="token function">startSingleSpa</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> urlRerouteOnly <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>startSingleSpa方法，开启应用。</p> 
<h6><a id="_142"></a>接着就是路由匹配的时候加载子应用。主要看</h6> 
<pre><code class="prism language-typescript">    <span class="token comment">// single-spa的注册应用方法。(路由劫持)</span>
    <span class="token function">registerApplication</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      name<span class="token punctuation">,</span>
      <span class="token function-variable function">app</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">loader</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待调用start方法后才会执行</span>
        <span class="token keyword">await</span> frameworkStartedDefer<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> mount<span class="token punctuation">,</span> <span class="token operator">...</span>otherMicroAppConfigs <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
          <span class="token comment">// (loadApp())()</span>
          <span class="token keyword">await</span> <span class="token function">loadApp</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>appConfig <span class="token punctuation">}</span><span class="token punctuation">,</span> frameworkConfiguration<span class="token punctuation">,</span> lifeCycles<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 返回接入协议 </span>
          mount<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">toArray</span><span class="token punctuation">(</span>mount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token operator">...</span>otherMicroAppConfigs<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      activeWhen<span class="token operator">:</span> activeRule<span class="token punctuation">,</span>
      customProps<span class="token operator">:</span> props<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h6><a id="loadApp_170"></a>loadApp方法</h6> 
<p>先看整个方法</p> 
<pre><code class="prism language-typescript"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">loadApp</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> ObjectType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  app<span class="token operator">:</span> LoadableApp<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  configuration<span class="token operator">:</span> FrameworkConfiguration <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  lifeCycles<span class="token operator">?</span><span class="token operator">:</span> FrameworkLifeCycles<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ParcelConfigObjectGetter<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> entry<span class="token punctuation">,</span> name<span class="token operator">:</span> appName <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  <span class="token keyword">const</span> appInstanceId <span class="token operator">=</span> <span class="token function">genAppInstanceIdByName</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//给当前加载的应用起一个名字</span>

  <span class="token keyword">const</span> markName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] App </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>appInstanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> Loading</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">performanceMark</span><span class="token punctuation">(</span>markName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    singular <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    sandbox <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    excludeAssetFilter<span class="token punctuation">,</span>
    globalContext <span class="token operator">=</span> window<span class="token punctuation">,</span>
    <span class="token operator">...</span>importEntryOpts
  <span class="token punctuation">}</span> <span class="token operator">=</span> configuration<span class="token punctuation">;</span>

  <span class="token comment">// get the entry html content and script executor 使用import-html-entry拉资源，获取html文件和脚本的执行器，html的脚本会注视掉，然后转成execScripts,然后放在沙箱执行</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> template<span class="token punctuation">,</span> execScripts<span class="token punctuation">,</span> assetPublicPath<span class="token punctuation">,</span> getExternalScripts <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">importEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// trigger external scripts loading to make sure all assets are ready before execScripts calling</span>
  <span class="token keyword">await</span> <span class="token function">getExternalScripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行额外的脚本，确保真正的脚本执行之前加载完</span>

  <span class="token comment">// as single-spa load and bootstrap new app parallel with other apps unmounting</span>
  <span class="token comment">// (see https://github.com/CanopyTax/single-spa/blob/master/src/navigation/reroute.js#L74)</span>
  <span class="token comment">// we need wait to load the app until all apps are finishing unmount in singular mode</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//单例模式下，要保证之前的应用被卸载</span>
    <span class="token keyword">await</span> <span class="token punctuation">(</span>prevAppUnmountedDeferred <span class="token operator">&amp;&amp;</span> prevAppUnmountedDeferred<span class="token punctuation">.</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取文件内容，将html转为qiankun特定的html</span>
  <span class="token keyword">const</span> appContent <span class="token operator">=</span> <span class="token function">getDefaultTplWrapper</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">,</span> sandbox<span class="token punctuation">)</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// shadowDom加载css的方式</span>
  <span class="token keyword">const</span> strictStyleIsolation <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>sandbox<span class="token punctuation">.</span>strictStyleIsolation<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span> <span class="token operator">&amp;&amp;</span> strictStyleIsolation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token string">"[qiankun] strictStyleIsolation configuration will be removed in 3.0, pls don't depend on it or use experimentalStyleIsolation instead!"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 作用域css的处理(配置)</span>
  <span class="token keyword">const</span> scopedCSS <span class="token operator">=</span> <span class="token function">isEnableScopedCSS</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建一个div,根据样式是作用域样式还是严格样式隔离，分别作对应的处理.</span>
  <span class="token keyword">let</span> initialAppWrapperElement<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>
    appContent<span class="token punctuation">,</span>
    strictStyleIsolation<span class="token punctuation">,</span>
    scopedCSS<span class="token punctuation">,</span>
    appInstanceId<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> initialContainer <span class="token operator">=</span> <span class="token string">'container'</span> <span class="token keyword">in</span> app <span class="token operator">?</span> app<span class="token punctuation">.</span>container <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">//设置子应用的容器container</span>
  <span class="token keyword">const</span> legacyRender <span class="token operator">=</span> <span class="token string">'render'</span> <span class="token keyword">in</span> app <span class="token operator">?</span> app<span class="token punctuation">.</span>render <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">getRender</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">,</span> appContent<span class="token punctuation">,</span> legacyRender<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 第一次加载设置应用可见区域 dom 结构</span>
  <span class="token comment">// 确保每次应用加载前容器 dom 结构已经设置完毕</span>
  <span class="token comment">// 将创建的div设置到container里面</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> initialAppWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> container<span class="token operator">:</span> initialContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'loading'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取外层的div或者ShadowRoot</span>
  <span class="token keyword">const</span> initialAppWrapperGetter <span class="token operator">=</span> <span class="token function">getAppWrapperGetter</span><span class="token punctuation">(</span>
    appInstanceId<span class="token punctuation">,</span>
    <span class="token operator">!</span><span class="token operator">!</span>legacyRender<span class="token punctuation">,</span>
    strictStyleIsolation<span class="token punctuation">,</span>
    scopedCSS<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> initialAppWrapperElement<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> global <span class="token operator">=</span> globalContext<span class="token punctuation">;</span> <span class="token comment">//默认是window</span>
  <span class="token keyword">let</span> <span class="token function-variable function">mountSandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">unmountSandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> useLooseSandbox <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>sandbox<span class="token punctuation">.</span>loose<span class="token punctuation">;</span> <span class="token comment">// 快照沙箱</span>
  <span class="token comment">// enable speedy mode by default</span>
  <span class="token keyword">const</span> speedySandbox <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> sandbox<span class="token punctuation">.</span>speedy <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//proxy 沙箱</span>
  <span class="token keyword">let</span> sandboxContainer<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//  创建沙箱容器</span>
    sandboxContainer <span class="token operator">=</span> <span class="token function">createSandboxContainer</span><span class="token punctuation">(</span>
      appInstanceId<span class="token punctuation">,</span>
      <span class="token comment">// FIXME should use a strict sandbox logic while remount, see https://github.com/umijs/qiankun/issues/518</span>
      initialAppWrapperGetter<span class="token punctuation">,</span>
      scopedCSS<span class="token punctuation">,</span>
      useLooseSandbox<span class="token punctuation">,</span>
      excludeAssetFilter<span class="token punctuation">,</span>
      global<span class="token punctuation">,</span>
      speedySandbox<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用沙箱的代理对象作为接下来使用的全局对象，否则就是快照</span>
    global <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>proxy <span class="token keyword">as</span> <span class="token keyword">typeof</span> window<span class="token punctuation">;</span>
    mountSandbox <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>mount<span class="token punctuation">;</span>
    unmountSandbox <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>unmount<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取一些全局对象，默认给global(假的window,给子应用的)设置一些全局变量，比如global.__POWERED_BY_QIANKUN_等</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    beforeUnmount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    afterUnmount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    afterMount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    beforeMount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    beforeLoad <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">mergeWith</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAddOns</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> assetPublicPath<span class="token punctuation">)</span><span class="token punctuation">,</span> lifeCycles<span class="token punctuation">,</span> <span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">concat</span><span class="token punctuation">(</span>v1 <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v2 <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>beforeLoad<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行beforLoad函数，设置全局变量</span>

  <span class="token comment">// get the lifecycle hooks from module exports 执行子应用真正的脚本</span>
  <span class="token comment">// 根据指定的沙箱环境执行脚本</span>
  <span class="token keyword">const</span> scriptExports<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execScripts</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> sandbox <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>useLooseSandbox<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    scopedGlobalVariables<span class="token operator">:</span> speedySandbox <span class="token operator">?</span> cachedGlobals <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取到子应用export出来的生命周期函数</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> bootstrap<span class="token punctuation">,</span> mount<span class="token punctuation">,</span> unmount<span class="token punctuation">,</span> update <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getLifecyclesFromExports</span><span class="token punctuation">(</span>
    scriptExports<span class="token punctuation">,</span>
    appName<span class="token punctuation">,</span>
    global<span class="token punctuation">,</span>
    sandboxContainer<span class="token operator">?.</span>instance<span class="token operator">?.</span>latestSetProp<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> onGlobalStateChange<span class="token punctuation">,</span> setGlobalState<span class="token punctuation">,</span> offGlobalStateChange <span class="token punctuation">}</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> CallableFunction<span class="token operator">&gt;</span> <span class="token operator">=</span>
    <span class="token function">getMicroAppStateActions</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// FIXME temporary way</span>
  <span class="token keyword">const</span> <span class="token function-variable function">syncAppWrapperElement2Sandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span>element<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>initialAppWrapperElement <span class="token operator">=</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> parcelConfigGetter<span class="token operator">:</span> <span class="token function-variable function">ParcelConfigObjectGetter</span> <span class="token operator">=</span> <span class="token punctuation">(</span>remountContainer <span class="token operator">=</span> initialContainer<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> appWrapperElement<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> appWrapperGetter<span class="token operator">:</span> ReturnType<span class="token operator">&lt;</span><span class="token keyword">typeof</span> getAppWrapperGetter<span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">// 最终返回的config</span>
    <span class="token keyword">const</span> parcelConfig<span class="token operator">:</span> ParcelConfigObject <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      name<span class="token operator">:</span> appInstanceId<span class="token punctuation">,</span>
      bootstrap<span class="token punctuation">,</span>
      mount<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> marks <span class="token operator">=</span> <span class="token function">performanceGetEntriesByName</span><span class="token punctuation">(</span>markName<span class="token punctuation">,</span> <span class="token string">'mark'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// mark length is zero means the app is remounting</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>marks <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>marks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">performanceMark</span><span class="token punctuation">(</span>markName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 单例模式保证之前应用的卸载</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> prevAppUnmountedDeferred<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> prevAppUnmountedDeferred<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// initial wrapper element before app mount/remount</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          appWrapperElement <span class="token operator">=</span> initialAppWrapperElement<span class="token punctuation">;</span>
          appWrapperGetter <span class="token operator">=</span> <span class="token function">getAppWrapperGetter</span><span class="token punctuation">(</span>
            appInstanceId<span class="token punctuation">,</span>
            <span class="token operator">!</span><span class="token operator">!</span>legacyRender<span class="token punctuation">,</span>
            strictStyleIsolation<span class="token punctuation">,</span>
            scopedCSS<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> appWrapperElement<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 添加 mount hook, 确保每次应用加载前容器 dom 结构已经设置完毕</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> useNewContainer <span class="token operator">=</span> remountContainer <span class="token operator">!==</span> initialContainer<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>useNewContainer <span class="token operator">||</span> <span class="token operator">!</span>appWrapperElement<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// element will be destroyed after unmounted, we need to recreate it if it not exist</span>
            <span class="token comment">// or we try to remount into a new container</span>
            appWrapperElement <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>appContent<span class="token punctuation">,</span> strictStyleIsolation<span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">syncAppWrapperElement2Sandbox</span><span class="token punctuation">(</span>appWrapperElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> appWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> container<span class="token operator">:</span> remountContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'mounting'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        mountSandbox<span class="token punctuation">,</span> <span class="token comment">//沙箱挂载</span>
        <span class="token comment">// exec the chain after rendering to keep the behavior with beforeLoad</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>beforeMount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>props<span class="token punctuation">,</span> container<span class="token operator">:</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> setGlobalState<span class="token punctuation">,</span> onGlobalStateChange <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//执行子应用的mount函数</span>
        <span class="token comment">// finish loading after app mounted</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> appWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> container<span class="token operator">:</span> remountContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>afterMount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// initialize the unmount defer after app mounted and resolve the defer after it unmounted</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            prevAppUnmountedDeferred <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deferred<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> measureName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] App </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>appInstanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> Loading Consuming</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token function">performanceMeasure</span><span class="token punctuation">(</span>measureName<span class="token punctuation">,</span> markName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      unmount<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>beforeUnmount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>props<span class="token punctuation">,</span> container<span class="token operator">:</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        unmountSandbox<span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>afterUnmount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> container<span class="token operator">:</span> remountContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'unmounted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">offGlobalStateChange</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// for gc</span>
          appWrapperElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token function">syncAppWrapperElement2Sandbox</span><span class="token punctuation">(</span>appWrapperElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> prevAppUnmountedDeferred<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            prevAppUnmountedDeferred<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> update <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      parcelConfig<span class="token punctuation">.</span>update <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> parcelConfig<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> parcelConfigGetter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>从头往下：</p> 
<ul><li>先给子应用取名字，然后使用import-html-entry拉取子应用的资源。然后先执行额外的脚本，比如cdn，然后获取文件内容，就是将子应用的html文件转为特定的html，比如 <code>&lt;head&gt;转为&lt;qiakun-head&gt; </code><br> 然后将style和script注释掉，因为css的话会特别处理，还有脚本需要在沙箱里面执行。</li></ul> 
<pre><code class="prism language-typescript"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> entry<span class="token punctuation">,</span> name<span class="token operator">:</span> appName <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  <span class="token keyword">const</span> appInstanceId <span class="token operator">=</span> <span class="token function">genAppInstanceIdByName</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//给当前加载的应用起一个名字</span>

  <span class="token keyword">const</span> markName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] App </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>appInstanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> Loading</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">performanceMark</span><span class="token punctuation">(</span>markName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    singular <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    sandbox <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    excludeAssetFilter<span class="token punctuation">,</span>
    globalContext <span class="token operator">=</span> window<span class="token punctuation">,</span>
    <span class="token operator">...</span>importEntryOpts
  <span class="token punctuation">}</span> <span class="token operator">=</span> configuration<span class="token punctuation">;</span>

  <span class="token comment">// get the entry html content and script executor 使用import-html-entry拉资源，获取html文件和脚本的执行器，html的脚本会注视掉，然后转成execScripts,然后放在沙箱执行</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> template<span class="token punctuation">,</span> execScripts<span class="token punctuation">,</span> assetPublicPath<span class="token punctuation">,</span> getExternalScripts <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">importEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// trigger external scripts loading to make sure all assets are ready before execScripts calling</span>
  <span class="token keyword">await</span> <span class="token function">getExternalScripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行额外的脚本，确保真正的脚本执行之前加载完</span>

  <span class="token comment">// as single-spa load and bootstrap new app parallel with other apps unmounting</span>
  <span class="token comment">// (see https://github.com/CanopyTax/single-spa/blob/master/src/navigation/reroute.js#L74)</span>
  <span class="token comment">// we need wait to load the app until all apps are finishing unmount in singular mode</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//单例模式下，要保证之前的应用被卸载</span>
    <span class="token keyword">await</span> <span class="token punctuation">(</span>prevAppUnmountedDeferred <span class="token operator">&amp;&amp;</span> prevAppUnmountedDeferred<span class="token punctuation">.</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取文件内容，将html转为qiankun特定的html</span>
  <span class="token keyword">const</span> appContent <span class="token operator">=</span> <span class="token function">getDefaultTplWrapper</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">,</span> sandbox<span class="token punctuation">)</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>接着处理css(shadowdom或者css作用域)，</li></ul> 
<pre><code class="prism language-typescript"><span class="token comment">// shadowDom加载css的方式</span>
  <span class="token keyword">const</span> strictStyleIsolation <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>sandbox<span class="token punctuation">.</span>strictStyleIsolation<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span> <span class="token operator">&amp;&amp;</span> strictStyleIsolation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token string">"[qiankun] strictStyleIsolation configuration will be removed in 3.0, pls don't depend on it or use experimentalStyleIsolation instead!"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 作用域css的处理(配置)</span>
  <span class="token keyword">const</span> scopedCSS <span class="token operator">=</span> <span class="token function">isEnableScopedCSS</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建一个div,根据样式是作用域样式还是严格样式隔离，分别作对应的处理.</span>
  <span class="token keyword">let</span> initialAppWrapperElement<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>
    appContent<span class="token punctuation">,</span>
    strictStyleIsolation<span class="token punctuation">,</span>
    scopedCSS<span class="token punctuation">,</span>
    appInstanceId<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> initialContainer <span class="token operator">=</span> <span class="token string">'container'</span> <span class="token keyword">in</span> app <span class="token operator">?</span> app<span class="token punctuation">.</span>container <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">//设置子应用的容器container</span>
  <span class="token keyword">const</span> legacyRender <span class="token operator">=</span> <span class="token string">'render'</span> <span class="token keyword">in</span> app <span class="token operator">?</span> app<span class="token punctuation">.</span>render <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">getRender</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">,</span> appContent<span class="token punctuation">,</span> legacyRender<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 第一次加载设置应用可见区域 dom 结构</span>
  <span class="token comment">// 确保每次应用加载前容器 dom 结构已经设置完毕</span>
  <span class="token comment">// 将创建的div设置到container里面</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> initialAppWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> container<span class="token operator">:</span> initialContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'loading'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>qiankun支持start({sandbox:true|{strictStyleIsolation?: boolean, experimentalStyleIsolation?: boolean}})</p> 
<p>如上，如果sandbox.strictStyleIsolation开启，那就是严格css，这样会用shadowDom来加载css(qiankun3.0会移除)，如果不是sandbox.strictStyleIsolation，那么就会判断是不是sandbox.experimentalStyleIsolation，也就是scopedCSS(作用域css，给子应用所有的css加前缀)</p> 
<p>然后会创建一个element，将子应用文件内容注入到div里面去。(会根据用户配置处理css)</p> 
<pre><code class="prism language-typescript"><span class="token comment">/**
 * 创建div,将获取到的转化后的html加载进去，使用attachShadow沙箱模式隔离环境。
 * 再判断css的处理逻辑
 */</span>
<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span>
  appContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  strictStyleIsolation<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  scopedCSS<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  appInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> HTMLElement <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> containerElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  containerElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> appContent<span class="token punctuation">;</span>
  <span class="token comment">// appContent always wrapped with a singular div</span>
  <span class="token keyword">const</span> appElement <span class="token operator">=</span> containerElement<span class="token punctuation">.</span>firstChild <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>strictStyleIsolation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果是严格的样式隔离，就使用影子dom</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportShadowDOM<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">'[qiankun]: As current browser not support shadow dom, your strictStyleIsolation configuration will be ignored!'</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> innerHTML <span class="token punctuation">}</span> <span class="token operator">=</span> appElement<span class="token punctuation">;</span>
      appElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> shadow<span class="token operator">:</span> ShadowRoot<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>appElement<span class="token punctuation">.</span>attachShadow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        shadow <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> mode<span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// createShadowRoot was proposed in initial spec, which has then been deprecated</span>
        shadow <span class="token operator">=</span> <span class="token punctuation">(</span>appElement <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createShadowRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      shadow<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> innerHTML<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//对于作用域的css，就是拿到style标签里面的css,增加css前缀(对于link加载的css而言，也会转化)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scopedCSS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 重写css属性名</span>
    <span class="token keyword">const</span> attr <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>css<span class="token punctuation">.</span>QiankunCSSRewriteAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>attr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      appElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>css<span class="token punctuation">.</span>QiankunCSSRewriteAttr<span class="token punctuation">,</span> appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> styleNodes <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">forEach</span><span class="token punctuation">(</span>styleNodes<span class="token punctuation">,</span> <span class="token punctuation">(</span>stylesheetElement<span class="token operator">:</span> HTMLStyleElement<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 给每个样式都加上前缀名</span>
      css<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>appElement<span class="token operator">!</span><span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">,</span> appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> appElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如上，如果是严格css，那么就使用影子dom，此时影子dom跟外部的样式互不影响。如果是作用域css，那么给所有的css增加前缀，对于link加载的css也会转化。</p> 
<p>接着调用render({ element: initialAppWrapperElement, loading: true, container: initialContainer }, ‘loading’);</p> 
<p>将创建好的div，注入到container里面（用户配置,#app1)，确保每次加载前，dom结构已经设置完毕。</p> 
<ul><li>接着创建沙箱</li></ul> 
<pre><code class="prism language-typescript">
  <span class="token comment">// 获取外层的div或者ShadowRoot</span>
  <span class="token keyword">const</span> initialAppWrapperGetter <span class="token operator">=</span> <span class="token function">getAppWrapperGetter</span><span class="token punctuation">(</span>
    appInstanceId<span class="token punctuation">,</span>
    <span class="token operator">!</span><span class="token operator">!</span>legacyRender<span class="token punctuation">,</span>
    strictStyleIsolation<span class="token punctuation">,</span>
    scopedCSS<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> initialAppWrapperElement<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> global <span class="token operator">=</span> globalContext<span class="token punctuation">;</span> <span class="token comment">//默认是window</span>
  <span class="token keyword">let</span> <span class="token function-variable function">mountSandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">unmountSandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> useLooseSandbox <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>sandbox<span class="token punctuation">.</span>loose<span class="token punctuation">;</span> <span class="token comment">// 降级proxy沙箱</span>
  <span class="token comment">// enable speedy mode by default</span>
  <span class="token keyword">const</span> speedySandbox <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> sandbox<span class="token punctuation">.</span>speedy <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//proxy 沙箱</span>
  <span class="token keyword">let</span> sandboxContainer<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//  创建沙箱容器</span>
    sandboxContainer <span class="token operator">=</span> <span class="token function">createSandboxContainer</span><span class="token punctuation">(</span>
      appInstanceId<span class="token punctuation">,</span>
      <span class="token comment">// FIXME should use a strict sandbox logic while remount, see https://github.com/umijs/qiankun/issues/518</span>
      initialAppWrapperGetter<span class="token punctuation">,</span>
      scopedCSS<span class="token punctuation">,</span>
      useLooseSandbox<span class="token punctuation">,</span>
      excludeAssetFilter<span class="token punctuation">,</span>
      global<span class="token punctuation">,</span>
      speedySandbox<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用沙箱的代理对象作为接下来使用的全局对象，否则就是快照</span>
    global <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>proxy <span class="token keyword">as</span> <span class="token keyword">typeof</span> window<span class="token punctuation">;</span>
    mountSandbox <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>mount<span class="token punctuation">;</span>
    unmountSandbox <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>unmount<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>判断是否使用降级proxy沙箱还是正常的proxy沙箱。接着调用createSandboxContainer创建沙箱。</p> 
<pre><code class="prism language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createSandboxContainer</span><span class="token punctuation">(</span>
  appName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token function-variable function">elementGetter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> HTMLElement <span class="token operator">|</span> ShadowRoot<span class="token punctuation">,</span>
  scopedCSS<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  useLooseSandbox<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  excludeAssetFilter<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  globalContext<span class="token operator">?</span><span class="token operator">:</span> <span class="token keyword">typeof</span> window<span class="token punctuation">,</span>
  speedySandBox<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> sandbox<span class="token operator">:</span> SandBox<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Proxy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    sandbox <span class="token operator">=</span> useLooseSandbox
      <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">LegacySandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> globalContext<span class="token punctuation">)</span> <span class="token comment">//为了兼容性 singular 模式下依旧使用该沙箱</span>
      <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ProxySandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> globalContext<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> speedy<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>speedySandBox <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//proxy 沙箱</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    sandbox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnapshotSandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//快照沙箱</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// some side effect could be invoked while bootstrapping, such as dynamic stylesheet injection with style-loader, especially during the development phase</span>
  <span class="token keyword">const</span> bootstrappingFreers <span class="token operator">=</span> <span class="token function">patchAtBootstrapping</span><span class="token punctuation">(</span>
    appName<span class="token punctuation">,</span>
    elementGetter<span class="token punctuation">,</span>
    sandbox<span class="token punctuation">,</span>
    scopedCSS<span class="token punctuation">,</span>
    excludeAssetFilter<span class="token punctuation">,</span>
    speedySandBox<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// mounting freers are one-off and should be re-init at every mounting time</span>
  <span class="token keyword">let</span> mountingFreers<span class="token operator">:</span> Freer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> sideEffectsRebuilders<span class="token operator">:</span> Rebuilder<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    instance<span class="token operator">:</span> sandbox<span class="token punctuation">,</span>

    <span class="token comment">/**
     * 沙箱被 mount
     * 可能是从 bootstrap 状态进入的 mount
     * 也可能是从 unmount 之后再次唤醒进入 mount
     */</span>
    <span class="token keyword">async</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* ------------------------------------------ 因为有上下文依赖（window），以下代码执行顺序不能变 ------------------------------------------ */</span>

      <span class="token comment">/* ------------------------------------------ 1. 启动/恢复 沙箱------------------------------------------ */</span>
      sandbox<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> sideEffectsRebuildersAtBootstrapping <span class="token operator">=</span> sideEffectsRebuilders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bootstrappingFreers<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> sideEffectsRebuildersAtMounting <span class="token operator">=</span> sideEffectsRebuilders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>bootstrappingFreers<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// must rebuild the side effects which added at bootstrapping firstly to recovery to nature state</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sideEffectsRebuildersAtBootstrapping<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sideEffectsRebuildersAtBootstrapping<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rebuild<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/* ------------------------------------------ 2. 开启全局变量补丁 ------------------------------------------*/</span>
      <span class="token comment">// render 沙箱启动时开始劫持各类全局监听，尽量不要在应用初始化阶段有 事件监听/定时器 等副作用</span>
      mountingFreers <span class="token operator">=</span> <span class="token function">patchAtMounting</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> elementGetter<span class="token punctuation">,</span> sandbox<span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> excludeAssetFilter<span class="token punctuation">,</span> speedySandBox<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">/* ------------------------------------------ 3. 重置一些初始化时的副作用 ------------------------------------------*/</span>
      <span class="token comment">// 存在 rebuilder 则表明有些副作用需要重建</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sideEffectsRebuildersAtMounting<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sideEffectsRebuildersAtMounting<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rebuild<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// clean up rebuilders</span>
      sideEffectsRebuilders <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 恢复 global 状态，使其能回到应用加载之前的状态
     */</span>
    <span class="token keyword">async</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// record the rebuilders of window side effects (event listeners or timers)</span>
      <span class="token comment">// note that the frees of mounting phase are one-off as it will be re-init at next mounting</span>
      sideEffectsRebuilders <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>bootstrappingFreers<span class="token punctuation">,</span> <span class="token operator">...</span>mountingFreers<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>free<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      sandbox<span class="token punctuation">.</span><span class="token function">inactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>判断使用快照沙箱还是proxy沙箱，然后返回一个包含mount和unmount等的对象，这里需要执行对应时期的一些函数。</p> 
<p>沙箱分两种类型，app环境沙箱和render沙箱。</p> 
<p>app环境沙箱应用初始化过之后，应用会在什么样的上下文环境运行。每个应用的环境沙箱只会初始化一次，因为子应用只会触发一次 bootstrap 。</p> 
<p>render沙箱是子应用在app mount之前开始生成的沙箱，每次子应用切换过后，render沙箱都会重新初始化。</p> 
<ul><li>创建沙箱之后，就需要设置全局变量，然后执行子应用的js脚本。</li></ul> 
<pre><code class="prism language-typescript"><span class="token comment">// 获取一些全局对象，默认给global(假的window,给子应用的)设置一些全局变量，比如global.__POWERED_BY_QIANKUN_等</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    beforeUnmount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    afterUnmount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    afterMount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    beforeMount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    beforeLoad <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">mergeWith</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAddOns</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> assetPublicPath<span class="token punctuation">)</span><span class="token punctuation">,</span> lifeCycles<span class="token punctuation">,</span> <span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">concat</span><span class="token punctuation">(</span>v1 <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v2 <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>beforeLoad<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行beforLoad函数，设置全局变量</span>

  <span class="token comment">// get the lifecycle hooks from module exports 执行子应用真正的脚本</span>
  <span class="token comment">// 根据指定的沙箱环境执行脚本</span>
  <span class="token keyword">const</span> scriptExports<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execScripts</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> sandbox <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>useLooseSandbox<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    scopedGlobalVariables<span class="token operator">:</span> speedySandbox <span class="token operator">?</span> cachedGlobals <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取到子应用export出来的生命周期函数</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> bootstrap<span class="token punctuation">,</span> mount<span class="token punctuation">,</span> unmount<span class="token punctuation">,</span> update <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getLifecyclesFromExports</span><span class="token punctuation">(</span>
    scriptExports<span class="token punctuation">,</span>
    appName<span class="token punctuation">,</span>
    global<span class="token punctuation">,</span>
    sandboxContainer<span class="token operator">?.</span>instance<span class="token operator">?.</span>latestSetProp<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// qiankun3.0即将舍弃</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> onGlobalStateChange<span class="token punctuation">,</span> setGlobalState<span class="token punctuation">,</span> offGlobalStateChange <span class="token punctuation">}</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> CallableFunction<span class="token operator">&gt;</span> <span class="token operator">=</span>
    <span class="token function">getMicroAppStateActions</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>使用mergeWidth收集每个时期应该做的事情。如getAddOns(global, assetPublicPath)，assetPublicPath在import-html-entry获取目标资源的时候就已经获取到了。</p> 
<pre><code class="prism language-typescript"><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{<!-- --></span> FrameworkLifeCycles <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../interfaces'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getAddOn</span><span class="token punctuation">(</span>global<span class="token operator">:</span> Window<span class="token punctuation">)</span><span class="token operator">:</span> FrameworkLifeCycles<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">async</span> <span class="token function">beforeLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// eslint-disable-next-line no-param-reassign</span>
      global<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token keyword">async</span> <span class="token function">beforeMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// eslint-disable-next-line no-param-reassign</span>
      global<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token keyword">async</span> <span class="token function">beforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// eslint-disable-next-line no-param-reassign</span>
      <span class="token keyword">delete</span> global<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getAddOn</span><span class="token punctuation">(</span>global<span class="token operator">:</span> Window<span class="token punctuation">,</span> publicPath <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token operator">:</span> FrameworkLifeCycles<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> hasMountedOnce <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">async</span> <span class="token function">beforeLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// eslint-disable-next-line no-param-reassign</span>
      global<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__ <span class="token operator">=</span> publicPath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token keyword">async</span> <span class="token function">beforeMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasMountedOnce<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// eslint-disable-next-line no-param-reassign</span>
        global<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__ <span class="token operator">=</span> publicPath<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token keyword">async</span> <span class="token function">beforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rawPublicPath <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// eslint-disable-next-line no-param-reassign</span>
        <span class="token keyword">delete</span> global<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// eslint-disable-next-line no-param-reassign</span>
        global<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__ <span class="token operator">=</span> rawPublicPath<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      hasMountedOnce <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>设置子应用的__INJECTED_PUBLIC_PATH_BY_QIANKUN__属性。这也可以理解子应用可以获取到qiankun特定的全局属性。</p> 
<p>接着执行beforeLoad函数，设置全局变量。</p> 
<pre><code class="prism language-typescript">  <span class="token comment">// 根据指定的沙箱环境执行脚本</span>
  <span class="token keyword">const</span> scriptExports<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execScripts</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> sandbox <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>useLooseSandbox<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    scopedGlobalVariables<span class="token operator">:</span> speedySandbox <span class="token operator">?</span> cachedGlobals <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>根据指定的沙箱环境，执行子应用真正的脚本(这时css和extra脚本已经执行完毕)execScripts是import-html-entry的包</p> 
<pre><code class="prism language-typescript"> <span class="token comment">// 获取到子应用export出来的生命周期函数</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> bootstrap<span class="token punctuation">,</span> mount<span class="token punctuation">,</span> unmount<span class="token punctuation">,</span> update <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getLifecyclesFromExports</span><span class="token punctuation">(</span>
    scriptExports<span class="token punctuation">,</span>
    appName<span class="token punctuation">,</span>
    global<span class="token punctuation">,</span>
    sandboxContainer<span class="token operator">?.</span>instance<span class="token operator">?.</span>latestSetProp<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>通过他的返回，可以获取到子应用入口文件export出来的生命周期函数。</p> 
<ul><li>接着是最后一步，因为qiankun是基于single-spa的，所以相当于在应用跟single-sap中间拦截了一层，多执行了一些东西，然后将对应的接入协议(bootsrtap，mount，unmount)继续交个sinle-spa处理。</li></ul> 
<pre><code class="prism language-typescript"><span class="token keyword">const</span> parcelConfigGetter<span class="token operator">:</span> <span class="token function-variable function">ParcelConfigObjectGetter</span> <span class="token operator">=</span> <span class="token punctuation">(</span>remountContainer <span class="token operator">=</span> initialContainer<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> appWrapperElement<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> appWrapperGetter<span class="token operator">:</span> ReturnType<span class="token operator">&lt;</span><span class="token keyword">typeof</span> getAppWrapperGetter<span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">// 最终返回的config</span>
    <span class="token keyword">const</span> parcelConfig<span class="token operator">:</span> ParcelConfigObject <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      name<span class="token operator">:</span> appInstanceId<span class="token punctuation">,</span>
      bootstrap<span class="token punctuation">,</span>
      mount<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> marks <span class="token operator">=</span> <span class="token function">performanceGetEntriesByName</span><span class="token punctuation">(</span>markName<span class="token punctuation">,</span> <span class="token string">'mark'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// mark length is zero means the app is remounting</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>marks <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>marks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">performanceMark</span><span class="token punctuation">(</span>markName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 单例模式保证之前应用的卸载</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> prevAppUnmountedDeferred<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> prevAppUnmountedDeferred<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// initial wrapper element before app mount/remount</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          appWrapperElement <span class="token operator">=</span> initialAppWrapperElement<span class="token punctuation">;</span>
          appWrapperGetter <span class="token operator">=</span> <span class="token function">getAppWrapperGetter</span><span class="token punctuation">(</span>
            appInstanceId<span class="token punctuation">,</span>
            <span class="token operator">!</span><span class="token operator">!</span>legacyRender<span class="token punctuation">,</span>
            strictStyleIsolation<span class="token punctuation">,</span>
            scopedCSS<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> appWrapperElement<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 添加 mount hook, 确保每次应用加载前容器 dom 结构已经设置完毕</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> useNewContainer <span class="token operator">=</span> remountContainer <span class="token operator">!==</span> initialContainer<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>useNewContainer <span class="token operator">||</span> <span class="token operator">!</span>appWrapperElement<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// element will be destroyed after unmounted, we need to recreate it if it not exist</span>
            <span class="token comment">// or we try to remount into a new container</span>
            appWrapperElement <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>appContent<span class="token punctuation">,</span> strictStyleIsolation<span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">syncAppWrapperElement2Sandbox</span><span class="token punctuation">(</span>appWrapperElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> appWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> container<span class="token operator">:</span> remountContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'mounting'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        mountSandbox<span class="token punctuation">,</span> <span class="token comment">//沙箱挂载</span>
        <span class="token comment">// exec the chain after rendering to keep the behavior with beforeLoad</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>beforeMount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>props<span class="token punctuation">,</span> container<span class="token operator">:</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> setGlobalState<span class="token punctuation">,</span> onGlobalStateChange <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//执行子应用的mount函数</span>
        <span class="token comment">// finish loading after app mounted</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> appWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> container<span class="token operator">:</span> remountContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>afterMount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// initialize the unmount defer after app mounted and resolve the defer after it unmounted</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            prevAppUnmountedDeferred <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deferred<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> measureName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] App </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>appInstanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> Loading Consuming</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token function">performanceMeasure</span><span class="token punctuation">(</span>measureName<span class="token punctuation">,</span> markName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      unmount<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>beforeUnmount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>props<span class="token punctuation">,</span> container<span class="token operator">:</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        unmountSandbox<span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>afterUnmount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> container<span class="token operator">:</span> remountContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'unmounted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">offGlobalStateChange</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// for gc</span>
          appWrapperElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token function">syncAppWrapperElement2Sandbox</span><span class="token punctuation">(</span>appWrapperElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> prevAppUnmountedDeferred<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            prevAppUnmountedDeferred<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> update <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      parcelConfig<span class="token punctuation">.</span>update <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> parcelConfig<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre> 
<p>最终返回的parcelConfig，里面就包含single-spa需要的接入协议。如上，moutn和unmount都执行了除子应用的之外，还执行了很多其他逻辑。</p> 
<p>如mount函数：</p> 
<pre><code class="prism language-typescript">  mount<span class="token operator">:</span> <span class="token punctuation">[</span>
       <span class="token comment">// 1 单例模式保证之前应用的卸载</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> prevAppUnmountedDeferred<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> prevAppUnmountedDeferred<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// initial wrapper element before app mount/remount</span>
	<span class="token comment">// 2 初始化容器在app mount之前</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          appWrapperElement <span class="token operator">=</span> initialAppWrapperElement<span class="token punctuation">;</span>
          appWrapperGetter <span class="token operator">=</span> <span class="token function">getAppWrapperGetter</span><span class="token punctuation">(</span>
            appInstanceId<span class="token punctuation">,</span>
            <span class="token operator">!</span><span class="token operator">!</span>legacyRender<span class="token punctuation">,</span>
            strictStyleIsolation<span class="token punctuation">,</span>
            scopedCSS<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> appWrapperElement<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 3 添加 mount hook, 确保每次应用加载前容器 dom 结构已经设置完毕</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> useNewContainer <span class="token operator">=</span> remountContainer <span class="token operator">!==</span> initialContainer<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>useNewContainer <span class="token operator">||</span> <span class="token operator">!</span>appWrapperElement<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// element will be destroyed after unmounted, we need to recreate it if it not exist</span>
            <span class="token comment">// or we try to remount into a new container</span>
            appWrapperElement <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>appContent<span class="token punctuation">,</span> strictStyleIsolation<span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">syncAppWrapperElement2Sandbox</span><span class="token punctuation">(</span>appWrapperElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> appWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> container<span class="token operator">:</span> remountContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'mounting'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
	 <span class="token comment">// 4沙箱挂载</span>
        mountSandbox<span class="token punctuation">,</span>
        <span class="token comment">// exec the chain after rendering to keep the behavior with beforeLoad</span>
	<span class="token comment">// 5 执行对应的beofrMount函数， 设置全局变量</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>beforeMount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token comment">// 6 执行子应用的mount函数</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>props<span class="token punctuation">,</span> container<span class="token operator">:</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> setGlobalState<span class="token punctuation">,</span> onGlobalStateChange <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// finish loading after app mounted</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> element<span class="token operator">:</span> appWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> container<span class="token operator">:</span> remountContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">// 7 执行对应的afterMount函数</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>afterMount<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// initialize the unmount defer after app mounted and resolve the defer after it unmounted</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            prevAppUnmountedDeferred <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deferred<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> measureName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] App </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>appInstanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> Loading Consuming</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token function">performanceMeasure</span><span class="token punctuation">(</span>measureName<span class="token punctuation">,</span> markName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> 
<p>最终将返回的parcelConfig交给single-spa处理。single-spa拦截路由匹配到路径的时候，就会执行该子应用对应的函数，也就会执行上述的一些逻辑。</p> 
<p>未完待续…</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ab03e3173174e72c6cc48514bb61e66a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">窥探系列之Mybatis-plus XML分页查询</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/63f1ea53bf55c9863e283805b56d5048/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python报错：IndexError: invalid index of a 0-dim tensor. Use `tensor.item()` in</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>