<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sql server 2016 Always on 实现无域高可用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Sql server 2016 Always on 实现无域高可用" />
<meta property="og:description" content="Sql server 2016 Always on 实现无域高可用 上一篇：sql server 2016 Always on 无域部署教程 使用三台服务器组成了sql server 高可用，但是基于成本考虑很多情况下我们只有两台服务器，今天就来测试下用两台服务器来组建sql server 高可用。
一、环境准备 ①、服务器及IP规划 主机名IP地址描述sql3.yishoe.com192.168.6.53数据库sql4.yishoe.com192.168.6.54数据库win-cluster192.168.6.56集群侦听IPsqlcluster192.168.6.57sql 高可用侦听IP ②、设置集群节点主机名，每个节点都需要设置 修改hosts文件，文件路径：C:\Windows\System32\drivers\etc
192.168.6.53 sql3.yishoe.com 192.168.6.54 sql4.yishoe.com 192.168.6.56 win-cluster.yishoe.com 192.168.6.57 sqlcluster.yishoe.com 直至可以使用主机名互相ping通
③、防火墙放行 注：两台服务器都需要放行
3.1、开启ICMP回显已检测服务器是否可以ping通
3.2、放行1433（Sql Server数据库端口）/5022（数据库镜像端口）
3.3、开启WMI、及远程相关应用和功能防火墙放行。（生产环境不建议关闭防火墙）
回显开启，方便测试服务器是否通达
故障转移集群需要允许通过防火墙
④、安装Windows Failover Cluster Feature（win 故障转移集群） 注：两台服务器都需要安装
⑤、安装sql server 注：两台服务器单独安装
二、创建Win 故障转移集群 ①、使用powershell创建故障转移集群 管理员启动powershell
New-Cluster –Name win-cluster -Node sql3.yishoe.com,sql4.yishoe.com -AdministrativeAccessPoint DNS -StaticAddress 192.168.6.56 创建完成
–获取集群名
Get-Cluster
–群集详情
Get-ClusterResource
②、验证集群高可用 先ping一下试试" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f344623d4aa9ef954e76af79546ef9e5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-11T17:44:56+08:00" />
<meta property="article:modified_time" content="2021-03-11T17:44:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Sql server 2016 Always on 实现无域高可用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Sql_server_2016_Always_on__0"></a>Sql server 2016 Always on 实现无域高可用</h3> 
<p>上一篇：<a href="https://blog.csdn.net/xjjj064/article/details/113651591">sql server 2016 Always on 无域部署教程</a> 使用三台服务器组成了sql server 高可用，但是基于成本考虑很多情况下我们只有两台服务器，今天就来测试下用两台服务器来组建sql server 高可用。</p> 
<h2><a id="_3"></a>一、环境准备</h2> 
<h3><a id="IP_4"></a>①、服务器及IP规划</h3> 
<table><thead><tr><th>主机名</th><th>IP地址</th><th>描述</th></tr></thead><tbody><tr><td>sql3.yishoe.com</td><td>192.168.6.53</td><td>数据库</td></tr><tr><td>sql4.yishoe.com</td><td>192.168.6.54</td><td>数据库</td></tr><tr><td>win-cluster</td><td>192.168.6.56</td><td>集群侦听IP</td></tr><tr><td>sqlcluster</td><td>192.168.6.57</td><td>sql 高可用侦听IP</td></tr></tbody></table> 
<h3><a id="_12"></a>②、设置集群节点主机名，每个节点都需要设置</h3> 
<p><img src="https://images2.imgbox.com/36/b5/OWEMXddY_o.png" alt="在这里插入图片描述"><br> 修改hosts文件，文件路径：C:\Windows\System32\drivers\etc</p> 
<pre><code class="prism language-bash">192.168.6.53  sql3.yishoe.com
192.168.6.54  sql4.yishoe.com
192.168.6.56  win-cluster.yishoe.com
192.168.6.57  sqlcluster.yishoe.com
</code></pre> 
<p>直至可以使用主机名互相ping通<br> <img src="https://images2.imgbox.com/7f/08/1worKN3D_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_24"></a>③、防火墙放行</h3> 
<p><strong>注：两台服务器都需要放行</strong></p> 
<p>3.1、开启ICMP回显已检测服务器是否可以ping通<br> 3.2、放行1433（Sql Server数据库端口）/5022（数据库镜像端口）<br> 3.3、开启WMI、及远程相关应用和功能防火墙放行。（生产环境不建议关闭防火墙）</p> 
<p>回显开启，方便测试服务器是否通达<br> <img src="https://images2.imgbox.com/9b/53/7mCHdpqB_o.png" alt="在这里插入图片描述"><br> 故障转移集群需要允许通过防火墙<br> <img src="https://images2.imgbox.com/0e/32/UQgpuDrt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ce/5f/PrVhY4OI_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Windows_Failover_Cluster_Featurewin__38"></a>④、安装Windows Failover Cluster Feature（win 故障转移集群）</h3> 
<p><strong>注：两台服务器都需要安装</strong><br> <img src="https://images2.imgbox.com/1a/be/JUoE4qTZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="sql_server_42"></a>⑤、安装sql server</h3> 
<p><strong>注：两台服务器单独安装</strong><br> <img src="https://images2.imgbox.com/d5/21/z1uiZ380_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Win__46"></a>二、创建Win 故障转移集群</h3> 
<h3><a id="powershell_47"></a>①、使用powershell创建故障转移集群</h3> 
<p>管理员启动powershell</p> 
<pre><code class="prism language-bash">New-Cluster –Name win-cluster -Node sql3.yishoe.com,sql4.yishoe.com  -AdministrativeAccessPoint DNS -StaticAddress 192.168.6.56
</code></pre> 
<p>创建完成<br> <img src="https://images2.imgbox.com/68/61/NFSAZ37X_o.png" alt="在这里插入图片描述"><br> –获取集群名<br> Get-Cluster<br> <img src="https://images2.imgbox.com/3c/81/LVS5SQjl_o.png" alt="在这里插入图片描述"><br> –群集详情<br> Get-ClusterResource<br> <img src="https://images2.imgbox.com/78/e2/keG8hg1F_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_64"></a>②、验证集群高可用</h3> 
<p>先ping一下试试<br> <img src="https://images2.imgbox.com/b7/48/2mLAEfsZ_o.png" alt="在这里插入图片描述"><br> 管理故障转移集群<br> 在服务器管理器–&gt;工具–&gt;故障转移群集–&gt;右键故障转移群集管理器–&gt;连接到群集（N）–&gt;输入集群的名称，如：win-cluster<br> 注：故障转移集群名称必须能ping通，能解析。<br> <img src="https://images2.imgbox.com/88/f0/4bO6jwS3_o.png" alt="在这里插入图片描述"><br> 我们关闭了一台服务器<br> <img src="https://images2.imgbox.com/ed/be/cD2RqPKa_o.png" alt="在这里插入图片描述"><br> 将关闭的服务器重新启动<br> 集群恢复正常<br> <img src="https://images2.imgbox.com/9a/31/YqW8KwUp_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Sql_Server_2016_Alwayson_77"></a>三、配置Sql Server 2016 Alwayson</h2> 
<h3><a id="sql_server_always_on_78"></a>①、sql server 启用always on</h3> 
<p>注：两台sql server 服务器都需要启用<br> 启用后需要重启下sql server服务<br> <img src="https://images2.imgbox.com/78/e0/kk5n6VhL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="sql_server__82"></a>②、sql server 启动用户</h3> 
<p>百度到的文章都说需要启用单独的统一的用户启动，我这里就是用系统NT Service 用户启动<br> <img src="https://images2.imgbox.com/ff/04/acaVUGCm_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_85"></a>③、新建一共享文件夹用户</h3> 
<p>只给administrator 权限<br> <img src="https://images2.imgbox.com/93/c1/37vUDBix_o.png" alt="在这里插入图片描述"></p> 
<p>在另外一台服务器测试访问没问题<br> <img src="https://images2.imgbox.com/5c/b1/n5g0wg8I_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_91"></a>④、为数据库通信创建证书</h3> 
<p>注：先两个节点分别执行step1生产证书后，将sql3服务器生产的证书copy到sql4服务器指定目录下（C:\software\cerficates）。<br> 然后再执行step2、step3两个步骤！</p> 
<p><strong>sql3 服务器执行</strong></p> 
<pre><code class="prism language-bash">--step1
CREATE MASTER KEY ENCRYPTION BY PASSWORD <span class="token operator">=</span> <span class="token string">'*********'</span>
--创建主密钥
CREATE CERTIFICATE cer_alwayson_063
WITH SUBJECT<span class="token operator">=</span><span class="token string">'alwayson 063 local certificate'</span>,
EXPIRY_DATE<span class="token operator">=</span><span class="token string">'9999-12-31'</span>
--创建证书  这里有两个<span class="token string">"cer_alwayson_063"</span>,建议每台机器都改成不同的名称以作区分
EXEC xp_create_subdir <span class="token string">'C:\software\cerficates'</span>
--创建存放证书目录
BACKUP CERTIFICATE cer_alwayson_063
TO FILE<span class="token operator">=</span><span class="token string">'C:\software\cerficates\cer_alwayson_063.cer'</span>
--将证书保存在本地C:\software\cerficates 路径下
CREATE ENDPOINT Endpoint_Mirroring
STATE <span class="token operator">=</span> STARTED
AS TCP <span class="token punctuation">(</span>LISTENER_PORT <span class="token operator">=</span> 5022, LISTENER_IP <span class="token operator">=</span> ALL<span class="token punctuation">)</span>
FOR DATABASE_MIRRORING <span class="token punctuation">(</span>AUTHENTICATION <span class="token operator">=</span> CERTIFICATE cer_alwayson_063, 
ENCRYPTION <span class="token operator">=</span> REQUIRED ALGORITHM AES, 
ROLE <span class="token operator">=</span> ALL<span class="token punctuation">)</span>
--创建镜像端点
--step2:
CREATE LOGIN alwayson_user 
WITH PASSWORD<span class="token operator">=</span><span class="token string">'*********'</span>,
CHECK_POLICY<span class="token operator">=</span>OFF
--创建镜像用户
USE MASTER
GO
CREATE USER alwayson_user FOR LOGIN alwayson_user

CREATE CERTIFICATE cer_alwayson_064
AUTHORIZATION alwayson_user
FROM FILE<span class="token operator">=</span><span class="token string">'C:\software\cerficates\cer_alwayson_064.cer'</span>

--step3:grant connection right
GRANT CONNECT ON ENDPOINT:: Endpoint_Mirroring TO alwayson_user
</code></pre> 
<p><strong>sql4服务器执行</strong></p> 
<pre><code class="prism language-bash">--step1
CREATE MASTER KEY ENCRYPTION BY PASSWORD <span class="token operator">=</span> <span class="token string">'***********'</span>
--创建主密钥
CREATE CERTIFICATE cer_alwayson_064
WITH SUBJECT<span class="token operator">=</span><span class="token string">'alwayson 064 local certificate'</span>,
EXPIRY_DATE<span class="token operator">=</span><span class="token string">'9999-12-31'</span>
--创建证书  这里有两个<span class="token string">"cer_alwayson_064"</span>,建议每台机器都改成不同的名称以作区分
EXEC xp_create_subdir <span class="token string">'C:\software\cerficates'</span>
--创建存放证书目录
BACKUP CERTIFICATE cer_alwayson_064
TO FILE<span class="token operator">=</span><span class="token string">'C:\software\cerficates\cer_alwayson_064.cer'</span>
--将证书保存在本地C:\software\cerficates 路径下
CREATE ENDPOINT Endpoint_Mirroring
STATE <span class="token operator">=</span> STARTED
AS TCP <span class="token punctuation">(</span>LISTENER_PORT <span class="token operator">=</span> 5022, LISTENER_IP <span class="token operator">=</span> ALL<span class="token punctuation">)</span>
FOR DATABASE_MIRRORING <span class="token punctuation">(</span>AUTHENTICATION <span class="token operator">=</span> CERTIFICATE cer_alwayson_064, 
ENCRYPTION <span class="token operator">=</span> REQUIRED ALGORITHM AES, 
ROLE <span class="token operator">=</span> ALL<span class="token punctuation">)</span>
--创建镜像端点
--step2:
CREATE LOGIN alwayson_user 
WITH PASSWORD<span class="token operator">=</span><span class="token string">'**********'</span>,
CHECK_POLICY<span class="token operator">=</span>OFF
--创建镜像用户
USE MASTER
GO
CREATE USER alwayson_user FOR LOGIN alwayson_user

CREATE CERTIFICATE cer_alwayson_063
AUTHORIZATION alwayson_user
FROM FILE<span class="token operator">=</span><span class="token string">'C:\software\cerficates\cer_alwayson_063.cer'</span>

--step3:grant connection right
GRANT CONNECT ON ENDPOINT:: Endpoint_Mirroring TO alwayson_user
</code></pre> 
<h3><a id="_173"></a>⑤、建一个测试数据库</h3> 
<p>sql3作为主数据库服务器创建一个新测试数据库<br> <img src="https://images2.imgbox.com/25/d3/T8fHqWIV_o.png" alt="在这里插入图片描述"><br> 将sql3上的Demo数据库做一个完整备份和日志备份还原到sql4服务器上<br> 注：恢复状态需设置为RESTORE WITH NORECOVERY<br> <strong>注：按此手动同步数据库，创建可用性组后需要进入副本服务器sql 可用性组中将副本服务器上的数据库手动联接到可用性组</strong><br> <img src="https://images2.imgbox.com/39/2d/qEr2cKEj_o.png" alt="在这里插入图片描述"><br> 查看sql4上数据库状态<br> <img src="https://images2.imgbox.com/5b/cf/CnAl9IlW_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_sql_server_always_on__184"></a>⑥、配置 sql server always on 可用性</h3> 
<p>此操作在sql3上执行<br> <img src="https://images2.imgbox.com/11/28/APP95AoW_o.png" alt="在这里插入图片描述"><br> 设置可用性组名称，例如：sqlcluster<br> <img src="https://images2.imgbox.com/ad/94/iy8JJ9CZ_o.png" alt="在这里插入图片描述"><br> 选择需要高可用的数据库<br> <img src="https://images2.imgbox.com/bc/f2/kFeyJtMA_o.png" alt="在这里插入图片描述"><br> 指定副本<br> <img src="https://images2.imgbox.com/2d/7a/jCTh4iIM_o.png" alt="在这里插入图片描述"><br> 设置可用性模式为同步提交，且都可读。并勾选自动故障转移！<br> <img src="https://images2.imgbox.com/c0/3a/1NqKRqin_o.png" alt="在这里插入图片描述"><br> 备份可以在任何副本上执行<br> <img src="https://images2.imgbox.com/2f/95/x8ywRQ8R_o.png" alt="在这里插入图片描述"><br> 创建侦听器：sqlcluster<br> <img src="https://images2.imgbox.com/ec/f0/6bdUa4nH_o.png" alt="在这里插入图片描述"><br> 数据库同步方式<br> 我这里选择手动备份还原，所以跳过初始化同步。<br> <img src="https://images2.imgbox.com/e2/ad/of60o8Xx_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/90/be/WvoC8Qzt_o.png" alt="在这里插入图片描述"><br> 验证没问题就执行下一步<br> <img src="https://images2.imgbox.com/04/dc/VYxp9nKd_o.png" alt="在这里插入图片描述"><br> 接下来喝杯茶，等着安装完成。<br> <img src="https://images2.imgbox.com/7b/fd/pYbKjh1m_o.png" alt="在这里插入图片描述"><br> 注：上面配置完之后还有一部需要操作，否则查看sql server 可用性组面板显示错误<br> <img src="https://images2.imgbox.com/5d/7b/wKPuyzbH_o.png" alt="在这里插入图片描述"></p> 
<p>在副本服务器上将数据库联接到可用性组<br> <img src="https://images2.imgbox.com/97/0f/hbjBv24I_o.png" alt="在这里插入图片描述"><br> 再次刷新可用性面板<br> <img src="https://images2.imgbox.com/5f/62/yIU5BvUw_o.png" alt="在这里插入图片描述"><br> 高可用性就搭建好了！</p> 
<h2><a id="_216"></a>四、报错处理</h2> 
<p>①、没有做事务日志还原<br> <img src="https://images2.imgbox.com/ad/d1/1oxxEFXB_o.png" alt="在这里插入图片描述"><br> 解决办法：在主数据库服务器备份最新事务日志还原到报错的节点即可。</p> 
<p>参考：<a href="https://blog.csdn.net/roven257/article/details/78691892">配置SQL Server 2016无域AlwaysOn</a><br> 参考：<a href="https://blog.csdn.net/WSD_CSDN/article/details/90410208">sql server 2016 AlwaysOn实现无域高可用全教程</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f4b868aa84ca13a5563552af17663f7c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">人人都想了解的BGP，路由策略这样处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cadf553f95b92503743cea743ace8f0a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">笔记本电脑升级内存指南（如何选择内存条）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>