<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>分类分析-案例：客户流失预测分析与应用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="分类分析-案例：客户流失预测分析与应用" />
<meta property="og:description" content="来自：宋天龙《PYTHON数据分析与数据化运营》，以下内容比较简陋，方便日后翻阅。
1. 业务场景 业务部门希望数据部门能对流失用户做分析，找到流失用户的典型特征，例如：到底流失用户的哪些特征最显著，当客户在哪些特征的什么条件下比较容易发生流失行为，并送到业务部门。
分析：
1.这是关于特征提取的分析工作，目标是交付特征重要性和特征规则；
2.该需求可以通过决策树实现，本例使用XGBoost
3.必须给业务部门提供规则图
4.数据集样本不平衡，因为流失用户是少量的，即使CGBoost对缺失值不敏感，但是过采样不允许有空值，故需要对缺失值处理。
2. python实现 1.导包，数据读取、预处理 # 导入库 import pandas as pd from sklearn.model_selection import train_test_split # 数据分区库 import xgboost as xgb from sklearn.metrics import accuracy_score, auc, confusion_matrix, f1_score, \ precision_score, recall_score, roc_curve # 导入指标库 from imblearn.over_sampling import SMOTE # 过抽样处理库SMOTE import matplotlib.pyplot as plt import prettytable # 导入表格库 # 读取准备 raw_data = pd.read_csv(&#39;classification.csv&#39;, delimiter=&#39;,&#39;) # 读取数据文件 X,y = raw_data.iloc[:, :-1],raw_data.iloc[:, -1] # 分割X,y n_samples, n_features = X." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/847b8c20b7eb5b1f156a4ad16c5c129c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-29T16:42:00+08:00" />
<meta property="article:modified_time" content="2020-09-29T16:42:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">分类分析-案例：客户流失预测分析与应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><font size="2"><font color="red"> 来自：宋天龙《PYTHON数据分析与数据化运营》，以下内容比较简陋，方便日后翻阅。</font><br> <img src="https://images2.imgbox.com/dc/a0/ERfpAaR8_o.png" alt="在这里插入图片描述"></font></p> 
<h2><a id="1__3"></a>1. 业务场景</h2> 
<p>业务部门希望数据部门能对流失用户做分析，找到流失用户的典型特征，例如：到底流失用户的哪些特征最显著，当客户在哪些特征的什么条件下比较容易发生流失行为，并送到业务部门。</p> 
<p>分析：<br> 1.这是关于特征提取的分析工作，目标是交付特征重要性和特征规则；<br> 2.该需求可以通过决策树实现，本例使用XGBoost<br> 3.必须给业务部门提供规则图<br> 4.数据集样本不平衡，因为流失用户是少量的，即使CGBoost对缺失值不敏感，但是过采样不允许有空值，故需要对缺失值处理。</p> 
<h2><a id="2_python_11"></a>2. python实现</h2> 
<h3><a id="1_12"></a>1.导包，数据读取、预处理</h3> 
<pre><code class="prism language-python"><span class="token comment"># 导入库</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split  <span class="token comment"># 数据分区库</span>
<span class="token keyword">import</span> xgboost <span class="token keyword">as</span> xgb
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> accuracy_score<span class="token punctuation">,</span> auc<span class="token punctuation">,</span> confusion_matrix<span class="token punctuation">,</span> f1_score<span class="token punctuation">,</span> \
    precision_score<span class="token punctuation">,</span> recall_score<span class="token punctuation">,</span> roc_curve  <span class="token comment"># 导入指标库</span>
<span class="token keyword">from</span> imblearn<span class="token punctuation">.</span>over_sampling <span class="token keyword">import</span> SMOTE  <span class="token comment"># 过抽样处理库SMOTE</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> prettytable  <span class="token comment"># 导入表格库</span>
<span class="token comment"># 读取准备</span>
raw_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'classification.csv'</span><span class="token punctuation">,</span> delimiter<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">)</span>  <span class="token comment"># 读取数据文件</span>
X<span class="token punctuation">,</span>y <span class="token operator">=</span> raw_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>raw_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 分割X,y</span>
n_samples<span class="token punctuation">,</span> n_features <span class="token operator">=</span> X<span class="token punctuation">.</span>shape  <span class="token comment"># 总样本量,总特征数</span>
<span class="token comment"># 数据基本审查</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'samples: {0}| features: {1} | X和y含有nan值的列数na count: {2}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>n_samples<span class="token punctuation">,</span> n_features<span class="token punctuation">,</span>raw_data<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 数据预处理</span>
<span class="token comment"># 填充缺失值</span>
X <span class="token operator">=</span> X<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>X<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 样本均衡处理</span>
<span class="token comment">#'''</span>
model_smote <span class="token operator">=</span> SMOTE<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 建立SMOTE模型对象</span>
X<span class="token punctuation">,</span> y <span class="token operator">=</span> model_smote<span class="token punctuation">.</span>fit_sample<span class="token punctuation">(</span>X<span class="token punctuation">,</span>y<span class="token punctuation">)</span>  <span class="token comment"># 输入数据并作过抽样处理</span>
<span class="token comment">#'''</span>
<span class="token comment"># 拆分数据集</span>
X <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>X<span class="token punctuation">,</span>columns<span class="token operator">=</span>raw_data<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>
    X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">.3</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">#</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9a/db/VPT1Jkhp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_43"></a>2.模型训练</h3> 
<pre><code class="prism language-python"><span class="token comment"># XGB分类模型训练</span>
<span class="token comment">#依次指定二分类、10个基模型、每个模型用得样本是总体样本得80%、最大深度10、使用全部CPU资源</span>
param_dist <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'objective'</span><span class="token punctuation">:</span> <span class="token string">'binary:logistic'</span><span class="token punctuation">,</span> <span class="token string">'n_estimators'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
              <span class="token string">'subsample'</span><span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'n_jobs'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span>
model_xgb <span class="token operator">=</span> xgb<span class="token punctuation">.</span>XGBClassifier<span class="token punctuation">(</span><span class="token operator">**</span>param_dist<span class="token punctuation">)</span>
model_xgb<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
pre_y <span class="token operator">=</span> model_xgb<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/54/71/u2dav3s7_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_55"></a>3.混淆矩阵</h3> 
<p><img src="https://images2.imgbox.com/64/84/fTNqjDmr_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token comment"># 混淆矩阵</span>
tn<span class="token punctuation">,</span> fp<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> tp <span class="token operator">=</span> confusion_matrix<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span> pre_y<span class="token punctuation">)</span><span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获得混淆矩阵</span>
confusion_matrix_table <span class="token operator">=</span> prettytable<span class="token punctuation">.</span>PrettyTable<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'prediction-0'</span><span class="token punctuation">,</span><span class="token string">'prediction-1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 创建表格实例</span>
confusion_matrix_table<span class="token punctuation">.</span>add_row<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'actual-0'</span><span class="token punctuation">,</span>tp<span class="token punctuation">,</span>fn<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 增加第一行数据</span>
confusion_matrix_table<span class="token punctuation">.</span>add_row<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'actual-1'</span><span class="token punctuation">,</span>fp<span class="token punctuation">,</span>tn<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 增加第二行数据</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'confusion matrix \n'</span><span class="token punctuation">,</span>confusion_matrix_table<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a3/89/n1N3VG0M_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_67"></a>4.输出重要特征</h3> 
<pre><code class="prism language-python"><span class="token comment"># 输出特征重要性</span>
<span class="token comment">#指定参数：树模型对象、条形图得高度、特征重要性按平均增益值、10个特征、</span>
xgb<span class="token punctuation">.</span>plot_importance<span class="token punctuation">(</span>model_xgb<span class="token punctuation">,</span>height<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>importance_type<span class="token operator">=</span><span class="token string">'gain'</span><span class="token punctuation">,</span>max_num_features<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>xlabel<span class="token operator">=</span><span class="token string">'Gain Split'</span><span class="token punctuation">,</span>grid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> 
</code></pre> 
<p><img src="https://images2.imgbox.com/1f/d7/Bu7RqCtj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_74"></a>5.输出树形规则图</h3> 
<p><mark>注意：使用conda install -c https://pypi.tuna.tsinghua.edu.cn/simple python-graphviz</mark></p> 
<pre><code class="prism language-python"><span class="token comment">#树模型对象、指定树得index（10个树，索引0-9）、值为真得颜色，值为假得颜色</span>
digraph<span class="token operator">=</span>xgb<span class="token punctuation">.</span>to_graphviz<span class="token punctuation">(</span>model_xgb<span class="token punctuation">,</span> num_trees<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> yes_color<span class="token operator">=</span><span class="token string">'#638e5e'</span><span class="token punctuation">,</span> no_color<span class="token operator">=</span><span class="token string">'#a40000'</span><span class="token punctuation">)</span> 
digraph<span class="token punctuation">.</span><span class="token builtin">format</span> <span class="token operator">=</span> <span class="token string">'png'</span>
digraph<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token string">'./iris_xgb'</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/16/5a/UWE6RMOp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6_83"></a>6.对不同规则进行分析</h3> 
<p>分析不同规则下，对应到测试集发生样本的以及预测得概率</p> 
<pre><code class="prism language-python"><span class="token comment"># 前N条规则对应的用户数据</span>
rule_depth_1 <span class="token operator">=</span> X_test<span class="token punctuation">[</span><span class="token string">'internet'</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0.00284512946</span>
rule_depth_2 <span class="token operator">=</span> X_test<span class="token punctuation">[</span><span class="token string">'longten'</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">230.75</span>
rule_depth_3 <span class="token operator">=</span> X_test<span class="token punctuation">[</span><span class="token string">'total_orders'</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">2.97253799</span>
rule_depth_4 <span class="token operator">=</span> X_test<span class="token punctuation">[</span><span class="token string">'sex'</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0.972537994</span>
rule_depth_5 <span class="token operator">=</span> X_test<span class="token punctuation">[</span><span class="token string">'wireten'</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">86.0607376</span>
rule_list <span class="token operator">=</span> <span class="token punctuation">[</span>rule_depth_1<span class="token punctuation">,</span>rule_depth_2<span class="token punctuation">,</span>rule_depth_3<span class="token punctuation">,</span>rule_depth_4<span class="token punctuation">,</span>rule_depth_5<span class="token punctuation">]</span>
rule_pd <span class="token operator">=</span> <span class="token punctuation">[</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> rule_list<span class="token punctuation">]</span>
rule_pd_merge <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>rule_pd<span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">#rule_pd_merge是五列值，值分别是True\False</span>
<span class="token comment"># 遍历不同条件下用户的情况</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dyn_rules <span class="token operator">=</span> rule_pd_merge<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># 取出top规则</span>
    dyn_rules<span class="token punctuation">[</span><span class="token string">'is_true'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">all</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">==</span><span class="token boolean">True</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> dyn_rules<span class="token punctuation">.</span>values<span class="token punctuation">]</span><span class="token comment"># 得到都为true的record</span>
    y_test_selected <span class="token operator">=</span> y_test<span class="token punctuation">[</span>dyn_rules<span class="token punctuation">[</span><span class="token string">'is_true'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    y_pre_selected <span class="token operator">=</span> y_score<span class="token punctuation">[</span>dyn_rules<span class="token punctuation">[</span><span class="token string">'is_true'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    y_pre_cal <span class="token operator">=</span> y_pre_selected<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span><span class="token number">0.5</span><span class="token comment">#说明标签是1，即流失的客户</span>
    total_samples <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y_pre_cal<span class="token punctuation">)</span>
    is_churn <span class="token operator">=</span> y_pre_cal<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    churn_rate <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>is_churn<span class="token punctuation">)</span><span class="token operator">/</span>total_samples
    <span class="token comment"># 计算样本比例</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'total samples: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>total_samples<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'churn samples: {} | rate: {:.0%} '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>is_churn<span class="token punctuation">,</span>churn_rate<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'unchurn samples: {} | rate: {:.0%} '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>total_samples<span class="token operator">-</span>is_churn<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>churn_rate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token operator">*</span><span class="token number">40</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ef/86/qcHzXruZ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c5/48/fimbmdUP_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a77d2996350367744d01f447beb2002d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">lotus 区块高度 导出快照</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/967ad76bbe2a4d6ee0de84f713500918/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring框架入门</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>