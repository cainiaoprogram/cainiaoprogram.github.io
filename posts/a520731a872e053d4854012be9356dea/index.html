<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>go-zero 3—客户端负载均衡算法及实现 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="go-zero 3—客户端负载均衡算法及实现" />
<meta property="og:description" content="本篇文章已经被 go-zero 团队的 微服务实践 公众号收录
自己实现的代码地址 https://github.com/wanmei002/goutil/blob/master/rpc/balancer/p2c-ewma.go
背景 我们希望每次选择的节点都是负载最低的、响应最快的节点来处理我们的请求。在这里 go-zero 选择了 p2c&#43;EWMA算法来实现。
采用的算法的中心思想 p2c p2c(Pick Of 2 Choices)二选一: 在多个节点中随机选择两个节点。
go-zero 中的会随机的选择3次，如果其中一次选择的节点的健康条件满足要求，就中断选择，采用这两个节点。
EWMA EWMA(Exponentially Weighted Moving-Average)指数移动加权平均法: 是指各数值的加权系数随时间呈指数递减，越靠近
当前时刻的数值加权系数就越大，体现了最近一段时间内的平均值。
公式:
变量解释:
Vt: 代表的是第t次请求的 EWMA值Vt-1: 代表的是第 t-1 次请求的 EWMA 值β: 是一个常量 EWMA算法的优势 相较于普通的计算平均值算法，EWMA不需要保存过去所有的数值，计算量显著减少，同时也减小了存储资源。传统的计算平均值算法对网络耗时不敏感, 而 EWMA 可以通过请求频繁来调节β，进而迅速监控到网络毛刺 或 更多的体现整体平均值 当请求较为频繁时, 说明节点网络负载升高了, 我们想监测到此时节点处理请求的耗时(侧面反映了节点的负载情况), 我们就相应的调小β。β越小，EWMA值就越接近本次耗时，进而迅速监测到网络毛刺;当请求较为不频繁时, 我们就相对的调大β值。这样计算出来的EWMA值越接近平均值 β计算 go-zero 采用的是牛顿冷却定律中的衰减函数模型计算EWMA算法中的β值:
其中Δt为两次请求的间隔，e，k为常数
简单介绍gRPC中实现自定义负载均衡器 首先我们需要实现 google.golang.org/grpc/balancer/base/base.go/PickerBuilder 接口, 这个接口是有服务节点更新的时候会调用接口里的Build方法 type PickerBuilder interface { // Build returns a picker that will be used by gRPC to pick a SubConn." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a520731a872e053d4854012be9356dea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-04T20:17:29+08:00" />
<meta property="article:modified_time" content="2021-08-04T20:17:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">go-zero 3—客户端负载均衡算法及实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>本篇文章已经被 go-zero 团队的 <code>微服务实践</code> 公众号收录</p> 
</blockquote> 
<h4><a id="_1"></a>自己实现的代码地址</h4> 
<p><a href="https://github.com/wanmei002/goutil/blob/master/rpc/balancer/p2c-ewma.go">https://github.com/wanmei002/goutil/blob/master/rpc/balancer/p2c-ewma.go</a></p> 
<h4><a id="_3"></a>背景</h4> 
<p>我们希望每次选择的节点都是负载最低的、响应最快的节点来处理我们的请求。在这里 go-zero 选择了 p2c+EWMA算法来实现。</p> 
<h4><a id="_6"></a>采用的算法的中心思想</h4> 
<h5><a id="p2c_7"></a>p2c</h5> 
<p>p2c(Pick Of 2 Choices)二选一: 在多个节点中随机选择两个节点。</p> 
<p>go-zero 中的会随机的选择3次，如果其中一次选择的节点的健康条件满足要求，就中断选择，采用这两个节点。</p> 
<h5><a id="EWMA_12"></a>EWMA</h5> 
<p>EWMA(Exponentially Weighted Moving-Average)指数移动加权平均法: 是指各数值的加权系数随时间呈指数递减，越靠近<br> 当前时刻的数值加权系数就越大，体现了最近一段时间内的平均值。</p> 
<ul><li> <p>公式:<br> <img src="https://images2.imgbox.com/c6/3a/JiBGcFuU_o.png" alt="请添加图片描述"></p> </li><li> <p>变量解释:</p> 
  <ul><li>Vt: 代表的是第t次请求的 EWMA值</li><li>Vt-1: 代表的是第 t-1 次请求的 EWMA 值</li><li>β: 是一个常量</li></ul> </li></ul> 
<h5><a id="EWMA_24"></a>EWMA算法的优势</h5> 
<ol><li>相较于普通的计算平均值算法，EWMA不需要保存过去所有的数值，计算量显著减少，同时也减小了存储资源。</li><li>传统的计算平均值算法对网络耗时不敏感, 而 EWMA 可以通过请求频繁来调节β，进而迅速监控到网络毛刺 或 更多的体现整体平均值 
  <ul><li>当请求较为频繁时, 说明节点网络负载升高了, 我们想监测到此时节点处理请求的耗时(侧面反映了节点的负载情况), 我们就相应的调小β。β越小，EWMA值就越接近本次耗时，进而迅速监测到网络毛刺;</li><li>当请求较为不频繁时, 我们就相对的调大β值。这样计算出来的EWMA值越接近平均值</li></ul> </li></ol> 
<h6><a id="_30"></a>β计算</h6> 
<p>go-zero 采用的是牛顿冷却定律中的衰减函数模型计算EWMA算法中的β值:</p> 
<p><img src="https://images2.imgbox.com/96/5f/CTNYdU7B_o.png" alt="请添加图片描述"></p> 
<p>其中Δt为两次请求的间隔，e，k为常数</p> 
<h4><a id="gRPC_37"></a>简单介绍gRPC中实现自定义负载均衡器</h4> 
<ol><li>首先我们需要实现 google.golang.org/grpc/balancer/base/base.go/PickerBuilder 接口, 这个接口是有服务节点更新的时候会调用接口里的<code>Build</code>方法</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">type</span> PickerBuilder <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Build returns a picker that will be used by gRPC to pick a SubConn.</span>
    <span class="token function">Build</span><span class="token punctuation">(</span>info PickerBuildInfo<span class="token punctuation">)</span> balancer<span class="token punctuation">.</span>Picker
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>还要实现 google.golang.org/grpc/balancer/balancer.go/Picker 接口。这个接口主要实现负载均衡，挑选一个节点供请求使用</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Picker <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">Pick</span><span class="token punctuation">(</span>info PickInfo<span class="token punctuation">)</span> <span class="token punctuation">(</span>PickResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>最后向负载均衡 map 中注册我们实现的负载均衡器</li></ol> 
<h4><a id="gozero__53"></a>go-zero 实现负载均衡的主要逻辑</h4> 
<ol><li>在每次节点更新，gRPC会调用 Build 方法，此时在Build 里实现保存所有的节点信息。</li><li>gRPC在获取节点处理请求时，会调用 Pick 方法以获取节点。go-zero 在Pick 方法里实现了p2c算法，挑选节点，并通过节点的 EWMA值计算负载情况，返回负载低的节点供gRPC使用。</li><li>在请求结束的时候 gRPC 会调用 PickResult.Done 方法，go-zero 在这个方法里实现了本次请求耗时等信息的存储，并计算出了 EWMA 值保存了起来，供下次请求时计算负载等情况的使用</li></ol> 
<h4><a id="_58"></a>实现负载均衡的精要代码</h4> 
<h5><a id="_59"></a>服务的所有节点信息保存起来</h5> 
<h6><a id="EWMAgozero__60"></a>我们需要保存节点处理本次请求的耗时、EWMA等信息，go-zero 给每个节点设计了如下结构：</h6> 
<pre><code class="prism language-go"><span class="token keyword">type</span> subConn <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    addr     resolver<span class="token punctuation">.</span>Address
    conn     balancer<span class="token punctuation">.</span>SubConn
    lag      <span class="token builtin">uint64</span> <span class="token comment">// 用来保存 ewma 值</span>
    inflight <span class="token builtin">int64</span> <span class="token comment">// 用在保存当前节点正在处理的请求总数</span>
    success  <span class="token builtin">uint64</span> <span class="token comment">// 用来标识一段时间内此连接的健康状态</span>
    requests <span class="token builtin">int64</span> <span class="token comment">// 用来保存请求总数</span>
    last     <span class="token builtin">int64</span> <span class="token comment">// 用来保存上一次请求耗时, 用于计算 ewma 值</span>
    pick     <span class="token builtin">int64</span> <span class="token comment">// 保存上一次被选中的时间点</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="p2cPicker__balancerPicker_conns__73"></a>p2cPicker 实现了 balancer.Picker 接口，<code>conns</code> 保存了服务的所有节点信息</h6> 
<pre><code class="prism language-go"><span class="token keyword">type</span> p2cPicker <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	conns <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>subConn  <span class="token comment">// 保存所有节点的信息 </span>
	r     <span class="token operator">*</span>rand<span class="token punctuation">.</span>Rand
	stamp <span class="token operator">*</span>syncx<span class="token punctuation">.</span>AtomicDuration
	lock  sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="gRPC_Build__subConn__p2cPicker__82"></a>gRPC在节点有更新的时候会调用 Build 方法，传入所有节点信息，我们在这里把每个节点信息用 subConn 结构保存起来。并归并到一起用 p2cPicker 结构保存起来</h6> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>p2cPickerBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span>info base<span class="token punctuation">.</span>PickerBuildInfo<span class="token punctuation">)</span> balancer<span class="token punctuation">.</span>Picker <span class="token punctuation">{<!-- --></span>
	<span class="token operator">...</span><span class="token operator">...</span>
	<span class="token keyword">var</span> conns <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>subConn
	<span class="token keyword">for</span> conn<span class="token punctuation">,</span> connInfo <span class="token operator">:=</span> <span class="token keyword">range</span> readySCs <span class="token punctuation">{<!-- --></span>
		conns <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>conns<span class="token punctuation">,</span> <span class="token operator">&amp;</span>subConn<span class="token punctuation">{<!-- --></span>
			addr<span class="token punctuation">:</span>    connInfo<span class="token punctuation">.</span>Address<span class="token punctuation">,</span>
			conn<span class="token punctuation">:</span>    conn<span class="token punctuation">,</span>
			success<span class="token punctuation">:</span> initSuccess<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>p2cPicker<span class="token punctuation">{<!-- --></span>
		conns<span class="token punctuation">:</span> conns<span class="token punctuation">,</span>
		r<span class="token punctuation">:</span>     rand<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">NewSource</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		stamp<span class="token punctuation">:</span> syncx<span class="token punctuation">.</span><span class="token function">NewAtomicDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_102"></a>随机挑选节点信息</h5> 
<h6><a id="_103"></a>在这里分了三种情况:</h6> 
<ol><li>只有一个服务节点，此时直接返回供gRPC使用即可</li><li>有两个服务节点，通过 EWMA 值计算负载，并返回负载低的节点返回供 gRPC 使用</li><li>有多个服务节点，此时通过 p2c 算法选出两个节点，比较负载情况，返回负载低的节点供 gRPC 使用<br> 下面贴下主要实现代码:</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">switch</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>conns<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span> 没有节点，返回错误
		<span class="token keyword">return</span> emptyPickResult<span class="token punctuation">,</span> balancer<span class="token punctuation">.</span>ErrNoSubConnAvailable
	<span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span> 有一个节点，直接返回这个节点
		chosen <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>conns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span> 有两个节点，计算负载，返回负载低的节点
		chosen <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>conns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>conns<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span> 有多个节点，p2c 挑选两个节点，比较这两个节点的负载，返回负载低的节点
		<span class="token keyword">var</span> node1<span class="token punctuation">,</span> node2 <span class="token operator">*</span>subConn
        <span class="token comment">// 3次随机选择两个节点</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pickTimes<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
			a <span class="token operator">:=</span> p<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>conns<span class="token punctuation">)</span><span class="token punctuation">)</span>
			b <span class="token operator">:=</span> p<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>conns<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> b <span class="token operator">&gt;=</span> a <span class="token punctuation">{<!-- --></span>
				b<span class="token operator">++</span>
			<span class="token punctuation">}</span>
			node1 <span class="token operator">=</span> p<span class="token punctuation">.</span>conns<span class="token punctuation">[</span>a<span class="token punctuation">]</span>
			node2 <span class="token operator">=</span> p<span class="token punctuation">.</span>conns<span class="token punctuation">[</span>b<span class="token punctuation">]</span>
			<span class="token comment">// 如果这次选择的节点达到了健康要求, 就中断选择</span>
			<span class="token keyword">if</span> node1<span class="token punctuation">.</span><span class="token function">healthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> node2<span class="token punctuation">.</span><span class="token function">healthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 比较两个节点的负载情况，选择负载低的</span>
		chosen <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>node1<span class="token punctuation">,</span> node2<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="load_137"></a><code>load</code>计算节点的负载情况</h6> 
<p>上面的 choose 方法会调用 load 方法来计算节点负载。</p> 
<p>计算负载的公式是: load = ewma * inflight;</p> 
<p>在这里简单解释下： ewma 相当于平均请求耗时，inflight 是当前节点正在处理请求的数量，相乘大致计算出了当前节点的网络负载</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>subConn<span class="token punctuation">)</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 通过 EWMA 计算节点的负载情况； 加 1 是为了避免为 0 的情况</span>
	lag <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lag<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	load <span class="token operator">:=</span> lag <span class="token operator">*</span> <span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">LoadInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>inflight<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> load <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> penalty
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> load
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_EWMA__155"></a>请求结束，更新节点的 EWMA 等信息</h5> 
<ol><li>把节点正在处理请求的总数减 1</li><li>保存处理请求结束的时间点，用于计算距离上次节点处理请求的差值，并算出 EWMA 中的 β 值</li><li>计算本次请求耗时，并计算出 EWMA值 保存到节点的 lag 属性里</li><li>计算节点的健康状态保存到节点的 success 属性中</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>p2cPicker<span class="token punctuation">)</span> <span class="token function">buildDoneFunc</span><span class="token punctuation">(</span>c <span class="token operator">*</span>subConn<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>info balancer<span class="token punctuation">.</span>DoneInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	start <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>timex<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>info balancer<span class="token punctuation">.</span>DoneInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 正在处理的请求数减 1</span>
		atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>inflight<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		now <span class="token operator">:=</span> timex<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 保存本次请求结束时的时间点，并取出上次请求时的时间点</span>
		last <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">SwapInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>last<span class="token punctuation">,</span> <span class="token function">int64</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span>
		td <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">-</span> last
		<span class="token keyword">if</span> td <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			td <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// 用牛顿冷却定律中的衰减函数模型计算EWMA算法中的β值</span>
		w <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Exp</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span><span class="token operator">-</span>td<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>decayTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 保存本次请求的耗时</span>
		lag <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">-</span> start
		<span class="token keyword">if</span> lag <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			lag <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
		olag <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lag<span class="token punctuation">)</span>
		<span class="token keyword">if</span> olag <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			w <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// 计算 EWMA 值</span>
		atomic<span class="token punctuation">.</span><span class="token function">StoreUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lag<span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>olag<span class="token punctuation">)</span><span class="token operator">*</span>w<span class="token operator">+</span><span class="token function">float64</span><span class="token punctuation">(</span>lag<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		success <span class="token operator">:=</span> initSuccess
		<span class="token keyword">if</span> info<span class="token punctuation">.</span>Err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>codes<span class="token punctuation">.</span><span class="token function">Acceptable</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>Err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			success <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
		osucc <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>success<span class="token punctuation">)</span>
		atomic<span class="token punctuation">.</span><span class="token function">StoreUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>success<span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>osucc<span class="token punctuation">)</span><span class="token operator">*</span>w<span class="token operator">+</span><span class="token function">float64</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		stamp <span class="token operator">:=</span> p<span class="token punctuation">.</span>stamp<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> now<span class="token operator">-</span>stamp <span class="token operator">&gt;=</span> logInterval <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> p<span class="token punctuation">.</span>stamp<span class="token punctuation">.</span><span class="token function">CompareAndSwap</span><span class="token punctuation">(</span>stamp<span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				p<span class="token punctuation">.</span><span class="token function">logStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>学习自go-zero: <a href="https://github.com/tal-tech/go-zero">https://github.com/tal-tech/go-zero</a></p> 
<p>如果有兴趣可以看看我的代码, 里面有很多中文注释</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8e71741c3760570edaa1877182b36d84/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">sharepoint搭建文档服务器,规划在 SharePoint 服务器的管理和服务帐户</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/279627ba9859c7ceba4f7f4b71a00e14/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vps用网站安全狗还是服务器安全狗,安全狗：适用于服务器、网站安全防护，免费...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>