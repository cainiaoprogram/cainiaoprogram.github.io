<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深度学习：语义分割 FCN与Unet - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深度学习：语义分割 FCN与Unet" />
<meta property="og:description" content="参考：https://blog.csdn.net/wyzjack47/article/details/81107980
图像分割： 什么是图像分割问题呢？ 简单的来讲就是给一张图像，检测是用框出框出物体，而图像分割分出一个物体的准确轮廓。也这样考虑，给出一张图像 Ｉ，这个问题就是求一个函数，从I映射到Mask。至于怎么求这个函数有多种方法。我们可以看到这个图，左边是给出图像，可以看到人和摩托车，右边是分割结果. 像素级分类。mask=function(I)
图像分割：两个框架 一个基于 cnn 一个基础 FCN 一、FCN(fully convolutional network) 论文：Fully Convolutional Networks for Semantic Segmentation. Jonathan Long ,Evan Shelhamer ,Trevor Darrell
第一次将深度学习结合起来的是这篇文章全卷积网络(FCN)，利用深度学习求这个函数。在此之前深度学习一般用在分类和检测问题上。由于用到CNN，所以最后提取的特征的尺度是变小的。和我们要求的函数不一样，我们要求的函数是输入多大，输出有多大。为了让CNN提取出来的尺度能到原图大小，FCN网络利用上采样和反卷积到原图像大小。然后做像素级的分类。输入原图，经过VGG16网络，得到特征map,然后将特征map上采样回去。再将预测结果和ground truth每个像素一一对应分类，做像素级别分类。也就是说将分割问题变成分类问题，而分类问题正好是深度学习的强项。如果只将特征map直接上采样或者反卷积，明显会丢失很多信息。
FCN毫无疑问是语义分割领域的经典之作，在FCN出现之前，传统的CNN分割是将像素周围一个小区域作为CNN输入，做训练和预测，这样低效且不准确（忽略整体信息）。CNN主要有三点创新：
• 卷积化：即将传统CNN结构（文中提到的Alexnet、VGG）最后的全连接层改成卷积层，以便进行直接分割，这是十分有创造性的。
• 上采样：由于网络过程中进行了一系列下采样，使得特征层大小减小，了最后得到的预测层和原图一致，需要采用上采样，作用类似于反卷积。
• 并联跳跃结构：想法类似于resnet和inception，在进行分类预测时利用多层信息，具体如下图：
FCN采取解决方法是将pool4、pool3、和特征map融合起来，由于pool3、pool4、特征map大小尺寸是不一样的，所以融合应该前上采样到同一尺寸。这里的融合是拼接在一起(concact)，不是对应元素相加。
FCN是深度学习在图像分割的开山之作，FCN优点是实现端到端分割等，缺点是分割结果细节不够好，可以看到图四，FCN8s是上面讲的pool4、pool3和特征map融合，FCN16s是pool4和特征map融合，FCN32s是只有特征map，得出结果都是细节不够好，具体可以看自行车。由于网络中只有卷积没有全连接，所以这个网络又叫全卷积网络
二、Unet:医学影像分割的基石 论文：U-Net: Convolutional Networks for Biomedical Image Segmentation. Olaf Ronneberger, Philipp Fischer, and Thomas Brox
医学影像分割的论文，大部分都以Unet为基础进行改良，可见其重要性。而Unet是在FCN的基础上进行改良的，其网络结构如下：
可见，Unet 包括左边的收缩路径和右边的扩张路径。收缩路径就是经结构，包括几个 3 × 3 的卷积加 RELU 激活层再加 2 × 2maxpooling 的结构(stride :2) ，下采样的每一步特征通道数都增加一倍。扩张路径的每一步包括上采样、 2 × 2 卷积（减少一半通道数），和相应收缩路径中的剪裁过的特征层的串联以及两个 3 × 3 卷积加 RELU 。最后一层用了 1 × 1 卷积把64个通道" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8ed6941c260cf67731cfe32322cc467d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-02-25T15:29:15+08:00" />
<meta property="article:modified_time" content="2019-02-25T15:29:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深度学习：语义分割 FCN与Unet</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>参考：<a href="https://blog.csdn.net/wyzjack47/article/details/81107980">https://blog.csdn.net/wyzjack47/article/details/81107980</a></p> 
<h2>图像分割：</h2> 
<p><img alt="åå²" class="has" src="https://images2.imgbox.com/a6/29/Kx5aqTRV_o.png"></p> 
<p>什么是图像分割问题呢？ 简单的来讲就是给一张图像，检测是用框出框出物体，而图像分割分出一个物体的准确轮廓。也这样考虑，给出一张图像 Ｉ，这个问题就是求一个函数，从I映射到Mask。至于怎么求这个函数有多种方法。我们可以看到这个图，左边是给出图像，可以看到人和<a href="https://www.baidu.com/s?wd=%E6%91%A9%E6%89%98%E8%BD%A6&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" rel="nofollow">摩托车</a>，右边是分割结果. 像素级分类。mask=function(I)</p> 
<p>图像分割：两个框架 一个基于 cnn 一个基础 FCN </p> 
<p> </p> 
<p> </p> 
<h2>一、FCN(fully convolutional network)</h2> 
<p>论文：Fully Convolutional Networks for Semantic Segmentation. Jonathan Long ,Evan Shelhamer ,Trevor Darrell</p> 
<p> </p> 
<blockquote> 
 <p>第一次将深度学习结合起来的是这篇文章全卷积网络(FCN)，利用深度学习求这个函数。在此之前深度学习一般用在分类和检测问题上。由于用到CNN，所以最后提取的特征的尺度是变小的。和我们要求的函数不一样，我们要求的函数是输入多大，输出有多大。为了让CNN提取出来的尺度能到原图大小，FCN网络利用上采样和反卷积到原图像大小。然后做像素级的分类。输入原图，经过VGG16网络，得到特征map,然后将特征map上采样回去。<span style="color:#f33b45;"><strong>再将预测结果和ground truth每个像素一一对应分类，做像素级别分类</strong></span>。也就是说将分割问题变成分类问题，而分类问题正好是深度学习的强项。<strong>如果只将特征map直接上采样或者反卷积，明显会丢失很多信息</strong>。<br>  </p> 
</blockquote> 
<p>FCN毫无疑问是语义分割领域的经典之作，在FCN出现之前，传统的CNN分割是将像素周围一个小区域作为CNN输入，做训练和预测，这样低效且不准确（忽略整体信息）。CNN主要有三点创新：</p> 
<blockquote> 
 <p>• 卷积化：即将传统CNN结构（文中提到的Alexnet、VGG）<strong>最后的全连接层改成卷积层</strong>，以便进行直接分割，这是十分有创造性的。</p> 
 <p>• 上采样：由于网络过程中进行了一系列下采样，使得特征层大小减小，了最后得到的预测层和原图一致，需要采用上采样，作用类似于<strong>反卷积</strong>。</p> 
 <p>• <strong>并联跳跃结构</strong>：想法类似于resnet和inception，在进行分类预测时<strong>利用多层信息</strong>，具体如下图：</p> 
</blockquote> 
<p><img alt="" class="has" src="https://images2.imgbox.com/32/f6/KgTQhKrM_o.png"></p> 
<p> </p> 
<p><img alt="å¾ä¸" class="has" src="https://images2.imgbox.com/e1/73/5xG6FeBj_o.png"></p> 
<p> </p> 
<p> FCN采取解决方法是将pool4、pool3、和特征map融合起来，由于pool3、pool4、特征map大小尺寸是不一样的，所以融合应该前上采样到同一尺寸。<strong>这里的融合是拼接在一起(concact)</strong>，不是对应元素相加。</p> 
<p><img alt="å¾å" class="has" src="https://images2.imgbox.com/6f/5f/RqkYRsOd_o.png"></p> 
<p> </p> 
<p>FCN是深度学习在图像分割的开山之作，FCN<strong>优点</strong>是实现端到端分割等，<strong>缺点</strong>是分割结果细节不够好，可以看到图四，FCN8s是上面讲的pool4、pool3和特征map融合，FCN16s是pool4和特征map融合，FCN32s是只有特征map，得出结果都是细节不够好，具体可以看自行车。由于网络中只有卷积没有全连接，所以这个网络又叫全卷积网络<br>  </p> 
<h2>二、Unet:医学影像分割的基石</h2> 
<p>论文：<a href="https://www.baidu.com/s?wd=U-Net&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" rel="nofollow">U-Net</a>: Convolutional Networks for Biomedical Image Segmentation. Olaf Ronneberger, Philipp Fischer, and Thomas Brox</p> 
<p>医学影像分割的论文，大部分都以Unet为基础进行改良，可见其重要性。而Unet是在FCN的基础上进行改良的，其网络结构如下：</p> 
<p><img alt="å¾äº" class="has" src="https://images2.imgbox.com/88/b4/Vyvl5svS_o.png"></p> 
<p> </p> 
<p>可见，Unet 包括<strong>左边的收缩路径</strong>和<strong>右边的扩张路径</strong>。收缩路径就是经结构，包括几个 3 × 3 的卷积加 RELU 激活层再加 2 × 2maxpooling 的结构(stride :2) ，<strong>下采样的每一步特征通道数都增加一倍</strong>。扩张路径的每一步包括上采样、 2 × 2 卷积（减少一半通道数），和<strong>相应收缩路径中的剪裁过的特征层的串联</strong>以及<strong>两个 3 × 3 卷积加 RELU </strong>。<strong>最后一层用了 1 × 1 卷积把64个通道<br> 映射到想要的类别种类数</strong>。</p> 
<p>很多分割网络都是基于FCNs做改进，包括Unet。 在一些文献中也把这样的结构叫做<span style="color:#f33b45;"><strong>编码器-解码器结构</strong></span>。由于此网络整体结构类似于大写的英文字母U，故得名U-net。</p> 
<p>1、Unet包括两部分，可以看右图，第一部分，特征提取，VGG类似。第二部分上采样部分。由于网络结构像U型，所以叫Unet网络。 <br> 特征提取部分，每经过一个池化层就一个尺度，包括原图尺度一共有5个尺度。<br> 上采样部分，每上采样一次，就和特征提取部分对应的通道数相同尺度融合，但是融合之前要将其crop。这里的融合也是拼接。 <br> 个人认为改进FCN之处有： </p> 
<ul><li>多尺度</li><li>适合超大图像分割，适合医学图像分割<br>  </li></ul> 
<blockquote> 
 <ol><li><span style="color:#4f4f4f;">U-net与其他常见的分割网络有一点非常不同的地方：</span><span style="color:#FF0000;">U-net采用了完全不同的特征融合方式：拼接，U-net采用将特征在channel维度拼接在一起，形成更厚的特征。而FCN融合时使用的对应点相加，并不形成更厚的特征</span></li><li><span style="color:#4f4f4f;">所以语义分割网络在特征融合时有两种办法：</span><br><span style="color:#FF0000;">1. FCN式的对应点相加，对应于TensorFlow中的tf.add()函数；</span><br><span style="color:#FF0000;">2. U-net式的channel维度拼接融合，对应于TensorFlow的tf.concat()函数，比较占显存。</span></li></ol> 
</blockquote> 
<p>Unet优点：</p> 
<blockquote> 
 <ul><li>5个pooling layer实现了网络对图像特征的多尺度特征识别。</li><li>上采样部分会融合特征提取部分的输出，这样做实际上是将多尺度特征融合在了一起，以最后一个上采样为例，它的特征既来自第一个卷积block的输出(同尺度特征)，也来自上采样的输出(大尺度特征)，这样的连接是贯穿整个网络的，你可以看到上图的网络中有四次融合过程，相对应的FCN网络只在最后一层进行融合。<br>  </li></ul> 
</blockquote> 
<p>2、unet 输入和输出</p> 
<p><img alt="å¾å­" class="has" src="https://images2.imgbox.com/ff/63/IUisugjV_o.png"></p> 
<p>医学图像是一般相当大，但是分割时候不可能将原图太小输入网络，所以必须切成一张一张的小patch，在切成小patch的时候，Unet由于网络结构原因适合有overlap的切图，可以看图，红框是要分割区域，但是在切图时要包含周围区域，overlap另一个重要原因是周围overlap部分可以为分割区域边缘部分提供文理等信息。可以看黄框的边缘，分割结果并没有受到切成小patch而造成分割情况不好。 <br>  </p> 
<p>  </p> 
<p> </p> 
<p>3、优化方式：这篇论文中优化用的是<strong>SGD with momentum</strong>, 能量函数十分有趣，用了<strong>加权的交叉熵形式</strong>，而不是通常的平均形式：</p> 
<p><img alt="" class="has" height="60" src="https://images2.imgbox.com/97/fe/DSHVaLHh_o.png" width="225"></p> 
<p> 其中</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/e1/fd/LS1pwAIi_o.png"></p> 
<p>即像<strong>素点形式的softmax</strong>。</p> 
<p>其中<strong> w(x) 表示训练构成中像素点的重要性，越重要权重越大</strong>。</p> 
<p>由于分割问题边界处的分割一直是难题，因此本文赋予<strong>边界处更高的权重以达到精确分割</strong>：</p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/4c/79/1V2GaxyT_o.png"></p> 
<p><img alt="" class="has" src="https://images2.imgbox.com/64/29/XE0v7hvz_o.png"></p> 
<p><strong>上式 d 1 表示此像素点到离他最近的cell的边界的距离，d 2 表示此像素点到离他第二近的cell的边界的距离。这样离边界越近的像素点权重越大，因而也会被着重训练</strong>。此举取得了很好的效果，这个idea也可谓让人拍案叫绝。<br>  </p> 
<p>4、unet 反向传播</p> 
<p>Unet反向传播过程，大家都知道卷积层和池化层都能反向传播，Unet上采样部分可以用上采样或反卷积，那反卷积和上采样可以怎么反向传播的呢？那什么是反卷积呢？先来讲下卷积的过程</p> 
<p><img alt="" class="has" height="309" src="https://images2.imgbox.com/d8/74/DY0Cl939_o.png" width="878"></p> 
<p>反卷积就是转置卷积，也是一种卷积，这个就是转置卷积，由小尺寸到大尺寸的过程。也就是说反卷积也可以表示为两个矩阵乘积，很显然转置卷积的反向传播就是也是可进行的。所以说整体是Unet是可以反向传播的。 </p> 
<p><img alt="" class="has" height="347" src="https://images2.imgbox.com/c1/44/w4ZWJtjD_o.png" width="350"></p> 
<p> </p> 
<p>5、unet 实现：keras <a href="https://blog.csdn.net/qq_16900751/article/details/78251778">https://blog.csdn.net/qq_16900751/article/details/78251778</a></p> 
<p><a href="https://blog.csdn.net/awyyauqpmy/article/details/79290710">https://blog.csdn.net/awyyauqpmy/article/details/79290710</a></p> 
<p> </p> 
<p> 实现 两个 <a href="https://blog.csdn.net/sinat_26917383/article/details/80107783">https://blog.csdn.net/sinat_26917383/article/details/80107783</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cb7a1371206c83fa18b16edd7f12291e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Scrapy - Request 和 Response（请求和响应）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/69d8cafc453686259028e0903cef95a2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">struts2文件上传大小限制问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>