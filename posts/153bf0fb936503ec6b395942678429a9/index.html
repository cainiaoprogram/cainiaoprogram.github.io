<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【腾讯云 Finops Crane 集训营】基于 Kubernetes 实现云资源分析与成本优化平台 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【腾讯云 Finops Crane 集训营】基于 Kubernetes 实现云资源分析与成本优化平台" />
<meta property="og:description" content="基于 Kubernetes 实现云资源分析与成本优化平台 一、基本介绍1.主要功能2.整体架构 二、基于 Kubernetes 实现云资源分析与成本优化平台1.准备工作2.安装 Prometheus/Grafana 软件包3.安装 Crane 软件包4. 使用智能弹性 EffectiveHPA4.配置集群 三、功能验证1.成本展示2.资源推荐3.副本数推荐 四、总结 前言： 为推进云原生用户在确保业务稳定性的基础上做到真正的极致降本，腾讯云推出了国内第一个基于云原生技术的成本优化开源项目 Crane（Cloud Resource Analytics and Economics）。Crane 遵循 FinOps 标准，旨在为云原生用户提供云成本优化一站式解决方案。
一、基本介绍 Crane 是一个基于 FinOps 的云资源分析与成本优化平台。它的愿景是在保护客户应用运行质量的前提下实现极致的降本。
官网地址GitHub 地址 1.主要功能 1）成本可视化和优化评估
提供一组 Exporter 计算集群云资源的计费和账单数据并存储到你的监控系统，比如 Prometheus。多维度的成本洞察，优化评估。通过 Cloud Provider 支持多云计费。 2）推荐框架
提供了一个可扩展的推荐框架以支持多种云资源的分析，内置了多种推荐器：资源推荐，副本推荐，HPA 推荐，闲置资源推荐。 3）基于预测的水平弹性器
EffectiveHorizontalPodAutoscaler 支持预测驱动的弹性；基于社区的 HPA 做底层的弹性控制，支持更丰富的弹性触发策略（预测，观测，周期），让弹性更加高效，并保障了服务的质量。 4）负载感知的调度器
动态调度器根据实际的节点利用率构建了一个简单但高效的模型，并过滤掉那些负载高的节点来平衡集群。 5）拓扑感知的调度器
Crane Scheduler 与 Crane Agent 配合工作，支持更为精细化的资源拓扑感知调度和多种绑核策略，使得资源得到更合理高效的利用。 6）基于 QOS 的混部
QOS 相关能力保证了运行在 Kubernetes 上的 Pod 的稳定性。具有多维指标条件下的干扰检测和主动回避能力，支持精确操作和自定义指标接入；具有预测算法增强的弹性资源超卖能力，复用和限制集群内的空闲资源；具备增强的旁路 cpuset 管理能力，在绑核的同时提升资源利用效率。 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/153bf0fb936503ec6b395942678429a9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-19T09:27:09+08:00" />
<meta property="article:modified_time" content="2023-05-19T09:27:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【腾讯云 Finops Crane 集训营】基于 Kubernetes 实现云资源分析与成本优化平台</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>基于 Kubernetes 实现云资源分析与成本优化平台</h4> 
 <ul><li><a href="#_3" rel="nofollow">一、基本介绍</a></li><li><ul><li><a href="#1_7" rel="nofollow">1.主要功能</a></li><li><a href="#2_33" rel="nofollow">2.整体架构</a></li></ul> 
  </li><li><a href="#_Kubernetes__54" rel="nofollow">二、基于 Kubernetes 实现云资源分析与成本优化平台</a></li><li><ul><li><a href="#1_55" rel="nofollow">1.准备工作</a></li><li><a href="#2_PrometheusGrafana__67" rel="nofollow">2.安装 Prometheus/Grafana 软件包</a></li><li><a href="#3_Crane__87" rel="nofollow">3.安装 Crane 软件包</a></li><li><a href="#4__EffectiveHPA_114" rel="nofollow">4. 使用智能弹性 EffectiveHPA</a></li><li><a href="#4_148" rel="nofollow">4.配置集群</a></li></ul> 
  </li><li><a href="#_152" rel="nofollow">三、功能验证</a></li><li><ul><li><a href="#1_153" rel="nofollow">1.成本展示</a></li><li><a href="#2_157" rel="nofollow">2.资源推荐</a></li><li><a href="#3_167" rel="nofollow">3.副本数推荐</a></li></ul> 
  </li><li><a href="#_176" rel="nofollow">四、总结</a></li></ul> 
</div> 
<br> 
<strong>前言：</strong> 
<p></p> 
<blockquote> 
 <p>为推进云原生用户在确保业务稳定性的基础上做到真正的极致降本，腾讯云推出了国内第一个基于云原生技术的成本优化开源项目 Crane（<code>Cloud Resource Analytics and Economics</code>）。Crane 遵循 FinOps 标准，旨在为云原生用户提供云成本优化一站式解决方案。</p> 
</blockquote> 
<h2><a id="_3"></a>一、基本介绍</h2> 
<p>Crane 是一个基于 FinOps 的云资源分析与成本优化平台。它的愿景是在保护客户应用运行质量的前提下实现极致的降本。</p> 
<ul><li><a href="https://gocrane.io" rel="nofollow">官网地址</a></li><li><a href="https://github.com/gocrane/crane">GitHub 地址</a></li></ul> 
<h3><a id="1_7"></a>1.主要功能</h3> 
<p><img src="https://images2.imgbox.com/f9/a7/JzzAmh9w_o.png" alt="在这里插入图片描述"></p> 
<p>1）<strong>成本可视化和优化评估</strong></p> 
<ul><li>提供一组 Exporter <strong>计算集群云资源的计费和账单数据并存储到你的监控系统</strong>，比如 Prometheus。</li><li>多维度的成本洞察，优化评估。通过 <code>Cloud Provider</code> 支持多云计费。</li></ul> 
<p>2）<strong>推荐框架</strong></p> 
<ul><li>提供了一个可扩展的推荐框架以支持多种云资源的分析，<strong>内置了多种推荐器：资源推荐，副本推荐，HPA 推荐，闲置资源推荐。</strong></li></ul> 
<p>3）<strong>基于预测的水平弹性器</strong></p> 
<ul><li><code>EffectiveHorizontalPodAutoscaler</code> 支持预测驱动的弹性；</li><li><strong>基于社区的 HPA 做底层的弹性控制，支持更丰富的弹性触发策略（预测，观测，周期），让弹性更加高效，并保障了服务的质量。</strong></li></ul> 
<p>4）<strong>负载感知的调度器</strong></p> 
<ul><li>动态调度器<strong>根据实际的节点利用率构建了一个简单但高效的模型，并过滤掉那些负载高的节点来平衡集群。</strong></li></ul> 
<p>5）<strong>拓扑感知的调度器</strong></p> 
<ul><li><code>Crane Scheduler</code> 与 <code>Crane Agent</code> 配合工作，<strong>支持更为精细化的资源拓扑感知调度和多种绑核策略，使得资源得到更合理高效的利用。</strong></li></ul> 
<p>6）<strong>基于 QOS 的混部</strong></p> 
<ul><li>QOS 相关能力保证了运行在 Kubernetes 上的 Pod 的稳定性。</li><li>具有多维指标条件下的干扰检测和主动回避能力，支持精确操作和自定义指标接入；</li><li>具有预测算法增强的弹性资源超卖能力，复用和限制集群内的空闲资源；</li><li>具备增强的旁路 <code>cpuset</code> 管理能力，在绑核的同时提升资源利用效率。</li></ul> 
<hr> 
<h3><a id="2_33"></a>2.整体架构</h3> 
<p>Crane 的整体架构如下：<br> <img src="https://images2.imgbox.com/3e/db/afS0mBYj_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p><strong>Craned 是 Crane 的最核心组件，它管理了 CRDs 的生命周期以及 API。</strong> Craned 通过 <code>Deployment</code> 方式部署且由两个容器组成：</p> 
<ul><li>Craned：运行了 Operators 用来管理 CRDs，向 Dashboard 提供了 WebAPI，Predictors 提供了 TimeSeries API；</li><li>Dashboard：基于 TDesign’s Starter 脚手架研发的前端项目，提供了易于上手的产品功能。</li></ul> 
<hr> 
<p>Fadvisor 提供一组 Exporter <strong>计算集群云资源的计费和账单数据并存储到你的监控系统，</strong> 比如 Prometheus。</p> 
<ul><li>Fadvisor 通过 <code>Cloud Provider</code> 支持了多云计费的 API。</li></ul> 
<hr> 
<p>Metric Adapter 实现了一个 <code>Custom Metric Apiserver</code>。</p> 
<ul><li>Metric Adapter 读取 CRDs 信息并提供基于 <code>Custom/External Metric API</code> 的 HPA Metric 的数据。</li></ul> 
<hr> 
<ul><li>Crane Agent 通过 <code>DaemonSet</code> 部署在集群的节点上。</li></ul> 
<hr> 
<h2><a id="_Kubernetes__54"></a>二、基于 Kubernetes 实现云资源分析与成本优化平台</h2> 
<h3><a id="1_55"></a>1.准备工作</h3> 
<ul><li>Kubernetes 1.16+：<a href="https://blog.csdn.net/weixin_46902396/article/details/122303350">二进制安装传送门</a></li><li>Helm 3.7+</li></ul> 
<hr> 
<p>1）安装 Helm</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">wget</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">get</span><span class="token punctuation">.</span><span class="token variable">helm</span><span class="token punctuation">.</span><span class="token variable">sh</span><span class="token punctuation">/</span><span class="token variable">helm-v3</span><span class="token punctuation">.</span><span class="token number">7.2</span><span class="token variable">-linux-amd64</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">tar</span> <span class="token variable">zxf</span> <span class="token variable">helm-v3</span><span class="token punctuation">.</span><span class="token number">7.2</span><span class="token variable">-linux-amd64</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">mv</span> <span class="token variable">linux-amd64</span><span class="token punctuation">/</span><span class="token variable">helm</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">bin</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">helm</span> <span class="token variable">version</span>
<span class="token variable">version</span><span class="token punctuation">.</span><span class="token variable">BuildInfo</span><span class="token punctuation">{<!-- --></span><span class="token variable">Version</span><span class="token punctuation">:</span><span class="token string">"v3.7.2"</span><span class="token punctuation">,</span> <span class="token variable">GitCommit</span><span class="token punctuation">:</span><span class="token string">"663a896f4a815053445eec4153677ddc24a0a361"</span><span class="token punctuation">,</span> <span class="token variable">GitTreeState</span><span class="token punctuation">:</span><span class="token string">"clean"</span><span class="token punctuation">,</span> <span class="token variable">GoVersion</span><span class="token punctuation">:</span><span class="token string">"go1.16.10"</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2_PrometheusGrafana__67"></a>2.安装 Prometheus/Grafana 软件包</h3> 
<p>1）安装 Prometheus</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">helm</span> <span class="token variable">repo</span> <span class="token variable">add</span> <span class="token variable">prometheus-community</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">prometheus-community</span><span class="token punctuation">.</span><span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">io</span><span class="token punctuation">/</span><span class="token variable">helm-charts</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">helm</span> <span class="token variable">install</span> <span class="token variable">prometheus</span> <span class="token variable">-n</span> <span class="token variable">crane-system</span> <span class="token variable">--version</span> <span class="token number">19.6</span><span class="token number">.1</span> <span class="token punctuation">\</span>
<span class="token variable">--set</span> <span class="token variable">pushgateway</span><span class="token punctuation">.</span><span class="token variable">enabled</span><span class="token punctuation">=</span><span class="token boolean">false</span> <span class="token punctuation">\</span>
<span class="token variable">--set</span> <span class="token variable">alertmanager</span><span class="token punctuation">.</span><span class="token variable">enabled</span><span class="token punctuation">=</span><span class="token boolean">false</span> <span class="token punctuation">\</span>
<span class="token variable">--set</span> <span class="token variable">server</span><span class="token punctuation">.</span><span class="token variable">persistentVolume</span><span class="token punctuation">.</span><span class="token variable">enabled</span><span class="token punctuation">=</span><span class="token boolean">false</span> <span class="token punctuation">\</span>
<span class="token variable">-f</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">raw</span><span class="token punctuation">.</span><span class="token variable">githubusercontent</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">gocrane</span><span class="token punctuation">/</span><span class="token variable">helm-charts</span><span class="token punctuation">/</span><span class="token variable">main</span><span class="token punctuation">/</span><span class="token variable">integration</span><span class="token punctuation">/</span><span class="token variable">prometheus</span><span class="token punctuation">/</span><span class="token variable">override_values</span><span class="token punctuation">.</span><span class="token variable">yaml</span> <span class="token punctuation">\</span>
<span class="token variable">--create-namespace</span>  <span class="token variable">prometheus-community</span><span class="token punctuation">/</span><span class="token variable">prometheus</span>
</code></pre> 
<p>2）安装 Grafana</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">helm</span> <span class="token variable">repo</span> <span class="token variable">add</span> <span class="token variable">grafana</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">grafana</span><span class="token punctuation">.</span><span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">io</span><span class="token punctuation">/</span><span class="token variable">helm-charts</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">helm</span> <span class="token variable">install</span> <span class="token variable">grafana</span> <span class="token variable">--version</span> <span class="token number">6.11</span><span class="token number">.0</span> <span class="token punctuation">\</span>
<span class="token variable">-f</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">raw</span><span class="token punctuation">.</span><span class="token variable">githubusercontent</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">gocrane</span><span class="token punctuation">/</span><span class="token variable">helm-charts</span><span class="token punctuation">/</span><span class="token variable">main</span><span class="token punctuation">/</span><span class="token variable">integration</span><span class="token punctuation">/</span><span class="token variable">grafana</span><span class="token punctuation">/</span><span class="token variable">override_values</span><span class="token punctuation">.</span><span class="token variable">yaml</span> <span class="token punctuation">\</span>
<span class="token variable">-n</span> <span class="token variable">crane-system</span> <span class="token punctuation">\</span>
<span class="token variable">--create-namespace</span> <span class="token variable">grafana</span><span class="token punctuation">/</span><span class="token variable">grafana</span>
</code></pre> 
<hr> 
<h3><a id="3_Crane__87"></a>3.安装 Crane 软件包</h3> 
<p>1）安装 Crane 和 Fadvisor</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">helm</span> <span class="token variable">repo</span> <span class="token variable">add</span> <span class="token variable">crane</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">gocrane</span><span class="token punctuation">.</span><span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">io</span><span class="token punctuation">/</span><span class="token variable">helm-charts</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">helm</span> <span class="token variable">install</span> <span class="token variable">crane</span> <span class="token variable">-n</span> <span class="token variable">crane-system</span> <span class="token variable">--create-namespace</span> <span class="token variable">crane</span><span class="token punctuation">/</span><span class="token variable">crane</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">helm</span> <span class="token variable">install</span> <span class="token variable">fadvisor</span> <span class="token variable">-n</span> <span class="token variable">crane-system</span> <span class="token variable">--create-namespace</span> <span class="token variable">crane</span><span class="token punctuation">/</span><span class="token variable">fadvisor</span>
</code></pre> 
<p>2）验证安装是否成功</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">get</span> <span class="token variable">pod</span><span class="token punctuation">,</span><span class="token variable">deploy</span> <span class="token variable">-n</span> <span class="token variable">crane-system</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5e/ec/iaW1XS0g_o.png" alt="在这里插入图片描述"><br> 3）修改 Craned 服务的 ConfigMap 配置，调整反向代理的地址</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">get</span> <span class="token variable">service</span> <span class="token variable">craned</span> <span class="token variable">-n</span> <span class="token variable">crane-system</span> <span class="token variable">-o</span> <span class="token variable">yaml</span> <span class="token punctuation">&gt;</span> <span class="token number">1.</span><span class="token variable">yaml</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">sed</span> <span class="token variable">-i</span> <span class="token string">'s/type: ClusterIP/type: NodePort/g'</span> <span class="token number">1.</span><span class="token variable">yaml</span> 
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">sed</span> <span class="token variable">-i</span> <span class="token string">'/targetPort: 9090/a\    nodePort: 30080'</span> <span class="token number">1.</span><span class="token variable">yaml</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">apply</span> <span class="token variable">-f</span> <span class="token number">1.</span><span class="token variable">yaml</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">edit</span> <span class="token variable">cm</span> <span class="token variable">nginx-conf</span> <span class="token variable">-n</span> <span class="token variable">crane-system</span>
<span class="token punctuation">:</span><span class="token punctuation">%</span><span class="token variable">s</span><span class="token punctuation">/</span><span class="token variable">craned</span><span class="token punctuation">.</span><span class="token variable">crane-system</span><span class="token punctuation">:</span><span class="token number">8082</span><span class="token punctuation">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8082</span><span class="token block keyword">/g</span>

<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">get</span> <span class="token variable">pod</span> <span class="token variable">-n</span> <span class="token variable">crane-system</span> <span class="token punctuation">|</span> <span class="token variable">awk</span> <span class="token string">'/^craned/{print $1}'</span> <span class="token punctuation">|</span> <span class="token variable">xargs</span> <span class="token variable">kubectl</span> <span class="token variable">delete</span> <span class="token variable">pod</span> <span class="token variable">-n</span> <span class="token variable">crane-system</span>
</code></pre> 
<ul><li>因为 Dashboard 和 Craned 服务都在同一个 Pod 里，而 Dashboard 容器是通过 Service 加端口的方式代理到 Craned 服务上的；</li><li>但是 <strong>Pod 并不能直接通过 Service 加 端口的方式访问到本身</strong>，所以我们这里通过 <code>127.0.0.1</code>（Lo）的方式进行代理。</li></ul> 
<p><img src="https://images2.imgbox.com/e3/6f/YAQZLJiU_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4__EffectiveHPA_114"></a>4. 使用智能弹性 EffectiveHPA</h3> 
<p>Kubernetes HPA 支持了丰富的弹性扩展能力，Kubernetes 平台开发者部署服务实现自定义 Metric 的服务，Kubernetes 用户配置多项内置的资源指标或者自定义 Metric 指标实现自定义水平弹性。</p> 
<hr> 
<p><code>EffectiveHorizontalPodAutoscaler</code>（简称 EHPA）是 Crane 提供的弹性伸缩产品，它基于社区 HPA 做底层的弹性控制，支持更丰富的弹性触发策略（预测，观测，周期），让弹性更加高效，并保障了服务的质量。</p> 
<ul><li><strong>提前扩容，保证服务质量：</strong> 通过算法预测未来的流量洪峰提前扩容，避免扩容不及时导致的雪崩和服务稳定性故障。</li><li><strong>减少无效缩容：</strong> 通过预测未来可减少不必要的缩容，稳定工作负载的资源使用率，消除突刺误判。</li><li><strong>支持 Cron 配置：</strong> 支持 Cron-based 弹性配置，应对大促等异常流量洪峰。</li><li><strong>兼容社区：</strong> 使用社区 HPA 作为弹性控制的执行层，能力完全兼容社区。</li></ul> 
<p>1）安装 Metrics Server</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">wget</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">github</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">kubernetes-sigs</span><span class="token punctuation">/</span><span class="token variable">metrics-server</span><span class="token punctuation">/</span><span class="token variable">releases</span><span class="token punctuation">/</span><span class="token variable">download</span><span class="token punctuation">/</span><span class="token variable">v0</span><span class="token punctuation">.</span><span class="token number">6.3</span><span class="token block keyword">/components.yaml</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">sed</span> <span class="token variable">-i</span> <span class="token string">'/- args:/a\        - --metric-resolution=15s'</span> <span class="token variable">components</span><span class="token punctuation">.</span><span class="token variable">yaml</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">sed</span> <span class="token variable">-i</span> <span class="token string">'s@image:.*@image: docker.io/gocrane/metrics-server:v0.6.3@g'</span> <span class="token variable">components</span><span class="token punctuation">.</span><span class="token variable">yaml</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">apply</span> <span class="token variable">-f</span> <span class="token variable">components</span><span class="token punctuation">.</span><span class="token variable">yaml</span>
</code></pre> 
<p>2）创建测试应用</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">apply</span> <span class="token variable">-f</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">raw</span><span class="token punctuation">.</span><span class="token variable">githubusercontent</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">gocrane</span><span class="token punctuation">/</span><span class="token variable">crane</span><span class="token punctuation">/</span><span class="token variable">main</span><span class="token punctuation">/</span><span class="token variable">examples</span><span class="token punctuation">/</span><span class="token variable">autoscaling</span><span class="token punctuation">/</span><span class="token variable">php-apache</span><span class="token punctuation">.</span><span class="token variable">yaml</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">apply</span> <span class="token variable">-f</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">raw</span><span class="token punctuation">.</span><span class="token variable">githubusercontent</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">gocrane</span><span class="token punctuation">/</span><span class="token variable">crane</span><span class="token punctuation">/</span><span class="token variable">main</span><span class="token punctuation">/</span><span class="token variable">examples</span><span class="token punctuation">/</span><span class="token variable">analytics</span><span class="token punctuation">/</span><span class="token variable">nginx-deployment</span><span class="token punctuation">.</span><span class="token variable">yaml</span>
</code></pre> 
<p>3）创建 <code>EffectiveHPA</code></p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">apply</span> <span class="token variable">-f</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">raw</span><span class="token punctuation">.</span><span class="token variable">githubusercontent</span><span class="token punctuation">.</span><span class="token variable">com</span><span class="token punctuation">/</span><span class="token variable">gocrane</span><span class="token punctuation">/</span><span class="token variable">crane</span><span class="token punctuation">/</span><span class="token variable">main</span><span class="token punctuation">/</span><span class="token variable">examples</span><span class="token punctuation">/</span><span class="token variable">autoscaling</span><span class="token punctuation">/</span><span class="token variable">effective-hpa</span><span class="token punctuation">.</span><span class="token variable">yaml</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4f/6f/TLgNK5Bs_o.png" alt="在这里插入图片描述"><br> 4）增加负载，查看应用是否能够正常扩容</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@k8s-master01 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">kubectl</span> <span class="token variable">run</span> <span class="token variable">-i</span> <span class="token variable">--tty</span> <span class="token variable">load-generator</span> <span class="token variable">--rm</span> <span class="token variable">--image</span><span class="token punctuation">=</span><span class="token variable">busybox</span><span class="token punctuation">:</span><span class="token number">1.28</span><span class="token number">.4</span> <span class="token variable">--restart</span><span class="token punctuation">=</span><span class="token variable">Never</span> <span class="token variable">--</span> <span class="token punctuation">/</span><span class="token variable">bin</span><span class="token punctuation">/</span><span class="token variable">sh</span> <span class="token variable">-c</span> <span class="token string">"while sleep 0.01; do wget -q -O- http://php-apache; done"</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d1/18/CqT3HOrR_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8f/27/GWhPPtrS_o.png" alt="在这里插入图片描述"></p> 
<ul><li>可以看到随着请求增多，CPU 利用率会不断提升，通过 EffectiveHPA 会自动扩容实例。</li></ul> 
<h3><a id="4_148"></a>4.配置集群</h3> 
<p>访问：<code>http://192.168.1.1:30080</code></p> 
<p><img src="https://images2.imgbox.com/f5/20/BJzdUGL1_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_152"></a>三、功能验证</h2> 
<h3><a id="1_153"></a>1.成本展示</h3> 
<p>Crane Dashboard 提供了各式各样的图表展示了集群的成本和资源用量。<br> <img src="https://images2.imgbox.com/24/08/xdMF3Nqq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7a/67/6yippbeZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_157"></a>2.资源推荐</h3> 
<hr> 
<p>Kubernetes 用户在创建应用资源时常常是基于经验值来设置 <code>request</code> 和 <code>limit</code>，通过资源推荐的算法分析应用的真实用量推荐更合适的资源配置，你可以参考并采纳它提升集群的资源利用率。该推荐算法模型采用了 VPA 的滑动窗口（Moving Window）算法进行推荐：</p> 
<ul><li>通过监控数据，获取 Workload 过去一周（可配置）的 CPU 和内存的历史用量。</li><li>算法考虑数据的时效性，较新的数据采样点会拥有更高的权重。</li><li>CPU 推荐值基于用户设置的目标百分位值计算，内存推荐值基于历史数据的最大值。</li></ul> 
<p>1）使用资源推荐<br> <img src="https://images2.imgbox.com/40/19/E3OWwQOY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/54/de/sipkl8Ie_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_167"></a>3.副本数推荐</h3> 
<p>Kubernetes 用户在创建应用资源时常常是基于经验值来设置副本数。通过副本数推荐的算法分析应用的真实用量推荐更合适的副本配置，同样可以参考并采纳它提升集群的资源利用率。</p> 
<blockquote> 
 <p>其实现的基本算法是基于工作负载历史 CPU 负载，找到过去七天内每小时负载最低的 CPU 用量，计算按 50%（可配置）利用率和工作负载 CPU Request 应配置的副本数。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/4b/71/3r4biPev_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/47/1b/XJ1xLSMi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8b/a2/R2huM73Y_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_176"></a>四、总结</h2> 
<p>整体操作体验下来，安装相对比较简单，通过使用 Helm 工具实现便捷安装。安装完成后，便可以通过提供的 Dashboard 面板来进行访问。界面简单明了，易上手，<strong>同时在功能层面上实现了实时监控成本、应用资源使用量、资源推荐、智能弹性等功能。</strong></p> 
<ul><li><strong>实时监控成本</strong>：Crane 提供每小时、每天、每周和每月的费用概览，并且可以按集群、命名空间和工作负载分解成本。</li><li><strong>资源监控</strong>：通过调用 Prometheus 和 Grafana 实现资源监控以及可视化 UI。</li><li><strong>资源推荐</strong>：使用 VPA 算法模型，先分析出应用的真实用量，再通过计算得出应用的最佳资源配置。</li><li><strong>智能弹性</strong>：基于社区 HPA 做底层的弹性控制，支持更加丰富的弹性触发策略，让弹性更加高效，并保证服务的质量。</li></ul> 
<p>因此，我们可以通过 Crane 服务提供的成本计算、资源使用率，以及上述功能，来观察是否需要对云服务器进行资源扩容或减配。<strong>避免出现资源不足或资源浪费的情况，达到真正意义上的降本增效。</strong></p> 
<hr> 
<p><strong>关于腾讯云 Finops Crane 集训营：</strong></p> 
<p>Finops Crane集训营主要面向广大开发者，旨在提升开发者在容器部署、K8s 层面的动手实践能力，同时吸纳 Crane 开源项目贡献者，鼓励开发者提交 <code>issue</code>、<code>bug</code> 反馈等，并搭载线上直播、动手实验组队、有奖征文等系列技术活动。既能让开发者通过活动对 Finops Crane 开源项目有深入了解，同时也能帮助广大开发者在云原生技能上有实质性收获。</p> 
<p>为奖励开发者，我们特别设立了积分获取任务和对应的积分兑换礼品。</p> 
<ul><li><strong>活动介绍送门：</strong><a href="https://marketing.csdn.net/p/038ae30af2357473fc5431b63e4e1a78">https://marketing.csdn.net/p/038ae30af2357473fc5431b63e4e1a78</a></li><li><strong>开源项目：</strong> <a href="https://github.com/gocrane/crane">https://github.com/gocrane/crane</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/71c42dd9ba8554766f13c35e61bcc572/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">手把手教你，用Auto-GPT自动写个网站（保姆级）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/df931cd5daed8bb3629aff619df077c8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python制作词云图</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>