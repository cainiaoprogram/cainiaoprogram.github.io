<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>spinal HDL - 04 - Spinal HDL - 组件、层次结构和区域 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="spinal HDL - 04 - Spinal HDL - 组件、层次结构和区域" />
<meta property="og:description" content="写在前面 本文主要介绍了spinal HDL的组件、层次结构和区域。
组件和层次结构（Component and hierarchy） 就像在 VHDL 和 Verilog 中一样，可以定义可用于构建设计层次结构的组件。但是，在 SpinalHDL 中，不需要在实例化时绑定它们的端口：
class AdderCell extends Component { // Declaring external ports in a Bundle called `io` is recommended val io = new Bundle { val a, b, cin = in Bool() val sum, cout = out Bool() } // Do some logic io.sum := io.a ^ io.b ^ io.cin io.cout := (io.a &amp; io.b) | (io.a &amp; io.cin) | (io." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fc79ea121b49ce3351c944f89d4ac30e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-02T13:25:57+08:00" />
<meta property="article:modified_time" content="2021-11-02T13:25:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">spinal HDL - 04 - Spinal HDL - 组件、层次结构和区域</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>写在前面</h2> 
<p>本文主要介绍了spinal HDL的组件、层次结构和区域。</p> 
<h2><a id="Component_and_hierarchy_2"></a>组件和层次结构（Component and hierarchy）</h2> 
<p>就像在 VHDL 和 Verilog 中一样，可以定义可用于构建设计层次结构的组件。但是，在 SpinalHDL 中，不需要在实例化时绑定它们的端口：</p> 
<pre><code class="prism language-scala"><span class="token keyword">class</span> AdderCell <span class="token keyword">extends</span> Component <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Declaring external ports in a Bundle called `io` is recommended</span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> <span class="token keyword">new</span> Bundle <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> cin <span class="token operator">=</span> in Bool<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> sum<span class="token punctuation">,</span> cout <span class="token operator">=</span> out Bool<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Do some logic</span>
  io<span class="token punctuation">.</span>sum <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>a <span class="token operator">^</span> io<span class="token punctuation">.</span>b <span class="token operator">^</span> io<span class="token punctuation">.</span>cin
  io<span class="token punctuation">.</span>cout <span class="token operator">:</span><span class="token operator">=</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>a <span class="token operator">&amp;</span> io<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>a <span class="token operator">&amp;</span> io<span class="token punctuation">.</span>cin<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>b <span class="token operator">&amp;</span> io<span class="token punctuation">.</span>cin<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> Adder<span class="token punctuation">(</span>width<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Component <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// Create 2 AdderCell instances</span>
  <span class="token keyword">val</span> cell0 <span class="token operator">=</span> <span class="token keyword">new</span> AdderCell
  <span class="token keyword">val</span> cell1 <span class="token operator">=</span> <span class="token keyword">new</span> AdderCell
  cell1<span class="token punctuation">.</span>io<span class="token punctuation">.</span>cin <span class="token operator">:</span><span class="token operator">=</span> cell0<span class="token punctuation">.</span>io<span class="token punctuation">.</span>cout   <span class="token comment">// Connect cout of cell0 to cin of cell1</span>

  <span class="token comment">// Another example which creates an array of ArrayCell instances</span>
  <span class="token keyword">val</span> cellArray <span class="token operator">=</span> Array<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">new</span> AdderCell<span class="token punctuation">)</span>
  cellArray<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span>cin <span class="token operator">:</span><span class="token operator">=</span> cellArray<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span>cout   <span class="token comment">// Connect cout of cell(0) to cin of cell(1)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>val io = new Bundle { … }<br> 建议在<code>Bundle</code>被叫方声明外部端口<code>io</code>。如果你命名你的 bundle <code>io</code>，SpinalHDL 将检查它的所有元素是否被定义为输入或输出。</p> 
</blockquote> 
<h3><a id="_34"></a>输入/输出定义</h3> 
<p>定义输入和输出的语法如下：</p> 
<table><thead><tr><th>Syntax</th><th>Description</th><th>Return</th></tr></thead><tbody><tr><td>in Bool()/out Bool()</td><td>创建输入 Bool/输出 Bool</td><td>Bool</td></tr><tr><td>in/out Bits/UInt/SInt[(x bit)]</td><td>创建相应类型的输入/输出</td><td>Bits/UInt/SInt</td></tr><tr><td>in/out(T)</td><td>对于所有其他数据类型，可能需要在其周围添加一些括号。抱歉，这是 Scala 限制。</td><td>T</td></tr><tr><td>master/slave(T)</td><td>此语法由<code>spinal.lib</code>库提供（如果您使用该<code>slave</code>语法注释对象，则<code>spinal.lib.slave</code>改为导入）。T 应该扩展<code>IMasterSlave</code></td><td>T</td></tr></tbody></table> 
<p>组件互连需要遵循一些规则：</p> 
<ul><li>组件只能读取子组件的输出和输入信号。</li><li>组件可以读取自己的输出端口值（与 VHDL 不同）。</li></ul> 
<h3><a id="_50"></a>修剪信号</h3> 
<p>SpinalHDL 只生成直接或间接驱动顶级实体输出所需的东西。</p> 
<p>所有其他信号（无用的）都从 RTL 生成中删除，并插入到修剪过的信号列表中。您可以通过生成的对象上的<code>printPruned</code>和<code>printPrunedIo</code>函数获取此列表<code>SpinalReport</code>：</p> 
<pre><code class="prism language-scala"><span class="token keyword">class</span> TopLevel <span class="token keyword">extends</span> Component <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> <span class="token keyword">new</span> Bundle <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> a<span class="token punctuation">,</span>b <span class="token operator">=</span> in UInt<span class="token punctuation">(</span><span class="token number">8</span> bits<span class="token punctuation">)</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> out UInt<span class="token punctuation">(</span><span class="token number">8</span> bits<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  io<span class="token punctuation">.</span>result <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>a <span class="token operator">+</span> io<span class="token punctuation">.</span>b

  <span class="token keyword">val</span> unusedSignal <span class="token operator">=</span> UInt<span class="token punctuation">(</span><span class="token number">8</span> bits<span class="token punctuation">)</span>
  <span class="token keyword">val</span> unusedSignal2 <span class="token operator">=</span> UInt<span class="token punctuation">(</span><span class="token number">8</span> bits<span class="token punctuation">)</span>

  unusedSignal2 <span class="token operator">:</span><span class="token operator">=</span> unusedSignal
<span class="token punctuation">}</span>

<span class="token keyword">object</span> Main <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    SpinalVhdl<span class="token punctuation">(</span><span class="token keyword">new</span> TopLevel<span class="token punctuation">)</span><span class="token punctuation">.</span>printPruned<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//This will report :</span>
    <span class="token comment">//  [Warning] Unused wire detected : toplevel/unusedSignal : UInt[8 bits]</span>
    <span class="token comment">//  [Warning] Unused wire detected : toplevel/unusedSignal2 : UInt[8 bits]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果您出于调试原因想在生成的 RTL 中保留修剪后的信号，您可以使用该<code>keep</code>信号的函数：</p> 
<pre><code class="prism language-scala"><span class="token keyword">class</span> TopLevel <span class="token keyword">extends</span> Component <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> <span class="token keyword">new</span> Bundle <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> in UInt<span class="token punctuation">(</span><span class="token number">8</span> bits<span class="token punctuation">)</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> out UInt<span class="token punctuation">(</span><span class="token number">8</span> bits<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  io<span class="token punctuation">.</span>result <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>a <span class="token operator">+</span> io<span class="token punctuation">.</span>b

  <span class="token keyword">val</span> unusedSignal <span class="token operator">=</span> UInt<span class="token punctuation">(</span><span class="token number">8</span> bits<span class="token punctuation">)</span>
  <span class="token keyword">val</span> unusedSignal2 <span class="token operator">=</span> UInt<span class="token punctuation">(</span><span class="token number">8</span> bits<span class="token punctuation">)</span><span class="token punctuation">.</span>keep<span class="token punctuation">(</span><span class="token punctuation">)</span>

  unusedSignal  <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">0</span>
  unusedSignal2 <span class="token operator">:</span><span class="token operator">=</span> unusedSignal
<span class="token punctuation">}</span>

<span class="token keyword">object</span> Main <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    SpinalVhdl<span class="token punctuation">(</span><span class="token keyword">new</span> TopLevel<span class="token punctuation">)</span><span class="token punctuation">.</span>printPruned<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// This will report nothing</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="VHDL_GenericVerilog_Parameter_107"></a>参数化硬件（VHDL 中的“Generic”，Verilog 中的“Parameter”）</h3> 
<p>如果你想参数化你的组件，你可以给组件的构造函数提供参数，如下所示：</p> 
<pre><code class="prism language-scala"><span class="token keyword">class</span> MyAdder<span class="token punctuation">(</span>width<span class="token operator">:</span> BitCount<span class="token punctuation">)</span> <span class="token keyword">extends</span> Component <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> <span class="token keyword">new</span> Bundle <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> a<span class="token punctuation">,</span> b   <span class="token operator">=</span> in UInt<span class="token punctuation">(</span>width<span class="token punctuation">)</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> out UInt<span class="token punctuation">(</span>width<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  io<span class="token punctuation">.</span>result <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>a <span class="token operator">+</span> io<span class="token punctuation">.</span>b
<span class="token punctuation">}</span>

<span class="token keyword">object</span> Main <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    SpinalVhdl<span class="token punctuation">(</span><span class="token keyword">new</span> MyAdder<span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果有多个参数，那么给出一个具体的配置类是一个很好的做法，如下所示：</p> 
<pre><code class="prism language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> MySocConfig<span class="token punctuation">(</span>axiFrequency  <span class="token operator">:</span> HertzNumber<span class="token punctuation">,</span>
                       onChipRamSize <span class="token operator">:</span> BigInt<span class="token punctuation">,</span>
                       cpu           <span class="token operator">:</span> RiscCoreConfig<span class="token punctuation">,</span>
                       iCache        <span class="token operator">:</span> InstructionCacheConfig<span class="token punctuation">)</span>

<span class="token keyword">class</span> MySoc<span class="token punctuation">(</span>config<span class="token operator">:</span> MySocConfig<span class="token punctuation">)</span> <span class="token keyword">extends</span> Component <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_140"></a>合成成分名称</h3> 
<p>在一个模块中，每个组件都有一个名称，称为“部分名称”。“完整”名称是通过用“_”连接每个组件的父名称来构建的，例如：<code>io_clockDomain_reset</code>。您可以使用<code>setName</code>自定义名称替换此约定。这在与外部组件接口时特别有用。其他的方法被称为<code>getName</code>，<code>setPartialName</code>和<code>getPartialName</code>分别。</p> 
<p>合成时，每个模块都会获得定义它的 Scala 类的名称。您也可以使用<code>setDefinitionName</code>.</p> 
<h2><a id="Area_146"></a>区域（Area）</h2> 
<p>有时，创建一个<code>Component</code>来定义一些逻辑是矫枉过正的，因为你：</p> 
<ul><li>需要定义所有的构造参数和IO（verbosity，duplication）</li><li>拆分您的代码（超出需要）</li></ul> 
<p>对于这种情况，您可以使用 an<code>Area</code>来定义一组信号/逻辑：</p> 
<pre><code class="prism language-scala"><span class="token keyword">class</span> UartCtrl <span class="token keyword">extends</span> Component <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">val</span> timer <span class="token operator">=</span> <span class="token keyword">new</span> Area <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> counter <span class="token operator">=</span> Reg<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">8</span> bit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> tick <span class="token operator">=</span> counter <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">0</span>
    counter <span class="token operator">:</span><span class="token operator">=</span> counter <span class="token operator">-</span> <span class="token number">1</span>
    when<span class="token punctuation">(</span>tick<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      counter <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">100</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> tickCounter <span class="token operator">=</span> <span class="token keyword">new</span> Area <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> value <span class="token operator">=</span> Reg<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">3</span> bit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> reset <span class="token operator">=</span> False
    when<span class="token punctuation">(</span>timer<span class="token punctuation">.</span>tick<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>          <span class="token comment">// Refer to the tick from timer area</span>
      value <span class="token operator">:</span><span class="token operator">=</span> value <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    when<span class="token punctuation">(</span>reset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      value <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> stateMachine <span class="token operator">=</span> <span class="token keyword">new</span> Area <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Reference_183"></a>Reference</h2> 
<ol><li>spinal HDL官方文档</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0e1f0971da4d6ba14a129a0cfd2c120b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">java.lang.IllegalStateException: 提交响应后无法转发</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/08b1b09d6940ab4bddb3ba8511aa018d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">百度文库f12免费复制文章</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>