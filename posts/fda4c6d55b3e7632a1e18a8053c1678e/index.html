<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CRNN代码笔记 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CRNN代码笔记" />
<meta property="og:description" content="CRNN代码笔记 主要由五个模块组成：
数据集的加载与切分CRNN代码复现训练过程预测过程训练过程中对的评估 文章目录 CRNN代码笔记数据集的加载与切分RCNN模型构建训练部分训练辅助函数注意超参数设置判断cuda是否可用，是则基于GPU训练，否则用cpu训练设置训练数据加载器、验证数据加载器，常规操作collate_fn用法 实例化CRNN模型，加载模型参数，并运行至可用设备（CPU or GPU）定义优化方法、损失函数开始训练 预测部分超参数设置判断cuda是否可用，否则用cpu预测设置预测数据加载器，常规操作实例化CRNN模型，加载模型参数，并运行至可用设备（CPU or GPU）实例化进度条，用于查看预测进度执行预测结果展示 验证部分 数据集的加载与切分 import os import glob import torch from torch.utils.data import Dataset from scipy import signal from scipy.io import wavfile import cv2 from PIL import Image import numpy as np class Synth90kDataset(Dataset): CHARS = &#39;0123456789abcdefghijklmnopqrstuvwxyz&#39; CHAR2LABEL = {char: i &#43; 1 for i, char in enumerate(CHARS)} LABEL2CHAR = {label: char for char, label in CHAR2LABEL.items()} def __init__(self, root_dir=None, mode=None, paths=None, img_height=32, img_width=100): if root_dir and mode and not paths: paths, texts = self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fda4c6d55b3e7632a1e18a8053c1678e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-17T17:39:44+08:00" />
<meta property="article:modified_time" content="2021-06-17T17:39:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CRNN代码笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="CRNN_0"></a>CRNN代码笔记</h2> 
<p>主要由五个模块组成：</p> 
<ol><li>数据集的加载与切分</li><li>CRNN代码复现</li><li>训练过程</li><li>预测过程</li><li>训练过程中对的评估</li></ol> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#CRNN_0" rel="nofollow">CRNN代码笔记</a></li><li><a href="#_15" rel="nofollow">数据集的加载与切分</a></li><li><a href="#RCNN_250" rel="nofollow">RCNN模型构建</a></li><li><a href="#_423" rel="nofollow">训练部分</a></li><li><ul><li><ul><li><a href="#_439" rel="nofollow">训练辅助函数</a></li><li><a href="#_441" rel="nofollow">注意</a></li><li><a href="#_497" rel="nofollow">超参数设置</a></li><li><a href="#cudaGPUcpu_519" rel="nofollow">判断cuda是否可用，是则基于GPU训练，否则用cpu训练</a></li><li><a href="#_530" rel="nofollow">设置训练数据加载器、验证数据加载器，常规操作</a></li><li><ul><li><a href="#collate_fn_532" rel="nofollow">collate_fn用法</a></li></ul> 
    </li><li><a href="#CRNNCPU_or_GPU_558" rel="nofollow">实例化CRNN模型，加载模型参数，并运行至可用设备（CPU or GPU）</a></li><li><a href="#_605" rel="nofollow">定义优化方法、损失函数</a></li><li><a href="#_628" rel="nofollow">开始训练</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_664" rel="nofollow">预测部分</a></li><li><ul><li><ul><li><a href="#_679" rel="nofollow">超参数设置</a></li><li><a href="#cudacpu_697" rel="nofollow">判断cuda是否可用，否则用cpu预测</a></li><li><a href="#_708" rel="nofollow">设置预测数据加载器，常规操作</a></li><li><a href="#CRNNCPU_or_GPU_721" rel="nofollow">实例化CRNN模型，加载模型参数，并运行至可用设备（CPU or GPU）</a></li><li><a href="#_767" rel="nofollow">实例化进度条，用于查看预测进度</a></li><li><a href="#_777" rel="nofollow">执行预测</a></li><li><a href="#_801" rel="nofollow">结果展示</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_825" rel="nofollow">验证部分</a></li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_15"></a>数据集的加载与切分</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> glob

<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset
<span class="token keyword">from</span> scipy <span class="token keyword">import</span> signal
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">import</span> wavfile
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Synth90kDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    CHARS <span class="token operator">=</span> <span class="token string">'0123456789abcdefghijklmnopqrstuvwxyz'</span>
    CHAR2LABEL <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>char<span class="token punctuation">:</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">for</span> i<span class="token punctuation">,</span> char <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>CHARS<span class="token punctuation">)</span><span class="token punctuation">}</span>
    LABEL2CHAR <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>label<span class="token punctuation">:</span> char <span class="token keyword">for</span> char<span class="token punctuation">,</span> label <span class="token keyword">in</span> CHAR2LABEL<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root_dir<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> paths<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> img_height<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> img_width<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> root_dir <span class="token keyword">and</span> mode <span class="token keyword">and</span> <span class="token keyword">not</span> paths<span class="token punctuation">:</span>
            paths<span class="token punctuation">,</span> texts <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_from_raw_files<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token keyword">not</span> root_dir <span class="token keyword">and</span> <span class="token keyword">not</span> mode <span class="token keyword">and</span> paths<span class="token punctuation">:</span>
            texts <span class="token operator">=</span> <span class="token boolean">None</span>

        self<span class="token punctuation">.</span>paths <span class="token operator">=</span> paths
        self<span class="token punctuation">.</span>texts <span class="token operator">=</span> texts
        self<span class="token punctuation">.</span>img_height <span class="token operator">=</span> img_height
        self<span class="token punctuation">.</span>img_width <span class="token operator">=</span> img_width

    <span class="token keyword">def</span> <span class="token function">_load_from_raw_files</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root_dir<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
        mapping <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> <span class="token string">'lexicon.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fr<span class="token punctuation">:</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>fr<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                mapping<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

        paths_file <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
            paths_file <span class="token operator">=</span> <span class="token string">'train.txt'</span>
        <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'dev'</span><span class="token punctuation">:</span>
            paths_file <span class="token operator">=</span> <span class="token string">'val.txt'</span>
        <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'test'</span><span class="token punctuation">:</span>
            paths_file <span class="token operator">=</span> <span class="token string">'test.txt'</span>

        paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        texts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> paths_file<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fr<span class="token punctuation">:</span>
            <span class="token keyword">for</span> line <span class="token keyword">in</span> fr<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                path<span class="token punctuation">,</span> index_str <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
                path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> path<span class="token punctuation">)</span>
                index <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>index_str<span class="token punctuation">)</span>
                text <span class="token operator">=</span> mapping<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
                paths<span class="token punctuation">.</span>append<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
                texts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token keyword">return</span> paths<span class="token punctuation">,</span> texts

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>paths<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        path <span class="token operator">=</span> self<span class="token punctuation">.</span>paths<span class="token punctuation">[</span>index<span class="token punctuation">]</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>  <span class="token comment"># grey-scale</span>
        <span class="token keyword">except</span> IOError<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Corrupted image for %d'</span> <span class="token operator">%</span> index<span class="token punctuation">)</span>
            <span class="token keyword">return</span> self<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>

        image <span class="token operator">=</span> image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>img_height<span class="token punctuation">)</span><span class="token punctuation">,</span> resample<span class="token operator">=</span>Image<span class="token punctuation">.</span>BILINEAR<span class="token punctuation">)</span>
        image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        image <span class="token operator">=</span> image<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>img_height<span class="token punctuation">,</span> self<span class="token punctuation">.</span>img_width<span class="token punctuation">)</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> <span class="token punctuation">(</span>image <span class="token operator">/</span> <span class="token number">127.5</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0</span>

        image <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>texts<span class="token punctuation">:</span>  <span class="token comment">#或者图片所对应的label</span>
            text <span class="token operator">=</span> self<span class="token punctuation">.</span>texts<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
            target <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>CHAR2LABEL<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> text<span class="token punctuation">]</span>
            target_length <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">]</span>

            target <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>target<span class="token punctuation">)</span>
            target_length <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>target_length<span class="token punctuation">)</span>
            <span class="token comment"># 如果DataLoader不设置collate_fn,则此处返回值为迭代DataLoader时取到的值</span>
            <span class="token keyword">return</span> image<span class="token punctuation">,</span> target<span class="token punctuation">,</span> target_length
        <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment"># 测试模式不需要label</span>
            <span class="token keyword">return</span> image

</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">synth90k_collate_fn</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># zip(*batch)拆包</span>
    images<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> target_lengths <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>batch<span class="token punctuation">)</span>
    <span class="token comment"># stack就是向量堆叠的意思。一定是扩张一个维度，然后在扩张的维度上，把多个张量纳入仅一个张量。想象向上摞面包片，摞的操作即是stack，0轴即按块stack</span>
    images <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># cat是指向量拼接的意思。一定不扩张维度，想象把两个长条向量cat成一个更长的向量。</span>
    targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>targets<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    target_lengths <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>target_lengths<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># 此处返回的数据即使train_loader每次取到的数据，迭代train_loader，每次都会取到三个值，即此处返回值。</span>
    <span class="token keyword">return</span> images<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> target_lengths
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">from</span> config <span class="token keyword">import</span> train_config <span class="token keyword">as</span> config
</code></pre> 
<pre><code class="prism language-python">img_width <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'img_width'</span><span class="token punctuation">]</span>
img_height <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'img_height'</span><span class="token punctuation">]</span>
data_dir <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'data_dir'</span><span class="token punctuation">]</span>
train_batch_size <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'train_batch_size'</span><span class="token punctuation">]</span>
cpu_workers <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'cpu_workers'</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python">train_dataset <span class="token operator">=</span> Synth90kDataset<span class="token punctuation">(</span>root_dir<span class="token operator">=</span>data_dir<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span>
                                    img_height<span class="token operator">=</span>img_height<span class="token punctuation">,</span> img_width<span class="token operator">=</span>img_width<span class="token punctuation">)</span>
train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span>train_batch_size<span class="token punctuation">,</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    num_workers<span class="token operator">=</span>cpu_workers<span class="token punctuation">,</span>
    collate_fn<span class="token operator">=</span>synth90k_collate_fn<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">train_data <span class="token operator">=</span> train_dataset<span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'train_data的类型是：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>train_data<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'train_data的长度是：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>train_data<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>train_data的类型是：&lt;class 'tuple'&gt;
train_data的长度是：3
</code></pre> 
<pre><code class="prism language-python">train_data
</code></pre> 
<pre><code>(tensor([[[0.3804, 0.3804, 0.4196,  ..., 0.4824, 0.4745, 0.4745],
          [0.5451, 0.5451, 0.5451,  ..., 0.4902, 0.4902, 0.4902],
          [0.4824, 0.4824, 0.4667,  ..., 0.4902, 0.4824, 0.4824],
          ...,
          [0.4353, 0.4353, 0.4196,  ..., 0.5059, 0.5059, 0.5059],
          [0.6078, 0.6078, 0.6078,  ..., 0.4902, 0.4824, 0.4824],
          [0.3255, 0.3255, 0.3804,  ..., 0.4667, 0.4745, 0.4745]]]),
 tensor([19, 28, 29]),
 tensor([3]))
</code></pre> 
<pre><code class="prism language-python">img <span class="token operator">=</span> train_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
label_idx <span class="token operator">=</span> train_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
label_length <span class="token operator">=</span> train_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'img的类型是：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'img的shape是：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'img matrix如下:'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
</code></pre> 
<pre><code>img的类型是：&lt;class 'torch.Tensor'&gt;
img的shape是：torch.Size([1, 32, 100])
img matrix如下:
tensor([[[0.3804, 0.3804, 0.4196,  ..., 0.4824, 0.4745, 0.4745],
         [0.5451, 0.5451, 0.5451,  ..., 0.4902, 0.4902, 0.4902],
         [0.4824, 0.4824, 0.4667,  ..., 0.4902, 0.4824, 0.4824],
         ...,
         [0.4353, 0.4353, 0.4196,  ..., 0.5059, 0.5059, 0.5059],
         [0.6078, 0.6078, 0.6078,  ..., 0.4902, 0.4824, 0.4824],
         [0.3255, 0.3255, 0.3804,  ..., 0.4667, 0.4745, 0.4745]]])
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
</code></pre> 
<pre><code class="prism language-python">img <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7f/d3/FXSFbUpg_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">chars <span class="token operator">=</span> <span class="token string">'0123456789abcdefghijklmnopqrstuvwxyz'</span>
label <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> idx <span class="token keyword">in</span> label_idx<span class="token punctuation">:</span>
    label <span class="token operator">+=</span> chars<span class="token punctuation">[</span>idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'label为：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>label<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>label为：irs
</code></pre> 
<pre><code class="prism language-python">CHARS <span class="token operator">=</span> <span class="token string">'0123456789abcdefghijklmnopqrstuvwxyz'</span>
CHAR2LABEL <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>char<span class="token punctuation">:</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">for</span> i<span class="token punctuation">,</span> char <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>CHARS<span class="token punctuation">)</span><span class="token punctuation">}</span>
LABEL2CHAR <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>label<span class="token punctuation">:</span> char <span class="token keyword">for</span> char<span class="token punctuation">,</span> label <span class="token keyword">in</span> CHAR2LABEL<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>CHAR2LABEL<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>LABEL2CHAR<span class="token punctuation">)</span>
</code></pre> 
<pre><code>{'0': 1, '1': 2, '2': 3, '3': 4, '4': 5, '5': 6, '6': 7, '7': 8, '8': 9, '9': 10, 'a': 11, 'b': 12, 'c': 13, 'd': 14, 'e': 15, 'f': 16, 'g': 17, 'h': 18, 'i': 19, 'j': 20, 'k': 21, 'l': 22, 'm': 23, 'n': 24, 'o': 25, 'p': 26, 'q': 27, 'r': 28, 's': 29, 't': 30, 'u': 31, 'v': 32, 'w': 33, 'x': 34, 'y': 35, 'z': 36}
{1: '0', 2: '1', 3: '2', 4: '3', 5: '4', 6: '5', 7: '6', 8: '7', 9: '8', 10: '9', 11: 'a', 12: 'b', 13: 'c', 14: 'd', 15: 'e', 16: 'f', 17: 'g', 18: 'h', 19: 'i', 20: 'j', 21: 'k', 22: 'l', 23: 'm', 24: 'n', 25: 'o', 26: 'p', 27: 'q', 28: 'r', 29: 's', 30: 't', 31: 'u', 32: 'v', 33: 'w', 34: 'x', 35: 'y', 36: 'z'}
</code></pre> 
<h2><a id="RCNN_250"></a>RCNN模型构建</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> config <span class="token keyword">import</span> train_config <span class="token keyword">as</span> config
<span class="token keyword">from</span> dataset <span class="token keyword">import</span> Synth90kDataset<span class="token punctuation">,</span> synth90k_collate_fn
<span class="token keyword">from</span> torchsummary <span class="token keyword">import</span> summary
<span class="token keyword">import</span> torch
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CRNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_channel<span class="token punctuation">,</span> img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">,</span> num_class<span class="token punctuation">,</span>
                 map_to_seq_hidden<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> rnn_hidden<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> leaky_relu<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CRNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>cnn<span class="token punctuation">,</span> <span class="token punctuation">(</span>output_channel<span class="token punctuation">,</span> output_height<span class="token punctuation">,</span> output_width<span class="token punctuation">)</span> <span class="token operator">=</span> \
            self<span class="token punctuation">.</span>_cnn_backbone<span class="token punctuation">(</span>img_channel<span class="token punctuation">,</span> img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">,</span> leaky_relu<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>map_to_seq <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>output_channel <span class="token operator">*</span> output_height<span class="token punctuation">,</span> map_to_seq_hidden<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rnn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>map_to_seq_hidden<span class="token punctuation">,</span> rnn_hidden<span class="token punctuation">,</span> bidirectional<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment">#bidirectional是否使用双向的LSTM </span>

        <span class="token comment"># 如果接双向lstm输出，则要 *2,固定用法</span>
        self<span class="token punctuation">.</span>rnn2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> rnn_hidden<span class="token punctuation">,</span> rnn_hidden<span class="token punctuation">,</span> bidirectional<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># 全连接层 </span>
        self<span class="token punctuation">.</span>dense <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> rnn_hidden<span class="token punctuation">,</span> num_class<span class="token punctuation">)</span>

    <span class="token comment"># CNN主干网络， 传入图像深度，高度和宽度，以及是否使用leaky_relu激活函数</span>
    <span class="token keyword">def</span> <span class="token function">_cnn_backbone</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_channel<span class="token punctuation">,</span> img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">,</span> leaky_relu<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> img_height <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">0</span>  <span class="token comment"># 确保高度是16的倍数，宽度是4的倍数</span>
        <span class="token keyword">assert</span> img_width <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span>

        <span class="token comment"># 超参设置</span>
        channels <span class="token operator">=</span> <span class="token punctuation">[</span>img_channel<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span>
        kernel_sizes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
        strides <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        paddings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>

        cnn <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">conv_relu</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> batch_norm<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 实现计算的整体模块，表示进行第i次卷积</span>
            <span class="token comment"># shape of input: (batch, input_channel, height, width)</span>
            input_channel <span class="token operator">=</span> channels<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            output_channel <span class="token operator">=</span> channels<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>

            cnn<span class="token punctuation">.</span>add_module<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f'conv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>input_channel<span class="token punctuation">,</span> output_channel<span class="token punctuation">,</span> kernel_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> strides<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> paddings<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

            <span class="token keyword">if</span> batch_norm<span class="token punctuation">:</span>
                cnn<span class="token punctuation">.</span>add_module<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'batchnorm</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>output_channel<span class="token punctuation">)</span><span class="token punctuation">)</span>

            relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">if</span> leaky_relu <span class="token keyword">else</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            cnn<span class="token punctuation">.</span>add_module<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'relu</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> relu<span class="token punctuation">)</span>

        <span class="token comment"># size of image: (channel, height, width) = (img_channel, img_height, img_width)</span>
        conv_relu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        cnn<span class="token punctuation">.</span>add_module<span class="token punctuation">(</span><span class="token string">'pooling0'</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># (64, img_height // 2, img_width // 2)</span>

        conv_relu<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        cnn<span class="token punctuation">.</span>add_module<span class="token punctuation">(</span><span class="token string">'pooling1'</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># (128, img_height // 4, img_width // 4)</span>

        conv_relu<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        conv_relu<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        cnn<span class="token punctuation">.</span>add_module<span class="token punctuation">(</span>
            <span class="token string">'pooling2'</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>  <span class="token comment"># (256, img_height // 8, img_width // 4)</span>

        conv_relu<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> batch_norm<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        conv_relu<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> batch_norm<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        cnn<span class="token punctuation">.</span>add_module<span class="token punctuation">(</span>
            <span class="token string">'pooling3'</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>  <span class="token comment"># (512, img_height // 16, img_width // 4)</span>

        conv_relu<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token comment"># (512, img_height // 16 - 1, img_width // 4 - 1)</span>

        output_channel<span class="token punctuation">,</span> output_height<span class="token punctuation">,</span> output_width <span class="token operator">=</span> \
            channels<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img_height <span class="token operator">//</span> <span class="token number">16</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> img_width <span class="token operator">//</span> <span class="token number">4</span> <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token keyword">return</span> cnn<span class="token punctuation">,</span> <span class="token punctuation">(</span>output_channel<span class="token punctuation">,</span> output_height<span class="token punctuation">,</span> output_width<span class="token punctuation">)</span>

    <span class="token comment"># CNN+LSTM前向计算</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># shape of images: (batch, channel, height, width)</span>

        conv <span class="token operator">=</span> self<span class="token punctuation">.</span>cnn<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
        batch<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width <span class="token operator">=</span> conv<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>

        conv <span class="token operator">=</span> conv<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch<span class="token punctuation">,</span> channel <span class="token operator">*</span> height<span class="token punctuation">,</span> width<span class="token punctuation">)</span>
        conv <span class="token operator">=</span> conv<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (width, batch, feature) 进行维度转换</span>

        <span class="token comment"># 卷积接全连接。全连接输入形状为(width, batch, channel*height)，</span>
        <span class="token comment"># 输出形状为(width, batch, hidden_layer)，分别对应时序长度，batch，特征数，符合LSTM输入要求</span>
        seq <span class="token operator">=</span> self<span class="token punctuation">.</span>map_to_seq<span class="token punctuation">(</span>conv<span class="token punctuation">)</span>

        recurrent<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>rnn1<span class="token punctuation">(</span>seq<span class="token punctuation">)</span> <span class="token comment"># 两次LSTM</span>
        recurrent<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>rnn2<span class="token punctuation">(</span>recurrent<span class="token punctuation">)</span>

        output <span class="token operator">=</span> self<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>recurrent<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output  <span class="token comment"># shape: (seq_len, batch, num_class) 时间步的长度，batch， 不同字符取值的概率值</span>

</code></pre> 
<pre><code class="prism language-python">img_width <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'img_width'</span><span class="token punctuation">]</span>
img_height <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'img_height'</span><span class="token punctuation">]</span>
data_dir <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'data_dir'</span><span class="token punctuation">]</span>

num_class <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>Synth90kDataset<span class="token punctuation">.</span>LABEL2CHAR<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment"># 1代表由一个blank的空白占位符</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 实例化我们的CRNN</span>
crnn <span class="token operator">=</span> CRNN<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">,</span> num_class<span class="token punctuation">,</span>
            map_to_seq_hidden<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'map_to_seq_hidden'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            rnn_hidden<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'rnn_hidden'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            leaky_relu<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'leaky_relu'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'device: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>device<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>device: cuda
</code></pre> 
<pre><code class="prism language-python">crnn<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
</code></pre> 
<pre><code>CRNN(
  (cnn): Sequential(
    (conv0): Conv2d(1, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu0): ReLU(inplace=True)
    (pooling0): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (conv1): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu1): ReLU(inplace=True)
    (pooling1): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (conv2): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu2): ReLU(inplace=True)
    (conv3): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu3): ReLU(inplace=True)
    (pooling2): MaxPool2d(kernel_size=(2, 1), stride=(2, 1), padding=0, dilation=1, ceil_mode=False)
    (conv4): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (batchnorm4): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu4): ReLU(inplace=True)
    (conv5): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (batchnorm5): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu5): ReLU(inplace=True)
    (pooling3): MaxPool2d(kernel_size=(2, 1), stride=(2, 1), padding=0, dilation=1, ceil_mode=False)
    (conv6): Conv2d(512, 512, kernel_size=(2, 2), stride=(1, 1))
    (relu6): ReLU(inplace=True)
  )
  (map_to_seq): Linear(in_features=512, out_features=64, bias=True)
  (rnn1): LSTM(64, 256, bidirectional=True)
  (rnn2): LSTM(512, 256, bidirectional=True)
  (dense): Linear(in_features=512, out_features=37, bias=True)
)
</code></pre> 
<h2><a id="_423"></a>训练部分</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os

<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> CTCLoss

<span class="token keyword">from</span> dataset <span class="token keyword">import</span> Synth90kDataset<span class="token punctuation">,</span> synth90k_collate_fn
<span class="token keyword">from</span> model <span class="token keyword">import</span> CRNN
<span class="token keyword">from</span> evaluate <span class="token keyword">import</span> evaluate
<span class="token keyword">from</span> config <span class="token keyword">import</span> train_config <span class="token keyword">as</span> config
</code></pre> 
<h4><a id="_439"></a>训练辅助函数</h4> 
<h4><a id="_441"></a>注意</h4> 
<ol><li>尺度</li></ol> 
<ul><li>images: (N, C, H, W) -&gt; (32, 1, 32, 100)</li><li>targets：(X, ),一维向量，长度不固定。32个batch标签（向量）拼接成一个长向量，target_lengths指定切割位置</li><li>logits：(T, N, n_class) -&gt; (24, 32, 37) T代表时间步的长度， N为 batchsize</li><li>input_lengths: (N,) -&gt; (32, ), 向量中每一个值表识相应batch输入序列长度,为T即24,表示输入序列长度固定为24</li><li>target_lengths: (N, ) -&gt;(32, ), 向量中每一个值表示相应batch训练图像label长度，长度不固定</li></ul> 
<ol start="2"><li>CTCLoss函数使用说明。</li></ol> 
<ol><li>获取CTCLoss()对象</li></ol> 
<pre><code>ctc_loss = nn.CTCLoss(blank=len(CHARS)-1, reduction='mean')
</code></pre> 
<ul><li> <p>blank：空白标签所在的label值，默认为0，需要根据实际的标签定义进行设定；</p> </li><li> <p>reduction：处理output losses的方式，string类型，可选’none’ 、 ‘mean’ 及 ‘sum’，'none’表示对output losses不做任何处理，‘mean’ 则对output losses取平均值处理，‘sum’则是对output losses求和处理，默认为’mean’ 。</p> </li></ul> 
<ol start="2"><li>在迭代中调用CTCLoss()对象计算损失值</li></ol> 
<pre><code>loss = ctc_loss(log_probs, targets, input_lengths, target_lengths)
</code></pre> 
<ul><li> <p>log_probs：shape为(T, N, C)的模型输出张量，其中，T表示CTCLoss的输入长度也即输出序列长度，N表示训练的batch size长度，C则表示包含有空白标签的所有要预测的字符集总长度，<mark>log_probs一般需要经过torch.nn.functional.log_softmax处理后再送入到CTCLoss中</mark>；</p> </li><li> <p>targets：shape为(N, S) 或(sum(target_lengths))的张量，其中第一种类型，N表示训练的batch size长度，S则为标签长度，第二种类型，则为所有标签长度之和，但是需要注意的是targets不能包含有空白标签；</p> </li><li> <p>input_lengths：shape为(N)的张量或元组，但每一个元素的长度必须等于T即输出序列长度，一般来说模型输出序列固定后则该张量或元组的元素值均相同；</p> </li><li> <p>target_lengths：shape为(N)的张量或元组，其每一个元素指示每个训练输入序列的标签长度，但标签长度是可以变化的；</p> </li></ul> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train_batch</span><span class="token punctuation">(</span>crnn<span class="token punctuation">,</span> data<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 训练过程中最核心的一部分</span>
    crnn<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 表示bn操作</span>
    images<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> target_lengths <span class="token operator">=</span> <span class="token punctuation">[</span>d<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> data<span class="token punctuation">]</span> <span class="token comment"># 有batch个</span>
 
    logits <span class="token operator">=</span> crnn<span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token comment"># 进行CNN LSTM 操作</span>
    log_probs <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>log_softmax<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 进行函数操作</span>

    batch_size <span class="token operator">=</span> images<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    input_lengths <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span><span class="token punctuation">[</span>logits<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">*</span> batch_size<span class="token punctuation">)</span>
    target_lengths <span class="token operator">=</span> torch<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>target_lengths<span class="token punctuation">)</span>
    <span class="token comment"># CTCloss的计算</span>
    loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>log_probs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> input_lengths<span class="token punctuation">,</span> target_lengths<span class="token punctuation">)</span>

    optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_497"></a>超参数设置</h4> 
<pre><code class="prism language-python">epochs <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'epochs'</span><span class="token punctuation">]</span>
train_batch_size <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'train_batch_size'</span><span class="token punctuation">]</span>
eval_batch_size <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'eval_batch_size'</span><span class="token punctuation">]</span>
lr <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span>
show_interval <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'show_interval'</span><span class="token punctuation">]</span> <span class="token comment"># 每隔多少次，打印信息</span>
valid_interval <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'valid_interval'</span><span class="token punctuation">]</span> <span class="token comment"># 多大的间隔进行一次验证</span>
save_interval <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'save_interval'</span><span class="token punctuation">]</span> <span class="token comment"># 多大间隔保存模型</span>
cpu_workers <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'cpu_workers'</span><span class="token punctuation">]</span>
reload_checkpoint <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'reload_checkpoint'</span><span class="token punctuation">]</span> <span class="token comment"># 加载保存好的模型参数</span>
valid_max_iter <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'valid_max_iter'</span><span class="token punctuation">]</span>

img_width <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'img_width'</span><span class="token punctuation">]</span>
img_height <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'img_height'</span><span class="token punctuation">]</span>
data_dir <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'data_dir'</span><span class="token punctuation">]</span>

num_class <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>Synth90kDataset<span class="token punctuation">.</span>LABEL2CHAR<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">#能识别字符的个数</span>
</code></pre> 
<h4><a id="cudaGPUcpu_519"></a>判断cuda是否可用，是则基于GPU训练，否则用cpu训练</h4> 
<pre><code class="prism language-python">device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'device: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>device<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>device: cuda
</code></pre> 
<h4><a id="_530"></a>设置训练数据加载器、验证数据加载器，常规操作</h4> 
<h5><a id="collate_fn_532"></a>collate_fn用法</h5> 
<ul><li>把list类型batch（若不加此操作，原先一个batch中的多个sample是在list中的）转换成Tensor，加速运算。</li><li>经collate_fn处理，返回符合需求的数据及相应尺度。</li><li>满足CTC的size要求</li></ul> 
<pre><code class="prism language-python">train_dataset <span class="token operator">=</span> Synth90kDataset<span class="token punctuation">(</span>root_dir<span class="token operator">=</span>data_dir<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span>
                                    img_height<span class="token operator">=</span>img_height<span class="token punctuation">,</span> img_width<span class="token operator">=</span>img_width<span class="token punctuation">)</span>
valid_dataset <span class="token operator">=</span> Synth90kDataset<span class="token punctuation">(</span>root_dir<span class="token operator">=</span>data_dir<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'dev'</span><span class="token punctuation">,</span>
                                img_height<span class="token operator">=</span>img_height<span class="token punctuation">,</span> img_width<span class="token operator">=</span>img_width<span class="token punctuation">)</span>

train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span>train_batch_size<span class="token punctuation">,</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    num_workers<span class="token operator">=</span>cpu_workers<span class="token punctuation">,</span>
    collate_fn<span class="token operator">=</span>synth90k_collate_fn<span class="token punctuation">)</span>
valid_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>valid_dataset<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span>eval_batch_size<span class="token punctuation">,</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    num_workers<span class="token operator">=</span>cpu_workers<span class="token punctuation">,</span>
    collate_fn<span class="token operator">=</span>synth90k_collate_fn<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="CRNNCPU_or_GPU_558"></a>实例化CRNN模型，加载模型参数，并运行至可用设备（CPU or GPU）</h4> 
<pre><code class="prism language-python">crnn <span class="token operator">=</span> CRNN<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">,</span> num_class<span class="token punctuation">,</span>
            map_to_seq_hidden<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'map_to_seq_hidden'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            rnn_hidden<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'rnn_hidden'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            leaky_relu<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'leaky_relu'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> reload_checkpoint<span class="token punctuation">:</span>
    crnn<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>reload_checkpoint<span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
crnn<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
</code></pre> 
<pre><code>CRNN(
  (cnn): Sequential(
    (conv0): Conv2d(1, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu0): ReLU(inplace=True)
    (pooling0): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (conv1): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu1): ReLU(inplace=True)
    (pooling1): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (conv2): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu2): ReLU(inplace=True)
    (conv3): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu3): ReLU(inplace=True)
    (pooling2): MaxPool2d(kernel_size=(2, 1), stride=(2, 1), padding=0, dilation=1, ceil_mode=False)
    (conv4): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (batchnorm4): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu4): ReLU(inplace=True)
    (conv5): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (batchnorm5): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu5): ReLU(inplace=True)
    (pooling3): MaxPool2d(kernel_size=(2, 1), stride=(2, 1), padding=0, dilation=1, ceil_mode=False)
    (conv6): Conv2d(512, 512, kernel_size=(2, 2), stride=(1, 1))
    (relu6): ReLU(inplace=True)
  )
  (map_to_seq): Linear(in_features=512, out_features=64, bias=True)
  (rnn1): LSTM(64, 256, bidirectional=True)
  (rnn2): LSTM(512, 256, bidirectional=True)
  (dense): Linear(in_features=512, out_features=37, bias=True)
)
</code></pre> 
<h4><a id="_605"></a>定义优化方法、损失函数</h4> 
<p>CTC 的全称是Connectionist Temporal Classification，中文名称是“连接时序分类”，这个方法主要是解决神经网络label 和output 不对齐的问题（Alignment problem），其优点是不用强制对齐标签且标签可变长，仅需输入序列和监督标签序列即可进行训练，目前，该方法主要应用于场景文本识别（scene text recognition）、语音识别（speech recognition）及手写字识别（handwriting recognition）等工程场景。以往我们在百度上搜索pytorch + ctc loss得到的结果基本上warp-ctc的使用方法，warp-ctc是百度开源的一个可以应用在CPU和GPU上高效并行的CTC代码库，但是为了在pytorch上使用warp-ctc我们不仅需要编译其源代码还需要进行安装配置，使用起来着实麻烦。而在Pytorch 1.0.x版本内早就有内置ctc loss接口了，我们完全可以直接使用</p> 
<pre><code class="prism language-python">optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>RMSprop<span class="token punctuation">(</span>crnn<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>
criterion <span class="token operator">=</span> CTCLoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">)</span>
criterion<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
</code></pre> 
<pre><code>CTCLoss()
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">assert</span> save_interval <span class="token operator">%</span> valid_interval <span class="token operator">==</span> <span class="token number">0</span>
i <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h4><a id="_628"></a>开始训练</h4> 
<pre><code class="prism language-python"><span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> epochs <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'epoch: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    tot_train_loss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span>
    tot_train_count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> train_data <span class="token keyword">in</span> train_loader<span class="token punctuation">:</span>
        loss <span class="token operator">=</span> train_batch<span class="token punctuation">(</span>crnn<span class="token punctuation">,</span> train_data<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span> device<span class="token punctuation">)</span>
        train_size <span class="token operator">=</span> train_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        tot_train_loss <span class="token operator">+=</span> loss
        tot_train_count <span class="token operator">+=</span> train_size
        <span class="token keyword">if</span> i <span class="token operator">%</span> show_interval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment"># 打印间隔</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'train_batch_loss['</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">']: '</span><span class="token punctuation">,</span> loss <span class="token operator">/</span> train_size<span class="token punctuation">)</span>

        <span class="token keyword">if</span> i <span class="token operator">%</span> valid_interval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment"># 验证间隔</span>
            evaluation <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>crnn<span class="token punctuation">,</span> valid_loader<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span>
                                  decode_method<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'decode_method'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  beam_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'beam_size'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'valid_evaluation: loss={loss}, acc={acc}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">**</span>evaluation<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> i <span class="token operator">%</span> save_interval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 自动保存间隔</span>
            prefix <span class="token operator">=</span> <span class="token string">'crnn'</span>
            loss <span class="token operator">=</span> evaluation<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>
            save_model_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'checkpoints_dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                           <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>prefix<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">:</span><span class="token format-spec">06</span><span class="token punctuation">}</span></span><span class="token string">_loss</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>loss<span class="token punctuation">}</span></span><span class="token string">.pt'</span></span><span class="token punctuation">)</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>crnn<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> save_model_path<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'save model at '</span><span class="token punctuation">,</span> save_model_path<span class="token punctuation">)</span>

        i <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'train_loss: '</span><span class="token punctuation">,</span> tot_train_loss <span class="token operator">/</span> tot_train_count<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_664"></a>预测部分</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> glob

<span class="token keyword">from</span> docopt <span class="token keyword">import</span> docopt
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader

<span class="token keyword">from</span> config <span class="token keyword">import</span> common_config <span class="token keyword">as</span> config
<span class="token keyword">from</span> dataset <span class="token keyword">import</span> Synth90kDataset<span class="token punctuation">,</span> synth90k_collate_fn
<span class="token keyword">from</span> model <span class="token keyword">import</span> CRNN
<span class="token keyword">from</span> ctc_decoder <span class="token keyword">import</span> ctc_decode
</code></pre> 
<h4><a id="_679"></a>超参数设置</h4> 
<pre><code class="prism language-python">images_dir <span class="token operator">=</span> <span class="token string">'../demo/*.jpg'</span>

images_path <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>images_dir<span class="token punctuation">)</span>
reload_checkpoint <span class="token operator">=</span> <span class="token string">'../checkpoints/crnn_synth90k.pt'</span>
batch_size <span class="token operator">=</span> <span class="token number">256</span>
decode_method <span class="token operator">=</span> <span class="token string">'beam_search'</span>
beam_size <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment"># size越大，表示准确率越高，时间复杂度也相应越大</span>

img_height <span class="token operator">=</span> <span class="token number">32</span>
img_width <span class="token operator">=</span> <span class="token number">100</span>

num_class <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>Synth90kDataset<span class="token punctuation">.</span>LABEL2CHAR<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
</code></pre> 
<h4><a id="cudacpu_697"></a>判断cuda是否可用，否则用cpu预测</h4> 
<pre><code class="prism language-python">device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'device: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>device<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>device: cuda
</code></pre> 
<h4><a id="_708"></a>设置预测数据加载器，常规操作</h4> 
<pre><code class="prism language-python">predict_dataset <span class="token operator">=</span> Synth90kDataset<span class="token punctuation">(</span>paths<span class="token operator">=</span>images_path<span class="token punctuation">,</span>
                                      img_height<span class="token operator">=</span>img_height<span class="token punctuation">,</span> img_width<span class="token operator">=</span>img_width<span class="token punctuation">)</span>

predict_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>predict_dataset<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
    shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="CRNNCPU_or_GPU_721"></a>实例化CRNN模型，加载模型参数，并运行至可用设备（CPU or GPU）</h4> 
<pre><code class="prism language-python">crnn <span class="token operator">=</span> CRNN<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">,</span> num_class<span class="token punctuation">,</span>
                map_to_seq_hidden<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'map_to_seq_hidden'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                rnn_hidden<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'rnn_hidden'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                leaky_relu<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'leaky_relu'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
crnn<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>reload_checkpoint<span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
crnn<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
</code></pre> 
<pre><code>CRNN(
  (cnn): Sequential(
    (conv0): Conv2d(1, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu0): ReLU(inplace=True)
    (pooling0): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (conv1): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu1): ReLU(inplace=True)
    (pooling1): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (conv2): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu2): ReLU(inplace=True)
    (conv3): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (relu3): ReLU(inplace=True)
    (pooling2): MaxPool2d(kernel_size=(2, 1), stride=(2, 1), padding=0, dilation=1, ceil_mode=False)
    (conv4): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (batchnorm4): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu4): ReLU(inplace=True)
    (conv5): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (batchnorm5): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu5): ReLU(inplace=True)
    (pooling3): MaxPool2d(kernel_size=(2, 1), stride=(2, 1), padding=0, dilation=1, ceil_mode=False)
    (conv6): Conv2d(512, 512, kernel_size=(2, 2), stride=(1, 1))
    (relu6): ReLU(inplace=True)
  )
  (map_to_seq): Linear(in_features=512, out_features=64, bias=True)
  (rnn1): LSTM(64, 256, bidirectional=True)
  (rnn2): LSTM(512, 256, bidirectional=True)
  (dense): Linear(in_features=512, out_features=37, bias=True)
)
</code></pre> 
<h4><a id="_767"></a>实例化进度条，用于查看预测进度</h4> 
<pre><code class="prism language-python">pbar <span class="token operator">=</span> tqdm<span class="token punctuation">(</span>total<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>predict_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"Predict"</span><span class="token punctuation">)</span>
all_preds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>Predict:   0%|                                                                                   | 0/1 [00:00&lt;?, ?it/s]
</code></pre> 
<h4><a id="_777"></a>执行预测</h4> 
<pre><code class="prism language-python"><span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> data <span class="token keyword">in</span> predict_loader<span class="token punctuation">:</span>
            device <span class="token operator">=</span> <span class="token string">'cuda'</span> <span class="token keyword">if</span> <span class="token builtin">next</span><span class="token punctuation">(</span>crnn<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_cuda <span class="token keyword">else</span> <span class="token string">'cpu'</span>

            images <span class="token operator">=</span> data<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

            logits <span class="token operator">=</span> crnn<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
            log_probs <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>log_softmax<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

            preds <span class="token operator">=</span> ctc_decode<span class="token punctuation">(</span>log_probs<span class="token punctuation">,</span> method<span class="token operator">=</span>decode_method<span class="token punctuation">,</span> beam_size<span class="token operator">=</span>beam_size<span class="token punctuation">,</span>
                               label2char<span class="token operator">=</span>Synth90kDataset<span class="token punctuation">.</span>LABEL2CHAR<span class="token punctuation">)</span>
            all_preds <span class="token operator">+=</span> preds

            pbar<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        pbar<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Predict: 100%|███████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00,  1.96it/s]
</code></pre> 
<h4><a id="_801"></a>结果展示</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">show_result</span><span class="token punctuation">(</span>paths<span class="token punctuation">,</span> preds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n===== result ====='</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> path<span class="token punctuation">,</span> pred <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>paths<span class="token punctuation">,</span> preds<span class="token punctuation">)</span><span class="token punctuation">:</span>
        text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>pred<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>path<span class="token punctuation">}</span></span><span class="token string"> &gt; </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>text<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">show_result<span class="token punctuation">(</span>images_path<span class="token punctuation">,</span> preds<span class="token punctuation">)</span>
</code></pre> 
<pre><code>===== result =====
../demo\14e214d430ea1bd5a9c043fcd56ad27.jpg &gt; csxdziszentlosts
../demo\170_READING_62745.jpg &gt; reading
../demo\178_Showtime_70541.jpg &gt; showtime
../demo\78_Novel_52433.jpg &gt; novel
</code></pre> 
<h2><a id="_825"></a>验证部分</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> CTCLoss
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

<span class="token keyword">from</span> dataset <span class="token keyword">import</span> Synth90kDataset<span class="token punctuation">,</span> synth90k_collate_fn
<span class="token keyword">from</span> model <span class="token keyword">import</span> CRNN
<span class="token keyword">from</span> ctc_decoder <span class="token keyword">import</span> ctc_decode
<span class="token keyword">from</span> config <span class="token keyword">import</span> evaluate_config <span class="token keyword">as</span> config

torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>crnn<span class="token punctuation">,</span> dataloader<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span>
             max_iter<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> decode_method<span class="token operator">=</span><span class="token string">'beam_search'</span><span class="token punctuation">,</span> beam_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    crnn<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    tot_count <span class="token operator">=</span> <span class="token number">0</span>
    tot_loss <span class="token operator">=</span> <span class="token number">0</span>
    tot_correct <span class="token operator">=</span> <span class="token number">0</span>
    wrong_cases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    pbar_total <span class="token operator">=</span> max_iter <span class="token keyword">if</span> max_iter <span class="token keyword">else</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span>
    pbar <span class="token operator">=</span> tqdm<span class="token punctuation">(</span>total<span class="token operator">=</span>pbar_total<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"Evaluate"</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> max_iter <span class="token keyword">and</span> i <span class="token operator">&gt;=</span> max_iter<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            device <span class="token operator">=</span> <span class="token string">'cuda'</span> <span class="token keyword">if</span> <span class="token builtin">next</span><span class="token punctuation">(</span>crnn<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_cuda <span class="token keyword">else</span> <span class="token string">'cpu'</span>

            images<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> target_lengths <span class="token operator">=</span> <span class="token punctuation">[</span>d<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> data<span class="token punctuation">]</span>

            logits <span class="token operator">=</span> crnn<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
            log_probs <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>log_softmax<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 为后期计算CTCloss进行辅助</span>

            batch_size <span class="token operator">=</span> images<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            input_lengths <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span><span class="token punctuation">[</span>logits<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">*</span> batch_size<span class="token punctuation">)</span>

            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>log_probs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> input_lengths<span class="token punctuation">,</span> target_lengths<span class="token punctuation">)</span>

            preds <span class="token operator">=</span> ctc_decode<span class="token punctuation">(</span>log_probs<span class="token punctuation">,</span> method<span class="token operator">=</span>decode_method<span class="token punctuation">,</span> beam_size<span class="token operator">=</span>beam_size<span class="token punctuation">)</span>
            reals <span class="token operator">=</span> targets<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
            target_lengths <span class="token operator">=</span> target_lengths<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

            tot_count <span class="token operator">+=</span> batch_size
            tot_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            target_length_counter <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">for</span> pred<span class="token punctuation">,</span> target_length <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>preds<span class="token punctuation">,</span> target_lengths<span class="token punctuation">)</span><span class="token punctuation">:</span>
                real <span class="token operator">=</span> reals<span class="token punctuation">[</span>target_length_counter<span class="token punctuation">:</span>target_length_counter <span class="token operator">+</span> target_length<span class="token punctuation">]</span>
                target_length_counter <span class="token operator">+=</span> target_length
                <span class="token keyword">if</span> pred <span class="token operator">==</span> real<span class="token punctuation">:</span>
                    tot_correct <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    wrong_cases<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>real<span class="token punctuation">,</span> pred<span class="token punctuation">)</span><span class="token punctuation">)</span>

            pbar<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        pbar<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    evaluation <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'loss'</span><span class="token punctuation">:</span> tot_loss <span class="token operator">/</span> tot_count<span class="token punctuation">,</span>
        <span class="token string">'acc'</span><span class="token punctuation">:</span> tot_correct <span class="token operator">/</span> tot_count<span class="token punctuation">,</span>
        <span class="token string">'wrong_cases'</span><span class="token punctuation">:</span> wrong_cases
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> evaluation
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    eval_batch_size <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'eval_batch_size'</span><span class="token punctuation">]</span>
    cpu_workers <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'cpu_workers'</span><span class="token punctuation">]</span>
    reload_checkpoint <span class="token operator">=</span> <span class="token string">'../checkpoints/crnn_synth90k.pt'</span>

    img_height <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'img_height'</span><span class="token punctuation">]</span>
    img_width <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'img_width'</span><span class="token punctuation">]</span>

    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'device: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>device<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    test_dataset <span class="token operator">=</span> Synth90kDataset<span class="token punctuation">(</span>root_dir<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'data_dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">,</span>
                                   img_height<span class="token operator">=</span>img_height<span class="token punctuation">,</span> img_width<span class="token operator">=</span>img_width<span class="token punctuation">)</span>

    test_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>
        dataset<span class="token operator">=</span>test_dataset<span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span>eval_batch_size<span class="token punctuation">,</span>
        shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        num_workers<span class="token operator">=</span>cpu_workers<span class="token punctuation">,</span>
        collate_fn<span class="token operator">=</span>synth90k_collate_fn<span class="token punctuation">)</span>

    num_class <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>Synth90kDataset<span class="token punctuation">.</span>LABEL2CHAR<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
    crnn <span class="token operator">=</span> CRNN<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">,</span> num_class<span class="token punctuation">,</span>
                map_to_seq_hidden<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'map_to_seq_hidden'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                rnn_hidden<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'rnn_hidden'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                leaky_relu<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'leaky_relu'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    crnn<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>reload_checkpoint<span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
    crnn<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    criterion <span class="token operator">=</span> CTCLoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">)</span>
    criterion<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    evaluation <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>crnn<span class="token punctuation">,</span> test_loader<span class="token punctuation">,</span> criterion<span class="token punctuation">,</span>
                          decode_method<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'decode_method'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                          beam_size<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'beam_size'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'test_evaluation: loss={loss}, acc={acc}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">**</span>evaluation<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<pre><code class="prism language-python">main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Evaluate:   0%|                                                                                                           | 0/1 [00:00&lt;?, ?it/s]

device: cpu


Evaluate: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:05&lt;00:00,  5.22s/it]

test_evaluation: loss=0.2696375235533103, acc=0.9615384615384616
</code></pre> 
<pre><code class="prism language-python">
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3f5e9543936b69db6c87000ecf28f2d7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决微信小程序input textarea输入框内容以及palceholder随页面滚动式跟着滚动，飘起来了。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/004051d63602e4ba01dced19bf980b58/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">STM32存储器映射学习笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>