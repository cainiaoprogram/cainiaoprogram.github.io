<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>负载均衡 - MQTT Broker 集群详解（一） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="负载均衡 - MQTT Broker 集群详解（一）" />
<meta property="og:description" content="MQTT 协议在物联网，小型设备场景，移动应用等方面已经有了广泛的应用，并逐渐成为了物联网通讯的标准。本文重点介绍了组建 MQTT Broker 集群的挑战及负载均衡在 MQTT 集群中所起的作用。
MQTT 协议 与大家熟悉的 HTTP 协议类似，MQTT 协议同样基于 TCP/TLS 之上，属于应用层协议（它也可以基于 HTTP 协议之上工作，本文暂不涉及这部分内容）。
MQTT 标准委员会对 MQTT 协议的释义如下：
MQTT 是用于物联网 (IoT) 的 OASIS 标准消息传递协议。它是一种非常轻量级的消息传输协议，采用了发布/订阅的机制，非常适合连接远程设备，无论是代码占用空间还是网络带宽的占用都很小。如今，MQTT 已被广泛用于汽车、工业制造、电信、石油和天然气等各个行业。
MQTT 客户端和 HTTP 客户端也很相似。它与服务器端建立一个 TCP 连接，通过该连接传输数据。不同的是，HTTP 采用的是请求/响应模型，而 MQTT 采用的是发布/订阅模型。
举个例子：客厅里安装的温度传感器，会间断性的把室内温度数值上传到 MQTT 服务器上。而另一个智能家居设备订阅了这个温度传感器发布消息的频道，就可以获得室内的温度数据，并根据实际室温采取一些智能应对措施，比如当室内温度超过 32°C 时就打开空调。
可拓展性挑战 MQTT 协议听起来似乎离我们很遥远，其实它早已渗透到了我们的日常生活中。一般情况下，单个 MQTT 节点就可以满足单个家庭的智能家居设备连接需求，用户甚至可以在树莓派上运行一个 EMQ X Edge （运行在边缘端的 MQTT 服务器）。而运行在云端的一个 EMQ X 节点可以支撑高达 200 万的连接数，轻松满足普通智能家居场景需求。
但如果是全国的千百万辆汽车要联网，或者是上百万盏路灯要传递数据之类的场景，那么巨大的设备数（MQTT 客户端）和数据吞吐量，就远远超出了单个 MQTT 节点所能承受的压力，需要组建 MQTT 服务器集群。
在组建集群的同时，也面临着一系列的技术挑战：
提供服务地址：如何让客户端知道该连接哪个地址？
不同节点如何接管 MQTT 订阅者的会话，比如当一个客户端从一台服务器断连后，要如何在另一台服务器恢复连接？" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/78a0de5bbaccaf9e250ba685cbe2e5be/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-17T17:58:27+08:00" />
<meta property="article:modified_time" content="2021-08-17T17:58:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">负载均衡 - MQTT Broker 集群详解（一）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="https://www.emqx.com/zh/mqtt" rel="nofollow">MQTT 协议</a>在物联网，小型设备场景，移动应用等方面已经有了广泛的应用，并逐渐成为了物联网通讯的标准。本文重点介绍了组建 MQTT Broker 集群的挑战及负载均衡在 MQTT 集群中所起的作用。</p> 
<h3><a id="MQTT__3"></a>MQTT 协议</h3> 
<p>与大家熟悉的 HTTP 协议类似，MQTT 协议同样基于 TCP/TLS 之上，属于应用层协议（它也可以基于 HTTP 协议之上工作，本文暂不涉及这部分内容）。</p> 
<p>MQTT 标准委员会对 MQTT 协议的释义如下：</p> 
<p>MQTT 是用于物联网 (IoT) 的 OASIS 标准消息传递协议。它是一种非常轻量级的消息传输协议，采用了发布/订阅的机制，非常适合连接远程设备，无论是代码占用空间还是网络带宽的占用都很小。如今，MQTT 已被广泛用于汽车、工业制造、电信、石油和天然气等各个行业。</p> 
<p><a href="https://www.emqx.com/zh/blog/introduction-to-the-commonly-used-mqtt-client-library" rel="nofollow">MQTT 客户端</a>和 HTTP 客户端也很相似。它与服务器端建立一个 TCP 连接，通过该连接传输数据。不同的是，HTTP 采用的是请求/响应模型，而 MQTT 采用的是发布/订阅模型。</p> 
<p>举个例子：客厅里安装的温度传感器，会间断性的把室内温度数值上传到 <a href="https://www.emqx.io/zh" rel="nofollow">MQTT 服务器上</a>。而另一个智能家居设备订阅了这个温度传感器发布消息的频道，就可以获得室内的温度数据，并根据实际室温采取一些智能应对措施，比如当室内温度超过 32°C 时就打开空调。</p> 
<h3><a id="_15"></a>可拓展性挑战</h3> 
<p>MQTT 协议听起来似乎离我们很遥远，其实它早已渗透到了我们的日常生活中。一般情况下，单个 MQTT 节点就可以满足单个家庭的智能家居设备连接需求，用户甚至可以在树莓派上运行一个 EMQ X Edge （运行在边缘端的 MQTT 服务器）。而运行在云端的一个 EMQ X 节点可以支撑高达 200 万的连接数，轻松满足普通智能家居场景需求。</p> 
<p>但如果是全国的千百万辆汽车要联网，或者是上百万盏路灯要传递数据之类的场景，那么巨大的设备数（MQTT 客户端）和数据吞吐量，就远远超出了单个 MQTT 节点所能承受的压力，需要组建 MQTT 服务器集群。</p> 
<p>在组建集群的同时，也面临着一系列的技术挑战：</p> 
<ol><li> <p>提供服务地址：如何让客户端知道该连接哪个地址？</p> </li><li> <p>不同节点如何接管 MQTT 订阅者的会话，比如当一个客户端从一台服务器断连后，要如何在另一台服务器恢复连接？</p> </li><li> <p>集群中各个节点上的路由表如何保持一致性？</p> </li></ol> 
<p>通过在 MQTT 集群前面引入一个负载均衡，可以帮助我们轻松解决问题 1 和 2。</p> 
<h3><a id="MQTT__32"></a>MQTT 负载均衡</h3> 
<p><img src="https://images2.imgbox.com/66/09/GkmWv7wJ_o.png" alt="MQTT 负载均衡"></p> 
<p align="center">MQTT 负载均衡</p> 
<p>为了应对上述问题，负载均衡需要能够根据配置的均衡策略来帮助客户端决定连接到哪个节点。 MQTT 集群负载均衡的主要功能有：</p> 
<ul><li> <p>对外提供集群服务地址</p> <p>客户端只需要关心负载均衡的地址，而且不需要知道集群内各个节点的地址。这大大提升了服务器迁移和伸缩的灵活性。</p> </li><li> <p>TLS 终结</p> <p>许多 MQTT 的用户选择在负载均衡这一层来终结 TLS，这样可以使 MQTT 服务器的资源被充分用于消息的处理。</p> </li><li> <p>平衡集群中各个节点的负载</p> <p>负载均衡服务通常可以配置不同的均衡策略，如：随机分配、轮询（有些轮询策略可以调节节点权重），还有比较有意思的粘性分配。</p> </li></ul> 
<p>由于 MQTT 是基于 TCP/IP 之上的协议，因此可以在传输层进行负载均衡。而在传输层负载均衡之外，MQTT 能使用的负载均衡产品 HAProxy 2.4 和 Nginx Plus 还提供了应用层（MQTT 层）的负载均衡解决方案。</p> 
<p>Nginx Plus 是在 Nginx（一个开源的 Web 服务器，适用于高流量网站的反向代理）基础上构建的应用程序交付平台。Nginx Plus 的<a href="https://www.nginx.com/blog/nginx-plus-iot-load-balancing-mqtt/" rel="nofollow">这篇文章</a>作了较为详细的描述。</p> 
<p>同样优秀的，还有 HAProxy。它提供高可用性负载均衡，以及基于 TCP、HTTP 和 MQTT 的应用程序代理。到目前为止（2021 年 8月），HAProxy 2.4 是唯一一款可以提供 MQTT 层负载均衡的免费产品。在他们的 <a href="https://www.haproxy.com/blog/announcing-haproxy-2-4/" rel="nofollow">release note</a> 中，对 MQTT 负载均衡的功能作了简单的介绍。</p> 
<p>在 “MQTT Broker 集群详解”系列的下一篇文章中，我们将对 HAProxy 2.4 + EMQ X 4.3 的集成方案进行详细展开，敬请期待。</p> 
<blockquote> 
 <p>版权声明： 本文为 EMQ 原创，转载请注明出处。</p> 
 <p>原文链接：<a href="https://www.emqx.com/zh/blog/mqtt-broker-clustering-part-1-load-balancing" rel="nofollow">https://www.emqx.com/zh/blog/mqtt-broker-clustering-part-1-load-balancing</a></p> 
 <p>技术支持：如对本文或 EMQ 相关产品有疑问，可访问 EMQ 问答社区 <a href="https://askemq.com" rel="nofollow">https://askemq.com</a> 提问，我们将会及时回复支持。</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/699049493c511daad52ce2c8ce47ee76/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一文了解推荐系统中的图神经网络</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e0b186fe7274b9dd125d0580ef14f6d9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android基础TextView 实现跑马灯效果</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>