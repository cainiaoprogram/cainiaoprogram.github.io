<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL Server数据库迁移最佳实践，可降低风险和停机时间 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SQL Server数据库迁移最佳实践，可降低风险和停机时间" />
<meta property="og:description" content="介绍 (Introduction) The main goal of many organizations, today, is reducing costs while maintaining the highest degree of stability and efficiency. To this end, we should think out of the box about how we can help to achieve this as DBAs. The approaches include: 今天，许多组织的主要目标是降低成本，同时保持最高的稳定性和效率。 为此，我们应该以开箱即用的方式考虑如何才能帮助实现DBA的目标。 这些方法包括： Centralization 集权 Curtailment the SAN storage 减少SAN存储 Reducing the Microsoft license for Windows and SQL Server 减少Windows和SQL Server的Microsoft许可证 Database Migration is a possible solution to achieve this goal." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ac7c2db092dba804b61dcb1adfae5706/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-17T12:51:52+08:00" />
<meta property="article:modified_time" content="2020-07-17T12:51:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL Server数据库迁移最佳实践，可降低风险和停机时间</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size: 16px;"> 
 <h3> 介绍 <span style="font-weight: bold;">(</span>Introduction<span style="font-weight: bold;">)</span></h3> 
 <p> The main goal of many organizations, today, is reducing costs while maintaining the highest degree of stability and efficiency. To this end, we should think out of the box about how we can help to achieve this as DBAs<strong>. </strong>The approaches include: </p> 
 <p> 今天，许多组织的主要目标是降低成本，同时保持最高的稳定性和效率。 为此，我们应该以开箱即用的方式考虑如何才能帮助实现DBA的目标<strong>。</strong> 这些方法包括： </p> 
 <ul><li> Centralization <p class="nodelete"></p> 集权 </li><li> Curtailment the SAN storage <p class="nodelete"></p> 减少SAN存储 </li><li> Reducing the Microsoft license for Windows and SQL Server <p class="nodelete"></p> 减少Windows和SQL Server的Microsoft许可证 </li></ul> 
 <p> Database Migration is a possible solution to achieve this goal. However, some DBA’s do not have a clear view of the requirements, and the actual steps for how to accomplish this with minimum risks and zero downtime. </p> 
 <p> 数据库迁移是实现此目标的可能解决方案。 但是，某些DBA对要求没有清晰的了解，而对于如何以最小的风险和零停机时间实现这一目标的实际步骤也不清楚。 </p> 
 <p> </p> 
 <div style="text-align: center;"> 
  <img src="https://images2.imgbox.com/03/93/LFBIbjk7_o.png" style="outline: none;"> 
 </div> 
 <p> In this article, I will list commons steps for database migration, including the following: </p> 
 <p> 在本文中，我将列出数据库迁移的常用步骤，包括以下内容： </p> 
 <ul><li> Migration Requirements <p class="nodelete"></p> 迁移要求 </li><li> Reporting Services (SSRS) Migration <p class="nodelete"></p> 报告服务（SSRS）迁移 </li><li> Databases Engine Migration Preparation <p class="nodelete"></p> 数据库引擎迁移准备 </li><li> Database Engine Migration Process <p class="nodelete"></p> 数据库引擎迁移过程 </li><li> Migration recommendation <p class="nodelete"></p> 迁移建议 </li><li> Conclusion <p class="nodelete"></p> 结论 </li><li> References <p class="nodelete"></p> 参考资料 </li></ul> 
 <h3> 迁移要求 <span style="font-weight: bold;">(</span>Migration requirements <span style="font-weight: bold;">)</span></h3> 
 <p> In this phase, we should have good knowledge about Microsoft SQL Server services and how we can manage it to be able to collect the below information: </p> 
 <p> 在此阶段，我们应该对Microsoft SQL Server服务以及如何对其进行管理以收集以下信息有很好的了解： </p> 
 <ul><li><p><strong>How many SQL Server instances?</strong> If we are going for migration project, we should list all the instance included in this process to prepare our scripts and to open the shared folder Port 445 to be able to take backup and restore on this shared folder.</p> <p> <strong>有多少个SQL Server实例？</strong> 如果要进行迁移项目，则应列出此过程中包含的所有实例以准备脚本并打开共享文件夹端口445，以便能够在此共享文件夹上进行备份和还原。 </p></li><li><p><strong>How many Databases need to be migrated?</strong> This is very important information to be able to know how we will distribute the databases between the new instances that we will migrate to. </p><p> <strong>需要迁移多少个数据库？</strong> 这是非常重要的信息，能够知道我们将如何在将要迁移到的新实例之间分配数据库。 </p></li><li><p><strong>Databases size?</strong> This information is required to be able to design the disk chart diagram required for this databases</p> <p> <strong>数据库大小？</strong> 需要此信息才能设计此数据库所需的磁盘图表 </p></li></ul> 
 <p> </p> 
 <div style="text-align: center;"> 
  <img src="https://images2.imgbox.com/c4/e6/yfZNhg0Z_o.png" style="outline: none;"> 
 </div> 
 <h3> 报告服务（SSRS）迁移 <span style="font-weight: bold;">(</span>Reporting Services (SSRS) Migration<span style="font-weight: bold;">)</span></h3> 
 <p> For moving reporting RDL from server to another server, we have two options: </p> 
 <p> 要将报告RDL从一台服务器移动到另一台服务器，我们有两个选择： </p> 
 <ol><li><p> Backup/Restore the two databases {<!-- --><strong>ReportServer, ReportServerTemp</strong>} from the old reporting service instance to the new one </p> <p> 将两个数据库{ <strong>ReportServer，ReportServerTemp</strong> }从旧的报表服务实例备份/恢复到新数据库 </p></li><li><p> Moving the RDL files and data source using third party tools like RS ScripterThis tool can grab all the RDL and data source from the destination and deploy it to the new report server. For more information about this tool check this <a href="https://weblogs.asp.net/akjoshi/using-rs-scripter-to-create-deployment-script-for-reporting-services" rel="nofollow noopener noreferrer" target="_blank">link</a></p> <p> 使用RS Scripter等第三方工具移动RDL文件和数据源此工具可以从目标位置获取所有RDL和数据源，并将其部署到新的报表服务器。 有关此工具的更多信息，请单击此<a href="https://weblogs.asp.net/akjoshi/using-rs-scripter-to-create-deployment-script-for-reporting-services" rel="nofollow noopener noreferrer" target="_blank">链接</a> </p></li></ol> 
 <p> More information can be found on this article <a href="https://msdn.microsoft.com/en-us/library/ms156421.aspx" rel="nofollow noopener noreferrer" target="_blank"> – Moving the Report Server Databases to Another Computer (SSRS Native Mode)</a> </p> 
 <p> 可以在本文中找到更多信息<a href="https://msdn.microsoft.com/en-us/library/ms156421.aspx" rel="nofollow noopener noreferrer" target="_blank">–将报表服务器数据库移动到另一台计算机（SSRS纯模式）</a> </p> 
 <h3> 数据库迁移 <span style="font-weight: bold;">(</span>Database Migration <span style="font-weight: bold;">)</span></h3> 
 <p> In this stage, will list all the steps one by one, that it will lead us to the optimal migration with no downtime, and without missing anything. These steps are divided into two phases, Preparation and Migration which will be covered next: </p> 
 <p> 在此阶段，将一步一步列出所有步骤，它将使我们在不停机的情况下实现最佳迁移，并且不会丢失任何内容。 这些步骤分为两个阶段，准备和迁移，接下来将介绍这些阶段： </p> 
 <h3> 数据库引擎迁移准备 <span style="font-weight: bold;">(</span>Databases Engine Migration Preparation<span style="font-weight: bold;">)</span></h3> 
 <ul><li><p><strong>Application Server: </strong>The Development team should be ready to change the connection string to the new SQL Server instance name. However, sometimes they will not be able to do this, and in such case we need to us routing alias to direct any connection attempts from the application server to the Old SQL Server.</p> <p> <strong>应用程序服务器：</strong>开发团队应准备将连接字符串更改为新SQL Server实例名称。 但是，有时他们将无法执行此操作，在这种情况下，我们需要使用路由别名将任何连接尝试从应用程序服务器定向到旧SQL Server。 </p> <p> Then the alias will direct it to our new SQL Server </p> <p> 然后，别名会将其定向到我们的新SQL Server </p> <p> To do this action: </p><p> 要执行此操作： </p> 
   <ul><li><p></p> 
    <p></p> 
    </li><li> Open RUN <p class="nodelete"></p> 打开运行 </li><li> Write Cliconfg <p class="nodelete"></p> 写Cliconfg </li><li><p> <a rel="nofollow" href="https://www.sqlshack.com/wp-content/uploads/2016/12/cliconfg-png.png"></a></p> 
     <div style="text-align: center;"> 
      <a rel="nofollow" href="https://www.sqlshack.com/wp-content/uploads/2016/12/cliconfg-png.png"><img src="https://images2.imgbox.com/2e/b7/AwwIVJfj_o.png" style="outline: none;"></a> 
     </div> <p></p><p> <a rel="nofollow" href="https://www.sqlshack.com/wp-content/uploads/2016/12/cliconfg-png.png"></a> </p> 
     <center>
       Figure 2 Adding Alias 
     </center> 
     <center>
       图2添加别名 
     </center> </li></ul></li><li><p><strong>Server configuration</strong>: script all the current server configuration like [CPU, IO, Memory, the threshold of parallelism, Max degree of parallelism, CLR] </p><p> <strong>服务器配置</strong> ：编写所有当前服务器配置的脚本，例如[CPU，IO，内存，并行度阈值，最大并行度，CLR] </p></li><li><p><strong>RCSI (Read Committed Snapshot Isolation):</strong> List all databases with <strong>RCSI</strong> option enable, this configuration saved in MSDB and when you move the DB by backup/restore this kind of configuration you will lose it. </p> <p> <strong>RCSI（读取提交的快照隔离）：</strong>列出所有启用了<strong>RCSI</strong>选项的数据库，此配置保存在MSDB中，当您通过备份/还原移动数据库时，这种配置将丢失。 </p> <pre class="has"><code> 
Select name,
' 
EXEC sp_resetstatus ''' + name + '''
GO
ALTER DATABASE ' + name + ' SET SINGLE_USER WITH ROLLBACK IMMEDIATE
go 
ALTER DATABASE ' + name + ' SET READ_COMMITTED_SNAPSHOT ON; 
go
ALTER DATABASE ' + name + ' SET MULTI_USER WITH ROLLBACK IMMEDIATE
go
'
as 'Run on Destination Server.'
from sys.databases
where is_read_committed_snapshot_on = 1
and database_id&gt;4 and name &lt;&gt;'distribution'
 
</code></pre></li><li><p><strong>Service Broker</strong>: figure out the databases with the service broker option enabled </p> <p> <strong>Service Broker</strong> ：找出启用了Service Broker选项的数据库 </p> <pre class="has"><code> 
Select name,'
USE master ;
GO
ALTER DATABASE [' + name + '] SET  SINGLE_USER WITH ROLLBACK IMMEDIATE
GO
ALTER DATABASE ' + name + ' SET ENABLE_BROKER ;
GO 
ALTER DATABASE [' + name + '] SET  MULTI_USER WITH ROLLBACK IMMEDIATE
GO' 
from sys.databases where is_broker_enabled = 1
and database_id&gt;4 and name &lt;&gt;'distribution'
 
</code></pre></li><li><p><strong>Non-Contained Object Migration</strong>: here we need to migrate the following: Linked Servers, Users, Privileges Alerts, Operator, Mail configuration, Bussniues jobs and System DB user objects</p> <p> <strong>非包含对象迁移</strong> ：在这里，我们需要迁移以下内容：链接服务器，用户，特权警报，操作员，邮件配置，Bussniues作业和System DB用户对象 </p> <p> To cover all of the above, I am using a very helpful PowerShell script from DBATools which covers many cases. </p> <p> 为了涵盖以上所有内容，我使用了DBATools提供的非常有用的PowerShell脚本，该脚本涵盖了许多情况。 </p> <p> For more information about this PowerShell script check it here <a href="https://dbatools.io/download/" rel="nofollow noopener noreferrer" target="_blank"><strong>DBATools</strong></a><strong>;</strong> some samples from the PowerShell command: </p> <p> 有关此PowerShell脚本的更多信息，请在这里<a href="https://dbatools.io/download/" rel="nofollow noopener noreferrer" target="_blank"><strong>DBATools中进行</strong></a>检查<strong>；</strong> PowerShell命令中的一些示例： </p> 
   <ul><li><strong>Server name</strong>”-Destination “<strong>服务器名称</strong> ”-目标“ <strong>Server name</strong>”-Force <strong>服务器名称</strong> ”-强制 </li><li><strong>Server name</strong>”-Destination “<strong>服务器名称</strong> ”-目标“ <strong>Server name</strong>” <strong>服务器名称</strong> ” </li><li><strong>Server name</strong>”-Destination “<strong>服务器名称</strong> ”-目标“ <strong>Server name</strong>”-Force <strong>服务器名称</strong> ”-强制 </li><li><strong>Server name</strong>”-Destination “<strong>服务器名称</strong> ”-目标“ <strong>Server name</strong>”-Force <strong>服务器名称</strong> ”-强制 </li><li><strong>Server name</strong>”-Destination “<strong>服务器名称</strong> ”-目标“ <strong>Server name</strong>”-Force <strong>服务器名称</strong> ”-强制 </li><li><strong>Server name</strong>”-Destination “<strong>服务器名称</strong> ”-目标“ <strong>Server name</strong>” -Force <strong>服务器名称</strong> ”-强制 </li><li><strong>Server name</strong>”-Destination “<strong>服务器名称</strong> ”-目标“ <strong>Server name</strong>”–Force <strong>服务器名称</strong> ”-强制 </li><li><strong>Server name</strong>”-Destination “<strong>服务器名称</strong> ”-目标“ <strong>Server name</strong>.” <strong>服务器名称”</strong> 。 </li></ul></li></ul> 
 <ul><li><strong>SYNONYMS</strong>: it is like linked server we need to list it then change the connection string with new server <strong>SYNONYMS</strong> ：就像链接服务器一样，我们需要列出它，然后更改与新服务器的连接字符串 <pre class="has"><code> 
Declare @DBname Nvarchar(500)=(Select DB_NAME())
Select @DBname
Select   '
Use ['+@DBname+']
GO
Create SYNONYM dbo.[' + Name + '] For ' + Base_Object_name   FROM SYS.SYNONYMS
 
</code></pre></li></ul> 
 <h3> 数据库引擎迁移过程 <span style="font-weight: bold;">(</span>Database engine migration process<span style="font-weight: bold;">)</span></h3> 
 <p> These previous four points are pre-preparation for the migration process, and now let’s start the actual migration. </p> 
 <p> 前面的四点是迁移过程的准备工作，现在让我们开始实际的迁移。 </p> 
 <ul><li><p><strong>Full Backup from the source server: </strong>Backup is the most important step that the entire migration processes depend on it. Thus, I am using one of my customized stored procedures: (<strong>DMV_backup_Database</strong>), it is very sophisticated stored procedure to drive all of the SQL backups types (<strong>FULL, DIFF, LOG</strong>) with using the backup device, dynamic technology parameters, Table type for eliminating long some databases from the backup. This stored procedure will require creating two shared folders on the destination server, to be able to take the backup direct from the source to the destination SAN disks.</p><p> <strong>从源服务器进行完全备份：</strong>备份是整个迁移过程所依赖的最重要的步骤。 因此，我使用的是我的自定义存储过程之一：（ <strong>DMV_backup_Database</strong> ），它是一种非常复杂的存储过程，它通过使用备份设备，动态技术参数，表类型来驱动所有SQL备份类型（ <strong>FULL，DIFF，LOG</strong> ）从备份中消除了一些数据库。 此存储过程将需要在目标服务器上创建两个共享文件夹，以便能够将备份直接从源磁盘复制到目标SAN磁盘。 </p> 
   <div class="mailmunch-forms-in-post-middle"></div> 
   <div class="mailmunch-forms-in-post-middle"></div> <p> For more information about this stored procedure including parameters and script see Appendix A. </p> <p> 有关此存储过程的更多信息，包括参数和脚本，请参阅附录A。 </p> <pre class="has"><code> 
USE [msdb]
GO
 
CREATE TYPE [dbo].[Exceptionlist] AS TABLE(
	[list] [int] NULL
)
GO
 
USE [msdb]
GO
DECLARE	@return_value int
declare @Exceptionlist_value Exceptionlist 
insert into  @Exceptionlist_value 
Select 2 UNION SELECT 6 UNION SELECT 9--- DB's ID Excluded from backup process
EXEC	@return_value = [dbo].[DMV_BackupAll]
		@start_DB_ID = 5,
		@END_DB_ID = 200,
		@FULLTapeBackupLocation = N'\\DestinationServer\Backup\FULL\',
		@FULLBackup = 1,
		@FULLoverwrite =1 ,
		@DIFFTapeBackupLocation = N'\\DestinationServer\Backup\DIFF\',
		@DiffBackup= 0 ,
		@DIFFoverwrite = 0,
		@LOGBackupLocation = N'\\DestinationServer\Backup\LOG\',
		@LOGBackup = 0,
		@LOGoverwrite = 0,
		@COMPRESSION = 1,
		@Exceptionlist_DBs = @Exceptionlist_value,
		@job_name='DMV_UserDB_Full_Backup',
		@p_recipients = 'SQLGULF-DBConsultant@MostafaElmasry.com'
 
SELECT	'Return Value' = @return_value 
 
</code></pre></li><li><p><strong>Create Backup Device for a Full backup:</strong> script all the backup devices created in the source after the backup successfully processes and create them on the destination server to be able to do the restore using this backup device. </p> <p> <strong>创建完整备份</strong>的备份设备<strong>：</strong>脚本在备份成功处理后在源中创建的所有备份设备编写脚本，并在目标服务器上创建它们，以便能够使用此备份设备进行还原。 </p> <pre class="has"><code> 
USE [master]
GO
Select 'USE [master]
GO
EXEC master.dbo.sp_addumpdevice  @devtype = N''disk'',
@logicalname = N'''+name+'_FULLtape'', @physicalname = 
N''\\DestinationServer\Backup\FULL\'+name+'_FULLtape.back''
GO
' from Sys.Databases where state_desc ='online' AND Database_id &gt; 4 
 
</code></pre></li><li><p><strong>Restore Full Backup on destination server: </strong>The second step is restoring the entire FULL backup on the new server with No recovery option. For making the databases in the restore mode to be able to restore the Differential backup overwrite it. </p><p> <strong>在目标服务器上还原完全备份：</strong>第二步是在没有恢复选项的新服务器上还原整个FULL备份。 为了使数据库在还原模式下能够还原差异备份，请将其覆盖。 </p></li><li><p><strong>DB in Read-only status:</strong> in the source server, we need to update the status of all of the databases to be <strong>in a Read-Only</strong> status, to make sure there is no change will occur on the DB level. The following script will generate a T-SQL script for altering each database to be in a <strong>Read-only</strong> mode. </p> <p> <strong>DB处于只读状态：</strong>在源服务器中，我们需要将所有数据库的状态更新<strong>为只读</strong>状态，以确保在DB级别上不会发生任何更改。 以下脚本将生成一个T-SQL脚本，用于将每个数据库更改为<strong>只读</strong>模式。 </p> <pre class="has"><code> 
select 'EXEC sp_resetstatus '''+NAME+'''
GO
ALTER DATABASE ['+NAME+'] SET SINGLE_USER WITH ROLLBACK IMMEDIATE
GO
ALTER DATABASE ['+NAME+'] SET  READ_ONLY WITH ROLLBACK IMMEDIATE
GO
ALTER DATABASE ['+NAME+'] SET MULTI_USER 
' 
from sys.databases where database_id&gt;4 and name &lt;&gt;'distribution' 
and state_desc = 'online'
 
</code></pre></li><li><p><strong>Differential Backup from the source server:</strong> Now the DB’s are in Read only mode so taking a differential backup will cover all the changes happened on the database from the last full backup. Here, also, we will use the same stored procedure “<strong>DMV_backup_Database</strong>” we used it in the full backup before.</p> <p> <strong>来自源服务器的差异备份：</strong>现在，数据库处于只读模式，因此进行差异备份将覆盖自上次完整备份以来数据库中发生的所有更改。 同样，在这里，我们将使用之前在完整备份中使用的存储过程“ <strong>DMV_backup_Database</strong> ”。 </p> <pre class="has"><code> 
USE [msdb]
GO
DECLARE	@return_value int
declare @Exceptionlist_value Exceptionlist 
insert into  @Exceptionlist_value 
Select 2 UNION SELECT 6 UNION SELECT 9--- DB's ID Excluded from backup process
EXEC	@return_value = [dbo].[DMV_BackupAll]
		@start_DB_ID = 5,
		@END_DB_ID = 200,
		@FULLTapeBackupLocation = N'\\DestinationServer\Backup\FULL\',
		@FULLBackup = 0,
		@FULLoverwrite =0 ,
		@DIFFTapeBackupLocation = N'\\DestinationServer\Backup\DIFF\',
		@DiffBackup= 1 ,
		@DIFFoverwrite = 1,
		@LOGBackupLocation = N'\\DestinationServer\Backup\LOG\',
		@LOGBackup = 0,
		@LOGoverwrite = 0,
		@COMPRESSION = 1,	
		@Exceptionlist_DBs = @Exceptionlist_value,
		@job_name='DMV_UserDB_DIFF_Backup',
		@p_recipients = 'SQLGULF-DBConsultant@MostafaElmasry.com'
 
</code></pre></li><li><p><strong>Create Backup Device for DIFF backup: </strong>Script the backup devices related to the DIFF backup from the source server and create it on the destination server.</p> <p> <strong>创建用于DIFF备份</strong>的备份设备<strong>：使用</strong>脚本编写与源服务器上的DIFF备份相关的备份设备，并在目标服务器上创建备份设备。 </p> <pre class="has"><code> 
USE [master]
GO
Select 'USE [master]
GO
EXEC master.dbo.sp_addumpdevice  @devtype = N''disk'',
@logicalname = N'''+name+'_DIFFtape'', @physicalname = 
N''\\DestinationServer\Backup\FULL\'+name+'_DIFFtape.back''
GO
' from Sys.Databases where state_desc ='online' AND Database_id &gt; 4
 
</code></pre></li><li><p><strong>Restore the Differential Backup on destination server: </strong>Restore the differential backup with Recover option and overwrite. </p> <p> <strong>在目标服务器上</strong>还原差异备份：使用“恢复”选项还原差异备份并覆盖。 </p></li><li><p><strong>Change DB’s status to Read-Write status</strong>: When we restored the differential backup on the destination server, will find all the databases in read only mode because we take the differential backup from the source after updating the databases by read only mode. </p> <p> <strong>将数据库的状态更改为读写状态</strong> ：当我们在目标服务器上还原差异备份时，将以只读模式查找所有数据库，因为在以只读模式更新数据库后，我们从源中获取了差异备份。 </p> <pre class="has"><code> 
select 'EXEC sp_resetstatus '''+NAME+'''
GO
ALTER DATABASE ['+NAME+'] SET SINGLE_USER WITH ROLLBACK IMMEDIATE
GO
ALTER DATABASE ['+NAME+'] SET  READ_WRITE WITH ROLLBACK IMMEDIATE
GO
ALTER DATABASE ['+NAME+'] SET MULTI_USER WITH ROLLBACK IMMEDIATE
' 
from sys.databases where database_id&gt;4 and name &lt;&gt;'distribution' 
and state_desc = 'online'
 
</code></pre></li><li><p><strong>Migrate Login from source server:</strong> Execute the PowerShell command again for moving the SQL Server users to grantee there is no missing user.</p> <p> <strong>从源服务器迁移登录：</strong>再次执行PowerShell命令，以将SQL Server用户移动到没有丢失用户的被授予者。 </p> 
   <ul><li><p> <a href="https://dbatools.io/functions/copy-sqllogin/" rel="nofollow noopener noreferrer" target="_blank"> Copy-SqlLogin</a> -Source “<strong>Server name</strong>”-Destination “<strong>Server name</strong>”-Force </p><p> <a href="https://dbatools.io/functions/copy-sqllogin/" rel="nofollow noopener noreferrer" target="_blank">Copy-SqlLogin-</a>源“ <strong>服务器名称</strong> ”-目标“ <strong>服务器名称</strong> ” <a href="https://dbatools.io/functions/copy-sqllogin/" rel="nofollow noopener noreferrer" target="_blank">-强制</a> </p></li><li><p> <a href="https://dbatools.io/functions/sync-sqlloginpermissions/" rel="nofollow noopener noreferrer" target="_blank"> Sync-SqlLoginPermissions</a> -Source “<strong>Server name</strong>”-Destination “<strong>Server name.</strong>” </p><p> <a href="https://dbatools.io/functions/sync-sqlloginpermissions/" rel="nofollow noopener noreferrer" target="_blank">Sync-SqlLoginPermissions-</a>源“ <strong>服务器名称</strong> ”-目标“ <strong>服务器名称。</strong> ” </p></li></ul></li><li><p><strong>Disable login on the source server</strong>: Now all of our databases are moved to the new server. To know if the application is working fine do disable the logins in the old instance. </p> <p> <strong>在源服务器上禁用登录</strong> ：现在我们所有的数据库都移到了新服务器上。 要知道应用程序是否运行正常，请在旧实例中禁用登录。 </p> <pre class="has"><code> 
USE master; 
GO 
SELECT 'ALTER LOGIN ['+name+'] DISABLE;' 
FROM sys.syslogins where 
name not like '%##MS%' 
and name not like '%NT AUTHORITY%'
and name not like '%NT SERVICE%'
and name not in 
('SQLSHACK','SA')
 
</code></pre></li><li><p><strong>Check DB compatibility:</strong> If we migrated from old version to new version as Example 2016 we need to update the DB compatibility to be 140 </p> <p> <strong>检查数据库兼容性：</strong>如果像例2016那样从旧版本迁移到新版本，则需要将数据库兼容性更新为140 </p> <pre class="has"><code> 
select name,
' 
EXEC sp_resetstatus ''' + name + '''
GO	
ALTER DATABASE ' + name + ' SET SINGLE_USER WITH ROLLBACK IMMEDIATE
go 
USE [master]
GO
ALTER DATABASE [' + name + '] SET COMPATIBILITY_LEVEL = 140
go
ALTER DATABASE ' + name + ' SET MULTI_USER WITH ROLLBACK IMMEDIATE
go
'
from sys.Databases where Database_Id &gt; 4 AND COMPATIBILITY_LEVEL &lt;&gt; 140 
 
</code></pre></li><li><p><strong>Check Failed login on both servers: </strong>failed logins on of the things that we should monitor to know if there is any application still connected to the old SQL Server. Here is the steps for creating Failed login audit in SQL Server</p> <p> <strong>选中两台服务器</strong>上的登录失败：我们应该监视以了解是否仍有任何应用程序仍连接到旧SQL Server的事物上的登录失败。 这是在SQL Server中创建失败的登录审核的步骤 </p> 
   <ul><li><p> Create folder on local SAN storage </p> <p> 在本地SAN存储上创建文件夹 </p> <pre class="has"><code> 
USE Master;
GO
SET NOCOUNT ON
-- 1 - Variable declaration)
DECLARE @LogPath nvarchar(500)
DECLARE @DirTree TABLE (subdirectory nvarchar(255), depth INT)
SET @LogPath = 'C:\ServerAuditing\' ---------------+ @DBName
-- 5 - Remove all records from @DirTree
DELETE FROM @DirTree
-- 6 - @LogPath values
INSERT INTO @DirTree(subdirectory, depth)
EXEC master.sys.xp_dirtree @LogPath
-- 7 - Create the @LogPath directory
IF NOT EXISTS (SELECT 1 FROM @DirTree )
----------WHERE subdirectory = @DBName)
EXEC master.dbo.xp_create_subdir @LogPath
SET NOCOUNT OFF
GO  
 
</code></pre></li><li><p> Create server audit specifications </p> <p> 创建服务器审核规范 </p> <pre class="has"><code> 
USE [master]
GO
IF  EXISTS (SELECT * FROM sys.server_audits WHERE name = N'FAILED_LOGIN_GROUP')
ALTER SERVER AUDIT [FAILED_LOGIN_GROUP]
WITH (STATE = OFF);
GO
IF  EXISTS (SELECT * FROM sys.server_audits WHERE name = N'FAILED_LOGIN_GROUP')
DROP SERVER AUDIT [FAILED_LOGIN_GROUP]
GO
USE [master]
GO
/****** Object:  Audit [FAILED_LOGIN_GROUP]    Script Date: 10/25/2010 13:21:58 ******/
CREATE SERVER AUDIT [FAILED_LOGIN_GROUP]
TO FILE 
(	FILEPATH = N'C:\Server Auditing'
	,MAXSIZE = 100 MB
	,MAX_ROLLOVER_FILES = 2
	,RESERVE_DISK_SPACE = OFF
)
WITH
(	QUEUE_DELAY = 1000
	,ON_FAILURE = CONTINUE
	,AUDIT_GUID = '8f5c8e0b-6ba3-4964-8da5-d7184220f9ca'
)
GO
ALTER SERVER AUDIT [FAILED_LOGIN_GROUP]
WITH (STATE = ON);
GO
IF  EXISTS (SELECT * FROM sys.server_audit_specifications WHERE name = N'FAILED_LOGIN_GROUP')
ALTER SERVER AUDIT SPECIFICATION [FAILED_LOGIN_GROUP]
WITH (STATE = OFF)
GO
IF  EXISTS (SELECT * FROM sys.server_audit_specifications WHERE name = N'FAILED_LOGIN_GROUP')
DROP SERVER AUDIT SPECIFICATION [FAILED_LOGIN_GROUP]
GO
GO
CREATE SERVER AUDIT SPECIFICATION [FAILED_LOGIN_GROUP]
FOR SERVER AUDIT [FAILED_LOGIN_GROUP]
ADD (FAILED_LOGIN_GROUP)
WITH (STATE = ON)
GO 
 
</code></pre></li></ul></li></ul> 
 <h3> 迁移建议 <span style="font-weight: bold;">(</span>Migration recommendation<span style="font-weight: bold;">)</span></h3> 
 <p> In this juncture, there are some recommended points we should consider; they are the key elements any successful migration project: </p> 
 <p> 目前，我们应该考虑一些建议的要点； 它们是任何成功的迁移项目的关键要素： </p> 
 <ul><li><p> The master database should be hosted on a separate disk (200 GB, SAS, RAID 5) </p><p> 主数据库应托管在单独的磁盘（200 GB，SAS，RAID 5）上 </p></li><li><p> TempDB databases should be hosted on a separate disk (150 GB, SSD-, RAID 1/0) </p><p> TempDB数据库应托管在单独的磁盘上（150 GB，SSD-，RAID 1/0） </p></li><li><p> MDF files for the user’s databases should be hosted on a separate disk (SAS, RAID 5) </p> <p> 用户数据库的MDF文件应托管在单独的磁盘（SAS，RAID 5）上 </p></li><li><p> Transaction log (LDF) should host in separate disk (150 GB, SAS, RAID 5) </p><p> 事务日志（LDF）应该位于单独的磁盘（150 GB，SAS，RAID 5）中 </p></li><li><p> TempDB databases files should be configured based on the logical processors count if the logical processors less than or equal to 8 configure your tempdb with the count of the logcail processors, If it is more than 8 logical processors configure your tempdb on 8 files for more information check microsoft <a href="https://support.microsoft.com/en-us/kb/2154845" rel="nofollow noopener noreferrer" target="_blank">recommendation</a>. </p><p> 如果少于或等于8的逻辑处理器用logcail处理器的数量来配置您的tempdb，则应基于逻辑处理器的数量来配置TempDB数据库文件；如果多于8的逻辑处理器，请在8个文件上配置tempdb以获取更多信息。检查Microsoft的<a href="https://support.microsoft.com/en-us/kb/2154845" rel="nofollow noopener noreferrer" target="_blank">建议</a> 。 </p></li></ul> 
 <h3> 结论 <span style="font-weight: bold;">(</span>Conclusion <span style="font-weight: bold;">)</span></h3> 
 <p> A successful database migration is not mission impossible. But it is important to approach it systematically. One only needs an awareness of what to do and the requirement to successfully carry it out. And, as always, make sure every single step is documented. </p> 
 <p> 成功的数据库迁移并非并非不可能。 但是系统地处理它很重要。 一个人只需要知道做什么和成功实施的要求即可。 并且，一如既往，确保记录每个步骤。 </p> 
 <h3> 附录A – DMV_BackupAll存储过程 <span style="font-weight: bold;">(</span>Appendix A – DMV_BackupAll stored prodecure<span style="font-weight: bold;">)</span></h3> 
 <p>You can download this script <a href="https://www.sqlshack.com/wp-content/uploads/2016/12/DMV_BackupAll.zip" rel="nofollow"> here</a></p> 
 <p> 您可以<a href="https://www.sqlshack.com/wp-content/uploads/2016/12/DMV_BackupAll.zip" rel="nofollow">在此处</a>下载此脚本 </p> 
 <p><strong><a rel="nofollow" href="https://www.sqlshack.com/wp-content/uploads/2016/12/word-image-180.png"></a></strong></p> 
 <div style="text-align: center;"> 
  <strong><a rel="nofollow" href="https://www.sqlshack.com/wp-content/uploads/2016/12/word-image-180.png"><img src="https://images2.imgbox.com/35/d6/ZEueg10a_o.png" style="outline: none;"></a></strong> 
 </div> 
 <p></p> 
 <p> <strong><a rel="nofollow" href="https://www.sqlshack.com/wp-content/uploads/2016/12/word-image-180.png"></a></strong> </p> 
 <blockquote> 
  <p>翻译自: <a href="https://www.sqlshack.com/sql-server-database-migration-best-practices-low-risk-downtime/" rel="nofollow">https://www.sqlshack.com/sql-server-database-migration-best-practices-low-risk-downtime/</a></p> 
 </blockquote> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0fdbe34cdd5c64d339c258114ec21f53/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">树莓派官方系统安装配置与SSH远程访问</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d3423776e088210574b5daab717e8b30/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CMake和QMake</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>