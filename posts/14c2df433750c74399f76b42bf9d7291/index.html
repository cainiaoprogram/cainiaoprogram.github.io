<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>rocketmq详解(全) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="rocketmq详解(全)" />
<meta property="og:description" content="学前小故事
搭建环境
管理工具
rocketmq基础
rocketmq之Java Class
学前小故事
有一天，产品跑来说：“我们要做一个用户注册功能，需要在用户注册成功后给用户发一封成功邮件。”
小明（攻城狮）：“好，需求很明确了。” 不就提供一个注册接口，保存用户信息，同时发起邮件调用，待邮件发送成功后，返回用户操作成功。没一会功夫，代码就写完了。验证功能没问题后，就发布上线了。
线上正常运行了一段时间，产品匆匆地跑来说：“你做的功能不行啊，运营反馈注册操作响应太慢，已经有好多用户流失了。”
小明听得一身冷汗，赶紧回去改。他发现，原先的以单线程同步阻塞的方式进行邮件发送，确实存在问题。这次，他利用了 JAVA 多线程的特性，另起线程进行邮件发送，主线程直接返回保存结果。测试通过后，赶紧发布上线。小明心想，这下总没问题了吧。
没过多久，产品又跑来了，他说：“现在，注册操作响应是快多了。但是又有新的问题了，有用户反应，邮件收不到。能否在发送邮件时，保存一下发送的结果，对于发送失败的，进行补发。”
小明一听，哎，又得熬夜加班了。产品看他一脸苦逼的样子，忙说：“邮件服务这块，别的团队都已经做好了，你不用再自己搞了，直接用他们的服务。”
小明赶紧去和邮件团队沟通，谁知他们的服务根本就不对外开放。这下小明可开始犯愁了，明知道有这么一个服务，可是偏偏又调用不了。
邮件团队的人说，“看你愁的，我给你提供了一个类似邮局信箱的东西，你往这信箱里写上你要发送的消息，以及我们约定的地址。之后你就不用再操心了，我们自然能从约定的地址中取得消息，进行邮件的相应操作。”
后来，小明才知道，这就是外界广为流传的消息队列。你不用知道具体的服务在哪，如何调用。你要做的只是将该发送的消息，向你们约定好的地址进行发送，你的任务就完成了。对应的服务自然能监听到你发送的消息，进行后续的操作。这就是消息队列最大的特点，将同步操作转为异步处理，将多服务共同操作转为职责单一的单服务操作，做到了服务间的解耦。
哈哈，这下能高枕无忧了。太年轻，哪有万无一失的技术啊~
不久的一天，你会发现所有业务都替换了邮件发送的方式，统一使用了消息队列来进行发送。这下仅仅一个邮件服务模块，难以承受业务方源源不断的消息，大量的消息堆积在了队列中。这就需要更多的消费者（邮件服务）来共同处理队列中的消息，即所谓的分布式消息处理。
rocketmq入门
消息队列
含义 消息队列中间件是分布式系统中重要的组件，主要解决应用耦合，异步消息，流量削锋等问题。实现高性能， 高可用，可伸缩和最终一致性架构。是大型分布式系统不可缺少的中间件。 目前在生产环境，使用较多的消息队列有ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ等。 应用场景 (同下方rocketmq应用场景) 示例图 a. 电商系统 （1）应用将主干逻辑处理完成后，写入消息队列。消息发送是否成功可以开启消息的确认模式。（消息队列返回消息接收成功状态后，应用再返回，这样保障消息的完整性） （2）扩展流程（发短信，配送处理）订阅队列消息。采用推或拉的方式获取消息并处理。 （3）消息将应用解耦的同时，带来了数据一致性问题，可以采用最终一致性方式解决。比如主数据写入数据库，扩展应用根据消息队列，并结合数据库方式实现基于消息队列的后续处理。 b. 日志收集系统 (消息将应用解耦的同时，带来了数据一致性问题，可以采用最终一致性方式解决。比如主数据写入数据库，扩展应用根据消息队列，并结合数据库方式实现基于消息队列的后续处理。) 1.Zookeeper注册中心，提出负载均衡和地址查找服务； 2.日志收集客户端，用于采集应用系统的日志，并将数据推送到kafka队列； 3.Kafka集群：接收，路由，存储，转发等消息处理； rocketmq示例图
分析 a.消息队列是一种&#34;先进先出&#34;的数据结构 b.不使用队列的情况下,生产者与消费者之间是通过RPC交互的 rocketmq应用场景
应用解耦
问题描述 系统的耦合性越高，容错性就越低，以电商应用为例，用户创建订单后， 如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障 或者因为升级等原因暂时不可用，都会造成下单操作异常 解耦含义 使用消息队列解耦，系统的耦合性就会下降了，比如物流系统发生故障， 需要几分钟才能修复，在这段时间内，物流系统要处理的数据被缓存到消 息队列中，用户的下单操作正常完成。当物流系统恢复后，补充处理存在 消息队列中的订单消息即可，终端系统感知不到物流系统发生过几分钟故 障 场景 用户下单后，订单系统需要通知库存系统。传统的做法是，订单系统调用库存系统的接口 那么会存在以下缺点 1.假如库存系统无法访问，则订单减库存将失败，从而导致订单失败 2.订单系统与库存系统耦合 解决方案 订单系统：用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户下单成功 库存系统：订单下单的消息，采用拉/推的方式，获取下单信息，库存系统根据下单信息，进行 库存操作 假如：在下单时库存系统不能正常使用，也不影响正常下单，因为下单后，订单系统写入消息 队列就不再关心其他的后续操作了。实现了订单系统与库存系统的应用解耦 流量削峰" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/14c2df433750c74399f76b42bf9d7291/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-08T15:50:37+08:00" />
<meta property="article:modified_time" content="2020-05-08T15:50:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">rocketmq详解(全)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="#one" rel="nofollow"><font size="3" face="宋体" color="grey">学前小故事</font></a></p> 
<p><a href="#two" rel="nofollow"><font size="3" face="宋体" color="grey">搭建环境</font></a></p> 
<p><a href="#four" rel="nofollow"><font size="3" face="宋体" color="grey">管理工具</font></a></p> 
<p><a href="#three" rel="nofollow"><font size="3" face="宋体" color="grey">rocketmq基础</font></a></p> 
<p><a href="#five" rel="nofollow"><font size="3" face="宋体" color="grey">rocketmq之Java Class</font></a></p> 
<blockquote> 
 <p><font size="4" color="black"><span id="one">学前小故事</span></font></p> 
</blockquote> 
<p><font size="3" face="宋体">有一天，产品跑来说：“我们要做一个用户注册功能，需要在用户注册成功后给用户发一封成功邮件。”</font></p> 
<p><font size="3" face="宋体">小明（攻城狮）：“好，需求很明确了。” 不就提供一个注册接口，保存用户信息，同时发起邮件调用，待邮件发送成功后，返回用户操作成功。没一会功夫，代码就写完了。验证功能没问题后，就发布上线了。</font></p> 
<p><font size="3" face="宋体">线上正常运行了一段时间，产品匆匆地跑来说：“你做的功能不行啊，运营反馈注册操作响应太慢，已经有好多用户流失了。”</font></p> 
<p><font size="3" face="宋体">小明听得一身冷汗，赶紧回去改。他发现，原先的以单线程同步阻塞的方式进行邮件发送，确实存在问题。这次，他利用了 JAVA 多线程的特性，另起线程进行邮件发送，主线程直接返回保存结果。测试通过后，赶紧发布上线。小明心想，这下总没问题了吧。</font></p> 
<p><font size="3" face="宋体">没过多久，产品又跑来了，他说：“现在，注册操作响应是快多了。但是又有新的问题了，有用户反应，邮件收不到。能否在发送邮件时，保存一下发送的结果，对于发送失败的，进行补发。”</font></p> 
<p><font size="3" face="宋体">小明一听，哎，又得熬夜加班了。产品看他一脸苦逼的样子，忙说：“邮件服务这块，别的团队都已经做好了，你不用再自己搞了，直接用他们的服务。”</font></p> 
<p><font size="3" face="宋体">小明赶紧去和邮件团队沟通，谁知他们的服务根本就不对外开放。这下小明可开始犯愁了，明知道有这么一个服务，可是偏偏又调用不了。</font></p> 
<p><font size="3" face="宋体">邮件团队的人说，“看你愁的，我给你提供了一个类似邮局信箱的东西，你往这信箱里写上你要发送的消息，以及我们约定的地址。之后你就不用再操心了，我们自然能从约定的地址中取得消息，进行邮件的相应操作。”</font></p> 
<p><font size="3" face="宋体">后来，小明才知道，这就是外界广为流传的消息队列。你不用知道具体的服务在哪，如何调用。你要做的只是将该发送的消息，向你们约定好的地址进行发送，你的任务就完成了。对应的服务自然能监听到你发送的消息，进行后续的操作。这就是消息队列最大的特点，将同步操作转为异步处理，将多服务共同操作转为职责单一的单服务操作，做到了服务间的解耦。</font></p> 
<p><font size="3" face="宋体">哈哈，这下能高枕无忧了。太年轻，哪有万无一失的技术啊~</font></p> 
<p><font size="3" face="宋体">不久的一天，你会发现所有业务都替换了邮件发送的方式，统一使用了消息队列来进行发送。这下仅仅一个邮件服务模块，难以承受业务方源源不断的消息，大量的消息堆积在了队列中。这就需要更多的消费者（邮件服务）来共同处理队列中的消息，即所谓的分布式消息处理。</font></p> 
<blockquote> 
 <p><font size="4" color="black">rocketmq入门</font></p> 
</blockquote> 
<ol><li> <p><font size="3" color="blue">消息队列</font></p> <pre><code class="prism language-java">含义

	消息队列中间件是分布式系统中重要的组件，主要解决应用耦合，异步消息，流量削锋等问题。实现高性能，

	高可用，可伸缩和最终一致性架构。是大型分布式系统不可缺少的中间件。

	目前在生产环境，使用较多的消息队列有<span class="token class-name">ActiveMQ</span>，<span class="token class-name">RabbitMQ</span>，<span class="token class-name">ZeroMQ</span>，<span class="token class-name">Kafka</span>，<span class="token class-name">MetaMQ</span>，<span class="token class-name">RocketMQ</span>等。

应用场景

	<span class="token punctuation">(</span>同下方rocketmq应用场景<span class="token punctuation">)</span>
</code></pre> <pre><code class="prism language-java">示例图

	a<span class="token punctuation">.</span> 电商系统

		（<span class="token number">1</span>）应用将主干逻辑处理完成后，写入消息队列。消息发送是否成功可以开启消息的确认模式。（消息队列返回消息接收成功状态后，应用再返回，这样保障消息的完整性）

		（<span class="token number">2</span>）扩展流程（发短信，配送处理）订阅队列消息。采用推或拉的方式获取消息并处理。

		（<span class="token number">3</span>）消息将应用解耦的同时，带来了数据一致性问题，可以采用最终一致性方式解决。比如主数据写入数据库，扩展应用根据消息队列，并结合数据库方式实现基于消息队列的后续处理。
	
	b<span class="token punctuation">.</span> 日志收集系统

		<span class="token punctuation">(</span>消息将应用解耦的同时，带来了数据一致性问题，可以采用最终一致性方式解决。比如主数据写入数据库，扩展应用根据消息队列，并结合数据库方式实现基于消息队列的后续处理。<span class="token punctuation">)</span>

		<span class="token number">1.</span>Zookeeper注册中心，提出负载均衡和地址查找服务；

		<span class="token number">2.</span>日志收集客户端，用于采集应用系统的日志，并将数据推送到kafka队列；

		<span class="token number">3.</span>Kafka集群：接收，路由，存储，转发等消息处理；
</code></pre> <p><img src="https://images2.imgbox.com/11/55/cryU9ozY_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/64/70/faiv5sIm_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="blue">rocketmq示例图</font></p> <p><img src="https://images2.imgbox.com/df/48/3cXyq9B1_o.png" alt="在这里插入图片描述"></p> <pre><code class="prism language-java">分析

	a<span class="token punctuation">.</span>消息队列是一种<span class="token string">"先进先出"</span>的数据结构

	b<span class="token punctuation">.</span>不使用队列的情况下<span class="token punctuation">,</span>生产者与消费者之间是通过RPC交互的
</code></pre> </li><li> <p><font size="3" color="blue">rocketmq应用场景</font></p> 
  <ol><li> <p><font size="3" color="green">应用解耦</font></p> <pre><code class="prism language-java">问题描述

	系统的耦合性越高，容错性就越低，以电商应用为例，用户创建订单后，
	如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障
	或者因为升级等原因暂时不可用，都会造成下单操作异常

解耦含义

	使用消息队列解耦，系统的耦合性就会下降了，比如物流系统发生故障，
	需要几分钟才能修复，在这段时间内，物流系统要处理的数据被缓存到消
	息队列中，用户的下单操作正常完成。当物流系统恢复后，补充处理存在
	消息队列中的订单消息即可，终端系统感知不到物流系统发生过几分钟故
	障

场景

	用户下单后，订单系统需要通知库存系统。传统的做法是，订单系统调用库存系统的接口

	那么会存在以下缺点

	<span class="token number">1.</span>假如库存系统无法访问，则订单减库存将失败，从而导致订单失败
	<span class="token number">2.</span>订单系统与库存系统耦合

解决方案

	订单系统：用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户下单成功

	库存系统：订单下单的消息，采用拉<span class="token operator">/</span>推的方式，获取下单信息，库存系统根据下单信息，进行
						库存操作

	假如：在下单时库存系统不能正常使用，也不影响正常下单，因为下单后，订单系统写入消息

	队列就不再关心其他的后续操作了。实现了订单系统与库存系统的应用解耦
</code></pre> <p><img src="https://images2.imgbox.com/a5/37/u8MshH1T_o.png" alt="在这里插入图片描述"></p> <p><img src="https://images2.imgbox.com/4a/33/X0dEs6XG_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="green">流量削峰</font></p> <pre><code class="prism language-java">问题描述

	应用系统如果遇到系统请求流量的瞬间猛增，有可能将系统压垮，有了消
	息队列可以将大量请求缓存起来，分散到很长一段时间处理，这样可以大
	大提高系统的稳定性

削峰含义

	一般情况，为了保证系统的稳定性，如果系统负载超过阈值，就会阻止用
	户请求，而如果使用消息队列将请求缓存起来，等待系统处理完毕后通知
	用户下单完毕，这方法虽然会耗时，但出现系统不能下单的情况

场景描述

	秒杀活动，一般会因为流量过大，导致流量暴增，应用挂掉。为了解决这个问题，一般需要

	在应用前端加入消息队列。这样做的好处有

	<span class="token number">1.</span>可以控制活动的人数

	<span class="token number">2.</span>可以缓解短时间内高流量压垮应用

	<span class="token number">3.</span>用户请求，服务器接收后，首先写入消息队列，假如消息队列长度超过最大数量，则直接

	抛弃用户请求或跳转到错误页面

	<span class="token number">4.</span>秒杀业务根据消息队列中的请求信息，再做后续处理
</code></pre> <p><img src="https://images2.imgbox.com/e1/49/reTkNpYr_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="green">数据分发</font></p> <pre><code class="prism language-java">数据分发含义

	通过消息队列可以让数据在多个系统之间更加方便流通。只需要将数据发
	送到消息队列，数据使用方直接在消息队列中获取数据即可

图解

	<span class="token class-name">A</span>系统产生数据，发送到MQ
	BCD哪个系统需要，自己去MQ消费即可
	如果某个系统不需要数据，取消对MQ消息的消费即可
	新系统要数据，直接从MQ消费即可
</code></pre> <p><img src="https://images2.imgbox.com/c9/93/0Z73uym4_o.png" alt="在这里插入图片描述"> <img src="https://images2.imgbox.com/b5/5f/GQCtJvV7_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="green">异步处理</font></p> <pre><code class="prism language-java">场景描述

	用户注册后，需要发注册邮件和注册短信。传统的做法有两种
	
	<span class="token number">1.</span>串行方式   <span class="token number">2.</span> 并行方式
	
	串行方式：将注册信息写入数据库成功后，发送注册邮件，再发送注册短信，以上三个任务

	完成后，返回给客户端

	并行方式：将注册信息写入数据库成功后，发送注册邮件的同时，发送注册短信。以上三个

	任务完成后，返回给客户端。与串行的差别是，并行的方式可以提高处理的时间

探究

	假设三个业务节点每个使用<span class="token number">50</span>毫秒，不考虑网络等其他开销，则串行方式的时间是<span class="token number">150</span>毫秒

	，并行的时间可能是<span class="token number">100</span>毫秒

	因为cpu在单位时间内处理的请求数是一定的，假设cpu1秒吞吐量是<span class="token number">100</span>次，则串行方式<span class="token number">1</span>

	秒内cpu可处理的请求量是<span class="token number">7</span>次<span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">/</span><span class="token number">150</span><span class="token punctuation">)</span>，并行方式处理的请求量是<span class="token number">10</span>次<span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span>。

小结

	根据如上案例，传统的方式系统的性能，如并发量、吞吐量、响应量等会有瓶颈

解决<span class="token punctuation">(</span>使用消息队列<span class="token punctuation">)</span>

	按照以上约定，用户的响应时间相当于是注册消息写入数据库时间，也就是<span class="token number">50</span>毫秒。

	注册邮件，发送短信写入消息队列后，直接返回，因为写入消息队列的速度很快

	基本可以忽略，因此用户响应时间可能是<span class="token number">50</span>毫秒。因此架构改变后，系统的吞吐量

	提高到每秒<span class="token number">20</span> QPS，比串行提高了<span class="token number">3</span>倍，比并行提高了<span class="token number">2</span>倍
</code></pre> <p><img src="https://images2.imgbox.com/08/e6/uvS7h5JG_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ef/12/2PC808hr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/55/53/PdLWqv8P_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="green">日志处理</font></p> <pre><code class="prism language-java">含义

	日志处理是指将消息队列用在日志处理中，比如kafka的应用<span class="token punctuation">,</span>解决大量日志传输的问题，

	架构简化如下

	日志采集客户端，负责日志数据采集，定时写入kafka队列

	kafka消息队列，负责日志数据的接收，存储和转发

	日志处理，订阅并消费kafka队列中的日志数据
</code></pre> <p><img src="https://images2.imgbox.com/0e/a7/e0MJYoWQ_o.png" alt="在这里插入图片描述"></p> </li></ol> </li></ol> 
<blockquote> 
 <p><font size="4" color="black"><span id="two">搭建环境</span></font></p> 
</blockquote> 
<p><font size="3" face="黑体" color="red"><span id="twofour">环境安装——Linux</span></font></p> 
<p><font size="3" face="楷体" color="orange">rocketmq安装</font></p> 
<font size="3" face="宋体"> </font> 
<p><font size="3" face="黑体">下载地址：<font size="3" face="宋体"><a href="http://rocketmq.apache.org/" rel="nofollow">http://rocketmq.apache.org/</a></font></font></p> 
<p><font size="3" face="黑体">安装选择：<font size="3" face="宋体">二进制包安装方式(含有bin的安装包)</font></font></p> 
<p><font size="3" face="黑体">安装环境：unzip 安装包名</font></p> 
<p><font size="3" face="黑体">安装环境：<font size="3" face="宋体">linux64位系统、JDK1.8(64位)、源码安装需要安装maven3.2x</font></font></p> 
<ol start="2"><li> <p><font size="3" color="blue">RocketMQ下载及安装</font></p> <p><img src="https://images2.imgbox.com/33/31/0JLXrnAP_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="blue">RocketMQ目录结构</font></p> <pre><code class="prism language-java">bin					启动脚本，包括shell脚本和cmd脚本

conf				实例配置文件，包括broker配置文件、logback配置文件等
					
lib					依赖jar包，包括netty、commons<span class="token operator">-</span>lang、<span class="token class-name">FastJSON</span>等
</code></pre> <p><img src="https://images2.imgbox.com/58/ce/f18DWak4_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="blue">RocketMQ启动及测试</font></p> 
  <ol><li> <p><font size="3" color="green">前提条件</font></p> <pre><code class="prism language-java">内存修改

	<span class="token class-name">Rocketmq</span>默认的虚拟机内存较大，启动broker如果因为内存不足失败，需要编辑如下两个配置文件，去修改JVM内存大小
	
	vi runbroker<span class="token punctuation">.</span>sh
	vi runserver<span class="token punctuation">.</span>sh

	#编辑runbroker<span class="token punctuation">.</span>sh和runserver<span class="token punctuation">.</span>sh修改默认JVM大小
	#参考设置
	JAVA_OPT<span class="token operator">=</span><span class="token string">"${JAVA_OPT} -server -Xms256m -Xmx256m -Xmn128m -xx:MetaspaceSize=128m xx:MaxMetaspaceSize=320m"</span>

端口

	开启端口<span class="token operator">:</span><span class="token number">10911</span> <span class="token number">10912</span> <span class="token number">10909</span> <span class="token number">9876</span>

启动位置

	bin目录
</code></pre> <p><img src="https://images2.imgbox.com/b9/c1/OnCey5jk_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/e4/d9/RwQNRPJb_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="green">NameServer启动</font></p> <pre><code class="prism language-java">位置

	<span class="token class-name">RocketMQ</span>目录下的bin目录

本地部署<span class="token punctuation">(</span>linux<span class="token punctuation">)</span>

	nohup sh mqnamesrv <span class="token operator">&amp;</span>								启动<span class="token class-name">NameServer</span>
	tail <span class="token operator">-</span>f <span class="token operator">~</span><span class="token operator">/</span>logs<span class="token operator">/</span>rocketmqlogs<span class="token operator">/</span>namesrv<span class="token punctuation">.</span>log				查看日志

外网部署

	nohup sh mqnamesrv  <span class="token operator">-</span>n <span class="token string">"192.168.33.100:9876"</span> <span class="token operator">&amp;</span>		启动<span class="token class-name">NameServer</span>
	tail <span class="token operator">-</span>f <span class="token operator">~</span><span class="token operator">/</span>logs<span class="token operator">/</span>rocketmqlogs<span class="token operator">/</span>namesrv<span class="token punctuation">.</span>log				查看日志
</code></pre> <p><img src="https://images2.imgbox.com/99/57/N3FHHxHm_o.png" alt="在这里插入图片描述"><br> <font size="2" color="grey">[注]此时NameServer启动成功</font></p> </li><li> <p><font size="3" color="green">Broker启动</font></p> <pre><code class="prism language-java">位置

	<span class="token class-name">RocketMQ</span>目录下的bin目录

本地部署<span class="token punctuation">(</span>linux<span class="token punctuation">)</span>

	nohup sh mqbroker <span class="token operator">-</span>n localhost<span class="token operator">:</span><span class="token number">9876</span> <span class="token operator">&amp;</span>		启动<span class="token class-name">Broker</span>
	tail <span class="token operator">-</span>f <span class="token operator">~</span><span class="token operator">/</span>logs<span class="token operator">/</span>rocketmqlogs<span class="token operator">/</span>broker<span class="token punctuation">.</span>log		查看启动日志

外网部署

	echo <span class="token string">'brokerIP1=192.168.33.100'</span> <span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>/conf<span class="token operator">/</span>broker<span class="token punctuation">.</span>properties
	nohup sh mqbroker <span class="token operator">-</span>n localhost<span class="token operator">:</span><span class="token number">9876</span> <span class="token operator">-</span>c <span class="token punctuation">.</span><span class="token punctuation">.</span>/conf<span class="token operator">/</span>broker<span class="token punctuation">.</span>properties autoCreateTopicEnable<span class="token operator">=</span><span class="token boolean">true</span> <span class="token operator">&amp;</span>
	tail <span class="token operator">-</span>f <span class="token operator">~</span><span class="token operator">/</span>logs<span class="token operator">/</span>rocketmqlogs<span class="token operator">/</span>broker<span class="token punctuation">.</span>log		查看启动日志
</code></pre> </li><li> <p><font size="3" color="green">发送与接受消息测试(linux端)</font></p> <pre><code class="prism language-java">含义

	在发送或接收消息之前，开发者需要通知客户端name servers 的位置。<span class="token class-name">RocketMQ</span>提供多种

	实现方式。为了简单起见，下方展示环境变量NAMESRV_ADDR的用法

发送消息（bin目录下）

	设置环境变量：export NAMESRV_ADDR<span class="token operator">=</span>localhost<span class="token operator">:</span><span class="token number">9876</span>
	使用安装包的<span class="token class-name">Demo</span>发送消息<span class="token operator">:</span> sh tools<span class="token punctuation">.</span>sh <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>example<span class="token punctuation">.</span>quickstart<span class="token punctuation">.</span></span>Producer</span>

接受消息 <span class="token punctuation">(</span>bin目录下<span class="token punctuation">)</span>

	设置环境变量：export NAMESRV_ADDR<span class="token operator">=</span>localhost<span class="token operator">:</span><span class="token number">9876</span>
	接受消息：sh tools<span class="token punctuation">.</span>sh <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>example<span class="token punctuation">.</span>quickstart<span class="token punctuation">.</span></span>Consumer</span>

	jps查看进程号
</code></pre> <p><font size="2" color="red">RocketMQ由如下几部分构成 <br> Name Server<br> Broker<br> Producer<br> Consumer</font></p> </li><li> <p><font size="3" color="green">RocketMQ关闭(linux端)</font></p> <pre><code class="prism language-java">位置

	<span class="token class-name">RocketMQ</span>的bin目录

命令

	sh mqshutdown namesrv			关闭<span class="token class-name">NameServer</span>
	sh mqshutdown broker     		关闭<span class="token class-name">Broker</span>
</code></pre> </li><li> <p><font size="3" color="green">日志查看问题(windows端)</font></p> <pre><code class="prism language-java"><span class="token number">1.</span>使用<span class="token class-name">NotePad</span><span class="token operator">++</span>工具

<span class="token number">2.</span>下载NPPTTP插件

<span class="token number">3.</span>使用插件远程连接<span class="token class-name">Linux</span>
</code></pre> <p><img src="https://images2.imgbox.com/05/6d/mztQqe4i_o.png" alt="在这里插入图片描述"><br> <font size="2" color="red">nohup的作用<br> nohup命令：如果你正在运行一个进程，而且你觉得在退出帐户时或者关闭客户端该进程还不会结束，那么可以使用nohup命令。该命令可以在你退出帐户/关闭终端之后继续运行相应的进程。在缺省情况下该作业的所有输出都被重定向到一个名为nohup.out的文件中。<br> 简单理解:<br> nohup运行命令可以使命令永久的执行下去，和用户终端没有关系，例如我们断开SSH连接都不会影响他的运行，注意了nohup没有后台运行的意思；<br> &amp;的作用<br> &amp;是指在后台运行，但当用户退出(挂起)的时候，命令自动也跟着退出<br> 注意<br> nohup COMMAND &amp; 这样就能使命令永久的在后台执行<br> nohup可以使用Ctrl+C结束掉，而&amp;使用Ctrl+C则结束不掉，nohup不受终端关闭，用户退出影响，而&amp;则受终端关闭，用户退出影响</font></p> </li></ol> </li></ol> 
<blockquote> 
 <p><font size="4" color="black"><span id="four">管理工具</span></font></p> 
</blockquote> 
<ol><li> <p><font size="3" color="blue">mqadmin管理工具</font></p> <pre><code class="prism language-java">使用方式

	进入<span class="token class-name">RocketMQ</span>安装位置<span class="token punctuation">,</span>在bin目录下执行<span class="token punctuation">.</span>/mqadmin <span class="token punctuation">{<!-- --></span>admin<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>args<span class="token punctuation">}</span>

命令介绍

	updateTopic<span class="token punctuation">[</span>创建<span class="token class-name">Topic</span><span class="token punctuation">]</span>

	类路径<span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>command<span class="token punctuation">.</span>topic<span class="token punctuation">.</span></span>UpdateTopicSubCommand</span><span class="token punctuation">]</span> 
	
	参数			是否必填				说明

	<span class="token operator">-</span>b			如果<span class="token operator">-</span>c为空，则必填		broker 地址，表示topic 建在该broker

	<span class="token operator">-</span>c			如果<span class="token operator">-</span>b为空，则必填		cluster 名称，表示topic 建在该集群（集群可通过clusterList 查询）

	<span class="token operator">-</span>h			否					打印帮助

	<span class="token operator">-</span>n			是					nameserve 服务地址列表，格式ip<span class="token operator">:</span>port<span class="token punctuation">;</span>ip<span class="token operator">:</span>port<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token operator">-</span>r 			否					可读队列数（默认为<span class="token number">8</span>）

	<span class="token operator">-</span>w			否					可写队列数（默认为<span class="token number">8</span>）

注意事项

	几乎所有命令都需要配置<span class="token operator">-</span>n 表示<span class="token class-name">NameServer</span>地址，格式为ip<span class="token operator">:</span>port<span class="token punctuation">;</span>

	几乎所有命令都可以通过<span class="token operator">-</span>h获取帮助<span class="token punctuation">;</span>

	如果既有<span class="token class-name">Broker</span>地址<span class="token punctuation">(</span><span class="token operator">-</span>b<span class="token punctuation">)</span>配置项又有<span class="token function">clusterName</span><span class="token punctuation">(</span><span class="token operator">-</span>c<span class="token punctuation">)</span>配置项，则优先以<span class="token class-name">Broker</span>地址执行

	命令<span class="token punctuation">;</span>如果不配置<span class="token class-name">Broker</span>地址，则对集群中所有主机执行命令

</code></pre> </li><li> <p><font size="3" color="blue">集群监控平台搭建</font></p> <pre><code class="prism language-java">含义

	<span class="token class-name">RocketMQ</span>有一个对其扩展的开源项目，incubator<span class="token operator">-</span>rocketmq<span class="token operator">-</span>externals，

	这个项目中有一个子模块叫rocketmq<span class="token operator">-</span>console。这个便是管理控制台项目。

	步骤是先将incubator<span class="token operator">-</span>rocketmq<span class="token operator">-</span>externals从git拉到本地，然后对rocketmq<span class="token operator">-</span>console

	进行操作<span class="token punctuation">(</span>编译打包运行<span class="token punctuation">)</span>

git地址

	https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token class-name">SummerUnfair</span><span class="token operator">/</span>rocketmq<span class="token operator">-</span>externals<span class="token punctuation">.</span>git

使用步骤

	<span class="token number">1.</span> 在rocketmq<span class="token operator">-</span>console中配置namesrc集群地址

		rocketmq<span class="token punctuation">.</span>config<span class="token punctuation">.</span>namesrvAddr<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token operator">:</span><span class="token number">9876</span>

	<span class="token number">2.</span> 执行打包命令

		clean <span class="token keyword">package</span> <span class="token operator">-</span><span class="token class-name">Dmaven</span><span class="token punctuation">.</span>test<span class="token punctuation">.</span>skip<span class="token operator">=</span><span class="token boolean">true</span>

	<span class="token number">3.</span>启动rokcetmq<span class="token operator">-</span>console

		java <span class="token operator">-</span>jar rocketmq<span class="token operator">-</span>console<span class="token operator">-</span>ng<span class="token operator">-</span><span class="token number">1.0</span><span class="token number">.0</span><span class="token punctuation">.</span>jar
</code></pre> <p><img src="https://images2.imgbox.com/49/60/LyNUb87W_o.png" alt="在这里插入图片描述"></p> <p><img src="https://images2.imgbox.com/3f/15/idgbZbcC_o.png" alt="在这里插入图片描述"> <img src="https://images2.imgbox.com/9b/1a/B25HIbNN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f1/5d/9En0yKvQ_o.png" alt="在这里插入图片描述"></p> <p><img src="https://images2.imgbox.com/3b/d6/AkX5S0TU_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="blue">使用集群监控平台</font></p> <pre><code class="prism language-java">rocketmq控制台<span class="token punctuation">(</span>驾驶舱<span class="token punctuation">)</span>

	下图首页即为<span class="token string">"驾驶舱"</span>标签下的图标

	<span class="token operator">-</span><span class="token class-name">Broker</span> TOP <span class="token number">10</span> ：是指前<span class="token number">10</span>个<span class="token class-name">Brokder</span>处理消息的数量。
					比如从下图可以看出来，我只有一个<span class="token class-name">Brokder</span>，并且此<span class="token class-name">Brokder</span>处理了<span class="token number">100</span>条消息<span class="token punctuation">.</span>
	
	<span class="token operator">-</span><span class="token class-name">Broker</span> <span class="token number">5</span>min trend<span class="token operator">:</span> 此图标可以筛选出某个<span class="token class-name">Topic</span>下<span class="token number">5</span>分钟的消息数量，可以切换时间，
						所以就相当于可以查看某个<span class="token class-name">Topic</span>下的消息数量趋势。

切换<span class="token function">namesrvAdd</span><span class="token punctuation">(</span>如图<span class="token punctuation">)</span>

集群<span class="token punctuation">(</span>如图<span class="token punctuation">)</span>

 主题<span class="token punctuation">(</span>如图<span class="token punctuation">)</span>

	<span class="token operator">-</span>状态<span class="token punctuation">,</span><span class="token class-name">TopicTest</span>是rocketmq系统自带的<span class="token class-name">Topic</span>，默认配置有<span class="token number">4</span>个队列

	<span class="token operator">-</span>发送消息，设定<span class="token operator">:</span>主体、tag、消息体后，即可在控制台发送消息
	
消息<span class="token punctuation">(</span>如图<span class="token punctuation">)</span>
</code></pre> <p><img src="https://images2.imgbox.com/c6/1d/vLU8szPJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/20/9b/knUmXApt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f0/44/E2rtf19r_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/26/51/sD8dRrTp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/57/29/VnjGXTB8_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/70/94/NSRcKz3D_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/59/e7/DjinTkQH_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<blockquote> 
 <p><font size="4" color="black"><span id="three">rocketmq基础</span></font></p> 
</blockquote> 
<p><a href="#threeone" rel="nofollow"><font size="3" face="宋体" color="grey">1.RocketMQ架构设计图及说明</font></a></p> 
<p><a href="#threetree" rel="nofollow"><font size="3" face="宋体" color="grey">2.RocketMQ优缺点</font></a></p> 
<p><a href="#threetwo" rel="nofollow"><font size="3" face="宋体" color="grey">3.常见的MQ产品宏观对比</font></a></p> 
<p><font size="3" face="宋体" color="blke"><span id="threeone">RocketMQ架构设计图及说明</span></font></p> 
<p><img src="https://images2.imgbox.com/2d/a0/IbQYu5m3_o.png" alt="在这里插入图片描述"></p> 
<p><font size="3" face="黑体">说明</font></p> 
<p><font size="3" face="宋体">RocketMQ 整体架构设计主要分为四大部分，分别是：Producer、Consumer、Broker、NameServer。</font></p> 
<p><font size="3" face="宋体">为了更贴合实际，图画的都是集群部署，像 Broker 还画了主从。</font></p> 
<p><font size="3" face="宋体">■ Producer：就是消息生产者，可以集群部署。它会先和 NameServer 集群中的随机一台建立长连接，得知当前要发送的 Topic 存在哪台 Broker Master上，然后再与其建立长连接，支持多种负载平衡模式发送消息。</font></p> 
<p><font size="3" face="宋体">■ Consumer：消息消费者，也可以集群部署。它也会先和 NameServer 集群中的随机一台建立长连接，得知当前要消息的 Topic 存在哪台 Broker Master、Slave上，然后它们建立长连接，支持集群消费和广播消费消息。</font></p> 
<p><font size="3" face="宋体">■ Broker：主要负责消息的存储、查询消费，支持主从部署，一个 Master 可以对应多个 Slave，Master 支持读写，Slave 只支持读。Broker 会向集群中的每一台 NameServer 注册自己的路由信息。</font></p> 
<p><font size="3" face="宋体">■ NameServer：是一个很简单的 Topic 路由注册中心，支持 Broker 的动态注册和发现，保存 Topic 和 Borker 之间的关系。通常也是集群部署，但是各 NameServer 之间不会互相通信， 各 NameServer 都有完整的路由信息，即无状态。</font></p> 
<p><font size="3" face="楷体">再用一段话来概括它们之间的交互</font></p> 
<p><font size="3" face="宋体">先启动 NameServer 集群，各 NameServer 之间无任何数据交互，Broker 启动之后会向所有 NameServer 定期（每 30s）发送心跳包，包括：IP、Port、TopicInfo，NameServer 会定期扫描 Broker 存活列表，如果超过 120s 没有心跳则移除此 Broker 相关信息，代表下线。</font></p> 
<p><font size="3" face="宋体">这样每个 NameServer 就知道集群所有 Broker 的相关信息，此时 Producer 上线从 NameServer 就可以得知它要发送的某 Topic 消息在哪个 Broker 上，和对应的 Broker （Master 角色的）建立长连接，发送消息。</font></p> 
<p><font size="3" face="宋体">Consumer 上线也可以从 NameServer 得知它所要接收的 Topic 是哪个 Broker ，和对应的 Master、Slave 建立连接，接收消息。</font></p> 
<p><font size="3" face="楷体">简单的工作流程如上所述，相信大家对整体数据流转已经有点印象了，我们再来看看每个部分的详细情况。</font></p> 
<p><font size="3" face="宋体" color="blke"><span id="threetree">RocketMQ优缺点</span></font></p> 
<p><font size="3" face="宋体">RocketMQ起到解耦、削峰、数据分发的作用，同时也存在着系统可用性降低、系统复杂度提高、一致性问题 这三个方面缺点。</font></p> 
<p><font size="3" face="黑体">系统可用性降低 : </font><font size="3" face="宋体">系统引入的外部依赖越多，系统稳定性越差。一旦MQ宕机，就会对业务造成影响.</font></p> 
<p><font size="3" face="黑体">系统复杂度提高 : </font><font size="3" face="宋体">MQ的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过MQ进行异步调用。如何保证</font></p> 
<p><font size="3" face="宋体">消息没有被重复消费、怎么处理消息丢失情况、如何保证消息传递的顺序性。</font></p> 
<p><font size="3" face="黑体">一致性问题 : </font><font size="3" face="宋体">A系统处理完业务，通过MQ给B、C、D三个系统发消息数据，如果B系统、C系统处理完成、D处理失败、如何保证消</font></p> 
<p><font size="3" face="宋体">息数据处理的一致性。</font></p> 
<p><font size="3" face="宋体" color="blke"><span id="threetwo">常见的MQ产品宏观对比</span></font></p> 
<table><thead><tr><th>产品</th><th>开发语言</th><th>单机吞吐量</th><th>时效性</th><th>可用性</th><th>特性</th></tr></thead><tbody><tr><td>ActiveMQ</td><td>java</td><td>万级</td><td>ms级</td><td>高(主从架构)</td><td>ActiveMQ 成熟的产品，在很多公司得到应用;有较多的文档;各种协议支持较好</td></tr><tr><td>RabbitMQ</td><td>erlang</td><td>万级</td><td>us级</td><td>高(主从架构)</td><td>RabbitMQ 基于erlang开发，所以并发能力强，性能极其好，延时很低，管理界面较丰富</td></tr><tr><td>RocketMQ</td><td>java</td><td>10万级</td><td>ms级</td><td>非常高(分布式架构)</td><td>RocketMQ MQ功能比较完备，扩展性佳</td></tr><tr><td>Kafka</td><td>scala</td><td>10万级</td><td>ms级以内</td><td>非常高(分布式架构)</td><td>Kafka 只支持主要的MQ功能，像一些消息查询，消息回溯等功能没有提供，毕竟是为大数据准备的，在大数据领域应用广</td></tr></tbody></table> 
<blockquote> 
 <p><font size="4" color="red">rocketmq消息管理</font></p> 
</blockquote> 
<ol><li> <p><font size="3" color="blue">环境搭建</font></p> 
  <ol><li> <p><font size="3" color="green">maven依赖</font></p> <pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
	<span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
	<span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>rocketmq<span class="token operator">-</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
	<span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">4.3</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> </li><li> <p><font size="3" color="green">consume messages(消费者)</font></p> <pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{<!-- --></span>
	
	    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{<!-- --></span>
	
	        <span class="token comment">// Instantiate with specified consumer group name.</span>
	        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	        <span class="token comment">// Specify name server addresses.</span>
	        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.33.100:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	        <span class="token comment">// Subscribe one more more topics to consume.</span>
	        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// Register callback to execute on arrival of messages fetched from brokers.</span>
	        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	
	            <span class="token annotation punctuation">@Override</span>
	            <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
	                                                            <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s Receive New Messages: %s %n"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
	        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	        <span class="token comment">//Launch the consumer instance.</span>
	        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	
	<span class="token punctuation">}</span>
</code></pre> </li></ol> </li><li> <p><font size="3" color="blue">生产者发送消息的三种方式</font></p> 
  <ol><li> <p><font size="3" color="green">轮廓图示<br> <img src="https://images2.imgbox.com/b4/9d/EJBvZz1u_o.png" alt="在这里插入图片描述"></font></p> </li><li> <p><font size="3" color="green">可靠同步发送</font></p> <pre><code class="prism language-java">含义

	同步发送是指消息发送方发出数据后，会在收到接收方发回响应之后才发下一个数据包的通讯方式。

示例

	<span class="token punctuation">(</span>调用<span class="token class-name">DefaultMQProducer</span>的send方法<span class="token punctuation">)</span>

应用

	重要的通知消息、短信通知、短信营销系统

生产者代码<span class="token punctuation">(</span>如下<span class="token punctuation">)</span>
</code></pre> <pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncProducer</span> <span class="token punctuation">{<!-- --></span>
	
	    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token comment">// Instantiate with a producer group name.</span>
	        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span>
	                <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// Specify name server addresses.</span>
	        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.33.100:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">// Launch the instance.</span>
	        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token comment">// Create a message instance, specifying topic, tag and message body.</span>
	            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span> <span class="token comment">/* Topic */</span><span class="token punctuation">,</span>
	                    <span class="token string">"TagA"</span> <span class="token comment">/* Tag */</span><span class="token punctuation">,</span>
	                    <span class="token punctuation">(</span><span class="token string">"ferao 帅"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span> <span class="token comment">/* Message body */</span>
	            <span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token comment">// Call send message to deliver message to one of brokers.</span>
	            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">// Shut down once the producer instance is not longer in use.</span>
	        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-java">	<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span>C0A8006C22E018B4AAC22DDEB59C0060<span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span>C0A8216400002A9F00000000000C0782<span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token class-name">TopicTest</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">974</span><span class="token punctuation">]</span>
	<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span>C0A8006C22E018B4AAC22DDEB59F0061<span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span>C0A8216400002A9F00000000000C0844<span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token class-name">TopicTest</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">974</span><span class="token punctuation">]</span>
	<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span>C0A8006C22E018B4AAC22DDEB5A00062<span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span>C0A8216400002A9F00000000000C0906<span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token class-name">TopicTest</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">974</span><span class="token punctuation">]</span>
	<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span>C0A8006C22E018B4AAC22DDEB5A20063<span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span>C0A8216400002A9F00000000000C09C8<span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token class-name">TopicTest</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">974</span><span class="token punctuation">]</span>
</code></pre> <p><img src="https://images2.imgbox.com/3c/56/Vpgtv19Q_o.png" alt="在这里插入图片描述"></p> <pre><code class="prism language-java">	<span class="token class-name">ConsumeMessageThread_19</span> <span class="token class-name">Receive</span> <span class="token class-name">New</span> <span class="token class-name">Messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">MessageExt</span> <span class="token punctuation">[</span>queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">194</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">973</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1594302370200</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">57952</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1594302369250</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span>C0A8216400002A9F00000000000C05FE<span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">787966</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">1284723028</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token class-name">Message</span><span class="token punctuation">{<!-- --></span>topic<span class="token operator">=</span><span class="token string">'TopicTest'</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">974</span><span class="token punctuation">,</span> CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1594302370203</span><span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span>C0A8006C22E018B4AAC22DDEB598005E<span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span><span class="token class-name">DefaultCluster</span><span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span><span class="token class-name">TagA</span><span class="token punctuation">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">'null'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
	<span class="token class-name">ConsumeMessageThread_17</span> <span class="token class-name">Receive</span> <span class="token class-name">New</span> <span class="token class-name">Messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">MessageExt</span> <span class="token punctuation">[</span>queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">194</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">973</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1594302370202</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">57952</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1594302369252</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span>C0A8216400002A9F00000000000C06C0<span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">788160</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">1284723028</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token class-name">Message</span><span class="token punctuation">{<!-- --></span>topic<span class="token operator">=</span><span class="token string">'TopicTest'</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">974</span><span class="token punctuation">,</span> CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1594302370206</span><span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span>C0A8006C22E018B4AAC22DDEB59A005F<span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span><span class="token class-name">DefaultCluster</span><span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span><span class="token class-name">TagA</span><span class="token punctuation">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">'null'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
	<span class="token class-name">ConsumeMessageThread_20</span> <span class="token class-name">Receive</span> <span class="token class-name">New</span> <span class="token class-name">Messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">MessageExt</span> <span class="token punctuation">[</span>queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">194</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">974</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1594302370204</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">57952</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1594302369254</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span>C0A8216400002A9F00000000000C0782<span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">788354</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">1284723028</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token class-name">Message</span><span class="token punctuation">{<!-- --></span>topic<span class="token operator">=</span><span class="token string">'TopicTest'</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">975</span><span class="token punctuation">,</span> CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1594302370207</span><span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span>C0A8006C22E018B4AAC22DDEB59C0060<span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span><span class="token class-name">DefaultCluster</span><span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span><span class="token class-name">TagA</span><span class="token punctuation">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">'null'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
	<span class="token class-name">ConsumeMessageThread_12</span> <span class="token class-name">Receive</span> <span class="token class-name">New</span> <span class="token class-name">Messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">MessageExt</span> <span class="token punctuation">[</span>queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">194</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">974</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1594302370207</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">57952</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1594302369257</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span>C0A8216400002A9F00000000000C0844<span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">788548</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">1284723028</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token class-name">Message</span><span class="token punctuation">{<!-- --></span>topic<span class="token operator">=</span><span class="token string">'TopicTest'</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">975</span><span class="token punctuation">,</span> CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1594302370209</span><span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span>C0A8006C22E018B4AAC22DDEB59F0061<span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span><span class="token class-name">DefaultCluster</span><span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span><span class="token class-name">TagA</span><span class="token punctuation">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">'null'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
	<span class="token class-name">ConsumeMessageThread_8</span> <span class="token class-name">Receive</span> <span class="token class-name">New</span> <span class="token class-name">Messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">MessageExt</span> <span class="token punctuation">[</span>queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">194</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">974</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1594302370208</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.2</span><span class="token operator">:</span><span class="token number">57952</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1594302369258</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span>C0A8216400002A9F00000000000C0906<span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">788742</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">1284723028</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token class-name">Message</span><span class="token punctuation">{<!-- --></span>topic<span class="token operator">=</span><span class="token string">'TopicTest'</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">975</span><span class="token punctuation">,</span> CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1594302370211</span><span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span>C0A8006C22E018B4AAC22DDEB5A00062<span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span><span class="token class-name">DefaultCluster</span><span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span><span class="token class-name">TagA</span><span class="token punctuation">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">'null'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
</code></pre> </li><li> <p><font size="3" color="green">可靠异步发送</font></p> <pre><code class="prism language-java">含义

	异步发送是指发送方发出数据后，不等接收方发回响应，接着发送下个数据包的通讯方式。
	MQ 的异步发送，需要用户实现异步发送回调接口（<span class="token class-name">SendCallback</span>）。
	消息发送方在发送了一条消息后，不需要等待服务器响应即可返回，
	进行第二条消息发送。发送方通过回调接口接收服务器响应，并对响应结果进行处理。

应用

	异步发送通常被用于对响应时间敏感的业务场景

示例
</code></pre> <pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncProducer</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token comment">//Instantiate with a producer group name.</span>
	        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"example_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">//Launch the instance.</span>
	        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendAsyncFailed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> i<span class="token punctuation">;</span>
	            <span class="token comment">//Create a message instance, specifying topic, tag and message body.</span>
	            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span>
	                    <span class="token string">"TagA"</span><span class="token punctuation">,</span>
	                    <span class="token string">"OrderID188"</span><span class="token punctuation">,</span>
	                    <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	
	                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span>
	                            sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token punctuation">}</span>
	
	                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token punctuation">}</span>
	            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
	        <span class="token comment">//Shut down once the producer instance is not longer in use.</span>
	        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <p><img src="https://images2.imgbox.com/5e/be/RYqyKdEU_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="green">单向（Oneway）发送</font></p> <pre><code class="prism language-java">含义

	单向（<span class="token class-name">Oneway</span>）发送特点为发送方只负责发送消息，不等待服务器回应且没有回调函数触发，
	即只发送请求不等待应答。 此方式发送消息的过程耗时非常短，一般在微秒级别。

应用

	单向发送用于要求一定可靠性的场景，例如日志收集

示例

	<span class="token punctuation">(</span>调用<span class="token class-name">DefaultMQProducer</span>的sendOneway方法<span class="token punctuation">)</span>
</code></pre> <pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnewayProducer</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
	        <span class="token comment">//Instantiate with a producer group name.</span>
	        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"example_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token comment">//Launch the instance.</span>
	        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token comment">//Create a message instance, specifying topic, tag and message body.</span>
	            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span> <span class="token comment">/* Topic */</span><span class="token punctuation">,</span>
	                    <span class="token string">"TagA"</span> <span class="token comment">/* Tag */</span><span class="token punctuation">,</span>
	                    <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span>
	                            i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span> <span class="token comment">/* Message body */</span>
	            <span class="token punctuation">)</span><span class="token punctuation">;</span>
	            <span class="token comment">//Call send message to deliver message to one of brokers.</span>
	            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	        <span class="token punctuation">}</span>
	        <span class="token comment">//Shut down once the producer instance is not longer in use.</span>
	        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <p><img src="https://images2.imgbox.com/aa/f9/wp91oQoa_o.png" alt="在这里插入图片描述"></p> </li></ol> </li><li> <p><font size="3" color="blue">msgId生成算法</font></p> <pre><code class="prism language-java">含义

	当开发者用rocketmq发送消息的时候通常都会返回如下消息

	<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token number">00000000000000000000000000000001000118</span>B4AAC2088BEB070000<span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span>C0A8216400002A9F00000000001A3D34<span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token class-name">TopicTest</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.100</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">2025</span><span class="token punctuation">]</span>

	对于客户端来说msgId是由客户端producer自己生成的，offsetMsgId是由broker生成的，

	其中offsetMsgId就是我们在rocketMQ控制台直接输入查询的那个messageId。

概念

	msgId

		该ID 是消息发送者在消息发送时会首先在客户端生成，全局唯一，
		在 <span class="token class-name">RocketMQ</span> 中该 ID 还有另外的一个叫法：uniqId，无不体现其全局唯一性。

	offsetMsgId

		消息偏移ID，该 ID 记录了消息所在集群的物理地址，
		主要包含所存储 <span class="token class-name">Broker</span> 服务器的地址<span class="token punctuation">(</span> IP 与端口号<span class="token punctuation">)</span>以及所在commitlog 文件的物理偏移量。
</code></pre> <pre><code class="prism language-java">两者ID的生成算法

	msgId

		生成步骤

			<span class="token number">1.</span>初始化参数LEN<span class="token punctuation">,</span>FIX_STRING<span class="token punctuation">,</span>COUNTER
			<span class="token number">2.</span>初始化buffer
			<span class="token number">3.</span>设置开始时间
			<span class="token number">4.</span>字节转string工具方法
			<span class="token number">5.</span>最终生成msgId

		细节
		
			 其中createUniqId就是最终生成msgId方法。除些之外的方法者是createUniqId调
			 用或者被间接调用的方法，这些方法实现也比较简单。

			<span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>LEN <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			由此可知msgId的长度是LEN <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">32</span>；

			设time <span class="token operator">=</span> 当前时间 <span class="token operator">-</span> 本月开始时间<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
			从代码得到 FIX_STRING <span class="token operator">=</span> ip <span class="token operator">+</span> 进程pid <span class="token operator">+</span> <span class="token class-name">MessageClientIDSetter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>；
			createUniqIDBuffer 加入time 和 counter 因子。
			最终得到msgId的生成因子是<span class="token operator">:</span>   ip <span class="token operator">+</span> 进程pid <span class="token operator">+</span> <span class="token class-name">MessageClientIDSetter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> time <span class="token operator">+</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token class-name">AtomicInteger</span>自增变量）
			最后调用bytes2string进行十六进制的移位和编码就产生了我们的msgId。

		分析算法

			对于每个producer实例来说ip都是唯一的，所以不同producer生成的msgId是不会重复的。
			对于producer单个实例来说的区分因子是：time <span class="token operator">+</span> counter。
			首先应用不重启的情况下msgId是保证唯一性的，
			应用重启了只要系统的时钟不变msgId也是唯一的。
			所以只要系统的时钟不回拨我们就可以保证msgId的全局唯一。
</code></pre> <p><img src="https://images2.imgbox.com/cd/98/3fDu8msV_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/52/15/1b9xeD9Y_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/05/97/u120sYZd_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/98/ab/bWd8tlR8_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/ac/6d/gpkv6MJe_o.png" alt="在这里插入图片描述"></p> <pre><code class="prism language-java">	offsetMsgId

		生成步骤

			broker端生成的offsetMsgId就比较简单了，直接就是主机ip <span class="token operator">+</span> 物理分区的offset，
			再调用<span class="token class-name">UtilAll</span><span class="token punctuation">.</span>bytes2string进行移位转码就完成了
</code></pre> <p><img src="https://images2.imgbox.com/47/11/Nth9Ul4H_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<blockquote> 
 <p><font size="4" color="black"><span id="five">rocketmq之Java Class</span></font></p> 
</blockquote> 
<p><a href="#fiveone" rel="nofollow"><font size="3" face="宋体" color="grey">1.DefaultMQProducer类</font></a></p> 
<p><a href="#fivetwo" rel="nofollow"><font size="3" face="宋体" color="grey">2.DefaultMQPushConsumer类</font></a></p> 
<p><font size="3" face="宋体" color="blke"><span id="fiveone">DefaultMQProducer类</span></font></p> 
<p><font size="3" face="宋体" color="orange">概述</font></p> 
<p><font size="3" face="宋体">DefaultMQProducer类是应用发送消息使用的基类，封装一些通用的方法方便开发者在更多场景中使用。属于线程安全类，在配置并启动后可在多个线程间共享此对象。<br> 其可以通过无参构造方法快速创建一个生产者，通过getter/setter方法，调整发送者的参数。主要负责消息的发送，支持同步/异步/oneway的发送方式，这些发送方式均支持批量发送。</font></p> 
<p><font size="3" face="宋体" color="orange">方法</font></p> 
<table><thead><tr><th>属性</th><th>内容</th></tr></thead><tbody><tr><td>DefaultMQProducerImpl defaultMQProducerImpl;</td><td>生产者内部默认实现类</td></tr><tr><td>String producerGroup;</td><td>Producer组名， 默认值为DEFAULT_PRODUCER。多个Producer如果属于一个应用，发送同样的消息，则应该将它们归为同一组。</td></tr><tr><td>String createTopicKey;</td><td>自动创建测试的topic名称， 默认值为TBW102；在发送消息时，自动创建服务器不存在的topic，需要指定Key。broker必须开启isAutoCreateTopicEnable</td></tr><tr><td>int defaultTopicQueueNums;</td><td>创建默认topic的queue数量。默认4</td></tr><tr><td>int sendMsgTimeout;</td><td>发送消息超时时间，默认值10000，单位毫秒</td></tr><tr><td>int compressMsgBodyOverHowmuch;</td><td>消息体压缩阈值，默认为4k（Consumer收到消息会自动解压缩）</td></tr><tr><td>int retryTimesWhenSendFailed;</td><td>同步模式，返回发送消息失败前内部重试发送的最大次数。可能导致消息重复。默认2</td></tr><tr><td>int retryTimesWhenSendAsyncFailed;</td><td>异步模式，返回发送消息失败前内部重试发送的最大次数。可能导致消息重复。默认2</td></tr><tr><td>boolean retryAnotherBrokerWhenNotStoreOK;</td><td>声明发送失败时，下次是否投递给其他Broker，默认false</td></tr><tr><td>int maxMessageSize;</td><td>最大消息大小。默认4M; 客户端限制的消息大小，超过报错，同时服务端也会限制</td></tr><tr><td>TraceDispatcher traceDispatcher</td><td>消息追踪器，定义了异步传输数据接口。使用rcpHook来追踪消息</td></tr></tbody></table> 
<p><font size="3" face="宋体" color="blke"><span id="fivetwo">DefaultMQPushConsumer类</span></font></p> 
<p><font size="3" face="宋体" color="orange">概述</font></p> 
<p><font size="3" face="宋体">DefaultMQPushConsumer类是rocketmq客户端消费者的实现，从名字上已经可以看出其消息获取方式为broker往消费端推送数据，其内部实现了流控，消费位置上报等等。DefaultMQPushConsumer是Push消费模式下的默认配置。</font></p> 
<p><font size="3" face="宋体" color="orange">方法</font></p> 
<table><thead><tr><th>字段</th><th>内容</th></tr></thead><tbody><tr><td>DefaultMQPushConsumerImpl defaultMQPushConsumerImpl;</td><td>消费者实现类，所有的功能都委托给DefaultMQPushConsumerImpl来实现</td></tr><tr><td>String consumerGroup;</td><td>消费者组名，必须设置，参数默认值是：DEFAULT_CONSUMER (需要注意的是，多个消费者如果具有同样的组名，那么这些消费者必须只消费同一个topic)</td></tr><tr><td>MessageModel messageModel;</td><td>消费的方式，支持以下两种 1、集群消费 2、广播消费。BROADCASTING 广播模式，即所有的消费者可以消费同样的消息CLUSTERING 集群模式，即所有的消费者平均来消费一组消息</td></tr><tr><td>ConsumeFromWhere consumeFromWhere;</td><td>消费者从那个位置消费，分别为：CONSUME_FROM_LAST_OFFSET：第一次启动从队列最后位置消费，后续再启动接着上次消费的进度开始消费 ；CONSUME_FROM_FIRST_OFFSET：第一次启动从队列初始位置消费，后续再启动接着上次消费的进度开始消费；CONSUME_FROM_TIMESTAMP：第一次启动从指定时间点位置消费，后续再启动接着上次消费的进度开始消费(以上所说的第一次启动是指从来没有消费过的消费者，如果该消费者消费过，那么会在broker端记录该消费者的消费位置，如果该消费者挂了再启动，那么自动从上次消费的进度开始)</td></tr><tr><td>AllocateMessageQueueStrategy allocateMessageQueueStrategy;</td><td>消息分配策略，用于集群模式下，消息平均分配给所有客户端；默认实现为AllocateMessageQueueAveragely</td></tr><tr><td>Map&lt;String, String&gt; subscription;</td><td>topic对应的订阅tag</td></tr><tr><td>MessageListener messageListener;</td><td>消息监听器 ，处理消息的业务就在监听里面。目前支持的监听模式包括：MessageListenerConcurrently，对应的处理逻辑类是MessageListener messageListener ；ConsumeMessageConcurrentlyService MessageListenerOrderly 对应的处理逻辑类是ConsumeMessageOrderlyService；两者使用不同的ACK机制。RocketMQ提供了ack机制，以保证消息能够被正常消费。发送者为了保证消息肯定消费成功，只有使用方明确表示消费成功，RocketMQ才会认为消息消费成功。中途断电，抛出异常等都不会认为成功——即都会重新投递。上面两个不同的监听模式使用的ACK机制是不一样的。</td></tr><tr><td>OffsetStore offsetStore;</td><td>offset存储实现，分为本地存储或远程存储 。集群消费：从远程Broker获取。广播消费：从本地文件获取。</td></tr><tr><td></td><td></td></tr></tbody></table> 
<ol><li> <p><font size="3" color="blue">DefaultMQPushConsumer类</font></p> <pre><code class="prism language-java">重要字段
							
	<span class="token keyword">int</span> consumeThreadMin <span class="token operator">=</span> <span class="token number">20</span>		线程池自动调整

	<span class="token keyword">int</span> consumeThreadMax <span class="token operator">=</span> <span class="token number">64</span>		线程池自动调整

	<span class="token keyword">long</span> adjustThreadPoolNumsThreshold <span class="token operator">=</span> <span class="token number">100000</span> 

	<span class="token keyword">int</span> consumeConcurrentlyMaxSpan <span class="token operator">=</span> <span class="token number">2000</span>
									单队列并行消费最大跨度，用于流控 

	<span class="token keyword">int</span> pullThresholdForQueue <span class="token operator">=</span> <span class="token number">1000</span>
									一个queue最大消费的消息个数，用于流控 

	<span class="token keyword">long</span> pullInterval <span class="token operator">=</span> <span class="token number">0</span>			检查拉取消息的间隔时间，由于是长轮询，所以为 <span class="token number">0</span>，但是如果应用为了流控，
									也可以设置大于 <span class="token number">0</span> 的值，单位毫秒，取值范围<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65535</span><span class="token punctuation">]</span>

	consumeMessageBatchMaxSize <span class="token operator">=</span> <span class="token number">1</span>	并发消费时，一次消费消息的数量，默认为<span class="token number">1</span>，
									假如修改为<span class="token number">50</span>，此时若有<span class="token number">100</span>条消息，那么会创建两个线程，每个线程分配<span class="token number">50</span>条消息。
									换句话说，批量消费最大消息条数，取值范围<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span>。默认是<span class="token number">1</span>
									
	pullBatchSize <span class="token operator">=</span> <span class="token number">32</span>				消费者去broker拉取消息时，一次拉取多少条。取值范围<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span>。默认是<span class="token number">32</span> 。可选配置

	<span class="token keyword">boolean</span> postSubscriptionWhenPull <span class="token operator">=</span> <span class="token boolean">false</span> 

	<span class="token keyword">boolean</span> unitMode <span class="token operator">=</span> <span class="token boolean">false</span> 

重要方法

	 <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">String</span> subExpression<span class="token punctuation">)</span> 
									订阅某个topic，subExpression传<span class="token operator">*</span>为订阅该topic所有消息 

	<span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span> messageListener<span class="token punctuation">)</span> 
									注册消息回调，如果需要顺序消费，需要注册<span class="token class-name">MessageListenerOrderly</span>的实现 
	
	start 							启动消息消费	
</code></pre> </li><li> <p><font size="3" color="blue">Message类</font></p> <pre><code class="prism language-java">含义

	<span class="token class-name">Producer</span>发送的消息定义为<span class="token class-name">Message</span>类

位置

	org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message

字段定义

	如图

字段详解

	topic

		<span class="token class-name">Message</span>都有<span class="token class-name">Topic</span>这一属性，<span class="token class-name">Producer</span>发送指定<span class="token class-name">Topic</span>的消息，<span class="token class-name">Consumer</span>订阅<span class="token class-name">Topic</span>下的
		消息。
		通过<span class="token class-name">Topic</span>字段，<span class="token class-name">Producer</span>会获取消息投递的路由信息，决定发送给哪个<span class="token class-name">Broker</span>。

	flag

		网络通信层标记。
		
	body

		<span class="token class-name">Producer</span>要发送的实际消息内容，以字节数组形式进行存储。<span class="token class-name">Message</span>消息有一定大小限制。

	transactionId
	
		<span class="token class-name">RocketMQ</span> <span class="token number">4.3</span><span class="token number">.0</span>引入的事务消息相关的事务编号。

	properties

		该字段为一个<span class="token class-name">HashMap</span>，存储了<span class="token class-name">Message</span>其余各项参数，比如tag、key等关键的消息属性。
		<span class="token class-name">RocketMQ</span>预定义了一组内置属性，除了内置属性之外，
		还可以设置任意自定义属性。当然属性的数量也是有限的，
		消息序列化之后的大小不能超过预设的最大消息大小。
		系统内置属性定义于<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span>MessageConst</span>	<span class="token punctuation">(</span>如图<span class="token punctuation">)</span>

		对于一些关键属性，<span class="token class-name">Message</span>类提供了一组set接口来进行设置，

		<span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{<!-- --></span>
		    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTags</span><span class="token punctuation">(</span><span class="token class-name">String</span> tags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
		    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setKeys</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
		    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
		    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWaitStoreMsgOK</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> waitStoreMsgOK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
		    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBuyerId</span><span class="token punctuation">(</span><span class="token class-name">String</span> buyerId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		这几个set接口对应的作用分别为为，

		属性								接口				用途
		<span class="token class-name">MessageConst</span><span class="token punctuation">.</span>PROPERTY_TAGS		setTags			在消费消息时可以通过tag进行消
														息过滤判定
														
		<span class="token class-name">MessageConst</span><span class="token punctuation">.</span>PROPERTY_KEYS		setKeys			可以设置业务相关标识，用于消费
														处理判定，或消息追踪查询
														
		<span class="token class-name">MessageConst</span><span class="token punctuation">.</span>PROPERTY_DELAY_TIME_LEVEL	setDelayTimeLevel	
														消息延迟处理级别，不同级别对应不同延迟时间
														
		<span class="token class-name">MessageConst</span><span class="token punctuation">.</span>PROPERTY_WAIT_STORE_MSG_OK	setWaitStoreMsgOK	
														在同步刷盘情况下是否需要等待数
														据落地才认为消息发送成功
		
		`<span class="token class-name">MessageConst</span><span class="token punctuation">.</span>PROPERTY_BUYER_ID	setBuyerId		没有在代码中找到使用的地方，所
														以暂不明白其用处	

		这几个字段为什么用属性定义，而不是单独用一个字段进行表示？方便之处可能在于消息数据存
		盘结构早早定义，一些后期添加上的字段功能为了适应之前的存储结构，以属性形式存储在一个
		动态字段更为方便，自然兼容。
</code></pre> <p><img src="https://images2.imgbox.com/1a/40/dBtBhgfx_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1a/2d/4kGpOx3U_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="3" color="blue">MessageExt类讲解</font></p> <pre><code class="prism language-java">含义

	对于发送方来说，上述<span class="token class-name">Message</span>的定义以足够。但对于<span class="token class-name">RocketMQ</span>的整个处理流程来说，
	还需要更多的字段信息用以记录一些必要内容，比如消息的id、创建时间、存储时间等
	等。在同<span class="token keyword">package</span>下可以找到与之相关的其余类定义。首先就是<span class="token class-name">MessageExt</span>，

字段

	字段							用途
	
	queueId						记录<span class="token class-name">MessageQueue</span>编号，消息会被发送到<span class="token class-name">Topic</span>下的<span class="token class-name">MessageQueue</span>

	storeSize					记录消息在<span class="token class-name">Broker</span>存盘大小

	queueOffset					记录在<span class="token class-name">ConsumeQueue</span>中的偏移

	sysFlag						记录一些系统标志的开关状态，<span class="token class-name">MessageSysFlag</span>中定义了系统标识

	bornTimestamp				消息创建时间，在<span class="token class-name">Producer</span>发送消息时设置

	storeHost					记录存储该消息的<span class="token class-name">Broker</span>地址

	msgId						消息<span class="token class-name">Id</span>

	commitLogOffset				记录在<span class="token class-name">Broker</span>中存储便宜

	bodyCRC						消息内容CRC校验值

	reconsumeTimes				消息重试消费次数

	preparedTransactionOffset	事务详细相关字段	

注意

	<span class="token class-name">Message</span>还有一个名为<span class="token class-name">MessageConst</span><span class="token punctuation">.</span>PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX的属性，
	在消息发送时由<span class="token class-name">Producer</span>生成创建。
	上面的msgId则是消息在<span class="token class-name">Broker</span>端进行存储时通过<span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span>createMessageId方法生成
	的，其构成为<span class="token punctuation">(</span>如图<span class="token punctuation">)</span>

	这个<span class="token class-name">MsgId</span>是在<span class="token class-name">Broker</span>生成的，<span class="token class-name">Producer</span>在发送消息时没有该信息，<span class="token class-name">Consumer</span>在消费消息时则能
	获取到该值。<span class="token class-name">RocketMQ</span>也提供了相关命令，

	命令				实现类					描述
	
	queryMsgById	<span class="token class-name">QueryMsgByIdSubCommand</span>	根据<span class="token class-name">MsgId</span>查询消息		
</code></pre> <p><img src="https://images2.imgbox.com/e1/0a/KH8FCVIe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/55/70/TOMJ807K_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<blockquote> 
 <p><font size="4" color="red">rocketmq角色介绍</font></p> 
</blockquote> 
<ol><li> <p><font size="3" color="blue">Producer</font></p> <pre><code class="prism language-java">含义

	消息生产者，负责创建消息发送给<span class="token class-name">Broker</span>，一般由业务系统负责产生消息

	<span class="token class-name">RocketMQ</span>默认提供了<span class="token class-name">DefaultMQProducer</span>、<span class="token class-name">TransactionMQProducer</span>用于发送消息。
	
内含

	<span class="token class-name"><span class="token namespace">a<span class="token punctuation">.</span></span>Producer</span> <span class="token class-name">Group</span><span class="token operator">:</span>
	
		是一组<span class="token class-name">Producer</span>的名称。通常来说一个业务系统可能会奉陪一个<span class="token class-name">Producer</span> <span class="token class-name">Group</span>。

		<span class="token class-name">Producer</span> <span class="token class-name">Group</span>后续可以用于消息发送相关的各项管理监控功能。
		            			               
	<span class="token class-name"><span class="token namespace">b<span class="token punctuation">.</span></span>Message</span><span class="token operator">:</span>

		<span class="token class-name">RocketMQ</span>中的消息。<span class="token class-name">Message</span>必须设置<span class="token class-name">Topic</span>以及消息体，除此之外还可以配

		置一些自定义属性。只要不超过预定义的消息大小，自定义属性可以任意添加。
		
	<span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>Message</span> <span class="token class-name">Model</span><span class="token operator">:</span>

		消息投递存在两种不同类别，
	
	<span class="token class-name"><span class="token namespace">d<span class="token punctuation">.</span></span>Tag</span><span class="token operator">:</span>

		<span class="token class-name">Message</span>可以设置<span class="token class-name">Tag</span>，<span class="token class-name">Tag</span>是系统预定义的属性。<span class="token class-name">Message</span>设置了<span class="token class-name">Tag</span>之后，在消费的时候

		可以根据<span class="token class-name">Tag</span>进行过滤。<span class="token class-name">RocketMQ</span>提供了几种过滤方式。可以认为<span class="token class-name">Tag</span>是<span class="token class-name">Message</span>的二级类别
</code></pre> </li><li> <p><font size="3" color="blue">Consumer</font></p> <pre><code class="prism language-java">含义

	消息消费者，用于从消息队列获取消息。常用的<span class="token class-name">Consumer</span>类

内含

	<span class="token class-name"><span class="token namespace">a<span class="token punctuation">.</span></span>DefaultMQPushConsumer</span>，

		收到消息自动调用传入的处理方法来处理，实时性高。

	<span class="token class-name"><span class="token namespace">b<span class="token punctuation">.</span></span>DefaultMQPullConsumer</span>			

		用户自主控制，灵活度更高。
	
	<span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span></span>Push</span> <span class="token class-name">Consumer</span><span class="token operator">:</span>

		服务端向消费端推送消息

	<span class="token class-name"><span class="token namespace">d<span class="token punctuation">.</span></span>Pull</span> <span class="token class-name">Consumer</span><span class="token operator">:</span>
	
		消费端向服务端定时拉取消息

	<span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span></span>Consumer</span> <span class="token class-name">Group</span> <span class="token operator">:</span>

		是一组<span class="token class-name">Consumer</span>的名称<span class="token punctuation">.</span>相同<span class="token class-name">Group</span>下的<span class="token class-name">Consumer</span>需要有同样的订阅关系，且消费逻辑一致

		否则消息投递的时候可能会出现一些难以排查的问题。

		<span class="token class-name">Consumer</span> <span class="token class-name">Group</span>同样用于分配给不同的业务系统。通过管理工具可以控制<span class="token class-name">Group</span>的消费范围
						 
</code></pre> </li><li> <p><font size="3" color="blue">Broker</font></p> <pre><code class="prism language-java">含义

	<span class="token class-name">Broker</span>是具体提供业务的服务器，

	解释一<span class="token operator">:</span><span class="token class-name">RocketMQ</span>的核心逻辑是<span class="token class-name">Broker</span>。<span class="token class-name">Broker</span>是实际用于手法消息的功能单元。从<span class="token class-name">RocketMQ</span>

		  使用者的角度来看，生产者通过接口将消息投递到<span class="token class-name">Broker</span>，消费者从<span class="token class-name">Broker</span>获取消息进行消费。

		  <span class="token class-name">RocketMQ</span>提供了推拉结合的方式用于获取消息。

	解释二<span class="token operator">:</span>单个<span class="token class-name">Broker</span>节点与所有的<span class="token class-name">NameServer</span>节点保持长连接及心跳，

		  并会定时将<span class="token class-name">Topic</span>信息注册到<span class="token class-name">NameServer</span>，顺带一提底层的通信和连接都是基于<span class="token class-name">Netty</span>实现的。

		  <span class="token class-name">Broker</span>中分master和slave两种角色，每个master可以对应多个slave，

		  但一个slave只能对应一个master，master和slave通过指定相同的<span class="token class-name">Brokername</span>，

		  不同的<span class="token class-name">BrokerId</span> （master为<span class="token number">0</span>）成为一个组。

		  master和slave之间的同步方式分为同步双写和异步复制，

		  异步复制方式master和slave之间虽然会存在少量的延迟，

		  但性能较同步双写方式要高出<span class="token number">10</span><span class="token operator">%</span>左右

		  举例：邮局 。它是<span class="token class-name">RocketMQ</span>的核心，用于接收<span class="token class-name">Producer</span>发过来的			

		  消息、以及处理<span class="token class-name">Consumer</span>的消费消息请求、消息的持久化存储、服务端过滤功能等

		  另外，<span class="token class-name">Broker</span>中还存在一些非常重要的名词需要说明：

内含

	<span class="token class-name"><span class="token namespace">a<span class="token punctuation">.</span></span>Topic</span><span class="token operator">:</span>

		区分消息的种类，一个发送者可以发送消息给一个或者多个<span class="token class-name">Topic</span>，一个消息的接受者可以

	     订阅一个或者多个<span class="token class-name">Topic</span>消息。对于<span class="token class-name">RokectMQ</span>而言，<span class="token class-name">Topic</span>只是一个逻辑上的概念，
	     
	     真正的消息存储其实是在<span class="token class-name">Topic</span>中的<span class="token class-name">Queue</span>中。这要设计是为了消息的顺序消费，
	     		  
	<span class="token class-name"><span class="token namespace">b<span class="token punctuation">.</span></span>Message</span> <span class="token class-name">Queue</span><span class="token operator">:</span>

		相当于是<span class="token class-name">Topic</span>的分区，用于并发发送和接受消息
</code></pre> </li><li> <p><font size="3" color="blue">NameServer</font></p> <pre><code class="prism language-java">含义
		
	   解释一<span class="token operator">:</span><span class="token class-name">RocketMQ</span>没有引入第三方服务依赖，消息队列内部的服务发现以及配置更新等，都

			 借由<span class="token class-name">Name</span> <span class="token class-name">Server</span>来完成。从功能上来说，<span class="token class-name">Name</span> <span class="token class-name">Server</span>相当于一个轻量级简化版

			 的<span class="token class-name">Zookeeper</span>，或者说提供了类似ZK的功能。

			 <span class="token class-name">Name</span> <span class="token class-name">Server</span>的定位是维护<span class="token class-name">RocketMQ</span>全局相关配置，提供消息路由信息，除此之外

			 并不包含过多复杂逻辑。因为其相对轻量级，一般一组<span class="token class-name">Name</span> <span class="token class-name">Server</span>集群可以服务多

			 组<span class="token class-name">Broker</span>集群。
		
			 <span class="token class-name">Name</span> <span class="token class-name">Server</span> <span class="token class-name">Cluster</span>是多个<span class="token class-name">Name</span> <span class="token class-name">Server</span>实例的统称，<span class="token class-name">Name</span> <span class="token class-name">Server</span>之间并无关

			 联，互相也不同步信息。多个<span class="token class-name">Name</span> <span class="token class-name">Server</span>的存在是为了提供高可用服务，不同实例之

			 间的数据信息同步则实际是在数据写入的时候保证的。一份配置或消息路由信息会写入

			 所有<span class="token class-name">Name</span> <span class="token class-name">Server</span>实例中。
			
	   解释二<span class="token operator">:</span>相当于配置中心，维护<span class="token class-name">Broker</span>集群、<span class="token class-name">Broker</span>信息、<span class="token class-name">Broker</span>存活信息、主题与

			 队列信息等。<span class="token class-name">NameServer</span>彼此之间不通信，每个<span class="token class-name">Broker</span>与集群内所有<span class="token class-name">NameServer</span>

			 保持长连接
	
通信机制

	<span class="token number">1.</span>Broker启动后需要完成一次将自己注册到<span class="token class-name">NameServer</span>的操作；随后每隔<span class="token number">30</span>秒时间定时向

		<span class="token class-name">NameServer</span>更新<span class="token class-name">Topic</span>路由信息

	<span class="token number">2.</span>Producer发送消息时，需要根据消息的<span class="token class-name">Topic</span>从本地缓存的获取路由信息。如果没有则

		更新路由信息，会从<span class="token class-name">NameServer</span>重新拉取，同时<span class="token class-name">Producer</span>会默认每隔<span class="token number">30</span>秒向<span class="token class-name">NameServer</span>

		拉取一次路由信息

	<span class="token number">3.</span>Consumer消费消息时，从<span class="token class-name">NameServer</span>获取的路由信息，并再完成客户端的负载均衡后，监听

		指定消息队列获取消息并进行消费
</code></pre> </li></ol> 
<blockquote> 
 <p><font size="4" color="red">集群</font></p> 
</blockquote> 
<ol><li> <p><font size="3" color="blue">集群模式</font></p> <pre><code class="prism language-java">单<span class="token class-name">Master</span>模式

	这种方式风险较大，一旦<span class="token class-name">Broker</span>重启或者宕机时，会导致整个服务不可用。不建议线上

	环境使用，可以用于本地测试

多<span class="token class-name">Master</span>模式

	一个集群无<span class="token class-name">Slave</span>，全是<span class="token class-name">Master</span>，例如<span class="token number">2</span>个<span class="token class-name">Master</span>或者<span class="token number">3</span>个<span class="token class-name">Master</span>，这种模式的优缺点是

	优点：配置简单，单个<span class="token class-name">Master</span>宕机或重启维护对应无影响，在磁盘配置为PAID10时，即时

		机器宕机不可恢复情况下，由于PAID10磁盘非常可靠，消息也不会丢（异步刷盘丢失少量


		消息，同步刷盘一条不丢），性能最高。

	缺点：单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前不可订阅，消息实时

		性会受到影响。

多<span class="token class-name">Master</span>多<span class="token class-name">Slave</span>模式<span class="token punctuation">(</span>异步<span class="token punctuation">)</span>

		每个<span class="token class-name">Master</span>配置一个<span class="token class-name">Slave</span>，有多对<span class="token class-name">Master</span><span class="token operator">-</span><span class="token class-name">Slave</span>，HA采用同步双写方式，即只有主

		备都写成功，才向应用返回成功，这种模式优缺点如下：

		优点：数据与服务都无单点故障，<span class="token class-name">Master</span>宕机情况下，消息无延迟，服务可用性与数据

			可用性都非常高
		缺点：性能比异步复制模式略低<span class="token punctuation">(</span>大约低<span class="token number">10</span><span class="token operator">%</span>左右<span class="token punctuation">)</span>，发送单个消息的RT会略高，且目前版本

			在主节点宕机后，备份不能自动切换为主机
</code></pre> </li><li> <p><font size="3" color="blue">集群特点</font></p> <pre><code class="prism language-java"><span class="token class-name">NameServer</span>

	是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。

<span class="token class-name">Broker</span>

	部署相对复杂，<span class="token class-name">Broker</span>分为<span class="token class-name">Master</span>与<span class="token class-name">Slave</span>，一个<span class="token class-name">Master</span>可以对应多个slave，但是一个

<span class="token class-name">Slave</span>

	只能对应一个<span class="token class-name">Master</span>，<span class="token class-name">Master</span>与<span class="token class-name">Slave</span>的对应关系通过指定相同<span class="token class-name">BrokerName</span><span class="token punctuation">,</span>不同的

	<span class="token class-name">BrokerId</span>来定义，<span class="token class-name">BrokerId</span>为<span class="token number">0</span>表示<span class="token class-name">Master</span>，非<span class="token number">0</span>表示<span class="token class-name">Slave</span>。<span class="token class-name">Master</span>也可以部署多个。每个

	<span class="token class-name">Broker</span>与<span class="token class-name">NameServer</span>集群中的所有节点建立长连接，定时注册<span class="token class-name">Topic</span>信息到所有<span class="token class-name">NameServer</span>

	<span class="token class-name">Producer</span>与<span class="token class-name">NameServer</span>集群中的其中一个节点（随机选择）建立长连接，定时从<span class="token class-name">NameServer</span>

	取<span class="token class-name">Topic</span>路由信息，并向提供<span class="token class-name">Topic</span>服务的<span class="token class-name">Master</span>建立长连接，且定时向<span class="token class-name">Master</span>发送心跳。

	<span class="token class-name">Producer</span>完全无状态，可集群部署。

	<span class="token class-name">Consumer</span>与<span class="token class-name">NameServer</span>集群中的其中一个节点（随机选择）建立长连接，定期从<span class="token class-name">NameServer</span>

	取<span class="token class-name">Topic</span>路由信息，并向提供<span class="token class-name">Topic</span>服务的<span class="token class-name">Master</span>、<span class="token class-name">Slave</span>建立长连接，且定时向<span class="token class-name">Master</span>、

	<span class="token class-name">Slave</span>发送心跳。<span class="token class-name">Consumer</span>既可以从<span class="token class-name">Master</span>订阅信息，也可以从<span class="token class-name">Slave</span>订阅消息，订阅规则

	由<span class="token class-name">Broker</span>配置决定。
</code></pre> </li><li> <p><font size="3" color="blue">各集群间关系</font></p> 
  <ol><li> <p><font size="3" color="green">Producer集群</font></p> <pre><code class="prism language-java">与nameserver的关系

	单个<span class="token class-name">Producer</span>和一台nameserver保持长连接，定时查询topic配置信息，如果该nameserver挂掉，

	生产者会自动连接下一个nameserver，直到有可用连接为止，并能自动重连。

	与nameserver之间没有心跳。

与broker的关系

	单个<span class="token class-name">Producer</span>和与其关联的所有broker保持长连接，并维持心跳。

	默认情况下消息发送采用轮询方式，会均匀发到对应<span class="token class-name">Topic</span>的所有queue中。

最佳实践

	<span class="token number">1.</span>一个应用尽可能只使用一个 <span class="token class-name">Topic</span>，消息子类型用 tags 来标识，tags 可以由应用自由设置。

	只有发送消息设置了tags，消费方在订阅消息时，才可以利用 tags 在 broker 做消息过滤。

	<span class="token number">2.</span>每个消息在业务层面的唯一标识码，要设置到 keys 字段，方便将来定位消息丢失问题。

	服务器会为每个消息创建索引（哈希索引），应用可以通过 <span class="token class-name">Topic</span>，key 来查询返条消息内容，

	以及消息被谁消费。由于是哈希索引，请务必保证 key 尽可能唯一，这样可以避免潜在的哈希冲突。

	<span class="token number">3.</span>消息发送成功或者失败，要打印消息日志，务必要打印 sendresult 和 key 字段。

	<span class="token number">4.</span>对于消息不可丢失应用，务必要有消息重发机制。例如：消息发送失败，存储到数据库，能有定

	时程序尝试重发或者人工触发重发。

	<span class="token number">5.</span>某些应用如果不关注消息是否发送成功，请直接使用sendOneWay方法发送消息。
</code></pre> </li><li> <p><font size="3" color="green">Producer集群</font></p> <pre><code class="prism language-java">与nameserver的关系

	单个<span class="token class-name">Consumer</span>和一台nameserver保持长连接，定时查询topic配置信息，如果该nameserver挂掉，

	消费者会自动连接下一个nameserver，直到有可用连接为止，并能自动重连。与nameserver之间没有心跳。

与broker的关系

	单个<span class="token class-name">Consumer</span>和与其关联的所有broker保持长连接，并维持心跳，失去心跳后，

	则关闭连接，并向该消费者分组的所有消费者发出通知，分组内消费者重新分配队列继续消费。

最佳实践

	<span class="token number">1.</span>Consumer 数量要小于等于queue的总数量，由于<span class="token class-name">Topic</span>下的queue会被相对均匀的分配给
	
	<span class="token class-name">Consumer</span>，如果 <span class="token class-name">Consumer</span> 超过queue的数量，那多余的 <span class="token class-name">Consumer</span> 将没有queue可以消费消息。

	<span class="token number">2.</span>消费过程要做到幂等（即消费端去重），<span class="token class-name">RocketMQ</span>为了保证性能并不支持严格的消息去重。

	<span class="token number">3.</span>尽量使用批量方式消费，<span class="token class-name">RocketMQ</span>消费端采用pull方式拉取消息，通过

	consumeMessageBatchMaxSize参数可以增加单次拉取的消息数量，可以很大程度上提高消费吞吐量。

	另外，提高消费并行度也可以通过增加<span class="token class-name">Consumer</span>处理线程的方式，对应参数

	consumeThreadMin和consumeThreadMax。

	<span class="token number">4.</span>消息发送成功或者失败，要打印消息日志。
</code></pre> </li></ol> </li><li> <p><font size="3" color="blue">补充</font></p> 
  <ol><li> <p><font size="3" color="green">线上建议关闭autoCreateTopicEnable配置</font></p> <pre><code class="prism language-java">该配置用于在<span class="token class-name">Topic</span>不存在时自动创建，会造成的问题是自动新建的<span class="token class-name">Topic</span>只会存在于一台broker上，

后续所有对该<span class="token class-name">Topic</span>的请求都会局限在单台broker上，造成单点压力。
</code></pre> </li><li> <p><font size="3" color="green">broker master宕机情况是否会丢消息</font></p> <pre><code class="prism language-java">broker master宕机，虽然理论上来说不能向该broker写入但slave仍然能支持消费，

但受限于rocketmq的网络连接机制，默认情况下最多需要<span class="token number">30</span>秒，消费者才会发现该情况，

这个时间可通过修改参数pollNameServerInteval来缩短。这个时间段内，发往该broker的请求都是失败的，

而且该broker的消息无法消费，因为此时消费者不知道该broker已经挂掉。

直到消费者得到master宕机通知后，才会转向slave进行消费，但是slave不能保证master的消息<span class="token number">100</span><span class="token operator">%</span>都同步过来了，

因此会有少量的消息丢失。但是消息最终不会丢，一旦master恢复，未同步过去的消息仍然会被消费掉。
</code></pre> </li></ol> </li></ol> 
<blockquote> 
 <p><font size="4" color="red">总结</font></p> 
</blockquote> 
<ol><li> <p><font size="3" color="blue">掌握rocketmq流程</font></p> <pre><code class="prism language-java">基础部分

	mq的介绍
	
		作用
		注意事项
		各mq产品比较

	rocketMQ环境搭建

		安装rocketmq
		启动rocketmq
		测试rocketmq
		关闭rocketmq

	rocketmq高可用集群搭建

		集群各个角色介绍
		集群搭建方式
		双主双从集群搭建
		集群监控平台

	各个消息发送样例

		同步消息
		异步消息
		单向消息
		顺序消息
		批量消息
		过滤消息
		事务消息

项目实战

	项目背景
	功能分析
	项目环境搭建
	下单功能<span class="token punctuation">,</span>保证各服务的数据一致性
	确认订单功能，通过消息进行数据分发
	整体联调

高级功能和源码分析

	高级功能
	
		消息的存储和发送
		消息存储结构
		刷盘机制
		消息的同步复制和异步复制

		负载均衡
	
			<span class="token class-name">Producer</span>负载均衡
			<span class="token class-name">Consumer</span>负载均衡

	源码分析

		路由中心<span class="token class-name">NameServer</span>

			<span class="token class-name">NameServer</span>架构设计
			<span class="token class-name">NameServer</span>启动流程
			<span class="token class-name">NameServer</span>路由注册和故障剔除

		消息生产者<span class="token class-name">Producer</span>

			生产者启动流程
			生产者发送消息流程
			批量发送

		消息存储

			消息存储流程
			存储文件与内存映射
			存储文件
			实时更新消息消费队列和存储文件
			消息队列与索引文件恢复
			刷盘机制
			过期文件删除机制

		消息消费<span class="token class-name">Consumer</span>

			消费者启动流程
			消息拉取
			消息队列负载均衡和重新分布机制
			消息消费过程
			定时消息机制
			顺序消费
</code></pre> </li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0315d53880de9f44b6866622d7a9c5db/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">前端开发之浏览器F12代码调试教程（谷歌浏览器为例）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cd326446a404dd506cb86b8b09d927e5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计算机网络课程笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>