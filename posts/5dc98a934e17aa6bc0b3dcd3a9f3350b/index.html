<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Opencv之特征匹配 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Opencv之特征匹配" />
<meta property="og:description" content="Brute-Force 蛮力匹配 1、导入需要的库 import cv2 import numpy as np import matplotlib.pyplot as plt %matplotlib inline 2、定义绘图函数 def cv_show(name,img): cv2.imshow(name, img) cv2.waitKey(0) cv2.destroyAllWindows() 3、读入需要进行匹配的两张图片 img1 = cv2.imread(&#39;box.png&#39;, 0) img2 = cv2.imread(&#39;box_in_scene.png&#39;, 0) cv_show(&#39;img1&#39;,img1) cv_show(&#39;img2&#39;,img2) 展示图片：
4、实例化SIFT函数 sift = cv2.xfeatures2d.SIFT_create() 5、检测特征点并计算特征 kp1, des1 = sift.detectAndCompute(img1, None) print(np.array(kp1).shape) print(np.array(des1).shape) kp2, des2 = sift.detectAndCompute(img2, None) print(np.array(kp2).shape) print(np.array(des2).shape) 可以得到结果：img1中有603个特征点，img2中有969个特征点，因为从img1和img2本身的图像来看，img2中是包含img1的，所以进行特征匹配的时候只会匹配img1和img2共有的603个特征点。
ps：当然，这里也可以分开来做，即先检测特征点再计算特征。即：
kp1 = sift.detect(img1, None) kp2 = sift.detect(img2, None) kp1, des1 = sift.compute(img1, kp1) kp2, des2 = sift." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5dc98a934e17aa6bc0b3dcd3a9f3350b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-18T12:11:27+08:00" />
<meta property="article:modified_time" content="2020-01-18T12:11:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Opencv之特征匹配</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="BruteForce__0"></a>Brute-Force 蛮力匹配</h2> 
<h3><a id="1_1"></a>1、导入需要的库</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2 
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token operator">%</span>matplotlib inline
</code></pre> 
<h3><a id="2_9"></a>2、定义绘图函数</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">cv_show</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>name<span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="3_18"></a>3、读入需要进行匹配的两张图片</h3> 
<pre><code class="prism language-python">img1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'box.png'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
img2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'box_in_scene.png'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
cv_show<span class="token punctuation">(</span><span class="token string">'img1'</span><span class="token punctuation">,</span>img1<span class="token punctuation">)</span>
cv_show<span class="token punctuation">(</span><span class="token string">'img2'</span><span class="token punctuation">,</span>img2<span class="token punctuation">)</span>
</code></pre> 
<p>展示图片：<br> <img src="https://images2.imgbox.com/a1/fc/gGdeZsRh_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/ad/e9/2ORva5SZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4SIFT_29"></a>4、实例化SIFT函数</h3> 
<pre><code class="prism language-python">sift <span class="token operator">=</span> cv2<span class="token punctuation">.</span>xfeatures2d<span class="token punctuation">.</span>SIFT_create<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="5_34"></a>5、检测特征点并计算特征</h3> 
<pre><code class="prism language-python">kp1<span class="token punctuation">,</span> des1 <span class="token operator">=</span> sift<span class="token punctuation">.</span>detectAndCompute<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>kp1<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>des1<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
kp2<span class="token punctuation">,</span> des2 <span class="token operator">=</span> sift<span class="token punctuation">.</span>detectAndCompute<span class="token punctuation">(</span>img2<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>kp2<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>des2<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre> 
<p>可以得到结果：img1中有603个特征点，img2中有969个特征点，因为从img1和img2本身的图像来看，img2中是包含img1的，所以进行特征匹配的时候只会匹配img1和img2共有的603个特征点。<br> ps：当然，这里也可以分开来做，即先检测特征点再计算特征。即：</p> 
<pre><code class="prism language-python">kp1 <span class="token operator">=</span> sift<span class="token punctuation">.</span>detect<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
kp2 <span class="token operator">=</span> sift<span class="token punctuation">.</span>detect<span class="token punctuation">(</span>img2<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
kp1<span class="token punctuation">,</span> des1 <span class="token operator">=</span> sift<span class="token punctuation">.</span>compute<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> kp1<span class="token punctuation">)</span>
kp2<span class="token punctuation">,</span> des2 <span class="token operator">=</span> sift<span class="token punctuation">.</span>compute<span class="token punctuation">(</span>img2<span class="token punctuation">,</span> kp2<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="6BF_54"></a>6、进行BF匹配</h3> 
<p>此时，情况应分成进行1对1的匹配还是k对最佳匹配。</p> 
<h4><a id="11_57"></a>1对1匹配</h4> 
<h5><a id="BF_58"></a>创建BF匹配器对象</h5> 
<p>函数介绍：<br> cv2.BFMatcher(normType=cv2.NORM_L2, crossCheck=True)</p> 
<p>传入参数：</p> 
<ul><li>normType：指定要使用的距离量度。默认是cv2.NORM_L2。适用于SIFT和SURF特征。对于二进制字符串的描述子，比如ORB，BRIEF，BRISK等，应该用cv2.NORM_HAMMING。使用Hamming距离度量，如果ORB使用VTA_K == 3或者4，应该用cv2.NORM_HAMMING2。</li><li>crossCheck：表示两个特征点要互相匹配，例如A中的第i个特征点与B中的第j个特征点最近的，并且B中的第j个特征点到A中的第i个特征点也是。当BF匹配器对象创建以后，两个重要的方法是BFMatcher.match()和BFMatcher.knnMatch()。第一个返回最匹配的，crossCheck=True，第二个方法返回k个最匹配的，k由用户指定，此时crossCheck=False。</li></ul> 
<pre><code class="prism language-python">bf <span class="token operator">=</span> cv2<span class="token punctuation">.</span>BFMatcher<span class="token punctuation">(</span>normType<span class="token operator">=</span>cv2<span class="token punctuation">.</span>NORM_L2<span class="token punctuation">,</span> crossCheck<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_68"></a>进行匹配操作</h5> 
<p>函数介绍：<br> bf.match(des1, des2)</p> 
<p>输出：<br> DMatch类型的数据结构。</p> 
<p>那么这个这个DMatch数据结构究竟是什么呢？<br> 它包含三个非常重要的数据分别是queryIdx，trainIdx，distance。</p> 
<ul><li>queryIdx：此匹配对应的测试图像的特征描述子索引（第几个特征点描述符）。即DMatch.queryIdx表示一个测试图像中的特征点。对于一个特征点来说，它本身也具有以下属性：.pt:关键点坐标，.angle：表示关键点方向，.response表示响应强度，.size:表示该点的直径大小。</li><li>trainIdx：此匹配对应的训练(模板)图像的特征描述子索引（第几个特征点描述符）。即DMatch.trainIdx表示一个训练(模板)图像中的特征点。同样地，对于一个特征点来说，它本身也具有以下属性：.pt:关键点坐标，.angle：表示关键点方向，.response表示响应强度，.size:表示该点的直径大小。</li><li>distance：代表这对匹配的特征点描述符的欧式距离，数值越小也就说明俩个特征点越相近。即DMatch.distance表示一个距离。</li></ul> 
<pre><code class="prism language-python">matches <span class="token operator">=</span> bf<span class="token punctuation">.</span>match<span class="token punctuation">(</span>des1<span class="token punctuation">,</span> des2<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_86"></a>找出最匹配的十个特征点并将它们用线连起来</h5> 
<p>函数介绍：<br> cv2.drawMatches(imageA, kpsA, imageB, kpsB, matches[:10], None, flags=2)</p> 
<p>传入参数：</p> 
<ul><li>imageA和imageB表示图片。</li><li>kpsA和kpsB表示关键点。</li><li>matches表示进过cv2.BFMatcher获得的匹配的索引值，也有距离。</li><li>flags表示有几个图像。</li></ul> 
<pre><code class="prism language-python">matches <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>matches<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>distance<span class="token punctuation">)</span>
img3 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>drawMatches<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> kp1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> kp2<span class="token punctuation">,</span> matches<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span>flags<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
cv_show<span class="token punctuation">(</span><span class="token string">'img3'</span><span class="token punctuation">,</span>img3<span class="token punctuation">)</span>
</code></pre> 
<p>得到结果：<br> <img src="https://images2.imgbox.com/4b/29/LZ4qQQfZ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="k_102"></a>k对最佳匹配</h4> 
<p>k对最佳匹配是指，每一个特征点在另一张图片上都会有k个最匹配的点存在，例如k=2，它会给每个特征点画两根匹配线。<br> 实现方法与1对1匹配大同小异。</p> 
<h5><a id="BF_105"></a>创建BF匹配器对象</h5> 
<p>注意，此时，crossCheck=False（默认）</p> 
<pre><code class="prism language-python">bf <span class="token operator">=</span> cv2<span class="token punctuation">.</span>BFMatcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_111"></a>进行匹配操作</h5> 
<p>函数介绍：<br> bf.knnMatch(des1, des2, k=2)</p> 
<p>输出：<br> Knnmatch与match的返回值类型一样，都是DMatch类型的数据结构，只不过一组返回的k（此处=2）个DMatch类型。</p> 
<pre><code class="prism language-python">matches <span class="token operator">=</span> bf<span class="token punctuation">.</span>knnMatch<span class="token punctuation">(</span>des1<span class="token punctuation">,</span> des2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_120"></a>找出匹配的特征点并将它们用线连起来</h5> 
<p>在这里，每一个特征点（设为A）都有最匹配的另外两个特征点在另一张图上，设为B和C。其中AB的距离最短，AC的距离次短。<br> 那么规定，如果AB间的距离小于AC间距离的0.75倍，则认为AB的匹配度远远大于A与其他任何点的匹配度，则将AB两点连起来。</p> 
<pre><code class="prism language-python">good <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> m<span class="token punctuation">,</span> n <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
    <span class="token keyword">if</span> m<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">0.75</span> <span class="token operator">*</span> n<span class="token punctuation">.</span>distance<span class="token punctuation">:</span>
        good<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>
img3 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>drawMatchesKnn<span class="token punctuation">(</span>img1<span class="token punctuation">,</span>kp1<span class="token punctuation">,</span>img2<span class="token punctuation">,</span>kp2<span class="token punctuation">,</span>good<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span>flags<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
cv_show<span class="token punctuation">(</span><span class="token string">'img3'</span><span class="token punctuation">,</span>img3<span class="token punctuation">)</span>
</code></pre> 
<p>得到结果：<br> <img src="https://images2.imgbox.com/9e/8c/E9FeWkSA_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/efb98803bae8702ba2162eb8a8effea6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">足球运动员的数据分析实战(python)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b876bcf683388b9738ffaba4d2b7931f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">一个有趣的问题---java.lang.String的&#43;到底做了什么</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>