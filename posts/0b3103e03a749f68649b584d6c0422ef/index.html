<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于FPGA的MobileNet V2卷积神经网络加速器 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于FPGA的MobileNet V2卷积神经网络加速器" />
<meta property="og:description" content="MobileNet V2介绍 MobileNetV2是在V1基础之上的改进。V1主要思想就是深度可分离卷积。而V2则在V1的基础上，引入了Linear Bottleneck 和 Inverted Residuals。下图是MobileNet V2中的一个基本模块
可以看到，该模块由三个卷积组成，第一第三个卷积是标准的1x1卷积，起到升维和降维的作用，而中间的是一个depthwise卷积，每一个卷积层之后，都紧接着一个BN层，以加速网络的收敛。
同时，我们观察到，该模块的输入和输出有一个残差连接，即输入和最终的输出求和，这就是MobileNet V2中的Inverted Residuals，同时，我们注意到，第三个卷积层之后，并没有跟着一个激活函数，这就是上面所说的Linear Bottleneck，因为从高维向低维转换时，使用ReLU激活函数可能会造成信息丢失或破坏（不使用非线性激活数数）。所以在最后一个卷积之后，我们不再使用ReLU激活函数而是使用线性激活函数。
有了上边的基础，整体的网络结构就很好理解了，如下图所示
下图则是MobileNet V2和其他网络在参数量、计算复杂度方面的对比，可以看到，MobileNet V2的参数数目为3.4M，乘累加数目为300M.
模型训练以及参数预处理 模型训练，我们采用的是一个有5种花卉类别的数据集，输入图像的尺寸为3x224x224,我们仅修改网络的最后一层(即将输出向量维度由1000改为5)
以下是训练代码:
import os import torchvision.transforms as transforms from torchvision import datasets import torch.utils.data as data import torch import numpy as np import matplotlib.pyplot as plt import torchvision.models as models #模型加载 model = models.mobilenet_v2(pretrained=True) model.classifier = torch.nn.Sequential(torch.nn.Dropout(p=0.5), torch.nn.Linear(1280, 5)) print(model) model.load_state_dict(torch.load(&#39;model.pkl&#39;)) #在训练过的参数的基础上再进行训练 #参数 BATCH_SIZE=32 DEVICE=&#39;cuda&#39; #数据集加载 path=&#39;F:\\data\\flower_photos\\flower_photos&#39; flower_class=[&#39;daisy&#39;,&#39;dandelion&#39;,&#39;roses&#39;,&#39;sunflowers&#39;,&#39;tulips&#39;] transform = { &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0b3103e03a749f68649b584d6c0422ef/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-21T18:58:08+08:00" />
<meta property="article:modified_time" content="2022-02-21T18:58:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于FPGA的MobileNet V2卷积神经网络加速器</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="MobileNet_V2_0"></a>MobileNet V2介绍</h2> 
<p><strong>MobileNetV2</strong>是在V1基础之上的改进。V1主要思想就是深度可分离卷积。而V2则在V1的基础上，引入了<strong>Linear Bottleneck</strong> 和 <strong>Inverted Residuals</strong>。下图是MobileNet V2中的一个基本模块<br> <img src="https://images2.imgbox.com/29/58/HKUtpB1h_o.png" alt="在这里插入图片描述"><br> 可以看到，该模块由三个卷积组成，第一第三个卷积是标准的<strong>1x1卷积</strong>，起到升维和降维的作用，而中间的是一个<strong>depthwise卷积</strong>，每一个卷积层之后，都紧接着一个BN层，以加速网络的收敛。<br> 同时，我们观察到，该模块的输入和输出有一个<strong>残差连接</strong>，即输入和最终的输出求和，这就是MobileNet V2中的<strong>Inverted Residuals</strong>，同时，我们注意到，第三个卷积层之后，并没有跟着一个激活函数，这就是上面所说的<strong>Linear Bottleneck</strong>，因为从高维向低维转换时，使用ReLU激活函数可能会造成信息丢失或破坏（不使用非线性激活数数）。所以在最后一个卷积之后，我们不再使用ReLU激活函数而是使用线性激活函数。<br> 有了上边的基础，整体的网络结构就很好理解了，如下图所示<br> <img src="https://images2.imgbox.com/ee/85/Tqg4YvQW_o.png" alt="在这里插入图片描述">下图则是MobileNet V2和其他网络在参数量、计算复杂度方面的对比，可以看到，MobileNet V2的参数数目为<strong>3.4M</strong>，乘累加数目为<strong>300M.</strong><br> <img src="https://images2.imgbox.com/51/4f/LQk1XhUY_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_8"></a>模型训练以及参数预处理</h2> 
<p>模型训练，我们采用的是一个有5种花卉类别的数据集，输入图像的尺寸为<strong>3x224x224</strong>,我们仅修改网络的最后一层(即将输出向量维度由1000改为5)<br> 以下是训练代码:</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> data
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> models
<span class="token comment">#模型加载</span>
model <span class="token operator">=</span> models<span class="token punctuation">.</span>mobilenet_v2<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>classifier <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1280</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'model.pkl'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment">#在训练过的参数的基础上再进行训练</span>
<span class="token comment">#参数</span>
BATCH_SIZE<span class="token operator">=</span><span class="token number">32</span>
DEVICE<span class="token operator">=</span><span class="token string">'cuda'</span>
<span class="token comment">#数据集加载</span>
path<span class="token operator">=</span><span class="token string">'F:\\data\\flower_photos\\flower_photos'</span>
flower_class<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'daisy'</span><span class="token punctuation">,</span><span class="token string">'dandelion'</span><span class="token punctuation">,</span><span class="token string">'roses'</span><span class="token punctuation">,</span><span class="token string">'sunflowers'</span><span class="token punctuation">,</span><span class="token string">'tulips'</span><span class="token punctuation">]</span>

transform <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"train"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>RandomResizedCrop<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"val"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
image_path <span class="token operator">=</span> path
trainset <span class="token operator">=</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>root<span class="token operator">=</span>image_path<span class="token punctuation">,</span>
                                transform<span class="token operator">=</span>transform<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
trainloader <span class="token operator">=</span> data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>trainset<span class="token punctuation">,</span> BATCH_SIZE<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>trainset<span class="token punctuation">.</span>classes<span class="token punctuation">)</span>  <span class="token comment">#根据分的文件夹的名字来确定的类别</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>trainset<span class="token punctuation">.</span>class_to_idx<span class="token punctuation">)</span> <span class="token comment">#按顺序为这些类别定义索引为0,1...</span>
<span class="token comment"># print(trainset.imgs) #返回从所有文件夹中得到的图片的路径以及其类别</span>

<span class="token keyword">def</span> <span class="token function">imshow</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> image<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># plt.imshow()只能接受3-D Tensor，所以也要用image[0]消去batch那一维</span>
        img <span class="token operator">=</span> img<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># FloatTensor转为ndarray</span>
        img <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 把channel那一维放到最后</span>
        <span class="token comment"># 显示图片</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#损失函数和优化器</span>
loss_f <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.00001</span><span class="token punctuation">)</span>
<span class="token comment"># 模型训练和参数优化</span>
epoch_n <span class="token operator">=</span> <span class="token number">10</span>
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>empty_cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
model<span class="token operator">=</span>model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epoch_n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Epoch {}/{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epoch_n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token comment"># 设置为True，会进行Dropout并使用batch mean和batch var</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    running_loss <span class="token operator">=</span> <span class="token number">0.0</span>
    running_corrects <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># enuerate(),返回的是索引和元素</span>
    <span class="token keyword">for</span> batch<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>trainloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        X<span class="token punctuation">,</span> y <span class="token operator">=</span> data
        X<span class="token operator">=</span>X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span>
        y<span class="token operator">=</span>y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>DEVICE<span class="token punctuation">)</span>
        y_pred <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
        <span class="token comment"># pred，概率较大值对应的索引值，可看做预测结果</span>
        _<span class="token punctuation">,</span> pred <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>y_pred<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 梯度归零</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 计算损失</span>
        loss <span class="token operator">=</span> loss_f<span class="token punctuation">(</span>y_pred<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 计算损失和</span>
        running_loss <span class="token operator">+=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>loss<span class="token punctuation">)</span>
        <span class="token comment"># 统计预测正确的图片数</span>
        running_corrects <span class="token operator">+=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>pred <span class="token operator">==</span> y<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> batch<span class="token operator">%</span><span class="token number">10</span><span class="token operator">==</span><span class="token number">9</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"loss="</span><span class="token punctuation">,</span>running_loss<span class="token operator">/</span><span class="token punctuation">(</span>BATCH_SIZE<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"acc is {}%"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>running_corrects<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>BATCH_SIZE<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            running_loss<span class="token operator">=</span><span class="token number">0</span>
            running_corrects<span class="token operator">=</span><span class="token number">0</span>

    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'model.pkl'</span><span class="token punctuation">)</span>

</code></pre> 
<p>训练完成后，为了加快推理速度，我们首先进行了一个<strong>BN融合</strong>，即将BN层参数和卷积层参数融合在一起，这样在推理时就可省去BN层的计算。<br> 以下就是进行参数<strong>BN融合</strong>以及<strong>保存</strong>的代码</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> data
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> models

<span class="token comment">#数据</span>
path<span class="token operator">=</span><span class="token string">'F:\\data\\flower_photos\\flower_photos'</span>

transform <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"train"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>RandomResizedCrop<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"val"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

trainset <span class="token operator">=</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>root<span class="token operator">=</span>path<span class="token punctuation">,</span>transform<span class="token operator">=</span>transform<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
trainloader <span class="token operator">=</span> data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>trainset<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
image<span class="token operator">=</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3670</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
label<span class="token operator">=</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3670</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> batch<span class="token punctuation">,</span>data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>trainloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
    X<span class="token punctuation">,</span>y<span class="token operator">=</span>data
    image<span class="token punctuation">[</span>batch<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">:</span>batch<span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span>y<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">=</span>X
    label<span class="token punctuation">[</span>batch<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">:</span>batch<span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span>y<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span>y

image<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"image.bin"</span><span class="token punctuation">)</span>
label<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"label.bin"</span><span class="token punctuation">)</span>

model <span class="token operator">=</span> models<span class="token punctuation">.</span>mobilenet_v2<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>classifier <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1280</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'model.pkl'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
model<span class="token operator">=</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">SaveFoldedInvertedResidualParam</span><span class="token punctuation">(</span>param_dict<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#</span>
    Wc1<span class="token operator">=</span><span class="token punctuation">(</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.0.1.weight'</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.0.1.running_var'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">0.00001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>\
        param_dict<span class="token punctuation">[</span><span class="token string">'conv.0.0.weight'</span><span class="token punctuation">]</span>
    bc1<span class="token operator">=</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.0.1.bias'</span><span class="token punctuation">]</span><span class="token operator">-</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.0.1.weight'</span><span class="token punctuation">]</span><span class="token operator">*</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.0.1.running_mean'</span><span class="token punctuation">]</span><span class="token operator">/</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>
        param_dict<span class="token punctuation">[</span><span class="token string">'conv.0.1.running_var'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">0.00001</span><span class="token punctuation">)</span>
    Wc2<span class="token operator">=</span><span class="token punctuation">(</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.1.1.weight'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.1.1.running_var'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.00001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> param_dict<span class="token punctuation">[</span>
        <span class="token string">'conv.1.0.weight'</span><span class="token punctuation">]</span>
    bc2 <span class="token operator">=</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.1.1.bias'</span><span class="token punctuation">]</span><span class="token operator">-</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.1.1.weight'</span><span class="token punctuation">]</span> <span class="token operator">*</span> param_dict<span class="token punctuation">[</span><span class="token string">'conv.1.1.running_mean'</span><span class="token punctuation">]</span> <span class="token operator">/</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>
        param_dict<span class="token punctuation">[</span><span class="token string">'conv.1.1.running_var'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.00001</span><span class="token punctuation">)</span>
    Wc3 <span class="token operator">=</span> <span class="token punctuation">(</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.3.weight'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.3.running_var'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.00001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span> param_dict<span class="token punctuation">[</span>
        <span class="token string">'conv.2.weight'</span><span class="token punctuation">]</span>
    bc3 <span class="token operator">=</span> param_dict<span class="token punctuation">[</span><span class="token string">'conv.3.bias'</span><span class="token punctuation">]</span><span class="token operator">-</span>param_dict<span class="token punctuation">[</span><span class="token string">'conv.3.weight'</span><span class="token punctuation">]</span> <span class="token operator">*</span> param_dict<span class="token punctuation">[</span><span class="token string">'conv.3.running_mean'</span><span class="token punctuation">]</span> <span class="token operator">/</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>
        param_dict<span class="token punctuation">[</span><span class="token string">'conv.3.running_var'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.00001</span><span class="token punctuation">)</span>
    <span class="token comment">#保存参数</span>
    Wc1<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"FoldedInvertedResidual.{}.Wc1.bin"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    bc1<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"FoldedInvertedResidual.{}.bc1.bin"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    Wc2<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"FoldedInvertedResidual.{}.Wc2.bin"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    bc2<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"FoldedInvertedResidual.{}.bc2.bin"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    Wc3<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"FoldedInvertedResidual.{}.Wc3.bin"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    bc3<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"FoldedInvertedResidual.{}.bc3.bin"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">SaveFoldedHeadParam</span><span class="token punctuation">(</span>param_dict1<span class="token punctuation">,</span>param_dict2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    Wc1<span class="token operator">=</span><span class="token punctuation">(</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.weight'</span><span class="token punctuation">]</span><span class="token operator">/</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.running_var'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">0.00001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>param_dict1<span class="token punctuation">[</span><span class="token string">'0.weight'</span><span class="token punctuation">]</span>
    bc1<span class="token operator">=</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.bias'</span><span class="token punctuation">]</span><span class="token operator">-</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.weight'</span><span class="token punctuation">]</span><span class="token operator">*</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.running_mean'</span><span class="token punctuation">]</span><span class="token operator">/</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.running_var'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">0.00001</span><span class="token punctuation">)</span>
    Wc1<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"Head.Wc1.bin"</span><span class="token punctuation">)</span>
    bc1<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"Head.bc1.bin"</span><span class="token punctuation">)</span>
    <span class="token comment">#</span>
    Wc2<span class="token operator">=</span><span class="token punctuation">(</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.0.1.weight'</span><span class="token punctuation">]</span><span class="token operator">/</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.0.1.running_var'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">0.00001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.0.0.weight'</span><span class="token punctuation">]</span>
    bc2<span class="token operator">=</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.0.1.bias'</span><span class="token punctuation">]</span><span class="token operator">-</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.0.1.weight'</span><span class="token punctuation">]</span><span class="token operator">*</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.0.1.running_mean'</span><span class="token punctuation">]</span><span class="token operator">/</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">0.00001</span><span class="token operator">+</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.0.1.running_var'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    Wc2<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"Head.Wc2.bin"</span><span class="token punctuation">)</span>
    bc2<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"Head.bc2.bin"</span><span class="token punctuation">)</span>
    <span class="token comment">#</span>
    Wc3<span class="token operator">=</span><span class="token punctuation">(</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.2.weight'</span><span class="token punctuation">]</span><span class="token operator">/</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">0.00001</span><span class="token operator">+</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.2.running_var'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.1.weight'</span><span class="token punctuation">]</span>
    bc3<span class="token operator">=</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.2.bias'</span><span class="token punctuation">]</span><span class="token operator">-</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.2.weight'</span><span class="token punctuation">]</span><span class="token operator">*</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.2.running_mean'</span><span class="token punctuation">]</span><span class="token operator">/</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">0.00001</span><span class="token operator">+</span>param_dict2<span class="token punctuation">[</span><span class="token string">'conv.2.running_var'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    Wc3<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"Head.Wc3.bin"</span><span class="token punctuation">)</span>
    bc3<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"Head.bc3.bin"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">SaveFoldedTailParam</span><span class="token punctuation">(</span>param_dict1<span class="token punctuation">,</span>param_dict2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    Wc1<span class="token operator">=</span><span class="token punctuation">(</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.weight'</span><span class="token punctuation">]</span><span class="token operator">/</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.running_var'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">0.00001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>param_dict1<span class="token punctuation">[</span><span class="token string">'0.weight'</span><span class="token punctuation">]</span>
    bc1<span class="token operator">=</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.bias'</span><span class="token punctuation">]</span><span class="token operator">-</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.weight'</span><span class="token punctuation">]</span><span class="token operator">*</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.running_mean'</span><span class="token punctuation">]</span><span class="token operator">/</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">0.00001</span><span class="token operator">+</span>param_dict1<span class="token punctuation">[</span><span class="token string">'1.running_var'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    Wc1<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"Tail.Wc1.bin"</span><span class="token punctuation">)</span>
    bc1<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"Tail.bc1.bin"</span><span class="token punctuation">)</span>
    <span class="token comment">#</span>
    param_dict2<span class="token punctuation">[</span><span class="token string">'1.weight'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">"Tail.Wf1.bin"</span><span class="token punctuation">)</span>
    param_dict2<span class="token punctuation">[</span><span class="token string">'1.bias'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tofile<span class="token punctuation">(</span><span class="token string">'Tail.bf1.bin'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">folded_param_save</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    SaveFoldedHeadParam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#feature2,16--&gt;96--&gt;24</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># feature3,24--&gt;144--&gt;24</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># feature4,24--&gt;144--&gt;32</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment"># feature5,32--&gt;192--&gt;32</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token comment"># feature6,32--&gt;192--&gt;32</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token comment"># feature7,32--&gt;192--&gt;64</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token comment"># feature8,64--&gt;384--&gt;64</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token comment"># feature9,64--&gt;384--&gt;64</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>
    <span class="token comment"># feature10,64--&gt;384--&gt;64</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token comment"># feature11,64--&gt;384--&gt;96</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>
    <span class="token comment"># feature12,96--&gt;576--&gt;96</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token comment"># feature13,96--&gt;576--&gt;96</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">)</span>
    <span class="token comment"># feature14,96--&gt;576--&gt;160</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span>
    <span class="token comment"># feature15,160--&gt;960--&gt;160</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">)</span>
    <span class="token comment"># feature16,160--&gt;960--&gt;160</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>
    <span class="token comment"># feature17,160--&gt;960--&gt;320</span>
    SaveFoldedInvertedResidualParam<span class="token punctuation">(</span>param_dict<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
    <span class="token comment">#Tail</span>
    SaveFoldedTailParam<span class="token punctuation">(</span>param_dict1<span class="token operator">=</span>model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>param_dict2<span class="token operator">=</span>model<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

folded_param_save<span class="token punctuation">(</span>model<span class="token punctuation">)</span>





</code></pre> 
<p>保存得到的权重参数以及数据集：<br> <img src="https://images2.imgbox.com/5e/69/arJZYv4y_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="HLS_237"></a>加速器HLS设计</h2> 
<p>由于MobileNet V2由多个计算构成，因此我们设计了多个<strong>IP</strong>，分别加速不同的运算，主要有:<br> <strong>pwconv</strong>:加速point-wise卷积<br> <strong>dwconv</strong>:加速depth-wise卷积<br> <strong>conv</strong>:加速网络第一层的标准3x3s2卷积（网络第一层计算量也很大，因此也得加速，很无奈)<br> <strong>fc</strong>:加速全局平均池化层和全连接层<br> 工程代码如下:<br> <img src="https://images2.imgbox.com/a4/39/GkPNcBps_o.png" alt="在这里插入图片描述">这里，我们着重看dwconv和pwconv的设计。</p> 
<h3><a id="dwconv_245"></a>dwconv</h3> 
<p><strong>dwconv</strong>，depth-wise卷积，一个通道对应一个卷积核，因此没有标准卷积中的通道求和操作，如下图所示<br> <img src="https://images2.imgbox.com/06/f0/Fv86uUG6_o.png" alt="在这里插入图片描述">我们将该卷积过程分为三个阶段:<strong>加载数据、计算卷积以及写回结果</strong>，为了掩盖数据的传输时间，我们进行了<strong>粗粒度流水线</strong>，即乒乓(双缓冲)操作，部分代码如下:</p> 
<pre><code class="prism language-cpp"><span class="token comment">//</span>
	<span class="token keyword">bool</span> pp<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
	BlockID load_block<span class="token punctuation">,</span>com_block<span class="token punctuation">,</span>store_block<span class="token punctuation">;</span>
	<span class="token comment">//阶段1</span>
	load_block<span class="token punctuation">.</span>ch<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	load_block<span class="token punctuation">.</span>row<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	load_block<span class="token punctuation">.</span>col<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">load_wrapper</span><span class="token punctuation">(</span>in1<span class="token punctuation">,</span>in2<span class="token punctuation">,</span>weight<span class="token punctuation">,</span>wt_buff1<span class="token punctuation">,</span>fm_in_buff1<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>load_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//阶段2</span>
	<span class="token function">update_block</span><span class="token punctuation">(</span>o_fm_size<span class="token punctuation">,</span>load_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
	com_block<span class="token punctuation">.</span>ch<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	com_block<span class="token punctuation">.</span>row<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	com_block<span class="token punctuation">.</span>col<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">compute</span><span class="token punctuation">(</span>fm_in_buff1<span class="token punctuation">,</span>wt_buff1<span class="token punctuation">,</span>bias_buff<span class="token punctuation">[</span>com_block<span class="token punctuation">.</span>ch<span class="token operator">/</span>Tm<span class="token punctuation">]</span><span class="token punctuation">,</span>fm_out_buff1<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">load_wrapper</span><span class="token punctuation">(</span>in1<span class="token punctuation">,</span>in2<span class="token punctuation">,</span>weight<span class="token punctuation">,</span>wt_buff2<span class="token punctuation">,</span>fm_in_buff2<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>load_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//</span>
	<span class="token function">update_block</span><span class="token punctuation">(</span>o_fm_size<span class="token punctuation">,</span>load_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">update_block</span><span class="token punctuation">(</span>o_fm_size<span class="token punctuation">,</span>com_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
	store_block<span class="token punctuation">.</span>ch<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	store_block<span class="token punctuation">.</span>row<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	store_block<span class="token punctuation">.</span>col<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">HLS LOOP_TRIPCOUNT min<span class="token operator">=</span><span class="token number">62</span> max<span class="token operator">=</span><span class="token number">62</span> avg<span class="token operator">=</span><span class="token number">62</span></span></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>load_block<span class="token punctuation">.</span>ch<span class="token operator">+</span>Tm<span class="token operator">&gt;</span>channel<span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token function">load_wrapper</span><span class="token punctuation">(</span>in1<span class="token punctuation">,</span>in2<span class="token punctuation">,</span>weight<span class="token punctuation">,</span>wt_buff1<span class="token punctuation">,</span>fm_in_buff1<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>load_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">compute</span><span class="token punctuation">(</span>fm_in_buff2<span class="token punctuation">,</span>wt_buff2<span class="token punctuation">,</span>bias_buff<span class="token punctuation">[</span>com_block<span class="token punctuation">.</span>ch<span class="token operator">/</span>Tm<span class="token punctuation">]</span><span class="token punctuation">,</span>fm_out_buff2<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">store_output</span><span class="token punctuation">(</span>out1<span class="token punctuation">,</span>out2<span class="token punctuation">,</span>fm_out_buff1<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>store_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
		    pp<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
			<span class="token function">load_wrapper</span><span class="token punctuation">(</span>in1<span class="token punctuation">,</span>in2<span class="token punctuation">,</span>weight<span class="token punctuation">,</span>wt_buff2<span class="token punctuation">,</span>fm_in_buff2<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>load_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">compute</span><span class="token punctuation">(</span>fm_in_buff1<span class="token punctuation">,</span>wt_buff1<span class="token punctuation">,</span>bias_buff<span class="token punctuation">[</span>com_block<span class="token punctuation">.</span>ch<span class="token operator">/</span>Tm<span class="token punctuation">]</span><span class="token punctuation">,</span>fm_out_buff1<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">store_output</span><span class="token punctuation">(</span>out1<span class="token punctuation">,</span>out2<span class="token punctuation">,</span>fm_out_buff2<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>store_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
			pp<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">update_three_block</span><span class="token punctuation">(</span>o_fm_size<span class="token punctuation">,</span>load_block<span class="token punctuation">,</span>com_block<span class="token punctuation">,</span>store_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    	<span class="token function">compute</span><span class="token punctuation">(</span>fm_in_buff2<span class="token punctuation">,</span>wt_buff2<span class="token punctuation">,</span>bias_buff<span class="token punctuation">[</span>com_block<span class="token punctuation">.</span>ch<span class="token operator">/</span>Tm<span class="token punctuation">]</span><span class="token punctuation">,</span>fm_out_buff2<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token function">store_output</span><span class="token punctuation">(</span>out1<span class="token punctuation">,</span>out2<span class="token punctuation">,</span>fm_out_buff1<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>store_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">//</span>
    	<span class="token function">update_three_block</span><span class="token punctuation">(</span>o_fm_size<span class="token punctuation">,</span>load_block<span class="token punctuation">,</span>com_block<span class="token punctuation">,</span>store_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token function">store_output</span><span class="token punctuation">(</span>out1<span class="token punctuation">,</span>out2<span class="token punctuation">,</span>fm_out_buff2<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>store_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    	<span class="token function">compute</span><span class="token punctuation">(</span>fm_in_buff1<span class="token punctuation">,</span>wt_buff1<span class="token punctuation">,</span>bias_buff<span class="token punctuation">[</span>com_block<span class="token punctuation">.</span>ch<span class="token operator">/</span>Tm<span class="token punctuation">]</span><span class="token punctuation">,</span>fm_out_buff1<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token function">store_output</span><span class="token punctuation">(</span>out1<span class="token punctuation">,</span>out2<span class="token punctuation">,</span>fm_out_buff2<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>store_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//</span>
    	<span class="token function">update_three_block</span><span class="token punctuation">(</span>o_fm_size<span class="token punctuation">,</span>load_block<span class="token punctuation">,</span>com_block<span class="token punctuation">,</span>store_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token function">store_output</span><span class="token punctuation">(</span>out1<span class="token punctuation">,</span>out2<span class="token punctuation">,</span>fm_out_buff1<span class="token punctuation">,</span>fm_size<span class="token punctuation">,</span>store_block<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里我们并没有直接使用DATAFLOW指令，而是通过显示的<strong>if-else</strong>加<strong>乒乓变量</strong>实现，综合结果表明，乒乓操作生效了，如下图所示</p> 
<p><img src="https://images2.imgbox.com/43/80/HO4udjnF_o.png" alt="在这里插入图片描述"><br> 同时，为了加快数据传输，我们将接口位宽增大为64bit，可一次性传输4个16bit的定点数，此外，我们还是用了多个传输接口，以进一步增大数据传输的带宽<br> <img src="https://images2.imgbox.com/1c/d8/5htCxw1Y_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="pwconv_310"></a>pwconv</h3> 
<p><strong>pwconv</strong>,即1x1的标准卷积，它不改变特征图的大小，只改变特征图的通道数，在MobileNet V2中，它起着升维和降维的作用，此外，mobilenet v2的主要计算量都集中在pwconv，因此，加速pwconv是最重要的。<br> 然而，不同于3x3标准卷积，pwconv实际上就是一个矩阵乘法，其计算/访存比较低，是<strong>memory-bounded</strong>的，因此，设计的思路主要就是增大数据传输的带宽，包括<strong>增大接口位宽</strong>、<strong>增大突发传输长度</strong>以及<strong>增加接口数目</strong>等。<br> 下面是加载输入特征的代码：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">load_input</span><span class="token punctuation">(</span>data_t fm_in_buff<span class="token punctuation">[</span>Tn<span class="token punctuation">]</span><span class="token punctuation">[</span>Tp<span class="token punctuation">]</span><span class="token punctuation">,</span>data_pack_t<span class="token operator">*</span> in1<span class="token punctuation">,</span>data_pack_t<span class="token operator">*</span> in2<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> n<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> basePixAddr<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> fm_size<span class="token punctuation">,</span><span class="token keyword">bool</span> flag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token comment">//load input tile In[n:n+Tn][basePixAddr:basePixAddr+Tp]</span>
<span class="token comment">//load In_interleave[n/4:n/4+1][basePixAddr:basePixAddr+Tp][:]</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> nn<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> length<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    	length<span class="token operator">=</span><span class="token number">49</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    	length<span class="token operator">=</span>Tp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">HLS PIPELINE</span></span>
    	data_pack_t tmp1<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>in1<span class="token operator">+</span><span class="token punctuation">(</span>n<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">*</span>fm_size<span class="token operator">*</span>fm_size<span class="token operator">+</span>basePixAddr<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	data_pack_t tmp2<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>in2<span class="token operator">+</span><span class="token punctuation">(</span>n<span class="token operator">/</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>fm_size<span class="token operator">*</span>fm_size<span class="token operator">+</span>basePixAddr<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span>Tn<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">HLS UNROLL</span></span>
    		fm_in_buff<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">=</span>tmp1<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		fm_in_buff<span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">+</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">=</span>tmp2<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，为了增加数据传输带宽，这里使用了两个接口(<strong>in1,in2</strong>)来并行的读取数据，并且每个接口，位宽都是<strong>64bit</strong>的，和HP接口的最大64bit相匹配，同时，两个接口的数据读取都是地址连续的，这样可以通过较长的突发传输长度，来抵消<strong>读地址通道握手所需的时间</strong>以及<strong>第一个数据读出所需等待的时间</strong>的开销。<br> 和dwconv一样，pwconv也通过乒乓操作来掩盖数据的传输时间：<br> <img src="https://images2.imgbox.com/66/08/b80ejj71_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_343"></a>硬件设计</h2> 
<p>在vivado中进行<strong>block design</strong>，结果如下：<br> <img src="https://images2.imgbox.com/3a/e3/6JHDyRlx_o.png" alt="在这里插入图片描述"><br> <strong>综合、实现、生成bitstream</strong></p> 
<h2><a id="SDK_347"></a>SDK设计</h2> 
<p>SDK代码如下，这里就不一一列出<br> <img src="https://images2.imgbox.com/fb/2a/yVI02NLP_o.png" alt="在这里插入图片描述"><br> 数据集和权重被存储在SD卡上，我们通过xilinx提供的<strong>ff.h</strong>中的API进行数据的读取，以下是整个工程的main文件</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"inference.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"pl_conv.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"xtime_l.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">GCC <span class="token function">optimize</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span></span><span class="token string">"Ofast"</span><span class="token expression"><span class="token punctuation">,</span></span><span class="token string">"inline"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//import!</span>
	<span class="token function">pl_pwconv_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hls_pwconv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pl_dwconv_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hls_dwconv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pl_shortcut_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hls_shortcut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pl_conv_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hls_conv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pl_fc_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hls_fc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> N<span class="token operator">=</span><span class="token number">250</span><span class="token punctuation">;</span>
    NetParam_q <span class="token operator">*</span>netParam<span class="token operator">=</span><span class="token punctuation">(</span>NetParam_q<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>NetParam_q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SpaceAllocateq</span><span class="token punctuation">(</span>netParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ReadParamq</span><span class="token punctuation">(</span><span class="token string">"weight\\"</span><span class="token punctuation">,</span>netParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">short</span><span class="token operator">*</span> image<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>N<span class="token operator">*</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">224</span><span class="token operator">*</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read_param_q</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span>N<span class="token operator">*</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">224</span><span class="token operator">*</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token string">"weight\\image.bin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span><span class="token operator">*</span> label<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token operator">*</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read_param</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span>N<span class="token punctuation">,</span><span class="token string">"weight\\label.bin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> correct<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">short</span> <span class="token operator">*</span>out<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Xil_DCacheFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"N=%d\n"</span><span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    XTime tEnd<span class="token punctuation">,</span> tCur<span class="token punctuation">;</span>
    u32 tUsed<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i=%d\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	    <span class="token function">XTime_GetTime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tCur<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">inference_q</span><span class="token punctuation">(</span>image<span class="token operator">+</span>i<span class="token operator">*</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">224</span><span class="token operator">*</span><span class="token number">224</span><span class="token punctuation">,</span>netParam<span class="token punctuation">,</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">XTime_GetTime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tUsed <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tEnd<span class="token operator">-</span>tCur<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>COUNTS_PER_SECOND<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">xil_printf</span><span class="token punctuation">(</span><span class="token string">"total time elapsed is %d us\r\n"</span><span class="token punctuation">,</span>tUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> max_idx<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> max_value<span class="token operator">=</span><span class="token operator">-</span><span class="token number">9999</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">&gt;</span>max_value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    max_value<span class="token operator">=</span>out<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    max_idx<span class="token operator">=</span>k<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>max_idx<span class="token operator">==</span>label<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                  correct<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,%d\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>max_idx<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>label<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test accuracy is %f\n"</span><span class="token punctuation">,</span>correct<span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SpaceDeleteq</span><span class="token punctuation">(</span>netParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>注意</strong>:不要忘了<strong>修改堆栈大小</strong>，否则无法读取这么多测试数据，整个程序会卡住</p> 
<h2><a id="_405"></a>结果</h2> 
<p>我们测试了250张图片，下图的结果表明，每张图片推理用时约为<strong>91ms</strong>，推理的准确率为98%(显然这个推理时间还能继续提升(只用了7020的一半资源))<br> <img src="https://images2.imgbox.com/c3/b5/6Hi04jxL_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eb85cd6565dbd2e53c0ea1cfd642567f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据挖掘——决策树和K近邻</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/03185afc2c385d719a58dd716b210934/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">构建YOCTO项目详细教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>