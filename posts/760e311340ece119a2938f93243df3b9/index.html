<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【单片机】基于STM32的UART串口通信 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【单片机】基于STM32的UART串口通信" />
<meta property="og:description" content="基于STM32的UART串口通信 一、前言二、UART相关知识1、UART简介2、UART通信协议3、UART功能说明（1）正常 USART 模式下，通过这些引脚以帧的形式发送和接收串行数据：（2）在同步模式下连接时需要以下引脚： 4、UART工作原理（1）发送接收（2）波特率产生（3）数据收发（4）中断控制（5）FIFO操作（6）回环操作 三、STM32CubeMx配置四、UART发送1、初始化说明2、HAL库函数说明3、代码实现UART发送（1）直接发送（2）字符串发送 五、UART接收1、初始化说明2、函数说明（1）CubeMx生成的UART中断处理函数（在stm32f1xx_it.c中）（2）HAL库函数HAL_UART_Transmit（在stm32f4xx_hal_uart.c中）（3）HAL库函数HAL_UART_Receive（在stm32f4xx_hal_uart.c中） 3、代码编写：实现UART接收（1）直接接收（不建议）（2）中断接收（接收并发送）（不推荐）（3）中断接收（先接收完，后处理）（推荐） 一、前言 简单讲解一下UART通信协议，以及UART能够实现的一些功能，还有有关使用STM32CubeMX来配置芯片的一些操作。实验内容基于正点原子精英板开发板，单片机芯片为STM32F103ZET6。
在后面我会以我使用的STM32F429开发板来举例讲解（其他STM32系列芯片大多数都可以按照这些步骤来操作的），如有不足请多多指教。
二、UART相关知识 1、UART简介 嵌入式开发中，UART串口通信协议是我们常用的通信协议（UART、I2C、SPI等）之一，全称叫做通用异步收发传输器（Universal Asynchronous Receiver/Transmitter），是异步串口通信协议的一种，工作原理是将传输数据的每个字符一位接一位地传输，它能将要传输的资料在串行通信与并行通信之间加以转换，能够灵活地与外部设备进行全双工数据交换。
类似的，USART（Universal Synchronous Asynchronous Receiver and Transmitter通用同步异步收发器）串口的，USART相当于UART的升级版，USART支持同步模式，因此USART 需要同步始终信号USART_CK（如STM32 单片机），通常情况同步信号很少使用，因此一般的单片机UART和USART使用方式是一样的，都使用异步模式。因为USART的使用方法上跟UART基本相同，所以在此就以UART来讲该通信协议了。
2、UART通信协议 起始位
当未有数据发送时，数据线处于逻辑“1”状态；先发出一个逻辑“0”信号，表示开始传输字符。数据位
紧接着起始位之后。资料位的个数可以是4、5、6、7、8等，构成一个字符。通常采用ASCII码。从最低位开始传送，靠时钟定位。奇偶校验位
资料为加上这一位后，使得“1”的位数应为偶数（偶校验）或奇数（奇校验），以此来校验资料传送的正确性。停止位
它是一个字符数据的结束标志。可以是1位、1.5位、2位的高电平。 由于数据是在传输线上定时的，并且每一个设备有其自己的时钟，很可能在通信中两台设备间出现了小小的不同步。因此停止位不仅仅是表示传输的结束，并且提供计算机校正时钟同步的机会。适用于停止位的位数越多，不同时钟同步的容忍程度越大，但是数据传输率同时也越慢。空闲位或起始位
处于逻辑“1”状态，表示当前线路上没有资料传送，进入空闲状态。
处于逻辑“0”状态，表示开始传送下一数据段。波特率
表示每秒钟传送的码元符号的个数，是衡量数据传送速率的指标，它用单位时间内载波调制状态改变的次数来表示。
常用的波特率有：9600、115200……
时间间隔计算：1秒除以波特率得出的时间，例如，波特率为9600的时间间隔为1s / 9600（波特率） = 104us。 3、UART功能说明 接口通过三个引脚从外部连接到其它设备。任何 USART 双向通信均需要 至少两个引脚：接收数据输入引脚 (RX) 和发送数据引脚输出 (TX)：
RX：接收数据输入引脚就是串行数据输入引脚。过采样技术可区分有效输入数据和噪声，从而用于恢复数据。
TX：发送数据输出引脚。如果关闭发送器，该输出引脚模式由其 I/O 端口配置决定。如果使 能了发送器但没有待发送的数据，则 TX 引脚处于高电平。在单线和智能卡模式下，该 I/O 用于发送和接收数据（USART 电平下，随后在 SW_RX 上接收数据）。
（1）正常 USART 模式下，通过这些引脚以帧的形式发送和接收串行数据： 发送或接收前保持空闲线路起始位数据（字长 8 位或 9 位），最低有效位在前用于指示帧传输已完成的 0.5 个、1 个、1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/760e311340ece119a2938f93243df3b9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-05T16:58:42+08:00" />
<meta property="article:modified_time" content="2023-06-05T16:58:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【单片机】基于STM32的UART串口通信</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>基于STM32的UART串口通信</h4> 
 <ul><li><a href="#_2" rel="nofollow">一、前言</a></li><li><a href="#UART_7" rel="nofollow">二、UART相关知识</a></li><li><ul><li><a href="#1UART_8" rel="nofollow">1、UART简介</a></li><li><a href="#2UART_13" rel="nofollow">2、UART通信协议</a></li><li><a href="#3UART_36" rel="nofollow">3、UART功能说明</a></li><li><ul><li><a href="#1_USART__40" rel="nofollow">（1）正常 USART 模式下，通过这些引脚以帧的形式发送和接收串行数据：</a></li><li><a href="#2_52" rel="nofollow">（2）在同步模式下连接时需要以下引脚：</a></li></ul> 
   </li><li><a href="#4UART_57" rel="nofollow">4、UART工作原理</a></li><li><ul><li><a href="#1_58" rel="nofollow">（1）发送接收</a></li><li><a href="#2_61" rel="nofollow">（2）波特率产生</a></li><li><a href="#3_63" rel="nofollow">（3）数据收发</a></li><li><a href="#4_71" rel="nofollow">（4）中断控制</a></li><li><a href="#5FIFO_81" rel="nofollow">（5）FIFO操作</a></li><li><a href="#6_91" rel="nofollow">（6）回环操作</a></li></ul> 
  </li></ul> 
  </li><li><a href="#STM32CubeMx_94" rel="nofollow">三、STM32CubeMx配置</a></li><li><a href="#UART_99" rel="nofollow">四、UART发送</a></li><li><ul><li><a href="#1_100" rel="nofollow">1、初始化说明</a></li><li><a href="#2HAL_179" rel="nofollow">2、HAL库函数说明</a></li><li><a href="#3UART_187" rel="nofollow">3、代码实现UART发送</a></li><li><ul><li><a href="#1_188" rel="nofollow">（1）直接发送</a></li><li><a href="#2_263" rel="nofollow">（2）字符串发送</a></li></ul> 
  </li></ul> 
  </li><li><a href="#UART_372" rel="nofollow">五、UART接收</a></li><li><ul><li><a href="#1_373" rel="nofollow">1、初始化说明</a></li><li><a href="#2_382" rel="nofollow">2、函数说明</a></li><li><ul><li><a href="#1CubeMxUARTstm32f1xx_itc_383" rel="nofollow">（1）CubeMx生成的UART中断处理函数（在stm32f1xx_it.c中）</a></li><li><a href="#2HALHAL_UART_Transmitstm32f4xx_hal_uartc_401" rel="nofollow">（2）HAL库函数HAL_UART_Transmit（在stm32f4xx_hal_uart.c中）</a></li><li><a href="#3HALHAL_UART_Receivestm32f4xx_hal_uartc_409" rel="nofollow">（3）HAL库函数HAL_UART_Receive（在stm32f4xx_hal_uart.c中）</a></li></ul> 
   </li><li><a href="#3UART_414" rel="nofollow">3、代码编写：实现UART接收</a></li><li><ul><li><a href="#1_415" rel="nofollow">（1）直接接收（不建议）</a></li><li><a href="#2_503" rel="nofollow">（2）中断接收（接收并发送）（不推荐）</a></li><li><a href="#3_588" rel="nofollow">（3）中断接收（先接收完，后处理）（推荐）</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>一、前言</h2> 
<p>简单讲解一下UART通信协议，以及UART能够实现的一些功能，还有有关使用STM32CubeMX来配置芯片的一些操作。实验内容基于<strong>正点原子精英板</strong>开发板，单片机芯片为<mark>STM32F103ZET6</mark>。<br> 在后面我会以我使用的STM32F429开发板来举例讲解（其他STM32系列芯片大多数都可以按照这些步骤来操作的），如有不足请多多指教。</p> 
<h2><a id="UART_7"></a>二、UART相关知识</h2> 
<h3><a id="1UART_8"></a>1、UART简介</h3> 
<p>嵌入式开发中，UART串口通信协议是我们常用的通信协议（UART、I2C、SPI等）之一，全称叫做通用异步收发传输器（Universal Asynchronous Receiver/Transmitter），是异步串口通信协议的一种，工作原理是将传输数据的每个字符一位接一位地传输，它能将要传输的资料在串行通信与并行通信之间加以转换，能够灵活地与外部设备进行全双工数据交换。<br> 类似的，USART（Universal Synchronous Asynchronous Receiver and Transmitter通用同步异步收发器）串口的，USART相当于UART的升级版，USART支持同步模式，因此USART 需要同步始终信号USART_CK（如STM32 单片机），通常情况同步信号很少使用，因此一般的单片机UART和USART使用方式是一样的，都使用异步模式。因为USART的使用方法上跟UART基本相同，所以在此就以UART来讲该通信协议了。</p> 
<h3><a id="2UART_13"></a>2、UART通信协议</h3> 
<p><img src="https://images2.imgbox.com/96/f7/q28x6gbQ_o.png" alt="在这里插入图片描述"></p> 
<ol><li><strong>起始位</strong><br> 当未有数据发送时，数据线处于逻辑“1”状态；先发出一个逻辑“0”信号，表示开始传输字符。</li><li><strong>数据位</strong><br> 紧接着起始位之后。资料位的个数可以是4、5、6、7、8等，构成一个字符。通常采用ASCII码。从最低位开始传送，靠时钟定位。</li><li><strong>奇偶校验位</strong><br> 资料为加上这一位后，使得“1”的位数应为偶数（偶校验）或奇数（奇校验），以此来校验资料传送的正确性。</li><li><strong>停止位</strong><br> 它是一个字符数据的结束标志。可以是1位、1.5位、2位的高电平。 由于数据是在传输线上定时的，并且每一个设备有其自己的时钟，很可能在通信中两台设备间出现了小小的不同步。因此停止位不仅仅是表示传输的结束，并且提供计算机校正时钟同步的机会。适用于停止位的位数越多，不同时钟同步的容忍程度越大，但是数据传输率同时也越慢。</li><li><strong>空闲位或起始位</strong><br> 处于逻辑“1”状态，表示当前线路上没有资料传送，进入空闲状态。<br> 处于逻辑“0”状态，表示开始传送下一数据段。</li><li><strong>波特率</strong><br> 表示每秒钟传送的码元符号的个数，是衡量数据传送速率的指标，它用单位时间内载波调制状态改变的次数来表示。<br> 常用的波特率有：9600、115200……<br> 时间间隔计算：1秒除以波特率得出的时间，例如，波特率为9600的时间间隔为1s / 9600（波特率） = 104us。</li></ol> 
<h3><a id="3UART_36"></a>3、UART功能说明</h3> 
<p>接口通过三个引脚从外部连接到其它设备。任何 USART 双向通信均需要 至少两个引脚：接收数据输入引脚 (RX) 和发送数据引脚输出 (TX)：<br> 　　RX：接收数据输入引脚就是串行数据输入引脚。过采样技术可区分有效输入数据和噪声，从而用于恢复数据。<br> 　　TX：发送数据输出引脚。如果关闭发送器，该输出引脚模式由其 I/O 端口配置决定。如果使 能了发送器但没有待发送的数据，则 TX 引脚处于高电平。在单线和智能卡模式下，该 I/O 用于发送和接收数据（USART 电平下，随后在 SW_RX 上接收数据）。</p> 
<h4><a id="1_USART__40"></a>（1）正常 USART 模式下，通过这些引脚以帧的形式发送和接收串行数据：</h4> 
<ul><li>发送或接收前保持空闲线路</li><li>起始位</li><li>数据（字长 8 位或 9 位），最低有效位在前</li><li>用于指示帧传输已完成的 0.5 个、1 个、1.5 个、2 个停止位</li><li>该接口使用小数波特率发生器 - 带 12 位尾数和 4 位小数</li><li>状态寄存器 (USART_SR)</li><li>数据寄存器 (USART_DR)</li><li>波特率寄存器 (USART_BRR) - 12 位尾数和 4 位小数</li><li>智能卡模式下的保护时间寄存器 (USART_GTPR)</li></ul> 
<h4><a id="2_52"></a>（2）在同步模式下连接时需要以下引脚：</h4> 
<ul><li>SCLK：发送器时钟输出。该引脚用于输出发送器数据时钟，以便按照 SPI 主模式进行同步发送（起始位和结束位上无时钟脉冲，可通过软件向最后一个数据位发送时钟脉冲）。RX 上可同步接收并行数据。这一点可用于控制带移位寄存器的外设（如 LCD 驱动器）。时钟相位和极性可通过软件编程。在智能卡模式下，SCLK 可向智能卡提供时钟。在硬件流控制模式下需要以下引脚：</li><li>nCTS：“清除以发送”用于在当前传输结束时阻止数据发送（高电平时）。</li><li>nRTS：“请求以发送”用于指示 USART 已准备好接收数据（低电平时）。</li></ul> 
<h3><a id="4UART_57"></a>4、UART工作原理</h3> 
<h4><a id="1_58"></a>（1）发送接收</h4> 
<p>发送逻辑对从发送FIFO 读取的数据执行“并→串”转换。控制逻辑输出起始位在先的串行位流，并且根据控制寄存器中已编程的配置，后面紧跟着数据位（注意：最低位 LSB 先输出）、奇偶校验位和停止位。<br> 在检测到一个有效的起始脉冲后，接收逻辑对接收到的位流执行“串→并”转换。此外还会对溢出错误、奇偶校验错误、帧错误和线中止（line-break）错误进行检测，并将检测到的状态附加到被写入接收FIFO 的数据中。</p> 
<h4><a id="2_61"></a>（2）波特率产生</h4> 
<p>波特率除数（baud-rate divisor）是一个22 位数，它由16 位整数和6 位小数组成。波特率发生器使用这两个值组成的数字来决定位周期。通过带有小数波特率的除法器，在足够高的系统时钟速率下，UART 可以产生所有标准的波特率，而误差很小。</p> 
<h4><a id="3_63"></a>（3）数据收发</h4> 
<p>发送时，数据被写入发送FIFO。如果UART 被使能，则会按照预先设置好的参数（波特率、数据位、停止位、校验位等）开始发送数据，一直到发送FIFO 中没有数据。一旦向发送FIFO 写数据（如果FIFO 未空），UART 的忙标志位BUSY 就有效，并且在发送数据期间一直保持有效。BUSY 位仅在发送FIFO 为空，且已从移位寄存器发送最后一个字符，包括停止位时才变无效。即 UART 不再使能，它也可以指示忙状态。</p> 
<p>在UART 接收器空闲时，如果数据输入变成“低电平”，即接收到了起始位，则接收计数器开始运行，并且数据在Baud16 的第8 个周期被采样。如果Rx 在Baud16 的第8 周期仍然为低电平，则起始位有效，否则会被认为是错误的起始位并将其忽略。<br> 　　<br> 如果起始位有效，则根据数据字符被编程的长度，在 Baud16 的每第 16 个周期（即一个位周期之后）对连续的数据位进行采样。如果奇偶校验模式使能，则还会检测奇偶校验位。</p> 
<p>最后，如果Rx 为高电平，则有效的停止位被确认，否则发生帧错误。当接收到一个完整的字符时，将数据存放在接收FIFO 中。</p> 
<h4><a id="4_71"></a>（4）中断控制</h4> 
<p>出现以下情况时，可使UART 产生中断：</p> 
<ul><li>FIFO 溢出错误</li><li>线中止错误（line-break，即Rx 信号一直为0 的状态，包括校验位和停止位在内）</li><li>奇偶校验错误</li><li>帧错误（停止位不为1）</li><li>接收超时（接收FIFO 已有数据但未满，而后续数据长时间不来）</li><li>发送</li><li>接收<br> 由于所有中断事件在发送到中断控制器之前会一起进行“或运算”操作，所以任意时刻 UART 只能向中断产生一个中断请求。通过查询中断状态函数，软件可以在同一个中断服务函数里处理多个中断事件（多个并列的if 语句）。</li></ul> 
<h4><a id="5FIFO_81"></a>（5）FIFO操作</h4> 
<p>FIFO 是“First-In First-Out”的缩写，意为“先进先出”，是一种常见的队列操作。 Stellaris 系列ARM 的UART 模块包含有2 个16 字节的FIFO：一个用于发送，另一个用于接收。可以将两个FIFO 分别配置为以不同深度触发中断。可供选择的配置包括：1/8、 1/4、1/2、3/4 和7/8 深度。例如，如果接收FIFO 选择1/4，则在UART 接收到4 个数据时产生接收中断。<br> 　<br> <strong>发送FIFO的基本工作过程：</strong> 只要有数据填充到发送FIFO 里，就会立即启动发送过程。由于发送本身是个相对缓慢的过程，因此在发送的同时其它需要发送的数据还可以继续填充到发送 FIFO 里。当发送 FIFO 被填满时就不能再继续填充了，否则会造成数据丢失，此时只能等待。这个等待并不会很久，以9600 的波特率为例，等待出现一个空位的时间在1ms 上下。发送 FIFO 会按照填入数据的先后顺序把数据一个个发送出去，直到发送 FIFO 全空时为止。已发送完毕的数据会被自动清除，在发送FIFO 里同时会多出一个空位。</p> 
<p><strong>接收FIFO的基本工作过程：</strong> 当硬件逻辑接收到数据时，就会往接收FIFO 里填充接收到的数据。程序应当及时取走这些数据，数据被取走也是在接收FIFO 里被自动删除的过程，因此在接收 FIFO 里同时会多出一个空位。如果在接收 FIFO 里的数据未被及时取走而造成接收FIFO 已满，则以后再接收到数据时因无空位可以填充而造成数据丢失。</p> 
<p>收发FIFO 主要是为了解决UART 收发中断过于频繁而导致CPU 效率不高的问题而引入的。在进行 UART 通信时，中断方式比轮询方式要简便且效率高。但是，如果没有收发 FIFO，则每收发一个数据都要中断处理一次，效率仍然不够高。如果有了收发FIFO，则可以在连续收发若干个数据（可多至14 个）后才产生一次中断然后一并处理，这就大大提高了收发效率。</p> 
<p>完全不必要担心FIFO 机制可能带来的数据丢失或得不到及时处理的问题，因为它已经帮你想到了收发过程中存在的任何问题，只要在初始化配置UART 后，就可以放心收发了， FIFO 和中断例程会自动搞定一切。</p> 
<h4><a id="6_91"></a>（6）回环操作</h4> 
<p>UART 可以进入一个内部回环（Loopback）模式，用于诊断或调试。在回环模式下，从Tx 上发送的数据将被Rx 输入端接收。</p> 
<h2><a id="STM32CubeMx_94"></a>三、STM32CubeMx配置</h2> 
<p>正常创建工程，启用USART1，相关设置如下：<br> <img src="https://images2.imgbox.com/c4/14/dThsHEDl_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="UART_99"></a>四、UART发送</h2> 
<h3><a id="1_100"></a>1、初始化说明</h3> 
<p>CubeMX生成的UART初始化代码（在usart.c中）</p> 
<pre><code class="prism language-c"><span class="token number">1</span> UART_HandleTypeDef huart1<span class="token punctuation">;</span>
 <span class="token number">2</span> 
 <span class="token number">3</span> <span class="token comment">/* USART1 init function */</span>
 <span class="token number">4</span> 
 <span class="token number">5</span> <span class="token keyword">void</span> <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
 <span class="token number">6</span> <span class="token punctuation">{<!-- --></span>
 <span class="token number">7</span> 
 <span class="token number">8</span>   huart1<span class="token punctuation">.</span>Instance <span class="token operator">=</span> USART1<span class="token punctuation">;</span>
 <span class="token number">9</span>   huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>BaudRate <span class="token operator">=</span> <span class="token number">115200</span><span class="token punctuation">;</span>
<span class="token number">10</span>   huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>WordLength <span class="token operator">=</span> UART_WORDLENGTH_8B<span class="token punctuation">;</span>
<span class="token number">11</span>   huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>StopBits <span class="token operator">=</span> UART_STOPBITS_1<span class="token punctuation">;</span>
<span class="token number">12</span>   huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Parity <span class="token operator">=</span> UART_PARITY_NONE<span class="token punctuation">;</span>
<span class="token number">13</span>   huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> UART_MODE_TX_RX<span class="token punctuation">;</span>
<span class="token number">14</span>   huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>HwFlowCtl <span class="token operator">=</span> UART_HWCONTROL_NONE<span class="token punctuation">;</span>
<span class="token number">15</span>   huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>OverSampling <span class="token operator">=</span> UART_OVERSAMPLING_16<span class="token punctuation">;</span>
<span class="token number">16</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token number">17</span>   <span class="token punctuation">{<!-- --></span>
<span class="token number">18</span>     <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span>   <span class="token punctuation">}</span>
<span class="token number">20</span> 
<span class="token number">21</span> <span class="token punctuation">}</span>
<span class="token number">22</span> 
<span class="token number">23</span> <span class="token keyword">void</span> <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>UART_HandleTypeDef<span class="token operator">*</span> uartHandle<span class="token punctuation">)</span>
<span class="token number">24</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">25</span> 
<span class="token number">26</span>   GPIO_InitTypeDef GPIO_InitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">27</span>   <span class="token keyword">if</span><span class="token punctuation">(</span>uartHandle<span class="token operator">-&gt;</span>Instance<span class="token operator">==</span>USART1<span class="token punctuation">)</span>
<span class="token number">28</span>   <span class="token punctuation">{<!-- --></span>
<span class="token number">29</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspInit 0 */</span>
<span class="token number">30</span> 
<span class="token number">31</span>   <span class="token comment">/* USER CODE END USART1_MspInit 0 */</span>
<span class="token number">32</span>     <span class="token comment">/* USART1 clock enable */</span>
<span class="token number">33</span>     <span class="token function">__HAL_RCC_USART1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">34</span>   
<span class="token number">35</span>     <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">36</span>     <span class="token comment">/**USART1 GPIO Configuration    
37     PA9     ------&gt; USART1_TX
38     PA10     ------&gt; USART1_RX 
39     */</span>
<span class="token number">40</span>     GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_9<span class="token operator">|</span>GPIO_PIN_10<span class="token punctuation">;</span>
<span class="token number">41</span>     GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>
<span class="token number">42</span>     GPIO_InitStruct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>
<span class="token number">43</span>     GPIO_InitStruct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_VERY_HIGH<span class="token punctuation">;</span>
<span class="token number">44</span>     GPIO_InitStruct<span class="token punctuation">.</span>Alternate <span class="token operator">=</span> GPIO_AF7_USART1<span class="token punctuation">;</span>
<span class="token number">45</span>     <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">46</span> 
<span class="token number">47</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspInit 1 */</span>
<span class="token number">48</span> 
<span class="token number">49</span>   <span class="token comment">/* USER CODE END USART1_MspInit 1 */</span>
<span class="token number">50</span>   <span class="token punctuation">}</span>
<span class="token number">51</span> <span class="token punctuation">}</span>
<span class="token number">52</span> 
<span class="token number">53</span> <span class="token keyword">void</span> <span class="token function">HAL_UART_MspDeInit</span><span class="token punctuation">(</span>UART_HandleTypeDef<span class="token operator">*</span> uartHandle<span class="token punctuation">)</span>
<span class="token number">54</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">55</span> 
<span class="token number">56</span>   <span class="token keyword">if</span><span class="token punctuation">(</span>uartHandle<span class="token operator">-&gt;</span>Instance<span class="token operator">==</span>USART1<span class="token punctuation">)</span>
<span class="token number">57</span>   <span class="token punctuation">{<!-- --></span>
<span class="token number">58</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspDeInit 0 */</span>
<span class="token number">59</span> 
<span class="token number">60</span>   <span class="token comment">/* USER CODE END USART1_MspDeInit 0 */</span>
<span class="token number">61</span>     <span class="token comment">/* Peripheral clock disable */</span>
<span class="token number">62</span>     <span class="token function">__HAL_RCC_USART1_CLK_DISABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">63</span>   
<span class="token number">64</span>     <span class="token comment">/**USART1 GPIO Configuration    
65     PA9     ------&gt; USART1_TX
66     PA10     ------&gt; USART1_RX 
67     */</span>
<span class="token number">68</span>     <span class="token function">HAL_GPIO_DeInit</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PIN_9<span class="token operator">|</span>GPIO_PIN_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">69</span> 
<span class="token number">70</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspDeInit 1 */</span>
<span class="token number">71</span> 
<span class="token number">72</span>   <span class="token comment">/* USER CODE END USART1_MspDeInit 1 */</span>
<span class="token number">73</span>   <span class="token punctuation">}</span>
<span class="token number">74</span> <span class="token punctuation">}</span> 
USART init
</code></pre> 
<h3><a id="2HAL_179"></a>2、HAL库函数说明</h3> 
<p>HAL_UART_Transmit（在stm32f4xx_hal_uart.c中），该函数能够通过huart串口发送Size位pData数据。<br> <strong>参数说明：</strong></p> 
<ul><li>huart ：选择用来发送的UART串口</li><li>pData ：指向将要发送的数据的指针</li><li>Size ：发送数据的大小</li><li>Timeout：超时时间</li></ul> 
<h3><a id="3UART_187"></a>3、代码实现UART发送</h3> 
<h4><a id="1_188"></a>（1）直接发送</h4> 
<p>在main主函数中定义一个数组：</p> 
<pre><code class="prism language-c"><span class="token number">1</span>   <span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token number">2</span>     <span class="token keyword">unsigned</span> <span class="token keyword">char</span> uTx_Data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x45</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">//数组内十六进制代表“ABCDE”</span>
<span class="token number">3</span>   <span class="token comment">/* USER CODE END 1 */</span>
</code></pre> 
<p>在main主函数中的while循环中调用HAL库UART发送函数：</p> 
<pre><code class="prism language-c"><span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* UART发送 */</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> uTx_Data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uTx_Data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 延迟1s */</span>
        <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END 3 */</span>
</code></pre> 
<p>整体的main函数如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN 1 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> uTx_Data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x45</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">//数组内十六进制代表“ABCDE”</span>
  <span class="token comment">/* USER CODE END 1 */</span>


  <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>

  <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
  <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN Init */</span>

  <span class="token comment">/* USER CODE END Init */</span>

  <span class="token comment">/* Configure the system clock */</span>
  <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN SysInit */</span>

  <span class="token comment">/* USER CODE END SysInit */</span>

  <span class="token comment">/* Initialize all configured peripherals */</span>
  <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 2 */</span>

  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* UART发送 */</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> uTx_Data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uTx_Data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 延迟1s */</span>
        <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END 3 */</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过编译下载，可在串口助手中显示发送的数据：<br> <img src="https://images2.imgbox.com/dd/66/fBLqwdgJ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_263"></a>（2）字符串发送</h4> 
<p>前面的发送方式，不仅要传入句柄参数，还有数组、长度、超时时间参数。</p> 
<p>为了简便发送，我们可以专门写一个字符串发送函数，可以直接传入一个数组即可发送，可以更简便地实现字符串发送。</p> 
<p>优点是，发送数据更简便，能够一次性发送很长的数据数组。</p> 
<p>但缺点就是不能控制发送的长度，会将整个数据数组发出。</p> 
<p><strong>在Uart.c中添加vUser_UART_SendString函数</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">void</span> <span class="token function">vUser_UART_SendString</span><span class="token punctuation">(</span>UART_HandleTypeDef<span class="token operator">*</span> uartHandle<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> uData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* -1- 判断数据是否发送完毕 */</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>uData<span class="token punctuation">)</span>        <span class="token comment">//若为空即发送完毕，若不为空则还有数据</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* -2- 发送1Byte */</span>
        <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span>uartHandle<span class="token punctuation">,</span> uData<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* -3- 移至下1Byte */</span>
        uData<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span>
</code></pre> 
<p><strong>在Uart.h中声明一下vUser_UART_SendString函数（声明后就可以在别的地方调用该函数）</strong></p> 
<pre><code class="prism language-c"><span class="token number">1</span> <span class="token comment">/* USER CODE BEGIN Prototypes */</span>
<span class="token number">2</span> <span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vUser_UART_SendString</span><span class="token punctuation">(</span>UART_HandleTypeDef<span class="token operator">*</span> uartHandle<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> uData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3</span> <span class="token comment">/* USER CODE END Prototypes */</span>
</code></pre> 
<p><strong>在main主函数中定义一个数组</strong></p> 
<pre><code class="prism language-c"><span class="token number">1</span>   <span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token number">2</span>     <span class="token keyword">unsigned</span> <span class="token keyword">char</span> uTx_Data<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\r\n Hallo World！ 你好，世界！"</span><span class="token punctuation">;</span>
<span class="token number">3</span>   <span class="token comment">/* USER CODE END 1 */</span>
</code></pre> 
<p><strong>在main主函数的while循环中调用字符串发送函数</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* 字符串发送 */</span>
      <span class="token function">vUser_UART_SendString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> uTx_Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 延迟1s */</span>
        <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END 3 */</span>
</code></pre> 
<p><strong>整个main函数如下：</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN 1 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> uTx_Data<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\r\n Hallo World！ 你好，世界！"</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END 1 */</span>


  <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>

  <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
  <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN Init */</span>

  <span class="token comment">/* USER CODE END Init */</span>

  <span class="token comment">/* Configure the system clock */</span>
  <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN SysInit */</span>

  <span class="token comment">/* USER CODE END SysInit */</span>

  <span class="token comment">/* Initialize all configured peripherals */</span>
  <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 2 */</span>

  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* UART发送 */</span>
      <span class="token function">vUser_UART_SendString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> uTx_Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 延迟1s */</span>
        <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END 3 */</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编译下载后在串口助手中显示如下：<br> <img src="https://images2.imgbox.com/47/71/TH8Kiwy3_o.png" alt="在这里插入图片描述"><br> 这种发送方式就是相当于编写c语言的时候，在小黑框中打印自己想要打印的东西；通过printf发送，我们也可以在串口助手上实现一样的功能。</p> 
<h2><a id="UART_372"></a>五、UART接收</h2> 
<h3><a id="1_373"></a>1、初始化说明</h3> 
<p>UART接收在原本配置CubeMx的基础上，添加一些UART的中断配置来实现中断接收操作。</p> 
<p><strong>使能串口中断</strong><br> <img src="https://images2.imgbox.com/75/9b/NGMk8Vn5_o.png" alt="在这里插入图片描述"><br> <strong>设置中断优先级（如果没开启其他中断，那就默认即可，直接跳过）</strong><br> <img src="https://images2.imgbox.com/16/5a/1diWYWZW_o.png" alt="在这里插入图片描述"><br> <strong>重新生成代码</strong></p> 
<h3><a id="2_382"></a>2、函数说明</h3> 
<h4><a id="1CubeMxUARTstm32f1xx_itc_383"></a>（1）CubeMx生成的UART中断处理函数（在stm32f1xx_it.c中）</h4> 
<p>当USART1发生中断事件时，程序会进行该函数，所以我们会在这个函数编写好程序，来处理我们的中断事件。</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * @brief This function handles USART1 global interrupt.
  */</span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN USART1_IRQn 0 */</span>

  <span class="token comment">/* USER CODE END USART1_IRQn 0 */</span>
  <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN USART1_IRQn 1 */</span>

  <span class="token comment">/* USER CODE END USART1_IRQn 1 */</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2HALHAL_UART_Transmitstm32f4xx_hal_uartc_401"></a>（2）HAL库函数HAL_UART_Transmit（在stm32f4xx_hal_uart.c中）</h4> 
<p>该函数能够通过huart串口发送Size位pData数据。<br> <strong>参数说明：</strong></p> 
<ul><li>huart ：选择用来发送的UART串口</li><li>pData ：指向将要发送的数据的指针</li><li>Size ：发送数据的大小</li><li>Timeout：超时时间</li></ul> 
<h4><a id="3HALHAL_UART_Receivestm32f4xx_hal_uartc_409"></a>（3）HAL库函数HAL_UART_Receive（在stm32f4xx_hal_uart.c中）</h4> 
<ul><li>huart ：选择用来接收的UART串口</li><li>pData ：指向将要存放数据的指针</li><li>Size ：发送数据的大小</li><li>Timeout：超时时间</li></ul> 
<h3><a id="3UART_414"></a>3、代码编写：实现UART接收</h3> 
<h4><a id="1_415"></a>（1）直接接收（不建议）</h4> 
<p>1）在main主函数中定义一个变量，负责接收数据</p> 
<pre><code class="prism language-c"><span class="token number">1</span>   <span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token number">2</span>     <span class="token keyword">unsigned</span> <span class="token keyword">char</span> uRx_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">3</span>   <span class="token comment">/* USER CODE END 1 */</span>
</code></pre> 
<p>2）在main主函数while循环中调用HAL库UART接收函数</p> 
<pre><code class="prism language-c"><span class="token number">1</span>   <span class="token comment">/* Infinite loop */</span>
 <span class="token number">2</span>   <span class="token comment">/* USER CODE BEGIN WHILE */</span>
 <span class="token number">3</span>   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token number">4</span>   <span class="token punctuation">{<!-- --></span>
 <span class="token number">5</span>         <span class="token comment">/* 判断是否接收成功 */</span>
 <span class="token number">6</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_UART_Receive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">==</span> HAL_OK<span class="token punctuation">)</span>
 <span class="token number">7</span>         <span class="token punctuation">{<!-- --></span>
 <span class="token number">8</span>             <span class="token comment">/* 将接收成功的数据通过串口发出来 */</span>
 <span class="token number">9</span>             <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span>         <span class="token punctuation">}</span>
<span class="token number">11</span>         
<span class="token number">12</span>     <span class="token comment">/* USER CODE END WHILE */</span>
<span class="token number">13</span> 
<span class="token number">14</span>     <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token number">15</span>   <span class="token punctuation">}</span>
<span class="token number">16</span>   <span class="token comment">/* USER CODE END 3 */</span>
</code></pre> 
<p>整个main函数如下：</p> 
<pre><code class="prism language-c"><span class="token number">1</span> <span class="token comment">/**
 2   * @brief  The application entry point.
 3   * @retval int
 4   */</span>
 <span class="token number">5</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
 <span class="token number">6</span> <span class="token punctuation">{<!-- --></span>
 <span class="token number">7</span>   <span class="token comment">/* USER CODE BEGIN 1 */</span>
 <span class="token number">8</span>     <span class="token keyword">unsigned</span> <span class="token keyword">char</span> uRx_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token number">9</span>   <span class="token comment">/* USER CODE END 1 */</span>
<span class="token number">10</span>   
<span class="token number">11</span> 
<span class="token number">12</span>   <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>
<span class="token number">13</span> 
<span class="token number">14</span>   <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
<span class="token number">15</span>   <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span> 
<span class="token number">17</span>   <span class="token comment">/* USER CODE BEGIN Init */</span>
<span class="token number">18</span> 
<span class="token number">19</span>   <span class="token comment">/* USER CODE END Init */</span>
<span class="token number">20</span> 
<span class="token number">21</span>   <span class="token comment">/* Configure the system clock */</span>
<span class="token number">22</span>   <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">23</span> 
<span class="token number">24</span>   <span class="token comment">/* USER CODE BEGIN SysInit */</span>
<span class="token number">25</span> 
<span class="token number">26</span>   <span class="token comment">/* USER CODE END SysInit */</span>
<span class="token number">27</span> 
<span class="token number">28</span>   <span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token number">29</span>   <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">30</span>   <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">31</span>   <span class="token comment">/* USER CODE BEGIN 2 */</span>
<span class="token number">32</span> 
<span class="token number">33</span>   <span class="token comment">/* USER CODE END 2 */</span>
<span class="token number">34</span> 
<span class="token number">35</span>   <span class="token comment">/* Infinite loop */</span>
<span class="token number">36</span>   <span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token number">37</span>   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">38</span>   <span class="token punctuation">{<!-- --></span>
<span class="token number">39</span>         <span class="token comment">/* 判断是否接收成功 */</span>
<span class="token number">40</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_UART_Receive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">==</span> HAL_OK<span class="token punctuation">)</span>
<span class="token number">41</span>         <span class="token punctuation">{<!-- --></span>
<span class="token number">42</span>             <span class="token comment">/* 将接收成功的数据通过串口发出来 */</span>
<span class="token number">43</span>             <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">44</span>         <span class="token punctuation">}</span>
<span class="token number">45</span>         
<span class="token number">46</span>     <span class="token comment">/* USER CODE END WHILE */</span>
<span class="token number">47</span> 
<span class="token number">48</span>     <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token number">49</span>   <span class="token punctuation">}</span>
<span class="token number">50</span>   <span class="token comment">/* USER CODE END 3 */</span>
<span class="token number">51</span> <span class="token punctuation">}</span>
</code></pre> 
<p>3）编译、下载烧写后实现效果如下<br> <img src="https://images2.imgbox.com/ad/d2/C1pj1UD4_o.png" alt="在这里插入图片描述"><br> 这种接收方式是直接在main函数里的while循环里不断接收，会<strong>严重占用程序的进程</strong>，且接收较长的数据时，会发生接收错误，如下：<br> <img src="https://images2.imgbox.com/6a/25/mR9Qflpu_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_503"></a>（2）中断接收（接收并发送）（不推荐）</h4> 
<p>1）在HAL_UART_MspInit（在usart.c中）使能接收中断</p> 
<pre><code class="prism language-c"><span class="token number">1</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspInit 1 */</span>
<span class="token number">2</span>     <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>uartHandle<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3</span>   <span class="token comment">/* USER CODE END USART1_MspInit 1 */</span>
</code></pre> 
<p>整个HAL_UART_MspInit函数如下：</p> 
<pre><code class="prism language-c"><span class="token number">1</span> <span class="token keyword">void</span> <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>UART_HandleTypeDef<span class="token operator">*</span> uartHandle<span class="token punctuation">)</span>
 <span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
 <span class="token number">3</span> 
 <span class="token number">4</span>   GPIO_InitTypeDef GPIO_InitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token number">5</span>   <span class="token keyword">if</span><span class="token punctuation">(</span>uartHandle<span class="token operator">-&gt;</span>Instance<span class="token operator">==</span>USART1<span class="token punctuation">)</span>
 <span class="token number">6</span>   <span class="token punctuation">{<!-- --></span>
 <span class="token number">7</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspInit 0 */</span>
 <span class="token number">8</span> 
 <span class="token number">9</span>   <span class="token comment">/* USER CODE END USART1_MspInit 0 */</span>
<span class="token number">10</span>     <span class="token comment">/* USART1 clock enable */</span>
<span class="token number">11</span>     <span class="token function">__HAL_RCC_USART1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">12</span>   
<span class="token number">13</span>     <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span>     <span class="token comment">/**USART1 GPIO Configuration    
15     PA9     ------&gt; USART1_TX
16     PA10     ------&gt; USART1_RX 
17     */</span>
<span class="token number">18</span>     GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_9<span class="token operator">|</span>GPIO_PIN_10<span class="token punctuation">;</span>
<span class="token number">19</span>     GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>
<span class="token number">20</span>     GPIO_InitStruct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>
<span class="token number">21</span>     GPIO_InitStruct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_VERY_HIGH<span class="token punctuation">;</span>
<span class="token number">22</span>     GPIO_InitStruct<span class="token punctuation">.</span>Alternate <span class="token operator">=</span> GPIO_AF7_USART1<span class="token punctuation">;</span>
<span class="token number">23</span>     <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">24</span> 
<span class="token number">25</span>     <span class="token comment">/* USART1 interrupt Init */</span>
<span class="token number">26</span>     <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">27</span>     <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">28</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspInit 1 */</span>
<span class="token number">29</span>     <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>uartHandle<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">30</span>   <span class="token comment">/* USER CODE END USART1_MspInit 1 */</span>
<span class="token number">31</span>   <span class="token punctuation">}</span>
<span class="token number">32</span> <span class="token punctuation">}</span>
</code></pre> 
<p>2）在USART1_IRQHandler（在stm32f4xx_it.c中）定义一个变量，负责接收数据</p> 
<pre><code class="prism language-c"><span class="token number">1</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> uRx_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<p>3）在USART1_IRQHandler（在stm32f4xx_it.c中）调用HAL库的UART接收函数以及发送函数</p> 
<pre><code class="prism language-c"><span class="token number">1</span>     <span class="token comment">/* -1- 接收 */</span>
<span class="token number">2</span>     <span class="token function">HAL_UART_Receive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3</span>     <span class="token comment">/* -2- 将接收成功的数据通过串口发出去 */</span>
<span class="token number">4</span>     <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>整个USART1_IRQHandler（在stm32f4xx_it.c中）函数如下：</p> 
<pre><code class="prism language-c"><span class="token number">1</span> <span class="token comment">/**
 2   * @brief This function handles USART1 global interrupt.
 3   */</span>
 <span class="token number">4</span> <span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
 <span class="token number">5</span> <span class="token punctuation">{<!-- --></span>
 <span class="token number">6</span>   <span class="token comment">/* USER CODE BEGIN USART1_IRQn 0 */</span>
 <span class="token number">7</span>     <span class="token keyword">unsigned</span> <span class="token keyword">char</span> uRx_Data<span class="token punctuation">;</span>
 <span class="token number">8</span>     
 <span class="token number">9</span>     <span class="token comment">/* -1- 接收 */</span>
<span class="token number">10</span>     <span class="token function">HAL_UART_Receive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span>     <span class="token comment">/* -2- 将接收成功的数据通过串口发出去 */</span>
<span class="token number">12</span>     <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span>     
<span class="token number">14</span>   <span class="token comment">/* USER CODE END USART1_IRQn 0 */</span>
<span class="token number">15</span>   <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span>   <span class="token comment">/* USER CODE BEGIN USART1_IRQn 1 */</span>
<span class="token number">17</span> 
<span class="token number">18</span>   <span class="token comment">/* USER CODE END USART1_IRQn 1 */</span>
<span class="token number">19</span> <span class="token punctuation">}</span>
</code></pre> 
<p>4）编译、下载烧写实现效果如下<br> <img src="https://images2.imgbox.com/c4/c5/LKsNdXHC_o.png" alt="在这里插入图片描述"><br> 相对于前面的直接接收方式，该中断接收方式就显得特别人性化了，在没有什么特别事件的时候，单片机会按照原本的程序运行着，等到有数据从UART串口发送过来时，会马上进入UART串口的中断处理函数中，完成相应的中断处理操作，完成后会退出中断函数，并继续原本在进行的程序，这样就不会占用单片机程序太多的进程了。</p> 
<p>但仍会发生前面直接接收方式的<strong>接收异常状况</strong>，主要原因是，在中断处理函数中，我们在接收了数据后并紧接着作出发送的操作，这会出现一个状况，还没来得及将上一次接收到的数据发送出去，就进入下一次接收的中断，然而导致失去了一些数据了。</p> 
<h4><a id="3_588"></a>（3）中断接收（先接收完，后处理）（推荐）</h4> 
<p>这种接收方式，是在方式2的基础上稍作改进的，较于前两种接收方式，是更好的一种接收方式，不会给原本的程序进程造成太大影响。还可以先接收全部数据（提示：通过定义一个较大的数组来存储），再将数据进行处理，这样能确保接收数据的完整性，并能将数据进行有效的处理、分析。</p> 
<p>既然这种方式明显会好一点，那为什么一开始不用这个方式呢？因为通过前面两种方法，可以更容易明白UART接收的操作。</p> 
<p>而这次就只要在方式2的基础上作出一些简单的修改就可以了。</p> 
<p>1）在HAL_UART_MspInit（在usart.c中）使能接收中断（与方式2相同）</p> 
<pre><code class="prism language-c"><span class="token number">1</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspInit 1 */</span>
<span class="token number">2</span>     <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>uartHandle<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3</span>   <span class="token comment">/* USER CODE END USART1_MspInit 1 */</span>
</code></pre> 
<p>整个HAL_UART_MspInit（在usart.c中）函数如下：</p> 
<pre><code class="prism language-c"><span class="token number">1</span> <span class="token keyword">void</span> <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>UART_HandleTypeDef<span class="token operator">*</span> uartHandle<span class="token punctuation">)</span>
 <span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
 <span class="token number">3</span> 
 <span class="token number">4</span>   GPIO_InitTypeDef GPIO_InitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token number">5</span>   <span class="token keyword">if</span><span class="token punctuation">(</span>uartHandle<span class="token operator">-&gt;</span>Instance<span class="token operator">==</span>USART1<span class="token punctuation">)</span>
 <span class="token number">6</span>   <span class="token punctuation">{<!-- --></span>
 <span class="token number">7</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspInit 0 */</span>
 <span class="token number">8</span> 
 <span class="token number">9</span>   <span class="token comment">/* USER CODE END USART1_MspInit 0 */</span>
<span class="token number">10</span>     <span class="token comment">/* USART1 clock enable */</span>
<span class="token number">11</span>     <span class="token function">__HAL_RCC_USART1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">12</span>   
<span class="token number">13</span>     <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span>     <span class="token comment">/**USART1 GPIO Configuration    
15     PA9     ------&gt; USART1_TX
16     PA10     ------&gt; USART1_RX 
17     */</span>
<span class="token number">18</span>     GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_9<span class="token operator">|</span>GPIO_PIN_10<span class="token punctuation">;</span>
<span class="token number">19</span>     GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>
<span class="token number">20</span>     GPIO_InitStruct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>
<span class="token number">21</span>     GPIO_InitStruct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_VERY_HIGH<span class="token punctuation">;</span>
<span class="token number">22</span>     GPIO_InitStruct<span class="token punctuation">.</span>Alternate <span class="token operator">=</span> GPIO_AF7_USART1<span class="token punctuation">;</span>
<span class="token number">23</span>     <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">24</span> 
<span class="token number">25</span>     <span class="token comment">/* USART1 interrupt Init */</span>
<span class="token number">26</span>     <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">27</span>     <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">28</span>   <span class="token comment">/* USER CODE BEGIN USART1_MspInit 1 */</span>
<span class="token number">29</span>     <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>uartHandle<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">30</span>   <span class="token comment">/* USER CODE END USART1_MspInit 1 */</span>
<span class="token number">31</span>   <span class="token punctuation">}</span>
<span class="token number">32</span> <span class="token punctuation">}</span>
</code></pre> 
<p>2）在USART1_IRQHandler（在stm32f4xx_it.c中）定义三个静态变量</p> 
<pre><code class="prism language-c"><span class="token number">1</span>     <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>     uRx_Data<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span>     <span class="token punctuation">;</span>    <span class="token comment">//存储数组</span>
<span class="token number">2</span>     <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  <span class="token operator">*</span>  pRx_Data       <span class="token operator">=</span> uRx_Data<span class="token punctuation">;</span>    <span class="token comment">//指向存储数组将要存储数据的位</span>
<span class="token number">3</span>     <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>     uLength        <span class="token operator">=</span>  <span class="token number">0</span>  
</code></pre> 
<p>3）在USART1_IRQHandler（在stm32f4xx_it.c中）调用HAL库的UART接收函数以及发送函数</p> 
<p><strong>注：</strong><br> 　　如下的第2、3步都可以根据自身要求进行改进。</p> 
<ul><li> <p>第2步：判断接收结束条件，这个可以根据自己想要接收何种类型的数据而定。</p> </li><li> <p>第3步：数据处理，大家可以在这一步执行自己想要对数据做的一些操作，我这里只是将接收到的数据重新发送出去而已。</p> </li></ul> 
<pre><code class="prism language-c"><span class="token number">1</span>     <span class="token comment">/* -1- 接收数据 */</span>
 <span class="token number">2</span>     <span class="token function">HAL_UART_Receive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> pRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">3</span>     
 <span class="token number">4</span>     <span class="token comment">/* -2- 判断数据结尾 */</span>
 <span class="token number">5</span>     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>pRx_Data <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span>
 <span class="token number">6</span>     <span class="token punctuation">{<!-- --></span>
 <span class="token number">7</span>         <span class="token comment">/* -3- 将接收成功的数据通过串口发出去 */</span>
 <span class="token number">8</span>         <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> uRx_Data<span class="token punctuation">,</span> uLength<span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">9</span>         
<span class="token number">10</span>         <span class="token comment">/* -4- 初始化指针和数据长度 */</span>
<span class="token number">11</span>         pRx_Data <span class="token operator">=</span> uRx_Data<span class="token punctuation">;</span>  <span class="token comment">//重新指向数组起始位置</span>
<span class="token number">12</span>         uLength  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>         <span class="token comment">//长度清零</span>
<span class="token number">13</span>     <span class="token punctuation">}</span>
<span class="token number">14</span>     <span class="token comment">/* -5- 若未结束，指针往下一位移动，长度自增一 */</span>
<span class="token number">15</span>     <span class="token keyword">else</span>
<span class="token number">16</span>     <span class="token punctuation">{<!-- --></span>
<span class="token number">17</span>         pRx_Data<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">18</span>         uLength<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">19</span>     <span class="token punctuation">}</span>
</code></pre> 
<p>整个USART1_IRQHandler（在stm32f4xx_it.c中）函数如下：</p> 
<pre><code class="prism language-c"><span class="token number">1</span> <span class="token comment">/**
 2   * @brief This function handles USART1 global interrupt.
 3   */</span>
 <span class="token number">4</span> <span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
 <span class="token number">5</span> <span class="token punctuation">{<!-- --></span>
 <span class="token number">6</span>   <span class="token comment">/* USER CODE BEGIN USART1_IRQn 0 */</span>
 <span class="token number">7</span>     <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   uRx_Data<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span>     <span class="token punctuation">;</span>    <span class="token comment">//存储数组</span>
 <span class="token number">8</span>     <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> pRx_Data       <span class="token operator">=</span> uRx_Data<span class="token punctuation">;</span>    <span class="token comment">//指向存储数组将要存储数据的位</span>
 <span class="token number">9</span>     <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   uLength        <span class="token operator">=</span>  <span class="token number">0</span>      <span class="token punctuation">;</span>    <span class="token comment">//接收数据长度</span>
<span class="token number">10</span>     
<span class="token number">11</span>     <span class="token comment">/* -1- 接收数据 */</span>
<span class="token number">12</span>     <span class="token function">HAL_UART_Receive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> pRx_Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span>     
<span class="token number">14</span>     <span class="token comment">/* -2- 判断数据结尾 */</span>
<span class="token number">15</span>     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>pRx_Data <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span>
<span class="token number">16</span>     <span class="token punctuation">{<!-- --></span>
<span class="token number">17</span>         <span class="token comment">/* -3- 将接收成功的数据通过串口发出去 */</span>
<span class="token number">18</span>         <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> uRx_Data<span class="token punctuation">,</span> uLength<span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span>         
<span class="token number">20</span>         <span class="token comment">/* -4- 初始化指针和数据长度 */</span>
<span class="token number">21</span>         pRx_Data <span class="token operator">=</span> uRx_Data<span class="token punctuation">;</span>   <span class="token comment">//重新指向数组起始位置</span>
<span class="token number">22</span>         uLength  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">//长度清零</span>
<span class="token number">23</span>     <span class="token punctuation">}</span>
<span class="token number">24</span>     <span class="token comment">/* -5- 若未结束，指针往下一位移动，长度自增一 */</span>
<span class="token number">25</span>     <span class="token keyword">else</span>
<span class="token number">26</span>     <span class="token punctuation">{<!-- --></span>
<span class="token number">27</span>         pRx_Data<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">28</span>         uLength<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">29</span>     <span class="token punctuation">}</span>
<span class="token number">30</span>     
<span class="token number">31</span>     
<span class="token number">32</span>   <span class="token comment">/* USER CODE END USART1_IRQn 0 */</span>
<span class="token number">33</span>   <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">34</span>   <span class="token comment">/* USER CODE BEGIN USART1_IRQn 1 */</span>
<span class="token number">35</span> 
<span class="token number">36</span>   <span class="token comment">/* USER CODE END USART1_IRQn 1 */</span>
<span class="token number">37</span> <span class="token punctuation">}</span>
</code></pre> 
<p>4）编译、下载烧写后实现效果如下<br> <img src="https://images2.imgbox.com/10/5a/Ip7RCrBx_o.png" alt="在这里插入图片描述"><br> <strong>除了上面的方法，还有DMA接收方法没介绍。</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fabad127b82bab0def252fa8016e193a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">STM32开发——简介、开发环境（Keil5、CubeMX）、HAL库</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/616cd962ca454edc5985c8172b0c2c17/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GNU/POSIX</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>