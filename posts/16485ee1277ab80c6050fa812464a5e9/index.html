<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>快速上手Android蓝牙串口开发 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="快速上手Android蓝牙串口开发" />
<meta property="og:description" content="/ 今日科技快讯 /
近日，快手科技与京东零售集团正式签署战略合作协议。双方将在快手小店的供应链能力打造、品牌营销和数据能力共建等方面展开深入合作，共同打造短视频直播电商新生态。
/ 作者简介 /
本篇文章来自gtf35的投稿，分享了Android中的蓝牙开发的内容，相信会对大家有所帮助！同时也感谢作者贡献的精彩文章。
gtf35的博客地址：
https://blog.gtf35.top/
/ 前言 /
最近在做做物联网相关的内容，经常需要用到蓝牙串口来和单片机通讯。引出了几个问题：
蓝牙串口是什么？
如何扫描蓝牙设备
如何连接蓝牙设备
如何收发串口数据
/ 蓝牙串口是什么？ /
先介绍下串口，串行接口简称串口，就是一种通信的方式，类似于「USB」，只是比USB低级多了。但是手机等设备他没外置这个串口，解决方式就是手机用蓝牙连接一个小硬件，小硬件有个串口，他的和单片机连接，来达到手机和单片机的串口连接，这种方式就是蓝牙串口。
在开发之前你最好有那个小硬件，那个小硬件通常叫「蓝牙透传模块」，淘宝不到30块钱就能买一个。我的长这样，有专用的上位机，这个你不明的请联系卖你模块的人，他会给予技术支持的：
你要做的就是打开电脑上蓝牙模块的上位机的串口界面，能正常的收发数据即可：
/ 如何扫描蓝牙设备 /
你肯定是有个问题，为啥不直接连接，而是要扫描呢？
因为连接需要使用「BluetoothDevice」，这个东西要么搜索到，要么用 「MAC」地址构造。「MAC」地址是每个设备独一无二的，所以必须要扫描设备，获取周围所有的设备列表，拿到 「BluetoothDevice」来连接。同时取出里面的 「MAC」地址，保存，用来下次连接。
我们先获取系统的蓝牙适配器，所有的搜索，连接，等操作都要靠他：
BluetoothAdapter mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter(); 然后判断下用户的蓝牙是否已经开启：
/** * 获取用户是否打开了蓝牙 */ boolean isBluetoothEnable() { return mBluetoothAdapter.isEnabled(); } 要是一个没开蓝牙就想连蓝牙的人，我们就勉为其难帮他开启下吧 #(笑
/** * 开启蓝牙 */ void enableBluetooth() { mBluetoothAdapter.enable(); } 现在蓝牙已经开启了，那就开始搜索设备列表
mBluetoothAdapter.startDiscovery(); 但是我们还需要考虑下是不是已经正在搜索：
mBluetoothAdapter.isDiscovering() 如果正在搜索就给他取消掉：
mBluetoothAdapter.cancelDiscovery() 所以结合起来就是：
/** * 开始搜索 */ void startDiscovery() { if (mBluetoothAdapter." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/16485ee1277ab80c6050fa812464a5e9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-28T08:00:00+08:00" />
<meta property="article:modified_time" content="2020-05-28T08:00:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">快速上手Android蓝牙串口开发</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="js_content"> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/28/14/024EzBy8_o.png"></p> 
 <p style="text-align: center">/   今日科技快讯   /</p> 
 <p>近日，快手科技与京东零售集团正式签署战略合作协议。双方将在快手小店的供应链能力打造、品牌营销和数据能力共建等方面展开深入合作，共同打造短视频直播电商新生态。</p> 
 <p style="text-align: center">/   作者简介   /</p> 
 <p>本篇文章来自gtf35的投稿，分享了Android中的蓝牙开发的内容，相信会对大家有所帮助！同时也感谢作者贡献的精彩文章。</p> 
 <p>gtf35的博客地址：</p> 
 <blockquote> 
  <p style="text-align: justify">https://blog.gtf35.top/</p> 
 </blockquote> 
 <p style="text-align: center">/   前言   /</p> 
 <p>最近在做做物联网相关的内容，经常需要用到蓝牙串口来和单片机通讯。引出了几个问题：</p> 
 <ul><li><p>蓝牙串口是什么？</p></li><li><p>如何扫描蓝牙设备</p></li><li><p>如何连接蓝牙设备</p></li><li><p>如何收发串口数据</p></li></ul> 
 <p style="text-align: center">/   蓝牙串口是什么？   /</p> 
 <p>先介绍下串口，串行接口简称串口，就是一种通信的方式，类似于「USB」，只是比USB低级多了。但是手机等设备他没外置这个串口，解决方式就是手机用蓝牙连接一个小硬件，小硬件有个串口，他的和单片机连接，来达到手机和单片机的串口连接，这种方式就是蓝牙串口。</p> 
 <p>在开发之前你最好有那个小硬件，那个小硬件通常叫「蓝牙透传模块」，淘宝不到30块钱就能买一个。我的长这样，有专用的上位机，这个你不明的请联系卖你模块的人，他会给予技术支持的：</p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/6f/f6/fQsWffO6_o.png"></p> 
 <p>你要做的就是打开电脑上蓝牙模块的上位机的串口界面，能正常的收发数据即可：</p> 
 <p><img src="https://images2.imgbox.com/d1/39/80CEiGKx_o.png"></p> 
 <p style="text-align: center">/   如何扫描蓝牙设备   /</p> 
 <p>你肯定是有个问题，为啥不直接连接，而是要扫描呢？</p> 
 <p>因为连接需要使用「BluetoothDevice」，这个东西要么搜索到，要么用 「MAC」地址构造。「MAC」地址是每个设备独一无二的，所以必须要扫描设备，获取周围所有的设备列表，拿到 「BluetoothDevice」来连接。同时取出里面的 「MAC」地址，保存，用来下次连接。</p> 
 <p>我们先获取系统的蓝牙适配器，所有的搜索，连接，等操作都要靠他：</p> 
 <pre class="has"><code class="language-php">BluetoothAdapter mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();
</code></pre> 
 <p>然后判断下用户的蓝牙是否已经开启：</p> 
 <pre class="has"><code class="language-php">/**
  * 获取用户是否打开了蓝牙
  */
boolean isBluetoothEnable() {
    return mBluetoothAdapter.isEnabled();
}
</code></pre> 
 <p>要是一个没开蓝牙就想连蓝牙的人，我们就勉为其难帮他开启下吧 #(笑</p> 
 <pre class="has"><code class="language-php">/**
 * 开启蓝牙
 */
void enableBluetooth() {
    mBluetoothAdapter.enable();
}
</code></pre> 
 <p>现在蓝牙已经开启了，那就开始搜索设备列表</p> 
 <pre class="has"><code class="language-php">mBluetoothAdapter.startDiscovery();
</code></pre> 
 <p>但是我们还需要考虑下是不是已经正在搜索：</p> 
 <pre class="has"><code class="language-php">mBluetoothAdapter.isDiscovering()
</code></pre> 
 <p>如果正在搜索就给他取消掉：</p> 
 <pre class="has"><code class="language-php">mBluetoothAdapter.cancelDiscovery()
</code></pre> 
 <p>所以结合起来就是：</p> 
 <pre class="has"><code class="language-php">/**
 * 开始搜索
 */
void startDiscovery() {
    if (mBluetoothAdapter.isDiscovering()) mBluetoothAdapter.cancelDiscovery();
    mBluetoothAdapter.startDiscovery();
}
</code></pre> 
 <p>似乎出现了一个问题，结果在哪获取？</p> 
 <p>说出来你可能不信，用广播，你没听错，就是广播，别无他法 ( ´･･)ﾉ(._.`) ，当然也可能是我太菜了。</p> 
 <p style="text-align: left">先定义一个广播接收器，获取到搜索结果的Action是BluetoothDevice.ACTION_FOUND，然后在里面取出BluetoothDevice.EXTRA_DEVICE 就可以获取到可爱的BluetoothDevice了。</p> 
 <p>还记的前文说的连接蓝牙需要的东西吗？就是他了：</p> 
 <pre class="has"><code class="language-php">/**
 * 搜索到新设备广播广播接收器
 */
private final BroadcastReceiver mReceiver = new BroadcastReceiver() {
    public void onReceive(Context context, Intent intent) {
        String action = intent.getAction();
        if (BluetoothDevice.ACTION_FOUND.equals(action)) {
            // 这就是可爱的 BluetoothDevice 了
            BluetoothDevice device = intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);
        }
    }
};
</code></pre> 
 <p>然后用context注册这个广播。</p> 
 <pre class="has"><code class="language-php">IntentFilter foundFilter = new IntentFilter(BluetoothDevice.ACTION_FOUND);
mContext.registerReceiver(mReceiver, foundFilter);
</code></pre> 
 <p>最后不要忘记加入权限，处理好运行时权限：</p> 
 <pre class="has"><code class="language-php">&lt;!--管理蓝牙需要--&gt;
&lt;uses-permission android:name="android.permission.BLUETOOTH" /&gt;
&lt;uses-permission android:name="android.permission.BLUETOOTH_ADMIN" /&gt;
&lt;!--搜索蓝牙需要，因为蓝牙可以被用来定位，所以需要定位权限--&gt;
&lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/&gt;
&lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;
</code></pre> 
 <p>这样在触发搜索逻辑后，每次找到一个新设备就会收到一个广播，拿到BluetoothDevice之后，就可以获取MAC地址：</p> 
 <pre class="has"><code class="language-php">bluetoothDevice.getAddress()
</code></pre> 
 <p>把他保存下来，下次使用的时候就可以用它二次获取BluetoothDevice了。</p> 
 <pre class="has"><code class="language-php">bluetoothDevice = bluetoothAdapter.getRemoteDevice("之前保存过的蓝牙MAC地址");
</code></pre> 
 <p>到此搜索的部分就结束了。</p> 
 <p style="text-align: center">/   如何连接蓝牙设备   /</p> 
 <p>上一节说道，拿到了BluetoothDevice就可以用来连接了，连接很简单，首先要知道每个蓝牙设备都有一个UUID来描述自己是什么设备，蓝牙串口设备的缩写是SPP，他的UUID如下，其他的UUID详情，可以参考这个页面：</p> 
 <pre class="has"><code class="language-php">UUID SPP_UUID = UUID.fromString("00001101-0000-1000-8000-00805F9B34FB");
</code></pre> 
 <p>然后用之上一步拿到的BluetoothDevice来打开指定UUID的连接即可获取到蓝牙的Socket。</p> 
 <pre class="has"><code class="language-php">BluetoothSocket bluetoothSocket = bluetoothDevice.createRfcommSocketToServiceRecord(SPP_UUID);
</code></pre> 
 <p>现在到了激动人心的时刻，建立连接！</p> 
 <p>调用bluetoothSocket的connect()方法会建立和蓝牙模块的连接，如果之前没有配对过，会弹出系统窗口，要求用户输入配对密码，这一块开发者没有特殊需求不用关心，系统会自动处理。要注意的是connect方法会阻塞线程，需要在子线程建立连接：</p> 
 <pre class="has"><code class="language-php">// 等待连接，会阻塞线程
bluetoothSocket.connect(); 
</code></pre> 
 <p>然后通过BluetoothSocket即可拿到输入流和输出流：</p> 
 <pre class="has"><code class="language-php">// 用来收数据
InputStream inputStream = bluetoothSocket.getInputStream();
// 用来发数据
OutputStream outputStream = bluetoothSocket.getOutputStream();
</code></pre> 
 <p>这就是普通的流操作了，就是大家熟悉的内容了。</p> 
 <p style="text-align: center">/   如何收发串口数据   /</p> 
 <p>发数据就是传统的流操作了，调用 OutputStream 的 write(byte[]) 方法来写入流：</p> 
 <pre class="has"><code class="language-php">/**
 * 发送
 *
 * @param msg 内容
 */
void send(byte[] msg) {
    try {
        bluetoothSocket.getOutputStream().write(msg);
    } catch (Exception e){e.printStackTrace();}
}
</code></pre> 
 <p>收数据需要注意一下，需要写个死循环，反复读取，因为串口发来的一句话很可能是分成好几段发来的，和单片机那边的开发约定好一个停止位，没收到停止位之前就一直累加，这里给出一个我调试好的模板代码：</p> 
 <pre class="has"><code class="language-php">// 记录标志位，开始运行
boolean isRunning = true;
// 约定好的停止位
String stopString = "\r\n";

// 开始监听数据接收
try {
    InputStream inputStream = bluetoothSocket.getInputStream();
    byte[] result = new byte[0];
    while (isRunning) {
        logD("looping");
        byte[] buffer = new byte[256];
        // 等待有数据
        while (inputStream.available() == 0 &amp;&amp; isRunning) {if (System.currentTimeMillis() &lt; 0) break;}
        while (isRunning) {
            try {
                int num = inputStream.read(buffer);
                byte[] temp = new byte[result.length + num];
                System.arraycopy(result, 0, temp, 0, result.length);
                System.arraycopy(buffer, 0, temp, result.length, num);
                result = temp;
                if (inputStream.available() == 0) break;
            } catch (Exception e) {
                e.printStackTrace();
                // todo:处理接收数据单次失败
                break;
            }
        }
        try {
            // 返回数据
            logD("当前累计收到的数据=&gt;" + byte2Hex(result));
            byte[] stopFlag = stopString.getBytes();
            int stopFlagSize = stopFlag.length;
            boolean shouldCallOnReceiveBytes = false;
            logD("标志位为：" + byte2Hex(stopFlag));
            for (int i = stopFlagSize - 1; i &gt;= 0; i--) {
                int indexInResult = result.length - (stopFlagSize - i);
                if (indexInResult &gt;= result.length || indexInResult &lt; 0) {
                    shouldCallOnReceiveBytes = false;
                    logD("收到的数据比停止字符串短");
                    break;
                }
                if (stopFlag[i] == result[indexInResult]) {
                    logD("发现" + byte2Hex(stopFlag[i]) + "等于" + byte2Hex(result[indexInResult]));
                    shouldCallOnReceiveBytes = true;
                } else {
                    logD("发现" + byte2Hex(stopFlag[i]) + "不等于" + byte2Hex(result[indexInResult]));
                    shouldCallOnReceiveBytes = false;
                }
            }
            if (shouldCallOnReceiveBytes) {
                // 到了这里，byte 数组 result 就是收到的数据了
                // todo: 执行收到数据逻辑
                // 清空之前的
                result = new byte[0];
            }
        } catch (Exception e) {
            e.printStackTrace();
            // todo:处理验证收到数据结束标志出错
        }
    }
} catch (Exception e) {
    e.printStackTrace();
    // todo:处理接收数据失败
}
</code></pre> 
 <p style="text-align: center">/   总结   /</p> 
 <p>到此，就算是大体结束了，但是不要忘记关闭线程，关闭流，解注册广播等等，我包装了一个工具类，上面的具体连贯实现也可以参考。</p> 
 <p>工具类地址为：</p> 
 <blockquote> 
  <p style="text-align: justify">https://github.com/gtf35/BLESerial/blob/master/app/src/main/java/top/gtf35/bleserial/BLESPPUtils.java</p> 
 </blockquote> 
 <p>demo项目地址为：</p> 
 <blockquote> 
  <p style="text-align: justify">https://github.com/gtf35/BLESerial</p> 
 </blockquote> 
 <p>推荐阅读：</p> 
 <p><a href="http://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA%3D%3D&amp;chksm=88636b26bf14e230697babd443301891f870e1543824acf4530b57325cd0a7c7ee7d562a358c&amp;idx=1&amp;mid=2650249801&amp;scene=21&amp;sn=5e9773e212bf1b8a24998225aff27727#wechat_redirect" rel="nofollow"></a><a href="http://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA%3D%3D&amp;chksm=88636794bf14ee823e8c11854b5c014e49a4af425c2947e7c62f3ce139062b5560b4c44e3d4f&amp;idx=1&amp;mid=2650248955&amp;scene=21&amp;sn=0c5237154c4c8de2ca635f8a578aa701#wechat_redirect" rel="nofollow">这本《第三行代码》，让大家久等了！</a><br></p> 
 <p><a href="http://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA%3D%3D&amp;chksm=886366dfbf14efc94945180aad7081319b701fb3c3147a2f7f382095875b018280dad115e5b8&amp;idx=1&amp;mid=2650249136&amp;scene=21&amp;sn=61dd56c11366cc85f5d304ee2a1e7451#wechat_redirect" rel="nofollow">Android 11来了，快！扶我起来</a><br></p> 
 <p><a href="http://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA%3D%3D&amp;chksm=886369b1bf14e0a7cb9bf3c12ac538a5f585f46a8fc4c4befc7694d043e05115e1e11001cdb7&amp;idx=1&amp;mid=2650249438&amp;scene=21&amp;sn=3ef634f7dc23ab9fdfa43a48696b5e54#wechat_redirect" rel="nofollow">Android 10适配要点，深色主题</a><br></p> 
 <p style="text-align: center">欢迎关注我的公众号</p> 
 <p style="text-align: center">学习技术或投稿</p> 
 <p><img src="https://images2.imgbox.com/50/72/B1igDLiP_o.png"></p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/de/0e/sbYVg4bi_o.png" height="123" width="123"></p> 
 <p style="text-align: center">长按上图，识别图中二维码即可关注</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5432cad6b45afffd8dad7013457ebce2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">js设置input输入框为必选输入框，判断空格或null值</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6106ea50f236ea89126dcdefc3a44ba1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">datagrid调用getEditor为null?这样你试过了吗？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>