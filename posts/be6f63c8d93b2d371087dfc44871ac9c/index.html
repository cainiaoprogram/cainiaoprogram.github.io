<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何在宝塔（bt）下搭建 wordpress 网站 &#43; 免费 waf 防火墙 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="如何在宝塔（bt）下搭建 wordpress 网站 &#43; 免费 waf 防火墙" />
<meta property="og:description" content="如何在宝塔（bt）下搭建 wordpress 网站 &#43; 免费 waf 防火墙 宝塔运维工具1，配合 wordpress 可以快速创建网站。当我们快速完成网站搭建并且上线后，惊讶的发现，网络上总隐藏着坏人，时时刻刻想害我的网站。此时就需要用到网络应用防火墙 waf，因为宝塔自带 waf 是收费的，作为小网站，用起来并不划算。所以得寻找可用的免费 waf 2，对比之后，最后选择了雷池 waf 社区版 3，原因很简单，社区版对应的就是商业版，背靠大树好乘凉。
下面是宝塔 bt &#43; 免费 waf 的搭建过程。
环境准备 使用腾讯云轻应用服务器4创建服务实例，操作系统选择 “WordPress”。
设置腾讯云防火墙开放端口，添加 3 个端口
端口服务用途8888宝塔面板进入宝塔的管理界面，管理所有服务，必开9443雷池社区面板管理雷池社区防火墙的后台，必开8001业务服务因为宝塔占用了 80 端口，waf 需要占用其他端口代理业务服务，非必开 注意：8001 端口是为了测试用，正式服务上线后可以使用 https 协议的 443 端口，然后就可以关掉这个测试端口了，并且 8001 也可以更换为其他端口，这里仅测试用。
安装成功后，在 “应用管理” 面板可以看到应用信息：
根据 宝塔 Linux 应用的提示，ssh 链接到服务器，获取登录宝塔的登录账号密码：
然后登录宝塔管理后端，环境配置成功。
在宝塔中添加社区版 waf 因为需要用到宝塔的云服务功能，这里推荐登录宝塔账号。
雷池 waf 使用 docker 运行，并且官网提供了一键安装脚本，但是想要在宝塔中管理，还需要进行一些配置。
宝塔安装 docker：
安装完成：
社区版 waf 是通过 docker compose 运行的，在宝塔中添加 compose 模板：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/be6f63c8d93b2d371087dfc44871ac9c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-28T10:32:38+08:00" />
<meta property="article:modified_time" content="2023-06-28T10:32:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何在宝塔（bt）下搭建 wordpress 网站 &#43; 免费 waf 防火墙</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="bt_wordpress____waf__0"></a>如何在宝塔（bt）下搭建 wordpress 网站 + 免费 waf 防火墙</h2> 
<p>宝塔运维工具<sup class="footnote-ref"><a href="#fn1" rel="nofollow" id="fnref1">1</a></sup>，配合 wordpress 可以快速创建网站。当我们快速完成网站搭建并且上线后，惊讶的发现，网络上总隐藏着坏人，时时刻刻想害我的网站。此时就需要用到网络应用防火墙 waf，因为宝塔自带 waf 是收费的，作为小网站，用起来并不划算。所以得寻找可用的免费 waf <sup class="footnote-ref"><a href="#fn2" rel="nofollow" id="fnref2">2</a></sup>，对比之后，最后选择了雷池 waf 社区版 <sup class="footnote-ref"><a href="#fn3" rel="nofollow" id="fnref3">3</a></sup>，原因很简单，社区版对应的就是商业版，背靠大树好乘凉。</p> 
<p>下面是宝塔 bt + 免费 waf 的搭建过程。</p> 
<h5><a id="_6"></a>环境准备</h5> 
<p>使用腾讯云轻应用服务器<sup class="footnote-ref"><a href="#fn4" rel="nofollow" id="fnref4">4</a></sup>创建服务实例，操作系统选择 “WordPress”。<br> <img src="https://images2.imgbox.com/9a/e5/4OZQvEU2_o.png" alt="image.png"></p> 
<p>设置腾讯云防火墙开放端口，添加 3 个端口</p> 
<table><thead><tr><th>端口</th><th>服务</th><th>用途</th></tr></thead><tbody><tr><td>8888</td><td>宝塔面板</td><td>进入宝塔的管理界面，管理所有服务，必开</td></tr><tr><td>9443</td><td>雷池社区面板</td><td>管理雷池社区防火墙的后台，必开</td></tr><tr><td>8001</td><td>业务服务</td><td>因为宝塔占用了 80 端口，waf 需要占用其他端口代理业务服务，非必开</td></tr></tbody></table> 
<p><strong>注意</strong>：8001 端口是为了测试用，正式服务上线后可以使用 https 协议的 443 端口，然后就可以关掉这个测试端口了，并且 8001 也可以更换为其他端口，这里仅测试用。<br> <img src="https://images2.imgbox.com/cf/1e/VlXpHaXa_o.png" alt="image.png"></p> 
<p>安装成功后，在 “应用管理” 面板可以看到应用信息：<br> <img src="https://images2.imgbox.com/2c/3d/ViEjIJ1U_o.png" alt="image.png"></p> 
<p>根据 宝塔 Linux 应用的提示，ssh 链接到服务器，获取登录宝塔的登录账号密码：<br> <img src="https://images2.imgbox.com/12/f9/zhL7rVUf_o.png" alt="image.png"></p> 
<p>然后登录宝塔管理后端，环境配置成功。<br> <img src="https://images2.imgbox.com/95/72/KyyOVs5i_o.png" alt="image.png"></p> 
<h5><a id="_waf_30"></a>在宝塔中添加社区版 waf</h5> 
<p>因为需要用到宝塔的云服务功能，这里推荐登录宝塔账号。<br> <img src="https://images2.imgbox.com/6f/fc/4eGlZBlJ_o.png" alt="image.png"></p> 
<p>雷池 waf 使用 docker 运行，并且官网提供了一键安装脚本，但是想要在宝塔中管理，还需要进行一些配置。</p> 
<p>宝塔安装 docker：<br> <img src="https://images2.imgbox.com/97/d9/elEpgkzx_o.png" alt="image.png"></p> 
<p>安装完成：<br> <img src="https://images2.imgbox.com/88/1a/ArSQJs2G_o.png" alt="image.png"></p> 
<p>社区版 waf 是通过 docker compose 运行的，在宝塔中添加 compose 模板：<br> <img src="https://images2.imgbox.com/43/8c/2OfZcbzT_o.png" alt="image.png"></p> 
<p>然后关键的 compose.yaml 文件，下面是手动修改过的 1.10 版本 compose 配置文件：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">safeline-ce</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> safeline<span class="token punctuation">-</span>ce
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
    <span class="token key atrule">ipam</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver</span><span class="token punctuation">:</span> default
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 169.254.0.1
          <span class="token key atrule">subnet</span><span class="token punctuation">:</span> 169.254.0.0/24
    <span class="token key atrule">driver_opts</span><span class="token punctuation">:</span>
      <span class="token key atrule">com.docker.network.bridge.name</span><span class="token punctuation">:</span> safeline<span class="token punctuation">-</span>ce

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">postgres</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> safeline<span class="token punctuation">-</span>postgres
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span><span class="token number">15.2</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/postgres/data<span class="token punctuation">:</span>/var/lib/postgresql/data
      <span class="token punctuation">-</span> /etc/localtime<span class="token punctuation">:</span>/etc/localtime<span class="token punctuation">:</span>ro
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> POSTGRES_USER=safeline<span class="token punctuation">-</span>ce
      <span class="token punctuation">-</span> POSTGRES_PASSWORD=SafeLine2023<span class="token tag">!</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">safeline-ce</span><span class="token punctuation">:</span>
        <span class="token key atrule">ipv4_address</span><span class="token punctuation">:</span> 169.254.0.2
    <span class="token key atrule">cap_drop</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> net_raw
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>postgres<span class="token punctuation">,</span> <span class="token punctuation">-</span>c<span class="token punctuation">,</span> max_connections=200<span class="token punctuation">]</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> safeline<span class="token punctuation">-</span>redis
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>7.0.11
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/redis/data<span class="token punctuation">:</span>/data
      <span class="token punctuation">-</span> /etc/localtime<span class="token punctuation">:</span>/etc/localtime<span class="token punctuation">:</span>ro
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass  SafeLine2023<span class="token tag">!</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">safeline-ce</span><span class="token punctuation">:</span>
        <span class="token key atrule">ipv4_address</span><span class="token punctuation">:</span> 169.254.0.3
    <span class="token key atrule">cap_drop</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> net_raw
    <span class="token key atrule">sysctls</span><span class="token punctuation">:</span>
      <span class="token key atrule">net.core.somaxconn</span><span class="token punctuation">:</span> <span class="token string">"511"</span>
  <span class="token key atrule">management</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> safeline<span class="token punctuation">-</span>mgt<span class="token punctuation">-</span>api
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> chaitin/safeline<span class="token punctuation">-</span>mgt<span class="token punctuation">-</span>api<span class="token punctuation">:</span>1.10.0
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/management<span class="token punctuation">:</span>/resources/management
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/nginx<span class="token punctuation">:</span>/resources/nginx
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/logs<span class="token punctuation">:</span>/logs
      <span class="token punctuation">-</span> /etc/localtime<span class="token punctuation">:</span>/etc/localtime<span class="token punctuation">:</span>ro
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $<span class="token punctuation">{<!-- --></span>MGT_PORT<span class="token punctuation">:</span><span class="token number">-9443</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token number">1443</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> MANAGEMENT_RESOURCES_DIR=/resources/management
      <span class="token punctuation">-</span> NGINX_RESOURCES_DIR=/resources/nginx
      <span class="token punctuation">-</span> DATABASE_URL=postgres<span class="token punctuation">:</span>//safeline<span class="token punctuation">-</span>ce<span class="token punctuation">:</span>SafeLine2023<span class="token tag">!@127.0.0.1/safeline-ce</span>
      <span class="token punctuation">-</span> MANAGEMENT_LOGS_DIR=/logs/management
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">safeline-ce</span><span class="token punctuation">:</span>
        <span class="token key atrule">ipv4_address</span><span class="token punctuation">:</span> 169.254.0.4
    <span class="token key atrule">cap_drop</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> net_raw
  <span class="token key atrule">detector</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> safeline<span class="token punctuation">-</span>detector
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> chaitin/safeline<span class="token punctuation">-</span>detector<span class="token punctuation">:</span>1.10.0
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/detector<span class="token punctuation">:</span>/resources/detector
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/logs/detector<span class="token punctuation">:</span>/logs/detector
      <span class="token punctuation">-</span> /etc/localtime<span class="token punctuation">:</span>/etc/localtime<span class="token punctuation">:</span>ro
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> LOG_DIR=/logs/detector
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">safeline-ce</span><span class="token punctuation">:</span>
        <span class="token key atrule">ipv4_address</span><span class="token punctuation">:</span> 169.254.0.5
    <span class="token key atrule">cap_drop</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> net_raw
  <span class="token key atrule">mario</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> safeline<span class="token punctuation">-</span>mario
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> chaitin/safeline<span class="token punctuation">-</span>mario<span class="token punctuation">:</span>1.10.0
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/mario<span class="token punctuation">:</span>/resources/mario
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/logs/mario<span class="token punctuation">:</span>/logs/mario
      <span class="token punctuation">-</span> /etc/localtime<span class="token punctuation">:</span>/etc/localtime<span class="token punctuation">:</span>ro
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> LOG_DIR=/logs/mario
      <span class="token punctuation">-</span> GOGC=100
      <span class="token punctuation">-</span> DATABASE_URL=postgres<span class="token punctuation">:</span>//safeline<span class="token punctuation">-</span>ce<span class="token punctuation">:</span>SafeLine2023<span class="token tag">!@safeline-postgres/safeline-ce</span>
      <span class="token punctuation">-</span> REDIS_URL=redis<span class="token punctuation">:</span>//<span class="token punctuation">:</span>SafeLine2023<span class="token tag">!@safeline-redis:6379/0</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">safeline-ce</span><span class="token punctuation">:</span>
        <span class="token key atrule">ipv4_address</span><span class="token punctuation">:</span> 169.254.0.6
    <span class="token key atrule">cap_drop</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> net_raw
  <span class="token key atrule">tengine</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> safeline<span class="token punctuation">-</span>tengine
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">image</span><span class="token punctuation">:</span> chaitin/safeline<span class="token punctuation">-</span>tengine<span class="token punctuation">:</span>1.10.0
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/nginx<span class="token punctuation">:</span>/etc/nginx
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/management<span class="token punctuation">:</span>/resources/management
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/detector<span class="token punctuation">:</span>/resources/detector
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/logs/nginx<span class="token punctuation">:</span>/var/log/nginx
      <span class="token punctuation">-</span> /etc/localtime<span class="token punctuation">:</span>/etc/localtime<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> /srv/safeline<span class="token punctuation">-</span>ce/resources/cache<span class="token punctuation">:</span>/usr/local/nginx/cache
      <span class="token punctuation">-</span> /etc/resolv.conf<span class="token punctuation">:</span>/etc/resolv.conf
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> MGT_ADDR=169.254.0.4<span class="token punctuation">:</span><span class="token number">9002</span>
    <span class="token key atrule">ulimits</span><span class="token punctuation">:</span>
      <span class="token key atrule">nofile</span><span class="token punctuation">:</span> <span class="token number">131072</span>
    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> host
</code></pre> 
<p>拷贝文件到 “添加 yaml 模板” 中，并添加模板。<br> <img src="https://images2.imgbox.com/03/88/oBhIUNQS_o.png" alt="image.png"></p> 
<p>在宝塔面板中，切换到 compose ，创建新的 compose 项目：<br> <img src="https://images2.imgbox.com/90/c7/0mHFwtPz_o.png" alt="image.png"></p> 
<p>点击“添加”后，需要几分钟时间准备运行。成功后，切换到 “容器” 面板，可以看到 waf 相关的 6 个容器都在运行状态：<br> <img src="https://images2.imgbox.com/88/fa/j4PPURIJ_o.png" alt="image.png"></p> 
<p>此时可以访问 9443 端口，就可以查看 waf 管理后台了。<br> 注意：雷池 waf 使用了自签名证书来支持 https，所以第一次访问时需要手动 “允许” 一次才可以。<br> <img src="https://images2.imgbox.com/36/b3/lOOsEKVo_o.png" alt="image.png"></p> 
<p>然后可以登录 waf 的登录，雷池社区采取了比较特殊的登录方式： OTP 验证码登录，参考官网文档<sup class="footnote-ref"><a href="#fn5" rel="nofollow" id="fnref5">5</a></sup>。绑定完 OTP 后再登录，成功后可以看到这个界面。<br> <img src="https://images2.imgbox.com/46/94/cwKpW2Ul_o.png" alt="image.png"></p> 
<h5><a id="_waf_182"></a>配置 waf</h5> 
<p>那么，服务都准备好了，下面如何给业务服务套上 waf。作为中小网站的维护人员，我并不想学习 waf，只想简单使用，因此我仅仅了解 waf 的几个关键点：</p> 
<ol><li>waf 是拦截在 wordpress 网站之前的，waf 如果挂了，网站就挂了</li><li>用户访问的其实是 waf，如果访问没有风险，waf 才会转发给业务服务</li><li>waf 也要监听端口，并且不能和网站监听同一个端口，这是操作系统的限制</li></ol> 
<p>所以应该是，waf 应该监听 80/443 这样的端口，然后转发给网站监听的 8000/8080 这样的端口。</p> 
<p>配置 waf 前，先测试我们的网站原来什么样：<br> <img src="https://images2.imgbox.com/44/ca/0dxgCjre_o.png" alt="image.png"></p> 
<p>监听 80 端口，可以正常访问。下面配置 waf，打开 waf 后端：<br> <img src="https://images2.imgbox.com/2f/6a/MyAfZSCd_o.png" alt="image.png"></p> 
<p>创建成功后，可以看到防护站点列表中出现一条记录，waf 可以配置多个站点，但我们只有一个网站，所以没有设置 “域名”，就表示所以访问都接受，会转发给网站。此时创建的 waf 防护站点运行模式是：防护模式。<br> <img src="https://images2.imgbox.com/5e/4b/ONXeSaAR_o.png" alt="image.png"></p> 
<p><strong>注意</strong>：waf 监听了 8001 端口，虽然我们已经在腾讯云的后台防火墙中开放了 8001 端口，但那是云平台的防火墙，在宝塔中添加系统防火墙的允许规则，否则 8001 端口是访问不了的。<br> <img src="https://images2.imgbox.com/aa/51/DWi5VrbC_o.png" alt="image.png"></p> 
<p>现在可以通过 8001 来访问网站了：<br> <img src="https://images2.imgbox.com/01/38/zsiNRtwP_o.png" alt="image.png"></p> 
<p>此时我们的网站已经在 waf 的保护之下了，来检测一下效果，访问 /shell.php 路径触发一次 waf 的防护功能：<br> <img src="https://images2.imgbox.com/bb/c8/u3h3sxtC_o.png" alt="image.png"></p> 
<p>啧啧啧，这个访问看起来太危险了，被 waf 拦截了。现在回到 waf 管理后台，在 “检测日志” 面板下，可以看到拦截日志列表，其中包含一条刚刚被拦截的日志，点击 “详情” 查看，会看到拦截原因和访问细节，现在是不是有了一种练成金钟罩的感觉。<br> <img src="https://images2.imgbox.com/88/39/DV7WGpum_o.png" alt="image.png"></p> 
<h5><a id="_213"></a>优化访问端口</h5> 
<p>此时的我们已经成功配置了 waf，但访问路径中包含了 8001 这个端口，这可不行。是否可以不显示这个端口号呢？根据 web 访问的规则，有两种情况是不用显示端口号的</p> 
<ol><li>http 访问 80 端口</li><li>https 访问 443 端口</li></ol> 
<p>因为 80 端口已经被宝塔占用，并且出于安全的考虑，网站也不建议使用 http 直接访问。好在宝塔没有占用 443 端口，那么我们可以用 waf 来监听 443 端口并转发给业务服务。443 端口对应的 https 协议需要证书，关于如何获取证书这里不展开解释。我们来继续修改 waf 的配置，将端改为 443 并添加证书。<br> <img src="https://images2.imgbox.com/a7/07/Fmu4YZO5_o.png" alt="image.png"></p> 
<p>这里一定要夸奖一下 waf 非常非常贴心的一个功能：自动生成证书。知道你自己搞证书不方便，反正流程是固定的，waf 直接帮你做了。<br> <img src="https://images2.imgbox.com/ae/d6/XMuc8pRE_o.png" alt="image.png"></p> 
<p>现在重新访问一下我们的网站，看到结果了吗，不再显示端口号了，并且是 https。虽然是红色警告，但换成真证书以后就没问题了， 或者也可以就用自签名证书也问题不大。<br> <img src="https://images2.imgbox.com/62/1f/uoXkzCS5_o.png" alt="image.png"></p> 
<h5><a id="_228"></a>收尾</h5> 
<p>当前网站已经出于 waf 的保护之下，现在可以把不安全的端口关掉了。<br> <img src="https://images2.imgbox.com/6c/ff/9ZnC2gVH_o.png" alt="image.png"></p> 
<h5><a id="_waf__233"></a>关于 waf 升级</h5> 
<p>目前 waf 项目还在不断地更新迭代当中，官方推荐 cli 模式下的手动升级，在宝塔下这是不行的。waf 是通过在宝塔下创建 compose 模板来实现管理的，所以升级时需要编写新的 compose 文件。关于如何而升级 waf ，以后升级时再单独记录一篇文章。</p> 
<hr class="footnotes-sep"> 
<section class="footnotes"> 
 <ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>https://www.bt.cn/new/index.html <a href="#fnref1" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn2" class="footnote-item"><p>https://zhuanlan.zhihu.com/p/638489965 <a href="#fnref2" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn3" class="footnote-item"><p>https://waf-ce.chaitin.cn/ <a href="#fnref3" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn4" class="footnote-item"><p>https://www.tencentcloud.com/zh/products/lighthouse <a href="#fnref4" rel="nofollow" class="footnote-backref">↩︎</a></p> </li><li id="fn5" class="footnote-item"><p>https://waf-ce.chaitin.cn/posts/guide_login <a href="#fnref5" rel="nofollow" class="footnote-backref">↩︎</a></p> </li></ol> 
</section>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b4033e263728cddfa304b69289318cdf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux虚拟机安装步骤</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8cf1e85ccbfc72153c8992d3e0dd10ba/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">二进制搭建Kubernetes集群（三）——部署多master</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>