<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux系统初始化 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux系统初始化" />
<meta property="og:description" content="学习Linux内核的原因 我个人是软件工程专业的学生，但是对计算机是怎么运行的一直都有疑惑。 为什么一通电计算机就能运行了，处理各种任务。 如果对计算机底层知识的不熟悉和不理解的话，这就造成了在了解各种中间件或者软件的底层原理的时候，会比较吃力，对于程序运行的具体情况也不太清楚。 我个人目前认为只有对程序在计算机中的具体执行过程有着深入的了解，才能写出性能更好、更健壮性的代码，所以开始学习Linux内核。
Linux内核学习方法 资料
《趣谈Linux内核 》 刘超 极客时间专栏
Linux源码
路线
学习Linux内核切记不要太过深入死扣代码，而是要先在宏观上了解Linux的运行原理，然后再深入了解具体实现原理
Linux初始化 相信很多人都有这样的疑惑：为什么通电后，按下启动按钮，操作系统就运行了？
BIOS初始化
当通电后，CPU就开始执行指令了，执行的是什么指令呢？主板上有一块ROM，ROM是只读存储器，里面存储了BIOS程序。CPU会执行BIOS程序来加载操作系统。
BIOS的全称是 basic input and output system，也就是基本输入输出系统。
上述图片是bios时期的CPU地址空间的映射布局。
此时CPU处于实模式，寄存器的位数是16位，然后地址线是20位，CPU的寻址空间是2^20，也就是1MB，即使是更先进的CPU，支持64位寄存器或者超过20根的地址线，同样只能使用寄存器中的16位和其中的20根地址线。
地址的转换规则为 DS寄存器左移4位 &#43; IP寄存器。此时CPU处于ring0特权，可以执行所有指令，操作硬件。
其中0X F0000 到 0X FFFFF 这 64kb的地址空间映射到 ROM中。
当CPU通电后，会做一些重置操作，讲DS寄存器赋值为0X FFFF ， IP寄存器为 0X 0000，所以访问地址就对应着 0X FFFF0，地址0X FFFF0对应的空间 处于ROM的空间中，也就是开始执行bios程序。
1、初始化中断向量表等数据，因为用户可以通过鼠标、键盘等操作方式来操作BIOS程序，所以
2、初始化硬件资源：显示器、内存、磁盘等资源
3、加载操作系统，也就是进入BootLoader阶段
BootLoader阶段
BootLoader阶段，BIOS程序会记载操作系统内核，怎么加载呢？
检测存储设备的第一个扇区是不是以0xAA55结尾的。 如果是以0xAA55结尾就说明这是一个操作系统的启动区。我们都知道一个扇区的大小一般是512字节，一个操作系统编译后的代码一般都是好几百MB，第一个扇区是无法装下操作系统所有的代码的，所以只会将操作系统的启动代码存储到第一个扇区内，这个扇区也叫做引导扇区，存储的内容叫做boot.img。
boot.img是grub2工具写入到磁盘中的。
bios程序会将boot.img 加载到 内存中的 0x 7C00，然后利用jump指令，跳转到boot.img，至此BIOS程序就算功德圆满了，接下来就看grub2的了。
grub2加载内核过程
grub2是Grand Unified Bootloader Version 2，是一个多系统启动程序，用来一个硬盘上存在多个系统的启动，多个系统的相关配置信息被写入到了一个配置文件grub.cfg中。grub.cfg中写入了操作系统的一些配置，包括系统的版本、系统镜像的位置等信息
menuentry &#39;CentOS Linux (3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c2177218a4b8135e78e5140cbb295168/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-10T21:05:44+08:00" />
<meta property="article:modified_time" content="2022-04-10T21:05:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux系统初始化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Linux_0"></a>学习Linux内核的原因</h3> 
<p>我个人是软件工程专业的学生，但是对计算机是怎么运行的一直都有疑惑。 为什么一通电计算机就能运行了，处理各种任务。 如果对计算机底层知识的不熟悉和不理解的话，这就造成了在了解各种中间件或者软件的底层原理的时候，会比较吃力，对于程序运行的具体情况也不太清楚。 我个人目前认为只有对程序在计算机中的具体执行过程有着深入的了解，才能写出性能更好、更健壮性的代码，所以开始学习Linux内核。</p> 
<h3><a id="Linux_3"></a>Linux内核学习方法</h3> 
<p><strong>资料</strong><br> 《趣谈Linux内核 》 刘超 极客时间专栏<br> Linux源码</p> 
<p><strong>路线</strong><br> 学习Linux内核切记不要太过深入死扣代码，而是要先在宏观上了解Linux的运行原理，然后再深入了解具体实现原理</p> 
<h3><a id="Linux_13"></a>Linux初始化</h3> 
<p>相信很多人都有这样的疑惑：为什么通电后，按下启动按钮，操作系统就运行了？</p> 
<p><strong>BIOS初始化</strong><br> 当通电后，CPU就开始执行指令了，执行的是什么指令呢？主板上有一块ROM，ROM是只读存储器，里面存储了BIOS程序。CPU会执行BIOS程序来加载操作系统。<br> BIOS的全称是 basic input and output system，也就是基本输入输出系统。</p> 
<p><img src="https://images2.imgbox.com/89/59/8SdnwgAE_o.png" alt="在这里插入图片描述"><br> 上述图片是bios时期的CPU地址空间的映射布局。</p> 
<p>此时CPU处于实模式，寄存器的位数是16位，然后地址线是20位，CPU的寻址空间是2^20，也就是1MB，即使是更先进的CPU，支持64位寄存器或者超过20根的地址线，同样只能使用寄存器中的16位和其中的20根地址线。</p> 
<p>地址的转换规则为 DS寄存器左移4位 + IP寄存器。此时CPU处于ring0特权，可以执行所有指令，操作硬件。</p> 
<p>其中0X F0000 到 0X FFFFF 这 64kb的地址空间映射到 ROM中。</p> 
<p>当CPU通电后，会做一些重置操作，讲DS寄存器赋值为0X FFFF ， IP寄存器为 0X 0000，所以访问地址就对应着 0X FFFF0，地址0X FFFF0对应的空间 处于ROM的空间中，也就是开始执行bios程序。</p> 
<p>1、初始化中断向量表等数据，因为用户可以通过鼠标、键盘等操作方式来操作BIOS程序，所以<br> 2、初始化硬件资源：显示器、内存、磁盘等资源<br> 3、加载操作系统，也就是进入BootLoader阶段</p> 
<p><strong>BootLoader阶段</strong><br> BootLoader阶段，BIOS程序会记载操作系统内核，怎么加载呢？</p> 
<p><strong>检测存储设备的第一个扇区是不是以0xAA55结尾的。</strong> 如果是以0xAA55结尾就说明这是一个操作系统的启动区。我们都知道一个扇区的大小一般是512字节，一个操作系统编译后的代码一般都是好几百MB，第一个扇区是无法装下操作系统所有的代码的，所以只会将操作系统的启动代码存储到第一个扇区内，这个扇区也叫做引导扇区，存储的内容叫做boot.img。</p> 
<p>boot.img是grub2工具写入到磁盘中的。</p> 
<p>bios程序会将boot.img 加载到 内存中的 0x 7C00，然后利用jump指令，跳转到boot.img，至此BIOS程序就算功德圆满了，接下来就看grub2的了。</p> 
<p><strong>grub2加载内核过程</strong></p> 
<p>grub2是Grand Unified Bootloader Version 2，是一个多系统启动程序，用来一个硬盘上存在多个系统的启动，多个系统的相关配置信息被写入到了一个配置文件grub.cfg中。grub.cfg中写入了操作系统的一些配置，包括系统的版本、系统镜像的位置等信息</p> 
<pre><code class="prism language-c">menuentry 'CentOS <span class="token function">Linux</span> <span class="token punctuation">(</span><span class="token number">3.10</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">862.</span>el7<span class="token punctuation">.</span>x86_64<span class="token punctuation">)</span> <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>' <span class="token operator">--</span>class centos <span class="token operator">--</span>class gnu<span class="token operator">-</span>linux <span class="token operator">--</span>class gnu <span class="token operator">--</span>class os <span class="token operator">--</span>unrestricted $menuentry_id_option 'gnulinux<span class="token operator">-</span><span class="token number">3.10</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">862.</span>el7<span class="token punctuation">.</span>x86_64<span class="token operator">-</span>advanced<span class="token operator">-</span>b1aceb95<span class="token operator">-</span><span class="token number">6</span>b9e<span class="token operator">-</span><span class="token number">464</span>a<span class="token operator">-</span>a589<span class="token operator">-</span>bed66220ebee' <span class="token punctuation">{<!-- --></span>
	load_video
	set gfxpayload<span class="token operator">=</span>keep
	insmod gzio
	insmod part_msdos
	insmod ext2
	set root<span class="token operator">=</span><span class="token char">'hd0,msdos1'</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span> x$feature_platform_search_hint <span class="token operator">=</span> xy <span class="token punctuation">]</span><span class="token punctuation">;</span> then
	  search <span class="token operator">--</span>no<span class="token operator">-</span>floppy <span class="token operator">--</span>fs<span class="token operator">-</span>uuid <span class="token operator">--</span>set<span class="token operator">=</span>root <span class="token operator">--</span>hint<span class="token operator">=</span><span class="token char">'hd0,msdos1'</span>  b1aceb95<span class="token operator">-</span><span class="token number">6</span>b9e<span class="token operator">-</span><span class="token number">464</span>a<span class="token operator">-</span>a589<span class="token operator">-</span>bed66220ebee
	<span class="token keyword">else</span>
	  search <span class="token operator">--</span>no<span class="token operator">-</span>floppy <span class="token operator">--</span>fs<span class="token operator">-</span>uuid <span class="token operator">--</span>set<span class="token operator">=</span>root b1aceb95<span class="token operator">-</span><span class="token number">6</span>b9e<span class="token operator">-</span><span class="token number">464</span>a<span class="token operator">-</span>a589<span class="token operator">-</span>bed66220ebee
	fi
	linux16 <span class="token operator">/</span>boot<span class="token operator">/</span>vmlinuz<span class="token operator">-</span><span class="token number">3.10</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">862.</span>el7<span class="token punctuation">.</span>x86_64 root<span class="token operator">=</span>UUID<span class="token operator">=</span>b1aceb95<span class="token operator">-</span><span class="token number">6</span>b9e<span class="token operator">-</span><span class="token number">464</span>a<span class="token operator">-</span>a589<span class="token operator">-</span>bed66220ebee ro console<span class="token operator">=</span>tty0 console<span class="token operator">=</span>ttyS0<span class="token punctuation">,</span><span class="token number">115200</span> crashkernel<span class="token operator">=</span><span class="token keyword">auto</span> net<span class="token punctuation">.</span>ifnames<span class="token operator">=</span><span class="token number">0</span> biosdevname<span class="token operator">=</span><span class="token number">0</span> rhgb quiet 
	initrd16 <span class="token operator">/</span>boot<span class="token operator">/</span>initramfs<span class="token operator">-</span><span class="token number">3.10</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">862.</span>el7<span class="token punctuation">.</span>x86_64<span class="token punctuation">.</span>img
<span class="token punctuation">}</span>
</code></pre> 
<p>grub2的程序主要包括 boot.img core.img</p> 
<p><img src="https://images2.imgbox.com/b6/35/XGpAnIId_o.png" alt="在这里插入图片描述"></p> 
<p>boot.img会加载core.img，core.img的一个扇区中存的是disk.img。</p> 
<p>disk.img用来加载core.img中的其他模块，比如lzma_decompress.img、kernel.img等。这里的kernel是指grub2的内核，而不是操作系统的。</p> 
<p>disk.img 加载lzma_decompress.img，lzma_decompress.img会对kernel.img进行解压，实模式的支持的内容空间不到1MB，而kernel.img占的内存比较大，所以要从实模式切换到保护模式。</p> 
<p>保护模式的做法：<br> 1、打开Gate20地址线，CPU可以使用其他的地址线了，意味着更大的寻址空间<br> 2、打开分段和分页，之前的映射方式是地址的翻译方式为 DS寄存器左移4位 + IP寄存器，这种访问方式是不安全的，一个进程可以访问另一个进程的数据。所以引入了逻辑地址的方法，通过页表将逻辑地址转化为物理地址，而页表由操作系统内核维护，可以做到进程之间的安全隔离。</p> 
<p>切换到保护模式后，lzma_decompress.img会执行kernel.img开始真正的加载操作系统。</p> 
<p>kernel.img会调用grub_load_config() 方法来解析grub.cfg, 里面有一个grub_show_menu()会让用户选择操作系统<br> <img src="https://images2.imgbox.com/41/f2/WGHmAUc0_o.png" alt="在这里插入图片描述"></p> 
<p>选择完操作系统后，就会根据grub.cfg里面的配置信息来加载操作系统啦。</p> 
<p><strong>初始化Linux</strong></p> 
<p>1、初始化中断向量表</p> 
<p>2、初始化内存管理模块</p> 
<p>3、初始化进程调度模块</p> 
<p>4、初始化VFS，虚拟文件系统</p> 
<p>5、 初始化进程</p> 
<ol><li> <p>创建0号进程<br> 0号进程是所有进程的祖先，通过<br> struct task_struct init_task = INIT_TASK(init_task) 来创建</p> </li><li> <p>创建1号进程<br> 1号进程是第一个用户态进程，是所有用户态进程的祖先，通过<br> kernel_thread(kernel_init, NULL, CLONE_FS) 创建</p> </li></ol> 
<p>kernel_init的大概定义如下，是要执行init文件，来进行初始化工作</p> 
<pre><code class="prism language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">try_to_run_init_process</span><span class="token punctuation">(</span><span class="token string">"/sbin/init"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
	    <span class="token operator">!</span><span class="token function">try_to_run_init_process</span><span class="token punctuation">(</span><span class="token string">"/etc/init"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
	    <span class="token operator">!</span><span class="token function">try_to_run_init_process</span><span class="token punctuation">(</span><span class="token string">"/bin/init"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
	    <span class="token operator">!</span><span class="token function">try_to_run_init_process</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<p>init文件是存储在Linux的根文件系统中的，根文件系统是一个内存文件系统。因为市面上由太多的文件系统，无法将所有的文件系统的驱动程序都加入到内核中，所以就引入了一个<strong>根文件内存系统</strong>，然后在1号进程中系统调用开始初始化内核。</p> 
<p><strong>在执行1号进程之前，会将CPU从内核态切换到用户态。</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span>
<span class="token function">start_thread</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> new_ip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> new_sp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">set_user_gs</span><span class="token punctuation">(</span>regs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//切换到用户态</span>
<span class="token comment">//设置寄存器的值</span>
regs<span class="token operator">-&gt;</span>fs	<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
regs<span class="token operator">-&gt;</span>ds	<span class="token operator">=</span> __USER_DS<span class="token punctuation">;</span>
regs<span class="token operator">-&gt;</span>es	<span class="token operator">=</span> __USER_DS<span class="token punctuation">;</span>
regs<span class="token operator">-&gt;</span>ss	<span class="token operator">=</span> __USER_DS<span class="token punctuation">;</span>
regs<span class="token operator">-&gt;</span>cs	<span class="token operator">=</span> __USER_CS<span class="token punctuation">;</span>
regs<span class="token operator">-&gt;</span>ip	<span class="token operator">=</span> new_ip<span class="token punctuation">;</span>
regs<span class="token operator">-&gt;</span>sp	<span class="token operator">=</span> new_sp<span class="token punctuation">;</span>
regs<span class="token operator">-&gt;</span>flags	<span class="token operator">=</span> X86_EFLAGS_IF<span class="token punctuation">;</span>
<span class="token function">force_iret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>start_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>创建2号进程<br> 2号进程是第一个内核进程，是所有内核进程的祖先。</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c437d8185a1c845324b22522e9e19353/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java集合类的解析与实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b48872a9e6d254fca931c3214143a27b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python-求整数的位数及各位数字之和</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>