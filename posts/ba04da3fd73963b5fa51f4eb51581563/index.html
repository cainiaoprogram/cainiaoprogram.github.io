<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2022-05-14 Druid源码阅读——Druid连接检查机制 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2022-05-14 Druid源码阅读——Druid连接检查机制" />
<meta property="og:description" content="1.Druid提供的校验参数 Druid对于连接校验提供了六个参数，其中testOnBorrow、testOnReturn、testWhileIdle是Druid所提供的连接校验时点，其余三个参数为校验的相关配置。
配置缺省值说明validationQuery用来检测连接是否有效的sql，要求是一个查询语句，常用select ‘x’。如果validationQuery为null，testOnBorrow、testOnReturn、testWhileIdle都不会起作用。validationQueryTimeout单位：秒，检测连接是否有效的超时时间。底层调用jdbc Statement对象的void setQueryTimeout(int seconds)方法testOnBorrowfalse申请连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能。testOnReturnfalse归还连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能。testWhileIdletrue建议配置为true，不影响性能，并且保证安全性。申请连接的时候检测，如果空闲时间大于timeBetweenEvictionRunsMillis，执行validationQuery检测连接是否有效。timeBetweenEvictionRunsMillis1分钟有两个含义：
(1) Destroy线程会检测连接的间隔时间，如果连接空闲时间大于等于minEvictableIdleTimeMillis则关闭物理连接。
(2) testWhileIdle的判断依据，详细看testWhileIdle属性的说明 2. Druid是如何进行连接校验的？ Druid依靠testConnectionInternal方法进行连接校验，如果当前连接池存在validConnectionChecker，则会利用validConnectionChecker进行校验，否则将利用一些内部状态以及执行校验SQL的方式进行探活，主要的校验方式都是以执行校验SQL进行校验，而MySQL可以使用PingMethod校验连接的有效性。
/** * 校验连接是否有效 * @param holder * @param conn * @return */ protected boolean testConnectionInternal(DruidConnectionHolder holder, Connection conn) { //此部分似乎是为了做监控用的 String sqlFile = JdbcSqlStat.getContextSqlFile(); String sqlName = JdbcSqlStat.getContextSqlName(); if (sqlFile != null) { JdbcSqlStat.setContextSqlFile(null); } if (sqlName != null) { JdbcSqlStat.setContextSqlName(null); } try { //判断当前连接池所持有的检查器是否为空 if (validConnectionChecker != null) { //调用检查器的教研方法进行教研 boolean valid = validConnectionChecker.isValidConnection(conn, validationQuery, validationQueryTimeout); long currentTimeMillis = System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ba04da3fd73963b5fa51f4eb51581563/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-15T15:57:28+08:00" />
<meta property="article:modified_time" content="2022-05-15T15:57:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2022-05-14 Druid源码阅读——Druid连接检查机制</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1Druid_0"></a>1.Druid提供的校验参数</h2> 
<p>Druid对于连接校验提供了六个参数，其中<code>testOnBorrow</code>、<code>testOnReturn</code>、<code>testWhileIdle</code>是Druid所提供的连接校验时点，其余三个参数为校验的相关配置。</p> 
<table><thead><tr><th>配置</th><th>缺省值</th><th>说明</th></tr></thead><tbody><tr><td>validationQuery</td><td></td><td>用来检测连接是否有效的sql，要求是一个查询语句，常用select ‘x’。如果validationQuery为null，testOnBorrow、testOnReturn、testWhileIdle都不会起作用。</td></tr><tr><td>validationQueryTimeout</td><td></td><td>单位：秒，检测连接是否有效的超时时间。底层调用jdbc Statement对象的void setQueryTimeout(int seconds)方法</td></tr><tr><td>testOnBorrow</td><td>false</td><td>申请连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能。</td></tr><tr><td>testOnReturn</td><td>false</td><td>归还连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能。</td></tr><tr><td>testWhileIdle</td><td>true</td><td>建议配置为true，不影响性能，并且保证安全性。申请连接的时候检测，如果空闲时间大于timeBetweenEvictionRunsMillis，执行validationQuery检测连接是否有效。</td></tr><tr><td>timeBetweenEvictionRunsMillis</td><td>1分钟</td><td>有两个含义：<br>(1) Destroy线程会检测连接的间隔时间，如果连接空闲时间大于等于minEvictableIdleTimeMillis则关闭物理连接。<br>(2) testWhileIdle的判断依据，详细看testWhileIdle属性的说明</td></tr></tbody></table> 
<h2><a id="2_Druid_13"></a>2. Druid是如何进行连接校验的？</h2> 
<p>Druid依靠<code>testConnectionInternal</code>方法进行连接校验，如果当前连接池存在<code>validConnectionChecker</code>，则会利用<code>validConnectionChecker</code>进行校验，否则将利用一些内部状态以及执行校验SQL的方式进行探活，主要的校验方式都是以执行校验SQL进行校验，而MySQL可以使用<code>PingMethod</code>校验连接的有效性。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 校验连接是否有效
 * @param holder
 * @param conn
 * @return
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">testConnectionInternal</span><span class="token punctuation">(</span><span class="token class-name">DruidConnectionHolder</span> holder<span class="token punctuation">,</span> <span class="token class-name">Connection</span> conn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//此部分似乎是为了做监控用的</span>
    <span class="token class-name">String</span> sqlFile <span class="token operator">=</span> <span class="token class-name">JdbcSqlStat</span><span class="token punctuation">.</span><span class="token function">getContextSqlFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> sqlName <span class="token operator">=</span> <span class="token class-name">JdbcSqlStat</span><span class="token punctuation">.</span><span class="token function">getContextSqlName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JdbcSqlStat</span><span class="token punctuation">.</span><span class="token function">setContextSqlFile</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JdbcSqlStat</span><span class="token punctuation">.</span><span class="token function">setContextSqlName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//判断当前连接池所持有的检查器是否为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>validConnectionChecker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//调用检查器的教研方法进行教研</span>
            <span class="token keyword">boolean</span> valid <span class="token operator">=</span> validConnectionChecker<span class="token punctuation">.</span><span class="token function">isValidConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> validationQuery<span class="token punctuation">,</span> validationQueryTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置相关的监控参数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                holder<span class="token punctuation">.</span>lastValidTimeMillis <span class="token operator">=</span> currentTimeMillis<span class="token punctuation">;</span>
                holder<span class="token punctuation">.</span>lastExecTimeMillis <span class="token operator">=</span> currentTimeMillis<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果校验通过并且是MySQL的情况下</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>valid <span class="token operator">&amp;&amp;</span> isMySql<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// unexcepted branch</span>
                <span class="token comment">//获得MySQL服务器中这个会话最后一次执行语句时间</span>
                <span class="token keyword">long</span> lastPacketReceivedTimeMs <span class="token operator">=</span> <span class="token class-name">MySqlUtils</span><span class="token punctuation">.</span><span class="token function">getLastPacketReceivedTimeMs</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果这个值&gt;0，即工具类返回正常结果的情况下</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lastPacketReceivedTimeMs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//获得MySQL的空闲时间</span>
                    <span class="token keyword">long</span> mysqlIdleMillis <span class="token operator">=</span> currentTimeMillis <span class="token operator">-</span> lastPacketReceivedTimeMs<span class="token punctuation">;</span>
                    <span class="token comment">//如果服务端空闲时间&gt;timeBetweenEvictionRunsMillis，则丢弃该连接，此时校验失败</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastPacketReceivedTimeMs <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token comment">//</span>
                            <span class="token operator">&amp;&amp;</span> mysqlIdleMillis <span class="token operator">&gt;=</span> timeBetweenEvictionRunsMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">discardConnection</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> errorMsg <span class="token operator">=</span> <span class="token string">"discard long time none received connection. "</span>
                                <span class="token operator">+</span> <span class="token string">", jdbcUrl : "</span> <span class="token operator">+</span> jdbcUrl
                                <span class="token operator">+</span> <span class="token string">", version : "</span> <span class="token operator">+</span> VERSION<span class="token punctuation">.</span><span class="token function">getVersionNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">", lastPacketReceivedIdleMillis : "</span> <span class="token operator">+</span> mysqlIdleMillis<span class="token punctuation">;</span>
                        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果校验成功，并且连接池中其他连接发生过异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>valid <span class="token operator">&amp;&amp;</span> onFatalError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//加锁并且重置状态</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>onFatalError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        onFatalError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//返回校验结果</span>
            <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//判断当前连接是否被关闭(DruidPooledConnection内部状态)，如果关闭则连接无效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果当前没有配置校验语句，则认为该连接有效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> validationQuery<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Statement</span> stmt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> rset <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//创建语句对象</span>
            stmt <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置该语句超时响应时间，如果没有配置则不进行操作</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getValidationQueryTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                stmt<span class="token punctuation">.</span><span class="token function">setQueryTimeout</span><span class="token punctuation">(</span>validationQueryTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//执行校验语句</span>
            rset <span class="token operator">=</span> stmt<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>validationQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果没有返回结果，则校验失败，连接失效</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rset<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//关闭校验时所创建的语句和返回对象</span>
            <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//判断致命异常状态并重置</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onFatalError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>onFatalError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    onFatalError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果上方分支都不存在问题，则该链接有效</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// skip</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JdbcSqlStat</span><span class="token punctuation">.</span><span class="token function">setContextSqlFile</span><span class="token punctuation">(</span>sqlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JdbcSqlStat</span><span class="token punctuation">.</span><span class="token function">setContextSqlName</span><span class="token punctuation">(</span>sqlName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="21_validConnectionChecker_139"></a>2.1 validConnectionChecker</h3> 
<p>validConnectionChecker是Druid针对不同数据库所提供不同的检查器，是<code>ValidConnectionChecker</code>接口的实现类，默认提供<code>MySql</code>、<code>ORACLE</code>、<code>SQL_SERVER</code>、<code>POSTGRESQL</code>以及<code>OCEANBASE</code>的检查器，这些检查器中提供了默认的<code>validationQuery</code>，用于在没有配置<code>validationQuery</code>的时候进行处理。</p> 
<p>这些检查器将在连接池初始化的时候被自动识别加载。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略部分代码<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">initExceptionSorter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">//调用方法初始化连接检查器</span>
        <span class="token function">initValidConnectionChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validationQueryCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略部分代码<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Druid通过驱动类名进行判断，自动识别对应的检查器。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initValidConnectionChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//如果已经设置过检查器，则不继续执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>validConnectionChecker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//获得当前驱动的类名</span>
    <span class="token class-name">String</span> realDriverClassName <span class="token operator">=</span> driver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//对不同类型数据库进行判断并设置对应的检查器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">isMySqlDriver</span><span class="token punctuation">(</span>realDriverClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>validConnectionChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySqlValidConnectionChecker</span><span class="token punctuation">(</span>usePingMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>ORACLE_DRIVER<span class="token punctuation">)</span>
               <span class="token operator">||</span> realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>ORACLE_DRIVER2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>validConnectionChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OracleValidConnectionChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>SQL_SERVER_DRIVER<span class="token punctuation">)</span>
               <span class="token operator">||</span> realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>SQL_SERVER_DRIVER_SQLJDBC4<span class="token punctuation">)</span>
               <span class="token operator">||</span> realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>SQL_SERVER_DRIVER_JTDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>validConnectionChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MSSQLValidConnectionChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>POSTGRESQL_DRIVER<span class="token punctuation">)</span>
               <span class="token operator">||</span> realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>ENTERPRISEDB_DRIVER<span class="token punctuation">)</span>
               <span class="token operator">||</span> realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>POLARDB_DRIVER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>validConnectionChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PGValidConnectionChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>OCEANBASE_DRIVER<span class="token punctuation">)</span>
               <span class="token operator">||</span> <span class="token punctuation">(</span>realDriverClassName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">JdbcConstants</span><span class="token punctuation">.</span>OCEANBASE_DRIVER2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DbType</span> dbType <span class="token operator">=</span> <span class="token class-name">DbType</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dbTypeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>validConnectionChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OceanBaseValidConnectionChecker</span><span class="token punctuation">(</span>dbType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22_MySqlValidConnectionChecker_192"></a>2.2 独特的MySqlValidConnectionChecker</h3> 
<p>在MySQL检查器中，存在一个特殊的属性<code>usePingMethod</code>，如果开启了这个属性，MySQL检查器将不会通过执行SQL的方式对连接进行校验，而是会通过MySQL所提供的<code>pingInternal</code>方法发送ping进行校验，该属性通过连接池中的属性进行传递，默认为false，且暂不支持参数配置，需要自行调用set方法进行设置。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySqlValidConnectionChecker</span> <span class="token keyword">extends</span> <span class="token class-name">ValidConnectionCheckerAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">ValidConnectionChecker</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_VALIDATION_QUERY_TIMEOUT <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_VALIDATION_QUERY <span class="token operator">=</span> <span class="token string">"SELECT 1"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span>  LOG              <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">MySqlValidConnectionChecker</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Method</span>   ping<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span>  usePingMethod <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MySqlValidConnectionChecker</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> usePingMethod<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//通过反射的方式获得pingInternal的实例</span>
            clazz <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.MySQLConnection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                clazz <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.ConnectionImpl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ping <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"pingInternal"</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">//如果没有加载成功的话，则依旧会使用SQL进行校验</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ping <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> usePingMethod <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>usePingMethod <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Cannot resolve com.mysql.jdbc.Connection.ping method.  Will use 'SELECT 1' instead."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">configFromProperties</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValidConnection</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> conn<span class="token punctuation">,</span> <span class="token class-name">String</span> validateQuery<span class="token punctuation">,</span> <span class="token keyword">int</span> validationQueryTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//判断是否使用ping进行校验</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>usePingMethod<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token keyword">instanceof</span> <span class="token class-name">DruidPooledConnection</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                conn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DruidPooledConnection</span><span class="token punctuation">)</span> conn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token keyword">instanceof</span> <span class="token class-name">ConnectionProxy</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                conn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConnectionProxy</span><span class="token punctuation">)</span> conn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRawObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//判断连接对象和连接对象的关系是否可以转化(是一样的类/接口或超类/超接口)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>validationQueryTimeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    validationQueryTimeout <span class="token operator">=</span> DEFAULT_VALIDATION_QUERY_TIMEOUT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//执行方法进行校验</span>
                    ping<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> validationQueryTimeout <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Throwable</span> cause <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token keyword">instanceof</span> <span class="token class-name">SQLException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span><span class="token punctuation">)</span> cause<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> query <span class="token operator">=</span> validateQuery<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>validateQuery <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> validateQuery<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            query <span class="token operator">=</span> DEFAULT_VALIDATION_QUERY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Statement</span> stmt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            stmt <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>validationQueryTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                stmt<span class="token punctuation">.</span><span class="token function">setQueryTimeout</span><span class="token punctuation">(</span>validationQueryTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            rs <span class="token operator">=</span> stmt<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="3_testWhileIdle_289"></a>3. testWhileIdle的校验时点</h2> 
<blockquote> 
 <p>testOnBorrow、testOnReturn两者分别在获得连接/归还连接时进行校验，无特殊内容。</p> 
</blockquote> 
<p>如果以字面意思来看，将会有一个线程或定时器判断链接是否空闲一段时间(timeBetweenEvictionRunsMillis)，实际这个时点却是在获得链接时进行的判断。</p> 
<p>由于testOnBorrow和testWhileIdle都是检查连接有效性，testOnBorrow是每次获取连接必定检查，testWhileIdle是超过一定时间才检查，所以当开启testOnBorrow时，testWhileIdle将不会执行。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">DruidPooledConnection</span> <span class="token function">getConnectionDirect</span><span class="token punctuation">(</span><span class="token keyword">long</span> maxWaitMillis<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> notFullTimeoutRetryCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// handle notFullTimeoutRetry</span>
        <span class="token class-name">DruidPooledConnection</span> poolableConnection<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            poolableConnection <span class="token operator">=</span> <span class="token function">getConnectionInternal</span><span class="token punctuation">(</span>maxWaitMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GetConnectionTimeoutException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>notFullTimeoutRetryCnt <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>notFullTimeoutRetryCount <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                notFullTimeoutRetryCnt<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"get connection timeout retry : "</span> <span class="token operator">+</span> notFullTimeoutRetryCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果开启了testOnBorrow，则每次获得连接时都执行一次校验</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>testOnBorrow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> validate <span class="token operator">=</span> <span class="token function">testConnectionInternal</span><span class="token punctuation">(</span>poolableConnection<span class="token punctuation">.</span>holder<span class="token punctuation">,</span> poolableConnection<span class="token punctuation">.</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"skip not validate connection."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">discardConnection</span><span class="token punctuation">(</span>poolableConnection<span class="token punctuation">.</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//判断连接是否被关闭，如果被关闭，则销毁当前连接(此时Holder应该为空)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>poolableConnection<span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">discardConnection</span><span class="token punctuation">(</span>poolableConnection<span class="token punctuation">.</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 传入null，避免重复关闭</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果开启了testWhileIdle，判断当前连接是空闲了所配置的时间，如果没有则不进行校验</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>testWhileIdle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//得到当前连接的持有者，便于获得统计信息</span>
                <span class="token keyword">final</span> <span class="token class-name">DruidConnectionHolder</span> holder <span class="token operator">=</span> poolableConnection<span class="token punctuation">.</span>holder<span class="token punctuation">;</span>
                <span class="token keyword">long</span> currentTimeMillis             <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//得到当前连接上次的活跃时间、上次的执行时间、上次校验存活的时间(归还连接时)</span>
                <span class="token keyword">long</span> lastActiveTimeMillis          <span class="token operator">=</span> holder<span class="token punctuation">.</span>lastActiveTimeMillis<span class="token punctuation">;</span>
                <span class="token keyword">long</span> lastExecTimeMillis            <span class="token operator">=</span> holder<span class="token punctuation">.</span>lastExecTimeMillis<span class="token punctuation">;</span>
                <span class="token keyword">long</span> lastKeepTimeMillis            <span class="token operator">=</span> holder<span class="token punctuation">.</span>lastKeepTimeMillis<span class="token punctuation">;</span>
                <span class="token comment">//如果开启了checkExecuteTime参数，并且最后执行时间与最后活跃时间不一致，则认为最后的活跃时间是执行时间</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>checkExecuteTime
                    <span class="token operator">&amp;&amp;</span> lastExecTimeMillis <span class="token operator">!=</span> lastActiveTimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lastActiveTimeMillis <span class="token operator">=</span> lastExecTimeMillis<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//最后校验存活时间大于上次活跃时间，则取最后校验存活时间</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lastKeepTimeMillis <span class="token operator">&gt;</span> lastActiveTimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lastActiveTimeMillis <span class="token operator">=</span> lastKeepTimeMillis<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//空闲时间=当前时间-上次活跃时间</span>
                <span class="token keyword">long</span> idleMillis                    <span class="token operator">=</span> currentTimeMillis <span class="token operator">-</span> lastActiveTimeMillis<span class="token punctuation">;</span>
                <span class="token comment">//获得timeBetweenEvictionRunsMillis参数</span>
                <span class="token keyword">long</span> timeBetweenEvictionRunsMillis <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeBetweenEvictionRunsMillis<span class="token punctuation">;</span>
                <span class="token comment">//如果没有配置这个参数，取默认值，60000ms，即1分钟</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>timeBetweenEvictionRunsMillis <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    timeBetweenEvictionRunsMillis <span class="token operator">=</span> DEFAULT_TIME_BETWEEN_EVICTION_RUNS_MILLIS<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//如果空闲时间超过了timeBetweenEvictionRunsMillis或者空闲时间小于0(此时可能发生时钟回拨等问题?)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>idleMillis <span class="token operator">&gt;=</span> timeBetweenEvictionRunsMillis
                    <span class="token operator">||</span> idleMillis <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token comment">// unexcepted branch</span>
                   <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//校验链接状态</span>
                    <span class="token keyword">boolean</span> validate <span class="token operator">=</span> <span class="token function">testConnectionInternal</span><span class="token punctuation">(</span>poolableConnection<span class="token punctuation">.</span>holder<span class="token punctuation">,</span> poolableConnection<span class="token punctuation">.</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"skip not validate connection."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token function">discardConnection</span><span class="token punctuation">(</span>poolableConnection<span class="token punctuation">.</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>removeAbandoned<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">StackTraceElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span> stackTrace <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            poolableConnection<span class="token punctuation">.</span>connectStackTrace <span class="token operator">=</span> stackTrace<span class="token punctuation">;</span>
            poolableConnection<span class="token punctuation">.</span><span class="token function">setConnectedTimeNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            poolableConnection<span class="token punctuation">.</span>traceEnable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            activeConnectionLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                activeConnections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>poolableConnection<span class="token punctuation">,</span> PRESENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                activeConnectionLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultAutoCommit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            poolableConnection<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> poolableConnection<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/480a306935c32c43463bb3f23b107f8a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">拉斯维加斯算法 八皇后问题（C&#43;&#43;实现）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/26b03aaf256105ca55d5f3e3efb9a158/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringIOC 依赖查找</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>