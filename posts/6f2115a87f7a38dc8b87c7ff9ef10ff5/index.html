<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>h5 js调用移动端 相机 相册 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="h5 js调用移动端 相机 相册" />
<meta property="og:description" content="效果：
点击从手机相机获取图片或打开相机拍摄图片， 触屏缩放移动 加载的图片到合适位置
注意这里的几个坑：
1 在红米K40上 出现了 微信浏览器点击，触发change事件后只能调到相册，无法弹出“相机或相册选择框”，而且无法选中相片的问题。
参考 前段H5开发，小米上用input File 为什么获取不到照片的数据？ - 知乎
解决方法如下代码。
&lt;!-- 写成 accept=&#34;image/png,image/jpeg,image/gif&#34; 时 红米k40 微信浏览器无法打开相册 要写成 accept=&#34;image/*&#34; --&gt; &lt;!-- &lt;input type=&#34;file&#34; id=&#34;image_uploads&#34; multiple=&#34;&#34; class=&#34;inputFile&#34; accept=&#34;image/png,image/jpeg,image/gif&#34; &gt; --&gt; &lt;!-- &lt;input type=&#34;file&#34; id=&#34;image_uploads&#34; multiple=&#34;&#34; class=&#34;inputFile&#34; accept=&#34;image/*&#34; &gt; --&gt; 只不过解决后因为问题2 又都注释掉了。
2 在ios系统上 出现了 第一次点击，经常无法触发change事件的情况
具体现象：安卓手机上，微信浏览器、自带浏览器都没有问题。苹果手机上，第一次点击，有时候无法触发change事件(复现频率较高)，第二次点击就好了。访问过一次，点击，好了后，刷新页面也不一定能复现问题。(坑死)
参考 https://stackoverflow.com/questions/47664777/javascript-file-input-onchange-not-working-ios-safari-only
解决方法：
将initNew() 方法里下面这两行注释掉 // this.input = document.querySelector(&#39;#image_uploads&#39;) // this.input.addEventListener(&#39;change&#39;, this.updateImageDisplay) 将 template 里的 &lt;input&gt; 元素注释掉 &lt;!-- 写成 accept=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6f2115a87f7a38dc8b87c7ff9ef10ff5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-09T09:53:04+08:00" />
<meta property="article:modified_time" content="2022-09-09T09:53:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">h5 js调用移动端 相机 相册</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p> 效果：</p> 
<p>点击从手机相机获取图片或打开相机拍摄图片，  触屏缩放移动 加载的图片到合适位置</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/e7/4b/RDYf7kTd_o.gif"></p> 
<p>注意这里的几个坑：</p> 
<p><strong>1  在红米K40上 出现了  微信浏览器点击，触发change事件后只能调到相册，无法弹出“相机或相册选择框”，而且无法选中相片的问题。</strong></p> 
<p>    参考  <a href="https://www.zhihu.com/question/56687897?sort=created" rel="nofollow" title="前段H5开发，小米上用input File 为什么获取不到照片的数据？ - 知乎">前段H5开发，小米上用input File 为什么获取不到照片的数据？ - 知乎</a></p> 
<p>解决方法如下代码。</p> 
<pre><code class="language-javascript">&lt;!-- 写成 accept="image/png,image/jpeg,image/gif"   时  红米k40 微信浏览器无法打开相册  要写成  accept="image/*"  --&gt;
          &lt;!-- &lt;input type="file" id="image_uploads" multiple=""  class="inputFile" accept="image/png,image/jpeg,image/gif"  &gt; --&gt;
          &lt;!-- &lt;input type="file" id="image_uploads" multiple=""  class="inputFile" accept="image/*"  &gt; --&gt;</code></pre> 
<p>只不过解决后因为问题2 又都注释掉了。</p> 
<p><strong>2  在ios系统上 出现了  第一次点击，经常无法触发change事件的情况</strong></p> 
<p><strong>     </strong>具体现象：安卓手机上，微信浏览器、自带浏览器都没有问题。苹果手机上，第一次点击，有时候无法触发change事件(复现频率较高)，第二次点击就好了。访问过一次，点击，好了后，刷新页面也不一定能复现问题。<strong>(坑死)</strong><br>     参考  https://stackoverflow.com/questions/47664777/javascript-file-input-onchange-not-working-ios-safari-only</p> 
<p>       解决方法：<br>         将initNew() 方法里下面这两行注释掉   </p> 
<pre><code class="language-javascript">  // this.input = document.querySelector('#image_uploads')
        // this.input.addEventListener('change', this.updateImageDisplay)</code></pre> 
<p>        将 template 里的  &lt;input&gt; 元素注释掉  </p> 
<pre><code class="language-javascript">&lt;!-- 写成 accept="image/png,image/jpeg,image/gif"   时  红米k40 微信浏览器无法打开相册  要写成  accept="image/*"  --&gt;
          &lt;!-- &lt;input type="file" id="image_uploads" multiple=""  class="inputFile" accept="image/png,image/jpeg,image/gif"  &gt; --&gt;
          &lt;!-- &lt;input type="file" id="image_uploads" multiple=""  class="inputFile" accept="image/*"  &gt; --&gt;</code></pre> 
<p>        换成initNew() 方法里</p> 
<pre><code class="language-javascript">// input 元素绑定 change 事件 
        let mobileCamera = document.querySelector('#mobileCamera')
        let input =  document.createElement("input"); 
        input = document.body.appendChild(input)
        input.type = "file"
        input.id = "image_uploads"
        input.className="inputFile";
        input.multiple= true
        input.accept="image/png,image/jpeg,image/gif"
        input.style.width=  "1%"
        input.style.height = "1%"
        input.style.position =  'absolute';
        input.style.opacity = 0;
        input.addEventListener('change', this.updateImageDisplay)</code></pre> 
<p>注意这里   </p> 
<p>    input = document.body.appendChild(input)  ，绑定在 document.body 上，一开始绑定在 &lt;div id="mobileCamera" class="mobileCamera"  v-loading="loading"&gt; 上，未解决问题，至于绑定在其他dom上可以不，还未测试。</p> 
<p>    绑定change事件用 ，input.addEventListener('change', this.updateImageDisplay)  </p> 
<p>用onchange 未生效。</p> 
<p>         </p> 
<p>   </p> 
<p><strong>3  功能设计里，是用img 或者div点击后，去触发 input 元素的click事件的。而这种情况下，在ios系统上 出现了 img、div  需要双击的情况才能触发click，input 支持单击。  Android手机无此问题。</strong><br>     参考  <a href="https://blog.csdn.net/qq_42309685/article/details/102526869" title="tap事件_苏醒!的博客-CSDN博客_tap事件">tap事件_苏醒!的博客-CSDN博客_tap事件</a></p> 
<p>    解决方法 </p> 
<pre><code class="language-javascript">        let mobileCamera = document.querySelector('#mobileCamera')
        // 用 tab 换掉 click ，click在ios safari浏览器上有 单击失效，需要双击  的问题
        this.bindTapEvent(mobileCamera,(e)=&gt;{
          input.click();
        })


       bindTapEvent(dom,callback){
            var startTime = 0;
            var isMove = false;
            dom.addEventListener('touchstart',function(){
              startTime = Date.now();
              console.log(startTime);
            });
            dom.addEventListener('touchmove',function(){
              isMove = true;
            });
            dom.addEventListener('touchend',function(e){
              console.log(Date.now()-startTime);
              if((Date.now()-startTime)&lt;250&amp;&amp;isMove == false){
                callback&amp;&amp;callback.call(this,e)
              }else{
            console.log('失败');
              }
              isMove = false;
              startTime = 0;
            });
      },</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p>直接上代码</p> 
<pre><code class="language-javascript">&lt;template&gt;
  &lt;div class="component"&gt;
    &lt;div id="mobileCamera" class="mobileCamera"  v-loading="loading"&gt;
          &lt;!-- 写成 accept="image/png,image/jpeg,image/gif"   时  红米k40 微信浏览器无法打开相册  要写成  accept="image/*"  --&gt;
          &lt;!-- &lt;input type="file" id="image_uploads" multiple=""  class="inputFile" accept="image/png,image/jpeg,image/gif"  &gt; --&gt;
          &lt;!-- &lt;input type="file" id="image_uploads" multiple=""  class="inputFile" accept="image/*"  &gt; --&gt;
             
          &lt;div class="imgPreviewDiv" v-show="src"&gt;
            &lt;img  id="mobileCameraPreview" :src="src" class="imgPreview"   &gt;
          &lt;/div&gt;
          &lt;img src="./assets/b.png" class="imgCamera"  v-if="show"&gt;

    &lt;/div&gt;

  &lt;/div&gt;
&lt;/template&gt;
import Hammer from 'hammerjs'
import axios from 'axios'

 export default {
    name: 'conponent01',
    props: {
  
    },
    computed: {},
    data () {
      return {

        input: undefined,
        src: "",
        show1:false,
        show:true,
        loading:false,

        // 拖动缩放
        imgScale: 1,
        oldScale: 1,
        imgPos: {
          x: 0,
          y: 0
        },

      }
    },
    mounted () {
  
      // 图片操作 移动 缩放
      this.zoom()
      
      this.initNew()
    },
  
    methods: {
      // 同事写的   移动端 移动、缩放元素
      zoom(){
        var square = this.$el.querySelector('#mobileCameraPreview')
          let that = this
          // Create an instance of Hammer with the reference.
          var hammer = new Hammer(square)
          hammer.get('pinch').set({ enable: true })
          // Subscribe to a quick start event: press, tap, or doubletap.
          // For a full list of quick start events, read the documentation.
          hammer.on('panend', function (e) {
            that.imgPos.x += e.deltaX
            that.imgPos.y += e.deltaY
          })
          hammer.on('pan', function (e) {
            // console.log('pan=====', e)
            square.style.transform = `matrix(${that.imgScale},0,0,${that.imgScale},${that.imgPos.x + e.deltaX},${that.imgPos.y + e.deltaY})`
          })
          hammer.on('pinch', function (e) {
            that.imgScale = Math.max(Math.min(that.oldScale * e.scale, 10), 1)
            square.style.transform = `matrix(${that.imgScale},0,0,${that.imgScale},${that.imgPos.x},${that.imgPos.y})`
          })
          hammer.on('pinchend', function (e) {
            that.oldScale = that.imgScale
          })
      },
 
      

      initNew () {
        // input 元素绑定 change 事件 
        let mobileCamera = document.querySelector('#mobileCamera')
        let input =  document.createElement("input"); 
        input = document.body.appendChild(input)
        input.type = "file"
        input.id = "image_uploads"
        input.className="inputFile";
        input.multiple= true
        input.accept="image/png,image/jpeg,image/gif"
        input.style.width=  "1%"
        input.style.height = "1%"
        input.style.position =  'absolute';
        input.style.opacity = 0;
        input.addEventListener('change', this.updateImageDisplay)
        
         //  在ios系统上 出现了  第一次点击，经常无法触发change事件的情况
         // 参考  https://stackoverflow.com/questions/47664777/javascript-file-input-onchange-not-working-ios-safari-only
        //  将下面这两行  和  template 里的  &lt;input&gt; 元素注释掉  换成上面这个 createElement('input')  
        // this.input = document.querySelector('#image_uploads')
        // this.input.addEventListener('change', this.updateImageDisplay)
        // 用 tab 换掉 click ，click在ios safari浏览器上有 单击失效，需要双击  的问题
        this.bindTapEvent(mobileCamera,(e)=&gt;{
          input.click();
        })
      },
      // 参考 https://blog.csdn.net/qq_42309685/article/details/102526869
      bindTapEvent(dom,callback){
        var startTime = 0;
        var isMove = false;
        dom.addEventListener('touchstart',function(){
          startTime = Date.now();
          console.log(startTime);
        });
        dom.addEventListener('touchmove',function(){
          isMove = true;
        });
        dom.addEventListener('touchend',function(e){
          console.log(Date.now()-startTime);
          if((Date.now()-startTime)&lt;250&amp;&amp;isMove == false){
            callback&amp;&amp;callback.call(this,e)
          }else{
            console.log('失败');
          }
          isMove = false;
          startTime = 0;
        });
      },
      imgClick () {
        this.input.click();
      },
      updateImageDisplay () {
        let _this = this
        this.loading = true
        
        const curFiles = this.input.files
        if (curFiles.length === 0) {
          // no file
        } else {
          for (const file of curFiles) {
            // 方法1  上传后台  返回服务器端图片地址 赋值给 src
            var formData = new FormData()
            formData.append('files',file)
            axios({
                  method: 'post',
                  url: 'https://xxxxxx/api/ossupload/uploadFile',
                  data: formData
            }).then((res)=&gt;{
              console.log(res.data.data[0].path)
              _this.show1 = true
              _this.show = false
              _this.$nextTick(()=&gt;{
                _this.src = res.data.data[0].path
                _this.loading = false

                // 图片操作相关
                _this.imgScale = 1
                _this.oldScale = 1
                _this.imgPos = {
                  x: 0,
                  y: 0
                }
                _this.$el.querySelector('#mobileCameraPreview').style.transform = `matrix(1,0,0,1,0,0)`
              })
            })

            // 方法2  读成 base64 赋值给 src
            // var reader = new FileReader()
            // reader.readAsDataURL(file)
            // reader.onload = function () {
            //   _this.show1 = true
            //   _this.show = false
            //   _this.$nextTick(()=&gt;{
            //     _this.src = this.result
            //     _this.imgScale = 1
            //     _this.oldScale = 1
            //     _this.imgPos = {
            //       x: 0,
            //       y: 0
            //     }
            //     _this.$el.querySelector('#mobileCameraPreview').style.transform = `matrix(1,0,0,1,0,0)`
            //   })
            // }
          }
        }
      },
  
  
    },

  }
&lt;/script&gt;

&lt;style scoped&gt;
  .component {
    width: 100%;
    height: 100%;
  }
  .mobileCamera{
    width: 100%; 
    height: 100%;
    cursor: pointer;
    border-radius: 50%;
    display:flex;
    justify-content: center;   
    align-items: center;  
    flex-direction: column;
    
  }
  .imgPreviewDiv {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    box-shadow: 0 0 15px 10px #d5d1a775; 
    overflow: hidden;
    display:flex;
    justify-content: center;   
    align-items: center;  
    flex-direction: column;
  }
  .imgPreview {
    width: 100%;
    box-shadow: 0 0 15px 10px #d5d1a775; 
  }
  .imgCamera {
    width: 80px; 
    height: 80px;
  }
  .inputFile {
    width: 1%;
    height: 1%;
    position:absolute;
    opacity: 0;
  }



    
&lt;/style&gt;</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p><br>  </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a81610a99d73ffcf09991c2ec4241b3b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C#读写各类文件合集</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e9a0c33627c7b5c226df1c6133cb10dd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue3实现video控件的h5端进度条拖拽与跳转</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>