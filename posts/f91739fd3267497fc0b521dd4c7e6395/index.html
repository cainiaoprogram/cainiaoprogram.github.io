<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>rsync 远程同步 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="rsync 远程同步" />
<meta property="og:description" content="rsync 远程同步 前言一、Rsync简介(1)rsync介绍(2)rsync同步方式 二、rsync同步源(1)配置rsync源①基本思路②配置文件rsync.conf③独立的账号密码④启用rsync服务 三、常用Rsync命令四、rsync与cp、scp对比五、配置源的两种表达方式六、配置服务端与客户端的实验(1)配置环境(2)配置client端(3)配置server端(4)rsync&#43;inotify实时同步①inotify简介②配置Rsync&#43;Inotify 实时同步③Master 关闭只读模式并为共享目录赋权④优化 Slave 内核参数⑤编译安装inotify-tools⑥编写触发同步脚本 七、rsync的应用场景八、总结 前言 rsync（Remote Sync，远程同步） 是一个开源的快速备份工具，可以在不同主机之间镜像同步整个目录树，支持增量备份，并保持链接和权限，且采用优化的同步算法，传输前执行压缩，因此非常适用于异地备份、镜像服务器等应用。
一、Rsync简介 (1)rsync介绍 rsync是一款开源的、快速的、多功能的、可实现全量及增量的本地或远程数据同步备份的优秀工具。并且可以不进行改变原有数据的属性信息，实现数据的备份迁移特性。
在远程同步任务中，负责发起rsync同步操作的客户机称为发起端，而负责响应来自客户机的rsync同步操作的服务器称为同步源。在同步过程中，同步源负责提供文件的原始位置，发起端应对该位置具有读取权限。
Rsync 是 Linux 系统下的数据镜像备份工具，使用快速增量备份工具 Remote Sync 可以远程同步， 可以在不同主机之间进行同步，可实现全量备份与增量备份，保持链接和权限，且采用优化的同步算法， 传输前执行压缩，因此非常适合用于架构集中式备份或异地备份等应用。同时Rsync支持本地复制，或者与其他 SSH、rsync 主机同步，rsync监听端口:873、rsync运行模式:C/S
官方网站：https://rsync.samba.org/
(2)rsync同步方式 完整备份：每次备份都是从备份源将所有的文件或目录备份到目的地。
差量备份：备份上次完全备份以后有变化的数据（他针对的上次的完全备份，他备份过程中不清除存档属性）。
增量备份：备份上次备份以后有变化的数据（他才不管是那种类型的备份，有变化的数据就备份，他会清除存档属性）
二、rsync同步源 rsync同步源指备份操作的远程服务器，也称为备份源 (1)配置rsync源 ①基本思路 建立rsyncd.conf配置文件、独立的账号文件启用rsync的 --daemon模式 ②配置文件rsync.conf 认证配置auth users、secrets file，不加则为匿名
③独立的账号密码 用户名:密码每行一个用户记录独立的账号数据，不依赖系统账号 ④启用rsync服务 通过 --daemon独自提供服务，rsync --daemon执行kill $(cat /var/run/rsyncd.pid)关闭服务 三、常用Rsync命令 命令使用语法 rsync 【选项】原始位置 目标位置 常用选项 -r递归模式，包含目录及子目录中的所有文件。-l对于符号链接文件仍然复制为符号链接文件。-v显示同步过程的详细（verbose）信息。-z在传输文件时进行压缩（compress）。-a归档模式，保留文件的权限、属性等信息，等同于组合选项“-rlptgoD”。-p保留文件的权限标记。-t保留文件的时间标记。-g保留文件的属组标记（仅超级用户使用）。-o保留文件的属主标记（仅超级用户使用）。-H保留硬连接文件。-A保留 ACL 属性信息。-D保留设备文件及其他特殊文件。–delete删除目标位置有而原始位置没有的文件。–checksum根据校验和（而不是文件大小、修改时间）来决定是否跳过文件。 –delete的作用简单来说，就是删除差异文件，保留一致性
四、rsync与cp、scp对比 cp命令是一种典型的将文件完整的拷贝到一个位置。而rsync是，第一次拷贝，在目标位置没有的时候，rsync是全量拷贝过去，但是第二次拷贝的时候，只会对差异项进行同步拷贝。所有如果对同一个文件进行二次备份的话，rsync速度会相较于cp而言更快。cp只支持本地，而rsync支持远程scp是基于cp原理，也是属于完整性拷贝文件。假设rsync和scp拷贝的文件都是第一，目标地址都没有要同步的文件，此时，这两者的差异在于，第一个，这个要传输的文件大不大，第二个要看在传输的过程中，用的带宽大不大。如果文件不大的情况下，scp是把数据从磁盘中的块存储提取出来，封装一下，网络传过去，此时scp更快，如果是更大的文件，比如说40G，带宽只支持100M的带宽，scp想要传输，需要拆分数据，一段一段传输。而rsync会根据一个逻辑意义上的空间，把数据划分出来，把数据先压缩再传输，所以这种方式而言，带宽校，文件大，这个时候先压缩再传输会比较快。此时适合用rsync远程同步。 五、配置源的两种表达方式 格式一：
用户名@主机地址::共享模块名 例： rsync -avz backuper@192." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f91739fd3267497fc0b521dd4c7e6395/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-13T23:44:23+08:00" />
<meta property="article:modified_time" content="2022-07-13T23:44:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">rsync 远程同步</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>rsync 远程同步</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#Rsync_3" rel="nofollow">一、Rsync简介</a></li><li><ul><li><a href="#1rsync_4" rel="nofollow">(1)rsync介绍</a></li><li><a href="#2rsync_13" rel="nofollow">(2)rsync同步方式</a></li></ul> 
  </li><li><a href="#rsync_20" rel="nofollow">二、rsync同步源</a></li><li><ul><li><a href="#1rsync_25" rel="nofollow">(1)配置rsync源</a></li><li><ul><li><a href="#_26" rel="nofollow">①基本思路</a></li><li><a href="#rsyncconf_29" rel="nofollow">②配置文件rsync.conf</a></li><li><a href="#_31" rel="nofollow">③独立的账号密码</a></li><li><a href="#rsync_36" rel="nofollow">④启用rsync服务</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Rsync_40" rel="nofollow">三、常用Rsync命令</a></li><li><a href="#rsynccpscp_64" rel="nofollow">四、rsync与cp、scp对比</a></li><li><a href="#_69" rel="nofollow">五、配置源的两种表达方式</a></li><li><a href="#_82" rel="nofollow">六、配置服务端与客户端的实验</a></li><li><ul><li><a href="#1_89" rel="nofollow">(1)配置环境</a></li><li><a href="#2client_100" rel="nofollow">(2)配置client端</a></li><li><a href="#3server_191" rel="nofollow">(3)配置server端</a></li><li><a href="#4rsyncinotify_242" rel="nofollow">(4)rsync+inotify实时同步</a></li><li><ul><li><a href="#inotify_243" rel="nofollow">①inotify简介</a></li><li><a href="#RsyncInotify__261" rel="nofollow">②配置Rsync+Inotify 实时同步</a></li><li><a href="#Master__266" rel="nofollow">③Master 关闭只读模式并为共享目录赋权</a></li><li><a href="#_Slave__287" rel="nofollow">④优化 Slave 内核参数</a></li><li><a href="#inotifytools_307" rel="nofollow">⑤编译安装inotify-tools</a></li><li><a href="#_326" rel="nofollow">⑥编写触发同步脚本</a></li></ul> 
  </li></ul> 
  </li><li><a href="#rsync_387" rel="nofollow">七、rsync的应用场景</a></li><li><a href="#_426" rel="nofollow">八、总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<p>rsync（Remote Sync，远程同步） 是一个开源的快速备份工具，可以在不同主机之间镜像同步整个目录树，支持增量备份，并保持链接和权限，且采用优化的同步算法，传输前执行压缩，因此非常适用于异地备份、镜像服务器等应用。</p> 
<h2><a id="Rsync_3"></a>一、Rsync简介</h2> 
<h3><a id="1rsync_4"></a>(1)rsync介绍</h3> 
<p>rsync是一款开源的、快速的、多功能的、可实现全量及增量的本地或远程数据同步备份的优秀工具。并且可以不进行改变原有数据的属性信息，<strong>实现数据的备份迁移特性</strong>。</p> 
<p>在远程同步任务中，负责<strong>发起rsync同步操作的客户机称为发起端</strong>，而负责响<strong>应来自客户机的rsync同步操作的服务器称为同步源</strong>。在同步过程中，同步源负责提供文件的原始位置，发起端应对该位置具有读取权限。</p> 
<p>Rsync 是 Linux 系统下的数据镜像备份工具，使用快速增量备份工具 Remote Sync 可以远程同步， 可以在不同主机之间进行同步，可实现全量备份与增量备份，保持链接和权限，且采用优化的同步算法， 传输前执行压缩，因此非常适合用于架构集中式备份或异地备份等应用。同时Rsync支持本地复制，或者与其他 SSH、rsync 主机同步，<strong>rsync监听端口:873、rsync运行模式:C/S</strong></p> 
<p>官方网站：https://rsync.samba.org/</p> 
<h3><a id="2rsync_13"></a>(2)rsync同步方式</h3> 
<ol><li> <p>完整备份：每次备份都是从备份源将所有的文件或目录备份到目的地。</p> </li><li> <p>差量备份：备份上次完全备份以后有变化的数据（他针对的上次的完全备份，他备份过程中不清除存档属性）。</p> </li><li> <p>增量备份：备份上次备份以后有变化的数据（他才不管是那种类型的备份，有变化的数据就备份，他会清除存档属性）</p> </li></ol> 
<h2><a id="rsync_20"></a>二、rsync同步源</h2> 
<ul><li>rsync同步源</li><li>指备份操作的远程服务器，也称为备份源</li></ul> 
<p><img src="https://images2.imgbox.com/bd/c4/M2vRzLN5_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1rsync_25"></a>(1)配置rsync源</h3> 
<h4><a id="_26"></a>①基本思路</h4> 
<ul><li>建立rsyncd.conf配置文件、独立的账号文件</li><li>启用rsync的 --daemon模式</li></ul> 
<h4><a id="rsyncconf_29"></a>②配置文件rsync.conf</h4> 
<p>认证配置auth users、secrets file，不加则为匿名</p> 
<h4><a id="_31"></a>③独立的账号密码</h4> 
<ul><li>用户名:密码</li><li>每行一个用户记录</li><li>独立的账号数据，不依赖系统账号</li></ul> 
<h4><a id="rsync_36"></a>④启用rsync服务</h4> 
<ul><li>通过 --daemon独自提供服务，rsync --daemon</li><li>执行kill $(cat /var/run/rsyncd.pid)关闭服务</li></ul> 
<h2><a id="Rsync_40"></a>三、常用Rsync命令</h2> 
<pre><code>命令使用语法
rsync 【选项】原始位置 目标位置
</code></pre> 
<ul><li>常用选项</li></ul> 
<table><thead><tr><th>-r</th><th>递归模式，包含目录及子目录中的所有文件。</th></tr></thead><tbody><tr><td>-l</td><td>对于符号链接文件仍然复制为符号链接文件。</td></tr><tr><td>-v</td><td>显示同步过程的详细（verbose）信息。</td></tr><tr><td>-z</td><td>在传输文件时进行压缩（compress）。</td></tr><tr><td>-a</td><td>归档模式，保留文件的权限、属性等信息，等同于组合选项“-rlptgoD”。</td></tr><tr><td>-p</td><td>保留文件的权限标记。</td></tr><tr><td>-t</td><td>保留文件的时间标记。</td></tr><tr><td>-g</td><td>保留文件的属组标记（仅超级用户使用）。</td></tr><tr><td>-o</td><td>保留文件的属主标记（仅超级用户使用）。</td></tr><tr><td>-H</td><td>保留硬连接文件。</td></tr><tr><td>-A</td><td>保留 ACL 属性信息。</td></tr><tr><td>-D</td><td>保留设备文件及其他特殊文件。</td></tr><tr><td>–delete</td><td>删除目标位置有而原始位置没有的文件。</td></tr><tr><td>–checksum</td><td>根据校验和（而不是文件大小、修改时间）来决定是否跳过文件。</td></tr></tbody></table> 
<p><strong>–delete的作用简单来说，就是删除差异文件，保留一致性</strong></p> 
<h2><a id="rsynccpscp_64"></a>四、rsync与cp、scp对比</h2> 
<ul><li>cp命令是<strong>一种典型的将文件完整的拷贝到一个位置</strong>。而rsync是，第一次拷贝，在目标位置没有的时候，rsync是<strong>全量拷贝过去，但是第二次拷贝的时候，只会对差异项进行同步拷贝</strong>。所有如果对同一个文件进行二次备份的话，rsync速度会相较于cp而言更快。</li><li>cp只支持本地，而rsync支持远程</li><li>scp是基于cp原理，也是属于完整性拷贝文件。假设rsync和scp拷贝的文件都是第一，目标地址都没有要同步的文件，此时，这两者的差异在于，第一个，这个要传输的文件大不大，第二个要看在传输的过程中，用的带宽大不大。如果文件不大的情况下，scp是把数据从磁盘中的块存储提取出来，封装一下，网络传过去，此时scp更快，如果是更大的文件，比如说40G，带宽只支持100M的带宽，scp想要传输，需要拆分数据，一段一段传输。而rsync会根据一个逻辑意义上的空间，把数据划分出来，把数据先压缩再传输，所以这种方式而言，带宽校，文件大，这个时候先压缩再传输会比较快。此时适合用rsync远程同步。</li></ul> 
<h2><a id="_69"></a>五、配置源的两种表达方式</h2> 
<p>格式一：</p> 
<pre><code>用户名@主机地址::共享模块名
例：
rsync -avz backuper@192.168.159.230::wwwroot /opt/
</code></pre> 
<p>格式二：</p> 
<pre><code>rsync://用户名@主机地址/共享模块名
例：
rsync -avz rsync://backuper@192.168.159.230/wwwroot /opt/
</code></pre> 
<h2><a id="_82"></a>六、配置服务端与客户端的实验</h2> 
<pre><code>前提首先关闭防火墙和增强功能
systemctl stop firewalld
setenforce 0
</code></pre> 
<p>1、关闭防火墙及安装机制<br> <img src="https://images2.imgbox.com/3a/d8/rl2Mt2ku_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1_89"></a>(1)配置环境</h3> 
<table><thead><tr><th>主机</th><th>操作系统</th><th>IP 地址</th></tr></thead><tbody><tr><td>server</td><td>CentOS7</td><td>192.168.159.230</td></tr><tr><td>client</td><td>CentOS7</td><td>192.168.159.231</td></tr></tbody></table> 
<pre><code>配置rsync源服务器（192.168.159.230）
rpm -q rsync							#一般系统已默认安装rsync
</code></pre> 
<h3><a id="2client_100"></a>(2)配置client端</h3> 
<pre><code>systemctl stop firewalld
systemctl disable firewalld
setenforce 0
#关闭防火墙及安装机制

yum install -y httpd rsync
#rsync系统一般已默认安装，安装httpd是为了生成/var/www/html目录（后续会用到作为共享目录）

vim /etc/rsyncd.conf
#编辑rsync配置文件
uid = root
gid = root
use chroot = yes
address = 192.168.159.230
port 873
log file = /var/log/rsyncd.log
pid file = /var/run/rsyncd.pid
hosts allow = 192.168.159.0/24
[wwwroot]        
path = /var/www/html
comment = Document Root of www.yxp.com
read only = yes
dont comperss = *.gz *.bz2 *.tgz *.zip *.rar *.z
auth users = backuper	
secrets file = /etc/rsyncd_users.db
----详解----
uid = root											#用户id,表示共享权限能执行的身份
gid = root											#组id
use chroot = yes									#开启，禁锢在源目录，表示允许在访问我备份的目录或文件的时候，使用的角色是root，同时你访问本地目录时拥有的也是root权限
address = 192.168.159.320						#监听地址
port 873											#默认端口号为873
log file = /var/log/rsyncd.log						#日志文件存放位置
pid file = /var/run/rsyncd.pid						#存放进程id的文件位置
hosts allow = 192.168.159.0/24						#允许访问的主机网段，有点类似于黑白名单
[wwwroot]        									#共享模块的名称，rsync默认调用该模块，默认我调用的路径是该模块指定的路径
path = /var/www/html								#源目录路径
comment = Document Root of www.yxp.com				#
read only = yes										#是否为只读
dont comperss = *.gz *.bz2 *.tgz *.zip *.rar *.z	#同步时不再压缩的文件类型，因为同步时，-avz已经进行压缩
auth users = backuper									#授权用户，使用wwwroot模块的用户是哪个用户，多个账户以空格隔开
secrets file = /etc/rsyncd_users.db					#存放账号信息的数据文件，一行一个
----
#############################################
uid = nobody
gid = nobody
use chroot = yes                                                
address = 192.168.159.230
port 873                                                                
log file = /var/log/rsyncd.log                  
pid file = /var/run/rsyncd.pid                  
hosts allow = 192.168.159.0/24
[wwwroot]                                                               
path = /var/www/html                                    
comment = Document Root of www.youzi.com
read only = yes                                                  
dont comperss = *.gz *.bz2 *.tgz *.zip *.rar *.z        
auth users = kiki                                               
secrets file = /etc/rsyncd_users.db
###############################################
vim /etc/rsyncd_users.db
kiki:123123
#编辑用户账号文件，固定格式为[名称:密码]，一行一个

chmod 600 /etc/rsyncd_users.db
#官方要求，最好只是赋权600！

rsync --daemon
#开启服务
netstat -natp | grep rsync
#检测端口号，确认服务是否成功开启

cd /var/www/html
#切换至共享目录下
touch dog.html cat.html
ls
</code></pre> 
<p>1、关闭防火墙及安装机制<br> <img src="https://images2.imgbox.com/52/b5/tM7icKHH_o.png" alt="在这里插入图片描述"><br> 2、rsync系统一般已默认安装，安装httpd是为了生成/var/www/html目录（后续会用到作为共享目录）<br> <img src="https://images2.imgbox.com/79/59/a0PuVdVW_o.png" alt="在这里插入图片描述"><br> 3、编辑rsync配置文件<br> <img src="https://images2.imgbox.com/b4/15/wke5U9sw_o.png" alt="在这里插入图片描述"><br> 4、编辑用户账号文件，固定格式为[名称：密码]，一行一个<br> <img src="https://images2.imgbox.com/f1/44/7JkqNZFN_o.png" alt="在这里插入图片描述"><br> 5、赋权，官方推荐最好600<br> <img src="https://images2.imgbox.com/b8/79/WbAJDaDa_o.png" alt="在这里插入图片描述"><br> 6、开启服务、检测端口号，确认服务是否成功开启<br> <img src="https://images2.imgbox.com/fe/99/iWJ8d2ED_o.png" alt="在这里插入图片描述"><br> 7、切换至共享目录下，创建文件<br> <img src="https://images2.imgbox.com/1d/7d/34qP21e5_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3server_191"></a>(3)配置server端</h3> 
<pre><code>systemctl stop firewalld
systemctl disable firewalld
setenforce 0
#关闭防火墙及安装机制

yum install -y rsync
#安装rsync

mkdir /opt/haha

#创建一个目录，用来同步

rsync -avz backuper@192.168.159.230::wwwroot /abc
#使用rsync同步备份源的同步文件

ls 
#查看同步是否成功


vim /etc/server.pass
123123
#编辑免交互密钥文件，第一行为密码


chmod 600 /etc/server.pass
#给密钥文件赋权600
rsync -avz kiki@192.168.159.230::wwwroot /opt/haha
#同步数据

rsync -az --delete --password-file=/etc/server.pass backuper@192.168.159.230::wwwroot /opt/haha
#rsync，使用密钥文件/etc/server/pass对应backuper用户，IP地址为192.168.159.230的共享模块文件进行压缩，并归档同步至当前服务器的/abc目录下，同时删除差异内容，如果原目标有的，会增加，原目标没有的，会删除。保持一致性。

ls /abc
#查看下行同步是否成功
</code></pre> 
<p>1、关闭防火墙及增强机制<br> <img src="https://images2.imgbox.com/b8/f2/ZlEWu26G_o.png" alt="在这里插入图片描述"><br> 2、安装rsync<br> <img src="https://images2.imgbox.com/11/b6/9zgR1Urm_o.png" alt="在这里插入图片描述"><br> 3、创建一个目录同步目录<br> <img src="https://images2.imgbox.com/67/e4/qo96ixZF_o.png" alt="在这里插入图片描述"><br> 4、使用rsync同步备份源的同步文件，并查看是否完成<br> <img src="https://images2.imgbox.com/ed/a3/ZqSbPYyA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/17/e3/BVBtDTwg_o.png" alt="在这里插入图片描述"><br> 5、同步数据<br> <img src="https://images2.imgbox.com/d0/f7/P0adHGwk_o.png" alt="在这里插入图片描述"><br> 6、使用rsync -az --delete 同步<br> <img src="https://images2.imgbox.com/0e/ef/9sCEzC5n_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4rsyncinotify_242"></a>(4)rsync+inotify实时同步</h3> 
<h4><a id="inotify_243"></a>①inotify简介</h4> 
<p>可以监控文件系统的变动情况，并做出通知响应</p> 
<pre><code>#调整inotify内核参数(优化)
letc/ sysctl.conf(内核参数配置文件)
inotifywait:    #用于持续监控,实时输出结果
inotifywatch:   #用于短期监控,任务完成后再输出结果
max_queue_events   #监控事件队列大小
max_user instances      #最多监控实例数，可以看成最多可以监控多少个实例
max_user_watches        #每个实例最多监控文件数

inotifywait格式参数
常见参数    说明
-m          持续进行监控
-r          递归监控所有子对象
-q          简化输出信息
-e          指定要监控哪些事件类型（*）
</code></pre> 
<h4><a id="RsyncInotify__261"></a>②配置Rsync+Inotify 实时同步</h4> 
<ul><li>使用inotify通知接口，可以用来监控文件系统的各种变化情况，如文件存取、删除、移动、修改等。利用这一机制，可以非常方便地实现文件异动告警、增量备份，并针对目录或文件的变化及时作出响应。</li><li>将inotify机制与rsync工具相结合，可以实现触发式备份（实时同步），即只要原始位置的文档发生变化，则立即启动增量备份操作；否则处于静默等待状态。</li><li>因为 inotify 通知机制由 Linux 内核提供，因此主要做本机监控，在触发式备份中应用时更适合上行同步</li></ul> 
<h4><a id="Master__266"></a>③Master 关闭只读模式并为共享目录赋权</h4> 
<pre><code>vim /etc/rsyncd.conf
read only = no
#关闭只读模式，否则将不可写入


kill `cat /var/run/rsyncd.pid`
#修改完配置文件需要重启服务，这里采用直接杀掉进程号的方式

netstat -natp | grep rsync
#检查一下服务是否已被终止

rsync --daemon
netstat -natp | grep rsync
#再次开启服务并检查端口号确认
</code></pre> 
<p>1、关闭只读模式，否则不可写入</p> 
<p><img src="https://images2.imgbox.com/b6/3c/fPiJeERs_o.png" alt="在这里插入图片描述"><br> 2、修改完配置文件需要重启服务，这里采用直接杀掉进程号的方式，检查一下是否已中止服务，并再次开启<br> <img src="https://images2.imgbox.com/cd/0e/2lpRrDRJ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_Slave__287"></a>④优化 Slave 内核参数</h4> 
<pre><code>cat /proc/sys/fs/inotify/max_queued_events      #监控事件队列
cat /proc/sys/fs/inotify/max_user_instances     #最多监控实例数
cat /proc/sys/fs/inotify/max_user_watches       #每个实例最多监控文件数

vim /etc/sysctl.conf         #加大每个参数
fs.inotify.max_queued_events = 16384
fs.inotify.max_user_instances = 1024
fs.inotify.max_user_watches = 1048576
#当要监控的目录、文件数据量较多或者变化频繁时，建议加大参数值

sysctl -p
#刷新
</code></pre> 
<p>1、查看参数<br> <img src="https://images2.imgbox.com/ab/d3/9Axi5WaR_o.png" alt="在这里插入图片描述"><br> 2、加大每个参数<br> <img src="https://images2.imgbox.com/c7/7e/31hewAQm_o.png" alt="在这里插入图片描述"><br> 3、刷新<br> <img src="https://images2.imgbox.com/e1/54/zAAe5nOB_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="inotifytools_307"></a>⑤编译安装inotify-tools</h4> 
<pre><code>yum install -y gcc gcc-c++ 
#安装gcc gcc-c++ 

cd /opt
#切换至/opt上传inotify-tools安装包

tar zxf inotify-tools-3.14.tar.gz 
#解压

cd /opt/inotify-tools-3.14/
./configure
make  &amp;&amp; make install
#编译安装
</code></pre> 
<p>1、安装编译依赖包、上传安装包并解压编译<br> <img src="https://images2.imgbox.com/43/e0/fOVme5Wd_o.png" alt="在这里插入图片描述"><br> 2、安装<br> <img src="https://images2.imgbox.com/9e/13/KvxHyTVi_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_326"></a>⑥编写触发同步脚本</h4> 
<pre><code>vim /opt/inotify.sh
#!/bin/bash
INOTIFY_CMD="inotifywait -mrq -e create,delete,move,modify,attrib /opt/abc/"
RSYNC_CMD="rsync -azH --delete --password-file=/etc/server.pass /opt/abc/ backuper@192.168.159.230::wwwroot"

$INOTIFY_CMD | while read DIRECTORY EVENT FILE
do
    if [ $(pgrep rsync | wc -l) -le 0 ] ; then
        $RSYNC_CMD
	fi
done
----详解----
#!/bin/bash
INOTIFY_CMD="inotifywait -mrq -e create,delete,move,modify,attrib /opt/abc/"
#INOTIFY_CMD变量：持续监控 /opt/abc目录中的创建，删除，移动，修改，改变时间的操作
RSYNC_CMD="rsync -azH --delete --password-file=/etc/server.pass /opt/abc/ xixi@192.168.159.230::wwwroot"
#RSYNC_CMD变量：使 xixi 用户，/etc/server.pass 密钥文件，将 /opt/xcf1 目录下的文件进行压缩，归档，保留硬链接文件同步至 192.168.159.230 的共享模块定义的目录 /var/www/html 下，并删除差异性内容，保持一致性

$INOTIFY_CMD | while read DIRECTORY EVENT FILE		#持续监控...
do
    if [ $(pgrep rsync | wc -l) -le 0 ] ; then		#如果服务并未启动，则执行同步
        $RSYNC_CMD
	fi
done
----

cd /opt/
chmod +x inotify.sh
#给脚本赋权

chmod +x /etc/rc.d/rc.local 
echo "/opt/inotify.sh" &gt;&gt; /etc/rc.d/rc.local 
#设置开机自启动

sh -x inotify.sh
#执行脚本

cd /opt/abc
touch ccc.html
rm -rf bbb.html
#创建一个新的html文件并删除之前的qwe
ls
#再次确认一下
</code></pre> 
<p>1、编写脚本<br> <img src="https://images2.imgbox.com/3d/9b/yUVcC5c5_o.png" alt="在这里插入图片描述"><br> 2、给脚本赋权并赋权执行<br> <img src="https://images2.imgbox.com/1f/08/t6HaEQCM_o.png" alt="在这里插入图片描述"><br> 3、测试结果在server端操作，创建文件并删除一个文件</p> 
<p><img src="https://images2.imgbox.com/e4/16/9VlHx315_o.png" alt="在这里插入图片描述"><br> 4、在server端查看结果</p> 
<p><img src="https://images2.imgbox.com/57/2d/RCd8KPr8_o.png" alt="在这里插入图片描述"><br> 5、之前上图server同步时会出现报错，原因是我们以匿名用户身份登陆的，下面是解决方案：<br> <img src="https://images2.imgbox.com/49/ea/h5Y3sRSV_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="rsync_387"></a>七、rsync的应用场景</h2> 
<p><strong>1、增量同步</strong></p> 
<p><strong>2、备份/迁移</strong>：可以作为辅助工具（mysql 主从复制 rsync +inotify ——》趋于一致 双向同步——MM，但是只能在并发量不大的时候可以用）</p> 
<p>假设mysql 从主机A迁移到主机B（一主两从模式）</p> 
<p>一主两从模式迁移方案</p> 
<p>①确定迁移的时间、业务线停止的时间、要写文档描述具体操作，要发邮件审批</p> 
<p>②确认迁移后的节点的环境问题（资源环境 + 系统依赖环境 + mysql内部的格式环境 ------1)例如自增长，自增长可能会导致主从复制不一致的情况 2）版本迁移问题，比如说低版本向高版本迁移。两个版本中的差异比较大，数据迁移比较重要，需要和研发沟通，让研发开发一个工具，让低版本可以转成高版本工具格式，使用工具迁移)</p> 
<p>③ 如果数据库是相同版本，可以用rsync + inotify持续同步</p> 
<p>④ 测试、之前还要编写回滚方案</p> 
<p>⑤ 提交检修申请</p> 
<p><strong>3、使用rsync来实现快速删除大量文件</strong></p> 
<p>假如要在linux下删除大量文件，比如100万、1000万，像/usr/local/nginx/proxy_temp的nginx缓存等，那么rm -rf * 可能就不好使了，因为要等待很长一段时间。在这种情况下我们可以使用rsync来巧妙处理。rsync实际用的是替换原理。</p> 
<p>先建立一个空的文件夹：<br> mkdir /home/blank</p> 
<p>用rsync删除目标目录：<br> rsync --delete-before -a -H -v --progress --stats /home/blank /usr/local/nginx/proxy_temp<br> 这样目标目录很快就被清空了<br> <strong>选项说明：</strong><br> –delete-before 接收者在传输进行删除操作<br> -a 归档模式，表示以递归方式传输文件，并保持所有文件属性<br> -H 保持硬连接的文件<br> -v 详细输出模式<br> –progress 在传输时显示传输过程<br> –stats 给出某些文件的传输状态</p> 
<h2><a id="_426"></a>八、总结</h2> 
<p>rsync是一款开源的、快速的、多功能的、可实现全量及增量的本地或远程数据同步备份的优秀工具。Remote Sync，远程同步，支持本地复制，或者与其他SSH、rsync主机同步。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/50b4d19b5e831f6df871d34c6b9b1e57/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">探究Vue表单输入绑定v-model</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/783bb86346a6427b6afd59ea200cd629/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GO语言-数据操作-GORM 中使用事务</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>