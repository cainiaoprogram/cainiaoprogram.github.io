<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AH协议与ESP协议简析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="AH协议与ESP协议简析" />
<meta property="og:description" content="http://www.gxu.edu.cn/college/hxhgxy/sec/COURSE/ch12/2_1.htm
http://www.gxu.edu.cn/college/hxhgxy/sec/COURSE/ch12/2_2.htm
http://enterprise.huawei.com/ecommunity/bbs/10181731.html
AH AH可对整个数据包（IP 报头与数据包中的数据负载）提供身份验证、完整性与抗重播保护。但是它不提供保密性，即它不对数据进行加密。数据可以读取，但是禁止修改。AH 使用加密哈希算法签名数据包以求得完整性。
例如，使用计算机 A 的 Alice 将数据发送给使用计算机 B 的 Bob。IP 报头、AH 报头和数据的完整性都得到保护。这意味着 Bob 可以确定确实是 Alice 发送的数据并且数据未被修改。
完整性与身份验证是通过在 IP 报头与 IP 负载之间置入的 AH 报头提供的。 在 IP 报头中使用 IP 协议 ID 51 来标识 AH。AH 可以独立使用，也可以与ESP协议组合使用。
AH报头 AH 报头包含下列字段：
next hdr 下一个报头：使用 IP 协议 ID来标识 IP 负载,。从下图可知，表示被AH协议包含的那一个协议的类型。例如，TCP数据中，传输模式值 6 表示 TCP，隧道模式表示下一个报头为IP报头。
AH len 长度：表示 AH 报头的长度。
Reserved 保留字段
SPI 安全参数索引 ：与目标地址及安全协议（AH 或 ESP）组合使用，以确保通信的正确安全关联。接收方使用该值确定数据包是使用哪一安全关联标识的。
Sequence Number 序数 ：为该数据包提供抗重播保护。序数是 32 位、递增的数字（从 1 开始），它表示通过通信的安全关联所发送的数据包数。在快速模式安全关联的生存期内序列号不能重复。接收方将检查该字段，以确认使用该数字的安全关联数据包还没有被接收过。如果一个已经被接收，则数据包被拒绝。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1e81912b187fb5bb145dc7cc904d44f6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-11-19T15:18:40+08:00" />
<meta property="article:modified_time" content="2013-11-19T15:18:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">AH协议与ESP协议简析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><a target="_blank" href="http://www.gxu.edu.cn/college/hxhgxy/sec/COURSE/ch12/2_1.htm" rel="nofollow noopener noreferrer">http://www.gxu.edu.cn/college/hxhgxy/sec/COURSE/ch12/2_1.htm</a></p> 
<p><a target="_blank" href="http://www.gxu.edu.cn/college/hxhgxy/sec/COURSE/ch12/2_2.htm" rel="nofollow noopener noreferrer">http://www.gxu.edu.cn/college/hxhgxy/sec/COURSE/ch12/2_2.htm</a></p> 
<p><strong></strong></p> 
<p><a target="_blank" href="http://enterprise.huawei.com/ecommunity/bbs/10181731.html" rel="nofollow noopener noreferrer">http://enterprise.huawei.com/ecommunity/bbs/10181731.html</a></p> 
<p><br> </p> 
<h2><span style="font-size:24px">AH</span></h2> 
<p></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <span style="margin:0px; padding:0px"><strong>AH可对整个数据包（IP 报头与数据包中的数据负载）提供身份验证、完整性与抗重播保护。但是它不提供保密性，即它不对数据进行加密。</strong></span><strong>数据可以读取，但是禁止修改</strong>。AH 使用加密哈希算法签名数据包以求得完整性。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> 例如，使用计算机 A 的 Alice 将数据发送给使用计算机 B 的 Bob。IP 报头、AH 报头和数据的完整性都得到保护。这意味着 Bob 可以确定确实是 Alice 发送的数据并且数据未被修改。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> 完整性与身份验证是通过在 IP 报头与 IP 负载之间置入的 AH 报头提供的。<br style="margin:0px; padding:0px"> <br style="margin:0px; padding:0px"> 在 IP 报头中使用 IP 协议 ID 51 来标识 AH。AH 可以独立使用，也可以与ESP协议组合使用。</p> 
<h3 style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <span style="font-size:18px">AH报头</span></h3> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <br> </p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <img src="https://images2.imgbox.com/fb/a7/kmpSMm9V_o.gif" alt="" style="color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.4px"><br> </p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <strong>AH 报头包含下列字段：</strong></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> next hdr 下一个报头：使用 IP 协议 ID来标识 IP 负载,。<span style="color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.4px">从下图可知，</span><span style="color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.4px"><strong>表示被AH协议包含的那一个协议的类型。</strong></span>例如，TCP数据中，传输模式值 6 表示 TCP，隧道模式表示下一个报头为IP报头。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> AH len 长度：表示 AH 报头的长度。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> Reserved 保留字段</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> SPI 安全参数索引 ：与目标地址及安全协议（AH 或 ESP）组合使用，以确保通信的正确安全关联。接收方使用该值确定数据包是使用哪一安全关联标识的。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> Sequence Number 序数 ：为该数据包提供抗重播保护。序数是 32 位、递增的数字（从 1 开始），它表示通过通信的安全关联所发送的数据包数。在快速模式安全关联的生存期内序列号不能重复。接收方将检查该字段，以确认使用该数字的安全关联数据包还没有被接收过。如果一个已经被接收，则数据包被拒绝。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> Authentication Data 身份验证数据 ：包含完整性校验值 (ICV)，也称为消息身份验证码，用于验证消息身份验证与完整性。接收方计算 ICV 值并对照发送方计算的值校验它，以验证完整性。ICV 是通过 IP 报头、AH 报头与 IP 负载来计算的。<span style="color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px; text-align:justify; text-indent:33px"><strong>AH可对整个数据包（IP 报头与数据包中的数据负载）提供身份验证、完整性与抗重播保护。所以不论是传输模式还是隧道模式，AH协议都不能穿越nat设备。</strong></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> </p> 
<p>使用 AH 报头进行数据包签名</p> 
<p><strong>AH 为了完整性而对整个数据包进行签名</strong>，除了在传输过程中可能更改的 IP 报头中的某些字段之外（例如，“生存时间”与“服务类型”字段）。如果除了 AH 外还在使用另一个 IPSec 报头，则会在所有其他 IPSec 报头前插入 AH 报头。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> 下图中黄色部分表示被AH协议签名保护的部分。</p> 
<h3 style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> ipsec协议的操作模式</h3> 
<div> 
 <p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 在传输模式下，AH或 ESP被插入到IP头之后但在所有传输层协议之前，或所有其他 IPSec协议之前。</p> 
 <p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 在隧道模式下，AH或 ESP插在原始 IP头之前，另外生成一个新IP头放到 AH或 ESP之前。不同安全协议在传输模式和隧道模式下的数据封装形式（传输协议以 TCP为例）如下图所示：</p> 
 <p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <img src="https://images2.imgbox.com/93/23/soY3KCuk_o.png" alt="" style="border:none; max-width:100%"></p> 
 <br> 
</div> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <br> </p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <img src="https://images2.imgbox.com/80/23/kx1dHqG9_o.gif" alt=""><br> </p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <br> </p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <img src="https://images2.imgbox.com/f4/3c/8lfJ7tKz_o.gif" alt=""><br> </p> 
<br> 
<div class="para"> 
 <br> 
</div> 
<h2>ESP</h2> 
<div class="para">
  IPsec 封装安全负载（IPsec Encapsulating Security Payload）是 IPsec 体系结构中的一种主要协议，其主要设计来在 IPv4 和 IPv6 中提供安全服务的混合应用。IPsec ESP 通过加密需要保护的数据以及在 IPsec ESP 的数据部分放置这些加密的数据来提供机密性和完整性。且ESP加密采用的是对称密钥加密算法，能够提供无连接的数据完整性验证、数据来源验证和抗重放攻击服务。根据用户安全要求，这个机制 
 <strong>既可以用于加密一个传输层的段（如：TCP、UDP、ICMP、IGMP），也可以用于加密一整个的 IP 数据报。</strong>封装受保护数据是非常必要的，这样就可以为整个原始数据报提供机密性。 
</div> 
<div class="para">
  ESP 头可以放置在 IP 头之后、上层协议头之前 （传输层），或者在被封装的 IP 头之前 （隧道模式）。IANA 分配给 ESP 一个协议数值 50，在 ESP 头前的协议头总是在“next head”字段（IPv6）或“协议”（IPv4）字段里包含该值 50。 
 <strong>ESP 包含一个非加密协议头，后面是加密数据。该加密数据既包括了受保护的 ESP 头字段也包括了受保护的用户数据，这个用户数据可以是整个 IP 数据报，也可以是 IP 的上层协议帧（如：TCP 或 UDP）。</strong> 
</div> 
<br> 
<p></p> 
<h3>封闭安全载荷ESP包格式</h3> 
<p align="JUSTIFY" style="text-indent:33"><span style="font-size:12px"><span style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"><strong>ESP不仅为IP 负载提供身份验证、完整性和抗重播保护，还提供机密性</strong>。</span><span style="color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px">传输模式中的 ESP 不对整个数据包进行签名。</span><span style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px">只对IP 负载（而不对IP 报头）进行保护。</span><span style="color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px">ESP 可以独立使用，也可与 AH 组合使用。</span></span><br> </p> 
<p align="JUSTIFY" style="text-indent:33"><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">属于</span><span style="font-size:14px">IPSec</span><span lang="ZH-CN" style="">的一种协议，</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">提供机密性、数据起源验证、无连接的完整性、抗重播服务和有限业务流机密性。</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">本身是一个</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">协议，协议号是</span><span style="font-size:14px">50</span><span lang="ZH-CN" style="">。</span></p> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style=""></span></p> 
<p align="center" style="text-indent:33px"><img src="https://images2.imgbox.com/84/77/HkbZDQlT_o.gif" alt=""><br> </p> 
<p align="CENTER" style="text-indent:33px"><span lang="ZH-CN"> ESP头</span></p> 
<span lang="ZH-CN" style=""></span> 
<span style="font-size:14px"></span> 
<p align="JUSTIFY" style="text-indent:33"><span style="font-size:14px">ESP</span><span lang="ZH-CN">头包含下面一些字段：</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">SPI 安全参数索引</span><span lang="ZH-CN" style="">（</span><span style="font-size:14px">32</span><span lang="ZH-CN" style="">位）：这个值，和</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">头之前的目标地址以及协议结合在一起，用来标识用于处理数据包的特定的那个安全关联。</span><span style="font-size:14px">SPI</span><span lang="ZH-CN" style="">本身是个任意数，一般是在</span><span style="font-size:14px">IKE</span><span lang="ZH-CN" style="">交换过程中由目标主机选定的。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">Sequence Number 序列号（</span><span style="font-size:14px">32</span><span lang="ZH-CN" style="">位）：序列号是一个独一无二的、单向递增的、并由发送端插在</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头的一个号码。发送方的计数器和接收方的计数器在一个</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">建立时被初始化为</span><span style="font-size:14px">0</span><span lang="ZH-CN" style="">，使用给定</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">发送的第一个分组的序列号为</span><span style="font-size:14px">1</span><span lang="ZH-CN" style="">，<strong>如果激活抗重播服务（默认地），传送的序列号不允许循环</strong>。因此，在</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">上传送第</span><span style="font-size:14px">2<sup>32</sup></span><span lang="ZH-CN" style="">个分组之前，发送方计数器和接收方计数器必须重新置位（通过建立新</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">和获取新密钥），序列号使</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">具有了抵抗重播攻击的能力。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">受保护数据（可变）：通过加密保护的传输层协议内容（传输模式）或</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">包（隧道模式）。如果受保护数据需要加密同步数据，那么初始化向量</span><span style="font-size:14px">IV</span><span lang="ZH-CN" style="">可以在受保护数据字段的开头携带，并且</span><span style="font-size:14px">IV</span><span lang="ZH-CN" style="">通常不加密，但经常被看作是密文的一部分。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">填充（</span><span style="font-size:14px">0~255</span><span lang="ZH-CN" style="">字节）：主要用于加密算法要求明文使某个数目字节的倍数、保证填充长度字段和下一个头字段排列在</span><span style="font-size:14px">32</span><span lang="ZH-CN" style="">位字的右边、提供部分业务流机密性。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">填充长度（</span><span style="font-size:14px">8</span><span lang="ZH-CN" style="">位）：指出填充字节的数目。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">下一个头（</span><span style="font-size:14px">8</span><span lang="ZH-CN" style="">位）：标识受保护数据的第一个协议头。例如，</span><span style="font-size:14px">IPv6</span><span lang="ZH-CN" style="">中的扩展头或者上层协议标识符。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN">验证数据（可变）：完整性检查值。验证数据是可变长字段，它包含一个完整性校验值（</span><span style="font-size:14px">ICV</span><span lang="ZH-CN">），</span><span style="font-size:14px">ESP</span><span lang="ZH-CN">分组中该值的计算不包含验证数据本身。字段长度由选择的验证函数指定。验证数据字段是可选的，只有</span><span style="font-size:14px">SA</span><span lang="ZH-CN">选择验证服务，才包含验证数据字段。验证算法规范必须指定</span><span style="font-size:14px">ICV</span><span lang="ZH-CN">长度、验证的比较规则和处理步骤。</span></p> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style=""></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <strong>ESP 验证尾端（即上面的验证数据）包含下列字段：</strong></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> 身份验证数据：包含完整性校验值 (ICV)，也称为消息身份验证码，用于验证消息身份验证与完整性。接收方计算 ICV 值并对照发送方计算的值校验它，以验证完整性。ICV 是通过 ESP 报头、负载数据与 ESP 尾端计算的。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> 数据包签名与加密：ESP 可为 IP 负载提供保护。数据包的签名部分表示数据包的完整性和身份验证签名是在哪里进行的。数据包的加密部分表示什么信息受到机密性保护。</p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <span style="color:rgb(73,73,73); font-family:simsun; font-size:14px; line-height:21px"><u><strong>ESP在传输模式时会保护TCP/UDP头，但是并不保护IP 头，因此修改IP 地址并不会破坏整个数据包的完整性。但是如果数据包是TCP/UDP数据包，NAT设备就需要修改数据包的校验值，而这个校验值是被ESP 所保护的，这样却会导致完整性校验失败。所以ESP在传输模式不能用于NAT穿越。</strong></u></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:5px; color:rgb(51,51,51); font-family:Arial,宋体; line-height:20.3999996185303px"> <span style="color:rgb(73,73,73); font-family:simsun; font-size:14px; line-height:21px"><u><strong>ESP在隧道模式下， NAT会修改新增的IP头，新增IP协议的数据时ESP，就不需要想TCP/UDP一样修改ESP的验证，所以最终能和NAT一起工作的只能是隧道模式下的ESP。</strong></u></span><br> </p> 
<br> 
<p align="center" style="text-indent:33"><br> </p> 
<p align="CENTER" style="text-indent:33"><br> </p> 
<p align="CENTER" style="text-indent:33"><img src="https://images2.imgbox.com/20/48/pGZiAM6I_o.gif" alt=""><br> </p> 
<p align="CENTER" style="text-indent:33"><br> </p> 
<p align="CENTER" style="text-indent:33"><img src="https://images2.imgbox.com/5f/07/JIrPlAmI_o.gif" alt=""><br> </p> 
<h3 align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">封闭安全协议处理<br> </span></h3> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">传输模式与通道模式下受</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">保护的一个</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">包。见下图。</span></p> 
<p align="center" style="text-indent:33"><br> </p> 
<p align="center" style="text-indent:33"><img src="https://images2.imgbox.com/e7/93/dlTD5qNP_o.gif" alt=""><br> </p> 
<p align="center" style="text-indent:33"><br> </p> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">由于</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">同时提供了机密性以及身份验证机制，所以在其</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">中必须同时定义两套算法用来确保机密性的算法叫作一个</span><span style="font-size:14px">cipher</span><span lang="ZH-CN" style="">（加密器），</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">使用对称加密算法。负责身份验证的叫作</span><span style="font-size:14px">authenticator</span><span lang="ZH-CN" style="">（验证器），验证算法包括基于对称加密算法（例如</span><span style="font-size:14px">DES</span><span lang="ZH-CN" style="">）的或者基于单向散列函数（例如</span><span style="font-size:14px">MD5</span><span lang="ZH-CN" style="">或</span><span style="font-size:14px">SHA-1</span><span lang="ZH-CN" style="">）的消息鉴别码（</span><span style="font-size:14px">MAC</span><span lang="ZH-CN" style="">）。注意因为加密、验证是可选的，算法可以为“</span><span style="font-size:14px">NULL</span><span lang="ZH-CN" style="">”。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">（</span><span style="font-size:14px">1</span><span lang="ZH-CN" style="">）外出分组的处理。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">对在</span><span style="font-size:14px">IPv4</span><span lang="ZH-CN" style="">上运行的传送模式应用来说，</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头紧跟</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">头，</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">头的协议字段被复制到</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头的下一个头字段中，</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头的其余字段则被填满。</span><span style="font-size:14px">SPI</span><span lang="ZH-CN" style="">字段分配到的是来自</span><span style="font-size:14px">SAD</span><span lang="ZH-CN" style="">的、用来对这个包进行处理的特定</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">的</span><span style="font-size:14px">SPI</span><span lang="ZH-CN" style="">；填充序列号字段的是序列中的下一个值；填充数据会被插入，其值被分配；同时分配的还有填充长度值。随后，</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">头的协议字段得到的是</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">的值</span><span style="font-size:14px">50</span><span lang="ZH-CN" style="">。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">除了头插入位置不同之外，</span><span style="font-size:14px">IPv6</span><span lang="ZH-CN" style="">处理规则基本上类似于</span><span style="font-size:14px">IPv4</span><span lang="ZH-CN" style="">。</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头可插在任意一个扩展头之后。对通道模式应用来说，</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头是加在</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">包前面的。如果封装的是一个</span><span style="font-size:14px">IPv4</span><span lang="ZH-CN" style="">包，那么</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头的下一个头字段分配到值</span><span style="font-size:14px">4</span><span lang="ZH-CN" style="">；如果封装的是一个</span><span style="font-size:14px">IPv6</span><span lang="ZH-CN" style="">包，则分配到值</span><span style="font-size:14px">41</span><span lang="ZH-CN" style="">。其他字段的填充方式和在传送模式中一样。随后，在</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头的前面新增了一个</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">头，并对相应的字段进行填充（赋值）</span><span style="font-size:14px">—</span><span lang="ZH-CN" style="">源地址对应于应用</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">的那个设备本身；目标地址取自于用来应用</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">的</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">；协议设为</span><span style="font-size:14px">50</span><span lang="ZH-CN" style="">；其他字段的值则参照本地的</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">处理加以填充。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">不管哪种模式下，接下去的步骤都是相同的。从恰当的</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">中选择加密器（加密算法），对包进行加密（从载荷数据的开头，一直到下一个头字段）。随后，使用恰当的</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">中的验证器，对包进行验证（自</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头开始，中间经过加密的密文，一直到</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">尾）。随后，将验证器的结果插入</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">尾的验证数据字段中。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">对外出数据包进行处理的最后一步是：重新计算位于</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">前面的</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">头的校验和。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">注意在添加</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头时，不必进行分段检查。如果结果包（在已采用</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">之后）大于它流经的那个接口的</span><span style="font-size:14px">MTU</span><span lang="ZH-CN" style="">，只好对它进行分段。这和一个完整的</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">包离开该设备，并在网络中的某个地方被分成段没有什么区别。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">（</span><span style="font-size:14px">2</span><span lang="ZH-CN" style="">）进入分组的处理</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">接收端在收到一个</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">包之后，若不对这个包进行处理，就无法得知它究竟处于通道模式，还是传送模式。根据对这个包进行处理的</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">，便可知道它到底处在什么模式下。但除非完成了对它的解密，实际上不可能知道</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">保护的是什么。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">如果收到的</span><span style="font-size:14px">IPSec</span><span lang="ZH-CN" style="">包是一个分段，必须把它保留下来，直到这个包的其他部分收完为止。即在</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">处理之前进行重组。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">收到一个（已重组的）包含</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">头的包时，根据目的</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">地址、安全协议（</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">）和</span><span style="font-size:14px">SPI</span><span lang="ZH-CN" style="">，接收方确定适当的</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">。</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">指出序列号字段是否被校验，验证数据字段是否存在，它将指定解密和</span><span style="font-size:14px">ICV</span><span lang="ZH-CN" style="">计算（如果适用）使用的算法和密钥。如果本次会话没有有效的</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">存在（例如接收方没有密钥），接收方必须丢弃分组；这是可审核事件。该事件的核查日志表项应该包含</span><span style="font-size:14px">SPI</span><span lang="ZH-CN" style="">的值、接收的日期</span><span style="font-size:14px">/</span><span lang="ZH-CN" style="">时间、源地址、目的地址、序列号和（</span><span style="font-size:14px">IPv6</span><span lang="ZH-CN" style="">）明文信息流</span><span style="font-size:14px">ID</span><span lang="ZH-CN" style="">。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">一旦验证通过了一个有效的</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">，就可用它开始包的处理。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">检查序列号：如果接收的包落入窗口内且是新的，或者包落在窗口的右边，那么接收方进行</span><span style="font-size:14px">ICV</span><span lang="ZH-CN" style="">确认。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">完整性校验值确认：如果选择验证，接收方采用指定的验证算法对</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">包计算</span><span style="font-size:14px">ICV</span><span lang="ZH-CN" style="">但不包含验证数据字段，确认它与验证数据字段中包含的</span><span style="font-size:14px">ICV</span><span lang="ZH-CN" style="">相同。如果计算得来的与接收的</span><span style="font-size:14px">ICV</span><span lang="ZH-CN" style="">匹配，那么数据包有效，可以被接收。如果测试失败，接收方必须作为非法而将接收的</span><span style="font-size:14px">IP</span><span lang="ZH-CN" style="">数据包丢弃；这是可审核事件。</span></p> 
<span lang="ZH-CN" style=""></span> 
<p align="JUSTIFY" style="text-indent:33"><span lang="ZH-CN" style="">分组解密：通过取自</span><span style="font-size:14px">SA</span><span lang="ZH-CN" style="">的密钥和密码算法，对</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">包进行解密，从这个</span><span style="font-size:14px">ESP</span><span lang="ZH-CN" style="">包载荷数据开始之处到下一个头之间。</span></p> 
<br>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f5267182413b5abf2a6f5e30ed9f5c6b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android短彩信源码解析-短信发送流程（三）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/daa53118fd42ce1f310f89aa70015727/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">获取Spring容器中Bean实例的工具类(Java泛型方法实现)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>