<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>浅入浅出keepalived&#43;nginx实现高可用双机热备 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="浅入浅出keepalived&#43;nginx实现高可用双机热备" />
<meta property="og:description" content="对应用keepalived&#43;nginx技术实现nginx高可用进行简单的分析，下面是通过对keepalived添加校验nginx存活脚本，监控nginx的状态，应用keepalived的主备模式实现nginx的高可用。
假如192.168.100.2和192.168.100.3两台机器安装了nginx，负载均衡配置一模一样。这两台机器对外的虚拟IP是：192.168.100.10，当100.2宕机或nginx未启动或启动失败，则将100.3选举为master，100.10绑定到100.3继续对外提供访问。
1、简介 1.1、keepalived Keepalived是一个基于VRRP协议来实现的服务高可用方案。VRRP协议（虚拟路由冗余协议—— Virtual Router Redundancy Protocol，简称VRRP），是由IETF提出的解决局域网中配置静态网关出现单点失效现象的路由协议，1998年已推出正式的RFC2338协议标准。VRRP广泛应用在边缘网络 中，它的设计目标是支持特定情况下IP数据流量失败转移不会引起混乱，允许主机使用单路由器，以 及即使在实际第一跳路由器使用失败的情形下仍能够维护路由器间的连通性。 简单来说就是，VRRP协议允许一台机器可以拥有一个或者多个虚拟IP。在高可用的一组机器中，有 一个master，多个slave，对外提供一个虚IP，通过虚IP访问master，slave负责监控master，如果 master宕机，则选举其中一个slave接管master，虚IP绑定到新的master上（俗称IP漂移），从而实现了高可用。具体请查看官网。
（摘自官网）
keepalived是一种高性能的服务器高可用或热备解决方案， keepalived可以用来防止服务器单点故障的发生，通过配合nginx可以实现 web 前端服务的高可用。可见keepalived的主备模式是针对宕机等情况，实现vip的漂移。
1.2、nginx nginx是一款轻量级的Web服务器、反向代理服务器，由于它的内存占用少，启动极快，高并发能力强，在互联网项目中广泛应用，具体请查看官网。
（摘自官网）
keepalived是一个高可用解决方案，主要是用来防止服务器单点发生故障，可以通过和nginx配合来实现web前端服务的高可用。
Keepalived&#43;Nginx实现高可用的思路：
请求不要直接打到nginx上，应该先通过keepalived（这就是所谓虚拟IP，VIP）；keepalived应该能监控nginx的生命状态（提供一个用户自定义的脚本，定期检查nginx进程状态，进行权重变化,，从而实现nginx故障切换）； 2、环境 准备2台机器，均为linux系统，ip地址分别为192.168.100.2和192.168.100.3，分别对应keepalived的master节点和backup节点，在2台机器上均安装keepalived和nginx服务。
vipipkeepalivednginx端口192.168.100.10192.168.100.2master80192.168.100.10192.168.100.3backup80 3、下载安装 3.1、nginx下载安装 准备linux版本的nginx安装包nginx-1.22.1.tar.gz
在2台机器上(ubuntu16.04)进行安装，编译安装命令如下：
# 更新源 apt-get update # 安装gcc g&#43;&#43; 的依赖库 apt-get install build-essential　apt-get install libtool # 安装pcre依赖库 apt-get install libpcre3 libpcre3-dev # 安装zlib依赖库 apt-get install zlib1g-dev # 安装openssl apt-get install openssl libssl-dev # 安装nginx tar -zxvf nginx-1.22.1.tar.gz cd nginx-1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/92de0c4eef63aac860f3b9e1d32019ba/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-07T10:43:32+08:00" />
<meta property="article:modified_time" content="2023-03-07T10:43:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">浅入浅出keepalived&#43;nginx实现高可用双机热备</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>对应用keepalived+nginx技术实现nginx高可用进行简单的分析，下面是通过对keepalived添加校验nginx存活脚本，监控nginx的状态，应用keepalived的主备模式实现nginx的高可用。<br> 假如192.168.100.2和192.168.100.3两台机器安装了nginx，负载均衡配置一模一样。这两台机器对外的虚拟IP是：192.168.100.10，当100.2宕机或nginx未启动或启动失败，则将100.3选举为master，100.10绑定到100.3继续对外提供访问。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/e6/8f/VaVctiWy_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="1_5"></a>1、简介</h2> 
<h3><a id="11keepalived_6"></a>1.1、keepalived</h3> 
<p>Keepalived是一个基于VRRP协议来实现的服务高可用方案。VRRP协议（虚拟路由冗余协议—— Virtual Router Redundancy Protocol，简称VRRP），是由IETF提出的解决局域网中配置静态网关出现单点失效现象的路由协议，1998年已推出正式的RFC2338协议标准。VRRP广泛应用在边缘网络 中，它的设计目标是支持特定情况下IP数据流量失败转移不会引起混乱，允许主机使用单路由器，以 及即使在实际第一跳路由器使用失败的情形下仍能够维护路由器间的连通性。 简单来说就是，VRRP协议允许一台机器可以拥有一个或者多个虚拟IP。在高可用的一组机器中，有 一个master，多个slave，对外提供一个虚IP，通过虚IP访问master，slave负责监控master，如果 master宕机，则选举其中一个slave接管master，虚IP绑定到新的master上（俗称IP漂移），从而实现了高可用。具体请查看官网。<br> <img src="https://images2.imgbox.com/b9/07/IglmIo7L_o.png" alt="在这里插入图片描述"><br> （摘自官网）<br> keepalived是一种高性能的服务器高可用或热备解决方案， keepalived可以用来防止服务器单点故障的发生，通过配合nginx可以实现 web 前端服务的高可用。可见keepalived的主备模式是针对宕机等情况，实现vip的漂移。</p> 
<h3><a id="12nginx_11"></a>1.2、nginx</h3> 
<p>nginx是一款轻量级的Web服务器、反向代理服务器，由于它的内存占用少，启动极快，高并发能力强，在互联网项目中广泛应用，具体请查看官网。<br> <img src="https://images2.imgbox.com/63/cd/1Og12Wpz_o.png" alt="在这里插入图片描述"><br> （摘自官网）<br> keepalived是一个高可用解决方案，主要是用来防止服务器单点发生故障，可以通过和nginx配合来实现web前端服务的高可用。<br> Keepalived+Nginx实现高可用的思路：</p> 
<ol><li>请求不要直接打到nginx上，应该先通过keepalived（这就是所谓虚拟IP，VIP）；</li><li>keepalived应该能监控nginx的生命状态（提供一个用户自定义的脚本，定期检查nginx进程状态，进行权重变化,，从而实现nginx故障切换）；</li></ol> 
<h2><a id="2_20"></a>2、环境</h2> 
<p>准备2台机器，均为linux系统，ip地址分别为192.168.100.2和192.168.100.3，分别对应keepalived的master节点和backup节点，在2台机器上均安装keepalived和nginx服务。</p> 
<table><thead><tr><th>vip</th><th>ip</th><th>keepalived</th><th>nginx端口</th></tr></thead><tbody><tr><td>192.168.100.10</td><td>192.168.100.2</td><td>master</td><td>80</td></tr><tr><td>192.168.100.10</td><td>192.168.100.3</td><td>backup</td><td>80</td></tr></tbody></table> 
<h2><a id="3_28"></a>3、下载安装</h2> 
<h3><a id="31nginx_29"></a>3.1、nginx下载安装</h3> 
<p>准备linux版本的nginx安装包nginx-1.22.1.tar.gz<br> 在2台机器上(ubuntu16.04)进行安装，编译安装命令如下：</p> 
<pre><code># 更新源
apt-get update
# 安装gcc g++ 的依赖库
apt-get install build-essential　
apt-get install libtool  
# 安装pcre依赖库
apt-get install libpcre3 libpcre3-dev
# 安装zlib依赖库
apt-get install zlib1g-dev
# 安装openssl
apt-get install openssl libssl-dev

# 安装nginx
tar -zxvf nginx-1.22.1.tar.gz
cd nginx-1.22.1
./configure --prefix=/usr/local/nginx
make &amp;&amp; make install
</code></pre> 
<p>启动命令如下：</p> 
<pre><code># 启动
nginx
# 停止
nginx -s stop
# 重启
nginx -s reload
# 测试
curl http://127.0.0.1:80
</code></pre> 
<h3><a id="32keepalived_64"></a>3.2、keepalived下载安装</h3> 
<p>准备linux版本的keepalived安装包keepalived-2.2.7.tar.gz<br> 在2台机器上(ubuntu16.04)进行安装，编译安装命令如下：</p> 
<pre><code># 安装依赖包
apt-get install libssl-dev openssl libpopt-dev
# 安装keepalived
tar -zxvf keepalived-2.2.7.tar.gz
cd keepalived-2.2.7
./configure --prefix=/usr/local/keepalived
make &amp;&amp; make install

# 设置 keepalived 服务开机启动
chkconfig keepalived on
# 若chkconfig：未找到命令，执行下面解决
apt-get install sysv-rc-conf
cp /usr/sbin/sysv-rc-conf /usr/sbin/chkconfig
</code></pre> 
<blockquote> 
 <p>我们发现根本没有’/usr/local/etc/keepalived/keepalived.conf’ or '/etc/keepalived/keepalived.conf’这两个配置文件，甚至连对应的目录都没有，这一点keepalive做的不太好。下面需要手动创建目录，复制配置文件。</p> 
</blockquote> 
<pre><code># 将 keepalived 设置为系统服务
cp  keepalived.conf.sample  keepalived.conf
mkdir /etc/keepalived
cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/
# 或对配置文件建立软链接
ln -s /usr/local/keepalived/etc/keepalived/keepalived.conf   /etc/keepalived/keepalived.conf
# 或直接对目录建立软链接
ln -s /usr/local/keepalived/etc/keepalived   /etc/keepalived

mkdir /etc/sysconfig
cp /usr/local/keepalived/etc/sysconfig/keepalived  /etc/sysconfig/

cp /usr/local/keepalived/sbin/keepalived /usr/sbin/
cp /usr/local/keepalived-2.2.7/keepalived/etc/init.d/keepalived /etc/rc.d/init.d/ #从keepalived源码目录复制，安装目录中没有
cp /usr/local/keepalived-2.2.7/keepalived/etc/init.d/keepalived /etc/init.d/ #从keepalived源码目录复制，安装目录中没有
</code></pre> 
<blockquote> 
 <p>注1：先查看keepalived的状态（先不启动，Keepalived很坑爹的），因为还需要将配置文件移动到对应的目录并修改配置文件，否则Keepalived启动不起来的。</p> 
</blockquote> 
<pre><code>systemctl daemon-reload 				#重载
systemctl stop keepalived.service  		#停止
systemctl start keepalived.service  	#启动keepalived
systemctl status keepalived.service  	#查看keepalived状态
systemctl restart keepalived          #重启
</code></pre> 
<blockquote> 
 <p>注2：查看一下/usr/local/keepalived/sbin/keepalived这个命令的使用帮助，从下面的使用帮助我们可以看的出来，keepalived命令启动时的默认配置文件使用了’/usr/local/etc/keepalived/keepalived.conf’<br> or ‘/etc/keepalived/keepalived.conf’。</p> 
</blockquote> 
<pre><code>root@master:/usr/local/keepalived/sbin# /usr/local/keepalived/sbin/keepalived --help
Usage: /usr/local/keepalived/sbin/keepalived [OPTION...]
  -f, --use-file=FILE          Use the specified configuration file
                                default '/usr/local/etc/keepalived/keepalived.conf'
                                     or '/etc/keepalived/keepalived.conf'
  -P, --vrrp                   Only run with VRRP subsystem
  -C, --check                  Only run with Health-checker subsystem
      --all                    Force all child processes to run, even if have no configuration
  -l, --log-console            Log messages to local console

</code></pre> 
<blockquote> 
 <p>注3：检查一下keepalived的配置文件/usr/local/keepalived/etc/keepalived/keepalived.conf<br> 参数，因为里面有个vip绑定的网卡，这个网卡写的不对，Keepalive启动仍会是失败。</p> 
</blockquote> 
<h2><a id="4keepalived_133"></a>4、配置keepalived</h2> 
<p>在keepalived.conf配置文件中的 instance 里面配置 track_script，指定检查nginx是否存活的脚本。</p> 
<h3><a id="41master_135"></a>4.1、master</h3> 
<pre><code>! Configuration File for keepalived
# 全局配置，路由ID，固定不变 
global_defs {
   router_id LVS_DEVEL
}
# 定义Nginx状态检查脚本 
vrrp_script chk_nginx {
   # 具体的脚本
   script "/etc/keepalived/nginx_check.sh"
   interval 2 # 2s执行一次 
   weight -20 # 失败一次 则优先级 -20
}
# VRRP实例 
vrrp_instance VI_1 {
	# 主节点 
    state MASTER
    # 绑定的网卡,使用ifconfig命令查看获取
    interface eno1
    # 虚拟路由id,保证相同
    virtual_router_id 51
    # 优先级，抢占模式下优先级高的称为主
    priority 100
    # 指定发送VRRP通告的间隔，单位是秒
    advert_int 1
    # 安全认证用的密码，自定义即可
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    # 对外暴露的VIP地址 
    virtual_ipaddress {
        192.168.100.10
    }
    # 指定脚本
    track_script {
      chk_nginx
    }
}
</code></pre> 
<h3><a id="42backup_178"></a>4.2、backup</h3> 
<pre><code>! Configuration File for keepalived
# 全局配置，路由ID，固定不变 
global_defs {
   router_id LVS_DEVEL
   script_user root
}
# 定义Nginx状态检查脚本 
vrrp_script chk_nginx {
   # 具体的脚本
   script "/etc/keepalived/nginx_check.sh"
   interval 2 # 2s执行一次 
   weight -20 # 失败一次 则优先级 -20
}
# VRRP实例 
vrrp_instance VI_1 {
	# 备节点 
    state BACKUP
    # 绑定的网卡,使用ifconfig命令查看获取
    interface eno1
    # 虚拟路由id,保证相同
    virtual_router_id 51
    # 优先级，抢占模式下优先级高的称为主
    priority 90
    # 指定发送VRRP通告的间隔，单位是秒
    advert_int 1
    # 安全认证用的密码，自定义即可
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    # 对外暴露的VIP地址 
    virtual_ipaddress {
        192.168.100.10
    }
    # 指定脚本
    track_script {
      chk_nginx
    }
}
</code></pre> 
<h3><a id="43_nginx_checksh_221"></a>4.3、配置 nginx_check.sh</h3> 
<p>该脚本就是通过ps命令检查nginx进程是否存活，如果不存活，则尝试启动一次再检查，如果还是启动不起来，则把keepalived关闭, 从而让keepalived能检测到，并且 vip 能够漂移到其他机器。</p> 
<pre><code>#!/bin/bash
status=$(ps -C nginx --no-heading|wc -l)
if [ "${status}" = "0" ]; then
            # 尝试启动一次
            systemctl start nginx
        # 再次检查ngixn 进程
        status2=$(ps -C nginx --no-heading|wc -l)
        if [ "${status2}" = "0"  ]; then
                # 关闭 keepalived 
                systemctl stop keepalived
        fi
fi
</code></pre> 
<p>需要在2台机器上都配置上这个脚本，且授予可执行权限，然后进行重启，命令如下：</p> 
<pre><code># 给脚本一个可执行的权限
chmode +x /etc/keepalived/nginx_check.sh 
# 重启或者启动keepalived 
systemctl restart keepalived
</code></pre> 
<h2><a id="5_247"></a>5、高可用双机热备测试</h2> 
<blockquote> 
 <p>2台机器分别启动nginx和keepalived服务，查看2台机器上的nginx服务，访问如下：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/fe/73/I0OTf7uh_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/56/c4/3GdkdRnB_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>查看2台机器上的ip地址，如下：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/40/ea/5g7YYkFp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b2/4b/QX7yZCoE_o.png" alt="在这里插入图片描述"><br> 从图中可以看出多出1个虚拟IP。</p> 
<blockquote> 
 <p>访问vip 192.168.100.10，结果如下：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/0c/8b/JDsXSFre_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>当关闭100.2上的nginx后，keepalived将在2s内将它重新启动，当关闭100.2上的keepalived和nginx后，再次访问vip 192.168.100.10，结果如下：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/27/95/daLEqj6E_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>当再次开启100.2上的keepalived和nginx后，再次访问vip 192.168.100.10，结果如下：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/e6/3e/jhdHEkPM_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>当关闭100.3上的keepalived和nginx后，再次访问vip 192.168.100.10，结果如下：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/c0/fb/zBBpK2G4_o.png" alt="在这里插入图片描述"><br> 可见，100.3机器宕机后，访问VIP并未受影响，可以正常访问。</p> 
<h2><a id="6_276"></a>6、小结</h2> 
<p>keepalived 是一种高性能的服务器高可用或热备解决方案， keepalived 可以用来防止服务器单点故障的发生，通过配合 nginx 可以实现 web 前端服务的高可用和双机热备。<br> 在实际的生产项目中，对服务的高可用可以用nginx来实现，但当nginx只有一台 ，访问流量又非常大时，为了避免nginx服务器宕机，可以通过keepalived实现nginx的双机热备。<br> keepalived实现高可用的原理请查看官网继续研究，若有不当或错误之处，欢迎留言。<br> 感兴趣的小伙伴可以尝试一下~</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a25e61f584a04b5b8784fd3c27c20881/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决Windows10、11 远程桌面时提示用户名、密码错误的情况（实际用户名、密码正确）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e957c53e772f74bc4e2c32ac0a356704/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">论文公式符号规范</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>