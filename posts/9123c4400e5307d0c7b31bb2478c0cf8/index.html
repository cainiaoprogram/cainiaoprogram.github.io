<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Boot 系列: 集成 Redis 数据库 分布式工具 Redisson 缓存 Spring Cache - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring Boot 系列: 集成 Redis 数据库 分布式工具 Redisson 缓存 Spring Cache" />
<meta property="og:description" content="🌈 集成 Redis 数据库 分布式工具 Redisson 缓存 Spring Cache 🌈 Redis 客户端 🌮 Jedis Jedis 是 Java 实现的较轻量级的 Redis 客户端，简洁且基于 Socket 的操作方式，很高的性能。
Jedis 的 API 提供的比较全面 Redis 命令的支持。
使用阻塞的 I/O 操作，方法调用都是同步的，程序流需等到 socket 处理完 I/O 才能执行，不支持异步的操作。
是直接连接 Redis Server 的，在多线程环境是非线程安全的，需要通过连接池来操作 Jedis。
🌮 ​Lettuce Lettuce 可伸缩线程安全的 Redis 客户端。多个线程可以共享同一个 RedisConnection，利用 Netty NIO 框架高效地管理多个连接。
支持同步、异步、响应式编程，自动重新连接，主从，集群，哨兵，管道和编码器。
Spring Boot 2.x 开始， Lettuce 已取代 Jedis 成为 Spring Boot 默认的 Redis 客户端。
🌮 ​Redisson Redisson 是一个在 Redis 的基础上实现的 Java 驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的 Java 常用对象，还提供了许多分布式服务。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9123c4400e5307d0c7b31bb2478c0cf8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-25T15:19:47+08:00" />
<meta property="article:modified_time" content="2023-05-25T15:19:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Boot 系列: 集成 Redis 数据库 分布式工具 Redisson 缓存 Spring Cache</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="rainbow__Redis___Redisson__Spring_Cache_0"></a>🌈 集成 Redis 数据库 分布式工具 Redisson 缓存 Spring Cache</h2> 
<h2><a id="rainbow_Redis__2"></a>🌈 Redis 客户端</h2> 
<h3><a id="taco_Jedis_4"></a>🌮 Jedis</h3> 
<p>Jedis 是 Java 实现的较轻量级的 Redis 客户端，简洁且基于 Socket 的操作方式，很高的性能。</p> 
<p>Jedis 的 API 提供的比较全面 Redis 命令的支持。</p> 
<p>使用阻塞的 I/O 操作，方法调用都是同步的，程序流需等到 socket 处理完 I/O 才能执行，不支持异步的操作。</p> 
<p>是直接连接 Redis Server 的，在多线程环境是非线程安全的，需要通过连接池来操作 Jedis。</p> 
<h3><a id="taco_Lettuce_14"></a>🌮 ​Lettuce</h3> 
<p>Lettuce 可伸缩线程安全的 Redis 客户端。多个线程可以共享同一个 RedisConnection，利用 Netty NIO 框架高效地管理多个连接。</p> 
<p>支持同步、异步、响应式编程，自动重新连接，主从，集群，哨兵，管道和编码器。</p> 
<p>Spring Boot 2.x 开始， Lettuce 已取代 Jedis 成为 Spring Boot 默认的 Redis 客户端。</p> 
<h3><a id="taco_Redisson_22"></a>🌮 ​Redisson</h3> 
<p>Redisson 是一个在 Redis 的基础上实现的 Java 驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的 Java 常用对象，还提供了许多分布式服务。</p> 
<p>Redisson 提供了使用 Redis 的最简单和最便捷的方法。</p> 
<p>适用于分布式应用，分布式缓存，分布式回话管理，分布式服务（任务，延迟任务，执行器）。</p> 
<p>🌊 当没有分布式场景，优先考虑使用 Lettuce 性能更高；需要用到分布式锁，分布式对象，分布式集合等，可以采用 Lettuce + Redisson 组合使用。</p> 
<h2><a id="rainbow_Spring_Boot__Redis_32"></a>🌈 ​Spring Boot 集成 Redis</h2> 
<h3><a id="taco_Spring_Data_Redis__34"></a>🌮 ​Spring Data Redis 的依赖</h3> 
<p>Maven 引入依赖，直接使用 Spring Boot 默认的版本（使用默认 Lettuce 客户端）</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>引入 commons-pool2 依赖，作为 Lettuce 的连接池</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="taco_Spring_Data_Redis__54"></a>🌮 Spring Data Redis 的配置</h3> 
<p>添加配置，参考 <code>org.springframework.boot.autoconfigure.data.redis.RedisProperties</code></p> 
<pre><code class="prism language-properties">## Redis数据库索引（默认为0）
spring.redis.database=0
## Redis服务器地址（默认为localhost）
spring.redis.host=127.0.0.1
## Redis服务器连接端口（默认为6379）
spring.redis.port=6379
## Redis服务器连接密码（默认为空）
spring.redis.password=
## 连接超时时间（毫秒）
spring.redis.timeout=1000
## 连接池最大连接数（默认为8。使用负值表示没有限制）
spring.redis.lettuce.pool.max-active=8
## 连接池最大阻塞等待时间（默认为-1。使用负值表示没有限制）
spring.redis.lettuce.pool.max-wait=-1
## 连接池中的最大空闲连接（默认为8）
spring.redis.lettuce.pool.max-idle=8
## 连接池中的最小空闲连接（默认为0）
spring.redis.lettuce.pool.min-idle=0
</code></pre> 
<h3><a id="taco_Spring_Data_Redis__79"></a>🌮 Spring Data Redis 的使用</h3> 
<p>Spring Data Redis 默认向容器中注入 <code>RedisTemplate&lt;Object, Object&gt; redisTemplate</code> 、<code>StringRedisTemplate stringRedisTemplate</code> 两个模板类，是 Spring 对 Redis 操作的封装，通过封装的 API 来操作 Redis。</p> 
<p>🍅 参考 <code>org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration</code></p> 
<p>使用示例</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/stringRedis/add"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">stringRedisAdd</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"stringRedis"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"stringRedis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/redis/add"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">SysAccount</span> <span class="token function">redisAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"redis"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SysAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAccount</span><span class="token punctuation">(</span><span class="token string">"don"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"redis"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SysAccount</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code>opsForValue --&gt; string 操作
opsForHash --&gt; hash 操作
opsForList --&gt; list 操作
opsForSet --&gt; set 操作
opsForZSet --&gt; Zset 操作
</code></pre> 
<p>测试完成，查看 Redis 数据库的数据</p> 
<p><img src="https://images2.imgbox.com/e2/fb/FbyaWTcu_o.png" alt="在这里插入图片描述"></p> 
<p>RedisTemplate 默认使用的是 JdkSerializationRedisSerializer 序列化</p> 
<h3><a id="taco_Spring_Data_Redis__121"></a>🌮 Spring Data Redis 自定义序列化</h3> 
<p>编写 Redis 配置类 RedisConfig 自定义 RedisTemplate 缓存序列化配置</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 创建 RedisTemplate 对象</span>
    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置 RedisConnection 工厂（实现多种 Java Redis 客户端接入的工厂）</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用 Jackson2JsonRedisSerialize 替换默认序列化</span>
    <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapper<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapper<span class="token punctuation">.</span><span class="token function">activateDefaultTyping</span><span class="token punctuation">(</span>mapper<span class="token punctuation">.</span><span class="token function">getPolymorphicTypeValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">,</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>As</span><span class="token punctuation">.</span>PROPERTY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

    redisTemplate<span class="token punctuation">.</span><span class="token function">setDefaultSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">StringRedisSerializer</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试，查看 Redis 数据库的数据，JSON 格式数据</p> 
<p><img src="https://images2.imgbox.com/28/75/pkx2dxLo_o.png" alt="在这里插入图片描述"></p> 
<p>🍅 StringRedisTemplate 默认使用的 StringRedisSerializer 序列化机制，简单的字符串序列化 ，key、value 都是 String 字符串，不用修改。参考 <code>org.springframework.data.redis.core.StringRedisTemplate</code></p> 
<p>🍅 RedisSerializer 接口是 Redis 序列化接口，用于 Redis KEY 和 VALUE 的序列化</p> 
<p><code>org.springframework.data.redis.serializer.RedisSerializer</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SerializationException</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token class-name">T</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SerializationException</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">java</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">java</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">java</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkSerializationRedisSerializer</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">RedisSerializer</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">byteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ByteArrayRedisSerializer</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">canSerialize</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isAssignable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实现类有：</p> 
<p><img src="https://images2.imgbox.com/91/33/wYMbYolo_o.png" alt="在这里插入图片描述"></p> 
<p>JdkSerializationRedisSerializer：序列化对象，对象必须实现 Serializable 接口，被序列化除属性内容还有其他内容，长度长且不易阅读，默认就是采用这种序列化方式。</p> 
<p>Jackson2JsonRedisSerializer：序列化对象为 JSON 字符串，被序列化对象不需要实现 Serializable 接口，序列化后结果容易阅读，存储字节少，速度快。</p> 
<h2><a id="rainbow_Spring_Boot__Redisson_209"></a>🌈 Spring Boot 集成 Redisson</h2> 
<h3><a id="taco_Redisson__211"></a>🌮 Redisson 的依赖</h3> 
<p>Maven 引入依赖，版本根据 Spring Boot 版本选择</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${redisson.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>参考 https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter</p> 
<h3><a id="taco_Redisson__225"></a>🌮 Redisson 的配置</h3> 
<p>添加配置文件 <code>redisson-config.yml</code></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">singleServerConfig</span><span class="token punctuation">:</span>
  <span class="token key atrule">address</span><span class="token punctuation">:</span> <span class="token string">"redis://127.0.0.1:6379"</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">clientName</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">idleConnectionTimeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
  <span class="token key atrule">pingTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
  <span class="token key atrule">retryAttempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">retryInterval</span><span class="token punctuation">:</span> <span class="token number">1500</span>
  <span class="token key atrule">reconnectionTimeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
  <span class="token key atrule">failedAttempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">subscriptionsPerConnection</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">subscriptionConnectionMinimumIdleSize</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">subscriptionConnectionPoolSize</span><span class="token punctuation">:</span> <span class="token number">50</span>
  <span class="token key atrule">connectionMinimumIdleSize</span><span class="token punctuation">:</span> <span class="token number">32</span>
  <span class="token key atrule">connectionPoolSize</span><span class="token punctuation">:</span> <span class="token number">64</span>
  <span class="token key atrule">dnsMonitoringInterval</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">threads</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">nettyThreads</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">codec</span><span class="token punctuation">:</span>
  <span class="token key atrule">class</span><span class="token punctuation">:</span> <span class="token string">"org.redisson.codec.JsonJacksonCodec"</span>
<span class="token key atrule">transportMode</span><span class="token punctuation">:</span> <span class="token string">"NIO"</span>
</code></pre> 
<p>在 application.yml 中配置</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">redisson</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>redisson<span class="token punctuation">-</span>config.yml
</code></pre> 
<p>配置完后即可使用 RedissonClient 操作 Redis</p> 
<p>🍅 详细参考 <code>org.redisson.spring.starter.RedissonAutoConfiguration</code></p> 
<h3><a id="taco_RedissonClient__269"></a>🌮 RedissonClient 的使用</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/set/{key}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RBucket</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyObj <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    keyObj<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get/{key}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RBucket</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyObj <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> keyObj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>锁的使用</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/lock"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redissonLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.获取 redis 锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 2.获取库存</span>
                <span class="token class-name">RBucket</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> keyObj <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token string">"xiaomi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Integer</span> stock <span class="token operator">=</span> keyObj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 3.比较并且扣减库存</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 4.设置库存</span>
                        keyObj<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">--</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"购买成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>更多锁的使用参考 https://github.com/redisson/redisson/wiki/8.-distributed-locks-and-synchronizers</p> 
<h3><a id="taco__RedissonAutoConfigurationCustomizer__323"></a>🌮 使用 RedissonAutoConfigurationCustomizer 配置</h3> 
<p>新建 Redisson 配置项类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"redisson"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonProperties</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * Redis 缓存 Key 前缀
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> keyPrefix<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 线程池数量, 默认值 = 当前处理核数量 * 2
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> threads<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Netty 线程池数量, 默认值 = 当前处理核数量 * 2
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> nettyThreads<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 传输模式
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">TransportMode</span> transportMode<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 单机服务配置
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">SingleServerConfig</span> singleServerConfig<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 集群服务配置
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ClusterServersConfig</span> clusterServersConfig<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token annotation punctuation">@NoArgsConstructor</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SingleServerConfig</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 客户端名称
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> clientName<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 最小空闲连接数
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> connectionMinimumIdleSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 连接池大小
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> connectionPoolSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 连接空闲超时，单位：毫秒
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> idleConnectionTimeout<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 命令等待超时，单位：毫秒
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> timeout<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 命令失败重试次数
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> retryAttempts<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 命令失败重试次数
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> retryInterval<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 发布和订阅连接的最小空闲连接数
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> subscriptionConnectionMinimumIdleSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 发布和订阅连接池大小
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> subscriptionConnectionPoolSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 单个连接最大订阅数量
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> subscriptionsPerConnection<span class="token punctuation">;</span>
        <span class="token comment">/**
         * DNS监测时间间隔，单位：毫秒
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> dnsMonitoringInterval<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token annotation punctuation">@NoArgsConstructor</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ClusterServersConfig</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 客户端名称
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> clientName<span class="token punctuation">;</span>
        <span class="token comment">/**
         * master最小空闲连接数
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> masterConnectionMinimumIdleSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * master连接池大小
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> masterConnectionPoolSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * slave最小空闲连接数
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> slaveConnectionMinimumIdleSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * slave连接池大小
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> slaveConnectionPoolSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 连接空闲超时，单位：毫秒
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> idleConnectionTimeout<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 命令等待超时，单位：毫秒
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> timeout<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 命令失败重试次数
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> retryAttempts<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 命令失败重试次数
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> retryInterval<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 失败从节点重连间隔时间
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> failedSlaveReconnectionInterval<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 失败从节点校验间隔时间
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> failedSlaveCheckInterval<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 单个连接最大订阅数量
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> subscriptionsPerConnection<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 发布和订阅连接的最小空闲连接数
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> subscriptionConnectionMinimumIdleSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 发布和订阅连接池大小
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> subscriptionConnectionPoolSize<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 读取模式
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">ReadMode</span> readMode<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 订阅模式
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">SubscriptionMode</span> subscriptionMode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>添加 yml 配置 Redisson</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">---</span> <span class="token comment">##### redis 配置 #####</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token comment">#    password:</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
    <span class="token comment"># 是否开启ssl</span>
    <span class="token key atrule">ssl</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token comment"># 连接池中的最大空闲连接 默认8</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span>
        <span class="token comment"># 连接池中的最小空闲连接 默认0</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>
        <span class="token comment"># 连接池最大连接数 默认8 ，负数表示没有限制</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span>
        <span class="token comment"># 连接池最大阻塞等待时间（使用负值表示没有限制） 默认-1</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">-1</span>
<span class="token punctuation">---</span> <span class="token comment"># redisson 客户端配置</span>
<span class="token key atrule">redisson</span><span class="token punctuation">:</span>
  <span class="token key atrule">key-prefix</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
  <span class="token comment"># 线程池数量</span>
  <span class="token key atrule">threads</span><span class="token punctuation">:</span> <span class="token number">16</span>
  <span class="token comment"># Netty线程池数量</span>
  <span class="token key atrule">netty-threads</span><span class="token punctuation">:</span> <span class="token number">32</span>
  <span class="token comment"># 传输模式</span>
  <span class="token key atrule">transport-mode</span><span class="token punctuation">:</span> <span class="token string">"NIO"</span>
  <span class="token comment"># 单节点配置</span>
  <span class="token key atrule">single-server-config</span><span class="token punctuation">:</span>
    <span class="token comment"># 客户端名称</span>
    <span class="token key atrule">client-name</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
    <span class="token comment"># 最小空闲连接数</span>
    <span class="token key atrule">connection-minimum-idle-size</span><span class="token punctuation">:</span> <span class="token number">32</span>
    <span class="token comment"># 连接池大小</span>
    <span class="token key atrule">connection-pool-size</span><span class="token punctuation">:</span> <span class="token number">64</span>
    <span class="token comment"># 连接空闲超时，单位：毫秒</span>
    <span class="token key atrule">idle-connection-timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
    <span class="token comment"># 命令等待超时，单位：毫秒</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
    <span class="token comment"># 如果尝试在此限制之内发送成功，则开始启用 timeout 计时。</span>
    <span class="token key atrule">retry-attempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
    <span class="token comment"># 命令重试发送时间间隔，单位：毫秒</span>
    <span class="token key atrule">retry-interval</span><span class="token punctuation">:</span> <span class="token number">1500</span>
    <span class="token comment"># 发布和订阅连接的最小空闲连接数</span>
    <span class="token key atrule">subscription-connection-minimum-idle-size</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token comment"># 发布和订阅连接池大小</span>
    <span class="token key atrule">subscription-connection-pool-size</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token comment"># 单个连接最大订阅数量</span>
    <span class="token key atrule">subscriptions-per-connection</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token comment"># dns监测时间间隔，单位：毫秒</span>
    <span class="token key atrule">dns-monitoring-interval</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre> 
<p>配置 Redisson</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">RedissonProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DonRedissonAutoConfiguration</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonAutoConfigurationCustomizer</span> <span class="token function">redissonCustomizer</span><span class="token punctuation">(</span><span class="token class-name">RedissonProperties</span> redissonProperties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"DonRedissonAutoConfiguration redissonCustomizer init ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> config <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            config<span class="token punctuation">.</span><span class="token function">setThreads</span><span class="token punctuation">(</span>redissonProperties<span class="token punctuation">.</span><span class="token function">getThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setNettyThreads</span><span class="token punctuation">(</span>redissonProperties<span class="token punctuation">.</span><span class="token function">getNettyThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setCodec</span><span class="token punctuation">(</span><span class="token class-name">JsonJacksonCodec</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setTransportMode</span><span class="token punctuation">(</span>redissonProperties<span class="token punctuation">.</span><span class="token function">getTransportMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">RedissonProperties<span class="token punctuation">.</span>SingleServerConfig</span> singleServerConfig <span class="token operator">=</span> redissonProperties<span class="token punctuation">.</span><span class="token function">getSingleServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RedissonProperties<span class="token punctuation">.</span>ClusterServersConfig</span> clusterServersConfig <span class="token operator">=</span> redissonProperties<span class="token punctuation">.</span><span class="token function">getClusterServersConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 单机模式</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setClientName</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment">// 设置 Redis key 前缀</span>
                        <span class="token punctuation">.</span><span class="token function">setNameMapper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeyPrefixHandler</span><span class="token punctuation">(</span>redissonProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setRetryAttempts</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getRetryAttempts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setRetryInterval</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getRetryInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSubscriptionConnectionMinimumIdleSize</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getSubscriptionConnectionMinimumIdleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSubscriptionConnectionPoolSize</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getSubscriptionConnectionPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSubscriptionsPerConnection</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getSubscriptionsPerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setConnectionMinimumIdleSize</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getConnectionMinimumIdleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setConnectionPoolSize</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getConnectionPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setIdleConnectionTimeout</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getIdleConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setDnsMonitoringInterval</span><span class="token punctuation">(</span>singleServerConfig<span class="token punctuation">.</span><span class="token function">getDnsMonitoringInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 集群模式</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                config<span class="token punctuation">.</span><span class="token function">useClusterServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setClientName</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment">// 设置 Redis key 前缀</span>
                        <span class="token punctuation">.</span><span class="token function">setNameMapper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeyPrefixHandler</span><span class="token punctuation">(</span>redissonProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setMasterConnectionMinimumIdleSize</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getMasterConnectionMinimumIdleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setMasterConnectionPoolSize</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getMasterConnectionPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSlaveConnectionMinimumIdleSize</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getSlaveConnectionMinimumIdleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSlaveConnectionPoolSize</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getSlaveConnectionPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setIdleConnectionTimeout</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getIdleConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setRetryAttempts</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getRetryAttempts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setRetryInterval</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getRetryInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setFailedSlaveReconnectionInterval</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getFailedSlaveReconnectionInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setFailedSlaveCheckInterval</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getFailedSlaveCheckInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSubscriptionsPerConnection</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getSubscriptionsPerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSubscriptionConnectionMinimumIdleSize</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getSubscriptionConnectionMinimumIdleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSubscriptionConnectionPoolSize</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getSubscriptionConnectionPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setReadMode</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getReadMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSubscriptionMode</span><span class="token punctuation">(</span>clusterServersConfig<span class="token punctuation">.</span><span class="token function">getSubscriptionMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>测试分布式锁</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/lock"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"当前线程名：{}"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="taco__624"></a>🌮 集群配置</h3> 
<pre><code class="prism language-yaml"><span class="token punctuation">---</span> <span class="token comment">##### redis 配置 #####</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">6380</span>
        <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">6381</span>
        <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">6382</span>
        <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">6383</span>
        <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">6384</span>
        <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">6385</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token comment"># 连接超时时间</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
    <span class="token comment"># 是否开启ssl</span>
    <span class="token key atrule">ssl</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token comment"># 连接池中的最大空闲连接 默认8</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span>
        <span class="token comment"># 连接池中的最小空闲连接 默认0</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>
        <span class="token comment"># 连接池最大连接数 默认8 ，负数表示没有限制</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span>
        <span class="token comment"># 连接池最大阻塞等待时间（使用负值表示没有限制） 默认-1</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">-1</span>
<span class="token punctuation">---</span> <span class="token comment"># redisson 客户端配置</span>
<span class="token key atrule">redisson</span><span class="token punctuation">:</span>
  <span class="token key atrule">key-prefix</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
  <span class="token comment"># 线程池数量</span>
  <span class="token key atrule">threads</span><span class="token punctuation">:</span> <span class="token number">16</span>
  <span class="token comment"># Netty线程池数量</span>
  <span class="token key atrule">netty-threads</span><span class="token punctuation">:</span> <span class="token number">32</span>
  <span class="token comment"># 传输模式</span>
  <span class="token key atrule">transport-mode</span><span class="token punctuation">:</span> <span class="token string">"NIO"</span>
  <span class="token key atrule">cluster-servers-config</span><span class="token punctuation">:</span>
    <span class="token comment"># 客户端名称</span>
    <span class="token key atrule">client-name</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
    <span class="token comment"># 主节点最小空闲连接数</span>
    <span class="token key atrule">master-connection-minimum-idle-size</span><span class="token punctuation">:</span> <span class="token number">24</span>
    <span class="token comment"># 主节点连接池大小</span>
    <span class="token key atrule">master-connection-pool-size</span><span class="token punctuation">:</span> <span class="token number">64</span>
    <span class="token comment"># 从节点最小空闲连接数</span>
    <span class="token key atrule">slave-connection-minimum-idle-size</span><span class="token punctuation">:</span> <span class="token number">24</span>
    <span class="token comment"># 从节点连接池大小</span>
    <span class="token key atrule">slave-connection-pool-size</span><span class="token punctuation">:</span> <span class="token number">64</span>
    <span class="token comment"># 连接空闲超时，单位：毫秒</span>
    <span class="token key atrule">idle-connection-timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
    <span class="token comment"># 命令等待超时，单位：毫秒</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
    <span class="token comment"># 命令失败重试次数</span>
    <span class="token key atrule">retry-attempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
    <span class="token comment"># 命令重试发送时间间隔，单位：毫秒</span>
    <span class="token key atrule">retry-interval</span><span class="token punctuation">:</span> <span class="token number">1500</span>
    <span class="token comment"># 失败从节点重连间隔时间</span>
    <span class="token key atrule">failed-slave-reconnection-interval</span><span class="token punctuation">:</span> <span class="token number">3000</span>
    <span class="token comment"># 失败从节点校验间隔时间</span>
    <span class="token key atrule">failed-slave-check-interval</span><span class="token punctuation">:</span> <span class="token number">60000</span>
    <span class="token comment"># 单个连接最大订阅数量</span>
    <span class="token key atrule">subscriptions-per-connection</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token comment"># 发布和订阅连接的最小空闲连接数</span>
    <span class="token key atrule">subscription-connection-minimum-idle-size</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token comment"># 发布和订阅连接池大小</span>
    <span class="token key atrule">subscription-connection-pool-size</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token comment"># 读取模式</span>
    <span class="token key atrule">read-mode</span><span class="token punctuation">:</span> <span class="token string">"slave"</span>
    <span class="token comment"># 订阅模式</span>
    <span class="token key atrule">subscription-mode</span><span class="token punctuation">:</span> <span class="token string">"master"</span>
</code></pre> 
<p>🍔 更多 API 操作参考 Redisson 官网 https://github.com/redisson/redisson</p> 
<h2><a id="rainbow__Spring_Cache__Redis__699"></a>🌈 基于 Spring Cache 实现 Redis 缓存</h2> 
<h3><a id="taco_Spring_Cache__701"></a>🌮 Spring Cache 的依赖</h3> 
<p>Maven 引入依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-cache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="taco_Spring_Cache__712"></a>🌮 Spring Cache 的配置</h3> 
<p>在 yml 文件添加配置</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">---</span> <span class="token comment">##### spring cache 配置 #####</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">cache-names</span><span class="token punctuation">:</span> don
</code></pre> 
<p>在主启动类开启支持</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableCaching</span>
</code></pre> 
<p>完成配置后，Spring Boot 会自动配置一个 RedisCacheManager 的类</p> 
<p>参考 <code>org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</code></p> 
<h3><a id="taco_Spring_Cache__734"></a>🌮 Spring Cache 缓存使用</h3> 
<p>🍅 注解 <code>@Cacheable</code> 缓存值</p> 
<p>添加在查询方法上，将方法的返回值进行缓存，默认情况下，缓存的 key 就是方法的参数，缓存的 value 就是方法的返回值。key 可以手动指定，使用 <code>SpEL</code> 表达式。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/cache/get"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">"#str"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"key {}"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>请求方法，查询缓存中是否有值，有则直接返回，无则执行方法并将值放入缓存。</p> 
<p>🍅 注解 <code>@CachePut</code> 更新缓存值</p> 
<p>注解添加在更新方法上，可以将方法的返回值自动更新到已经存在的 key 中。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@CachePut</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">"#str"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/cache/put"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"key {}"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>🍅 注解 <code>@CacheEvict</code> 删除缓存值</p> 
<p>注解添加在删除方法上，会将缓存中的值删除。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">"#str"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/cache/clear"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"key {}"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>更多使用 https://docs.spring.io/spring-framework/docs/5.3.27/reference/html/integration.html#cache-annotations</p> 
<h3><a id="taco__RedisCacheManager_779"></a>🌮 自定义配置 RedisCacheManager</h3> 
<p>可以手动配置 RedisCacheManager，指定序列化机制，缓存时长等。</p> 
<p>示例</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">CacheManager</span> <span class="token function">redisCacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">,</span> <span class="token class-name">CacheProperties</span> cacheProperties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"DonCacheAutoConfiguration redisCacheManager init ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapper<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapper<span class="token punctuation">.</span><span class="token function">activateDefaultTyping</span><span class="token punctuation">(</span>mapper<span class="token punctuation">.</span><span class="token function">getPolymorphicTypeValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">,</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>As</span><span class="token punctuation">.</span>PROPERTY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 配置序列化, 默认过期时间10分钟</span>
    <span class="token class-name">Duration</span> timeToLive <span class="token operator">=</span> cacheProperties<span class="token punctuation">.</span><span class="token function">getRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>timeToLive<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">:</span> timeToLive<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">computePrefixWith</span><span class="token punctuation">(</span>name <span class="token operator">-&gt;</span> name <span class="token operator">+</span> <span class="token string">"::"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span>stringRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">RedisCacheManager</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transactionAware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>End…</p> 
<p>https://github.com/redisson/redisson</p> 
<p>https://spring.io/projects/spring-boot</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dc45dad27a4a74a67edcbc3b35b17514/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java 8 List 排序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c9a297d1d98d247f7f121bc8c88b0bca/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ansible 参数·命令说明</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>