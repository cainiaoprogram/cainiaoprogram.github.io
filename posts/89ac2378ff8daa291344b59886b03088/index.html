<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>简易机器学习笔记（九）LeNet实例 - 在眼疾识别数据集iChallenge-PM上的应用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="简易机器学习笔记（九）LeNet实例 - 在眼疾识别数据集iChallenge-PM上的应用" />
<meta property="og:description" content="前言 上一节大概讲了一下LeNet的内容，这一章就直接来用，实际上用一下LeNet来进行训练和分类试试。
调用的数据集：
https://aistudio.baidu.com/datasetdetail/19065
说明：
如今近视已经成为困扰人们健康的一项全球性负担，在近视人群中，有超过35%的人患有重度近视。近视会拉长眼睛的光轴，也可能引起视网膜或者络网膜的病变。随着近视度数的不断加深，高度近视有可能引发病理性病变，这将会导致以下几种症状：视网膜或者络网膜发生退化、视盘区域萎缩、漆裂样纹损害、Fuchs斑等。因此，及早发现近视患者眼睛的病变并采取治疗，显得非常重要。
数据集实际上用了这么几个部分：
其中DATADIR目录下的图片都是以下形式：
其中照片的成分是按照文件的名称来进行区分的，当其命名规则为P开头的，则代表其为病理性近视，N开头的为正常眼睛，而H开头的则代表为高度近视。
我们将病理性患者的图片作为正样本，标签为1； 非病理性患者的图片作为负样本，标签为0。从数据集中选取两张图片，通过LeNet提取特征，构建分类器，对正负样本进行分类，并将图片显示出来。
流程 正式开始之前，我们还是要将任务按照流程划分
我们在这次开发中，不仅要训练模型，计算Loss，还需要用数据集对成果进行准确性分析。
定义数据读取器
定义LeNet模型
编写训练过程
定义评估过程
进行模型计算
实际开发 定义数据读取器 我们需要读取两部分数据，分别是训练集和评估集，这两个集是分开的
首先我们需要进行一个预处理部分： # 对读入的图像数据进行预处理 def transform_img(img): # 将图片尺寸缩放道 224x224 img = cv2.resize(img, (224, 224)) # 读入的图像数据格式是[H, W, C] # 使用转置操作将其变成[C, H, W] img = np.transpose(img, (2,0,1)) img = img.astype(&#39;float32&#39;) # 将数据范围调整到[-1.0, 1.0]之间 img = img / 255. img = img * 2.0 - 1.0 return img 定义一个训练集数据读取器 类似之前的，我们需要将训练集划分batch，还需要将其打乱进行。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/89ac2378ff8daa291344b59886b03088/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T18:07:25+08:00" />
<meta property="article:modified_time" content="2024-01-04T18:07:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">简易机器学习笔记（九）LeNet实例 - 在眼疾识别数据集iChallenge-PM上的应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>上一节大概讲了一下LeNet的内容，这一章就直接来用，实际上用一下LeNet来进行训练和分类试试。</p> 
<p>调用的数据集：</p> 
<p><a href="https://aistudio.baidu.com/datasetdetail/19065" rel="nofollow">https://aistudio.baidu.com/datasetdetail/19065</a></p> 
<p>说明：</p> 
<p>如今近视已经成为困扰人们健康的一项全球性负担，在近视人群中，有超过35%的人患有重度近视。近视会拉长眼睛的光轴，也可能引起视网膜或者络网膜的病变。随着近视度数的不断加深，高度近视有可能引发病理性病变，这将会导致以下几种症状：视网膜或者络网膜发生退化、视盘区域萎缩、漆裂样纹损害、Fuchs斑等。因此，及早发现近视患者眼睛的病变并采取治疗，显得非常重要。</p> 
<p>数据集实际上用了这么几个部分：</p> 
<p><img src="https://images2.imgbox.com/91/1e/gQI1zOkv_o.png" alt="在这里插入图片描述"><br> 其中DATADIR目录下的图片都是以下形式：</p> 
<p><img src="https://images2.imgbox.com/5c/ea/exeBxnF8_o.png" alt="在这里插入图片描述"><br> 其中照片的成分是按照文件的名称来进行区分的，当其命名规则为P开头的，则代表其为病理性近视，N开头的为正常眼睛，而H开头的则代表为高度近视。</p> 
<p>我们将病理性患者的图片作为正样本，标签为1； 非病理性患者的图片作为负样本，标签为0。从数据集中选取两张图片，通过LeNet提取特征，构建分类器，对正负样本进行分类，并将图片显示出来。</p> 
<h3><a id="_21"></a>流程</h3> 
<p>正式开始之前，我们还是要将任务按照流程划分<br> 我们在这次开发中，不仅要训练模型，计算Loss，还需要用数据集对成果进行准确性分析。</p> 
<ol><li> <p>定义数据读取器</p> </li><li> <p>定义LeNet模型</p> </li><li> <p>编写训练过程</p> </li><li> <p>定义评估过程</p> </li><li> <p>进行模型计算</p> </li></ol> 
<h3><a id="_36"></a>实际开发</h3> 
<h4><a id="_38"></a>定义数据读取器</h4> 
<p>我们需要读取两部分数据，分别是训练集和评估集，这两个集是分开的</p> 
<ol><li>首先我们需要进行一个预处理部分：</li></ol> 
<pre><code class="prism language-python"><span class="token comment"># 对读入的图像数据进行预处理</span>
<span class="token keyword">def</span> <span class="token function">transform_img</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 将图片尺寸缩放道 224x224</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 读入的图像数据格式是[H, W, C]</span>
    <span class="token comment"># 使用转置操作将其变成[C, H, W]</span>
    img <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> img<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
    <span class="token comment"># 将数据范围调整到[-1.0, 1.0]之间</span>
    img <span class="token operator">=</span> img <span class="token operator">/</span> <span class="token number">255.</span>
    img <span class="token operator">=</span> img <span class="token operator">*</span> <span class="token number">2.0</span> <span class="token operator">-</span> <span class="token number">1.0</span>
    <span class="token keyword">return</span> img
</code></pre> 
<ol start="2"><li>定义一个训练集数据读取器</li></ol> 
<p>类似之前的，我们需要将训练集划分batch，还需要将其打乱进行。</p> 
<p>至于Label，则是由名称决定的</p> 
<p>分组读取完毕之后，</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义训练集数据读取器</span>
<span class="token keyword">def</span> <span class="token function">data_loader</span><span class="token punctuation">(</span>datadir<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> mode <span class="token operator">=</span> <span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 将datadir目录下的文件列出来，每条文件都要读入</span>
    filenames <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>datadir<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'train'</span><span class="token punctuation">:</span>
            <span class="token comment"># 训练时随机打乱数据顺序</span>
            random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>filenames<span class="token punctuation">)</span>
        batch_imgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        batch_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> filenames<span class="token punctuation">:</span>
            filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>datadir<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
            img <span class="token operator">=</span> transform_img<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token keyword">if</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'H'</span> <span class="token keyword">or</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'N'</span><span class="token punctuation">:</span>
                <span class="token comment"># H开头的文件名表示高度近似，N开头的文件名表示正常视力</span>
                <span class="token comment"># 高度近视和正常视力的样本，都不是病理性的，属于负样本，标签为0</span>
                label <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">elif</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'P'</span><span class="token punctuation">:</span>
                <span class="token comment"># P开头的是病理性近视，属于正样本，标签为1</span>
                label <span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span><span class="token punctuation">(</span><span class="token string">'Not excepted file name'</span><span class="token punctuation">)</span>
            <span class="token comment"># 每读取一个样本的数据，就将其放入数据列表中</span>
            batch_imgs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            batch_labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>batch_imgs<span class="token punctuation">)</span> <span class="token operator">==</span> batch_size<span class="token punctuation">:</span>
                <span class="token comment"># 当数据列表的长度等于batch_size的时候，</span>
                <span class="token comment"># 把这些数据当作一个mini-batch，并作为数据生成器的一个输出</span>
                imgs_array <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch_imgs<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
                labels_array <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch_labels<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">yield</span> imgs_array<span class="token punctuation">,</span> labels_array
                batch_imgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                batch_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>batch_imgs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># 剩余样本数目不足一个batch_size的数据，一起打包成一个mini-batch</span>
            imgs_array <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch_imgs<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            labels_array <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch_labels<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">yield</span> imgs_array<span class="token punctuation">,</span> labels_array

    <span class="token keyword">return</span> reader
</code></pre> 
<h4><a id="_112"></a>定义一个验证集数据读取器</h4> 
<p>训练集读取时通过文件名来确定样本标签，验证集则通过csvfile来读取每个图片对应的标签</p> 
<p>请查看解压后的验证集标签数据，观察csvfile文件里面所包含的内容</p> 
<p>需要注意的是,原先的文件不是csv，而是一个xlsx，不能直接改个后缀就直接用，而是需要使用office或者wps重新保存一下，而且需要注意的是，请使用UTF-8或者gbk格式打开，否则可能会导致无法正确读取文件。</p> 
<p>csvfile文件所包含的内容格式如下，每一行代表一个样本，其中第一列是图片id，第二列是文件名，第三列是图片标签，第四列和第五列是Fovea的坐标，与分类任务无关</p> 
<p>ID,imgName,Label,Fovea_X,Fovea_Y<br> 1,V0001.jpg,0,1157.74,1019.87<br> 2,V0002.jpg,1,1285.82,1080.47</p> 
<p>打开包含验证集标签的csvfile，并读入其中的内容</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义验证集数据读取器</span>
<span class="token keyword">def</span> <span class="token function">valid_data_loader</span><span class="token punctuation">(</span>datadir<span class="token punctuation">,</span> csvfile<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'valid'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 训练集读取时通过文件名来确定样本标签，验证集则通过csvfile来读取每个图片对应的标签</span>
    <span class="token comment"># 请查看解压后的验证集标签数据，观察csvfile文件里面所包含的内容</span>
    <span class="token comment"># csvfile文件所包含的内容格式如下，每一行代表一个样本，</span>
    <span class="token comment"># 其中第一列是图片id，第二列是文件名，第三列是图片标签，</span>
    <span class="token comment"># 第四列和第五列是Fovea的坐标，与分类任务无关</span>
    <span class="token comment"># ID,imgName,Label,Fovea_X,Fovea_Y</span>
    <span class="token comment"># 1,V0001.jpg,0,1157.74,1019.87</span>
    <span class="token comment"># 2,V0002.jpg,1,1285.82,1080.47</span>
    <span class="token comment"># 打开包含验证集标签的csvfile，并读入其中的内容</span>
    filelists <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>csvfile<span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch_imgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        batch_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> line <span class="token keyword">in</span> filelists<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            line <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
            name <span class="token operator">=</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            label <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># 根据图片文件名加载图片，并对图像数据作预处理</span>
            filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>datadir<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
            img <span class="token operator">=</span> transform_img<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token comment"># 每读取一个样本的数据，就将其放入数据列表中</span>
            batch_imgs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            batch_labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>batch_imgs<span class="token punctuation">)</span> <span class="token operator">==</span> batch_size<span class="token punctuation">:</span>
                <span class="token comment"># 当数据列表的长度等于batch_size的时候，</span>
                <span class="token comment"># 把这些数据当作一个mini-batch，并作为数据生成器的一个输出</span>
                imgs_array <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch_imgs<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
                labels_array <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch_labels<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">yield</span> imgs_array<span class="token punctuation">,</span> labels_array
                batch_imgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                batch_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>batch_imgs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># 剩余样本数目不足一个batch_size的数据，一起打包成一个mini-batch</span>
            imgs_array <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch_imgs<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            labels_array <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch_labels<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">yield</span> imgs_array<span class="token punctuation">,</span> labels_array

    <span class="token keyword">return</span> reader
</code></pre> 
<h3><a id="LeNet_174"></a>定义LeNet模型</h3> 
<p>这个地方其实上一节也说过了，就是LeNet是如何定义的，详情可以参考</p> 
<p><a href="https://blog.csdn.net/Andius/article/details/135364697?spm=1001.2014.3001.5501">简易机器学习笔记（八）关于经典的图像分类问题-常见经典神经网络LeNet</a></p> 
<p>这里就不过多介绍了，简单放一下代码：</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding:utf-8 -*-</span>

<span class="token comment"># 导入需要的包</span>
<span class="token keyword">import</span> paddle
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> paddle<span class="token punctuation">.</span>nn <span class="token keyword">import</span> Conv2D<span class="token punctuation">,</span> MaxPool2D<span class="token punctuation">,</span> Linear<span class="token punctuation">,</span> Dropout
<span class="token keyword">import</span> paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token comment"># 定义 LeNet 网络结构</span>
<span class="token keyword">class</span> <span class="token class-name">LeNet</span><span class="token punctuation">(</span>paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>LeNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>num_classes <span class="token operator">=</span> num_classes
        <span class="token comment"># 创建卷积和池化层块，每个卷积层使用Sigmoid激活函数，后面跟着一个2x2的池化</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>max_pool1 <span class="token operator">=</span> MaxPool2D<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>max_pool2 <span class="token operator">=</span> MaxPool2D<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># 创建第3个卷积层</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token comment"># 创建全连接层，第一个全连接层的输出神经元个数为64</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">300000</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>
        <span class="token comment"># 第二个全连接层输出神经元个数为分类标签的类别数</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>

    <span class="token comment"># 网络的前向计算过程</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>max_pool1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>max_pool2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> paddle<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">if</span> label <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>num_classes <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                pred <span class="token operator">=</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
                pred <span class="token operator">=</span> paddle<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token operator">-</span> pred<span class="token punctuation">,</span> pred<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                acc <span class="token operator">=</span> paddle<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> paddle<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>label<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'int64'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                acc <span class="token operator">=</span> paddle<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>x<span class="token punctuation">,</span> paddle<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>label<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'int64'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> x<span class="token punctuation">,</span> acc
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> x
</code></pre> 
<h3><a id="_234"></a>编写训练过程</h3> 
<p>训练过程实际上和之前文章中提到的训练过程并无二至，实际上还是老一套：</p> 
<ol><li>读数据</li><li>前向计算预测</li><li>计算loss函数</li><li>反向传播</li><li>更新权重</li><li>清除梯度</li></ol> 
<p>当然了，这次的训练主要目的不是为了进行实际的工作，而是来进行模型准确度的测算，这也是我们在上面为什么读取数据集的时候除了基本的训练集，还添加了一个验证集。</p> 
<p>验证集的验证工作其实比较简单，就是把model和验证集的参数传进去，然后让模型的预测和实际结果进行比较，计算出预测值和实际的label值的binary_cross_entropy_with_logits，再求出平均的损失值和准确度</p> 
<p>代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># LeNet 识别眼疾图片</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">import</span> paddle
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

DATADIR <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/palm/PALM-Training400/PALM-Training400'</span>
DATADIR2 <span class="token operator">=</span> <span class="token string">'/home/aistudio/work/palm/PALM-Validation400'</span>
CSVFILE <span class="token operator">=</span> <span class="token string">'/home/aistudio/labels.csv'</span>

<span class="token keyword">def</span> <span class="token function">train_pm</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start training ... '</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">#定义数据读取器，训练数据读取器和验证数据读取器</span>
    train_loader <span class="token operator">=</span> data_loader<span class="token punctuation">(</span>DATADIR<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">)</span>
    valid_loader <span class="token operator">=</span> valid_data_loader<span class="token punctuation">(</span>DATADIR2<span class="token punctuation">,</span> CSVFILE<span class="token punctuation">)</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>EPOCH_NUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> batch_id<span class="token punctuation">,</span>data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            x_data<span class="token punctuation">,</span>y_data <span class="token operator">=</span> data
            img <span class="token operator">=</span> paddle<span class="token punctuation">.</span>to_tensor<span class="token punctuation">(</span>x_data<span class="token punctuation">)</span>
            label <span class="token operator">=</span> paddle<span class="token punctuation">.</span>to_tensor<span class="token punctuation">(</span>y_data<span class="token punctuation">)</span>
            <span class="token comment"># 运行模型前向计算，得到预测值</span>
            logits <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
            avg_loss <span class="token operator">=</span> paddle<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>

            <span class="token keyword">if</span> batch_id <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch: {}, batch_id: {}, loss is: {:.4f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> batch_id<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>avg_loss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token comment">#反向传播，更新权重，清除梯度</span>
            avg_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>clear_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        accuracies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> batch_id<span class="token punctuation">,</span>data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>valid_loader<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            x_data<span class="token punctuation">,</span> y_data <span class="token operator">=</span> data
            img <span class="token operator">=</span> paddle<span class="token punctuation">.</span>to_tensor<span class="token punctuation">(</span>x_data<span class="token punctuation">)</span>
            label <span class="token operator">=</span> paddle<span class="token punctuation">.</span>to_tensor<span class="token punctuation">(</span>y_data<span class="token punctuation">)</span>
            <span class="token comment"># 运行模型前向计算，得到预测值</span>
            logits <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token comment"># 二分类，sigmoid计算后的结果以0.5为阈值分两个类别</span>
            <span class="token comment"># 计算sigmoid后的预测概率，进行loss计算</span>
            pred <span class="token operator">=</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>logits<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> label<span class="token punctuation">)</span>

            <span class="token comment"># 计算预测概率小于0.5的类别</span>
            pred2 <span class="token operator">=</span> pred <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span>   

            <span class="token comment"># 得到两个类别的预测概率，并沿第一个维度级联</span>
            pred <span class="token operator">=</span> paddle<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>pred2<span class="token punctuation">,</span> pred<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            acc <span class="token operator">=</span> paddle<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> paddle<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>label<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'int64'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            accuracies<span class="token punctuation">.</span>append<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[validation] accuracy/loss: {:.4f}/{:.4f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>accuracies<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>losses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

        paddle<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'palm.pdparams'</span><span class="token punctuation">)</span>
        paddle<span class="token punctuation">.</span>save<span class="token punctuation">(</span>optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'palm.pdopt'</span><span class="token punctuation">)</span>


<span class="token comment">#定义评估过程</span>
<span class="token keyword">def</span> <span class="token function">evaluation</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span>params_file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start evaluation.....'</span><span class="token punctuation">)</span>

    <span class="token comment">#加载模型参数</span>
    model_state_dict <span class="token operator">=</span> paddle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>params_file_path<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_dict<span class="token punctuation">(</span>model_state_dict<span class="token punctuation">)</span>

    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    eval_loader <span class="token operator">=</span> data_loader<span class="token punctuation">(</span>DATADIR<span class="token punctuation">,</span> 
                        batch_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'eval'</span><span class="token punctuation">)</span>
    acc_set <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    avg_loss_set <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> batch_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>eval_loader<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_data<span class="token punctuation">,</span>y_data <span class="token operator">=</span> data
        img <span class="token operator">=</span> paddle<span class="token punctuation">.</span>to_tensor<span class="token punctuation">(</span>x_data<span class="token punctuation">)</span>
        label <span class="token operator">=</span> paddle<span class="token punctuation">.</span>to_tensor<span class="token punctuation">(</span>y_data<span class="token punctuation">)</span>
        y_data <span class="token operator">=</span> y_data<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        label_64 <span class="token operator">=</span> paddle<span class="token punctuation">.</span>to_tensor<span class="token punctuation">(</span>y_data<span class="token punctuation">)</span>

        <span class="token comment"># 计算预测和精度</span>
        prediction<span class="token punctuation">,</span> acc <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">,</span> label_64<span class="token punctuation">)</span>

        <span class="token comment"># 计算损失函数值</span>
        loss <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>prediction<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
        avg_loss <span class="token operator">=</span> paddle<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>
        acc_set<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>acc<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        avg_loss_set<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>avg_loss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 求平均精度</span>
    acc_val_mean <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>acc_set<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    avg_loss_val_mean <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>avg_loss_set<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'loss={:.4f}, acc={:.4f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>avg_loss_val_mean<span class="token punctuation">,</span> acc_val_mean<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>上述就是LeNet在实际验证中的总全部代码，稍微看懂整理一下即可。我们可以跑一下看看结果</p> 
<h3><a id="_359"></a>结果</h3> 
<p>他奶奶的，本来就是个三分法的问题，算出来的准确度才0.5几，那不就和我瞎猜准确度高一点点…</p> 
<p>不过也能理解，原来1444x1444的图片压缩到244x244再进行处理，这个精确度能高就有鬼了…</p> 
<p>不过这也算是一个全流程的设计与开发，可以参考一下流程，</p> 
<pre><code class="prism language-python">start training <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
epoch<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.8100</span>
epoch<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6131</span>
epoch<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.7744</span>
epoch<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.7073</span>
<span class="token punctuation">[</span>validation<span class="token punctuation">]</span> accuracy<span class="token operator">/</span>loss<span class="token punctuation">:</span> <span class="token number">0.5275</span><span class="token operator">/</span><span class="token number">0.6923</span>
epoch<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.7042</span>
epoch<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6933</span>
epoch<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6831</span>
epoch<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6810</span>
<span class="token punctuation">[</span>validation<span class="token punctuation">]</span> accuracy<span class="token operator">/</span>loss<span class="token punctuation">:</span> <span class="token number">0.5275</span><span class="token operator">/</span><span class="token number">0.6920</span>
epoch<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.7451</span>
epoch<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6951</span>
epoch<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.7227</span>
epoch<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6579</span>
<span class="token punctuation">[</span>validation<span class="token punctuation">]</span> accuracy<span class="token operator">/</span>loss<span class="token punctuation">:</span> <span class="token number">0.5275</span><span class="token operator">/</span><span class="token number">0.6918</span>
epoch<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6808</span>
epoch<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6888</span>
epoch<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6944</span>
epoch<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6829</span>
<span class="token punctuation">[</span>validation<span class="token punctuation">]</span> accuracy<span class="token operator">/</span>loss<span class="token punctuation">:</span> <span class="token number">0.5275</span><span class="token operator">/</span><span class="token number">0.6917</span>
epoch<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6855</span>
epoch<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.6458</span>
epoch<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.7227</span>
epoch<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> batch_id<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> loss <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">0.7857</span>
<span class="token punctuation">[</span>validation<span class="token punctuation">]</span> accuracy<span class="token operator">/</span>loss<span class="token punctuation">:</span> <span class="token number">0.5275</span><span class="token operator">/</span><span class="token number">0.6917</span>
start evaluation<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
loss<span class="token operator">=</span><span class="token number">0.6912</span><span class="token punctuation">,</span> acc<span class="token operator">=</span><span class="token number">0.5325</span>
</code></pre> 
<p>我们换一种方法，不改变图片的大小了，直接上1444x1444图片，然后把神经元改一下，fc1的全连接层的输入值要改成15123000</p> 
<pre><code class="prism language-python"> <span class="token comment"># 创建全连接层，第一个全连接层的输出神经元个数为64</span>
 self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">15123000</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>
</code></pre> 
<p>然后这个模型，他奶奶的，跑了快五分钟才跑了一个batch，不知道跑到明天能不能跑出来…跑出来再给大家看看结果</p> 
<p>算了笑死，刚刚跑了一下下采样改成600 x 600，结果结果和244 x 244 完全一样，不知道这个对于图片大小到底是不是真的</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/21434e2e6241ab342ca11c3237d9aa8b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringBoot整合sentinel</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/68061f4e7d44e04892183b2cbbda70f0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">QT上位机开发（简易图像处理软件）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>