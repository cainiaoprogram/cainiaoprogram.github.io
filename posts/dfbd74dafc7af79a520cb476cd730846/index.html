<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>stm32f407的hal库开发-adc（dma） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="stm32f407的hal库开发-adc（dma）" />
<meta property="og:description" content="#ifndef __ADC_H__ #define __ADC_H__ #include &#34;sys.h&#34; /******************************************************************************/ #define N 100	//每个通道缓存区长度 #define ADC_CHANNELS 8 //8个转换通道 /******************************************************************************/ extern void MY_ADC_Init(void);	//初始化ADC和DMA; extern u16 getADC_CH(uint8 channel);//获取某一通道的采样结果，内部使用冒泡排序法，取中间50个求平均值； #endif /*********** **************************************************************************************** *名称：	adc.c *描述：	adc多通道DMA模式数据采集 *作者：	WYP *接口：	void MY_ADC_Init(void);	初始化ADC和DMA; uint16 getADC_CH(uint8 channel);获取某一通道的采样结果，内部使用冒泡排序法，取中间50个求平均值； ***************************************************************************************************/ #include &#34;adc.h&#34; /* 私有变量 ------------------------------------------------------------------*/ u16 ADC_ConvertedValue[N][ADC_CHANNELS]; ADC_HandleTypeDef ADC1_Handler;//ADC句柄 DMA_HandleTypeDef ADC1_DMA_Handler; //DMA句柄 /*************************************************************************************************** *名称：bubbleSort(u16 a[], u16 n) *描述：排序 *入口参数：排序数组，排序数量 *出口参数：无 ***************************************************************************************************/ void bubbleSort(u16 a[], u16 n){ u16 i,j,tmp; for( i =0 ; i&lt; n-1; &#43;&#43;i) { for( j = 0; j &lt; n-i-1; &#43;&#43;j) { if(a[j] &gt; a[j&#43;1]) { tmp = a[j] ; a[j] = a[j&#43;1] ; a[j&#43;1] = tmp; } } } } /*************************************************************************************************** *名称：	MYDMA_Config() *描述：	DMA配置 *入口参数：	无 *出口参数：	无 ***************************************************************************************************/ void MYDMA_Config(void) { __HAL_RCC_DMA2_CLK_ENABLE();//DMA2时钟使能	//Tx DMA配置 ADC1_DMA_Handler." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dfbd74dafc7af79a520cb476cd730846/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-09T09:33:50+08:00" />
<meta property="article:modified_time" content="2023-09-09T09:33:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">stm32f407的hal库开发-adc（dma）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__ADC_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__ADC_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>

<span class="token comment">/******************************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span> <span class="token expression"><span class="token number">100</span>			</span><span class="token comment">//每个通道缓存区长度</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADC_CHANNELS</span>   	<span class="token expression"><span class="token number">8</span> </span><span class="token comment">//8个转换通道</span></span>
<span class="token comment">/******************************************************************************/</span>

<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">MY_ADC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//初始化ADC和DMA;</span>
<span class="token keyword">extern</span> u16 <span class="token function">getADC_CH</span><span class="token punctuation">(</span>uint8 channel<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取某一通道的采样结果，内部使用冒泡排序法，取中间50个求平均值；</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">/***********

****************************************************************************************
*名称：	adc.c
*描述：	adc多通道DMA模式数据采集
*作者：	WYP
*接口：	void MY_ADC_Init(void);		初始化ADC和DMA;
	  	uint16 getADC_CH(uint8 channel);获取某一通道的采样结果，内部使用冒泡排序法，取中间50个求平均值；
***************************************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>

<span class="token comment">/* 私有变量 ------------------------------------------------------------------*/</span>
u16 ADC_ConvertedValue<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>ADC_CHANNELS<span class="token punctuation">]</span><span class="token punctuation">;</span>

ADC_HandleTypeDef ADC1_Handler<span class="token punctuation">;</span><span class="token comment">//ADC句柄</span>
DMA_HandleTypeDef  ADC1_DMA_Handler<span class="token punctuation">;</span>      <span class="token comment">//DMA句柄</span>

<span class="token comment">/***************************************************************************************************
*名称：bubbleSort(u16 a[], u16 n)
*描述：排序
*入口参数：排序数组，排序数量
*出口参数：无
***************************************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">bubbleSort</span><span class="token punctuation">(</span>u16 a<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u16 n<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
	u16 i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>tmp<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">for</span><span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token operator">-</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
            <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&gt;</span> a<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
            <span class="token punctuation">{<!-- --></span>  
                 tmp <span class="token operator">=</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">;</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>  a<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span> 
<span class="token comment">/***************************************************************************************************
*名称：	MYDMA_Config()
*描述：	DMA配置
*入口参数：	无
*出口参数：	无
***************************************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">MYDMA_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token function">__HAL_RCC_DMA2_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//DMA2时钟使能	</span>
    
    <span class="token comment">//Tx DMA配置</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Instance<span class="token operator">=</span>DMA2_Stream0<span class="token punctuation">;</span>                            <span class="token comment">//数据流选择</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Channel<span class="token operator">=</span>DMA_CHANNEL_0<span class="token punctuation">;</span>                                <span class="token comment">//通道选择</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Direction<span class="token operator">=</span>DMA_PERIPH_TO_MEMORY<span class="token punctuation">;</span>             <span class="token comment">//存储器到外设</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>PeriphInc<span class="token operator">=</span>DMA_PINC_DISABLE<span class="token punctuation">;</span>                 <span class="token comment">//外设增量模式</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>MemInc<span class="token operator">=</span>DMA_MINC_ENABLE<span class="token punctuation">;</span>                     <span class="token comment">//存储器增量模式</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>PeriphDataAlignment<span class="token operator">=</span>DMA_PDATAALIGN_HALFWORD<span class="token punctuation">;</span>    <span class="token comment">//外设数据长度:16位</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>MemDataAlignment<span class="token operator">=</span>DMA_PDATAALIGN_HALFWORD<span class="token punctuation">;</span>       <span class="token comment">//存储器数据长度:16位</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode<span class="token operator">=</span>DMA_CIRCULAR<span class="token punctuation">;</span>                            <span class="token comment">//外设普通模式</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Priority<span class="token operator">=</span>DMA_PRIORITY_MEDIUM<span class="token punctuation">;</span>               <span class="token comment">//中等优先级</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>FIFOMode<span class="token operator">=</span>DMA_FIFOMODE_DISABLE<span class="token punctuation">;</span>              
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>FIFOThreshold<span class="token operator">=</span>DMA_FIFO_THRESHOLD_FULL<span class="token punctuation">;</span>      
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>MemBurst<span class="token operator">=</span>DMA_MBURST_SINGLE<span class="token punctuation">;</span>                 <span class="token comment">//存储器突发单次传输</span>
    ADC1_DMA_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>PeriphBurst<span class="token operator">=</span>DMA_PBURST_SINGLE<span class="token punctuation">;</span>              <span class="token comment">//外设突发单次传输</span>
    
    <span class="token function">__HAL_LINKDMA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span>DMA_Handle<span class="token punctuation">,</span>ADC1_DMA_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//将DMA与ADC1联系起来</span>

	ADC1_DMA_Handler<span class="token punctuation">.</span>Instance<span class="token operator">-&gt;</span>PAR <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token operator">&amp;</span>ADC1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span><span class="token comment">//外设地址</span>
	ADC1_DMA_Handler<span class="token punctuation">.</span>Instance<span class="token operator">-&gt;</span>M0AR <span class="token operator">=</span> <span class="token punctuation">(</span>vu32<span class="token punctuation">)</span>ADC_ConvertedValue<span class="token punctuation">;</span>
	ADC1_DMA_Handler<span class="token punctuation">.</span>Instance<span class="token operator">-&gt;</span>NDTR <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
	
    <span class="token function">HAL_DMA_DeInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_DMA_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token function">HAL_DMA_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_DMA_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">HAL_DMA_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_DMA_Handler<span class="token punctuation">,</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token operator">&amp;</span>ADC1<span class="token operator">-&gt;</span>DR<span class="token punctuation">,</span> <span class="token punctuation">(</span>vu32<span class="token punctuation">)</span>ADC_ConvertedValue<span class="token punctuation">,</span> N<span class="token operator">*</span>ADC_CHANNELS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 


<span class="token comment">/***************************************************************************************************
*名称：	MY_ADC_Init()
*描述：	配置AD转换，使用ADC1，DMA2，转换8个通道
*入口参数：	无
*出口参数：	无
***************************************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">MY_ADC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
	ADC_ChannelConfTypeDef ADC1_ChanConf<span class="token punctuation">;</span>
	
    ADC1_Handler<span class="token punctuation">.</span>Instance<span class="token operator">=</span>ADC1<span class="token punctuation">;</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ClockPrescaler<span class="token operator">=</span>ADC_CLOCK_SYNC_PCLK_DIV4<span class="token punctuation">;</span>   <span class="token comment">//4分频，ADCCLK=PCLK2/4=90/4=22.5MHZ</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Resolution<span class="token operator">=</span>ADC_RESOLUTION_12B<span class="token punctuation">;</span>             <span class="token comment">//12位模式</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>DataAlign<span class="token operator">=</span>ADC_DATAALIGN_RIGHT<span class="token punctuation">;</span>             <span class="token comment">//右对齐</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ScanConvMode<span class="token operator">=</span>ENABLE<span class="token punctuation">;</span>                      <span class="token comment">//扫描模式？</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>EOCSelection<span class="token operator">=</span>DISABLE<span class="token punctuation">;</span>                      <span class="token comment">//关闭EOC中断</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ContinuousConvMode<span class="token operator">=</span>ENABLE<span class="token punctuation">;</span>                <span class="token comment">//开启连续转换</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>NbrOfConversion<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>                         <span class="token comment">//8个转换在规则序列中 也就是只转换规则序列1 </span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>DiscontinuousConvMode<span class="token operator">=</span>DISABLE<span class="token punctuation">;</span>             <span class="token comment">//禁止不连续采样模式</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>NbrOfDiscConversion<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">//不连续采样通道数为0</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ExternalTrigConv<span class="token operator">=</span>ADC_SOFTWARE_START<span class="token punctuation">;</span>       <span class="token comment">//软件触发</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ExternalTrigConvEdge<span class="token operator">=</span>ADC_EXTERNALTRIGCONVEDGE_NONE<span class="token punctuation">;</span><span class="token comment">//使用软件触发</span>
    ADC1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>DMAContinuousRequests<span class="token operator">=</span>ENABLE<span class="token punctuation">;</span>             <span class="token comment">//开启DMA请求</span>
    <span class="token function">HAL_ADC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">//初始化 </span>
	<span class="token comment">//转换序列</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Channel <span class="token operator">=</span> ADC_CHANNEL_8<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Rank <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>										<span class="token comment">//第1个序列，序列1</span>
	ADC1_ChanConf<span class="token punctuation">.</span>SamplingTime <span class="token operator">=</span> ADC_SAMPLETIME_480CYCLES<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_ADC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC1_ChanConf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	ADC1_ChanConf<span class="token punctuation">.</span>Channel <span class="token operator">=</span> ADC_CHANNEL_15<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Rank <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>										<span class="token comment">//第1个序列，序列2</span>
	ADC1_ChanConf<span class="token punctuation">.</span>SamplingTime <span class="token operator">=</span> ADC_SAMPLETIME_480CYCLES<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_ADC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC1_ChanConf<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ADC1_ChanConf<span class="token punctuation">.</span>Channel <span class="token operator">=</span> ADC_CHANNEL_14<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Rank <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>										<span class="token comment">//第1个序列，序列3</span>
	ADC1_ChanConf<span class="token punctuation">.</span>SamplingTime <span class="token operator">=</span> ADC_SAMPLETIME_480CYCLES<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_ADC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC1_ChanConf<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ADC1_ChanConf<span class="token punctuation">.</span>Channel <span class="token operator">=</span> ADC_CHANNEL_7<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Rank <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>										<span class="token comment">//第1个序列，序列4</span>
	ADC1_ChanConf<span class="token punctuation">.</span>SamplingTime <span class="token operator">=</span> ADC_SAMPLETIME_480CYCLES<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_ADC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC1_ChanConf<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ADC1_ChanConf<span class="token punctuation">.</span>Channel <span class="token operator">=</span> ADC_CHANNEL_6<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Rank <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>										<span class="token comment">//第1个序列，序列5</span>
	ADC1_ChanConf<span class="token punctuation">.</span>SamplingTime <span class="token operator">=</span> ADC_SAMPLETIME_480CYCLES<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_ADC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC1_ChanConf<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ADC1_ChanConf<span class="token punctuation">.</span>Channel <span class="token operator">=</span> ADC_CHANNEL_3<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Rank <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>										<span class="token comment">//第1个序列，序列6</span>
	ADC1_ChanConf<span class="token punctuation">.</span>SamplingTime <span class="token operator">=</span> ADC_SAMPLETIME_480CYCLES<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_ADC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC1_ChanConf<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ADC1_ChanConf<span class="token punctuation">.</span>Channel <span class="token operator">=</span> ADC_CHANNEL_9<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Rank <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>										<span class="token comment">//第1个序列，序列6</span>
	ADC1_ChanConf<span class="token punctuation">.</span>SamplingTime <span class="token operator">=</span> ADC_SAMPLETIME_480CYCLES<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_ADC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC1_ChanConf<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ADC1_ChanConf<span class="token punctuation">.</span>Channel <span class="token operator">=</span> ADC_CHANNEL_5<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Rank <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>										<span class="token comment">//第1个序列，序列6</span>
	ADC1_ChanConf<span class="token punctuation">.</span>SamplingTime <span class="token operator">=</span> ADC_SAMPLETIME_480CYCLES<span class="token punctuation">;</span>
	ADC1_ChanConf<span class="token punctuation">.</span>Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_ADC_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC1_ChanConf<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">MYDMA_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化并开启DMA</span>
	<span class="token function">HAL_ADC_Start_DMA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC1_Handler<span class="token punctuation">,</span> <span class="token punctuation">(</span>vu32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ADC_ConvertedValue<span class="token punctuation">,</span> N<span class="token operator">*</span>ADC_CHANNELS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/***************************************************************************************************
*名称：HAL_ADC_MspInit()
*描述：ADC底层驱动，引脚配置，时钟使能，此函数会被HAL_ADC_Init()调用
*入口参数：ADC句柄
*出口参数：无
***************************************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">HAL_ADC_MspInit</span><span class="token punctuation">(</span>ADC_HandleTypeDef<span class="token operator">*</span> hadc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef GPIO_Initure<span class="token punctuation">;</span>
    <span class="token function">__HAL_RCC_ADC1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//使能ADC1时钟</span>
    <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//开启GPIOA时钟</span>
    <span class="token function">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//开启GPIOA时钟</span>
    <span class="token function">__HAL_RCC_GPIOC_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//开启GPIOA时钟</span>
	
    GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_3<span class="token operator">|</span>GPIO_PIN_6<span class="token operator">|</span>GPIO_PIN_7<span class="token operator">|</span>GPIO_PIN_5<span class="token punctuation">;</span>            <span class="token comment">//PA3,6,7,	5用于测试</span>
    GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_ANALOG<span class="token punctuation">;</span>     <span class="token comment">//模拟</span>
    GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_NOPULL<span class="token punctuation">;</span>          <span class="token comment">//不带上下拉</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_0<span class="token operator">|</span>GPIO_PIN_1<span class="token punctuation">;</span>            <span class="token comment">//PB0,1</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_4<span class="token operator">|</span>GPIO_PIN_5<span class="token punctuation">;</span>            <span class="token comment">//PC4,5</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/***************************************************************************************************
*名称：getAdc()
*描述：读取指定通道AD值，先冒泡排序，然后取中间50个求平均值
*入口参数：通道号channel,取值分为0到（ADC_CHANNELS-1）
*出口参数：AD值
***************************************************************************************************/</span>
u16 <span class="token function">getADC_CH</span><span class="token punctuation">(</span>uint8 channel<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	u16 tbuf<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
	u32 tdat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 ti<span class="token punctuation">;</span>
	<span class="token comment">//判断传入参数是否合法</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>channel<span class="token operator">&gt;=</span>ADC_CHANNELS<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>ti<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ti<span class="token operator">&lt;</span>N<span class="token punctuation">;</span>ti<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		tbuf<span class="token punctuation">[</span>ti<span class="token punctuation">]</span><span class="token operator">=</span>ADC_ConvertedValue<span class="token punctuation">[</span>ti<span class="token punctuation">]</span><span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">bubbleSort</span><span class="token punctuation">(</span>tbuf<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>ti<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>ti<span class="token operator">&lt;</span><span class="token punctuation">(</span>N<span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ti<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		tdat<span class="token operator">+=</span>tbuf<span class="token punctuation">[</span>ti<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	tdat<span class="token operator">/=</span><span class="token number">50</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>tdat<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
			tdat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">return</span> tdat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/88d877688f3f487e191ed1b49b7e5365/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">史上最详细的Python安装教程，小白建议收藏！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/109b2401f6aeced52414cbabe798ca5d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">最新快手点号教程：成功率高达80%（仅揭秘-自我保护）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>