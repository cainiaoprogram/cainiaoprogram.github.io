<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Certbot实现 HTTPS 免费证书(Let‘s Encrypt)自动续期 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Certbot实现 HTTPS 免费证书(Let‘s Encrypt)自动续期" />
<meta property="og:description" content="Certbot实现 HTTPS 自动续期 以前阿里云支持申请一年的免费https证书，那每年我们手动更新证书并没什么大问题，但现在阿里云的免费证书仅支持3个月，这意味着每三个月都要要申请一下证书显得非常麻烦。
下面我们使用Certbot实现ssl证书的自动更新，这次我在Centos8的Nginx上进行演示如何配置SSL证书。
Certbot的安装 以下安装在CentOS8实操通过，其他系统可以参考：https://certbot.eff.org/instructions
要使用Certbot，首先需要安装：
yum install epel-release -y yum install certbot -y 如果你安装过程中出现 “Couldn’t open file /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-8” 的错误，是由于缺少 EPEL 存储库的 GPG 密钥导致的。这个密钥用于验证从 EPEL 存储库下载的软件包的完整性和真实性。
需要先导入 EPEL 存储库的 GPG 密钥：
rpm --import https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-8 然后重新安装上述安装命令即可安装成功。
生成 Let’s Encrypt 免费证书的命令参数 Let’s Encrypt 是免费 HTTPS 证书生成工具之一，由 Internet Security Research Group（ISRG）这个非营利组织提供ISRG的使命是使全球范围内的网站能够安全、自动化地使用HTTPS加密，并提供免费的 SSL/TLS 证书。
虽然 Let’s Encrypt 证书的有效期只有90天，但是可以自动续期。
使用 Certbot 工具生成 Let’s Encrypt 证书的手动验证命令：
certbot certonly --email example@qq.com --agree-tos -d ai.xxxxxx.top --manual --preferred-challenges dns 参数说明：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fe9a99276acb456e20ccf5641798c2e6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-13T22:37:55+08:00" />
<meta property="article:modified_time" content="2023-12-13T22:37:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Certbot实现 HTTPS 免费证书(Let‘s Encrypt)自动续期</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Certbot_HTTPS__1"></a>Certbot实现 HTTPS 自动续期</h2> 
<p>以前阿里云支持申请一年的免费https证书，那每年我们手动更新证书并没什么大问题，但现在阿里云的免费证书仅支持3个月，这意味着每三个月都要要申请一下证书显得非常麻烦。</p> 
<p>下面我们使用Certbot实现ssl证书的自动更新，这次我在Centos8的Nginx上进行演示如何配置SSL证书。</p> 
<h3><a id="Certbot_7"></a>Certbot的安装</h3> 
<blockquote> 
 <p>以下安装在CentOS8实操通过，其他系统可以参考：<a href="https://certbot.eff.org/instructions" rel="nofollow">https://certbot.eff.org/instructions</a></p> 
</blockquote> 
<p>要使用Certbot，首先需要安装：</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> epel-release <span class="token parameter variable">-y</span>
yum <span class="token function">install</span> certbot <span class="token parameter variable">-y</span>
</code></pre> 
<p>如果你安装过程中出现 “Couldn’t open file /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-8” 的错误，是由于缺少 EPEL 存储库的 GPG 密钥导致的。这个密钥用于验证从 EPEL 存储库下载的软件包的完整性和真实性。</p> 
<p>需要先导入 EPEL 存储库的 GPG 密钥：</p> 
<pre><code class="prism language-bash"><span class="token function">rpm</span> <span class="token parameter variable">--import</span> https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-8
</code></pre> 
<p>然后重新安装上述安装命令即可安装成功。</p> 
<h3><a id="_Lets_Encrypt__28"></a>生成 Let’s Encrypt 免费证书的命令参数</h3> 
<p>Let’s Encrypt 是免费 HTTPS 证书生成工具之一，由 Internet Security Research Group（ISRG）这个非营利组织提供ISRG的使命是使全球范围内的网站能够安全、自动化地使用HTTPS加密，并提供免费的 SSL/TLS 证书。</p> 
<p>虽然 Let’s Encrypt 证书的有效期只有90天，但是可以自动续期。</p> 
<p>使用 Certbot 工具生成 Let’s Encrypt 证书的手动验证命令：</p> 
<pre><code>certbot certonly --email example@qq.com --agree-tos -d ai.xxxxxx.top --manual --preferred-challenges dns
</code></pre> 
<p>参数说明：</p> 
<ul><li><code>certonly</code>: 用于生成 SSL/TLS 证书的工具插件。</li><li><code>--email example@qq.com</code>: Let’s Encrypt 要求提供有效的电子邮件地址</li><li><code>--agree-tos</code>：同意 Let’s Encrypt 的服务条款。</li><li><code>-d 'test.com'</code>：指定您想要为其生成 SSL 证书的域名。你可以通过添加多个 <code>-d</code> 选项来同时为多个域名生成证书。</li><li><code>--manual</code>：在命令提示符下手动操作来验证您拥有该域名。</li><li><code>--preferred-challenges=dns</code>：使用 DNS 验证方式进行证书颁发，需要将一个特定的 TXT 记录添加到 DNS 进行验证。</li></ul> 
<p>生成 Let’s Encrypt 证书的http验证命令：</p> 
<pre><code>certbot certonly --email example@qq.com --webroot -w /home/letsencrypt --preferred-challenges http-01 -d example.com
</code></pre> 
<p><code>--preferred-challenges http-01</code>：使用HTTP 验证方式生成证书。</p> 
<p><code>--webroot -w /home/letsencrypt</code>：用http做域名验证时，在目录<code>/home/letsencrypt</code>目录下产生对应的验证文件xxxx。</p> 
<p>certbot通过访问<code>http://example.com/.well-known/acme-challenge/xxxx</code>便能完成验证。</p> 
<h3><a id="DNSSSL_63"></a>通过DNS验证生成SSL证书</h3> 
<p>首先执行以下命令：</p> 
<pre><code>certbot certonly --email 604049322@qq.com --agree-tos -d ai.xxx.top --manual --preferred-challenges dns
</code></pre> 
<p>首先会提示：<code>We'd like to send you email about our work encrypting the web, EFF news, campaigns, and ways to support digital freedom.</code></p> 
<p>我先输入Y回车同意(也可以输入N拒绝他们给你发邮件)，然后出现如下提示：</p> 
<p><img src="https://images2.imgbox.com/36/b1/C5MPfo9A_o.png" alt="image-20231212115626549"></p> 
<p>注意提示中的内容，下面我们在阿里云添加对应解析：</p> 
<p><img src="https://images2.imgbox.com/83/1f/voyWt27p_o.png" alt="image-20231212115727526"></p> 
<p>阿里云中配置完成后，回到控制台回车确认，等待十秒钟后，提示<code>Successfully received certificate.</code>表示证书已经生成。</p> 
<p>证书存储信息如下：</p> 
<pre><code>Certificate is saved at: /etc/letsencrypt/live/ai.xxx.top/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/ai.xxx.top/privkey.pem
</code></pre> 
<p>此时修改Nginx的配置给需要使用https的server指定ssl证书：</p> 
<pre><code>ssl_certificate      /etc/letsencrypt/live/ai.xxx.top/fullchain.pem;
ssl_certificate_key  /etc/letsencrypt/live/ai.xxx.top/privkey.pem;
</code></pre> 
<p>重启Nginx：</p> 
<pre><code>service nginx restart
</code></pre> 
<p>可以使用以下网站测试目标网站的ssl：<a href="https://www.ssllabs.com/ssltest/" rel="nofollow">https://www.ssllabs.com/ssltest/</a></p> 
<blockquote> 
 <p>注意：使用DNS验证可以很方便的手动生成SSL证书，但是每次续期的时候要求填写的TXT记录都有可能不同，这意味着基于DNS验证的自动续期必须动态修改DNS的TXT记录。</p> 
 <p>虽然certbot 提供了一个 hook，可以在续期的时候让脚本调用 DNS 服务商的 API 接口动态添加 TXT 记录，但操作毕竟是复杂了很多，所以我们考虑使用j基于HTTP验证来自动续期生成SSL证书。</p> 
</blockquote> 
<h3><a id="httpSSL_114"></a>通过http验证生成SSL证书</h3> 
<p>certbot需要通过访问域名对应的地址完成验证，例如<code>http://www.xxx.cn/.well-known/acme-challenge/abcd</code>，如果访问无法访问，则需要给Nginx配置该路径可以访问，从而完成验证。</p> 
<p>执行以下命令修改配置(根据配置文件实际位置修改)：</p> 
<pre><code>vi /usr/local/nginx/conf/vhost/proj.conf
</code></pre> 
<blockquote> 
 <p>注意：一般yum安装的Nginx执行<code>vi /etc/nginx/conf.d/proj.conf</code></p> 
</blockquote> 
<p>添加如下配置：</p> 
<pre><code class="prism language-nginx">server {
    listen 80;
    server_name www.xxxxxx.cn;
    location / {
        return 301 https://$server_name$request_uri;
    }
    location ^~ /.well-known/ {
        root /data/pro/ydz/web;
    }
}
</code></pre> 
<p>然后使用<code>service nginx reload</code>命令重载配置。</p> 
<p>然后通过http验证生成证书：</p> 
<pre><code class="prism language-bash">certbot certonly <span class="token parameter variable">--email</span> <span class="token number">604049322</span>@qq.com <span class="token parameter variable">--webroot</span> <span class="token parameter variable">-w</span> /data/pro/ydz/web --preferred-challenges http-01 <span class="token parameter variable">-d</span> www.xxx.cn
</code></pre> 
<p>然后可以看到ssl生成成功的提示<code>Successfully received certificate.</code>。</p> 
<p>然后就可以增加ssl配置：</p> 
<pre><code class="prism language-nginx">server {
	listen 443 ssl http2;
	server_name  www.xxxxxx.cn;
	ssl_certificate      /etc/letsencrypt/live/www.xxxxxx.cn/fullchain.pem;
	ssl_certificate_key  /etc/letsencrypt/live/www.xxxxxx.cn/privkey.pem;
	location / {
	    root    /data/pro/ydz/web;
	    index  index.html index.htm;
	    error_page  404	http://www.xxxxxx.cn;
	}
    location ^~  /.well-known/ {
        root  /data/pro/ydz/web;
    }
}
</code></pre> 
<p>再次重载配置<code>nginx -s reload</code>（两种命令都可以）。</p> 
<h3><a id="_172"></a>自动更新证书</h3> 
<p>使用以下命令即可更新证书：</p> 
<pre><code>certbot renew
</code></pre> 
<p>但有效期超过一个月的会自动跳过。</p> 
<p>我们将该命令配置为crontab定时任务即可实现自动续签：</p> 
<p>首先执行<code>crontab -e</code>，然后添加以下配置：</p> 
<pre><code>0 0 * * 1 /usr/bin/certbot renew &gt;&gt; /var/log/certbot-renew.log
</code></pre> 
<p>crontab从左至右分别是：分钟、小时、日期、月份、星期几，以上配置代表每周一执行一次证书更新。</p> 
<h3><a id="openai_194"></a>实例：配置openai反向代理</h3> 
<blockquote> 
 <p>演示的操作系统：CentOS 7.6</p> 
</blockquote> 
<p>由于这次我使用7.6版本的CentOS 进行演示，Python默认版本为2.7.5，运行会出现很多问题，所以我需要先调整Python环境：</p> 
<pre><code>pip uninstall urllib3 -y
pip uninstall requests -y
pip uninstall chardet -y
yum remove python-requests -y
yum remove python-urllib3 -y
pip install --upgrade --force-reinstall 'requests==2.6.0' urllib3
pip install chardet -U
</code></pre> 
<p>然后安装certbot：</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> certbot <span class="token parameter variable">-y</span>
</code></pre> 
<p>使用openai会自动将http请求重定向到https上，如果我们的Nginx服务器不支持https就无法正常访问，所以必须配置使用https。</p> 
<p>假设我们的域名为ai.haobanok.com。一开始没有SSL证书，首先进行基本配置便于http验证：</p> 
<pre><code class="prism language-bash"><span class="token function">vi</span> /etc/nginx/conf.d/gpt.conf
</code></pre> 
<p>配置一下基本配置：</p> 
<pre><code class="prism language-nginx">server {
    listen 80;
    server_name ai.haobanok.com;
    location ^~  /.well-known/ {
        root /var/www;
    }
}
</code></pre> 
<blockquote> 
 <p>注意：root指定的目录必须是nginx用户有权限访问的目录（否则对应请求都会返回403），上面的目录可以通过如下命令创建：</p> 
 <pre><code>mkdir /var/www
chown -R nginx:nginx /var/www/
</code></pre> 
</blockquote> 
<p>执行<code>nginx -s reload</code>重载配置。</p> 
<blockquote> 
 <p>可以尝试访问一下<code>http://ai.haobanok.com/.well-known/acme-challenge/xxx</code>，如果返回404说明正常，返回403大概率是Nginx所使用的用户，没有操作指定目录的权限，需要根据实际情况调整。</p> 
</blockquote> 
<p>接下来我们使用certbot生成证书，直接使用http验证可能会缺少接入点。可以先使用dns验证生成接入点，dns验证命令：</p> 
<pre><code class="prism language-bash">certbot certonly <span class="token parameter variable">--email</span> example@qq.com --agree-tos <span class="token parameter variable">-d</span> ai.haobanok.com <span class="token parameter variable">--manual</span> --preferred-challenges dns
</code></pre> 
<p>输入N拒绝后，直接Ctrl+C结束进程，接入点便注册完毕。</p> 
<p>然后就可以通过http验证生成证书：</p> 
<pre><code>certbot certonly --email 604049322@qq.com --webroot -w /var/www --preferred-challenges http-01 -d ai.haobanok.com
</code></pre> 
<p>稍等几秒钟后，证书生成完毕。由于certbot版本差异，提示信息与前面有所差异，这次生成完成的提示信息为：</p> 
<pre><code>-  Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/ai.haobanok.com/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/ai.haobanok.com/privkey.pem
</code></pre> 
<p>证书生成完成，我们就可以配置openai反代了：</p> 
<pre><code class="prism language-nginx">server {
	allow 183.12.0.0/16;
	allow 117.136.0.0/16;
	allow 27.38.6.0/24;
	allow 113.91.0.0/16;
	deny all;
	listen 80;
	listen 443 ssl http2;
	server_name ai.haobanok.com;
	ssl_certificate      /etc/letsencrypt/live/ai.haobanok.com/fullchain.pem;
	ssl_certificate_key  /etc/letsencrypt/live/ai.haobanok.com/privkey.pem;
	location / {
		proxy_pass  https://api.openai.com/;
		proxy_ssl_server_name on;
		proxy_set_header Host api.openai.com;
		proxy_set_header Connection '';
		proxy_http_version 1.1;
		chunked_transfer_encoding off;
		proxy_buffering off;
		proxy_cache off;
	}
	location ^~  /.well-known/ {
		allow all;
		root  /var/www;
	}
}
</code></pre> 
<p>执行<code>nginx -s reload</code>重载配置。</p> 
<blockquote> 
 <p>保留<code>/.well-known/</code>前缀匹配保证未来更新证书的时候可以进行验证。</p> 
</blockquote> 
<p>执行<code>crontab -e</code>添加每周自动检查更新：</p> 
<pre><code>0 0 * * 1 /usr/bin/certbot renew &gt;&gt; /var/log/certbot-renew.log
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/43a3bc15ddbde6e34d328e92fedf2890/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Faster RCNN训练自己的数据集【傻瓜式教程】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d18cb9e5a2493e744fca2cb56ad2398d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Java】Java8 将List转换为用逗号隔开的字符串的几种方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>