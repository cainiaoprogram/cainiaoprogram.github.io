<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>kafka：java集成 kafka(springboot集成、客户端集成) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="kafka：java集成 kafka(springboot集成、客户端集成)" />
<meta property="og:description" content="摘要
对于java的kafka集成，一般选用springboot集成kafka，但可能由于对接方kafka老旧、kafka不安全等问题导致kafak版本与spring版本不兼容，这个时候就得自己根据kafka客户端api集成了。
一、springboot集成kafka
具体官方文档地址：https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/
1、加入依赖，spring-boot-starter-web和spring-kafka 的版本号可以看它们依赖的spring版本是否一致，这里pom依赖如下：
&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;version&gt;2.7.9&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt; &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt; &lt;version&gt;2.9.6&lt;/version&gt; &lt;/dependency&gt; 2、添加application.yml配置,具体如下：
server: port: 8087 spring: mvc: pathmatch: matching-strategy: ant_path_matcher kafka: bootstrap-servers: 192.168.189.128:9092,92.168.189.128:9093,192.168.189.128:9094 consumer: properties: group: id: boot-kafka 3、发送消息，由于KafkaTemplate是自动装配的，所以只要在spring的bean里注入KafkaTemplate发送消息即可，具体如下：
package com.longqi.bootkafka.controller; import com.longqi.bootkafka.entity.MessageParam; import com.longqi.bootkafka.entity.Wrapper; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import io.swagger.annotations.ApiParam; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.kafka.core.KafkaTemplate; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RequestBody; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import javax.validation.Valid; /** * &lt;p&gt; * 测试 前端控制器 * &lt;/p&gt; * @author LongQi * @since 2021-06-23 */ @Slf4j @RestController @RequestMapping(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c04653ec927ae839f973a8231c157f9f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-15T09:00:48+08:00" />
<meta property="article:modified_time" content="2023-03-15T09:00:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">kafka：java集成 kafka(springboot集成、客户端集成)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="kdocs-document"> 
 <p style=""><span class="kdocs-fontSize" style="font-size:16pt;"><span class="kdocs-bold" style="font-weight:bold;">摘要</span></span></p> 
 <p style="text-indent:1.4em;">对于java的kafka集成，一般选用springboot集成kafka，但可能由于对接方kafka老旧、kafka不安全等问题导致kafak版本与spring版本不兼容，这个时候就得自己根据kafka客户端api集成了。</p> 
 <p style=""></p> 
 <p style=""><span class="kdocs-fontSize" style="font-size:16pt;"><span class="kdocs-bold" style="font-weight:bold;">一、springboot集成kafka</span></span></p> 
 <p style="text-indent:1.4em;">具体官方文档地址：<a class="kdocs-link" style="color:#0A6CFF;" href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/" rel="nofollow noopener noreferrer" target="_blank">https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/</a></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1376px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:65.0436%;height:0;"> 
    <img src="https://images2.imgbox.com/05/2e/hJdJxsof_o.png" style="margin-left:;display:block;width:1376px;margin-top:-65.0436%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">1、<span class="kdocs-bold" style="font-weight:bold;">加入依赖</span>，spring-boot-starter-web和spring-kafka 的版本号可以看它们依赖的spring版本是否一致，这里pom依赖如下：</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
            &lt;version&gt;2.7.9&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;
            &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;
            &lt;version&gt;2.9.6&lt;/version&gt;
        &lt;/dependency&gt;</code></pre> 
 <p style="">2、<span class="kdocs-bold" style="font-weight:bold;">添加application.yml配</span>置,具体如下：</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">server:
  port: 8087
spring:
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher
  kafka:
    bootstrap-servers: 192.168.189.128:9092,92.168.189.128:9093,192.168.189.128:9094
    consumer:
      properties:
        group:
          id: boot-kafka
</code></pre> 
 <p style="">3、<span class="kdocs-bold" style="font-weight:bold;">发送消息</span>，由于KafkaTemplate是自动装配的，所以只要在spring的bean里注入KafkaTemplate发送消息即可，具体如下：</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">package com.longqi.bootkafka.controller;

import com.longqi.bootkafka.entity.MessageParam;
import com.longqi.bootkafka.entity.Wrapper;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.kafka.core.KafkaTemplate;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.validation.Valid;

/**
 * &lt;p&gt;
 * 测试 前端控制器
 * &lt;/p&gt;
 * @author LongQi
 * @since 2021-06-23
 */

@Slf4j
@RestController
@RequestMapping("/test")
@Api(value = "TestController", tags = {"测试 API"})
public class TestController {

    @Autowired
    private KafkaTemplate&lt;String, String&gt; kafkaTemplate;

    private Boolean isSend = true;

    @PostMapping("/kafka/sendMessage")
    @ApiOperation(httpMethod = "POST", value = "发送kafka告警消息", response = Wrapper.class)
    public Wrapper sendKafkaMessage(@Valid @ApiParam("参数") @RequestBody MessageParam param) {
        kafkaTemplate.send(param.getTopic(), param.getMessage());
        return Wrapper.ok(true);
    }

}</code></pre> 
 <p style="text-indent:1.4em;">这里用参数{"message": "asd54a6d46a4ds","topic": "device-alarm-test"}进行测试，会报如下日志：</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1770px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:29.096045%;height:0;"> 
    <img src="https://images2.imgbox.com/bb/ac/69vvg5pW_o.png" style="margin-left:;display:block;width:1770px;margin-top:-29.096045%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="text-indent:1.4em;">发现会报警告：[Producer clientId=producer-1] Error while fetching metadata with correlation id 34 : {device-alarm-test=LEADER_NOT_AVAILABLE}，获取主题元数据错误，这个可以忽略，查找元数据失败，kafka默认会自动创建主题的，后续再次发送消息，是不会报这个错误的。</p> 
 <p style="text-indent:1.4em;">查看可视化工具EFAK，发现主题device-alarm-test是自动创建成功，分区数是kafka的集群配置service.properties里配置的分区9，具体如下：</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1456px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:34.615387%;height:0;"> 
    <img src="https://images2.imgbox.com/63/4f/trdAWcmp_o.png" style="margin-left:;display:block;width:1456px;margin-top:-34.615387%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1458px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:44.170097%;height:0;"> 
    <img src="https://images2.imgbox.com/2c/c1/KaLv8S8w_o.png" style="margin-left:;display:block;width:1458px;margin-top:-44.170097%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="text-indent:1.4em;">可以看到，其中一个分区保存了这个消息，logsize变成了1，说明这个消息是发送成功的。另外也可以看到主题的各分区主备消息所在的节点是不一样的。</p> 
 <p style="">4、<span class="kdocs-bold" style="font-weight:bold;">接收消息</span>，接收消息也很简单，只要在spring的bean里使用KafkaListener注解即可，具体如下：</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:722px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:59.833797%;height:0;"> 
    <img src="https://images2.imgbox.com/e3/36/DRu6EXbg_o.png" style="margin-left:;display:block;width:722px;margin-top:-59.833797%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="text-indent:1.4em;">可视化工具也能看到该主题该消费者9个分区的消费情况，具体如下：</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1861px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:48.41483%;height:0;"> 
    <img src="https://images2.imgbox.com/c7/8e/1RdBrQzB_o.png" style="margin-left:;display:block;width:1861px;margin-top:-48.41483%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="text-indent:1.4em;">logSize为存入分区parttion消息数量，Offset为消费的偏移量(已消费的数量)，Lag为未消费的数量(积压的数量)，Owner为消费者，目前可以看到消费者为同一个，即只有1个线程在消费这9个分区的消息。</p> 
 <p style=""></p> 
 <p style="text-align:left;"><span class="kdocs-fontSize" style="font-size:16pt;"><span class="kdocs-bold" style="font-weight:bold;">二、客户端集成kafka</span></span></p> 
 <p style="text-indent:1.4em;">直接使用kafka客户端，建议使用最新版的客户端，毕竟没有其他框架版本限制，能用最新的就用最新的，毕竟新的一般性能强也修复了bug。好比23年2月份出现的kafka安全漏洞：远程代码执行漏洞CVE-2023-25194，对现在最新版3.4.0无效，对以前大部分版本就有效。</p> 
 <p style="text-indent:1.4em;">1、<span class="kdocs-bold" style="font-weight:bold;">添加依赖</span>，具体如下：</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;
            &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;
            &lt;version&gt;3.4.0&lt;/version&gt;
        &lt;/dependency&gt;</code></pre> 
 <p style="text-indent:1.4em;">2、<span class="kdocs-bold" style="font-weight:bold;">发送和消费消息</span>，具体代码如下：</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">package com.longqi.bootkafka.config;

import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.clients.producer.ProducerRecord;

import java.time.Duration;
import java.util.Arrays;
import java.util.Properties;

/**
 * @author LongQi
 * @projectName boot-integration
 * @description: kafka配置
 * @date 2023/3/13 14:42
 */

public class KafkaConfig {

    public static void main(String[] args) {
        // 声明主题
        String topic = "device-alarm-test";
        // 创建消费者
        Properties consumerConfig = new Properties();
        consumerConfig.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "192.168.189.128:9092,92.168.189.128:9093,192.168.189.128:9094");
        consumerConfig.put(ConsumerConfig.GROUP_ID_CONFIG,"boot-kafka");
        consumerConfig.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG,"org.apache.kafka.common.serialization.StringDeserializer");
        consumerConfig.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG,"org.apache.kafka.common.serialization.StringDeserializer");
        KafkaConsumer kafkaConsumer = new KafkaConsumer(consumerConfig);
        // 订阅主题并循环拉取消息
        kafkaConsumer.subscribe(Arrays.asList(topic));
        new Thread(new Runnable() {
            @Override
            public void run() {
                while (true){
                    ConsumerRecords&lt;String, String&gt; records = kafkaConsumer.poll(Duration.ofMillis(10000));
                    for(ConsumerRecord&lt;String, String&gt; record:records){
                        System.out.println(record.value());
                    }
                }
            }
        }).start();
        // 创建生产者
        Properties producerConfig = new Properties();
        producerConfig.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "192.168.189.128:9092,92.168.189.128:9093,192.168.189.128:9094");
        producerConfig.put(ProducerConfig.CLIENT_ID_CONFIG,"boot-kafka-client");
        producerConfig.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, "org.apache.kafka.common.serialization.StringSerializer");
        producerConfig.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, "org.apache.kafka.common.serialization.StringSerializer");
        KafkaProducer producer = new KafkaProducer&lt;&gt;(producerConfig);
        // 给主题发送消息
        producer.send(new ProducerRecord&lt;&gt;(topic, "hello，"+System.currentTimeMillis()));
    }
}
</code></pre> 
 <p style="">最后可以看到打印消息如下：</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1844px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:19.631237%;height:0;"> 
    <img src="https://images2.imgbox.com/2d/1c/dgAxqOoM_o.png" style="margin-left:;display:block;width:1844px;margin-top:-19.631237%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">成功接收到消息并打印</p> 
 <p style=""></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3b6310f5a120c9c148abea7e48f060e3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">操作系统(未完)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e013e4171f108359e5dd3ced476f5ae1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java启动jar包引入外部配置文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>