<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android Viewè½¬æ¢ä¸ºBitmapï¼Œå®ç°æˆªå±æ•ˆæœ - èœé¸Ÿç¨‹åºå‘˜åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android Viewè½¬æ¢ä¸ºBitmapï¼Œå®ç°æˆªå±æ•ˆæœ" />
<meta property="og:description" content="å‰è¨€ å®‰å“è®¾å¤‡ä¸€èˆ¬éƒ½è‡ªå¸¦æˆªå›¾åŠŸèƒ½ï¼Œä½†æ˜¯ç”¨æˆ·ä½“éªŒæœ‰ä¸å¥½ä¹‹å¤„ã€‚å°±æ˜¯ä¼šè¿å¸¦ç€çŠ¶æ€æ ğŸ“¶ã€ğŸ”‹ã€æ—¶é—´æ—¥æœŸã€å…¶ä»–ä¸å¿…è¦é¡µé¢ä¸­ä¿¡æ¯ï¼Œç­‰ç­‰ä¸ç”¨æˆ·æƒ³æˆªå±çš„å†…å®¹ä¸ç¬¦çš„ä¿¡æ¯ä¹Ÿä¼šè¢«ä¿å­˜ä¸‹æ¥ã€‚é€šå¸¸ï¼Œæˆªå›¾åç”¨æˆ·ä¼šå†æ¬¡è£å‰ªä¸€æ¬¡æ‰èƒ½æƒ³æŠŠçœŸæ­£éœ€æ±‚åˆ†äº«å‡ºå»ã€‚
å› æ­¤ï¼Œå’±ä»¬æŠ€æœ¯ç ”å‘ä¼šé‡åˆ°é’ˆå¯¹æ€§çš„ä¼šåšä¸€äº›åº”ç”¨å†…çš„æˆªå±åŠŸèƒ½ã€‚
ä¸€ã€getDrawingCache getDrawingCache()æ˜¯å…¶ä¸­ä¸€ç§æˆªå›¾æ‰‹æ®µï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œä¸»è¦é’ˆå¯¹åº”ç”¨å†…æˆªå›¾ã€‚
1ã€åˆ›å»ºView
fun getShareView() : View { val shareView: View = LayoutInflater.from(context).inflate(R.layout.share_layout, null) //å†…å®¹... return shareView } æ³¨æ„ï¼šä¸€èˆ¬å¤§å®¶å®ç°æ€è·¯éƒ½æ˜¯ç‚¹å‡»äº‹ä»¶é‡Œè¿›è¡Œåˆ›å»ºViewç»˜åˆ¶ï¼Œå¾ˆå¯èƒ½ä¼šé‡åˆ°ç½‘ç»œå›¾ç‰‡è¿˜æœªåŠ è½½å®Œçš„æƒ…å†µã€‚å› æ­¤ï¼Œå»ºè®®åšå»¶è¿Ÿå¤„ç†ï¼Œæˆ–åœ¨ç‚¹å‡»å‰å‰ç½®åˆ›å»ºå¥½ã€‚
2ã€æµ‹è¯•å’Œç»˜åˆ¶
public static void layoutView(View v, int width, int height) { v.layout(0, 0, width, height); int measuredWidth = View.MeasureSpec.makeMeasureSpec(width, View.MeasureSpec.EXACTLY); int measuredHeight = View.MeasureSpec.makeMeasureSpec(height, View.MeasureSpec.EXACTLY); v.measure(measuredWidth, measuredHeight); v.layout(0, 0, v.getMeasuredWidth(), v.getMeasuredHeight()); } å¦‚æœä¸èµ°è¿™ä¸ªæ–¹æ³•ï¼Œbitmapè½¬æ¢æ—¶ä¼šæ²¡æœ‰è§†å›¾(é»‘å±æƒ…å†µ)ã€‚Â è°ƒç”¨æ–¹æ³•ï¼š
// è®¾ç½®è§†å›¾çš„dpå®½é«˜ layoutView(share_view, dp2px(210), dp2px(180)); public static int dp2px(float dp) { float scale = Resources." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/566ef4d11939969e2455c4084dd2610d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-08T16:44:30+08:00" />
<meta property="article:modified_time" content="2022-09-08T16:44:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="èœé¸Ÿç¨‹åºå‘˜åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">èœé¸Ÿç¨‹åºå‘˜åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android Viewè½¬æ¢ä¸ºBitmapï¼Œå®ç°æˆªå±æ•ˆæœ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>å‰è¨€</h3> 
<p>Â  Â  Â  Â  å®‰å“è®¾å¤‡ä¸€èˆ¬éƒ½è‡ªå¸¦æˆªå›¾åŠŸèƒ½ï¼Œä½†æ˜¯ç”¨æˆ·ä½“éªŒæœ‰ä¸å¥½ä¹‹å¤„ã€‚å°±æ˜¯ä¼šè¿å¸¦ç€çŠ¶æ€æ ğŸ“¶ã€ğŸ”‹ã€æ—¶é—´æ—¥æœŸã€å…¶ä»–ä¸å¿…è¦é¡µé¢ä¸­ä¿¡æ¯ï¼Œç­‰ç­‰ä¸ç”¨æˆ·æƒ³æˆªå±çš„å†…å®¹ä¸ç¬¦çš„ä¿¡æ¯ä¹Ÿä¼šè¢«ä¿å­˜ä¸‹æ¥ã€‚é€šå¸¸ï¼Œæˆªå›¾åç”¨æˆ·ä¼šå†æ¬¡è£å‰ªä¸€æ¬¡æ‰èƒ½æƒ³æŠŠçœŸæ­£éœ€æ±‚åˆ†äº«å‡ºå»ã€‚</p> 
<p>Â  Â  Â  Â  å› æ­¤ï¼Œå’±ä»¬æŠ€æœ¯ç ”å‘ä¼šé‡åˆ°é’ˆå¯¹æ€§çš„ä¼šåšä¸€äº›åº”ç”¨å†…çš„æˆªå±åŠŸèƒ½ã€‚</p> 
<hr> 
<h3>ä¸€ã€getDrawingCache</h3> 
<p>Â  Â getDrawingCache()æ˜¯å…¶ä¸­ä¸€ç§æˆªå›¾æ‰‹æ®µï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œä¸»è¦é’ˆå¯¹åº”ç”¨å†…æˆªå›¾ã€‚</p> 
<p>1ã€åˆ›å»ºView</p> 
<pre><code class="language-Kotlin">fun getShareView() : View {
     val shareView: View =
            LayoutInflater.from(context).inflate(R.layout.share_layout, null)
     //å†…å®¹...
     return  shareView
}</code></pre> 
<p>æ³¨æ„ï¼šä¸€èˆ¬å¤§å®¶å®ç°æ€è·¯éƒ½æ˜¯ç‚¹å‡»äº‹ä»¶é‡Œè¿›è¡Œåˆ›å»ºViewç»˜åˆ¶ï¼Œå¾ˆå¯èƒ½ä¼šé‡åˆ°ç½‘ç»œå›¾ç‰‡è¿˜æœªåŠ è½½å®Œçš„æƒ…å†µã€‚å› æ­¤ï¼Œå»ºè®®åšå»¶è¿Ÿå¤„ç†ï¼Œæˆ–åœ¨ç‚¹å‡»å‰å‰ç½®åˆ›å»ºå¥½ã€‚</p> 
<p></p> 
<p>2ã€æµ‹è¯•å’Œç»˜åˆ¶</p> 
<pre><code class="language-java"> public static void layoutView(View v, int width, int height) {
        v.layout(0, 0, width, height);
        int measuredWidth = View.MeasureSpec.makeMeasureSpec(width, View.MeasureSpec.EXACTLY);
        int measuredHeight = View.MeasureSpec.makeMeasureSpec(height, View.MeasureSpec.EXACTLY);
        v.measure(measuredWidth, measuredHeight);
        v.layout(0, 0, v.getMeasuredWidth(), v.getMeasuredHeight());
    }</code></pre> 
<p>å¦‚æœä¸èµ°è¿™ä¸ªæ–¹æ³•ï¼Œbitmapè½¬æ¢æ—¶ä¼šæ²¡æœ‰è§†å›¾(é»‘å±æƒ…å†µ)ã€‚Â </p> 
<p>è°ƒç”¨æ–¹æ³•ï¼š</p> 
<pre><code class="language-java">// è®¾ç½®è§†å›¾çš„dpå®½é«˜
layoutView(share_view, dp2px(210), dp2px(180));</code></pre> 
<pre><code class="language-java">  public static int dp2px(float dp) {
        float scale = Resources.getSystem().getDisplayMetrics().density;
        return (int) (dp * scale + 0.5f);
    }</code></pre> 
<p>3ã€è½¬æ¢Bitmap</p> 
<pre><code class="language-java"> public static Bitmap getCacheBitmapFromView(View view) {
        final boolean drawingCacheEnabled = true;
        view.setDrawingCacheEnabled(drawingCacheEnabled);
      //è®¾ç½®èƒŒæ™¯è‰²  //view.setBackgroundColor(CommonUtils.getContext().getResources().getColor(R.color.half_white));
        view.buildDrawingCache(drawingCacheEnabled);
        final Bitmap drawingCache = view.getDrawingCache();
        Bitmap bitmap;
        if (drawingCache != null) {
            bitmap = Bitmap.createBitmap(drawingCache);
            view.setDrawingCacheEnabled(false);
        } else {
            bitmap = null;
        }
        return bitmap;
    }</code></pre> 
<p></p> 
<h3>äºŒã€é»‘å±é—®é¢˜</h3> 
<p>Â Â Â Â Â Â Â Â ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„ä»£ç èƒ½å¤Ÿæ­£å¸¸å®ç°æ•ˆæœã€‚ä½†æœ‰æ—¶å€™ï¼Œç”ŸæˆBitmapä¼šå‡ºç°é—®é¢˜(Bitmapå…¨é»‘è‰²)ã€‚ä¸»è¦åŸå› æ˜¯drawingCacheçš„å€¼å¤§äºç³»ç»Ÿç»™å®šçš„å€¼ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹buildDrawingCache()æ–¹æ³•ä¸­çš„ä¸€æ®µä»£ç ï¼š</p> 
<pre><code class="language-java">    //æ‰€è¦cacheçš„viewç»˜åˆ¶çš„å®½åº¦å’Œé«˜åº¦
if (width &lt;= 0 || height &lt;= 0 ||
    //è®¡ç®—çš„æ˜¯å½“å‰æ‰€éœ€è¦çš„drawingCache å¤§å°
    (width * height * (opaque &amp;&amp; !translucentWindow ? 2 : 4) &gt; 
    //å¾—åˆ°çš„æ˜¯ç³»ç»Ÿæ‰€æä¾›çš„æœ€å¤§çš„DrawingCacheçš„å€¼
   ViewConfiguration.get(mContext).getScaledMaximumDrawingCacheSize())) {

    destroyDrawingCache();

    return;
}</code></pre> 
<p>å½“æ‰€éœ€è¦çš„<span style="color:#fe2c24;"><strong>drawingCache Â &gt; ç³»ç»Ÿæ‰€æä¾›çš„æœ€å¤§DrawingCache</strong></span>å€¼æ—¶ï¼Œç”ŸæˆBitmapå°±ä¼šå‡ºç°é—®é¢˜ï¼Œæ­¤æ—¶è·å–çš„Bitmapå°±ä¸ºnullã€‚</p> 
<p>æ‰€ä»¥åœ¨åªéœ€è¦ä¿®æ”¹æ‰€éœ€çš„cacheå€¼å°±å¯ä»¥è§£å†³é—®é¢˜äº†ã€‚äºæ˜¯æˆ‘ä»¬å¼•å…¥ç¬¬äºŒç§æ–¹æ³•ï¼š</p> 
<p>è§£å†³æ–¹æ¡ˆ:</p> 
<pre><code class="language-java">public static Bitmap convertViewToBitmap(View view){

    view.measure(MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED),
MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED));

    view.layout(0, 0, view.getMeasuredWidth(), view.getMeasuredHeight());

    view.buildDrawingCache();

    Bitmap bitmap = view.getDrawingCache();

    return bitmap;

}</code></pre> 
<p>view ä½¿ç”¨ "getMeasuredWidth()"ã€ "getMeasuredHeight()"æ–¹æ³•è®¡ç®—é•¿å®½ã€‚æ­¤æ—¶ï¼ŒBitmapå°±èƒ½æ­£ç¡®è·å–äº†ã€‚</p> 
<p></p> 
<h3>ä¸‰ã€æºç åˆ†æ</h3> 
<pre><code class="language-java">    public void buildDrawingCache() {
        buildDrawingCache(false);
    }
	
    public Bitmap getDrawingCache() {
        return getDrawingCache(false);
    }
	
    public Bitmap getDrawingCache(boolean autoScale) {
        if ((mViewFlags &amp; WILL_NOT_CACHE_DRAWING) == WILL_NOT_CACHE_DRAWING) {
            return null;
        }
        if ((mViewFlags &amp; DRAWING_CACHE_ENABLED) == DRAWING_CACHE_ENABLED) {
            buildDrawingCache(autoScale);
        }
        return autoScale ? mDrawingCache : mUnscaledDrawingCache;
    }   

    public void buildDrawingCache(boolean autoScale) {
        if ((mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == 0 || (autoScale ?
                mDrawingCache == null : mUnscaledDrawingCache == null)) {
            if (Trace.isTagEnabled(Trace.TRACE_TAG_VIEW)) {
                Trace.traceBegin(Trace.TRACE_TAG_VIEW,
                        "buildDrawingCache/SW Layer for " + getClass().getSimpleName());
            }
            try {
                buildDrawingCacheImpl(autoScale);
            } finally {
                Trace.traceEnd(Trace.TRACE_TAG_VIEW);
            }
        }
    }
	
    private void buildDrawingCacheImpl(boolean autoScale) {
        mCachingFailed = false;
 
        int width = mRight - mLeft;
        int height = mBottom - mTop;
 
        final AttachInfo attachInfo = mAttachInfo;
        final boolean scalingRequired = attachInfo != null &amp;&amp; attachInfo.mScalingRequired;
 
        if (autoScale &amp;&amp; scalingRequired) {
            width = (int) ((width * attachInfo.mApplicationScale) + 0.5f);
            height = (int) ((height * attachInfo.mApplicationScale) + 0.5f);
        }
 
        final int drawingCacheBackgroundColor = mDrawingCacheBackgroundColor;
        final boolean opaque = drawingCacheBackgroundColor != 0 || isOpaque();
        final boolean use32BitCache = attachInfo != null &amp;&amp; attachInfo.mUse32BitDrawingCache;
 
        final long projectedBitmapSize = width * height * (opaque &amp;&amp; !use32BitCache ? 2 : 4);
        final long drawingCacheSize =
                ViewConfiguration.get(mContext).getScaledMaximumDrawingCacheSize();
        if (width &lt;= 0 || height &lt;= 0 || projectedBitmapSize &gt; drawingCacheSize) {
            if (width &gt; 0 &amp;&amp; height &gt; 0) {
                Log.w(VIEW_LOG_TAG, getClass().getSimpleName() + " not displayed because it is"
                        + " too large to fit into a software layer (or drawing cache), needs "
                        + projectedBitmapSize + " bytes, only "
                        + drawingCacheSize + " available");
            }
            destroyDrawingCache();
            mCachingFailed = true;
            return;
        }
     ..æ£€æµ‹drawingCacheåŸæœ‰æ•°æ®æ“ä½œ..
	    try {
                bitmap = Bitmap.createBitmap(mResources.getDisplayMetrics(),
                        width, height, quality);
                bitmap.setDensity(getResources().getDisplayMetrics().densityDpi);
                if (autoScale) {
                    mDrawingCache = bitmap;
                } else {
                    mUnscaledDrawingCache = bitmap;
                }
                if (opaque &amp;&amp; use32BitCache) bitmap.setHasAlpha(false);
            } catch (OutOfMemoryError e) {
                // If there is not enough memory to create the bitmap cache, just
                // ignore the issue as bitmap caches are not required to draw the
                // view hierarchy
                if (autoScale) {
                    mDrawingCache = null;
                } else {
                    mUnscaledDrawingCache = null;
                }
                mCachingFailed = true;
                return;
            }
	..æ‰§è¡ŒBitmapå†™å…¥autoScale ? mDrawingCache : mUnscaledDrawingCacheæ“ä½œ..
    }
</code></pre> 
<p>Â  Â ä»ä»¥ä¸Šæºç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°getDrawingcache = nullÂ çš„æ¡ä»¶å…±æœ‰å››ä¸ªï¼šÂ <br> Â  Â  Â  1ã€(mViewFlags &amp; WILL_NOT_CACHE_DRAWING) == WILL_NOT_CACHE_DRAWINGä¸ºtrueÂ <br> Â  Â  Â  2ã€æ²¡æœ‰è®¾ç½®setDrawingCacheEnabled(true)Â <br> Â  Â  Â  3ã€width &lt;= 0 || height &lt;= 0 || projectedBitmapSize &gt; drawingCacheSizeä¸ºtrueÂ <br> Â  Â  Â  4ã€OutOfMemoryÂ <br> Â </p> 
<p>Â Â Â Â Â Â Â Â é™¤äº†ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œå…¶ä»–çš„éƒ½æ˜¯buildDrawingCacheæ‰§è¡Œæ—¶æ‰ä¼šè§¦å‘ã€‚ä¸‹é¢æ¥åˆ†æä¸‹æ¡ä»¶ä¸‰ã€‚æ—¢ç„¶å­å¸ƒå±€å¯ä»¥æ­£å¸¸æ˜¾ç¤ºï¼Œé‚£ä¹ˆä¸€å®šæ˜¯æ»¡è¶³width&gt;0å’Œheight&gt;0çš„ï¼Œ drawingCacheSizeè‚¯å®šæ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œå°±æ˜¯å½“å‰è®¾å¤‡ç³»ç»Ÿæ‰€å…è®¸çš„æœ€å¤§ç»˜åˆ¶ç¼“å­˜å€¼ã€‚projectedBitmapSizeçš„è®¡ç®—æ–¹å¼ä¸ºwidth * height * (opaque &amp;&amp; !use32BitCache ? 2 : 4)ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å½“å‰è®¡åˆ’ç¼“å­˜çš„å›¾ç‰‡å¤§å°ï¼Œ(opaque &amp;&amp; !use32BitCache ? 2 : 4)ä¸å¯èƒ½ä¸º0ï¼Œä¹Ÿä¸å¯èƒ½æ˜¯å¯¼è‡´è®¡åˆ’ç¼“å­˜å€¼å˜å¤§çš„ä¸»å› ï¼Œwidthå°±æ˜¯å±å¹•çš„å®½ï¼Œè¿™ä¸ªæ²¡æœ‰å˜åŠ¨çš„æ¡ä»¶ï¼Œé‚£ä¹ˆå¯ä»¥è‚¯å®šå°±æ˜¯heightå‡ºç°äº†å¼‚å¸¸ï¼Œå¯¹äºè§†å›¾é«˜åº¦çš„è®¡ç®—ï¼Œandroidæºç è¡¨ç¤ºå¦‚ä¸‹ï¼š</p> 
<pre><code class="language-java">@ViewDebug.ExportedProperty(category = "layout")
public final int getHeight() {
  return mBottom - mTop;
}

</code></pre> 
<p>ä¸€ä¸ªViewçš„é«˜åº¦getHeight()å°±æ˜¯åº•-é«˜ï¼Œå…¶ä¸­mBottomæŒ‡çš„æ˜¯è§†å›¾è‡ªèº«çš„åº•è¾¹åˆ°çˆ¶è§†å›¾é¡¶è¾¹çš„è·ç¦»ï¼ŒmTopæŒ‡çš„æ˜¯è§†å›¾è‡ªèº«çš„é¡¶è¾¹åˆ°çˆ¶è§†å›¾é¡¶è¾¹çš„è·ç¦»ã€‚</p> 
<p></p> 
<h3>å››ã€Viewè½¬Canvasè½¬Bitmap</h3> 
<pre><code class="language-java">Â  Â  Bitmap bitmap = Bitmap.createBitmap(view.getWidth(), view.getHeight(), Bitmap.Config.ARGB_8888);
Â  Â  Canvas canvas = new Canvas(bitmap);
Â  Â  view.measure(View.MeasureSpec.makeMeasureSpec(view.getWidth(), View.MeasureSpec.EXACTLY), View.MeasureSpec.makeMeasureSpec(view.getHeight(), View.MeasureSpec.EXACTLY));
Â  Â  view.layout((int) view.getX(), (int) view.getY(), (int) view.getX() + view.getMeasuredWidth(), (int) view.getY() + view.getMeasuredHeight());
Â  Â  view.draw(canvas);
Â  Â  return bitmap;</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2205d8183b3167dadfdd9265759bf59f/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Token_JWT</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/153867c7abac45db4e01c2de58283d25/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">å¦‚ä½•å¤åˆ¶å¦ä¸€ä¸ªPCBåˆ°å½“å‰çš„PCBä¸­</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 èœé¸Ÿç¨‹åºå‘˜åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>