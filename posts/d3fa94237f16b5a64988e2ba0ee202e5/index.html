<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL · 物理备份 · Percona XtraBackup 备份原理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL · 物理备份 · Percona XtraBackup 备份原理" />
<meta property="og:description" content="前言 Percona XtraBackup（简称PXB）是 Percona 公司开发的一个用于 MySQL 数据库物理热备的备份工具，支持 MySQl（Oracle）、Percona Server 和 MariaDB，并且全部开源，真可谓是业界良心。我们 RDS MySQL 的物理备份就是基于这个工具做的。
项目的 blueprint 和 bug 讨论放在 Launchpad，代码之前也放在 Launchpad，现在已经迁移到 Github 啦，项目更新发布非常快，感兴趣的可以关注 :-)
本文会介绍下备份工具的工作原理，希望对大家有所帮助。
工具集 软件包安装完后一共有4个可执行文件，如下：
usr ├── bin │ ├── innobackupex │ ├── xbcrypt │ ├── xbstream │ └── xtrabackup 其中最主要的是 innobackupex 和 xtrabackup，前者是一个 perl 脚本，后者是 C/C&#43;&#43; 编译的二进制。
xtrabackup 是用来备份 InnoDB 表的，不能备份非 InnoDB 表，和 mysqld server 没有交互；innobackupex 脚本用来备份非 InnoDB 表，同时会调用 xtrabackup 命令来备份 InnoDB 表，还会和 mysqld server 发送命令进行交互，如加读锁（FTWRL）、获取位点（SHOW SLAVE STATUS）等。简单来说，innobackupex 在 xtrabackup 之上做了一层封装。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d3fa94237f16b5a64988e2ba0ee202e5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-03-27T12:15:51+08:00" />
<meta property="article:modified_time" content="2016-03-27T12:15:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL · 物理备份 · Percona XtraBackup 备份原理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="content-detail markdown-body"> 
 <h3 style="font-family:'Helvetica Neue', 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;font-size:1.8em;">前言</h3> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;"><a href="https://www.percona.com/software/mysql-database/percona-xtrabackup" rel="nofollow" title="Percona XtraBackup 官网" style="color:rgb(34,102,153);text-decoration:none;vertical-align:baseline;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(26,188,156);">Percona XtraBackup</a>（简称PXB）是 Percona 公司开发的一个用于 MySQL 数据库<span style="font-weight:600;color:rgb(0,0,0);">物理热备</span>的备份工具，支持 MySQl（Oracle）、Percona Server 和 MariaDB，并且全部开源，真可谓是业界良心。我们 RDS MySQL 的物理备份就是基于这个工具做的。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">项目的 blueprint 和 bug 讨论放在 <a href="https://launchpad.net/percona-xtrabackup" rel="nofollow" title="Launchpad 地址" style="color:rgb(34,102,153);text-decoration:none;vertical-align:baseline;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(26,188,156);">Launchpad</a>，代码之前也放在 Launchpad，现在已经迁移到 <a href="https://github.com/percona/percona-xtrabackup" title="Github 地址" style="color:rgb(34,102,153);text-decoration:none;vertical-align:baseline;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(26,188,156);">Github</a> 啦，项目更新发布非常快，感兴趣的可以关注 :-)</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">本文会介绍下备份工具的工作原理，希望对大家有所帮助。</p> 
 <h3 style="font-family:'Helvetica Neue', 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;font-size:1.8em;">工具集</h3> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">软件包安装完后一共有4个可执行文件，如下：</p> 
 <pre><code class="hljs nginx" style="font-family:Courier, 'Courier New', monospace;color:rgb(77,77,76);vertical-align:baseline;border:1px solid rgb(221,221,221);"><span class="hljs-title" style="color:rgb(142,144,140);">usr</span>
├── bin
│   ├── innobackupex
│   ├── xbcrypt
│   ├── xbstream
│   └── xtrabackup
</code></pre> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">其中最主要的是 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 和 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code>，前者是一个 perl 脚本，后者是 C/C++ 编译的二进制。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;"><code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 是用来备份 InnoDB 表的，不能备份非 InnoDB 表，和 mysqld server 没有交互；<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 脚本用来备份非 InnoDB 表，同时会调用 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 命令来备份 InnoDB 表，还会和 mysqld server 发送命令进行交互，如加读锁（FTWRL）、获取位点（SHOW SLAVE STATUS）等。简单来说，<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 在 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 之上做了一层封装。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">一般情况下，我们是希望能备份 MyISAM 表的，虽然我们可能自己不用 MyISAM 表，但是 mysql 库下的系统表是 MyISAM 的，因此备份基本都通过 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 命令进行；另外一个原因是我们可能需要保存位点信息。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">另外2个工具相对小众些，<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xbcrypt</code> 是加解密用的；<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xbstream</code> 类似于tar，是 Percona 自己实现的一种支持并发写的流文件格式。两都在备份和解压时都会用到（如果备份用了加密和并发）。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">本文的介绍的主角是 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 和 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code>。</p> 
 <h3 style="font-family:'Helvetica Neue', 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;font-size:1.8em;">原理</h3> 
 <h4 style="font-family:'Helvetica Neue', 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;font-size:1.6em;">通信方式</h4> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">2个工具之间的交互和协调是通过控制文件的创建和删除来实现的，主要文件有：</p> 
 <ul style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;"><li>xtrabackup_suspended_1</li><li>xtrabackup_suspended_2</li><li>xtrabackup_log_copied</li></ul> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">举个栗子，我们来看备份时 xtrabackup_suspended_2 是怎么来协调2个工具进程的</p> 
 <ol style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;"><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 在启动 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 进程后，会一直等 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 备份完 InnoDB 文件，方式就是等待 xtrabackup_suspended_2 这个文件被创建出来；</li><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 在备完 InnoDB 数据后，就在指定目录下创建出这个文件，然后等这个文件被 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 删除；</li><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 检测到文件 xtrabackup_suspended_2 被创建出来后，就继续往下走；</li><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 在备份完非 InnoDB 表后，删除 xtrabackup_suspended_2 这个文件，这样就通知 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 可以继续了，然后等 xtrabackup_log_copied 被创建；</li><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 检测到 xtrabackup_suspended_2 文件删除后，就可以继续往下了。</li></ol> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">是不是感觉有点不可思议，通过文件是否存在来控制进程，这种方式非常的不靠谱，因为非常容易被外部干扰，比如文件被别人误删掉，或者2个正在跑的备份控制文件误放在同一个目录下，就等着备份乱掉吧，但是 Percona 就是这么干的。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">之所以这么搞，估计主要是因为 perl 和 C 二进制2个进程，没有既好用又方便的通信方式，搞个协议啥的太麻烦了。但是官方也觉得这种方式不靠谱，11年就搞了个 <a href="https://blueprints.launchpad.net/percona-xtrabackup/+spec/rewrite-innobackupex-in-c" rel="nofollow" title="Rewrite innobackupex in C" style="color:rgb(34,102,153);text-decoration:none;vertical-align:baseline;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(26,188,156);">blueprint</a> 要用C重写 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code>，终于在<a href="https://www.percona.com/blog/2015/05/20/percona-xtrabackup-2-3-1-beta1-is-now-available/" rel="nofollow" title="Percona XtraBackup 2.3.1-beta1 is now available" style="color:rgb(34,102,153);text-decoration:none;vertical-align:baseline;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(26,188,156);">2.3 版本</a>实现了，<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 功能全部集成到 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 里面，只有一个 binary，另外为了使用上的兼容考虑，<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code>作为 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 的一个软链。对于二次开发来说，2.3 摆脱了之前2个进程协作的负担，架构上明显要好于之前版本。考虑到 perl + C 这种架构的长期存在，大多数读者朋友也基本用的2.3之前版本，本文的介绍也是基于老的架构（2.2版本），但是原理和2.3是一样的，只是实现上的差别。</p> 
 <h4 style="font-family:'Helvetica Neue', 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;font-size:1.6em;">备份过程</h4> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">整个备份过程如下图：</p> 
 <div class="image-wrapper" style="text-align:center;color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;"> 
  <img src="https://images2.imgbox.com/cb/dc/ejdLvwFG_o.png" alt="PXB备份过程" style="border:none;"> 
  <p style="color:rgb(64,64,64);">PXB 备份过程</p> 
 </div> 
 <ol style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;"><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 在启动后，会先 fork 一个进程，启动 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code>进程，然后就等待 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 备份完 ibd 数据文件；</li><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 在备份 InnoDB 相关数据时，是有2种线程的，1种是 redo 拷贝线程，负责拷贝 redo 文件，1种是 ibd 拷贝线程，负责拷贝 ibd 文件；redo 拷贝线程只有一个，在 ibd 拷贝线程之前启动，在 ibd 线程结束后结束。<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 进程开始执行后，先启动 redo 拷贝线程，从最新的 checkpoint 点开始顺序拷贝 redo 日志；然后再启动 ibd 数据拷贝线程，在 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 拷贝 ibd 过程中，<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 进程一直处于等待状态（等待文件被创建）。</li><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 拷贝完成idb后，通知 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code>（通过创建文件），同时自己进入等待（redo 线程仍然继续拷贝）;</li><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 收到 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 通知后，执行<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">FLUSH TABLES WITH READ LOCK</code> (FTWRL)，取得一致性位点，然后开始备份非 InnoDB 文件（包括 frm、MYD、MYI、CSV、opt、par等）。拷贝非 InnoDB 文件过程中，因为数据库处于全局只读状态，如果在业务的主库备份的话，要特别小心，非 InnoDB 表（主要是MyISAM）比较多的话整库只读时间就会比较长，这个影响一定要评估到。</li><li>当 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 拷贝完所有非 InnoDB 表文件后，通知 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code>（通过删文件） ，同时自己进入等待（等待另一个文件被创建）；</li><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 收到 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 备份完非 InnoDB 通知后，就停止 redo 拷贝线程，然后通知 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code>redo log 拷贝完成（通过创建文件）；</li><li> <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 收到 redo 备份完成通知后，就开始解锁，执行 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">UNLOCK TABLES</code>；</li><li>最后 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 和 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 进程各自完成收尾工作，如资源的释放、写备份元数据信息等，<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 等待 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 子进程结束后退出。</li></ol> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">在上面描述的文件拷贝，都是备份进程直接通过操作系统读取数据文件的，只在执行 SQL 命令时和数据库有交互，基本不影响数据库的运行，在备份非 InnoDB 时会有一段时间只读（如果没有MyISAM表的话，只读时间在几秒左右），在备份 InnoDB 数据文件时，对数据库完全没有影响，是真正的热备。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">InnoDB 和非 InnoDB 文件的备份都是通过拷贝文件来做的，但是实现的方式不同，前者是以page为粒度做的(<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code>)，后者是 cp 或者 tar 命令(<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code>)，<code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">xtrabackup</code> 在读取每个page时会校验 checksum 值，保证数据块是一致的，而 <code style="font-family:Courier, 'Courier New', monospace;color:rgb(51,51,51);vertical-align:baseline;background:rgb(247,247,247);">innobackupex</code> 在 cp MyISAM 文件时已经做了flush（FTWRL），磁盘上的文件也是完整的，所以最终备份集里的数据文件都是写入完整的。</p> 
 <h5 style="font-family:'Helvetica Neue', 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;font-size:1.4em;">增量备份</h5> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">PXB 是支持增量备份的，但是只能对 InnoDB 做增量，InnoDB 每个 page 有个 LSN 号，LSN 是全局递增的，page 被更改时会记录当前的 LSN 号，page中的 LSN 越大，说明当前page越新（最近被更新）。每次备份会记录当前备份到的LSN（xtrabackup_checkpoints 文件中），增量备份就是只拷贝LSN大于上次备份的page，比上次备份小的跳过，每个 ibd 文件最终备份出来的是增量 delta 文件。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">MyISAM 是没有增量的机制的，每次增量备份都是全部拷贝的。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">增量备份过程和全量备份一样，只是在 ibd 文件拷贝上有不同。</p> 
 <h4 style="font-family:'Helvetica Neue', 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;font-size:1.6em;">恢复过程</h4> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">如果看恢复备份集的日志，会发现和 mysqld 启动时非常相似，其实备份集的恢复就是类似 mysqld crash后，做一次 crash recover。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">恢复的目的是把备份集中的数据恢复到一个一致性位点，所谓一致就是指原数据库某一时间点各引擎数据的状态，比如 MyISAM 中的数据对应的是 15:00 时间点的，InnoDB 中的数据对应的是 15:20 的，这种状态的数据就是不一致的。PXB 备份集对应的一致点，就是备份时FTWRL的时间点，恢复出来的数据，就对应原数据库FTWRL时的状态。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">因为备份时 FTWRL 后，数据库是处于只读的，非 InnoDB 数据是在持有全局读锁情况下拷贝的，所以非 InnoDB 数据本身就对应 FTWRL 时间点；InnoDB 的 ibd 文件拷贝是在 FTWRL 前做的，拷贝出来的不同 ibd 文件最后更新时间点是不一样的，这种状态的 ibd 文件是不能直接用的，但是 redo log 是从备份开始一直持续拷贝的，最后的 redo 日志点是在持有 FTWRL 后取得的，所以最终通过 redo 应用后的 ibd 数据时间点也是和 FTWRL 一致的。</p> 
 <p style="color:rgb(48,48,48);font-family:Avenir, 'Microsoft Yahei', 'Hiragino Sans GB', 'Microsoft Sans Serif', 'WenQuanYi Micro Hei', sans-serif;font-size:15px;line-height:30px;">所以恢复过程只涉及 InnoDB 文件的恢复，非 InnoDB 数据是不动的。备份恢复完成后，就可以把数据文件拷贝到对应的目录，然后通过mysqld来启动了。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/90a7d3aa3f2cd9edaba11915fcdd489f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android基础之首页广告轮播效果</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/36c36effbb8902ef605b23f1e34537e0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">PS制作gif文件，可用作微信表情</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>