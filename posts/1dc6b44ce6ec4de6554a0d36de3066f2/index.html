<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>NMS与Soft NMS算法解析以及numpy实现 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="NMS与Soft NMS算法解析以及numpy实现" />
<meta property="og:description" content="1. NMS算法 1.1 什么是NMS算法 NMS全称为Non Maximum Suppression，中文意思是非极大值抑制，字面意思就是不是极大值的元素被抑制掉，其实就是筛选出局部最大值得到最优解。NMS算法被广泛运用于目标检测算法处理网络输出的边界框。
1.2 为什么在目标检测中要使用NMS算法 在目标检测中如果不是用NMS算法，则网络的输出结果就会向如下图所示，许多预测框都框住了目标，但是这些框并不是我们都想要的，我们想要的是其中框出来最好的那一个预测框。此时，我们就需要利用NMS算法去筛选出最适合的预测框。
1.3 在目标检测中怎么样使用NMS算法 我们以检测人脸为例，在目标检测中使用NMS算法的流程：
首先，需要通过置信度阈值消除小于阈值的预测框，比如阈值为0.5，如图下图所示，得到过滤后的预测框。 将所有的预测框的置信度降序排列，得到置信度最大的预测框，如下图红色框： 再设置一个IOU阈值，所谓IOU就是两个框面积的交并比，遍历其余的框，如果和当前最高分框的IOU大于一定阈值，我们就将框删除，如下图所示。 再重复1、2、3步骤，得到最终的结果。 Python代码如下：
代码来自：https://github.com/rbgirshick/fast-rcnn/blob/master/lib/utils/nms.py
import numpy as np def nms(dets, thresh): # ------------------------------------ # # 获取所有预测框的左上角x1, y1、右上角x2, y2以及置信度scores # ------------------------------------ # x1 = dets[:, 0] y1 = dets[:, 1] x2 = dets[:, 2] y2 = dets[:, 3] scores = dets[:, 4] # ------------------------------------ # # 获取所有预测框的面积 # ------------------------------------ # areas = (x2 - x1 &#43; 1) * (y2 - y1 &#43; 1) # ------------------------------------ # # 所有预测框降序排列（保存的是下标） # ------------------------------------ # order = scores." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1dc6b44ce6ec4de6554a0d36de3066f2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-17T17:59:49+08:00" />
<meta property="article:modified_time" content="2022-12-17T17:59:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">NMS与Soft NMS算法解析以及numpy实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_NMS_0"></a>1. NMS算法</h3> 
<h4><a id="11_NMS_2"></a>1.1 什么是NMS算法</h4> 
<p>NMS全称为Non Maximum Suppression，中文意思是非极大值抑制，字面意思就是不是极大值的元素被抑制掉，其实就是筛选出局部最大值得到最优解。NMS算法被广泛运用于目标检测算法处理网络输出的边界框。</p> 
<h4><a id="12_NMS_6"></a>1.2 为什么在目标检测中要使用NMS算法</h4> 
<p>在目标检测中如果不是用NMS算法，则网络的输出结果就会向如下图所示，许多预测框都框住了目标，但是这些框并不是我们都想要的，我们想要的是其中框出来最好的那一个预测框。此时，我们就需要利用NMS算法去筛选出最适合的预测框。</p> 
<p><img src="https://images2.imgbox.com/72/b9/KiR1bfUr_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="13_NMS_13"></a>1.3 在目标检测中怎么样使用NMS算法</h4> 
<p>我们以检测人脸为例，在目标检测中使用NMS算法的流程：</p> 
<ol><li>首先，需要通过置信度阈值消除小于阈值的预测框，比如阈值为0.5，如图下图所示，得到过滤后的预测框。</li></ol> 
<p><img src="https://images2.imgbox.com/b7/eb/dsw3P093_o.png" alt="在这里插入图片描述"></p> 
<ol start="2"><li>将所有的预测框的置信度降序排列，得到置信度最大的预测框，如下图红色框：</li></ol> 
<p><img src="https://images2.imgbox.com/e8/d2/1Ybzkhe9_o.png" alt="在这里插入图片描述"></p> 
<ol start="3"><li>再设置一个IOU阈值，所谓IOU就是两个框面积的交并比，遍历其余的框，如果和当前最高分框的IOU大于一定阈值，我们就将框删除，如下图所示。</li></ol> 
<p><img src="https://images2.imgbox.com/10/83/3eUn7GLJ_o.png" alt="在这里插入图片描述"></p> 
<ol start="4"><li>再重复1、2、3步骤，得到最终的结果。</li></ol> 
<p><img src="https://images2.imgbox.com/f3/2f/dOG5SCTf_o.png" alt="在这里插入图片描述"></p> 
<p>Python代码如下：<br> 代码来自：https://github.com/rbgirshick/fast-rcnn/blob/master/lib/utils/nms.py</p> 
<pre><code class="prism language-python">
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">nms</span><span class="token punctuation">(</span>dets<span class="token punctuation">,</span> thresh<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># ------------------------------------ #</span>
	<span class="token comment"># 获取所有预测框的左上角x1, y1、右上角x2, y2以及置信度scores</span>
	<span class="token comment"># ------------------------------------ #</span>
    x1 <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    y1 <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    x2 <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    y2 <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
    scores <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
	<span class="token comment"># ------------------------------------ #</span>
	<span class="token comment"># 获取所有预测框的面积</span>
	<span class="token comment"># ------------------------------------ #</span>
    areas <span class="token operator">=</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># ------------------------------------ #</span>
	<span class="token comment"># 所有预测框降序排列（保存的是下标）</span>
	<span class="token comment"># ------------------------------------ #</span>
    order <span class="token operator">=</span> scores<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    
	<span class="token comment"># ------------------------------------ #</span>
	<span class="token comment"># keep为最后计算保留下来预测框的下标</span>
	<span class="token comment"># ------------------------------------ #</span>
    keep <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> order<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
    	<span class="token comment"># ------------------------------------ #</span>
    	<span class="token comment"># 取出置信度值最大的下标</span>
    	<span class="token comment"># ------------------------------------ #</span>
        i <span class="token operator">=</span> order<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        keep<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        
        <span class="token comment"># ------------------------------------ #</span>
    	<span class="token comment"># 计算IOU</span>
    	<span class="token comment"># ------------------------------------ #</span>
        xx1 <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>x1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> x1<span class="token punctuation">[</span>order<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        yy1 <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>y1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> y1<span class="token punctuation">[</span>order<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        xx2 <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>x2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> x2<span class="token punctuation">[</span>order<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        yy2 <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>y2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> y2<span class="token punctuation">[</span>order<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        w <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> xx2 <span class="token operator">-</span> xx1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        h <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> yy2 <span class="token operator">-</span> yy1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        inter <span class="token operator">=</span> w <span class="token operator">*</span> h
        ovr <span class="token operator">=</span> inter <span class="token operator">/</span> <span class="token punctuation">(</span>areas<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> areas<span class="token punctuation">[</span>order<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">-</span> inter<span class="token punctuation">)</span>
		<span class="token comment"># ------------------------------------ #</span>
    	<span class="token comment"># 过滤小于IOU阈值的边界框</span>
    	<span class="token comment"># ------------------------------------ #</span>
        inds <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>ovr <span class="token operator">&lt;=</span> thresh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># ------------------------------------ #</span>
        <span class="token comment"># ovr 数组的长度比 order 数组少一个，这里将所有下标后移一位</span>
        <span class="token comment"># ------------------------------------ #</span>
        order <span class="token operator">=</span> order<span class="token punctuation">[</span>inds <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> keep
</code></pre> 
<h3><a id="2_Soft_NMS_96"></a>2. Soft NMS算法</h3> 
<h4><a id="21_Soft_NMS_98"></a>2.1 什么是Soft NMS算法</h4> 
<p>Soft NMS是对NMS的优化算法，它在不增加额外参数的情况下且只需要对NMS算法进行简单的改动就能提高AP。该Soft-NMS算法在标准数据集PASCAL VOC2007（较R-FCN和Faster-RCNN提升1.7%）和MS-COCO（较R-FCN提升1.3%，较Faster-RCNN提升1.1%）上均有提升。</p> 
<p><strong>Soft NMS的主要思想</strong></p> 
<p>如下图所示，假设重叠的阈值为 0.5，图 中当黑框与红框比较时，两者之间的IoU为0.51，则红框将被删除，即使置信度高于许多其他 IoU 较小的框。因此，如果有两个并排的对象，则其中一个将被消除，这会降低模型的精度。</p> 
<p>NMS与Soft NMS都有一个共同点，都是从置信度最大的框开始逐渐迭代的。</p> 
<p><img src="https://images2.imgbox.com/81/ef/EwHTkI7b_o.png" alt="在这里插入图片描述"></p> 
<p>因此，Soft NMS则不再是直接将大于重叠的阈值的框删除，而是根据重叠程度衰减框的置信度得分，再根据设定的置信度阈值，去除小于置信度阈值的框。</p> 
<p>改变置信度的方法有两种：</p> 
<ol><li>线性法</li></ol> 
<p>如下公式：<br> 其中，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
         o 
        
       
         u 
        
       
         ( 
        
       
         M 
        
       
         , 
        
        
        
          b 
         
        
          i 
         
        
       
         ) 
        
       
      
        iou(M, b_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>代表最大置信度得分的框<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         M 
        
       
      
        M 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span></span></span></span></span>与第<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
      
        i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>个框<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          b 
         
        
          i 
         
        
       
      
        b_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>的IOU，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          N 
         
        
          t 
         
        
       
      
        N_t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.109em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.109em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>代表重叠的阈值，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          s 
         
        
          i 
         
        
       
      
        s_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>代表第<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
      
        i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>个框的置信度得分<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          s 
         
        
          i 
         
        
       
      
        s_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p><img src="https://images2.imgbox.com/12/bb/5a3cZ6fn_o.png" alt="在这里插入图片描述"></p> 
<p>通过分析可以得出，当重叠的IOU增大时，置信度得分确实得到线性的下降。</p> 
<ol start="2"><li>高斯法</li></ol> 
<p>如下公式：<br> 其中：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
         o 
        
       
         u 
        
       
         ( 
        
       
         M 
        
       
         , 
        
        
        
          b 
         
        
          i 
         
        
       
         ) 
        
       
      
        iou(M, b_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>代表最大置信度得分的框<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         M 
        
       
      
        M 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span></span></span></span></span>与第<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
      
        i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>个框<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          b 
         
        
          i 
         
        
       
      
        b_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>的IOU，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         σ 
        
       
      
        \sigma 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">σ</span></span></span></span></span>为一个可设定的常数，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          s 
         
        
          i 
         
        
       
      
        s_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>代表第<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
      
        i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>个框的置信度得分<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          s 
         
        
          i 
         
        
       
      
        s_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>。</p> 
<p><img src="https://images2.imgbox.com/8e/85/IiwYUqcu_o.png" alt="在这里插入图片描述"></p> 
<p>通过分析可以得出，当重叠的IOU增大时，置信度得分确实下降了。</p> 
<p>如下图是原论文中Soft NMS在R-FCN中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          N 
         
        
          t 
         
        
       
      
        N_t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.109em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.109em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>与<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         σ 
        
       
      
        \sigma 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">σ</span></span></span></span></span>的变化对AP的影响。</p> 
<p><img src="https://images2.imgbox.com/2e/35/EFRMHbvR_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="22__140"></a>2.2 代码实现：</h4> 
<p>参考代码：https://github.com/DocF/Soft-NMS/blob/master/soft_nms.py</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np



<span class="token keyword">def</span> <span class="token function">py_cpu_softnms</span><span class="token punctuation">(</span>dets<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> Nt<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> sigma<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> thresh<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    py_cpu_softnms
    :param dets:   boexs 坐标矩阵 format [y1, x1, y2, x2]
    :param sc:     每个 boxes 对应的分数
    :param Nt:     iou 交叠门限
    :param sigma:  使用 gaussian 函数的方差，根据需要设置
    :param thresh: 最后的分数门限
    :param method: 使用的方法
    :return:       留下的 boxes 的 index
    """</span>

    <span class="token comment"># indexes concatenate boxes with the last column</span>
    N <span class="token operator">=</span> dets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    indexes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    dets <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>dets<span class="token punctuation">,</span> indexes<span class="token punctuation">.</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># the order of boxes coordinate is [y1,x1,y2,x2]</span>
    y1 <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    x1 <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    y2 <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    x2 <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
    scores <span class="token operator">=</span> sc
    areas <span class="token operator">=</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># intermediate parameters for later parameters exchange</span>
        tBD <span class="token operator">=</span> dets<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        tscore <span class="token operator">=</span> scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        tarea <span class="token operator">=</span> areas<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pos <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>

        <span class="token comment">#</span>
        <span class="token keyword">if</span> i <span class="token operator">!=</span> N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            maxscore <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>scores<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            maxpos <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>scores<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            maxscore <span class="token operator">=</span> scores<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            maxpos <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> tscore <span class="token operator">&lt;</span> maxscore<span class="token punctuation">:</span>
            dets<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> dets<span class="token punctuation">[</span>maxpos <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            dets<span class="token punctuation">[</span>maxpos <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> tBD
            tBD <span class="token operator">=</span> dets<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

            scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> scores<span class="token punctuation">[</span>maxpos <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
            scores<span class="token punctuation">[</span>maxpos <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> tscore
            tscore <span class="token operator">=</span> scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

            areas<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> areas<span class="token punctuation">[</span>maxpos <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
            areas<span class="token punctuation">[</span>maxpos <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> tarea
            tarea <span class="token operator">=</span> areas<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

        <span class="token comment"># IoU calculate</span>
        xx1 <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>dets<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dets<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        yy1 <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>dets<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dets<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        xx2 <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>dets<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dets<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        yy2 <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>dets<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dets<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        w <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> xx2 <span class="token operator">-</span> xx1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        h <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> yy2 <span class="token operator">-</span> yy1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        inter <span class="token operator">=</span> w <span class="token operator">*</span> h
        ovr <span class="token operator">=</span> inter <span class="token operator">/</span> <span class="token punctuation">(</span>areas<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> areas<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> inter<span class="token punctuation">)</span>

        <span class="token comment"># Three methods: 1.linear 2.gaussian 3.original NMS</span>
        <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># linear</span>
            weight <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>ovr<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
            weight<span class="token punctuation">[</span>ovr <span class="token operator">&gt;</span> Nt<span class="token punctuation">]</span> <span class="token operator">=</span> weight<span class="token punctuation">[</span>ovr <span class="token operator">&gt;</span> Nt<span class="token punctuation">]</span> <span class="token operator">-</span> ovr<span class="token punctuation">[</span>ovr <span class="token operator">&gt;</span> Nt<span class="token punctuation">]</span>
        <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>  <span class="token comment"># gaussian</span>
            weight <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>ovr <span class="token operator">*</span> ovr<span class="token punctuation">)</span> <span class="token operator">/</span> sigma<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># original NMS</span>
            weight <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>ovr<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
            weight<span class="token punctuation">[</span>ovr <span class="token operator">&gt;</span> Nt<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

        scores<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> weight <span class="token operator">*</span> scores<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token comment"># select the boxes and keep the corresponding indexes</span>
    inds <span class="token operator">=</span> dets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>scores <span class="token operator">&gt;</span> thresh<span class="token punctuation">]</span>
    keep <span class="token operator">=</span> inds<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> keep
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c32c1a9b009fbda6abf910bf40a69ce5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C&#43;&#43;】C&#43;&#43;引用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d9570f003379ada9780f9a6619cc8313/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">redis底层数据结构之压缩列表(ziplist)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>