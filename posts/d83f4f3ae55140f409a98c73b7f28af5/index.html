<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于树莓派的流星雨监测系统（RMS）的进一步改造(2) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于树莓派的流星雨监测系统（RMS）的进一步改造(2)" />
<meta property="og:description" content="如何搭建流星雨监测系统，传送门：https://blog.csdn.net/delacroix_xu/article/details/119813807
此篇文章是系列第二篇，第一篇传送门：基于树莓派的流星雨监测系统（RMS）的进一步改造(1)_delacroix_xu的专栏-CSDN博客
背景 近期开始使用一个开源项目，在树莓派4B上玩耍。监测流星雨并存储下来。
https://github.com/CroatianMeteorNetwork/RMS
但该项目有个令人不爽的地方，存储下来的是.bin文件，一种自研的格式，我希望能输出gif或者mp4，方便分享到社交媒体上。
本篇新增功能 输出mp4后，增加钉钉机器人通知，后期再增加上传服务器功能
编写脚本，每日上午8:00运行，找到昨日的目录 ~/RMS_data/CapturedFiles/YESTERDAY_DIR ，执行 python -m Utils.FRbinViewer $dir -e -f mp4 --hide 尝试转换流星监测结果到 mp4视频
然后如果发现了mp4文件，则发出钉钉通知
#!/bin/sh set -ex xxdays=$1 DATE=`date -d &#34;$xxdays days ago&#34; &#43;%Y%m%d` DIRS=`ls ~/RMS_data/CapturedFiles/ | grep ${DATE}` . /home/pi/py37env/bin/activate pwd function sendMsg () { curl -sL &#39;https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxx&#39; \ -H &#39;Content-Type: application/json&#39; \ -d &#39;{&#34;msgtype&#34;: &#34;text&#34;,&#34;text&#34;: {&#34;content&#34;:&#34;&#39;&#34;$1&#34;&#39;&#34;}}&#39; } for DIR in $DIRS; do python -m Utils.FRbinViewer ~/RMS_data/CapturedFiles/${DIR} -e -f mp4 --hide NORMAL=~/RMS_data/CapturedFiles/${DIR}/output-normal." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d83f4f3ae55140f409a98c73b7f28af5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-08T19:41:02+08:00" />
<meta property="article:modified_time" content="2022-02-08T19:41:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于树莓派的流星雨监测系统（RMS）的进一步改造(2)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>如何搭建流星雨监测系统，传送门：<a href="https://blog.csdn.net/delacroix_xu/article/details/119813807" title="https://blog.csdn.net/delacroix_xu/article/details/119813807">https://blog.csdn.net/delacroix_xu/article/details/119813807</a></p> 
<p>此篇文章是系列第二篇，第一篇传送门：<a href="https://blog.csdn.net/delacroix_xu/article/details/119090220" title="基于树莓派的流星雨监测系统（RMS）的进一步改造(1)_delacroix_xu的专栏-CSDN博客">基于树莓派的流星雨监测系统（RMS）的进一步改造(1)_delacroix_xu的专栏-CSDN博客</a></p> 
<p></p> 
<p></p> 
<h3>背景</h3> 
<p>近期开始使用一个开源项目，在树莓派4B上玩耍。监测流星雨并存储下来。</p> 
<p>https://github.com/CroatianMeteorNetwork/RMS</p> 
<p>但该项目有个令人不爽的地方，存储下来的是.bin文件，一种自研的格式，我希望能输出gif或者mp4，方便分享到社交媒体上。</p> 
<p></p> 
<h3>本篇新增功能</h3> 
<p>输出mp4后，增加钉钉机器人通知，后期再增加上传服务器功能</p> 
<p></p> 
<p>编写脚本，每日上午8:00运行，找到昨日的目录 ~/RMS_data/CapturedFiles/YESTERDAY_DIR ，执行 python -m Utils.FRbinViewer  $dir  -e -f mp4 --hide 尝试转换流星监测结果到 mp4视频</p> 
<p>然后如果发现了mp4文件，则发出钉钉通知</p> 
<p></p> 
<pre><code class="language-bash">#!/bin/sh

set -ex

xxdays=$1

DATE=`date -d "$xxdays days ago" +%Y%m%d`
DIRS=`ls ~/RMS_data/CapturedFiles/ | grep ${DATE}`

. /home/pi/py37env/bin/activate

pwd

function sendMsg () 
{

  curl -sL 'https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxx' \
   -H 'Content-Type: application/json' \
   -d '{"msgtype": "text","text": {"content":"'"$1"'"}}'

}


for DIR in $DIRS;
do 
  python -m  Utils.FRbinViewer ~/RMS_data/CapturedFiles/${DIR}  -e -f mp4 --hide


  NORMAL=~/RMS_data/CapturedFiles/${DIR}/output-normal.mp4
  SLOW=~/RMS_data/CapturedFiles/${DIR}/output-slow.mp4
  

  if [ -f "$NORMAL" ]; then
    echo "find video file"
    /bin/cp -f ~/RMS_data/CapturedFiles/${DIR}/*.fits ~/RMS_data/ArchivedFiles/${DIR}/
    /bin/cp -f ~/RMS_data/CapturedFiles/${DIR}/*.mp4 ~/RMS_data/ArchivedFiles/${DIR}/
    # upload video files 2 server
    # TODO
    MSG="发现流星, video file: http://xxxxxxxx/meteorStoreServer/get?name=${DIR}_slow.mp4"
    sendMsg "$MSG"
    MSG="发现流星, video file: http://xxxxxxxx/meteorStoreServer/get?name=${DIR}_normal.mp4"
    sendMsg "$MSG"

    curl  -F "file=@$SLOW"   "http://xxxxxxxx/meteorStoreServer/post?name=${DIR}_slow.mp4"
    curl  -F "file=@$NORMAL" "http://xxxxxxxx/meteorStoreServer/post?name=${DIR}_normal.mp4"

  fi
done
</code></pre> 
<h4>添加crontab，每天早晨8点检查流星文件</h4> 
<p>0 8 * * * cd /home/pi/Desktop/RMS/RMS_new &amp;&amp; bash detect_yestoday_fireball.sh 1 &gt;6.txt 2&gt;&amp;1</p> 
<p></p> 
<p>注意：针对 FRbinViewer.py 的修改，见第一篇文章， 支持输出mp4视频文件</p> 
<p></p> 
<p>发送钉钉群的效果如下</p> 
<p></p> 
<p><img alt="" height="265" src="https://images2.imgbox.com/62/99/wly4U9La_o.png" width="709"></p> 
<p></p> 
<h3>附录</h3> 
<p></p> 
<h4>流星mp4存储服务代码</h4> 
<p></p> 
<p>使用flask作为框架。 post接口接受文件，写入目录。 get接口获取文件，返回二进制流</p> 
<pre><code class="language-python">#!/bin/env python3.6
# -*- coding: utf-8 -*- #
from flask import Flask
from flask import request
from flask import Response
import json
import base64
import requests
import os

import myutil
logger = myutil.getLog("log-default.log")


app = Flask(__name__)
#app.debug=True

@app.route('/meteorStoreServer/get')
def getMeteor():
    logger.info("args:" + str(request.args))
    filename = request.args.get("name")
    if '/' in filename or '..' in filename:
        return "invalid file name"
    def send_file():
        store_path = os.path.join("store", filename)
        with open(store_path, 'rb') as targetfile:
            while 1:
                data = targetfile.read(1 * 1024 * 1024)  
                if not data:
                    break
                yield data
    response = Response(send_file(), content_type='application/octet-stream')
    response.headers["Content-disposition"] = 'attachment; filename=%s' % filename   
    return response


def delete_old_videos():
    for f in os.listdir("store"):
        print(f)


@app.route('/meteorStoreServer/post', methods={'POST'})
def postMeteor():
    logger.info("values:" + json.dumps(request.values))
    logger.info("files: " + str(request.files))
    logger.info("args:" + str(request.args))
    file_name = request.args.get("name")
    for n in request.files:
        fobj = request.files[n]
        logger.info("save file, " + file_name)
        fobj.save(os.path.join("store", file_name))
    return json.dumps({"code": 0})

if __name__ == '__main__':
    app.run(host='0.0.0.0',port=8085)</code></pre> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd38c4825adc840a7b97bae1163109dd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux基础</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b8d2c1a7c8e463b64b4098f0b08f2114/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">单片机的分频是什么意思？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>