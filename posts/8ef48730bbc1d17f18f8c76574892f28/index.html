<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[Ionic]上传图片 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[Ionic]上传图片" />
<meta property="og:description" content="前言 由于项目中涉及到用户上传修改头像，所以研究一下Ionic中上传图片的实现。
正文 由于代码中注释很详细，直接贴代码和注释
HTML代码：
&lt;!-- 下拉刷新加载 --&gt; &lt;ion-content no-margin&gt; &lt;ion-refresher (ionRefresh)=&#34;pullDown($event)&#34;&gt; &lt;ion-refresher-content pullingIcon=&#34;arrow-dropdown&#34; pullingText=&#34;{{Refresh}}&#34; refreshingSpinner=&#34;circles&#34; refreshingText=&#34;{{Refresh}}&#34;&gt; &lt;/ion-refresher-content&gt; &lt;/ion-refresher&gt; &lt;!-- 显示图片，若没有图片则显示请从图库中选择一张图片 --&gt; &lt;img src=&#34;{{pathForImage(lastImage)}}&#34; style=&#34;width:100%;&#34; [hidden]=&#34;lastImage === null&#34; /&gt; &lt;h3&gt;请从图库中选择一张图片&lt;/h3&gt; &lt;/ion-content&gt; &lt;ion-footer&gt; &lt;ion-toolbar color=&#34;primary&#34;&gt; &lt;ion-buttons&gt; &lt;button ion-button icon-left (click)=&#34;presentActionSheet()&#34;&gt; &lt;ion-icon name=&#34;camera&#34;&gt;&lt;/ion-icon&gt;选择... &lt;/button&gt; &lt;!-- 如果没有选择图片，上传按钮为不可用状态 --&gt; &lt;button ion-button icon-left (click)=&#34;uploadImage()&#34; [disabled]=&#34;lastImage === null&#34;&gt; &lt;ion-icon name=&#34;cloud-upload&#34;&gt;&lt;/ion-icon&gt;上传 &lt;/button&gt; &lt;/ion-buttons&gt; &lt;/ion-toolbar&gt; &lt;/ion-footer&gt; .ts代码
import { Component } from &#39;@angular/core&#39;; //判断是哪个平台打开的导入Platform import { IonicPage, normalizeURL, NavController, NavParams, ActionSheetController, ToastController, ModalController, LoadingController, Platform, Loading, ViewController } from &#39;ionic-angular&#39;; // 导入四个外部加载进来的组件 import { File } from &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8ef48730bbc1d17f18f8c76574892f28/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-06-06T21:39:28+08:00" />
<meta property="article:modified_time" content="2018-06-06T21:39:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[Ionic]上传图片</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4><span style="color:#ff0000;">前言</span></h4> 
<p>由于项目中涉及到用户上传修改头像，所以研究一下Ionic中上传图片的实现。</p> 
<h4><span style="color:#ff0000;">正文</span></h4> 
<p>由于代码中注释很详细，直接贴代码和注释</p> 
<p>HTML代码：</p> 
<pre><code class="language-html">&lt;!-- 下拉刷新加载 --&gt;
&lt;ion-content no-margin&gt;
  &lt;ion-refresher (ionRefresh)="pullDown($event)"&gt;
    &lt;ion-refresher-content pullingIcon="arrow-dropdown" pullingText="{<!-- -->{Refresh}}" refreshingSpinner="circles" refreshingText="{<!-- -->{Refresh}}"&gt;
    &lt;/ion-refresher-content&gt;
  &lt;/ion-refresher&gt;

  &lt;!-- 显示图片，若没有图片则显示请从图库中选择一张图片 --&gt;
  &lt;img src="{<!-- -->{pathForImage(lastImage)}}" style="width:100%;" [hidden]="lastImage === null" /&gt;
  &lt;h3&gt;请从图库中选择一张图片&lt;/h3&gt;
&lt;/ion-content&gt;

&lt;ion-footer&gt;
  &lt;ion-toolbar color="primary"&gt;
    &lt;ion-buttons&gt;
      &lt;button ion-button icon-left (click)="presentActionSheet()"&gt;
        &lt;ion-icon name="camera"&gt;&lt;/ion-icon&gt;选择...
      &lt;/button&gt;
      &lt;!-- 如果没有选择图片，上传按钮为不可用状态 --&gt;
      &lt;button ion-button icon-left (click)="uploadImage()" [disabled]="lastImage === null"&gt;
        &lt;ion-icon name="cloud-upload"&gt;&lt;/ion-icon&gt;上传
      &lt;/button&gt;
    &lt;/ion-buttons&gt;
  &lt;/ion-toolbar&gt;
&lt;/ion-footer&gt;
</code></pre> 
<p>.ts代码</p> 
<pre><code class="language-html">import { Component } from '@angular/core';
//判断是哪个平台打开的导入Platform
import { IonicPage, normalizeURL, NavController, NavParams, ActionSheetController, ToastController, ModalController, LoadingController, Platform, Loading, ViewController } from 'ionic-angular';

// 导入四个外部加载进来的组件
import { File } from "@ionic-native/file";
import { Transfer, TransferObject } from "@ionic-native/transfer";
import { FilePath } from "@ionic-native/file-path";
import { Camera } from "@ionic-native/camera";
import { BaseUI } from '../../../../common/baseui';

declare var cordova: any; //导入第三方的库定义到TS项目中

// @IonicPage()
@Component({
  selector: 'page-headface',
  templateUrl: 'headface.html',
})

export class HeadfacePage extends BaseUI {
  userId: string;
  errorMessage: string;
  lastImage: string = null;

  constructor(public navCtrl: NavController,
    public navParams: NavParams,
    public modalCtrl: ModalController,
    public loadingCtrl: LoadingController,
    public actionSheetCtrl: ActionSheetController,
    public camera: Camera,
    public transfer: Transfer,
    public file: File,
    public filePath: FilePath,
    public platform: Platform,
    public toastCtrl: ToastController,
    public viewCtrl: ViewController
  ) {
    super();
  }

  // ionViewDidEnter(){
  //   this.shorage.get('UserId').then(val)=&gt;{
  //     if (val != null) {
  //       this.userId = val
  //     }
  //   }
  // }

  private Refresh: string;
  // 下拉刷新
  pullDown(goback) {
    this.Refresh = "这里不是入口";
    goback.complete();
  }

  presentActionSheet() {
    let actionSheet = this.actionSheetCtrl.create({
      title: '选择图片',
      buttons: [
        {
          text: '从图库中选择',
          handler: () =&gt; {
            this.takePicture(this.camera.PictureSourceType.PHOTOLIBRARY);
          }
        },
        {
          text: '使用相机',
          handler: () =&gt; {
            this.takePicture(this.camera.PictureSourceType.CAMERA);
          }
        },
        {
          text: '取消',
          role: 'cancel'
        }
      ]

    });
    actionSheet.present();
  }

  // 获取图片
  takePicture(sourceType) {
    // 定义相机的一些参数
    var options = {
      quality: 100,//图片的质量
      sourceType: sourceType,
      saveToPhotoAlbum: false, //是否把拍摄的照片保存到相册中
      correctOrientation: true,//是否纠正拍摄照片的方向-陀螺仪
    };
    //获取图片的方法
    this.camera.getPicture(options).then((imagePath) =&gt; {
      //特别处理Android平台的文件路径问题
      if (this.platform.is('android') &amp;&amp; sourceType === this.camera.PictureSourceType.PHOTOLIBRARY) {
        //获取Android平台下的真实路径
        this.filePath.resolveNativePath(imagePath)
          .then(filePath =&gt; {
            //获取正确的路径
            let correctPath = filePath.substr(0, filePath.lastIndexOf('/') + 1);
            //获取正确的文件名
            let currentName = imagePath.substr(imagePath.lastIndexof('/') + 1);
            this.copyFileToLocalDir(correctPath, currentName, this.createFileName());
          });
      }
      else {
        //获取正确的路径
        let correctPath = imagePath.substr(0, imagePath.lastIndexOf('/') + 1);
        //获取正确的文件名
        let currentName = imagePath.substr(imagePath.lastIndexof('/') + 1);
        this.copyFileToLocalDir(correctPath, currentName, this.createFileName());
      }
    }, (err) =&gt; {
      super.showToast(this.toastCtrl, "选择图片出现错误，请检查相关权限。");
    }
    );
  }

  //将获取到的图片或者相机拍摄的图片进行另存为，用于后期图片的上传使用
  copyFileToLocalDir(namePath, currentName, newFileName) {
    this.file.copyFile(namePath, currentName, cordova.file.dataDirectory, newFileName).then(sucess =&gt; {
      this.lastImage = newFileName;
    }, error =&gt; {
      super.showToast(this.toastCtrl, "存储图片到本地图库出现错误。");
    });
  }

  //为文件生成一个新的文件名
  createFileName() {
    var d = new Date(),
      n = d.getTime(),
      newFileName = n + ",jpg"; //拼接文件名
    return newFileName;
  }

  //处理图片的路径为可以上传的路径
  public pathForImage(img) {
    if (img === null) {
      return '';
    }
    else {
      //https://ionicframework.com/docs/wkwebview/
      return normalizeURL(cordova.file.dataDirectory + img);//normalizeURL 重写file路径，适配ios11
    }
  }

  uploadImage() {
    var url = '';
    var targetPath = this.pathForImage(this.lastImage);
    var filename = this.userId + ".jpg" //定义上传后的文件名
    //上传的参数
    var options = {
      fileKey: "file",
      fileName: filename,
      chunkedMode: false,
      mimeType: "multipart/form-data",
      params: { 'fileName': filename, 'userid': this.userId }
    };

    const fileTransfer: TransferObject = this.transfer.create();

    var loading = super.showLoading(this.loadingCtrl, "上传中...");

    //开始正式上传
    fileTransfer.upload(targetPath, url, options).then(data =&gt; {
      loading.dismiss();
      super.showToast(this.toastCtrl, "图片上传成功。");
      //用户看清弹窗提示后进行页面的关闭
      setTimeout(() =&gt; {
        this.viewCtrl.dismiss();
      }, 3000);
    }, err =&gt; {
      loading.dismiss();
      super.showToast(this.toastCtrl, "图片上传发生错误，请重试。");
    });
  }
}
<span style="color:#ff0000;">
</span></code></pre> 
<h4><span style="color:#ff0000;">总结</span></h4> 
<p>本博客几乎全是代码，详情参考代码注释</p> 
<p><br></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c291cc840dd466a449d50e0f083b7906/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">图像的纹理特征</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5287d814ebb6a6e80c08ee7f30633013/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">清华大学陈煜波：数字经济与中国市场的数字化转型（附视频&amp;amp;PPT）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>