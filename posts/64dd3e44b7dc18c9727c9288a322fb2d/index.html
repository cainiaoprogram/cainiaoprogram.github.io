<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Jetson nano部署YOLOv7 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Jetson nano部署YOLOv7" />
<meta property="og:description" content="目录 前言一、YOLOv7模型训练1. 项目的克隆和必要的环境依赖1.1 项目的克隆1.2 项目代码结构整体介绍1.3 环境安装 2. 数据集和预训练权重的准备2.1 数据集2.2 预训练权重准备 3 训练模型3.1 修改模型配置文件3.2 修改数据配置文件3.3 训练模型3.4 推理测试 二、YOLOv7模型部署1. 源码下载2. 环境配置2.1 Jtop(option)2.1.1 配置pip2.1.2 安装jtop2.1.3 使用jtop 2.2 编译Protobuf2.2.1 解压2.2.2 编译2.2.3 安装2.2.4 环境配置(option) 2.3 配置CMakeLists.txt 3. ONNX导出3.1 源码下载3.2 修改代码3.3 导出ONNX模型3.4 拓展-正确导出ONNX文件 4. 运行4.1 源码修改4.2 编译4.3 模型构建和推理4.4 拓展-摄像头检测 结语下载链接参考 前言 yolov7模型部署流程和yolov5几乎完全一致，大家可以先查看我之前的Jetson嵌入式系列模型部署教程。考虑到nano的算力，这里采用yolov7-tiny.pt模型，本文主要分享yolov7模型训练和jetson nano部署yolov7模型两方面的内容。若有问题欢迎各位看官批评指正!!!​😃
一、YOLOv7模型训练 yolov7的代码风格和yolov5非常像，训练流程可参考yolov5的训练。博主主要参考炮哥带你学的利用yolov5训练自己的目标检测模型以及深度学习麋了鹿的yolov7训练测试自己的数据集
1. 项目的克隆和必要的环境依赖 1.1 项目的克隆 yolov7的代码是开源的可直接从github官网上下载，源码下载地址是https://github.com/WongKinYiu/yolov7，由于yolov7刚发布不久目前就只固定v0.1一个版本，而v0.1版本并未提供训练的详细说明，故采用主分支进行模型的训练和部署工作。Linux下代码克隆指令如下
git clone https://github.com/WongKinYiu/yolov7.git 也可手动点击下载，点击右上角的绿色的Code按键，将代码下载下来。至此整个项目就已经准备好了。也可以点击here[password:yolo]下载博主准备好的代码(注意该代码下载于2022/8/31日，若有改动请参考最新)
1.2 项目代码结构整体介绍 将下载后的yolov7的代码解压，其代码目录如下图
现在来对代码的整体目录做一个介绍
|-cfg：存放yolov7不同模型的yaml文件，如yolov7.yaml、yolov7-tiny.yaml等，包括训练和部署时的yolov7模型yaml|-data：存放一些超参数的配置文件以及配置训练集和验证集路径的coco.yaml文件，如果需要修改自己的数据集，那么需要修改其中的yaml文件|-deploy：针对部署的文件夹|-figure：存放yolov7测试的效果图片|-inference：存放推理时的图片|-models：存放yolov7整体网络模型搭建的py文件|-paper：存放yolov7论文|-scripts：脚本文件，用于获取coco数据集|-tools：该文件夹主要存放一些示例教程，如yolov7关键点检测、yolov7实例分割、yolov7onnx等等|-utils：存放工具类函数，包括loss、metrics、plots函数等|- detect.py：检测代码，包括图像检测、视频流检测等export.py：模型导出代码，如onnx导出hubconf.py：pytorch扩展模型requirements.txt：文本文件，里面包含使用yolov7项目的环境依赖包以及相应的版本号test.py：测试代码train.py：训练代码train_aux.py：训练辅助头代码(不确定) 1.3 环境安装 关于深度学习的环境安装可参考炮哥的利用Anaconda安装pytorch和paddle深度学习环境&#43;pycharm安装—免额外安装CUDA和cudnn(适合小白的保姆级教学)，这里不再赘述。如果之前配置过yolov5的环境，yolov7可直接使用。
2. 数据集和预训练权重的准备 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/64dd3e44b7dc18c9727c9288a322fb2d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-26T21:50:16+08:00" />
<meta property="article:modified_time" content="2023-03-26T21:50:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Jetson nano部署YOLOv7</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">前言</a></li><li><a href="#YOLOv7_6" rel="nofollow">一、YOLOv7模型训练</a></li><li><ul><li><a href="#1__10" rel="nofollow">1. 项目的克隆和必要的环境依赖</a></li><li><ul><li><a href="#11__12" rel="nofollow">1.1 项目的克隆</a></li><li><a href="#12__25" rel="nofollow">1.2 项目代码结构整体介绍</a></li><li><a href="#13__52" rel="nofollow">1.3 环境安装</a></li></ul> 
    </li><li><a href="#2__56" rel="nofollow">2. 数据集和预训练权重的准备</a></li><li><ul><li><a href="#21__58" rel="nofollow">2.1 数据集</a></li><li><a href="#22__255" rel="nofollow">2.2 预训练权重准备</a></li></ul> 
    </li><li><a href="#3__261" rel="nofollow">3 训练模型</a></li><li><ul><li><a href="#31__267" rel="nofollow">3.1 修改模型配置文件</a></li><li><a href="#32__274" rel="nofollow">3.2 修改数据配置文件</a></li><li><a href="#33__287" rel="nofollow">3.3 训练模型</a></li><li><a href="#34__310" rel="nofollow">3.4 推理测试</a></li></ul> 
   </li></ul> 
   </li><li><a href="#YOLOv7_333" rel="nofollow">二、YOLOv7模型部署</a></li><li><ul><li><a href="#1__337" rel="nofollow">1. 源码下载</a></li><li><a href="#2__349" rel="nofollow">2. 环境配置</a></li><li><ul><li><a href="#21_Jtopoption_353" rel="nofollow">2.1 Jtop(option)</a></li><li><ul><li><a href="#211_pip_363" rel="nofollow">2.1.1 配置pip</a></li><li><a href="#212_jtop_388" rel="nofollow">2.1.2 安装jtop</a></li><li><a href="#213_jtop_394" rel="nofollow">2.1.3 使用jtop</a></li></ul> 
     </li><li><a href="#22_Protobuf_414" rel="nofollow">2.2 编译Protobuf</a></li><li><ul><li><a href="#221__418" rel="nofollow">2.2.1 解压</a></li><li><a href="#222__425" rel="nofollow">2.2.2 编译</a></li><li><a href="#223__433" rel="nofollow">2.2.3 安装</a></li><li><a href="#224_option_442" rel="nofollow">2.2.4 环境配置(option)</a></li></ul> 
     </li><li><a href="#23_CMakeListstxt_479" rel="nofollow">2.3 配置CMakeLists.txt</a></li></ul> 
    </li><li><a href="#3_ONNX_500" rel="nofollow">3. ONNX导出</a></li><li><ul><li><a href="#31__505" rel="nofollow">3.1 源码下载</a></li><li><a href="#32__513" rel="nofollow">3.2 修改代码</a></li><li><a href="#33_ONNX_580" rel="nofollow">3.3 导出ONNX模型</a></li><li><a href="#34_ONNX_601" rel="nofollow">3.4 拓展-正确导出ONNX文件</a></li></ul> 
    </li><li><a href="#4__617" rel="nofollow">4. 运行</a></li><li><ul><li><a href="#41__619" rel="nofollow">4.1 源码修改</a></li><li><a href="#42__641" rel="nofollow">4.2 编译</a></li><li><a href="#43__680" rel="nofollow">4.3 模型构建和推理</a></li><li><a href="#44__703" rel="nofollow">4.4 拓展-摄像头检测</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_788" rel="nofollow">结语</a></li><li><a href="#_792" rel="nofollow">下载链接</a></li><li><a href="#_803" rel="nofollow">参考</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>前言</h3> 
<blockquote> 
 <p>yolov7模型部署流程和yolov5几乎完全一致，大家可以先查看我之前的<a href="https://blog.csdn.net/qq_40672115/category_11970990.html?spm=1001.2014.3001.5482">Jetson嵌入式系列模型部署教程</a>。考虑到nano的算力，这里采用yolov7-tiny.pt模型，本文主要分享yolov7模型训练和jetson nano部署yolov7模型两方面的内容。若有问题欢迎各位看官批评指正!!!​😃</p> 
</blockquote> 
<h3><a id="YOLOv7_6"></a>一、YOLOv7模型训练</h3> 
<p>yolov7的代码风格和yolov5非常像，训练流程可参考yolov5的训练。博主主要参考炮哥带你学的<a href="https://blog.csdn.net/didiaopao/article/details/119954291?spm=1001.2014.3001.5501">利用yolov5训练自己的目标检测模型</a>以及深度学习麋了鹿的<a href="https://www.bilibili.com/video/BV1kU4y1i7Ts?spm_id_from=333.999.0.0&amp;vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">yolov7训练测试自己的数据集</a></p> 
<h4><a id="1__10"></a>1. 项目的克隆和必要的环境依赖</h4> 
<h5><a id="11__12"></a>1.1 项目的克隆</h5> 
<p>yolov7的代码是开源的可直接从github官网上下载，源码下载地址是<a href="https://github.com/WongKinYiu/yolov7">https://github.com/WongKinYiu/yolov7</a>，由于yolov7刚发布不久目前就只固定v0.1一个版本，而v0.1版本并未提供训练的详细说明，故采用<strong>主分支进行模型的训练和部署工作</strong>。Linux下代码克隆指令如下</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/WongKinYiu/yolov7.git
</code></pre> 
<p>也可手动点击下载，点击右上角的绿色的<code>Code</code>按键，将代码下载下来。至此整个项目就已经准备好了。也可以点击<a href="https://pan.baidu.com/s/1OmR4bCoRhGD_D8HrPbcVhQ" rel="nofollow">here[password:yolo]</a>下载博主准备好的代码(<strong>注意该代码下载于2022/8/31日，若有改动请参考最新</strong>)</p> 
<p><img src="https://images2.imgbox.com/a6/6f/pXq8BKNO_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="12__25"></a>1.2 项目代码结构整体介绍</h5> 
<p>将下载后的yolov7的代码解压，其代码目录如下图</p> 
<p><img src="https://images2.imgbox.com/64/a8/aq2EjmSt_o.png" alt="在这里插入图片描述"></p> 
<p>现在来对代码的整体目录做一个介绍</p> 
<ul><li><strong>|-cfg</strong>：存放yolov7不同模型的yaml文件，如yolov7.yaml、yolov7-tiny.yaml等，包括训练和部署时的yolov7模型yaml</li><li><strong>|-data</strong>：存放一些超参数的配置文件以及配置训练集和验证集路径的coco.yaml文件，如果需要修改自己的数据集，那么需要修改其中的yaml文件</li><li><strong>|-deploy</strong>：针对部署的文件夹</li><li><strong>|-figure</strong>：存放yolov7测试的效果图片</li><li><strong>|-inference</strong>：存放推理时的图片</li><li><strong>|-models</strong>：存放yolov7整体网络模型搭建的py文件</li><li><strong>|-paper</strong>：存放yolov7论文</li><li><strong>|-scripts</strong>：脚本文件，用于获取coco数据集</li><li><strong>|-tools</strong>：该文件夹主要存放一些示例教程，如yolov7关键点检测、yolov7实例分割、yolov7onnx等等</li><li><strong>|-utils</strong>：存放工具类函数，包括loss、metrics、plots函数等</li><li>|- 
  <ul><li><strong>detect.py</strong>：检测代码，包括图像检测、视频流检测等</li><li><strong>export.py</strong>：模型导出代码，如onnx导出</li><li><strong>hubconf.py</strong>：pytorch扩展模型</li><li><strong>requirements.txt</strong>：文本文件，里面包含使用yolov7项目的环境依赖包以及相应的版本号</li><li><strong>test.py</strong>：测试代码</li><li><strong>train.py</strong>：训练代码</li><li><strong>train_aux.py</strong>：训练辅助头代码(<strong>不确定</strong>)</li></ul> </li></ul> 
<h5><a id="13__52"></a>1.3 环境安装</h5> 
<p>关于深度学习的环境安装可参考炮哥的<a href="https://blog.csdn.net/didiaopao/article/details/119787139?spm=1001.2014.3001.5501">利用Anaconda安装pytorch和paddle深度学习环境+pycharm安装—免额外安装CUDA和cudnn(适合小白的保姆级教学)</a>，这里不再赘述。如果之前配置过yolov5的环境，yolov7可直接使用。</p> 
<h4><a id="2__56"></a>2. 数据集和预训练权重的准备</h4> 
<h5><a id="21__58"></a>2.1 数据集</h5> 
<p>这里采用的数据集是口罩识别，来源于<a href="https://space.bilibili.com/73270408" rel="nofollow">B站UP主HamlinZheng</a>的<a href="https://www.bilibili.com/video/BV1i7411376y?spm_id_from=333.337.search-card.all.click&amp;vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">口罩识别数据集</a>，这里给出下载链接<a href="https://pan.baidu.com/s/1oeBugM-bqRN6QFnVgXi5HQ" rel="nofollow">Baidu Drive[password:yolo]</a>，博主将原数据集整合了下，方便后续的训练，解压后整个数据集目录结构如下</p> 
<pre><code class="prism language-shell">VOCdevkit
   └─VOC2007
       ├─Annotations
       └─JPEGImages
</code></pre> 
<p>其中JPEGImages中存放的是图像文件，Annotations存放的是对应的XML标签文件。关于标签的制作可参考<a href="https://space.bilibili.com/18161609?spm_id_from=333.337.0.0" rel="nofollow">B站UP主霹雳吧啦Wz</a>的<a href="https://www.bilibili.com/video/BV1kV411k7D8?vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">PASCAL VOC2012数据集讲解与制作自己的数据集</a>，<strong>由于labelimg标注的是VOC格式标签的XML文件，需要转化为YOLO格式标签的txt文件</strong>，关于转换的代码可参考炮哥的<a href="https://blog.csdn.net/didiaopao/article/details/120022845?spm=1001.2014.3001.5502">目标检测—数据集格式转化及训练集和验证集划分</a>，下面给出VOC格式转YOLO格式的代码：</p> 
<pre><code class="prism language-python"><span class="token comment"># voc2yolo.py</span>
<span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>ElementTree <span class="token keyword">as</span> ET
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> os
<span class="token keyword">from</span> os <span class="token keyword">import</span> listdir<span class="token punctuation">,</span> getcwd
<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> join
<span class="token keyword">import</span> random
<span class="token keyword">from</span> shutil <span class="token keyword">import</span> copyfile

<span class="token comment"># 1. 修改为自制数据集需检测的类别数</span>
classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"have_mask"</span><span class="token punctuation">,</span> <span class="token string">"no_mask"</span><span class="token punctuation">]</span>

<span class="token comment"># 2. 训练集和验证集的比例</span>
TRAIN_RATIO <span class="token operator">=</span> <span class="token number">80</span>


<span class="token keyword">def</span> <span class="token function">clear_hidden_files</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dir_list <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> dir_list<span class="token punctuation">:</span>
        abspath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>abspath<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> i<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"._"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>abspath<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            clear_hidden_files<span class="token punctuation">(</span>abspath<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> box<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dw <span class="token operator">=</span> <span class="token number">1.</span> <span class="token operator">/</span> size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    dh <span class="token operator">=</span> <span class="token number">1.</span> <span class="token operator">/</span> size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    x <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span>
    y <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span>
    w <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    h <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    x <span class="token operator">=</span> x <span class="token operator">*</span> dw
    w <span class="token operator">=</span> w <span class="token operator">*</span> dw
    y <span class="token operator">=</span> y <span class="token operator">*</span> dh
    h <span class="token operator">=</span> h <span class="token operator">*</span> dh
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">convert_annotation</span><span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    in_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'VOCdevkit/VOC2007/Annotations/%s.xml'</span> <span class="token operator">%</span> image_id<span class="token punctuation">)</span>
    out_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'VOCdevkit/VOC2007/YOLOLabels/%s.txt'</span> <span class="token operator">%</span> image_id<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    tree <span class="token operator">=</span> ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>in_file<span class="token punctuation">)</span>
    root <span class="token operator">=</span> tree<span class="token punctuation">.</span>getroot<span class="token punctuation">(</span><span class="token punctuation">)</span>
    size <span class="token operator">=</span> root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'size'</span><span class="token punctuation">)</span>
    w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>

    <span class="token keyword">for</span> obj <span class="token keyword">in</span> root<span class="token punctuation">.</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        difficult <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        cls <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">if</span> cls <span class="token keyword">not</span> <span class="token keyword">in</span> classes <span class="token keyword">or</span> <span class="token builtin">int</span><span class="token punctuation">(</span>difficult<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        cls_id <span class="token operator">=</span> classes<span class="token punctuation">.</span>index<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>
        xmlbox <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token builtin">float</span><span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        bb <span class="token operator">=</span> convert<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        out_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>cls_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">for</span> a <span class="token keyword">in</span> bb<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    in_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    out_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


wd <span class="token operator">=</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
wd <span class="token operator">=</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
data_base_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>wd<span class="token punctuation">,</span> <span class="token string">"VOCdevkit/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>data_base_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>data_base_dir<span class="token punctuation">)</span>
work_sapce_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_base_dir<span class="token punctuation">,</span> <span class="token string">"VOC2007/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>work_sapce_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>work_sapce_dir<span class="token punctuation">)</span>
annotation_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>work_sapce_dir<span class="token punctuation">,</span> <span class="token string">"Annotations/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>annotation_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>annotation_dir<span class="token punctuation">)</span>
clear_hidden_files<span class="token punctuation">(</span>annotation_dir<span class="token punctuation">)</span>
image_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>work_sapce_dir<span class="token punctuation">,</span> <span class="token string">"JPEGImages/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>image_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>image_dir<span class="token punctuation">)</span>
clear_hidden_files<span class="token punctuation">(</span>image_dir<span class="token punctuation">)</span>
yolo_labels_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>work_sapce_dir<span class="token punctuation">,</span> <span class="token string">"YOLOLabels/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>yolo_labels_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>yolo_labels_dir<span class="token punctuation">)</span>
clear_hidden_files<span class="token punctuation">(</span>yolo_labels_dir<span class="token punctuation">)</span>
yolov5_images_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_base_dir<span class="token punctuation">,</span> <span class="token string">"images/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>yolov5_images_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>yolov5_images_dir<span class="token punctuation">)</span>
clear_hidden_files<span class="token punctuation">(</span>yolov5_images_dir<span class="token punctuation">)</span>
yolov5_labels_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_base_dir<span class="token punctuation">,</span> <span class="token string">"labels/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>yolov5_labels_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>yolov5_labels_dir<span class="token punctuation">)</span>
clear_hidden_files<span class="token punctuation">(</span>yolov5_labels_dir<span class="token punctuation">)</span>
yolov5_images_train_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>yolov5_images_dir<span class="token punctuation">,</span> <span class="token string">"train/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>yolov5_images_train_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>yolov5_images_train_dir<span class="token punctuation">)</span>
clear_hidden_files<span class="token punctuation">(</span>yolov5_images_train_dir<span class="token punctuation">)</span>
yolov5_images_test_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>yolov5_images_dir<span class="token punctuation">,</span> <span class="token string">"val/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>yolov5_images_test_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>yolov5_images_test_dir<span class="token punctuation">)</span>
clear_hidden_files<span class="token punctuation">(</span>yolov5_images_test_dir<span class="token punctuation">)</span>
yolov5_labels_train_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>yolov5_labels_dir<span class="token punctuation">,</span> <span class="token string">"train/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>yolov5_labels_train_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>yolov5_labels_train_dir<span class="token punctuation">)</span>
clear_hidden_files<span class="token punctuation">(</span>yolov5_labels_train_dir<span class="token punctuation">)</span>
yolov5_labels_test_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>yolov5_labels_dir<span class="token punctuation">,</span> <span class="token string">"val/"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>yolov5_labels_test_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>yolov5_labels_test_dir<span class="token punctuation">)</span>
clear_hidden_files<span class="token punctuation">(</span>yolov5_labels_test_dir<span class="token punctuation">)</span>

train_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>wd<span class="token punctuation">,</span> <span class="token string">"yolov5_train.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
test_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>wd<span class="token punctuation">,</span> <span class="token string">"yolov5_val.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
train_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
test_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
train_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>wd<span class="token punctuation">,</span> <span class="token string">"yolov5_train.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
test_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>wd<span class="token punctuation">,</span> <span class="token string">"yolov5_val.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
list_imgs <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>image_dir<span class="token punctuation">)</span>  <span class="token comment"># list image files</span>
prob <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Probability: %d"</span> <span class="token operator">%</span> prob<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>list_imgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>image_dir<span class="token punctuation">,</span> list_imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image_path <span class="token operator">=</span> image_dir <span class="token operator">+</span> list_imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        voc_path <span class="token operator">=</span> list_imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">(</span>nameWithoutExtention<span class="token punctuation">,</span> extention<span class="token punctuation">)</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span>voc_nameWithoutExtention<span class="token punctuation">,</span> voc_extention<span class="token punctuation">)</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>voc_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
        annotation_name <span class="token operator">=</span> nameWithoutExtention <span class="token operator">+</span> <span class="token string">'.xml'</span>
        annotation_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>annotation_dir<span class="token punctuation">,</span> annotation_name<span class="token punctuation">)</span>
        label_name <span class="token operator">=</span> nameWithoutExtention <span class="token operator">+</span> <span class="token string">'.txt'</span>
        label_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>yolo_labels_dir<span class="token punctuation">,</span> label_name<span class="token punctuation">)</span>
    prob <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Probability: %d"</span> <span class="token operator">%</span> prob<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prob <span class="token operator">&lt;</span> TRAIN_RATIO<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># train dataset</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>annotation_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            train_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>image_path <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            convert_annotation<span class="token punctuation">(</span>nameWithoutExtention<span class="token punctuation">)</span>  <span class="token comment"># convert label</span>
            copyfile<span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> yolov5_images_train_dir <span class="token operator">+</span> voc_path<span class="token punctuation">)</span>
            copyfile<span class="token punctuation">(</span>label_path<span class="token punctuation">,</span> yolov5_labels_train_dir <span class="token operator">+</span> label_name<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># test dataset</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>annotation_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            test_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>image_path <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            convert_annotation<span class="token punctuation">(</span>nameWithoutExtention<span class="token punctuation">)</span>  <span class="token comment"># convert label</span>
            copyfile<span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> yolov5_images_test_dir <span class="token operator">+</span> voc_path<span class="token punctuation">)</span>
            copyfile<span class="token punctuation">(</span>label_path<span class="token punctuation">,</span> yolov5_labels_test_dir <span class="token operator">+</span> label_name<span class="token punctuation">)</span>
train_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
test_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>代码总共需要修改两处</p> 
<ul><li><strong>第11行，修改要检测的类别名称</strong></li><li><strong>第14行，修改训练集和验证集的划分比例</strong></li></ul> 
<p>整个目录结构如下，注意<code>voc2yolo.py</code>与<code>VOCdevkit</code>处于<strong>同一级目录</strong></p> 
<pre><code class="prism language-shell">VOCdevkit
   └─VOC2007
       ├─Annotations
       └─JPEGImages
voc2yolo.py
</code></pre> 
<p><strong>注</strong>：目录结构一定要与博主的一致，因为程序已经将对应目录写死。</p> 
<p>运行<code>voc2yolo.py</code>代码之后得到如下结果</p> 
<p><img src="https://images2.imgbox.com/ae/56/Mo9Gtn0z_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到目录下有一些新的文件生成，首先VOCdevkit文件夹下分别生成了images和labels文件夹，分别存放着图像和对应的<strong>yolo格式的标签文件</strong>，每个文件夹下分别包含train和val两个子文件夹，代表各自对应的训练集和验证集。VOC2007文件夹下生成了YOLOLabels文件夹，存放着对应yolo格式的标签文件。然后还生成了<code>yolov5_train.txt</code>以及<code>yolov5_val.txt</code>两个txt文件，存放着训练集和验证集图片的完整路径。<strong>yolov7的训练只需要VOCdevkit目录下的images和labels两个文件夹，其它均不需要</strong>，故最终的目录结构如下</p> 
<pre><code class="prism language-shell">VOCdevkit
    ├─images
    │  ├─train
    │  └─val
    └─labels
        ├─train
        └─val
</code></pre> 
<p>至此，数据集的准备工作完毕。</p> 
<h5><a id="22__255"></a>2.2 预训练权重准备</h5> 
<p>yolov7预训练权重可以通过<a href="https://github.com/WongKinYiu/yolov7/releases/tag/v0.1">here</a>下载，博主也提供下载好的两个预训练权重<a href="https://pan.baidu.com/s/1l4gekCq9_EHyfaRvlD8dgw" rel="nofollow">Baidu Drive[password:yolo]</a>，<strong>注意这是yolov7-v0.1版本的预训练权重，若后续有版本更新，记得替换</strong>。本次训练自己的数据集使用的预训练权重为<code>yolov7-tiny.pt</code>。</p> 
<p><img src="https://images2.imgbox.com/37/ad/m8E4qgu6_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3__261"></a>3 训练模型</h4> 
<p>将准备好的数据集文件夹即VOCdevkit复制到yolov7项目环境中，将准备好的预训练权重<code>yolov7-tiny.pt</code>复制到yolov7项目环境中，完整的项目结构如下图所示。训练目标检测模型主要修改cfg文件夹下的模型配置文件<code>yolov7-tiny.ymal</code>以及data文件夹下的数据配置文件<code>coco.yaml</code></p> 
<p><img src="https://images2.imgbox.com/45/5d/Ee6lVy8a_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="31__267"></a>3.1 修改模型配置文件</h5> 
<p>由于该项目使用的是<code>yolov7-tiny.pt</code>这个预训练权重，所有需要使用cfg/training目录下的<code>yolov7-tiny.yaml</code>这个文件夹(由于不同的预训练权重对应不同的网络结构，所以用错预训练权重会报错)。主要修改<code>yolov7-tiny.yaml</code>文件的第二行，即需要识别的类别数，由于这里识别佩戴口罩和不佩戴口罩两个类别，故修改为2即可，如下所示</p> 
<p><img src="https://images2.imgbox.com/05/61/lAGYwbE7_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="32__274"></a>3.2 修改数据配置文件</h5> 
<p>修改data目录下相应的yaml文件，找到目录下的<code>coco.yaml</code>文件，主要修改如下</p> 
<ul><li><strong>1.注释第4行</strong></li><li><strong>2.修改第7行训练集的路径</strong></li><li><strong>3.修改第8行验证集的路径</strong></li><li><strong>4.注释第9行，因为未使用到测试集</strong></li><li><strong>5.修改第12行需要检测的类别数个数</strong></li><li><strong>6.修改第15行需要检测的类别数名称</strong></li></ul> 
<p><img src="https://images2.imgbox.com/0e/0e/AUN3qGpA_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="33__287"></a>3.3 训练模型</h5> 
<p>在终端执行如下指令即可开始训练，参考自yolov7的<a href="https://github.com/WongKinYiu/yolov7">README.md/Training</a></p> 
<pre><code class="prism language-shell">python train.py --workers <span class="token number">8</span> --device <span class="token number">0</span> --batch-size <span class="token number">32</span> --data data/coco.yaml --img <span class="token number">640</span> <span class="token number">640</span> --cfg cfg/training/yolov7-tiny.yaml --weights <span class="token string">'yolov7-tiny.pt'</span> --name yolov7 --hyp data/hyp.scratch.p5.yaml
</code></pre> 
<p>博主训练的模型为p5 models且使用的是单个GPU进行训练，显卡为2080Ti，操作系统为Ubuntu20.04，pytorch版本为1.7，训练时长大概1个小时。训练参数的指定和yolov5差不多，简要解释如下：</p> 
<ul><li><strong>–workers 最大工作核心数</strong></li><li><strong>–device 指定训练的设备，cpu，0(代表第一个gpu设备)</strong></li><li><strong>–batch-size 每次输入到网络的图片数</strong></li><li><strong>–data 数据配置文件的路径</strong></li><li><strong>–img 输入图像的尺寸</strong></li><li><strong>–cfg 模型配置文件路径</strong></li><li><strong>–weights 预训练权重路径</strong></li><li><strong>–name 训练保存的文件夹名字</strong></li><li><strong>–hyp 超参数文件路径</strong></li></ul> 
<p>还有其它参数博主并未设置，<strong>如–epochs训练轮数</strong>等。<strong>大家一定要根据自己的实际情况(如显卡算力)指定不同的参数</strong>，如果你之前训练过yolov5，那我相信这对你来说应该是小case😄<br> 训练完成后的模型权重保存在run/train/weights文件夹下，和yolov5不同的是它保存了多个权重文件，使用<code>best.pt</code>进行后续模型部署即可，这里提供博主训练好的权重文件下载链接<a href="https://pan.baidu.com/s/1QWkXmvBNhdaXonm6pUtbLg" rel="nofollow">Baidu Drive[password:yolo]</a></p> 
<h5><a id="34__310"></a>3.4 推理测试</h5> 
<p>利用项目中的<code>detect.py</code>文件进行测试，将需要推理的图片放入inference/images文件夹下，执行指令如下</p> 
<pre><code class="prism language-shell">python detect.py --weights runs/train/yolov7/weights/best.pt --conf <span class="token number">0.25</span> --img-size <span class="token number">640</span> --source inference/images/mask.png
</code></pre> 
<p>推理完成后在run下面会生成一个detect目录，推理的结果保存在exp目录下，推理结果如下所示</p> 
<p><img src="https://images2.imgbox.com/6f/c8/aNDC60nQ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c6/83/GLrdCj4Y_o.jpg" alt="在这里插入图片描述"></p> 
<p>也可进行视频或者摄像头推理，执行指令如下，0代表本地摄像头</p> 
<pre><code class="prism language-shell">python detect.py --weights runs/train/yolov7/weights/best.pt --conf <span class="token number">0.25</span> --img-size <span class="token number">640</span> --source <span class="token number">0</span>
</code></pre> 
<p>至此，yolov7模型训练已经完毕，下面开始jetson nano上的模型部署工作。</p> 
<h3><a id="YOLOv7_333"></a>二、YOLOv7模型部署</h3> 
<blockquote> 
 <p>Jetson nano上yolov7模型部署流程和yolov5基本一致，大家可以参考我之前发的<a href="https://blog.csdn.net/qq_40672115/category_11970990.html?spm=1001.2014.3001.5482">Jetson嵌入式系列模型部署</a>文章，在这里再重新copy一下吧，部署使用到的Github仓库是<a href="https://github.com/shouxieai/tensorRT_Pro">tensorRT_Pro</a>。该仓库通过<code>TensorRT</code>的<code>ONNX parser</code>解析ONNX文件来完成模型的构建工作。对模型部署有疑问的可以参考<a href="https://blog.csdn.net/qq_40672115/article/details/126386680?spm=1001.2014.3001.5502">Jetson嵌入式系列模型部署-1</a>，想了解通过<code>TensorRT</code>的<code>Layer API</code>一层层完成模型的搭建工作可参考<a href="https://blog.csdn.net/qq_40672115/article/details/126368779?spm=1001.2014.3001.5502">Jetson嵌入式系列模型部署-2</a>。本文主要是针对于<a href="https://github.com/shouxieai/tensorRT_Pro">tensorRT_Pro</a>项目中的yolov7完成嵌入式模型部署，本文参考自<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/tutorial/README.zh-cn.md">tensorRT_Pro的README.md</a>，具体操作流程作者描述非常详细，这里再简单过一遍，本次训练的模型使用yolov7-tiny，类别数为2，为口罩识别😷。</p> 
</blockquote> 
<h4><a id="1__337"></a>1. 源码下载</h4> 
<p>使用如下指令</p> 
<pre><code class="prism language-shell">$ <span class="token function">git</span> clone https://github.com/shouxieai/tensorRT_Pro.git
</code></pre> 
<p>文件较大下载可能比较慢，给出下载好的源码链接<a href="https://pan.baidu.com/s/1DuJG99J3lY21Hfj_Qeb4oA" rel="nofollow">Baidu Drive[password:yolo]</a>，<strong>若有改动请参考最新</strong></p> 
<p>删除不必要的文件，给出简化后的源码链接<a href="https://pan.baidu.com/s/18zralGjexrVqOI-b6cD1xg" rel="nofollow">Baidu Drive[password:yolo]</a>，<strong>若有改动请参考最新</strong></p> 
<h4><a id="2__349"></a>2. 环境配置</h4> 
<blockquote> 
 <p>需要使用的软件环境有<code>TensorRT、CUDA、CUDNN、OpenCV、Protobuf</code>。前四个软件环境在JetPack镜像中已经安装完成，故只需要配置protobuf即可。博主使用的jetpack版本为JetPack4.6.1(PS:关于jetson nano刷机就不再赘述了，需要各位看官自行配置好相关环境😄，外网访问较慢，这里提供Jetson nano的<a href="https://pan.baidu.com/s/1RW8Z-EQK--NtPgIe6mmKIQ?_at_=1660636990470#list/path=%2F" rel="nofollow">JetPack镜像下载链接Baidu Drive[password:nano]【更新完毕!!!】</a>(<strong>PS:提供4.6和4.6.1两个版本，注意4GB和2GB的区别，不要刷错了</strong>)，关于Jetson Nano 2GB和4GB的区别可参考链接<a href="https://zhuanlan.zhihu.com/p/339225116" rel="nofollow">Jetson NANO是什么？如何选？</a>。(吐槽下这玩意上传忒慢了，超级会员不顶用呀，终于上传完了，折磨!!!)</p> 
</blockquote> 
<h5><a id="21_Jtopoption_353"></a>2.1 Jtop(option)</h5> 
<p>可使用如下指令查看自己的JetPack版本简单信息</p> 
<pre><code class="prism language-shell">$ <span class="token function">cat</span> /etc/nv_tegra_release
</code></pre> 
<p>使用Jtop可查看<strong>JetPack详细信息</strong>。Jtop是一个由第三方开发，用于显示Jetson开发板信息的包，可以查询当前板子CPU，GPU使用率，实时功耗，<strong>Jetpack软件包信息</strong>等，参考自<a href="https://blog.csdn.net/xgd2016/article/details/105501745">Jetson nano安装jtop</a>，<a href="https://blog.csdn.net/qq_45772756/article/details/115433921">Jetson nano安装pip并换源</a></p> 
<h6><a id="211_pip_363"></a>2.1.1 配置pip</h6> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> python-pip python3-pip
$ pip3 <span class="token function">install</span> --upgrade pip
$ pip <span class="token function">install</span> --upgrade pip
</code></pre> 
<p>pip换源，指令如下</p> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> <span class="token function">mkdir</span> .pip <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> .pip
$ <span class="token function">sudo</span> <span class="token function">touch</span> pip.conf
$ <span class="token function">sudo</span> <span class="token function">vim</span> pip.conf
</code></pre> 
<p>添加如下内容</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>global<span class="token punctuation">]</span>
<span class="token function">timeout</span> <span class="token operator">=</span> <span class="token number">6000</span>
index-url <span class="token operator">=</span> https://pypi.tuna.tsinghua.edu.cn/simple
trusted-host <span class="token operator">=</span> pypi.tuna.tsinghua.edu.cn
</code></pre> 
<h6><a id="212_jtop_388"></a>2.1.2 安装jtop</h6> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> pip3 <span class="token function">install</span> -U jetson-stats
</code></pre> 
<h6><a id="213_jtop_394"></a>2.1.3 使用jtop</h6> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> jtop
The jetson_stats.service is not active. Please run:
<span class="token function">sudo</span> systemctl restart jetson_stats.service
</code></pre> 
<p>需要启动相关服务，指令如下</p> 
<pre><code class="prism language-jtop">$ sudo systemctl restart jetson_stats.service
$ jtop
</code></pre> 
<p>博主Jtop显示的jetson nano软件包信息页面如下</p> 
<p><img src="https://images2.imgbox.com/16/0f/0HSWXUdR_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="22_Protobuf_414"></a>2.2 编译Protobuf</h5> 
<p><a href="https://github.com/shouxieai/tensorRT_Pro">tensorRT_Pro</a>需要<code>Protobuf</code>用于<strong>ONNX解析器</strong>，需要下载并编译protobuf源码。这里使用的<strong>protobuf版本为3.11.4</strong>，若需要修改为其他版本，请参照<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/tutorial/README.zh-cn.md">README/环境配置/适配Protobuf版本</a>。关于protobuf的相关介绍请参考<a href="https://blog.csdn.net/qq_40672115/article/details/126386680?spm=1001.2014.3001.5502">protubuf简介</a>，给出protobuf的安装包下载链接<a href="https://pan.baidu.com/s/1f3UCcJeOoUaEFSCYUXcL1Q" rel="nofollow">Baidu Drive[password:yolo]</a>。参考自<a href="https://blog.csdn.net/xp178171640/article/details/122597777?spm=1001.2014.3001.5502">Linux下编译protobuf</a>，<a href="https://blog.csdn.net/weixin_32829077/article/details/116832775">Linux下添加protobuf环境变量</a></p> 
<h6><a id="221__418"></a>2.2.1 解压</h6> 
<pre><code class="prism language-shell">$ <span class="token function">mkdir</span> protobuf-3.11.4 <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> protobuf-3.11.4    // 创建protobuf编译的文件夹
$ uzip protobuf-3.11.4.zip    // 解压protobuf压缩包
</code></pre> 
<h6><a id="222__425"></a>2.2.2 编译</h6> 
<pre><code class="prism language-shell">$ <span class="token builtin class-name">cd</span> protobuf-3.11.4/cmake
$ cmake <span class="token builtin class-name">.</span> -Dprotobuf_BUILD_TESTS<span class="token operator">=</span>OFF
$ cmake --build <span class="token builtin class-name">.</span>
</code></pre> 
<h6><a id="223__433"></a>2.2.3 安装</h6> 
<pre><code class="prism language-shell">$ <span class="token function">mkdir</span> protobuf  // 创建protobuf安装的文件夹
$ <span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">DESTDIR</span><span class="token operator">=</span>/home/nvidia/protobuf // 指定protobuf安装的路径
</code></pre> 
<p><strong>注：<strong>编译完成之后protobuf文件夹下仅仅只有</strong>user</strong>一个文件夹，需要将编译好的<code>protobuf/user/local</code>下的<strong>bin、include、lib</strong>文件夹复制到<code>protobuf</code>当前文件夹下，方便后续<a href="https://github.com/shouxieai/tensorRT_Pro">tensorRT_Pro</a>项目CMakeLists.txt的指定。</p> 
<h6><a id="224_option_442"></a>2.2.4 环境配置(option)</h6> 
<ul><li> <p>配置环境变量</p> <pre><code class="prism language-shell">$ <span class="token function">sudo</span> <span class="token function">vim</span> /etc/profile
</code></pre> <p>添加如下内容保存并退出，<strong>注意路径修改为自己的路径</strong></p> <pre><code class="prism language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:/home/nvidia/protobuf/bin
<span class="token builtin class-name">export</span> <span class="token assign-left variable">PKG_CONFIG_PATH</span><span class="token operator">=</span>/home/nvidia/protobuf/lib/pkgconfig/
</code></pre> <p>source生效</p> <pre><code class="prism language-shell">$ <span class="token builtin class-name">source</span> /etc/profile
</code></pre> </li><li> <p>配置动态路径</p> <pre><code class="prism language-shell">$ <span class="token function">sudo</span> <span class="token function">vim</span> /etc/ld.so.conf
</code></pre> <p><strong>追加</strong>如下内容，<strong>注意路径修改为自己的路径</strong></p> <pre><code class="prism language-shell">/home/nvidia/protobuf/lib
</code></pre> </li><li> <p>验证</p> <p><code>protoc --version</code>输出对应版本信息说明安装成功</p> </li></ul> 
<h5><a id="23_CMakeListstxt_479"></a>2.3 配置CMakeLists.txt</h5> 
<p>主要修改三处</p> 
<ul><li> 
  <ol><li><strong>修改第10行，选择不支持python(也可选择支持)</strong></li></ol> <pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>HAS_PYTHON OFF<span class="token punctuation">)</span>
</code></pre> </li><li> 
  <ol start="2"><li><strong>修改第20行，修改CUDA路径</strong></li></ol> <pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>CUDA_TOOLKIT_ROOT_DIR  <span class="token string">"/usr/local/cuda-10.2"</span><span class="token punctuation">)</span>
</code></pre> </li><li> 
  <ol start="3"><li><strong>修改第33行，修改自编译的protobuf的路径</strong></li></ol> </li></ul> 
<p><img src="https://images2.imgbox.com/68/ed/fUlK7EBC_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3_ONNX_500"></a>3. ONNX导出</h4> 
<ul><li>训练的模型使用yolov7-tiny，torch版本1.7</li><li>参考自<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/tutorial/README.zh-cn.md">tensorRT_Pro/README/各项任务支持/YoloV7支持</a>，导出细节的说明已经非常详细了，这里简单过一遍</li></ul> 
<h5><a id="31__505"></a>3.1 源码下载</h5> 
<pre><code class="prism language-shell">$ <span class="token function">git</span> clone https://github.com/WongKinYiu/yolov7.git
</code></pre> 
<p>并将训练好的权重文件复制到yolov7文件夹中，给出权重下载链接<a href="https://pan.baidu.com/s/1QWkXmvBNhdaXonm6pUtbLg" rel="nofollow">Baidu Drive[password:yolo]</a></p> 
<h5><a id="32__513"></a>3.2 修改代码</h5> 
<p>主要修改以下两个文件的内容</p> 
<ul><li><strong>1. yolov7/models/yolo.py</strong></li><li><strong>2. yolov7/export.py</strong></li></ul> 
<p><strong>特别注意!!!，由于使用的模型是yolov7-tiny.pt，训练出来的检测头为IDetect而非部署时的Detect，可以利用<a href="https://netron.app/" rel="nofollow">Netron工具</a>查看官方yolov7-tiny.pt和best.pt二者间区别，如下图所示。</strong></p> 
<p><img src="https://images2.imgbox.com/9c/78/Tr1b5XwZ_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>主要有以下几点说明</p> 
 <p>1.可以查看yolov7项目中的cfg文件夹中的training和deploy文件夹下的<code>yolov7-tiny.yaml</code>文件，可以看到训练和部署时二者的检测头不一致，训练时为IDetect检测头，部署时为Detect检测头，这也是export.py导出onnx文件时需要加上<code>--grid</code>参数的原因</p> 
 <p>2.<code>yolov7-tiny.pt</code>训练出的检测头为IDetect，故代码修改的地方与<a href="https://github.com/shouxieai/tensorRT_Pro">tensorRT_Pro</a>项目修改地方有出入，但内容大体一致</p> 
 <p>3.<code>yolo.py</code>文件中Model类前向传播过程中(706行)，执行的前向传播为m.fuseforward而非m.forward</p> 
 <p>4.<strong>最终定位修改代码的地方在IDetect类中的fuseforward函数中即<code>yolo.py</code>文件第140行</strong></p> 
 <p>具体修改可参考下面。<strong>若有更新请参考最新!!!</strong></p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># 在yolov7/models/yolo.py的第146行</span>
<span class="token comment"># bs, _, ny, nx = x[i].shape  # x(bs,255,20,20) to x(bs,3,20,20,85)</span>
<span class="token comment"># x[i] = x[i].view(bs, self.na, self.no, ny, nx).permute(0, 1, 3, 4, 2).contiguous()</span>
<span class="token comment"># 修改为如下代码，保证view部分不会操作batch size，对于batch维度一定是-1：</span>

bs<span class="token punctuation">,</span> _<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nx <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>  <span class="token comment"># x(bs,255,20,20) to x(bs,3,20,20,85)</span>
bs <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nx<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 在yolov7/models/yolo.py的第153行</span>
<span class="token comment"># y = x[i].sigmoid()</span>
<span class="token comment"># if not torch.onnx.is_in_onnx_export():</span>
<span class="token comment"># 	 y[..., 0:2] = (y[..., 0:2] * 2. - 0.5 + self.grid[i]) * self.stride[i]  # xy</span>
<span class="token comment"># 	 y[..., 2:4] = (y[..., 2:4] * 2) ** 2 * self.anchor_grid[i]  # wh</span>
<span class="token comment"># else:</span>
<span class="token comment">#    xy, wh, conf = y.split((2, 2, self.nc + 1), 4)  # y.tensor_split((2, 4, 5), 4)  # torch 1.8.0</span>
<span class="token comment">#    xy = xy * (2. * self.stride[i]) + (self.stride[i] * (self.grid[i] - 0.5))  # new xy</span>
<span class="token comment">#    wh = wh ** 2 * (4 * self.anchor_grid[i].data)  # new wh</span>
<span class="token comment">#    y = torch.cat((xy, wh, conf), 4)</span>
<span class="token comment"># z.append(y.view(bs, -1, self.no))</span>
<span class="token comment"># 修改为如下代码，目的去掉ScatterND、去掉Gather、Shape等节点：</span>
y <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
xy <span class="token operator">=</span> <span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># xy</span>
wh <span class="token operator">=</span> <span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># wh</span>
classif <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
y <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> classif<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
z<span class="token punctuation">.</span>append<span class="token punctuation">(</span>y<span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>na <span class="token operator">*</span> ny <span class="token operator">*</span> nx<span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 在yolov7/models/yolo.py的第176行</span>
<span class="token comment"># return out</span>
<span class="token comment"># 修改为如下代码，去掉多余的输出部分：</span>
<span class="token keyword">return</span> x <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">else</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>


<span class="token comment"># 在yolov7/export.py第126行</span>
<span class="token comment"># dynamic_axes = {'images': {0: 'batch', 2: 'height', 3: 'width'},  # size(1,3,640,640)</span>
<span class="token comment">#  'output': {0: 'batch', 2: 'y', 3: 'x'}}</span>
<span class="token comment"># 修改为如下代码，使得动态维度只出现在batch上：</span>
dynamic_axes<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'images'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># size(1,3,640,640)</span>
              <span class="token string">'output'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h5><a id="33_ONNX_580"></a>3.3 导出ONNX模型</h5> 
<p>ONNX模型导出指令如下</p> 
<pre><code class="prism language-shell">$ <span class="token builtin class-name">cd</span> yolov7
$ python export.py --dynamic --grid --weights<span class="token operator">=</span>best.pt
</code></pre> 
<p>导出的ONNX模型可使用<a href="https://netron.app/" rel="nofollow">Netron可视化工具</a>查看，给出ONNX文件下载链接<a href="https://pan.baidu.com/s/1QWkXmvBNhdaXonm6pUtbLg" rel="nofollow">Baidu Drive[password:yolo]</a>。<br> 下图对比展示了<strong>原始onnx输出</strong>(不加修改直接导出)和<strong>简化后onnx输出</strong>(按照以上要求修改后导出)的部分差别(<strong>第一张未修改直接导出，第二张修改后导出</strong>)。主要体现在以下几点：</p> 
<ul><li>修改后的onnx导出文件更加简洁</li><li>不必要的节点如Shape、Gather、Unsqueeze等去除</li><li>batch维度指定为动态，其它维度不指定</li></ul> 
<p><img src="https://images2.imgbox.com/6a/f6/eJ7akssW_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/3d/c2/5r4sypdP_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="34_ONNX_601"></a>3.4 拓展-正确导出ONNX文件</h5> 
<p>如何正确导出ONNX文件？主要包含以下几条：</p> 
<blockquote> 
 <ol><li> <p>对于任何用到shape、size返回值的参数时，例如：<code>tensor.view(tensor.size(0),-1)</code>这类操作，避免直接使用tensor.size的返回值，而是加上int转换如<code>tensor.view(int(tensor(0)),-1)</code>，断开跟踪</p> </li><li> <p>对于nn.Unsample或nn.functional.interpolate函数，使用scale_factor指定倍率，而不是使用size参数指定大小</p> </li><li> <p>对于reshape、view操作时，-1的指定需放到batch维度。其他维度计算出来即可。batch维度禁止指定为大于-1的明确数字</p> </li><li> <p>torch.onnx.export指定dynamic_axes参数，并且只指定batch维度，禁止其他动态</p> </li><li> <p>使用opset_version=11，不要低于11</p> </li><li> <p>避免使用inplace操作，如<code>y[...,0:2] = y[..., 0:2] * 2 - 0.5</code></p> </li><li> <p>尽量少的出现5个维度，例如ShuffleNet Module，可用考虑合并wh避免出现5维</p> </li><li> <p>尽量将后处理部分在onnx模型中实现，降低后处理复杂度</p> </li></ol> 
</blockquote> 
<p><strong>注</strong>：参考自<a href="https://www.bilibili.com/video/BV1Xw411f7FW?p=7&amp;vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">手写AI的详解TensorRT高性能部署视频</a>，这些做法的必要性体现在，简化过程的复杂度，去掉Gather、Shape类节点，很多时候不这么改看似也可以成功，但是需求复杂后，依旧存在各类问题。按照上述要求修改后，基本总能成，就不需要使用onnx-simplifer了。具体更多细节描述请观看<a href="https://www.bilibili.com/video/BV1Xw411f7FW?p=7&amp;vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">视频</a>。</p> 
<h4><a id="4__617"></a>4. 运行</h4> 
<h5><a id="41__619"></a>4.1 源码修改</h5> 
<blockquote> 
 <p>yolo模型的推理代码主要在<code>src/application/app_yolo.cpp</code>文件中，需要推理的图片放在<code>workspace/inference</code>文件夹中，将上述修改后导出的ONNX文件放在<code>workspace/</code>文件夹下。源码修改较简单主要有以下几点：</p> 
</blockquote> 
<ul><li><strong>1. app_yolo.cpp 177行 “yolov7"改成"best”，构建best.pt模型</strong></li><li><strong>2. app_yolo.cpp 100行 cocolabels修改为mylabels</strong></li><li><strong>3. app_yolo.cpp 25行 新增mylabels数组，添加自训练模型的类别名称</strong></li></ul> 
<p>具体修改如下</p> 
<pre><code class="prism language-cpp"><span class="token function">test</span><span class="token punctuation">(</span>Yolo<span class="token double-colon punctuation">::</span>Type<span class="token double-colon punctuation">::</span>V7<span class="token punctuation">,</span> TRT<span class="token double-colon punctuation">::</span>Mode<span class="token double-colon punctuation">::</span>FP32<span class="token punctuation">,</span> <span class="token string">"best"</span><span class="token punctuation">)</span>				<span class="token comment">//修改1 177行"yolov7"改成"best"</span>

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> obj <span class="token operator">:</span> boxes<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">auto</span> name    <span class="token operator">=</span> mylabels<span class="token punctuation">[</span>obj<span class="token punctuation">.</span>class_label<span class="token punctuation">]</span><span class="token punctuation">;</span>	 			<span class="token comment">//修改2 100行cocolabels修改为mylabels</span>
	 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> mylabels<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"have_mask"</span><span class="token punctuation">,</span> <span class="token string">"no_mask"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>	<span class="token comment">//修改3 25行新增代码，为自训练模型的类别名称</span>
</code></pre> 
<h5><a id="42__641"></a>4.2 编译</h5> 
<p>编译生成可执行文件<code>.pro</code>，保存在<code>workspace/</code>文件夹下，指令如下：</p> 
<pre><code class="prism language-shell">$ <span class="token builtin class-name">cd</span> tensorRT_Pro-main
$ <span class="token function">mkdir</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> build
$ cmake <span class="token punctuation">..</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -j8
</code></pre> 
<p>耐心等待编译完成(<strong>PS:需要一段时间</strong>)，make -j参数的选取一般时以<strong>CPU核心数两倍为宜</strong>，参考自<a href="https://blog.csdn.net/clarkness/article/details/86633681?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166063241916780366554449%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=166063241916780366554449&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-86633681-null-null.nonecase&amp;utm_term=make%20-j&amp;spm=1018.2226.3001.4450">make -j参数简介</a>，Linux下CPU核心数可通过<code>lscpu</code>指令查看，jetson nano的cpu核心数为4。</p> 
<pre><code class="prism language-shell">$ lscpu
Architecture:        aarch64
Byte Order:          Little Endian
CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:              <span class="token number">4</span>
On-line CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span> list: <span class="token number">0</span>-3
Thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per core:  <span class="token number">1</span>
Core<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per socket:  <span class="token number">4</span>
Socket<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:           <span class="token number">1</span>
Vendor ID:           ARM
Model:               <span class="token number">1</span>
Model name:          Cortex-A57
Stepping:            r1p1
CPU max MHz:         <span class="token number">1479.0000</span>
CPU min MHz:         <span class="token number">102.0000</span>
BogoMIPS:            <span class="token number">38.40</span>
L1d cache:           32K
L1i cache:           48K
L2 cache:            2048K
Flags:               fp asimd evtstrm aes pmull sha1 sha2 crc32
</code></pre> 
<p>编译图解如下所示</p> 
<p><img src="https://images2.imgbox.com/17/2a/KmS41PYh_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="43__680"></a>4.3 模型构建和推理</h5> 
<p>编译完成后的可执行文件<code>.pro</code>存放在<code>workspace/</code>文件夹下，故进入workspace文件夹下执行以下指令</p> 
<pre><code class="prism language-shell">$ <span class="token builtin class-name">cd</span> workspace    // 进入可执行文件目录下
$ <span class="token function">ls</span>			  // 查看当前目录下所有文件
$ ./pro yolo	  // 构建模型并推理 
</code></pre> 
<p>模型构建和推理图解如下所示。在<code>workspace/</code>文件夹下会生成<code>best.FP32.trtmodel</code>引擎文件用于模型推理，会生成<code>best_Yolov7_FP32_result</code>文件夹，该文件夹下保存了推理的图片。</p> 
<p><img src="https://images2.imgbox.com/88/09/IsSAdoBl_o.png" alt="在这里插入图片描述"></p> 
<p>模型推理效果如下图所示</p> 
<p><img src="https://images2.imgbox.com/c8/28/kOUxrlwY_o.jpg" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d0/d6/7fwHmIPU_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="44__703"></a>4.4 拓展-摄像头检测</h5> 
<blockquote> 
 <p>简单写了一个摄像头检测的demo，主要修改以下几点:</p> 
</blockquote> 
<ul><li><strong>1. app_yolo.cpp 新增app_yolo_video_demo()函数，具体内容参考下面</strong></li><li><strong>2. app_yolo.cpp 177行 注释</strong></li><li><strong>3. app_yolo.cpp 176行 新增调用app_yolo_video_demo()函数代码，具体内容参考下面</strong></li></ul> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">app_yolo_video_demo</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> engine_file<span class="token punctuation">,</span> TRT<span class="token double-colon punctuation">::</span>Mode mode<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// 修改1 新增函数</span>
    <span class="token keyword">auto</span> yolo <span class="token operator">=</span> <span class="token class-name">Yolo</span><span class="token double-colon punctuation">::</span><span class="token function">create_infer</span><span class="token punctuation">(</span>
        engine_file<span class="token punctuation">,</span>                    <span class="token comment">// engine file</span>
        Yolo<span class="token double-colon punctuation">::</span>Type<span class="token double-colon punctuation">::</span>V7<span class="token punctuation">,</span>                 <span class="token comment">// yolo type, Yolo::Type::V5 / Yolo::Type::X</span>
        <span class="token number">0</span><span class="token punctuation">,</span>                              <span class="token comment">// gpu_id</span>
        <span class="token number">0.5f</span><span class="token punctuation">,</span>                           <span class="token comment">// confidence threshold</span>
        <span class="token number">0.5f</span><span class="token punctuation">,</span>                           <span class="token comment">// nms threshold</span>
        Yolo<span class="token double-colon punctuation">::</span>NMSMethod<span class="token double-colon punctuation">::</span>FastGPU<span class="token punctuation">,</span>       <span class="token comment">// NMS method, fast GPU / CPU</span>
        <span class="token number">1024</span><span class="token punctuation">,</span>                           <span class="token comment">// max objects</span>
        <span class="token boolean">false</span>                           <span class="token comment">// preprocess use multi stream</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>      
    <span class="token keyword">if</span> <span class="token punctuation">(</span>yolo <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">"Engine is nullptr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cv<span class="token double-colon punctuation">::</span>Mat frame<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>VideoCapture <span class="token function">cap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cap<span class="token punctuation">.</span><span class="token function">isOpened</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">"Engine is nullptr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        cap<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> t0 <span class="token operator">=</span> iLogger<span class="token double-colon punctuation">::</span><span class="token function">timestamp_now_float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        time_t now <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> boxes <span class="token operator">=</span> yolo<span class="token operator">-&gt;</span><span class="token function">commit</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>obj <span class="token operator">:</span> boxes<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">uint8_t</span> b<span class="token punctuation">,</span> g<span class="token punctuation">,</span> r<span class="token punctuation">;</span>
            <span class="token function">tie</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span> iLogger<span class="token double-colon punctuation">::</span><span class="token function">random_color</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>class_label<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token double-colon punctuation">::</span><span class="token function">rectangle</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>left<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>right<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> g<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">auto</span> name <span class="token operator">=</span> mylabels<span class="token punctuation">[</span>obj<span class="token punctuation">.</span>class_label<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> caption <span class="token operator">=</span> iLogger<span class="token double-colon punctuation">::</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s %.2f"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>confidence<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> width <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">getTextSize</span><span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
            cv<span class="token double-colon punctuation">::</span><span class="token function">rectangle</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>left <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>top <span class="token operator">-</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>left <span class="token operator">+</span> width<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> g<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token double-colon punctuation">::</span><span class="token function">putText</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>left<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>top <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token class-name">Scalar</span><span class="token double-colon punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"frame"</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> fee <span class="token operator">=</span> iLogger<span class="token double-colon punctuation">::</span><span class="token function">timestamp_now_float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t0<span class="token punctuation">;</span>
        <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">"fee %.2f ms, fps = %.2f"</span><span class="token punctuation">,</span> fee<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> fee <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> key <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cap<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">destroyAllWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    yolo<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">app_yolo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">app_yolo_video_demo</span><span class="token punctuation">(</span><span class="token string">"best.FP32.trtmodel"</span><span class="token punctuation">,</span> TRT<span class="token double-colon punctuation">::</span>Mode<span class="token double-colon punctuation">::</span>FP32<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 修改3 176行新增</span>
    <span class="token comment">// test(Yolo::Type::V7, TRT::Mode::FP32, "yolov7");					// 修改2 注释177行</span>
    <span class="token comment">// test(Yolo::Type::V5, TRT::Mode::FP32, "yolov5s");</span>
    <span class="token comment">// test(Yolo::Type::V3, TRT::Mode::FP32, "yolov3");</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>进入<code>build/</code>文件夹下编译，然后进行<code>workspace/</code>文件夹下运行即可调用摄像头检测，指令如下</p> 
<pre><code class="prism language-shell">$ <span class="token builtin class-name">cd</span> build
$ <span class="token function">make</span> -j8
$ <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/workspace
$ ./pro yolo
</code></pre> 
<p>图解如下所示</p> 
<p><img src="https://images2.imgbox.com/ff/25/YQBEiK5t_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_788"></a>结语</h3> 
<blockquote> 
 <p>本篇博客介绍了关于yolov7模型训练的流程，以及在jetson nano嵌入式上的部署工作。博主在这里只做了最基础的演示，如果有更多的需求需要各位看官自己去挖掘啦😄。感谢各位看到最后，创作不易，读后有收获的看官请帮忙点个👍⭐️。</p> 
</blockquote> 
<h3><a id="_792"></a>下载链接</h3> 
<ul><li><a href="https://pan.baidu.com/s/1OmR4bCoRhGD_D8HrPbcVhQ" rel="nofollow">yolov7源码[password:yolo]</a></li><li><a href="https://pan.baidu.com/s/1oeBugM-bqRN6QFnVgXi5HQ" rel="nofollow">口罩识别数据集[password:yolo]</a></li><li><a href="https://pan.baidu.com/s/1l4gekCq9_EHyfaRvlD8dgw" rel="nofollow">yolov7-v0.1预训练权重[password:yolo]</a></li><li><a href="https://pan.baidu.com/s/1QWkXmvBNhdaXonm6pUtbLg" rel="nofollow">yolov7口罩识别模型权重[password:yolo]</a></li><li><a href="https://pan.baidu.com/s/1DuJG99J3lY21Hfj_Qeb4oA" rel="nofollow">tensorRT_Pro源码[password:yolo]</a></li><li><a href="https://pan.baidu.com/s/18zralGjexrVqOI-b6cD1xg" rel="nofollow">tensorRT_Pro简化源码[password:yolo]</a></li><li><a href="https://pan.baidu.com/s/1RW8Z-EQK--NtPgIe6mmKIQ?_at_=1660636990470#list/path=%2F" rel="nofollow">JetPack镜像[password:nano]</a></li><li><a href="https://pan.baidu.com/s/1f3UCcJeOoUaEFSCYUXcL1Q" rel="nofollow">protobuf安装包[password:yolo]</a></li></ul> 
<h3><a id="_803"></a>参考</h3> 
<ul><li><a href="https://blog.csdn.net/qq_40672115/category_11970990.html?spm=1001.2014.3001.5482">Jetson嵌入式系列模型部署教程</a></li><li><a href="https://blog.csdn.net/didiaopao/article/details/119954291?spm=1001.2014.3001.5501">利用yolov5训练自己的目标检测模型</a></li><li><a href="https://www.bilibili.com/video/BV1kU4y1i7Ts?spm_id_from=333.999.0.0&amp;vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">yolov7训练测试自己的数据集</a></li><li><a href="https://github.com/WongKinYiu/yolov7">yolov7</a></li><li><a href="https://blog.csdn.net/didiaopao/article/details/119787139?spm=1001.2014.3001.5501">利用Anaconda安装pytorch和paddle深度学习环境+pycharm安装—免额外安装CUDA和cudnn(适合小白的保姆级教学)</a></li><li><a href="https://www.bilibili.com/video/BV1i7411376y?spm_id_from=333.337.search-card.all.click&amp;vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">口罩佩戴识别Demo</a></li><li><a href="https://www.bilibili.com/video/BV1kV411k7D8?vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">PASCAL VOC2012数据集讲解与制作自己的数据集</a></li><li><a href="https://blog.csdn.net/didiaopao/article/details/120022845?spm=1001.2014.3001.5502">目标检测—数据集格式转化及训练集和验证集划分</a></li><li><a href="https://github.com/shouxieai/tensorRT_Pro">tensorRT_Pro</a></li><li><a href="https://zhuanlan.zhihu.com/p/339225116" rel="nofollow">Jetson NANO是什么？如何选？</a></li><li><a href="https://blog.csdn.net/xgd2016/article/details/105501745">Jetson nano安装jtop</a></li><li><a href="https://blog.csdn.net/qq_45772756/article/details/115433921">Jetson nano安装pip并换源</a></li><li><a href="https://blog.csdn.net/xp178171640/article/details/122597777?spm=1001.2014.3001.5502">Linux下编译protobuf</a></li><li><a href="https://blog.csdn.net/weixin_32829077/article/details/116832775">Linux下添加protobuf环境变量</a></li><li><a href="https://netron.app/" rel="nofollow">Netron可视化工具</a></li><li><a href="https://www.bilibili.com/video/BV1Xw411f7FW?p=7&amp;vd_source=2306b3f342c070c8a11931c94eafa8e3" rel="nofollow">手写AI的详解TensorRT高性能部署视频</a> <strong>博主强烈推荐</strong>!!!👍👍👍</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d1570be407782b12156fba959817118e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">js求数组最大值有哪些方式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f2ae7e5e76ad4540801cce8fda0fbffa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Jetson嵌入式系列模型部署-1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>