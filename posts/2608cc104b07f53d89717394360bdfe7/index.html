<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Gromacs副本交换分子动力学模拟(REMD) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Gromacs副本交换分子动力学模拟(REMD)" />
<meta property="og:description" content="REMD(副本交换分子动力学)是一种增强采样方法，其在不同温度下对具有相似势能的体系进行采样。通过这种方法，可以增加体系跳出势能面势阱的可能性，从而达到探索新的构象空间的目的。
一般来说某一温度下蛋白模拟构象分布满足正态分布规律。如上图所示，展示了同一体系在不同温度下的分布情况，横坐标表示模拟过程中出现的构象，纵坐标表示某一构象存在的丰度。对于体系1（绿色）而言，能达到虚线区域内构象的概率比较小，需要延长模拟时间才能提高这个区域构象出现的次数，若模拟时间不充分甚至有可能采样不到该区域的构象。而对于体系2（红色）而言，却很容易达到蓝色虚线之间的构象，如果在模拟过程中体系1与体系2在这个区间进行了构象交换，那么就可以弥补体系1采样不足的问题。
以上个人愚见，仅供参考！
Gromacs 中实现的方式：
注意：只有单线程 gromacs 不支持 REMD，需要多线程编译版本。安装过程和之前的教程相差无几，只是需要额外安装 openmpi，并在最后 gromacs 编译步骤增加一个选项-DGMX_MPI=ON 即可。编译完成并安装后，执行gmx_mpi可以正常调用。
确定所选模拟体系温度变化范围，温度变化梯度；每一个温度下分别进行预平衡（NVT/NPT），每个温度下的预平衡称为一个副本/或系综。在这些副本进行预平衡之前共同都要进行相同的步骤：包括建模、能量最小化。以每个副本预平衡后的终构象作为起始分别开始对应温度下的成品模拟。 实现上述过程并不复杂，我为大家提供了运行脚本：
关注微信公众号grosetta，后台回复“REMD”自取（以溶菌酶模拟为例）
1、模型构建&#43;EM cd REMD chmod 777 run.sh ./run.sh 运行完后，在主文件夹中会出现模拟后的文件（后面不需要的都自动删除了），文件1EM.gro及topol.top是必须存在的。
用编辑器打开1EM.gro及topol.top查看蛋白总原子数及水总分子数。
2、副本温度取值确定 打开网址：
http://virtualchemistry.org/remd-temperature-generator/
其中：
Exchange probability（副本交换频率）可根据需求自行调整；Lower temperature limit 设定温度区间下限（单位K）；Number of water molecules 体系总的水分子数；Number of protein atoms 体系蛋白总原子数；Upper temperature limit 设定温度区间上限(单位K)；Constraints in water 水分子模型是柔性水还是刚性水，一般选刚性水；Constraints in the protein 选择只对氢原子的键进行束缚； 其余各项保持默认即可。
点击submit提交，返回程序推荐的各副本模拟温度取值（需要注意的是该程序针对oplsaa力场发展而来，对于应用其他力场的体系，如AMBER、GROMOS,则多少存在些偏差）。
复制红框内的数据以备后用。
3、多副本预平衡模拟 在REMD文件夹一级目录下打开终端
chmod 777 step1.sh ./step1.sh step1.sh脚本内容如下（第一行的温度数据就是上一步复制结果，替换成你的即可）：
#!/bin/bash T=&#34;298.15, 299.47, 300.78, 302.11, 303.44, 304.77, 306." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2608cc104b07f53d89717394360bdfe7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-16T14:21:03+08:00" />
<meta property="article:modified_time" content="2022-05-16T14:21:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Gromacs副本交换分子动力学模拟(REMD)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>REMD(副本交换分子动力学)是一种增强采样方法，其在不同温度下对具有相似势能的体系进行采样。通过这种方法，可以增加体系跳出势能面势阱的可能性，从而达到探索新的构象空间的目的。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/7f/5a/uqTJWQt6_o.png" alt=""></p> 
<blockquote> 
 <p>一般来说某一温度下蛋白模拟构象分布满足正态分布规律。如上图所示，展示了同一体系在不同温度下的分布情况，横坐标表示模拟过程中出现的构象，纵坐标表示某一构象存在的丰度。对于体系1（绿色）而言，能达到虚线区域内构象的概率比较小，需要延长模拟时间才能提高这个区域构象出现的次数，若模拟时间不充分甚至有可能采样不到该区域的构象。而对于体系2（红色）而言，却很容易达到蓝色虚线之间的构象，如果在模拟过程中体系1与体系2在这个区间进行了构象交换，那么就可以弥补体系1采样不足的问题。</p> 
</blockquote> 
<p>以上个人愚见，仅供参考！</p> 
<p><strong>Gromacs 中实现的方式：</strong></p> 
<p>注意：只有单线程 gromacs 不支持 REMD，需要多线程编译版本。安装过程和之前的教程相差无几，只是需要额外安装 openmpi，并在最后 gromacs 编译步骤增加一个选项<code>-DGMX_MPI=ON</code> 即可。编译完成并安装后，执行<code>gmx_mpi</code>可以正常调用。</p> 
<ol><li>确定所选模拟体系温度变化范围，温度变化梯度；</li><li>每一个温度下分别进行预平衡（NVT/NPT），每个温度下的预平衡称为一个副本/或系综。在这些副本进行预平衡之前共同都要进行相同的步骤：包括建模、能量最小化。</li><li>以每个副本预平衡后的终构象作为起始分别开始对应温度下的成品模拟。</li></ol> 
<p>实现上述过程并不复杂，我为大家提供了运行脚本：</p> 
<p>关注微信公众号<strong>grosetta</strong>，后台回复“<font color="red">REMD</font>”自取（以溶菌酶模拟为例）</p> 
<h4><a id="1EM_27"></a>1、模型构建+EM</h4> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> REMD
<span class="token function">chmod</span> <span class="token number">777</span> run.sh
./run.sh             
</code></pre> 
<p>运行完后，在主文件夹中会出现模拟后的文件（后面不需要的都自动删除了），文件<code>1EM.gro</code>及<code>topol.top</code>是必须存在的。</p> 
<p>用编辑器打开<code>1EM.gro</code>及<code>topol.top</code>查看蛋白总原子数及水总分子数。</p> 
<h4><a id="2_38"></a>2、副本温度取值确定</h4> 
<p>打开网址：<br> <a href="http://virtualchemistry.org/remd-temperature-generator/" rel="nofollow">http://virtualchemistry.org/remd-temperature-generator/</a></p> 
<p><img src="https://images2.imgbox.com/1c/04/5NE6oZdB_o.png" alt="主页面"></p> 
<p>其中：</p> 
<ul><li>Exchange probability（副本交换频率）可根据需求自行调整；</li><li>Lower temperature limit 设定温度区间下限（单位K）；</li><li>Number of water molecules 体系总的水分子数；</li><li>Number of protein atoms 体系蛋白总原子数；</li><li>Upper temperature limit 设定温度区间上限(单位K)；</li><li>Constraints in water 水分子模型是柔性水还是刚性水，一般选刚性水；</li><li>Constraints in the protein 选择只对氢原子的键进行束缚；</li></ul> 
<p>其余各项保持默认即可。</p> 
<p>点击submit提交，返回程序推荐的各副本模拟温度取值（需要注意的是该程序针对oplsaa力场发展而来，对于应用其他力场的体系，如AMBER、GROMOS,则多少存在些偏差）。</p> 
<p><img src="https://images2.imgbox.com/a2/21/EsKO7nsa_o.png" alt="推荐温度取值"></p> 
<p>复制红框内的数据以备后用。</p> 
<h4><a id="3_67"></a>3、多副本预平衡模拟</h4> 
<p>在REMD文件夹一级目录下打开终端</p> 
<pre><code class="prism language-bash"><span class="token function">chmod</span> <span class="token number">777</span> step1.sh
./step1.sh
</code></pre> 
<p><code>step1.sh</code>脚本内容如下（第一行的温度数据就是上一步复制结果，替换成你的即可）：</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">T</span><span class="token operator">=</span><span class="token string">"298.15, 299.47, 300.78, 302.11, 303.44, 304.77, 306.11, 307.47, 308.82, 310.00"</span>
<span class="token assign-left variable">arr_T</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">${T<span class="token operator">/</span><span class="token operator">/</span><span class="token operator">,</span><span class="token operator">/</span> }</span><span class="token punctuation">)</span>  <span class="token comment">#温度数据转为数组</span>
<span class="token assign-left variable">len</span><span class="token operator">=</span><span class="token variable">${<!-- --><span class="token operator">#</span>arr_T<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>   <span class="token comment">#统计数组元素个数</span>

<span class="token function">rm</span> -r ./step1/equ* <span class="token operator">&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>  <span class="token comment">#删除step1路径下的残存文件夹</span>

<span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>$len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">))</span></span>
<span class="token keyword">do</span>
	<span class="token function">mkdir</span> ./step1/equ_<span class="token variable">${i}</span>
	<span class="token function">cp</span> ./step1/mdp_file/* ./step1/equ_<span class="token variable">${i}</span>/.
	<span class="token function">sed</span> -i <span class="token string">'s/TEMP/'</span><span class="token variable">${arr_T<span class="token punctuation">[</span>$i<span class="token punctuation">]</span>}</span><span class="token string">'/g'</span> ./step1/equ_<span class="token variable">${i}</span>/*.mdp
	<span class="token comment">#预平衡</span>
	gmx_mpi grompp -f ./step1/equ_<span class="token variable">${i}</span>/PR.mdp -c 1EM.gro -r 1EM.gro -p topol.top -o ./step1/equ_<span class="token variable">${i}</span>/2PR.tpr -maxwarn <span class="token number">99</span>
	gmx_mpi mdrun -deffnm ./step1/equ_<span class="token variable">${i}</span>/2PR -v
	<span class="token comment">#NVT</span>
	gmx_mpi grompp -f ./step1/equ_<span class="token variable">${i}</span>/NVT.mdp -c ./step1/equ_<span class="token variable">${i}</span>/2PR.gro -p topol.top -o ./step1/equ_<span class="token variable">${i}</span>/3NVT.tpr -maxwarn <span class="token number">99</span>
	gmx_mpi mdrun -deffnm ./step1/equ_<span class="token variable">${i}</span>/3NVT -v
	<span class="token comment">#NPT</span>
	gmx_mpi grompp -f ./step1/equ_<span class="token variable">${i}</span>/NPT.mdp -c ./step1/equ_<span class="token variable">${i}</span>/3NVT.gro -p topol.top -o ./step1/equ_<span class="token variable">${i}</span>/4NPT.tpr -maxwarn <span class="token number">99</span>
	gmx_mpi mdrun -deffnm ./step1/equ_<span class="token variable">${i}</span>/4NPT -v
	<span class="token comment">#删除中间文件</span>
	<span class="token function">rm</span> -f ./step1/equ_<span class="token variable">${i}</span>/*.trr ./step1/equ_<span class="token variable">${i}</span>/*.edr ./step1/equ_<span class="token variable">${i}</span>/*tpr ./step1/equ_<span class="token variable">${i}</span>/*.log ./step1/equ_<span class="token variable">${i}</span>/*.xtc ./step1/equ_<span class="token variable">${i}</span>/<span class="token punctuation">\</span>#* <span class="token operator">&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
<span class="token keyword">done</span>
</code></pre> 
<p>此步的mdp模板文件存在路径为<code>step1/mdp_file</code>,可以根据自己需求修改步长、总步数、输出频率等各类参数（注意和温度数值相关参数一概不要修改，脚本可代劳。此外该路径下的模板文件不能删除）。</p> 
<h4><a id="4_110"></a>4、成品模拟（副本交换）</h4> 
<p>同样是在REMD文件夹一级目录下打开终端</p> 
<pre><code class="prism language-bash"><span class="token function">chmod</span> <span class="token number">777</span> step2.sh
./step2.sh
</code></pre> 
<p><code>step2.sh</code>脚本内容如下（同样只需要替换第一行的温度数据，和上一步一样）：</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">T</span><span class="token operator">=</span><span class="token string">"298.15, 299.47, 300.78, 302.11, 303.44, 304.77, 306.11, 307.47, 308.82, 310.00"</span>
<span class="token assign-left variable">arr_T</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">${T<span class="token operator">/</span><span class="token operator">/</span><span class="token operator">,</span><span class="token operator">/</span> }</span><span class="token punctuation">)</span>  <span class="token comment">#温度数据转为数组</span>
<span class="token assign-left variable">len</span><span class="token operator">=</span><span class="token variable">${<!-- --><span class="token operator">#</span>arr_T<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>   <span class="token comment">#统计数组元素个数</span>
<span class="token assign-left variable">mid</span><span class="token operator">=</span><span class="token variable">${len}</span>-1

<span class="token function">rm</span> -r ./step2/MD* <span class="token operator">&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>  <span class="token comment">#删除step2路径下的残存文件夹</span>

<span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>$mid<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">))</span></span>
<span class="token keyword">do</span>
	<span class="token function">mkdir</span> ./step2/MD_<span class="token variable">${i}</span>
	<span class="token function">cp</span> ./step2/mdp_file/* ./step2/MD_<span class="token variable">${i}</span>/.
	<span class="token function">cp</span> ./step1/equ_<span class="token variable">${i}</span>/4*.gro ./step2/MD_<span class="token variable">${i}</span>/.
	<span class="token function">sed</span> -i <span class="token string">'s/TEMP/'</span><span class="token variable">${arr_T<span class="token punctuation">[</span>$i<span class="token punctuation">]</span>}</span><span class="token string">'/g'</span> ./step2/MD_<span class="token variable">${i}</span>/*.mdp
	<span class="token comment">#成品模拟tpr文件生成</span>
	gmx_mpi grompp -f ./step2/MD_<span class="token variable">${i}</span>/md.mdp -c ./step1/equ_<span class="token variable">${i}</span>/4NPT.gro -p topol.top -o ./step2/MD_<span class="token variable">${i}</span>/5MD.tpr
<span class="token keyword">done</span>

</code></pre> 
<p>执行交换模拟</p> 
<pre><code class="prism language-bash">mpirun -np <span class="token number">8</span> gmx_mpi mdrun -deffnm 5MD -multidir ./step2/MD_<span class="token punctuation">[</span><span class="token number">12345678</span><span class="token punctuation">]</span> -replex <span class="token number">1000</span>
</code></pre> 
<ul><li>-np 表示调用cpu核心数</li><li>[] 内的数字表示副本所在文件夹名称的后缀数字，我们创建了10个副本，对应文件夹的后缀名是0，1，2，3，4，5，6，7，8，9 但由于cpu个数应该是副本个数整数倍，我是在笔记本上的wsl中进行的测试，只有八个核心，所以最多只能进行8个副本的交换，我选的这八个副本的文件夹后缀序号是1-8，对应在中括号内需要将数字补齐，即12345678</li><li>replex 表示副本模拟多少步进行一次交换，蛋白体系一般需要至少间隔1ps（在步长为2fs情况下，即运行500步）再交换。</li></ul> 
<blockquote> 
 <p>由于进行模拟的每个副本在模拟过程中进行了构象交换，所以各自在时间上就不是连续的，可以用gromacs自带脚本进行整合，命令如下：</p> 
</blockquote> 
<pre><code class="prism language-bash">demux.pl ./step2/MD_1/5MD.log
gmx_mpi trjcat -f ./step2/MD_<span class="token punctuation">[</span><span class="token number">12345678</span><span class="token punctuation">]</span>/5MD.xtc -demux replica_index.xvg -o ./traj_merge/<span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">8</span><span class="token punctuation">}</span>_traj.xtc
</code></pre> 
<p>最后整合好的轨迹输出到了traj_merge文件夹内。<br> 整合后的轨迹只代表单一温度下的轨迹</p> 
<p><strong>扫码关注下方二维码关注公众号，后台回复“<font color="red">REMD</font>”获取示例文件和脚本：</strong><br> <img src="https://images2.imgbox.com/b9/6a/iPnsawk9_o.jpg" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aeb128c3ed31021c5cc38030a1690c18/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于java.sql.SQLException: The server time zone value问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/163735d364a8a0b8c725fee84b32842a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">.net 6 EF Core MySql数据库表生成实体类命令</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>