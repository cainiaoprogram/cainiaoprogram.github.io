<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深度理解 C# 中的 for 和 foreach - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深度理解 C# 中的 for 和 foreach" />
<meta property="og:description" content="1 前言 很多人认为，在C#中 for 和 foreach 功能是一样的，foreach 顶多就是比 for 要更方便一些。但是实际上真的是这样吗？在本文中，让我们通过一个实例来理解其底层的工作原理。
2 for VS foreach 首先，请看下面的代码段：
List&lt;Person&gt; people = new List&lt;Person&gt;(); for(int i = 0; i &lt; 100; i&#43;&#43;){ var p = people[i]; // TODO: 下面的代码处理 p } List&lt;Person&gt; people = new List&lt;Person&gt;(); foreach(var p in people) // TODO: 下面的代码处理p } 我们可以看到，在 TODO 下方，都是直接使用 p 就可以完成相关操作。两者从使用上来说，foreach 能够比 for 省去一个赋值语句（），也就仅此而已，两者感觉完全是一样的，但是实际上真的是这样吗？
3 一个示例 在回答问题之前，让我们再看这样的一个示例。以下代码先定义了一个列表 List&lt;int&gt; list并添加3亿个整型数，然后分别使用 for 和 foreach 进行累加求和，结果分别保存在 sum1 和 sum2 中，并对这两种方法进行计时，在最后输出计算结果和所用时间。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/671243af7eae178889167d87abce43c5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-15T15:52:48+08:00" />
<meta property="article:modified_time" content="2022-06-15T15:52:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深度理解 C# 中的 for 和 foreach</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1 前言</h2> 
<p>很多人认为，在C#中 <code>for</code> 和 <code>foreach</code> 功能是一样的，<code>foreach</code> 顶多就是比 <code>for</code> 要更方便一些。但是实际上真的是这样吗？在本文中，让我们通过一个实例来理解其底层的工作原理。</p> 
<h2><a id="2_for_VS_foreach_3"></a>2 <code>for</code> VS <code>foreach</code></h2> 
<p>首先，请看下面的代码段：</p> 
<pre><code class="prism language-csharp"><span class="token class-name">List<span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token class-name"><span class="token keyword">var</span></span> p <span class="token operator">=</span> people<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// TODO: 下面的代码处理 p</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token class-name">List<span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> p <span class="token keyword">in</span> people<span class="token punctuation">)</span>
	<span class="token comment">// TODO: 下面的代码处理p</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们可以看到，在 TODO 下方，都是直接使用 p 就可以完成相关操作。两者从使用上来说，<code>foreach</code> 能够比 <code>for</code> 省去一个赋值语句（），也就仅此而已，两者感觉完全是一样的，但是实际上真的是这样吗？</p> 
<h2><a id="3__21"></a>3 一个示例</h2> 
<p>在回答问题之前，让我们再看这样的一个示例。以下代码先定义了一个列表 <code>List&lt;int&gt; list</code>并添加3亿个整型数，然后分别使用 <code>for</code> 和 <code>foreach</code> 进行累加求和，结果分别保存在 <code>sum1</code> 和 <code>sum2</code> 中，并对这两种方法进行计时，在最后输出计算结果和所用时间。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
     Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"processing..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name"><span class="token keyword">int</span></span> size <span class="token operator">=</span> <span class="token number">300_000_000</span><span class="token punctuation">;</span>
     <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
         list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 使用 for 求和</span>
     <span class="token class-name"><span class="token keyword">var</span></span> t1 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
     <span class="token class-name"><span class="token keyword">double</span></span> sum1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
         sum1 <span class="token operator">+=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token class-name"><span class="token keyword">var</span></span> t2 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
     
     <span class="token comment">// 使用 foreach 求和</span>
     <span class="token class-name"><span class="token keyword">double</span></span> sum2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> v <span class="token keyword">in</span> list<span class="token punctuation">)</span>
         sum2 <span class="token operator">+=</span> v<span class="token punctuation">;</span>
     <span class="token class-name"><span class="token keyword">var</span></span> t3 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
     
     <span class="token comment">// 输出结果</span>
     Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"done.\nResult: sum1=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">sum1</span><span class="token punctuation">}</span></span><span class="token string">, sum2=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">sum2</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"time1: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">t2 <span class="token operator">-</span> t1</span><span class="token punctuation">}</span></span><span class="token string">\ntime2: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">t3 <span class="token operator">-</span> t2</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>输出如下：</p> 
<pre><code>processing...
done.
Result: sum1=44999999767108860, sum2=44999999767108860
time1: 00:00:01.1345446
time2: 00:00:00.6056811
</code></pre> 
<h2><a id="4__59"></a>4 原理分析</h2> 
<p>通过结果分析，我们可以看出，使用 <code>for</code> 循环与 <code>foreach</code> 的用时相差近1倍，通过多次测试也基本是这个结果。这个时间差显然不是误差，根本原因就在于两者实现的方式不同：</p> 
<ul><li><code>for</code> 对 list 中的元素逐一进行访问，由于 list[i] 是列表，所以每次在访问 list[i] 时，需要重新定位，因此要消耗很多的定位时间；</li><li><code>foreach</code> 则是只对 list 进行一次遍历，从第1个元素开始直到最后一个元素，具体在实现中使用 <code>yield return</code> 来实现（可以参见之前我的文章 <a href="https://blog.csdn.net/weixin_43145361/article/details/100172768">深入理解C#中yield return的用法</a> ）。</li></ul> 
<p>所以，<code>foreach</code> 是为可迭代的对象(iteratable)专门设计的，能够只遍历一次的情况下，完成对有元素的访问。</p> 
<p>明白了这个原理，我们可以将 list 换成数组，再测试一次，代码和结果如下：</p> 
<pre><code class="prism language-csharp">        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//Test1();</span>
            <span class="token comment">//Test2();</span>
            <span class="token comment"> Thread.Sleep(4000);</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"processing..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> size <span class="token operator">=</span> <span class="token number">300_000_000</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">int</span></span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> t1 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">double</span></span> sum1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                sum1 <span class="token operator">+=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> t2 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">double</span></span> sum2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> v <span class="token keyword">in</span> arr<span class="token punctuation">)</span>
                sum2 <span class="token operator">+=</span> v<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> t3 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"done.\nResult: sum1=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">sum1</span><span class="token punctuation">}</span></span><span class="token string">, sum2=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">sum2</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"time1: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">t2 <span class="token operator">-</span> t1</span><span class="token punctuation">}</span></span><span class="token string">\ntime2: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">t3 <span class="token operator">-</span> t2</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>结果</p> 
<pre><code>processing...
done.
Result: sum1=44999999767108860, sum2=44999999767108860
time1: 00:00:00.6329427
time2: 00:00:00.6343659
</code></pre> 
<p>由于数组有较好的随机访问性能，所以两者的结果基本一样。如果再换一种数据类型，比如 LinkedList，由于其随机读写性能较 List 更差，所以两者的时间差会更大，即 <code>foreach</code> 的优势更明显，有兴趣的读者可以自行尝试一下。</p> 
<h2><a id="5__103"></a>5 总结</h2> 
<p>C#中的 <code>for</code> 和 <code>foreach</code> 的设计目的是不一样的，<code>for</code> 是一般性的循环，而 <code>foreach</code> 是专门用于可以迭代的集合的循环方法，能够有效地减少访问次数，从而达到优化的效果。因此，在遍历随机访问性能的集合时，两者区别不大，而随机访问性能差时，优先使用<code>foreach</code> 会取得更好的性能。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a97b7440376d6ee8255fc81880a363f7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C&#43;&#43;基础】【集成编译环境02】从源码开始的Windows10 Clion的Opencv 3.0 编译环境配置和搭建</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9f7434ae0b2b506a79fae70bd59a893f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">VMware、CentOS7安装及静态ip配置和Xshell远程工具连接(个人学习笔记）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>