<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ubuntu部署k8s - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ubuntu部署k8s" />
<meta property="og:description" content="目录
提前安装
一. 修改 ubuntu 配置
关闭 swap 内存
配置免密登录
二. 安装 docker
docker 的安装
docker 的配置
三. 安装 k8s
四. 安装 master 节点
初始化 master 节点
配置 kubectl 工具
部署 flannel 网络
五. 将 slave 节点加入网络
默认网卡问题修复
修改 kubelet 默认地址
修改 flannel 的默认网卡
重置节点
常见问题
总结
参考
要注意，对于1.24之上的k8s版本，默认使用安装是contained，要使用docker需要另外安装cri
提前安装 apt-get install -y curl &amp;&amp; apt-get install -y vim 一. 修改 ubuntu 配置 首先，k8s 要求我们的 ubuntu 进行一些符合它要求的配置。
1.关闭 Swap 内存" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9915155620116c5d1daff286621bc12f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-12T16:20:11+08:00" />
<meta property="article:modified_time" content="2023-11-12T16:20:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ubuntu部署k8s</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px;"></p> 
<p id="%E6%8F%90%E5%89%8D%E5%AE%89%E8%A3%85-toc" style="margin-left:0px;"><a href="#%E6%8F%90%E5%89%8D%E5%AE%89%E8%A3%85" rel="nofollow">提前安装</a></p> 
<p id="%E5%89%8D%E8%A8%80-toc" style="margin-left:0px;"><a href="#%E5%89%8D%E8%A8%80" rel="nofollow">一. 修改 ubuntu 配置</a></p> 
<p id="%E5%85%B3%E9%97%AD%20swap%20%E5%86%85%E5%AD%98-toc" style="margin-left:40px;"><a href="#%E5%85%B3%E9%97%AD%20swap%20%E5%86%85%E5%AD%98" rel="nofollow">关闭 swap 内存</a></p> 
<p id="%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95-toc" style="margin-left:0px;"><a href="#%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95" rel="nofollow">配置免密登录</a></p> 
<p id="%E4%BA%8C.%20%E5%AE%89%E8%A3%85%20docker-toc" style="margin-left:0px;"><a href="#%E4%BA%8C.%20%E5%AE%89%E8%A3%85%20docker" rel="nofollow">二. 安装 docker</a></p> 
<p id="docker%20%E7%9A%84%E5%AE%89%E8%A3%85-toc" style="margin-left:40px;"><a href="#docker%20%E7%9A%84%E5%AE%89%E8%A3%85" rel="nofollow">docker 的安装</a></p> 
<p id="docker%20%E7%9A%84%E9%85%8D%E7%BD%AE-toc" style="margin-left:40px;"><a href="#docker%20%E7%9A%84%E9%85%8D%E7%BD%AE" rel="nofollow">docker 的配置</a></p> 
<p id="%E4%B8%89.%20%E5%AE%89%E8%A3%85%20k8s-toc" style="margin-left:0px;"><a href="#%E4%B8%89.%20%E5%AE%89%E8%A3%85%20k8s" rel="nofollow">三. 安装 k8s</a></p> 
<p id="%E5%9B%9B.%20%E5%AE%89%E8%A3%85%20master%20%E8%8A%82%E7%82%B9-toc" style="margin-left:0px;"><a href="#%E5%9B%9B.%20%E5%AE%89%E8%A3%85%20master%20%E8%8A%82%E7%82%B9" rel="nofollow">四. 安装 master 节点</a></p> 
<p id="%E5%88%9D%E5%A7%8B%E5%8C%96%20master%20%E8%8A%82%E7%82%B9-toc" style="margin-left:40px;"><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%20master%20%E8%8A%82%E7%82%B9" rel="nofollow">初始化 master 节点</a></p> 
<p id="%E9%85%8D%E7%BD%AE%20kubectl%20%E5%B7%A5%E5%85%B7-toc" style="margin-left:40px;"><a href="#%E9%85%8D%E7%BD%AE%20kubectl%20%E5%B7%A5%E5%85%B7" rel="nofollow">配置 kubectl 工具</a></p> 
<p id="%E9%83%A8%E7%BD%B2%20flannel%20%E7%BD%91%E7%BB%9C-toc" style="margin-left:40px;"><a href="#%E9%83%A8%E7%BD%B2%20flannel%20%E7%BD%91%E7%BB%9C" rel="nofollow">部署 flannel 网络</a></p> 
<p id="%E4%BA%94.%20%E5%B0%86%20slave%20%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E7%BD%91%E7%BB%9C-toc" style="margin-left:0px;"><a href="#%E4%BA%94.%20%E5%B0%86%20slave%20%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E7%BD%91%E7%BB%9C" rel="nofollow">五. 将 slave 节点加入网络</a></p> 
<p id="%E9%BB%98%E8%AE%A4%E7%BD%91%E5%8D%A1%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D-toc" style="margin-left:0px;"><a href="#%E9%BB%98%E8%AE%A4%E7%BD%91%E5%8D%A1%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D" rel="nofollow">默认网卡问题修复</a></p> 
<p id="%E4%BF%AE%E6%94%B9%20kubelet%20%E9%BB%98%E8%AE%A4%E5%9C%B0%E5%9D%80-toc" style="margin-left:40px;"><a href="#%E4%BF%AE%E6%94%B9%20kubelet%20%E9%BB%98%E8%AE%A4%E5%9C%B0%E5%9D%80" rel="nofollow">修改 kubelet 默认地址</a></p> 
<p id="%E4%BF%AE%E6%94%B9%20flannel%20%E7%9A%84%E9%BB%98%E8%AE%A4%E7%BD%91%E5%8D%A1-toc" style="margin-left:40px;"><a href="#%E4%BF%AE%E6%94%B9%20flannel%20%E7%9A%84%E9%BB%98%E8%AE%A4%E7%BD%91%E5%8D%A1" rel="nofollow">修改 flannel 的默认网卡</a></p> 
<p id="%E9%87%8D%E7%BD%AE%E8%8A%82%E7%82%B9-toc" style="margin-left:0px;"><a href="#%E9%87%8D%E7%BD%AE%E8%8A%82%E7%82%B9" rel="nofollow">重置节点</a></p> 
<p id="%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-toc" style="margin-left:0px;"><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" rel="nofollow">常见问题</a></p> 
<p id="%E6%80%BB%E7%BB%93-toc" style="margin-left:0px;"><a href="#%E6%80%BB%E7%BB%93" rel="nofollow">总结</a></p> 
<p id="%E5%8F%82%E8%80%83-toc" style="margin-left:0px;"><a href="#%E5%8F%82%E8%80%83" rel="nofollow">参考</a></p> 
<hr id="hr-toc"> 
<p><span style="color:#fe2c24;">要注意，对于1.24之上的k8s版本，默认使用安装是contained，要使用docker需要另外安装cri</span></p> 
<h2></h2> 
<h2 id="%E6%8F%90%E5%89%8D%E5%AE%89%E8%A3%85">提前安装</h2> 
<pre><code>apt-get install -y curl &amp;&amp; apt-get install -y vim</code></pre> 
<h2 id="%E5%89%8D%E8%A8%80"><br> 一. 修改 ubuntu 配置</h2> 
<p>首先，k8s 要求我们的 ubuntu 进行一些符合它要求的配置。</p> 
<p><strong>1.关闭 <code>Swap</code> 内存</strong></p> 
<p><strong>2.配置免密登录</strong></p> 
<p></p> 
<h3 id="%E5%85%B3%E9%97%AD%20swap%20%E5%86%85%E5%AD%98">关闭 swap 内存</h3> 
<p> k8s 的较新版本都要求关闭<code>swap，</code>修改<code>/etc/fstab</code>文件：</p> 
<pre><code>sudo vi /etc/fstab
</code></pre> 
<p><span style="color:#fe2c24;">把下列内容第二条用<code>#</code>注释掉就好了，第一条别注释了，不然重启之后系统有可能会报<code>file system read-only</code>错误。</span></p> 
<pre><code>UUID=e2048966-750b-4795-a9a2-7b477d6681bf /   ext4    errors=remount-ro 0    1
# /dev/fd0        /media/floppy0  auto    rw,user,noauto,exec,utf8 0       0
</code></pre> 
<p>ubuntu 22 注释掉 /swap 开头的一行</p> 
<p><img alt="" height="373" src="https://images2.imgbox.com/67/03/6Jl7rE2I_o.png" width="1161"></p> 
<p>reboot重启，如果top显示如下即成功</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/61/60/ZZ4oshFT_o.png"></p> 
<p></p> 
<h2 id="%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95">配置免密登录</h2> 
<p>k8s 要求 <strong>管理节点可以直接免密登录工作节点</strong> 的原因是：在集群搭建完成后，管理节点的 kubelet 需要登陆工作节点进行操作。而至于怎么操作很简单，这里就不详提了，可以参见文章 <a href="https://www.jianshu.com/p/e6684182471b" rel="nofollow" title="virtualbox 虚拟机组网">virtualbox 虚拟机组网</a> 的最后一个章节 <strong>免密钥登录</strong> 。</p> 
<h2 id="%E4%BA%8C.%20%E5%AE%89%E8%A3%85%20docker">二. 安装 docker</h2> 
<p>docker 是 k8s 的基础，在安装完成之后也需要修改一些配置来适配 k8s ，所以本章分为 <strong>docker 的安装</strong> 与 <strong>docker 的配置</strong> 两部分。如果你已经安装并使用了一段时间的 docker 了话，建议使用<code>docker -v</code>查看已安装的 docker 版本，并在 k8s 官网上查询适合该版本的 k8s 进行安装。这一步两台主机都需要进行安装。</p> 
<h3 id="docker%20%E7%9A%84%E5%AE%89%E8%A3%85">docker 的安装</h3> 
<p>docker 在 ubuntu 的安装上真是再简单不过了，执行如下命令即可，在安装之前请记得把镜像源切换到国内。</p> 
<pre><code>sudo apt install docker.io
</code></pre> 
<p>等安装完成之后使用<code>docker -v</code>来验证 docker是否可用。</p> 
<h3 id="docker%20%E7%9A%84%E9%85%8D%E7%BD%AE">docker 的配置</h3> 
<p>安装完成之后需要进行一些配置，包括 <strong>切换docker下载源为国内镜像站</strong> 以及 <strong>修改cgroups</strong>。</p> 
<p>这个<code>cgroups</code>是啥呢，你可以把它理解成一个进程隔离工具，<code>docker</code>就是用它来实现容器的隔离的。docker 默认使用的是<code>cgroupfs</code>，而 k8s 也用到了一个进程隔离工具<code>systemd</code>，如果使用两个隔离组的话可能会引起异常，所以我们要把 docker 的也改成<code>systemd</code>。</p> 
<p>这两者都是在<code>/etc/docker/daemon.json</code>里修改的，所以我们一起配置了就好了，首先执行下述命令编辑<code>daemon.json</code>：</p> 
<pre><code>sudo vim /etc/docker/daemon.json
</code></pre> 
<p>打开后输入以下内容：</p> 
<pre><code>{
  "registry-mirrors": [
    "https://registry.docker-cn.com"
  ],
  "exec-opts": [ "native.cgroupdriver=systemd" ]
}
</code></pre> 
<p>然后<code>:wq</code>保存后重启 docker：</p> 
<pre><code>sudo systemctl daemon-reload
sudo systemctl restart docker
</code></pre> 
<p>然后就可以通过<code>docker info | grep Cgroup</code>来查看修改后的 docker cgroup 状态，发现变为<code>systemd</code>即为修改成功。</p> 
<h2 id="%E4%B8%89.%20%E5%AE%89%E8%A3%85%20k8s">三. 安装 k8s</h2> 
<p>安装完了 docker 就可以下载 k8s 的三个主要组件<code>kubelet</code>、<code>kubeadm</code>以及<code>kubectl</code>了。这一步两台主机都需要进行安装。先来简单介绍一下这三者：</p> 
<ul><li><code>kubelet</code>: k8s 的核心服务</li><li><code>kubeadm</code>: 这个是用于快速安装 k8s 的一个集成工具，我们在<code>master1</code>和<code>worker1</code>上的 k8s 部署都将使用它来完成。</li><li><code>kubectl</code>: k8s 的命令行工具，部署完成之后后续的操作都要用它来执行</li></ul> 
<p>其实这三个的下载很简单，直接用<code>apt-get</code>就好了，但是因为某些原因，它们的下载地址不存在了。所以我们需要用国内的镜像站来下载，也很简单，依次执行下面五条命令即可：</p> 
<pre><code># 使得 apt 支持 ssl 传输
apt-get update &amp;&amp; apt-get install -y apt-transport-https
# 下载 gpg 密钥
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - 
# 添加 k8s 镜像源
cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF
# 更新源列表
apt-get update
# 下载 kubectl，kubeadm以及 kubelet
# apt-get install -y kubelet kubeadm kubectl 现在会下载最新版本，最新版使用contained
apt-get install -y kubelet=1.23.6-00 kubeadm=1.23.6-00 kubectl=1.23.6-00
</code></pre> 
<p>直接在<code>/etc/apt/sources.list</code>里添加<code>https://mirrors.aliyun.com/kubernetes/apt/</code>是不行的，因为这个阿里镜像站使用的<code>ssl</code>进行传输的，所以要先安装<code>apt-transport-https</code>并下载镜像站的密钥才可以进行下载。</p> 
<h2 id="%E5%9B%9B.%20%E5%AE%89%E8%A3%85%20master%20%E8%8A%82%E7%82%B9">四. 安装 master 节点</h2> 
<p>下载完成后就要迎来重头戏了，初始化<code>master</code>节点，这一章节只需要在管理节点上配置即可，大致可以分为如下几步：</p> 
<ul><li>初始化<code>master</code>节点</li><li>部署<code>flannel</code>网络</li><li>配置<code>kubectl</code>工具</li></ul> 
<h3 id="%E5%88%9D%E5%A7%8B%E5%8C%96%20master%20%E8%8A%82%E7%82%B9">初始化 master 节点</h3> 
<p>运行下列命令，其中<code>--apiserver-advertise-address</code>参数的<span style="color:#fe2c24;"> ip 地址修改为自己的<code>master</code>主机地址</span>，然后再执行。</p> 
<pre><code>kubeadm init \
--apiserver-advertise-address=192.168.56.11 \
--image-repository registry.aliyuncs.com/google_containers \
--pod-network-cidr=10.244.0.0/16
</code></pre> 
<p>这里介绍一下一些常用参数的含义：</p> 
<ul><li><code>--apiserver-advertise-address</code>: k8s 中的主要服务<code>apiserver</code>的部署地址，填自己的管理节点 ip</li><li><code>--image-repository</code>: 拉取的 docker 镜像源，因为初始化的时候<code>kubeadm</code>会去拉 k8s 的很多组件来进行部署，所以需要指定国内镜像源，下不然会拉取不到镜像。</li><li><code>--pod-network-cidr</code>: 这个是 k8s 采用的节点网络，因为我们将要使用<code>flannel</code>作为 k8s 的网络，所以这里填<code>10.244.0.0/16</code>就好</li><li><code>--kubernetes-version</code>: 这个是用来指定你要部署的 k8s 版本的，一般不用填，不过如果初始化过程中出现了因为版本不对导致的安装错误的话，可以用这个参数手动指定。</li><li><code>--ignore-preflight-errors</code>: 忽略初始化时遇到的错误，比如说我想忽略 cpu 数量不够 2 核引起的错误，就可以用<code>--ignore-preflight-errors=CpuNum</code>。错误名称在初始化错误时会给出来。</li></ul> 
<p>当你看到如下字样是，就说明初始化成功了，<strong>请把最后那行以<code>kubeadm join</code>开头的命令复制下来，之后安装工作节点时要用到的</strong>，如果你不慎遗失了该命令，可以在<code>master</code>节点上使用<code>kubeadm token create --print-join-command</code>命令来重新生成一条。</p> 
<p></p> 
<pre><code>Your Kubernetes master has initialized successfully!
 
To start using your cluster, you need to run the following as a regular user:
 
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
 
You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/
 
You can now join any number of machines by running the following on each node
as root:
 
kubeadm join 192.168.56.11:6443 --token wbryr0.am1n476fgjsno6wa --discovery-token-ca-cert-hash sha256:7640582747efefe7c2d537655e428faa6275dbaff631de37822eb8fd4c054807
</code></pre> 
<p>如果在初始化过程中出现了任何<code>Error</code>导致初始化终止了，使用<code>kubeadm reset</code>重置之后再重新进行初始化。</p> 
<h3 id="%E9%85%8D%E7%BD%AE%20kubectl%20%E5%B7%A5%E5%85%B7">配置 kubectl 工具</h3> 
<p>这一步就比较简单了，直接执行如下命令即可：</p> 
<pre><code>mkdir -p /root/.kube &amp;&amp; \
cp /etc/kubernetes/admin.conf /root/.kube/config
</code></pre> 
<p>执行完成后并不会刷新出什么信息，可以通过下面两条命令测试 <code>kubectl</code>是否可用：</p> 
<pre><code># 查看已加入的节点
kubectl get nodes
# 查看集群状态
kubectl get cs
</code></pre> 
<h3 id="%E9%83%A8%E7%BD%B2%20flannel%20%E7%BD%91%E7%BB%9C">部署 flannel 网络</h3> 
<p><code>flannel</code>是什么？它是一个专门为 k8s 设置的网络规划服务，可以让集群中的不同节点主机创建的 docker 容器都具有全集群唯一的虚拟IP地址。想要部署<code>flannel</code>的话直接执行下述命令即可：</p> 
<p></p> 
<pre><code>kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</code></pre> 
<p>输出如下内容即为安装完成：</p> 
<pre><code>clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.extensions/kube-flannel-ds-amd64 created
daemonset.extensions/kube-flannel-ds-arm64 created
daemonset.extensions/kube-flannel-ds-arm created
daemonset.extensions/kube-flannel-ds-ppc64le created
daemonset.extensions/kube-flannel-ds-s390x created
</code></pre> 
<p>至此，k8s 管理节点部署完成。</p> 
<h2 id="%E4%BA%94.%20%E5%B0%86%20slave%20%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E7%BD%91%E7%BB%9C">五. 将 slave 节点加入网络</h2> 
<p>首先需要重复步骤 1 ~ 3 来安装 docker 、k8s 以及修改服务器配置，之后执行从步骤 4 中保存的命令即可完成加入，注意，这条命令每个人的都不一样，不要直接复制执行：</p> 
<p></p> 
<pre><code>kubeadm join 192.168.56.11:6443 --token wbryr0.am1n476fgjsno6wa --discovery-token-ca-cert-hash sha256:7640582747efefe7c2d537655e428faa6275dbaff631de37822eb8fd4c054807
</code></pre> 
<p>待控制台中输出以下内容后即为加入成功：</p> 
<p></p> 
<pre><code>This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.
Run 'kubectl get nodes' on the master to see this node join the cluster.
</code></pre> 
<p>随后登录<code>master1</code>查看已加入节点状态，可以看到<code>worker1</code>已加入，并且状态均为就绪。至此，k8s 搭建完成：</p> 
<p></p> 
<pre><code>root@master1:~# kubectl get nodes
NAME      STATUS   ROLES    AGE    VERSION
master1   Ready    master   145m   v1.15.0
worker1   Ready    &lt;none&gt;   87m    v1.15.0
</code></pre> 
<h2 id="%E9%BB%98%E8%AE%A4%E7%BD%91%E5%8D%A1%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D">默认网卡问题修复</h2> 
<p>如果你是使用<code>virtualBox</code>部署的虚拟机，并且虚拟机直接无法使用网卡1的 ip 地址互相访问的话（<em>例如组建双网卡，网卡1为 NAT 地址转换用来上网，网卡2为<code>Host-only</code>，用于虚拟机之间访问</em>）。就需要执行本节的内容来修改 k8s 的默认网卡。不然会出现一些命令无法使用的问题。如果你的默认网卡可以进行虚拟机之间的相互访问，则没有该问题。</p> 
<h3 id="%E4%BF%AE%E6%94%B9%20kubelet%20%E9%BB%98%E8%AE%A4%E5%9C%B0%E5%9D%80">修改 kubelet 默认地址</h3> 
<p>访问<code>kubelet</code>配置文件：</p> 
<p></p> 
<pre><code>sudo vi /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</code></pre> 
<p>在最后一行<code>ExecStart</code> <strong>之前</strong> 添加如下内容：</p> 
<p></p> 
<pre><code>Environment="KUBELET_EXTRA_ARGS=--node-ip=192.168.56.21"
</code></pre> 
<p>重启<code>kubelet</code>：</p> 
<p></p> 
<pre><code>systemctl stop kubelet.service &amp;&amp; \
systemctl daemon-reload &amp;&amp; \
systemctl start kubelet.service
</code></pre> 
<p>至此修改完成，更多信息详见 <a href="https://www.jianshu.com/p/fd9941c21e55" rel="nofollow" title="kubectl logs、exec、port-forward 执行失败问题解决">kubectl logs、exec、port-forward 执行失败问题解决</a> 。</p> 
<h3 id="%E4%BF%AE%E6%94%B9%20flannel%20%E7%9A%84%E9%BB%98%E8%AE%A4%E7%BD%91%E5%8D%A1">修改 flannel 的默认网卡</h3> 
<p>编辑<code>flannel</code>配置文件</p> 
<p></p> 
<pre><code>sudo kubectl edit daemonset kube-flannel-ds-amd64 -n kube-system
</code></pre> 
<p>找到<code>spec.template.spec.containers.args</code>字段并添加<code>--iface=网卡名</code>，例如我的网卡是<code>enp0s8</code>：</p> 
<p></p> 
<pre><code>- args:
  - --ip-masq
  - --kube-subnet-mgr
  # 添加到这里
  - --iface=enp0s8
</code></pre> 
<p><code>:wq</code>保存修改后输入以下内容删除所有 flannel，k8s 会自动重建：</p> 
<p></p> 
<pre><code>kubectl delete pod -n kube-system -l app=flannel
</code></pre> 
<p>至此修改完成，更多内容请见 <a href="https://www.jianshu.com/p/ed1ae8443fff" rel="nofollow" title="解决k8s无法通过svc访问其他节点pod的问题">解决k8s无法通过svc访问其他节点pod的问题</a> 。</p> 
<h2 id="%E9%87%8D%E7%BD%AE%E8%8A%82%E7%82%B9">重置节点</h2> 
<p>如果子节点需要重新加入到其他节点，还需要在kubeadm reset后，执行下面命令，不然会出现奇奇怪怪问题，比如cni0没删除，或者创建pod起不来</p> 
<pre><code>ifconfig cni0 down    
ip link delete cni0

systemctl stop kubelet
systemctl stop docker
kubeadm reset
rm -rf /var/lib/cni/
rm -rf /var/lib/kubelet/*
rm -rf /etc/cni/
##重启kubelet
systemctl restart kubelet
##重启docker
systemctl restart docker
</code></pre> 
<h2 id="%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">常见问题</h2> 
<p>1.节点名重复</p> 
<p>可以使用下列命令，来完成主机名字修改</p> 
<pre><code>sudo hostnamectl set-hostname newhostname</code></pre> 
<h2 id="%E6%80%BB%E7%BB%93">总结</h2> 
<p>至此你应该已经搭建好了一个完整可用的双节点 k8s 集群了。接下来你可以通过如下内容继续深入 k8s，排名分先后，推荐依次阅读：</p> 
<ul><li><a href="https://www.jianshu.com/p/80c88ae38396" rel="nofollow" title="让你的 k8s 使用更简单">让你的 k8s 使用更简单</a></li><li><a href="https://www.jianshu.com/p/8d60ce1587e1" rel="nofollow" title="k8s 基本使用">k8s 基本使用</a></li><li><a href="https://www.jianshu.com/p/132319e795ae" rel="nofollow" title="k8s 如何让你的应用活的更久">k8s 如何让你的应用活的更久</a></li></ul> 
<h2 id="%E5%8F%82%E8%80%83">参考</h2> 
<ul><li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwww.kubernetes.org.cn%2F5462.html" rel="nofollow" title="kubeadm安装Kubernetes 1.14最佳实践">kubeadm安装Kubernetes 1.14最佳实践</a></li><li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwww.cnblogs.com%2Fhongdada%2Fp%2F9771857.html" rel="nofollow" title="Docker中的Cgroup Driver:Cgroupfs 与 Systemd">Docker中的Cgroup Driver:Cgroupfs 与 Systemd</a></li><li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Fqq_14845119%2Farticle%2Fdetails%2F83349471" rel="nofollow" title="Ubuntu16.04搭建Kubernetes">Ubuntu16.04搭建Kubernetes</a></li><li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Fhuwh_%2Farticle%2Fdetails%2F77899108" rel="nofollow" title="Flannel介绍">Flannel介绍</a></li><li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fkubernetes.io%2Fdocs%2Fhome%2F" rel="nofollow" title="k8s 官方文档">k8s 官方文档</a></li></ul> 
<p><br>  </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f43c4752ce904fe8c7f9e9da5fc4f47b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何判断从本机上传到服务器的文件数据内容是一致的？用md5加密算法！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b1d69494316f73f4e16da1a82c84955a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">（三）正点原子I.MX6ULL kernel6.1挂根文件系统</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>