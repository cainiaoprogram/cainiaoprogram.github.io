<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>tvm tutorial (1.1) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="tvm tutorial (1.1)" />
<meta property="og:description" content="接着上次 tensor_expr_get_started.py 没记录完的部分继续
剩下的代码如下，给出的样例是Nvidia GPU设备端的代码
run_cuda = False if run_cuda: # Change this target to the correct backend for you gpu. For example: cuda (NVIDIA GPUs), # rocm (Radeon GPUS), OpenCL (opencl). tgt_gpu = tvm.target.Target(target=&#34;cuda&#34;, host=&#34;llvm&#34;) # Recreate the schedule n = te.var(&#34;n&#34;) A = te.placeholder((n,), name=&#34;A&#34;) B = te.placeholder((n,), name=&#34;B&#34;) C = te.compute(A.shape, lambda i: A[i] &#43; B[i], name=&#34;C&#34;) s = te.create_schedule(C.op) bx, tx = s[C].split(C.op.axis[0], factor=64) ################################################################################ # Finally we must bind the iteration axis bx and tx to threads in the GPU # compute grid." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/87b19936100c82c4c1df7dd15dae6f73/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-09T10:49:33+08:00" />
<meta property="article:modified_time" content="2022-02-09T10:49:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">tvm tutorial (1.1)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>接着上次 tensor_expr_get_started.py 没记录完的部分继续</p> 
<p>剩下的代码如下，给出的样例是Nvidia GPU设备端的代码</p> 
<pre><code class="prism language-python">run_cuda <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">if</span> run_cuda<span class="token punctuation">:</span>
    <span class="token comment"># Change this target to the correct backend for you gpu. For example: cuda (NVIDIA GPUs),</span>
    <span class="token comment"># rocm (Radeon GPUS), OpenCL (opencl).</span>
    tgt_gpu <span class="token operator">=</span> tvm<span class="token punctuation">.</span>target<span class="token punctuation">.</span>Target<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"llvm"</span><span class="token punctuation">)</span>

    <span class="token comment"># Recreate the schedule</span>
    n <span class="token operator">=</span> te<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token string">"n"</span><span class="token punctuation">)</span>
    A <span class="token operator">=</span> te<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"A"</span><span class="token punctuation">)</span>
    B <span class="token operator">=</span> te<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"B"</span><span class="token punctuation">)</span>
    C <span class="token operator">=</span> te<span class="token punctuation">.</span>compute<span class="token punctuation">(</span>A<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> <span class="token keyword">lambda</span> i<span class="token punctuation">:</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> B<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"C"</span><span class="token punctuation">)</span>

    s <span class="token operator">=</span> te<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>

    bx<span class="token punctuation">,</span> tx <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token comment">################################################################################</span>
    <span class="token comment"># Finally we must bind the iteration axis bx and tx to threads in the GPU</span>
    <span class="token comment"># compute grid. The naive schedule is not valid for GPUs, and these are</span>
    <span class="token comment"># specific constructs that allow us to generate code that runs on a GPU.</span>

    s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>bind<span class="token punctuation">(</span>bx<span class="token punctuation">,</span> te<span class="token punctuation">.</span>thread_axis<span class="token punctuation">(</span><span class="token string">"blockIdx.x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>bind<span class="token punctuation">(</span>tx<span class="token punctuation">,</span> te<span class="token punctuation">.</span>thread_axis<span class="token punctuation">(</span><span class="token string">"threadIdx.x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">######################################################################</span>
    <span class="token comment"># Compilation</span>
    <span class="token comment"># -----------</span>
    <span class="token comment"># After we have finished specifying the schedule, we can compile it</span>
    <span class="token comment"># into a TVM function. By default TVM compiles into a type-erased</span>
    <span class="token comment"># function that can be directly called from the python side.</span>
    <span class="token comment">#</span>
    <span class="token comment"># In the following line, we use tvm.build to create a function.</span>
    <span class="token comment"># The build function takes the schedule, the desired signature of the</span>
    <span class="token comment"># function (including the inputs and outputs) as well as target language</span>
    <span class="token comment"># we want to compile to.</span>
    <span class="token comment">#</span>
    <span class="token comment"># The result of compilation fadd is a GPU device function (if GPU is</span>
    <span class="token comment"># involved) as well as a host wrapper that calls into the GPU</span>
    <span class="token comment"># function. fadd is the generated host wrapper function, it contains</span>
    <span class="token comment"># a reference to the generated device function internally.</span>

    fadd <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>tgt_gpu<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"myadd"</span><span class="token punctuation">)</span>

    <span class="token comment">################################################################################</span>
    <span class="token comment"># The compiled TVM function is exposes a concise C API that can be invoked from</span>
    <span class="token comment"># any language.</span>
    <span class="token comment">#</span>
    <span class="token comment"># We provide a minimal array API in python to aid quick testing and prototyping.</span>
    <span class="token comment"># The array API is based on the `DLPack &lt;https://github.com/dmlc/dlpack&gt;`_ standard.</span>
    <span class="token comment">#</span>
    <span class="token comment"># - We first create a GPU device.</span>
    <span class="token comment"># - Then tvm.nd.array copies the data to the GPU.</span>
    <span class="token comment"># - ``fadd`` runs the actual computation</span>
    <span class="token comment"># - ``numpy()`` copies the GPU array back to the CPU (so we can verify correctness).</span>
    <span class="token comment">#</span>
    <span class="token comment"># Note that copying the data to and from the memory on the GPU is a required step.</span>

    dev <span class="token operator">=</span> tvm<span class="token punctuation">.</span>device<span class="token punctuation">(</span>tgt_gpu<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    n <span class="token operator">=</span> <span class="token number">1024</span>
    a <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span>size<span class="token operator">=</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>A<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>
    b <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span>size<span class="token operator">=</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>B<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>
    c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>n<span class="token punctuation">,</span> dtype<span class="token operator">=</span>C<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>
    fadd<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
    tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">################################################################################</span>
    <span class="token comment"># Inspect the Generated GPU Code</span>
    <span class="token comment"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
    <span class="token comment"># You can inspect the generated code in TVM. The result of tvm.build is a TVM</span>
    <span class="token comment"># Module. fadd is the host module that contains the host wrapper, it also</span>
    <span class="token comment"># contains a device module for the CUDA (GPU) function.</span>
    <span class="token comment">#</span>
    <span class="token comment"># The following code fetches the device module and prints the content code.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        tgt_gpu<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"cuda"</span>
        <span class="token keyword">or</span> tgt_gpu<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"rocm"</span>
        <span class="token keyword">or</span> tgt_gpu<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"opencl"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        dev_module <span class="token operator">=</span> fadd<span class="token punctuation">.</span>imported_modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-----GPU code-----"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>dev_module<span class="token punctuation">.</span>get_source<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fadd<span class="token punctuation">.</span>get_source<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p>其中比较重要的是下面几行代码</p> 
<pre><code class="prism language-python"> bx<span class="token punctuation">,</span> tx <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>

<span class="token comment">################################################################################</span>
<span class="token comment"># Finally we must bind the iteration axis bx and tx to threads in the GPU</span>
<span class="token comment"># compute grid. The naive schedule is not valid for GPUs, and these are</span>
<span class="token comment"># specific constructs that allow us to generate code that runs on a GPU.</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>bind<span class="token punctuation">(</span>bx<span class="token punctuation">,</span> te<span class="token punctuation">.</span>thread_axis<span class="token punctuation">(</span><span class="token string">"blockIdx.x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>bind<span class="token punctuation">(</span>tx<span class="token punctuation">,</span> te<span class="token punctuation">.</span>thread_axis<span class="token punctuation">(</span><span class="token string">"threadIdx.x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里需要了解cuda的编程模型，上面的<code>split</code>操作将循环分成的两个嵌套循环。<br> 其中<code>factor</code>为64，内层循环为64，这里将cuda中<code>threadIdx</code>绑定到内层循环中，将<code>blockIdx</code>绑定的外层循环上。</p> 
<p>其余部分没有什么区别，进行编译运行，最后生成代码的部分如下：</p> 
<pre><code class="prism language-python">    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        tgt_gpu<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"cuda"</span>
        <span class="token keyword">or</span> tgt_gpu<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"rocm"</span>
        <span class="token keyword">or</span> tgt_gpu<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"opencl"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        dev_module <span class="token operator">=</span> fadd<span class="token punctuation">.</span>imported_modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-----GPU code-----"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>dev_module<span class="token punctuation">.</span>get_source<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fadd<span class="token punctuation">.</span>get_source<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>根据使用不同的设备，会生成对应不同设备端的代码，也包括host端的代码</p> 
<h2><a id="_124"></a>保存与加载模型</h2> 
<pre><code class="prism language-python"><span class="token comment">################################################################################</span>
<span class="token comment"># Saving and Loading Compiled Modules</span>
<span class="token comment"># -----------------------------------</span>
<span class="token comment"># Besides runtime compilation, we can save the compiled modules into a file and</span>
<span class="token comment"># load them back later.</span>
<span class="token comment">#</span>
<span class="token comment"># The following code first performs the following steps:</span>
<span class="token comment">#</span>
<span class="token comment"># - It saves the compiled host module into an object file.</span>
<span class="token comment"># - Then it saves the device module into a ptx file.</span>
<span class="token comment"># - cc.create_shared calls a compiler (gcc) to create a shared library</span>

<span class="token keyword">from</span> tvm<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> cc
<span class="token keyword">from</span> tvm<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> utils

temp <span class="token operator">=</span> utils<span class="token punctuation">.</span>tempdir<span class="token punctuation">(</span><span class="token punctuation">)</span>
fadd<span class="token punctuation">.</span>save<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.o"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> tgt<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"cuda"</span><span class="token punctuation">:</span>
    fadd<span class="token punctuation">.</span>imported_modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.ptx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> tgt<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"rocm"</span><span class="token punctuation">:</span>
    fadd<span class="token punctuation">.</span>imported_modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.hsaco"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> tgt<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"opencl"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    fadd<span class="token punctuation">.</span>imported_modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.cl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
cc<span class="token punctuation">.</span>create_shared<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.so"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.o"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">################################################################################</span>
<span class="token comment"># .. note:: Module Storage Format</span>
<span class="token comment">#</span>
<span class="token comment">#   The CPU (host) module is directly saved as a shared library (.so). There</span>
<span class="token comment">#   can be multiple customized formats of the device code. In our example, the</span>
<span class="token comment">#   device code is stored in ptx, as well as a meta data json file. They can be</span>
<span class="token comment">#   loaded and linked separately via import.</span>

<span class="token comment">################################################################################</span>
<span class="token comment"># Load Compiled Module</span>
<span class="token comment"># ~~~~~~~~~~~~~~~~~~~~</span>
<span class="token comment"># We can load the compiled module from the file system and run the code. The</span>
<span class="token comment"># following code loads the host and device module separately and links them</span>
<span class="token comment"># together. We can verify that the newly loaded function works.</span>

fadd1 <span class="token operator">=</span> tvm<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>load_module<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.so"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> tgt<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"cuda"</span><span class="token punctuation">:</span>
    fadd1_dev <span class="token operator">=</span> tvm<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>load_module<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.ptx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fadd1<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span>fadd1_dev<span class="token punctuation">)</span>

<span class="token keyword">if</span> tgt<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"rocm"</span><span class="token punctuation">:</span>
    fadd1_dev <span class="token operator">=</span> tvm<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>load_module<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.hsaco"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fadd1<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span>fadd1_dev<span class="token punctuation">)</span>

<span class="token keyword">if</span> tgt<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"opencl"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    fadd1_dev <span class="token operator">=</span> tvm<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>load_module<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd.cl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fadd1<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span>fadd1_dev<span class="token punctuation">)</span>

fadd1<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">################################################################################</span>
<span class="token comment"># Pack Everything into One Library</span>
<span class="token comment"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="token comment"># In the above example, we store the device and host code separately. TVM also</span>
<span class="token comment"># supports export everything as one shared library. Under the hood, we pack</span>
<span class="token comment"># the device modules into binary blobs and link them together with the host</span>
<span class="token comment"># code. Currently we support packing of Metal, OpenCL and CUDA modules.</span>

fadd<span class="token punctuation">.</span>export_library<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd_pack.so"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
fadd2 <span class="token operator">=</span> tvm<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>load_module<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span><span class="token string">"myadd_pack.so"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
fadd2<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里看cuda模型，如果是使用nv的GPU，最后保存成PTX文件，里面是GPU的汇编代码。<br> 在后面可以使用<code>runtime</code>部分之家加载ptx文件并运行<br> 最后代码中的注释也提到，上面部分的程序是将host和device端部分的代码分离开保存的，也可以一起打包成动态库</p> 
<h2><a id="_202"></a>矩阵乘法优化</h2> 
<h3><a id="_205"></a>朴素方法</h3> 
<p>这部分代码使用TE优化矩阵乘法，主要以CPU为主（不错，电脑上没有GPU）<br> 矩阵乘法是一个计算密集型的OP，主要的优化手段包括两种（来自注释部分）：<br> 1.提高cache的命中率，要达到此目的需要改变访存的模式来适应cache的工作原理<br> 2.使用向量指令，通过循环优化，可以在LLVM 后端上lower成向量指令。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tvm
<span class="token keyword">import</span> tvm<span class="token punctuation">.</span>testing
<span class="token keyword">from</span> tvm <span class="token keyword">import</span> te
<span class="token keyword">import</span> numpy
<span class="token keyword">import</span> timeit

<span class="token comment"># The size of the matrix</span>
<span class="token comment"># (M, K) x (K, N)</span>
<span class="token comment"># You are free to try out different shapes, sometimes TVM optimization outperforms numpy with MKL.</span>
M <span class="token operator">=</span> <span class="token number">1024</span>
K <span class="token operator">=</span> <span class="token number">1024</span>
N <span class="token operator">=</span> <span class="token number">1024</span>

<span class="token comment"># The default tensor data type in tvm</span>
dtype <span class="token operator">=</span> <span class="token string">"float32"</span>

<span class="token comment"># You will want to adjust the target to match any CPU vector extensions you</span>
<span class="token comment"># might have. For example, if you're using using Intel AVX2 (Advanced Vector</span>
<span class="token comment"># Extensions) ISA for SIMD, you can get the best performance by changing the</span>
<span class="token comment"># following line to ``llvm -mcpu=core-avx2``, or specific type of CPU you use.</span>
<span class="token comment"># Recall that you're using llvm, you can get this information from the command</span>
<span class="token comment"># ``llc --version`` to get the CPU type, and you can check ``/proc/cpuinfo``</span>
<span class="token comment"># for additional extensions that your processor might support.</span>

target <span class="token operator">=</span> tvm<span class="token punctuation">.</span>target<span class="token punctuation">.</span>Target<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token string">"llvm"</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"llvm"</span><span class="token punctuation">)</span>
dev <span class="token operator">=</span> tvm<span class="token punctuation">.</span>device<span class="token punctuation">(</span>target<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment"># Random generated tensor for testing</span>
a <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>M<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>
b <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>K<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>

<span class="token comment"># Repeatedly perform a matrix multiplication to get a performance baseline</span>
<span class="token comment"># for the default numpy implementation</span>
np_repeat <span class="token operator">=</span> <span class="token number">100</span>
np_running_time <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span>
    setup<span class="token operator">=</span><span class="token string">"import numpy\n"</span>
    <span class="token string">"M = "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>
    <span class="token string">"K = "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>K<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>
    <span class="token string">"N = "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>
    <span class="token string">'dtype = "float32"\n'</span>
    <span class="token string">"a = numpy.random.rand(M, K).astype(dtype)\n"</span>
    <span class="token string">"b = numpy.random.rand(K, N).astype(dtype)\n"</span><span class="token punctuation">,</span>
    stmt<span class="token operator">=</span><span class="token string">"answer = numpy.dot(a, b)"</span><span class="token punctuation">,</span>
    number<span class="token operator">=</span>np_repeat<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Numpy running time: %f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>np_running_time <span class="token operator">/</span> np_repeat<span class="token punctuation">)</span><span class="token punctuation">)</span>

answer <span class="token operator">=</span> numpy<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>a<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">################################################################################</span>
<span class="token comment"># Now we write a basic matrix multiplication using TVM TE and verify that it</span>
<span class="token comment"># produces the same results as the numpy implementation. We also write a</span>
<span class="token comment"># function that will help us measure the performance of the schedule</span>
<span class="token comment"># optimizations.</span>

<span class="token comment"># TVM Matrix Multiplication using TE</span>
k <span class="token operator">=</span> te<span class="token punctuation">.</span>reduce_axis<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"k"</span><span class="token punctuation">)</span>
A <span class="token operator">=</span> te<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"A"</span><span class="token punctuation">)</span>
B <span class="token operator">=</span> te<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"B"</span><span class="token punctuation">)</span>
C <span class="token operator">=</span> te<span class="token punctuation">.</span>compute<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> te<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>x<span class="token punctuation">,</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> B<span class="token punctuation">[</span>k<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"C"</span><span class="token punctuation">)</span>

<span class="token comment"># Default schedule</span>
s <span class="token operator">=</span> te<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>
func <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">)</span>

c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>
func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>上面的代码使用了最原始的矩阵乘法计算的方式，对应的C++代码逻辑如下：</p> 
<pre><code class="prism language-cpp"><span class="token comment">// A[N][K] * B[K][M] = C[N][M]</span>
<span class="token keyword">void</span> <span class="token function">gemm_naive</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> A<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> B<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> C<span class="token punctuation">,</span> <span class="token keyword">int</span> N<span class="token punctuation">,</span> <span class="token keyword">int</span> M<span class="token punctuation">,</span> <span class="token keyword">int</span> K<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">memset</span><span class="token punctuation">(</span>C<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> N <span class="token operator">*</span> M<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> m <span class="token operator">&lt;</span> M<span class="token punctuation">;</span> m<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">float</span> tmp <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> K<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// C[n][m] += A[n][k] * B[k][m];</span>
                tmp <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>A <span class="token operator">+</span> n <span class="token operator">*</span> K <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>B <span class="token operator">+</span> k <span class="token operator">*</span> M <span class="token operator">+</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>C <span class="token operator">+</span> n <span class="token operator">*</span> M <span class="token operator">+</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面tvm代码生成的IR如下：</p> 
<pre><code class="prism language-python">primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0f32</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>A_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="blocking__tilling_320"></a>blocking &amp; tilling优化</h3> 
<p>什么是blocking tilling优化？实际上就是利用cache存储数据的局部性原理，增加连续访存，减少跳跃式访存带来的cache miss，从而提高运行效率。<br> 要实现连续性访存，且将局部数据放进cache里面，需要使用<code>tile</code>和<code>reorder</code>两种操作，经过<code>tile</code>后的数据块可以可以完整的填入cache。</p> 
<p>在CPU上，这种方法可以增加cache的命中率<br> tvm的代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># Optimization 1: Blocking</span>
<span class="token comment"># ~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="token comment">#</span>
<span class="token comment"># A important trick to enhance the cache hit rate is blocking, where you</span>
<span class="token comment"># structure memory access such that the inside a block is a small neighborhood</span>
<span class="token comment"># that has high memory locality. In this tutorial, we pick a block factor of</span>
<span class="token comment"># 32. This will result in a block that will fill a 32 * 32 * sizeof(float) area</span>
<span class="token comment"># of memory. This corresponds to a cache size of 4KB, in relation to a</span>
<span class="token comment"># reference cache size of 32 KB for L1 cache.</span>
<span class="token comment">#</span>
<span class="token comment"># We begin by creating a default schedule for the ``C`` operation, then apply a</span>
<span class="token comment"># ``tile`` scheduling primitive to it with the specified block factor, with the</span>
<span class="token comment"># scheduling primitive returning the resulting loop order from outermost to</span>
<span class="token comment"># innermost, as a vector ``[x_outer, y_outer, x_inner, y_inner]``. We then get</span>
<span class="token comment"># the reduction axis for output of the operation, and perform a split operation</span>
<span class="token comment"># on it using a factor of 4. This factor doesn't directly impact the blocking</span>
<span class="token comment"># optimization we're working on right now, but will be useful later when we</span>
<span class="token comment"># apply vectorization.</span>
<span class="token comment">#</span>
<span class="token comment"># Now that the operation has been blocked, we can reorder the computation to</span>
<span class="token comment"># put the reduction operation into the outermost loop of the computation,</span>
<span class="token comment"># helping to guarantee that the blocked data remains in cache. This completes</span>
<span class="token comment"># the schedule, and we can build and test the performance compared to the naive</span>
<span class="token comment"># schedule.</span>

bn <span class="token operator">=</span> <span class="token number">32</span>

<span class="token comment"># Blocking by loop tiling</span>
xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
<span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment"># Hoist reduction domain outside the blocking loop</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>

evaluate_operation<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">,</span> optimization<span class="token operator">=</span><span class="token string">"blocking"</span><span class="token punctuation">,</span> log<span class="token operator">=</span>log<span class="token punctuation">)</span>

<span class="token comment">################################################################################</span>
<span class="token comment"># By reordering the computation to take advantage of caching, you should see a</span>
<span class="token comment"># significant improvement in the performance of the computation. Now, print the</span>
<span class="token comment"># internal representation and compare it to the original:</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="tiling_374"></a>仅使用tiling</h4> 
<p>这里使用的<code>tile</code>的参数大小是32，即可以构造一个32×32大小的block填入到cache当中<br> 如果仅使用<code>tile</code>的schedule，得到的IR是这样的，inner的部分是tile的参数</p> 
<pre><code class="prism language-python">primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0f32</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>A_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>x.outer的stride是32768，即<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         y 
        
       
         . 
        
       
         o 
        
       
         u 
        
       
         t 
        
       
         e 
        
       
         r 
        
       
         ∗ 
        
       
         x 
        
       
         . 
        
       
         i 
        
       
         n 
        
       
         n 
        
       
         e 
        
       
         r 
        
       
         ∗ 
        
       
         y 
        
       
         . 
        
       
         i 
        
       
         n 
        
       
         n 
        
       
         e 
        
       
         r 
        
       
         = 
        
       
         32768 
        
       
      
        y.outer * x.inner * y.inner = 32768 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.80952em; vertical-align: -0.19444em;"></span><span style="margin-right: 0.03588em;" class="mord mathdefault">y</span><span class="mord">.</span><span class="mord mathdefault">o</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span style="margin-right: 0.02778em;" class="mord mathdefault">r</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.65952em; vertical-align: 0em;"></span><span class="mord mathdefault">x</span><span class="mord">.</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault">n</span><span class="mord mathdefault">e</span><span style="margin-right: 0.02778em;" class="mord mathdefault">r</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.85396em; vertical-align: -0.19444em;"></span><span style="margin-right: 0.03588em;" class="mord mathdefault">y</span><span class="mord">.</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault">n</span><span class="mord mathdefault">e</span><span style="margin-right: 0.02778em;" class="mord mathdefault">r</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">3</span><span class="mord">2</span><span class="mord">7</span><span class="mord">6</span><span class="mord">8</span></span></span></span></span></p> 
<p>对应的C++代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">gemm_tile</span><span class="token punctuation">(</span>T<span class="token operator">*</span> A<span class="token punctuation">,</span> T<span class="token operator">*</span> B<span class="token punctuation">,</span> T<span class="token operator">*</span> C<span class="token punctuation">,</span> <span class="token keyword">int</span> N<span class="token punctuation">,</span> <span class="token keyword">int</span> M<span class="token punctuation">,</span> <span class="token keyword">int</span> K<span class="token punctuation">,</span> <span class="token keyword">int</span> fac<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">memset</span><span class="token punctuation">(</span>C<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> N <span class="token operator">*</span> M<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n_outer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n_outer <span class="token operator">&lt;</span> <span class="token punctuation">(</span>N <span class="token operator">+</span> fac <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> fac<span class="token punctuation">;</span> n_outer<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m_outer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> m_outer <span class="token operator">&lt;</span> <span class="token punctuation">(</span>M <span class="token operator">+</span> fac <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> fac<span class="token punctuation">;</span> m_outer<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k_outer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k_outer <span class="token operator">&lt;</span> <span class="token punctuation">(</span>K <span class="token operator">+</span> fac <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> fac<span class="token punctuation">;</span> k_outer<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n_inner <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n_inner <span class="token operator">&lt;</span> fac<span class="token punctuation">;</span> n_inner<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> index_n <span class="token operator">=</span> n_outer <span class="token operator">*</span> fac <span class="token operator">+</span> n_inner<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>index_n <span class="token operator">&gt;=</span> N<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m_inner <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> m_inner <span class="token operator">&lt;</span> fac<span class="token punctuation">;</span> m_inner<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">int</span> index_m <span class="token operator">=</span> m_outer <span class="token operator">*</span> fac <span class="token operator">+</span> m_inner<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>index_m <span class="token operator">&gt;=</span> M<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k_inner <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k_inner <span class="token operator">&lt;</span> fac<span class="token punctuation">;</span> k_inner<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">int</span> index_k <span class="token operator">=</span> k_outer <span class="token operator">*</span> fac <span class="token operator">+</span> k_inner<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>index_k <span class="token operator">&gt;=</span> K<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

                            C<span class="token punctuation">[</span>index_n <span class="token operator">*</span> M <span class="token operator">+</span> index_m<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>A <span class="token operator">+</span> index_n <span class="token operator">*</span> K <span class="token operator">+</span> index_k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>B <span class="token operator">+</span> index_k <span class="token operator">*</span> M <span class="token operator">+</span> index_m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="reordering_434"></a>仅使用reordering</h4> 
<p>遍历方式如下：<br> <img src="https://images2.imgbox.com/1f/e6/Y9S8EN8J_o.jpg" alt="请添加图片描述"><br> 相比与朴素方法，遍历矩阵B时为按行索引，这样对数据的局部性很不友好，可以考虑将遍历矩阵B的方式改为按列遍历，仅使用reoroder的tvm代码如下：</p> 
<pre><code class="prism language-python">bn <span class="token operator">=</span> <span class="token number">32</span>
<span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>x<span class="token punctuation">,</span> k<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>生成的IR如下：</p> 
<pre><code class="prism language-python">primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0f32</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>A_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>c++实现代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">gemm_reordering</span><span class="token punctuation">(</span>T<span class="token operator">*</span> A<span class="token punctuation">,</span> T<span class="token operator">*</span> B<span class="token punctuation">,</span> T<span class="token operator">*</span> C<span class="token punctuation">,</span> <span class="token keyword">int</span> N<span class="token punctuation">,</span> <span class="token keyword">int</span> M<span class="token punctuation">,</span> <span class="token keyword">int</span> K<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">memset</span><span class="token punctuation">(</span>C<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> N <span class="token operator">*</span> M<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> K<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> m <span class="token operator">&lt;</span> M<span class="token punctuation">;</span> m<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                C<span class="token punctuation">[</span>n <span class="token operator">*</span> M <span class="token operator">+</span> m<span class="token punctuation">]</span> <span class="token operator">+=</span> A<span class="token punctuation">[</span>n <span class="token operator">*</span> K <span class="token operator">+</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> B<span class="token punctuation">[</span>k <span class="token operator">*</span> M <span class="token operator">+</span> m<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="reordering__tile_485"></a>reordering &amp; tile</h4> 
<p>把<code>reordering</code> 和 <code>tile</code>的策略结合起来</p> 
<pre><code class="prism language-python"><span class="token comment"># Blocking by loop tiling</span>
xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
<span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment">#</span>
<span class="token comment"># # Hoist reduction domain outside the blocking loop</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>得到的IR如下：</p> 
<pre><code class="prism language-python">primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0f32</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>A_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>相应的C++代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">gemm_reordering_tile</span><span class="token punctuation">(</span>T<span class="token operator">*</span> A<span class="token punctuation">,</span> T<span class="token operator">*</span> B<span class="token punctuation">,</span> T<span class="token operator">*</span> C<span class="token punctuation">,</span> <span class="token keyword">int</span> N<span class="token punctuation">,</span> <span class="token keyword">int</span> M<span class="token punctuation">,</span> <span class="token keyword">int</span> K<span class="token punctuation">,</span> <span class="token keyword">int</span> fac<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">memset</span><span class="token punctuation">(</span>C<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> N <span class="token operator">*</span> M<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n_outer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n_outer <span class="token operator">&lt;</span> <span class="token punctuation">(</span>N <span class="token operator">+</span> fac <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> fac<span class="token punctuation">;</span> n_outer<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k_outer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k_outer <span class="token operator">&lt;</span> <span class="token punctuation">(</span>K <span class="token operator">+</span> fac <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> fac<span class="token punctuation">;</span> k_outer<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m_outer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> m_outer <span class="token operator">&lt;</span> <span class="token punctuation">(</span>M <span class="token operator">+</span> fac <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> fac<span class="token punctuation">;</span> m_outer<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n_inner <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n_inner <span class="token operator">&lt;</span> fac<span class="token punctuation">;</span> n_inner<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> index_n <span class="token operator">=</span> n_outer <span class="token operator">*</span> fac <span class="token operator">+</span> n_inner<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>index_n <span class="token operator">&gt;=</span> N<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k_inner <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k_inner <span class="token operator">&lt;</span> fac<span class="token punctuation">;</span> k_inner<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">int</span> index_k <span class="token operator">=</span> k_outer <span class="token operator">*</span> fac <span class="token operator">+</span> k_inner<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>index_k <span class="token operator">&gt;=</span> K<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m_inner <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> m_inner <span class="token operator">&lt;</span> fac<span class="token punctuation">;</span> m_inner<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">int</span> index_m <span class="token operator">=</span> m_outer <span class="token operator">*</span> fac <span class="token operator">+</span> m_inner<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>index_m <span class="token operator">&gt;=</span> M<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

                            C<span class="token punctuation">[</span>index_n <span class="token operator">*</span> M <span class="token operator">+</span> index_m<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>A <span class="token operator">+</span> index_n <span class="token operator">*</span> K <span class="token operator">+</span> index_k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>B <span class="token operator">+</span> index_k <span class="token operator">*</span> M <span class="token operator">+</span> index_m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_562"></a>向量化</h4> 
<p>tvm中使用如下代码</p> 
<pre><code class="prism language-python">bn <span class="token operator">=</span> <span class="token number">32</span>

<span class="token comment"># Blocking by loop tiling</span>
xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
<span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment"># Hoist reduction domain outside the blocking loop</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yi<span class="token punctuation">)</span>
</code></pre> 
<p>注意上面的reorder的顺序，将yi放在了最后，将ki放在了xi和yi之前</p> 
<p>生成的IR如下：</p> 
<pre><code class="prism language-python">primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcast<span class="token punctuation">(</span><span class="token number">0f32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32x32<span class="token operator">*</span><span class="token punctuation">)</span>C_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>A_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>float32x32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可见上面的循环中少了对y.innder部分的循环，因为对y轴执行向量化操作</p> 
<p>这里暂时不实现向量指令的C++代码。（记得补上）</p> 
<h4><a id="_609"></a>循环重新排布</h4> 
<p>上面循环的排列对矩阵A访问存时，是按照列访问的（k_inner在最外)，cache hit利用率不高。</p> 
<p>TVM代码如下：</p> 
<pre><code class="prism language-python"> s <span class="token operator">=</span> te<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>
 xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
 <span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
 ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

 <span class="token comment"># re-ordering</span>
 s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>
 s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yi<span class="token punctuation">)</span>
</code></pre> 
<p>生成IR如下：</p> 
<pre><code class="prism language-python">primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcast<span class="token punctuation">(</span><span class="token number">0f32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32x32<span class="token operator">*</span><span class="token punctuation">)</span>C_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>A_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>float32x32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="array_packing_651"></a>array packing</h4> 
<p>这个优化策略稍有复杂<br> 原始的B的数据摆放是<code>B[K][N]</code>现在变成<code>B[N/bn][K][bn]</code>，这里bn是数组B最内层循环的迭代量。<br> 注意上面数组B的两个维度K和N交换了，然后将N分成bn份。<br> 这里记<br> <code>bigN=N/bn</code><br> <code>bn=littleN</code><br> 仅执行packedB操作，得到的IR如下：</p> 
<pre><code class="prism language-python">primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  allocate<span class="token punctuation">(</span>packedB<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span><span class="token keyword">global</span> float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> storage_scope <span class="token operator">=</span> <span class="token keyword">global</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>bigN<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>littleN<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        packedB<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bigN<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> littleN<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>bigN<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> littleN<span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到执行packedB的遍历顺序是bigN，K然后是littleN<br> 注意计算逻辑中的区别如下</p> 
<pre><code class="prism language-python"> packedB<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bigN<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> littleN<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>bigN<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> littleN<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<p>上面IR执行的packed过程，可以用下面的图来表示：<br> <img src="https://images2.imgbox.com/16/60/vmQ2vTl3_o.png" alt="在这里插入图片描述">对应的c++代码逻辑表示如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">packedB</span><span class="token punctuation">(</span>T<span class="token operator">*</span> B<span class="token punctuation">,</span> T<span class="token operator">*</span> packed_b<span class="token punctuation">,</span> <span class="token keyword">int</span> K<span class="token punctuation">,</span> <span class="token keyword">int</span> N<span class="token punctuation">,</span> <span class="token keyword">int</span> fac<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> big_n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> big_n <span class="token operator">&lt;</span> N <span class="token operator">/</span> fac<span class="token punctuation">;</span> big_n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> K<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> little_n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> little_n <span class="token operator">&lt;</span> fac<span class="token punctuation">;</span> little_n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                packed_b<span class="token punctuation">[</span>big_n <span class="token operator">*</span> K <span class="token operator">*</span> fac <span class="token operator">+</span> k <span class="token operator">*</span> fac <span class="token operator">+</span> little_n<span class="token punctuation">]</span> <span class="token operator">=</span> B<span class="token punctuation">[</span>k <span class="token operator">*</span> N <span class="token operator">+</span> big_n <span class="token operator">*</span> fac <span class="token operator">+</span> little_n<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>接下来描述矩阵C如何利用packedB进行计算</p> 
<pre><code class="prism language-python"> C <span class="token operator">=</span> te<span class="token punctuation">.</span>compute<span class="token punctuation">(</span>
     <span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> te<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>x<span class="token punctuation">,</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> packedB<span class="token punctuation">[</span>y <span class="token operator">//</span> bn<span class="token punctuation">,</span> k<span class="token punctuation">,</span> tvm<span class="token punctuation">.</span>tir<span class="token punctuation">.</span>indexmod<span class="token punctuation">(</span>y<span class="token punctuation">,</span> bn<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span>
     name<span class="token operator">=</span><span class="token string">"C"</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span>
</code></pre> 
<p>上面代码里面有个<code>tvm.tir.indexmod</code>，从官方文档中得到的解释如下：</p> 
<blockquote> 
 <p>Compute the remainder of indexdiv. a and b are non-negative.</p> 
</blockquote> 
<p>注意上面的提到的哪个<code>indexdiv</code>也是OP，它的解释是这样的：</p> 
<blockquote> 
 <p>Compute floor(a / b) where a and b are non-negative. （直接取整）</p> 
</blockquote> 
<p>这里猜测<code>indexmod(y,bn)</code>的结果就是y % bn (为啥不直接叫mod呢）</p> 
<p>生成的IR如下：</p> 
<pre><code class="prism language-python">primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  allocate<span class="token punctuation">(</span>packedB<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span><span class="token keyword">global</span> float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> storage_scope <span class="token operator">=</span> <span class="token keyword">global</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>bigN<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>littleN<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          packedB<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bigN<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> littleN<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>bigN<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> littleN<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0f32</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k_1<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>C_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>A_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> k_1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>packedB<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>floordiv<span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k_1<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> floormod<span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面的逻辑就是用矩阵A乘以packedB了，可以看到矩阵A的访存方式就是标准的按行主序的方式索引，再看packedB，<br> 因为packedB的维度是<code>B[N/bn][K][bn]</code>，所以上面的IR中<code>floordiv(y,32)</code>计算就是<code>N/bn</code>这个维度的索引，后面的<code>32768</code>是1024×32<br> <code>k_1</code>是K的索引，<code>floormod(y,32)</code>是bn的索引</p> 
<p>完整的代码如下：</p> 
<pre><code class="prism language-python"> packedB <span class="token operator">=</span> te<span class="token punctuation">.</span>compute<span class="token punctuation">(</span><span class="token punctuation">(</span>N <span class="token operator">/</span> bn<span class="token punctuation">,</span> K<span class="token punctuation">,</span> bn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">:</span> B<span class="token punctuation">[</span>y<span class="token punctuation">,</span> x <span class="token operator">*</span> bn <span class="token operator">+</span> z<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"packedB"</span><span class="token punctuation">)</span>
 C <span class="token operator">=</span> te<span class="token punctuation">.</span>compute<span class="token punctuation">(</span>
     <span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> te<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>x<span class="token punctuation">,</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> packedB<span class="token punctuation">[</span>y <span class="token operator">//</span> bn<span class="token punctuation">,</span> k<span class="token punctuation">,</span> tvm<span class="token punctuation">.</span>tir<span class="token punctuation">.</span>indexmod<span class="token punctuation">(</span>y<span class="token punctuation">,</span> bn<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span>
     name<span class="token operator">=</span><span class="token string">"C"</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span>

 s <span class="token operator">=</span> te<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>

 xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
 <span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
 ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

 s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>
 s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yi<span class="token punctuation">)</span>

 x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis
 s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
 s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>parallel<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> 
<p>上面的schedule逻辑中，矩阵C的两个轴进行tile操作。<br> 此外，还对矩阵C最内层循环进行向量化操作，C是写回的结果矩阵，同样需要进行向量化的原因是计算packedB进行向量化操作，得到的是多个结果的连续值，因此需要将写回的访存行为也进行向量化</p> 
<p>生成的IR如下：</p> 
<pre><code class="prism language-python">primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  allocate<span class="token punctuation">(</span>packedB<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span><span class="token keyword">global</span> float32x32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32x32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">32768</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> storage_scope <span class="token operator">=</span> <span class="token keyword">global</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>bigN<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token string">"parallel"</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        packedB<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bigN<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>float32x32<span class="token operator">*</span><span class="token punctuation">)</span>B_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>bigN<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcast<span class="token punctuation">(</span><span class="token number">0f32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              C_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>float32x32<span class="token operator">*</span><span class="token punctuation">)</span>C_2<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span><span class="token punctuation">(</span>float32<span class="token operator">*</span><span class="token punctuation">)</span>A_2<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>float32x32<span class="token operator">*</span><span class="token punctuation">)</span>packedB<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7b324e63c91346ee8a2bdee03b29eaf6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Push模块管理推送消息功能，可以实现在线、离线的消息推送，通过plus.push可获取推送消息管理对象</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/df955796d1e136df93961e98983c56cc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python2写csv文件中文乱码问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>