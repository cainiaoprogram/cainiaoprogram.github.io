<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ubuntu配置Yolov8环境并训练自己的数据集 &#43; ROS实时运行 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ubuntu配置Yolov8环境并训练自己的数据集 &#43; ROS实时运行" />
<meta property="og:description" content="文章目录 一、环境配置与功能测试1.1 安装1.2 目标检测1.3 实例分割1.4 分类1.5 姿态检测 二、训练数据标注三、数据集训练方法3.1 命令训练3.2 代码训练 四、Yolov8在ROS中实时运行4.1 yolov8_ros4.2 ultralytics_ros 前言：需要先安装CUDA和Anaconda，它们的安装参考我这篇文章：Ubuntu配置深度学习环境（TensorFlow和PyTorch）
一、环境配置与功能测试 1.1 安装 新建一个虚拟环境下安装：
# 新建虚拟环境 conda create -n yolov8 python=3.8 # 激活虚拟环境 conda activate yolov8 pip install ultralytics # 使用清华大学的镜像源安装 pip install ultralytics -i https://pypi.tuna.tsinghua.edu.cn/simple/ 源码安装：
# 激活虚拟环境 conda activate yolov8 # 需要单独安装torch conda install pytorch==2.0.0 torchvision==0.15.0 torchaudio==2.0.0 pytorch-cuda=11.7 -c pytorch -c nvidia git clone https://github.com/ultralytics/ultralytics.git cd ultralytics # 安装依赖 pip install -r requirements.txt # 使用清华大学的镜像源安装 pip install -r requirements." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/be94abe4d6fcf499d0ab6559b693620f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-06T14:36:41+08:00" />
<meta property="article:modified_time" content="2024-01-06T14:36:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ubuntu配置Yolov8环境并训练自己的数据集 &#43; ROS实时运行</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_4" rel="nofollow">一、环境配置与功能测试</a></li><li><ul><li><a href="#11__5" rel="nofollow">1.1 安装</a></li><li><a href="#12__34" rel="nofollow">1.2 目标检测</a></li><li><a href="#13__83" rel="nofollow">1.3 实例分割</a></li><li><a href="#14__93" rel="nofollow">1.4 分类</a></li><li><a href="#15__98" rel="nofollow">1.5 姿态检测</a></li></ul> 
  </li><li><a href="#_105" rel="nofollow">二、训练数据标注</a></li><li><a href="#_127" rel="nofollow">三、数据集训练方法</a></li><li><ul><li><a href="#31__242" rel="nofollow">3.1 命令训练</a></li><li><a href="#32__269" rel="nofollow">3.2 代码训练</a></li></ul> 
  </li><li><a href="#Yolov8ROS_318" rel="nofollow">四、Yolov8在ROS中实时运行</a></li><li><ul><li><a href="#41_yolov8_ros_319" rel="nofollow">4.1 yolov8_ros</a></li><li><a href="#42_ultralytics_ros_347" rel="nofollow">4.2 ultralytics_ros</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<p>前言：需要先安装CUDA和Anaconda，它们的安装参考我这篇文章：<a href="https://blog.csdn.net/zardforever123/article/details/133432077?spm=1001.2014.3001.5501">Ubuntu配置深度学习环境（TensorFlow和PyTorch）</a></p> 
<h2><a id="_4"></a>一、环境配置与功能测试</h2> 
<h3><a id="11__5"></a>1.1 安装</h3> 
<p>新建一个虚拟环境下安装：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 新建虚拟环境</span>
conda create <span class="token parameter variable">-n</span> yolov8 <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.8</span>
<span class="token comment"># 激活虚拟环境</span>
conda activate yolov8


pip <span class="token function">install</span> ultralytics  
<span class="token comment"># 使用清华大学的镜像源安装</span>
pip <span class="token function">install</span> ultralytics <span class="token parameter variable">-i</span>  https://pypi.tuna.tsinghua.edu.cn/simple/
</code></pre> 
<p>源码安装：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 激活虚拟环境</span>
conda activate yolov8
<span class="token comment"># 需要单独安装torch</span>
conda <span class="token function">install</span> <span class="token assign-left variable">pytorch</span><span class="token operator">==</span><span class="token number">2.0</span>.0 <span class="token assign-left variable">torchvision</span><span class="token operator">==</span><span class="token number">0.15</span>.0 <span class="token assign-left variable">torchaudio</span><span class="token operator">==</span><span class="token number">2.0</span>.0 pytorch-cuda<span class="token operator">=</span><span class="token number">11.7</span> <span class="token parameter variable">-c</span> pytorch <span class="token parameter variable">-c</span> nvidia


<span class="token function">git</span> clone https://github.com/ultralytics/ultralytics.git
<span class="token builtin class-name">cd</span> ultralytics
<span class="token comment"># 安装依赖</span>
pip <span class="token function">install</span> <span class="token parameter variable">-r</span> requirements.txt
<span class="token comment"># 使用清华大学的镜像源安装</span>
pip <span class="token function">install</span> <span class="token parameter variable">-r</span> requirements.txt <span class="token parameter variable">-i</span>  https://pypi.tuna.tsinghua.edu.cn/simple/
</code></pre> 
<h3><a id="12__34"></a>1.2 目标检测</h3> 
<pre><code class="prism language-bash"><span class="token comment">#激活虚拟环境</span>
conda activate yolov8

<span class="token comment">#官方的测试案例进行程序的推理测试：</span>
yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>detect <span class="token assign-left variable">mode</span><span class="token operator">=</span>predict <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8n.pt <span class="token assign-left variable">source</span><span class="token operator">=</span>/home/zard/Pictures/2.jpeg  <span class="token assign-left variable">device</span><span class="token operator">=</span>cpu <span class="token assign-left variable">save</span><span class="token operator">=</span>True <span class="token assign-left variable">show</span><span class="token operator">=</span>True
<span class="token comment"># 任务模型task=detect，YOLOv8可用于检测，分割，姿态和分类</span>
<span class="token comment"># 会自动下载权重文件https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8n.pt到当前目录</span>
<span class="token comment"># 推理的数据为source</span>
<span class="token comment"># 这是CPU进行测试的，将device改为0用GPU</span>
</code></pre> 
<p>结果如下，结果保存在当前路径下的runs/detect/predict文件夹中：</p> 
<pre><code class="prism language-bash">Ultralytics YOLOv8.0.145 🚀 Python-3.7.16 torch-1.13.1+cu117 CPU <span class="token punctuation">(</span>12th Gen Intel Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i5-12500H<span class="token punctuation">)</span>
YOLOv8n summary <span class="token punctuation">(</span>fused<span class="token punctuation">)</span>: <span class="token number">168</span> layers, <span class="token number">3151904</span> parameters, <span class="token number">0</span> gradients

image <span class="token number">1</span>/1 /home/zard/Pictures/2.jpeg: 480x640 <span class="token number">4</span> persons, <span class="token number">5</span> cars, <span class="token number">1</span> motorcycle, <span class="token number">1</span> suitcase, <span class="token number">32</span>.9ms
Speed: <span class="token number">1</span>.8ms preprocess, <span class="token number">32</span>.9ms inference, <span class="token number">0</span>.7ms postprocess per image at shape <span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span>, <span class="token number">480</span>, <span class="token number">640</span><span class="token punctuation">)</span>
Results saved to runs/detect/predict
</code></pre> 
<p><img src="https://images2.imgbox.com/3f/8a/BWWKSQ5i_o.jpg" alt="在这里插入图片描述"><br> GPU运行</p> 
<pre><code class="prism language-bash">yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>detect <span class="token assign-left variable">mode</span><span class="token operator">=</span>predict <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8n.pt <span class="token assign-left variable">source</span><span class="token operator">=</span>/home/zard/Pictures/1.jpeg  <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">save</span><span class="token operator">=</span>True <span class="token assign-left variable">show</span><span class="token operator">=</span>True

Ultralytics YOLOv8.0.145 🚀 Python-3.7.16 torch-1.13.1+cu117 CUDA:0 <span class="token punctuation">(</span>NVIDIA GeForce RTX <span class="token number">3060</span> Laptop GPU, 5930MiB<span class="token punctuation">)</span>
YOLOv8n summary <span class="token punctuation">(</span>fused<span class="token punctuation">)</span>: <span class="token number">168</span> layers, <span class="token number">3151904</span> parameters, <span class="token number">0</span> gradients

image <span class="token number">1</span>/1 /home/zard/Pictures/1.jpeg: 448x640 <span class="token number">7</span> persons, <span class="token number">6</span> cars, <span class="token number">2</span> buss, <span class="token number">6</span>.8ms
Speed: <span class="token number">1</span>.5ms preprocess, <span class="token number">6</span>.8ms inference, <span class="token number">0</span>.8ms postprocess per image at shape <span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span>, <span class="token number">448</span>, <span class="token number">640</span><span class="token punctuation">)</span>
Results saved to runs/detect/predict2
</code></pre> 
<p>也可以输入文件夹，处理多张图片：</p> 
<pre><code class="prism language-bash">yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>detect <span class="token assign-left variable">mode</span><span class="token operator">=</span>predict <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8n.pt <span class="token assign-left variable">source</span><span class="token operator">=</span>/home/zard/Pictures/  <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">save</span><span class="token operator">=</span>True <span class="token assign-left variable">show</span><span class="token operator">=</span>True
Ultralytics YOLOv8.0.145 🚀 Python-3.7.16 torch-1.13.1+cu117 CUDA:0 <span class="token punctuation">(</span>NVIDIA GeForce RTX <span class="token number">3060</span> Laptop GPU, 5930MiB<span class="token punctuation">)</span>
YOLOv8n summary <span class="token punctuation">(</span>fused<span class="token punctuation">)</span>: <span class="token number">168</span> layers, <span class="token number">3151904</span> parameters, <span class="token number">0</span> gradients

image <span class="token number">1</span>/3 /home/zard/Pictures/1.jpeg: 448x640 <span class="token number">7</span> persons, <span class="token number">6</span> cars, <span class="token number">2</span> buss, <span class="token number">7</span>.0ms
image <span class="token number">2</span>/3 /home/zard/Pictures/2.jpeg: 480x640 <span class="token number">4</span> persons, <span class="token number">5</span> cars, <span class="token number">1</span> motorcycle, <span class="token number">1</span> suitcase, <span class="token number">6</span>.9ms
image <span class="token number">3</span>/3 /home/zard/Pictures/3.jpeg: 448x640 <span class="token number">7</span> persons, <span class="token number">1</span> car, <span class="token number">2</span> trucks, <span class="token number">3</span>.7ms
Speed: <span class="token number">1</span>.8ms preprocess, <span class="token number">5</span>.9ms inference, <span class="token number">0</span>.6ms postprocess per image at shape <span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span>, <span class="token number">448</span>, <span class="token number">640</span><span class="token punctuation">)</span>
Results saved to runs/detect/predict3
</code></pre> 
<h3><a id="13__83"></a>1.3 实例分割</h3> 
<pre><code class="prism language-bash"><span class="token comment">#激活虚拟环境</span>
conda activate yolov8

yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>segment <span class="token assign-left variable">mode</span><span class="token operator">=</span>predict <span class="token assign-left variable">model</span><span class="token operator">=</span>/home/zard/yolov8s-seg.pt <span class="token assign-left variable">source</span><span class="token operator">=</span>/home/zard/Pictures/2.jpeg <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">save</span><span class="token operator">=</span>True <span class="token assign-left variable">show</span><span class="token operator">=</span>True

<span class="token comment"># 自动下载权重文件https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8s-seg.pt</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9c/a6/TeSkWNag_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="14__93"></a>1.4 分类</h3> 
<pre><code class="prism language-bash">yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>classify <span class="token assign-left variable">mode</span><span class="token operator">=</span>predict <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8x-cls.pt <span class="token assign-left variable">source</span><span class="token operator">=</span>/home/zard/Pictures/2.jpeg <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">save</span><span class="token operator">=</span>True <span class="token assign-left variable">show</span><span class="token operator">=</span>True
</code></pre> 
<h3><a id="15__98"></a>1.5 姿态检测</h3> 
<pre><code class="prism language-bash">yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>pose <span class="token assign-left variable">mode</span><span class="token operator">=</span>predict <span class="token assign-left variable">model</span><span class="token operator">=</span>/home/zard/yolov8s-pose.pt <span class="token assign-left variable">source</span><span class="token operator">=</span>/home/zard/Pictures/2.jpeg <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">save</span><span class="token operator">=</span>True <span class="token assign-left variable">show</span><span class="token operator">=</span>True
</code></pre> 
<p><img src="https://images2.imgbox.com/04/81/BKkLIJ8H_o.jpg" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/d0/b0/6M4HrVI8_o.jpg" alt="请添加图片描述"></p> 
<h2><a id="_105"></a>二、训练数据标注</h2> 
<p>安装数据标注环境：</p> 
<pre><code class="prism language-bash"><span class="token comment">#激活虚拟环境</span>
conda activate yolov8
pip <span class="token function">install</span> labelImg
<span class="token comment"># 使用清华大学的镜像源安装</span>
pip <span class="token function">install</span> labelImg <span class="token parameter variable">-i</span>  https://pypi.tuna.tsinghua.edu.cn/simple/

labelImg
</code></pre> 
<p>labelImg允许用户在图像中绘制边界框、多边形、线条和点等来标注不同类型的对象或特征。也可以标注标注类别，用户可以定义不同的标注类别，使其适应不同的项目需求。每个类别都可以有自己的名称和颜色。我这里从网上随便找了一些狗子的照片示例：<br> 选择要标注的数据和输出目录，右下角会出现目录下所有图片：<br> <img src="https://images2.imgbox.com/d9/6c/RgbDpVh4_o.png" alt="在这里插入图片描述"></p> 
<p>更改数据的标注结果格式，点击save下面按钮选择输出为YOLO<br> <img src="https://images2.imgbox.com/82/06/zelOMdIV_o.png" alt="在这里插入图片描述"><br> 点击Creat RectBox框选目标，填入标签：<br> <img src="https://images2.imgbox.com/e5/be/42P4dmF9_o.png" alt="在这里插入图片描述"><br> 每一帧标注完成后均要点击save，会在输出路径下生成结果，其中.txt文件包含图片中的物体信息及对应的位置之类的，class.txt列出所有的标签：<br> <img src="https://images2.imgbox.com/2a/83/O6ToIL4G_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_127"></a>三、数据集训练方法</h2> 
<p>标注完成后，创建data文件夹，并在images中放置所有标注原图，labels保存每个图片对应的标签文件（.txt），dataSet用来保存数据集划分，例如训练集、验证集和测试集，通常以文本文件的形式列出每个数据集中的图像名称或ID，使用下面脚本生成数据集划分：</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">import</span> argparse
 
parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 标注文件的地址，根据自己的数据进行修改</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--label_path'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'./labels'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'input label path'</span><span class="token punctuation">)</span>
<span class="token comment"># 数据集的划分，地址选择自己数据dataSet下</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--txt_path'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'./dataSet'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'output dataset path'</span><span class="token punctuation">)</span>
opt <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
<span class="token comment"># 训练与测试数据集比例</span>
trainval_percent <span class="token operator">=</span> <span class="token number">1.0</span>
train_percent <span class="token operator">=</span> <span class="token number">0.9</span>
labelfilepath <span class="token operator">=</span> opt<span class="token punctuation">.</span>label_path
txtsavepath <span class="token operator">=</span> opt<span class="token punctuation">.</span>txt_path
<span class="token comment"># 读取所有已经标注文件的名称</span>
total_label <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>labelfilepath<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>txtsavepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>txtsavepath<span class="token punctuation">)</span>
 
num <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>total_label<span class="token punctuation">)</span>
list_index <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
tv <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>num <span class="token operator">*</span> trainval_percent<span class="token punctuation">)</span>
tr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tv <span class="token operator">*</span> train_percent<span class="token punctuation">)</span>
trainval <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>list_index<span class="token punctuation">,</span> tv<span class="token punctuation">)</span>
train <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>trainval<span class="token punctuation">,</span> tr<span class="token punctuation">)</span>

file_trainval <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txtsavepath <span class="token operator">+</span> <span class="token string">'/trainval.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
file_test <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txtsavepath <span class="token operator">+</span> <span class="token string">'/test.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
file_train <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txtsavepath <span class="token operator">+</span> <span class="token string">'/train.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
file_val <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txtsavepath <span class="token operator">+</span> <span class="token string">'/val.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
 
<span class="token keyword">for</span> i <span class="token keyword">in</span> list_index<span class="token punctuation">:</span>
    name <span class="token operator">=</span> total_label<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
    <span class="token comment"># 排除掉生成的classes.txt文件</span>
    <span class="token keyword">if</span> name<span class="token operator">==</span><span class="token string">'classes'</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> i <span class="token keyword">in</span> trainval<span class="token punctuation">:</span>
        file_trainval<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token keyword">in</span> train<span class="token punctuation">:</span>
            file_train<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            file_val<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        file_test<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        
file_trainval<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
file_train<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
file_val<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
file_test<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>再用下面脚本将数据组织成Yolov8需要的形式（训练与验证数据集下均包含图像与对应的标签文件夹）：</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os<span class="token punctuation">,</span>shutil
rootpath<span class="token operator">=</span><span class="token string">"/home/zard/Pictures/data/"</span><span class="token comment">#待修改路径</span>
<span class="token comment"># 输出路径</span>
imgtrain<span class="token operator">=</span>rootpath<span class="token operator">+</span><span class="token string">"train/images/"</span>
imgval<span class="token operator">=</span>rootpath<span class="token operator">+</span><span class="token string">"val/images/"</span>
labeltrain<span class="token operator">=</span>rootpath<span class="token operator">+</span><span class="token string">"train/labels/"</span>
labelval<span class="token operator">=</span>rootpath<span class="token operator">+</span><span class="token string">"val/labels/"</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>imgtrain<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>imgtrain<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>imgval<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>imgval<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>labeltrain<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>labeltrain<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>labelval<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>labelval<span class="token punctuation">)</span>

f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>rootpath<span class="token operator">+</span><span class="token string">"dataSet/train.txt"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span>
lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
	shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rootpath<span class="token operator">+</span><span class="token string">"images/"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".jpg"</span><span class="token punctuation">,</span>imgtrain<span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".jpg"</span><span class="token punctuation">)</span>
    shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rootpath <span class="token operator">+</span> <span class="token string">"labels/"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".txt"</span><span class="token punctuation">,</span> labeltrain <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".txt"</span><span class="token punctuation">)</span>
 
f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>rootpath<span class="token operator">+</span><span class="token string">"dataSet/val.txt"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span>
lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
    shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rootpath<span class="token operator">+</span><span class="token string">"images/"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".jpg"</span><span class="token punctuation">,</span>imgval<span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".jpg"</span><span class="token punctuation">)</span>
    shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rootpath <span class="token operator">+</span> <span class="token string">"labels/"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".txt"</span><span class="token punctuation">,</span> labelval <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".txt"</span><span class="token punctuation">)</span>
shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rootpath<span class="token operator">+</span><span class="token string">"dataSet/train.txt"</span><span class="token punctuation">,</span>rootpath<span class="token operator">+</span><span class="token string">"train.txt"</span><span class="token punctuation">)</span>
shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rootpath<span class="token operator">+</span><span class="token string">"dataSet/trainval.txt"</span><span class="token punctuation">,</span>rootpath<span class="token operator">+</span><span class="token string">"trainval.txt"</span><span class="token punctuation">)</span>
shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rootpath<span class="token operator">+</span><span class="token string">"dataSet/test.txt"</span><span class="token punctuation">,</span>rootpath<span class="token operator">+</span><span class="token string">"test.txt"</span><span class="token punctuation">)</span>
shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rootpath<span class="token operator">+</span><span class="token string">"dataSet/val.txt"</span><span class="token punctuation">,</span>rootpath<span class="token operator">+</span><span class="token string">"val.txt"</span><span class="token punctuation">)</span>
</code></pre> 
<p>然后编写ymal文件，${Youpath}替换为你的路径：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">train</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>Youpath<span class="token punctuation">}</span>/data/train/images
<span class="token key atrule">val</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>Youpath<span class="token punctuation">}</span>/data/val/images
<span class="token key atrule">test</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>Youpath<span class="token punctuation">}</span>/data/test/images

<span class="token comment"># number of classes</span>
<span class="token key atrule">nc</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token comment"># class names</span>
<span class="token key atrule">names</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'dog'</span><span class="token punctuation">]</span>
</code></pre> 
<p>然后去Yolo源码里找到yolov8.yaml参数文件，复制一份并修改：</p> 
<pre><code class="prism language-bash">nc: <span class="token number">1</span>  <span class="token comment"># number of classes</span>
</code></pre> 
<p>最后的文件结构如下，蓝色文件夹下均为图像和对应的标注文件：<br> <img src="https://images2.imgbox.com/10/82/Ie0iHAQo_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="31__242"></a>3.1 命令训练</h3> 
<pre><code class="prism language-bash"><span class="token comment">#激活虚拟环境</span>
conda activate yolov8

<span class="token builtin class-name">cd</span> <span class="token variable">${Youpath}</span>/data
yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>detect <span class="token assign-left variable">mode</span><span class="token operator">=</span>train <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8.yaml <span class="token assign-left variable">data</span><span class="token operator">=</span>dog.yaml <span class="token assign-left variable">batch</span><span class="token operator">=</span><span class="token number">32</span> <span class="token assign-left variable">epochs</span><span class="token operator">=</span><span class="token number">100</span> <span class="token assign-left variable">imgsz</span><span class="token operator">=</span><span class="token number">640</span> <span class="token assign-left variable">workers</span><span class="token operator">=</span><span class="token number">16</span> <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token number">0</span>
</code></pre> 
<p>model部分可以进行模型的选择与更改，其余的参数都可以根据自己电脑的性能进行修改。训练完成后就可以进入runs文件夹下面看自己的训练成果：<br> <img src="https://images2.imgbox.com/b5/bb/7RSDaMbr_o.png" alt="在这里插入图片描述"><br> 结果如下，包括一些图表和验证结果：其中weights下包含两个训练的权重文件（最好的 和 上一次的）<br> <img src="https://images2.imgbox.com/0d/1a/rtluLPJq_o.png" alt="在这里插入图片描述"><br> 利用训练得到的权重推理：</p> 
<pre><code class="prism language-bash"><span class="token comment">#激活虚拟环境</span>
conda activate yolov8
yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>detect <span class="token assign-left variable">mode</span><span class="token operator">=</span>predict <span class="token assign-left variable">model</span><span class="token operator">=</span>best.pt <span class="token assign-left variable">source</span><span class="token operator">=</span><span class="token number">15</span>.jpg  <span class="token assign-left variable">device</span><span class="token operator">=</span>cpu <span class="token assign-left variable">save</span><span class="token operator">=</span>True <span class="token assign-left variable">show</span><span class="token operator">=</span>True
</code></pre> 
<p>由于就只有十几张图片，没有训练出来效果就不展示了<br> best.pt还可以作为下一次训练的初值：</p> 
<pre><code class="prism language-bash"><span class="token comment">#激活虚拟环境</span>
conda activate yolov8
yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>detect <span class="token assign-left variable">mode</span><span class="token operator">=</span>predict <span class="token assign-left variable">model</span><span class="token operator">=</span> ./runs/detect/train/weights/best.pt <span class="token assign-left variable">source</span><span class="token operator">=</span><span class="token number">15</span>.jpg  <span class="token assign-left variable">device</span><span class="token operator">=</span>cpu <span class="token assign-left variable">save</span><span class="token operator">=</span>True <span class="token assign-left variable">show</span><span class="token operator">=</span>True
</code></pre> 
<h3><a id="32__269"></a>3.2 代码训练</h3> 
<p>训练：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

<span class="token comment"># Load a model</span>
<span class="token comment"># model = YOLO('yolov8n.pt')  # load a pretrained model (recommended for training)</span>
<span class="token comment"># model = YOLO('./runs/detect/train/weights/best.pt')  # load a pretrained model (recommended for training)</span>
model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">'yolov8.yaml'</span><span class="token punctuation">)</span>  <span class="token comment"># load a pretrained model (recommended for training)</span>

<span class="token comment"># Train the model</span>
model<span class="token punctuation">.</span>train<span class="token punctuation">(</span>data<span class="token operator">=</span><span class="token string">'dog.yaml'</span><span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">640</span>，workers<span class="token operator">=</span><span class="token number">16</span> device<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<p>运行，与上面效果是一样的：</p> 
<pre><code class="prism language-bash"><span class="token comment">#激活虚拟环境</span>
conda activate yolov8
python3 train.py
</code></pre> 
<p>推理：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> cv2

model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"runs/detect/train/weights/best.pt"</span><span class="token punctuation">)</span>
<span class="token comment"># accepts all fonmats - image/dir/Path/URL/video/PIL/ndarray. 0 for webcamresults = model.predict(source="0")</span>
<span class="token comment"># results = model.predict(source="0") # 用摄像头</span>
<span class="token comment"># results = model.predict(source="folder",show=True)# Display preds. Accepts all YoLO predict argument</span>


<span class="token comment">#from PIL</span>
im1 <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"15.jpg"</span><span class="token punctuation">)</span>
results <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>source<span class="token operator">=</span>im1<span class="token punctuation">,</span> save<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># save plotted images</span>

<span class="token comment">#from ndarray</span>
<span class="token comment"># im2 = cv2.imread("test.jpg")</span>
<span class="token comment"># results = model.predict(source=im2,save=True,save_txt=True) # save predictions as labels</span>
<span class="token comment"># #from list of PIL/ndancay</span>
<span class="token comment"># results = model. predict(source=[im1, im2])</span>
</code></pre> 
<p>运行：</p> 
<pre><code class="prism language-bash"><span class="token comment">#激活虚拟环境</span>
conda activate yolov8
python3 train.py
</code></pre> 
<h2><a id="Yolov8ROS_318"></a>四、Yolov8在ROS中实时运行</h2> 
<h3><a id="41_yolov8_ros_319"></a>4.1 yolov8_ros</h3> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> yolov8_ros/src <span class="token parameter variable">-p</span>
<span class="token builtin class-name">cd</span> yolov8_ros/src
<span class="token function">git</span> clone https://github.com/qq44642754a/Yolov8_ros.git
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
catkin_make
</code></pre> 
<p>使用TUM数据集测试，图像话题参数修改如下：</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>param <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"image_topic"</span>       <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token string">"/camera/rgb/image_color"</span> /<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-bash">rosbag play rgbd_dataset_freiburg3_walking_rpy.bag
roslaunch yolov8_ros yolo_v8.launch
</code></pre> 
<p>如果报错：ImportError: No module named cv2，说明ros调用了python2，修改：</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/usr/bin/env python3</span>
-- coding: utf-8 --
</code></pre> 
<p><img src="https://images2.imgbox.com/f8/89/gJgJowbv_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="42_ultralytics_ros_347"></a>4.2 ultralytics_ros</h3> 
<p>这个相对功能更全面一点</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> yolov8_ros/src
<span class="token function">git</span> clone <span class="token parameter variable">-b</span> noetic-devel https://github.com/Alpaca-zip/ultralytics_ros.git
<span class="token function">git</span> clone <span class="token parameter variable">-b</span> noetic-devel https://github.com/ros-perception/vision_msgs.git
python3 <span class="token parameter variable">-m</span> pip <span class="token function">install</span> <span class="token parameter variable">-r</span> ultralytics_ros/requirements.txt
<span class="token builtin class-name">cd</span> yolov8_ros
rosdep <span class="token function">install</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-y</span> <span class="token parameter variable">-i</span> --from-paths <span class="token builtin class-name">.</span>
catkin build
</code></pre> 
<p>使用TUM数据集测试，参数修改如下：</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>arg <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"input_topic"</span> <span class="token assign-left variable">default</span><span class="token operator">=</span><span class="token string">"/camera/rgb/image_color"</span>/<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>arg <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"device"</span> <span class="token assign-left variable">default</span><span class="token operator">=</span><span class="token string">"0"</span>/<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-bash">rosbag play rgbd_dataset_freiburg3_walking_rpy.bag
roslaunch ultralytics_ros tracker.launch
</code></pre> 
<p><img src="https://images2.imgbox.com/20/35/q6uutmYf_o.png" alt="在这里插入图片描述"></p> 
<p>代码阅读（yolo跟踪或者分割的数据获取）</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># 指定脚本使用的Python解释器</span>

<span class="token keyword">import</span> cv_bridge <span class="token comment"># 导入cv_bridge模块，用于ROS图像消息和OpenCV图像格式之间的转换</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> roslib<span class="token punctuation">.</span>packages
<span class="token keyword">import</span> rospy
<span class="token keyword">from</span> sensor_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> Image
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">from</span> vision_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> Detection2D<span class="token punctuation">,</span> Detection2DArray<span class="token punctuation">,</span> ObjectHypothesisWithPose
<span class="token keyword">from</span> ultralytics_ros<span class="token punctuation">.</span>msg <span class="token keyword">import</span> YoloResult

<span class="token keyword">class</span> <span class="token class-name">TrackerNode</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化节点的参数</span>
        <span class="token comment"># 指定接收图像数据的ROS话题</span>
        self<span class="token punctuation">.</span>input_topic <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~input_topic"</span><span class="token punctuation">,</span> <span class="token string">"image_raw"</span><span class="token punctuation">)</span>
        <span class="token comment"># 将检测结果发布到的ROS话题</span>
        self<span class="token punctuation">.</span>result_topic <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~result_topic"</span><span class="token punctuation">,</span> <span class="token string">"yolo_result"</span><span class="token punctuation">)</span>
        <span class="token comment"># 结果图像发布的ROS话题名称</span>
        self<span class="token punctuation">.</span>result_image_topic <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~result_image_topic"</span><span class="token punctuation">,</span> <span class="token string">"yolo_image"</span><span class="token punctuation">)</span>

        <span class="token comment"># 指定要使用的YOLO模型</span>
        yolo_model <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~yolo_model"</span><span class="token punctuation">,</span> <span class="token string">"yolov8n.pt"</span><span class="token punctuation">)</span>
        <span class="token comment"># 置信度阈值，默认值为0.25。用于过滤检测结果的置信度阈值，低于该值的结果会被丢弃。</span>
        self<span class="token punctuation">.</span>conf_thres <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~conf_thres"</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span> 
        <span class="token comment"># IoU（交并比）阈值，默认值为0.45。表示两个边界框之间的最小IoU阈值，用于非极大值抑制（NMS）。</span>
        self<span class="token punctuation">.</span>iou_thres <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~iou_thres"</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">)</span>
        <span class="token comment"># 最大检测数，默认值为300。指定每张图像上允许的最大检测数量。</span>
        self<span class="token punctuation">.</span>max_det <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~max_det"</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
        <span class="token comment"># 需要检测的类别，默认为None。可以指定要检测的特定类别，如果为None，则检测所有类别。</span>
        self<span class="token punctuation">.</span>classes <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~classes"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token comment"># 跟踪器的配置文件路径或名称，默认值为"bytetrack.yaml"。用于指定目标跟踪器的配置。</span>
        self<span class="token punctuation">.</span>tracker <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~tracker"</span><span class="token punctuation">,</span> <span class="token string">"bytetrack.yaml"</span><span class="token punctuation">)</span>
        <span class="token comment"># 设备类型，默认为None。指定模型的运行显卡设备，例如"cpu"或"cuda:0"等。</span>
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~device"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

        <span class="token comment"># result_conf：是否在结果图像中显示置信度，默认为True。控制是否在输出图像中显示检测框的置信度。</span>
        <span class="token comment"># result_line_width：结果图像中检测框的线宽，默认为None。指定在结果图像中绘制检测框的线宽。</span>
        <span class="token comment"># result_font_size：结果图像中文本的字体大小，默认为None。指定在结果图像中显示的文本的字体大小。</span>
        <span class="token comment"># result_font：结果图像中文本的字体名称，默认为"Arial.ttf"。指定在结果图像中显示的文本的字体。</span>
        <span class="token comment"># result_labels：是否在结果图像中显示标签，默认为True。控制是否在输出图像中显示类别标签。</span>
        <span class="token comment"># result_boxes：是否在结果图像中显示边界框，默认为True。控制是否在输出图像中显示检测框。</span>
        self<span class="token punctuation">.</span>result_conf <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~result_conf"</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result_line_width <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~result_line_width"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result_font_size <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~result_font_size"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result_font <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~result_font"</span><span class="token punctuation">,</span> <span class="token string">"Arial.ttf"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result_labels <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~result_labels"</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result_boxes <span class="token operator">=</span> rospy<span class="token punctuation">.</span>get_param<span class="token punctuation">(</span><span class="token string">"~result_boxes"</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># 加载YOLO模型</span>
        path <span class="token operator">=</span> roslib<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>get_pkg_dir<span class="token punctuation">(</span><span class="token string">"ultralytics_ros"</span><span class="token punctuation">)</span>  <span class="token comment"># 获取ultralytics_ros软件包的路径</span>
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>path<span class="token punctuation">}</span></span><span class="token string">/models/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>yolo_model<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 加载YOLO模型</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fuse<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 加载模型权重</span>

        <span class="token comment"># 创建ROS订阅器和发布器</span>
        self<span class="token punctuation">.</span>sub <span class="token operator">=</span> rospy<span class="token punctuation">.</span>Subscriber<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>input_topic<span class="token punctuation">,</span>
            Image<span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>image_callback<span class="token punctuation">,</span>
            queue_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            buff_size<span class="token operator">=</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">24</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>results_pub <span class="token operator">=</span> rospy<span class="token punctuation">.</span>Publisher<span class="token punctuation">(</span>self<span class="token punctuation">.</span>result_topic<span class="token punctuation">,</span> YoloResult<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result_image_pub <span class="token operator">=</span> rospy<span class="token punctuation">.</span>Publisher<span class="token punctuation">(</span>self<span class="token punctuation">.</span>result_image_topic<span class="token punctuation">,</span> Image<span class="token punctuation">,</span> queue_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bridge <span class="token operator">=</span> cv_bridge<span class="token punctuation">.</span>CvBridge<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 检查是否使用分割模型</span>
        self<span class="token punctuation">.</span>use_segmentation <span class="token operator">=</span> yolo_model<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"-seg.pt"</span><span class="token punctuation">)</span>

    <span class="token comment"># 图像回调函数，用于接收传感器图像消息</span>
    <span class="token keyword">def</span> <span class="token function">image_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cv_image <span class="token operator">=</span> self<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>imgmsg_to_cv2<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> desired_encoding<span class="token operator">=</span><span class="token string">"bgr8"</span><span class="token punctuation">)</span>

        <span class="token comment"># 使用YOLO模型进行目标跟踪</span>
        results <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>track<span class="token punctuation">(</span>
            source<span class="token operator">=</span>cv_image<span class="token punctuation">,</span>
            conf<span class="token operator">=</span>self<span class="token punctuation">.</span>conf_thres<span class="token punctuation">,</span>
            iou<span class="token operator">=</span>self<span class="token punctuation">.</span>iou_thres<span class="token punctuation">,</span>
            max_det<span class="token operator">=</span>self<span class="token punctuation">.</span>max_det<span class="token punctuation">,</span>
            classes<span class="token operator">=</span>self<span class="token punctuation">.</span>classes<span class="token punctuation">,</span>
            tracker<span class="token operator">=</span>self<span class="token punctuation">.</span>tracker<span class="token punctuation">,</span>
            device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span>
            verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            retina_masks<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 如果有检测结果</span>
        <span class="token keyword">if</span> results <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span> 
            yolo_result_image_msg <span class="token operator">=</span> Image<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建图像消息</span>
            yolo_result_image_msg<span class="token punctuation">.</span>header <span class="token operator">=</span> msg<span class="token punctuation">.</span>header  <span class="token comment"># 设置图像消息头部</span>
            yolo_result_image_msg <span class="token operator">=</span> self<span class="token punctuation">.</span>create_result_image<span class="token punctuation">(</span>results<span class="token punctuation">)</span>  <span class="token comment"># 创建结果图像消息</span>
            self<span class="token punctuation">.</span>result_image_pub<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>yolo_result_image_msg<span class="token punctuation">)</span>  <span class="token comment"># 发布结果图像消息</span>

            <span class="token comment"># YoloResult消息类型包含detections和掩膜图像</span>
            <span class="token comment"># header</span>
            <span class="token comment"># detections: </span>
            <span class="token comment">#     heade</span>
            <span class="token comment">#     detections: "&lt;array type: vision_msgs/Detection2D, length: 5&gt;"</span>
            <span class="token comment"># masks: "&lt;array type: sensor_msgs/Image, length: 5&gt;"</span>
            yolo_result_msg <span class="token operator">=</span> YoloResult<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建YoloResult消息</span>
            yolo_result_msg<span class="token punctuation">.</span>header <span class="token operator">=</span> msg<span class="token punctuation">.</span>header  <span class="token comment"># 设置消息头部</span>
            yolo_result_msg<span class="token punctuation">.</span>detections <span class="token operator">=</span> self<span class="token punctuation">.</span>create_detections_array<span class="token punctuation">(</span>results<span class="token punctuation">)</span>  <span class="token comment"># 创建检测结果的消息数组</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_segmentation<span class="token punctuation">:</span>  <span class="token comment"># 如果使用分割模型</span>
                yolo_result_msg<span class="token punctuation">.</span>masks <span class="token operator">=</span> self<span class="token punctuation">.</span>create_segmentation_masks<span class="token punctuation">(</span>results<span class="token punctuation">)</span>  <span class="token comment"># 创建分割掩模消息</span>
            self<span class="token punctuation">.</span>results_pub<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>yolo_result_msg<span class="token punctuation">)</span>  <span class="token comment"># 发布检测结果消息</span>

    <span class="token comment"># 创建检测结果数组消息</span>
    <span class="token keyword">def</span> <span class="token function">create_detections_array</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">:</span>
        detections_msg <span class="token operator">=</span> Detection2DArray<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取坐标、类别id和相似度 [0]是因为结果是一个列表，在处理多张图片时用</span>
        <span class="token comment"># 边界框的坐标格式为 [x, y, w, h]，其中 x 和 y 是边界框左上角的坐标，w 和 h 分别表示边界框的宽度和高度</span>
        bounding_box <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>boxes<span class="token punctuation">.</span>xywh 
        classes <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>boxes<span class="token punctuation">.</span>cls
        confidence_score <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>boxes<span class="token punctuation">.</span>conf
        <span class="token keyword">for</span> bbox<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> conf <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>bounding_box<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> confidence_score<span class="token punctuation">)</span><span class="token punctuation">:</span>
            detection <span class="token operator">=</span> Detection2D<span class="token punctuation">(</span><span class="token punctuation">)</span>
            detection<span class="token punctuation">.</span>bbox<span class="token punctuation">.</span>center<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            detection<span class="token punctuation">.</span>bbox<span class="token punctuation">.</span>center<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            detection<span class="token punctuation">.</span>bbox<span class="token punctuation">.</span>size_x <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            detection<span class="token punctuation">.</span>bbox<span class="token punctuation">.</span>size_y <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>bbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            hypothesis <span class="token operator">=</span> ObjectHypothesisWithPose<span class="token punctuation">(</span><span class="token punctuation">)</span>
            hypothesis<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span>
            hypothesis<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
            detection<span class="token punctuation">.</span>results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>hypothesis<span class="token punctuation">)</span>
            detections_msg<span class="token punctuation">.</span>detections<span class="token punctuation">.</span>append<span class="token punctuation">(</span>detection<span class="token punctuation">)</span>
        <span class="token keyword">return</span> detections_msg

    <span class="token comment"># 创建结果图像消息</span>
    <span class="token keyword">def</span> <span class="token function">create_result_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在图像上绘制分割结果</span>
        plotted_image <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>
            conf<span class="token operator">=</span>self<span class="token punctuation">.</span>result_conf<span class="token punctuation">,</span>
            line_width<span class="token operator">=</span>self<span class="token punctuation">.</span>result_line_width<span class="token punctuation">,</span>
            font_size<span class="token operator">=</span>self<span class="token punctuation">.</span>result_font_size<span class="token punctuation">,</span>
            font<span class="token operator">=</span>self<span class="token punctuation">.</span>result_font<span class="token punctuation">,</span>
            labels<span class="token operator">=</span>self<span class="token punctuation">.</span>result_labels<span class="token punctuation">,</span>
            boxes<span class="token operator">=</span>self<span class="token punctuation">.</span>result_boxes<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        result_image_msg <span class="token operator">=</span> self<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>cv2_to_imgmsg<span class="token punctuation">(</span>plotted_image<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"bgr8"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result_image_msg

    <span class="token comment"># 创建分割掩模消息</span>
    <span class="token keyword">def</span> <span class="token function">create_segmentation_masks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">:</span>
        masks_msg <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">"masks"</span><span class="token punctuation">)</span> <span class="token keyword">and</span> result<span class="token punctuation">.</span>masks <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># 遍历 result.masks 中的每个分割掩模</span>
                <span class="token keyword">for</span> mask_tensor <span class="token keyword">in</span> result<span class="token punctuation">.</span>masks<span class="token punctuation">:</span>
                    <span class="token comment"># 将 PyTorch 张量（tensor）转换为 NumPy 数组（numpy array）</span>
                    mask_numpy <span class="token operator">=</span> <span class="token punctuation">(</span>
                        np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>mask_tensor<span class="token punctuation">.</span>data<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>
                            np<span class="token punctuation">.</span>uint8
                        <span class="token punctuation">)</span>
                        <span class="token operator">*</span> <span class="token number">255</span>
                    <span class="token punctuation">)</span>
                    <span class="token comment"># 将 NumPy 数组转换为 ROS 图像消息</span>
                    mask_image_msg <span class="token operator">=</span> self<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>cv2_to_imgmsg<span class="token punctuation">(</span>
                        mask_numpy<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"mono8"</span>
                    <span class="token punctuation">)</span>
                    masks_msg<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mask_image_msg<span class="token punctuation">)</span>
        <span class="token keyword">return</span> masks_msg


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    rospy<span class="token punctuation">.</span>init_node<span class="token punctuation">(</span><span class="token string">"tracker_node"</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化ROS节点</span>
    node <span class="token operator">=</span> TrackerNode<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化TrackerNode类</span>
    rospy<span class="token punctuation">.</span>spin<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 进入ROS事件循环</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4c08f8f4bc20488bd23e622956d3c152/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android 某个应用缺少特殊权限导致系统一直重启解决</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a5f79e8166e8163db865063b3f6dc59d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">0-自然语言处理基础知识</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>