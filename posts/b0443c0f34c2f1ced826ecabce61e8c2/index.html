<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 找到资源的内存数据位置 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 找到资源的内存数据位置" />
<meta property="og:description" content="Android 得到主题中对应的属性的结果或自己设置的style中的结果该文在说GetBag(uint32_t resid, std::vector&lt;uint32_t&gt;&amp; child_resids)的时候，会通过FindEntry(resid, 0u /* density_override /, false / stop_at_first_match /, false / ignore_configuration */)会得到一个ResTable_map_entry结构的数据指针。该指针就是Bag资源在内存中的位置。
我们知道，查找一个资源的时候，是根据一个32位整数来查询的。这个32位整数分成3部分，前8位是包id，系统资源包id是01，应用资源包id是0x7F；接着8位是类型id，类型id是从1开始，所以查找资源的时候，在用做数组序列时，需要先减1；最后16位是对应类型中该资源收集过程中的出现序列，叫entry_idx。
查找资源的过程中，是先通过包id找到对应的包，因为包id不是从0递增，所以需要维护包id与对应数组序列的映射，从下面的代码中可以看出，然后再通过类型id，找到包中对应的类型，最后通过entry_idx找到该类型中对应的资源。
AssetManager2 前面的文章也说了，AssetManager2里面包含着应用所有的资源内容。有必要了解下该类
class AssetManager2 { ………… // The ordered list of ApkAssets to search. These are not owned by the AssetManager, and must // have a longer lifetime. std::vector&lt;const ApkAssets*&gt; apk_assets_; // DynamicRefTables for shared library package resolution. // These are ordered according to apk_assets_. The mappings may change depending on what is // in apk_assets_, therefore they must be stored in the AssetManager and not in the // immutable ApkAssets class." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b0443c0f34c2f1ced826ecabce61e8c2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-20T20:32:15+08:00" />
<meta property="article:modified_time" content="2022-05-20T20:32:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 找到资源的内存数据位置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>  <a href="https://blog.csdn.net/q1165328963/article/details/124548291">Android 得到主题中对应的属性的结果或自己设置的style中的结果</a>该文在说GetBag(uint32_t resid, std::vector&lt;uint32_t&gt;&amp; child_resids)的时候，会通过FindEntry(resid, 0u /* density_override <em>/, false /</em> stop_at_first_match <em>/, false /</em> ignore_configuration */)会得到一个ResTable_map_entry结构的数据指针。该指针就是Bag资源在内存中的位置。<br>   我们知道，查找一个资源的时候，是根据一个32位整数来查询的。这个32位整数分成3部分，前8位是包id，系统资源包id是01，应用资源包id是0x7F；接着8位是类型id，类型id是从1开始，所以查找资源的时候，在用做数组序列时，需要先减1；最后16位是对应类型中该资源收集过程中的出现序列，叫entry_idx。<br>   查找资源的过程中，是先通过包id找到对应的包，因为包id不是从0递增，所以需要维护包id与对应数组序列的映射，从下面的代码中可以看出，然后再通过类型id，找到包中对应的类型，最后通过entry_idx找到该类型中对应的资源。</p> 
<h2><a id="AssetManager2_3"></a>AssetManager2</h2> 
<p>  前面的文章也说了，AssetManager2里面包含着应用所有的资源内容。有必要了解下该类</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">AssetManager2</span> <span class="token punctuation">{<!-- --></span>
	…………
  <span class="token comment">// The ordered list of ApkAssets to search. These are not owned by the AssetManager, and must</span>
  <span class="token comment">// have a longer lifetime.</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> ApkAssets<span class="token operator">*</span><span class="token operator">&gt;</span> apk_assets_<span class="token punctuation">;</span>

  <span class="token comment">// DynamicRefTables for shared library package resolution.</span>
  <span class="token comment">// These are ordered according to apk_assets_. The mappings may change depending on what is</span>
  <span class="token comment">// in apk_assets_, therefore they must be stored in the AssetManager and not in the</span>
  <span class="token comment">// immutable ApkAssets class.</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PackageGroup<span class="token operator">&gt;</span> package_groups_<span class="token punctuation">;</span>

  <span class="token comment">// An array mapping package ID to index into package_groups. This keeps the lookup fast</span>
  <span class="token comment">// without taking too much memory.</span>
  std<span class="token double-colon punctuation">::</span>array<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">numeric_limits</span><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">&gt;</span> package_ids_<span class="token punctuation">;</span>

  <span class="token comment">// The current configuration set for this AssetManager. When this changes, cached resources</span>
  <span class="token comment">// may need to be purged.</span>
  ResTable_config configuration_<span class="token punctuation">;</span>

  <span class="token comment">// Cached set of bags. These are cached because they can inherit keys from parent bags,</span>
  <span class="token comment">// which involves some calculation.</span>
  <span class="token keyword">mutable</span> std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token punctuation">,</span> util<span class="token double-colon punctuation">::</span>unique_cptr<span class="token operator">&lt;</span>ResolvedBag<span class="token operator">&gt;&gt;</span> cached_bags_<span class="token punctuation">;</span>

  <span class="token comment">// Cached set of bag resid stacks for each bag. These are cached because they might be requested</span>
  <span class="token comment">// a number of times for each view during View inspection.</span>
  <span class="token keyword">mutable</span> std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">&gt;&gt;</span> cached_bag_resid_stacks_<span class="token punctuation">;</span>

  <span class="token comment">// Cached set of resolved resource values.</span>
  <span class="token keyword">mutable</span> std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token punctuation">,</span> SelectedValue<span class="token operator">&gt;</span> cached_resolved_values_<span class="token punctuation">;</span>
  …………
<span class="token punctuation">}</span>  	
</code></pre> 
<p>  成员apk_assets_是std::vector&lt;const ApkAssets*&gt;，ApkAssets对应着Apk文件。在对APK文件解析资源时，是将APK文件解析成ApkAssets对象的。<br>   package_groups_是std::vector，它是由apk_assets_再处理得到的。<br>   package_ids_里面存储的是包id与上面package_groups_中次序的映射。<br>   configuration_是当前AssetManager的配置信息，它是用ResTable_config 来描述的。当它发生改变时，缓存的资源可能需要丢弃。<br>   下面的三个成员，看名字都能看出来是用来做缓存的。</p> 
<h3><a id="PackageGroup_45"></a>PackageGroup</h3> 
<p>  针对PackageGroup，咱们还是需要好好说一下。看下它的结构</p> 
<pre><code class="prism language-cpp">  <span class="token comment">// A collection of configurations and their associated ResTable_type that match the current</span>
  <span class="token comment">// AssetManager configuration.</span>
  <span class="token keyword">struct</span> <span class="token class-name">FilteredConfigGroup</span> <span class="token punctuation">{<!-- --></span>
      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> TypeSpec<span class="token double-colon punctuation">::</span>TypeEntry<span class="token operator">*</span><span class="token operator">&gt;</span> type_entries<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Represents an single package.</span>
  <span class="token keyword">struct</span> <span class="token class-name">ConfiguredPackage</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// A pointer to the immutable, loaded package info.</span>
      <span class="token keyword">const</span> LoadedPackage<span class="token operator">*</span> loaded_package_<span class="token punctuation">;</span>

      <span class="token comment">// A mutable AssetManager-specific list of configurations that match the AssetManager's</span>
      <span class="token comment">// current configuration. This is used as an optimization to avoid checking every single</span>
      <span class="token comment">// candidate configuration when looking up resources.</span>
      ByteBucketArray<span class="token operator">&lt;</span>FilteredConfigGroup<span class="token operator">&gt;</span> filtered_configs_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Represents a Runtime Resource Overlay that overlays resources in the logical package.</span>
  <span class="token keyword">struct</span> <span class="token class-name">ConfiguredOverlay</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// The set of package groups that overlay this package group.</span>
      IdmapResMap overlay_res_maps_<span class="token punctuation">;</span>

      <span class="token comment">// The cookie of the overlay assets.</span>
      ApkAssetsCookie cookie<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Represents a logical package, which can be made up of many individual packages. Each package</span>
  <span class="token comment">// in a PackageGroup shares the same package name and package ID.</span>
  <span class="token keyword">struct</span> <span class="token class-name">PackageGroup</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// The set of packages that make-up this group.</span>
      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>ConfiguredPackage<span class="token operator">&gt;</span> packages_<span class="token punctuation">;</span>

      <span class="token comment">// The cookies associated with each package in the group. They share the same order as</span>
      <span class="token comment">// packages_.</span>
      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>ApkAssetsCookie<span class="token operator">&gt;</span> cookies_<span class="token punctuation">;</span>

      <span class="token comment">// Runtime Resource Overlays that overlay resources in this package group.</span>
      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>ConfiguredOverlay<span class="token operator">&gt;</span> overlays_<span class="token punctuation">;</span>

      <span class="token comment">// A library reference table that contains build-package ID to runtime-package ID mappings.</span>
      std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>DynamicRefTable<span class="token operator">&gt;</span> dynamic_ref_table <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>DynamicRefTable<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>  每个PackageGroup 对应着一个包id。它可能包含着多个包的资源，packages_的类型是std::vector，每个ConfiguredPackage实例对应着一个包的资源。这些包的id值是相同的。<br>   cookies_是用来描述对应的ConfiguredPackage来自哪个APK。它的次序是与packages_的次序对应的。<br>   overlays_是与RRO相关，RRO就是运行资源遮罩。<br>   dynamic_ref_table它是库引用表，里面包含构建包ID到运行包ID的映射。<br>   再看ConfiguredPackage 结构，他有两个成员：loaded_package_和filtered_configs_。<br>   loaded_package_是LoadedPackage*，它指向的是包里的资源信息。<br>   而filtered_configs_是为了优化，根据当前的配置信息，将所有匹配的资源都放入它里面。这样就不用再去查询那些不匹配的资源信息。filtered_configs_是ByteBucketArray类型，里面的次序是（typeid -1），对应着每个类型的资源。后面为了称呼方便，这里暂且叫它优化配置资源。</p> 
<h2><a id="FindEntry_99"></a>FindEntry()</h2> 
<p>  下面来说说FindEntry()，分段阅读：</p> 
<pre><code class="prism language-cpp">base<span class="token double-colon punctuation">::</span>expected<span class="token operator">&lt;</span>FindEntryResult<span class="token punctuation">,</span> NullOrIOError<span class="token operator">&gt;</span> <span class="token class-name">AssetManager2</span><span class="token double-colon punctuation">::</span><span class="token function">FindEntry</span><span class="token punctuation">(</span>
    <span class="token keyword">uint32_t</span> resid<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> density_override<span class="token punctuation">,</span> <span class="token keyword">bool</span> stop_at_first_match<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> ignore_configuration<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    …………
      <span class="token comment">// Might use this if density_override != 0.</span>
  ResTable_config density_override_config<span class="token punctuation">;</span>

  <span class="token comment">// Select our configuration or generate a density override configuration.</span>
  <span class="token keyword">const</span> ResTable_config<span class="token operator">*</span> desired_config <span class="token operator">=</span> <span class="token operator">&amp;</span>configuration_<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>density_override <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> density_override <span class="token operator">!=</span> configuration_<span class="token punctuation">.</span>density<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    density_override_config <span class="token operator">=</span> configuration_<span class="token punctuation">;</span>
    density_override_config<span class="token punctuation">.</span>density <span class="token operator">=</span> density_override<span class="token punctuation">;</span>
    desired_config <span class="token operator">=</span> <span class="token operator">&amp;</span>density_override_config<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>   参数 resid就是要查询的资源id；density_override是要满足的屏幕密度，如果为0，则没要求；stop_at_first_match是如果找到第一个匹配的，是否停止；ignore_configuration是否忽略配置。<br>    这第一段代码是处理参数density_override，如果density_override不为0，并且和当前AssetManager2配置configuration_的屏幕密度不一致，则将desired_config的屏幕密度设置为 density_override。其他的配置则取configuration_的。<br>   再看下一段代码：</p> 
<pre><code class="prism language-cpp">  …………
  <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> package_id <span class="token operator">=</span> <span class="token function">get_package_id</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> type_idx <span class="token operator">=</span> <span class="token function">get_type_id</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">uint16_t</span> entry_idx <span class="token operator">=</span> <span class="token function">get_entry_id</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span> package_idx <span class="token operator">=</span> package_ids_<span class="token punctuation">[</span>package_id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>package_idx <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">ANDROID_LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> base<span class="token double-colon punctuation">::</span><span class="token function">StringPrintf</span><span class="token punctuation">(</span><span class="token string">"No package ID %02x found for ID 0x%08x."</span><span class="token punctuation">,</span>
                                             package_id<span class="token punctuation">,</span> resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> base<span class="token double-colon punctuation">::</span><span class="token function">unexpected</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>nullopt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> PackageGroup<span class="token operator">&amp;</span> package_group <span class="token operator">=</span> package_groups_<span class="token punctuation">[</span>package_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> result <span class="token operator">=</span> <span class="token function">FindEntryInternal</span><span class="token punctuation">(</span>package_group<span class="token punctuation">,</span> type_idx<span class="token punctuation">,</span> entry_idx<span class="token punctuation">,</span> <span class="token operator">*</span>desired_config<span class="token punctuation">,</span>
                                  stop_at_first_match<span class="token punctuation">,</span> ignore_configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> 
<p>  这块开始处理resid得到package_id ，type_idx ，entry_idx 。这个前面解释了。分别通过移位操作得到对应的值。type_idx 是移位操作之后，做了一个减1的操作。因为typeid是从1开始的。后面在通过数组的序列查找，所以需要减1。<br>   接着就是怎么找到对应的PackageGroup，在package_ids_中存储的是对应包id的次序，然后在通过package_groups_[package_idx]就得到了对应的package_group 。<br>   然后调用<a href="#FindEntryInternal" rel="nofollow">FindEntryInternal()</a>得到FindEntryResult对象结果。这个下面再说，接着向下看代码：</p> 
<pre><code class="prism language-cpp">	…………
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_at_first_match <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ignore_configuration <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>apk_assets_<span class="token punctuation">[</span>result<span class="token operator">-&gt;</span>cookie<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">IsLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> id_map <span class="token operator">:</span> package_group<span class="token punctuation">.</span>overlays_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">auto</span> overlay_entry <span class="token operator">=</span> id_map<span class="token punctuation">.</span>overlay_res_maps_<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span>resid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>overlay_entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// No id map entry exists for this target resource.</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>overlay_entry<span class="token punctuation">.</span><span class="token function">IsInlineValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// The target resource is overlaid by an inline value not represented by a resource.</span>
        result<span class="token operator">-&gt;</span>entry <span class="token operator">=</span> overlay_entry<span class="token punctuation">.</span><span class="token function">GetInlineValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token operator">-&gt;</span>dynamic_ref_table <span class="token operator">=</span> id_map<span class="token punctuation">.</span>overlay_res_maps_<span class="token punctuation">.</span><span class="token function">GetOverlayDynamicRefTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span> id_map<span class="token punctuation">.</span>cookie<span class="token punctuation">;</span>
			…………
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">auto</span> overlay_result <span class="token operator">=</span> <span class="token function">FindEntry</span><span class="token punctuation">(</span>overlay_entry<span class="token punctuation">.</span><span class="token function">GetResourceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> density_override<span class="token punctuation">,</span>
                                      <span class="token boolean">false</span> <span class="token comment">/* stop_at_first_match */</span><span class="token punctuation">,</span>
                                      <span class="token boolean">false</span> <span class="token comment">/* ignore_configuration */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span><span class="token function">IsIOError</span><span class="token punctuation">(</span>overlay_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> base<span class="token double-colon punctuation">::</span><span class="token function">unexpected</span><span class="token punctuation">(</span>overlay_result<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>overlay_result<span class="token punctuation">.</span><span class="token function">has_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>overlay_result<span class="token operator">-&gt;</span>config<span class="token punctuation">.</span><span class="token function">isBetterThan</span><span class="token punctuation">(</span>result<span class="token operator">-&gt;</span>config<span class="token punctuation">,</span> desired_config<span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> overlay_result<span class="token operator">-&gt;</span>config<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>result<span class="token operator">-&gt;</span>config<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// The configuration of the entry for the overlay must be equal to or better than the target</span>
        <span class="token comment">// configuration to be chosen as the better value.</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      result<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span> overlay_result<span class="token operator">-&gt;</span>cookie<span class="token punctuation">;</span>
      result<span class="token operator">-&gt;</span>entry <span class="token operator">=</span> overlay_result<span class="token operator">-&gt;</span>entry<span class="token punctuation">;</span>
      result<span class="token operator">-&gt;</span>config <span class="token operator">=</span> overlay_result<span class="token operator">-&gt;</span>config<span class="token punctuation">;</span>
      result<span class="token operator">-&gt;</span>dynamic_ref_table <span class="token operator">=</span> id_map<span class="token punctuation">.</span>overlay_res_maps_<span class="token punctuation">.</span><span class="token function">GetOverlayDynamicRefTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		…………
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
	…………

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>	
</code></pre> 
<p>  这块的代码是主要处理RRO存在的情况，不准备细说，能看到，它也调用了FindEntry()来返回结果。<br>   FindEntry()说完了。</p> 
<h3><a id="ResTable_type_190"></a>ResTable_type</h3> 
<p>  再讲FindEntryInternal()之前需要先说一下ResTable_type，查找的时候和它密切相关</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
 * Header that appears at the front of every data chunk in a resource.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">ResChunk_header</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Type identifier for this chunk.  The meaning of this value depends</span>
    <span class="token comment">// on the containing chunk.</span>
    <span class="token keyword">uint16_t</span> type<span class="token punctuation">;</span>

    <span class="token comment">// Size of the chunk header (in bytes).  Adding this value to</span>
    <span class="token comment">// the address of the chunk allows you to find its associated data</span>
    <span class="token comment">// (if any).</span>
    <span class="token keyword">uint16_t</span> headerSize<span class="token punctuation">;</span>

    <span class="token comment">// Total size of this chunk (in bytes).  This is the chunkSize plus</span>
    <span class="token comment">// the size of any data associated with the chunk.  Adding this value</span>
    <span class="token comment">// to the chunk allows you to completely skip its contents (including</span>
    <span class="token comment">// any child chunks).  If this value is the same as chunkSize, there is</span>
    <span class="token comment">// no data associated with the chunk.</span>
    <span class="token keyword">uint32_t</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>		
		…………
<span class="token keyword">struct</span> <span class="token class-name">ResTable_type</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">ResChunk_header</span> header<span class="token punctuation">;</span>

    <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
        NO_ENTRY <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">// The type identifier this chunk is holding.  Type IDs start</span>
    <span class="token comment">// at 1 (corresponding to the value of the type bits in a</span>
    <span class="token comment">// resource identifier).  0 is invalid.</span>
    <span class="token keyword">uint8_t</span> id<span class="token punctuation">;</span>
    
    <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If set, the entry is sparse, and encodes both the entry ID and offset into each entry,</span>
        <span class="token comment">// and a binary search is used to find the key. Only available on platforms &gt;= O.</span>
        <span class="token comment">// Mark any types that use this with a v26 qualifier to prevent runtime issues on older</span>
        <span class="token comment">// platforms.</span>
        FLAG_SPARSE <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> flags<span class="token punctuation">;</span>

    <span class="token comment">// Must be 0.</span>
    <span class="token keyword">uint16_t</span> reserved<span class="token punctuation">;</span>
    
    <span class="token comment">// Number of uint32_t entry indices that follow.</span>
    <span class="token keyword">uint32_t</span> entryCount<span class="token punctuation">;</span>

    <span class="token comment">// Offset from header where ResTable_entry data starts.</span>
    <span class="token keyword">uint32_t</span> entriesStart<span class="token punctuation">;</span>

    <span class="token comment">// Configuration this collection of entries is designed for. This must always be last.</span>
    ResTable_config config<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>  ResTable_type数据结构对应内存中的数据内容。<br>   header是ResChunk_header 结构。ResChunk_header 是每个数据表的开头的内容。ResChunk_header 的type代表表类型，headerSize是ResTable_type数据结构的内存大小，size是ResTable_type数据结构 + 相关数据内容 的大小。<br>   ResTable_type 的id是type id。从1开始计数。<br>   ResTable_type 的entryCount代表这个类型的资源的entry数量<br>   ResTable_type 的entriesStart是数据开始的地方距离该结构开始的偏移。<br>   ResTable_type 的config是该类型的相关配置信息。<br>   看下图，就是该结构相关数据在内存中的布局，<br> <img src="https://images2.imgbox.com/0f/95/9kRVjBRd_o.png" alt="ResTable_type内存描述"></p> 
<center>
  ResTable_type相关数据在内存中的布局 
</center>   ResTable_type出现在开头。紧接着是entryCount个整数，它们是相关entry的偏移值，并且这些偏移值是相对于entriesStart的。查找的时候，先通过typeidx，得到对应的ResTable_type，再通过entryidx得到偏移值，之后就能通过偏移值得到了具体的数据内容。 
<p>  图中还能看到分为普通资源和Bag资源。普通资源就是比较简单的资源，像string类型。Bag资源是复杂一些的资源，像style类型资源，在xml文件中，包括好多条item属性内容。<br>   ResTable_map_entry、ResTable_map数据结构在<a href="https://blog.csdn.net/q1165328963/article/details/124548291">Android 得到主题中对应的属性的结果或自己设置的style中的结果</a>说过。<br>   ResTable_type是和资源具体的配置相关。像drawable类型的，mdpi和hdpi是两个ResTable_type来表示的。</p> 
<p>   开始说FindEntryInternal()</p> 
<h3><a id="FindEntryInternal_span_idFindEntryInternalspan_268"></a>FindEntryInternal() <span id="FindEntryInternal"></span></h3> 
<p>   这个方法是查找资源核心的一个方法，描述了处理资源查找时比较配置，什么情况下采用优化的filtered_configs_，怎么在内存中找到对应的资源。<br>    接着看代码，还是一段一段的看：</p> 
<pre><code class="prism language-cpp">base<span class="token double-colon punctuation">::</span>expected<span class="token operator">&lt;</span>FindEntryResult<span class="token punctuation">,</span> NullOrIOError<span class="token operator">&gt;</span> <span class="token class-name">AssetManager2</span><span class="token double-colon punctuation">::</span><span class="token function">FindEntryInternal</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> PackageGroup<span class="token operator">&amp;</span> package_group<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> type_idx<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> entry_idx<span class="token punctuation">,</span>
    <span class="token keyword">const</span> ResTable_config<span class="token operator">&amp;</span> desired_config<span class="token punctuation">,</span> <span class="token keyword">bool</span> stop_at_first_match<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> ignore_configuration<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token keyword">bool</span> logging_enabled <span class="token operator">=</span> resource_resolution_logging_enabled_<span class="token punctuation">;</span>
  ApkAssetsCookie best_cookie <span class="token operator">=</span> kInvalidCookie<span class="token punctuation">;</span>
  <span class="token keyword">const</span> LoadedPackage<span class="token operator">*</span> best_package <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  incfs<span class="token double-colon punctuation">::</span>verified_map_ptr<span class="token operator">&lt;</span>ResTable_type<span class="token operator">&gt;</span> best_type<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ResTable_config<span class="token operator">*</span> best_config <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> best_offset <span class="token operator">=</span> <span class="token number">0U</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> type_flags <span class="token operator">=</span> <span class="token number">0U</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Resolution<span class="token double-colon punctuation">::</span>Step<span class="token operator">&gt;</span> resolution_steps<span class="token punctuation">;</span>

  <span class="token comment">// If `desired_config` is not the same as the set configuration or the caller will accept a value</span>
  <span class="token comment">// from any configuration, then we cannot use our filtered list of types since it only it contains</span>
  <span class="token comment">// types matched to the set configuration.</span>
  <span class="token keyword">const</span> <span class="token keyword">bool</span> use_filtered <span class="token operator">=</span> <span class="token operator">!</span>ignore_configuration <span class="token operator">&amp;&amp;</span> <span class="token operator">&amp;</span>desired_config <span class="token operator">==</span> <span class="token operator">&amp;</span>configuration_<span class="token punctuation">;</span>    
</code></pre> 
<p>   参数都是从FindEntry()中传递过来的，就不说了。<br>   定义了几个变量，best_cookie 代表资源来自哪个ApkAssets；best_package 是资源来自LoadedPackage，它对应着一个package；best_type代表它来自哪个ResTable_type；best_config 代表它来自哪中配置；best_offset 是资源的偏移值，它与前面的ResTable_type结构有关；type_flags 代表资源受影响的配置因素。<br>   还定义了一个使用优化配置资源（上面也说了，就是用ConfiguredPackage的filtered_configs_来进行查找）的变量use_filtered 。这个变量在不忽略配置并且期望查找的配置和当前AssetManager2当前的配置信息完全一样的情况下，就会采用优化配置资源信息进行查找对应的资源。<br>   接着下一段</p> 
<pre><code class="prism language-cpp">  <span class="token keyword">const</span> size_t package_count <span class="token operator">=</span> package_group<span class="token punctuation">.</span>packages_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t pi <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pi <span class="token operator">&lt;</span> package_count<span class="token punctuation">;</span> pi<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> ConfiguredPackage<span class="token operator">&amp;</span> loaded_package_impl <span class="token operator">=</span> package_group<span class="token punctuation">.</span>packages_<span class="token punctuation">[</span>pi<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> LoadedPackage<span class="token operator">*</span> loaded_package <span class="token operator">=</span> loaded_package_impl<span class="token punctuation">.</span>loaded_package_<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ApkAssetsCookie cookie <span class="token operator">=</span> package_group<span class="token punctuation">.</span>cookies_<span class="token punctuation">[</span>pi<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// If the type IDs are offset in this package, we need to take that into account when searching</span>
    <span class="token comment">// for a type.</span>
    <span class="token keyword">const</span> TypeSpec<span class="token operator">*</span> type_spec <span class="token operator">=</span> loaded_package<span class="token operator">-&gt;</span><span class="token function">GetTypeSpecByTypeIndex</span><span class="token punctuation">(</span>type_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>type_spec <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Allow custom loader packages to overlay resource values with configurations equivalent to the</span>
    <span class="token comment">// current best configuration.</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> package_is_loader <span class="token operator">=</span> loaded_package<span class="token operator">-&gt;</span><span class="token function">IsCustomLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> entry_flags <span class="token operator">=</span> type_spec<span class="token operator">-&gt;</span><span class="token function">GetFlagsForEntryIndex</span><span class="token punctuation">(</span>entry_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span>entry_flags<span class="token punctuation">.</span><span class="token function">has_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> base<span class="token double-colon punctuation">::</span><span class="token function">unexpected</span><span class="token punctuation">(</span>entry_flags<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    type_flags <span class="token operator">|=</span> entry_flags<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> FilteredConfigGroup<span class="token operator">&amp;</span> filtered_group <span class="token operator">=</span> loaded_package_impl<span class="token punctuation">.</span>filtered_configs_<span class="token punctuation">[</span>type_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> size_t type_entry_count <span class="token operator">=</span> <span class="token punctuation">(</span>use_filtered<span class="token punctuation">)</span> <span class="token operator">?</span> filtered_group<span class="token punctuation">.</span>type_entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                   <span class="token operator">:</span> type_spec<span class="token operator">-&gt;</span>type_entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  开始进入一个循环，这个是循环包id相同的所有包。<br>   首先拿到LoadedPackage<em>类型loaded_package,然后调用它的GetTypeSpecByTypeIndex(type_idx)方法得到一个TypeSpec</em>类型type_spec。loaded_package里面包含解析APK文件的资源表(resources.arsc)中的所有资源信息。这个得到的type_spec就指向包含着该typeidx对应的类型的配置信息和资源数据信息。看一下它的结构</p> 
<pre><code class="prism language-cpp"><span class="token comment">// TypeSpec is going to be immediately proceeded by</span>
<span class="token comment">// an array of Type structs, all in the same block of memory.</span>
<span class="token keyword">struct</span> <span class="token class-name">TypeSpec</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">struct</span> <span class="token class-name">TypeEntry</span> <span class="token punctuation">{<!-- --></span>
    incfs<span class="token double-colon punctuation">::</span>verified_map_ptr<span class="token operator">&lt;</span>ResTable_type<span class="token operator">&gt;</span> type<span class="token punctuation">;</span>

    <span class="token comment">// Type configurations are accessed frequently when setting up an AssetManager and querying</span>
    <span class="token comment">// resources. Access this cached configuration to minimize page faults.</span>
    ResTable_config config<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Pointer to the mmapped data where flags are kept. Flags denote whether the resource entry is</span>
  <span class="token comment">// public and under which configurations it varies.</span>
  incfs<span class="token double-colon punctuation">::</span>verified_map_ptr<span class="token operator">&lt;</span>ResTable_typeSpec<span class="token operator">&gt;</span> type_spec<span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>TypeEntry<span class="token operator">&gt;</span> type_entries<span class="token punctuation">;</span>
	…………
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre> 
<p>  它的type_spec是incfs::verified_map_ptr&lt;ResTable_typeSpec&gt;类型，它里面包含着entry受哪些配置影响。我们通过entryidx，就能得到对应资源受影响的flags。type_entries是TypeEntry的集合，每一个TypeEntry对象又包含incfs::verified_map_ptr&lt;ResTable_type&gt; type，ResTable_type这个在前面解释过了。<br>   接着看代码，调用type_spec-&gt;GetFlagsForEntryIndex(entry_idx)得到影响该资源配置flags。并且如果存在多个包的情况下，会将所有的影响flags都收集起来。<br>   再根据前面的变量use_filtered来判断是否能用优化配置收集的资源来查找资源。<br>   如果采用优化配置资源集合，就取filtered_group.type_entries，否则就取type_spec-&gt;type_entries，得到他们的数量type_entry_count，这个数量是对应类型的资源数量。filtered_group.type_entries里面是所有满足当前配置的类型资源，而type_spec-&gt;type_entries里面则是所有的类型资源。所以使用filtered_group.type_entries能免去许多不必要的比较开销，当然这个是得根据参数来判断的。<br>   再接着向下看代码：</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> type_entry_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> TypeSpec<span class="token double-colon punctuation">::</span>TypeEntry<span class="token operator">*</span> type_entry <span class="token operator">=</span> <span class="token punctuation">(</span>use_filtered<span class="token punctuation">)</span> <span class="token operator">?</span> filtered_group<span class="token punctuation">.</span>type_entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                                                             <span class="token operator">:</span> <span class="token operator">&amp;</span>type_spec<span class="token operator">-&gt;</span>type_entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// We can skip calling ResTable_config::match() if the caller does not care for the</span>
      <span class="token comment">// configuration to match or if we're using the list of types that have already had their</span>
      <span class="token comment">// configuration matched.</span>
      <span class="token keyword">const</span> ResTable_config<span class="token operator">&amp;</span> this_config <span class="token operator">=</span> type_entry<span class="token operator">-&gt;</span>config<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>use_filtered <span class="token operator">||</span> ignore_configuration <span class="token operator">||</span> this_config<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>desired_config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
		…………
      <span class="token comment">// The configuration matches and is better than the previous selection.</span>
      <span class="token comment">// Find the entry value if it exists for this configuration.</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> type <span class="token operator">=</span> type_entry<span class="token operator">-&gt;</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token keyword">auto</span> offset <span class="token operator">=</span> <span class="token class-name">LoadedPackage</span><span class="token double-colon punctuation">::</span><span class="token function">GetEntryOffset</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> entry_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      …………
      best_cookie <span class="token operator">=</span> cookie<span class="token punctuation">;</span>
      best_package <span class="token operator">=</span> loaded_package<span class="token punctuation">;</span>
      best_type <span class="token operator">=</span> type<span class="token punctuation">;</span>
      best_config <span class="token operator">=</span> <span class="token operator">&amp;</span>this_config<span class="token punctuation">;</span>
      best_offset <span class="token operator">=</span> offset<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      …………
      <span class="token comment">// Any configuration will suffice, so break.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_at_first_match<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>            
</code></pre> 
<p>  得到类型资源的数量，就开始循环。首先得到type_entry ，它是TypeSpec::TypeEntry*，这个上面说过了。然后得到它的配置this_config 。<br>   接着就是一个判断，必须三个条件都为false的情况下，会直接进入下次循环比较。use_filtered是使用优化配置资源，ignore_configuration是忽略配置，第三个是this_config.match(desired_config)，这个是当前这个资源的配置符合期望的配置。这三个条件均不满足的情况，舍弃当前类型资源，会直接进行下个类型资源比较。如果有一个满足，就向下执行。<br>   接着得到type，它是上面说的ResTable_type指针，再通过LoadedPackage::GetEntryOffset(type, entry_idx)得到offset，这个就是上面讲述ResTable_type时，所说的entry的偏移量。<br>   再向下，就是认为找到了合适的结果了，就把best_cookie，best_package，best_type，best_config，best_offset均赋值。<br>   判断参数stop_at_first_match是否设置为true了，如果设置了，就会跳出第一层循环。如果没有设置，继续进行循环，直到两层循环结束。<br>   两层循环的内容就说完了，继续向下看代码：</p> 
<pre><code class="prism language-cpp">	…………
  <span class="token keyword">auto</span> best_entry_result <span class="token operator">=</span> <span class="token class-name">LoadedPackage</span><span class="token double-colon punctuation">::</span><span class="token function">GetEntryFromOffset</span><span class="token punctuation">(</span>best_type<span class="token punctuation">,</span> best_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  …………
  <span class="token keyword">const</span> incfs<span class="token double-colon punctuation">::</span>map_ptr<span class="token operator">&lt;</span>ResTable_entry<span class="token operator">&gt;</span> best_entry <span class="token operator">=</span> <span class="token operator">*</span>best_entry_result<span class="token punctuation">;</span>
  …………
  <span class="token keyword">const</span> <span class="token keyword">auto</span> entry <span class="token operator">=</span> <span class="token function">GetEntryValue</span><span class="token punctuation">(</span>best_entry<span class="token punctuation">.</span><span class="token function">verified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  …………
  <span class="token keyword">return</span> FindEntryResult<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>cookie <span class="token operator">=</span> best_cookie<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>entry <span class="token operator">=</span> <span class="token operator">*</span>entry<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token operator">*</span>best_config<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>type_flags <span class="token operator">=</span> type_flags<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>package_name <span class="token operator">=</span> <span class="token operator">&amp;</span>best_package<span class="token operator">-&gt;</span><span class="token function">GetPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>type_string_ref <span class="token operator">=</span> <span class="token function">StringPoolRef</span><span class="token punctuation">(</span>best_package<span class="token operator">-&gt;</span><span class="token function">GetTypeStringPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> best_type<span class="token operator">-&gt;</span>id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>entry_string_ref <span class="token operator">=</span> <span class="token function">StringPoolRef</span><span class="token punctuation">(</span>best_package<span class="token operator">-&gt;</span><span class="token function">GetKeyStringPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      best_entry<span class="token operator">-&gt;</span>key<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>dynamic_ref_table <span class="token operator">=</span> package_group<span class="token punctuation">.</span>dynamic_ref_table<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  这最后的这段代码就是处理结果了。<br>   LoadedPackage::GetEntryFromOffset(best_type, best_offset)这块得到ResTable_entry指针best_entry_result ，这块就是咱们上面说的ResTable_type数据结构，通过相对于entriesStart的偏移量，就找到ResTable_entry的位置了。<br>   然后通过GetEntryValue(best_entry.verified())得到EntryValue类型entry 。看下相关代码：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">using</span> EntryValue <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>variant<span class="token operator">&lt;</span>Res_value<span class="token punctuation">,</span> incfs<span class="token double-colon punctuation">::</span>verified_map_ptr<span class="token operator">&lt;</span>ResTable_map_entry<span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

base<span class="token double-colon punctuation">::</span>expected<span class="token operator">&lt;</span>EntryValue<span class="token punctuation">,</span> IOError<span class="token operator">&gt;</span> <span class="token function">GetEntryValue</span><span class="token punctuation">(</span>
    incfs<span class="token double-colon punctuation">::</span>verified_map_ptr<span class="token operator">&lt;</span>ResTable_entry<span class="token operator">&gt;</span> table_entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token keyword">uint16_t</span> entry_size <span class="token operator">=</span> <span class="token function">dtohs</span><span class="token punctuation">(</span>table_entry<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Check if the entry represents a bag value.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>entry_size <span class="token operator">&gt;=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ResTable_map_entry<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token function">dtohs</span><span class="token punctuation">(</span>table_entry<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span> <span class="token operator">&amp;</span> ResTable_entry<span class="token double-colon punctuation">::</span>FLAG_COMPLEX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span> map_entry <span class="token operator">=</span> table_entry<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">convert</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResTable_map_entry<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map_entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> base<span class="token double-colon punctuation">::</span><span class="token function">unexpected</span><span class="token punctuation">(</span>IOError<span class="token double-colon punctuation">::</span>PAGES_MISSING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> map_entry<span class="token punctuation">.</span><span class="token function">verified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The entry represents a non-bag value.</span>
  <span class="token keyword">const</span> <span class="token keyword">auto</span> entry_value <span class="token operator">=</span> table_entry<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>entry_size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">convert</span><span class="token generic class-name"><span class="token operator">&lt;</span>Res_value<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry_value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> base<span class="token double-colon punctuation">::</span><span class="token function">unexpected</span><span class="token punctuation">(</span>IOError<span class="token double-colon punctuation">::</span>PAGES_MISSING<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Res_value value<span class="token punctuation">;</span>
  value<span class="token punctuation">.</span><span class="token function">copyFrom_dtoh</span><span class="token punctuation">(</span>entry_value<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  可以看到EntryValue 可能的值类型是Res_value或incfs::verified_map_ptr&lt;ResTable_map_entry&gt;，在该资源是Bag资源的时候，会是incfs::verified_map_ptr&lt;ResTable_map_entry&gt;；如果是普通资源的情况下，则是Res_value。还可以看到，在ResTable_entry类成员变量flags有ResTable_entry::FLAG_COMPLEX时，会是Bag资源。<br>   再看上面最后一段代码，最后拼成一个FindEntryResult结构作为结果返回。看下其成员type_string_ref和entry_string_ref。type_string_ref是取的对应LoadedPackage的类型Type 的ResStringPool，entry_string_ref取的对应LoadedPackage的Key的ResStringPool。并且成员dynamic_ref_table取的是对应package_group.dynamic_ref_table。<br>   这样，FindEntry(）函数就说完了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/26ab9ef4a97e6b30d5d06cb59f0aeb90/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AHB2APB桥接器设计（1）——基本原理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/47203d349a9b0eb26931afcdbe397510/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">《Meta Graph Transformer：一种时空交通预测模型》</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>