<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【PyTorch实战】图像描述——让神经网络看图讲故事 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【PyTorch实战】图像描述——让神经网络看图讲故事" />
<meta property="og:description" content="图像描述——让神经网络看图讲故事 1. 图像描述介绍2. 数据2.1 数据介绍2.2 图像数据处理2.3 数据加载 3. 模型与训练3. 实验结果参考资料 Image Caption: 图像描述，又称为图像标注，就是从给定的图像生成一段描述文字。图像描述是深度学习中十分有趣的一个研究方向，也是计算机视觉的一个关键目标。 对于图像描述的任务，神经网络不仅要了解图中有哪些对象，对象之间的关系，还要使用自然语言来描述这些对象的关系。 图像描述用到的数据集通常是MS COCO。COCO数据集使用的是英文语料库，这里使用2017年9月~12月举办的AI Challenger比赛中的”图像中文描述“子任务的数据。
地址链接: https://pan.baidu.com/s/1K4DUjkqCyNNSysP31f5lJg?pwd=y35v 提取码: y35v
1. 图像描述介绍 利用深度学习完成图像描述的工作可以追溯到2014年百度研究院发表的Explain Images with Multimodal Recurrent Neural Networks论文，将深度卷积神经网络和深度循环神经网络结合，用于解决图像标注与图像和语句检索等问题。
另一篇论文：Show and tell: A neural image caption generator， 这篇论文提出的Caption模型如下图所示：
Image是原始图片，左边是GoogleLeNet，实际使用中可以用任意的深度学习网络结构代替（如VGG或ResNet等）， S 0 ， S 1 ， S 2 ， … … ， S N S_0，S_1，S_2，……，S_N S0​，S1​，S2​，……，SN​是人工对图片进行描述的语句，例如“A dog is playing with a ball”，那么 S 0 S 6 S_0~S_6 S0​ S6​就是这7个单词。就是这几个单词对应的词向量。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f95c6a49e45f87d09ee5f8b2c4a3f275/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-14T13:16:50+08:00" />
<meta property="article:modified_time" content="2022-10-14T13:16:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【PyTorch实战】图像描述——让神经网络看图讲故事</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>图像描述——让神经网络看图讲故事</h4> 
 <ul><li><a href="#1__6" rel="nofollow">1. 图像描述介绍</a></li><li><a href="#2__22" rel="nofollow">2. 数据</a></li><li><ul><li><a href="#21__23" rel="nofollow">2.1 数据介绍</a></li><li><a href="#22__354" rel="nofollow">2.2 图像数据处理</a></li><li><a href="#23__628" rel="nofollow">2.3 数据加载</a></li></ul> 
  </li><li><a href="#3__751" rel="nofollow">3. 模型与训练</a></li><li><a href="#3__909" rel="nofollow">3. 实验结果</a></li><li><a href="#_913" rel="nofollow">参考资料</a></li></ul> 
</div> 
<br> Image Caption: 图像描述，又称为图像标注，就是从给定的图像生成一段描述文字。图像描述是深度学习中十分有趣的一个研究方向，也是计算机视觉的一个关键目标。 对于图像描述的任务，神经网络不仅要了解图中有哪些对象，对象之间的关系，还要使用自然语言来描述这些对象的关系。 
<p></p> 
<p><img src="https://images2.imgbox.com/83/12/lUW4dGwl_o.png" alt="图像描述"><br> 图像描述用到的数据集通常是MS COCO。COCO数据集使用的是英文语料库，这里使用2017年9月~12月举办的AI Challenger比赛中的”图像中文描述“子任务的数据。<br> 地址链接: https://pan.baidu.com/s/1K4DUjkqCyNNSysP31f5lJg?pwd=y35v 提取码: y35v</p> 
<h2><a id="1__6"></a>1. 图像描述介绍</h2> 
<p>利用深度学习完成图像描述的工作可以追溯到2014年百度研究院发表的Explain Images with Multimodal Recurrent Neural Networks论文，将深度卷积神经网络和深度循环神经网络结合，用于解决图像标注与图像和语句检索等问题。</p> 
<p>另一篇论文：Show and tell: A neural image caption generator， 这篇论文提出的Caption模型如下图所示：<br> <img src="https://images2.imgbox.com/5c/84/CIGC03gz_o.png" alt="Show and Tell的图像描述模型"><br> Image是原始图片，左边是<code>GoogleLeNet</code>，实际使用中可以用任意的深度学习网络结构代替（如<code>VGG</code>或<code>ResNet</code>等），<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          S 
         
        
          0 
         
        
       
         ， 
        
        
        
          S 
         
        
          1 
         
        
       
         ， 
        
        
        
          S 
         
        
          2 
         
        
       
         ， 
        
       
         … 
        
       
         … 
        
       
         ， 
        
        
        
          S 
         
        
          N 
         
        
       
      
        S_0，S_1，S_2，……，S_N 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">，</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">，</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">，</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">……</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord cjk_fallback">，</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>是人工对图片进行描述的语句，例如“A dog is playing with a ball”，那么<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          S 
         
        
          0 
         
        
       
           
        
        
        
          S 
         
        
          6 
         
        
       
      
        S_0~S_6 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace nobreak"> </span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>就是这7个单词。就是这几个单词对应的词向量。<br> 论文中训练的方法如下：</p> 
<ul><li>图片经过神经网络提取到图片高层次的语义信息<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          f 
         
        
       
         f 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span></span></span></span></span></li><li>将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          f 
         
        
       
         f 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span></span></span></span></span>输入到LSTM中，并希望LSTM的输出是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           0 
          
         
        
       
         S_0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></li><li>将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           0 
          
         
        
       
         S_0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>输入到LSTM中，并希望LSTM的输出是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           1 
          
         
        
       
         S_1 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></li><li>将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           1 
          
         
        
       
         S_1 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>输入到LSTM中，并希望LSTM的输出是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           2 
          
         
        
       
         S_2 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></li><li>将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           2 
          
         
        
       
         S_2 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>输入到LSTM中，并希望LSTM的输出是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           3 
          
         
        
       
         S_3 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></li><li>…</li><li>以此类推，将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
          
          
            N 
           
          
            − 
           
          
            1 
           
          
         
        
       
         S_{N-1} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8917em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span></span></span>输入到LSTM中，并希望LSTM的输出是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           N 
          
         
        
       
         S_N 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></li></ul> 
<p>在论文中，作者使用了预训练好的GoogleLeNet获取图片在全连接分类层之前的输出，作为图像语义。训练的目标就是输出的词尽量和预期的词相符，所以<strong>图像描述问题最终也变成了一个分类问题，利用LSTM不断预测下一个最有可能出现的词</strong>。</p> 
<h2><a id="2__22"></a>2. 数据</h2> 
<h3><a id="21__23"></a>2.1 数据介绍</h3> 
<p>AI Challenger图像中文描述比赛的数据分为两部分，第一个部分是图片，总共20万张，第二部分是一个<code>caption_train_annotations_20170902.json</code>文件，它以<code>json</code>的格式保存每张图片的描述，每个样本的格式如下，总共有20万条这样的样本。</p> 
<ul><li>url：图片的下载地址（没用，因为已经提供了下载好的图片）。</li><li>image_id：图片的文件名。</li><li>caption：图片对应的五句描述。</li></ul> 
<p>url:<br> [{“url”: “http://img5.cache.netease.com/photo/0005/2013-09-25/99LA1FC60B6P0005.jpg”, “image_id”: “3cd32bef87ed98572bac868418521852ac3f6a70.jpg”, “caption”: [“\u4e00\u4e2a\u53cc\u81c2\u62ac\u8d77\u7684\u8fd0\u52a8\u5458\u8dea\u5728\u7eff\u8335\u8335\u7684\u7403\u573a\u4e0a”, “\u4e00\u4e2a\u62ac\u7740\u53cc\u81c2\u7684\u8fd0\u52a8\u5458\u8dea\u5728\u8db3\u7403\u573a\u4e0a”, “\u4e00\u4e2a\u53cc\u624b\u63e1\u62f3\u7684\u7537\u4eba\u8dea\u5728\u7eff\u8335\u8335\u7684\u8db3\u7403\u573a\u4e0a”, “\u4e00\u4e2a\u62ac\u8d77\u53cc\u624b\u7684\u7537\u4eba\u8dea\u5728\u78a7\u7eff\u7684\u7403\u573a\u4e0a”, “\u4e00\u4e2a\u53cc\u624b\u63e1\u62f3\u7684\u8fd0\u52a8\u5458\u8dea\u5728\u5e73\u5766\u7684\u8fd0\u52a8\u573a\u4e0a”]}, …<br> 图片：<br> <img src="https://images2.imgbox.com/b5/2e/zdbD2x7d_o.png" alt="示例图片"><br> 描述：</p> 
<ul><li>“一个双臂抬起的运动员跪在绿茵茵的球场上”,</li><li>“一个抬着双臂的运动员跪在足球场上”,</li><li>“一个双手握拳的男人跪在绿茵茵的足球场上”,</li><li>“一个抬起双手的男人跪在碧绿的球场上”,</li><li>“一个双手握拳的运动员跪在平坦的运动场上”</li></ul> 
<p>描述具有的特点：</p> 
<ul><li>每句话的描述长短不一；</li><li>描述不涉及太多额外的知识，尽可能的客观；</li><li>尽可能点明图像的人物以及人物之间的关系。</li></ul> 
<p><strong>数据处理主要涉及对图片的预处理和对描述的预处理</strong>。对图片的预处理相对比较简单，即将图片送入<code>ResNet</code>，获得指定层的输出并保存即可。对文字的预处理相对比较麻烦，分为以下几步：</p> 
<ul><li>中文分词</li><li>将词用序号表示（word2idx），并过滤低频词，即统计每个词出现的次数，然后删除一些频词太低的词。</li><li>将所有描述补齐到等长（pad_sequence）</li><li>利用pack_padded_sequence进行计算加速</li></ul> 
<p>其中对中文分词。英语采用空格区分单词，汉语则采用分词软件，最有效的是<code>结巴分词</code>，安装采用 <code>pip install jieba</code>。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> jieba
seq_list <span class="token operator">=</span> jieba<span class="token punctuation">.</span>cut<span class="token punctuation">(</span><span class="token string">"我正在学习深度学习知识"</span><span class="token punctuation">,</span>cut_all<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">u"分词结果： "</span><span class="token operator">+</span><span class="token string">"/"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>seq_list<span class="token punctuation">)</span><span class="token punctuation">)</span>
分词结果： 我<span class="token operator">/</span>正在<span class="token operator">/</span>学习<span class="token operator">/</span>深度<span class="token operator">/</span>学习<span class="token operator">/</span>知识
</code></pre> 
<p>注意：结巴分词利用自建的词典进行分词，还可以指定自己自定义的词典。</p> 
<p>PyTorch中函数<code>pack_padded_sequence</code>专门对经过<code>pad操作</code>后的序列进行<code>pack</code>，因经过pad后的序列存在很多空白的填充值，使得在计算RNN时可能会影响隐藏元的取值，使其变得复杂，浪费计算资源。<code>PackedSequence</code>能够解决这一问题，它知道输入数据中哪些是pad的值，不会计算pad的数据输出，从而节省计算资源。具体方法：</p> 
<ul><li>对不同长度的句子，按长度（从长到短）进行排序并记录句子的长短；</li><li>对不同的句子，统一pad成一样的长度；</li><li>将上一步得到的variable和样本的长度输入pack_padded_sequence，会输出PackedSequence对象，这个对象可以输入到任何RNN类型的module中（包括RNN、LSTM和GRＵ），还能送入部分损失函数中（例如交叉熵损失函数）。</li><li>PackedSequence可以通过pad_packed_sequence方法取出variable和length。这个操作可以看成是pack_padded_sequence的逆操作，但是一般不需要取出来，而是直接通过全连接层计算损失。</li></ul> 
<p>使用案例：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch <span class="token keyword">as</span> t
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>rnn <span class="token keyword">import</span> pack_padded_sequence<span class="token punctuation">,</span> pad_packed_sequence
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
sen1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
sen2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
sen3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
sen4 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>
sentences <span class="token operator">=</span> <span class="token punctuation">[</span>sen1<span class="token punctuation">,</span>sen2<span class="token punctuation">,</span>sen3<span class="token punctuation">,</span>sen4<span class="token punctuation">]</span>
sentences
Out<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
sentences <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>sentences<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
sentences
Out<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment"># 长于5个词的截断到5个词</span>
lengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sen<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">5</span> <span class="token keyword">else</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sen<span class="token punctuation">)</span> <span class="token keyword">for</span> sen <span class="token keyword">in</span> sentences<span class="token punctuation">]</span>
lengths
Out<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token comment"># pad数据， 太长的就截断，太短的就补零</span>
<span class="token keyword">def</span> <span class="token function">pad_sen</span><span class="token punctuation">(</span>sen<span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> padded_num<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     origin_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sen<span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     padded_sen <span class="token operator">=</span> sen<span class="token punctuation">[</span><span class="token punctuation">:</span>length<span class="token punctuation">]</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     padded_sen <span class="token operator">=</span> padded_sen <span class="token operator">+</span> <span class="token punctuation">[</span>padded_num <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>origin_len<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">]</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span> 
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>     <span class="token keyword">return</span> padded_sen
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span> 
pad_sentences <span class="token operator">=</span> <span class="token punctuation">[</span>pad_sen<span class="token punctuation">(</span>sen<span class="token punctuation">)</span> <span class="token keyword">for</span> sen <span class="token keyword">in</span> sentences<span class="token punctuation">]</span>
pad_sentences
Out<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment"># 4 * 5 batch_size = 3， 词=5</span>
pad_tensor <span class="token operator">=</span> t<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>pad_sentences<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 5 * 4 batch_size = 4, 词=5</span>
pad_tensor <span class="token operator">=</span> pad_tensor<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span>
pad_variable <span class="token operator">=</span> t<span class="token punctuation">.</span>autograd<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>pad_tensor<span class="token punctuation">)</span>
pad_variable <span class="token comment"># 一列是一句话</span>
Out<span class="token punctuation">[</span><span class="token number">38</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 总共5个词，每个词用2维向量表示</span>
embedding <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># 5 * 4 * 2</span>
pad_embeddings <span class="token operator">=</span> embedding<span class="token punctuation">(</span>pad_variable<span class="token punctuation">)</span>
pad_embeddings
Out<span class="token punctuation">[</span><span class="token number">43</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">0.2895</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3784</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">1.2969</span><span class="token punctuation">,</span>  <span class="token number">1.7264</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">0.2895</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3784</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">1.2969</span><span class="token punctuation">,</span>  <span class="token number">1.7264</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">0.2895</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3784</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">1.2969</span><span class="token punctuation">,</span>  <span class="token number">1.7264</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">0.2895</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3784</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">0.8121</span><span class="token punctuation">,</span>  <span class="token number">0.9832</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">0.8121</span><span class="token punctuation">,</span>  <span class="token number">0.9832</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token punctuation">[</span> <span class="token number">0.8121</span><span class="token punctuation">,</span>  <span class="token number">0.9832</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> grad_fn<span class="token operator">=</span><span class="token operator">&lt;</span>EmbeddingBackward0<span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token comment"># pack数据</span>
packed_variable <span class="token operator">=</span> pack_padded_sequence<span class="token punctuation">(</span>pad_embeddings<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span>
packed_variable <span class="token comment"># 输出也是PackedSequence</span>
Out<span class="token punctuation">[</span><span class="token number">47</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
PackedSequence<span class="token punctuation">(</span>data<span class="token operator">=</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">0.2895</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3784</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">1.2969</span><span class="token punctuation">,</span>  <span class="token number">1.7264</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">0.2895</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3784</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">1.2969</span><span class="token punctuation">,</span>  <span class="token number">1.7264</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">0.2895</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3784</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">1.2969</span><span class="token punctuation">,</span>  <span class="token number">1.7264</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">0.2895</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3784</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5019</span><span class="token punctuation">,</span>  <span class="token number">0.4527</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">1.4539</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8153</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> grad_fn<span class="token operator">=</span><span class="token operator">&lt;</span>PackPaddedSequenceBackward0<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_sizes<span class="token operator">=</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sorted_indices<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> unsorted_indices<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token comment"># 输入2维（词向量长度）,隐藏元长度为3</span>
rnn <span class="token operator">=</span> t<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
output<span class="token punctuation">,</span> hn <span class="token operator">=</span> rnn<span class="token punctuation">(</span>packed_variable<span class="token punctuation">)</span>
output <span class="token operator">=</span> pad_packed_sequence<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
output
Out<span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
<span class="token punctuation">(</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0.1196</span><span class="token punctuation">,</span>  <span class="token number">0.0815</span><span class="token punctuation">,</span>  <span class="token number">0.0840</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.0695</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0680</span><span class="token punctuation">,</span>  <span class="token number">0.2405</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span> <span class="token number">0.0309</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0104</span><span class="token punctuation">,</span>  <span class="token number">0.1873</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.2330</span><span class="token punctuation">,</span>  <span class="token number">0.0528</span><span class="token punctuation">,</span>  <span class="token number">0.0075</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 
         <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0.1888</span><span class="token punctuation">,</span>  <span class="token number">0.1278</span><span class="token punctuation">,</span>  <span class="token number">0.1229</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.1119</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1228</span><span class="token punctuation">,</span>  <span class="token number">0.2911</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span> <span class="token number">0.0386</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0304</span><span class="token punctuation">,</span>  <span class="token number">0.2468</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.3550</span><span class="token punctuation">,</span>  <span class="token number">0.1099</span><span class="token punctuation">,</span>  <span class="token number">0.0170</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 
         <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0.2290</span><span class="token punctuation">,</span>  <span class="token number">0.1541</span><span class="token punctuation">,</span>  <span class="token number">0.1402</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.1266</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1615</span><span class="token punctuation">,</span>  <span class="token number">0.3069</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span> <span class="token number">0.0408</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0499</span><span class="token punctuation">,</span>  <span class="token number">0.2678</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.4142</span><span class="token punctuation">,</span>  <span class="token number">0.1606</span><span class="token punctuation">,</span>  <span class="token number">0.0280</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 
         <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0.2531</span><span class="token punctuation">,</span>  <span class="token number">0.1691</span><span class="token punctuation">,</span>  <span class="token number">0.1479</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.1299</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1880</span><span class="token punctuation">,</span>  <span class="token number">0.3132</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span> <span class="token number">0.0427</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.0663</span><span class="token punctuation">,</span>  <span class="token number">0.2759</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span> <span class="token number">0.0000</span><span class="token punctuation">,</span>  <span class="token number">0.0000</span><span class="token punctuation">,</span>  <span class="token number">0.0000</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 
         <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0.2681</span><span class="token punctuation">,</span>  <span class="token number">0.1777</span><span class="token punctuation">,</span>  <span class="token number">0.1513</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.1292</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2064</span><span class="token punctuation">,</span>  <span class="token number">0.3162</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span> <span class="token number">0.0000</span><span class="token punctuation">,</span>  <span class="token number">0.0000</span><span class="token punctuation">,</span>  <span class="token number">0.0000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span> <span class="token number">0.0000</span><span class="token punctuation">,</span>  <span class="token number">0.0000</span><span class="token punctuation">,</span>  <span class="token number">0.0000</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> grad_fn<span class="token operator">=</span><span class="token operator">&lt;</span>CopySlices<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>因为这里<font color="red">仅使用原来的验证集，所以用书里提供的代码对<code>caption_validation_annotations_20170910.json</code>进行预处理</font> ，保存为pickle格式的dict对象，名称为<code>caption_validation.pth</code>。<br> 预处理代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-#</span>

<span class="token comment"># ----------------------------------------------</span>
<span class="token comment"># Name:         data_preprocess.py</span>
<span class="token comment"># Description:  对caption_validation_annotations_20170910.json进行预处理，保存成pickle格式的dict对象</span>
<span class="token comment"># Author:       PANG</span>
<span class="token comment"># Date:         2022/7/3</span>
<span class="token comment"># ----------------------------------------------</span>
<span class="token keyword">import</span> torch <span class="token keyword">as</span> t
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> json
<span class="token keyword">import</span> jieba
<span class="token keyword">import</span> tqdm


<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    annotation_file <span class="token operator">=</span> <span class="token string">'ai_challenger_caption_validation_20170910/caption_validation_annotations_20170910.json'</span>
    unknown <span class="token operator">=</span> <span class="token string">'&lt;/UNKNOWN&gt;'</span>
    end <span class="token operator">=</span> <span class="token string">'&lt;/EOS&gt;'</span>
    padding <span class="token operator">=</span> <span class="token string">'&lt;/PAD&gt;'</span>
    max_words <span class="token operator">=</span> <span class="token number">10000</span>
    min_appear <span class="token operator">=</span> <span class="token number">2</span>
    save_path <span class="token operator">=</span> <span class="token string">'caption_validation.pth'</span>


<span class="token comment"># START='&lt;/START&gt;'</span>
<span class="token comment"># MAX_LENS = 25,</span>

<span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    opt <span class="token operator">=</span> Config<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">setattr</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>annotation_file<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

    <span class="token comment"># 8f00f3d0f1008e085ab660e70dffced16a8259f6.jpg -&gt; 0</span>
    id2ix <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>item<span class="token punctuation">[</span><span class="token string">'image_id'</span><span class="token punctuation">]</span><span class="token punctuation">:</span> ix <span class="token keyword">for</span> ix<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token comment"># 0-&gt; 8f00f3d0f1008e085ab660e70dffced16a8259f6.jpg</span>
    ix2id <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>ix<span class="token punctuation">:</span> <span class="token builtin">id</span> <span class="token keyword">for</span> <span class="token builtin">id</span><span class="token punctuation">,</span> ix <span class="token keyword">in</span> <span class="token punctuation">(</span>id2ix<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword">assert</span> id2ix<span class="token punctuation">[</span>ix2id<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">10</span>

    captions <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token string">'caption'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> data<span class="token punctuation">]</span>
    <span class="token comment"># 分词结果</span>
    cut_captions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>jieba<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>ii<span class="token punctuation">,</span> cut_all<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> ii <span class="token keyword">in</span> item<span class="token punctuation">]</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> tqdm<span class="token punctuation">.</span>tqdm<span class="token punctuation">(</span>captions<span class="token punctuation">)</span><span class="token punctuation">]</span>

    word_nums <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  <span class="token comment"># '快乐'-&gt; 10000 (次)</span>

    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>word_nums<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">fun</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">:</span>
            word_nums<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> word_nums<span class="token punctuation">.</span>get<span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

        <span class="token keyword">return</span> fun

    lambda_ <span class="token operator">=</span> update<span class="token punctuation">(</span>word_nums<span class="token punctuation">)</span>
    _ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>lambda_<span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token keyword">for</span> sentences <span class="token keyword">in</span> cut_captions <span class="token keyword">for</span> sentence <span class="token keyword">in</span> sentences <span class="token keyword">for</span> word <span class="token keyword">in</span> sentence<span class="token punctuation">}</span>

    <span class="token comment"># [ (10000,u'快乐')，(9999,u'开心') ...]</span>
    word_nums_list <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> word<span class="token punctuation">)</span> <span class="token keyword">for</span> word<span class="token punctuation">,</span> num <span class="token keyword">in</span> word_nums<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment">#### 以上的操作是无损，可逆的操作###############################</span>
    <span class="token comment"># **********以下会删除一些信息******************</span>

    <span class="token comment"># 1. 丢弃词频不够的词</span>
    <span class="token comment"># 2. ~~丢弃长度过长的词~~</span>

    words <span class="token operator">=</span> <span class="token punctuation">[</span>word<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> word <span class="token keyword">in</span> word_nums_list<span class="token punctuation">[</span><span class="token punctuation">:</span>opt<span class="token punctuation">.</span>max_words<span class="token punctuation">]</span> <span class="token keyword">if</span> word<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> opt<span class="token punctuation">.</span>min_appear<span class="token punctuation">]</span>
    words <span class="token operator">=</span> <span class="token punctuation">[</span>opt<span class="token punctuation">.</span>unknown<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>end<span class="token punctuation">]</span> <span class="token operator">+</span> words
    word2ix <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>word<span class="token punctuation">:</span> ix <span class="token keyword">for</span> ix<span class="token punctuation">,</span> word <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>words<span class="token punctuation">)</span><span class="token punctuation">}</span>
    ix2word <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>ix<span class="token punctuation">:</span> word <span class="token keyword">for</span> word<span class="token punctuation">,</span> ix <span class="token keyword">in</span> word2ix<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword">assert</span> word2ix<span class="token punctuation">[</span>ix2word<span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">123</span>

    ix_captions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span>word2ix<span class="token punctuation">.</span>get<span class="token punctuation">(</span>word<span class="token punctuation">,</span> word2ix<span class="token punctuation">.</span>get<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>unknown<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> word <span class="token keyword">in</span> sentence<span class="token punctuation">]</span>
                    <span class="token keyword">for</span> sentence <span class="token keyword">in</span> item<span class="token punctuation">]</span>
                   <span class="token keyword">for</span> item <span class="token keyword">in</span> cut_captions<span class="token punctuation">]</span>
    readme <span class="token operator">=</span> <span class="token triple-quoted-string string">u"""
    word：词
    ix:index
    id:图片名
    caption: 分词之后的描述，通过ix2word可以获得原始中文词
    """</span>
    results <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'caption'</span><span class="token punctuation">:</span> ix_captions<span class="token punctuation">,</span>
        <span class="token string">'word2ix'</span><span class="token punctuation">:</span> word2ix<span class="token punctuation">,</span>
        <span class="token string">'ix2word'</span><span class="token punctuation">:</span> ix2word<span class="token punctuation">,</span>
        <span class="token string">'ix2id'</span><span class="token punctuation">:</span> ix2id<span class="token punctuation">,</span>
        <span class="token string">'id2ix'</span><span class="token punctuation">:</span> id2ix<span class="token punctuation">,</span>
        <span class="token string">'padding'</span><span class="token punctuation">:</span> <span class="token string">'&lt;/PAD&gt;'</span><span class="token punctuation">,</span>
        <span class="token string">'end'</span><span class="token punctuation">:</span> <span class="token string">'&lt;/EOS&gt;'</span><span class="token punctuation">,</span>
        <span class="token string">'readme'</span><span class="token punctuation">:</span> readme
    <span class="token punctuation">}</span>
    t<span class="token punctuation">.</span>save<span class="token punctuation">(</span>results<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>save_path<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'save file in %s'</span> <span class="token operator">%</span> opt<span class="token punctuation">.</span>save_path<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>ix<span class="token punctuation">,</span> ix2<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        results <span class="token operator">=</span> t<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>save_path<span class="token punctuation">)</span>
        ix2word <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'ix2word'</span><span class="token punctuation">]</span>
        examples <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'caption'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
        sentences_p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>ix2word<span class="token punctuation">[</span>ii<span class="token punctuation">]</span> <span class="token keyword">for</span> ii <span class="token keyword">in</span> examples<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sentences_r <span class="token operator">=</span> data<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'caption'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>ix2<span class="token punctuation">]</span>
        <span class="token keyword">assert</span> sentences_p <span class="token operator">==</span> sentences_r<span class="token punctuation">,</span> <span class="token string">'test failed'</span>

    test<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'test success'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># import fire</span>
    <span class="token comment">#</span>
    <span class="token comment"># fire.Fire()</span>
    <span class="token comment"># python data_preprocess.py process --annotation-file=/data/annotation.json --max-words=5000</span>
    process<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p><code>caption_validation.pth</code>中的内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch <span class="token keyword">as</span> t
data <span class="token operator">=</span> t<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'D:\MyProjects\deeplearningDay100\Image_Caption\caption_validation.pth'</span><span class="token punctuation">)</span>
<span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'caption'</span><span class="token punctuation">,</span> <span class="token string">'word2ix'</span><span class="token punctuation">,</span> <span class="token string">'ix2word'</span><span class="token punctuation">,</span> <span class="token string">'ix2id'</span><span class="token punctuation">,</span> <span class="token string">'id2ix'</span><span class="token punctuation">,</span> <span class="token string">'padding'</span><span class="token punctuation">,</span> <span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token string">'readme'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'readme'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    word：词
    ix<span class="token punctuation">:</span>index
    <span class="token builtin">id</span><span class="token punctuation">:</span>图片名
    caption<span class="token punctuation">:</span> 分词之后的描述，通过ix2word可以获得原始中文词
</code></pre> 
<p>字典中各个键值对的含义如下：</p> 
<ul><li>word2idx: 长度为5911的字典，词对应的序号，例如“女人”-&gt;10</li><li>id2word：长度为5911的字典，序号对应的词，例如10 -&gt; “女人”</li><li>id2ix：长度为30000的字典，图片文件名对应的序号，例如’a20401efd162bd6320a2203057019afbf996423c.jpg’ -&gt; 9</li><li>ix2id：长度为30000的字典，序号对应的图片文件名，例如9 -&gt; ‘a20401efd162bd6320a2203057019afbf996423c.jpg’</li><li>end: 结束标识符&lt;/EOS&gt;</li><li>padding：pad标识符&lt;/PAD&gt;</li><li>caption：长度为30000的列表，每一项是个长度为5的列表，保存图片都应为五句描述。描述的数据经过分词，并将词映射到序号。可以通过word2ix查看词和序号的对应关系。<br> <img src="https://images2.imgbox.com/13/8a/DDPdTCDi_o.png" alt="字典中各个键值对示例"><br> 一个使用案例：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch <span class="token keyword">as</span> t
data <span class="token operator">=</span> t<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'D:\MyProjects\deeplearningDay100\Image_Caption\caption_validation.pth'</span><span class="token punctuation">)</span>
ix2word <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'ix2word'</span><span class="token punctuation">]</span>
ix2id <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'ix2id'</span><span class="token punctuation">]</span>
caption <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'caption'</span><span class="token punctuation">]</span>
img_ix <span class="token operator">=</span> <span class="token number">100</span> <span class="token comment"># 第100张图片</span>
<span class="token comment"># 图片对应的描述</span>
img_caption <span class="token operator">=</span> caption<span class="token punctuation">[</span>img_ix<span class="token punctuation">]</span>
<span class="token comment"># 图片文件名</span>
img_id <span class="token operator">=</span> ix2id<span class="token punctuation">[</span>img_ix<span class="token punctuation">]</span>
img_caption
Out<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">833</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">207</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token punctuation">[</span><span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token punctuation">[</span><span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">756</span><span class="token punctuation">,</span> <span class="token number">609</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">223</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">229</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token punctuation">[</span><span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">193</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">207</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
img_id
Out<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token string">'644441869019a08b76a6eacc3d4ac4c21142e036.jpg'</span>
<span class="token comment"># 通过ix2word获得对应的词</span>
sen <span class="token operator">=</span> img_caption<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
sen <span class="token operator">=</span> <span class="token punctuation">[</span>ix2word<span class="token punctuation">[</span>_<span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> sen<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>sen<span class="token punctuation">)</span><span class="token punctuation">)</span>
干净的大厅里一个十指交叉的男人前面有一群穿着黄色衣服的女人在跳舞
</code></pre> 
<p><img src="https://images2.imgbox.com/9b/81/axhObXfA_o.png" alt="示例"></p> 
<h3><a id="22__354"></a>2.2 图像数据处理</h3> 
<p>需要利用神经网络提取图像的特征。具体地，就是利用ResNet提取图片在倒数第二层（池化层的输出，全连接层的输入）的2048维度的向量。有两种解决方案：</p> 
<ol><li>复制并修改torchvision中的ResNet源码，让它在倒数第二层就输出返回</li><li>直接把最后一层删除并替换成一个恒等映射。</li></ol> 
<p>首先，看一下torchvision中ResNet的forward源码，我们的目标是获得x=self.avgpool(x)的输出。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ResNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        block<span class="token punctuation">:</span> Type<span class="token punctuation">[</span>Union<span class="token punctuation">[</span>BasicBlock<span class="token punctuation">,</span> Bottleneck<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        layers<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        num_classes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>
        zero_init_residual<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        groups<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        width_per_group<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span>
        replace_stride_with_dilation<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        norm_layer<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _log_api_usage_once<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        <span class="token keyword">if</span> norm_layer <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            norm_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d
        self<span class="token punctuation">.</span>_norm_layer <span class="token operator">=</span> norm_layer

        self<span class="token punctuation">.</span>inplanes <span class="token operator">=</span> <span class="token number">64</span>
        self<span class="token punctuation">.</span>dilation <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> replace_stride_with_dilation <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># each element in the tuple indicates if we should replace</span>
            <span class="token comment"># the 2x2 stride with a dilated convolution instead</span>
            replace_stride_with_dilation <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>replace_stride_with_dilation<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>
                <span class="token string">"replace_stride_with_dilation should be None "</span>
                <span class="token string-interpolation"><span class="token string">f"or a 3-element tuple, got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>replace_stride_with_dilation<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>groups <span class="token operator">=</span> groups
        self<span class="token punctuation">.</span>base_width <span class="token operator">=</span> width_per_group
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>inplanes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> norm_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>inplanes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>maxpool <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer1 <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> layers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> layers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> dilate<span class="token operator">=</span>replace_stride_with_dilation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer3 <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> layers<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> dilate<span class="token operator">=</span>replace_stride_with_dilation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer4 <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> layers<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> dilate<span class="token operator">=</span>replace_stride_with_dilation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>avgpool <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">512</span> <span class="token operator">*</span> block<span class="token punctuation">.</span>expansion<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

        <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">)</span><span class="token punctuation">:</span>
                nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>kaiming_normal_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"fan_out"</span><span class="token punctuation">,</span> nonlinearity<span class="token operator">=</span><span class="token string">"relu"</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token punctuation">(</span>nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>GroupNorm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># Zero-initialize the last BN in each residual branch,</span>
        <span class="token comment"># so that the residual branch starts with zeros, and each residual block behaves like an identity.</span>
        <span class="token comment"># This improves the model by 0.2~0.3% according to https://arxiv.org/abs/1706.02677</span>
        <span class="token keyword">if</span> zero_init_residual<span class="token punctuation">:</span>
            <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> Bottleneck<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>bn3<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore[arg-type]</span>
                <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> BasicBlock<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>bn2<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore[arg-type]</span>

    <span class="token keyword">def</span> <span class="token function">_make_layer</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        block<span class="token punctuation">:</span> Type<span class="token punctuation">[</span>Union<span class="token punctuation">[</span>BasicBlock<span class="token punctuation">,</span> Bottleneck<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        planes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        blocks<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        stride<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        dilate<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">:</span>
        norm_layer <span class="token operator">=</span> self<span class="token punctuation">.</span>_norm_layer
        downsample <span class="token operator">=</span> <span class="token boolean">None</span>
        previous_dilation <span class="token operator">=</span> self<span class="token punctuation">.</span>dilation
        <span class="token keyword">if</span> dilate<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>dilation <span class="token operator">*=</span> stride
            stride <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> stride <span class="token operator">!=</span> <span class="token number">1</span> <span class="token keyword">or</span> self<span class="token punctuation">.</span>inplanes <span class="token operator">!=</span> planes <span class="token operator">*</span> block<span class="token punctuation">.</span>expansion<span class="token punctuation">:</span>
            downsample <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                conv1x1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>inplanes<span class="token punctuation">,</span> planes <span class="token operator">*</span> block<span class="token punctuation">.</span>expansion<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">,</span>
                norm_layer<span class="token punctuation">(</span>planes <span class="token operator">*</span> block<span class="token punctuation">.</span>expansion<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

        layers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
            block<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>inplanes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> downsample<span class="token punctuation">,</span> self<span class="token punctuation">.</span>groups<span class="token punctuation">,</span> self<span class="token punctuation">.</span>base_width<span class="token punctuation">,</span> previous_dilation<span class="token punctuation">,</span> norm_layer
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>inplanes <span class="token operator">=</span> planes <span class="token operator">*</span> block<span class="token punctuation">.</span>expansion
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> blocks<span class="token punctuation">)</span><span class="token punctuation">:</span>
            layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                block<span class="token punctuation">(</span>
                    self<span class="token punctuation">.</span>inplanes<span class="token punctuation">,</span>
                    planes<span class="token punctuation">,</span>
                    groups<span class="token operator">=</span>self<span class="token punctuation">.</span>groups<span class="token punctuation">,</span>
                    base_width<span class="token operator">=</span>self<span class="token punctuation">.</span>base_width<span class="token punctuation">,</span>
                    dilation<span class="token operator">=</span>self<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span>
                    norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>layers<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_forward_impl</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
        <span class="token comment"># See note [TorchScript super()]</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x <span class="token operator">=</span> self<span class="token punctuation">.</span>avgpool<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment"># 获取这里的输出</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token keyword">return</span> x

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_forward_impl<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> 
<p>第一种做法：修改forward函数</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">import</span> resnet50

<span class="token keyword">def</span> <span class="token function">new_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> self<span class="token punctuation">.</span>avgpool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># x = self.fc(x)</span>
    <span class="token keyword">return</span> x

model <span class="token operator">=</span> resnet50<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>forward <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span>new_forward<span class="token punctuation">(</span>model<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
model <span class="token operator">=</span> model<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>第二种做法：删除model的全连接层，将它改成一个恒等映射</p> 
<pre><code class="prism language-python">resnet50 <span class="token operator">=</span> tv<span class="token punctuation">.</span>models<span class="token punctuation">.</span>resnet50<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">del</span> resnet50<span class="token punctuation">.</span>fc
resnet50<span class="token punctuation">.</span>fc <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x
resnet50<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>修改完ResNet的结构之后，就可以提取30000张图片的feature。代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-#</span>

<span class="token comment"># ----------------------------------------------</span>
<span class="token comment"># Name:         feature_extract.py</span>
<span class="token comment"># Description:  修改ResNet导数第二层，提取图片特征</span>
<span class="token comment"># Author:       PANG</span>
<span class="token comment"># Date:         2022/7/3</span>
<span class="token comment"># ----------------------------------------------</span>
<span class="token keyword">import</span> os

<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torchvision <span class="token keyword">as</span> tv
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils <span class="token keyword">import</span> data
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">import</span> resnet50

<span class="token keyword">from</span> Image_Caption<span class="token punctuation">.</span>config <span class="token keyword">import</span> Config

torch<span class="token punctuation">.</span>set_grad_enabled<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
opt <span class="token operator">=</span> Config<span class="token punctuation">(</span><span class="token punctuation">)</span>

IMAGENET_MEAN <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span>
IMAGENET_STD <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span>
normalize <span class="token operator">=</span> tv<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span>IMAGENET_MEAN<span class="token punctuation">,</span> std<span class="token operator">=</span>IMAGENET_STD<span class="token punctuation">)</span>


<span class="token comment"># 方案1：修改forward函数</span>
<span class="token keyword">def</span> <span class="token function">new_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># See note [TorchScript super()]</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>layer4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> self<span class="token punctuation">.</span>avgpool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># x = self.fc(x)</span>

    <span class="token keyword">return</span> x


<span class="token comment"># 方案2： 删除model的全连接层，将它改成一个恒等映射</span>
<span class="token comment"># model = resnet50(pretrained=False)</span>
<span class="token comment"># model.load_state_dict(torch.load("resnet50-19c8e357.pth"))</span>
<span class="token comment"># del model.fc</span>
<span class="token comment"># model.fc = lambda x:x</span>
<span class="token comment"># model = model.cuda()</span>

<span class="token keyword">class</span> <span class="token class-name">CaptionDataset</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> caption_data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>transforms <span class="token operator">=</span> tv<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
            tv<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            tv<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            tv<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            normalize
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>caption_data_path<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ix2id <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'ix2id'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>imgs <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>img_path<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ix2id<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ix2id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>imgs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>transforms<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        <span class="token keyword">return</span> img<span class="token punctuation">,</span> index

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>imgs<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_dataloader</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dataset <span class="token operator">=</span> CaptionDataset<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>caption_data_path<span class="token punctuation">)</span>
    dataloader <span class="token operator">=</span> data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span>opt<span class="token punctuation">.</span>num_workers<span class="token punctuation">)</span>
    <span class="token keyword">return</span> dataloader


<span class="token keyword">def</span> <span class="token function">feature_extract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 数据, 获取30000张图片</span>
    opt<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> <span class="token number">32</span> <span class="token comment"># 可以设置大一些</span>
    dataloader <span class="token operator">=</span> get_dataloader<span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
    results <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fill_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    batch_size <span class="token operator">=</span> opt<span class="token punctuation">.</span>batch_size

    <span class="token comment"># 模型</span>
    model <span class="token operator">=</span> resnet50<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"resnet50-19c8e357.pth"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 用新的forward函数覆盖旧的forward函数</span>
    model<span class="token punctuation">.</span>forward <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> new_forward<span class="token punctuation">(</span>model<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    model <span class="token operator">=</span> model<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 前向传播，获取feature</span>
    <span class="token keyword">for</span> ii<span class="token punctuation">,</span> <span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> indexs<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 确保序号没有对应错</span>
        <span class="token keyword">assert</span> indexs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> batch_size <span class="token operator">*</span> ii
        imgs <span class="token operator">=</span> imgs<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        features <span class="token operator">=</span> model<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span>
        results<span class="token punctuation">[</span>ii <span class="token operator">*</span> batch_size<span class="token punctuation">:</span><span class="token punctuation">(</span>ii <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> batch_size<span class="token punctuation">]</span> <span class="token operator">=</span> features<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>ii <span class="token operator">*</span> batch_size<span class="token punctuation">)</span>

    <span class="token comment"># 30000 * 2048 30000张图片，每张图片2048维的feature</span>
    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>results<span class="token punctuation">,</span> <span class="token string">'results_val_2048.pth'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    feature_extract<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>注意：dataloader不要shuffle，要按顺序，这样才能和ix2id中的序号和图片文件名一一对应。</p> 
<h3><a id="23__628"></a>2.3 数据加载</h3> 
<p>首先，将数据封装成dataset。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CaptionDataset</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Attributes:
            _data (dict): 预处理之后的数据，包括所有图片的文件名，以及处理过后的描述
            all_imgs (tensor): 利用resnet50提取的图片特征，形状（30000，2048）
            caption(list): 长度为3万的list，包括每张图片的文字描述
            ix2id(dict): 指定序号的图片对应的文件名
            start_(int): 起始序号，训练集的起始序号是0，验证集的起始序号是29000，
                        即前29000张图片是训练集，剩下的1000张图片是验证集
            len_(init): 数据集大小，如果是训练集，长度就是29000，验证集长度为1000
            traininig(bool): 是训练集(True),还是验证集(False)
        """</span>
        self<span class="token punctuation">.</span>opt <span class="token operator">=</span> opt
        data <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>caption_data_path<span class="token punctuation">)</span>
        word2ix <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'word2ix'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>captions <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'caption'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>padding <span class="token operator">=</span> word2ix<span class="token punctuation">.</span>get<span class="token punctuation">(</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'padding'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end <span class="token operator">=</span> word2ix<span class="token punctuation">.</span>get<span class="token punctuation">(</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_data <span class="token operator">=</span> data
        self<span class="token punctuation">.</span>ix2id <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'ix2id'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>all_imgs <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>img_feature_path<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        返回：
        - img: 图像features 2048的向量
        - caption: 描述，形如LongTensor([1,3,5,2]),长度取决于描述长度
        - index: 下标，图像的序号，可以通过ix2id[index]获取对应图片文件名
        """</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>all_imgs<span class="token punctuation">[</span>index<span class="token punctuation">]</span>

        caption <span class="token operator">=</span> self<span class="token punctuation">.</span>captions<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token comment"># 5句描述随机选一句</span>
        rdn_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>caption<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        caption <span class="token operator">=</span> caption<span class="token punctuation">[</span>rdn_index<span class="token punctuation">]</span>
        <span class="token keyword">return</span> img<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>caption<span class="token punctuation">)</span><span class="token punctuation">,</span> index

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ix2id<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        在训练集和测试集之间切换，training为True，getitem返回训练集的数据，否则返回验证集的数据
        :param training:
        :return:
        """</span>
        self<span class="token punctuation">.</span>training <span class="token operator">=</span> training
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_start <span class="token operator">=</span> <span class="token number">0</span>
            self<span class="token punctuation">.</span>len_ <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1000</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_start <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ix2id<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1000</span>
            self<span class="token punctuation">.</span>len_ <span class="token operator">=</span> <span class="token number">1000</span>
        <span class="token keyword">return</span> self
</code></pre> 
<p>注意：在<code>__getitem</code>__中，dataset会返回一个样本的数据，在dataloader中，会将每个样本的数据拼接成一个batch，可是由于描述的长短不一，无法拼接成一个batch，这需要自己实现一个collate_fn，将每一个batch长短不一的数据拼接成一个tensor。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">create_collate_fn</span><span class="token punctuation">(</span>padding<span class="token punctuation">,</span> eos<span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">collate_fn</span><span class="token punctuation">(</span>img_cap<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        将多个样本拼接在一起成一个batch
        输入： list of data，形如
        [(img1, cap1, index1), (img2, cap2, index2) ....]

        拼接策略如下：
        - batch中每个样本的描述长度都是在变化的，不丢弃任何一个词\
            - 选取长度最长的句子，将所有句子pad成一样长
            - 长度不够的用&lt;/PAD&gt;在结尾PAD
            - 没有START标识符
            - 如果长度刚好和词一样，那么就没有&lt;/EOS&gt;

        返回：
        - imgs(Tensor): batch_sie*2048
        - cap_tensor(Tensor): batch_size*max_length
        - lengths(list of int): 长度为batch_size
        - index(list of int): 长度为batch_size
        """</span>
        img_cap<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        imgs<span class="token punctuation">,</span> caps<span class="token punctuation">,</span> indexs <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>img_cap<span class="token punctuation">)</span>
        imgs <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> img <span class="token keyword">in</span> imgs<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        lengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> max_length<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> caps<span class="token punctuation">]</span>
        batch_length <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>
        cap_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>batch_length<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>caps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fill_<span class="token punctuation">(</span>padding<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>caps<span class="token punctuation">)</span><span class="token punctuation">:</span>
            end_cap <span class="token operator">=</span> lengths<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token keyword">if</span> end_cap <span class="token operator">&lt;</span> batch_length<span class="token punctuation">:</span>
                cap_tensor<span class="token punctuation">[</span>end_cap<span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> eos
            cap_tensor<span class="token punctuation">[</span><span class="token punctuation">:</span>end_cap<span class="token punctuation">,</span> i<span class="token punctuation">]</span><span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>c<span class="token punctuation">[</span><span class="token punctuation">:</span>end_cap<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> imgs<span class="token punctuation">,</span> <span class="token punctuation">(</span>cap_tensor<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span><span class="token punctuation">,</span> indexs

    <span class="token keyword">return</span> collate_fn
</code></pre> 
<p>封装完成之后，就可以在训练时调用了：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_dataloader</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dataset <span class="token operator">=</span> CaptionDataset<span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
    n_train <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    split_train<span class="token punctuation">,</span> split_valid <span class="token operator">=</span> random_split<span class="token punctuation">(</span>dataset<span class="token operator">=</span>dataset<span class="token punctuation">,</span> lengths<span class="token operator">=</span><span class="token punctuation">[</span>n_train<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span> <span class="token operator">-</span> n_train<span class="token punctuation">]</span><span class="token punctuation">)</span>
    train_dataloader <span class="token operator">=</span> data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>split_train<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span>opt<span class="token punctuation">.</span>shuffle<span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                                       collate_fn<span class="token operator">=</span>create_collate_fn<span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span>
    valid_dataloader <span class="token operator">=</span> data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>split_valid<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span>opt<span class="token punctuation">.</span>shuffle<span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                                       collate_fn<span class="token operator">=</span>create_collate_fn<span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> train_dataloader<span class="token punctuation">,</span> valid_dataloader
    <span class="token comment"># dataloader = data.DataLoader(dataset, batch_size=opt.batch_size, shuffle=opt.shuffle, num_workers=0,</span>
    <span class="token comment">#                              collate_fn=create_collate_fn(dataset.padding, dataset.end))</span>
    <span class="token comment"># return dataloader</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> Image_Caption<span class="token punctuation">.</span>config <span class="token keyword">import</span> Config

    opt <span class="token operator">=</span> Config<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opt<span class="token punctuation">.</span>num_workers <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment"># 添加: 线程数设置为1</span>
    dataloader <span class="token operator">=</span> get_dataloader<span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
    <span class="token keyword">for</span> ii<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">break</span>

</code></pre> 
<h2><a id="3__751"></a>3. 模型与训练</h2> 
<p>在完成数据处理之后，就可以利用PyTorch训练模型进行训练了。<br> （1）图片经过ResNet提取成2028维度的向量，然后利用全连接层转成256维向量，可以认为从图像的语义空间转成了词向量的语义空间。<br> （2）描述经过Embedding层，每个词都变成了256维的向量<br> （3）将第一步和第二步得到的词向量拼接在一起，送入LSTM中，计算每个词的输出。<br> （4）利用每个词的输出进行分类，预测下一个词（分类）</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CaptionModel</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> word2ix<span class="token punctuation">,</span> ix2word<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CaptionModel<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ix2word <span class="token operator">=</span> ix2word
        self<span class="token punctuation">.</span>word2ix <span class="token operator">=</span> word2ix
        self<span class="token punctuation">.</span>opt <span class="token operator">=</span> opt
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>rnn_hidden<span class="token punctuation">)</span>  <span class="token comment"># 利用全连接层转成256维的向量</span>

        self<span class="token punctuation">.</span>rnn <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>embedding_dim<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>rnn_hidden<span class="token punctuation">,</span> num_layers<span class="token operator">=</span>opt<span class="token punctuation">.</span>num_layers<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>rnn_hidden<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word2ix<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>embedding <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word2ix<span class="token punctuation">)</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>embedding_dim<span class="token punctuation">)</span>
        <span class="token comment"># if opt.share_embedding_weights:</span>
        <span class="token comment">#     # rnn_hidden=embedding_dim的时候才可以</span>
        <span class="token comment">#     self.embedding.weight</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_feats<span class="token punctuation">,</span> captions<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span><span class="token punctuation">:</span>
        embeddings <span class="token operator">=</span> self<span class="token punctuation">.</span>embedding<span class="token punctuation">(</span>captions<span class="token punctuation">)</span>
        <span class="token comment"># img_feats是2048维的向量，通过全连接层转为256维的向量，和词向量一样</span>
        img_feats <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>img_feats<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># 将img_feats看成第一个词的词向量，和其他词向量拼接在一起</span>
        embeddings <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>img_feats<span class="token punctuation">,</span> embeddings<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># PackedSequence</span>
        packed_embeddings <span class="token operator">=</span> pack_padded_sequence<span class="token punctuation">(</span>embeddings<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span>
        outputs<span class="token punctuation">,</span> state <span class="token operator">=</span> self<span class="token punctuation">.</span>rnn<span class="token punctuation">(</span>packed_embeddings<span class="token punctuation">)</span>
        <span class="token comment"># lstm的输出作为特征用来分类预测下一个词的序号</span>
        <span class="token comment"># 因为输入是PackedSequence， 所以输出的output也是PackedSequence</span>
        <span class="token comment"># PackedSequence的第一个元素是Variable, 即outputs[0]</span>
        <span class="token comment"># 第二个元素是batch_size, 即batch中每个样本的长度</span>
        pred <span class="token operator">=</span> self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> pred<span class="token punctuation">,</span> state

    <span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">,</span> eos_token<span class="token operator">=</span><span class="token string">'&lt;/EOS&gt;'</span><span class="token punctuation">,</span> beam_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> max_caption_length<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> length_normalization_factor<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        根据图片生成描述,主要是使用beam search算法以得到更好的描述
        beam search算法是一个动态规划算法，它每次搜索的时候，不是只记下最可能的一个词，而是记住最可能的k个词，然后继续搜索下一个词，
        找到k^2个序列，保存概率最大的k，就这样不断搜索直到最后得到最优结果。

        """</span>
        cap_gen <span class="token operator">=</span> CaptionGenerator<span class="token punctuation">(</span>embedder<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding<span class="token punctuation">,</span>
                                   rnn<span class="token operator">=</span>self<span class="token punctuation">.</span>rnn<span class="token punctuation">,</span>
                                   classifier<span class="token operator">=</span>self<span class="token punctuation">.</span>classifier<span class="token punctuation">,</span>
                                   eos_id<span class="token operator">=</span>self<span class="token punctuation">.</span>word2ix<span class="token punctuation">[</span>eos_token<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                   beam_size<span class="token operator">=</span>beam_size<span class="token punctuation">,</span>
                                   max_caption_length<span class="token operator">=</span>max_caption_length<span class="token punctuation">,</span>
                                   length_normalization_factor<span class="token operator">=</span>length_normalization_factor<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">next</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_cuda<span class="token punctuation">:</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> img<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        sentences<span class="token punctuation">,</span> score <span class="token operator">=</span> cap_gen<span class="token punctuation">.</span>beam_search<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        sentences <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>ix2word<span class="token punctuation">[</span>idx<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> idx <span class="token keyword">in</span> sent<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> sent <span class="token keyword">in</span> sentences<span class="token punctuation">]</span>
        <span class="token keyword">return</span> sentences
</code></pre> 
<p>这里比较复杂的地方在于PackedSequence的使用，由于LSTM的输入是PackedSequence，所以输出也是PackedSequence，PackedSequence是一个特殊的tuple，即可以通过packedsequence.data获得对应的variable，也可以通过packedsequence[0]获得。如果想要获得对应的tensor，则需要packedsequence.data.data，第一个data得到的是variable，第二个data得到的是tensor。因为总共大约有10000个词，所以最终变成了一个10000分类问题，采用交叉熵损失作为目标函数。<br> 训练部分代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    opt <span class="token operator">=</span> Config<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">setattr</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> opt<span class="token punctuation">.</span>use_gpu <span class="token keyword">else</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>

    opt<span class="token punctuation">.</span>caption_data_path <span class="token operator">=</span> <span class="token string">'caption_validation.pth'</span>  <span class="token comment"># 原始数据</span>
    opt<span class="token punctuation">.</span>test_img <span class="token operator">=</span> <span class="token string">'example.jpeg'</span>  <span class="token comment"># 输入图片</span>
    <span class="token comment"># opt.model_ckpt='caption_0914_1947' # 预训练的模型</span>

    <span class="token comment"># 数据</span>
    vis <span class="token operator">=</span> Visualizer<span class="token punctuation">(</span>env<span class="token operator">=</span>opt<span class="token punctuation">.</span>env<span class="token punctuation">)</span>
    <span class="token comment"># dataloader = get_dataloader(opt)</span>
    train_dataloader<span class="token punctuation">,</span> valid_dataloader <span class="token operator">=</span> get_dataloader<span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
    <span class="token comment"># 数据预处理</span>
    _data <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>caption_data_path<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token keyword">lambda</span> s<span class="token punctuation">,</span> l<span class="token punctuation">:</span> s<span class="token punctuation">)</span>
    word2ix<span class="token punctuation">,</span> ix2word <span class="token operator">=</span> _data<span class="token punctuation">[</span><span class="token string">'word2ix'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> _data<span class="token punctuation">[</span><span class="token string">'ix2word'</span><span class="token punctuation">]</span>

    <span class="token comment"># _data = dataloader.dataset._data</span>
    <span class="token comment"># word2ix, ix2word = _data['word2ix'], _data['ix2word']</span>
    max_loss <span class="token operator">=</span> <span class="token number">263</span>

    <span class="token comment"># 模型</span>
    model <span class="token operator">=</span> CaptionModel<span class="token punctuation">(</span>opt<span class="token punctuation">,</span> word2ix<span class="token punctuation">,</span> ix2word<span class="token punctuation">)</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>model_ckpt<span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>model_ckpt<span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> model<span class="token punctuation">.</span>get_optimizer<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>lr<span class="token punctuation">)</span>
    criterion <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>

    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># 统计</span>
    loss_meter <span class="token operator">=</span> meter<span class="token punctuation">.</span>AverageValueMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    valid_losses <span class="token operator">=</span> meter<span class="token punctuation">.</span>AverageValueMeter<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>max_epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        loss_meter<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        valid_losses<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> ii<span class="token punctuation">,</span> <span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> <span class="token punctuation">(</span>captions<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span><span class="token punctuation">,</span> indexes<span class="token punctuation">)</span> <span class="token keyword">in</span> tqdm<span class="token punctuation">.</span>tqdm<span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_dataloader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 训练</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            imgs <span class="token operator">=</span> imgs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            captions <span class="token operator">=</span> captions<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            input_captions <span class="token operator">=</span> captions<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            target_captions <span class="token operator">=</span> pack_padded_sequence<span class="token punctuation">(</span>captions<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            score<span class="token punctuation">,</span> _ <span class="token operator">=</span> model<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> input_captions<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>score<span class="token punctuation">,</span> target_captions<span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss_meter<span class="token punctuation">.</span>add<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># 可视化</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ii <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> opt<span class="token punctuation">.</span>plot_every <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>debug_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    ipdb<span class="token punctuation">.</span>set_trace<span class="token punctuation">(</span><span class="token punctuation">)</span>

                vis<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token string">'loss'</span><span class="token punctuation">,</span> loss_meter<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

                <span class="token comment"># 可视化原始图片 + 可视化人工的描述语句</span>
                raw_img <span class="token operator">=</span> _data<span class="token punctuation">[</span><span class="token string">'ix2id'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>indexes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
                img_path <span class="token operator">=</span> opt<span class="token punctuation">.</span>img_path <span class="token operator">+</span> raw_img
                raw_img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
                raw_img <span class="token operator">=</span> tv<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>raw_img<span class="token punctuation">)</span>

                raw_caption <span class="token operator">=</span> captions<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
                raw_caption <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>_data<span class="token punctuation">[</span><span class="token string">'ix2word'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>ii<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> ii <span class="token keyword">in</span> raw_caption<span class="token punctuation">]</span><span class="token punctuation">)</span>
                vis<span class="token punctuation">.</span>text<span class="token punctuation">(</span>raw_caption<span class="token punctuation">,</span> <span class="token string">u'raw_caption'</span><span class="token punctuation">)</span>
                vis<span class="token punctuation">.</span>img<span class="token punctuation">(</span><span class="token string">'raw'</span><span class="token punctuation">,</span> raw_img<span class="token punctuation">,</span> caption<span class="token operator">=</span>raw_caption<span class="token punctuation">)</span>

                <span class="token comment"># 可视化网络生成的描述语句</span>
                results <span class="token operator">=</span> model<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>imgs<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                vis<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token string">'&lt;/br&gt;'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">u'caption'</span><span class="token punctuation">)</span>
                model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                total_loss <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">for</span> ii<span class="token punctuation">,</span> <span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> <span class="token punctuation">(</span>captions<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span><span class="token punctuation">,</span> indexes<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>valid_dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        imgs <span class="token operator">=</span> imgs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                        captions <span class="token operator">=</span> captions<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                        input_captions <span class="token operator">=</span> captions<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
                        target_captions <span class="token operator">=</span> pack_padded_sequence<span class="token punctuation">(</span>captions<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                        score<span class="token punctuation">,</span> _ <span class="token operator">=</span> model<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> input_captions<span class="token punctuation">,</span> lengths<span class="token punctuation">)</span>
                        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>score<span class="token punctuation">,</span> target_captions<span class="token punctuation">)</span>
                        total_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
                valid_losses<span class="token punctuation">.</span>add<span class="token punctuation">(</span>total_loss<span class="token punctuation">)</span>
                <span class="token keyword">if</span> total_loss <span class="token operator">&lt;</span> max_loss<span class="token punctuation">:</span>
                    max_loss <span class="token operator">=</span> total_loss
                    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'checkpoints/model_best.pth'</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>max_loss<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>loss_meter<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>valid_losses<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="3__909"></a>3. 实验结果</h2> 
<p>实验效果不是很好，如下所示：<br> <img src="https://images2.imgbox.com/ba/25/8PKEqwFC_o.png" alt="实验效果"><br> 总体来看，模型能够提取出图片的基本元素和对象之间的关系，但是生成的描述质量距离人类的水平还有不小的距离。</p> 
<h2><a id="_913"></a>参考资料</h2> 
<p>[1] 《深度学习框架PyTorch：入门到实践》<br> [2] <a href="https://blog.csdn.net/qq_41897800?type=blog">Yang SiCheng: 【PyTorch】13 Image Caption：让神经网络看图讲故事</a><br> [3] <a href="https://blog.csdn.net/qq_33427431/article/details/87929905">今天敲代码了么: pytorch入门与实践学习笔记：chapter10 神经网络看图讲故事</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/357b23c471486c10b518f6be34c786d5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Hyperledger Fabric 03 超详细图解——通过Fabric测试网络深入理解联盟链</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3794f6854beaec0ce5d1a83ab69c38ec/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ubuntu20.04安装ROS Noetic (一篇博客走遍天)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>