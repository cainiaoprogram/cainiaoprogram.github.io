<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Oracle--其他复杂查询 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Oracle--其他复杂查询" />
<meta property="og:description" content="其他复杂查询 当开发数据库应用程序时，除了使用基本查询、数据分组、连接查询、子查询之外，还需要使用集合操作符、层次查询、Flashback查询等。
一、使用集合操作符
集合操作符专门用于合并多条SELECT语句的结果，包括UNION、UNION ALL、INTERSECT和MINUS四个操作符。
这些集合操作符具有相同的优先级，当同时使用多个操作符时，会按照先后顺序引用这些集合操作符。
当使用集合操作符时，必须确保不同查询的列个数和数据类型匹配。
另外，使用集合操作符具有以下限制：
集合操作符不适用于LOB、VARRAY和嵌套表列。
UNION、INTERSECT、MINUS操作符不适用于LONG列。
如果选择列表包含有表达式或者函数，那么必须为表达式或者函数定义列别名。
在介绍如何使用这些集合操作符之前，首先建立MANAGER表和WORKER表。
CREATE TABLE manager(id,name,job,sal) AS
SELECT empno,ename,job,sal FROM emp
where empno in(select distinct nvl(mgr,0) FROM emp);
CREATE TABLE worker(id,name,job,sal) AS
SELECT empno,ename,job,sal FROM emp
where empno not in (select distinct nvl(mgr,0) FROM emp);
1.UNION
UNION操作符用于取得俩个结果的并集。当使用该操作符时，会自动去掉结果集中的重复行，并且会以第一列的结果升序排列。
SELECT id,name,job FROM manager UNION
SELECT empno,ename,job FROM emp;
2.UNION ALL
UNION ALL操作符用于取得俩个结果集的并集。但与UNION操作符不同，该操作符不会取消重复值，并且不会对结果集数据进行排序。
SELECT id,name,job FROM worker UNION ALL
SELECT empno,ename,job FROM emp;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c20b032062498d506b0eb9a91502d92c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-05-07T14:05:26+08:00" />
<meta property="article:modified_time" content="2019-05-07T14:05:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Oracle--其他复杂查询</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>                                       其他复杂查询</h3> 
<p>     当开发数据库应用程序时，除了使用基本查询、数据分组、连接查询、子查询之外，还需要使用集合操作符、层次查询、Flashback查询等。<br><strong>一、使用集合操作符</strong><br>        集合操作符专门用于合并多条SELECT语句的结果，包括UNION、UNION ALL、INTERSECT和MINUS四个操作符。<br> 这些集合操作符具有相同的优先级，当同时使用多个操作符时，会按照先后顺序引用这些集合操作符。<br> 当使用集合操作符时，必须确保不同查询的列个数和数据类型匹配。<br> 另外，使用集合操作符具有以下限制：<br>     集合操作符不适用于LOB、VARRAY和嵌套表列。<br>     UNION、INTERSECT、MINUS操作符不适用于LONG列。<br>     如果选择列表包含有表达式或者函数，那么必须为表达式或者函数定义列别名。<br> 在介绍如何使用这些集合操作符之前，首先建立MANAGER表和WORKER表。<br> CREATE TABLE manager(id,name,job,sal) AS<br> SELECT empno,ename,job,sal FROM emp<br> where empno in(select distinct nvl(mgr,0) FROM emp);<br> CREATE TABLE worker(id,name,job,sal) AS<br> SELECT empno,ename,job,sal FROM emp<br> where empno not in (select distinct nvl(mgr,0) FROM emp);<br><span style="color:#f33b45;">1.UNION</span><br> UNION操作符用于取得俩个结果的并集。当使用该操作符时，会自动去掉结果集中的重复行，并且会以第一列的结果升序排列。<br> SELECT id,name,job FROM manager UNION<br> SELECT empno,ename,job FROM emp;<br><span style="color:#f33b45;">2.UNION ALL</span><br> UNION ALL操作符用于取得俩个结果集的并集。但与UNION操作符不同，该操作符不会取消重复值，并且不会对结果集数据进行排序。<br> SELECT id,name,job FROM worker UNION ALL<br> SELECT empno,ename,job FROM emp;<br><span style="color:#f33b45;">3.INTERSECT</span><br> INTERSECT操作符用于取得俩个结果集的交集。当使用该操作符时，只会显示同时存在俩个结果集中的数据，并且会以第一列的结果进行升序排序。<br> SELECT id,name,job FROM worker INTERSECT<br> SELECT empno,ename,job FROM emp;<br><span style="color:#f33b45;">4.MINUS</span><br> MINUS操作符用于取得俩个结果集的差集。当使用该操作符时，只会显示在第一个结果集中存在，<br> 在第二个结果集中不存在的数据，并且会以第一列的结果进行升序排列。<br> SELECT empno,ename,job FROM emp MINUS<br> SELECT id,name,job FROM worker;<br><span style="color:#f33b45;">5.控制结果顺序</span><br> 当使用集合操作符UNION、INTERSECT和MINUS时，默认情况下会自动基于第一列进行升序排序；而当使用集合操作符UNION ALL时，不会进行排序。<br> 为了控制结果的排序顺序，可以使用order by子句。注意：该子句必须放在最后一条SELECT语句之后。<br> 当指定order by子句时，列名相同可以直接使用列名排序，列名不同必须使用列位置排序。<br> SELECT id,name,job FROM worker INTERSECT<br> SELECT empno,ename,job FROM emp order by 2;</p> 
<p><strong>二、层次查询</strong><br> 层次查询用于检索具有层次结构的表行数据。在Oracle数据库中，数据库数据是以关系结构方式存储的，但是层次数据可以存放在单个表中。<br> 当表具有层次结构的数据时，通过使用层次查询可以更直观地显示数据结果，并显示其数据之间的层次关系。层次查询的语法如下：<br> SELECT [LEVEL],column,expr... FROM table<br> [WHERE condition]<br> START WITH condition<br> CONNECT BY [PRIOR column1 = column2 | column = PRIOR column];<br> 如上所示，伪列LEVEL用于返回层次结构的层次(1:根行，2：第二级行，3：第三级行，......)，START WITH子句用于指定层次查询的根行，<br> CONNECT BY 子句用于指定父行和子行之间的关系，当定义父行和子行的关系时，必须使用PRIOR关键字，并且column1和column2对应于父键或者子健列。<br> 当使用层次查询显示层次结构的表行数据时，可以采用从顶向下或者从底向上俩种方式显示数据。<br><span style="color:#f33b45;">1.示例一，使用PRIOR column1=column2从顶向下显示层次数据</span><br> SELECT LPAD(' ',3*(LEVEL-1))||ename ename,<br> LPAD(' ',3*(LEVEL-1))||job job FROM emp<br> start with ename='JONES' connect by prior empno=MGR;<br><span style="color:#f33b45;">2.示例二，使用column1=PRIOR column2从顶向下显示层次数据</span><br> SELECT LPAD(' ',3*(LEVEL-1))||ename ename,<br> LPAD(' ',3*(LEVEL-1))||job job FROM emp<br> start with ename='BLAKE' connect by mgr=PRIOR empno;<br><span style="color:#f33b45;">3.示例三，使用PRIOR column1=column2从底向上显示层次数据</span><br> SELECT LPAD(' ',3*(LEVEL-1))||ename ename,<br> LPAD(' ',3*(LEVEL-1))||job job FROM emp<br> start with ename='SMITH' connect by PRIOR mgr=empno;<br><span style="color:#f33b45;">4.示例四，column1=PRIOR column2从底向上显示层次数据</span><br> SELECT LPAD(' ',3*(LEVEL-1))||ename ename,<br> LPAD(' ',3*(level-1))||job job FROM emp<br> start with ename='ALLEN' connect by empno=PRIOR mgr;<br><strong>三、使用条件表达式</strong><br><span style="color:#f33b45;">1.使用DECODE函数</span><br> 语法如下：<br> DECODE(col|expr,search1,result1[,search2,result2,...,][,default])<br> 如上所示,col用于指定列名，expr用于指定表达式，如果列或者表达式的结果匹配于search1,则返回result1，以此类推；<br> 如果列或者表达式不匹配与任何search，则返回default。<br> SELECT ename,deptno,sal,DECODE(deptno,10,sal*1.2,20,sal*1.1,sal) "Actual Salary"<br> FROM emp;<br><span style="color:#f33b45;">2.使用CASE表达式</span><br> 使用CASE表达式处理多重条件分支有两种方法，第一种方法是使用单一选择符进行等值比较；第二种方法是使用多种条件进行非等值比较。<br> ①在CASE表达式中使用单一选择符进行等值比较<br> 当使用CASE表达式执行多重条件分支时，如果条件选择符完全相同，并且条件表达式为相等条件选择，那么可以选择使用单一条件选择符进行等值比较。<br> 语法如下：<br> CASE selector<br>      WHEN expr1 THEN return_expr1<br>      WHEN expr2 THEN return_expr2<br>      ...<br>      WHEN exprN THEN return_exprN<br>      [ELSE return_expr]<br> END<br>   如下所示，selector用于指定条件选择符，expr用于指定条件表达式，return_expr用于指定要返回的值表达式。<br> SELECT ename,deptno,sal,CASE deptno<br>     WHEN 10 THEN sal*1.2 WHEN 20 THEN sal*1.1<br>     ELSE sal END "Actual Salary"<br> FROM emp;<br> ②在CASE表达式中使用多种条件比较<br> 当使用单一条件选择符进行等值比较时，可以使用CASE selector语法实现。如果包含有多种条件进行不等比较，那么必须在WHEN子句中指定比较条件。<br> 语法如下：<br> CASE<br>     WHEN search_condition1 THEN return_expr1<br>     WHEN search_condition2 THEN return_expr2<br>     ...<br>     WHEN search_conditionN THEN return_exprN<br>     [ELSE return_expr]<br> END<br> 如上所示，search_condition用于指定不同比较条件，return_expr用于指定返回值的表达式。<br> SELECT ename,sal,CASE WHEN sal&lt;2000 THEN sal*1.2<br>     WHEN sal&lt;3000 THEN sal*1.1 ELSE sal END "Actual Salary"<br> FROM emp;<br><strong>四、Flashback查询</strong><br> 当执行查询操作时，默认情况下会显示当前数据。通过利用Flashback特征，可以显示过去特定时间点或者特定SCN的表数据。<br> 注意：如果使用Flashback查询，那么要求数据库必须采用自动UNDO管理方式。<br> 在介绍如何使用Flashback之前，首先执行如下语句：<br> conn system/123456<br> SELECT systimestamp FROM dual;<br> SELECT sal FROM scott.emp WHERE empno=7788;<br> commit;<br> SELECT current_scn FROM v$database;</p> 
<p>SQL&gt; select current_scn from v$database;  （v$database--系统视图）</p> 
<p>CURRENT_SCN<br> -----------<br>     2048219<br> update scott.emp set sal=2500 where empno=7788;<br> commit;    </p> 
<p><span style="color:#f33b45;">1.显示当前数据</span><br> 当执行查询操作时，默认情况下会显示当前数据。<br> SELECT sal FROM scott.emp WHERE empno=7788;</p> 
<p>SQL&gt; SELECT sal FROM scott.emp WHERE empno=7788;</p> 
<p>       SAL<br> ----------<br>       2500<br><span style="color:#f33b45;">2.使用AS OF TIMESTAMP子句查看过去时间点的数据</span><br> 当执行Flashback查询时，通过使用AS OF TIMESTAMP子句，可以查看过去时间点的数据。<br> SELECT sal FROM scott.emp AS OF TIMESTAMP TO_TIMESTAMP('07-5月 -19 10.26.07') WHERE empno=7788;</p> 
<p>SQL&gt; SELECT sal FROM scott.emp AS OF TIMESTAMP TO_TIMESTAMP('07-5月 -19 10.26.07') WHERE empno=7788;</p> 
<p>       SAL<br> ----------<br>       1600<br>     <br><span style="color:#f33b45;">3.使用AS OF SCN子句查看过去SCN点的数据</span><br> 当执行Flashback查询时，通过使用AS OF SCN子句，可以查看过去SCN点的数据。<br> SELECT SAL FROM SCOTT.EMP AS OF SCN 2048219 WHERE EMPNO=7788;</p> 
<p>SQL&gt; SELECT SAL FROM SCOTT.EMP AS OF SCN 2048219 WHERE EMPNO=7788;</p> 
<p>       SAL<br> ----------<br>       2000</p> 
<p>    </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8beedfb980d7faf4a13ea6210af83610/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java基础类库之Observable（观察者模式）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/623f4ec3ee01864a590eace9e32a4483/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">“是男人就下一百层”h5游戏全网最详细教学、全代码，js操作</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>