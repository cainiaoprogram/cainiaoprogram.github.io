<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Core3.0 EntityFrameWork DbFirst  and CodeFirst - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Core3.0 EntityFrameWork DbFirst  and CodeFirst" />
<meta property="og:description" content="DbFirst Asp.net Core3.0 MVC下使用EntityFrameWork框架实现DbFirst
一：生成
DbFirst 数据库优先
首先NuGet引入以下包
Microsoft.EntityFrameworkCore
Microsoft.EntityFrameworkC ore.Tools
Microsoft.EntityFrameworkCore.Design
Microsoft.EntityFrameworkCore.SqlServer
Microsoft.EntityFrameworkCore. SqlServer.Design
其次在程序包管理器控制台输入：
Scaffold-DbContext &#34;Server=.;database=Core;uid=sa;pwd=123456&#34; （数据库连接字符串）Microsoft.EntityFrameworkCore.SqlServer -OutputDir GeneralModels（任意文件夹名）
回车即可
生成后如下图
Ps:
CoreContext.cs是DbFirst根据数据库名称自动生成的数据库上下文类，不要擅自更改以免报错
然后打开上下文类注释掉OnConfiguring方法或者三个方法一起注释掉
其次打开appsettings.json文件，加入红色框中字符串，将其数据库连接写入配置文件。
最后打开Startup类，在ConfigureServices中注册添加代码：
即可
二：使用上下文增删改查
举例：在HomeController中使用上下文查询数据，在这里需要用到依赖注入中的构造函数注入，这里不过多阐述依赖注入原理，仅实现此次功能。
首先：声明一个上下文私有变量
private readonly CoreContext _coreContext;
然后：实例一个HomeConroller构造函数
public HomeController(CoreContext coreContext)
{
this._coreContext = coreContext;
}
这样我们就拿到了数据库上下文这个实例。
最后我们就可以进行增删改查了
这里直接贴出代码
如果数据库有修改字段或者表
在上面创建的命令后面 添加 -f 就好，-f 表示 -Force 覆盖
增、改、查的测试在下面 如果遇到 Build failed. 且没有提示，请把 项目 生成成功不报错了再执行 CodeFirst 先引用 NuGet 包
再编写继承自 DbContext 的数据库上下文类" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7ab19326ead0889c8c11b3bed6a8fb0e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-28T17:33:17+08:00" />
<meta property="article:modified_time" content="2020-04-28T17:33:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Core3.0 EntityFrameWork DbFirst  and CodeFirst</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>DbFirst</h2> 
<p>Asp.net Core3.0 MVC下使用EntityFrameWork框架实现DbFirst</p> 
<p>一：生成</p> 
<p>DbFirst 数据库优先</p> 
<p>首先NuGet引入以下包</p> 
<p>Microsoft.EntityFrameworkCore</p> 
<p>Microsoft.EntityFrameworkC ore.Tools</p> 
<p>Microsoft.EntityFrameworkCore.Design</p> 
<p>Microsoft.EntityFrameworkCore.SqlServer</p> 
<p>Microsoft.EntityFrameworkCore. SqlServer.Design</p> 
<p>其次在程序包管理器控制台输入：</p> 
<p>Scaffold-DbContext "Server=.;database=Core;uid=sa;pwd=123456" （数据库连接字符串）Microsoft.EntityFrameworkCore.SqlServer -OutputDir GeneralModels（任意文件夹名）</p> 
<p>回车即可</p> 
<p>生成后如下图</p> 
<p><img alt="" src="https://images2.imgbox.com/36/6c/OaX5qnzg_o.png"></p> 
<p>Ps:</p> 
<p>CoreContext.cs是DbFirst根据数据库名称自动生成的数据库上下文类，不要擅自更改以免报错</p> 
<p> </p> 
<p>然后打开上下文类注释掉OnConfiguring方法或者三个方法一起注释掉</p> 
<p><img alt="" src="https://images2.imgbox.com/b9/12/VpBgi9F3_o.png"></p> 
<p>其次打开appsettings.json文件，加入红色框中字符串，将其数据库连接写入配置文件。</p> 
<p><img alt="" src="https://images2.imgbox.com/48/5a/1lsEGIgn_o.png"></p> 
<p>最后打开Startup类，在ConfigureServices中注册添加代码：</p> 
<p><img alt="" src="https://images2.imgbox.com/c3/d3/VwSb4vax_o.png"></p> 
<p>即可</p> 
<p>二：使用上下文增删改查</p> 
<p>举例：在HomeController中使用上下文查询数据，在这里需要用到依赖注入中的构造函数注入，这里不过多阐述依赖注入原理，仅实现此次功能。</p> 
<p>首先：声明一个上下文私有变量</p> 
<p>private readonly CoreContext _coreContext;</p> 
<p>然后：实例一个HomeConroller构造函数</p> 
<p>public HomeController(CoreContext coreContext)</p> 
<p>{<!-- --></p> 
<p>this._coreContext = coreContext;</p> 
<p>}</p> 
<p><img alt="" src="https://images2.imgbox.com/96/12/BH59pUeO_o.png"></p> 
<p>这样我们就拿到了数据库上下文这个实例。</p> 
<p>最后我们就可以进行增删改查了</p> 
<p>这里直接贴出代码</p> 
<p><img alt="" src="https://images2.imgbox.com/15/fe/wYbbhm7e_o.png"></p> 
<p> </p> 
<p><strong>如果数据库有修改字段或者表</strong></p> 
<p>在上面创建的命令后面 添加 -f 就好，-f 表示 <em>-Force 覆盖</em></p> 
<p><img alt="" height="114" src="https://images2.imgbox.com/67/b0/gyxgaXci_o.png" width="860"></p> 
<p><img alt="" height="89" src="https://images2.imgbox.com/17/d7/i6w0xTUt_o.png" width="850"></p> 
<p><span style="color:#e579b6;"><u>增、改、查的测试在下面 </u></span></p> 
<p><img alt="" height="95" src="https://images2.imgbox.com/bb/53/Vnbs5VBS_o.png" width="1167"></p> 
<h4><strong><span style="color:#f33b45;">如果遇到 Build failed. 且没有提示，请把 项目 生成成功不报错了再执行</span></strong></h4> 
<h2>CodeFirst</h2> 
<p>先引用 NuGet 包</p> 
<p><img alt="" height="75" src="https://images2.imgbox.com/02/e5/TAWHLB2o_o.png" width="361"></p> 
<p>再编写继承自 DbContext 的数据库上下文类</p> 
<pre><code class="language-cs">using CodeFirstLibrary.Model;
using Microsoft.EntityFrameworkCore;

namespace CodeFirstLibrary
{
    public class GangHoodContext : DbContext
    {
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
            modelBuilder.Entity&lt;Account&gt;().HasIndex(a=&gt;a.AccountName).IsUnique();
        }
        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            string sqlConnection = "Server=.;database=GangHood;uid=sa;pwd=123456";
            optionsBuilder.UseSqlServer(sqlConnection);

            // var builder = new ConfigurationBuilder()
            //.SetBasePath(Directory.GetCurrentDirectory())
            //.AddJsonFile("appsettings.json");
            // var configuration = builder.Build();
            // var conn = configuration.GetConnectionString("JDDbConnection");

            //optionsBuilder.UseSqlServer(this._IConfiguration.GetConnectionString("JDDbConnectionString"));


            //optionsBuilder.UseLoggerFactory(new CustomEFLoggerFactory());

            //optionsBuilder.UseSqlServer(StaticConstraint.JDDbConnection);

            //optionsBuilder.UseSqlServer("Server=.;Database=advanced11;User id=sa;password=Passw0rd");



        }


        #region 表
        public DbSet&lt;User&gt; Users { get; set; }
        public DbSet&lt;Account&gt; Accounts { get; set; }
        #endregion

    }
}
</code></pre> 
<p>添加表的映射类</p> 
<pre><code class="language-cs">using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace CodeFirstLibrary.Model
{
    [Table("Accounts")]
    public  class Account
    {
        [Key]
        public long Id { get; set; }

        [MaxLength(50),Required]
        public string AccountName { get; set; }

        [MaxLength(100)]
        public string Password { get; set; }
    }
}
</code></pre> 
<p>添加迁移文件（Add-Migration 版本说明）</p> 
<p><img alt="" height="54" src="https://images2.imgbox.com/f8/1e/jSOgFSgi_o.png" width="200"></p> 
<p>更新数据库 （Update-Database 版本说明--对应上面迁移的版本说明）</p> 
<p><img alt="" height="83" src="https://images2.imgbox.com/ba/93/txgm12kW_o.png" width="326"></p> 
<h4>测试  增、改、查</h4> 
<pre><code class="language-cs">public IActionResult Index()
        {
            #region code first  测试
            using (GangHoodContext gangHoodContext = new GangHoodContext())
            {
                gangHoodContext.Add&lt;User&gt;(new User() { Name = $"小明{DateTimeOffset.Now.ToUnixTimeSeconds()}" });
                gangHoodContext.SaveChanges();

                User user =
                gangHoodContext.Users.FirstOrDefault(a =&gt; a.Id == 2);
                user.Name = $"小芬{DateTimeOffset.Now.ToUnixTimeSeconds()}";

                gangHoodContext.SaveChanges();

                List&lt;User&gt; users = gangHoodContext.Users.OrderByDescending(a =&gt; a.Id).Take(3).ToList();
                ViewBag.Users = users;
            }
            #endregion

            #region db first  测试
            using (StudyDataContext studyDataContext = new StudyDataContext())
            {
                studyDataContext.Add&lt;People&gt;(new People() { Name = $"赵云{DateTimeOffset.Now.ToUnixTimeSeconds()}",Age=DateTime.Now.Second });
                studyDataContext.SaveChanges();

                People people =
                studyDataContext.People.FirstOrDefault(a =&gt; a.Id == 8);
                people.Name = $"张飞{DateTimeOffset.Now.ToUnixTimeSeconds()}";
                studyDataContext.SaveChanges();

                List&lt;People&gt; peoples = studyDataContext.People.OrderByDescending(a =&gt; a.Id).Take(3).ToList();
                ViewBag.Peoples = peoples;
            }
            #endregion

            return View();
        }</code></pre> 
<pre><code class="language-cs">@{
    ViewData["Title"] = "Home Page";
}
@using CodeFirstLibrary.Model
@using DBModelLibrary.DbModel

    &lt;div class="text-center"&gt;
        &lt;h1 class="display-4"&gt;Welcome&lt;/h1&gt;
        &lt;p&gt;Learn about &lt;a href="https://docs.microsoft.com/aspnet/core"&gt;building Web apps with ASP.NET Core&lt;/a&gt;.&lt;/p&gt;

        &lt;p&gt;CodeFirst&lt;/p&gt;
        &lt;dl&gt;
            @foreach (User item in ViewBag.Users)
            {
                &lt;dd&gt;
                    @item.Name
                &lt;/dd&gt;
            }
        &lt;/dl&gt;
        &lt;br /&gt;
        &lt;p&gt;DbFirst&lt;/p&gt;
        &lt;ol&gt;
            @foreach (People item in ViewBag.Peoples)
            {
                &lt;li&gt;
                    @item.Name--@item.Age
                &lt;/li&gt;
            }
        &lt;/ol&gt;
    &lt;/div&gt;
</code></pre> 
<p><img alt="" height="585" src="https://images2.imgbox.com/39/05/JMPTIwph_o.png" width="800"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/264a7c6c56a5cda74a2ba0ea604a8b1e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">struts2  简介</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c1ff8dc9b931613619ca1a55fddc7820/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Centos中部署vue出现Error: EACCES: permission denied问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>