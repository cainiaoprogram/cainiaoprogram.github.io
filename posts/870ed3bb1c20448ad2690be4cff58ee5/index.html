<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>把 charles，Fiddler 证书安装到安卓根目录，解决安卓微信 7.0 版本以后安装证书也无法抓包问题，需要 root - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="把 charles，Fiddler 证书安装到安卓根目录，解决安卓微信 7.0 版本以后安装证书也无法抓包问题，需要 root" />
<meta property="og:description" content="From：https://testerhome.com/topics/21956
OpenSSL ：https://slproweb.com/products/Win32OpenSSL.html
1、安装为系统证书好处 （1）安装用户证书必须要设置开机密码，而且设置后就不能取消，除非先删掉所有的用户证书。如果安装为系统证书就不需要设置开机密码，自动化操作时更方便。（2）谷歌在 安卓7.0 修改了安全策略，安卓系统 大于 7.0 时 APP默认不信任用户证书，只信任系统证书，安装为用户证书，对APP的HTTPS抓包会失败。安装为全局证书才能被所有APP信任，方可进行HTTPS抓包。 解决方法
降级 APP降级 系统版本将用户证书偷渡成系统证书，需要有 root 权限。将 charles 的 CA 证书安装进系统信任的证书目录下，这样在开启 charles 代理的时候，系统就会认为CA证书安全，从而可以获取 https 数据。 2、将证书安装为安卓系统证书 怎么将 Fiddler 或 Mitmproxy 的证书安装为安卓系统证书呢？
Android 的系统证书的存储位置是 /system/etc/security/cacerts，证书文件必须是PEM格式，而且文件命名必须符合系统证书规范。
第1步：下载Fiddler或Mitmproxy的证书文件，PEM或者DER格式均可。 第2步：获取有效的系统证书文件名 # 如果是PEM格式的： openssl x509 -inform PEM -subject_hash_old -in mitmproxy-ca-cert.pem -noout # 如果是DER格式的： openssl x509 -inform der -subject_hash_old -in FiddlerRoot.cer -noout # 例如，输出8bbe0e8d 第3步：转换证书格式为PEM格式，并重命名证书为有效的系统证书名。 # 如果是PEM格式的: openssl x509 -inform PEM -in mitmproxy-ca-cert.pem -out 8bbe0e8d.0 # 如果是DER格式的： openssl x509 -inform der -in FiddlerRoot." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/870ed3bb1c20448ad2690be4cff58ee5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-05T10:27:30+08:00" />
<meta property="article:modified_time" content="2023-05-05T10:27:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">把 charles，Fiddler 证书安装到安卓根目录，解决安卓微信 7.0 版本以后安装证书也无法抓包问题，需要 root</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p></p> 
<p>From：<a class="link-info" href="https://testerhome.com/topics/21956" rel="nofollow" title="https://testerhome.com/topics/21956">https://testerhome.com/topics/21956</a></p> 
<p>OpenSSL ：<a href="https://slproweb.com/products/Win32OpenSSL.html" rel="nofollow" title="https://slproweb.com/products/Win32OpenSSL.html">https://slproweb.com/products/Win32OpenSSL.html</a></p> 
<p></p> 
<p></p> 
<p></p> 
<h2>1、安装为系统证书好处</h2> 
<p></p> 
<blockquote> 
 <ul><li>（1）安装用户证书必须要设置开机密码，而且设置后就不能取消，除非先删掉所有的用户证书。如果安装为系统证书就不需要设置开机密码，自动化操作时更方便。</li><li>（2）谷歌在 安卓7.0 修改了安全策略，安卓系统 大于 7.0 时 APP默认不信任用户证书，只信任系统证书，安装为用户证书，对APP的HTTPS抓包会失败。安装为全局证书才能被所有APP信任，方可进行HTTPS抓包。</li></ul> 
</blockquote> 
<p>解决方法</p> 
<blockquote> 
 <ul><li>降级 APP</li><li>降级 系统版本</li><li>将用户证书偷渡成系统证书，需要有 root 权限。<strong><span style="color:#fe2c24;">将 charles 的 CA 证书安装进系统信任的证书目录下，这样在开启 charles 代理的时候，系统就会认为CA证书安全，从而可以获取 https 数据。</span></strong></li></ul> 
</blockquote> 
<p></p> 
<p></p> 
<h2>2、将证书安装为安卓系统证书</h2> 
<p></p> 
<p>怎么将 Fiddler 或 Mitmproxy 的证书安装为安卓系统证书呢？</p> 
<p>Android 的系统证书的存储位置是 /system/etc/security/cacerts，证书文件必须是PEM格式，而且文件命名必须符合系统证书规范。</p> 
<blockquote> 
 <p>第1步：下载Fiddler或Mitmproxy的证书文件，PEM或者DER格式均可。  <br> 第2步：获取有效的系统证书文件名 <br>         # 如果是PEM格式的：  <br>         openssl x509 -inform PEM -subject_hash_old -in mitmproxy-ca-cert.pem -noout  <br>         # 如果是DER格式的：  <br>         openssl x509 -inform der -subject_hash_old -in FiddlerRoot.cer  -noout  <br>         # 例如，输出8bbe0e8d  <br> 第3步：转换证书格式为PEM格式，并重命名证书为有效的系统证书名。  <br>         # 如果是PEM格式的:  <br>         openssl x509 -inform PEM -in mitmproxy-ca-cert.pem -out 8bbe0e8d.0  <br>         # 如果是DER格式的：  <br>         openssl x509 -inform der -in FiddlerRoot.cer -out 8bbe0e8d.0  <br>   <br> 第4步：上传准备好的证书文件到设备。例如：adb push 8bbe0e8d.0 /sdcard/  </p> 
 <p>第5步：复制证书到Android系统证书目录<br>         adb shell  <br>         su   <br>         mount -o rw,remount /system   <br>         cp /sdcard/8bbe0e8d.0 /system/etc/security/cacerts  <br>         chmod 644 /system/etc/security/cacerts/8bbe0e8d.0  <br>         # 上述可整合为一句  <br>         adb shell "su -c 'mount -o rw,remount /system;cp /sdcard/8bbe0e8d.0 /system/etc/security/cacerts;chmod 644 /system/etc/security/cacerts/8bbe0e8d.0;'"  <br>         # 重启设备  <br>         adb reboot  </p> 
</blockquote> 
<p></p> 
<p></p> 
<h3 id="Fiddler证书安装到安卓根目录">Fiddler 证书安装到安卓根目录</h3> 
<p></p> 
<p>一台已 root 过的手机，开启开发者选项，然后连接电脑。</p> 
<p>安卓系统证书跟 Fiddler 证书的格式不一样，需要转换。</p> 
<blockquote> 
 <p>1、安装 OPENSSL【<a href="https://slproweb.com/products/Win32OpenSSL.html" rel="nofollow" title="https://slproweb.com/products/Win32OpenSSL.html">https://slproweb.com/products/Win32OpenSSL.html</a>】。linux 默认已经安装。如果使用 linux 系统，可以忽略这一步。</p> 
 <p>2、下载 fiddler 证书到电脑上</p> 
 <p>3、打开命令窗口，执行以下命令，查看证书哈希信息：</p> 
 <p>        openssl x509 -inform der -subject_hash_old -in FiddlerRoot.cer<br>         openssl x509 -inform der -subject_hash_old -in FiddlerRoot.cer -noout</p> 
</blockquote> 
<p class="img-center"><img alt="" height="526" src="https://images2.imgbox.com/6a/87/c9CjaqK9_o.png" width="878"></p> 
<p>安卓系统的安全证书在 /system/etc/security/cacerts/ 目录下，进入adb shell，打开目录就能看到这些证书文件。</p> 
<p class="img-center"><img alt="" height="364" src="https://images2.imgbox.com/34/6f/KAR4Rr2F_o.png" width="783"></p> 
<p>文件名是 Hash值 加 数字后缀。后缀名的数字是为了防止文件名冲突的，比如如果两个证书算出的Hash值是一样的话，那么一个证书的后缀名数字可以设置成0，而另一个证书的后缀名数字可以设置成1</p> 
<p>4、转换证书</p> 
<blockquote> 
 <p>openssl x509 -inform DER -in FiddlerRoot.cer -text &gt; [哈希].0</p> 
</blockquote> 
<p>5、用记事本编辑证书</p> 
<blockquote> 
 <p>将 <span style="color:#fe2c24;"><strong>-----BEGIN CERTIFICATE-----</strong></span> 到 <span style="color:#fe2c24;"><strong>-----END CERTIFICATE-----</strong></span> 的部分放到文件最前面。</p> 
 <p>可以使用 cat 命令随便查看一个 证书文件，就可以看到都是放在文件的最前面</p> 
 <p class="img-center"><img alt="" height="540" src="https://images2.imgbox.com/31/bd/LU9jw8Qi_o.png" width="830"></p> 
</blockquote> 
<p>6、将证书放到手机的 /system/etc/security/cacerts/ 下</p> 
<blockquote> 
 <p>执行 adb 命令连接手机，获取权限，把文件夹挂载为读写模式，把文件复制到证书根目录</p> 
 <p>adb root<br> adb remount<br> adb shell mount -o rw,remount /system<br> adb push e5742ab9.0 /system/etc/security/cacerts</p> 
</blockquote> 
<p><span style="color:#fe2c24;"><strong>重启手机</strong></span>，可以看到 Fiddler 的证书已经变成系统证书了，接下来就可以愉快的抓包了</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/47/ef/2k5eijhc_o.png"></p> 
<p></p> 
<p></p> 
<h3>Charles 证书安装到安卓根目录</h3> 
<p></p> 
<p>一台已 root 过的手机，开启开发者选项，然后连接电脑。</p> 
<p>下载证书到电脑上</p> 
<ul><li>电脑端浏览器输入 chls.pro/ssl 即可下载，</li><li>如果未下载也可以在 charles &gt;&gt; help &gt;&gt; SSL Proxying &gt;&gt;Save Charles Root Certificate 保存证书到本地文件夹</li></ul> 
<p>查看证书信息：</p> 
<p>openssl x509 -subject_hash_old -in charles.pem<br> openssl x509 -inform PEM -subject_hash_old -in charles.pem -noout</p> 
<p class="img-center"><img alt="" height="755" src="https://images2.imgbox.com/ee/2b/QXWMlAP0_o.png" width="918"></p> 
<p>重命名证书：<span style="color:#fe2c24;"><strong>mv charles.pem 5a3b138a.0</strong></span></p> 
<p>执行 adb 命令连接手机，获取权限，把文件夹挂载为读写模式，把文件复制到证书根目录</p> 
<blockquote> 
 <p>adb root<br> adb remount<br> adb shell mount -o rw,remount /system<br> adb push e5742ab9.0 /system/etc/security/cacerts</p> 
</blockquote> 
<p>以上就 OK 了。如果不放心可以 cd 到对应目录，检查文件是否存在，文件权限是否与其他证书一致。证书安装 OK，其他代理选项正常配置即可</p> 
<p>如果出现 &lt;hash&gt;.0：Read-only file system 这个警告，这是因为 system 文件为只读，需要将其挂载为可读写。一般的解决方法是：<span style="color:#956fe7;"><strong>mount -o rw,remount /system</strong></span> 修改system读写权限，然后再进行复制操作。如果修改了之后还是提示Read-only file system，还有方法</p> 
<blockquote> 
 <p>adb root<br> adb disable-verity<br> adb reboot #手机会重启，不用关闭cmd窗口，手机可能需要拔掉数据写重新连接<br> adb root<br> adb shell <br> mount -o rw,remount /system    #再次进行修改</p> 
</blockquote> 
<p>然后就可以进行复制操作了。<span style="color:#fe2c24;"><strong>复制完之后输入reboot 重启</strong></span></p> 
<p>重启之后，打开设置 ---&gt; 更多设置 ---&gt; 系统安全 ---&gt; 信任的凭据中可以看到安装的证书</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/70/91/Sz1fy4Mu_o.png"></p> 
<p></p> 
<h4>Charles工具配置</h4> 
<p>首先是 proxy - proxy settings，选择 socks proxy 模式，如图配置，点击ok完毕</p> 
<p class="img-center"><img alt="" height="451" src="https://images2.imgbox.com/32/99/QX2H3Acp_o.png" width="527"></p> 
<p>取消勾选 windows proxy，因为我们不需要用来抓取windows的数据包。</p> 
<p class="img-center"><img alt="" height="387" src="https://images2.imgbox.com/99/7a/3E7HvYh7_o.png" width="312"></p> 
<p>然后是 proxy-ssl proxy settings</p> 
<p class="img-center"><img alt="" height="305" src="https://images2.imgbox.com/d5/de/FFt0O1Pv_o.png" width="301"></p> 
<p>点 add，host、port 都填 * 即可。</p> 
<p class="img-center"><img alt="" height="358" src="https://images2.imgbox.com/51/82/An4wwt4c_o.png" width="521"></p> 
<p>设置完成后，就可以通过 charles 代理查看到 https 的数据了。 </p> 
<p></p> 
<h3>Burpsuite 导入 Charles 的证书</h3> 
<p></p> 
<p>打开 charles - help - ssl proxying</p> 
<p class="img-center"><img alt="" height="395" src="https://images2.imgbox.com/47/63/cXuvHcuU_o.png" width="676"></p> 
<p>输入密码，导出证书，得到一个.p12的文件</p> 
<p>往 burp 中导入</p> 
<p class="img-center"><img alt="" height="862" src="https://images2.imgbox.com/33/c3/ZXt4ZOk7_o.png" width="1200"></p> 
<p>选择文件，输入密码，导入成功</p> 
<p></p> 
<h4>联合 burp</h4> 
<p>因为charles抓包能力强但是不好做修改数据包之类的操作，所以我们就再做一层代理到burp来方便我们渗透测试人员。</p> 
<p>proxy - external proxy settings</p> 
<p class="img-center"><img alt="" height="491" src="https://images2.imgbox.com/a6/e9/JbtloELT_o.png" width="318"></p> 
<p class="img-center"><img alt="" height="706" src="https://images2.imgbox.com/27/c6/ktkvrlwi_o.png" width="515"></p> 
<p>记得两个选项都要配置127.0.0.1:8080，因为我们的burp就是默认监听8080端口的，若不是8080，改成自己burp上监听的端口就可以了。</p> 
<p class="img-center"><img alt="" height="207" src="https://images2.imgbox.com/f9/50/HQPectet_o.png" width="464"></p> 
<p>测试结果</p> 
<p class="img-center"><img alt="" height="817" src="https://images2.imgbox.com/88/84/pX1p0rpc_o.png" width="1059"></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df5a4bf2f167cc6e0194ea8d399d1502/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Centos使用Docker搭建Lamp环境（详细教程）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4d334eef964162c4dfa200c5bb436ddc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【故障排查】dig通过coredns的svc IP，解析pod的fqdn出现connection timed out； no servers could be reached</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>