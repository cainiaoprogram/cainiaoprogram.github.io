<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>sklearn实战06：xgboost - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="sklearn实战06：xgboost" />
<meta property="og:description" content="1 梯度提升树 class xgboost.XGBRegressor (max_depth=3, learning_rate=0.1, n_estimators=100, silent=True,objective=&#39;reg:linear&#39;, booster=&#39;gbtree&#39;, n_jobs=1, nthread=None, gamma=0, min_child_weight=1, max_delta_step=0,subsample=1, colsample_bytree=1, colsample_bylevel=1, reg_alpha=0, reg_lambda=1, scale_pos_weight=1,base_score=0.5, random_state=0, seed=None, missing=None, importance_type=&#39;gain&#39;, **kwargs) 1.1 重要参数：n_estimators 对于梯度提升树来说，每个样本的预测结果表示为所有树上结果的加权求和：
其中，K是树的总数量，k代表第k棵树，γk是这棵树的权重，hk表示这棵树上的预测结果。
而对于XGB来说，每个叶子节点上会有一个预测分数（prediction score），也被称为叶子权重。这个叶子权重就是所有在这个叶子节点上的样本在这一棵树上的回归取值，用fk(xi)或者w来表示，其中fk表示第k棵决策树，xi表示样本i对应的特征向量。当只有一棵树的时候，f1(xi)就是提升集成算法返回的结果，但这个结果往往非常糟糕。当有多棵树的时候，集成模型的回归结果就是所有树的预测分数之和，假设这个集成模型中总共有K棵决策树，则整个模型在这个样本i上给出的预测结果为：
因此我们要做的第一件事是确定K，即建几棵树。
from xgboost import XGBRegressor as XGBR from sklearn.ensemble import RandomForestRegressor as RFR from sklearn.linear_model import LinearRegression as LinearR from sklearn.datasets import load_boston from sklearn.model_selection import KFold, cross_val_score as CVS, train_test_split as TTS from sklearn.metrics import mean_squared_error as MSE import pandas as pd import numpy as np import matplotlib." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a992d90f30485b190b3cd6cd9ffd6159/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-25T23:07:52+08:00" />
<meta property="article:modified_time" content="2021-11-25T23:07:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">sklearn实战06：xgboost</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1 梯度提升树</h2> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">xgboost</span><span class="token punctuation">.</span>XGBRegressor <span class="token punctuation">(</span>max_depth<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> n_estimators<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> silent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>objective<span class="token operator">=</span><span class="token string">'reg:linear'</span><span class="token punctuation">,</span> booster<span class="token operator">=</span><span class="token string">'gbtree'</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> nthread<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> min_child_weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max_delta_step<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>subsample<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> colsample_bytree<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> colsample_bylevel<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> reg_alpha<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> reg_lambda<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> scale_pos_weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>base_score<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> missing<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> importance_type<span class="token operator">=</span><span class="token string">'gain'</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="11_n_estimators_4"></a>1.1 重要参数：n_estimators</h3> 
<p>对于梯度提升树来说，每个样本的预测结果表示为所有树上结果的加权求和：<br> <img src="https://images2.imgbox.com/65/01/hYu2FmyI_o.png" alt="在这里插入图片描述"><br> 其中，K是树的总数量，k代表第k棵树，γk是这棵树的权重，hk表示这棵树上的预测结果。<br> 而对于XGB来说，每个叶子节点上会有一个预测分数（prediction score），也被称为叶子权重。这个叶子权重就是所有在这个叶子节点上的样本在这一棵树上的回归取值，用fk(xi)或者w来表示，其中fk表示第k棵决策树，xi表示样本i对应的特征向量。当只有一棵树的时候，f1(xi)就是提升集成算法返回的结果，但这个结果往往非常糟糕。当有多棵树的时候，集成模型的回归结果就是所有树的预测分数之和，假设这个集成模型中总共有K棵决策树，则整个模型在这个样本i上给出的预测结果为：<br> <img src="https://images2.imgbox.com/0a/15/Z4IgB0HC_o.png" alt="在这里插入图片描述"><br> 因此我们要做的第一件事是确定K，即建几棵树。<br> <img src="https://images2.imgbox.com/9e/6e/JdzEAitD_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> xgboost <span class="token keyword">import</span> XGBRegressor <span class="token keyword">as</span> XGBR
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> RandomForestRegressor <span class="token keyword">as</span> RFR
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LinearRegression <span class="token keyword">as</span> LinearR
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> load_boston
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> KFold<span class="token punctuation">,</span> cross_val_score <span class="token keyword">as</span> CVS<span class="token punctuation">,</span> train_test_split <span class="token keyword">as</span> TTS
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error <span class="token keyword">as</span> MSE
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> time <span class="token keyword">import</span> time
<span class="token keyword">import</span> datetime
data <span class="token operator">=</span> load_boston<span class="token punctuation">(</span><span class="token punctuation">)</span>
X <span class="token operator">=</span> data<span class="token punctuation">.</span>data
y <span class="token operator">=</span> data<span class="token punctuation">.</span>target

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>定义绘制以训练样本数为横坐标的学习曲线的函数<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token keyword">def</span> <span class="token function">plot_learning_curve</span><span class="token punctuation">(</span>estimator<span class="token punctuation">,</span>title<span class="token punctuation">,</span> X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> 
                        ax<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token comment">#选择子图</span>
                        ylim<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token comment">#设置纵坐标的取值范围</span>
                        cv<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token comment">#交叉验证</span>
                        n_jobs<span class="token operator">=</span><span class="token boolean">None</span> <span class="token comment">#设定索要使用的线程</span>
                       <span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> learning_curve
    <span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
    <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
    
    train_sizes<span class="token punctuation">,</span> train_scores<span class="token punctuation">,</span> test_scores <span class="token operator">=</span> learning_curve<span class="token punctuation">(</span>estimator<span class="token punctuation">,</span> X<span class="token punctuation">,</span> y
                                                            <span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">True</span>
                                                            <span class="token punctuation">,</span>cv<span class="token operator">=</span>cv
                                                            <span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span>
                                                            <span class="token punctuation">,</span>n_jobs<span class="token operator">=</span>n_jobs<span class="token punctuation">)</span>      
    <span class="token keyword">if</span> ax <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>title<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ylim <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        ax<span class="token punctuation">.</span>set_ylim<span class="token punctuation">(</span><span class="token operator">*</span>ylim<span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">"Training examples"</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">"Score"</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#绘制网格，不是必须</span>
    ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train_sizes<span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>train_scores<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'o-'</span>
            <span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"r"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"Training score"</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train_sizes<span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test_scores<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'o-'</span>
            <span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"g"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"Test score"</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">"best"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ax
    
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>使用参数学习曲线观察n_estimators对模型的影响<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
axisx <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1010</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> axisx<span class="token punctuation">:</span>
    reg <span class="token operator">=</span> XGBR<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span>i<span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">)</span>
    rs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>CVS<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"XGB"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>进化的学习曲线：方差与泛化误差<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
axisx <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">1050</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
var <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
ge <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> axisx<span class="token punctuation">:</span>
    reg <span class="token operator">=</span> XGBR<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span>i<span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">)</span>
    cvresult <span class="token operator">=</span> CVS<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">)</span>
    <span class="token comment">#记录1-偏差</span>
    rs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cvresult<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#记录方差</span>
    var<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cvresult<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#计算泛化误差的可控部分</span>
    ge<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> cvresult<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token operator">+</span>cvresult<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#打印R2最高所对应的参数取值，并打印这个参数下的方差</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">,</span>var<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#打印方差最低时对应的参数取值，并打印这个参数下的R2</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>var<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rs<span class="token punctuation">[</span>var<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#打印泛化误差可控部分的参数取值，并打印这个参数下的R2，方差以及泛化误差的可控部分</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rs<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>var<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"XGB"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/76/2e/Cj5XEblR_o.png" alt="在这里插入图片描述"><br> 因为这里我们的数据量少，模型相对不稳定，因此需要把方差也纳入考虑的范围。因此需要改进学习曲线</p> 
<pre><code class="prism language-python"><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>细化学习曲线，找到最佳的n_estimators<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
xisx <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
var <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
ge <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> axisx<span class="token punctuation">:</span>
    reg <span class="token operator">=</span> XGBR<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span>i<span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">)</span>
    cvresult <span class="token operator">=</span> CVS<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">)</span>
    rs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cvresult<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    var<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cvresult<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ge<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> cvresult<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token operator">+</span>cvresult<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">,</span>var<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>var<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rs<span class="token punctuation">[</span>var<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rs<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>var<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>rs<span class="token punctuation">)</span>
var <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.01</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"black"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"XGB"</span><span class="token punctuation">)</span>
<span class="token comment">#添加方差线</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token operator">+</span>var<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>linestyle<span class="token operator">=</span><span class="token string">'-.'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token operator">-</span>var<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>linestyle<span class="token operator">=</span><span class="token string">'-.'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>首先，XGB中的树的数量决定了模型的学习能力，树的数量越多，模型的学习能力越强。只要XGB中树的数量足够了，即便只有很少的数据， 模型也能够学到训练数据100%的信息，所以XGB也是天生过拟合的模型。但在这种情况下，模型会变得非常不稳定。</p> 
<p>第二，XGB中树的数量很少的时候，对模型的影响较大，当树的数量已经很多的时候，对模型的影响比较小，只能有<br> 微弱的变化。当数据本身就处于过拟合的时候，再使用过多的树能达到的效果甚微，反而浪费计算资源。当唯一指标或者准确率给出的n_estimators看起来不太可靠的时候，我们可以改造学习曲线来帮助我们。</p> 
<p>第三，树的数量提升对模型的影响有极限，最开始，模型的表现会随着XGB的树的数量一起提升，但到达某个点之后，树的数量越多，模型的效果会逐步下降，这也说明了暴力增加n_estimators不一定有效果。</p> 
<p>这些都和随机森林中的参数n_estimators表现出一致的状态。在随机森林中我们总是先调整n_estimators，当n_estimators的极限已达到，我们才考虑其他参数，但XGB中的状况明显更加复杂，当数据集不太寻常的时候会更加复杂。这是我们要给出的第一个超参数，因此还是建议优先调整n_estimators，一般都不会建议一个太大的数目，300以下为佳</p> 
<h3><a id="12_subsample_136"></a>1.2 有放回随机抽样：重要参数subsample</h3> 
<p>在无论是装袋还是提升的集成算法中，有放回抽样都是我们<strong>防止过拟合</strong>，让单一弱分类器变得更轻量的必要操作。实际应用中，每次抽取50%左右的数据就能够有不错的效果了。sklearn的随机森林类中也有名为boostrap的参数来帮助我们控制这种随机有放回抽样。</p> 
<p>同时，这样做还可以保证集成算法中的每个弱分类器（每棵树）都是不同的模型，基于不同的数据建立的自然是不同的模型，而集成一系列一模一样的弱分类器是没有意义的。在梯度提升树中，我们每一次迭代都要建立一棵新的树，因此我们每次迭代中，都要有放回抽取一个新的训练样本。</p> 
<p>不过，这并不能保证每次建新树后，集成的效果都比之前要好。因此我们规定，在梯度提升树中，每构建一个评估<br> 器，都让模型更加集中于数据集中容易被判错的那些样本。<br> <img src="https://images2.imgbox.com/2f/cb/LiLd4Vlz_o.png" alt="在这里插入图片描述"><br> 采样除了让模型更加集中于那些困难样本，还对模型造成了什么样的影响呢？<br> 采样会减少样本数量，而从学习曲线来看样本数量越少模型的过拟合会越严重，因为对模型来说，数据量越少模型学习越容易，学到的规则也会越具体越不适用于测试样本。所以subsample参数通常是在样本量本身很大的时候来调整和使用。</p> 
<pre><code class="prism language-python">axisx <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> axisx<span class="token punctuation">:</span>
    reg <span class="token operator">=</span> XGBR<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">,</span>subsample<span class="token operator">=</span>i<span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">)</span>
    rs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>CVS<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"green"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"XGB"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#继续细化学习曲线</span>
axisx <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
var <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
ge <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> axisx<span class="token punctuation">:</span>
    reg <span class="token operator">=</span> XGBR<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">,</span>subsample<span class="token operator">=</span>i<span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">)</span>
    cvresult <span class="token operator">=</span> CVS<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">)</span>
    rs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cvresult<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    var<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cvresult<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ge<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> cvresult<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token operator">+</span>cvresult<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">,</span>var<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>var<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rs<span class="token punctuation">[</span>var<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rs<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>var<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>rs<span class="token punctuation">)</span>
var <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"black"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"XGB"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token operator">+</span>var<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>linestyle<span class="token operator">=</span><span class="token string">'-.'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token operator">-</span>var<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>linestyle<span class="token operator">=</span><span class="token string">'-.'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#细化学习曲线</span>
axisx <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0.75</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
var <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
ge <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> axisx<span class="token punctuation">:</span>
    reg <span class="token operator">=</span> XGBR<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">,</span>subsample<span class="token operator">=</span>i<span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">)</span>
    cvresult <span class="token operator">=</span> CVS<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">)</span>
    rs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cvresult<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    var<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cvresult<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ge<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> cvresult<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token operator">+</span>cvresult<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">,</span>var<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>var<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rs<span class="token punctuation">[</span>var<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">min</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rs<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>var<span class="token punctuation">[</span>ge<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">min</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>rs<span class="token punctuation">)</span>
var <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"black"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"XGB"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token operator">+</span>var<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>linestyle<span class="token operator">=</span><span class="token string">'-.'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token operator">-</span>var<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>linestyle<span class="token operator">=</span><span class="token string">'-.'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="13_eta_204"></a>1.3 迭代决策树：重要参数eta</h3> 
<p>如何保证必须每次新添加的树一定得是对这个新数据集预测效果最优的那一棵树。<br> 类比逻辑回归：<br> <img src="https://images2.imgbox.com/1e/2a/FLffoUHD_o.png" alt="在这里插入图片描述"><br> 完整的迭代决策树公式：<br> <img src="https://images2.imgbox.com/8c/76/tb5W8zmI_o.png" alt="在这里插入图片描述"><br> 其中η读作"eta"，是迭代决策树时的步长（shrinkage），又叫做学习率（learning rate），η越大，迭代的速度越快，算法的极限很快被达到，有可能无法收敛到真正的最佳。η 越小，越有可能找到更精确的最佳值，更多的空间被留给了后面建立的树，但迭代速度会比较缓慢。<br> <img src="https://images2.imgbox.com/de/0e/zKfWX0Nh_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token comment">#首先我们先来定义一个评分函数，这个评分函数能够帮助我们直接打印Xtrain上的交叉验证结果</span>
<span class="token keyword">def</span> <span class="token function">regassess</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token punctuation">,</span>scoring <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"r2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>show<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    score <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>scoring<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> show<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{}:{:.2f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>scoring<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">#模型评估指标的名字</span>
                                     <span class="token punctuation">,</span>CVS<span class="token punctuation">(</span>reg
                                          <span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain
                                          <span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">,</span>scoring<span class="token operator">=</span>scoring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        score<span class="token punctuation">.</span>append<span class="token punctuation">(</span>CVS<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">,</span>scoring<span class="token operator">=</span>scoring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> score
<span class="token comment">#观察一下eta如何影响我们的模型：</span>
<span class="token keyword">from</span> time <span class="token keyword">import</span> time
<span class="token keyword">import</span> datetime
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    time0<span class="token operator">=</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    reg <span class="token operator">=</span> XGBR<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">,</span>learning_rate<span class="token operator">=</span>i<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"learning_rate = {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    regassess<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token punctuation">,</span>scoring <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"r2"</span><span class="token punctuation">,</span><span class="token string">"neg_mean_squared_error"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>time0<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%M:%S:%f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span>
axisx <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0.05</span><span class="token punctuation">)</span>
rs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
te <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> axisx<span class="token punctuation">:</span>
    reg <span class="token operator">=</span> XGBR<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">,</span>learning_rate<span class="token operator">=</span>i<span class="token punctuation">)</span>
    score <span class="token operator">=</span> regassess<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">,</span>cv<span class="token punctuation">,</span>scoring <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"r2"</span><span class="token punctuation">,</span><span class="token string">"neg_mean_squared_error"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>show<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    test <span class="token operator">=</span> reg<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">)</span><span class="token punctuation">.</span>score<span class="token punctuation">(</span>Xtest<span class="token punctuation">,</span>Ytest<span class="token punctuation">)</span>
    rs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    te<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>axisx<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>te<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"gray"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"test"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>axisx<span class="token punctuation">,</span>rs<span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"green"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>虽然从图上来说，默认的0.1看起来是一个比较理想的情况，并且看起来更小的步长更利于现在的数据，但我们也无法确定对于其他数据会有怎么样的效果。所以通常，我们不调整 ，即便调整，一般它也会在[0.01,0.2]之间变动。如果我们希望模型的效果更好，更多的可能是从树本身的角度来说，对树进行剪枝，而不会寄希望于调整η</p> 
<h2><a id="2__XGBoost_252"></a>2 XGBoost</h2> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">xgboost</span><span class="token punctuation">.</span>XGBRegressor <span class="token punctuation">(</span>kwargs，max_depth<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> n_estimators<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> silent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
objective<span class="token operator">=</span><span class="token string">'reg:linear'</span><span class="token punctuation">,</span> booster<span class="token operator">=</span><span class="token string">'gbtree'</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> nthread<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> min_child_weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
max_delta_step<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> subsample<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> colsample_bytree<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> colsample_bylevel<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> reg_alpha<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> reg_lambda<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
scale_pos_weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> base_score<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> missing<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> importance_type<span class="token operator">=</span><span class="token string">'gain'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="21_booster_260"></a>2.1 选择弱评估器：重要参数booster</h3> 
<p>梯度提升算法中不只有梯度提升树，XGB作为梯度提升算法的进化，自然也不只有树模型一种弱评估器。在XGB中，除了树模型，我们还可以选用线性模型，比如线性回归，来进行集成。虽然主流的XGB依然是树模型，但我们也可以使用其他的模型。基于XGB的这种性质，我们有参数“booster"来控制我们究竟使用怎样的弱评估器。<br> <img src="https://images2.imgbox.com/da/d9/aR8lgaBu_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> booster <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"gbtree"</span><span class="token punctuation">,</span><span class="token string">"gblinear"</span><span class="token punctuation">,</span><span class="token string">"dart"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    reg <span class="token operator">=</span> XGBR<span class="token punctuation">(</span>n_estimators<span class="token operator">=</span><span class="token number">180</span>
               <span class="token punctuation">,</span>learning_rate<span class="token operator">=</span><span class="token number">0.1</span>
               <span class="token punctuation">,</span>random_state<span class="token operator">=</span><span class="token number">420</span>
               <span class="token punctuation">,</span>booster<span class="token operator">=</span>booster<span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>Xtrain<span class="token punctuation">,</span>Ytrain<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>booster<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>reg<span class="token punctuation">.</span>score<span class="token punctuation">(</span>Xtest<span class="token punctuation">,</span>Ytest<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="22_XGBobjective_272"></a>2.2 XGB的目标函数：重要参数objective</h3> 
<p>梯度提升算法中都存在着损失函数。不同于逻辑回归和SVM等算法中固定的损失函数写法，集成算法中的损失函数是可选的，要选用什么损失函数取决于我们希望解决什么问题，以及希望使用怎样的模型。比如说，如果我们的目标是进行回归预测，那我们可以选择调节后的均方误差RMSE作为我们的损失函数。如果我们是进行分类预测，那我们可以选择错误率error或者对数损失log_loss。只要我们选出的函数是一个可微的，能够代表某种损失的函数，它就可以是我们XGB中的损失函数.<br> <img src="https://images2.imgbox.com/02/ff/QDXQOIx0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/93/40/MfVGbQOp_o.png" alt="在这里插入图片描述"><br> 看xgb自身的调用方式：<br> <img src="https://images2.imgbox.com/e2/0b/BM8IMUrt_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token comment">#xgb实现法</span>
<span class="token comment">#使用类Dmatrix读取数据</span>
dtrain <span class="token operator">=</span> xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>xtrain<span class="token punctuation">,</span>ytrain<span class="token punctuation">)</span>
dtest <span class="token operator">=</span> xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>xtest<span class="token punctuation">,</span>ytest<span class="token punctuation">)</span>
param <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'silent'</span><span class="token punctuation">:</span><span class="token boolean">False</span><span class="token punctuation">,</span><span class="token comment">#silent默认为False，通常需要手动将它关闭</span>
        <span class="token string">'objective'</span><span class="token punctuation">:</span><span class="token string">'reg:linear'</span><span class="token punctuation">,</span>
        <span class="token string">'eta'</span><span class="token punctuation">:</span><span class="token number">0.1</span><span class="token punctuation">}</span>
num_round <span class="token operator">=</span> <span class="token number">180</span>
<span class="token comment">#类train，可以直接导入的参数是训练数据，树的数量，其他参数都需要通过params来导入</span>
bst <span class="token operator">=</span> xgb<span class="token punctuation">.</span>train<span class="token punctuation">(</span>param<span class="token punctuation">,</span> dtrain<span class="token punctuation">,</span> num_round<span class="token punctuation">)</span>
r2_score<span class="token punctuation">(</span>ytest<span class="token punctuation">,</span>bst<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>dtest<span class="token punctuation">)</span><span class="token punctuation">)</span>
MSE<span class="token punctuation">(</span>ytest<span class="token punctuation">,</span>bst<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>dtest<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="23__fkxalphalambda_293"></a>2.3 参数化决策树fk(x)：参数alpha，lambda</h3> 
<p><img src="https://images2.imgbox.com/c6/78/gPYdZPGp_o.png" alt="在这里插入图片描述"><br> 当λ和α越大，惩罚越重，正则项所占的比例就越大，在尽全力最小化目标函数的最优化方向下，叶子节点数量就会被压制，模型的复杂度就越来越低，所以对于天生过拟合的XGB来说，正则化可以一定程度上提升模型效果。</p> 
<pre><code class="prism language-python"><span class="token comment">#使用网格搜索来查找最佳的参数组合</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> GridSearchCV
param <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"reg_alpha"</span><span class="token punctuation">:</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"reg_lambda"</span><span class="token punctuation">:</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
gscv <span class="token operator">=</span> GridSearchCV<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>param_grid <span class="token operator">=</span> param<span class="token punctuation">,</span>scoring <span class="token operator">=</span> <span class="token string">"neg_mean_squared_error"</span><span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">)</span>

param <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'reg_alpha'</span><span class="token punctuation">:</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'reg_lambda'</span><span class="token punctuation">:</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
gscv <span class="token operator">=</span> GridSearchCV<span class="token punctuation">(</span>reg<span class="token punctuation">,</span>param_grid<span class="token operator">=</span>param<span class="token punctuation">,</span>scoring <span class="token operator">=</span> <span class="token string">'neg_mean_squared_error'</span><span class="token punctuation">,</span>cv<span class="token operator">=</span>cv<span class="token punctuation">)</span>
time0 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
gscv<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>xtrain<span class="token punctuation">,</span>ytrain<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>time0<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%M:%s:%f'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="24_gamma_309"></a>2.4 让树停止生长：重要参数gamma</h3> 
<p><img src="https://images2.imgbox.com/e6/50/sxUJLV05_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/65/99/27fYPjX4_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> xgboost <span class="token keyword">as</span> xgb

<span class="token comment">#为了便捷，使用全数据</span>
dfull <span class="token operator">=</span> xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>X<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
<span class="token comment">#设定参数</span>
param1 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'silent'</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token string">'obj'</span><span class="token punctuation">:</span><span class="token string">'reg:linear'</span><span class="token punctuation">,</span><span class="token string">"gamma"</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span>
num_round <span class="token operator">=</span> <span class="token number">100</span>
n_fold<span class="token operator">=</span><span class="token number">5</span> <span class="token comment">#sklearn - KFold</span>
<span class="token comment">#使用类xgb.cv</span>
time0 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
cvresult1 <span class="token operator">=</span> xgb<span class="token punctuation">.</span>cv<span class="token punctuation">(</span>param1<span class="token punctuation">,</span> dfull<span class="token punctuation">,</span> num_round<span class="token punctuation">,</span>n_fold<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>time0<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%M:%S:%f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#看看类xgb.cv生成了什么结果？</span>
cvresult1 <span class="token comment">#随着树不断增加，我们的模型的效果如何变化</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cvresult1<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"train,gamma=0"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cvresult1<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"orange"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"test,gamma=0"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#从这个图中，我们可以看出什么？</span>
<span class="token comment">#怎样从图中观察模型的泛化能力？</span>
<span class="token comment">#从这个图的角度来说，模型的调参目标是什么？</span>
param1 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'silent'</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token string">'obj'</span><span class="token punctuation">:</span><span class="token string">'reg:linear'</span><span class="token punctuation">,</span><span class="token string">"gamma"</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"eval_metric"</span><span class="token punctuation">:</span><span class="token string">"mae"</span><span class="token punctuation">}</span>
cvresult1 <span class="token operator">=</span> xgb<span class="token punctuation">.</span>cv<span class="token punctuation">(</span>param1<span class="token punctuation">,</span> dfull<span class="token punctuation">,</span> num_round<span class="token punctuation">,</span>n_fold<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cvresult1<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"train,gamma=0"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cvresult1<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"orange"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"test,gamma=0"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
param1 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'silent'</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token string">'obj'</span><span class="token punctuation">:</span><span class="token string">'reg:linear'</span><span class="token punctuation">,</span><span class="token string">"gamma"</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span>
param2 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'silent'</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token string">'obj'</span><span class="token punctuation">:</span><span class="token string">'reg:linear'</span><span class="token punctuation">,</span><span class="token string">"gamma"</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">}</span>
num_round <span class="token operator">=</span> <span class="token number">180</span>
n_fold<span class="token operator">=</span><span class="token number">5</span>

time0 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
cvresult1 <span class="token operator">=</span> xgb<span class="token punctuation">.</span>cv<span class="token punctuation">(</span>param1<span class="token punctuation">,</span> dfull<span class="token punctuation">,</span> num_round<span class="token punctuation">,</span>n_fold<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>time0<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%M:%S:%f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
time0 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
cvresult2 <span class="token operator">=</span> xgb<span class="token punctuation">.</span>cv<span class="token punctuation">(</span>param2<span class="token punctuation">,</span> dfull<span class="token punctuation">,</span> num_round<span class="token punctuation">,</span>n_fold<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>time0<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%M:%S:%f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cvresult1<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"train,gamma=0"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cvresult1<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"orange"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"test,gamma=0"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cvresult2<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"green"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"train,gamma=20"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cvresult2<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token string">"blue"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"test,gamma=20"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#从这里，你看出gamma是如何控制过拟合了吗？控制训练集上的训练 - 降低训练集上的表现</span>
</code></pre> 
<h2><a id="3_XGBoost_369"></a>3 XGBoost应用中的其他问题</h2> 
<h3><a id="31__370"></a>3.1 过拟合：剪枝参数与回归模型调参</h3> 
<p><img src="https://images2.imgbox.com/b1/4b/5KdmcuWi_o.png" alt="在这里插入图片描述"><br> 这些参数中，树的最大深度是决策树中的剪枝法宝，算是最常用的剪枝参数，不过在XGBoost中，最大深度的功能与参数 相似，因此如果先调节了 ，则最大深度可能无法展示出巨大的效果。当然，如果先调整了最大深度，则 也有可能无法显示明显的效果。通常来说，这两个参数中我们只使用一个，不过两个都试试也没有坏处。</p> 
<p>三个随机抽样特征的参数中，前两个比较常用。在建立树时对特征进行抽样其实是决策树和随机森林中比较常见的一种方法，但是在XGBoost之前，这种方法并没有被使用到boosting算法当中过。Boosting算法一直以抽取样本（横向抽样）来调整模型过拟合的程度，而实践证明其实纵向抽样（抽取特征）更能够防止过拟合。</p> 
<p>参数min_child_weight不太常用，它是一篇叶子上的二阶导数 之和，当样本所对应的二阶导数很小时，比如说为<br> 0.01，min_child_weight若设定为1，则说明一片叶子上至少需要100个样本。本质上来说，这个参数其实是在控制<br> 叶子上所需的最小样本量，因此对于样本量很大的数据会比较有效。如果样本量很小（比如我们现在使用的波士顿房价数据集，则这个参数效用不大）。就剪枝的效果来说，这个参数的功能也被 替代了一部分，通常来说我们会试试看这个参数，但这个参数不是我的优先选择。</p> 
<p>通常当我们获得了一个数据集后，我们先使用网格搜索找出比较合适的n_estimators和eta组合，然后使用gamma或 者max_depth观察模型处于什么样的状态（过拟合还是欠拟合，处于方差-偏差图像的左边还是右边？），最后再决定是否要进行剪枝。通常来说，对于XGB模型，大多数时候都是需要剪枝的。接下来我们就来看看使用xgb.cv这个类来进行剪枝调参，以调整出一组泛化能力很强的参数。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/18a54fd551c74e524efa36caf9286dbf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">人工智能技术在银行客服中心的应用风险</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7330f34d159ad49e15a958a511b669b9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">缅怀我的虾皮，瓜皮总是马后炮，事后明明也不是不会写</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>