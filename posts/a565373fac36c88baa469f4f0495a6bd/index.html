<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>电子科技大学-操作系统实验课-遇到的问题以及查找的知识总结 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="电子科技大学-操作系统实验课-遇到的问题以及查找的知识总结" />
<meta property="og:description" content="文章目录 linux与windows的操作系统内核都是宏内核内核编程特点：编写的内核模块必须有下面两种函数`printk`的使用内核模块的两种形态内核的两种声明需要包含的头文件一个内核模块的简单示例Makefile文件简介Makefile文件干啥的`obj-m`与`obj-y``ifeq`and`ifneq`and`ifdef`and`ifndef`KERNELRELEASE`make -C $(KDIR) M=$(PWD)`Makefile中的`$@`、`$^`、`$&lt;`、`$?`、 %、` &#43;`、`$*` C语言编写问题[Error] ‘for‘ loop initial declarations are only allowed in C99 or C11 mode 解决方法initializer element is not constant 问题kmalloc函数使用kfree函数的使用 一些其他问题printk打印不出来的解决方法insmod第一次killed，第二次直接卡死的原因 系统调用内核下载`linux 5.15.0`等一系列内核的系统调用需要修改的目录为编写系统调用遇到的一些问题 linux内核模块调用其他模块导出的函数遇到的一些问题 linux字符设备驱动程序编写方式`mknod`命令用于创建字符设备文件和块设备文件Linux中/proc目录下文件详解/proc/cmdline/proc/cpuinfo/proc/devices/proc/filesystems/proc/meminfo 遇到的一些问题步骤 linux与windows的操作系统内核都是宏内核 内核编程特点： 不能使用C库函数，如外部头文件，printf，可以使用如printk函数可以使用汇编语言，GNU C和GCC编译器不能使用FPU可能会产生内存故障 编写的内核模块必须有下面两种函数 static int hello_int(void){...} // static int __init hello_init(void) module_init(hello_init); 通过module_init(...);来指定程序开始运行的函数
static void hello_exit(void){...} // static void __exit hello_exit(void) module_exit(hello_exit); 通过module_exit(...);来指定程序终结时运行的函数，一般在这个exit函数，会释放申请的各种系统资源，最后退出，整个模块从内核中卸载
printk的使用 …
内核模块的两种形态 静态编译进内核的模块
用insmod命令动态加载的模块
用rmmod来卸载模块
sudo insmod hello.ko var=XXX
sudo rmmod hello." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a565373fac36c88baa469f4f0495a6bd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-05T17:08:04+08:00" />
<meta property="article:modified_time" content="2023-06-05T17:08:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">电子科技大学-操作系统实验课-遇到的问题以及查找的知识总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#linuxwindows_1" rel="nofollow">linux与windows的操作系统内核都是宏内核</a></li><li><a href="#_3" rel="nofollow">内核编程特点：</a></li><li><a href="#_10" rel="nofollow">编写的内核模块必须有下面两种函数</a></li><li><a href="#printk_26" rel="nofollow">`printk`的使用</a></li><li><a href="#_30" rel="nofollow">内核模块的两种形态</a></li><li><a href="#_42" rel="nofollow">内核的两种声明</a></li><li><a href="#_56" rel="nofollow">需要包含的头文件</a></li><li><a href="#_65" rel="nofollow">一个内核模块的简单示例</a></li><li><a href="#Makefile_247" rel="nofollow">Makefile文件简介</a></li><li><ul><li><a href="#Makefile_249" rel="nofollow">Makefile文件干啥的</a></li><li><a href="#objmobjy_253" rel="nofollow">`obj-m`与`obj-y`</a></li><li><a href="#ifeqandifneqandifdefandifndef_258" rel="nofollow">`ifeq`and`ifneq`and`ifdef`and`ifndef`</a></li><li><a href="#KERNELRELEASE_318" rel="nofollow">KERNELRELEASE</a></li><li><a href="#make_C_KDIR_MPWD_322" rel="nofollow">`make -C $(KDIR) M=$(PWD)`</a></li><li><a href="#Makefile_326" rel="nofollow">Makefile中的`$@`、`$^`、`$&lt;`、`$?`、<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
          
           
            
           
             %、` 
            
           
         </span><span class="katex-html"></span></span></span>+`、`$*`</a></li></ul> 
   </li><li><a href="#C_336" rel="nofollow">C语言编写问题</a></li><li><ul><li><a href="#Error_for_loop_initial_declarations_are_only_allowed_in_C99_or_C11_mode__338" rel="nofollow">[Error] ‘for‘ loop initial declarations are only allowed in C99 or C11 mode 解决方法</a></li><li><a href="#initializer_element_is_not_constant__344" rel="nofollow">initializer element is not constant 问题</a></li><li><a href="#kmalloc_350" rel="nofollow">kmalloc函数使用</a></li><li><a href="#kfree_356" rel="nofollow">kfree函数的使用</a></li></ul> 
   </li><li><a href="#_360" rel="nofollow">一些其他问题</a></li><li><ul><li><a href="#printk_362" rel="nofollow">printk打印不出来的解决方法</a></li><li><a href="#insmodkilled_368" rel="nofollow">insmod第一次killed，第二次直接卡死的原因</a></li></ul> 
   </li><li><a href="#_372" rel="nofollow">系统调用</a></li><li><ul><li><a href="#_396" rel="nofollow">内核下载</a></li><li><a href="#linux_5150_402" rel="nofollow">`linux 5.15.0`等一系列内核的系统调用需要修改的目录为</a></li><li><a href="#_416" rel="nofollow">编写系统调用</a></li><li><ul><li><a href="#_482" rel="nofollow">遇到的一些问题</a></li></ul> 
   </li></ul> 
   </li><li><a href="#linux_498" rel="nofollow">linux内核模块调用其他模块导出的函数</a></li><li><ul><li><a href="#_500" rel="nofollow">遇到的一些问题</a></li></ul> 
   </li><li><a href="#linux_518" rel="nofollow">linux字符设备驱动程序编写方式</a></li><li><ul><li><a href="#mknod_528" rel="nofollow">`mknod`命令用于创建字符设备文件和块设备文件</a></li><li><a href="#Linuxproc_552" rel="nofollow">Linux中/proc目录下文件详解</a></li><li><ul><li><a href="#proccmdline_564" rel="nofollow">/proc/cmdline</a></li><li><a href="#proccpuinfo_570" rel="nofollow">/proc/cpuinfo</a></li><li><a href="#procdevices_574" rel="nofollow">/proc/devices</a></li><li><a href="#procfilesystems_580" rel="nofollow">/proc/filesystems</a></li><li><a href="#procmeminfo_586" rel="nofollow">/proc/meminfo</a></li></ul> 
    </li><li><a href="#_590" rel="nofollow">遇到的一些问题</a></li><li><a href="#_596" rel="nofollow">步骤</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="linuxwindows_1"></a>linux与windows的操作系统内核都是宏内核</h3> 
<h3><a id="_3"></a>内核编程特点：</h3> 
<ol><li>不能使用C库函数，如外部头文件，<code>printf</code>，可以使用如<code>printk</code>函数</li><li>可以使用汇编语言，GNU C和GCC编译器</li><li>不能使用FPU</li><li>可能会产生内存故障</li></ol> 
<h3><a id="_10"></a>编写的内核模块必须有下面两种函数</h3> 
<ol><li> <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>  <span class="token comment">// static int __init hello_init(void)</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>hello_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
  <blockquote> 
   <p>通过<code>module_init(...);</code>来指定程序开始运行的函数</p> 
  </blockquote> </li><li> <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>  <span class="token comment">// static void __exit hello_exit(void)</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
  <blockquote> 
   <p>通过<code>module_exit(...);</code>来指定程序终结时运行的函数，一般在这个exit函数，会释放申请的各种系统资源，最后退出，整个模块从内核中卸载</p> 
  </blockquote> </li></ol> 
<h3><a id="printk_26"></a><code>printk</code>的使用</h3> 
<p>…</p> 
<h3><a id="_30"></a>内核模块的两种形态</h3> 
<ol><li> <p>静态编译进内核的模块</p> </li><li> <p>用<code>insmod</code>命令动态加载的模块</p> 
  <blockquote> 
   <p>用<code>rmmod</code>来卸载模块</p> 
   <p><code>sudo insmod hello.ko</code> var=XXX</p> 
   <p><code>sudo rmmod hello.ko</code></p> 
  </blockquote> </li></ol> 
<h3><a id="_42"></a>内核的两种声明</h3> 
<pre><code class="prism language-c"><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>内核是GNU开源工程的一部分，遵循GPL协议，使用MODULE_LICENSE可以声明你编写的这段代码使用设什么协议发布，一般声明GPL就可以了，不声明的话，内核可能不会接受，运行时的打印可能打不出来</p> 
<pre><code class="prism language-c"><span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"wit@zhaixue.cc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>MODULE_AUTHOR声明代码作者，一般可以留个邮箱或者名字，对这块代码感兴趣的人可以通过该联系方式找到你</p> 
<h3><a id="_56"></a>需要包含的头文件</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
</code></pre> 
<p>因为我们在内核模块中使用了<code>module_init</code>、<code>module_exit</code>函数，按照C语言先声明后使用的传统，所以要包含<code>module.h</code>头文件，这个头文件位于<code>include/linux</code>目录下，include是路径起点，所以要给头文件价格前缀：<code>linux/module.h</code>。<code>init.h</code>头文件主要定义了<code>__init</code>、<code>__exit</code>宏，用于将这个内核模块在编译时放到指定的section中，统一管理。</p> 
<h3><a id="_65"></a>一个内核模块的简单示例</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/moduleparam.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/slab.h&gt;</span></span>


<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>whom <span class="token operator">=</span> <span class="token string">"world"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment">//传递命令参数 S_IRUGO 指明参数可以被所有人读取 </span>
<span class="token function">module_param</span><span class="token punctuation">(</span>whom<span class="token punctuation">,</span> charp<span class="token punctuation">,</span> S_IRUGO
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span>
<span class="token keyword">int</span><span class="token punctuation">,</span>S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Node</span>  <span class="token comment">//typedef方法函数可以对于struct Node进行重命名</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> val<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

<span class="token punctuation">}</span> listnode<span class="token punctuation">,</span> <span class="token operator">*</span>LinkList<span class="token punctuation">;</span>  <span class="token comment">//定义一个结构体指针方便后续的操作</span>


listnode <span class="token operator">*</span><span class="token function">newNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    listnode <span class="token operator">*</span>L <span class="token operator">=</span> <span class="token punctuation">(</span>listnode <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>listnode<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//为头结点动态分配内存</span>
    L<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">//初始化时头结点指向空</span>
    L<span class="token operator">-&gt;</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> L<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">insertNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">,</span> listnode <span class="token operator">*</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    listnode <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    listnode <span class="token operator">*</span>tail <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tail<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tail <span class="token operator">=</span> tail<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tail<span class="token operator">-&gt;</span>next <span class="token operator">=</span> n<span class="token punctuation">;</span>
    head<span class="token operator">-&gt;</span>val <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">deleteNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">,</span> listnode <span class="token operator">*</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    listnode <span class="token operator">*</span>b <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    listnode <span class="token operator">*</span>a <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> head<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>val <span class="token operator">==</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            a<span class="token operator">-&gt;</span>next <span class="token operator">=</span> b<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            <span class="token function">kfree</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            head<span class="token operator">-&gt;</span>val <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            a <span class="token operator">=</span> b<span class="token punctuation">;</span>
            b <span class="token operator">=</span> b<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">lookupNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">,</span> listnode <span class="token operator">*</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    listnode <span class="token operator">*</span>b <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> head<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>val <span class="token operator">==</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            b <span class="token operator">=</span> b<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">printListNode</span><span class="token punctuation">(</span>listnode <span class="token operator">*</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    listnode <span class="token operator">*</span>b <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> head<span class="token operator">-&gt;</span>val <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT
        <span class="token string">"%d,"</span><span class="token punctuation">,</span> b<span class="token operator">-&gt;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        b <span class="token operator">=</span> b<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT
    <span class="token string">"%d,"</span><span class="token punctuation">,</span> b<span class="token operator">-&gt;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//程序中必须有下列两个函数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    LinkList head <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">insertNode</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    result <span class="token operator">=</span> <span class="token function">lookupNode</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT
    <span class="token string">"find 5 is %d"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">deleteNode</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">lookupNode</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT
    <span class="token string">"find 5 is %d"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printListNode</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        listnode <span class="token operator">*</span>n <span class="token operator">=</span> head<span class="token punctuation">;</span>
        head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT
    <span class="token string">"goodbye,kernel/n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//加载or卸载模块</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>hello_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 可选 </span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"zhou-silence"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"This is a simple example!/n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_VERSION</span><span class="token punctuation">(</span><span class="token string">"v1.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_ALIAS</span><span class="token punctuation">(</span><span class="token string">"A simplest example"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-makefile">obj-m:=hello.o


CURRENT_PATH :=$(shell pwd)
VERSION_NUM :=$(shell uname -r)
LINUX_PATH :=/usr/src/linux-headers-$(VERSION_NUM)

all :
	make -C $(LINUX_PATH) M=$(CURRENT_PATH) modules
clean :
	make -C $(LINUX_PATH) M=$(CURRENT_PATH) clean
</code></pre> 
<pre><code class="prism language-shell">root@duyuhui:~/experiment<span class="token comment"># ls</span>
hello.c  Makefile
root@duyuhui:~/experiment<span class="token comment"># make</span>
<span class="token function">make</span> -C /usr/src/linux-headers-5.15.0-71-generic <span class="token assign-left variable">M</span><span class="token operator">=</span>/root/experiment modules
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Entering directory <span class="token string">'/usr/src/linux-headers-5.15.0-71-generic'</span>
warning: the compiler differs from the one used to build the kernel
  The kernel was built by: gcc <span class="token punctuation">(</span>Ubuntu <span class="token number">11.3</span>.0-1ubuntu1~22.04.1<span class="token punctuation">)</span> <span class="token number">11.3</span>.0
  You are using:           gcc <span class="token punctuation">(</span>Ubuntu <span class="token number">11.3</span>.0-1ubuntu1~22.04<span class="token punctuation">)</span> <span class="token number">11.3</span>.0
  CC <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  /root/experiment/hello.o
  MODPOST /root/experiment/Module.symvers
  CC <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  /root/experiment/hello.mod.o
  LD <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  /root/experiment/hello.ko
  BTF <span class="token punctuation">[</span>M<span class="token punctuation">]</span> /root/experiment/hello.ko
Skipping BTF generation <span class="token keyword">for</span> /root/experiment/hello.ko due to unavailability of vmlinux
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/usr/src/linux-headers-5.15.0-71-generic'</span>
root@duyuhui:~/experiment<span class="token comment"># </span>
</code></pre> 
<pre><code class="prism language-shell">root@duyuhui:~/experiment<span class="token comment"># insmod hello.ko</span>
root@duyuhui:~/experiment<span class="token comment"># rmmod hello.ko</span>
root@duyuhui:~/experiment<span class="token comment"># dmesg</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token punctuation">[</span>  <span class="token number">502.824660</span><span class="token punctuation">]</span> <span class="token function">find</span> <span class="token number">5</span> is <span class="token number">1</span>
<span class="token punctuation">[</span>  <span class="token number">502.824758</span><span class="token punctuation">]</span> <span class="token function">find</span> <span class="token number">5</span> is -1
<span class="token punctuation">[</span>  <span class="token number">502.824817</span><span class="token punctuation">]</span> <span class="token number">0</span>,
<span class="token punctuation">[</span>  <span class="token number">502.824869</span><span class="token punctuation">]</span> <span class="token number">1</span>,
<span class="token punctuation">[</span>  <span class="token number">502.824918</span><span class="token punctuation">]</span> <span class="token number">2</span>,
<span class="token punctuation">[</span>  <span class="token number">502.824967</span><span class="token punctuation">]</span> <span class="token number">3</span>,
<span class="token punctuation">[</span>  <span class="token number">502.825019</span><span class="token punctuation">]</span> <span class="token number">4</span>,
<span class="token punctuation">[</span>  <span class="token number">502.825071</span><span class="token punctuation">]</span> <span class="token number">6</span>,
<span class="token punctuation">[</span>  <span class="token number">502.825121</span><span class="token punctuation">]</span> <span class="token number">7</span>,
<span class="token punctuation">[</span>  <span class="token number">502.825171</span><span class="token punctuation">]</span> <span class="token number">8</span>,
<span class="token punctuation">[</span>  <span class="token number">502.825221</span><span class="token punctuation">]</span> <span class="token number">9</span>,
<span class="token punctuation">[</span>  <span class="token number">506.827271</span><span class="token punctuation">]</span> goodbye,kernel/n
</code></pre> 
<h3><a id="Makefile_247"></a>Makefile文件简介</h3> 
<h4><a id="Makefile_249"></a>Makefile文件干啥的</h4> 
<p>在windows下的各种IDE可以帮助自动运行代码，但是到了linux环境下，需要使用Makefile文件来自动编译代码，一旦整个项目的Makefile都写好了以后，只需要一个简单的make命令，就可以实现自动编译了。当然，准确的说，是make这个命令工具帮助我们实现了我们想要做的事，而Makefile就相当于是一个规则文件，make程序会按照Makefile所指定的规则，去判断哪些文件需要先编译，哪些文件需要后编译，哪些文件需要重新编译</p> 
<h4><a id="objmobjy_253"></a><code>obj-m</code>与<code>obj-y</code></h4> 
<p><code>obj-m</code>表示把文件<code>XXX.o</code>作为模块进行编译，不会编译到内核，但是会生成一个独立的<code>XXX.ko</code>文件<br> <code>obj-y</code>表示把<code>XXX.o</code>文件编译进内核</p> 
<h4><a id="ifeqandifneqandifdefandifndef_258"></a><code>ifeq</code>and<code>ifneq</code>and<code>ifdef</code>and<code>ifndef</code></h4> 
<ol><li> <p><code>ifeq</code>是判断是否相等，如果相等就执行。</p> <p>其格式有4种</p> <pre><code class="prism language-makefile">ifeq (ARG1, ARG2)
如果相等就执行
ifeq 'ARG1' 'ARG2'
如果相等就执行
ifeq "ARG1" "ARG2"
如果相等就执行
ifeq "ARG1" 'ARG2'
如果相等就执行
</code></pre> <pre><code class="prism language-makefile">ifeq ($(strip $(foo)),)
如果为空就执行
endif
</code></pre> <p>如果ARG1与ARG2相等就执行</p> </li><li> <p><code>ifneq</code>与<code>ifeq</code>相反</p> </li><li> <p><code>ifdef</code>判断一个变量是否已经定义了</p> <p>格式为<code>ifdef VARIABLE-NAME</code></p> <p><code>ifdef</code> 只是测试一个变量是否有值，不会对变量进行<strong>替换展开</strong>来判断变量的值是否为空。</p> 
  <blockquote> 
   <p>除开<code>VARIABLE-NAME=</code>这种情况以外，使用其它方式对它的定义都会使<code>ifdef</code>返回真。就是说，即使我们通过其它方式（比如，定义它的值引用了其它的变量）给它赋了一个空值， <code>ifdef</code>也会返回真。</p> 
   <p>例子：</p> 
   <pre><code class="prism language-makefile">例1： 
bar = 
foo = $(bar) 
ifdef foo 
frobozz = yes 
else 
frobozz = no 
endif 

例 2： 
foo = 
ifdef foo 
frobozz = yes 
else 
frobozz = no 
endif 
</code></pre> 
   <p>例1的结果是：<code>frobozz = yes</code></p> 
   <p>例2的结果是：<code>frobozz = no</code></p> 
  </blockquote> </li><li> <p>ifndef与ifdef相反</p> </li></ol> 
<h4><a id="KERNELRELEASE_318"></a>KERNELRELEASE</h4> 
<p><code>ifeq ($(KERNELRELEASE),)</code>它的由来是指在Linux源码根目录下的Makefile编译内核时，KERNELRELEASE宏会被定义，这个时候非空</p> 
<h4><a id="make_C_KDIR_MPWD_322"></a><code>make -C $(KDIR) M=$(PWD)</code></h4> 
<p>其中<code>-C</code>指明到<code>$(KDIR)</code>目录下读取Makefile，<code>M=$(PWD)</code>表明返回到当前目录继续读入，执行当前的Makefile。</p> 
<h4><a id="Makefile_326"></a>Makefile中的<code>$@</code>、<code>$^</code>、<code>$&lt;</code>、<code>$?</code>、<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
      
        %、` 
       
      
    </span><span class="katex-html"></span></span></span>+<code>、</code>$*`</h4> 
<p>$@ 表示目标文件</p> 
<p>$^ 表示所有的依赖文件</p> 
<p>$&lt; 表示第一个依赖文件</p> 
<p>$? 表示比目标还要新的依赖文件列表</p> 
<h3><a id="C_336"></a>C语言编写问题</h3> 
<h4><a id="Error_for_loop_initial_declarations_are_only_allowed_in_C99_or_C11_mode__338"></a>[Error] ‘for‘ loop initial declarations are only allowed in C99 or C11 mode 解决方法</h4> 
<p>这是因为在 GCC 中直接在 for 循环中初始化了增量， 这种写法在 GCC 中是错误的，必须先定义变量i，然后可以成功编译运行。</p> 
<p>[<a href="https://cloud.tencent.com/developer/article/1908896" rel="nofollow">Error] ‘for‘ loop initial declarations are only allowed in C99 or C11 mode 解决方法-腾讯云开发者社区-腾讯云 (tencent.com)</a></p> 
<h4><a id="initializer_element_is_not_constant__344"></a>initializer element is not constant 问题</h4> 
<p><strong>C语言初始化一个全局变量或static变量时，只能用常量赋值，不能用变量赋值</strong>！</p> 
<p><a href="https://blog.csdn.net/shenwansangz/article/details/46756191">(30条消息) initializer element is not constant 问题_沈万三gz的博客-CSDN博客</a></p> 
<h4><a id="kmalloc_350"></a>kmalloc函数使用</h4> 
<p><a href="https://www.cnblogs.com/Senchuangdianzi/p/12215376.html" rel="nofollow">kmalloc函数详解 - 森码世界 - 博客园 (cnblogs.com)</a></p> 
<p>在linux内核中不能使用malloc</p> 
<h4><a id="kfree_356"></a>kfree函数的使用</h4> 
<p>直接<code>kfree(对象)</code>即可，值得注意的是你需要手动回收资源，否则系统不会帮你回收</p> 
<h3><a id="_360"></a>一些其他问题</h3> 
<h4><a id="printk_362"></a>printk打印不出来的解决方法</h4> 
<p><a href="https://www.yii666.com/article/75658.html" rel="nofollow">linux内核打印数据到串口控制台,printk数据不打印问题_广州建站小戴BOTAO博客 (yii666.com)</a></p> 
<p>这里死活打印不出来，就直接使用dmesg了</p> 
<h4><a id="insmodkilled_368"></a>insmod第一次killed，第二次直接卡死的原因</h4> 
<p><a href="https://blog.csdn.net/qz2014728/article/details/70822110">(32条消息) 关于模块insmod和rmmod出错的解决方案_rmmod卡死_Victor–的博客-CSDN博客</a></p> 
<h3><a id="_372"></a>系统调用</h3> 
<ol><li> <p>系统调用都具有一种明确的操作</p> 
  <blockquote> 
   <p>如：<code>getpid()</code>系统调用，根据定义它会返回当前进程的PID</p> 
   <p>实现如下：</p> 
   <pre><code class="prism language-c">asmlinkage <span class="token keyword">long</span> <span class="token function">sys_getpid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> current<span class="token operator">-&gt;</span>tgid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
   <p>asmlinkage限定词，通知编译器仅从栈中提取该函数的参数，系统调用都需要这个限定词，系统调用<code>get_pid()</code>在内核中被定义为<code>sys_getpid()</code></p> 
  </blockquote> </li><li> <p>在Linux系统中，每个系统调用被赋予一个系统调用号，用户空间中的进程执行一个系统调用的时候，这个系统调用号就被用来指明哪个系统调用，系统调用号存储在<code>sys_call_table</code>中，它与体系结构有关，一般在<code>entry.s</code>中定义</p> </li><li> <p>用户如何使用系统调用</p> <p><img src="https://images2.imgbox.com/b2/7f/j82w6LhT_o.png" alt="image-20230528102017976"></p> </li><li> <p>必须保证系统调用是可重入的</p> </li></ol> 
<h4><a id="_396"></a>内核下载</h4> 
<p>用 <code>apt-cache search linux-source</code> 和 <code>apt-get install linux-source</code> 可以搜索并下载当前内核版本的源码，并自动解压到 <code>/usr/src/</code> 目录下。</p> 
<p>使用<code>tar xvf linux-source-4.4.0.tar.gz</code>来解压。</p> 
<h4><a id="linux_5150_402"></a><code>linux 5.15.0</code>等一系列内核的系统调用需要修改的目录为</h4> 
<p><code>kernel/sys.c</code>是用于编写具体函数的，如下所示setuid就是一个声明后在这里编写具体函数</p> 
<p><img src="https://images2.imgbox.com/bc/f7/neoI60lq_o.png" alt="image-20230529101600683"></p> 
<p><code>include/linux/syscalls.h</code>是用于声明函数的，即asmlinage开头的，如下所示，setuid即为一个系统调用的声明</p> 
<p><img src="https://images2.imgbox.com/b9/6f/YWcWCvQD_o.png" alt="image-20230529101458045"></p> 
<p><code>arch/x86/entry/syscalls/syscall_64.tbl</code>是系统调用号表</p> 
<p><img src="https://images2.imgbox.com/91/8e/8ThrH9xX_o.png" alt="image-20230529101745374"></p> 
<h4><a id="_416"></a>编写系统调用</h4> 
<blockquote> 
 <p>下面的操作都是在下载好的内核里面操作，然后编译内核，安装内核，最终启动内核，然后写个程序测试是否可以使用</p> 
</blockquote> 
<ol><li>修改系统调用表号，如下，设置了调用表449号为我们的系统调用</li></ol> 
<p><img src="https://images2.imgbox.com/bc/a8/KqVDndsY_o.png" alt="image-20230531100410560"></p> 
<ol start="2"><li> <p>增加系统调用声明，如下，增加了系统调用声明asmlinkage开头的</p> <p><img src="https://images2.imgbox.com/00/f6/7mQikRE5_o.png" alt="image-20230531100521174"></p> </li><li> <p>增加系统调用实际内容，如下系统调用的内容是打印一个Hello eternal robot</p> <p><img src="https://images2.imgbox.com/f5/5e/QXWZQZex_o.png" alt="image-20230531100616311"></p> </li><li> <p>编译内核</p> <p><a href="https://www.fujieace.com/linux/kernel-add-new-system-call.html" rel="nofollow">Linux内核添加新的系统调用 教程 - 付杰博客 (fujieace.com)</a></p> <p><a href="https://blog.51cto.com/u_15127514/3516827" rel="nofollow">Linux重新编译内核_51CTO博客_ubuntu编译linux内核（这篇很详细）</a></p> <p>简单来说就是在下载内核解压根目录下运行下面内容</p> <pre><code class="prism language-shell"><span class="token function">make</span> clean
<span class="token function">make</span> defconfig
<span class="token function">make</span>
<span class="token function">make</span> modules_install
<span class="token function">make</span> <span class="token function">install</span>
</code></pre> <p>在虚拟机里面，输入<code>reboot</code>加回车后，长按<code>esc</code>键，才能进入选内核界面</p> </li><li> <p>测试内核</p> <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/syscall.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__NR_hello_eternal_robot</span> <span class="token expression"><span class="token number">448</span></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token function">syscall</span><span class="token punctuation">(</span>__NR_hello_eternal_robot<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ok! run dmesg | grep Hello in terminal!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>使用如下编译运行</p> <pre><code class="prism language-shell">root@duyuhui:~/experiment/2<span class="token comment"># nano hello.c </span>
root@duyuhui:~/experiment/2<span class="token comment"># gcc -o myhello hello.c</span>
root@duyuhui:~/experiment/2<span class="token comment"># ./myhello </span>
ok<span class="token operator">!</span> run <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">grep</span> Hello <span class="token keyword">in</span> terminal<span class="token operator">!</span>
root@duyuhui:~/experiment/2<span class="token comment"># dmesg | grep Hello</span>
<span class="token punctuation">[</span>  <span class="token number">707.558821</span><span class="token punctuation">]</span> Hello eternal robot 
<span class="token punctuation">[</span> <span class="token number">1413.170153</span><span class="token punctuation">]</span> Hello eternal robot 
<span class="token punctuation">[</span> <span class="token number">1462.344935</span><span class="token punctuation">]</span> Hello eternal robot 
root@duyuhui:~/experiment/2<span class="token comment"># </span>
</code></pre> <p>主要运行了三次，所以抓出了三个Hello内容</p> </li></ol> 
<h5><a id="_482"></a>遇到的一些问题</h5> 
<ol><li> <p>什么是SYSCALL_DEFINE</p> <p><a href="https://blog.csdn.net/hxmhyp/article/details/22699669">(34条消息) Linux系统调用之SYSCALL_DEFINE_麦兜布达拉的博客-CSDN博客</a></p> </li><li> <p>安装内核的时候遇到<code>E:You must put some 'deb-src' URIs in your sources.list</code>怎么办？</p> </li><li> <p>内核编译的时候在输入<code>make -j 5</code>后出现<code>gelf.h: No such file or directory</code>问题</p> <p><a href="https://blog.csdn.net/weixin_44260459/article/details/123035958">(34条消息) Ubuntu编译出现：gelf.h: No such file or directory_木可木可❀的博客-CSDN博客</a></p> </li><li> <p>自定义内核的时候在输入<code>make defconfig</code>后出现<code>lexer.lex.c Error 127</code>问题</p> <p><a href="https://blog.csdn.net/u011553516/article/details/120544785">(34条消息) make menuconfig出现错误lexer.lex.c Error 127_scripts/kconfig/lexer.lex.c_qt码农C的博客-CSDN博客</a></p> </li></ol> 
<h3><a id="linux_498"></a>linux内核模块调用其他模块导出的函数</h3> 
<h4><a id="_500"></a>遇到的一些问题</h4> 
<ol><li> <p><code>ERROR: modpost: “Func” [xxxxx.ko]undefined!</code>问题，下面给出了三种方式解决，这个里面的第二点解决方案有点问题，会导致下面的第二点错误<code>no symbol version for fptr_Operation</code></p> <p><a href="https://blog.csdn.net/special00/article/details/80928620">(34条消息) Linux内核模块间函数调用正确方法_内核模块调用外部函数_少林达摩祖师的博客-CSDN博客</a></p> </li><li> <p><code>no symbol version for fptr_Operation</code></p> <p><a href="http://blog.chinaunix.net/uid-20543672-id-3023148.html" rel="nofollow">关于内核模块挂载出现“no symbol version for”问题的研究-tekkamanninja-ChinaUnix博客</a></p> </li><li> <p>如何查看导出的函数，或查看函数是否导出了</p> <p><code>cat /proc/kallsyms | grep hello</code></p> </li><li> <p>如何计算内核模块时间</p> <p><a href="https://blog.csdn.net/lyndon_li/article/details/126294604">(35条消息) 统计内核代码运行时间_k_time_Li-Yongjun的博客-CSDN博客</a></p> </li></ol> 
<h3><a id="linux_518"></a>linux字符设备驱动程序编写方式</h3> 
<blockquote> 
 <p>Linux的设备管理是和文件系统紧密结合的，各种设备都以文件的形式存放在/dev目录 下，称为设备文件。应用程序可以打开、关闭和读写这些设备文件，完成对设备的操作，就像操作普通的数据文件一样。</p> 
 <p>为了管理这些设备，系统为设备编了号，每 个设备号又分为主设备号和次设备号。主设备号用来区分不同种类的设备，而次设备号用来区分同一类型的多个设备。对于常用设备，Linux有约定俗成的编 号，如硬盘的主设备号是3。</p> 
 <p>Linux为所有的设备文件都提供了统一的操作函数接口，方法是使用数据结构struct file_operations。这个数据结构中包括许多操作函数的指针，如open()、close()、read()和write()等，但由于外设 的种类较多，操作方式各不相同。Struct file_operations结构体中的成员为一系列的接口函数，如用于读/写的read/write函数和用于控制的ioctl等。</p> 
 <p>打开一个文件就是调用这个文件file_operations中的open操作。不同类型的文件有不同的file_operations成员函数，如普通的磁盘数据文件， 接口函数完成磁盘数据块读写操作；而对于各种设备文件，则最终调用各自驱动程序中的I/O函数进行具体设备的操作。这样，应用程序根本不必考虑操作的是设 备还是普通文件，可一律当作文件处理，具有非常清晰统一的I/O接口。所以file_operations是文件层次的I/O接口。</p> 
</blockquote> 
<h4><a id="mknod_528"></a><code>mknod</code>命令用于创建字符设备文件和块设备文件</h4> 
<p><code>mknod (选项) (参数)</code></p> 
<blockquote> 
 <p>选项有：</p> 
 <p>-Z：设置安全的上下文； -m：设置权限模式； -help：显示帮助信息； --version：显示版本信息。</p> 
 <p>参数有：</p> 
 <ul><li>文件名：要创建的设备文件名；</li><li>类型：指定要创建的设备文件的类型；</li><li>主设备号：指定设备文件的主设备号；</li><li>次设备号：指定设备文件的次设备号。</li></ul> 
 <p>例如：</p> 
 <p><code>mknod /dev/ttyUSB32 c 188 32</code></p> 
 <p>/dev/ttyUSB32，表示要创建的节点文件<br> c，表示是一个字符设备<br> 188，主设备号，表示某一个具体的驱动<br> 32，次设备号，表示使用这个驱动的各个设备</p> 
</blockquote> 
<h4><a id="Linuxproc_552"></a>Linux中/proc目录下文件详解</h4> 
<blockquote> 
 <p>/proc文件系统下的多种文件提供的系统信息不是针对某个特定进程的，而是能够在整个系统范围的上下文中使用。可以使用的文件随系统配置的变化而变化。</p> 
 <p>/proc文件系统是一个伪文件系统，它只存在内存当中，而不占用外存空间。</p> 
 <p>它以文件系统的方式为访问系统内核数据的操作提供接口。</p> 
 <p>由于系统的信息，如进程，是动态改变的，所以用户或应用程序读取proc文件时，proc文件系统是<strong>动态从系统内核读出所需信息并提交的</strong>。</p> 
</blockquote> 
<p><strong>下面列举一些类型</strong></p> 
<h5><a id="proccmdline_564"></a>/proc/cmdline</h5> 
<p>内核启动的命令行</p> 
<p><img src="https://images2.imgbox.com/55/ee/cUPAYRh3_o.png" alt="image-20230604152936222"></p> 
<h5><a id="proccpuinfo_570"></a>/proc/cpuinfo</h5> 
<p><img src="https://images2.imgbox.com/14/a5/USHlghwY_o.png" alt="image-20230604153113890"></p> 
<h5><a id="procdevices_574"></a>/proc/devices</h5> 
<p>列出字符和块设备的主设备号，以及分配到这些设备号的设备名称</p> 
<p><img src="https://images2.imgbox.com/06/48/vP0fVsRR_o.png" alt="image-20230604153221943"></p> 
<h5><a id="procfilesystems_580"></a>/proc/filesystems</h5> 
<p>列出可供使用的文件系统类型，一种类型一行。虽然它们通常是编入内核的文件系统类型，但该文件还可以包含可加载的内核模块加入的其它文件系统类型</p> 
<p><img src="https://images2.imgbox.com/ba/f5/PfDtw07x_o.png" alt="image-20230604153955626"></p> 
<h5><a id="procmeminfo_586"></a>/proc/meminfo</h5> 
<p><img src="https://images2.imgbox.com/5d/03/5xf59VEs_o.png" alt="image-20230604154139589"></p> 
<h4><a id="_590"></a>遇到的一些问题</h4> 
<p><code>struct file_operations</code>的头文件是<code>#include &lt;linux/fs.h&gt;</code></p> 
<p><code>copy_to_user</code>的头文件是<code>#include &lt;linux/uaccess.h&gt;</code></p> 
<h4><a id="_596"></a>步骤</h4> 
<ol><li> <p>注册字符设备</p> <p><img src="https://images2.imgbox.com/98/de/3kW4CcLf_o.png" alt="Snipaste_2023-06-04_15-45-11"></p> </li><li> <p>编写字符设备模块，以及载入内核，查看一下是否成果</p> <p>编写my_char_device.c代码</p> <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>

<span class="token comment">// 主设备号</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHAR_DEVICE_MAJOR</span> <span class="token expression"><span class="token number">255</span></span></span>
<span class="token comment">// 设备名</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHAR_DEVICE_NAME</span> <span class="token string">"my_char_devices"</span></span>
<span class="token comment">// 保存数据的最大长度</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MSG_LENGTH</span> <span class="token expression"><span class="token number">1024</span></span></span>

<span class="token comment">// 设备open次数</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> device_open_counts<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 保存从用户空间来的数据</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> message<span class="token punctuation">[</span>MSG_LENGTH<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 记录用户空间的数据的长度</span>
<span class="token keyword">static</span> <span class="token keyword">short</span> message_length<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"dyh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"自建字符设备/n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">device_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    device_open_counts<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s 已经打开了 %d 次\n"</span><span class="token punctuation">,</span>CHAR_DEVICE_NAME<span class="token punctuation">,</span>device_open_counts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">device_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s 关闭\n"</span><span class="token punctuation">,</span>CHAR_DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">device_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pOffset<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    ret<span class="token operator">=</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span>message<span class="token punctuation">,</span>message_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s 发送 %d 数量的字符给用户\n"</span><span class="token punctuation">,</span>CHAR_DEVICE_NAME<span class="token punctuation">,</span>message_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s 读取数据失败\n"</span><span class="token punctuation">,</span>CHAR_DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">device_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pOffset<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    ret<span class="token operator">=</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    message_length<span class="token operator">=</span>count<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s 接收来自用户的数据数量是 %d\n"</span><span class="token punctuation">,</span>CHAR_DEVICE_NAME<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s 接收数据失败\n"</span><span class="token punctuation">,</span>CHAR_DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 设备操作函数结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> device_operations<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner<span class="token operator">=</span>THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open<span class="token operator">=</span>device_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release<span class="token operator">=</span>device_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read<span class="token operator">=</span>device_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write<span class="token operator">=</span>device_write<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">char_device_driver_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"my_char_device 初始化\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册字符设备驱动</span>
    ret<span class="token operator">=</span><span class="token function">register_chrdev</span><span class="token punctuation">(</span>CHAR_DEVICE_MAJOR<span class="token punctuation">,</span>CHAR_DEVICE_NAME<span class="token punctuation">,</span><span class="token operator">&amp;</span>device_operations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s 设备注册失败\n"</span><span class="token punctuation">,</span>CHAR_DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">char_device_driver_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 注销字符设备驱动</span>
    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>CHAR_DEVICE_MAJOR<span class="token punctuation">,</span>CHAR_DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"my_char_device 退出\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>char_device_driver_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>char_device_driver_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <p>编写makefile文件</p> <pre><code class="prism language-makefile">obj-m:=my_char_device.o


CURRENT_PATH :=$(shell pwd)
VERSION_NUM :=$(shell uname -r)
LINUX_PATH :=/usr/src/linux-headers-$(VERSION_NUM)

all :
	make -C $(LINUX_PATH) M=$(CURRENT_PATH) modules
clean :
	make -C $(LINUX_PATH) M=$(CURRENT_PATH) clean

</code></pre> <pre><code class="prism language-shell"><span class="token function">make</span>
insmod my_char_device.ko
lsmod <span class="token function">grep</span> <span class="token operator">|</span> my_char_device
<span class="token function">ls</span> /dev
<span class="token function">cat</span> /proc/devices
</code></pre> <p>第一行是编译，第二行是载入，第三行是查看载入是否成功，第四行是列出设备，第五行是列出设备</p> </li><li> <p>编写测试程序</p> <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LENGTH</span> <span class="token expression"><span class="token number">1024</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">char</span> message<span class="token punctuation">[</span>LENGTH<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> to_send<span class="token punctuation">[</span>LENGTH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/my_char_device"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"无法打开 my_char_device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"给内核模块输入一些东西:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%[^\n]%*c"</span><span class="token punctuation">,</span> to_send<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"正在写入...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> to_send<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>to_send<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写入失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"按Enter键获取从内核发回的消息\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"正在读取...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> message<span class="token punctuation">,</span> LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"从设备中读取失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"信息是: [%s]\n"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-shell">root@duyuhui:~/experiment/4<span class="token comment"># gcc -o test test.c</span>
test.c: In <span class="token keyword">function</span> ‘main’:
test.c:21:14: warning: implicit declaration of <span class="token keyword">function</span> ‘write’<span class="token punctuation">;</span> did you mean ‘fwrite’? <span class="token punctuation">[</span>-Wimplicit-function-declaration<span class="token punctuation">]</span>
   <span class="token number">21</span> <span class="token operator">|</span>     result <span class="token operator">=</span> write<span class="token punctuation">(</span>fd, to_send, strlen<span class="token punctuation">(</span>to_send<span class="token punctuation">))</span><span class="token punctuation">;</span>
      <span class="token operator">|</span>              ^~~~~
      <span class="token operator">|</span>              fwrite
test.c:29:14: warning: implicit declaration of <span class="token keyword">function</span> ‘read’<span class="token punctuation">;</span> did you mean ‘fread’? <span class="token punctuation">[</span>-Wimplicit-function-declaration<span class="token punctuation">]</span>
   <span class="token number">29</span> <span class="token operator">|</span>     result <span class="token operator">=</span> read<span class="token punctuation">(</span>fd, message, LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">|</span>              ^~~~
      <span class="token operator">|</span>              fread
test.c:35:5: warning: implicit declaration of <span class="token keyword">function</span> ‘close’<span class="token punctuation">;</span> did you mean ‘pclose’? <span class="token punctuation">[</span>-Wimplicit-function-declaration<span class="token punctuation">]</span>
   <span class="token number">35</span> <span class="token operator">|</span>     close<span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">|</span>     ^~~~~
      <span class="token operator">|</span>     pclose
root@duyuhui:~/experiment/4<span class="token comment"># ls</span>
device  <span class="token builtin class-name">test</span>  test.c
root@duyuhui:~/experiment/4<span class="token comment"># ./test</span>
给内核模块输入一些东西:
sx
正在写入<span class="token punctuation">..</span>.
按Enter键获取从内核发回的消息

正在读取<span class="token punctuation">..</span>.
信息是: <span class="token punctuation">[</span>sx<span class="token punctuation">]</span>

</code></pre> </li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/616cd962ca454edc5985c8172b0c2c17/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">GNU/POSIX</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/48f123bd2da1dafaf3b083469ff5c7d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">eICIC和FeICIC</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>