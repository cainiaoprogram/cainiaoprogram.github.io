<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MQTT broker 集群部署 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MQTT broker 集群部署" />
<meta property="og:description" content="在近期的一个项目中，被问到公司自研的MQTT push服务器是否支持HA部署，从我了解的情况看目前还不支持。
[转载] 一篇使用 Apache activeMQ的集群部署实例，以后参考：
主要是利用HAProxy作为负载均衡器，利用activeMQ作为broker的集群。
1，准备4台服务器，默认操作系统为Ubuntu14.04，三台服务器安装activeMQ, 另外一台服务器安装HAProxy作为负载均衡。
2，安装和配置activeMQ
安装jre
sudo apt-get install default-jre export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64/jre 安装activeMQ
wget http://ftp.meisei-u.ac.jp/mirror/apache/dist/activemq/5.12.0/apache-activemq-5.12.0-bin.tar.gz tar zxvf apache-activemq-5.12.0-bin.tar.gz 启动activeMQ
cd [activemq_install_dir]/bin ./activemq console 3，配置activeMQ集群
假设三台broker服务器的地址分别是10.80.1.1, 10.80.1.2, 10.80.1.3，在三台服务器上分别配置如下
在服务器10.80.1.1上添加如下networkConnectors配置
&lt;networkConnectors&gt;
&lt;networkConnector uri=&#34;static:(tcp://10.80.1.2:61616,tcp://10.80.1.3:61616)&#34;/&gt;
&lt;/networkConnectors&gt;
在服务器10.80.1.2上添加如下networkConnectors配置
&lt;networkConnectors&gt;
&lt;networkConnector uri=&#34;static:(tcp://10.80.1.1:61616,tcp://10.80.1.3:61616)&#34;/&gt;
&lt;/networkConnectors&gt;
在服务器10.80.1.3上添加如下networkConnectors配置
&lt;networkConnectors&gt;
&lt;networkConnector uri=&#34;static:(tcp://10.80.1.1:61616,tcp://10.80.1.2:61616)&#34;/&gt;
&lt;/networkConnectors&gt;
4，可通过如下web console添加topic
http://10.80.1.1:8161/admin/
http://10.80.1.2:8161/admin/
http://10.80.1.3:8161/admin/
默认用户名和密码是admin和admin
分别添加一个topic，比如presence
5,安装并配置HAProxy，假设服务器地址为10.80.1.4
安装HAProxy请参考如下的文档
https://www.vultr.com/docs/installing-and-configuring-haproxy-on-ubuntu-14-04
在HAProxy配置文件里面添加如下配置并重启
frontend mqtt_proxy bind *:1883 mode tcp default_backend mqtt_agent backend mqtt_agent mode tcp option tcplog balance roundrobin server mqtt_01 10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fabfc8a9f233179a53d2f0270ed2f1b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-11-09T14:12:03+08:00" />
<meta property="article:modified_time" content="2016-11-09T14:12:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MQTT broker 集群部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>在近期的一个项目中，被问到公司自研的MQTT push服务器是否支持HA部署，从我了解的情况看目前还不支持。</p> 
<p>[转载] 一篇使用 Apache  activeMQ的集群部署实例，以后参考：</p> 
<p><br> </p> 
<p>主要是利用HAProxy作为负载均衡器，利用activeMQ作为broker的集群。<br> <br> <br> <br> <br> 1，准备4台服务器，默认操作系统为Ubuntu14.04，三台服务器安装activeMQ, 另外一台服务器安装HAProxy作为负载均衡。<br> <br> <br> <br> <br> 2，安装和配置activeMQ<br> <br> <br> 安装jre<br> <br> <br> sudo apt-get install default-jre <br> export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64/jre <br> <br> <br> 安装activeMQ<br> <br> <br> wget http://ftp.meisei-u.ac.jp/mirror/apache/dist/activemq/5.12.0/apache-activemq-5.12.0-bin.tar.gz <br> tar zxvf apache-activemq-5.12.0-bin.tar.gz <br> <br> <br> 启动activeMQ<br> <br> <br> cd [activemq_install_dir]/bin <br> ./activemq console <br> <br> <br> <br> <br> 3，配置activeMQ集群<br> <br> <br> 假设三台broker服务器的地址分别是10.80.1.1, 10.80.1.2, 10.80.1.3，在三台服务器上分别配置如下<br> <br> <br> 在服务器10.80.1.1上添加如下networkConnectors配置<br> &lt;networkConnectors&gt;<br> &lt;networkConnector uri="static:(tcp://10.80.1.2:61616,tcp://10.80.1.3:61616)"/&gt;<br> &lt;/networkConnectors&gt;<br> <br> <br> 在服务器10.80.1.2上添加如下networkConnectors配置<br> &lt;networkConnectors&gt;<br> &lt;networkConnector uri="static:(tcp://10.80.1.1:61616,tcp://10.80.1.3:61616)"/&gt;<br> &lt;/networkConnectors&gt;<br> <br> <br> 在服务器10.80.1.3上添加如下networkConnectors配置<br> &lt;networkConnectors&gt;<br> &lt;networkConnector uri="static:(tcp://10.80.1.1:61616,tcp://10.80.1.2:61616)"/&gt;<br> &lt;/networkConnectors&gt;<br> <br> <br> <br> <br> 4，可通过如下web console添加topic<br> <br> <br> http://10.80.1.1:8161/admin/<br> <br> <br> http://10.80.1.2:8161/admin/<br> <br> <br> http://10.80.1.3:8161/admin/<br> <br> <br> 默认用户名和密码是admin和admin<br> <br> <br> 分别添加一个topic，比如presence<br> <br> <br> <br> <br> 5,安装并配置HAProxy，假设服务器地址为10.80.1.4<br> <br> <br> 安装HAProxy请参考如下的文档<br> <br> <br> https://www.vultr.com/docs/installing-and-configuring-haproxy-on-ubuntu-14-04<br> <br> <br> 在HAProxy配置文件里面添加如下配置并重启<br> <br> <br> frontend mqtt_proxy <br> bind *:1883 <br> mode tcp <br> default_backend mqtt_agent <br> <br> <br> backend mqtt_agent <br> mode tcp <br> option  tcplog <br> balance roundrobin <br> server mqtt_01 10.80.1.1:1883 check <br> server mqtt_02 10.80.1.2:1883 check <br> server mqtt_03 10.80.1.3:1883 check  <br> <br> <br> 重启HAProxy。<br> <br> <br> <br> <br> 6，通过mqtt.js的MQTT的客户端来测试cluster server<br> <br> <br> var mqtt= require('mqtt'); <br> var client  = mqtt.connect('mqtt://10.80.1.4'); <br> <br> <br> client.on('connect', function () { <br> client.subscribe('presence'); <br> client.publish('presence', 'Hello this is from client and server: '+new Date()); <br> }); <br> client.on('message', function (topic, message) { <br> // message is Buffer <br> console.log(message.toString()); <br> client.end(); <br> }); <br> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cad5e38ee3b83531b73205852300a197/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">echo print() print_r() var_dump()的区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5fadd96d885d43f251d0c16941af5960/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">详解Linux下安装配置Nginx</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>