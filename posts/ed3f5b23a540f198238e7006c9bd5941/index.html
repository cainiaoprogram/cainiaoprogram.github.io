<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>供应商系统工具剖析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="供应商系统工具剖析" />
<meta property="og:description" content="文章目录 一、文件结构二、makefile 结构主线流程解析参数表驱动法获取任务任务数据结构任务队列任务进队任务出队 业务处理1、将命令包装成驱动可以识别的数据包2、netlink 收发函数3、收到消息时使用供应商专属的解析函数 一、文件结构 ├── 3rdParty │ └── wpa_supplicant │ ├── CONTRIBUTIONS │ ├── COPYING │ ├── README │ └── src │ └── drivers │ └── nl80211_copy.h ├── build │ ├── beamforming_on_connected.sh │ ├── build.sh │ └── Makefile ├── common │ └── include │ ├── dot11.h │ ├── netlink │ .............................(netlink相关头文件) ├── doc └── src ├── lib │ ├── libnl-3.so │ ├── libnl-3.so.200 │ ├── libnl-3.so.200.20.0 │ ├── libnl-genl-3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ed3f5b23a540f198238e7006c9bd5941/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-20T17:03:07+08:00" />
<meta property="article:modified_time" content="2023-09-20T17:03:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">供应商系统工具剖析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_5" rel="nofollow">一、文件结构</a></li><li><a href="#makefile__67" rel="nofollow">二、makefile 结构</a></li><li><a href="#_165" rel="nofollow">主线流程</a></li><li><ul><li><a href="#_175" rel="nofollow">解析参数</a></li><li><a href="#_269" rel="nofollow">表驱动法获取任务</a></li><li><a href="#_278" rel="nofollow">任务数据结构</a></li><li><a href="#_496" rel="nofollow">任务队列</a></li><li><ul><li><a href="#_498" rel="nofollow">任务进队</a></li><li><a href="#_518" rel="nofollow">任务出队</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_542" rel="nofollow">业务处理</a></li><li><ul><li><a href="#1_551" rel="nofollow">1、将命令包装成驱动可以识别的数据包</a></li><li><a href="#2netlink__611" rel="nofollow">2、netlink 收发函数</a></li><li><a href="#3_670" rel="nofollow">3、收到消息时使用供应商专属的解析函数</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_5"></a>一、文件结构</h2> 
<pre><code class="prism language-powershell">├── 3rdParty
│   └── wpa_supplicant
│       ├── CONTRIBUTIONS
│       ├── COPYING
│       ├── README
│       └── src
│           └── drivers
│               └── nl80211_copy<span class="token punctuation">.</span>h
├── build
│   ├── beamforming_on_connected<span class="token punctuation">.</span>sh
│   ├── build<span class="token punctuation">.</span>sh
│   └── Makefile
├── common
│   └── include
│       ├── dot11<span class="token punctuation">.</span>h
│       ├── netlink
│ <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span>netlink相关头文件<span class="token punctuation">)</span>
├── doc


└── src
    ├── lib
    │   ├── libnl-3<span class="token punctuation">.</span>so
    │   ├── libnl-3<span class="token punctuation">.</span>so<span class="token punctuation">.</span>200
    │   ├── libnl-3<span class="token punctuation">.</span>so<span class="token punctuation">.</span>200<span class="token punctuation">.</span>20<span class="token punctuation">.</span>0
    │   ├── libnl-genl-3<span class="token punctuation">.</span>so
    │   ├── libnl-genl-3<span class="token punctuation">.</span>so<span class="token punctuation">.</span>200
    │   ├── libnl-genl-3<span class="token punctuation">.</span>so<span class="token punctuation">.</span>200<span class="token punctuation">.</span>20<span class="token punctuation">.</span>0
    │   ├── managed
    │   │   ├── PrsManagedIface<span class="token punctuation">.</span><span class="token function">cpp</span>
    │   │   └── PrsManagedIface<span class="token punctuation">.</span>h
    │   ├── PrsDbg<span class="token punctuation">.</span><span class="token function">cpp</span>
    │   ├── PrsDbg<span class="token punctuation">.</span>h
    │   ├── PrsDeviceAccessIface<span class="token punctuation">.</span>h
    │   ├── PrsVendorCommand<span class="token punctuation">.</span><span class="token function">cpp</span>
    │   ├── PrsVendorCommand<span class="token punctuation">.</span>h
    │   ├── PrsVendorEndian<span class="token punctuation">.</span><span class="token function">cpp</span>
    │   ├── PrsVendorEndian<span class="token punctuation">.</span>h
    │   ├── PrsVendorEventFile<span class="token punctuation">.</span><span class="token function">cpp</span>
    │   ├── PrsVendorEventFile<span class="token punctuation">.</span>h
    │   ├── PrsVendorInterface<span class="token punctuation">.</span>h
    │   ├── PrsVendorInterfaceLinux<span class="token punctuation">.</span><span class="token function">cpp</span>
    │   ├── PrsVendorInterfaceLinux<span class="token punctuation">.</span>h
    │   ├── PrsVendorLib<span class="token punctuation">.</span><span class="token function">cpp</span>

    │   └── PrsVendorLib<span class="token punctuation">.</span>h
    └── sample
        └── linux
            ├── Sample<span class="token punctuation">.</span><span class="token function">cpp</span>
            ├── SampleEventListener<span class="token punctuation">.</span><span class="token function">cpp</span>
            ├── SampleEventListener<span class="token punctuation">.</span>h
            ├── SampleFileWriterEventListener<span class="token punctuation">.</span><span class="token function">cpp</span>
            ├── SampleFileWriterEventListener<span class="token punctuation">.</span>h
            ├── Sample<span class="token punctuation">.</span>h
            ├── SampleJsonEventListener<span class="token punctuation">.</span><span class="token function">cpp</span>
            ├── SampleJsonEventListener<span class="token punctuation">.</span>h
            ├── SampleSink<span class="token punctuation">.</span><span class="token function">cpp</span>
            └── SampleSink<span class="token punctuation">.</span>h
</code></pre> 
<h2><a id="makefile__67"></a>二、makefile 结构</h2> 
<pre><code class="prism language-powershell">PREFIX ?= <span class="token operator">/</span>usr
SBINDIR ?= $<span class="token punctuation">(</span>PREFIX<span class="token punctuation">)</span><span class="token operator">/</span>sbin
MANDIR ?= $<span class="token punctuation">(</span>PREFIX<span class="token punctuation">)</span><span class="token operator">/</span>share/man
MKDIR ?= mkdir <span class="token operator">-</span>p
INSTALL ?= install
CXXFLAGS <span class="token operator">+=</span> <span class="token operator">-</span>std=c+<span class="token operator">+</span>11 <span class="token operator">-</span>Wall <span class="token operator">-</span>Wundef <span class="token operator">-</span>Wno-trigraphs <span class="token operator">-</span>fno-strict-aliasing <span class="token operator">-</span>fno-common <span class="token operator">-</span>Werror-implicit-<span class="token keyword">function</span><span class="token operator">-</span>declaration
CC = <span class="token operator">/</span>opt/toolchain-aarch64_cortex-a53_gcc-5<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0_musl-1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>16/bin/aarch64-openwrt-linux-gcc
CXX = <span class="token operator">/</span>opt/toolchain-aarch64_cortex-a53_gcc-5<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0_musl-1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>16/bin/aarch64-openwrt-linux-g+<span class="token operator">+</span>
AR = <span class="token operator">/</span>opt/toolchain-aarch64_cortex-a53_gcc-5<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0_musl-1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>16/bin/aarch64-openwrt-linux-ar
LD = <span class="token operator">/</span>opt/toolchain-aarch64_cortex-a53_gcc-5<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0_musl-1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>16/bin/aarch64-openwrt-linux-ld
AROPTS = cr

ifeq <span class="token punctuation">(</span>$<span class="token punctuation">(</span>V<span class="token punctuation">)</span><span class="token punctuation">,</span>1<span class="token punctuation">)</span>
Q=
NQ=true
<span class="token keyword">else</span>
Q=@
NQ=<span class="token function">echo</span>
endif
<span class="token function">CP</span> = <span class="token function">cp</span>

INCLUDES=<span class="token operator">-</span>I$<span class="token punctuation">(</span>PRS_COMMON_DIR<span class="token punctuation">)</span><span class="token operator">/</span>include <span class="token operator">-</span>I$<span class="token punctuation">(</span>SUPPLICANT_DIR<span class="token punctuation">)</span><span class="token operator">/</span>src/drivers <span class="token operator">-</span>I$<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>lib <span class="token operator">-</span>I$<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>sample/linux 
VPATH=$<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>lib:$<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>lib/managed:$<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>sample/linux
LIBS <span class="token operator">+=</span> <span class="token operator">-</span>lprsvendor <span class="token operator">-</span>lpthread
LIBS <span class="token operator">+=</span> $<span class="token punctuation">(</span>shell pkg-config <span class="token operator">--</span>libs libnl-3<span class="token punctuation">.</span>0 libnl-genl-3<span class="token punctuation">.</span>0<span class="token punctuation">)</span>

PRS_TYPES_FLAGS=<span class="token operator">-</span>DLINUX_FWLOGS_POSTPROCESS
ifeq <span class="token punctuation">(</span>$<span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">,</span>1<span class="token punctuation">)</span>

CXXFLAGS <span class="token operator">+=</span> <span class="token operator">-</span>Og <span class="token operator">-</span>g <span class="token operator">-</span>D __DEBUG__=1 $<span class="token punctuation">(</span>PRS_TYPES_FLAGS<span class="token punctuation">)</span>
CFLAGS <span class="token operator">+=</span> <span class="token operator">-</span>Og <span class="token operator">-</span>g
OUTPUT_DIR=debug
DEBUG_FLAGS=<span class="token string">"DEBUG=1"</span>

<span class="token keyword">else</span>

CXXFLAGS <span class="token operator">+=</span> <span class="token operator">-</span>O3  $<span class="token punctuation">(</span>PRS_TYPES_FLAGS<span class="token punctuation">)</span>
CFLAGS <span class="token operator">+=</span> <span class="token operator">-</span>O3
OUTPUT_DIR=release
DEBUG_FLAGS=

endif

REL_DIR = <span class="token punctuation">.</span>
_OBJS_VENDOR_LIB =     PrsDbg<span class="token punctuation">.</span>o                        \
                    PrsVendorEndian<span class="token punctuation">.</span>o                \
                    PrsVendorCommand<span class="token punctuation">.</span>o                \
                    PrsVendorLib<span class="token punctuation">.</span>o                    \
                    PrsManagedIface<span class="token punctuation">.</span>o                \
                    PrsVendorInterfaceLinux<span class="token punctuation">.</span>o        \
                    PrsVendorEventFile<span class="token punctuation">.</span>o            \

OBJS_VENDOR_LIB = $<span class="token punctuation">(</span>patsubst <span class="token operator">%</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">%</span><span class="token punctuation">,</span>$<span class="token punctuation">(</span>_OBJS_VENDOR_LIB<span class="token punctuation">)</span><span class="token punctuation">)</span>
_OBJS_SAMPLE =         Sample<span class="token punctuation">.</span>o                              \
                         SampleEventListener<span class="token punctuation">.</span>o           \
                    SampleJsonEventListener<span class="token punctuation">.</span>o        \
                    SampleFileWriterEventListener<span class="token punctuation">.</span>o \
                    SampleSink<span class="token punctuation">.</span>o

OBJS_SAMPLE = $<span class="token punctuation">(</span>patsubst <span class="token operator">%</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">%</span><span class="token punctuation">,</span>$<span class="token punctuation">(</span>_OBJS_SAMPLE<span class="token punctuation">)</span><span class="token punctuation">)</span>

VENDOR_LIB = libprsvendor
SAMPLE_APP = prs_vendor_app

all: dirs $<span class="token punctuation">(</span>VENDOR_LIB<span class="token punctuation">)</span><span class="token punctuation">.</span>a $<span class="token punctuation">(</span>SAMPLE_APP<span class="token punctuation">)</span>

$<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">%</span><span class="token punctuation">.</span>o: $<span class="token punctuation">(</span>REL_DIR<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">%</span><span class="token punctuation">.</span>c
    @$<span class="token punctuation">(</span>NQ<span class="token punctuation">)</span> <span class="token string">' CC     '</span> $@
    $<span class="token punctuation">(</span>Q<span class="token punctuation">)</span>$<span class="token punctuation">(</span>CC<span class="token punctuation">)</span> $<span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> $<span class="token punctuation">(</span>INCLUDES<span class="token punctuation">)</span> <span class="token operator">-</span>c $&lt; <span class="token operator">-</span>o $@

$<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">%</span><span class="token punctuation">.</span>o: $<span class="token punctuation">(</span>REL_DIR<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">%</span><span class="token punctuation">.</span><span class="token function">cpp</span>
    @$<span class="token punctuation">(</span>NQ<span class="token punctuation">)</span> <span class="token string">' CXX     '</span> $@
    $<span class="token punctuation">(</span>Q<span class="token punctuation">)</span>$<span class="token punctuation">(</span>CXX<span class="token punctuation">)</span> $<span class="token punctuation">(</span>CXXFLAGS<span class="token punctuation">)</span> $<span class="token punctuation">(</span>INCLUDES<span class="token punctuation">)</span> <span class="token operator">-</span>c $&lt; <span class="token operator">-</span>o $@

$<span class="token punctuation">(</span>VENDOR_LIB<span class="token punctuation">)</span><span class="token punctuation">.</span>a: dirs $<span class="token punctuation">(</span>OBJS_VENDOR_LIB<span class="token punctuation">)</span> 
    <span class="token function">echo</span> <span class="token string">' AR '</span> $<span class="token punctuation">(</span>VENDOR_LIB<span class="token punctuation">)</span><span class="token punctuation">.</span>a
    $<span class="token punctuation">(</span>AR<span class="token punctuation">)</span> $<span class="token punctuation">(</span>AROPTS<span class="token punctuation">)</span> $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span>$<span class="token punctuation">(</span>VENDOR_LIB<span class="token punctuation">)</span><span class="token punctuation">.</span>a $<span class="token punctuation">(</span>OBJS_VENDOR_LIB<span class="token punctuation">)</span> $<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>lib/libnl-3<span class="token punctuation">.</span>so $<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>lib/libnl-genl-3<span class="token punctuation">.</span>so
    $<span class="token punctuation">(</span><span class="token function">CP</span><span class="token punctuation">)</span> $<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>lib/PrsVendorLib<span class="token punctuation">.</span>h $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span>include
    $<span class="token punctuation">(</span><span class="token function">CP</span><span class="token punctuation">)</span> $<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>lib/libnl-3<span class="token punctuation">.</span>so $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span>libnl-3<span class="token punctuation">.</span>so
    $<span class="token punctuation">(</span><span class="token function">CP</span><span class="token punctuation">)</span> $<span class="token punctuation">(</span>SRC_DIR<span class="token punctuation">)</span><span class="token operator">/</span>lib/libnl-genl-3<span class="token punctuation">.</span>so $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span>libnl-genl-3<span class="token punctuation">.</span>so
    $<span class="token punctuation">(</span><span class="token function">CP</span><span class="token punctuation">)</span> <span class="token operator">-</span>rf $<span class="token punctuation">(</span>PRS_COMMON_DIR<span class="token punctuation">)</span><span class="token operator">/</span>include $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span>

$<span class="token punctuation">(</span>SAMPLE_APP<span class="token punctuation">)</span>: dirs $<span class="token punctuation">(</span>OBJS_SAMPLE<span class="token punctuation">)</span> $<span class="token punctuation">(</span>VENDOR_LIB<span class="token punctuation">)</span><span class="token punctuation">.</span>a
    @$<span class="token punctuation">(</span>NQ<span class="token punctuation">)</span> <span class="token string">' LINK     '</span> $<span class="token punctuation">(</span>SAMPLE_APP<span class="token punctuation">)</span>
    $<span class="token punctuation">(</span>CXX<span class="token punctuation">)</span> $<span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span> $<span class="token punctuation">(</span>OBJS_SAMPLE<span class="token punctuation">)</span> <span class="token operator">-</span>L$<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span> $<span class="token punctuation">(</span>LIBS<span class="token punctuation">)</span> <span class="token operator">-</span>o $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span>$<span class="token punctuation">(</span>SAMPLE_APP<span class="token punctuation">)</span>

dirs:
    $<span class="token punctuation">(</span>MKDIR<span class="token punctuation">)</span> $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span>
    $<span class="token punctuation">(</span>MKDIR<span class="token punctuation">)</span> $<span class="token punctuation">(</span>OUTPUT_DIR<span class="token punctuation">)</span><span class="token operator">/</span>include

clean: 
    $<span class="token punctuation">(</span>Q<span class="token punctuation">)</span><span class="token function">rm</span> <span class="token operator">-</span>rf debug release
</code></pre> 
<p>其实我们关心的并不是这个工具的结构，而是这个工具的实现方法，是否有通用的软件工具开发方法？</p> 
<h2><a id="_165"></a>主线流程</h2> 
<p><img src="https://images2.imgbox.com/fd/c5/z1cjyLTh_o.png" alt="在这里插入图片描述"><br> 可以看出这个工具主要是两个用途：</p> 
<ol><li>向底层发送命令；</li><li>监听底层的事件。</li></ol> 
<p>我们主要分析 GetOpts() 和 g_run。<br> GetOpts() 用于解析用户命令，打包参数通过表驱动法查表封装任务到任务队列。</p> 
<h3><a id="_175"></a>解析参数</h3> 
<pre><code class="prism language-c">bool <span class="token function">GetOpts</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> a_argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> a_argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SPrsSampleAppOpts<span class="token operator">&amp;</span>  a_opts<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">int32_t</span>     argIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    bool        ok <span class="token operator">=</span> true<span class="token punctuation">;</span>
    bool        specificCommands <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>       parms <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    bool        help <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span>    eventId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    a_opts<span class="token punctuation">.</span>inputSelection       <span class="token operator">=</span> InputSelection_Interface<span class="token punctuation">;</span>
    a_opts<span class="token punctuation">.</span>interfaceName        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    a_opts<span class="token punctuation">.</span>peerDevice           <span class="token operator">=</span> false<span class="token punctuation">;</span>
    a_opts<span class="token punctuation">.</span>inputFileName        <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

    a_opts<span class="token punctuation">.</span>outputSelection      <span class="token operator">=</span> OutputSelection_Stdout<span class="token punctuation">;</span>
    a_opts<span class="token punctuation">.</span>outputFileName       <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    a_opts<span class="token punctuation">.</span>remoteJsonHost       <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    a_opts<span class="token punctuation">.</span>remoteJsonPort       <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    a_opts<span class="token punctuation">.</span>eventsWaitSeconds    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    a_opts<span class="token punctuation">.</span>eventFilters         <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>argIndex <span class="token operator">&lt;</span> a_argc<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>a_argv<span class="token punctuation">[</span>argIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            help <span class="token operator">=</span> true<span class="token punctuation">;</span>    <span class="token comment">//帮助模式开启</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>a_argv<span class="token punctuation">[</span>argIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>argIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> a_argc<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Note: Ignoring -c option (no longer needed)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            argIndex<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>a_argv<span class="token punctuation">[</span>argIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>argIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> a_argc<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            argIndex<span class="token operator">++</span><span class="token punctuation">;</span>
            a_opts<span class="token punctuation">.</span>inputSelection <span class="token operator">=</span> InputSelection_Interface<span class="token punctuation">;</span>
            a_opts<span class="token punctuation">.</span>interfaceName <span class="token operator">=</span> a_argv<span class="token punctuation">[</span>argIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>a_argv<span class="token punctuation">[</span>argIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-e"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>argIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> a_argc<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            argIndex<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>a_argv<span class="token punctuation">[</span>argIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-o"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>argIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> a_argc<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            argIndex<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>a_argv<span class="token punctuation">[</span>argIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>argIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> a_argc<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            specificCommands <span class="token operator">=</span> true<span class="token punctuation">;</span>    <span class="token comment">//命令模式</span>
            argIndex<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ProcessCmdParms</span><span class="token punctuation">(</span>a_argc<span class="token punctuation">,</span> a_argv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>argIndex<span class="token punctuation">,</span> parms<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//查表执行命令</span>
            <span class="token punctuation">{<!-- --></span>
                ok <span class="token operator">=</span> false<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>a_argv<span class="token punctuation">[</span>argIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>argIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> a_argc<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error: Unknown option "</span>
                 <span class="token operator">&lt;&lt;</span> a_argv<span class="token punctuation">[</span>argIndex<span class="token punctuation">]</span>
                 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            ok <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        argIndex<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>help<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Usage</span><span class="token punctuation">(</span>a_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//打印用法</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> ok<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>省略了大部分不重要的代码，这个函数主要是分析用户执行时所带的参数，例如：<br> -s ，那么参数后面就要带命令。<br> -h ，直接就打印工具的使用方法了。<br> -i，参数后面要带指定的网络接口。<br> 等等，我们继续分析命令模式。</p> 
<h3><a id="_269"></a>表驱动法获取任务</h3> 
<pre><code class="prism language-c"><span class="token function">ProcessCmdParms</span><span class="token punctuation">(</span>a_argc<span class="token punctuation">,</span> a_argv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>argIndex<span class="token punctuation">,</span> parms<span class="token punctuation">)</span>
</code></pre> 
<p>a_argc 是 main 函数的参数个数，a_argv 是 main 函数的所有参数组成的字符串。<br> &amp;argIndex 和 parms 有其他的用法，但是不是用在命令模式中，无视即可。<br> 先来看一个用于封装任务的数据结构：</p> 
<h3><a id="_278"></a>任务数据结构</h3> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">SPrsCmdDef</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// @brief Test command name</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>     cmdName<span class="token punctuation">;</span>

    <span class="token comment">/// @brief A test description</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>     cmdDesc<span class="token punctuation">;</span>

    <span class="token comment">/// @brief Indicates whether connection is required or not</span>
    bool            cnxn<span class="token punctuation">;</span>    <span class="token comment">//这个无视即可</span>

    <span class="token comment">/// @brief 任务的回调函数</span>
    CmdHandler      func<span class="token punctuation">;</span>

    <span class="token comment">/// @brief 解析一些特殊的参数</span>
    CmdHandlerParms getFuncParms<span class="token punctuation">;</span>

    <span class="token comment">/// @brief 命令的具体用法</span>
    CmdUsage        usage<span class="token punctuation">;</span>

    <span class="token comment">/// @brief 运行函数所需的参数指针</span>
    <span class="token keyword">void</span><span class="token operator">*</span>           parms<span class="token punctuation">;</span>

<span class="token punctuation">}</span> SPrsCmdDef<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token function">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span>CmdHandler<span class="token punctuation">)</span><span class="token punctuation">(</span>PrsCommandIface<span class="token operator">*</span> a_comIface<span class="token punctuation">,</span> SPrsCmdDef<span class="token operator">*</span> a_cmdDef<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// @brief 为任务函数解析一些特殊的参数</span>
<span class="token keyword">typedef</span> <span class="token function">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span>CmdHandlerParms<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> a_argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> a_argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> a_argIndex<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> a_cmdParms<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// @brief 打印用法的函数指针</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>CmdUsage<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>ProcessCmdParms 源码：</p> 
<pre><code class="prism language-c">bool <span class="token function">ProcessCmdParms</span><span class="token punctuation">(</span>
 <span class="token class-name">int32_t</span> a_argc<span class="token punctuation">,</span>
 <span class="token keyword">char</span><span class="token operator">*</span> a_argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token class-name">int32_t</span><span class="token operator">*</span> a_argIndex<span class="token punctuation">,</span>
 <span class="token keyword">void</span><span class="token operator">*</span> a_parms <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    bool          ok <span class="token operator">=</span> true<span class="token punctuation">;</span>
    SPrsCmdDef<span class="token operator">*</span>   cmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>cmd <span class="token operator">=</span> <span class="token function">GetCommandByName</span><span class="token punctuation">(</span>a_argv<span class="token punctuation">[</span><span class="token operator">*</span>a_argIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//查表获取命令的完整结构体</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token operator">-&gt;</span>getFuncParms<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token operator">-&gt;</span><span class="token function">getFuncParms</span><span class="token punctuation">(</span>a_argc<span class="token punctuation">,</span> a_argv<span class="token punctuation">,</span> a_argIndex<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a_parms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//解析命令的参数（-s之后的内容）</span>
            <span class="token punctuation">{<!-- --></span>
                cmd<span class="token operator">-&gt;</span>parms <span class="token operator">=</span> a_parms<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token operator">-&gt;</span>usage<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Error: "</span>
                         <span class="token operator">&lt;&lt;</span> a_argv<span class="token punctuation">[</span><span class="token operator">*</span>a_argIndex<span class="token punctuation">]</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">" expects parameters "</span><span class="token punctuation">;</span>
                    cmd<span class="token operator">-&gt;</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cout <span class="token operator">&lt;&lt;</span> endl
 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>

                    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Error: Failed to collect command parameters"</span>
 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


                delete cmd<span class="token punctuation">;</span>
                cmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                ok <span class="token operator">=</span> false<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ok <span class="token operator">&amp;&amp;</span> cmd<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Added \""</span>
                 <span class="token operator">&lt;&lt;</span> cmd<span class="token operator">-&gt;</span>cmdDesc
                 <span class="token operator">&lt;&lt;</span> <span class="token string">"\" command"</span>
                 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            g_run<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Error: "</span>
             <span class="token operator">&lt;&lt;</span> a_argv<span class="token punctuation">[</span><span class="token operator">*</span>a_argIndex<span class="token punctuation">]</span>
             <span class="token operator">&lt;&lt;</span> <span class="token string">" command is not recognized."</span>
             <span class="token operator">&lt;&lt;</span> endl
             <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        ok <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> ok<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>GetCommandByName 原型</p> 
<pre><code class="prism language-c">SPrsCmdDef<span class="token operator">*</span> <span class="token function">GetCommandByName</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> a_cmdName<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">int32_t</span>       cmdNo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    SPrsCmdDef<span class="token operator">*</span>   cmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    cmd <span class="token operator">=</span> new <span class="token function">SPrsCmdDef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>cmdNo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> cmdNo <span class="token operator">&lt;</span> ePrsSampleCommands_Max<span class="token punctuation">;</span> cmdNo<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>g_cmds<span class="token punctuation">[</span>cmdNo<span class="token punctuation">]</span><span class="token punctuation">.</span>cmdName<span class="token punctuation">,</span> a_cmdName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//通过命令的枚举编号获取命令在表中的位置</span>
            <span class="token punctuation">{<!-- --></span>
               <span class="token comment">// 如果找得到命令，就把这个命令在表中的结构体复制给要执行的 cmd 变量</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_cmds<span class="token punctuation">[</span>cmdNo<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SPrsCmdDef<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>cmdNo <span class="token operator">==</span> ePrsSampleCommands_Max<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            delete cmd<span class="token punctuation">;</span>
            cmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> cmd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 命令的枚举，查表时使用 */</span>
<span class="token keyword">enum</span> <span class="token class-name">EPrsSampleCommands</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// @brief Add Block ACK command</span>
    ePrsSampleCommands_AddBlockAck <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>

    <span class="token comment">/// @brief Query Block ACK status command</span>
    ePrsSampleCommands_QueryBlockAckStatus<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Delete Block ACK command</span>
    ePrsSampleCommands_DelBlockAck<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Link measurement request command</span>
    ePrsSampleCommands_LinkMeasure<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Query MIB(s) command</span>
    ePrsSampleCommands_QueryMib<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Set MIB(s) command</span>
    ePrsSampleCommands_SetMib<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Set aiming mode with no options</span>
    ePrsSampleCommands_SimpleAimMode<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Set aiming mode with channel number</span>
    ePrsSampleCommands_ChannelAimMode<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Set aiming mode given BSSID of AP and channel number</span>
    ePrsSampleCommands_BssidAimMode<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Enable firmware logs</span>
    ePrsSampleCommands_EnableFwLogs<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Set the power mode</span>
    ePrsSampleCommands_PowerMode<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Issue firmare reset</span>
    ePrsSampleCommands_Reset<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Initiate get crash logs from firmware</span>
    ePrsSampleCommands_GetCrashLogs<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Enable DBSC feature</span>
    ePrsSampleCommands_DbscEnable<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Disable DBSC feature</span>
    ePrsSampleCommands_DbscDisable<span class="token punctuation">,</span>

    <span class="token comment">/// @brief Notification filter commands</span>
    ePrsSampleCommands_NotificationFilter<span class="token punctuation">,</span>

    <span class="token comment">/// @brief 命令的数量</span>
    ePrsSampleCommands_Max
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>核心来了，表驱动法！！！</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> SPrsCmdDef g_cmds<span class="token punctuation">[</span>ePrsSampleCommands_Max<span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">// Connection based commands</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"aba"</span><span class="token punctuation">,</span> <span class="token string">"Add Block ACK"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DoAddBlockAck<span class="token punctuation">,</span> GetPeerAddress<span class="token punctuation">,</span> UsagePeerAddr<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"qba"</span><span class="token punctuation">,</span> <span class="token string">"Query Block ACK status"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DoQueryBlockAckStatus<span class="token punctuation">,</span> GetPeerAddress<span class="token punctuation">,</span> UsagePeerAddr<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"dba"</span><span class="token punctuation">,</span> <span class="token string">"Send del Block ACK"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DoDelBlockAck<span class="token punctuation">,</span> GetPeerAddress<span class="token punctuation">,</span> UsagePeerAddr<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"lm"</span><span class="token punctuation">,</span> <span class="token string">"Link measurement request"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DoLinkMeasure<span class="token punctuation">,</span> GetPeerAddress<span class="token punctuation">,</span> UsagePeerAddr<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>

   <span class="token comment">// Non-connection based commands</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"qmib"</span><span class="token punctuation">,</span> <span class="token string">"Query a range of MIBs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoQueryMib<span class="token punctuation">,</span> GetQueryMibs<span class="token punctuation">,</span> UsageQueryMibs<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"smib"</span><span class="token punctuation">,</span> <span class="token string">"Set a range of MIBs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoSetMib<span class="token punctuation">,</span> GetSetMibsAndVals<span class="token punctuation">,</span> UsageSetMib<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"aim1"</span><span class="token punctuation">,</span> <span class="token string">"Enable/Disable Aiming mode"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoSimpleAimMode<span class="token punctuation">,</span> GetSetting<span class="token punctuation">,</span> UsageEnableAimingMode<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"aim2"</span><span class="token punctuation">,</span> <span class="token string">"Set aiming mode on with channel"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoChannelAimMode<span class="token punctuation">,</span> GetSetting<span class="token punctuation">,</span> UsageChannelNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"aim3"</span><span class="token punctuation">,</span> <span class="token string">"Set aiming mode on with BSSID/channel"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoBssidAimMode<span class="token punctuation">,</span> GetChannelAndBssid<span class="token punctuation">,</span> UsageChannelAndBssid<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"fel"</span><span class="token punctuation">,</span> <span class="token string">"Enable/Disable firmware logs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoEnableFwLogs<span class="token punctuation">,</span> GetSetting<span class="token punctuation">,</span> UsageEnable<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"pm"</span><span class="token punctuation">,</span> <span class="token string">"Set power mode"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoPowerMode<span class="token punctuation">,</span> GetSetting<span class="token punctuation">,</span> UsagePowerMode<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"rs"</span><span class="token punctuation">,</span> <span class="token string">"Issue firmware reset"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoReset<span class="token punctuation">,</span> GetOptionalResetTime<span class="token punctuation">,</span> UsageReset<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"fgl"</span><span class="token punctuation">,</span> <span class="token string">"Trigger getting firmware crash logs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoGetCrashLogs<span class="token punctuation">,</span> GetSetting<span class="token punctuation">,</span> UsageCrashLogs<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"dbsc_en"</span><span class="token punctuation">,</span> <span class="token string">"Enable DBSC"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoDbscEnable<span class="token punctuation">,</span> GetChannelAndBssid<span class="token punctuation">,</span> UsageChannelAndBssid<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"dbsc_dis"</span><span class="token punctuation">,</span> <span class="token string">"Disable DBSC"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoDbscDisable<span class="token punctuation">,</span> GetChannelAndBssid<span class="token punctuation">,</span> UsageChannelAndBssid<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span> <span class="token string">"notif"</span><span class="token punctuation">,</span> <span class="token string">"Notification filter commands"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DoNotifFilter<span class="token punctuation">,</span> GetNotifFilter<span class="token punctuation">,</span> UsageNotifFilter<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>每个命令的名称、说明、回调函数、获取参数的函数、普通参数做成了一个表。通过查找一个表的命令名称就可以找到对应的回调函数去执行。</p> 
<h3><a id="_496"></a>任务队列</h3> 
<h4><a id="_498"></a>任务进队</h4> 
<p>ProcessCmdParms函数的下半段：</p> 
<pre><code class="prism language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>ok <span class="token operator">&amp;&amp;</span> cmd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Added \""</span>
             <span class="token operator">&lt;&lt;</span> cmd<span class="token operator">-&gt;</span>cmdDesc
             <span class="token operator">&lt;&lt;</span> <span class="token string">"\" command"</span>
             <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        g_run<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>g_run.push(cmd) 就是将一个任务结构体写进了队列，这个队列在全局中实现：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> queue<span class="token operator">&lt;</span> SPrsCmdDef<span class="token operator">*</span> <span class="token operator">&gt;</span> g_run<span class="token punctuation">;</span>
</code></pre> 
<p>可以看到是通过 std 标准库来实现的，而且为了减少内存和提高翻问速度，队列里存放的是任务指针。</p> 
<h4><a id="_518"></a>任务出队</h4> 
<p>现在回到主函数的一部分：</p> 
<pre><code class="prism language-c">    <span class="token keyword">if</span> <span class="token punctuation">(</span>g_run<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Command mode exclusive to event mode otherwise command</span>
        <span class="token comment">// output gets garbled and cannot be parsed.</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>rc <span class="token operator">&amp;&amp;</span> g_run<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

            cmd <span class="token operator">=</span> g_run<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//获取任务队列中最先入队的任务</span>
            g_run<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//成员出队</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> cmd<span class="token operator">-&gt;</span><span class="token function">func</span><span class="token punctuation">(</span>com<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//然后执行任务</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">else</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>软件框架上就是这样，简单的框架，复杂的任务。<br> <img src="https://images2.imgbox.com/74/7c/jX0FU0PW_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_542"></a>业务处理</h2> 
<p>下面简单讲一下这个工具的业务处理，对比两个命令的执行流程来了解一下。<br> <img src="https://images2.imgbox.com/81/10/BHERPDov_o.png" alt="在这里插入图片描述"></p> 
<p>从这里也就可以看出这个软件最终都是向 cfg80211 也就无线网卡的驱动发送 netlink 消息。<br> 驱动会将消息传递给固件，从而修改无线网卡的工作。</p> 
<p>真正起作用的底层代码：</p> 
<h3><a id="1_551"></a>1、将命令包装成驱动可以识别的数据包</h3> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">Private_IssueCommand</span><span class="token punctuation">(</span>
    PrsNl80211VendorCommandHandle <span class="token operator">*</span>a_handle<span class="token punctuation">,</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> a_vendorId<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> a_subCommand<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>a_pData<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> a_dataLength<span class="token punctuation">,</span>
    SPrsVendorReplyBuffer <span class="token operator">*</span>a_pReplyBuffer
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">nl_msg</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> returnCode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> hdrlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> version <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        msg <span class="token operator">=</span> <span class="token function">nlmsg_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"nlmsg_alloc failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            returnCode <span class="token operator">=</span> <span class="token operator">-</span>NLE_NOMEM<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">genlmsg_put</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> NL_AUTO_PORT<span class="token punctuation">,</span> NL_AUTO_SEQ<span class="token punctuation">,</span> a_handle<span class="token operator">-&gt;</span>nl80211_id<span class="token punctuation">,</span> hdrlen<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> NL80211_CMD_VENDOR<span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"genlmsg_put failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            returnCode <span class="token operator">=</span> <span class="token operator">-</span>NLE_NOMEM<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>returnCode <span class="token operator">=</span> <span class="token function">nla_put_u32</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> NL80211_ATTR_IFINDEX<span class="token punctuation">,</span> a_handle<span class="token operator">-&gt;</span>ifindex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"nla_put_u32 NL80211_ATTR_IFINDEX failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>returnCode <span class="token operator">=</span> <span class="token function">nla_put_u32</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> NL80211_ATTR_VENDOR_ID<span class="token punctuation">,</span> a_vendorId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"nla_put_u32 NL80211_ATTR_VENDOR_ID failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>returnCode <span class="token operator">=</span> <span class="token function">nla_put_u32</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> NL80211_ATTR_VENDOR_SUBCMD<span class="token punctuation">,</span> a_subCommand<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"nla_put_u32 NL80211_ATTR_VENDOR_SUBCMD failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>returnCode <span class="token operator">=</span> <span class="token function">nla_put</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> NL80211_ATTR_VENDOR_DATA<span class="token punctuation">,</span> a_dataLength<span class="token punctuation">,</span> a_pData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"nla_put_u32 NL80211_ATTR_VENDOR_DATA failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        returnCode <span class="token operator">=</span> <span class="token function">Private_SendReceive</span><span class="token punctuation">(</span>a_handle<span class="token operator">-&gt;</span>cb<span class="token punctuation">,</span> a_handle<span class="token operator">-&gt;</span>sk<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> 
            Private_VendorReplyHandler<span class="token punctuation">,</span> a_pReplyBuffer
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">nlmsg_free</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> returnCode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2netlink__611"></a>2、netlink 收发函数</h3> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Private_SendReceive</span><span class="token punctuation">(</span>
    <span class="token keyword">struct</span> <span class="token class-name">nl_cb</span> <span class="token operator">*</span>a_pOriginalCallback<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> <span class="token class-name">nl_sock</span> <span class="token operator">*</span>a_sk<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> <span class="token class-name">nl_msg</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span>
    <span class="token class-name">nl_recvmsg_msg_cb_t</span> a_replyCallback<span class="token punctuation">,</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>a_pReplyCallbackArg
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">nl_cb</span> <span class="token operator">*</span>cb <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> returnCode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span> 
    <span class="token punctuation">{<!-- --></span>
        cb <span class="token operator">=</span> <span class="token function">nl_cb_clone</span><span class="token punctuation">(</span>a_pOriginalCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"nl_cb_clone failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            returnCode <span class="token operator">=</span> <span class="token operator">-</span>NLE_NOMEM<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        returnCode <span class="token operator">=</span> <span class="token function">nl_send_auto_complete</span><span class="token punctuation">(</span>a_sk<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>returnCode <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"nl_send_auto_complete failed with %d\n"</span><span class="token punctuation">,</span> returnCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">nl_cb_err</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> NL_CB_CUSTOM<span class="token punctuation">,</span> Private_ErrorHandler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>returnCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Last message in a series of multi part messages received */</span>
        <span class="token function">nl_cb_set</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> NL_CB_FINISH<span class="token punctuation">,</span> NL_CB_CUSTOM<span class="token punctuation">,</span> Private_FinishHandler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>returnCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Message is an acknowledge */</span>
        <span class="token function">nl_cb_set</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> NL_CB_ACK<span class="token punctuation">,</span>    NL_CB_CUSTOM<span class="token punctuation">,</span> Private_AckHandler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>returnCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Message is valid */</span>
        <span class="token function">nl_cb_set</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> NL_CB_VALID<span class="token punctuation">,</span>  NL_CB_CUSTOM<span class="token punctuation">,</span> a_replyCallback<span class="token punctuation">,</span> a_pReplyCallbackArg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        returnCode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">/* This will be set by the handlers */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>returnCode <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">nl_recvmsgs</span><span class="token punctuation">(</span>a_sk<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"nl_recvmsgs failed with %d\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                returnCode <span class="token operator">=</span> res<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">nl_cb_put</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cb <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> returnCode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_670"></a>3、收到消息时使用供应商专属的解析函数</h3> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">Private_VendorReplyHandler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nl_msg</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">nlattr</span> <span class="token operator">*</span>tb<span class="token punctuation">[</span>NL80211_ATTR_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">nlattr</span> <span class="token operator">*</span>nl_vendor_reply<span class="token punctuation">,</span> <span class="token operator">*</span>nl<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">genlmsghdr</span> <span class="token operator">*</span>gnlh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">genlmsghdr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">nlmsg_data</span><span class="token punctuation">(</span><span class="token function">nlmsg_hdr</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SPrsVendorReplyBuffer <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token punctuation">(</span>SPrsVendorReplyBuffer <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> sc_SuccessCodeBuffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rem<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buf<span class="token punctuation">)</span>
        <span class="token keyword">return</span> NL_SKIP<span class="token punctuation">;</span> <span class="token comment">/* Skip this message. */</span>

    <span class="token comment">// Create attribute index based on a stream of attributes. This will populate</span>
    <span class="token comment">// `tb` by parsing all attributes from `gnlh`.</span>
    <span class="token function">nla_parse</span><span class="token punctuation">(</span>tb<span class="token punctuation">,</span> NL80211_ATTR_MAX<span class="token punctuation">,</span> <span class="token function">genlmsg_attrdata</span><span class="token punctuation">(</span>gnlh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">genlmsg_attrlen</span><span class="token punctuation">(</span>gnlh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nl_vendor_reply <span class="token operator">=</span> tb<span class="token punctuation">[</span>NL80211_ATTR_VENDOR_DATA<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nl_vendor_reply<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"No vendor data found in reply"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> NL_SKIP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">nla_for_each_nested_typecast</span><span class="token punctuation">(</span>nl<span class="token punctuation">,</span> nl_vendor_reply<span class="token punctuation">,</span> rem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">Private_Buffer_Append</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token function">nla_data</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">nla_len</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">nla_len</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> buf<span class="token operator">-&gt;</span>capacity <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">memcmp</span><span class="token punctuation">(</span><span class="token function">nla_data</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">,</span> sc_SuccessCodeBuffer<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// All commands seem to return return a 4 byte response!</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">PRS_ERROR</span><span class="token punctuation">(</span><span class="token string">"buffer_append error: data=0x%p len=%d buffer capacity=%zu size=%zu"</span><span class="token punctuation">,</span>
                    <span class="token function">nla_data</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">nla_len</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">,</span> buf<span class="token operator">-&gt;</span>capacity<span class="token punctuation">,</span> buf<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> NL_SKIP<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> NL_SKIP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/db1480212994895cb1f9010f51105289/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jmeter时间戳</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ca1b54d3ac2411c2dce062a0b437c10c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux之jq命令</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>