<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>vsomeip —— 10分钟快速了解 vsomeip （vsomeip wiki 文档翻译） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="vsomeip —— 10分钟快速了解 vsomeip （vsomeip wiki 文档翻译）" />
<meta property="og:description" content="文档声明：
以下资料均属于本人在学习过程中产出的学习笔记，如果错误或者遗漏之处，请多多指正。并且该文档在后期会随着学习的深入不断补充完善。感谢各位的参考查看。
笔记资料仅供学习交流使用，转载请标明出处，谢谢配合。
如果存在相关知识点的遗漏，可以在评论区留言，看到后将在第一时间更新。
作者：Aliven888
vsomeip in 10 minutes 这篇文章是对 vsomeip 官方 wiki 文档的一个翻译。属于个人学习开发笔记的一个记录。
SOME/IP 简介 SOME/IP 是 Scalable service-Oriented middleware over IP 的缩写。 该中间件专为典型的汽车用例而设计，并与 AUTOSAR 兼容（至少在有线格式级别上）。 可在 SOME/IP 上获得可公开访问的规范。 在这个 wiki 中，我们不想进一步深入探讨另一个中间件规范的原因，而是想对 SOME/IP 规范的基本结构及其开源实现 vsomeip 给出一个粗略的概述，而不要求任何完整性。
让我们从 SOME/IP 规范的三个主要部分开始：
On-wire formatProtocolService Discovery SOME/IP On-Wire Format 原则上，SOME/IP 通信由设备或订阅者之间通过 IP 发送的消息组成。 详见如下图示：
这里你会看到两个设备（A 和 B）； 设备 A 向 B 发送一条 SOME/IP 消息，并收到一条回复消息。
底层传输协议可以是 TCP 或 UDP； 对于消息本身，这没有什么区别。
现在我们假设设备 B 上正在运行一个服务，该服务提供了一个由该消息从设备 A 调用的函数，而返回的消息就是答案。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7d2e55a323ee396d05678b820fcecec6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-11T14:41:50+08:00" />
<meta property="article:modified_time" content="2022-03-11T14:41:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">vsomeip —— 10分钟快速了解 vsomeip （vsomeip wiki 文档翻译）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>文档声明：<br> 以下资料均属于本人在学习过程中产出的学习笔记，如果错误或者遗漏之处，请多多指正。并且该文档在后期会随着学习的深入不断补充完善。感谢各位的参考查看。</p> 
 <hr> 
 <p>笔记资料仅供学习交流使用，转载请标明出处，谢谢配合。<br> 如果存在相关知识点的遗漏，可以在评论区留言，看到后将在第一时间更新。<br> 作者：Aliven888</p> 
</blockquote> 
<h3><a id="vsomeip_in_10_minutes_7"></a>vsomeip in 10 minutes</h3> 
<p>  这篇文章是对 vsomeip 官方 wiki 文档的一个翻译。属于个人学习开发笔记的一个记录。</p> 
<h4><a id="SOMEIP__10"></a>SOME/IP 简介</h4> 
<p>  SOME/IP 是 <code>Scalable service-Oriented middleware over IP</code> 的缩写。 该中间件专为典型的汽车用例而设计，并与 AUTOSAR 兼容（至少在有线格式级别上）。 可在 <a href="http://some-ip.com/" rel="nofollow">SOME/IP</a> 上获得可公开访问的规范。 在这个 wiki 中，我们不想进一步深入探讨另一个中间件规范的原因，而是想对 SOME/IP 规范的基本结构及其开源实现 vsomeip 给出一个粗略的概述，而不要求任何完整性。</p> 
<p>让我们从 SOME/IP 规范的三个主要部分开始：</p> 
<ul><li>On-wire format</li><li>Protocol</li><li>Service Discovery</li></ul> 
<h5><a id="SOMEIP_OnWire_Format_19"></a>SOME/IP On-Wire Format</h5> 
<p>  原则上，SOME/IP 通信由设备或订阅者之间通过 IP 发送的消息组成。 详见如下图示：</p> 
<p><img src="https://images2.imgbox.com/85/c4/9tglE00P_o.jpg" alt="在这里插入图片描述"><br>   这里你会看到两个设备（A 和 B）； 设备 A 向 B 发送一条 SOME/IP 消息，并收到一条回复消息。</p> 
<p>  底层传输协议可以是 TCP 或 UDP； 对于消息本身，这没有什么区别。</p> 
<p> 现在我们假设设备 B 上正在运行一个服务，该服务提供了一个由该消息从设备 A 调用的函数，而返回的消息就是答案。</p> 
<p>  SOME/IP 的消息由两部分组成： <code>header</code> 和 <code>payload</code>。</p> 
<p>  在图片中，您可以看到 <code>header</code> 主要由标识符组成：</p> 
<ul><li>Service ID: unique identifier for each service</li><li>Method ID: 0-32767 for methods, 32768-65535 for events</li><li>Length: length of payload in byte (covers also the next IDs, that means 8 additional bytes)</li><li>Client ID: unique identifier for the calling client inside the ECU; has to be unique in the overall vehicle</li><li>Session ID: identifier for session handling; has to be incremented for each call</li><li>Protocol Version: 0x01</li><li>Interface Version: major version of the service interface</li><li>Message Type:<br> – REQUEST (0x00) A request expecting a response (even void)<br> – REQUEST_NO_RETURN (0x01) A fire&amp;forget request<br> – NOTIFICATION (0x02) A request of a notification/event callback expecting no response<br> – RESPONSE (0x80) The response message</li><li>Return Code:<br> – E_OK (0x00) No error occurred<br> – E_NOT_OK (0x01) An unspecified error occurred<br> – E_WRONG_INTERFACE_VERSION (0x08) Interface version mismatch<br> – E_MALFORMED_MESSAGE (0x09) Deserialization error, so that payload cannot be deseria-lized<br> – E_WRONG_MESSAGE_TYPE (0x0A) An unexpected message type was received (e.g. RE-QUEST_NO_RETURN for a method defined as RE-QUEST)</li></ul> 
<p>  我们可以看到，对于客户端已订阅的事件，正常函数的调用和通知消息都有“请求”和“响应”。 错误报告为正常响应或通知，并且会返回错误代码。</p> 
<p>  payload 包含序列化数据。 如上图示的传输数据结构，只有基本数据类型的嵌套结构下的简单序列化。 在这种情况下，结构元素只是被展平，然后它们被一个接一个地写入 payload 中。</p> 
<h5><a id="SOMEIP_Protocol_58"></a>SOME/IP Protocol</h5> 
<p>  在本节中，主要有两点很重要，现在将对其进行描述：</p> 
<ul><li>传输绑定（UDP 和 TCP）</li><li>基本的通信模式发布/订阅和请求/响应。</li></ul> 
<p>  如上所述，底层传输协议可以是 UDP 或 TCP。 在 UDP 情况下，SOME/IP 消息没有分段； 一个 UDP 数据包中可能包含多条消息，但一条消息的长度不能超过 UDP 数据包的长度（最多 1400 字节）。 更大的消息必须通过 TCP 传输。 在这种情况下，使用了 TCP 的所有健壮性特征。 如果 TCP 流中发生同步错误，SOME/IP 规范允许所谓的 <code>magic cookies</code> 以便再次找到下一条消息的开头。</p> 
<p>  请注意，必须实例化服务接口，并且因为可能存在同一接口的多个实例，所以必须为定义的实例添加一个附加标识符（instance ID）。 但是，instance ID 不是 SOME/IP 消息的标头的一部分。 实例通过传输协议的端口号识别； 这意味着不可能在同一端口上提供同一接口的多个实例。</p> 
<p>现在请看下图，它显示了基本的 SOME/IP 通信模式：</p> 
<p><img src="https://images2.imgbox.com/10/18/ALYNN9BP_o.jpg" alt="在这里插入图片描述"></p> 
<p>  除了用于远程过程调用的标准 <code>请求-响应</code> 机制之外，还有用于事件的 <code>发布-订阅</code> 模式。 请注意，SOME/IP 协议中的事件总是分组在一个事件组中； 因此只能订阅事件组而不是事件本身。</p> 
<p>  SOME/IP 规范也有 <code>fields</code>； 在这种情况下，<code>setter/getter</code> 方法遵循 <code>请求-响应</code> 模式，并且更改的通知消息是事件。 订阅本身是通过 SOME/IP 服务发现完成的。</p> 
<h5><a id="SOMEIP_Service_discovery_77"></a>SOME/IP Service discovery</h5> 
<p>  <code>SOME/IP</code> 服务发现用于定位服务实例并检测服务实例是否正在运行以及实现发布/订阅处理。 这主要是通过所谓的报价消息来完成的； 同时也意味着每个设备都广播（多播）消息，并在广播的消息中包含该设备提供的所有服务信息。</p> 
<p>  <code>SOME/IP</code> SD 消息通过 UDP 发送。</p> 
<p>  如果客户端应用程序需要服务但目前没有提供，那么也可以发送<code>查找消息（find messages）</code>。 其他 <code>SOME/IP</code> SD 消息可用于发布或订阅事件组。</p> 
<p><strong>SOME/IP SD 消息的结构显示如下：</strong></p> 
<p><img src="https://images2.imgbox.com/12/20/uViKNL6R_o.jpg" alt="在这里插入图片描述"></p> 
<p>  这应该足够开始了。 更多细节将在后面的示例中讨论，或者可以在说明书中阅读。</p> 
<h4><a id="vsomeip__91"></a>vsomeip 简述</h4> 
<p>  在我们开始实现介绍示例之前，让我们简要了解一下 <code>SOME/IP</code> 的 <code>GENIVI</code>实现的基本结构，即<code>vsomeip</code>。</p> 
<p><img src="https://images2.imgbox.com/97/de/ha0Cvh8l_o.jpg" alt="在这里插入图片描述"><br>   如图所示，<code>vsomeip</code> 不仅涵盖了设备之间的 <code>SOME/IP</code> 通信（外部通信），还涵盖了内部进程间通信。 两个设备通过所谓的通信端点进行通信，这些端点将使用的传输协议<code>（TCP 或 UDP）</code>及其参数确定为端口号或其他参数。 所有这些参数都是可以在 <code>vsomeip</code> 配置文件中设置的配置参数<code>（json 文件，请参阅 vsomeip 用户指南）</code>。 内部通信是通过本地端点完成的，这些端点由 <code>unix</code> 域套接字使用<code>Boost.Asio</code>库实现。 由于这种内部通信不是通过中央组件（例如，像 D-Bus 守护程序）路由的，因此它非常快。</p> 
<p>  <code>vsomeip</code> 中央路由管理器仅在必须将消息发送到外部设备时才获取消息，并且他分发来自外部的消息。 每台设备只有一个路由管理器； 如果未配置任何内容，则第一个运行的 <code>vsomeip</code> 应用程序也会启动路由管理器。</p> 
<p>  ❗️ <code>vsomeip</code> 没有实现数据结构的序列化！ <code>CommonAPI</code> 的 <code>SOME/IP</code> 绑定涵盖了这一点。<code>vsomeip</code>仅涵盖 <code>SOME/IP</code>协议和服务发现。</p> 
<p>  现在这是对 <code>SOME/IP</code>和 <code>vsomeip</code> 的非常、非常简短的概述。 但是对于第一次开始就足够了； 更多细节在示例中直接解释。</p> 
<h4><a id="Preparation__Prerequisites___103"></a>Preparation / Prerequisites（准备 / 先决条件）</h4> 
<p>  如前所述，<code>vsomeip</code> 需要 <code>Boost.Asio</code> 库，因此请确保您已在系统上安装了 <code>BOOST（至少 1.55 版）</code>。 成功安装 <code>Boost</code> 后，您可以像往常一样轻松构建 <code>vsomeip</code>：</p> 
<pre><code class="prism language-bash">$ <span class="token function">cd</span> vsomeip
<span class="token operator">&lt;</span>.<span class="token operator">&gt;</span>/vsomeip$ <span class="token function">mkdir</span> build
<span class="token operator">&lt;</span>.<span class="token operator">&gt;</span>/vsomeip$ <span class="token function">cd</span> build
<span class="token operator">&lt;</span>.<span class="token operator">&gt;</span>/vsomeip/build$ cmake <span class="token punctuation">..</span>
<span class="token operator">&lt;</span>.<span class="token operator">&gt;</span>/vsomeip/build$ <span class="token function">make</span>
</code></pre> 
<p>This works, but in order to avoid some special problems afterwards I recommend to add at least one parameter to your CMake call:</p> 
<p>  虽然这样就搞定了，但为了避免之后出现一些特殊问题，我建议在您的 CMake 调用中添加至少一个参数：</p> 
<pre><code class="prism language-bash"><span class="token operator">&gt;</span> cmake -DENABLE_SIGNAL_HANDLING<span class="token operator">=</span>1 <span class="token punctuation">..</span>
</code></pre> 
<p>  此参数确保您可以毫无问题地终止您的 vsomeip 应用程序<code>（否则可能是当您使用 Ctrl-C 停止应用程序时，共享内存段 /dev/shm/vsomeip 未正确删除）</code>。</p> 
  
<h4><a id="First_Application_126"></a>First Application（首次申请）</h4> 
<p>  创建第一个 <code>vsomeip</code> 程序，我们称它为 <code>service-example</code>:</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*service-example.cpp*/</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vsomeip/vsomeip.hpp&gt;</span></span>

std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span> vsomeip<span class="token operator">::</span>application <span class="token operator">&gt;</span> app<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    app <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_application</span><span class="token punctuation">(</span><span class="token string">"World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  这很容易：您必须首先创建一个应用程序对象，然后初始化并启动它。 创建 <code>vsomeip</code> 应用程序后必须首先调用 <em>init</em> 方法，并执行以下步骤对其进行初始化：</p> 
<ul><li>Loading the configuration （加载配置）</li><li>Determining routing configuration and initialization of the routing （确定路由配置和路由初始化）</li><li>Installing signal handlers （安装信号处理程序）</li></ul> 
<p>The start method has to be called after <em>init</em> in order to start the message processing. The received messages are processed via sockets and registered callbacks are used to pass them to the user application.</p> 
<p>  为了启动消息处理，必须在 <em>init</em> 之后调用 <code>start</code> 方法。 接收到的消息通过套接字进行处理，并使用注册的回调将它们传递给用户应用程序。</p> 
<p>READY 👍👍👍👍👍👍👍👍👍👍👍👍👍👍👍👍👍👍👍👍</p> 
<p>  为了构建我们的程序，需要创建一个<code>CMake</code> 文件，文件如下：</p> 
<p><em>CMakeLists.txt (Example)</em></p> 
<pre><code class="prism language-cmake">cmake_minimum_required (VERSION 2.8)

set (CMAKE_CXX_FLAGS "-g -std=c++0x")

find_package (vsomeip 2.6.0 REQUIRED)
find_package( Boost 1.55 COMPONENTS system thread log REQUIRED )

include_directories (
    ${Boost_INCLUDE_DIR}
    ${VSOMEIP_INCLUDE_DIRS}
)

add_executable(service-example ../src/service-example.cpp)
target_link_libraries(service-example vsomeip ${Boost_LIBRARIES})
</code></pre> 
<p>  像往常一样继续（创建构建目录，运行 <code>CMake</code> 并构建）。 然后启动它（<code>service-example</code>）。 您应该在控制台上获得以下输出（或类似输出）：</p> 
<pre><code class="prism language-bash">2017-03-20 10:38:20.885390 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Parsed vsomeip configuration <span class="token keyword">in</span> 0ms
2017-03-20 10:38:20.889637 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Default configuration module loaded.
2017-03-20 10:38:20.889797 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Initializing vsomeip application <span class="token string">"World"</span><span class="token keyword">.</span>
2017-03-20 10:38:20.890120 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> SOME/IP client identifier configured. Using 0001 <span class="token punctuation">(</span>was: 0000<span class="token punctuation">)</span>
2017-03-20 10:38:20.890259 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> No routing manager configured. Using auto-configuration.
2017-03-20 10:38:20.890367 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Instantiating routing manager <span class="token punctuation">[</span>Host<span class="token punctuation">]</span>.
2017-03-20 10:38:20.890641 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> init_routing_endpoint Routing endpoint at /tmp/vsomeip-0
2017-03-20 10:38:20.890894 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Client <span class="token punctuation">[</span>1<span class="token punctuation">]</span> is connecting to <span class="token punctuation">[</span>0<span class="token punctuation">]</span> at /tmp/vsomeip-0
2017-03-20 10:38:20.891039 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Service Discovery enabled. Trying to load module.
2017-03-20 10:38:20.891647 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Service Discovery module loaded.
2017-03-20 10:38:20.892045 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Application<span class="token punctuation">(</span>World, 1001<span class="token punctuation">)</span> is initialized <span class="token punctuation">(</span>11, 100<span class="token punctuation">)</span>.
2017-03-20 10:38:20.892210 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Starting vsomeip application <span class="token string">"World"</span> using 2 threads
2017-03-20 10:38:20.892668 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Watchdog is disabled<span class="token operator">!</span>
2017-03-20 10:38:20.893312 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Network interface <span class="token string">"lo"</span> is up and running.
2017-03-20 10:38:20.898471 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> vSomeIP 2.6.2
2017-03-20 10:38:20.898708 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Sent READY to systemd watchdog
2017-03-20 10:38:20.898854 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> SOME/IP routing ready.
</code></pre> 
<p><strong>请注意：</strong></p> 
<ul><li>这些步骤对于服务和客户端是相同的； 没有区别。 它只是一个 <code>vsomeip</code> 应用程序。</li><li>到目前为止，您不需要任何配置文件。</li></ul> 
<p><strong>让我们详细讨论一些要点：</strong></p> 
<ul><li> <p>首先你看到已经加载的配置；您没有配置，因此使用默认值。</p> </li><li> <p>您没有为您的应用程序配置客户端 ID；因此，<code>vsomeip</code> 功能（自动配置）会找到适当的<code>client ID</code>。第一个数字是 <code>0x0001</code>。</p> </li><li> <p>路由管理器也没有配置；因此，路由管理器会随着系统中的第一个 <code>vsomeip</code> 应用程序自动启动，这就是 <code>service-example</code>。</p> </li><li> <p>默认情况下启用服务发现，没有静态路由。这将需要一些配置参数。</p> </li><li> <p>最后一个 <code>init()</code> 输出是 <code>Application(World, 1) is initialized (11, 100)</code>。最后的两个数字意味着如果回调阻塞超过 100 毫秒，则 <code>vsomeip</code> 使用的最大调度程序数量为 <code>11</code>。可以配置这些参数。</p> </li><li> <p>默认创建两个线程来接收 <code>SOME/IP</code> 消息；这允许 <code>vsomeip</code> 并行处理长消息。</p> </li><li> <p>然后您会看到当前的 <code>vsomeip</code> 版本，并且 <code>SOME/IP</code> 路由已准备就绪。</p> </li></ul> 
<h4><a id="_223"></a>可用性</h4> 
<p>  到目前为止，该应用程序并没有做太多工作 😃 客户端和服务之间也没有区别。 现在让我们假设我们的 <code>service-example</code> 是服务，并且我们想要编写一个想要使用该服务的客户端。 第一步，我们必须触发应用程序提供服务实例。 这可以通过在我们的第一个示例中添加<code>offer_service</code>命令来完成：</p> 
<p><em>service-example.cpp with offer</em></p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vsomeip/vsomeip.hpp&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_SERVICE_ID 0x1234</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_INSTANCE_ID 0x5678</span>

std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span> vsomeip<span class="token operator">::</span>application <span class="token operator">&gt;</span> app<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    app <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_application</span><span class="token punctuation">(</span><span class="token string">"World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">offer_service</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  在下一步中，我们编写一个应用程序来检查正在运行的 <em>“World”</em> 应用程序是否可用。 考虑下面的 <code>client-example</code> 代码，它创建了一个名为 <code>Hello</code> 的应用程序：</p> 
<p><em>client-example.cpp</em></p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iomanip&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vsomeip/vsomeip.hpp&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_SERVICE_ID 0x1234</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_INSTANCE_ID 0x5678</span>

std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span> vsomeip<span class="token operator">::</span>application <span class="token operator">&gt;</span> app<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">on_availability</span><span class="token punctuation">(</span>vsomeip<span class="token operator">::</span>service_t _service<span class="token punctuation">,</span> vsomeip<span class="token operator">::</span>instance_t _instance<span class="token punctuation">,</span> <span class="token keyword">bool</span> _is_available<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Service ["</span>
            <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex <span class="token operator">&lt;&lt;</span> _service <span class="token operator">&lt;&lt;</span> <span class="token string">"."</span> <span class="token operator">&lt;&lt;</span> _instance
            <span class="token operator">&lt;&lt;</span> <span class="token string">"] is "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>_is_available <span class="token operator">?</span> <span class="token string">"available."</span> <span class="token operator">:</span> <span class="token string">"NOT available."</span><span class="token punctuation">)</span>  <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    app <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_application</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">register_availability_handler</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">,</span> on_availability<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">request_service</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  为了使其尽可能简单，我们省略了所有可能的检查，例如注册是否成功。 作为客户端，您必须告诉 <code>vsomeip</code> 您想要使用该服务，并且您需要注册一个回调以便在该服务可用时获得呼叫。 客户端输出现在应该类如下：</p> 
<pre><code class="prism language-bash">Service <span class="token punctuation">[</span>1234.5678<span class="token punctuation">]</span> is NOT available.
2017-03-21 04:14:37.720313 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> REQUEST<span class="token punctuation">(</span>0002<span class="token punctuation">)</span>: <span class="token punctuation">[</span>1234.5678:255.4294967295<span class="token punctuation">]</span>
Service <span class="token punctuation">[</span>1234.5678<span class="token punctuation">]</span> is available.
</code></pre> 
<p>  当 <code>app-&gt;start()</code> 启动 <code>vsomeip</code> 事件循环时，将调用可用性回调 <code>(on_availability(...) 函数)</code>。</p> 
<p><strong>在服务端打印如下语句（log）</strong></p> 
<pre><code class="prism language-bash">2017-03-21 04:14:33.850964 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> OFFER<span class="token punctuation">(</span>0001<span class="token punctuation">)</span>: <span class="token punctuation">[</span>1234.5678:0.0<span class="token punctuation">]</span>
</code></pre> 
  
<h4><a id="___291"></a>请求 / 响应</h4> 
<p> 从一个常见的 <code>vsomeip</code> 应用程序开始，我们创建了一个服务，它提供了一个服务接口的实例和一个想要使用这个接口的客户端。 下一步现在是在服务端实现一个可由客户端调用的功能。</p> 
<p>  服务示例必须准备好接收消息； 这可以通过注册消息处理程序来完成。 请看下面的代码：</p> 
<p><em>service-example.cpp with offer and message handler</em></p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iomanip&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vsomeip/vsomeip.hpp&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_SERVICE_ID 0x1234</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_INSTANCE_ID 0x5678</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_METHOD_ID 0x0421</span>

std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>application<span class="token operator">&gt;</span> app<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">on_message</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>message<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>_request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>payload<span class="token operator">&gt;</span> its_payload <span class="token operator">=</span> _request<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vsomeip<span class="token operator">::</span>length_t l <span class="token operator">=</span> its_payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get payload</span>
    std<span class="token operator">::</span>stringstream ss<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>vsomeip<span class="token operator">::</span>length_t i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       ss <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex
          <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>its_payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"SERVICE: Received message with Client/Session ["</span>
        <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex <span class="token operator">&lt;&lt;</span> _request<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"/"</span>
        <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex <span class="token operator">&lt;&lt;</span> _request<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
        <span class="token operator">&lt;&lt;</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">// Create response</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>message<span class="token operator">&gt;</span> its_response <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_response</span><span class="token punctuation">(</span>_request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    its_payload <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>byte_t<span class="token operator">&gt;</span> its_payload_data<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        its_payload_data<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    its_payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_data</span><span class="token punctuation">(</span>its_payload_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    its_response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_payload</span><span class="token punctuation">(</span>its_payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">send</span><span class="token punctuation">(</span>its_response<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

   app <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_application</span><span class="token punctuation">(</span><span class="token string">"World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">register_message_handler</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">,</span> SAMPLE_METHOD_ID<span class="token punctuation">,</span> on_message<span class="token punctuation">)</span><span class="token punctuation">;</span>
   app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">offer_service</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
   app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>在客户端，它有点复杂：</strong></p> 
<p><em>client-example.cpp with message handler and send function</em></p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iomanip&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vsomeip/vsomeip.hpp&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_SERVICE_ID 0x1234</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_INSTANCE_ID 0x5678</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SAMPLE_METHOD_ID 0x0421</span>

std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span> vsomeip<span class="token operator">::</span>application <span class="token operator">&gt;</span> app<span class="token punctuation">;</span>
std<span class="token operator">::</span>mutex mutex<span class="token punctuation">;</span>
std<span class="token operator">::</span>condition_variable condition<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">its_lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  condition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>its_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span> vsomeip<span class="token operator">::</span>message <span class="token operator">&gt;</span> request<span class="token punctuation">;</span>
  request <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_service</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  request<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_instance</span><span class="token punctuation">(</span>SAMPLE_INSTANCE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  request<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_method</span><span class="token punctuation">(</span>SAMPLE_METHOD_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span> vsomeip<span class="token operator">::</span>payload <span class="token operator">&gt;</span> its_payload <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span> vsomeip<span class="token operator">::</span>byte_t <span class="token operator">&gt;</span> its_payload_data<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>vsomeip<span class="token operator">::</span>byte_t i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      its_payload_data<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  its_payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_data</span><span class="token punctuation">(</span>its_payload_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  request<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_payload</span><span class="token punctuation">(</span>its_payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">send</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">on_message</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>message<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>_response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>payload<span class="token operator">&gt;</span> its_payload <span class="token operator">=</span> _response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vsomeip<span class="token operator">::</span>length_t l <span class="token operator">=</span> its_payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Get payload</span>
  std<span class="token operator">::</span>stringstream ss<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>vsomeip<span class="token operator">::</span>length_t i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     ss <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex
        <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>its_payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"CLIENT: Received message with Client/Session ["</span>
      <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex <span class="token operator">&lt;&lt;</span> _response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"/"</span>
      <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex <span class="token operator">&lt;&lt;</span> _response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
      <span class="token operator">&lt;&lt;</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">on_availability</span><span class="token punctuation">(</span>vsomeip<span class="token operator">::</span>service_t _service<span class="token punctuation">,</span> vsomeip<span class="token operator">::</span>instance_t _instance<span class="token punctuation">,</span> <span class="token keyword">bool</span> _is_available<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"CLIENT: Service ["</span>
            <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex <span class="token operator">&lt;&lt;</span> _service <span class="token operator">&lt;&lt;</span> <span class="token string">"."</span> <span class="token operator">&lt;&lt;</span> _instance
            <span class="token operator">&lt;&lt;</span> <span class="token string">"] is "</span>
            <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>_is_available <span class="token operator">?</span> <span class="token string">"available."</span> <span class="token operator">:</span> <span class="token string">"NOT available."</span><span class="token punctuation">)</span>
            <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    condition<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    app <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_application</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">register_availability_handler</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">,</span> on_availability<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">request_service</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">register_message_handler</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">,</span> SAMPLE_METHOD_ID<span class="token punctuation">,</span> on_message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>thread <span class="token function">sender</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  就像在服务端一样，我们需要注册一个消息处理程序来接收我们调用的响应。 原则上，创建发送消息 (<code>request</code>) 非常容易。 只需通过调用 <code>create_request()</code> 获取请求对象，设置服务 ID、实例 ID 和方法 ID，最后使用您的序列化数据写入 <code>payload</code>。 在此处的示例中，我们将 0 到 9 的值写入有效负载 (<code>std::vector&lt; vsomeip::byte_t &gt;</code>)。</p> 
<p>  当我们尝试将我们的请求从客户端发送到服务时，我们遇到了一个小问题。 在我们发送消息之前，必须启动应用程序（<code>app-&gt;start()</code>），因为我们需要一个正在运行的事件循环来处理消息。 但是 <code>app-&gt;start()</code> 方法不会返回，因为它内部有正在运行的事件循环。 因此，我们启动一个线程 (<code>run</code>) 并在此线程中等待可用性回调的返回，然后再调用 <code>app-&gt;send(request, true)</code>。</p> 
<p>现在我们应该得到输出（首先启动服务端）：</p> 
<pre><code class="prism language-bash">2017-03-21 08:08:08.033710 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> REQUEST<span class="token punctuation">(</span>1002<span class="token punctuation">)</span>: <span class="token punctuation">[</span>1234.5678:255.4294967295<span class="token punctuation">]</span>
CLIENT: Service <span class="token punctuation">[</span>1234.5678<span class="token punctuation">]</span> is available.
2017-03-21 08:08:08.034182 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> Client <span class="token punctuation">[</span>1002<span class="token punctuation">]</span> is connecting to <span class="token punctuation">[</span>1001<span class="token punctuation">]</span> at /tmp/vsomeip-1001
SERVICE: Received message with Client/Session <span class="token punctuation">[</span>1002/0001<span class="token punctuation">]</span> 00 01 02 03 04 05 06 07 08 09 
CLIENT: Received message with Client/Session <span class="token punctuation">[</span>1002/0001<span class="token punctuation">]</span> 09 08 07 06 05 04 03 02 01 00 
</code></pre> 
  
<h4><a id="___444"></a>订阅 / 通知</h4> 
<p>  到目前为止，我们已经创建了一个实现方法的服务和调用该方法的客户端。 但这并不是所有可能的☀️。 <code>SOME/IP</code> 规范还描述了事件处理。 这意味着应用程序可以发送订阅者可以订阅的事件，如果他们感兴趣的话。 连同 <code>setter</code> 和 <code>getter</code> 方法的定义，可以实现提供属性的服务。</p> 
<p>  为了使它不太复杂，我们在示例中删除了方法调用的实现并实现了事件处理。 首先让我们看一下服务。</p> 
<p>  请在您的主要功能中添加以下几行：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">const</span> vsomeip<span class="token operator">::</span>byte_t its_data<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0x10</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
payload <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">set_data</span><span class="token punctuation">(</span>its_data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>its_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

std<span class="token operator">::</span>set<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>eventgroup_t<span class="token operator">&gt;</span> its_groups<span class="token punctuation">;</span>
its_groups<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>SAMPLE_EVENTGROUP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">offer_event</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">,</span> SAMPLE_EVENT_ID<span class="token punctuation">,</span> its_groups<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">notify</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">,</span> SAMPLE_EVENT_ID<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>❗️ <strong>请注意：</strong></p> 
<ul><li> <p>您必须提供活动才能向世界其他地方宣布此活动的存在<code>（You must offer the event in order to announce the existence of this event to the rest of the world）</code>。</p> </li><li> <p>使用通知方法，您可以将事件发送给任何订阅的人。</p> </li><li> <p>每个事件都属于一个事件组！ 但它也可以属于多个事件组。</p> </li><li> <p>事件不独立于服务而存在； 如果该服务尚未提供，则该服务对客户端不可用且客户端无法订阅。</p> </li></ul> 
<p>在客户端实现以下内容（为了更好地理解，我省略了之前讨论过的所有内容）：</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">its_lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  condition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>its_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>set<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>eventgroup_t<span class="token operator">&gt;</span> its_groups<span class="token punctuation">;</span>
  its_groups<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>SAMPLE_EVENTGROUP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">request_event</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">,</span> SAMPLE_EVENT_ID<span class="token punctuation">,</span> its_groups<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">subscribe</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">,</span> SAMPLE_EVENTGROUP_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">on_message</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>message<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>_response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span>stringstream its_message<span class="token punctuation">;</span>
    its_message <span class="token operator">&lt;&lt;</span> <span class="token string">"CLIENT: received a notification for event ["</span>
            <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex
            <span class="token operator">&lt;&lt;</span> _response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"."</span>
            <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex
            <span class="token operator">&lt;&lt;</span> _response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"."</span>
            <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex
            <span class="token operator">&lt;&lt;</span> _response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"] to Client/Session ["</span>
            <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex
            <span class="token operator">&lt;&lt;</span> _response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"/"</span>
            <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex
            <span class="token operator">&lt;&lt;</span> _response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">&lt;&lt;</span> <span class="token string">"] = "</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>vsomeip<span class="token operator">::</span>payload<span class="token operator">&gt;</span> its_payload <span class="token operator">=</span> _response<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    its_message <span class="token operator">&lt;&lt;</span> <span class="token string">"("</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>dec <span class="token operator">&lt;&lt;</span> its_payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">") "</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> its_payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        its_message <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>hex <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setfill</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>
            <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> its_payload<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> its_message<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    app <span class="token operator">=</span> vsomeip<span class="token operator">::</span>runtime<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create_application</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">register_availability_handler</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">,</span> on_availability<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">request_service</span><span class="token punctuation">(</span>SAMPLE_SERVICE_ID<span class="token punctuation">,</span> SAMPLE_INSTANCE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">register_message_handler</span><span class="token punctuation">(</span>vsomeip<span class="token operator">::</span>ANY_SERVICE<span class="token punctuation">,</span> vsomeip<span class="token operator">::</span>ANY_INSTANCE<span class="token punctuation">,</span> vsomeip<span class="token operator">::</span>ANY_METHOD<span class="token punctuation">,</span> on_message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token operator">::</span>thread <span class="token function">sender</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>按照如下步骤，你会发现该功能实现起来会很简单：</p> 
<ul><li>您再次需要事件组来订阅该事件。</li><li>您必须先请求活动，然后才能订阅。</li><li>接收事件只需注册一个标准消息处理程序； 在这种情况下，您可以使用非常方便的通配符。</li></ul> 
<p>在控制台中，你将要看到以下几行日志：</p> 
<pre><code class="prism language-bash">2017-04-06 03:47:46.424942 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> REGISTER EVENT<span class="token punctuation">(</span>0001<span class="token punctuation">)</span>: <span class="token punctuation">[</span>1234.5678.8778:is_provider<span class="token operator">=</span>true<span class="token punctuation">]</span>
2017-04-06 03:47:51.851654 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> REGISTER EVENT<span class="token punctuation">(</span>0002<span class="token punctuation">)</span>: <span class="token punctuation">[</span>1234.5678.8778:is_provider<span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token punctuation">..</span>.
2017-04-06 03:47:51.856821 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> SUBSCRIBE<span class="token punctuation">(</span>0002<span class="token punctuation">)</span>: <span class="token punctuation">[</span>1234.5678.4465:ffff:0<span class="token punctuation">]</span>
2017-04-06 03:47:51.861330 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> SUBSCRIBE ACK<span class="token punctuation">(</span>0001<span class="token punctuation">)</span>: <span class="token punctuation">[</span>1234.5678.4465.ffff<span class="token punctuation">]</span>
</code></pre> 
<p>The numbers in the round brackets are again the client IDs; I started the service first, therfore the service has got from the autoconfiguration the number 1 and the client the number 2.</p> 
<p>  圆括号中的数字也是客户端 ID； 我首先启动了服务，因此服务从自动配置中获得了数字 <code>0001</code>，客户端获得了数字 <code>0002</code>。</p> 
  
<h4><a id="_548"></a>两个设备之间的通信</h4> 
<p>  <code>SOME/IP</code> 不是为一个设备内的进程间通信而发明的（例如，作为 D-Bus），而是为几个设备之间基于 IP 的通信而发明的。 如果您想使用迄今为止为两个设备之间的通信开发的示例，则无需更改 C++ 代码，但是你必须编写 <code>vsomeip</code> 配置文件。 有关详细信息，请查看 <code>vsomeip</code> 用户指南； 在这里，我们只讨论如何让你的系统程序运行的起来。</p> 
<p>I will first lose some introductory words about the vsoemip configuration generally.</p> 
<p>  我将首先失去一些关于 vsoemip 配置的介绍性文字。</p> 
<ul><li> <p>堆栈由一个或多个json格式的文件配置 <code>The stack is configured by one or more files in json format（http://www.json.org/）</code>。</p> </li><li> <p>json 文件的标准文件夹是<code>/etc/vsomeip</code>。</p> </li><li> <p>也可以通过设置环境变量<code>VSOMEIP_CONFIGURATION</code>来更改此文件夹或定义单个配置文件。</p> </li><li> <p>也可以将配置文件复制到包含可执行应用程序的文件夹（本地配置）。</p> </li></ul> 
<p>对于以下配置示例，我假设服务在地址为<code>172.17.0.2</code>的设备上运行，客户端的地址为<code>172.17.0.1</code>。</p> 
<p>首先让我们看一个服务配置的例子：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"unicast"</span> <span class="token punctuation">:</span> <span class="token string">"172.17.0.2"</span><span class="token punctuation">,</span>
    <span class="token string">"logging"</span> <span class="token punctuation">:</span>
    <span class="token punctuation">{<!-- --></span> 
        <span class="token string">"level"</span> <span class="token punctuation">:</span> <span class="token string">"debug"</span><span class="token punctuation">,</span>
        <span class="token string">"console"</span> <span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token string">"file"</span> <span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"enable"</span> <span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span> <span class="token string">"path"</span> <span class="token punctuation">:</span> <span class="token string">"/tmp/vsomeip.log"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"dlt"</span> <span class="token punctuation">:</span> <span class="token string">"false"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"applications"</span> <span class="token punctuation">:</span> 
    <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span> <span class="token punctuation">:</span> <span class="token string">"World"</span><span class="token punctuation">,</span>
            <span class="token string">"id"</span> <span class="token punctuation">:</span> <span class="token string">"0x1212"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"services"</span> <span class="token punctuation">:</span>
    <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"service"</span> <span class="token punctuation">:</span> <span class="token string">"0x1234"</span><span class="token punctuation">,</span>
            <span class="token string">"instance"</span> <span class="token punctuation">:</span> <span class="token string">"0x5678"</span><span class="token punctuation">,</span>
            <span class="token string">"unreliable"</span> <span class="token punctuation">:</span> <span class="token string">"30509"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"routing"</span> <span class="token punctuation">:</span> <span class="token string">"World"</span><span class="token punctuation">,</span>
    <span class="token string">"service-discovery"</span> <span class="token punctuation">:</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"enable"</span> <span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token string">"multicast"</span> <span class="token punctuation">:</span> <span class="token string">"224.224.224.245"</span><span class="token punctuation">,</span>
        <span class="token string">"port"</span> <span class="token punctuation">:</span> <span class="token string">"30490"</span><span class="token punctuation">,</span>
        <span class="token string">"protocol"</span> <span class="token punctuation">:</span> <span class="token string">"udp"</span><span class="token punctuation">,</span>
        <span class="token string">"initial_delay_min"</span> <span class="token punctuation">:</span> <span class="token string">"10"</span><span class="token punctuation">,</span>
        <span class="token string">"initial_delay_max"</span> <span class="token punctuation">:</span> <span class="token string">"100"</span><span class="token punctuation">,</span>
        <span class="token string">"repetitions_base_delay"</span> <span class="token punctuation">:</span> <span class="token string">"200"</span><span class="token punctuation">,</span>
        <span class="token string">"repetitions_max"</span> <span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
        <span class="token string">"ttl"</span> <span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
        <span class="token string">"cyclic_offer_delay"</span> <span class="token punctuation">:</span> <span class="token string">"2000"</span><span class="token punctuation">,</span>
        <span class="token string">"request_response_delay"</span> <span class="token punctuation">:</span> <span class="token string">"1500"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  对于通过 IP 进行的通信，单播地址是强制性的。 让我们讨论其他条目：</p> 
<ul><li> <p><em>logging</em>：这些设置是可选的；设置 “console”=true 以查看控制台上的日志消息。</p> </li><li> <p><em>applications</em>：您可以为每个应用程序（您通过<code>create_application(&lt;name&gt;)</code> 创建它）定义一个固定的 <code>client ID</code>，而不是让它由自动配置确定。这将帮助您稍后在跟踪中识别您的应用程序。 <strong>此处必须设置<code>client ID</code>，因为 <code>client ID</code> 在您的网络中必须是唯一的。</strong> 如果您不设置 <code>client ID</code> ，自动配置将在每个设备上计算 <code>client ID</code> + 1，并且无法进行通信。</p> </li><li> <p><em>services</em>：对于每个服务实例，必须定义它可以通过哪个端口到达。如果端口为“不可靠”，则为 UDP 端口，如果为“可靠”，则 TCP 将是传输层。</p> </li><li> <p><em>routing</em>：每个设备只有一个路由管理器。此路由管理器将附加到第一个启动的 vsomeip 应用程序或此处定义的应用程序。</p> </li><li> <p><em>service-discovery</em>：所有这些参数只有在启用服务发现时才有意义。在这种情况下，强制参数是用于发送服务发现消息的多播地址以及端口和协议。其他参数确定发送报价消息的频率、延迟等。请查看用户指南或 SOME/IP 规范。</p> </li></ul> 
<p>❗️ 确保您的设备已配置为接收多播消息（例如，通过 <code>route add -nv 224.224.224.245 dev eth0</code> 或类似方法；这取决于您的以太网设备的名称）。</p> 
<p>考虑客户端的以下配置：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"unicast"</span> <span class="token punctuation">:</span> <span class="token string">"172.17.0.1"</span><span class="token punctuation">,</span>
    <span class="token string">"logging"</span> <span class="token punctuation">:</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"level"</span> <span class="token punctuation">:</span> <span class="token string">"debug"</span><span class="token punctuation">,</span>
        <span class="token string">"console"</span> <span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token string">"file"</span> <span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"enable"</span> <span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span> <span class="token string">"path"</span> <span class="token punctuation">:</span> <span class="token string">"/var/log/vsomeip.log"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"dlt"</span> <span class="token punctuation">:</span> <span class="token string">"false"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"applications"</span> <span class="token punctuation">:</span> 
    <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span> <span class="token punctuation">:</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span>
            <span class="token string">"id"</span> <span class="token punctuation">:</span> <span class="token string">"0x1313"</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"routing"</span> <span class="token punctuation">:</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span>
    <span class="token string">"service-discovery"</span> <span class="token punctuation">:</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"enable"</span> <span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token string">"multicast"</span> <span class="token punctuation">:</span> <span class="token string">"224.224.224.245"</span><span class="token punctuation">,</span>
        <span class="token string">"port"</span> <span class="token punctuation">:</span> <span class="token string">"30490"</span><span class="token punctuation">,</span>
        <span class="token string">"protocol"</span> <span class="token punctuation">:</span> <span class="token string">"udp"</span><span class="token punctuation">,</span>
        <span class="token string">"initial_delay_min"</span> <span class="token punctuation">:</span> <span class="token string">"10"</span><span class="token punctuation">,</span>
        <span class="token string">"initial_delay_max"</span> <span class="token punctuation">:</span> <span class="token string">"100"</span><span class="token punctuation">,</span>
        <span class="token string">"repetitions_base_delay"</span> <span class="token punctuation">:</span> <span class="token string">"200"</span><span class="token punctuation">,</span>
        <span class="token string">"repetitions_max"</span> <span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
        <span class="token string">"ttl"</span> <span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
        <span class="token string">"cyclic_offer_delay"</span> <span class="token punctuation">:</span> <span class="token string">"2000"</span><span class="token punctuation">,</span>
        <span class="token string">"request_response_delay"</span> <span class="token punctuation">:</span> <span class="token string">"1500"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于客户端不提供服务，因此不需要“服务”设置。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9a647683f9ed739a559752213964eaf5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">反向输入数字C语言（基础题训练）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/03eb9657ebb9c8035692152121739b05/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于Autosar Can driver的理解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>