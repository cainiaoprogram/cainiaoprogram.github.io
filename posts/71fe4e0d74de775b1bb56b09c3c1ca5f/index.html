<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SPI驱动理论与实例分析2 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SPI驱动理论与实例分析2" />
<meta property="og:description" content="文章目录 前言一、idt8v97003（无线收发器）原理图设备树数据手册整理数据手册编写驱动数据结构读写函数完成驱动结构体驱动出入口 二、Admv1139（ADC）原理图设备树数据手册驱动编写寄存器设置SPI 传输函数注册驱动驱动出入口 前言 DEBUG 用的一些宏：
//将一字节十进制数字转换成二进制 debug用，一般用于查看寄存器每个位的数值 #define PRINTF_BINARY_PATTERN_INT8 &#34;%c %c %c %c %c %c %c %c&#34; #define PRINTF_BYTE_TO_BINARY_INT8(i) \ (((i) &amp; 0x80ll) ? &#39;1&#39; : &#39;0&#39;), \ (((i) &amp; 0x40ll) ? &#39;1&#39; : &#39;0&#39;), \ (((i) &amp; 0x20ll) ? &#39;1&#39; : &#39;0&#39;), \ (((i) &amp; 0x10ll) ? &#39;1&#39; : &#39;0&#39;), \ (((i) &amp; 0x08ll) ? &#39;1&#39; : &#39;0&#39;), \ (((i) &amp; 0x04ll) ? &#39;1&#39; : &#39;0&#39;), \ (((i) &amp; 0x02ll) ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/71fe4e0d74de775b1bb56b09c3c1ca5f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-18T18:03:25+08:00" />
<meta property="article:modified_time" content="2023-09-18T18:03:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SPI驱动理论与实例分析2</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_4" rel="nofollow">前言</a></li><li><a href="#idt8v97003_136" rel="nofollow">一、idt8v97003（无线收发器）</a></li><li><ul><li><a href="#_138" rel="nofollow">原理图</a></li><li><a href="#_142" rel="nofollow">设备树</a></li><li><a href="#_157" rel="nofollow">数据手册</a></li><li><a href="#_202" rel="nofollow">整理数据手册</a></li><li><a href="#_405" rel="nofollow">编写驱动</a></li><li><ul><li><a href="#_406" rel="nofollow">数据结构</a></li><li><a href="#_437" rel="nofollow">读写函数</a></li><li><a href="#_487" rel="nofollow">完成驱动结构体</a></li><li><a href="#_538" rel="nofollow">驱动出入口</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Admv1139ADC_606" rel="nofollow">二、Admv1139（ADC）</a></li><li><ul><li><a href="#_607" rel="nofollow">原理图</a></li><li><a href="#_609" rel="nofollow">设备树</a></li><li><a href="#_627" rel="nofollow">数据手册</a></li><li><a href="#_638" rel="nofollow">驱动编写</a></li><li><ul><li><a href="#_639" rel="nofollow">寄存器设置</a></li><li><a href="#SPI__801" rel="nofollow">SPI 传输函数</a></li><li><a href="#_882" rel="nofollow">注册驱动</a></li><li><a href="#_916" rel="nofollow">驱动出入口</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_4"></a>前言</h2> 
<p>DEBUG 用的一些宏：</p> 
<pre><code class="prism language-c"><span class="token comment">//将一字节十进制数字转换成二进制 debug用，一般用于查看寄存器每个位的数值</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PRINTF_BINARY_PATTERN_INT8</span> <span class="token string">"%c %c %c %c %c %c %c %c"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">)</span>    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x80ll</span><span class="token punctuation">)</span> <span class="token operator">?</span> </span><span class="token char">'1'</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token char">'0'</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x40ll</span><span class="token punctuation">)</span> <span class="token operator">?</span> </span><span class="token char">'1'</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token char">'0'</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x20ll</span><span class="token punctuation">)</span> <span class="token operator">?</span> </span><span class="token char">'1'</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token char">'0'</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x10ll</span><span class="token punctuation">)</span> <span class="token operator">?</span> </span><span class="token char">'1'</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token char">'0'</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x08ll</span><span class="token punctuation">)</span> <span class="token operator">?</span> </span><span class="token char">'1'</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token char">'0'</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x04ll</span><span class="token punctuation">)</span> <span class="token operator">?</span> </span><span class="token char">'1'</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token char">'0'</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x02ll</span><span class="token punctuation">)</span> <span class="token operator">?</span> </span><span class="token char">'1'</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token char">'0'</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01ll</span><span class="token punctuation">)</span> <span class="token operator">?</span> </span><span class="token char">'1'</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token char">'0'</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PRINTF_BINARY_PATTERN_INT16</span> <span class="token punctuation">\</span>
    <span class="token expression">PRINTF_BINARY_PATTERN_INT8</span><span class="token string">" "</span><span class="token expression">PRINTF_BINARY_PATTERN_INT8</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PRINTF_BYTE_TO_BINARY_INT16</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PRINTF_BINARY_PATTERN_INT32</span> <span class="token punctuation">\</span>
    <span class="token expression">PRINTF_BINARY_PATTERN_INT16</span><span class="token string">" "</span><span class="token expression">PRINTF_BINARY_PATTERN_INT16</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PRINTF_BYTE_TO_BINARY_INT32</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">PRINTF_BYTE_TO_BINARY_INT16</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PRINTF_BYTE_TO_BINARY_INT16</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PRINTF_BINARY_PATTERN_INT64</span>    <span class="token punctuation">\</span>
    <span class="token expression">PRINTF_BINARY_PATTERN_INT32</span><span class="token string">" "</span><span class="token expression">PRINTF_BINARY_PATTERN_INT32</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PRINTF_BYTE_TO_BINARY_INT64</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">PRINTF_BYTE_TO_BINARY_INT32</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PRINTF_BYTE_TO_BINARY_INT32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span></span></span>
</code></pre> 
<p>其实驱动难的真不是软件，而是硬件，特别是当数据手册又臭又长的时候，高通的数据手册会加倍臭长，特别是把寄存器设置给分散得很凌乱的时候……就怕设置少了器件埋下了惊天大雷好吧。<br> 毕竟数据手册又不是只给程序员看的，设备特性才是人家的卖点。<br> 我们要提炼出使用方法，也就是接线和协议，包括协议中的交互规则。</p> 
<p>先声明一下，本人真的是很讨厌高通的驱动框架，非常的复杂。<br> 高通的官方 spi 驱动：kernel/drivers/spispi-qup.c<br> 但是一些操作还是可以拿出来说说的。<br> 例如：驱动入口函数</p> 
<pre><code class="prism language-c"><span class="token class-name">int32_t</span> <span class="token function">QUP_Init</span><span class="token punctuation">(</span>T_LcmConfig <span class="token operator">*</span>pCfg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_QUP <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>qupDev<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">QUP_InitConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"qup config init fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pDev<span class="token operator">-&gt;</span>pBuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T_QUP<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>pBuf <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"kmalloc fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">spi_register_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qup_SpiDrv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>ucSpiFlag<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"register spi driver fail, please check qup kernel support.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Mutex_CreateHdl</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tMutex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"Mutex_CreateHdl fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> Create_Mutex_Fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">QUP_Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">QUP_Setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"qup init success.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

Create_Mutex_Fail<span class="token operator">:</span>
    <span class="token function">spi_unregister_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qup_SpiDrv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">qup_InitConfig</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_QUP <span class="token operator">*</span>pDev   <span class="token operator">=</span> <span class="token operator">&amp;</span>qupDev<span class="token punctuation">;</span>
    <span class="token comment">//配置设备管脚</span>
    pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCs     <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">//配置的管脚初始化</span>
    <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>之前我们都是把管脚初始化放在 probe 函数的，这里放在驱动入口函数也没问题，只要使用到硬件之前有初始化的就可以了。<br> 而且之前获取 CS 管脚是通过 sysfs 文件系统获取的，而 sysfs 文件系统中的 spi 节点的 CS 属性也是通过设备树写的，这里是竟然是直接写编号！！！<br> 再来看 probe 函数（节省）：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">QUP_SpiProbe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>pSpiDev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_QUPDev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>qupDev<span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span> iRet<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"probe spi device '%s' success and infomation as follows: \n"</span><span class="token punctuation">,</span> 
                pSpiDev<span class="token operator">-&gt;</span>modalias<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"max_speed_hz = %d, chip_select=%d, mode=0x%x, bits_per_word=%d"</span><span class="token punctuation">,</span> 
                pSpiDev<span class="token operator">-&gt;</span>max_speed_hz<span class="token punctuation">,</span> pSpiDev<span class="token operator">-&gt;</span>chip_select<span class="token punctuation">,</span> 
                pSpiDev<span class="token operator">-&gt;</span>mode<span class="token punctuation">,</span> pSpiDev<span class="token operator">-&gt;</span>bits_per_word<span class="token punctuation">)</span><span class="token punctuation">;</span>

    pSpiDev<span class="token operator">-&gt;</span>max_speed_hz <span class="token operator">=</span> pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiRate<span class="token punctuation">;</span>
    pSpiDev<span class="token operator">-&gt;</span>cs_gpio      <span class="token operator">=</span> pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCs<span class="token punctuation">;</span>        <span class="token comment">//把 CS 管脚分配给设备</span>
    pSpiDev<span class="token operator">-&gt;</span>mode        <span class="token operator">|=</span> SPI_MODE_3<span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">spi_setup</span><span class="token punctuation">(</span>pSpiDev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"qup spi setup fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    pDev<span class="token operator">-&gt;</span>ucSpiFlag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看出 probe 函数中最重要的操作就是把 CS 管脚赋给设备结构体，同时把设备结构体交给 spi_setup 去完成主控器时序参数的初始化。</p> 
<p>这里的两个项目是根据公司的模块写的，和别的驱动不太一样，虽然还是驱动的框架，但是用途不太一样。</p> 
<ol><li>对于数量多而简单的驱动，没必要挨个注册，这里的驱动就是集成到主板驱动上，一个主板一个驱动；</li><li>对于复杂的驱动，类似网卡、无线网卡、USB，这些有厂商和内核提供驱动，一般作为模块编进系统；</li><li>将驱动写成 API 的方式集成到主板驱动的好处：<br> a. 可以让其他需要用到该驱动的模块直接调用；<br> b. 这些设备不需要应用工程师控制，减少文件系统的复杂度。</li></ol> 
<h2><a id="idt8v97003_136"></a>一、idt8v97003（无线收发器）</h2> 
<h3><a id="_138"></a>原理图</h3> 
<p><img src="https://images2.imgbox.com/ec/7e/oZKF2ncr_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_142"></a>设备树</h3> 
<pre><code class="prism language-powershell">spi_0: spi@78b5000 <span class="token punctuation">{<!-- --></span>
    status = <span class="token string">"ok"</span><span class="token punctuation">;</span>
    pinctrl-0 = &lt;&amp;spi_0_pins&gt;<span class="token punctuation">;</span>     <span class="token operator">/</span><span class="token operator">/</span>选择spi控制器0的管脚配置，spi控制器0的管脚配置是处理器写死的，不要去改
    pinctrl-names = <span class="token string">"default"</span><span class="token punctuation">;</span>
    cs-<span class="token function">select</span> = &lt;0&gt;<span class="token punctuation">;</span>               <span class="token operator">/</span><span class="token operator">/</span>选择编号为0的设备
<span class="token punctuation">}</span>
</code></pre> 
<p>其实配置 SPI 最重要的也就是配置管脚复用为 SPI 功能。<br> SPI 的的从设备有很多，但是我们只会控制 SPI 主控器，如何驱动信息是发给哪一个从设备的呢？<br> 只能通过 CS 编号。SPI 控制器或许有多个 CS 管脚，但是这个不重要，因为不够的可以用 GPIO 代替。<br> 只有被使能的管脚才能和主机通信。所以每次发消息前都是先使能，发完消息就失能。</p> 
<h3><a id="_157"></a>数据手册</h3> 
<p><img src="https://images2.imgbox.com/34/d4/u8sOPtrt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3e/d5/Pyms6Dlj_o.png" alt="在这里插入图片描述"><br> 设备的地址空间是 0X00 到 0X49，寻址模式是 15 位。也就是说，每个寄存器有15个位。<br> 在传输操作中，如果寄存器0x00 的第5位和第2位设置为1，地址自动递增，否则递减。<br> 在递增模式下，如果地址达到0x49，则将其置为0x00。在递减模式下，如果地址达到0x00，则将其置为0x49。<br> 默认是递增的。<br> <img src="https://images2.imgbox.com/94/78/nw2hdl0h_o.png" alt="在这里插入图片描述"><br> SPI操作在CSB上有高到低的转换时开始，在CSB上有低到高的转换时停止。如果传输方向位R/nW为1，则为读操作，否则为写操作。<br> 该设备支持多字节的读取或写操作。位A14到A0表示寄存器地址。设备读取或写入数据到这个地址，只要CSB保持在低水平就会继续。设备会根据地址编码位自动增加或减少地址。<br> <img src="https://images2.imgbox.com/cb/1c/etTpKcuA_o.png" alt="在这里插入图片描述"><br> MSB 模式：<br> 如果要写数据到寄存器，那么先发写位+15位地址+8位寄存器数据。<br> 如果要读寄存器的数据，那么先发读位+15位地址。然后就会收到8位数据。<br> <img src="https://images2.imgbox.com/2e/41/TyKMCI5F_o.png" alt="在这里插入图片描述"><br> LSB 模式：<br> 首先操作是一样的，但是地址和读写位、数据位的顺序都是相反的。<br> <img src="https://images2.imgbox.com/7b/cc/LJE1HE0R_o.png" alt="在这里插入图片描述"><br> MSB 模式写入多个字节：（寄存器地址会递增，前面说过了，默认是递增的；第一个例子是递减的）<br> 还是之前的操作，但是第二个数据会自动写到下一个地址。<br> <img src="https://images2.imgbox.com/fe/5b/fSbUt5Xo_o.png" alt="在这里插入图片描述"><br> LSB 模式读多个字节：<br> 略…<br> <img src="https://images2.imgbox.com/12/58/uMAbBQGS_o.png" alt="在这里插入图片描述"><br> SPI 的时序，对于不连续的地址也可以，写入多个地址，然后接受多个地址的数据。<br> <img src="https://images2.imgbox.com/b9/07/Oa3q8SZj_o.png" alt="在这里插入图片描述"><br> 宽度大于8位的配置寄存器是为同步访问提供的双缓冲寄存器。<br> 对于这些寄存器，需要先将多字节设置写入缓冲寄存器。新配置直到将1写入寄存器0x0F位0，以将它们从缓冲寄存器传输到活动寄存器。<br> 传输位是自动清除的。多字节配置数据可以从缓冲寄存器或0x01位5寄存器中指定的缓冲区读取模式位进行回读取。<br> 寄存器0x10到0x1D、0x22到0x25和0x29到0x2C都是双缓冲的。</p> 
<p><strong>提示：</strong><br> <strong>其实正常j讲到这里就可以了，因为每个 SPI 模块的操作各异，相同点已经讲完了。</strong><br> 接下去的内容会让崩溃，抛开无效寄存器，假如每个寄存器有8个，每个位又有0/1两种情况，两种情况对应不用的功能。<br> 那么就需要了解 0X49 X 8 X 2 个功能，也就是 1168 个功能…文章篇幅有限，会给举个例子，但是具体讲不了。<br> <img src="https://images2.imgbox.com/e9/4c/KHJx4eSA_o.png" alt="在这里插入图片描述"><br> 所有寄存器功能的地址归类，可以看到的是用不到的和没用的还是挺多的。<br> <img src="https://images2.imgbox.com/f1/e0/DF0sQ8Xw_o.png" alt="在这里插入图片描述"><br> 预设寄存器中每个位的意义：<br> <img src="https://images2.imgbox.com/4b/a3/Isd7wIOx_o.png" alt="在这里插入图片描述"><br> 每个位的功能选择：<br> <img src="https://images2.imgbox.com/b7/d3/MeXGLQzt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a1/0e/sTsrlgkq_o.png" alt="在这里插入图片描述"><br> 再讲下去我怕浪费各位同学的青春……总之以后开发时，每个模块的寄存设置不一样，自己要自己学会看数据手册。</p> 
<h3><a id="_202"></a>整理数据手册</h3> 
<p>数据手册又不是只给程序员看的，里面芯片介绍、热特性、，所以一定要把所有程序相关的转移出来，做到一目了然的效果。</p> 
<pre><code class="prism language-c"><span class="token comment">/* IDT8V97003 register map:
 * 0000~000F Preface registers
 * 0010~0043 Control registers
 * 0044~0049 Status registers
 * 所有数据寄存器皆为8位
 */</span>

<span class="token comment">/* Preface registers
 * 0000-0001 Startup Control Resigters
 * 0002      Reserved
 * 0003-0006 Device Type, ID and Version Registers
 * 0007      Reserved
 * 0008-000B Unused
 * 000C 000D Vendor ID Control Registers
 * 000E-000F Unused
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_SCR_0</span>         <span class="token expression"><span class="token number">0</span>      </span><span class="token comment">//高位与对应低位互为镜像，且互为镜像的位需要同时设置 R/W</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_SCR_1</span>         <span class="token expression"><span class="token number">0x01</span>   </span><span class="token comment">//D5:BufferReadMode  R/W</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_DeviceType</span>    <span class="token expression"><span class="token number">0x03</span>   </span><span class="token comment">//Device Type  R    default:0000_0110</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_DeviceID_0</span>    <span class="token expression"><span class="token number">0x04</span>   </span><span class="token comment">//DeviceID     R</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_DeviceID_1</span>    <span class="token expression"><span class="token number">0x05</span>   </span><span class="token comment">//DeviceID     R</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_DeviceVersion</span> <span class="token expression"><span class="token number">0x06</span>   </span><span class="token comment">//DeviceVersion R</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_VendorID_0</span>    <span class="token expression"><span class="token number">0x0C</span>   </span><span class="token comment">//Vendor ID    R    default:0010_0110</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_VendorID_1</span>    <span class="token expression"><span class="token number">0x0D</span>   </span><span class="token comment">//Vendor ID    R    default:0000_0100</span></span>

<span class="token comment">/* Control registers
 * 0010-0019 Feedback Divider Control Registers
 * 001A-001D Phase Adjustments Control Registers
 * 001E      DSM Control Registers
 * 001F-0020 Manual VCO and Digital Band Selection
 * 0021      Calibration Control Registers
 * 0022-0023 Band Select Clock Divider Control Registers
 * 0024-0025 Reserved
 * 0026-0027 Lock Detect Control Registers
 * 0028      Power Down Control Registers
 * 0029-002C Input Control Registers
 * 002D-002F Charge Pump Current Control Registers
 * 0030      Charge Pump Current Control Registers
 * 0031-0032 Re-Sync Control Registers
 * 0033-003B Output Control Registers
 * 003C      Reserved
 * 003D      Reserved
 * 003E-0040 Unused or Reserved
 * 0041-0043 Reserved
 */</span>
<span class="token comment">/*FB分压器整数部分 R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NIntR_0</span>           <span class="token expression"><span class="token number">0x10</span>  </span><span class="token comment">//default: 0001 1111 = d'31 最小值 d'12 R/W</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NIntR_1</span>           <span class="token expression"><span class="token number">0x11</span></span></span>
<span class="token comment">/*FB分压器小数部分，Nfrac是分数除比的分子值。可编程范围为0 ~ (MOD−1)。R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NFracR_0</span>          <span class="token expression"><span class="token number">0x12</span>  </span><span class="token comment">//default: 1011 1100 1111 1111 1111 1110 1000 0110</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NFracR_1</span>          <span class="token expression"><span class="token number">0x13</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NFracR_2</span>          <span class="token expression"><span class="token number">0x14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NFracR_3</span>          <span class="token expression"><span class="token number">0x15</span></span></span>
<span class="token comment">/*FB分压器模量部分 ；R/W    */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NModR_0</span>           <span class="token expression"><span class="token number">0x16</span>  </span><span class="token comment">//default: 1111 1111 1111 1111 1111 1110 0000 0000</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NModR_1</span>           <span class="token expression"><span class="token number">0x17</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NModR_2</span>           <span class="token expression"><span class="token number">0x18</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_NModR_3</span>           <span class="token expression"><span class="token number">0x19</span></span></span>
<span class="token comment">/*相位调整控制寄存器。相位调整(相位值)必须小于模量(Nmod值)。 R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_PhaseR_0</span>          <span class="token expression"><span class="token number">0x1A</span>  </span><span class="token comment">//default: d'1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_PhaseR_1</span>          <span class="token expression"><span class="token number">0x1B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_PhaseR_2</span>          <span class="token expression"><span class="token number">0x1C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_PhasRe_3</span>          <span class="token expression"><span class="token number">0x1D</span></span></span>
<span class="token comment">/*DSM控制寄存器 R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_DSMOrderR</span>         <span class="token expression"><span class="token number">0x1E</span>  </span><span class="token comment">/* D7~D5 DSM Order   000=OFF 设备工作在整数模式，忽略小数部分。default:111
                                            * D4~D3 Dither Gain 00=LSB Dither (Recommended) (default)
                                            * D2    Shape Dither Enable 0/1=Shaped dither disabled/enabled
                                            * D1    Dither Enable  0/1 = Dither off/on
                                            */</span></span>
<span class="token comment">/*校准控制寄存器             R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_CalibrationR_0</span>    <span class="token expression"><span class="token number">0x1F</span>  </span><span class="token comment">/* D7:ManuBandEn 启用校准模式 0/1=自动/手动压控振荡器和数字波段选择。
                                            * D6/D5/D4:0
                                            * D3~D0:VCOManu 手动选择VCO(ManuBandEn=1时) 0000/.../0111=VCO0/.../VCO7  default:1000
                                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_CalibrationR_1</span>    <span class="token expression"><span class="token number">0x20</span>  </span><span class="token comment">/* D7:0
                                            * D6~D0:手动选择数字波段(ManuBandEn=1时)  0000000/.../1111111=Band/.../Band127 default:10000000
                                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_CalibrationR_2</span>    <span class="token expression"><span class="token number">0x21</span>  </span><span class="token comment">/* D7:ForceRelockVCO  0/1=正常操作(default)/VCO强制重新校准，自动清除。(当锁相环在整数模式下使用时，在编程反馈分压器值后，必须将该位设置为1。)
                                            * D6:PhAdj           相位调整触发器 0/1=正常操作(default)/触发相位调整一次。自动清除。
                                            * D5:BandSelDisable  禁用波段选择，当写入寄存器0x0010-0x0019时，该位将防止VCO重新校准。 0/1=是/否重新校准 default:0
                                            * D4:ManualReSync    手动重新同步锁相环输出。0/1=正常操作(default)/同步锁相环输出到PFD参考的特定阶段，由相位调整控制寄存器&lt;31:0&gt;指定。自动清除。
                                            * D3~D2:0
                                            * D1~D0:             波段选择/校准分辨率。00/01/10/11=Reserved/Reserved/4x resolution/8x resolution(default)
                                            */</span></span>
<span class="token comment">/*频带选择时钟分频控制寄存器               R/W*/</span>
<span class="token comment">// This value should be set so that FPFD / BndSelDiv is &lt; 100kHz and &gt; 50kHz</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_BSCDCR_0</span>          <span class="token expression"><span class="token number">0x22</span>  </span><span class="token comment">//BndSelDiv[12:0] default:1010 0000 0000</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_BSCDCR_1</span>          <span class="token expression"><span class="token number">0x23</span>  </span><span class="token comment">//D7~D5:Unused  D4:BndSelDiv&lt;D12&gt;</span></span>
<span class="token comment">/*锁定检测控制寄存器           R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_LDCR_0</span>            <span class="token expression"><span class="token number">0x26</span>  </span><span class="token comment">/* D7~D5:Unused
                                            * D4:LD_Disable  禁用锁定检测           0/1=禁用(default)/启用锁定检测电路
                                            * D3:AutoRecalEn 启用自动重新校准         0/1=禁用(default)/启用(如果检测到LD上的解锁，则会自动重新校准)
                                            */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_LDCR_1</span>            <span class="token expression"><span class="token number">0x27</span>  </span><span class="token comment">/* D7~D6:Unused
                                            * D5~4:LDPinMode  00/01=数字锁检测(默认);正常锁探测器功能/校准完成                      10/11=Low/High
                                            * D3:Unused
                                            * D2~D0:锁探测器精度设置(ns)   000=0.375 (default)  001/010/100/101/110/111=0.75/1.5/2.4/5.2/5.2/8.5/8.5
                                            */</span></span>
<span class="token comment">/*断电控制寄存器         R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_PDCR</span>              <span class="token expression"><span class="token number">0x28</span>  </span><span class="token comment">/* D7:Reserved
                                            * D6:ref_vreg_pwrdwn  参考输入路径调节器断电控制                0/1=开启调节器(默认)/调节器断电
                                            * D5:pdcp_vreg_pwrdwn 鉴相器和电荷泵调节器断电控制 0/1=开启(默认)/关闭
                                            * D4:fb_vreg_pwrdwn   反馈分频调节器断电控制 0/1=开启(默认)/关闭
                                            * D3:outA_vreg_pwrdwn 输出稳压器断电控制 0/1=开启(默认)/关闭
                                            * D2:outBbuf_vreg_pwrdwn 输出路径调节器和输出b调节器的断电控制  0/1=开启(默认)/关闭
                                            * D1:PDNAnaRegu       模拟调节器断电控制 该位设置为1将关闭以上的所有调节器 default:0
                                            * D0:VCO_En    0/1=禁用所有VCO(将VCO电源电流IVCO降低到46mA(典型值))/正常模式
                                            */</span></span>
<span class="token comment">/*输入控制寄存器 R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_InputControl_0</span>    <span class="token expression"><span class="token number">0x29</span>  </span><span class="token comment">//InputControl_0[D7~D0] + InputControl_1[D1~D0]=R[9:0],输入除法值(参考)  default:d'1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_InputControl_1</span>    <span class="token expression"><span class="token number">0x2A</span>  </span><span class="token comment">/* D7~D5:Unused
                                            * D4:RefDoubler_Delay  为输入倍频器选择标准或扩展脉冲宽度延迟 0/1=标准脉冲宽度(默认值)。输入参考频率&gt;50MHz时使用/延长脉冲宽度用于低频(&lt;50MHz)
                                            * D3:Input_Type     选择差分或单端输入 0/1=单端输入/差分输入(default)
                                            * D2:RefDoubler_En  启用输入引用加倍器 0/1=disabled/enabled(default)
                                            * D1~D0=R&lt;9&gt;~R&lt;8&gt;
                                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_InputControl_2</span>    <span class="token expression"><span class="token number">0x2B</span>  </span><span class="token comment">/* D7:Mult_En     MULT Enable  0/1=not enabled(default)/enabled
                                            * D6:Mult_reset  重置参考倍频器模块(MULT) 0/1= is active (default)/is reset 当输入倍增器(MULT)正在使用时，
                                            *                  建议对设备进行适当的MULT设置，保持Mult_reset = 1并将其切换到低(活动)，
                                            *                  然后使用TransferOn位(寄存器0F，位0)传输数据，用于双缓冲寄存器，并重新锁定锁相锁(ForceRelock)
                                            * D5~D0:Mult&lt;5:0&gt;  输入时钟的倍频因子。当启用时，乘法器块(Mult)将相位检波器的输入频率乘到更高的频率
                                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_InputControl_3</span>    <span class="token expression"><span class="token number">0x2C</span>  </span><span class="token comment">/* D7:Mult_mux_ena  为倍频器使能多路复用器 0/1=disabled(default)/enabled
                                            * D6:Mult_d2s_ena  差分到单端块启用倍频器 0/1=disabled(default)/enabled
                                            * D5:Mult_cp_ena   电荷泵启用倍频器 0/1=disabled(default)/enabled
                                            * D4:Mult_force_vchi  倍增器电平强制控制在高电平 0/1=正常操作(default)/倍增器控制电压充电到VDD
                                            * D3:Mult_force_vclow 倍增器电平强制控制在低电平 0/1=正常操作(default)/倍增器控制电压放电到GND
                                            *                      如果没有使用输入倍频器，建议将Mult_force_vclow位设置为1 (High)
                                            * D2~D0:1 0 0
                                            */</span></span>
<span class="token comment">/*充电泵控制寄存器 R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_CPCCR_0</span>           <span class="token expression"><span class="token number">0x2D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_CPCCR_1</span>           <span class="token expression"><span class="token number">0x2E</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_CPCCR_2</span>           <span class="token expression"><span class="token number">0x2F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_CPCCR_3</span>           <span class="token expression"><span class="token number">0x30</span></span></span>
<span class="token comment">/*重新同步控制寄存器 R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_ReSyncControl_0</span>   <span class="token expression"><span class="token number">0x31</span>  </span><span class="token comment">//D7~D0:1 0 0 0 1 0 0 0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_ReSyncControl_1</span>   <span class="token expression"><span class="token number">0x32</span>  </span><span class="token comment">//D7:AutoReSync  选择自动同步模式 0/1=设备不会将“锁相环输出与引用”同步到特定相位/在重新锁定后，设备将“锁相环输出与引用”同步到特定相位</span></span>
<span class="token comment">/*输出控制寄存器 R/W*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_OutputControl_0</span>   <span class="token expression"><span class="token number">0x33</span>  </span><span class="token comment">/* D7~D4:Unused
                                            * D3~D0:RF_OUTA_pwr[3:0]  RF_OUTA电源设置 设置RF_OUTA的输出功率。设置数越高输出功率越大，最高可达最大值，这取决于所使用的输出负载
                                                0000/0001=OFF(default)/最小输出功率设置 1100-1111=最高输出功率
                                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_OutputControl_1</span>   <span class="token expression"><span class="token number">0x34</span>  </span><span class="token comment">/* D7:1
                                            * D6:Unused
                                            * D5:Mute_until_LD  0/1=输出与锁检测无关(默认)/“锁定检测”值为“高”时，才使能输出
                                            * D4:RF_OUTA_ena    0/1= RF_OUTA is disabled (MUTED &amp; default)/enabled
                                            * D3~D0:1 1 1 0
                                            */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_OutputControl_2</span>   <span class="token expression"><span class="token number">0x35</span>  </span><span class="token comment">/* D7~D4:Unused
                                            * D3~D0:RF_OUTB_pwr[3:0]  RF_OUTB电源设置 设置数越高输出功率越大，最高可达最大值，这取决于所使用的输出负载
                                            *                          0000/0001=OFF(default)/最小输出功率设置 1100-1111=最高输出功率
                                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_OutputControl_3</span>   <span class="token expression"><span class="token number">0x36</span>  </span><span class="token comment">/* D7:1
                                            * D6~D5:Unused
                                            * D4:RF_OUTB_ena  0/1=RF_OUTB is disabled (MUTED &amp; default)/enabled
                                            * D3~D0:1 1 1 0
                                            */</span></span>
<span class="token comment">/*0037~003A Reserved*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_OutputControl_4</span>   <span class="token expression"><span class="token number">0x3B</span>  </span><span class="token comment">/* D7:OutDoubler_Ena  射频输出倍频器使能 0/1=1x path (Divide by 1) path Enabled (default)/2x path Enabled (RF Output Doubler Enabled)
                                            *                      当VCO频率不大于9GHz时，OutDoubler_Ena只能设置为1。
                                            *                      对于除1(绕过Output Divider和Doubler)， OutDoubler_Ena Bit和Out_Divider_Ena Bit都必须设置为0 (Low)。
                                            * D6:OutDivider_Ena  射频输出分频器使能 0/1=1x or 2x path Enabled (default)/RF Output Divider Enabled
                                            *                      注意：倍频器和差分器两者不能同时使能
                                            * D5:OutDoubler_Freq 射频输出加倍器频率设置 0/1=VCO频率7.0-9.0GHz(默认)/VCO频率5.5-7.0GHz
                                            * D4~D3:Unused
                                            * D2~D0:OutDiv[2:0]  射频输出分压器(M0)设置
                                                                 000/001/011/100/101/110/111
                                                                 =
                                                                 Unused/Div By 2/Div By 4/Div By 8/Div By 16/Div By 32/Unused/Unused
                                            */</span></span>

<span class="token comment">/* Status Registers
 * 0044      Digital Lock and Calibration and VCO Status Registers
 * 0045      Digital Band Status Registers
 * 0046-0048 Reserved or Unused
 * 0049      Loss of Lock Status Registers
*/</span>
<span class="token comment">/*数字校准锁定和VCO状态寄存器 Read only*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_StatusRegisters_0</span> <span class="token expression"><span class="token number">0x44</span>  </span><span class="token comment">/* D7:DigLock      0/1=锁相环未锁定(default)/锁相环已锁定(根据寄存器0x27中的LDP设置)
                                            * D6:BandSelDone  波段选择完成(校正完成) 0/1=未完成(default)/已完成
                                            * D5~D4:Unused
                                            * D3~D0:VcoSts[3:0]  VCO当前状态 0000/.../0111=VCO0/.../VCO7  1000-1111:Unused
                                            */</span></span>
<span class="token comment">/*数字波段状态寄存器 R*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_StatusRegisters_1</span> <span class="token expression"><span class="token number">0x45</span>  </span><span class="token comment">/* D7:Unused
                                            * D6~D0:BandSts[6:0]  数字频带的当前状态
                                            *                      000 0000/.../111 1111=Band 0/.../Band 127
                                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_StatusRegisters_2</span> <span class="token expression"><span class="token number">0x46</span>  </span><span class="token comment">//Reserved</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_StatusRegisters_3</span> <span class="token expression"><span class="token number">0x47</span>  </span><span class="token comment">//Reserved</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_StatusRegisters_4</span> <span class="token expression"><span class="token number">0x48</span>  </span><span class="token comment">//Unused</span></span>
<span class="token comment">/*锁状态缺失寄存器*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IDT8V97003_StatusRegisters_5</span> <span class="token expression"><span class="token number">0x49</span></span></span>
</code></pre> 
<h3><a id="_405"></a>编写驱动</h3> 
<h4><a id="_406"></a>数据结构</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">97003_REG_NUM</span> <span class="token expression"><span class="token number">73</span>    </span><span class="token comment">//寄存器数量</span></span>

<span class="token comment">//idt8v97003寄存器参数</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span>     uAddr<span class="token punctuation">;</span>      <span class="token comment">//寄存器地址</span>
    <span class="token class-name">uint32_t</span>    uiData<span class="token punctuation">;</span>     <span class="token comment">//需要写入或者读出的数据</span>
<span class="token punctuation">}</span>T_97003RegParam<span class="token punctuation">;</span>

<span class="token comment">//idt8v97003配置</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span>            uiSdio<span class="token punctuation">;</span>       <span class="token comment">//三线input/output,四线input</span>
    <span class="token class-name">uint32_t</span>            uiSdo<span class="token punctuation">;</span>        <span class="token comment">//三线input/output,四线output</span>
    <span class="token class-name">uint32_t</span>            uiSclk<span class="token punctuation">;</span>       <span class="token comment">//时钟</span>
    <span class="token class-name">uint32_t</span>            uiCsPin<span class="token punctuation">;</span>      <span class="token comment">//片选</span>
    <span class="token class-name">uint32_t</span>            uiNreset<span class="token punctuation">;</span>     <span class="token comment">//复位引脚</span>
<span class="token punctuation">}</span>T_97003Config<span class="token punctuation">;</span>

<span class="token comment">//an41908设备对象结构体</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span>            uaRegCache<span class="token punctuation">[</span><span class="token number">97003</span>_REG_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//idt8v97003寄存器cache</span>
    <span class="token class-name">uint8_t</span>             ucSpiFlag<span class="token punctuation">;</span>                    <span class="token comment">//SPI设备探测成功标志, 1.成功  0.失败</span>
    T_97003Config       tCfg<span class="token punctuation">;</span>                         <span class="token comment">//idt8v97003配置</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span>   <span class="token operator">*</span>pSpiDev<span class="token punctuation">;</span>                     <span class="token comment">//spi设备指针</span>
<span class="token punctuation">}</span>T_97003Dev<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_437"></a>读写函数</h4> 
<pre><code class="prism language-c"><span class="token comment">//从机使能</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Idt8v97003_EnableCs</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_97003Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gIDT8v97003Dev<span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//从机失能</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Idt8v97003_DisableCs</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_97003Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gIDT8v97003Dev<span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 写寄存器数据
 * uiAddr：从设备寄存器地址
 * ucData：要写入的数据
 */</span>
<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> <span class="token function">Idt8v97003_WriteReg</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> uiAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ucData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">int32_t</span> iRet <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    T_97003Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gIDT8v97003Dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>pSpidev <span class="token operator">=</span> pDev<span class="token operator">-&gt;</span>pSpiDev<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> ucTxBuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    ucTxBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">;</span>
    ucTxBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> uiAddr<span class="token punctuation">;</span>
    ucTxBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> ucData<span class="token punctuation">;</span>

    <span class="token function">Idt8v97003_DisableCs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">spi_write</span><span class="token punctuation">(</span>pSpidev<span class="token punctuation">,</span> ucTxBuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Idt8v97003_EnableCs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"write REG fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"IDT8V97003 SPI write reg:Addr = \"PRINTF_BINARY_PATTERN_INT8\" \"PRINTF_BINARY_PATTERN_INT8\"\nData = \"PRINTF_BINARY_PATTERN_INT8\"\n"</span><span class="token punctuation">,</span>
                <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>因为芯片业务是控制无线收发器，并没有要读取的数据，所以只需要实现 write 操作。</p> 
<h4><a id="_487"></a>完成驱动结构体</h4> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">Idt8v97003_SpiProbe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>pSpiDev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_97003Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gIDT8v97003Dev<span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span> iRet<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span>DBG_LENS_IRIS<span class="token punctuation">,</span> <span class="token string">"probe spi device '%s' success and infomation as follows: \n"</span><span class="token punctuation">,</span>
              pSpiDev<span class="token operator">-&gt;</span>modalias<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span>DBG_LENS_IRIS<span class="token punctuation">,</span> <span class="token string">"max_speed_hz = %d, chip_select=%d, mode=0x%x, bits_per_word=%d"</span><span class="token punctuation">,</span>
              pSpiDev<span class="token operator">-&gt;</span>max_speed_hz<span class="token punctuation">,</span> pSpiDev<span class="token operator">-&gt;</span>chip_select<span class="token punctuation">,</span>
              pSpiDev<span class="token operator">-&gt;</span>mode<span class="token punctuation">,</span> pSpiDev<span class="token operator">-&gt;</span>bits_per_word<span class="token punctuation">)</span><span class="token punctuation">;</span>

    pSpiDev<span class="token operator">-&gt;</span>max_speed_hz <span class="token operator">=</span> <span class="token number">2000000</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">spi_setup</span><span class="token punctuation">(</span>pSpiDev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"Idt8v97003 spi setup fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pDev<span class="token operator">-&gt;</span>pSpiDev <span class="token operator">=</span> pSpiDev<span class="token punctuation">;</span>    <span class="token comment">//直接把初始化完成的设备结构体给了设备指针</span>
    pDev<span class="token operator">-&gt;</span>ucSpiFlag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">Idt8v97003_SpiRemove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>pSpiDev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"remove spi device '%s' success.\n"</span><span class="token punctuation">,</span> pSpiDev<span class="token operator">-&gt;</span>modalias<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> Idt8v97003_of_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"qcom,idt8v97003"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">/* Sentinel */</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">spi_driver</span> gIdt8v97003_SpiDrv <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>driver  <span class="token operator">=</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"idt8v97003"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner  <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> Idt8v97003_of_match<span class="token punctuation">,</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>probe  <span class="token operator">=</span> Idt8v97003_SpiProbe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> Idt8v97003_SpiRemove
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_538"></a>驱动出入口</h4> 
<pre><code class="prism language-c"><span class="token class-name">int32_t</span> <span class="token function">Idt8v97003_Init</span><span class="token punctuation">(</span>T_97003Config <span class="token operator">*</span>pCfg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_97003Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gIDT8v97003Dev<span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span> iRet<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Idt8v97003_InitConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"bu240 config init fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> Init_Config_Fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">spi_register_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gIdt8v97003_SpiDrv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>ucSpiFlag<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"register spi driver fail, please check bu240 kernel support.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> Register_Spi_Fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">Idt8v97003_InitReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"Idt8v97003 init success.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

Register_Spi_Fail<span class="token operator">:</span>
Init_Config_Fail<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Idt8v97003_Exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">spi_unregister_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gIdt8v97003_SpiDrv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"Idt8v97003 exit success.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>驱动编写其实也挺自由的，但是也就在那几个函数之间找个顺序填充而已。这里也是驱动入口处完成设备结构体的配置和寄存器的初始化。<br> 用到函数如下：</p> 
<pre><code class="prism language-c"><span class="token comment">//设备结构体配置</span>
<span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">Idt8v97003_InitConfig</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_97003Dev <span class="token operator">*</span>pDev  <span class="token operator">=</span> <span class="token operator">&amp;</span>gIDT8v97003Dev<span class="token punctuation">;</span>

    pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiSdio   <span class="token operator">=</span> <span class="token punctuation">;</span>
    pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiSclk   <span class="token operator">=</span> <span class="token punctuation">;</span>
    pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiSdo    <span class="token operator">=</span> <span class="token punctuation">;</span>
    pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin  <span class="token operator">=</span> <span class="token punctuation">;</span>
    pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiNreset <span class="token operator">=</span> <span class="token punctuation">;</span>

    <span class="token comment">//配置的管脚初始化</span>
    <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiSdio<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiNreset<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiSdio<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从机寄存器初始化，按照数据手册写入数据</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Idt8v97003_InitReg</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Idt8v97003_WriteReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Admv1139ADC_606"></a>二、Admv1139（ADC）</h2> 
<h3><a id="_607"></a>原理图</h3> 
<p><img src="https://images2.imgbox.com/6b/f8/xRf92MHJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_609"></a>设备树</h3> 
<pre><code class="prism language-powershell">spi_1_pins: spi-1-pins <span class="token punctuation">{<!-- --></span>
    pins = <span class="token string">"gpio61"</span><span class="token punctuation">,</span> <span class="token string">"gpio62"</span><span class="token punctuation">,</span> <span class="token string">"gpio63"</span><span class="token punctuation">,</span> <span class="token string">"gpio64"</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> = <span class="token string">"blsp1_spi"</span><span class="token punctuation">;</span>
    drive-strength = &lt;8&gt;<span class="token punctuation">;</span>
    bias-disable<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

spi_1: spi@78b6000 <span class="token punctuation">{<!-- --></span>
    status = <span class="token string">"ok"</span><span class="token punctuation">;</span>
    pinctrl-0 = &lt;&amp;spi_1_pins&gt;<span class="token punctuation">;</span>
    pinctrl-names = <span class="token string">"default"</span><span class="token punctuation">;</span>
    cs-<span class="token function">select</span> = &lt;0&gt;<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里使用的是 spi 控制器1。一般最求性能的话，就不要把多个从设备都挂在同一个主机上。</p> 
<h3><a id="_627"></a>数据手册</h3> 
<p>相比前一个，这个模块的寄存器相对来说寄存器少一些，但是功能复杂很多。<br> <img src="https://images2.imgbox.com/de/a0/JQnGzAtf_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/36/a1/sEuH47CV_o.png" alt="在这里插入图片描述"><br> 而且这个数据手册是我喜欢的类型，如下：<br> <img src="https://images2.imgbox.com/82/65/m2ZbDEeL_o.png" alt="在这里插入图片描述"><br> 如果要设置这个寄存器，那么可以先选择 MSB 或者 LSB，然后在 spi message 里面 填充地址和写位，再接上上面这8位的具体值。<br> 同样太多寄存器就不一一列举了。<br> 下面是一个例程：</p> 
<h3><a id="_638"></a>驱动编写</h3> 
<h4><a id="_639"></a>寄存器设置</h4> 
<pre><code class="prism language-c"><span class="token comment">//写寄存器初始参数</span>
<span class="token keyword">static</span> T_Admv1139RegParam gAdmv1139_InitRegParam<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x13</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x17</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x1C</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x1F</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x83</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x85</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x87</span><span class="token punctuation">,</span> <span class="token number">0xEC</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xB7</span><span class="token punctuation">,</span> <span class="token number">0x3F</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token number">0x3F</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xB9</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xBA</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xBB</span><span class="token punctuation">,</span> <span class="token number">0x3F</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xBC</span><span class="token punctuation">,</span> <span class="token number">0x3F</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xBD</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xBE</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xC5</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xC6</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xCB</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0xCD</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x101</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x103</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x104</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x12B</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x12C</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x12D</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x12E</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x130</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x131</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x132</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x133</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x137</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x138</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x139</span><span class="token punctuation">,</span> <span class="token number">0x5C</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x141</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x142</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x143</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x18C</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x18F</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x190</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x192</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x193</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x197</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//读寄存器初始参数</span>
<span class="token keyword">static</span> T_Admv1139RegParam gAdmv1139_ReadIDParam<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span>ADMV1139_REG0004<span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>ADMV1139_REG0005<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//初始化寄存器</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Admv1139_InitReg</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>gAdmv1139_InitRegParam<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span>gAdmv1139_InitRegParam<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>uiAddr<span class="token punctuation">,</span> gAdmv1139_InitRegParam<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>uiData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 功能: Tx增益寄存器（0~15dB，1dB step）R/W
 * 参数: ucTx_rf_dsa1,ucTx_rf_dsa2  0~15dB，1dB step
 */</span>
<span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">Admv1139_Tx_RF_DSA_Reg</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> ucTx_rf_dsa1<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ucTx_rf_dsa2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> ucTx_rf_dsa <span class="token operator">=</span> <span class="token punctuation">(</span>ucTx_rf_dsa2 <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> ucTx_rf_dsa1<span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span> iRet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ucTx_rf_dsa1 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>ucTx_rf_dsa1 <span class="token operator">&gt;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>ucTx_rf_dsa2 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>ucTx_rf_dsa2 <span class="token operator">&gt;</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"Write Tx_RF_DSA_Reg fail!Check the reg range in 0~15!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    iRet <span class="token operator">=</span> <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x15</span><span class="token punctuation">,</span> ucTx_rf_dsa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"write Tx_RF_DSA_Reg fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"Set Tx_RF_DSA1:%ddB   Tx_RF_DSA2:%ddB\n"</span><span class="token punctuation">,</span> ucTx_rf_dsa1<span class="token punctuation">,</span> ucTx_rf_dsa2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 功能描述: Rx增益寄存器
 * 输入参数: ucRx_rf_dsa, 0~15dB，1dB step  ucRx_if_dsaq,ucRx_if_dsai  0~4dB，1dB step
 */</span>
<span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">Admv1139_Rx_RFIF_Reg</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> ucRx_rf_dsa<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ucRx_if_dsaq<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ucRx_if_dsai<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> ucRx_rf_dsa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> ucRx_rf_dsa<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> ucRx_if     <span class="token operator">=</span> <span class="token punctuation">(</span>ucRx_if_dsaq <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> ucRx_if_dsai<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ucRx_rf_dsa <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token operator">||</span>
       <span class="token punctuation">(</span>ucRx_rf_dsa <span class="token operator">&gt;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">||</span>
       <span class="token punctuation">(</span>ucRx_if_dsaq <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
       <span class="token punctuation">(</span>ucRx_if_dsaq <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span>
       <span class="token punctuation">(</span>ucRx_if_dsai <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
       <span class="token punctuation">(</span>ucRx_if_dsai <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"Write Tx_RF_DSA_Reg fail!Check the range of reg!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x14</span><span class="token punctuation">,</span> ucRx_rf_dsa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">,</span> ucRx_if<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"Set Rx_RF_DSA:%ddB   Rx_IF_DSAQ:%ddB   Rx_IF_DSAI:%ddB\n"</span><span class="token punctuation">,</span>
                ucRx_rf_dsa<span class="token punctuation">,</span> ucRx_if_dsaq<span class="token punctuation">,</span> ucRx_if_dsai<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 功能描述: LO nulling
 * 输入参数: void
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Admv1139_LOnulling</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">,</span> <span class="token number">0x0B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//初始化并使能ADC以及ADC时钟</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x12E</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//重置LO nulling loop</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x12D</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//使能LO nulling loop</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x137</span><span class="token punctuation">,</span> <span class="token number">0x5F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//power up the ADC reference</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x103</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//select LO nulling for the ADC</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x12B</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//tap the envelop detector</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x130</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//set the optimum LO nulling</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x12D</span><span class="token punctuation">,</span> <span class="token number">0x49</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//start the LO nulling</span>
    <span class="token function">msleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x12D</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//finish the LO nulling</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x12B</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//disable envelop tapping</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//disable the ADC and the ADC clock</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
* 功能: LO nulling disable
* 参数:
*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Admv1139_LOnullingDisable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x12D</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//失能LO nulling loop</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x131</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token number">0x132</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="SPI__801"></a>SPI 传输函数</h4> 
<pre><code class="prism language-c"><span class="token comment">//功能描述: Admv1139使能片选</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Admv1139_EnableCs</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_Admv1139Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gAdmv1139Dev<span class="token punctuation">;</span>

    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//Admv1139失能片选</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Admv1139_DisableCs</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_Admv1139Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gAdmv1139Dev<span class="token punctuation">;</span>

    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 功能: 写寄存器数据
 * 参数: uiAddr 寄存器地址  ucData: 写入的寄存器数据
 */</span>
<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> <span class="token function">Admv1139_WriteReg</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> uiAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ucData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">int32_t</span> iRet <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    T_Admv1139Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gAdmv1139Dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>pSpidev <span class="token operator">=</span> pDev<span class="token operator">-&gt;</span>pSpiDev<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> ucTxBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    ucTxBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span> <span class="token operator">|</span> uiAddr<span class="token punctuation">;</span>
    ucTxBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> ucData<span class="token punctuation">;</span>

    <span class="token function">Admv1139_DisableCs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">spi_write</span><span class="token punctuation">(</span>pSpidev<span class="token punctuation">,</span> ucTxBuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Admv1139_EnableCs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"write REG fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"Admv1139 SPI write reg:Addr = \"PRINTF_BINARY_PATTERN_INT8\" \"PRINTF_BINARY_PATTERN_INT8\"\nData = \"PRINTF_BINARY_PATTERN_INT8\"\n"</span><span class="token punctuation">,</span>
                <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 功能: 读寄存器数据
 * 参数: uiAddr 寄存器地址  ucData: 写入的寄存器数据
 */</span>
<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> <span class="token function">Admv1139_ReadReg</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> uiAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ucData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">int32_t</span> iRet <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    T_Admv1139Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gAdmv1139Dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>pSpidev <span class="token operator">=</span> pDev<span class="token operator">-&gt;</span>pSpiDev<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> ucTxBuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    ucTxBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">;</span>
    ucTxBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> uiAddr<span class="token punctuation">;</span>
    ucTxBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> ucData<span class="token punctuation">;</span>

    <span class="token function">Admv1139_DisableCs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">spi_write</span><span class="token punctuation">(</span>pSpidev<span class="token punctuation">,</span> ucTxBuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Admv1139_EnableCs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"write REG fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"Admv1139 SPI write reg:Addr = \"PRINTF_BINARY_PATTERN_INT8\" \"PRINTF_BINARY_PATTERN_INT8\"\nData = \"PRINTF_BINARY_PATTERN_INT8\"\n"</span><span class="token punctuation">,</span>
                <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">PRINTF_BYTE_TO_BINARY_INT8</span><span class="token punctuation">(</span>ucTxBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_882"></a>注册驱动</h4> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">Admv1139_SpiProbe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>pSpiDev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_Admv1139Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gAdmv1139Dev<span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span> iRet<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span>DBG_LENS_IRIS<span class="token punctuation">,</span> <span class="token string">"probe spi device '%s' success and infomation as follows: \n"</span><span class="token punctuation">,</span>
              pSpiDev<span class="token operator">-&gt;</span>modalias<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span>DBG_LENS_IRIS<span class="token punctuation">,</span> <span class="token string">"max_speed_hz = %d, chip_select=%d, mode=0x%x, bits_per_word=%d"</span><span class="token punctuation">,</span>
              pSpiDev<span class="token operator">-&gt;</span>max_speed_hz<span class="token punctuation">,</span> pSpiDev<span class="token operator">-&gt;</span>chip_select<span class="token punctuation">,</span>
              pSpiDev<span class="token operator">-&gt;</span>mode<span class="token punctuation">,</span> pSpiDev<span class="token operator">-&gt;</span>bits_per_word<span class="token punctuation">)</span><span class="token punctuation">;</span>

    pSpiDev<span class="token operator">-&gt;</span>max_speed_hz <span class="token operator">=</span> <span class="token number">2000000</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">spi_setup</span><span class="token punctuation">(</span>pSpiDev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"bu240 spi setup fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pDev<span class="token operator">-&gt;</span>pSpiDev <span class="token operator">=</span> pSpiDev<span class="token punctuation">;</span>
    pDev<span class="token operator">-&gt;</span>ucSpiFlag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">Admv1139_SpiRemove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>pSpiDev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"remove spi device '%s' success.\n"</span><span class="token punctuation">,</span> pSpiDev<span class="token operator">-&gt;</span>modalias<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_916"></a>驱动出入口</h4> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">Admv1139_InitConfig</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_Admv1139Dev <span class="token operator">*</span>pDev  <span class="token operator">=</span> <span class="token operator">&amp;</span>gAdmv1139Dev<span class="token punctuation">;</span>
    T_DevType tDevType   <span class="token operator">=</span> DEV_NULL<span class="token punctuation">;</span>

    <span class="token comment">//根据平台产品型号配置并初始化管脚</span>
    tDevType <span class="token operator">=</span> <span class="token function">Config_GetDevType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>tDevType<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> DEV_PTP4100<span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
            pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCenPin <span class="token operator">=</span> <span class="token punctuation">;</span>
            pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiSdo    <span class="token operator">=</span> <span class="token punctuation">;</span>
            pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiSclk   <span class="token operator">=</span> <span class="token punctuation">;</span>
            pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin  <span class="token operator">=</span> <span class="token punctuation">;</span>
            pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiLoad   <span class="token operator">=</span> <span class="token punctuation">;</span>
            pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiTx_en  <span class="token operator">=</span> <span class="token punctuation">;</span>
            pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiRx_en  <span class="token operator">=</span> <span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"unsuppot device type=%d.\n"</span><span class="token punctuation">,</span> tDevType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//配置的管脚初始化</span>
    <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCenPin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiSdo<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiLoad<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiTx_en<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCenPin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiSdo<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiCsPin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiLoad<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>tCfg<span class="token punctuation">.</span>uiTx_en<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//Admv1139驱动加载入口</span>
<span class="token class-name">int32_t</span> <span class="token function">Admv1139_Init</span><span class="token punctuation">(</span>T_97003Config <span class="token operator">*</span>pCfg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    T_Admv1139Dev <span class="token operator">*</span>pDev <span class="token operator">=</span> <span class="token operator">&amp;</span>gAdmv1139Dev<span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span> iRet<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Admv1139_InitConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"bu240 config init fail.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> Init_Config_Fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">spi_register_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gAdmv1139_SpiDrv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pDev<span class="token operator">-&gt;</span>ucSpiFlag<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"register spi driver fail, please check bu240 kernel support.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> Register_Spi_Fail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">Admv1139_InitReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"Admv1139 init success.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

Register_Spi_Fail<span class="token operator">:</span>
Init_Config_Fail<span class="token operator">:</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//功能描述: Admv1139驱动卸载入口</span>
<span class="token keyword">void</span> <span class="token function">Admv1139_Exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">spi_unregister_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gAdmv1139_SpiDrv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"Admv1139 exit success.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>学习 SPI 驱动只要是学习一个框架，当然框架怎么好维护就怎么写。</p> 
<p>代码中用到了几个封装好的函数：</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * 功能: 设置管脚方向
 * 参数: uiPinId: 管脚编号
 *       uiDir: 管脚方向 0.input     1.output
 */</span>
<span class="token class-name">int32_t</span> <span class="token function">Gpio_SetDir</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> uiPinId<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> uiDir<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">gpio_is_valid</span><span class="token punctuation">(</span>uiPinId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"gpio%d is invalid.\n"</span><span class="token punctuation">,</span> uiPinId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>uiDir <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">gpio_direction_input</span><span class="token punctuation">(</span>uiPinId<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">else</span>
        <span class="token function">gpio_direction_output</span><span class="token punctuation">(</span>uiPinId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 功能: 配置gpio
 * 参数: uiPinId: 管脚编号
 *       uiDir: 管脚方向 0.input     1.output
 *       uiLevel: 默认电平
 */</span>
<span class="token class-name">int32_t</span> <span class="token function">Gpio_Config</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> uiPinId<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> uiDir<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> uiLevel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">gpio_is_valid</span><span class="token punctuation">(</span>uiPinId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"gpio%d is invalid.\n"</span><span class="token punctuation">,</span> uiPinId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>uiDir <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">gpio_direction_input</span><span class="token punctuation">(</span>uiPinId<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">else</span>
        <span class="token function">gpio_direction_output</span><span class="token punctuation">(</span>uiPinId<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token operator">!</span>uiLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1220f85587c4823ddc0f0e3cf292e7a6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SQLI-labs-第七关和第八关</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7a1b8af06fc7bc6d70de1431617ad62a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">element-plus修改英语语言模式为中文方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>