<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL高可用探索之orchestrator - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL高可用探索之orchestrator" />
<meta property="og:description" content="摘要：使用orchestrator实现mysql主从自动切换、故障转移、拓扑管理。
部署MySQL环境(一主两从) IP:端口角色版本192.168.30.113:4406masterPercona 5.7.24-27-log CentOS Linux release 7.4.1708 (Core) 3.10.0-693.el7.x86_64192.168.30.118:4406slavePercona 5.7.24-27-log CentOS Linux release 7.4.1708 (Core) 3.10.0-693.el7.x86_64192.168.30.119:4406slavePercona 5.7.24-27-log CentOS Linux release 7.4.1708 (Core) 3.10.0-693.el7.x86_64 安装MySQL(略)
创建复制用户(三台mysql上面都创建)
GRANT REPLICATION SLAVE ON . TO repluser@’192.168.30.%’ IDENTIFIED BY ‘rep_2019’;
set global slave_net_timeout=8; 缩短从库感知主库宕机的等待时间
创建复制关系
在118和119上执行：
change master to master_host=&#39;192.168.30.113&#39;,master_port=4406,master_user=&#39;repluser&#39;,master_password=&#39;rep_2019&#39;,master_auto_position=1,MASTER_HEARTBEAT_PERIOD=2,MASTER_CONNECT_RETRY=1, MASTER_RETRY_COUNT=86400;
start slave;
以119为例，实操：
mysql&gt; change master to master_host=&#39;192.168.30.113&#39;,master_port=4406,master_user=&#39;repluser&#39;,master_password=&#39;rep_2019&#39;,master_auto_position=1,MASTER_HEARTBEAT_PERIOD=2,MASTER_CONNECT_RETRY=1, MASTER_RETRY_COUNT=86400;
Query OK, 0 rows affected, 2 warnings (0.01 sec)
mysql&gt; show warnings \G;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/53c924f46fd5dd3bf18a6b32b251ee9b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-22T10:42:26+08:00" />
<meta property="article:modified_time" content="2021-02-22T10:42:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL高可用探索之orchestrator</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>摘要：使用orchestrator实现mysql主从自动切换、故障转移、拓扑管理。<a id="more"></a></p> 
<h4 id="部署MySQL环境-一主两从">部署MySQL环境(一主两从)</h4> 
<table><thead><tr><th>IP:端口</th><th>角色</th><th>版本</th></tr></thead><tbody><tr><td>192.168.30.113:4406</td><td>master</td><td>Percona 5.7.24-27-log CentOS Linux release 7.4.1708 (Core) 3.10.0-693.el7.x86_64</td></tr><tr><td>192.168.30.118:4406</td><td>slave</td><td>Percona 5.7.24-27-log CentOS Linux release 7.4.1708 (Core) 3.10.0-693.el7.x86_64</td></tr><tr><td>192.168.30.119:4406</td><td>slave</td><td>Percona 5.7.24-27-log CentOS Linux release 7.4.1708 (Core) 3.10.0-693.el7.x86_64</td></tr></tbody></table> 
<p>安装MySQL(略)</p> 
<p>创建复制用户(三台mysql上面都创建)</p> 
<p>GRANT REPLICATION SLAVE ON <em>.</em> TO repluser@’192.168.30.%’ IDENTIFIED BY ‘rep_2019’;<br> set global slave_net_timeout=8; 缩短从库感知主库宕机的等待时间</p> 
<p>创建复制关系</p> 
<p>在118和119上执行：</p> 
<table><tbody><tr><td> <pre> </pre> <p>change master to master_host='192.168.30.113',master_port=4406,master_user='repluser',master_password='rep_2019',master_auto_position=1,MASTER_HEARTBEAT_PERIOD=2,MASTER_CONNECT_RETRY=1, MASTER_RETRY_COUNT=86400;</p> <p>start slave;</p> </td></tr></tbody></table> 
<p> </p> 
<p>以119为例，实操：</p> 
<table><tbody><tr><td> <pre> </pre> <p>mysql&gt; change master to master_host='192.168.30.113',master_port=4406,master_user='repluser',master_password='rep_2019',master_auto_position=1,MASTER_HEARTBEAT_PERIOD=2,MASTER_CONNECT_RETRY=1, MASTER_RETRY_COUNT=86400;</p> <p>Query OK, 0 rows affected, 2 warnings (0.01 sec)</p> <p>mysql&gt; show warnings \G;</p> <p>*************************** 1. row ***************************</p> <p>Level: Note</p> <p>Code: 1759</p> <p>Message: Sending passwords in plain text without SSL/TLS is extremely insecure.</p> <p>*************************** 2. row ***************************</p> <p>Level: Note</p> <p>Code: 1760</p> <p>Message: Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information.</p> <p>2 rows in set (0.00 sec)</p> <p>ERROR:</p> <p>No query specified</p> <p>mysql&gt; start slave;</p> <p>Query OK, 0 rows affected (0.00 sec)</p> <p>mysql&gt; show slave status \G;</p> <p>*************************** 1. row ***************************</p> <p>Slave_IO_State: Waiting for master to send event</p> <p>Master_Host: 192.168.30.113</p> <p>Master_User: repluser</p> <p>Master_Port: 4406</p> <p>Connect_Retry: 1</p> <p>Master_Log_File: mysql-bin.000024</p> <p>Read_Master_Log_Pos: 588</p> <p>Relay_Log_File: mysqld-relay-bin.000002</p> <p>Relay_Log_Pos: 665</p> <p>Relay_Master_Log_File: mysql-bin.000024</p> <p>Slave_IO_Running: Yes</p> <p>Slave_SQL_Running: Yes</p> <p>Replicate_Do_DB:</p> <p>Replicate_Ignore_DB:</p> <p>Replicate_Do_Table:</p> <p>Replicate_Ignore_Table:</p> <p>Replicate_Wild_Do_Table:</p> <p>Replicate_Wild_Ignore_Table:</p> <p>Last_Errno: 0</p> <p>Last_Error:</p> <p>Skip_Counter: 0</p> <p>Exec_Master_Log_Pos: 588</p> <p>Relay_Log_Space: 873</p> <p>Until_Condition: None</p> <p>Until_Log_File:</p> <p>Until_Log_Pos: 0</p> <p>Master_SSL_Allowed: No</p> <p>Master_SSL_CA_File:</p> <p>Master_SSL_CA_Path:</p> <p>Master_SSL_Cert:</p> <p>Master_SSL_Cipher:</p> <p>Master_SSL_Key:</p> <p>Seconds_Behind_Master: 0</p> <p>Master_SSL_Verify_Server_Cert: No</p> <p>Last_IO_Errno: 0</p> <p>Last_IO_Error:</p> <p>Last_SQL_Errno: 0</p> <p>Last_SQL_Error:</p> <p>Replicate_Ignore_Server_Ids:</p> <p>Master_Server_Id: 1134406</p> <p>Master_UUID: 9b8d01ee-081d-11e9-94a1-005056a99b7f</p> <p>Master_Info_File: mysql.slave_master_info</p> <p>SQL_Delay: 0</p> <p>SQL_Remaining_Delay: NULL</p> <p>Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</p> <p>Master_Retry_Count: 86400</p> <p>Master_Bind:</p> <p>Last_IO_Error_Timestamp:</p> <p>Last_SQL_Error_Timestamp:</p> <p>Master_SSL_Crl:</p> <p>Master_SSL_Crlpath:</p> <p>Retrieved_Gtid_Set: 9b8d01ee-081d-11e9-94a1-005056a99b7f:1</p> <p>Executed_Gtid_Set: 3db33b36-0e51-409f-a61d-c99756e90155:1-31:1000007,</p> <p>7b8d01ee-081d-11e9-94a1-005056a99b7f:1-3,</p> <p>8b8d01ee-081d-11e9-94a1-005056a99b7f:1-2,</p> <p>9b8d01ee-081d-11e9-94a1-005056a99b7f:1</p> <p>Auto_Position: 1</p> <p>Replicate_Rewrite_DB:</p> <p>Channel_Name:</p> <p>Master_TLS_Version:</p> <p>1 row in set (0.00 sec)</p> <p>ERROR:</p> <p>No query specified</p> </td></tr></tbody></table> 
<p> </p> 
<p>在113上查看slave信息:</p> 
<table><tbody><tr><td> <pre> </pre> <p>mysql&gt; show slave hosts;</p> <p>+-----------+----------------+------+-----------+--------------------------------------+</p> <p>| Server_id | Host | Port | Master_id | Slave_UUID |</p> <p>+-----------+----------------+------+-----------+--------------------------------------+</p> <p>| 1194406 | 192.168.30.119 | 4406 | 1134406 | 8b8d01ee-081d-11e9-94a1-005056a99b7f |</p> <p>| 1184406 | 192.168.30.118 | 4406 | 1134406 | 7b8d01ee-081d-11e9-94a1-005056a99b7f |</p> <p>+-----------+----------------+------+-----------+--------------------------------------+</p> <p>2 rows in set (0.00 sec)</p> </td></tr></tbody></table> 
<p> </p> 
<p>一主两从搭建完毕。</p> 
<h4 id="安装orchestrator">安装orchestrator</h4> 
<p>下载并解压</p> 
<p>下载地址：<a href="https://github.com/github/orchestrator/releases/download/v3.0.14/orchestrator-3.0.14-linux-amd64.tar.gz">https://github.com/github/orchestrator/releases/download/v3.0.14/orchestrator-3.0.14-linux-amd64.tar.gz</a><br> 将解压出来的orchestrator目录拷贝到/usr/local/，将/usr/local/orchestrator加入环境变量(3台都装)<br> [root@mysql2 src]# tar xvf orchestrator-3.0.14-linux-amd64.tar.gz<br> [root@mysql2 src]# cp -r ./usr/local/orchestrator/ /usr/local/</p> 
<p>配置</p> 
<p>首先在orchestrator管理数据库的实例上创建账号：orch自用</p> 
<table><tbody><tr><td> <pre> </pre> <p>root@(none) 04:11:09&gt;create database orchestrator;</p> <p>Query OK, 1 row affected (0.02 sec)</p> <p>root@(none) 04:13:49&gt;CREATE USER 'orchestrator'@'192.168.1.3' IDENTIFIED BY '123456';</p> <p>Query OK, 0 rows affected (0.00 sec)</p> <p>root@(none) 04:13:58&gt;GRANT ALL ON orchestrator.* TO 'orchestrator'@'192.168.1.3';</p> <p>Query OK, 0 rows affected (0.00 sec)</p> </td></tr></tbody></table> 
<p> </p> 
<p>然后再在被管理的MySQL实例上创建账号（只在主库113执行即可，从库会复制过去）：</p> 
<table><tbody><tr><td> <pre> </pre> <p>mysql&gt; GRANT SELECT, RELOAD, PROCESS, SUPER, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'orchestrator'@'192.168.30.%' identified by 'abc123';</p> <p>Query OK, 0 rows affected, 1 warning (0.00 sec)</p> <p>mysql&gt; show warnings;</p> <p>+---------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</p> <p>| Level | Code | Message |</p> <p>+---------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</p> <p>| Warning | 1287 | Using GRANT statement to modify existing user's properties other than privileges is deprecated and will be removed in future release. Use ALTER USER statement for this operation. |</p> <p>+---------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</p> <p>1 row in set (0.00 sec)</p> </td></tr></tbody></table> 
<p> </p> 
<p>编辑配置文件<br><a href="https://github.com/github/orchestrator/blob/master/docs/configuration-sample.md">https://github.com/github/orchestrator/blob/master/docs/configuration-sample.md</a><br> 使用官网的配置文件模板，修改一下数据源即可：</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-113 ~]# cat /usr/local/orchestrator/orchestrator.conf.json</p> <p>{<!-- --></p> <p>"Debug": true,</p> <p>"EnableSyslog": false,</p> <p>"ListenAddress": ":3000",</p> <p>"MySQLTopologyUser": "orchestrator",</p> <p>"MySQLTopologyPassword": "abc123",</p> <p>"MySQLTopologyCredentialsConfigFile": "",</p> <p>"MySQLTopologySSLPrivateKeyFile": "",</p> <p>"MySQLTopologySSLCertFile": "",</p> <p>"MySQLTopologySSLCAFile": "",</p> <p>"MySQLTopologySSLSkipVerify": true,</p> <p>"MySQLTopologyUseMutualTLS": false,</p> <p>"MySQLOrchestratorHost": "192.168.1.3",</p> <p>"MySQLOrchestratorPort": 3306,</p> <p>"MySQLOrchestratorDatabase": "orchestrator",</p> <p>"MySQLOrchestratorUser": "orchestrator",</p> <p>"MySQLOrchestratorPassword": "123456",</p> <p>... ...</p> <p>"RaftEnabled": true,</p> <p>"BackendDB": "mysql",</p> <p>"RaftBind": "192.168.30.113",</p> <p>"RaftDataDir": "/var/lib/orchestrator",</p> <p>"DefaultRaftPort": 10008,</p> <p>"RaftNodes": [</p> <p>"192.168.30.113",</p> <p>"192.168.30.118",</p> <p>"192.168.30.119"</p> <p>],</p> <p>"ConsulAddress": "",</p> <p>"ConsulAclToken": ""</p> <p>}</p> </td></tr></tbody></table> 
<p> </p> 
<p>启动</p> 
<table><tbody><tr><td> <pre> </pre> <p>root@:mysql-113:/usr/local/orchestrator$./orchestrator --config=./orchestrator.conf.json http</p> <p>2019-02-26 16:21:50 INFO starting orchestrator</p> <p>2019-02-26 16:21:50 INFO Read config: ./orchestrator.conf.json</p> <p>2019-02-26 16:21:50 DEBUG Initializing orchestrator</p> <p>2019-02-26 16:21:50 DEBUG Migrating database schema</p> <p>2019-02-26 16:22:25 DEBUG Migrated database schema to version [1.5.7]</p> <p>2019-02-26 16:22:25 DEBUG Connected to orchestrator backend: orchestrator:?@tcp(127.0.0.1:3306)/orchestrator?timeout=1s</p> <p>2019-02-26 16:22:25 DEBUG Orchestrator pool SetMaxOpenConns: 128</p> <p>2019-02-26 16:22:25 INFO Starting Discovery</p> <p>2019-02-26 16:22:25 INFO Registering endpoints</p> <p>2019-02-26 16:22:25 INFO Starting continuous discovery</p> <p>2019-02-26 16:22:25 INFO Starting HTTP listener on :3000</p> <p>2019-02-26 16:22:26 DEBUG outdated keys: []</p> <p>2019-02-26 16:22:27 DEBUG outdated keys: []</p> <p>2019-02-26 16:22:28 DEBUG outdated keys: []</p> <p>2019-02-26 16:22:29 DEBUG outdated keys: []</p> <p>2019-02-26 16:22:30 DEBUG outdated keys: []</p> <p>2019-02-26 16:22:31 DEBUG outdated keys: []</p> </td></tr></tbody></table> 
<p>访问WEB</p> 
<p><a href="http://192.168.30.113:3000/" rel="nofollow">http://192.168.30.113:3000</a><br><a href="https://riverdba.github.io/2019/03/19/orchestrator/web1.png" rel="nofollow" id="ui-id-1"><img alt="web1" src="https://images2.imgbox.com/4d/45/7SDx0nz6_o.png"></a><br> 查看主从拓扑：<br><a href="https://riverdba.github.io/2019/03/19/orchestrator/web2.png" rel="nofollow"><img alt="web2" src="https://images2.imgbox.com/d4/cb/bMNM9hBs_o.png"></a><br> 查看orchestrator状态：<br><a href="https://riverdba.github.io/2019/03/19/orchestrator/web3_status.png" rel="nofollow"><img alt="web3" src="https://images2.imgbox.com/9e/56/YDWrmuON_o.png"></a></p> 
<h4 id="命令行操作">命令行操作</h4> 
<p>将/usr/local/orchestrator/resources/bin目录加入path环境变量</p> 
<p>列出集群（含别名）</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c clusters-alias</p> <p>mysql-113:4406,cluster_dev</p> <p>mysql2:3306,trotdb_test</p> </td></tr></tbody></table> 
<p>发现实例</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119]# orchestrator -c discover -i mysql1:3306</p> <p>2019-03-11 07:12:45 FATAL Orchestrator configured to run raft ("RaftEnabled": true). All access must go through the web API of the active raft node. You may use the orchestrator-client script which has a similar interface to the command line invocation. You may override this with --ignore-raft-setup</p> <p>报错说在启用raft模式上禁止使用orchestrator客户端，建议使用orchestrator-client，orchestrator-client可以安装在没有orchestrator上的服务器。</p> <p>要使用orchestrator-client需要先安装jq，否则会报错：orchestrator-client[18537]: cannot find jq</p> <p>[root@mysql-119]# yum install jq -y</p> <p>[root@mysql-119]# orchestrator-client -c discover -i mysql1:3306</p> <p>mysql1:3306</p> </td></tr></tbody></table> 
<p>查看拓扑</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c topology -i mysql-113:4406</p> <p>mysql-113:4406 [0s,ok,5.7.24-27-log,rw,ROW,&gt;&gt;,GTID,P-GTID]</p> <p>+ mysql-119:4406 [0s,ok,5.7.24-27-log,rw,ROW,&gt;&gt;,GTID,P-GTID]</p> <p>+ mysql-118:4406 [0s,ok,5.7.24-27-log,rw,ROW,&gt;&gt;,GTID]</p> <p>[root@mysql-119 ~]#</p> <p>返回列表格式：</p> <p>[root@mysql-119 ~]# orchestrator-client -c topology-tabulated -i mysql-113:4406</p> <p>mysql-113:4406 |0s|ok|5.7.24-27-log|rw|ROW|&gt;&gt;,GTID,P-GTID</p> <p>+ mysql-119:4406 |0s|ok|5.7.24-27-log|rw|ROW|&gt;&gt;,GTID,P-GTID</p> <p>+ mysql-118:4406|0s|ok|5.7.24-27-log|rw|ROW|&gt;&gt;,GTID</p> </td></tr></tbody></table> 
<p>忘记实例</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c forget -i mysql-118:4406</p> <p>查看拓扑可以发现没有了mysql-118:</p> <p>[root@mysql-119 ~]# orchestrator-client -c topology-tabulated -i mysql-113:4406</p> <p>mysql-113:4406 |0s|ok|5.7.24-27-log|rw|ROW|&gt;&gt;,GTID,P-GTID</p> <p>+ mysql-119:4406|0s|ok|5.7.24-27-log|rw|ROW|&gt;&gt;,GTID,P-GTID</p> <p>重新发现mysql-118：</p> <p>[root@mysql-119 ~]# orchestrator-client -c discover -i mysql-118:4406</p> <p>mysql-118:4406</p> <p>[root@mysql-119 ~]# orchestrator-client -c topology-tabulated -i mysql-113:4406</p> <p>mysql-113:4406 |0s|ok|5.7.24-27-log|rw|ROW|&gt;&gt;,GTID,P-GTID</p> <p>+ mysql-119:4406 |0s|ok|5.7.24-27-log|rw|ROW|&gt;&gt;,GTID,P-GTID</p> <p>+ mysql-118:4406|0s|ok|5.7.24-27-log|rw|ROW|&gt;&gt;,GTID</p> </td></tr></tbody></table> 
<p>查看API接口</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c which-api</p> <p>http://localhost:3000/api</p> </td></tr></tbody></table> 
<p>调用API</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c api -path clusters</p> <p>[ "mysql-113:4406", "mysql2:3306" ]</p> <p>[root@mysql-119 ~]# orchestrator-client -c api -path leader-check</p> <p>"Not leader"</p> <p>[root@mysql-119 ~]# orchestrator-client -c api -path status</p> <p>{ "Code": "OK", "Message": "Application node is healthy", "Details": { "Healthy": true, "Hostname": "mysql-119", "Token": "3bfe4deae671a528477bb3caa281b4d50b7aae33b052dd421d2b8655c8220864", "IsActiveNode": false, "ActiveNode": { "Hostname": "192.168.30.118:10008", "Token": "", "AppVersion": "", "FirstSeenActive": "", "LastSeenActive": "", "ExtraInfo": "", "Command": "", "DBBackend": "", "LastReported": "0001-01-01T00:00:00Z" }, "Error": null, "AvailableNodes": [ { "Hostname": "mysql-113", "Token": "30a4dc2ab18b3fce1f66b518a3c87f5f8c9351bcf43e09e10718390392bb64aa", "AppVersion": "3.0.14", "FirstSeenActive": "2019-03-05 14:04:02", "LastSeenActive": "2019-03-11 19:36:14", "ExtraInfo": "", "Command": "", "DBBackend": "192.168.1.3:3306", "LastReported": "0001-01-01T00:00:00Z" }, { "Hostname": "mysql-118", "Token": "b8e7dea2b6bf2a7117f0ba6258633f7ad677675530d499462d51473bffd6e54b", "AppVersion": "3.0.14", "FirstSeenActive": "2019-03-05 13:58:53", "LastSeenActive": "2019-03-11 19:36:13", "ExtraInfo": "", "Command": "", "DBBackend": "192.168.1.3:3306", "LastReported": "0001-01-01T00:00:00Z" }, { "Hostname": "mysql-119", "Token": "3bfe4deae671a528477bb3caa281b4d50b7aae33b052dd421d2b8655c8220864", "AppVersion": "3.0.14", "FirstSeenActive": "2019-03-05 14:01:55", "LastSeenActive": "2019-03-11 19:36:14", "ExtraInfo": "", "Command": "", "DBBackend": "192.168.1.3:3306", "LastReported": "0001-01-01T00:00:00Z" } ], "RaftLeader": "192.168.30.118:10008", "IsRaftLeader": false, "RaftLeaderURI": "http://192.168.30.118:3000", "RaftAdvertise": "192.168.30.119", "RaftHealthyMembers": null } }</p> <p>[root@mysql-118 ~]# orchestrator-client -c api -path leader-check</p> <p>"OK"</p> <p>[root@mysql-113 ~]# orchestrator-client -c api -path leader-check</p> <p>"Not leader"</p> </td></tr></tbody></table> 
<p>搜索实例</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c search -i mysql-118</p> <p>mysql-118:4406</p> <p>[root@mysql-119 ~]# orchestrator-client -c search -i mysql3</p> <p>mysql3:3307</p> </td></tr></tbody></table> 
<p>查看指定实例的主库</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c which-master -i mysql-119:4406</p> <p>mysql-113:4406</p> </td></tr></tbody></table> 
<p>查看指定实例的从库</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c which-replicas -i mysql-113:4406</p> <p>mysql-119:4406</p> <p>[root@mysql-119 ~]# orchestrator-client -c which-replicas -i mysql2</p> <p>mysql1:3306</p> <p>mysql3:3307</p> </td></tr></tbody></table> 
<p>查看指定实例名</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c instance -i mysql2</p> <p>mysql2:3306</p> </td></tr></tbody></table> 
<p>打印指定主实例从库异常的列表：which-broken-replicas，模拟test3的复制异常：</p> 
<table><tbody><tr><td> <pre> </pre> <p># orchestrator-client -c which-broken-replicas -i test2:3307</p> <p>test3:3307</p> </td></tr></tbody></table> 
<p>给定一个实例，列出所在集群下所有实例</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c which-cluster-instances -i mysql-119:4406</p> <p>mysql-113:4406</p> <p>mysql-118:4406</p> <p>mysql-119:4406</p> <p>[root@mysql-119 ~]# orchestrator-client -c which-cluster-instances -i mysql1</p> <p>mysql1:3306</p> <p>mysql2:3306</p> <p>mysql3:3307</p> </td></tr></tbody></table> 
<p>查看所有实例</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c all-clusters-masters</p> <p>mysql-113:4406</p> <p>mysql2:3306</p> <p>[root@mysql-119 ~]# orchestrator-client -c all-instances</p> <p>mysql2:3306</p> <p>mysql-113:4406</p> <p>mysql-119:4406</p> <p>mysql1:3306</p> <p>mysql3:3307</p> <p>mysql-118:4406</p> </td></tr></tbody></table> 
<p>查看可作为pt-online-schema-change操作的副本列表</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c which-cluster-osc-replicas -i mysql2</p> <p>mysql1:3306</p> <p>mysql3:3307</p> <p>[root@mysql-119 ~]# orchestrator-client -c which-cluster-osc-running-replicas -i mysql2</p> <p>mysql1:3306</p> <p>mysql3:3307</p> </td></tr></tbody></table> 
<p>查看集群中主实例的数据中心</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c dominant-dc</p> <p>mysql2</p> </td></tr></tbody></table> 
<p>将集群的主提交到KV存储</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c submit-masters-to-kv-stores</p> <p>mysql/master/cluster_dev:mysql-113:4406</p> <p>mysql/master/cluster_dev/hostname:mysql-113</p> <p>mysql/master/cluster_dev/port:4406</p> <p>mysql/master/cluster_dev/ipv4:192.168.30.113</p> <p>mysql/master/cluster_dev/ipv6:</p> <p>mysql/master/trotdb_test:mysql2:3306</p> <p>mysql/master/trotdb_test/hostname:mysql2</p> <p>mysql/master/trotdb_test/port:3306</p> <p>mysql/master/trotdb_test/ipv4:192.168.1.173</p> <p>mysql/master/trotdb_test/ipv6:</p> </td></tr></tbody></table> 
<p>修改拓扑（迁移从库到另一个实例上）</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-119 ~]# orchestrator-client -c topology -i mysql-118:4406</p> <p>mysql-113:4406 [0s,ok,5.7.24-27-log,rw,ROW,&gt;&gt;,GTID,P-GTID]</p> <p>+ mysql-119:4406 [0s,ok,5.7.24-27-log,rw,ROW,&gt;&gt;,GTID,P-GTID]</p> <p>+ mysql-118:4406 [0s,ok,5.7.24-27-log,rw,ROW,&gt;&gt;,GTID]</p> <p>将mysql-118:4406改为mysql-113:4406的从库</p> <p>[root@mysql-119 ~]# orchestrator-client -c relocate -i mysql-118:4406 -d mysql-113:4406</p> <p>mysql-118:4406&lt;mysql-113:4406</p> <p>[root@mysql-119 ~]# orchestrator-client -c topology -i mysql-118:4406</p> <p>mysql-113:4406 [0s,ok,5.7.24-27-log,rw,ROW,&gt;&gt;,GTID,P-GTID]</p> <p>+ mysql-118:4406 [0s,ok,5.7.24-27-log,rw,ROW,&gt;&gt;,GTID]</p> <p>+ mysql-119:4406 [0s,ok,5.7.24-27-log,rw,ROW,&gt;&gt;,GTID,P-GTID]</p> </td></tr></tbody></table> 
<p>如果发生过了failover，旧主修复后只能通过手动方式将其加入复制。<br> 如果使用orchestrator加入会报错：</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql-113 ~]# orchestrator-client -c relocate -i mysql-118:4406 -d mysql-113:4406</p> <p>2019-03-19 08:37:10 ERROR Relocating mysql-118:4406 below mysql-113:4406 turns to be too complex; please do it manually</p> </td></tr></tbody></table> 
<p> </p> 
<h4 id="故障切换">故障切换</h4> 
<p>主库宕机，自动Failover</p> 
<p>② Detected UnreachableMaster on mysql-113:4406. Affected replicas: 2<br> ② Detected DeadMaster on mysql-113:4406. Affected replicas: 1<br> ③ Will recover from DeadMaster on mysql-113:4406<br> ④ Recovered from DeadMaster on mysql-113:4406. Failed: mysql-113:4406; Promoted: mysql-118:4406<br> ⑤ (for all types) Recovered from DeadMaster on mysql-113:4406. Failed: mysql-113:4406; Successor: mysql-118:4406</p> 
<h4 id="遇到问题及解决">遇到问题及解决</h4> 
<p>访问WEB报：html/template: “templates/layout” is undefined</p> 
<p>访问<a href="http://192.168.30.113:3000/template" rel="nofollow">http://192.168.30.113:3000时报错：html/template</a>: “templates/layout” is undefined<br> 由于启动orchstrator时没有cd到go的项目路径，而是直接使用绝对路径启动：<br> /usr/local/orchestrator/orchestrator –config=/usr/local/orchestrator/orchestrator.conf.json http &amp;<br> 正确启动方式：<br> cd /usr/local/orchestrator &amp;&amp; ./orchestrator –config=./orchestrator.conf.json http &amp;</p> 
<p>glibc版本太低问题</p> 
<p>如果系统版本是centos6，运行时可能遇到如下报错：</p> 
<table><tbody><tr><td> <pre> </pre> <p>[root@mysql2 ~]# orchestrator</p> <p>orchestrator: /lib64/libc.so.6: version `GLIBC_2.14' not found (required by orchestrator)</p> <p>[root@mysql2 ~]# strings /lib64/libc.so.6 |grep GLIBC</p> <p>GLIBC_2.2.5</p> <p>GLIBC_2.2.6</p> <p>GLIBC_2.3</p> <p>GLIBC_2.3.2</p> <p>GLIBC_2.3.3</p> <p>GLIBC_2.3.4</p> <p>GLIBC_2.4</p> <p>GLIBC_2.5</p> <p>GLIBC_2.6</p> <p>GLIBC_2.7</p> <p>GLIBC_2.8</p> <p>GLIBC_2.9</p> <p>GLIBC_2.10</p> <p>GLIBC_2.11</p> <p>GLIBC_2.12</p> <p>GLIBC_PRIVATE</p> <p>[root@mysql2 ~]#</p> <p>升级glibc要非常小心，一般不建议升级。</p> <p>root@:mysql_dev:~$strings /lib64/libc.so.6 |grep GLIBC</p> <p>GLIBC_2.2.5</p> <p>GLIBC_2.2.6</p> <p>GLIBC_2.3</p> <p>GLIBC_2.3.2</p> <p>GLIBC_2.3.3</p> <p>GLIBC_2.3.4</p> <p>GLIBC_2.4</p> <p>GLIBC_2.5</p> <p>GLIBC_2.6</p> <p>GLIBC_2.7</p> <p>GLIBC_2.8</p> <p>GLIBC_2.9</p> <p>GLIBC_2.10</p> <p>GLIBC_2.11</p> <p>GLIBC_2.12</p> <p>GLIBC_2.13</p> <p>GLIBC_2.14</p> <p>GLIBC_2.15</p> <p>GLIBC_2.16</p> <p>GLIBC_2.17</p> <p>GLIBC_PRIVATE</p> <p>root@:mysql_dev:~$orchestrator --help</p> <p>Usage of orchestrator:</p> <p>-alias string</p> <p>cluster alias</p> <p>-binlog string</p> <p>Binary log file name</p> <p>-c string</p> <p>command, required. See full list of commands via 'orchestrator -c help'</p> <p>-config string</p> <p>config file name</p> <p>-d string</p> <p>destination instance, host_fqdn[:port] (synonym to -s)</p> <p>-databaseless</p> <p>EXPERIMENTAL! Work without backend database</p> <p>-debug</p> <p>debug mode (very verbose)</p> <p>-discovery</p> <p>auto discovery mode (default true)</p> <p>-duration string</p> <p>maintenance duration (format: 59s, 59m, 23h, 6d, 4w)</p> <p>-grab-election</p> <p>Grab leadership (only applies to continuous mode)</p> <p>-hostname string</p> <p>Hostname/fqdn/CNAME/VIP (applies for hostname/resolve related commands)</p> <p>-i string</p> <p>instance, host_fqdn[:port] (e.g. db.company.com:3306, db.company.com)</p> <p>-noop</p> <p>Dry run; do not perform destructing operations</p> <p>-owner string</p> <p>operation owner</p> <p>-pattern string</p> <p>regular expression pattern</p> <p>-pool string</p> <p>Pool logical name (applies for pool-related commands)</p> <p>-promotion-rule string</p> <p>Promotion rule for register-andidate (prefer|neutral|must_not) (default "prefer")</p> <p>-quiet</p> <p>quiet</p> <p>-reason string</p> <p>operation reason</p> <p>-s string</p> <p>sibling instance, host_fqdn[:port]</p> <p>-skip-unresolve</p> <p>Do not unresolve a host name</p> <p>-skip-unresolve-check</p> <p>Skip/ignore checking an unresolve mapping (via hostname_unresolve table) resolves back to same hostname</p> <p>-stack</p> <p>add stack trace upon error</p> <p>-statement string</p> <p>Statement/hint</p> <p>-strict</p> <p>strict mode (more checks, slower)</p> <p>-verbose</p> <p>verbose</p> <p>-version</p> <p>Print version and exit</p> </td></tr></tbody></table> 
<p> </p> 
<p>虚GTID问题</p> 
<p>报错：2019-03-05 10:31:52 ERROR ReadTopologyInstance(mysql-113:4406) DetectPseudoGTIDQuery: Error 1146: Table ‘meta.pseudo_gtid_status’ doesn’t exist<br> 在被管理的MySQL实例上创建Pseudo-GTID的meta库（只在主库执行即可，从库会复制过去）</p> 
<table><tbody><tr><td> <pre> </pre> <p>mysql&gt; create database meta;</p> <p>Query OK, 1 row affected (0.01 sec)</p> <p>mysql&gt; source /usr/local/orchestrator/resources/pseudo-gtid/pseudo-gtid.sql;</p> <p>Query OK, 1 row affected, 1 warning (0.00 sec)</p> <p>Database changed</p> <p>Query OK, 0 rows affected (0.01 sec)</p> <p>Query OK, 0 rows affected, 1 warning (0.00 sec)</p> <p>Query OK, 0 rows affected (0.01 sec)</p> <p>Query OK, 0 rows affected (0.00 sec)</p> <p>mysql&gt; CREATE TABLE IF NOT EXISTS cluster (</p> <p>-&gt; anchor TINYINT NOT NULL,</p> <p>-&gt; cluster_name VARCHAR(128) CHARSET ascii NOT NULL DEFAULT '',</p> <p>-&gt; cluster_domain VARCHAR(128) CHARSET ascii NOT NULL DEFAULT '',</p> <p>-&gt; PRIMARY KEY (anchor)</p> <p>-&gt; ) ENGINE=InnoDB DEFAULT CHARSET=utf8;</p> <p>Query OK, 0 rows affected (0.01 sec)</p> <p>mysql&gt; show tables;</p> <p>+--------------------+</p> <p>| Tables_in_meta |</p> <p>+--------------------+</p> <p>| cluster |</p> <p>| pseudo_gtid_status |</p> <p>+--------------------+</p> <p>2 rows in set (0.00 sec)</p> <p>mysql&gt; INSERT INTO cluster (anchor, cluster_name, cluster_domain)</p> <p>-&gt; VALUES (1, CONCAT('cls_',@@hostname), @@hostname)</p> <p>-&gt; ON DUPLICATE KEY UPDATE cluster_name=VALUES(cluster_name), cluster_domain=VALUES(cluster_domain);</p> <p>Query OK, 1 row affected (0.00 sec)</p> <p>mysql&gt; select * from cluster;</p> <p>+--------+---------------+----------------+</p> <p>| anchor | cluster_name | cluster_domain |</p> <p>+--------+---------------+----------------+</p> <p>| 1 | cls_mysql-113 | mysql-113 |</p> <p>+--------+---------------+----------------+</p> <p>1 row in set (0.00 sec)</p> </td></tr></tbody></table> 
<p> </p> 
<p>hosts没配置报错</p> 
<table><tbody><tr><td> <pre> </pre> <p>2019-02-27 11:28:43 DEBUG outdated keys: []</p> <p>2019-02-27 11:28:44 DEBUG outdated keys: [mysql1:3306 mysql2:3306 mysql3:3307]</p> <p>2019-02-27 11:28:44 ERROR dial tcp: lookup mysql3 on [::1]:53: read udp [::1]:32462-&gt;[::1]:53: read: connection refused</p> <p>2019-02-27 11:28:44 ERROR ReadTopologyInstance(mysql3:3307) show variables like 'maxscale%': dial tcp: lookup mysql3 on [::1]:53: read udp [::1]:32462-&gt;[::1]:53: read: connection refused</p> <p>2019-02-27 11:28:44 ERROR ReadTopologyInstance(mysql3:3307) Cleanup: dial tcp: lookup mysql3 on [::1]:53: read udp [::1]:19871-&gt;[::1]:53: read: connection refused</p> <p>2019-02-27 11:28:44 WARNING discoverInstance(mysql3:3307) instance is nil in 0.009s, error=Failed ReadTopologyInstance</p> <p>2019-02-27 11:28:44 DEBUG Discovered host: mysql2:3306, master: mysql1:3306, version: 5.7.20-19-log in 0.018s</p> <p>2019-02-27 11:28:44 DEBUG Discovered host: mysql1:3306, master: mysql2:3306, version: 5.7.20-19-log in 0.020s</p> <p>2019-02-27 11:28:45 DEBUG outdated keys: []</p> <p>报错：</p> <p>2019-03-05 13:31:04 DEBUG raft leader is 192.168.30.113:10008; state: Follower</p> <p>2019-03-05 13:31:07 ERROR ReadTopologyInstance(mysql1:3306) show global status like 'Uptime': dial tcp: lookup mysql1 on 127.0.0.1:53: no such host</p> <p>2019-03-05 13:31:07 ERROR ReadTopologyInstance(mysql3:3307) show global status like 'Uptime': dial tcp: lookup mysql3 on 127.0.0.1:53: no such host</p> <p>原因：域名解析问题，配置/etc/hosts解决</p> <p>解决：在orchestrator运行的机器上添加mysql的ip及对应主机名</p> <p>#orchestrator</p> <p>192.168.1.172 mysql1</p> <p>192.168.1.173 mysql2</p> <p>192.168.1.123 mysql3</p> </td></tr></tbody></table> 
<p>report-host没设置报错</p> 
<table><tbody><tr><td> <pre> </pre> <p>2019-02-26 17:15:03 DEBUG outdated keys: [mysql1:3306 mysql2:3306]</p> <p>2019-02-26 17:15:03 ERROR ReadTopologyInstance(mysql2:3306) show slave hosts: ReadTopologyInstance(mysql2:3306) 'show slave hosts' returned row with &lt;host,port&gt;: &lt;,3306&gt;</p> <p>2019-02-26 17:15:03 ERROR ReadTopologyInstance(mysql1:3306) show slave hosts: ReadTopologyInstance(mysql1:3306) 'show slave hosts' returned row with &lt;host,port&gt;: &lt;,3306&gt;</p> <p>2019-02-26 17:15:03 DEBUG Discovered host: mysql2:3306, master: mysql1:3306, version: 5.7.20-19-log in 0.018s</p> <p>2019-02-26 17:15:03 DEBUG Discovered host: mysql1:3306, master: mysql2:3306, version: 5.7.20-19-log in 0.025s</p> <p>2019-02-26 17:15:04 DEBUG outdated keys: []</p> <p>2019-02-26 17:15:05 DEBUG outdated keys: []</p> <p>解决：</p> <p>Mysql主从复制，在master上查看从的信息：show slave hosts</p> <p>http://dinglin.iteye.com/blog/1255160</p> <p>默认不记录从的host信息，只记录端口和Server_id信息，需要设置my.cnf 中的[mysqld] report-host=IP</p> <p>正常输出：</p> <p>2019-02-27 11:31:43 DEBUG outdated keys: []</p> <p>2019-02-27 11:31:44 DEBUG outdated keys: [mysql1:3306 mysql2:3306 mysql3:3307]</p> <p>2019-02-27 11:31:44 DEBUG Discovered host: mysql2:3306, master: mysql1:3306, version: 5.7.20-19-log in 0.019s</p> <p>2019-02-27 11:31:44 DEBUG Discovered host: mysql1:3306, master: mysql2:3306, version: 5.7.20-19-log in 0.023s</p> <p>2019-02-27 11:31:44 DEBUG Discovered host: mysql3:3307, master: mysql2:3306, version: 5.7.20-19-log in 0.042s</p> <p>2019-02-27 11:31:45 DEBUG outdated keys: []</p> </td></tr></tbody></table> 
<p>mysql用户权限问题</p> 
<table><tbody><tr><td> <pre> </pre> <p>2019-03-05 13:58:55 ERROR ReadTopologyInstance(mysql2:3306) show global status like 'Uptime': Error 1045: Access denied for user 'orchestrator'@'192.168.30.118' (using password: YES)</p> <p>2019-03-05 14:08:34 ERROR ReadTopologyInstance(mysql3:3307) show global status like 'Uptime': Error 1045: Access denied for user 'orchestrator'@'192.168.30.118' (using password: YES)</p> <p>2019-03-05 14:08:34 WARNING DiscoverInstance(mysql3:3307) instance is nil in 0.017s (Backend: 0.004s, Instance: 0.013s), error=Error 1045: Access denied for user 'orchestrator'@'192.168.30.118' (using password: YES)</p> <p>2019-03-05 14:08:34 ERROR ReadTopologyInstance(mysql1:3306) show global status like 'Uptime': Error 1045: Access denied for user 'orchestrator'@'192.168.30.118' (using password: YES)</p> <p>2019-03-05 14:08:34 WARNING DiscoverInstance(mysql1:3306) instance is nil in 0.023s (Backend: 0.004s, Instance: 0.019s), error=Error 1045: Access denied for user 'orchestrator'@'192.168.30.118' (using password: YES)</p> <p>2019-03-05 14:08:35 ERROR ReadTopologyInstance(mysql2:3306) show global status like 'Uptime': Error 1045: Access denied for user 'orchestrator'@'192.168.30.118' (using password: YES)</p> <p>2019-03-05 14:08:35 WARNING DiscoverInstance(mysql2:3306) instance is nil in 0.016s (Backend: 0.008s, Instance: 0.009s), error=Error 1045: Access denied for user 'orchestrator'@'192.168.30.118' (using password: YES)</p> <p>解决：由于orchestrator部署到了新的网段，需重新赋权</p> <p>mysql&gt; GRANT SELECT, RELOAD, PROCESS, SUPER, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'orchestrator'@'192.168.30.%' identified by 'abc123';</p> <p>Query OK, 0 rows affected, 1 warning (0.00 sec)</p> <p>mysql&gt; show warnings;</p> <p>+---------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</p> <p>| Level | Code | Message |</p> <p>+---------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</p> <p>| Warning | 1287 | Using GRANT statement to modify existing user's properties other than privileges is deprecated and will be removed in future release. Use ALTER USER statement for this operation. |</p> <p>+---------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</p> <p>1 row in set (0.00 sec)</p> </td></tr></tbody></table> 
<p>GTID错误跳过</p> 
<p>Problem:Errant GTID<br> replica has gtid entries not found on its master<br> 可以在页面上处理GTID错误：<br><a href="https://riverdba.github.io/2019/03/19/orchestrator/errant_gtid1.png" rel="nofollow"><img alt="图1" src="https://images2.imgbox.com/de/f2/WV9fEYVI_o.png"></a><br><a href="https://riverdba.github.io/2019/03/19/orchestrator/errant_gtid2.png" rel="nofollow" id="ui-id-3"><img alt="图2" src="https://images2.imgbox.com/fa/fa/xvCSGDCj_o.png"></a><br><a href="https://riverdba.github.io/2019/03/19/orchestrator/errant_gtid3.png" rel="nofollow" id="ui-id-2"><img alt="图3" src="https://images2.imgbox.com/cf/96/XfMMoE5v_o.png"></a><br> 然后刷新下页面就没有GTID的报错了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/96c0a725b1f071780318498225492be5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">make makefile cmake qmake都是什么，有什么区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/61c910d6013c5b42f0c8af5544425afe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">xmind怎么在左边创建_XMind位置调整的方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>