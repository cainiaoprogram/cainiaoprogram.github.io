<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32 HAL 串口理论和实例 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32 HAL 串口理论和实例" />
<meta property="og:description" content="文章目录 前言一、基本理论1、单片机通信基础2、串口通信基础串口概念RS-232串口电平与CMOS以及TTL的对比设备间的RS-232通信示意图STM32串口与电脑USB口通信示意图RS-232异步通信协议 3、UART 和 USART 的区别4、USART5、HAL库的串口机制HAL库外设初始化MSP回调机制HAL库中断回调机制USART/UART异步通信配置步骤IO引脚复用功能IO引脚复用 F4 F7 H7同步模式中断控制FIFO 操作串口频繁进入中断导致的问题 二、CubeMX 配置串口选择处理器选择连接设备的串口在GPIO Settings中设置引脚设置Parameter Settings时钟配置NVIC Settings在A-&gt;Z中找到NVIC，并按如下图配置Project Manage设置创建代码生成代码一览 HAL 串口 API汇总设计 三、案例：ESP8266 前言 因为最近老板突发奇想，想要做一个轻量级的AI工具，其他保密，我负责整理采集到的数据并上传到服务器。
趁此大好机会，赶紧复习一下串口的知识。一些和实际开发不相关的基础知识我就直接跳过了。
一、基本理论 1、单片机通信基础 同步和异步通信 波特率 常见串行通信接口 2、串口通信基础 串口概念 RS-232串口电平与CMOS以及TTL的对比 设备间的RS-232通信示意图 STM32串口与电脑USB口通信示意图 RS-232异步通信协议 3、UART 和 USART 的区别 区别点USARTUART双工模式半双工全双工速度快慢时钟信号要时钟信号和数据信号互相配合不需要兼容USART可以做到UART的功能做不到USART数据形式块形式一次一个字节复杂度复杂简单波特率不需要知道需要设置波特率变速恒速传输可变速传输 4、USART 引脚数量以及对应的引脚，可以参考MCU手册以及STM32F1硬件手册。
USART框图 设置USART/UART波特率 通过波特率计算得到要设置的寄存器参数。
将两个×16放在一起合并，简化公式。
USART寄存器介绍 通过波特率计算得到要设置的寄存器参数。
将两个×16放在一起合并，简化公式。
USART寄存器介绍 5、HAL库的串口机制 HAL库外设初始化MSP回调机制 HAL库中断回调机制 USART/UART异步通信配置步骤 IO引脚复用功能 IO引脚复用 F4 F7 H7 每一个引脚都可以选择相应的复用，对F1进行了改进
同步模式 在同步模式下连接时需要以下引脚：
SCLK：发送器时钟输出。该引脚用于输出发送器数据时钟，以便按照 SPI 主模式进行同步发送（起始位和结束位上无时钟脉冲，可通过软件向最后一个数据位发送时钟脉冲）。RX 上可同步接收并行数据。这一点可用于控制带移位寄存器的外设（如 LCD 驱动器）。时钟相位和极性可通过软件编程。在智能卡模式下，SCLK 可向智能卡提供时钟。在硬件流控制模式下需要以下引脚：
nCTS：“清除以发送”用于在当前传输结束时阻止数据发送（高电平时）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/13aa8e9f44b74aae585f4c37eb8b1702/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-28T15:12:20+08:00" />
<meta property="article:modified_time" content="2023-09-28T15:12:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32 HAL 串口理论和实例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_4" rel="nofollow">前言</a></li><li><a href="#_8" rel="nofollow">一、基本理论</a></li><li><ul><li><a href="#1_9" rel="nofollow">1、单片机通信基础</a></li><li><a href="#2_22" rel="nofollow">2、串口通信基础</a></li><li><ul><li><a href="#_23" rel="nofollow">串口概念</a></li><li><a href="#RS232CMOSTTL_25" rel="nofollow">RS-232串口电平与CMOS以及TTL的对比</a></li><li><a href="#RS232_27" rel="nofollow">设备间的RS-232通信示意图</a></li><li><a href="#STM32USB_30" rel="nofollow">STM32串口与电脑USB口通信示意图</a></li><li><a href="#RS232_32" rel="nofollow">RS-232异步通信协议</a></li></ul> 
   </li><li><a href="#3UART__USART__35" rel="nofollow">3、UART 和 USART 的区别</a></li><li><a href="#4USART_47" rel="nofollow">4、USART</a></li><li><a href="#5HAL_84" rel="nofollow">5、HAL库的串口机制</a></li><li><ul><li><a href="#HALMSP_85" rel="nofollow">HAL库外设初始化MSP回调机制</a></li><li><a href="#HAL_89" rel="nofollow">HAL库中断回调机制</a></li><li><a href="#USARTUART_92" rel="nofollow">USART/UART异步通信配置步骤</a></li><li><a href="#IO_96" rel="nofollow">IO引脚复用功能</a></li><li><a href="#IO_F4_F7_H7_99" rel="nofollow">IO引脚复用 F4 F7 H7</a></li><li><a href="#_103" rel="nofollow">同步模式</a></li><li><a href="#_109" rel="nofollow">中断控制</a></li><li><a href="#FIFO__114" rel="nofollow">FIFO 操作</a></li><li><a href="#_131" rel="nofollow">串口频繁进入中断导致的问题</a></li></ul> 
  </li></ul> 
  </li><li><a href="#CubeMX__154" rel="nofollow">二、CubeMX 配置串口</a></li><li><ul><li><a href="#_155" rel="nofollow">选择处理器</a></li><li><a href="#_159" rel="nofollow">选择连接设备的串口</a></li><li><a href="#GPIO_Settings_164" rel="nofollow">在GPIO Settings中设置引脚</a></li><li><a href="#Parameter_Settings_168" rel="nofollow">设置Parameter Settings</a></li><li><a href="#_173" rel="nofollow">时钟配置</a></li><li><a href="#NVIC_Settings_176" rel="nofollow">NVIC Settings</a></li><li><a href="#AZNVIC_179" rel="nofollow">在A-&gt;Z中找到NVIC，并按如下图配置</a></li><li><a href="#Project_Manage_182" rel="nofollow">Project Manage设置</a></li><li><a href="#_184" rel="nofollow">创建代码</a></li><li><a href="#_187" rel="nofollow">生成代码一览</a></li></ul> 
  </li><li><a href="#HAL__API_274" rel="nofollow">HAL 串口 API</a></li><li><ul><li><a href="#_424" rel="nofollow">汇总设计</a></li></ul> 
  </li><li><a href="#ESP8266_503" rel="nofollow">三、案例：ESP8266</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_4"></a>前言</h2> 
<p>因为最近老板突发奇想，想要做一个轻量级的AI工具，其他保密，我负责整理采集到的数据并上传到服务器。<br> 趁此大好机会，赶紧复习一下串口的知识。一些和实际开发不相关的基础知识我就直接跳过了。</p> 
<h2><a id="_8"></a>一、基本理论</h2> 
<h3><a id="1_9"></a>1、单片机通信基础</h3> 
<ol><li>同步和异步通信</li></ol> 
<p><img src="https://images2.imgbox.com/63/9f/XTvyJg5w_o.png" alt="在这里插入图片描述"></p> 
<ol start="2"><li>波特率</li></ol> 
<p><img src="https://images2.imgbox.com/8d/3a/c3sjfjQJ_o.png" alt="在这里插入图片描述"></p> 
<ol start="3"><li>常见串行通信接口</li></ol> 
<p><img src="https://images2.imgbox.com/32/70/XgKea4xf_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_22"></a>2、串口通信基础</h3> 
<h4><a id="_23"></a>串口概念</h4> 
<p><img src="https://images2.imgbox.com/1c/da/ZofQGOlJ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="RS232CMOSTTL_25"></a>RS-232串口电平与CMOS以及TTL的对比</h4> 
<p><img src="https://images2.imgbox.com/19/02/VHrChzzu_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="RS232_27"></a>设备间的RS-232通信示意图</h4> 
<p><img src="https://images2.imgbox.com/c0/32/erNA3izY_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="STM32USB_30"></a>STM32串口与电脑USB口通信示意图</h4> 
<p><img src="https://images2.imgbox.com/ca/5c/m23YHJxw_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="RS232_32"></a>RS-232异步通信协议</h4> 
<p><img src="https://images2.imgbox.com/82/95/u009WAl6_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3UART__USART__35"></a>3、UART 和 USART 的区别</h3> 
<table><thead><tr><th>区别点</th><th>USART</th><th>UART</th></tr></thead><tbody><tr><td>双工模式</td><td>半双工</td><td>全双工</td></tr><tr><td>速度</td><td>快</td><td>慢</td></tr><tr><td>时钟信号</td><td>要时钟信号和数据信号互相配合</td><td>不需要</td></tr><tr><td>兼容</td><td>USART可以做到UART的功能</td><td>做不到USART</td></tr><tr><td>数据形式</td><td>块形式</td><td>一次一个字节</td></tr><tr><td>复杂度</td><td>复杂</td><td>简单</td></tr><tr><td>波特率</td><td>不需要知道</td><td>需要设置波特率</td></tr><tr><td>变速</td><td>恒速传输</td><td>可变速传输</td></tr></tbody></table> 
<h3><a id="4USART_47"></a>4、USART</h3> 
<p><img src="https://images2.imgbox.com/a2/df/SmyE9gZQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/53/4d/djVB3vkB_o.png" alt="在这里插入图片描述"><br> 引脚数量以及对应的引脚，可以参考MCU手册以及STM32F1硬件手册。</p> 
<ol><li>USART框图</li></ol> 
<p><img src="https://images2.imgbox.com/de/38/zhVsAv8N_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bd/8d/0wqHiVpF_o.png" alt="在这里插入图片描述"></p> 
<ol start="2"><li>设置USART/UART波特率</li></ol> 
<p><img src="https://images2.imgbox.com/db/cc/49o0d4JA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/00/54/jwMndRPs_o.png" alt="在这里插入图片描述"><br> 通过波特率计算得到要设置的寄存器参数。<br> <img src="https://images2.imgbox.com/0e/98/8oCQWTDb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/79/2a/Dl2lE6Kn_o.png" alt="在这里插入图片描述"><br> 将两个×16放在一起合并，简化公式。</p> 
<ol start="3"><li>USART寄存器介绍</li></ol> 
<p><img src="https://images2.imgbox.com/e1/28/VezALhB6_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2e/bf/62nwCHGW_o.png" alt="在这里插入图片描述"><br> 通过波特率计算得到要设置的寄存器参数。<br> <img src="https://images2.imgbox.com/18/0d/xEIMRhWl_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/12/81/EJ5E4Cas_o.png" alt="在这里插入图片描述"><br> 将两个×16放在一起合并，简化公式。</p> 
<ol start="4"><li>USART寄存器介绍</li></ol> 
<p><img src="https://images2.imgbox.com/8a/d5/2HQxcDbe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3f/2c/btQj6eYh_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/08/ff/QYvJhzqI_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6a/2e/0ppStQ3N_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/43/03/mfy3x08n_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f8/71/QrR8pZx9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5HAL_84"></a>5、HAL库的串口机制</h3> 
<h4><a id="HALMSP_85"></a>HAL库外设初始化MSP回调机制</h4> 
<p><img src="https://images2.imgbox.com/25/09/aHqgTMUJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/13/90/9XtRjbr5_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="HAL_89"></a>HAL库中断回调机制</h4> 
<p><img src="https://images2.imgbox.com/79/00/Yt7068r7_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4c/0b/JqHsKmbx_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="USARTUART_92"></a>USART/UART异步通信配置步骤</h4> 
<p><img src="https://images2.imgbox.com/b6/1a/XRP6FBD7_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/70/4e/xmIBqSSQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/41/96/YnpJcVHq_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="IO_96"></a>IO引脚复用功能</h4> 
<p><img src="https://images2.imgbox.com/c4/87/54I9ggU9_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3e/f5/D8PjeD1J_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="IO_F4_F7_H7_99"></a>IO引脚复用 F4 F7 H7</h4> 
<p>每一个引脚都可以选择相应的复用，对F1进行了改进<br> <img src="https://images2.imgbox.com/c8/e5/1sl1nhoJ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_103"></a>同步模式</h4> 
<p>在同步模式下连接时需要以下引脚：<br> SCLK：发送器时钟输出。该引脚用于输出发送器数据时钟，以便按照 SPI 主模式进行同步发送（起始位和结束位上无时钟脉冲，可通过软件向最后一个数据位发送时钟脉冲）。RX 上可同步接收并行数据。这一点可用于控制带移位寄存器的外设（如 LCD 驱动器）。时钟相位和极性可通过软件编程。在智能卡模式下，SCLK 可向智能卡提供时钟。在硬件流控制模式下需要以下引脚：<br> nCTS：“清除以发送”用于在当前传输结束时阻止数据发送（高电平时）。<br> nRTS：“请求以发送”用于指示 USART 已准备好接收数据（低电平时）。</p> 
<h4><a id="_109"></a>中断控制</h4> 
<p>出现以下情况时，可使UART 产生中断：<br> <img src="https://images2.imgbox.com/e1/fc/7tLRKcdu_o.png" alt="在这里插入图片描述"><br> 由于所有中断事件在发送到中断控制器之前会一起进行“或运算”操作，所以任意时刻 UART 只能向中断产生一个中断请求。通过查询中断状态函数，软件可以在同一个中断服务函数里处理多个中断事件（多个并列的if 语句）。</p> 
<h4><a id="FIFO__114"></a>FIFO 操作</h4> 
<p>Stellaris 系列ARM 的UART 模块包含有2 个16 字节的FIFO：一个用于发送，另一个用于接收。可以将两个FIFO 分别配置为以不同深度触发中断。可供选择的配置包括：1/8、 1/4、1/2、3/4 和7/8 深度。例如，如果接收FIFO 选择1/4，则在UART 接收到4 个数据时产生接收中断。</p> 
<ol><li>发送FIFO的基本工作过程</li></ol> 
<p>只要有数据填充到发送FIFO 里，就会立即启动发送过程。由于发送本身是个相对缓慢的过程，因此在发送的同时其它需要发送的数据还可以继续填充到发送 FIFO 里。当发送 FIFO 被填满时就不能再继续填充了，否则会造成数据丢失，此时只能等待。这个等待并不会很久，以9600 的波特率为例，等待出现一个空位的时间在1ms 上下。发送 FIFO 会按照填入数据的先后顺序把数据一个个发送出去，直到发送 FIFO 全空时为止。已发送完毕的数据会被自动清除，在发送FIFO 里同时会多出一个空位。</p> 
<ol start="2"><li>接收FIFO的基本工作过程</li></ol> 
<p>当硬件逻辑接收到数据时，就会往接收FIFO 里填充接收到的数据。程序应当及时取走这些数据，数据被取走也是在接收FIFO 里被自动删除的过程，因此在接收 FIFO 里同时会多出一个空位。如果在接收 FIFO 里的数据未被及时取走而造成接收FIFO 已满，则以后再接收到数据时因无空位可以填充而造成数据丢失。</p> 
<ol start="3"><li>FIFO解决的问题</li></ol> 
<p>收发FIFO 主要是为了解决UART 收发中断过于频繁而导致CPU 效率不高的问题而引入的。在进行 UART 通信时，中断方式比轮询方式要简便且效率高。但是，如果没有收发 FIFO，则每收发一个数据都要中断处理一次，效率仍然不够高。如果有了收发FIFO，则可以在连续收发若干个数据（可多至14 个）后才产生一次中断然后一并处理，这就大大提高了收发效率。<br> 完全不必要担心FIFO 机制可能带来的数据丢失或得不到及时处理的问题，因为它已经帮你想到了收发过程中存在的任何问题，只要在初始化配置UART 后，就可以放心收发了， FIFO 和中断例程会自动搞定一切。</p> 
<h4><a id="_131"></a>串口频繁进入中断导致的问题</h4> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>         
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_FLAG_ORE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">USART_ClearFlag</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_FLAG_ORE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>USART_IT_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET <span class="token punctuation">)</span>    
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">USART_ClearITPendingBit</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>USART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token function">USART_ClearFlag</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>USART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Uart1_Val<span class="token punctuation">.</span>Real_Data <span class="token operator">=</span> <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span> USART1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Uart1_IT_Reci_Fuc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="CubeMX__154"></a>二、CubeMX 配置串口</h2> 
<h3><a id="_155"></a>选择处理器</h3> 
<p><img src="https://images2.imgbox.com/4e/ec/iI4lawoE_o.png" alt="在这里插入图片描述"><br> 我这里项目用的是 H750ZBT6 的芯片</p> 
<h3><a id="_159"></a>选择连接设备的串口</h3> 
<p><img src="https://images2.imgbox.com/11/d2/F96PJ8R3_o.png" alt="在这里插入图片描述"><br> 设置为异步通信、不使用硬件流控制。<br> 可以发现另一侧的芯片引脚图上的引脚自动显示为 USART 的 TX、RX 引脚了：<br> <img src="https://images2.imgbox.com/4c/75/P5NaaFxr_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="GPIO_Settings_164"></a>在GPIO Settings中设置引脚</h3> 
<p><img src="https://images2.imgbox.com/a3/af/0Fnvfq2s_o.png" alt="在这里插入图片描述"><br> 修改为快速输出和上拉电阻之后，modify 标志位会自动更新。</p> 
<h3><a id="Parameter_Settings_168"></a>设置Parameter Settings</h3> 
<p>设置波特率115200，8位字长，无奇偶校验位，1个停止位，接受和发送均开启，过采样8位；<br> <img src="https://images2.imgbox.com/44/f8/lAVlgIZ1_o.png" alt="在这里插入图片描述"><br> FIFO开了也没问题，开了效果更好。</p> 
<h3><a id="_173"></a>时钟配置</h3> 
<p>当你选择了波特率之后，时钟会自动调整为符合波特率的分频系数：<br> <img src="https://images2.imgbox.com/cc/e7/sz4N9ttO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="NVIC_Settings_176"></a>NVIC Settings</h3> 
<p>在NVIC Settings中USART2 global interrupt勾选Enable：<br> <img src="https://images2.imgbox.com/08/56/GM3sddqZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="AZNVIC_179"></a>在A-&gt;Z中找到NVIC，并按如下图配置</h3> 
<p>继续用到了中断，那么就一定要设置中断控制器 NVIC 。<br> <img src="https://images2.imgbox.com/b5/18/EQak8DWK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Project_Manage_182"></a>Project Manage设置</h3> 
<p><img src="https://images2.imgbox.com/08/fc/6jwiCjsW_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_184"></a>创建代码</h3> 
<p>在创建的工程中找到main.c就会有串口初始化代码：<br> <img src="https://images2.imgbox.com/f8/ad/bQbWhuIc_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_187"></a>生成代码一览</h3> 
<p>初始化函数</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">MX_USART2_UART_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

  <span class="token comment">/* USER CODE BEGIN USART2_Init 0 */</span>

  <span class="token comment">/* USER CODE END USART2_Init 0 */</span>

  <span class="token comment">/* USER CODE BEGIN USART2_Init 1 */</span>

  <span class="token comment">/* USER CODE END USART2_Init 1 */</span>
  huart2<span class="token punctuation">.</span>Instance <span class="token operator">=</span> USART2<span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>BaudRate <span class="token operator">=</span> <span class="token number">115200</span><span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>WordLength <span class="token operator">=</span> UART_WORDLENGTH_8B<span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>StopBits <span class="token operator">=</span> UART_STOPBITS_1<span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Parity <span class="token operator">=</span> UART_PARITY_NONE<span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> UART_MODE_TX_RX<span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>HwFlowCtl <span class="token operator">=</span> UART_HWCONTROL_NONE<span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>OverSampling <span class="token operator">=</span> UART_OVERSAMPLING_8<span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>OneBitSampling <span class="token operator">=</span> UART_ONE_BIT_SAMPLE_DISABLE<span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ClockPrescaler <span class="token operator">=</span> UART_PRESCALER_DIV1<span class="token punctuation">;</span>
  huart2<span class="token punctuation">.</span>AdvancedInit<span class="token punctuation">.</span>AdvFeatureInit <span class="token operator">=</span> UART_ADVFEATURE_NO_INIT<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_UARTEx_SetTxFifoThreshold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> UART_TXFIFO_THRESHOLD_1_8<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_UARTEx_SetRxFifoThreshold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> UART_RXFIFO_THRESHOLD_1_8<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_UARTEx_DisableFifoMode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>在stm32h7xx_hal_msp.c中可以看到USART2的回调函数</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>UART_HandleTypeDef<span class="token operator">*</span> huart<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  GPIO_InitTypeDef GPIO_InitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  RCC_PeriphCLKInitTypeDef PeriphClkInitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance<span class="token operator">==</span>USART2<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN USART2_MspInit 0 */</span>
  <span class="token comment">/* USER CODE END USART2_MspInit 0 */</span>
  <span class="token comment">/* Initializes the peripherals clock
 */</span>
    PeriphClkInitStruct<span class="token punctuation">.</span>PeriphClockSelection <span class="token operator">=</span> RCC_PERIPHCLK_USART2<span class="token punctuation">;</span>
    PeriphClkInitStruct<span class="token punctuation">.</span>Usart234578ClockSelection <span class="token operator">=</span> RCC_USART234578CLKSOURCE_D2PCLK1<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_RCCEx_PeriphCLKConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PeriphClkInitStruct<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Peripheral clock enable */</span>
    <span class="token function">__HAL_RCC_USART2_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**USART2 GPIO Configuration
    PA2     ------&gt; USART2_TX
    PA3     ------&gt; USART2_RX
    */</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_2<span class="token operator">|</span>GPIO_PIN_3<span class="token punctuation">;</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_VERY_HIGH<span class="token punctuation">;</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Alternate <span class="token operator">=</span> GPIO_AF7_USART2<span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* USART2 interrupt Init */</span>
    <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART2_IRQn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART2_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE BEGIN USART2_MspInit 1 */</span>
    <span class="token comment">/* USER CODE END USART2_MspInit 1 */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>生成的代码真的不行，还是得继续优化优化。</p> 
<h2><a id="HAL__API_274"></a>HAL 串口 API</h2> 
<ol><li>串口初始化（波特率/停止位/使能串口）</li></ol> 
<pre><code class="prism language-c">HAL_StatusTypeDef <span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数：串口句柄</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
 USART_TypeDef               <span class="token operator">*</span>Instance<span class="token punctuation">;</span>     <span class="token comment">//执行寄存器基地址，HAL库已定义，若为串口1，取值为 USART1 </span>
 UART_InitTypeDef            Init<span class="token punctuation">;</span>          <span class="token comment">//设置串口各个参数，下面有结构体</span>
 UART_AdvFeatureInitTypeDef  AdvancedInit<span class="token punctuation">;</span> 
 <span class="token class-name">uint8_t</span>                     <span class="token operator">*</span>pTxBuffPtr<span class="token punctuation">;</span>   <span class="token comment">//发送数据缓存指针</span>
 <span class="token class-name">uint16_t</span>                    TxXferSize<span class="token punctuation">;</span>    <span class="token comment">//发送数据量</span>
 __IO <span class="token class-name">uint16_t</span>               TxXferCount<span class="token punctuation">;</span>   <span class="token comment">//剩余发送数据量</span>
 <span class="token class-name">uint8_t</span>                     <span class="token operator">*</span>pRxBuffPtr<span class="token punctuation">;</span>   <span class="token comment">//接收数据缓存指针</span>
 <span class="token class-name">uint16_t</span>                    RxXferSize<span class="token punctuation">;</span>    <span class="token comment">//单次最大接收量</span>
 __IO <span class="token class-name">uint16_t</span>               RxXferCount<span class="token punctuation">;</span>   <span class="token comment">//剩余要接收的数据量</span>
 <span class="token class-name">uint16_t</span>                    Mask<span class="token punctuation">;</span>          <span class="token comment">//</span>
 DMA_HandleTypeDef           <span class="token operator">*</span>hdmatx<span class="token punctuation">;</span>       <span class="token comment">//DMA发送句柄</span>
 DMA_HandleTypeDef           <span class="token operator">*</span>hdmarx<span class="token punctuation">;</span>       <span class="token comment">//DMA接收句柄</span>
 HAL_LockTypeDef             Lock<span class="token punctuation">;</span> 
 __IO HAL_UART_StateTypeDef  gState<span class="token punctuation">;</span> 
 __IO HAL_UART_StateTypeDef  RxState<span class="token punctuation">;</span> 
 __IO <span class="token class-name">uint32_t</span>               ErrorCode<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>UART_HandleTypeDef<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token class-name">uint32_t</span> BaudRate<span class="token punctuation">;</span>        <span class="token comment">//波特率</span>
 <span class="token class-name">uint32_t</span> WordLength<span class="token punctuation">;</span>      <span class="token comment">//字长，一般是8位：8 位字长数据格式 UART_WORDLENGTH_8B</span>
 <span class="token class-name">uint32_t</span> StopBits<span class="token punctuation">;</span>        <span class="token comment">//停止位，一般是一位：UART_STOPBITS_1</span>
 <span class="token class-name">uint32_t</span> Parity<span class="token punctuation">;</span>          <span class="token comment">//奇偶校验</span>
 <span class="token class-name">uint32_t</span> Mode<span class="token punctuation">;</span>            <span class="token comment">//收/发模式设置，全双工：UART_MODE_TX_RX</span>
 <span class="token class-name">uint32_t</span> HwFlowCtl<span class="token punctuation">;</span>       <span class="token comment">//硬件流设置</span>
 <span class="token class-name">uint32_t</span> OverSampling<span class="token punctuation">;</span>    <span class="token comment">//过采样设置，一般过采样为 16 倍或 8 倍</span>
 <span class="token class-name">uint32_t</span> OneBitSampling<span class="token punctuation">;</span>  <span class="token comment">//一位采样</span>
 <span class="token class-name">uint32_t</span> Prescaler<span class="token punctuation">;</span>       <span class="token comment">//分频</span>
 <span class="token class-name">uint32_t</span> FIFOMode<span class="token punctuation">;</span>        <span class="token comment">//FIFO 模式</span>
 <span class="token class-name">uint32_t</span> TXFIFOThreshold<span class="token punctuation">;</span> <span class="token comment">//发送 FIFO 阈值</span>
 <span class="token class-name">uint32_t</span> RXFIFOThreshold<span class="token punctuation">;</span> <span class="token comment">//接受 FIFO 阈值</span>
<span class="token punctuation">}</span>UART_InitTypeDef
</code></pre> 
<p>调用函数 HAL_UART_Init<br> 对串口进行初始化的时候，需要先设置 Instance 和 Init 两个成员变量的值。</p> 
<p>函数 HAL_UART_Init 使用的一般格式为：</p> 
<pre><code class="prism language-c"><span class="token comment">//UART 初始化设置</span>
UART1_Handler<span class="token punctuation">.</span>Instance<span class="token operator">=</span>USART1<span class="token punctuation">;</span> <span class="token comment">//USART1</span>
UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>BaudRate<span class="token operator">=</span>bound<span class="token punctuation">;</span> <span class="token comment">//波特率</span>
UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>WordLength<span class="token operator">=</span>UART_WORDLENGTH_8B<span class="token punctuation">;</span> <span class="token comment">//字长为 8 位</span>
UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>StopBits<span class="token operator">=</span>UART_STOPBITS_1<span class="token punctuation">;</span> <span class="token comment">//一个停止位</span>
UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Parity<span class="token operator">=</span>UART_PARITY_NONE<span class="token punctuation">;</span> <span class="token comment">//无奇偶校验位</span>
UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>HwFlowCtl<span class="token operator">=</span>UART_HWCONTROL_NONE<span class="token punctuation">;</span> <span class="token comment">//无硬件流控</span>
UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode<span class="token operator">=</span>UART_MODE_TX_RX<span class="token punctuation">;</span> <span class="token comment">//收发模式</span>
<span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UART1_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>HAL_UART_Init 内部会调用串口使能函数使能相应串口，<br> 所以调用了该函数之后我们就不需要重复使能串口了。当然，HAL 库也提供了具体的串口使能和关闭方法，具体使用方法如下：</p> 
<pre><code class="prism language-c"><span class="token function">__HAL_UART_ENABLE</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能句柄 handler 指定的串口</span>
<span class="token function">__HAL_UART_DISABLE</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭句柄 handler 指定的串口</span>
</code></pre> 
<p>这里还需要提醒大家，串口作为一个重要外设，在调用的初始化函数 HAL_UART_Init 内部，会先调用 MSP 初始化回调函数进行 MCU 相关的初始化，函数为：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们在程序中，只需要重写该函数即可。一般情况下，该函数内部用来编写 IO 口初始化，时钟使能以及 NVIC 配置。</p> 
<ol start="2"><li>使能串口和GPIO时钟</li></ol> 
<pre><code class="prism language-c"><span class="token function">__HAL_RCC_USART1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能 USART1 时钟</span>
<span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//使能 GPIOA 时钟</span>
</code></pre> 
<ol start="3"><li>GPIO 口初始化设置（速度，上下拉等）以及复用映射配置</li></ol> 
<p>HAL 库中 IO 口初始化参数设置和复用映射配置是在函数<br> HAL_GPIO_Init 中一次性完成。<br> 这里要复用 PA9 和 PA10 为串口发送接收相关引脚，我们需要配置 IO 口为复用，同时复用映射到串口 1。</p> 
<pre><code class="prism language-c">GPIO_InitTypeDef GPIO_Initure<span class="token punctuation">;</span>
GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_9<span class="token operator">|</span>GPIO_PIN_10<span class="token punctuation">;</span>  <span class="token comment">//PA9/PA10</span>
GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_AF_PP<span class="token punctuation">;</span>        <span class="token comment">//复用推挽输出</span>
GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_PULLUP<span class="token punctuation">;</span>            <span class="token comment">//上拉</span>
GPIO_Initure<span class="token punctuation">.</span>Speed<span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span> <span class="token comment">//高速</span>
GPIO_Initure<span class="token punctuation">.</span>Alternate<span class="token operator">=</span>GPIO_AF7_USART1<span class="token punctuation">;</span>   <span class="token comment">//复用为 USART1</span>
<span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//初始化 PA9/PA10</span>
</code></pre> 
<ol start="4"><li>开启串口相关中断，配置串口中断优先级</li></ol> 
<p>HAL 库中定义了一个使能串口中断的标识符 __HAL_UART_ENABLE_IT，可以把它当一个函数来使用，例如我要使能接收完成中断：</p> 
<pre><code class="prism language-c"><span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开启接收完成中断</span>
</code></pre> 
<p>huart 是串口句柄，UART_HandleTypeDef 类型。<br> UART_IT_RXNE 是我们要开启的中断类型值，可选值在头文件 stm32h7xx_hal_uart.h 中有宏定义。<br> 有开启中断就有关闭中断，操作方法为：</p> 
<pre><code class="prism language-c"><span class="token function">__HAL_UART_DISABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span>UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭接收完成中断</span>
</code></pre> 
<p>对于中断优先级配置，方法就非常简单，详细知识情参考 4.5 小节相关知识。参考方法为：</p> 
<pre><code class="prism language-c"><span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//使能 USART1 中断通道</span>
<span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//抢占优先级 3，子优先级 3</span>
</code></pre> 
<ol start="5"><li>中断服务函数</li></ol> 
<p>串口 1 中断服务函数为：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
</code></pre> 
<p>当发生中断的时候，程序就会执行中断服务函数。然后我们在中断服务函数中编写们相应的逻辑代码即可。HAL 库实际上对中断处理过程进行了完整的封装。</p> 
<ol start="6"><li>串口数据接收和发送</li></ol> 
<p>STM32H7 的发送与接收是通过数据寄存器 USART_DR 来实现的，这是一个双寄存器，包<br> 含了 TDR 和 RDR。当向该寄存器写数据的时候，串口就会自动发送，当收到数据的时候，也<br> 是存在该寄存器内。HAL 库操作 USART_DR 寄存器发送数据的函数是：</p> 
<pre><code class="prism language-c">HAL_StatusTypeDef <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> 
                                    <span class="token class-name">uint8_t</span>            <span class="token operator">*</span>pData<span class="token punctuation">,</span> 
                                    <span class="token class-name">uint16_t</span>           Size<span class="token punctuation">,</span> 
                                    <span class="token class-name">uint32_t</span>           Timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>通过该函数向串口寄存器 USART_DR 写入一个数据。<br> HAL 库操作 USART_DR 寄存器读取串口接收到的数据的函数是：</p> 
<pre><code class="prism language-c">HAL_StatusTypeDef <span class="token function">HAL_UART_Receive</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> 
                                   <span class="token class-name">uint8_t</span>            <span class="token operator">*</span>pData<span class="token punctuation">,</span> 
                                   <span class="token class-name">uint16_t</span>           Size<span class="token punctuation">,</span> 
                                   <span class="token class-name">uint32_t</span>           Timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>通过该函数可以读取串口接受到的数据。</p> 
<h3><a id="_424"></a>汇总设计</h3> 
<pre><code class="prism language-c"><span class="token comment">//初始化 IO 串口 1 ; bound:波特率</span>
<span class="token keyword">void</span> <span class="token function">uart_init</span><span class="token punctuation">(</span>u32 bound<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//UART 初始化设置</span>
    UART1_Handler<span class="token punctuation">.</span>Instance<span class="token operator">=</span>USART1<span class="token punctuation">;</span>                    <span class="token comment">//USART1</span>
    UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>BaudRate<span class="token operator">=</span>bound<span class="token punctuation">;</span>                <span class="token comment">//波特率</span>
    UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>WordLength<span class="token operator">=</span>UART_WORDLENGTH_8B<span class="token punctuation">;</span> <span class="token comment">//字长为 8 位</span>
    UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>StopBits<span class="token operator">=</span>UART_STOPBITS_1<span class="token punctuation">;</span>      <span class="token comment">//一个停止位</span>
    UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Parity<span class="token operator">=</span>UART_PARITY_NONE<span class="token punctuation">;</span>       <span class="token comment">//无奇偶校验位</span>
    UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>HwFlowCtl<span class="token operator">=</span>UART_HWCONTROL_NONE<span class="token punctuation">;</span> <span class="token comment">//无硬件流控</span>
    UART1_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode<span class="token operator">=</span>UART_MODE_TX_RX<span class="token punctuation">;</span>          <span class="token comment">//收发模式</span>
    <span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UART1_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//HAL_UART_Init()会使能 UART1</span>

    <span class="token comment">//该函数会开启接收中断：标志位 UART_IT_RXNE，同时设置接收缓冲以及接收缓冲接收最大数据量</span>
    <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UART1_Handler<span class="token punctuation">,</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>aRxBuffer<span class="token punctuation">,</span>RXBUFFERSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//GPIO 端口设置</span>
    GPIO_InitTypeDef GPIO_Initure<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance<span class="token operator">==</span>USART1<span class="token punctuation">)</span><span class="token comment">//如果是串口 1，进行串口 1 MSP 初始化</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//使能 GPIOA 时钟</span>
        <span class="token function">__HAL_RCC_USART1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//使能 USART1 时钟</span>
        GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_9<span class="token punctuation">;</span>             <span class="token comment">//PA9</span>
        GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_AF_PP<span class="token punctuation">;</span>       <span class="token comment">//复用推挽输出</span>
        GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_PULLUP<span class="token punctuation">;</span>           <span class="token comment">//上拉</span>
        GPIO_Initure<span class="token punctuation">.</span>Speed<span class="token operator">=</span>GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span> <span class="token comment">//高速</span>
        GPIO_Initure<span class="token punctuation">.</span>Alternate<span class="token operator">=</span>GPIO_AF7_USART1<span class="token punctuation">;</span>  <span class="token comment">//复用为 USART1</span>
        <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//初始化 PA9</span>
        GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_10<span class="token punctuation">;</span>            <span class="token comment">//PA10</span>
        <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//初始化 PA10</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">EN_USART1_RX</span></span>
        <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//使能 USART1 中断通道</span>
        <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//抢占优先级 3，子优先级 3</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 通过判断宏定义标识符 EN_USART1_RX 的值来确定是否开启串口中断通道和设置串口1 中断优先级。
 * 标识符 EN_USART1_RX 在头文件 usart.h 中有定义，默认情况下我们设置为1。
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EN_USART1_RX</span> <span class="token expression"><span class="token number">1</span>     </span><span class="token comment">//使能（1）/禁止（0）串口 1 接收</span></span>

<span class="token comment">//编写中断服务函数</span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span> 
    <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UART1_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//调用 HAL 库中断处理公用函数</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                                 <span class="token comment">//中断处理完成后的结束工作</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对于中断服务函数中的 HAL_UART_IRQHandler() 在 HAL 库中已经实现了，如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token class-name">uint32_t</span> isrflags <span class="token operator">=</span> <span class="token function">READ_REG</span><span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance<span class="token operator">-&gt;</span>ISR<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">uint32_t</span> cr1its <span class="token operator">=</span> <span class="token function">READ_REG</span><span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance<span class="token operator">-&gt;</span>CR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">uint32_t</span> cr3its <span class="token operator">=</span> <span class="token function">READ_REG</span><span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance<span class="token operator">-&gt;</span>CR3<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">uint32_t</span> errorflags<span class="token punctuation">;</span>
 …<span class="token comment">//此处省略部分代码</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>errorflags <span class="token operator">==</span> RESET<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>isrflags <span class="token operator">&amp;</span> USART_ISR_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
        <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr1its <span class="token operator">&amp;</span> USART_CR1_RXNEIE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr3its <span class="token operator">&amp;</span> USART_CR3_RXFTIE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token function">UART_Receive_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> …<span class="token comment">//此处省略部分代码</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>HAL_UART_IRQHandler 内部通过判断中断类型是否为接收完成中断，确定是否调用 HAL 另外一个函数 UART_Receive_IT()。函数 UART_Receive_IT()的作用是把每次中断接收到的字符保存在串口句柄的缓存指针 pRxBuffPtr 中，同时每次接收一个字符，其计数器 RxXferCount 减 1，直到接收完成 RxXferSize 个字符之后 RxXferCount 设置为 0，同时调用接收完成回调函数 HAL_UART_RxCpltCallback 进行处理。<br> 串口接收中断的一般流程：<br> <img src="https://images2.imgbox.com/0e/a8/CO3iICc8_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="ESP8266_503"></a>三、案例：ESP8266</h2> 
<pre><code class="prism language-c"><span class="token keyword">static</span> ESP_T gEsp <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> UART_HandleTypeDef   gUART2  <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 功能描述: ESP模块初始化</span>
<span class="token class-name">int32_t</span> <span class="token function">ESP_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef tGPIO<span class="token punctuation">;</span>

    <span class="token function">__HAL_RCC_USART2_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//TX</span>
    tGPIO<span class="token punctuation">.</span>Pin        <span class="token operator">=</span> GPIO_PIN_2<span class="token punctuation">;</span>
    tGPIO<span class="token punctuation">.</span>Mode       <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>
    tGPIO<span class="token punctuation">.</span>Pull       <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>
    tGPIO<span class="token punctuation">.</span>Speed      <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>
    tGPIO<span class="token punctuation">.</span>Alternate  <span class="token operator">=</span> GPIO_AF7_USART2<span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tGPIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//RX</span>
    tGPIO<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_3<span class="token punctuation">;</span>
    tGPIO<span class="token punctuation">.</span>Alternate  <span class="token operator">=</span> GPIO_AF7_USART2<span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tGPIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART2_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART2_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gUART2<span class="token punctuation">.</span>Instance                      <span class="token operator">=</span> USART2<span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>BaudRate                 <span class="token operator">=</span> <span class="token number">115200</span><span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>WordLength               <span class="token operator">=</span> UART_WORDLENGTH_8B<span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>StopBits                 <span class="token operator">=</span> UART_STOPBITS_1<span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Parity                   <span class="token operator">=</span> UART_PARITY_NONE<span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode                     <span class="token operator">=</span> UART_MODE_TX_RX<span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>HwFlowCtl                <span class="token operator">=</span> UART_HWCONTROL_NONE<span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>OverSampling             <span class="token operator">=</span> UART_OVERSAMPLING_16<span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>OneBitSampling           <span class="token operator">=</span> UART_ONE_BIT_SAMPLE_DISABLE<span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ClockPrescaler           <span class="token operator">=</span> UART_PRESCALER_DIV1<span class="token punctuation">;</span>
    gUART2<span class="token punctuation">.</span>AdvancedInit<span class="token punctuation">.</span>AdvFeatureInit   <span class="token operator">=</span> UART_ADVFEATURE_NO_INIT<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_UARTEx_SetTxFifoThreshold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">,</span> UART_TXFIFO_THRESHOLD_1_8<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_UARTEx_SetRxFifoThreshold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">,</span> UART_RXFIFO_THRESHOLD_1_8<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_UARTEx_DisableFifoMode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gEsp<span class="token punctuation">.</span>bRxData<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ESP_ExitTransmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">ESP_ConnectAP</span><span class="token punctuation">(</span>CFG_SSID<span class="token punctuation">,</span> CFG_PASSWORD<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">ESP_ConnectServer</span><span class="token punctuation">(</span>CFG_IP<span class="token punctuation">,</span> CFG_PORT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************************
* 功能描述: 中断接收处理
* 输入参数: void
* 输出参数: void
* 返 回 值: void
****************************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">USART2_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> iCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_UART_GetState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_UART_STATE_READY<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        iCnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>iCnt <span class="token operator">&gt;</span> <span class="token number">0x1FFFF</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    iCnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gEsp<span class="token punctuation">.</span>bRxData<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        iCnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>iCnt <span class="token operator">&gt;</span> <span class="token number">0x1FFFF</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>iCnt <span class="token operator">&gt;=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>aBuf<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        gEsp<span class="token punctuation">.</span>iCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gEsp<span class="token punctuation">.</span>aBuf<span class="token punctuation">[</span>gEsp<span class="token punctuation">.</span>iCnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> gEsp<span class="token punctuation">.</span>bRxData<span class="token punctuation">;</span>
    <span class="token comment">//Shell_Putc(gEsp.bRxData);</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>iCnt <span class="token operator">&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        gEsp<span class="token punctuation">.</span>iState  <span class="token operator">=</span> <span class="token function">ESP_GetAckSta</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>aBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>iState <span class="token operator">!=</span> AT_ACK_UNKNOW<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>iState <span class="token operator">!=</span> AT_ACK_BUSY<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            gEsp<span class="token punctuation">.</span>pCmd <span class="token operator">=</span> <span class="token function">ESP_GetAckAt</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>aBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ESP_Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            gEsp<span class="token punctuation">.</span>iCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>aBuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>aBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//中断接收处理</span>
<span class="token keyword">void</span> <span class="token function">USART2_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> iCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_UART_GetState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_UART_STATE_READY<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        iCnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>iCnt <span class="token operator">&gt;</span> <span class="token number">0x1FFFF</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    iCnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gEsp<span class="token punctuation">.</span>bRxData<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        iCnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>iCnt <span class="token operator">&gt;</span> <span class="token number">0x1FFFF</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>iCnt <span class="token operator">&gt;=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>aBuf<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        gEsp<span class="token punctuation">.</span>iCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gEsp<span class="token punctuation">.</span>aBuf<span class="token punctuation">[</span>gEsp<span class="token punctuation">.</span>iCnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> gEsp<span class="token punctuation">.</span>bRxData<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//发送 AT 指令</span>
<span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">ESP_SendCmd</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pCmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>pCmd<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pCmd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">__HAL_UART_GET_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gUART2<span class="token punctuation">,</span> UART_FLAG_TC<span class="token punctuation">)</span><span class="token operator">!=</span>SET<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//等待串口回应</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AT_ACK_ERROR</span>    <span class="token expression"><span class="token operator">-</span><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AT_ACK_OK</span>       <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AT_ACK_BUSY</span>     <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AT_ACK_UNKNOW</span>   <span class="token expression"><span class="token number">2</span></span></span>

<span class="token comment">//ESP8266对象结构体</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span>     aIP<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">//IP</span>
    <span class="token class-name">uint8_t</span>     aMAC<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//MAC</span>
    <span class="token class-name">uint8_t</span>     bRxData<span class="token punctuation">;</span>    <span class="token comment">//接收单字节数据</span>
    <span class="token class-name">uint8_t</span>     <span class="token operator">*</span>pCmd<span class="token punctuation">;</span>      <span class="token comment">//应答命令</span>
    <span class="token class-name">int32_t</span>     iState<span class="token punctuation">;</span>     <span class="token comment">//应答状态</span>
    <span class="token class-name">uint32_t</span>    iCnt<span class="token punctuation">;</span>       <span class="token comment">//接收数据计数</span>
    <span class="token class-name">uint8_t</span>     aBuf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//接收数据缓冲</span>
    <span class="token class-name">int32_t</span>     iAck<span class="token punctuation">;</span>
<span class="token punctuation">}</span>ESP_T<span class="token punctuation">;</span>

<span class="token comment">/****************************************************************************************
* 功能描述: 获取应答状态
* 输入参数: pBuf: 接收数据缓存
* 返 回 值: 应答命令状态
****************************************************************************************/</span>
<span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">ESP_GetAckSta</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pBuf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pBuf<span class="token punctuation">,</span> <span class="token string">"ERROR"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> AT_ACK_ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pBuf<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span>
             <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pBuf<span class="token punctuation">,</span> <span class="token string">"&gt;"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> AT_ACK_OK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pBuf<span class="token punctuation">,</span> <span class="token string">"WIFI "</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pBuf<span class="token punctuation">,</span> <span class="token string">"busy"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> AT_ACK_BUSY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> AT_ACK_UNKNOW<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************************
* 功能描述: 等待应答
* 输入参数: pAt: AT指令指针
            timeout: 超时时间, 单位秒
* 返 回 值: 0.成功 -1.失败
****************************************************************************************/</span>
<span class="token keyword">static</span> <span class="token class-name">int32_t</span> <span class="token function">ESP_WaitAck</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pCmd<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">int8_t</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    gEsp<span class="token punctuation">.</span>pCmd <span class="token operator">=</span> AT_UNKNOW<span class="token punctuation">;</span>
    gEsp<span class="token punctuation">.</span>iState  <span class="token operator">=</span> AT_ACK_UNKNOW<span class="token punctuation">;</span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>iState <span class="token operator">==</span> AT_ACK_OK <span class="token operator">||</span> gEsp<span class="token punctuation">.</span>iState <span class="token operator">==</span> AT_ACK_ERROR<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>gEsp<span class="token punctuation">.</span>iState <span class="token operator">==</span> AT_ACK_BUSY<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//举例：获取GMR信息</span>
<span class="token class-name">int32_t</span> <span class="token function">ESP_GetGMR</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pBuf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ESP_SendCmd</span><span class="token punctuation">(</span>AT_GMR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ESP_WaitAck</span><span class="token punctuation">(</span>AT_GMR<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/12d4b44e99e035cdea2762b45e30183f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">重复相似图片查找工具</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/76b5a200ad74e0375ee82611b62f2e34/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C语言_printf()】教你如何使用printf()，格式化输出</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>