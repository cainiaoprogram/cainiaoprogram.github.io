<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Orchestrator Failover过程源码分析-II - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Orchestrator Failover过程源码分析-II" />
<meta property="og:description" content="Orchestrator Failover过程源码分析-II 书接上文Orchestrator Failover过程源码分析-I
DeadMaster恢复流程 首先通过getCheckAndRecoverFunction获取&#34;checkAndRecoverFunction&#34;
func getCheckAndRecoverFunction(analysisCode inst.AnalysisCode, analyzedInstanceKey *inst.InstanceKey) ( checkAndRecoverFunction func(analysisEntry inst.ReplicationAnalysis, candidateInstanceKey *inst.InstanceKey, forceInstanceRecovery bool, skipProcesses bool) (recoveryAttempted bool, topologyRecovery *TopologyRecovery, err error), isActionableRecovery bool, ) { switch analysisCode { // master case inst.DeadMaster, inst.DeadMasterAndSomeReplicas: // 如果analysisCode是DeadMaster 或 DeadMasterAndSomeReplicas if isInEmergencyOperationGracefulPeriod(analyzedInstanceKey) { // 首先判断是否处于 EmergencyOperationGracefulPeriod return checkAndRecoverGenericProblem, false // 如果处于EmergencyOperationGracefulPeriod, 则又相当于啥也没干, 等下一轮recoverTick } else { return checkAndRecoverDeadMaster, true } 这里先判断isInEmergencyOperationGracefulPeriod
func isInEmergencyOperationGracefulPeriod(instanceKey *inst.InstanceKey) bool { _, found := emergencyOperationGracefulPeriodMap." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f65a1c0541f037845eb5d3e20fa4d42e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-15T17:07:26+08:00" />
<meta property="article:modified_time" content="2022-05-15T17:07:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Orchestrator Failover过程源码分析-II</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Orchestrator_FailoverIIhttpfuxkdbcom2022043020220506OrchestratorFailoverE8BF87E7A88BE6BA90E7A081E58886E69E90II_0"></a><a href="http://fuxkdb.com/2022/04/30/2022-05-06-Orchestrator-Failover%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-II/" rel="nofollow">Orchestrator Failover过程源码分析-II</a></h2> 
<p>书接上文<a href="https://blog.csdn.net/ashic/article/details/124774367">Orchestrator Failover过程源码分析-I</a></p> 
<h3><a id="DeadMaster_2"></a>DeadMaster恢复流程</h3> 
<p>首先通过<code>getCheckAndRecoverFunction</code>获取"checkAndRecoverFunction"</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">getCheckAndRecoverFunction</span><span class="token punctuation">(</span>analysisCode inst<span class="token punctuation">.</span>AnalysisCode<span class="token punctuation">,</span> analyzedInstanceKey <span class="token operator">*</span>inst<span class="token punctuation">.</span>InstanceKey<span class="token punctuation">)</span> <span class="token punctuation">(</span>
    checkAndRecoverFunction <span class="token keyword">func</span><span class="token punctuation">(</span>analysisEntry inst<span class="token punctuation">.</span>ReplicationAnalysis<span class="token punctuation">,</span> candidateInstanceKey <span class="token operator">*</span>inst<span class="token punctuation">.</span>InstanceKey<span class="token punctuation">,</span> forceInstanceRecovery <span class="token builtin">bool</span><span class="token punctuation">,</span> skipProcesses <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>recoveryAttempted <span class="token builtin">bool</span><span class="token punctuation">,</span> topologyRecovery <span class="token operator">*</span>TopologyRecovery<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    isActionableRecovery <span class="token builtin">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> analysisCode <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// master</span>
    <span class="token keyword">case</span> inst<span class="token punctuation">.</span>DeadMaster<span class="token punctuation">,</span> inst<span class="token punctuation">.</span>DeadMasterAndSomeReplicas<span class="token punctuation">:</span> <span class="token comment">// 如果analysisCode是DeadMaster 或 DeadMasterAndSomeReplicas</span>
        <span class="token keyword">if</span> <span class="token function">isInEmergencyOperationGracefulPeriod</span><span class="token punctuation">(</span>analyzedInstanceKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 首先判断是否处于 EmergencyOperationGracefulPeriod</span>
            <span class="token keyword">return</span> checkAndRecoverGenericProblem<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">// 如果处于EmergencyOperationGracefulPeriod, 则又相当于啥也没干, 等下一轮recoverTick</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> checkAndRecoverDeadMaster<span class="token punctuation">,</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>这里先判断isInEmergencyOperationGracefulPeriod</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">isInEmergencyOperationGracefulPeriod</span><span class="token punctuation">(</span>instanceKey <span class="token operator">*</span>inst<span class="token punctuation">.</span>InstanceKey<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> found <span class="token operator">:=</span> emergencyOperationGracefulPeriodMap<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>instanceKey<span class="token punctuation">.</span><span class="token function">StringCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// emergencyOperationGracefulPeriodMap 是一个cache, 有过期时间的"缓存"</span>
    <span class="token keyword">return</span> found
<span class="token punctuation">}</span>
</code></pre> 
<p>实际是尝试去emergencyOperationGracefulPeriodMap这个cache找有没有这个instance. 那么问题来了, 是谁在什么时候向这个cache放这个instance呢?<br> 其实是在主库处于<a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Failure%20detection%20%26%20recovery/Failure%20detection.md#unreachablemaster">UnreachableMaster</a>状态下, <code>executeCheckAndRecoverFunction</code>中调用runEmergentOperations时</p> 
<pre><code class="prism language-go"><span class="token comment">// executeCheckAndRecoverFunction will choose the correct check &amp; recovery function based on analysis.</span>
<span class="token comment">// It executes the function synchronuously</span>
<span class="token keyword">func</span> <span class="token function">executeCheckAndRecoverFunction</span><span class="token punctuation">(</span>analysisEntry inst<span class="token punctuation">.</span>ReplicationAnalysis<span class="token punctuation">,</span> candidateInstanceKey <span class="token operator">*</span>inst<span class="token punctuation">.</span>InstanceKey<span class="token punctuation">,</span> forceInstanceRecovery <span class="token builtin">bool</span><span class="token punctuation">,</span> skipProcesses <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>recoveryAttempted <span class="token builtin">bool</span><span class="token punctuation">,</span> topologyRecovery <span class="token operator">*</span>TopologyRecovery<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>countPendingRecoveries<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>countPendingRecoveries<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    checkAndRecoverFunction<span class="token punctuation">,</span> isActionableRecovery <span class="token operator">:=</span> <span class="token function">getCheckAndRecoverFunction</span><span class="token punctuation">(</span>analysisEntry<span class="token punctuation">.</span>Analysis<span class="token punctuation">,</span> <span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey<span class="token punctuation">)</span> <span class="token comment">// 最初处于UnreachableMaster时, 这里拿到的是checkAndRecoverGenericProblem</span>
    analysisEntry<span class="token punctuation">.</span>IsActionableRecovery <span class="token operator">=</span> isActionableRecovery
    <span class="token function">runEmergentOperations</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">)</span> 
</code></pre> 
<p>可以看到, <a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Failure%20detection%20%26%20recovery/Failure%20detection.md#unreachablemaster">UnreachableMaster</a>时, 会运行emergentlyReadTopologyInstance</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">runEmergentOperations</span><span class="token punctuation">(</span>analysisEntry <span class="token operator">*</span>inst<span class="token punctuation">.</span>ReplicationAnalysis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> analysisEntry<span class="token punctuation">.</span>Analysis <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>省略部分代码
    <span class="token keyword">case</span> inst<span class="token punctuation">.</span>UnreachableMaster<span class="token punctuation">:</span> <span class="token comment">// 实际目的是强制重新读一下该实例和其所有从库的"信息"</span>
        <span class="token keyword">go</span> <span class="token function">emergentlyReadTopologyInstance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey<span class="token punctuation">,</span> analysisEntry<span class="token punctuation">.</span>Analysis<span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token function">emergentlyReadTopologyInstanceReplicas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey<span class="token punctuation">,</span> analysisEntry<span class="token punctuation">.</span>Analysis<span class="token punctuation">)</span>
</code></pre> 
<p>而在emergentlyReadTopologyInstance中会先尝试向emergencyReadTopologyInstanceMap中Add</p> 
<pre><code class="prism language-go"><span class="token comment">// Force a re-read of a topology instance; this is done because we need to substantiate a suspicion</span>
<span class="token comment">// that we may have a failover scenario. we want to speed up reading the complete picture.</span>
<span class="token keyword">func</span> <span class="token function">emergentlyReadTopologyInstance</span><span class="token punctuation">(</span>instanceKey <span class="token operator">*</span>inst<span class="token punctuation">.</span>InstanceKey<span class="token punctuation">,</span> analysisCode inst<span class="token punctuation">.</span>AnalysisCode<span class="token punctuation">)</span> <span class="token punctuation">(</span>instance <span class="token operator">*</span>inst<span class="token punctuation">.</span>Instance<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> existsInCacheError <span class="token operator">:=</span> emergencyReadTopologyInstanceMap<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>instanceKey<span class="token punctuation">.</span><span class="token function">StringCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> cache<span class="token punctuation">.</span>DefaultExpiration<span class="token punctuation">)</span><span class="token punctuation">;</span> existsInCacheError <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Just recently attempted</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    instance<span class="token punctuation">,</span> err <span class="token operator">=</span> inst<span class="token punctuation">.</span><span class="token function">ReadTopologyInstance</span><span class="token punctuation">(</span>instanceKey<span class="token punctuation">)</span> <span class="token comment">// 会调用 ReadTopologyInstanceBufferable</span>
    inst<span class="token punctuation">.</span><span class="token function">AuditOperation</span><span class="token punctuation">(</span><span class="token string">"emergently-read-topology-instance"</span><span class="token punctuation">,</span> instanceKey<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>analysisCode<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>ReadTopologyInstance 实际调用 <a href="http://fuxkdb.com/2022/04/26/2022-04-26-Orchestrator-Discover%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#gt-ReadTopologyInstanceBufferable" rel="nofollow">ReadTopologyInstanceBufferable</a></p> 
</blockquote> 
<p>这个cache是在logic包init时创建的</p> 
<pre><code class="prism language-go">emergencyOperationGracefulPeriodMap <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Millisecond<span class="token operator">*</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token comment">// 过期时间5s</span>
</code></pre> 
<p>isInEmergencyOperationGracefulPeriod 如果返回true, 表示尚处于EmergentOperations运行窗口期内, 所以需要等<br> 若返回false, 表示已经可以开始"恢复"了, 就会返回checkAndRecoverDeadMaster, 并且isActionableRecovery也为true</p> 
<h4><a id="executeCheckAndRecoverFunction_72"></a>executeCheckAndRecoverFunction</h4> 
<pre><code class="prism language-go"><span class="token comment">// It executes the function synchronuously</span>
<span class="token keyword">func</span> <span class="token function">executeCheckAndRecoverFunction</span><span class="token punctuation">(</span>analysisEntry inst<span class="token punctuation">.</span>ReplicationAnalysis<span class="token punctuation">,</span> candidateInstanceKey <span class="token operator">*</span>inst<span class="token punctuation">.</span>InstanceKey<span class="token punctuation">,</span> forceInstanceRecovery <span class="token builtin">bool</span><span class="token punctuation">,</span> skipProcesses <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>recoveryAttempted <span class="token builtin">bool</span><span class="token punctuation">,</span> topologyRecovery <span class="token operator">*</span>TopologyRecovery<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>countPendingRecoveries<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>countPendingRecoveries<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    checkAndRecoverFunction<span class="token punctuation">,</span> isActionableRecovery <span class="token operator">:=</span> <span class="token function">getCheckAndRecoverFunction</span><span class="token punctuation">(</span>analysisEntry<span class="token punctuation">.</span>Analysis<span class="token punctuation">,</span> <span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey<span class="token punctuation">)</span>
    analysisEntry<span class="token punctuation">.</span>IsActionableRecovery <span class="token operator">=</span> isActionableRecovery
    <span class="token function">runEmergentOperations</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">)</span>

    <span class="token operator">...</span>省略部分代码
    <span class="token comment">// Initiate detection:</span>
    <span class="token comment">// 向backend db topology_failure_detection表insert ignore into一条数据</span>
    <span class="token comment">// 这里 skipProcesses = false, 所以会调用 OnFailureDetectionProcesses 钩子</span>
    <span class="token comment">// 到这里我才明白, 原来 skipProcesses 意思是 是否跳过 钩子的执行</span>
    registrationSuccess<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">checkAndExecuteFailureDetectionProcesses</span><span class="token punctuation">(</span>analysisEntry<span class="token punctuation">,</span> skipProcesses<span class="token punctuation">)</span>
    <span class="token keyword">if</span> registrationSuccess <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> orcraft<span class="token punctuation">.</span><span class="token function">IsRaftEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> orcraft<span class="token punctuation">.</span><span class="token function">PublishCommand</span><span class="token punctuation">(</span><span class="token string">"register-failure-detection"</span><span class="token punctuation">,</span> analysisEntry<span class="token punctuation">)</span>
            log<span class="token punctuation">.</span><span class="token function">Errore</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>省略部分代码
    <span class="token comment">// We don't mind whether detection really executed the processes or not</span>
    <span class="token comment">// (it may have been silenced due to previous detection). We only care there's no error.</span>

    <span class="token comment">// We're about to embark on recovery shortly...</span>

    <span class="token comment">// Check for recovery being disabled globally</span>
    <span class="token comment">// 看是否全局禁用了恢复, 如通过API disable-global-recoveries 去禁用全局恢复</span>
    <span class="token keyword">if</span> recoveryDisabledGlobally<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">IsRecoveryDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Unexpected. Shouldn't get this</span>
        log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Unable to determine if recovery is disabled globally: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> recoveryDisabledGlobally <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 这里checkAndRecover传的是false</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>forceInstanceRecovery <span class="token punctuation">{<!-- --></span> <span class="token comment">// 所以如果全局禁用了recover, recoverTick是不会进行恢复的, 因为forceInstanceRecovery也是false. 至此退出</span>
            log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"CheckAndRecover: Analysis: %+v, InstanceKey: %+v, candidateInstanceKey: %+v, "</span><span class="token operator">+</span>
                <span class="token string">"skipProcesses: %v: NOT Recovering host (disabled globally)"</span><span class="token punctuation">,</span>
                analysisEntry<span class="token punctuation">.</span>Analysis<span class="token punctuation">,</span> analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey<span class="token punctuation">,</span> candidateInstanceKey<span class="token punctuation">,</span> skipProcesses<span class="token punctuation">)</span>

            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"CheckAndRecover: Analysis: %+v, InstanceKey: %+v, candidateInstanceKey: %+v, "</span><span class="token operator">+</span>
            <span class="token string">"skipProcesses: %v: recoveries disabled globally but forcing this recovery"</span><span class="token punctuation">,</span>
            analysisEntry<span class="token punctuation">.</span>Analysis<span class="token punctuation">,</span> analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey<span class="token punctuation">,</span> candidateInstanceKey<span class="token punctuation">,</span> skipProcesses<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 开始运行checkAndRecoverFunction. 本例中是运行checkAndRecoverDeadMaster</span>
    <span class="token comment">// 我们先不看checkAndRecoverDeadMaster具体干了啥, 先往下看</span>
    recoveryAttempted<span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">checkAndRecoverFunction</span><span class="token punctuation">(</span>analysisEntry<span class="token punctuation">,</span> candidateInstanceKey<span class="token punctuation">,</span> forceInstanceRecovery<span class="token punctuation">,</span> skipProcesses<span class="token punctuation">)</span> <span class="token comment">// 实参为analysisEntry, nil, false, false</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>recoveryAttempted <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> recoveryAttempted<span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> topologyRecovery <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> recoveryAttempted<span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> b<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Topology recovery: %+v"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Topology recovery: %+v"</span><span class="token punctuation">,</span> <span class="token operator">*</span>topologyRecovery<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// skipProcesses=false</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>skipProcesses <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 没恢复成功, 调用 PostUnsuccessfulFailoverProcesses</span>
        <span class="token keyword">if</span> topologyRecovery<span class="token punctuation">.</span>SuccessorKey <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Execute general unsuccessful post failover processes</span>
            <span class="token function">executeProcesses</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>PostUnsuccessfulFailoverProcesses<span class="token punctuation">,</span> <span class="token string">"PostUnsuccessfulFailoverProcesses"</span><span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 否则调用 PostFailoverProcesses</span>
            <span class="token comment">// Execute general post failover processes</span>
            inst<span class="token punctuation">.</span><span class="token function">EndDowntime</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">.</span>SuccessorKey<span class="token punctuation">)</span>
            <span class="token function">executeProcesses</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>PostFailoverProcesses<span class="token punctuation">,</span> <span class="token string">"PostFailoverProcesses"</span><span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
    <span class="token operator">...</span>省略部分代码
    <span class="token comment">// 代码只要能走到这里, 就带表恢复成功了? recoveryAttempted肯定是true</span>
    <span class="token comment">// 具体的恢复操作, 都在checkAndRecoverFunction里</span>
    <span class="token keyword">return</span> recoveryAttempted<span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre> 
<p>对于本文场景, 当主库被认定处于<a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Failure%20detection%20%26%20recovery/Failure%20detection.md#deadmaster">DeadMaster</a>状态后:<br> executeCheckAndRecoverFunction会先调用getCheckAndRecoverFunction获取:</p> 
<ul><li>checkAndRecoverFunction: checkAndRecoverDeadMaster</li><li>isActionableRecovery: true</li></ul> 
<p>然后检查是否"禁用"了全局故障恢复功能(如通过API <a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Failure%20detection%20%26%20recovery/Topology%20recovery.md#web-api-command-line">disable-global-recoveries</a>), 如果是, 则直接return</p> 
<p>接下来, 开始执行checkAndRecoverFunction, 即checkAndRecoverDeadMaster</p> 
<p>我们先不看checkAndRecoverDeadMaster具体逻辑, 继续往下看. 下面的代码就是根据checkAndRecoverFunction的执行情况(是否成功恢复), 调用对应的钩子, 最后将恢复结果return回去, 其实到这里, 本轮恢复就算做完了. 具体恢复是否成功, recoverTick也不关心. 具体如何恢复的, 还是要看checkAndRecoverFunction(本例中是checkAndRecoverDeadMaster)</p> 
<blockquote> 
 <p>关于钩子, 见:<br> <a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-%E2%85%A1.md#onfailuredetectionprocesses">OnFailureDetectionProcesses</a><br> <a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-%E2%85%A1.md#postunsuccessfulfailoverprocesses">PostUnsuccessfulFailoverProcesses</a><br> <a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-%E2%85%A1.md#postfailoverprocesses">PostFailoverProcesses</a></p> 
</blockquote> 
<h4><a id="checkAndRecoverDeadMaster_170"></a>checkAndRecoverDeadMaster</h4> 
<pre><code class="prism language-go"><span class="token comment">// checkAndRecoverDeadMaster checks a given analysis, decides whether to take action, and possibly takes action</span>
<span class="token comment">// Returns true when action was taken.</span>
<span class="token keyword">func</span> <span class="token function">checkAndRecoverDeadMaster</span><span class="token punctuation">(</span>analysisEntry inst<span class="token punctuation">.</span>ReplicationAnalysis<span class="token punctuation">,</span> candidateInstanceKey <span class="token operator">*</span>inst<span class="token punctuation">.</span>InstanceKey<span class="token punctuation">,</span> forceInstanceRecovery <span class="token builtin">bool</span><span class="token punctuation">,</span> skipProcesses <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>recoveryAttempted <span class="token builtin">bool</span><span class="token punctuation">,</span> topologyRecovery <span class="token operator">*</span>TopologyRecovery<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// forceInstanceRecovery=false</span>
    <span class="token comment">// HasAutomatedMasterRecovery 是在GetReplicationAnalysis中会运行 a.ClusterDetails.ReadRecoveryInfo()</span>
    <span class="token comment">// ReadRecoveryInfo中会执行 this.HasAutomatedMasterRecovery = this.filtersMatchCluster(config.Config.RecoverMasterClusterFilters)</span>
    <span class="token comment">// RecoverMasterClusterFilters 我们配置的是 .* 所以这里为true</span>
    <span class="token comment">// false || true = true</span>
    <span class="token comment">// 所以这对于recoverTick来说, 目的是检查一下RecoverMasterClusterFilters配置, 看这个集群到底配没配自动故障恢复</span>
    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span>forceInstanceRecovery <span class="token operator">||</span> analysisEntry<span class="token punctuation">.</span>ClusterDetails<span class="token punctuation">.</span>HasAutomatedMasterRecovery<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 实参 &amp;analysisEntry, true, true</span>
    <span class="token comment">// 尝试注册一个恢复条目, 如果失败, 意味着 recovery is already in place.</span>

    <span class="token comment">// 让我们检查一下这个实例是否最近刚刚被提升或集群刚刚经历failover，并且仍然处于活动期。如果是这样，我们就拒绝恢复注册，to avoid flapping. </span>
    <span class="token comment">// 就是说刚Failover没多久又Failover不行, 类似MHA 8小时限制</span>
    <span class="token comment">// 时间由RecoveryPeriodBlockMinutes控制, 默认1小时. 也是在recoveryTick启动协程是会去清理in_active_period标记(update为0)</span>
    <span class="token comment">// 如果一切没问题, 会向数据库topology_recovery插入一条记录, 并new一个topologyRecovery结构体返回.</span>
    <span class="token comment">// 否则 topologyRecovery 是 nil</span>
    topologyRecovery<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">AttemptRecoveryRegistration</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">,</span> <span class="token operator">!</span>forceInstanceRecovery<span class="token punctuation">,</span> <span class="token operator">!</span>forceInstanceRecovery<span class="token punctuation">)</span>
    <span class="token keyword">if</span> topologyRecovery <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果 topologyRecovery = nil, 说明最近刚恢复完, 或者正在恢复, 直接return</span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"found an active or recent recovery on %+v. Will not issue another RecoverDeadMaster."</span><span class="token punctuation">,</span> analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token comment">// That's it! We must do recovery!</span>
    <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"will handle DeadMaster event on %+v"</span><span class="token punctuation">,</span> analysisEntry<span class="token punctuation">.</span>ClusterDetails<span class="token punctuation">.</span>ClusterName<span class="token punctuation">)</span><span class="token punctuation">)</span>
    recoverDeadMasterCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">// 正式开始恢复</span>
    <span class="token comment">// 实参为 topologyRecovery, nil, false</span>
    recoveryAttempted<span class="token punctuation">,</span> promotedReplica<span class="token punctuation">,</span> lostReplicas<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">recoverDeadMaster</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> candidateInstanceKey<span class="token punctuation">,</span> skipProcesses<span class="token punctuation">)</span>
    <span class="token operator">...</span>省略部分代码
    topologyRecovery<span class="token punctuation">.</span>LostReplicas<span class="token punctuation">.</span><span class="token function">AddInstances</span><span class="token punctuation">(</span>lostReplicas<span class="token punctuation">)</span> <span class="token comment">// lostReplicas 由于种种原因, 没有成功change到new master的从库</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>recoveryAttempted <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 代码运行到这里时, 可能已经选举出了new master, 即promotedReplica</span>
    <span class="token comment">// 这个函数补充了一些判断条件, 判断这个promotedReplica是不是可以做new master</span>
    <span class="token comment">// 主要就是这几个参数:</span>
    <span class="token comment">// - PreventCrossDataCenterMasterFailover</span>
    <span class="token comment">// - PreventCrossRegionMasterFailover</span>
    <span class="token comment">// - FailMasterPromotionOnLagMinutes</span>
    <span class="token comment">// - FailMasterPromotionIfSQLThreadNotUpToDate</span>
    <span class="token comment">// - DelayMasterPromotionIfSQLThreadNotUpToDate</span>
    overrideMasterPromotion <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>inst<span class="token punctuation">.</span>Instance<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> promotedReplica <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// No promotion; nothing to override.</span>
            <span class="token keyword">return</span> promotedReplica<span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token comment">// Scenarios where we might cancel the promotion.</span>
        <span class="token comment">// 这个函数就是通过以下参数:</span>
        <span class="token comment">// - PreventCrossDataCenterMasterFailover</span>
        <span class="token comment">// - PreventCrossRegionMasterFailover</span>
        <span class="token comment">// 判断 promotedReplica 是否可以做 new master</span>
        <span class="token comment">// PreventCrossDataCenterMasterFailover:</span>
        <span class="token comment">// 默认false . 当为true 时, orchestrator将只用与故障集群主库位于同一DC的从库替换故障的主库. 它将尽最大努力从同一DC中找到一个替代者, 如果找不到, 将中止（失败）故障转移.</span>
        <span class="token comment">// PreventCrossRegionMasterFailover:</span>
        <span class="token comment">// 默认false . 当为true 时, orchestrator将只用与故障集群主库位于同一region的从库替换故障的主库. 它将尽最大努力找到同一region的替代者, 如果找不到, 将中止（失败）故障转移.</span>
        <span class="token keyword">if</span> satisfied<span class="token punctuation">,</span> reason <span class="token operator">:=</span> <span class="token function">MasterFailoverGeographicConstraintSatisfied</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">,</span> promotedReplica<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>satisfied <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: failed %+v promotion; %s"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: promoted replica lag seconds: %+v"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>ReplicationLagSeconds<span class="token punctuation">.</span>Int64<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>FailMasterPromotionOnLagMinutes <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>promotedReplica<span class="token punctuation">.</span>ReplicationLagSeconds<span class="token punctuation">.</span>Int64<span class="token punctuation">)</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token operator">&gt;=</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>FailMasterPromotionOnLagMinutes<span class="token punctuation">)</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Minute <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// candidate replica lags too much</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: failed promotion. FailMasterPromotionOnLagMinutes is set to %d (minutes) and promoted replica %+v 's lag is %d (seconds)"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>FailMasterPromotionOnLagMinutes<span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>ReplicationLagSeconds<span class="token punctuation">.</span>Int64<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: promoted replica sql thread up-to-date: %+v"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span><span class="token function">SQLThreadUpToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>FailMasterPromotionIfSQLThreadNotUpToDate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>promotedReplica<span class="token punctuation">.</span><span class="token function">SQLThreadUpToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: failed promotion. FailMasterPromotionIfSQLThreadNotUpToDate is set and promoted replica %+v 's sql thread is not up to date (relay logs still unapplied). Aborting promotion"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>DelayMasterPromotionIfSQLThreadNotUpToDate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>promotedReplica<span class="token punctuation">.</span><span class="token function">SQLThreadUpToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"DelayMasterPromotionIfSQLThreadNotUpToDate: waiting for SQL thread on %+v"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> inst<span class="token punctuation">.</span><span class="token function">WaitForSQLThreadUpToDate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"DelayMasterPromotionIfSQLThreadNotUpToDate error: %+v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"DelayMasterPromotionIfSQLThreadNotUpToDate: SQL thread caught up on %+v"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// All seems well. No override done.</span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: found no reason to override promotion of %+v"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> promotedReplica<span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token comment">// 运行 overrideMasterPromotion</span>
    <span class="token keyword">if</span> promotedReplica<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">overrideMasterPromotion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// And this is the end; whether successful or not, we're done.</span>
    <span class="token function">resolveRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> promotedReplica<span class="token punctuation">)</span>
    <span class="token comment">// Now, see whether we are successful or not. From this point there's no going back.</span>
    
    <span class="token keyword">if</span> promotedReplica <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 成功选举除了新主库</span>
        <span class="token comment">// Success!</span>
        recoverDeadMasterSuccessCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: successfully promoted %+v"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"- RecoverDeadMaster: promoted server coordinates: %+v"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>SelfBinlogCoordinates<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// 当为true 时, orchestrator 将在选举出的新主库上执行reset slave all 和set read_only=0 . 默认: true . 当该参数为true 时, 将覆盖MasterFailoverDetachSlaveMasterHost .</span>
        <span class="token comment">// 所以这个if列操作就是执行在新主库执行 reset slave all 和set read_only=0</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>ApplyMySQLPromotionAfterMasterFailover <span class="token operator">||</span> analysisEntry<span class="token punctuation">.</span>CommandHint <span class="token operator">==</span> inst<span class="token punctuation">.</span>GracefulMasterTakeoverCommandHint <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// on GracefulMasterTakeoverCommandHint it makes utter sense to RESET SLAVE ALL and read_only=0, and there is no sense in not doing so.</span>
            <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"- RecoverDeadMaster: will apply MySQL changes to promoted master"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> inst<span class="token punctuation">.</span><span class="token function">ResetReplicationOperation</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Ugly, but this is important. Let's give it another try</span>
                    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> inst<span class="token punctuation">.</span><span class="token function">ResetReplicationOperation</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"- RecoverDeadMaster: applying RESET SLAVE ALL on promoted master: success=%t"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"- RecoverDeadMaster: NOTE that %+v is promoted even though SHOW SLAVE STATUS may still show it has a master"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> inst<span class="token punctuation">.</span><span class="token function">SetReadOnly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"- RecoverDeadMaster: applying read-only=0 on promoted master: success=%t"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Let's attempt, though we won't necessarily succeed, to set old master as read-only</span>
            <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 并且尝试给旧主库打开只读, 成功与否无所</span>
                <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> inst<span class="token punctuation">.</span><span class="token function">SetReadOnly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"- RecoverDeadMaster: applying read-only=1 on demoted master: success=%t"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token operator">...</span>省略部分代码
        <span class="token comment">// 当该参数为true 时, orchestrator将对被选举为新主库的节点执行detach-replica-master-host（这确保了即使旧主库"复活了", 新主库也不会试图从旧主库复制数据）. 默认值: false. 如果ApplyMySQLPromotionAfterMasterFailover为真，这个参数将失去意义.</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>MasterFailoverDetachReplicaMasterHost <span class="token punctuation">{<!-- --></span>
            postponedFunction <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"- RecoverDeadMaster: detaching master host on promoted master"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 所以说 如果 ApplyMySQLPromotionAfterMasterFailover=true, 就已经完成了reset slave all了. </span>
                <span class="token comment">// 那么DetachReplicaMasterHost也就失去意义了</span>
                inst<span class="token punctuation">.</span><span class="token function">DetachReplicaMasterHost</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            topologyRecovery<span class="token punctuation">.</span><span class="token function">AddPostponedFunction</span><span class="token punctuation">(</span>postponedFunction<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster, detaching promoted master host %+v"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token operator">...</span>省略部分代码

        <span class="token keyword">if</span> <span class="token operator">!</span>skipProcesses <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Execute post master-failover processes</span>
            <span class="token comment">// 执行钩子 PostMasterFailoverProcesses</span>
            <span class="token function">executeProcesses</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>PostMasterFailoverProcesses<span class="token punctuation">,</span> <span class="token string">"PostMasterFailoverProcesses"</span><span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 否则, 说明恢复失败了</span>
        recoverDeadMasterFailureCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre> 
<p>checkAndRecoverDeadMaster 首先通过<a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-%E2%85%A1.md#recovermasterclusterfilters">RecoverMasterClusterFilters</a>再次判断这个实例是否可以进行自动故障恢复.<br> 接着, 调用AttemptRecoveryRegistration检查这个实例是否最近刚刚被提升或该实例所处集群刚刚经历failover, 并且仍然处于活动期.</p> 
<blockquote> 
 <p>就是说刚Failover没多久又Failover不行, 类似MHA 8小时限制</p> 
</blockquote> 
<p>活动期的时间由<a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-%E2%85%A1.md#recoveryperiodblockminutes">RecoveryPeriodBlockMinutes</a>控制, 默认1小时. 也是在recoveryTick启动协程时会去清理in_active_period标记(update为0)<br> 如果一切没问题, 会向数据库topology_recovery插入一条记录, 并new一个topologyRecovery结构体返回. 否则 topologyRecovery 是 nil</p> 
<p>以上检查都没问题的话, 就正式开始执行恢复, 调用recoverDeadMaster.</p> 
<p>我们先不看recoverDeadMaster代码, 继续往后看.</p> 
<p>recoverDeadMaster最重要的是会返回promotedReplica, 即选举出来的新主库<br> 代码运行到这里时, 可能已经选举出了new master, 即promotedReplica. 随后会运行overrideMasterPromotion函数<br> 这个函数补充了一些判断条件, 判断这个promotedReplica是不是可以做new master<br> 主要就是这几个参数:</p> 
<ul><li><a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-III.md#preventcrossdatacentermasterfailover">PreventCrossDataCenterMasterFailover</a></li><li><a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-III.md#preventcrossregionmasterfailover">PreventCrossRegionMasterFailover</a></li><li><a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-III.md#failmasterpromotiononlagminutes">FailMasterPromotionOnLagMinutes</a></li><li><a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-III.md#failmasterpromotionifsqlthreadnotuptodate">FailMasterPromotionIfSQLThreadNotUpToDate</a></li><li><a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-III.md#delaymasterpromotionifsqlthreadnotuptodate">DelayMasterPromotionIfSQLThreadNotUpToDate</a></li></ul> 
<p>以上任意一个判断有问题, 都会终止后续恢复动作, 直接return</p> 
<p>最后, checkAndRecoverDeadMaster会对new master和old master做一些收尾工作, 如:</p> 
<ul><li>如果<a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-III.md#applymysqlpromotionaftermasterfailover">ApplyMySQLPromotionAfterMasterFailover</a>为true, 则会在新主库执行 reset slave all 和set read_only=0, 否则走<a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-III.md#masterfailoverdetachreplicamasterhost">MasterFailoverDetachReplicaMasterHost</a>逻辑</li><li>尝试连接旧主库打开只读</li></ul> 
<p>至此, 恢复成功完成.<br> 具体的恢复逻辑, 还要看recoverDeadMaster</p> 
<h4><a id="recoverDeadMaster_358"></a>recoverDeadMaster</h4> 
<pre><code class="prism language-go"><span class="token comment">// recoverDeadMaster recovers a dead master, complete logic inside</span>
<span class="token keyword">func</span> <span class="token function">recoverDeadMaster</span><span class="token punctuation">(</span>topologyRecovery <span class="token operator">*</span>TopologyRecovery<span class="token punctuation">,</span> candidateInstanceKey <span class="token operator">*</span>inst<span class="token punctuation">.</span>InstanceKey<span class="token punctuation">,</span> skipProcesses <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>recoveryAttempted <span class="token builtin">bool</span><span class="token punctuation">,</span> promotedReplica <span class="token operator">*</span>inst<span class="token punctuation">.</span>Instance<span class="token punctuation">,</span> lostReplicas <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">*</span>inst<span class="token punctuation">.</span>Instance<span class="token punctuation">)</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 传进来的实参, topologyRecovery, nil, false</span>

    topologyRecovery<span class="token punctuation">.</span>Type <span class="token operator">=</span> MasterRecovery
    analysisEntry <span class="token operator">:=</span> <span class="token operator">&amp;</span>topologyRecovery<span class="token punctuation">.</span>AnalysisEntry
    failedInstanceKey <span class="token operator">:=</span> <span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey
    <span class="token keyword">var</span> cannotReplicateReplicas <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">*</span>inst<span class="token punctuation">.</span>Instance<span class="token punctuation">)</span>
    postponedAll <span class="token operator">:=</span> <span class="token boolean">false</span>

    inst<span class="token punctuation">.</span><span class="token function">AuditOperation</span><span class="token punctuation">(</span><span class="token string">"recover-dead-master"</span><span class="token punctuation">,</span> failedInstanceKey<span class="token punctuation">,</span> <span class="token string">"problem found; will recover"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>skipProcesses <span class="token punctuation">{<!-- --></span> <span class="token comment">// 执行钩子</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">executeProcesses</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>PreFailoverProcesses<span class="token punctuation">,</span> <span class="token string">"PreFailoverProcesses"</span><span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> lostReplicas<span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">.</span><span class="token function">AddError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>省略部分代码
    <span class="token comment">// topologyRecovery.RecoveryType = MasterRecoveryGTID</span>
    topologyRecovery<span class="token punctuation">.</span>RecoveryType <span class="token operator">=</span> <span class="token function">GetMasterRecoveryType</span><span class="token punctuation">(</span>analysisEntry<span class="token punctuation">)</span>
    <span class="token operator">...</span>省略部分代码

    <span class="token comment">// 这个函数判断GetCandidateReplica返回的candidate是不是"理想的"</span>
    <span class="token comment">// 如果是"理想的" 一些从库的恢复操作可以异步推迟执行</span>
    <span class="token comment">// 否则要同步执行</span>
    promotedReplicaIsIdeal <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>promoted <span class="token operator">*</span>inst<span class="token punctuation">.</span>Instance<span class="token punctuation">,</span> hasBestPromotionRule <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> promoted <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: promotedReplicaIsIdeal(%+v)"</span><span class="token punctuation">,</span> promoted<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment">// candidateInstanceKey实参是nil, 所以走不到这个if</span>
        <span class="token keyword">if</span> candidateInstanceKey <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//explicit request to promote a specific server</span>
            <span class="token keyword">return</span> promoted<span class="token punctuation">.</span>Key<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>candidateInstanceKey<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> promoted<span class="token punctuation">.</span>DataCenter <span class="token operator">==</span> topologyRecovery<span class="token punctuation">.</span>AnalysisEntry<span class="token punctuation">.</span>AnalyzedInstanceDataCenter <span class="token operator">&amp;&amp;</span>
            promoted<span class="token punctuation">.</span>PhysicalEnvironment <span class="token operator">==</span> topologyRecovery<span class="token punctuation">.</span>AnalysisEntry<span class="token punctuation">.</span>AnalyzedInstancePhysicalEnvironment <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> promoted<span class="token punctuation">.</span>PromotionRule <span class="token operator">==</span> inst<span class="token punctuation">.</span>MustPromoteRule <span class="token operator">||</span> promoted<span class="token punctuation">.</span>PromotionRule <span class="token operator">==</span> inst<span class="token punctuation">.</span>PreferPromoteRule <span class="token operator">||</span>
                <span class="token punctuation">(</span>hasBestPromotionRule <span class="token operator">&amp;&amp;</span> promoted<span class="token punctuation">.</span>PromotionRule <span class="token operator">!=</span> inst<span class="token punctuation">.</span>MustNotPromoteRule<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: found %+v to be ideal candidate; will optimize recovery"</span><span class="token punctuation">,</span> promoted<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                postponedAll <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">switch</span> topologyRecovery<span class="token punctuation">.</span>RecoveryType <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> MasterRecoveryGTID<span class="token punctuation">:</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: regrouping replicas via GTID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// promotedReplica 有可能==nil</span>
            lostReplicas<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> cannotReplicateReplicas<span class="token punctuation">,</span> promotedReplica<span class="token punctuation">,</span> err <span class="token operator">=</span> inst<span class="token punctuation">.</span><span class="token function">RegroupReplicasGTID</span><span class="token punctuation">(</span>failedInstanceKey<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>topologyRecovery<span class="token punctuation">.</span>PostponedFunctionsContainer<span class="token punctuation">,</span> promotedReplicaIsIdeal<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// case MasterRecoveryPseudoGTID:</span>
    <span class="token comment">//  ...省略部分代码</span>
    <span class="token comment">// case MasterRecoveryBinlogServer:</span>
    <span class="token comment">//  ...省略部分代码</span>
    <span class="token punctuation">}</span>
    topologyRecovery<span class="token punctuation">.</span><span class="token function">AddError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    lostReplicas <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>lostReplicas<span class="token punctuation">,</span> cannotReplicateReplicas<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>省略部分代码

    <span class="token keyword">if</span> promotedReplica <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>lostReplicas<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>DetachLostReplicasAfterMasterFailover <span class="token punctuation">{<!-- --></span>
        postponedFunction <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: lost %+v replicas during recovery process; detaching them"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>lostReplicas<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> replica <span class="token operator">:=</span> <span class="token keyword">range</span> lostReplicas <span class="token punctuation">{<!-- --></span>
                replica <span class="token operator">:=</span> replica
                inst<span class="token punctuation">.</span><span class="token function">DetachReplicaMasterHost</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>replica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 对lostReplicas并发执行 DetachReplicaMasterHost</span>
        topologyRecovery<span class="token punctuation">.</span><span class="token function">AddPostponedFunction</span><span class="token punctuation">(</span>postponedFunction<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster, detach %+v lost replicas"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>lostReplicas<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token operator">...</span>省略部分代码

    <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RecoverDeadMaster: %d postponed functions"</span><span class="token punctuation">,</span> topologyRecovery<span class="token punctuation">.</span>PostponedFunctionsContainer<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> promotedReplica <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>postponedAll <span class="token punctuation">{<!-- --></span> <span class="token comment">// 有候选人, 并且不是理想的候选人</span>
        <span class="token comment">// 这里的意思是, 我们一开始选了一个new master, 可能因为他有最全的日志, 但是, 他不是我们设置的prefer的实例, 那么我们就重新组织一下拓扑, 把prefer的再变成new master</span>
        promotedReplica<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">replacePromotedReplicaWithCandidate</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> <span class="token operator">&amp;</span>analysisEntry<span class="token punctuation">.</span>AnalyzedInstanceKey<span class="token punctuation">,</span> promotedReplica<span class="token punctuation">,</span> candidateInstanceKey<span class="token punctuation">)</span>
        topologyRecovery<span class="token punctuation">.</span><span class="token function">AddError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> promotedReplica <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        message <span class="token operator">:=</span> <span class="token string">"Failure: no replica promoted."</span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
        inst<span class="token punctuation">.</span><span class="token function">AuditOperation</span><span class="token punctuation">(</span><span class="token string">"recover-dead-master"</span><span class="token punctuation">,</span> failedInstanceKey<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        message <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"promoted replica: %+v"</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
        <span class="token function">AuditTopologyRecovery</span><span class="token punctuation">(</span>topologyRecovery<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
        inst<span class="token punctuation">.</span><span class="token function">AuditOperation</span><span class="token punctuation">(</span><span class="token string">"recover-dead-master"</span><span class="token punctuation">,</span> failedInstanceKey<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> promotedReplica<span class="token punctuation">,</span> lostReplicas<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>

</code></pre> 
<p>recoverDeadMaster 主要做了几件事 ^a0c808</p> 
<ol><li>GetMasterRecoveryType, 确定到底用什么方式恢复, 是基于GTID? PseudoGTID? 还是BinlogServer?</li><li>重组拓扑, 我们的案例是使用RegroupReplicasGTID.<br> 但这里有一个问题, 可能现在我们的新主库并不是我们"期望"的实例, 就是说之所以选他做主库可能是因为他有最全的日志. 但不是我们设置的prefer的<br> 所以通过一个闭包promotedReplicaIsIdeal去做了判断和标记(通过postponedAll)<br> 如果postponedAll=false, 则需要重组拓扑, 选择prefer的replica作为新主库 
  <blockquote> 
   <p>postponedAll=true表是candidate就是"理想型", 所有replica恢复可以并行异步执行</p> 
  </blockquote> </li><li>如果存在lostReplicas, 并且开启了<a href="https://github.com/Fanduzi/orchestrator-zh-doc/blob/master/Setup/%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-%E2%85%A1.md#detachlostreplicasaftermasterfailover">DetachLostReplicasAfterMasterFailover</a>, 那么会并行的对所有lostReplicas执行DetachReplicaMasterHost 
  <blockquote> 
   <p>其实就是执行change master to master_host=‘// {host}’</p> 
  </blockquote> </li><li>如果当前选举的new master不是我们prefer的实例, 重组拓扑, 用prefer做新主库</li></ol> 
<p>recoverDeadMaster还是干了挺多事儿的, 尤其是RegroupReplicasGTID中的逻辑还是很复杂的. 本文就先不继续展开了, 要知后事如何, 请看<a href="https://blog.csdn.net/ashic/article/details/124784528">Orchestrator Failover过程源码分析-III</a></p> 
<h3><a id="_472"></a>初步流程总结</h3> 
<p><img src="https://images2.imgbox.com/5a/63/zSWZtB5k_o.png" alt=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/07ceee4cb848e3b9fb64ec7854211b1b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[转](3条消息) docker安装Mysql8.0的坑之lower(转载请删除括号里的内容)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/182fbaba8406314cdbe8775ad6e327c2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">BeanFactory和ApplicationContext谁才是SpringIoC容器？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>