<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>华为云CES监控与飞书通知 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="华为云CES监控与飞书通知" />
<meta property="og:description" content="华为云负载均衡连接数监控与飞书通知 在云服务的日常运维中，持续监控资源状态是保障系统稳定性的关键步骤之一。本文通过一个实际案例展示了如何使用华为云的Go SDK获取负载均衡器的连接数，并通过飞书Webhook发送通知到团队群组，以便运维人员及时获取最新的监控信息。本来准备直接使用ces告警，但是看了一下模版以及最佳实践貌似没有很好的支持webhook，就直接自己使用go sdk实现了！
背景知识 在华为云上，负载均衡服务（ELB）用于分发来自客户端的网络请求到多个云服务器，确保系统在面对不同的负载情况时，仍能够提供稳定、可靠的服务。ELB的性能指标，如每分钟连接数（CPS），是反映当前系统承载能力的重要数据。通常情况下，我们希望能够实时监控这些关键指标。
随着云服务技术的成熟，大型企业往往会将监控数据集成到实时通讯工具中，便于团队成员即时查看和响应潜在的问题。本案例中选择的通讯工具是飞书，华为云Go SDK则是我们与华为云服务交互的媒介。
环境准备 华为云提供的Go SDK是一套围绕华为云API构建的开发工具包，使得开发者可以在Go语言环境中便捷地调用云服务。在这里，我们利用Cloud Eye Service (CES) 的API，通过SDK检索ELB的CPS指标数据。
安装华为云Go SDK 首先需要安装华为云Go SDK。可以通过go get命令安装所需的SDK包：
go get -u github.com/huaweicloud/huaweicloud-sdk-go-v3 安装完成后，即可在项目中引入相关的SDK模块。
初始化客户端 要与华为云的服务交互，我们需要创建并初始化一个SDK客户端。如下示例中，我们创建了用于CES（Cloud Eye Service）服务的客户端，并使用了之前提到的AK和SK进行了认证。
package main // 导入相关的包 import ( &#34;fmt&#34; &#34;bytes&#34; &#34;json&#34; &#34;http&#34; &#34;ioutil&#34; &#34;time&#34; &#34;github.com/huaweicloud/huaweicloud-sdk-go-v3/core/auth/basic&#34; &#34;github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1&#34; ces &#34;github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1/model&#34; ) const ( feishuWebhookURL = &#34;xxxx&#34; // 飞书Webhook URL ak = &#34;xxx&#34; // Access Key sk = &#34;xxxxx&#34; // Secret Key ) func main() { // 构建认证信息 auth := basic." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dc74fb44a6e106fa56badbff92f1f87a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T21:33:49+08:00" />
<meta property="article:modified_time" content="2024-01-04T21:33:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">华为云CES监控与飞书通知</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>华为云负载均衡连接数监控与飞书通知</h2> 
<p>在云服务的日常运维中，持续监控资源状态是保障系统稳定性的关键步骤之一。本文通过一个实际案例展示了如何使用华为云的Go SDK获取负载均衡器的连接数，并通过飞书Webhook发送通知到团队群组，以便运维人员及时获取最新的监控信息。本来准备直接使用ces告警，但是看了一下模版以及最佳实践貌似没有很好的支持webhook，就直接自己使用go sdk实现了！</p> 
<h3><a id="_3"></a>背景知识</h3> 
<p>在华为云上，负载均衡服务（ELB）用于分发来自客户端的网络请求到多个云服务器，确保系统在面对不同的负载情况时，仍能够提供稳定、可靠的服务。ELB的性能指标，如每分钟连接数（CPS），是反映当前系统承载能力的重要数据。通常情况下，我们希望能够实时监控这些关键指标。</p> 
<p>随着云服务技术的成熟，大型企业往往会将监控数据集成到实时通讯工具中，便于团队成员即时查看和响应潜在的问题。本案例中选择的通讯工具是飞书，华为云Go SDK则是我们与华为云服务交互的媒介。</p> 
<h3><a id="_9"></a>环境准备</h3> 
<p>华为云提供的Go SDK是一套围绕华为云API构建的开发工具包，使得开发者可以在Go语言环境中便捷地调用云服务。在这里，我们利用Cloud Eye Service (CES) 的API，通过SDK检索ELB的CPS指标数据。</p> 
<h4><a id="Go_SDK_13"></a>安装华为云Go SDK</h4> 
<p>首先需要安装华为云Go SDK。可以通过<code>go get</code>命令安装所需的SDK包：</p> 
<pre><code class="prism language-bash">go get <span class="token parameter variable">-u</span> github.com/huaweicloud/huaweicloud-sdk-go-v3
</code></pre> 
<p>安装完成后，即可在项目中引入相关的SDK模块。</p> 
<h4><a id="_22"></a>初始化客户端</h4> 
<p>要与华为云的服务交互，我们需要创建并初始化一个SDK客户端。如下示例中，我们创建了用于CES（Cloud Eye Service）服务的客户端，并使用了之前提到的AK和SK进行了认证。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token comment">// 导入相关的包</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"bytes"</span>
    <span class="token string">"json"</span>
    <span class="token string">"http"</span>
    <span class="token string">"ioutil"</span>
    <span class="token string">"time"</span>

    <span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/core/auth/basic"</span>
    <span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1"</span>
    ces <span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1/model"</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    feishuWebhookURL <span class="token operator">=</span> <span class="token string">"xxxx"</span> <span class="token comment">// 飞书Webhook URL</span>
    ak               <span class="token operator">=</span> <span class="token string">"xxx"</span>  <span class="token comment">// Access Key</span>
    sk               <span class="token operator">=</span> <span class="token string">"xxxxx"</span> <span class="token comment">// Secret Key</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 构建认证信息</span>
    auth <span class="token operator">:=</span> basic<span class="token punctuation">.</span><span class="token function">NewCredentialsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
       <span class="token function">WithAk</span><span class="token punctuation">(</span>ak<span class="token punctuation">)</span><span class="token punctuation">.</span>
       <span class="token function">WithSk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">.</span>
       <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 初始化CES客户端</span>
    client <span class="token operator">:=</span> ces<span class="token punctuation">.</span><span class="token function">NewCesClient</span><span class="token punctuation">(</span>
       ces<span class="token punctuation">.</span><span class="token function">CesClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
          <span class="token function">WithRegion</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token string">"cn-east-3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
          <span class="token function">WithCredential</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">.</span>
          <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// ...后续代码</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_66"></a>设置定时器和执行任务</h3> 
<p>我们通过一个定时器来定期检查负载均衡器的最大连接数，例如：</p> 
<pre><code class="prism language-go">    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span> <span class="token comment">// 每分钟触发检查</span>
    <span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">case</span> t <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
          currentHour <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">// 只在既定的时间范围内执行</span>
          <span class="token keyword">if</span> currentHour <span class="token operator">&gt;=</span> <span class="token number">7</span> <span class="token operator">&amp;&amp;</span> currentHour <span class="token operator">&lt;</span> <span class="token number">24</span> <span class="token punctuation">{<!-- --></span>
             <span class="token comment">// 我们设定在59分时收集数据</span>
             <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">Minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">59</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">go</span> <span class="token function">collectDataAndSendToFeishu</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
             <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里限制了定时器发送的时间范围早上7点到24点执行，0点-7点默认不执行。并且执行的时间是每个小时的59分执行！</p> 
<h3><a id="_87"></a>收集和发送数据</h3> 
<p>一旦定时器触发并满足条件，我们会收集负载均衡的最大连接数并发送给飞书，参考 华为云ces <a href="https://console.huaweicloud.com/apiexplorer/#/openapi/CES/sdk?version=v1&amp;api=ShowMetricData" rel="nofollow">ShowMetricData</a>接口：<br> <img src="https://images2.imgbox.com/36/84/19kqZ3lo_o.png" alt="image.png"><br> 具体实现如下，注意**ShowMetricDataRequest **中具体参数：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">collectDataAndSendToFeishu</span><span class="token punctuation">(</span>client <span class="token operator">*</span>ces<span class="token punctuation">.</span>CesClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    currentTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UTC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    startTime <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Truncate</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Minute <span class="token operator">*</span> <span class="token number">58</span><span class="token punctuation">)</span>
    endTime <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>

    startTimestamp <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
    endTimestamp <span class="token operator">:=</span> endTime<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>

    request <span class="token operator">:=</span> <span class="token operator">&amp;</span>model<span class="token punctuation">.</span>ShowMetricDataRequest<span class="token punctuation">{<!-- --></span>
       Namespace<span class="token punctuation">:</span>  <span class="token string">"SYS.ELB"</span><span class="token punctuation">,</span>
       MetricName<span class="token punctuation">:</span> <span class="token string">"m1_cps"</span><span class="token punctuation">,</span>
       Dim0<span class="token punctuation">:</span>       <span class="token string">"lbaas_instance_id,xxxxxx"</span><span class="token punctuation">,</span>
       Filter<span class="token punctuation">:</span>     model<span class="token punctuation">.</span><span class="token function">GetShowMetricDataRequestFilterEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>MAX<span class="token punctuation">,</span>
       Period<span class="token punctuation">:</span>     <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       From<span class="token punctuation">:</span>       startTimestamp<span class="token punctuation">,</span>
       To<span class="token punctuation">:</span>         endTimestamp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">ShowMetricData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error querying CES data:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
       <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"CES response: %+v\n"</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>

    <span class="token comment">// Extract max value and timestamp from the response</span>
    <span class="token keyword">var</span> maxConnection <span class="token builtin">float64</span>
    <span class="token keyword">var</span> timestamp <span class="token builtin">int64</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>Datapoints <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>response<span class="token punctuation">.</span>Datapoints<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
       datapoints <span class="token operator">:=</span> <span class="token operator">*</span>response<span class="token punctuation">.</span>Datapoints
       maxConnection <span class="token operator">=</span> <span class="token operator">*</span>datapoints<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Max
       timestamp <span class="token operator">=</span> datapoints<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Timestamp
    <span class="token punctuation">}</span>

    <span class="token comment">// Format the timestamp to a readable form</span>
    readableTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>timestamp<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>timestamp<span class="token operator">%</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span>
    <span class="token comment">// Prepare the message to send to Feishu</span>
    feishuMessage <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"当前时间 %s 负载均衡最大连接数是 %.2f"</span><span class="token punctuation">,</span> readableTime<span class="token punctuation">,</span> maxConnection<span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">sendToFeishuWebhook</span><span class="token punctuation">(</span>feishuWebhookURL<span class="token punctuation">,</span> feishuMessage<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error sending to Feishu webhook:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Webhook_138"></a>发送Webhook通知</h3> 
<p>最后，实现<code>sendToFeishuWebhook</code>方法以将消息推送到飞书。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">sendToFeishuWebhook</span><span class="token punctuation">(</span>webhookURL <span class="token builtin">string</span><span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    webhookMessage <span class="token operator">:=</span> FeishuWebhookMessage<span class="token punctuation">{<!-- --></span>
       MsgType<span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    webhookMessage<span class="token punctuation">.</span>Content<span class="token punctuation">.</span>Text <span class="token operator">=</span> message

    jsonData<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>webhookMessage<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to marshal webhook message: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> webhookURL<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create HTTP request: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span>

    client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to send HTTP request: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    responseBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to read webhook response body: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Feishu webhook response:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
根
</code></pre> 
<h3><a id="_177"></a>完整代码：</h3> 
<p>每小时59分统计58-59分最大值发送统计到飞书：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
<span class="token keyword">type</span> FeishuWebhookMessage <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    MsgType <span class="token builtin">string</span> <span class="token string">`json:"msg_type"`</span>
    Content <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
       Text <span class="token builtin">string</span> <span class="token string">`json:"text"`</span>
    <span class="token punctuation">}</span> <span class="token string">`json:"content"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    <span class="token comment">// 定时器间隔，用于根据特定时间点触发数据检索。例如：59分时执行任务，就是(59 - 当前时间的分钟数) x 每分钟的秒数</span>
    feishuWebhookURL <span class="token operator">=</span> <span class="token string">"xxxx"</span>
    ak               <span class="token operator">=</span> <span class="token string">"xxx"</span>
    sk               <span class="token operator">=</span> <span class="token string">"xxxxx"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    auth <span class="token operator">:=</span> basic<span class="token punctuation">.</span><span class="token function">NewCredentialsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
       <span class="token function">WithAk</span><span class="token punctuation">(</span>ak<span class="token punctuation">)</span><span class="token punctuation">.</span>
       <span class="token function">WithSk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">.</span>
       <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    client <span class="token operator">:=</span> ces<span class="token punctuation">.</span><span class="token function">NewCesClient</span><span class="token punctuation">(</span>
       ces<span class="token punctuation">.</span><span class="token function">CesClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
          <span class="token function">WithRegion</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token string">"cn-east-3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
          <span class="token function">WithCredential</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">.</span>
          <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span> <span class="token comment">// Check every 10 minutes to adjust for the next 59th minute.</span>
    <span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">case</span> t <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
          <span class="token comment">// 这里设置只在7-24点执行</span>
          currentHour <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> currentHour <span class="token operator">&gt;=</span> <span class="token number">7</span> <span class="token operator">&amp;&amp;</span> currentHour <span class="token operator">&lt;</span> <span class="token number">24</span> <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">Minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">59</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">go</span> <span class="token function">collectDataAndSendToFeishu</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
             <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">collectDataAndSendToFeishu</span><span class="token punctuation">(</span>client <span class="token operator">*</span>ces<span class="token punctuation">.</span>CesClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    currentTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UTC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    startTime <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Truncate</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Minute <span class="token operator">*</span> <span class="token number">58</span><span class="token punctuation">)</span>
    endTime <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>

    startTimestamp <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
    endTimestamp <span class="token operator">:=</span> endTime<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>

    request <span class="token operator">:=</span> <span class="token operator">&amp;</span>model<span class="token punctuation">.</span>ShowMetricDataRequest<span class="token punctuation">{<!-- --></span>
       Namespace<span class="token punctuation">:</span>  <span class="token string">"SYS.ELB"</span><span class="token punctuation">,</span>
       MetricName<span class="token punctuation">:</span> <span class="token string">"m1_cps"</span><span class="token punctuation">,</span>
       Dim0<span class="token punctuation">:</span>       <span class="token string">"lbaas_instance_id,xxxxxx"</span><span class="token punctuation">,</span>
       Filter<span class="token punctuation">:</span>     model<span class="token punctuation">.</span><span class="token function">GetShowMetricDataRequestFilterEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>MAX<span class="token punctuation">,</span>
       Period<span class="token punctuation">:</span>     <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       From<span class="token punctuation">:</span>       startTimestamp<span class="token punctuation">,</span>
       To<span class="token punctuation">:</span>         endTimestamp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">ShowMetricData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error querying CES data:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
       <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"CES response: %+v\n"</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>

    <span class="token comment">// Extract max value and timestamp from the response</span>
    <span class="token keyword">var</span> maxConnection <span class="token builtin">float64</span>
    <span class="token keyword">var</span> timestamp <span class="token builtin">int64</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>Datapoints <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>response<span class="token punctuation">.</span>Datapoints<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
       datapoints <span class="token operator">:=</span> <span class="token operator">*</span>response<span class="token punctuation">.</span>Datapoints
       maxConnection <span class="token operator">=</span> <span class="token operator">*</span>datapoints<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Max
       timestamp <span class="token operator">=</span> datapoints<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Timestamp
    <span class="token punctuation">}</span>

    <span class="token comment">// Format the timestamp to a readable form</span>
    readableTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>timestamp<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>timestamp<span class="token operator">%</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span>
    <span class="token comment">// Prepare the message to send to Feishu</span>
    feishuMessage <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"当前时间 %s 负载均衡最大连接数是 %.2f"</span><span class="token punctuation">,</span> readableTime<span class="token punctuation">,</span> maxConnection<span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">sendToFeishuWebhook</span><span class="token punctuation">(</span>feishuWebhookURL<span class="token punctuation">,</span> feishuMessage<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error sending to Feishu webhook:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// sendToFeishuWebhook sends a message to Feishu webhook</span>
<span class="token keyword">func</span> <span class="token function">sendToFeishuWebhook</span><span class="token punctuation">(</span>webhookURL <span class="token builtin">string</span><span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    webhookMessage <span class="token operator">:=</span> FeishuWebhookMessage<span class="token punctuation">{<!-- --></span>
       MsgType<span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    webhookMessage<span class="token punctuation">.</span>Content<span class="token punctuation">.</span>Text <span class="token operator">=</span> message

    jsonData<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>webhookMessage<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to marshal webhook message: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> webhookURL<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create HTTP request: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span>

    client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to send HTTP request: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    responseBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to read webhook response body: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Feishu webhook response:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>运行以上代码：<br> <img src="https://images2.imgbox.com/fa/0a/zIMedIJ7_o.jpg" alt="img_v3_026i_b57d3d26-178b-4f64-8ade-5ecfcd3917dg.jpg"></p> 
<h2><a id="_302"></a>其它的扩展玩法：</h2> 
<h3><a id="100_303"></a>每分钟检查一次，当连接数大于100报警触发</h3> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/core/auth/basic"</span>
	ces <span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1"</span>
	<span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1/model"</span>
	region <span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1/region"</span>
	<span class="token string">"io/ioutil"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> FeishuWebhookMessage <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	MsgType <span class="token builtin">string</span> <span class="token string">`json:"msg_type"`</span>
	Content <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		Text <span class="token builtin">string</span> <span class="token string">`json:"text"`</span>
	<span class="token punctuation">}</span> <span class="token string">`json:"content"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	feishuWebhookURL <span class="token operator">=</span> <span class="token string">"xxxx"</span>
	ak               <span class="token operator">=</span> <span class="token string">"xxxx"</span>
	sk               <span class="token operator">=</span> <span class="token string">"xxxxx"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	auth <span class="token operator">:=</span> basic<span class="token punctuation">.</span><span class="token function">NewCredentialsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">WithAk</span><span class="token punctuation">(</span>ak<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">WithSk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	client <span class="token operator">:=</span> ces<span class="token punctuation">.</span><span class="token function">NewCesClient</span><span class="token punctuation">(</span>
		ces<span class="token punctuation">.</span><span class="token function">CesClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">WithRegion</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token string">"cn-east-3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">WithCredential</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span> <span class="token comment">// Check every 10 minutes to adjust for the next 59th minute.</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> t <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			<span class="token comment">// 这里设置只在7-24点执行</span>
			currentHour <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> currentHour <span class="token operator">&gt;=</span> <span class="token number">7</span> <span class="token operator">&amp;&amp;</span> currentHour <span class="token operator">&lt;</span> <span class="token number">24</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">go</span> <span class="token function">collectDataAndSendToFeishu</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">collectDataAndSendToFeishu</span><span class="token punctuation">(</span>client <span class="token operator">*</span>ces<span class="token punctuation">.</span>CesClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	currentTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UTC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Truncate</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>
	startTime <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>
	endTime <span class="token operator">:=</span> currentTime

	startTimestamp <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
	endTimestamp <span class="token operator">:=</span> endTime<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>

	request <span class="token operator">:=</span> <span class="token operator">&amp;</span>model<span class="token punctuation">.</span>ShowMetricDataRequest<span class="token punctuation">{<!-- --></span>
		Namespace<span class="token punctuation">:</span>  <span class="token string">"SYS.ELB"</span><span class="token punctuation">,</span>
		MetricName<span class="token punctuation">:</span> <span class="token string">"m1_cps"</span><span class="token punctuation">,</span>
		Dim0<span class="token punctuation">:</span>       <span class="token string">"lbaas_instance_id,xxxxx"</span><span class="token punctuation">,</span>
		Filter<span class="token punctuation">:</span>     model<span class="token punctuation">.</span><span class="token function">GetShowMetricDataRequestFilterEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>MAX<span class="token punctuation">,</span>
		Period<span class="token punctuation">:</span>     <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		From<span class="token punctuation">:</span>       startTimestamp<span class="token punctuation">,</span>
		To<span class="token punctuation">:</span>         endTimestamp<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	response<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">ShowMetricData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error querying CES data:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"CES response: %+v\n"</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>

	<span class="token comment">// Extract max value and timestamp from the response</span>
	<span class="token keyword">var</span> maxConnection <span class="token builtin">float64</span>
	<span class="token keyword">var</span> timestamp <span class="token builtin">int64</span>
	<span class="token keyword">if</span> response<span class="token punctuation">.</span>Datapoints <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>response<span class="token punctuation">.</span>Datapoints<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		datapoints <span class="token operator">:=</span> <span class="token operator">*</span>response<span class="token punctuation">.</span>Datapoints
		maxConnection <span class="token operator">=</span> <span class="token operator">*</span>datapoints<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Max
		timestamp <span class="token operator">=</span> datapoints<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Timestamp
	<span class="token punctuation">}</span>

	<span class="token comment">// Format the timestamp to a readable form</span>
	readableTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>timestamp<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>timestamp<span class="token operator">%</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span>
	<span class="token comment">// Prepare the message to send to Feishu</span>
	<span class="token keyword">if</span> maxConnection <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Prepare the alert message to send to Feishu</span>
		feishuMessage <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"警告：当前时间 %s 负载均衡连接数超越100，当前数值是 %.2f"</span><span class="token punctuation">,</span> readableTime<span class="token punctuation">,</span> maxConnection<span class="token punctuation">)</span>

		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">sendToFeishuWebhook</span><span class="token punctuation">(</span>feishuWebhookURL<span class="token punctuation">,</span> feishuMessage<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error sending to Feishu webhook:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// sendToFeishuWebhook sends a message to Feishu webhook</span>
<span class="token keyword">func</span> <span class="token function">sendToFeishuWebhook</span><span class="token punctuation">(</span>webhookURL <span class="token builtin">string</span><span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	webhookMessage <span class="token operator">:=</span> FeishuWebhookMessage<span class="token punctuation">{<!-- --></span>
		MsgType<span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	webhookMessage<span class="token punctuation">.</span>Content<span class="token punctuation">.</span>Text <span class="token operator">=</span> message

	jsonData<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>webhookMessage<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to marshal webhook message: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> webhookURL<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create HTTP request: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span>

	client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to send HTTP request: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	responseBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to read webhook response body: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Feishu webhook response:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>为了方便代码的复用性，可读性。将100作为一个可配置常量提取出来：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/core/auth/basic"</span>
	ces <span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1"</span>
	<span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1/model"</span>
	region <span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1/region"</span>
	<span class="token string">"io/ioutil"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> FeishuWebhookMessage <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	MsgType <span class="token builtin">string</span> <span class="token string">`json:"msg_type"`</span>
	Content <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		Text <span class="token builtin">string</span> <span class="token string">`json:"text"`</span>
	<span class="token punctuation">}</span> <span class="token string">`json:"content"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token comment">// 定时器间隔，用于根据特定时间点触发数据检索。例如：59分时执行任务，就是(59 - 当前时间的分钟数) x 每分钟的秒数</span>
	feishuWebhookURL                <span class="token operator">=</span> <span class="token string">"xxxxx"</span>
	ak                              <span class="token operator">=</span> <span class="token string">"xxxx"</span>
	sk                              <span class="token operator">=</span> <span class="token string">"xxxx"</span>
	loadBalancerConnectionThreshold <span class="token operator">=</span> <span class="token number">100.00</span> <span class="token comment">// 负载均衡连接数阈值</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	auth <span class="token operator">:=</span> basic<span class="token punctuation">.</span><span class="token function">NewCredentialsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">WithAk</span><span class="token punctuation">(</span>ak<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">WithSk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	client <span class="token operator">:=</span> ces<span class="token punctuation">.</span><span class="token function">NewCesClient</span><span class="token punctuation">(</span>
		ces<span class="token punctuation">.</span><span class="token function">CesClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">WithRegion</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token string">"cn-east-3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">WithCredential</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span> <span class="token comment">// Check every 10 minutes to adjust for the next 59th minute.</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> t <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			<span class="token comment">// 这里设置只在7-24点执行</span>
			currentHour <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> currentHour <span class="token operator">&gt;=</span> <span class="token number">7</span> <span class="token operator">&amp;&amp;</span> currentHour <span class="token operator">&lt;</span> <span class="token number">24</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">go</span> <span class="token function">collectDataAndSendToFeishu</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">collectDataAndSendToFeishu</span><span class="token punctuation">(</span>client <span class="token operator">*</span>ces<span class="token punctuation">.</span>CesClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	currentTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UTC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Truncate</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>
	startTime <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>
	endTime <span class="token operator">:=</span> currentTime

	startTimestamp <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
	endTimestamp <span class="token operator">:=</span> endTime<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>

	request <span class="token operator">:=</span> <span class="token operator">&amp;</span>model<span class="token punctuation">.</span>ShowMetricDataRequest<span class="token punctuation">{<!-- --></span>
		Namespace<span class="token punctuation">:</span>  <span class="token string">"SYS.ELB"</span><span class="token punctuation">,</span>
		MetricName<span class="token punctuation">:</span> <span class="token string">"m1_cps"</span><span class="token punctuation">,</span>
		Dim0<span class="token punctuation">:</span>       <span class="token string">"lbaas_instance_id,xxxx"</span><span class="token punctuation">,</span>
		Filter<span class="token punctuation">:</span>     model<span class="token punctuation">.</span><span class="token function">GetShowMetricDataRequestFilterEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>MAX<span class="token punctuation">,</span>
		Period<span class="token punctuation">:</span>     <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		From<span class="token punctuation">:</span>       startTimestamp<span class="token punctuation">,</span>
		To<span class="token punctuation">:</span>         endTimestamp<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	response<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">ShowMetricData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error querying CES data:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"CES response: %+v\n"</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>

	<span class="token comment">// Extract max value and timestamp from the response</span>
	<span class="token keyword">var</span> maxConnection <span class="token builtin">float64</span>
	<span class="token keyword">var</span> timestamp <span class="token builtin">int64</span>
	<span class="token keyword">if</span> response<span class="token punctuation">.</span>Datapoints <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>response<span class="token punctuation">.</span>Datapoints<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		datapoints <span class="token operator">:=</span> <span class="token operator">*</span>response<span class="token punctuation">.</span>Datapoints
		maxConnection <span class="token operator">=</span> <span class="token operator">*</span>datapoints<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Max
		timestamp <span class="token operator">=</span> datapoints<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Timestamp
	<span class="token punctuation">}</span>

	<span class="token comment">// Format the timestamp to a readable form</span>
	readableTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>timestamp<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>timestamp<span class="token operator">%</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span>
	<span class="token comment">// Prepare the message to send to Feishu</span>
	<span class="token keyword">if</span> maxConnection <span class="token operator">&gt;</span> loadBalancerConnectionThreshold <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Prepare the alert message to send to Feishu</span>
		feishuMessage <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"警报：在%s，负载均衡器的连接数超过了%.2f，当前连接数：%.2f"</span><span class="token punctuation">,</span> readableTime<span class="token punctuation">,</span> loadBalancerConnectionThreshold<span class="token punctuation">,</span> maxConnection<span class="token punctuation">)</span>

		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">sendToFeishuWebhook</span><span class="token punctuation">(</span>feishuWebhookURL<span class="token punctuation">,</span> feishuMessage<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error sending to Feishu webhook:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// sendToFeishuWebhook sends a message to Feishu webhook</span>
<span class="token keyword">func</span> <span class="token function">sendToFeishuWebhook</span><span class="token punctuation">(</span>webhookURL <span class="token builtin">string</span><span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	webhookMessage <span class="token operator">:=</span> FeishuWebhookMessage<span class="token punctuation">{<!-- --></span>
		MsgType<span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	webhookMessage<span class="token punctuation">.</span>Content<span class="token punctuation">.</span>Text <span class="token operator">=</span> message

	jsonData<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>webhookMessage<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to marshal webhook message: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> webhookURL<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create HTTP request: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span>

	client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to send HTTP request: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	responseBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to read webhook response body: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Feishu webhook response:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>注意<strong>loadBalancerConnectionThreshold</strong> 为<strong>float64.</strong></p> 
<h3><a id="_MetricName_579"></a>增加 MetricName多个条件</h3> 
<p>这里以弹性IP EIP与负载均衡为例，我想查询负载均衡连接数大于100报警，并根据负载均衡对应eip的四个指标：<strong>“upstream_bandwidth_usage”，“downstream_bandwidth_usage”，“upstream_bandwidth”，"downstream_bandwidth"报警，完整代码如下：</strong></p> 
<pre><code class="prism language-shell">package main

<span class="token function">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/core/auth/basic"</span>
	ces <span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1"</span>
	<span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1/model"</span>
	region <span class="token string">"github.com/huaweicloud/huaweicloud-sdk-go-v3/services/ces/v1/region"</span>
	<span class="token string">"io/ioutil"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token builtin class-name">type</span> FeishuWebhookMessage struct <span class="token punctuation">{<!-- --></span>
	MsgType string <span class="token variable"><span class="token variable">`</span>json:<span class="token string">"msg_type"</span><span class="token variable">`</span></span>
	Content struct <span class="token punctuation">{<!-- --></span>
		Text string <span class="token variable"><span class="token variable">`</span>json:<span class="token string">"text"</span><span class="token variable">`</span></span>
	<span class="token punctuation">}</span> <span class="token variable"><span class="token variable">`</span>json:<span class="token string">"content"</span><span class="token variable">`</span></span>
<span class="token punctuation">}</span>

const <span class="token punctuation">(</span>
	// 定时器间隔，用于根据特定时间点触发数据检索。例如：59分时执行任务，就是<span class="token punctuation">(</span><span class="token number">59</span> - 当前时间的分钟数<span class="token punctuation">)</span> x 每分钟的秒数
	feishuWebhookURL                <span class="token operator">=</span> <span class="token string">"xxxxxxx"</span>
	ak                              <span class="token operator">=</span> <span class="token string">"xxx"</span>
	sk                              <span class="token operator">=</span> <span class="token string">"xxxx"</span>
	upstreamBandwidthThreshold      <span class="token operator">=</span> <span class="token number">40</span>    // 出网带宽阈值，单位Mbps
	downstreamBandwidthThreshold    <span class="token operator">=</span> <span class="token number">80</span>    // 入网带宽阈值，单位Mbps（示例中以百分比为单位，根据实际单位调整）
	upstreamUsageThreshold          <span class="token operator">=</span> <span class="token number">20</span>    // 出网带宽使用率阈值，单位百分比
	downstreamUsageThreshold        <span class="token operator">=</span> <span class="token number">40</span>    // 入网带宽使用率阈值，单位百分比
<span class="token punctuation">)</span>

var metricNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token punctuation">{<!-- --></span>
	<span class="token string">"upstream_bandwidth_usage"</span>,
	<span class="token string">"downstream_bandwidth_usage"</span>,
	<span class="token string">"upstream_bandwidth"</span>,
	<span class="token string">"downstream_bandwidth"</span>,
<span class="token punctuation">}</span>

func <span class="token function-name function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	auth :<span class="token operator">=</span> basic.NewCredentialsBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span>.
		WithAk<span class="token punctuation">(</span>ak<span class="token punctuation">)</span>.
		WithSk<span class="token punctuation">(</span>sk<span class="token punctuation">)</span>.
		Build<span class="token punctuation">(</span><span class="token punctuation">)</span>

	client :<span class="token operator">=</span> ces.NewCesClient<span class="token punctuation">(</span>
		ces.CesClientBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span>.
			WithRegion<span class="token punctuation">(</span>region.ValueOf<span class="token punctuation">(</span><span class="token string">"cn-east-3"</span><span class="token punctuation">))</span>.
			WithCredential<span class="token punctuation">(</span>auth<span class="token punctuation">)</span>.
			Build<span class="token punctuation">(</span><span class="token punctuation">))</span>

	ticker :<span class="token operator">=</span> time.NewTicker<span class="token punctuation">(</span>time.Minute<span class="token punctuation">)</span> // Check every minute.
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token operator">&lt;</span>-ticker.C:
			// 每分钟执行
			go collectDataAndSendToFeishu<span class="token punctuation">(</span>client<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

func collectDataAndSendToFeishu<span class="token punctuation">(</span>client *ces.CesClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	currentTime :<span class="token operator">=</span> time.Now<span class="token punctuation">(</span><span class="token punctuation">)</span>.UTC<span class="token punctuation">(</span><span class="token punctuation">)</span>.Truncate<span class="token punctuation">(</span>time.Minute<span class="token punctuation">)</span>
	startTime :<span class="token operator">=</span> currentTime.Add<span class="token punctuation">(</span>-1 * time.Minute<span class="token punctuation">)</span>
	endTime :<span class="token operator">=</span> currentTime

	startTimestamp :<span class="token operator">=</span> startTime.UnixMilli<span class="token punctuation">(</span><span class="token punctuation">)</span>
	endTimestamp :<span class="token operator">=</span> endTime.UnixMilli<span class="token punctuation">(</span><span class="token punctuation">)</span>
	dimensionValues :<span class="token operator">=</span> <span class="token string">"bandwidth_id,xxxx"</span>
	<span class="token keyword">for</span> _, metricName :<span class="token operator">=</span> range metricNames <span class="token punctuation">{<!-- --></span>
		request :<span class="token operator">=</span> <span class="token operator">&amp;</span>model.ShowMetricDataRequest<span class="token punctuation">{<!-- --></span>
			Namespace:  <span class="token string">"SYS.VPC"</span>,
			MetricName: metricName,
			Dim0:       dimensionValues, // Replace with actual dimension value
			Filter:     model.GetShowMetricDataRequestFilterEnum<span class="token punctuation">(</span><span class="token punctuation">)</span>.MAX,
			Period:     int32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,
			From:       startTimestamp,
			To:         endTimestamp,
		<span class="token punctuation">}</span>

		response, err :<span class="token operator">=</span> client.ShowMetricData<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
			fmt.Printf<span class="token punctuation">(</span><span class="token string">"Error querying CES data for %s: %v<span class="token entity" title="\n">\n</span>"</span>, metricName, err<span class="token punctuation">)</span>
			<span class="token builtin class-name">continue</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> response.Datapoints <span class="token operator">==</span> nil <span class="token operator">||</span> len<span class="token punctuation">(</span>*response.Datapoints<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			fmt.Printf<span class="token punctuation">(</span><span class="token string">"No datapoints received for %s<span class="token entity" title="\n">\n</span>"</span>, metricName<span class="token punctuation">)</span>
			<span class="token builtin class-name">continue</span>
		<span class="token punctuation">}</span>

		datapoints :<span class="token operator">=</span> *response.Datapoints
		var maxUsage float64
		<span class="token keyword">for</span> _, point :<span class="token operator">=</span> range datapoints <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> point.Max <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> metricName <span class="token operator">==</span> <span class="token string">"upstream_bandwidth"</span> <span class="token operator">||</span> metricName <span class="token operator">==</span> <span class="token string">"downstream_bandwidth"</span> <span class="token punctuation">{<!-- --></span>
					// Convert from bits to Mbits
					maxUsage <span class="token operator">=</span> *point.Max / <span class="token number">1000000.0</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					maxUsage <span class="token operator">=</span> *point.Max // <span class="token keyword">for</span> utilization metrics, <span class="token function">which</span> are percentages
				<span class="token punctuation">}</span>
				<span class="token builtin class-name">break</span> // Assuming there's only <span class="token number">1</span> datapoint with MAX filter
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>metricName <span class="token operator">==</span> <span class="token string">"upstream_bandwidth"</span> <span class="token operator">&amp;&amp;</span> maxUsage <span class="token operator">&gt;</span> upstreamBandwidthThreshold<span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token punctuation">(</span>metricName <span class="token operator">==</span> <span class="token string">"downstream_bandwidth"</span> <span class="token operator">&amp;&amp;</span> maxUsage <span class="token operator">&gt;</span> downstreamBandwidthThreshold<span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token punctuation">(</span>metricName <span class="token operator">==</span> <span class="token string">"upstream_bandwidth_usage"</span> <span class="token operator">&amp;&amp;</span> maxUsage <span class="token operator">&gt;</span> upstreamUsageThreshold<span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token punctuation">(</span>metricName <span class="token operator">==</span> <span class="token string">"downstream_bandwidth_usage"</span> <span class="token operator">&amp;&amp;</span> maxUsage <span class="token operator">&gt;</span> downstreamUsageThreshold<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

			alertMessage :<span class="token operator">=</span> createAlertMessage<span class="token punctuation">(</span>metricName, maxUsage, endTime<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err :<span class="token operator">=</span> sendToFeishuWebhook<span class="token punctuation">(</span>feishuWebhookURL, alertMessage<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
				fmt.Printf<span class="token punctuation">(</span><span class="token string">"Error sending to Feishu webhook: %v<span class="token entity" title="\n">\n</span>"</span>, err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

func createAlertMessage<span class="token punctuation">(</span>metricName string, usage float64, endTime time.Time<span class="token punctuation">)</span> string <span class="token punctuation">{<!-- --></span>
	readableTime :<span class="token operator">=</span> endTime.Add<span class="token punctuation">(</span>+8 * time.Hour<span class="token punctuation">)</span>.Format<span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span>
	var alertMessage string

	// 注意阈值和单位已更新，具体文本格式根据实际需要调整
	switch metricName <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> <span class="token string">"upstream_bandwidth"</span><span class="token builtin class-name">:</span>
		alertMessage <span class="token operator">=</span> fmt.Sprintf<span class="token punctuation">(</span><span class="token string">"警报：在%s，出网带宽超过了%.2fMbps，当前带宽：%.2fMbps"</span>, readableTime, upstreamBandwidthThreshold, usage<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token string">"downstream_bandwidth"</span><span class="token builtin class-name">:</span>
		alertMessage <span class="token operator">=</span> fmt.Sprintf<span class="token punctuation">(</span><span class="token string">"警报：在%s，入网带宽超过了%.2fMbps，当前带宽：%.2fMbps"</span>, readableTime, downstreamBandwidthThreshold, usage<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token string">"upstream_bandwidth_usage"</span><span class="token builtin class-name">:</span>
		alertMessage <span class="token operator">=</span> fmt.Sprintf<span class="token punctuation">(</span><span class="token string">"警报：在%s，出网带宽使用率超过了%.2f%%，当前使用率：%.2f%%"</span>, readableTime, upstreamUsageThreshold, usage<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token string">"downstream_bandwidth_usage"</span><span class="token builtin class-name">:</span>
		alertMessage <span class="token operator">=</span> fmt.Sprintf<span class="token punctuation">(</span><span class="token string">"警报：在%s，入网带宽使用率超过了%.2f%%，当前使用率：%.2f%%"</span>, readableTime, downstreamUsageThreshold, usage<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token builtin class-name">return</span> alertMessage
<span class="token punctuation">}</span>

func sendToFeishuWebhook<span class="token punctuation">(</span>webhookURL string, message string<span class="token punctuation">)</span> error <span class="token punctuation">{<!-- --></span>
	webhookMessage :<span class="token operator">=</span> FeishuWebhookMessage<span class="token punctuation">{<!-- --></span>
		MsgType: <span class="token string">"text"</span>,
	<span class="token punctuation">}</span>
	webhookMessage.Content.Text <span class="token operator">=</span> message

	jsonData, err :<span class="token operator">=</span> json.Marshal<span class="token punctuation">(</span>webhookMessage<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		<span class="token builtin class-name">return</span> fmt.Errorf<span class="token punctuation">(</span><span class="token string">"failed to marshal webhook message: %v"</span>, err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	req, err :<span class="token operator">=</span> http.NewRequest<span class="token punctuation">(</span><span class="token string">"POST"</span>, webhookURL, bytes.NewBuffer<span class="token punctuation">(</span>jsonData<span class="token punctuation">))</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		<span class="token builtin class-name">return</span> fmt.Errorf<span class="token punctuation">(</span><span class="token string">"failed to create HTTP request: %v"</span>, err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	req.Header.Set<span class="token punctuation">(</span><span class="token string">"Content-Type"</span>, <span class="token string">"application/json"</span><span class="token punctuation">)</span>

	client :<span class="token operator">=</span> <span class="token operator">&amp;</span>http.Client<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	resp, err :<span class="token operator">=</span> client.Do<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		<span class="token builtin class-name">return</span> fmt.Errorf<span class="token punctuation">(</span><span class="token string">"failed to send HTTP request: %v"</span>, err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	defer resp.Body.Close<span class="token punctuation">(</span><span class="token punctuation">)</span>

	responseBody, err :<span class="token operator">=</span> ioutil.ReadAll<span class="token punctuation">(</span>resp.Body<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		<span class="token builtin class-name">return</span> fmt.Errorf<span class="token punctuation">(</span><span class="token string">"failed to read webhook response body: %v"</span>, err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt.Printf<span class="token punctuation">(</span><span class="token string">"Feishu webhook response: %s<span class="token entity" title="\n">\n</span>"</span>, responseBody<span class="token punctuation">)</span>
	<span class="token builtin class-name">return</span> nil
<span class="token punctuation">}</span>

</code></pre> 
<p>测试报警如下：<br> <img src="https://images2.imgbox.com/82/c1/s2sBCkZL_o.png" alt="image.png"></p> 
<h3><a id="_756"></a>其他</h3> 
<ol><li>遍历负载均衡列表，批量查询所有负载均衡连接数？发送告警时候传入负载均衡的名称？</li><li>根据负载均衡列表查询绑定的eip实例，查询所有eip对应<strong>bandwidth_id</strong>，输出所有eip的指标？</li></ol> 
<h3><a id="_760"></a>总结</h3> 
<p>此文为你展示了如何通过Go SDK获取华为云上的负载均衡最大连接数and eip指标的多个条件查询，并通过飞书Webhook发送通知的过程。以上的实现可以根据你自己的需求进行调整，比如改变监测的指标或者消息发送的方式。希望本文能帮助你更好地监控和管理华为云上的资源。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bf9bc15514b7da4dd3ee0d254affae71/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深度学习-模型转换_所需算力相关</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a08ae549de5a724a1926202e41202c91/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">BUU-crypto-刷题记录20</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>