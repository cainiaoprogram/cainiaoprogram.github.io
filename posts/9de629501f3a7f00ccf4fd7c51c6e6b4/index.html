<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux内核编程Hello World - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux内核编程Hello World" />
<meta property="og:description" content="1. ker_HelloWorld.c程序编写 这里首先给出编写的源代码程序，后面对每行代码进行一一说明。
#include &lt;linux/module.h&gt; #include &lt;linux/kernel.h&gt; #include &lt;linux/init.h&gt; static char * cmd = &#34;&#34;; module_param(cmd, charp, S_IRUGO); static int __init helloworld_init(void) { printk(KERN_ALERT &#34;Hello world module init with cmd %s\n&#34;, cmd); return 0; } static void __exit helloworld_exit(void) { printk(KERN_ALERT &#34;Hello world module exit\n&#34;); } module_init(helloworld_init); module_exit(helloworld_exit); MODULE_LICENSE(&#34;GPL&#34;); MODULE_AUTHOR(&#34;o_o&#34;); MODULE_DESCRIPTION(&#34;Hello World Module&#34;); MODULE_VERSION(&#34;0.0.1&#34;); MODULE_ALIAS(&#34;Hi&#34;); #include &lt;linux/init.h&gt; 包含这个库，在一般的编译器程序中会报错。
原因是因为linux的/usr/include/linux/目录中并没有init.h这个头文件，但是这对我们kernel内核编程时不影响的。
因为后面我们并不是直接使用gcc对该ker_HelloWorld.c文件进行编译。
module_param static char * cmd = &#34;&#34;; module_param(cmd, charp, S_IRUGO); 声明了一个静态字符指针变量 cmd，使用 module_param 宏将其注册为内核参数，charp是一个数据类型，表示字符指针类型，权限为 S_IRUGO，即允许读取。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9de629501f3a7f00ccf4fd7c51c6e6b4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-23T21:59:35+08:00" />
<meta property="article:modified_time" content="2023-03-23T21:59:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux内核编程Hello World</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_ker_HelloWorldc_0"></a>1. ker_HelloWorld.c程序编写</h3> 
<p>这里首先给出编写的源代码程序，后面对每行代码进行一一说明。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>

<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span> cmd <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> charp<span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">helloworld_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT <span class="token string">"Hello world module init with cmd %s\n"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">helloworld_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT <span class="token string">"Hello world module exit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>helloworld_init<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">module_exit</span><span class="token punctuation">(</span>helloworld_exit<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"o_o"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Hello World Module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">MODULE_VERSION</span><span class="token punctuation">(</span><span class="token string">"0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">MODULE_ALIAS</span><span class="token punctuation">(</span><span class="token string">"Hi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>#include &lt;linux/init.h&gt;</li></ul> 
<p>包含这个库，在一般的编译器程序中会报错。</p> 
<p>原因是因为linux的<code>/usr/include/linux/</code>目录中并没有init.h这个头文件，但是这对我们kernel内核编程时不影响的。</p> 
<p>因为后面我们并不是直接使用gcc对该ker_HelloWorld.c文件进行编译。</p> 
<ul><li>module_param</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span> cmd <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> charp<span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>声明了一个静态字符指针变量 <code>cmd</code>，使用 <code>module_param</code> 宏将其注册为内核参数，charp是一个数据类型，表示字符指针类型，权限为 S_IRUGO，即允许读取。</p> 
<p>使得内核中的其他函数能够调用该内核参数<code>cmd</code></p> 
<ul><li>static int __init helloworld_init(void)</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">helloworld_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT <span class="token string">"Hello world module init with cmd %s\n"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>定义一个静态函数，将相应的信息<code>Hello world module init with cmd %s\n</code>输出到系统日志中。</p> 
<p>printk是Linux内核中用于输出信息的一种函数。它的作用类似于用户空间中的printf函数，但它输出的信息不是直接出出到终端等设备，而是通过<code>内核日志缓冲区</code>输出到<code>系统日志</code>中。</p> 
<p>__init和__initdata告诉内核这些函数和数据只在初始化期间使用，一旦初始化完成，它们就不再需要，从而可以释放掉它们占用的内存，从而提高系统的性能和效率。</p> 
<p>所以该函数名称中的__init关键字表示这是一个初始化函数。</p> 
<ul><li>static void __exit helloworld_exit(void)</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">helloworld_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT <span class="token string">"Hello world module exit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>定义一个静态函数，将相应的信息<code>Hello world module exit\n</code>输出到系统日志中。</p> 
<p>__exit告诉内核这些函数只在模块卸载时使用，一旦模块被卸载，它们就不再需要，从而可以释放掉它们占用的内存，从而提高系统的性能和效率。</p> 
<p>所以该函数名称中的__exit关键字表示这是一个清理函数，该函数在模块卸载时被调用。</p> 
<ul><li>module_init(helloworld_init);</li></ul> 
<p>将函数helloworld_init注册为当前内核模块的初始化函数，当这个内核模块被加载到系统中时，内核会自动调用这个函数来完成其初始化工作。</p> 
<ul><li>module_exit(helloworld_exit);</li></ul> 
<p>将函数helloworld_exit注册为当前内核模块的退出函数，当这个内核模块被卸载时，内核会自动调用这个函数来完成其退出工作。</p> 
<ul><li>MODULE_LICENSE(“GPL”);</li></ul> 
<p><code>MODULE_LICENSE()</code> 是一个 Linux 内核模块中的宏，用于声明模块的许可证信息。</p> 
<p>表示该模块的许可证是 GPL（GNU通用公共许可证）。</p> 
<ul><li>MODULE_AUTHOR(“o_o”);</li></ul> 
<p><code>MODULE_AUTHOR()</code> 是一个 Linux 内核模块中的宏，用于声明模块的作者信息。</p> 
<p>表示模块的作者是 “o_o”。</p> 
<ul><li>MODULE_DESCRIPTION(“Hello World Module”);</li></ul> 
<p><code>MODULE_DESCRIPTION()</code> 是一个 Linux 内核模块中的宏，用于声明模块的描述信息。</p> 
<p>表示该模块的描述信息为 “Hello World Module”。</p> 
<ul><li>MODULE_VERSION(“0.0.1”);</li></ul> 
<p><code>MODULE_VERSION()</code> 是一个 Linux 内核模块中的宏，用于声明模块的版本号。</p> 
<p>表示该模块的版本号为 “0.0.1”。</p> 
<ul><li>MODULE_ALIAS(“Hi”);</li></ul> 
<h3><a id="2_Makefile_121"></a>2. Makefile文件解读</h3> 
<pre><code class="prism language-makefile"># Makefile 4.0
obj-m := ker_HelloWorld.o
CURRENT_PATH := $(shell pwd)
LINUX_KERNEL := $(shell uname -r)
LINUX_KERNEL_PATH := /usr/src/linux-headers-$(LINUX_KERNEL)

all:
	make -C $(LINUX_KERNEL_PATH) M=$(CURRENT_PATH) modules
clean:
	make -C $(LINUX_KERNEL_PATH) M=$(CURRENT_PATH) clean
</code></pre> 
<ul><li>obj-m := ker_HelloWorld.o</li></ul> 
<ol><li>Makefile文件中的obj-m是什么意思?</li></ol> 
<p>在Makefile文件中，obj-m是指要编译成内核模块的目标文件名。它通常用于构建Linux内核模块。obj-m表示目标是一个模块，而不是一个可执行文件。该目标文件名的扩展名通常是“.ko”。</p> 
<p>第一行指定了要编译的内核模块的文件名，这里是ker_HelloWorld.o。</p> 
<ul><li>CURRENT_PATH := $(shell pwd)</li></ul> 
<p>CURRENT_PATH变量指定了当前目录的路径，它使用shell命令pwd来获取当前路径。</p> 
<ul><li>LINUX_KERNEL := $(shell uname -r)</li></ul> 
<p>LINUX_KERNEL变量指定了当前系统的内核版本号，它使用uname命令获取。</p> 
<ul><li>LINUX_KERNEL_PATH := /usr/src/linux-headers-$(LINUX_KERNEL)</li></ul> 
<p>LINUX_KERNEL_PATH变量指定了Linux内核源代码的路径，它使用Linux内核版本号拼接而成。</p> 
<ul><li>all</li></ul> 
<pre><code class="prism language-makefile">all:
	make -C $(LINUX_KERNEL_PATH) M=$(CURRENT_PATH) modules
</code></pre> 
<p>all规则使用make命令在$LINUX_KERNEL_PATH目录下构建内核模块，M参数指定了模块代码所在的目录是$(CURRENT_PATH)。</p> 
<ul><li>clean</li></ul> 
<pre><code class="prism language-makefile">clean:
	make -C $(LINUX_KERNEL_PATH) M=$(CURRENT_PATH) clean
</code></pre> 
<ul><li>clean规则使用make命令在$LINUX_KERNEL_PATH目录下清除内核模块的所有编译结果，M参数指定了模块代码所在的目录是$(CURRENT_PATH)。</li></ul> 
<h3><a id="3__176"></a>3. 运行</h3> 
<p>在上述工作均完成以后，我们在当前目录执行<code>make</code>命令生成内核模块module</p> 
<pre><code class="prism language-bash"><span class="token function">make</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1a/70/Zikz83aC_o.png" alt=""></p> 
<p>在文件目录中看到的一个以<code>.ko</code>后缀结尾的文件即为内核模块</p> 
<p>通过以下命令加载该内核模块</p> 
<pre><code class="prism language-C">sudo insmod ker_HelloWorld.ko
</code></pre> 
<p>在通过<code>lsmod</code>命令查看加载的内核模块，即可发现我们已经将编写的模块加入到内核中</p> 
<p><img src="https://images2.imgbox.com/99/95/NQvLe0vt_o.png" alt=""></p> 
<p>在通过<code>dmesg</code>查看内核相关信息，可以发现系统内核中打印出来了我们helloworld_init(void)函数打印的内容。</p> 
<p><img src="https://images2.imgbox.com/d3/9f/8B1hmfrH_o.png" alt="在这里插入图片描述"></p> 
<p>通过以下命令将模块从内核中删除</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> rmmod ker_HelloWorld
</code></pre> 
<p><img src="https://images2.imgbox.com/fe/88/AUS1L0GN_o.png" alt="在这里插入图片描述"></p> 
<ul><li>带参数将模块插入内核中</li></ul> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> insmod ker_HelloWorld.ko <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">"o_o'"</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a6/ec/y4kbTVoS_o.png" alt="在这里插入图片描述"></p> 
<p>通过以下指令即可将当前目录所生成的相应模块删除</p> 
<pre><code class="prism language-bash"><span class="token function">make</span> clean
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8b9d365a3a0b74f19f5333ab92339c82/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">qt生成帮助文档过程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dad624e68b180defc5cd9853d89dfb86/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Maple 入门常用教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>