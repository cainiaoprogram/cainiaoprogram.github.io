<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>零入门kubernetes网络实战-34-＞将物理网卡eth0挂载到虚拟网桥上使得内部网络能够跨主机ping通外网的方案 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="零入门kubernetes网络实战-34-＞将物理网卡eth0挂载到虚拟网桥上使得内部网络能够跨主机ping通外网的方案" />
<meta property="og:description" content="《零入门kubernetes网络实战》视频专栏地址
https://www.ixigua.com/7193641905282875942
本篇文章视频地址(稍后上传)
本篇文章模拟一下啊，将宿主机的对外的物理网卡，挂载到虚拟网桥上，测试一下，
网桥管理的内部网络如何跟宿主机的本局域网内的其他节点通信？
1、测试环境介绍 两台centos虚拟机
# 查看操作系统版本 cat /etc/centos-release # 内核版本 uname -a uname -r # 查看网卡信息 ip a s eth0 2、网络拓扑 将物理网卡eth0挂载到虚拟网桥br0，从master节点的ns1命名空间里向slave节点发起icmp请求
3、操作实战 3.1、在master上执行下面的命令 brctl addbr br0 ip link set br0 up ip addr add 10.211.55.122/24 dev br0 ip netns add ns1 ip link add veth1a type veth peer name veth1b ip link set veth1a netns ns1 ip netns exec ns1 ip addr add 10.244.1.2/24 dev veth1a ip netns exec ns1 ip link set veth1a up ip link set veth1b up brctl addif br0 veth1b brctl addif br0 eth0 ip netns exec ns1 route add default dev veth1a 在具体执行这些命令前，最好前提前多打开几个xshell终端，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/43368361bb48ade24fb021ecb94b8b48/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-05T08:01:48+08:00" />
<meta property="article:modified_time" content="2023-06-05T08:01:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">零入门kubernetes网络实战-34-＞将物理网卡eth0挂载到虚拟网桥上使得内部网络能够跨主机ping通外网的方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>《零入门kubernetes网络实战》视频专栏地址</p> 
<p>https://www.ixigua.com/7193641905282875942</p> 
<p>本篇文章视频地址(稍后上传)</p> 
<hr> 
<p>本篇文章模拟一下啊，将宿主机的对外的物理网卡，挂载到虚拟网桥上，测试一下，</p> 
<p>网桥管理的内部网络如何跟宿主机的本局域网内的其他节点通信？</p> 
<h2><a id="tabletrtd_bgcolor660099_alignleftfont_size5_colorffffff1fonttdtrtable_16"></a> 
 </h2><table><tbody><tr><td bgcolor="#660099" align="left"><font size="5" color="#ffffff">1、测试环境介绍</font></td></tr></tbody></table> 
<p>两台centos虚拟机</p> 
<pre><code># 查看操作系统版本
cat /etc/centos-release
# 内核版本
uname -a
uname -r 
# 查看网卡信息
ip a s eth0
</code></pre> 
<p><img src="https://images2.imgbox.com/9a/f5/xdEEoaXh_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="tabletrtd_bgcolor660099_alignleftfont_size5_colorffffff2fonttdtrtable_32"></a> 
 </h2><table><tbody><tr><td bgcolor="#660099" align="left"><font size="5" color="#ffffff">2、网络拓扑</font></td></tr></tbody></table> 
<p><img src="https://images2.imgbox.com/20/22/AjMRO0Z9_o.png" alt="在这里插入图片描述"></p> 
<p>将物理网卡eth0挂载到虚拟网桥br0，从master节点的ns1命名空间里向slave节点发起icmp请求</p> 
<h2><a id="tabletrtd_bgcolor660099_alignleftfont_size5_colorffffff3fonttdtrtable_38"></a> 
 </h2><table><tbody><tr><td bgcolor="#660099" align="left"><font size="5" color="#ffffff">3、操作实战</font></td></tr></tbody></table> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff31masterfonttdtrtable_39"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">3.1、在master上执行下面的命令</font></td></tr></tbody></table> 
<pre><code>brctl addbr br0
ip link set br0 up
ip addr add 10.211.55.122/24 dev br0

ip netns add ns1

ip link add veth1a type veth peer name veth1b

ip link set veth1a netns ns1
ip netns exec ns1 ip addr add 10.244.1.2/24 dev veth1a
ip netns exec ns1 ip link set veth1a up

ip link set veth1b up

brctl addif br0 veth1b
brctl addif br0 eth0

ip netns exec ns1 route add default dev veth1a
</code></pre> 
<p><img src="https://images2.imgbox.com/2d/56/zR2B3XEx_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>在具体执行这些命令前，最好前提前多打开几个xshell终端，<br> 一旦，执行了这些命令，就不能重新打开xshell终端了<br> 如果不给网桥配置IP的话，执行完brctl addif br0 eth0后，xshell终端就链接不上了。</p> 
</blockquote> 
<p>将eth0挂载到网桥上后，eth0网卡的地位，就降低了，就不具备三层IP功能了。</p> 
<p>只保留MAC地址。</p> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff32fonttdtrtable_70"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">3.2、查看一下，当前的网桥信息</font></td></tr></tbody></table> 
<pre><code>brctl show
brctl showmacs br0
brctl showstp br0
</code></pre> 
<p>查看网桥缓存的MAC信息<br> <img src="https://images2.imgbox.com/86/aa/yF04bikJ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/2b/a2/qvGOMINQ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff33masterveth1afonttdtrtable_81"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">3.3、在master节点对veth1a进行抓包</font></td></tr></tbody></table> 
<pre><code>ip netns exec ns1 tcpdump -nn -i veth1a
ip netns exec ns1 tcpdump -nn -i veth1a -w icmp-veth1a.pcap
</code></pre> 
<p><img src="https://images2.imgbox.com/66/f8/8JokkiBY_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff34mastereth0fonttdtrtable_88"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">3.4、在master节点对eth0进行抓包</font></td></tr></tbody></table> 
<pre><code>tcpdump -nn -i eth0 icmp
tcpdump -nn -i eth0 icmp -w icmp.pcap
</code></pre> 
<p><img src="https://images2.imgbox.com/3c/06/UKRk9gim_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff35masterfonttdtrtable_95"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">3.5、在master节点上，发起请求</font></td></tr></tbody></table> 
<pre><code>ip netns exec ns1 ping -c 1 10.211.55.123
</code></pre> 
<p><img src="https://images2.imgbox.com/f5/8c/81p78E19_o.png" alt="在这里插入图片描述"></p> 
<pre><code>ip netns exec ns1 arp -n
</code></pre> 
<p><img src="https://images2.imgbox.com/02/d1/xnX0E4fP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff36fonttdtrtable_107"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">3.6、根据上面的抓包分析</font></td></tr></tbody></table> 
<p>可以知道，当slave节点收到master节点发送的数据包后，<br> 开始回包，发现目的地址是10.244.1.2，属于跨网段了<br> 因此，slave在回馈包的时候，将目的MAC地址重写成本局域网的网关地址，<br> 当master节点收到此数据包后，发现MAC地址，并非是自己的就丢弃了。</p> 
<p>其实，也就是在slave节点上，没有去往10.244.1.0/24网段的路由，</p> 
<p>因此，只要在slave节点上，添加上指定的路由即可。</p> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff37slavefonttdtrtable_118"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">3.7、在slave节点上，添加上指定的路由</font></td></tr></tbody></table> 
<pre><code>route add -net 10.244.1.0/24 dev eth0
route -n
</code></pre> 
<p><img src="https://images2.imgbox.com/df/98/eqfeAvYS_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff38masterfonttdtrtable_125"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">3.8、在master节点上，重新测试</font></td></tr></tbody></table> 
<pre><code>ip netns exec ns1 ping -c 1 10.211.55.123
</code></pre> 
<p><img src="https://images2.imgbox.com/a6/dd/QAc1lU91_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="tabletrtd_bgcolor660099_alignleftfont_size5_colorffffff4fonttdtrtable_138"></a> 
 </h2><table><tbody><tr><td bgcolor="#660099" align="left"><font size="5" color="#ffffff">4、提供完整的测试用例</font></td></tr></tbody></table> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff41masterfonttdtrtable_139"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">4.1、在master节点上具体命令</font></td></tr></tbody></table> 
<pre><code>brctl addbr br0
ip link set br0 up
ip addr add 10.211.55.122/24 dev br0

ip netns add ns1

ip link add veth1a type veth peer name veth1b

ip link set veth1a netns ns1
ip netns exec ns1 ip addr add 10.244.1.2/24 dev veth1a
ip netns exec ns1 ip link set veth1a up

ip link set veth1b up

brctl addif br0 veth1b
brctl addif br0 eth0

ip netns exec ns1 route add default dev veth1a

</code></pre> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff42slavefonttdtrtable_162"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">4.2、进入slave节点上</font></td></tr></tbody></table> 
<p>添加去往master节点的10.244.1.0/24网段的路由</p> 
<pre><code>route add -net 10.244.1.0/24 dev eth0
route -n
</code></pre> 
<h3><a id="tabletrtd_bgcolor68228B_alignleftfont_size4_colorffffff43mastericmpfonttdtrtable_170"></a> 
 </h3><table><tbody><tr><td bgcolor="##68228B" align="left"><font size="4" color="#ffffff">4.3、在master节点上，发起icmp请求</font></td></tr></tbody></table> 
<pre><code>ip netns exec ns1 ping -c 1 10.211.55.123
</code></pre> 
<h2><a id="tabletrtd_bgcolor660099_alignleftfont_size5_colorffffff5fonttdtrtable_176"></a> 
 </h2><table><tbody><tr><td bgcolor="#660099" align="left"><font size="5" color="#ffffff">5、总结</font></td></tr></tbody></table> 
<ul><li>本文主要尝试了一下，将物理网卡eth0挂载的网桥上的通信方式。</li><li>这么用的一个好处，应该是，从网桥管理的内网发送出去的数据包，不会走网络协议栈了，直接利用网桥的二层转发功能，就转发出去了。效率会提高。</li><li>本次的网络拓扑有点类似于在同一个宿主机上使用bridge链接不同网段的多个网络命名空间的通信方案。都是利用了bridge的二层转发功能。</li><li>一般实际中，应该也不会这么用的。</li><li>除了给slave节点上，添加路由外，好像还可以在master节点上，添加SNAT(下面论述仅供参考) 
  <ul><li>即，将本节点发送出去的数据包的源IP地址改为宿主机对外网卡的地址</li><li>但是，对外网卡的IP地址，其实已经不起作用了。</li><li>这种方式下，eth0是可以接收到反馈的数据包的。</li><li>目的MAC地址，就是eth0的MAC，IP也是10.211.55.122</li><li>但是，此时的eth0的IP 是不起作用的。</li><li>因此，使用了SNAT，eth0看似收到了正确的包，也无法处理。</li></ul> </li></ul> 
<hr> 
<p><a href="https://blog.csdn.net/u011582922/article/details/128756964">&lt;&lt;零入门kubernetes网络实战&gt;&gt;技术专栏之文章目录</a></p> 
<hr>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/faeab8a932a6005b5305a14382255837/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">YOLO8自定义检测实战</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0e3b415cd10ea989479c6cd84778ce80/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue项目播放海康,大华等rtsp视频流-webrtc</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>