<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ROS2使用nav2全教程 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ROS2使用nav2全教程" />
<meta property="og:description" content="1. 建图 1.1 绘制地图 绘制地图需要什么？
1.配备以下设备的机器人: LIDAR和Odometry 2.机器人环境
我们使用cartographer_ros这个 cartographer 的 ROS 封装器，来建图。
在ROS2中启动cartographer，需要启动两个节点
import os from launch import LaunchDescription from ament_index_python.packages import get_package_share_directory from launch_ros.actions import Node def generate_launch_description(): cartographer_config_dir = os.path.join(get_package_share_directory(&#39;cartographer_slam&#39;), &#39;config&#39;) configuration_basename = &#39;cartographer.lua&#39; return LaunchDescription([ Node( package=&#39;cartographer_ros&#39;, executable=&#39;cartographer_node&#39;, name=&#39;cartographer_node&#39;, output=&#39;screen&#39;, parameters=[{&#39;use_sim_time&#39;: True}], arguments=[&#39;-configuration_directory&#39;, cartographer_config_dir, &#39;-configuration_basename&#39;, configuration_basename]), Node( package=&#39;cartographer_ros&#39;, executable=&#39;occupancy_grid_node&#39;, output=&#39;screen&#39;, name=&#39;occupancy_grid_node&#39;, parameters=[{&#39;use_sim_time&#39;: True}], arguments=[&#39;-resolution&#39;, &#39;0.05&#39;, &#39;-publish_period_sec&#39;, &#39;1.0&#39;] ), ]) 第一个节点指定建图的配置，使用lua语言：
include &#34;map_builder.lua&#34; include &#34;trajectory_builder.lua&#34; options = { map_builder = MAP_BUILDER, trajectory_builder = TRAJECTORY_BUILDER, map_frame = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5d917e155b54dc0f3b182a4cb0fb5636/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-15T07:59:57+08:00" />
<meta property="article:modified_time" content="2023-08-15T07:59:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ROS2使用nav2全教程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1. 建图</h2> 
<h3><a id="11___2"></a>1.1 绘制地图</h3> 
<p>绘制地图需要什么？<br> 1.配备以下设备的机器人: LIDAR和Odometry 2.机器人环境</p> 
<p>我们使用cartographer_ros这个 cartographer 的 ROS 封装器，来建图。</p> 
<p>在ROS2中启动cartographer，需要启动两个节点</p> 
<pre><code class="prism language-python">
<span class="token keyword">import</span> os
<span class="token keyword">from</span> launch <span class="token keyword">import</span> LaunchDescription
<span class="token keyword">from</span> ament_index_python<span class="token punctuation">.</span>packages <span class="token keyword">import</span> get_package_share_directory
<span class="token keyword">from</span> launch_ros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> Node

<span class="token keyword">def</span> <span class="token function">generate_launch_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    cartographer_config_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'cartographer_slam'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">)</span>
    configuration_basename <span class="token operator">=</span> <span class="token string">'cartographer.lua'</span>

    <span class="token keyword">return</span> LaunchDescription<span class="token punctuation">(</span><span class="token punctuation">[</span>
        
        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'cartographer_ros'</span><span class="token punctuation">,</span> 
            executable<span class="token operator">=</span><span class="token string">'cartographer_node'</span><span class="token punctuation">,</span> 
            name<span class="token operator">=</span><span class="token string">'cartographer_node'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'use_sim_time'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            arguments<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'-configuration_directory'</span><span class="token punctuation">,</span> cartographer_config_dir<span class="token punctuation">,</span>
                       <span class="token string">'-configuration_basename'</span><span class="token punctuation">,</span> configuration_basename<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'cartographer_ros'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'occupancy_grid_node'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'occupancy_grid_node'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'use_sim_time'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            arguments<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'-resolution'</span><span class="token punctuation">,</span> <span class="token string">'0.05'</span><span class="token punctuation">,</span> <span class="token string">'-publish_period_sec'</span><span class="token punctuation">,</span> <span class="token string">'1.0'</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span> 

</code></pre> 
<p>第一个节点指定建图的配置，使用lua语言：</p> 
<pre><code class="prism language-lua">include <span class="token string">"map_builder.lua"</span>
include <span class="token string">"trajectory_builder.lua"</span>

options <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  map_builder <span class="token operator">=</span> MAP_BUILDER<span class="token punctuation">,</span>
  trajectory_builder <span class="token operator">=</span> TRAJECTORY_BUILDER<span class="token punctuation">,</span>
  map_frame <span class="token operator">=</span> <span class="token string">"map"</span><span class="token punctuation">,</span>                  <span class="token operator">#</span> 用于发布子地图的frame。通常设置为poses的父帧，常用<span class="token string">"map"</span>。
  tracking_frame <span class="token operator">=</span> <span class="token string">"base_footprint"</span><span class="token punctuation">,</span>  <span class="token operator">#</span> SLAM算法跟踪机器人状态的frame<span class="token punctuation">,</span>通常选择<span class="token string">"base_link"</span>或<span class="token string">"base_footprint"</span>
  published_frame <span class="token operator">=</span> <span class="token string">"odom"</span><span class="token punctuation">,</span>
  odom_frame <span class="token operator">=</span> <span class="token string">"odom"</span><span class="token punctuation">,</span>
  provide_odom_frame <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  publish_frame_projected_to_2d <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
  use_odometry <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span>   <span class="token operator">#</span>  如果启用，Cartographer将订阅odom话题，使用里程计数据进行SLAM。
  use_nav_sat <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  use_landmarks <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  num_laser_scans <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token operator">#</span> 订阅的激光扫描主题数量
  num_multi_echo_laser_scans <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  num_subdivisions_per_laser_scan <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  num_point_clouds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  lookup_transform_timeout_sec <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
  submap_publish_period_sec <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
  pose_publish_period_sec <span class="token operator">=</span> <span class="token number">5e-3</span><span class="token punctuation">,</span>
  trajectory_publish_period_sec <span class="token operator">=</span> <span class="token number">30e-3</span><span class="token punctuation">,</span>
  rangefinder_sampling_ratio <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">,</span>
  odometry_sampling_ratio <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">,</span>
  fixed_frame_pose_sampling_ratio <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">,</span>
  imu_sampling_ratio <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">,</span>
  landmarks_sampling_ratio <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

MAP_BUILDER<span class="token punctuation">.</span>use_trajectory_builder_2d <span class="token operator">=</span> <span class="token keyword">true</span>

TRAJECTORY_BUILDER_2D<span class="token punctuation">.</span>min_range <span class="token operator">=</span> <span class="token number">0.12</span>
TRAJECTORY_BUILDER_2D<span class="token punctuation">.</span>max_range <span class="token operator">=</span> <span class="token number">3.5</span>
TRAJECTORY_BUILDER_2D<span class="token punctuation">.</span>missing_data_ray_length <span class="token operator">=</span> <span class="token number">3.0</span>
TRAJECTORY_BUILDER_2D<span class="token punctuation">.</span>use_imu_data <span class="token operator">=</span> <span class="token keyword">false</span>
TRAJECTORY_BUILDER_2D<span class="token punctuation">.</span>use_online_correlative_scan_matching <span class="token operator">=</span> <span class="token keyword">true</span> 
TRAJECTORY_BUILDER_2D<span class="token punctuation">.</span>motion_filter<span class="token punctuation">.</span>max_angle_radians <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">rad</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>

POSE_GRAPH<span class="token punctuation">.</span>constraint_builder<span class="token punctuation">.</span>min_score <span class="token operator">=</span> <span class="token number">0.65</span>
POSE_GRAPH<span class="token punctuation">.</span>constraint_builder<span class="token punctuation">.</span>global_localization_min_score <span class="token operator">=</span> <span class="token number">0.7</span>

<span class="token comment">-- POSE_GRAPH.optimize_every_n_nodes = 0</span>

<span class="token keyword">return</span> options
</code></pre> 
<p>Cartographer 可与多种机器人和传感器配合使用。要获得最佳的地图效果，需要对其进行正确配置，所有配置都可以通过 Lua 配置文件给出。</p> 
<p>Cartographer 会自动订阅以下主题，如果机器人不在这些主题上发布信息，则必须重新映射：</p> 
<p><strong>/scan 用于激光数据</strong><br> <strong>/odom 用于里程测量数据</strong><br> <strong>/imu 用于 IMU 数据</strong></p> 
<p>第二个节点occupancy_grid_node 用来发布建图的地图数据，地图精度为0.05米，发布频率1s/次。</p> 
<p>使用 ros2 run teleop_twist_keyboard teleop_twist_keyboard 控制小车运动，把环境跑一遍。</p> 
<p><img src="https://images2.imgbox.com/55/62/osdyEDZY_o.png" alt="img"></p> 
<h3><a id="12___110"></a>1.2 保存地图</h3> 
<p>在目标文件夹下使用</p> 
<pre><code class="prism language-shell">ros2 run nav2_map_server map_saver_cli <span class="token parameter variable">-f</span> turtlebot_area
</code></pre> 
<p>在调用 map_saver_cli 之前，不要关闭cartographer节点 。这个命令将生成turtlebot_area.pgm 图像文件和 turtlebot_area.yaml 文件。</p> 
<p>包含有关地图分辨率的详细信息。</p> 
<p>image： 包含生成地图图像的文件名。</p> 
<p>resolution: 分辨率： 地图的分辨率（单位：米/像素）。</p> 
<p>origin： 地图左下角像素的坐标。这些坐标以二维（x、y、z）形式给出。第三个值表示旋转。如果没有旋转，该值将为 0。</p> 
<p>occupied_thresh： 数值大于此值的像素将被视为被占区域（标记为障碍物）。</p> 
<p>free_thresh： 小于此值的像素将被视为完全自由区域。</p> 
<p>negate： 反转地图的颜色。默认情况下，白色表示完全自由，黑色表示完全被占用。</p> 
<h3><a id="13__136"></a>1.3 使用保存好的地图</h3> 
<p>使用保存好的地图，需要启动<code>map_server</code> 和 <code>nav2_lifecycle_manager</code> 两个节点。</p> 
<p>map_server 用来发布地图数据， nav2_lifecycle_manager 用来管理nav2中有关节点的生命周期</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> ament_index_python<span class="token punctuation">.</span>packages <span class="token keyword">import</span> get_package_share_directory
<span class="token keyword">from</span> launch <span class="token keyword">import</span> LaunchDescription
<span class="token keyword">from</span> launch_ros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> Node

<span class="token keyword">def</span> <span class="token function">generate_launch_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    map_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'map_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'turtlebot_area.yaml'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> LaunchDescription<span class="token punctuation">(</span><span class="token punctuation">[</span>
        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_map_server'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'map_server'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'map_server'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'use_sim_time'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
                        <span class="token punctuation">{<!-- --></span><span class="token string">'yaml_filename'</span><span class="token punctuation">:</span>map_file<span class="token punctuation">}</span> 
                       <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_lifecycle_manager'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'lifecycle_manager'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'lifecycle_manager_mapper'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'use_sim_time'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'autostart'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'node_names'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'map_server'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="2___175"></a>2. 在环境中定位机器人</h2> 
<p>定位是指了解相对于环境的当前位置，在ROS中使用AMCL（自适应蒙特卡洛定位），发布 <code>/map</code>和 <code>/odom</code> 之间的变换，由于/odom一般和/base_link相连，因此可以定位机器人的位置。</p> 
<h3><a id="21__179"></a>2.1 局部定位</h3> 
<p>在ROS2中使用定位，相较于1.3使用保存好的地图，多了一个localization算法的节点,同时 lifecycle_manager节点中要加入amcl</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os

<span class="token keyword">from</span> ament_index_python<span class="token punctuation">.</span>packages <span class="token keyword">import</span> get_package_share_directory
<span class="token keyword">from</span> launch <span class="token keyword">import</span> LaunchDescription
<span class="token keyword">from</span> launch_ros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> Node

<span class="token keyword">def</span> <span class="token function">generate_launch_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    nav2_yaml <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'localization_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'amcl_config.yaml'</span><span class="token punctuation">)</span>
    map_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'map_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'turtlebot_area.yaml'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> LaunchDescription<span class="token punctuation">(</span><span class="token punctuation">[</span>
        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_map_server'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'map_server'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'map_server'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'use_sim_time'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
                        <span class="token punctuation">{<!-- --></span><span class="token string">'yaml_filename'</span><span class="token punctuation">:</span>map_file<span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
            
        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_amcl'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'amcl'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'amcl'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span>nav2_yaml<span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>

        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_lifecycle_manager'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'lifecycle_manager'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'lifecycle_manager_localization'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'use_sim_time'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'autostart'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'node_names'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'map_server'</span><span class="token punctuation">,</span> <span class="token string">'amcl'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>使用的定位节点采用AMCL算法来定位，配置下面的参数</p> 
<pre><code class="prism language-python">amcl<span class="token punctuation">:</span>
  ros__parameters<span class="token punctuation">:</span>
    use_sim_time<span class="token punctuation">:</span> <span class="token boolean">True</span>
    alpha1<span class="token punctuation">:</span> <span class="token number">0.2</span>              <span class="token comment"># 机器人运动的旋转分量对里程测量旋转估算值产生的预期噪声</span>
    alpha2<span class="token punctuation">:</span> <span class="token number">0.2</span>
    alpha3<span class="token punctuation">:</span> <span class="token number">0.2</span>
    alpha4<span class="token punctuation">:</span> <span class="token number">0.2</span>
    alpha5<span class="token punctuation">:</span> <span class="token number">0.2</span>
    base_frame_id<span class="token punctuation">:</span> <span class="token string">"base_footprint"</span>      <span class="token comment"># 机器人基座</span>
    beam_skip_distance<span class="token punctuation">:</span> <span class="token number">0.5</span>
    beam_skip_error_threshold<span class="token punctuation">:</span> <span class="token number">0.9</span>
    beam_skip_threshold<span class="token punctuation">:</span> <span class="token number">0.3</span>
    do_beamskip<span class="token punctuation">:</span> false
    global_frame_id<span class="token punctuation">:</span> <span class="token string">"map"</span>
    lambda_short<span class="token punctuation">:</span> <span class="token number">0.1</span>
    laser_likelihood_max_dist<span class="token punctuation">:</span> <span class="token number">2.0</span>
    laser_max_range<span class="token punctuation">:</span> <span class="token number">100.0</span>
    laser_min_range<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1.0</span>
    laser_model_type<span class="token punctuation">:</span> <span class="token string">"likelihood_field"</span>
    max_beams<span class="token punctuation">:</span> <span class="token number">60</span>
    max_particles<span class="token punctuation">:</span> <span class="token number">8000</span>
    min_particles<span class="token punctuation">:</span> <span class="token number">200</span>
    odom_frame_id<span class="token punctuation">:</span> <span class="token string">"odom"</span>
    pf_err<span class="token punctuation">:</span> <span class="token number">0.05</span>
    pf_z<span class="token punctuation">:</span> <span class="token number">0.99</span>
    recovery_alpha_fast<span class="token punctuation">:</span> <span class="token number">0.0</span>
    recovery_alpha_slow<span class="token punctuation">:</span> <span class="token number">0.0</span>
    resample_interval<span class="token punctuation">:</span> <span class="token number">1</span>
    robot_model_type<span class="token punctuation">:</span> <span class="token string">"differential"</span>    <span class="token comment"># differential小车或者 omnidirectional 小车</span>
    save_pose_rate<span class="token punctuation">:</span> <span class="token number">0.5</span>
    sigma_hit<span class="token punctuation">:</span> <span class="token number">0.2</span>
    tf_broadcast<span class="token punctuation">:</span> true
    transform_tolerance<span class="token punctuation">:</span> <span class="token number">1.0</span>
    update_min_a<span class="token punctuation">:</span> <span class="token number">0.2</span>
    update_min_d<span class="token punctuation">:</span> <span class="token number">0.25</span>
    z_hit<span class="token punctuation">:</span> <span class="token number">0.5</span>
    z_max<span class="token punctuation">:</span> <span class="token number">0.05</span>
    z_rand<span class="token punctuation">:</span> <span class="token number">0.5</span>
    z_short<span class="token punctuation">:</span> <span class="token number">0.05</span>
    set_initial_pose<span class="token punctuation">:</span> true  <span class="token comment"># 使 AMCL 从 initial_pose参数设置初始姿态，而不是等待 initial_pose 消息。也就是说可以通过其他方式来确定初始位置</span>
    initial_pose<span class="token punctuation">:</span> 
        x<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">4.44264</span>
        y<span class="token punctuation">:</span> <span class="token number">2.32243</span>
        yaw<span class="token punctuation">:</span> <span class="token number">0.328028</span>
   
</code></pre> 
<p>每次机器人开始工作时，都必须标明它的初始位置，可以通过rviz的点击的方式确定。也可以使用命令行的方式:</p> 
<pre><code class="prism language-shell">ros2 topic pub <span class="token parameter variable">-1</span> /initialpose geometry_msgs/msg/PoseWithCovarianceStamped <span class="token string">"{header: {stamp: {sec: 0}, frame_id: 'map'}, pose: {pose: {position: {x: 0.2, y: 0.0, z: 0.0}, orientation: {w: 1.0}}}}"</span>
</code></pre> 
<p>同理，通过编程的方式也是可以的。</p> 
<h3><a id="22__283"></a>2.2 全局定位</h3> 
<p>全局定位是在既没有人也没有机器人知道机器人在地图上的位置时使用的技术。机器人必须尝试确定自己的位置。使用全局定位，机器人将尝试在地图上识别自己的位置。</p> 
<p>要使用全局定位，需要两个步骤：</p> 
<ol><li>将滤波器的所有粒子分布在地图上。这一步通过调用名为 /reinitialize_global_localization 的服务来实现。</li><li>移动机器人，直到它检测到自己的位置。这一步可以通过随机移动机器人并避免障碍物来实现。如果环境简单，还可以通过使机器人在原地旋转（安全解决方案）来实现。</li></ol> 
<p>(a) 打开 amcl_config 配置文件并更新粒子的值。</p> 
<p>max_particles: 80000 min_particles: 2000 记得重新编译，以便将新的配置文件安装到安装目录中。</p> 
<p>(b) 现在运行定位程序。</p> 
<p>© 启动 rviz 并添加显示以可视化粒子云（ParticleCloud）。</p> 
<p>(d) 发布 2D_pose_estimate 主题，并观察机器人粒子。</p> 
<p>(e) 现在调用 reinitialize_global_localization 服务并观察粒子的扩散。</p> 
<p>在 命令行中执行以下命令：</p> 
<p>ros2 service call /reinitialize_global_localization std_srvs/srv/Empty</p> 
<p>在调用服务后，你应该在 RVIZ 中看到类似以下的情况：</p> 
<p>https://s3.eu-west-1.amazonaws.com/notebooks.ws/ros2-navigation-galactic-109/gifs/reinitialize_global_localization.gif</p> 
<p>(f) 现在，使用键盘来移动机器人，并观察粒子开始积聚。在某个时刻，粒子应该全部位于机器人的位置。</p> 
<h2><a id="3_316"></a>3.机器人路径规划</h2> 
<p>路径规划是指规划从 A 点到 B 点的轨迹，避开沿途的障碍物。</p> 
<p>在ROS2中，为了启动路径规划，在实现定位的基础上还要启动</p> 
<ul><li><code>planner</code> node</li><li><code>controller</code> node</li><li><code>manager of recovery behaviors</code> node</li><li><code>behavior tree navigator</code> node</li></ul> 
<h3><a id="31_planner_327"></a>3.1 planner节点</h3> 
<p>Nav2中的 <strong>planner</strong> 任务是为机器人找到一条从 A 点到 B 点的路径，是全局规划器。当机器人接受到一个<em>2d_Goal_Pose</em>时， <strong>planner</strong> 会根据地图上的已知障碍物规划路径</p> 
<p>节点配置文件的参数如下：</p> 
<pre><code class="prism language-python">planner_server<span class="token punctuation">:</span>
  ros__parameters<span class="token punctuation">:</span>
    expected_planner_frequency<span class="token punctuation">:</span> <span class="token number">10.0</span>
    use_sim_time<span class="token punctuation">:</span> <span class="token boolean">True</span>
    planner_plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"GridBased"</span><span class="token punctuation">]</span>
    GridBased<span class="token punctuation">:</span>
      plugin<span class="token punctuation">:</span> <span class="token string">"nav2_navfn_planner/NavfnPlanner"</span>
      tolerance<span class="token punctuation">:</span> <span class="token number">0.5</span>
      use_astar<span class="token punctuation">:</span> false
      allow_unknown<span class="token punctuation">:</span> true
</code></pre> 
<p>规划器默认使用的是<strong>Nav2Fn_Planner</strong> ，基于网格搜索的方式规划。它可以使用 A* 或 Dijkstra 算法查找两点之间的路径。</p> 
<p>在 Dijkstra 模式（use_astar = false）下，Dijkstra 搜索算法保证在任何条件下都能找到最短路径。</p> 
<p>在 A* 模式（use_astar = true）下，A* 的搜索算法并不保证能找到最短路径，但它会使用启发式方法来扩大通向目标的潜在区域，从而更快地找到可能的路径。</p> 
<p>目标姿势与路径终点之间的容差为0.5m, allow_unknown指的是允许在未知空间进行规划。</p> 
<h3><a id="32_controllers_356"></a>3.2 controllers节点</h3> 
<p>Nav2中的 <strong>controller</strong> 相当于局部规划器，其主要任务是从当前位置到几米前方（直到传感器范围）执行反应式路径规划。然后，它会构建一个轨迹，以避开动态障碍物（这些障碍物不会出现在地图上，但可以通过传感器数据检测到），同时尝试遵循全局计划。它还负责生成轮子的控制命令，使机器人遵循轨迹。</p> 
<p>节点配置文件的参数如下：</p> 
<pre><code class="prism language-python">controller_server<span class="token punctuation">:</span>
  ros__parameters<span class="token punctuation">:</span>
    use_sim_time<span class="token punctuation">:</span> <span class="token boolean">True</span>
    controller_frequency<span class="token punctuation">:</span> <span class="token number">10.0</span>
    min_x_velocity_threshold<span class="token punctuation">:</span> <span class="token number">0.001</span>  <span class="token comment"># 控制器要考虑的最小 X 速度。低于此值将被视为 0.0 m/s</span>
    min_y_velocity_threshold<span class="token punctuation">:</span> <span class="token number">0.5</span>
    min_theta_velocity_threshold<span class="token punctuation">:</span> <span class="token number">0.001</span>
    failure_tolerance<span class="token punctuation">:</span> <span class="token number">0.3</span>
    progress_checker_plugin<span class="token punctuation">:</span> <span class="token string">"progress_checker"</span>
    goal_checker_plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"general_goal_checker"</span><span class="token punctuation">]</span> 
    controller_plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"FollowPath"</span><span class="token punctuation">]</span>

    <span class="token comment"># Progress checker parameters</span>
    progress_checker<span class="token punctuation">:</span>     <span class="token comment"># 检查机器人在完成目标的过程中是被卡住了还是取得了进展。</span>
      plugin<span class="token punctuation">:</span> <span class="token string">"nav2_controller::SimpleProgressChecker"</span>
      required_movement_radius<span class="token punctuation">:</span> <span class="token number">0.5</span>				<span class="token comment"># 机器人向目标前进所需的最小移动量</span>
      movement_time_allowance<span class="token punctuation">:</span> <span class="token number">10.0</span>
    <span class="token comment"># Goal checker parameters</span>
    general_goal_checker<span class="token punctuation">:</span>
      stateful<span class="token punctuation">:</span> <span class="token boolean">True</span>
      plugin<span class="token punctuation">:</span> <span class="token string">"nav2_controller::SimpleGoalChecker"</span>
      xy_goal_tolerance<span class="token punctuation">:</span> <span class="token number">0.25</span>
      yaw_goal_tolerance<span class="token punctuation">:</span> <span class="token number">0.25</span>
    <span class="token comment"># DWB parameters</span>
    FollowPath<span class="token punctuation">:</span>
      plugin<span class="token punctuation">:</span> <span class="token string">"dwb_core::DWBLocalPlanner"</span>  <span class="token comment"># dwb_controller适用于差分小车</span>
      debug_trajectory_details<span class="token punctuation">:</span> <span class="token boolean">True</span>
      min_vel_x<span class="token punctuation">:</span> <span class="token number">0.0</span>
      min_vel_y<span class="token punctuation">:</span> <span class="token number">0.0</span>
      max_vel_x<span class="token punctuation">:</span> <span class="token number">0.26</span>
      max_vel_y<span class="token punctuation">:</span> <span class="token number">0.0</span>
      max_vel_theta<span class="token punctuation">:</span> <span class="token number">1.0</span>
      min_speed_xy<span class="token punctuation">:</span> <span class="token number">0.0</span>
      max_speed_xy<span class="token punctuation">:</span> <span class="token number">0.26</span>
      min_speed_theta<span class="token punctuation">:</span> <span class="token number">0.0</span>
      acc_lim_x<span class="token punctuation">:</span> <span class="token number">2.5</span>
      acc_lim_y<span class="token punctuation">:</span> <span class="token number">0.0</span>
      acc_lim_theta<span class="token punctuation">:</span> <span class="token number">3.2</span>
      decel_lim_x<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">2.5</span>
      decel_lim_y<span class="token punctuation">:</span> <span class="token number">0.0</span>
      decel_lim_theta<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">3.2</span>
      vx_samples<span class="token punctuation">:</span> <span class="token number">20</span>
      vy_samples<span class="token punctuation">:</span> <span class="token number">5</span>
      vtheta_samples<span class="token punctuation">:</span> <span class="token number">20</span>
      sim_time<span class="token punctuation">:</span> <span class="token number">1.7</span>
      linear_granularity<span class="token punctuation">:</span> <span class="token number">0.05</span>
      angular_granularity<span class="token punctuation">:</span> <span class="token number">0.025</span>
      transform_tolerance<span class="token punctuation">:</span> <span class="token number">0.2</span>
      xy_goal_tolerance<span class="token punctuation">:</span> <span class="token number">0.25</span>  <span class="token comment"># 控制着机器人移动的速度和敏捷度。</span>
      trans_stopped_velocity<span class="token punctuation">:</span> <span class="token number">0.25</span>
      short_circuit_trajectory_evaluation<span class="token punctuation">:</span> <span class="token boolean">True</span>
      stateful<span class="token punctuation">:</span> <span class="token boolean">True</span>
      critics<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"RotateToGoal"</span><span class="token punctuation">,</span> <span class="token string">"Oscillation"</span><span class="token punctuation">,</span> <span class="token string">"BaseObstacle"</span><span class="token punctuation">,</span> <span class="token string">"GoalAlign"</span><span class="token punctuation">,</span> <span class="token string">"PathAlign"</span><span class="token punctuation">,</span> <span class="token string">"PathDist"</span><span class="token punctuation">,</span> <span class="token string">"GoalDist"</span><span class="token punctuation">]</span>
      BaseObstacle<span class="token punctuation">.</span>scale<span class="token punctuation">:</span> <span class="token number">0.02</span>
      PathAlign<span class="token punctuation">.</span>scale<span class="token punctuation">:</span> <span class="token number">32.0</span>
      PathAlign<span class="token punctuation">.</span>forward_point_distance<span class="token punctuation">:</span> <span class="token number">0.1</span>
      GoalAlign<span class="token punctuation">.</span>scale<span class="token punctuation">:</span> <span class="token number">24.0</span>
      GoalAlign<span class="token punctuation">.</span>forward_point_distance<span class="token punctuation">:</span> <span class="token number">0.1</span>
      PathDist<span class="token punctuation">.</span>scale<span class="token punctuation">:</span> <span class="token number">32.0</span>
      GoalDist<span class="token punctuation">.</span>scale<span class="token punctuation">:</span> <span class="token number">24.0</span>
      RotateToGoal<span class="token punctuation">.</span>scale<span class="token punctuation">:</span> <span class="token number">32.0</span>
      RotateToGoal<span class="token punctuation">.</span>slowing_factor<span class="token punctuation">:</span> <span class="token number">5.0</span>
      RotateToGoal<span class="token punctuation">.</span>lookahead_time<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1.0</span>
</code></pre> 
<h3><a id="33___recoveries_428"></a>3.3 recoveries节点</h3> 
<p>当机器人找不到通往目标的有效路径，会发生什么情况？如果机器人卡在中间，不知道该怎么办？</p> 
<p>在这种情况下，机器人会使用恢复行为。目前，Nav2 中有三种可用的恢复行为：</p> 
<p><strong>spin</strong> - 按给定角度执行原地旋转<br> <strong>backup</strong> - 按给定距离进行线性平移<br> <strong>wait</strong> - 使机器人处于静止状态</p> 
<p>这些简单、预定义的动作通常可以通过行为树来实现。</p> 
<pre><code class="prism language-python">recoveries_server<span class="token punctuation">:</span>
  ros__parameters<span class="token punctuation">:</span>
    costmap_topic<span class="token punctuation">:</span> local_costmap<span class="token operator">/</span>costmap_raw
    footprint_topic<span class="token punctuation">:</span> local_costmap<span class="token operator">/</span>published_footprint
    cycle_frequency<span class="token punctuation">:</span> <span class="token number">10.0</span>
    recovery_plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"spin"</span><span class="token punctuation">,</span> <span class="token string">"backup"</span><span class="token punctuation">,</span> <span class="token string">"wait"</span><span class="token punctuation">]</span>
    spin<span class="token punctuation">:</span>
      plugin<span class="token punctuation">:</span> <span class="token string">"nav2_recoveries/Spin"</span>
    backup<span class="token punctuation">:</span>
      plugin<span class="token punctuation">:</span> <span class="token string">"nav2_recoveries/BackUp"</span>
    wait<span class="token punctuation">:</span>
      plugin<span class="token punctuation">:</span> <span class="token string">"nav2_recoveries/Wait"</span>
    global_frame<span class="token punctuation">:</span> odom
    robot_base_frame<span class="token punctuation">:</span> base_link
    transform_timeout<span class="token punctuation">:</span> <span class="token number">0.1</span>
    use_sim_time<span class="token punctuation">:</span> true
    simulate_ahead_time<span class="token punctuation">:</span> <span class="token number">2.0</span>
    max_rotational_vel<span class="token punctuation">:</span> <span class="token number">1.0</span>
    min_rotational_vel<span class="token punctuation">:</span> <span class="token number">0.4</span>
    rotational_acc_lim<span class="token punctuation">:</span> <span class="token number">3.2</span>
</code></pre> 
<h2><a id="34___BT_463"></a>3.4 BT节点</h2> 
<p>该节点调用路径规划器节点请求路径，然后调用控制器让机器人沿着路径移动,并在出现问题是恢复。整个行为通过BT来组建</p> 
<pre><code class="prism language-python">bt_navigator<span class="token punctuation">:</span>
  ros__parameters<span class="token punctuation">:</span>
    use_sim_time<span class="token punctuation">:</span> <span class="token boolean">True</span>
    global_frame<span class="token punctuation">:</span> <span class="token builtin">map</span>
    robot_base_frame<span class="token punctuation">:</span> base_link
    odom_topic<span class="token punctuation">:</span> <span class="token operator">/</span>odom
    bt_loop_duration<span class="token punctuation">:</span> <span class="token number">10</span>
    default_server_timeout<span class="token punctuation">:</span> <span class="token number">20</span>
    default_nav_to_pose_bt_xml<span class="token punctuation">:</span> <span class="token string">"/home/user/ros2_ws/src/path_planner_server/config/behavior.xml"</span> <span class="token comment">#包含用于导航到姿势的行为的文件的完整路径</span>
    plugin_lib_names<span class="token punctuation">:</span>
    <span class="token operator">-</span> nav2_compute_path_to_pose_action_bt_node
    <span class="token operator">-</span> nav2_compute_path_through_poses_action_bt_node
    <span class="token operator">-</span> nav2_follow_path_action_bt_node
    <span class="token operator">-</span> nav2_back_up_action_bt_node
    <span class="token operator">-</span> nav2_spin_action_bt_node
    <span class="token operator">-</span> nav2_wait_action_bt_node
    <span class="token operator">-</span> nav2_clear_costmap_service_bt_node
    <span class="token operator">-</span> nav2_is_stuck_condition_bt_node
    <span class="token operator">-</span> nav2_goal_reached_condition_bt_node
    <span class="token operator">-</span> nav2_goal_updated_condition_bt_node
    <span class="token operator">-</span> nav2_initial_pose_received_condition_bt_node
    <span class="token operator">-</span> nav2_reinitialize_global_localization_service_bt_node
    <span class="token operator">-</span> nav2_rate_controller_bt_node
    <span class="token operator">-</span> nav2_distance_controller_bt_node
    <span class="token operator">-</span> nav2_speed_controller_bt_node
    <span class="token operator">-</span> nav2_truncate_path_action_bt_node
    <span class="token operator">-</span> nav2_goal_updater_node_bt_node
    <span class="token operator">-</span> nav2_recovery_node_bt_node
    <span class="token operator">-</span> nav2_pipeline_sequence_bt_node
    <span class="token operator">-</span> nav2_round_robin_node_bt_node
    <span class="token operator">-</span> nav2_transform_available_condition_bt_node
    <span class="token operator">-</span> nav2_time_expired_condition_bt_node
    <span class="token operator">-</span> nav2_distance_traveled_condition_bt_node
    <span class="token operator">-</span> nav2_single_trigger_bt_node
    <span class="token operator">-</span> nav2_is_battery_low_condition_bt_node
    <span class="token operator">-</span> nav2_navigate_through_poses_action_bt_node
    <span class="token operator">-</span> nav2_navigate_to_pose_action_bt_node
    <span class="token operator">-</span> nav2_remove_passed_goals_action_bt_node
</code></pre> 
<p>下面是行为树的具体内容：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--
  This Behavior Tree replans the global path periodically at 1 Hz, and has
  recovery actions. Obtained from the official Nav2 package
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">main_tree_to_execute</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MainTree<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BehaviorTree</span> <span class="token attr-name">ID</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MainTree<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecoveryNode</span> <span class="token attr-name">number_of_retries</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NavigateRecovery<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PipelineSequence</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NavigateWithReplanning<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RateController</span> <span class="token attr-name">hz</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecoveryNode</span> <span class="token attr-name">number_of_retries</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ComputePathToPose<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ComputePathToPose</span> <span class="token attr-name">goal</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{goal}<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{path}<span class="token punctuation">"</span></span> <span class="token attr-name">planner_id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>GridBased<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClearEntireCostmap</span> <span class="token attr-name">service_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>global_costmap/clear_entirely_global_costmap<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecoveryNode</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RateController</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecoveryNode</span> <span class="token attr-name">number_of_retries</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>FollowPath<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FollowPath</span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{path}<span class="token punctuation">"</span></span> <span class="token attr-name">controller_id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>FollowPath<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClearEntireCostmap</span> <span class="token attr-name">service_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>local_costmap/clear_entirely_local_costmap<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecoveryNode</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PipelineSequence</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SequenceStar</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>RecoveryActions<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClearEntireCostmap</span> <span class="token attr-name">service_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>local_costmap/clear_entirely_local_costmap<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClearEntireCostmap</span> <span class="token attr-name">service_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>global_costmap/clear_entirely_global_costmap<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Spin</span> <span class="token attr-name">spin_dist</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.57<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Wait</span> <span class="token attr-name">wait_duration</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SequenceStar</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecoveryNode</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>BehaviorTree</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h2><a id="35__543"></a>3.5 配置文件</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> ament_index_python<span class="token punctuation">.</span>packages <span class="token keyword">import</span> get_package_share_directory
<span class="token keyword">from</span> launch <span class="token keyword">import</span> LaunchDescription
<span class="token keyword">from</span> launch_ros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> Node

<span class="token keyword">def</span> <span class="token function">generate_launch_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    controller_yaml <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'path_planner_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'controller.yaml'</span><span class="token punctuation">)</span>
    bt_navigator_yaml <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'path_planner_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'bt_navigator.yaml'</span><span class="token punctuation">)</span>
    planner_yaml <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'path_planner_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'planner_server.yaml'</span><span class="token punctuation">)</span>
    recovery_yaml <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'path_planner_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'recovery.yaml'</span><span class="token punctuation">)</span>

    
    <span class="token keyword">return</span> LaunchDescription<span class="token punctuation">(</span><span class="token punctuation">[</span>     
        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_controller'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'controller_server'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'controller_server'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span>controller_yaml<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_planner'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'planner_server'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'planner_server'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span>planner_yaml<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            
        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_recoveries'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'recoveries_server'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'recoveries_server'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span>recovery_yaml<span class="token punctuation">]</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_bt_navigator'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'bt_navigator'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'bt_navigator'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span>bt_navigator_yaml<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_lifecycle_manager'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'lifecycle_manager'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'lifecycle_manager_pathplanner'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'autostart'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'node_names'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'planner_server'</span><span class="token punctuation">,</span>
                                        <span class="token string">'controller_server'</span><span class="token punctuation">,</span>
                                        <span class="token string">'recoveries_server'</span><span class="token punctuation">,</span>
                                        <span class="token string">'bt_navigator'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>配置好启动文件后，可以给定目标位置，指引小车到指定位置。</p> 
<p>同样的，可以通过rviz的点击的方式确定。也可以使用命令行的方式:</p> 
<pre><code class="prism language-shell">ros2 action send_goal /navigate_to_pose nav2_msgs/action/NavigateToPose <span class="token string">"pose: {header: {frame_id: map}, pose: {position: {x: 1.52, y: 1.92, z: 0.0}, orientation:{x: 0.0, y: 0.0, z: 0, w: 1.0000000}}}"</span>
</code></pre> 
<pre><code class="prism language-shell">ros2 topic pub <span class="token parameter variable">-1</span> /goal_pose geometry_msgs/PoseStamped <span class="token string">"{header: {stamp: {sec: 0}, frame_id: 'map'}, pose: {position: {x: 2.2, y: 0.0, z: 0.0}, orientation: {w: 1.0}}}"</span>
</code></pre> 
<p>同理，通过编程的方式也是可以的。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> rclpy
<span class="token keyword">from</span> nav2_msgs<span class="token punctuation">.</span>action <span class="token keyword">import</span> NavigateToPose
<span class="token keyword">from</span> rclpy<span class="token punctuation">.</span>action <span class="token keyword">import</span> ActionClient
<span class="token keyword">from</span> rclpy<span class="token punctuation">.</span>node <span class="token keyword">import</span> Node
<span class="token keyword">from</span> geometry_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> PointStamped

<span class="token keyword">class</span> <span class="token class-name">NavToPoseActionClient</span><span class="token punctuation">(</span>Node<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token string">'Nav_To_Pose_Action_Client'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_action_client <span class="token operator">=</span> ActionClient<span class="token punctuation">(</span>self<span class="token punctuation">,</span> NavigateToPose<span class="token punctuation">,</span> <span class="token string">'/navigate_to_pose'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>subscriber_ <span class="token operator">=</span> self<span class="token punctuation">.</span>create_subscription<span class="token punctuation">(</span>PointStamped<span class="token punctuation">,</span> <span class="token string">'clicked_point'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>callback<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>subscriber_  <span class="token comment"># prevent unused variable warning</span>

    <span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Recieved Data:\n X : %f \n Y : %f \n Z : %f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>point<span class="token punctuation">.</span>x<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>point<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_goal <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>point<span class="token punctuation">.</span>x<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">send_goal</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x <span class="token punctuation">,</span>y<span class="token punctuation">,</span> theta<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'sending goal to action server'</span><span class="token punctuation">)</span>
        goal_pose <span class="token operator">=</span> NavigateToPose<span class="token punctuation">.</span>Goal<span class="token punctuation">(</span><span class="token punctuation">)</span>
        goal_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">'map'</span>
        goal_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> x
        goal_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> y
        goal_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">=</span> theta

        self<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'waiting for action server'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_action_client<span class="token punctuation">.</span>wait_for_server<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'action server detected'</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_send_goal_future <span class="token operator">=</span> self<span class="token punctuation">.</span>_action_client<span class="token punctuation">.</span>send_goal_async<span class="token punctuation">(</span>
            goal_pose<span class="token punctuation">,</span>
            feedback_callback<span class="token operator">=</span>self<span class="token punctuation">.</span>feedback_callback<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'goal sent'</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_send_goal_future<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>self<span class="token punctuation">.</span>goal_response_callback<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">goal_response_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">:</span>
        goal_handle <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> goal_handle<span class="token punctuation">.</span>accepted<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Goal rejected :('</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        self<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Goal accepted :)'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_get_result_future <span class="token operator">=</span> goal_handle<span class="token punctuation">.</span>get_result_async<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_get_result_future<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_result_callback<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_result_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>result
        self<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Result: {0}'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
        rclpy<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">feedback_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> feedback_msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        feedback <span class="token operator">=</span> feedback_msg<span class="token punctuation">.</span>feedback
        self<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'FEEDBACK:'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>feedback<span class="token punctuation">)</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rclpy<span class="token punctuation">.</span>init<span class="token punctuation">(</span>args<span class="token operator">=</span>args<span class="token punctuation">)</span>

    action_client <span class="token operator">=</span> NavToPoseActionClient<span class="token punctuation">(</span><span class="token punctuation">)</span>

    rclpy<span class="token punctuation">.</span>spin<span class="token punctuation">(</span>action_client<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="4_684"></a>4.机器人避障</h2> 
<h3><a id="41__686"></a>4.1 代价地图</h3> 
<p>代价地图是机器人感应到的障碍物在网格地图上的二维表示。</p> 
<p>每个网格单元都包含传感器检测到的障碍物信息，单元的代价可以是未知的、空闲的、被占用的或膨胀的。不同的颜色表示与障碍物发生碰撞的可能性有多大，然后，控制器、规划器和恢复器会利用这些信息来安全高效地计算它们的任务</p> 
<p>代价地图有两种类型：</p> 
<p>全局代价地图（左图）由静态地图中的障碍物生成。它是规划者用来生成长期路径的地图，有助于避开地图上的已知障碍物。<br> 局部代价地图（右图）由机器人在其周围小范围内检测到的新障碍物生成。控制器利用它来生成短期路径并避开动态障碍物。</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-5B6GzaHQ-1692057536275)(/home/lk/.config/Typora/typora-user-images/image-20230812121839712.png)]</p> 
<h3><a id="42__699"></a>4.2 配置全局代价地图</h3> 
<p>代价地图</p> 
<p>要添加全局代价图，需要在planner 配置文件中添加以下一系列参数：</p> 
<pre><code class="prism language-python">global_costmap<span class="token punctuation">:</span>
  global_costmap<span class="token punctuation">:</span>
    ros__parameters<span class="token punctuation">:</span>
      update_frequency<span class="token punctuation">:</span> <span class="token number">1.0</span>
      publish_frequency<span class="token punctuation">:</span> <span class="token number">1.0</span>
      global_frame<span class="token punctuation">:</span> <span class="token builtin">map</span>
      robot_base_frame<span class="token punctuation">:</span> base_link
      use_sim_time<span class="token punctuation">:</span> <span class="token boolean">True</span>
      robot_radius<span class="token punctuation">:</span> <span class="token number">0.15</span>
      resolution<span class="token punctuation">:</span> <span class="token number">0.05</span>
      track_unknown_space<span class="token punctuation">:</span> true
      plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"static_layer"</span><span class="token punctuation">,</span> <span class="token string">"inflation_layer"</span><span class="token punctuation">]</span>
      static_layer<span class="token punctuation">:</span>
        plugin<span class="token punctuation">:</span> <span class="token string">"nav2_costmap_2d::StaticLayer"</span>
        map_subscribe_transient_local<span class="token punctuation">:</span> <span class="token boolean">True</span>
      inflation_layer<span class="token punctuation">:</span>
        plugin<span class="token punctuation">:</span> <span class="token string">"nav2_costmap_2d::InflationLayer"</span>
        cost_scaling_factor<span class="token punctuation">:</span> <span class="token number">3.0</span>
        inflation_radius<span class="token punctuation">:</span> <span class="token number">0.35</span>
      obstacle_layer<span class="token punctuation">:</span>
        plugin<span class="token punctuation">:</span> <span class="token string">"nav2_costmap_2d::ObstacleLayer"</span>
        enabled<span class="token punctuation">:</span> <span class="token boolean">True</span>
        observation_sources<span class="token punctuation">:</span> scan
        scan<span class="token punctuation">:</span>
          topic<span class="token punctuation">:</span> <span class="token operator">/</span>scan
          max_obstacle_height<span class="token punctuation">:</span> <span class="token number">2.0</span>
          clearing<span class="token punctuation">:</span> <span class="token boolean">True</span>
          marking<span class="token punctuation">:</span> <span class="token boolean">True</span>
          data_type<span class="token punctuation">:</span> <span class="token string">"LaserScan"</span>
          raytrace_max_range<span class="token punctuation">:</span> <span class="token number">3.0</span>
          raytrace_min_range<span class="token punctuation">:</span> <span class="token number">0.0</span>
          obstacle_max_range<span class="token punctuation">:</span> <span class="token number">2.5</span>
          obstacle_min_range<span class="token punctuation">:</span> <span class="token number">0.0</span>
      always_send_full_costmap<span class="token punctuation">:</span> <span class="token boolean">True</span>
</code></pre> 
<p>在 RVIZ 中为 /global_costmap/costmap 主题添加costmap显示（选择Color Scheme为map）</p> 
<p>global costmap是由不同障碍物层叠加生成的。每一层都会根据该层计算障碍物的方式向global costmap添加一组障碍物。可用的代价图层有：</p> 
<p><strong>Static Layer</strong> - 将静态地图中存在的任何黑点作为障碍物添加到全局代价地图中<br> <strong>Inflation Layer</strong> - 为全局代价地图中的任何障碍物添加膨胀，作为需要保持的安全距离<br> <strong>Inflation Layer</strong> - 将二维传感器检测到的任何物体添加到全局代价图中<br> <strong>Voxel Layer</strong> - 将点云数据中的三维障碍物添加到全局代价图中<br> 可以指定应用于全局代价图的一个或所有前面的图层。不过，要包含这些层，需要将它们添加到插件列表中，然后为每个层添加配置参数。</p> 
<pre><code class="prism language-shell">    plugins: <span class="token punctuation">[</span><span class="token string">"static_layer"</span>, <span class="token string">"obstacle_layer"</span>, <span class="token string">"inflation_layer"</span><span class="token punctuation">]</span>
</code></pre> 
<p>需要注意的是，在插件列表中，将 "obstacle_layer "放在 "inflation_layer "之前。否则，"inflation_layer "插件将无法放大新检测到的障碍物。</p> 
<h3><a id="43__762"></a>4.3 配置局部代价地图</h3> 
<p>要添加局部代价图，需要在planner 配置文件中添加以下一系列参数：</p> 
<pre><code class="prism language-python">local_costmap<span class="token punctuation">:</span>
  local_costmap<span class="token punctuation">:</span>
    ros__parameters<span class="token punctuation">:</span>
      update_frequency<span class="token punctuation">:</span> <span class="token number">5.0</span>
      publish_frequency<span class="token punctuation">:</span> <span class="token number">2.0</span>
      global_frame<span class="token punctuation">:</span> odom
      robot_base_frame<span class="token punctuation">:</span> base_link
      use_sim_time<span class="token punctuation">:</span> <span class="token boolean">True</span>
      rolling_window<span class="token punctuation">:</span> true
      width<span class="token punctuation">:</span> <span class="token number">1</span>
      height<span class="token punctuation">:</span> <span class="token number">1</span>
      resolution<span class="token punctuation">:</span> <span class="token number">0.05</span>
      robot_radius<span class="token punctuation">:</span> <span class="token number">0.15</span>  <span class="token comment"># 通常使用圆形（或接近圆形）机器人</span>
      plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"voxel_layer"</span><span class="token punctuation">,</span> <span class="token string">"inflation_layer"</span><span class="token punctuation">]</span>
      inflation_layer<span class="token punctuation">:</span>
        plugin<span class="token punctuation">:</span> <span class="token string">"nav2_costmap_2d::InflationLayer"</span>
        cost_scaling_factor<span class="token punctuation">:</span> <span class="token number">3.0</span>
        inflation_radius<span class="token punctuation">:</span> <span class="token number">0.35</span>
      voxel_layer<span class="token punctuation">:</span>
        plugin<span class="token punctuation">:</span> <span class="token string">"nav2_costmap_2d::VoxelLayer"</span>
        enabled<span class="token punctuation">:</span> <span class="token boolean">True</span>
        publish_voxel_map<span class="token punctuation">:</span> <span class="token boolean">True</span>
        origin_z<span class="token punctuation">:</span> <span class="token number">0.0</span>
        z_resolution<span class="token punctuation">:</span> <span class="token number">0.05</span>
        z_voxels<span class="token punctuation">:</span> <span class="token number">16</span>
        max_obstacle_height<span class="token punctuation">:</span> <span class="token number">2.0</span>
        mark_threshold<span class="token punctuation">:</span> <span class="token number">0</span>
        observation_sources<span class="token punctuation">:</span> scan
        scan<span class="token punctuation">:</span>
          topic<span class="token punctuation">:</span> <span class="token operator">/</span>scan
          max_obstacle_height<span class="token punctuation">:</span> <span class="token number">2.0</span>
          clearing<span class="token punctuation">:</span> <span class="token boolean">True</span>
          marking<span class="token punctuation">:</span> <span class="token boolean">True</span>
          data_type<span class="token punctuation">:</span> <span class="token string">"LaserScan"</span>
          raytrace_max_range<span class="token punctuation">:</span> <span class="token number">3.0</span>
          raytrace_min_range<span class="token punctuation">:</span> <span class="token number">0.0</span>
          obstacle_max_range<span class="token punctuation">:</span> <span class="token number">2.5</span>
          obstacle_min_range<span class="token punctuation">:</span> <span class="token number">0.0</span>
      static_layer<span class="token punctuation">:</span>
        map_subscribe_transient_local<span class="token punctuation">:</span> <span class="token boolean">True</span>
      always_send_full_costmap<span class="token punctuation">:</span> <span class="token boolean">True</span>
        
</code></pre> 
<p>局部代价地图用于在近距离障碍物前做出快速反应。因此，它的尺寸被缩小到几米。代价映射的实际大小由两个附加参数指定：</p> 
<p>width，height<br> 这两个参数决定了传感器更新的机器人周围代价地图区域的大小。</p> 
<h2><a id="5__818"></a>5. 多机器人导航</h2> 
<p>如果是多机器人环境，每个机器人都可能有相同的 /cmd_vel 主题名和相同的 base_footprint 框架名，甚至相同的控制节点名。这在多机器人环境中是不正确的，因为导航算法无法识别与之对话的机器人。</p> 
<p>因此，首先要正确配置机器人，并将主题、框架和节点名称分离到命名空间中。</p> 
<p>为了使所有机器人都能自主移动，你需要为每个机器人配置和启动一个完整的导航系统。这意味着为每个机器人都需要一个定位系统、一个控制器服务器、一个规划器服务器、一个行为树导航器（bt-navigator）等等。</p> 
<p>唯一共享给所有机器人的是 map_server。因为所有机器人将使用相同的地图，所以只会有一个 map_server。</p> 
<ol><li>从机器人队列中选择一台机器人负责创建地图。</li><li>创建地图后，使用该地图启动一个单独的 map_server。</li><li>每个机器人的导航系统都将使用相同的地图，通过向相同的 map_server 请求。</li></ol> 
<h3><a id="51__832"></a>5.1 多机器人定位</h3> 
<pre><code class="prism language-python">tb3_0<span class="token operator">/</span>amcl<span class="token punctuation">:</span>
  ros__parameters<span class="token punctuation">:</span>
    use_sim_time<span class="token punctuation">:</span> <span class="token boolean">True</span>
    alpha1<span class="token punctuation">:</span> <span class="token number">0.2</span>
    alpha2<span class="token punctuation">:</span> <span class="token number">0.2</span>
    alpha3<span class="token punctuation">:</span> <span class="token number">0.2</span>
    alpha4<span class="token punctuation">:</span> <span class="token number">0.2</span>
    alpha5<span class="token punctuation">:</span> <span class="token number">0.2</span>
    base_frame_id<span class="token punctuation">:</span> <span class="token string">"tb3_0/base_footprint"</span>
    beam_skip_distance<span class="token punctuation">:</span> <span class="token number">0.5</span>
    beam_skip_error_threshold<span class="token punctuation">:</span> <span class="token number">0.9</span>
    beam_skip_threshold<span class="token punctuation">:</span> <span class="token number">0.3</span>
    do_beamskip<span class="token punctuation">:</span> false
    global_frame_id<span class="token punctuation">:</span> <span class="token string">"map"</span>
    lambda_short<span class="token punctuation">:</span> <span class="token number">0.1</span>
    laser_likelihood_max_dist<span class="token punctuation">:</span> <span class="token number">2.0</span>
    laser_max_range<span class="token punctuation">:</span> <span class="token number">100.0</span>
    laser_min_range<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1.0</span>
    laser_model_type<span class="token punctuation">:</span> <span class="token string">"likelihood_field"</span>
    max_beams<span class="token punctuation">:</span> <span class="token number">60</span>
    max_particles<span class="token punctuation">:</span> <span class="token number">8000</span>
    min_particles<span class="token punctuation">:</span> <span class="token number">200</span>
    odom_frame_id<span class="token punctuation">:</span> <span class="token string">"tb3_0/odom"</span>
    pf_err<span class="token punctuation">:</span> <span class="token number">0.05</span>
    pf_z<span class="token punctuation">:</span> <span class="token number">0.99</span>
    recovery_alpha_fast<span class="token punctuation">:</span> <span class="token number">0.0</span>
    recovery_alpha_slow<span class="token punctuation">:</span> <span class="token number">0.0</span>
    resample_interval<span class="token punctuation">:</span> <span class="token number">1</span>
    robot_model_type<span class="token punctuation">:</span> <span class="token string">"differential"</span>
    save_pose_rate<span class="token punctuation">:</span> <span class="token number">0.5</span>
    sigma_hit<span class="token punctuation">:</span> <span class="token number">0.2</span>
    tf_broadcast<span class="token punctuation">:</span> true
    transform_tolerance<span class="token punctuation">:</span> <span class="token number">1.0</span>
    update_min_a<span class="token punctuation">:</span> <span class="token number">0.2</span>
    update_min_d<span class="token punctuation">:</span> <span class="token number">0.25</span>
    z_hit<span class="token punctuation">:</span> <span class="token number">0.5</span>
    z_max<span class="token punctuation">:</span> <span class="token number">0.05</span>
    z_rand<span class="token punctuation">:</span> <span class="token number">0.5</span>
    z_short<span class="token punctuation">:</span> <span class="token number">0.05</span>
    scan_topic<span class="token punctuation">:</span> <span class="token string">"scan"</span>
    map_topic<span class="token punctuation">:</span> <span class="token string">"/map"</span>
    <span class="token comment"># ACTIVATE THE set_initial_pose WHEN YOU HAVE A PROPER initial_pose, by uncommenting the code below</span>
    <span class="token comment">#set_initial_pose: true</span>
    <span class="token comment">#initial_pose:</span>
    <span class="token comment"># x: 7.778</span>
    <span class="token comment"># y: -9.589</span>
    <span class="token comment"># z: 0.0</span>
    <span class="token comment"># a: -0.211</span>

tb3_0<span class="token operator">/</span>amcl_map_client<span class="token punctuation">:</span>
  ros__parameters<span class="token punctuation">:</span>
    use_sim_time<span class="token punctuation">:</span> <span class="token boolean">True</span>

tb3_0<span class="token operator">/</span>amcl_rclcpp_node<span class="token punctuation">:</span>
  ros__parameters<span class="token punctuation">:</span>
    use_sim_time<span class="token punctuation">:</span> <span class="token boolean">True</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os

<span class="token keyword">from</span> ament_index_python<span class="token punctuation">.</span>packages <span class="token keyword">import</span> get_package_share_directory
<span class="token keyword">from</span> launch <span class="token keyword">import</span> LaunchDescription
<span class="token keyword">from</span> launch_ros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> Node

<span class="token keyword">def</span> <span class="token function">generate_launch_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    tb3_0_config <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'localization_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'tb3_0_amcl_config.yaml'</span><span class="token punctuation">)</span>
    tb3_1_config <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'localization_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'tb3_1_amcl_config.yaml'</span><span class="token punctuation">)</span>

    map_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>get_package_share_directory<span class="token punctuation">(</span><span class="token string">'map_server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'turtlebot_area.yaml'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> LaunchDescription<span class="token punctuation">(</span><span class="token punctuation">[</span>
        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_map_server'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'map_server'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'map_server'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'use_sim_time'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
                        <span class="token punctuation">{<!-- --></span><span class="token string">'topic_name'</span><span class="token punctuation">:</span><span class="token string">"map"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'frame_id'</span><span class="token punctuation">:</span><span class="token string">"map"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'yaml_filename'</span><span class="token punctuation">:</span>map_file<span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
            
        Node<span class="token punctuation">(</span>
            namespace<span class="token operator">=</span><span class="token string">'tb3_0'</span><span class="token punctuation">,</span>
            package<span class="token operator">=</span><span class="token string">'nav2_amcl'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'amcl'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'amcl'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span>tb3_0_config<span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>

        Node<span class="token punctuation">(</span>
             namespace<span class="token operator">=</span><span class="token string">'tb3_1'</span><span class="token punctuation">,</span>
             package<span class="token operator">=</span><span class="token string">'nav2_amcl'</span><span class="token punctuation">,</span>
             executable<span class="token operator">=</span><span class="token string">'amcl'</span><span class="token punctuation">,</span>
             name<span class="token operator">=</span><span class="token string">'amcl'</span><span class="token punctuation">,</span>
             output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
             parameters<span class="token operator">=</span><span class="token punctuation">[</span>tb3_1_config<span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>

        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">'nav2_lifecycle_manager'</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">'lifecycle_manager'</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">'lifecycle_manager_localization'</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">'screen'</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'use_sim_time'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'autostart'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'bond_timeout'</span><span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">'node_names'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'map_server'</span><span class="token punctuation">,</span> <span class="token string">'tb3_0/amcl'</span><span class="token punctuation">,</span> <span class="token string">'tb3_1/amcl'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>同理，其他也是两个节点</p> 
<h2><a id="6_Nav2_956"></a>6. Nav2导航新特性</h2> 
<p>Nav2 Simple Commander 提供了一套通过 Python3 代码与 Nav2 系统交互的方法。因此，您可以将其视为一个 Python API，让您可以轻松地与导航堆栈交互。</p> 
<p>包括goToPose()、goThroughPoses() 和 followWaypoints()。</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> ~/ros2_ws/src
<span class="token function">git</span> clone https://bitbucket.org/theconstructcore/nav2_pkgs.git
</code></pre> 
<h3><a id="61_Navigate_To_Pose_967"></a>6.1 Navigate To Pose</h3> 
<p>NavigateToPose 动作最适用于点对点导航请求或其他可在行为树中表示边界条件姿势的任务，如动态物体跟随。</p> 
<pre><code class="prism language-python"><span class="token comment">#! /usr/bin/env python3</span>
<span class="token comment"># Copyright 2021 Samsung Research America</span>
<span class="token comment">#</span>
<span class="token comment"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="token comment"># you may not use this file except in compliance with the License.</span>
<span class="token comment"># You may obtain a copy of the License at</span>
<span class="token comment">#</span>
<span class="token comment">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#</span>
<span class="token comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment"># See the License for the specific language governing permissions and</span>
<span class="token comment"># limitations under the License.</span>

<span class="token keyword">import</span> time
<span class="token keyword">from</span> copy <span class="token keyword">import</span> deepcopy

<span class="token keyword">from</span> geometry_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> PoseStamped
<span class="token keyword">from</span> rclpy<span class="token punctuation">.</span>duration <span class="token keyword">import</span> Duration
<span class="token keyword">import</span> rclpy

<span class="token keyword">from</span> nav2_simple_commander<span class="token punctuation">.</span>robot_navigator <span class="token keyword">import</span> BasicNavigator<span class="token punctuation">,</span> TaskResult

<span class="token comment"># Shelf positions for picking</span>
shelf_positions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"shelf_A"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3.829</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7.604</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"shelf_B"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3.791</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.287</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"shelf_C"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3.791</span><span class="token punctuation">,</span> <span class="token number">1.254</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"shelf_D"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3.24</span><span class="token punctuation">,</span> <span class="token number">5.861</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

<span class="token comment"># Shipping destination for picked products</span>
shipping_destinations <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"recycling"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.205</span><span class="token punctuation">,</span> <span class="token number">7.403</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"pallet_jack7"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.073</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8.497</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"conveyer_432"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">6.217</span><span class="token punctuation">,</span> <span class="token number">2.153</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"frieght_bay_3"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6.349</span><span class="token punctuation">,</span> <span class="token number">9.147</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

<span class="token triple-quoted-string string">'''
Basic item picking demo. In this demonstration, the expectation
is that a person is waiting at the item shelf to put the item on the robot
and at the pallet jack to remove it
(probably with a button for 'got item, robot go do next task').
'''</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Recieved virtual request for picking item at Shelf A and bringing to</span>
    <span class="token comment"># worker at the pallet jack 7 for shipping. This request would</span>
    <span class="token comment"># contain the shelf ID ("shelf_A") and shipping destination ("pallet_jack7")</span>
    <span class="token comment">####################</span>
    request_item_location <span class="token operator">=</span> <span class="token string">'shelf_C'</span>
    request_destination <span class="token operator">=</span> <span class="token string">'pallet_jack7'</span>
    <span class="token comment">####################</span>

    rclpy<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>

    navigator <span class="token operator">=</span> BasicNavigator<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Set your demo's initial pose</span>
    initial_pose <span class="token operator">=</span> PoseStamped<span class="token punctuation">(</span><span class="token punctuation">)</span>
    initial_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">'map'</span>
    initial_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_msg<span class="token punctuation">(</span><span class="token punctuation">)</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">3.45</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">2.15</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">1.0</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">0.0</span>
    navigator<span class="token punctuation">.</span>setInitialPose<span class="token punctuation">(</span>initial_pose<span class="token punctuation">)</span>

    <span class="token comment"># Wait for navigation to activate fully</span>
    navigator<span class="token punctuation">.</span>waitUntilNav2Active<span class="token punctuation">(</span><span class="token punctuation">)</span>

    shelf_item_pose <span class="token operator">=</span> PoseStamped<span class="token punctuation">(</span><span class="token punctuation">)</span>
    shelf_item_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">'map'</span>
    shelf_item_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_msg<span class="token punctuation">(</span><span class="token punctuation">)</span>
    shelf_item_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> shelf_positions<span class="token punctuation">[</span>request_item_location<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    shelf_item_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> shelf_positions<span class="token punctuation">[</span>request_item_location<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    shelf_item_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">1.0</span>
    shelf_item_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Received request for item picking at '</span> <span class="token operator">+</span> request_item_location <span class="token operator">+</span> <span class="token string">'.'</span><span class="token punctuation">)</span>
    navigator<span class="token punctuation">.</span>goToPose<span class="token punctuation">(</span>shelf_item_pose<span class="token punctuation">)</span>

    <span class="token comment"># Do something during your route</span>
    <span class="token comment"># (e.x. queue up future tasks or detect person for fine-tuned positioning)</span>
    <span class="token comment"># Print information for workers on the robot's ETA for the demonstration</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token keyword">not</span> navigator<span class="token punctuation">.</span>isTaskComplete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
        feedback <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getFeedback<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> feedback <span class="token keyword">and</span> i <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Estimated time of arrival at '</span> <span class="token operator">+</span> request_item_location <span class="token operator">+</span>
                  <span class="token string">' for worker: '</span> <span class="token operator">+</span> <span class="token string">'{0:.0f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                      Duration<span class="token punctuation">.</span>from_msg<span class="token punctuation">(</span>feedback<span class="token punctuation">.</span>estimated_time_remaining<span class="token punctuation">)</span><span class="token punctuation">.</span>nanoseconds <span class="token operator">/</span> <span class="token number">1e9</span><span class="token punctuation">)</span>
                  <span class="token operator">+</span> <span class="token string">' seconds.'</span><span class="token punctuation">)</span>

    result <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getResult<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> result <span class="token operator">==</span> TaskResult<span class="token punctuation">.</span>SUCCEEDED<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Got product from '</span> <span class="token operator">+</span> request_item_location <span class="token operator">+</span>
              <span class="token string">'! Bringing product to shipping destination ('</span> <span class="token operator">+</span> request_destination <span class="token operator">+</span> <span class="token string">')...'</span><span class="token punctuation">)</span>
        shipping_destination <span class="token operator">=</span> PoseStamped<span class="token punctuation">(</span><span class="token punctuation">)</span>
        shipping_destination<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">'map'</span>
        shipping_destination<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_msg<span class="token punctuation">(</span><span class="token punctuation">)</span>
        shipping_destination<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> shipping_destinations<span class="token punctuation">[</span>request_destination<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        shipping_destination<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> shipping_destinations<span class="token punctuation">[</span>request_destination<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        shipping_destination<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">1.0</span>
        shipping_destination<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">0.0</span>
        navigator<span class="token punctuation">.</span>goToPose<span class="token punctuation">(</span>shipping_destination<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> result <span class="token operator">==</span> TaskResult<span class="token punctuation">.</span>CANCELED<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task at '</span> <span class="token operator">+</span> request_item_location <span class="token operator">+</span>
              <span class="token string">' was canceled. Returning to staging point...'</span><span class="token punctuation">)</span>
        initial_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_msg<span class="token punctuation">(</span><span class="token punctuation">)</span>
        navigator<span class="token punctuation">.</span>goToPose<span class="token punctuation">(</span>initial_pose<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> result <span class="token operator">==</span> TaskResult<span class="token punctuation">.</span>FAILED<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task at '</span> <span class="token operator">+</span> request_item_location <span class="token operator">+</span> <span class="token string">' failed!'</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token keyword">not</span> navigator<span class="token punctuation">.</span>isTaskComplete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="62_Navigate_Through_Poses_1100"></a>6.2 Navigate Through Poses</h3> 
<p>NavigateThroughPoses 动作最适用于姿态受限的导航请求，或其他在行为树中表示一组姿态的任务。该操作不会在每个航点停留，而是以姿势约束的方式穿过这些航点。</p> 
<pre><code class="prism language-python"><span class="token comment">#! /usr/bin/env python3</span>
<span class="token comment"># Copyright 2021 Samsung Research America</span>
<span class="token comment">#</span>
<span class="token comment"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="token comment"># you may not use this file except in compliance with the License.</span>
<span class="token comment"># You may obtain a copy of the License at</span>
<span class="token comment">#</span>
<span class="token comment">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#</span>
<span class="token comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment"># See the License for the specific language governing permissions and</span>
<span class="token comment"># limitations under the License.</span>

<span class="token keyword">import</span> time
<span class="token keyword">from</span> copy <span class="token keyword">import</span> deepcopy

<span class="token keyword">from</span> geometry_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> PoseStamped
<span class="token keyword">from</span> rclpy<span class="token punctuation">.</span>duration <span class="token keyword">import</span> Duration
<span class="token keyword">import</span> rclpy

<span class="token keyword">from</span> nav2_simple_commander<span class="token punctuation">.</span>robot_navigator <span class="token keyword">import</span> BasicNavigator<span class="token punctuation">,</span> TaskResult

<span class="token triple-quoted-string string">'''
Basic security route patrol demo. In this demonstration, the expectation
is that there are security cameras mounted on the robots recording or being
watched live by security staff.
'''</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rclpy<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>

    navigator <span class="token operator">=</span> BasicNavigator<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Security route, probably read in from a file for a real application</span>
    <span class="token comment"># from either a map or drive and repeat.</span>
    security_route <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token number">1.792</span><span class="token punctuation">,</span> <span class="token number">2.144</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">1.792</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5.44</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">1.792</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">9.427</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3.665</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">9.427</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3.665</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.303</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3.665</span><span class="token punctuation">,</span> <span class="token number">2.330</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3.665</span><span class="token punctuation">,</span> <span class="token number">9.283</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token comment"># Set your demo's initial pose</span>
    initial_pose <span class="token operator">=</span> PoseStamped<span class="token punctuation">(</span><span class="token punctuation">)</span>
    initial_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">'map'</span>
    initial_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_msg<span class="token punctuation">(</span><span class="token punctuation">)</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">3.45</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">2.15</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">1.0</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">0.0</span>
    navigator<span class="token punctuation">.</span>setInitialPose<span class="token punctuation">(</span>initial_pose<span class="token punctuation">)</span>

    <span class="token comment"># Wait for navigation to activate fully </span>
    navigator<span class="token punctuation">.</span>waitUntilNav2Active<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Do security route until dead</span>
    <span class="token keyword">while</span> rclpy<span class="token punctuation">.</span>ok<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Send your route</span>
        route_poses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        pose <span class="token operator">=</span> PoseStamped<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">'map'</span>
        pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_msg<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token keyword">for</span> pt <span class="token keyword">in</span> security_route<span class="token punctuation">:</span>
            pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> pt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> pt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            route_poses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>deepcopy<span class="token punctuation">(</span>pose<span class="token punctuation">)</span><span class="token punctuation">)</span>
        navigator<span class="token punctuation">.</span>goThroughPoses<span class="token punctuation">(</span>route_poses<span class="token punctuation">)</span>

        <span class="token comment"># Do something during your route (e.x. AI detection on camera images for anomalies)</span>
        <span class="token comment"># Print ETA for the demonstration</span>
        i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> navigator<span class="token punctuation">.</span>isTaskComplete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
            feedback <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getFeedback<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> feedback <span class="token keyword">and</span> i <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Estimated time to complete current route: '</span> <span class="token operator">+</span> <span class="token string">'{0:.0f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                      Duration<span class="token punctuation">.</span>from_msg<span class="token punctuation">(</span>feedback<span class="token punctuation">.</span>estimated_time_remaining<span class="token punctuation">)</span><span class="token punctuation">.</span>nanoseconds <span class="token operator">/</span> <span class="token number">1e9</span><span class="token punctuation">)</span>
                      <span class="token operator">+</span> <span class="token string">' seconds.'</span><span class="token punctuation">)</span>

                <span class="token comment"># Some failure mode, must stop since the robot is clearly stuck</span>
                <span class="token keyword">if</span> Duration<span class="token punctuation">.</span>from_msg<span class="token punctuation">(</span>feedback<span class="token punctuation">.</span>navigation_time<span class="token punctuation">)</span> <span class="token operator">&gt;</span> Duration<span class="token punctuation">(</span>seconds<span class="token operator">=</span><span class="token number">180.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Navigation has exceeded timeout of 180s, canceling the request.'</span><span class="token punctuation">)</span>
                    navigator<span class="token punctuation">.</span>cancelTask<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># If at the end of the route, reverse the route to restart</span>
        security_route<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>

        result <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getResult<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> result <span class="token operator">==</span> TaskResult<span class="token punctuation">.</span>SUCCEEDED<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Route complete! Restarting...'</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> result <span class="token operator">==</span> TaskResult<span class="token punctuation">.</span>CANCELED<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Security route was canceled, exiting.'</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> result <span class="token operator">==</span> TaskResult<span class="token punctuation">.</span>FAILED<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Security route failed! Restarting from the other side...'</span><span class="token punctuation">)</span>

    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="63_Waypoint_Following_1216"></a>6.3 Waypoint Following</h3> 
<p>FollowWaypoints 操作最适用于简单的自主任务，您希望在每个航点停留并执行某个行为（例如暂停 2 秒、拍照、等待某人在航点上放置盒子等）。Nav2 航点跟踪服务器包含在每个航点执行任务的 TaskExecutor 插件。</p> 
<pre><code class="prism language-python"><span class="token comment">#! /usr/bin/env python3</span>
<span class="token comment"># Copyright 2021 Samsung Research America</span>
<span class="token comment">#</span>
<span class="token comment"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="token comment"># you may not use this file except in compliance with the License.</span>
<span class="token comment"># You may obtain a copy of the License at</span>
<span class="token comment">#</span>
<span class="token comment">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#</span>
<span class="token comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment"># See the License for the specific language governing permissions and</span>
<span class="token comment"># limitations under the License.</span>

<span class="token keyword">import</span> time
<span class="token keyword">from</span> copy <span class="token keyword">import</span> deepcopy

<span class="token keyword">from</span> geometry_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> PoseStamped
<span class="token keyword">from</span> rclpy<span class="token punctuation">.</span>duration <span class="token keyword">import</span> Duration
<span class="token keyword">import</span> rclpy

<span class="token keyword">from</span> nav2_simple_commander<span class="token punctuation">.</span>robot_navigator <span class="token keyword">import</span> BasicNavigator<span class="token punctuation">,</span> TaskResult


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rclpy<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>

    navigator <span class="token operator">=</span> BasicNavigator<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Inspection route, probably read in from a file for a real application</span>
    <span class="token comment"># from either a map or drive and repeat.</span>
    inspection_route <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token number">3.461</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.450</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3.461</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3.661</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.121</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3.661</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5.850</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token comment"># Set your demo's initial pose</span>
    initial_pose <span class="token operator">=</span> PoseStamped<span class="token punctuation">(</span><span class="token punctuation">)</span>
    initial_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">'map'</span>
    initial_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_msg<span class="token punctuation">(</span><span class="token punctuation">)</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">3.45</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">2.15</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">1.0</span>
    initial_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">0.0</span>
    navigator<span class="token punctuation">.</span>setInitialPose<span class="token punctuation">(</span>initial_pose<span class="token punctuation">)</span>

    <span class="token comment"># Wait for navigation to activate fully </span>
    navigator<span class="token punctuation">.</span>waitUntilNav2Active<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Send your route</span>
    inspection_points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    inspection_pose <span class="token operator">=</span> PoseStamped<span class="token punctuation">(</span><span class="token punctuation">)</span>
    inspection_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">'map'</span>
    inspection_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_msg<span class="token punctuation">(</span><span class="token punctuation">)</span>
    inspection_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">1.0</span>
    inspection_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> pt <span class="token keyword">in</span> inspection_route<span class="token punctuation">:</span>
        inspection_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> pt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        inspection_pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> pt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        inspection_points<span class="token punctuation">.</span>append<span class="token punctuation">(</span>deepcopy<span class="token punctuation">(</span>inspection_pose<span class="token punctuation">)</span><span class="token punctuation">)</span>
    nav_start <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
    navigator<span class="token punctuation">.</span>followWaypoints<span class="token punctuation">(</span>inspection_points<span class="token punctuation">)</span>

    <span class="token comment"># Do something during your route (e.x. AI to analyze stock information or upload to the cloud)</span>
    <span class="token comment"># Print the current waypoint ID for the demonstration</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token keyword">not</span> navigator<span class="token punctuation">.</span>isTaskComplete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
        feedback <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getFeedback<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> feedback <span class="token keyword">and</span> i <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Executing current waypoint: '</span> <span class="token operator">+</span>
                  <span class="token builtin">str</span><span class="token punctuation">(</span>feedback<span class="token punctuation">.</span>current_waypoint <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>inspection_points<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    result <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getResult<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> result <span class="token operator">==</span> TaskResult<span class="token punctuation">.</span>SUCCEEDED<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Inspection of shelves complete! Returning to start...'</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> result <span class="token operator">==</span> TaskResult<span class="token punctuation">.</span>CANCELED<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Inspection of shelving was canceled. Returning to start...'</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> result <span class="token operator">==</span> TaskResult<span class="token punctuation">.</span>FAILED<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Inspection of shelving failed! Returning to start...'</span><span class="token punctuation">)</span>

    <span class="token comment"># go back to start</span>
    initial_pose<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> navigator<span class="token punctuation">.</span>get_clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_msg<span class="token punctuation">(</span><span class="token punctuation">)</span>
    navigator<span class="token punctuation">.</span>goToPose<span class="token punctuation">(</span>initial_pose<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token keyword">not</span> navigator<span class="token punctuation">.</span>isTaskComplete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5f40fb301f180997e4efa463b9ff4cc1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">揭秘概率迷思：三门问题探析与Java代码模拟</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5593407263a9ce312e1ebe06f6066b85/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring Security6 最新版配置该怎么写，该如何实现动态权限管理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>