<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>星哥带你学秒杀-我看你还是有机会的 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="星哥带你学秒杀-我看你还是有机会的" />
<meta property="og:description" content="一、前言 大家好，好久不发文章了。最近自己把秒杀系统搭建了一下，想给有需要帮助的童鞋学习。整个项目已经放到Github上去了，项目Pull下来，修改好配置文件就可以跑起来，减少你们项目框架搭建的时间，希望对你们有帮助！！！
JDKMavenMysqlSpringBootRedisRocketMq1.83.2.25.8.X1.5.10.RELEASE3.24.3.X 项目地址：https://github.com/chenxingxing6/second_skill
二、如何理解秒杀系统 秒杀场景一般会在电商网站举行一些活动或者节假日在12306网站上抢票时遇到。对于电商网站中一些稀缺或者特价商品，电商网站一般会在约定时间点对其进行限量销售，因为这些商品的特殊性，会吸引大量用户前来抢购，并且会在约定的时间点同时在秒杀页面进行抢购。
2.1 秒杀系统场景特点 秒杀时大量用户会在同一时间同时进行抢购，网站瞬时访问流量激增。 秒杀一般是访问请求。数量远远大于库存数量，只有少部分用户能够秒杀成功。秒杀业务流程比较简单，一般就是下订单减库存。 2.2 秒杀系统设计理念 限流降级解决写问题：流量肖峰解决读问题：缓存机器可弹性扩容底层需要有个好的架构：分布式服务，读写分离 三、代码预览 3.1 架构设计 3.2 项目启动说明 1、启动前，进行相关redis、mysql、rocketMq地址
2、登录地址：http://localhost:8888/page/login
3、商品秒杀列表地址：http://localhost:8888/goods/list
4、账号：18077200000，密码：123456
PS：测试时需要修改秒杀活动时间seckill_goods表开始和结束时间，然后确保库存足够。
3.3 如何模拟高并发（测试） 1、数据库共有一千个用户左右（手机号：从18077200000~18077200998 密码为：123456）
2、使用CyclicBarrier模拟高并发，1000个用户秒杀某个商品
3、读：Redis
4、写：RocketMq
ExecutorService executorService = Executors.newCachedThreadPool(); CyclicBarrier barrier = new CyclicBarrier(size); for (int i = 0; i &lt; size; i&#43;&#43;) { int finalI = i; int finalI1 = i; executorService.execute(()-&gt;{ try { barrier.await(); // 1000个人模拟高并发 businessDoHandler(users.get(finalI), goodsId); } catch (Exception e) { e." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ca3054ba38ccf483d48fc593bae48a1b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-26T16:38:49+08:00" />
<meta property="article:modified_time" content="2020-07-26T16:38:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">星哥带你学秒杀-我看你还是有机会的</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/03/a3/PtExvbIZ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/0f/e4/RNU8BCWg_o.png" alt="在这里插入图片描述" width="510" height="300"></p> 
<h3><a id="_4"></a>一、前言</h3> 
<p>大家好，好久不发文章了。最近自己把秒杀系统搭建了一下，想给有需要帮助的童鞋学习。整个项目已经放到Github上去了，项目Pull下来，修改好配置文件就可以跑起来，减少你们项目框架搭建的时间，希望对你们有帮助！！！</p> 
<table><thead><tr><th>JDK</th><th>Maven</th><th>Mysql</th><th>SpringBoot</th><th>Redis</th><th>RocketMq</th></tr></thead><tbody><tr><td>1.8</td><td>3.2.2</td><td>5.8.X</td><td>1.5.10.RELEASE</td><td>3.2</td><td>4.3.X</td></tr></tbody></table> 
<p><img src="https://images2.imgbox.com/eb/95/ZuoYXX12_o.png" alt="在这里插入图片描述"><br> <a href="https://github.com/chenxingxing6/second_skill">项目地址</a>：https://github.com/chenxingxing6/second_skill</p> 
<hr> 
<h3><a id="_16"></a>二、如何理解秒杀系统</h3> 
<p>秒杀场景一般会在电商网站举行一些活动或者节假日在12306网站上抢票时遇到。对于电商网站中一些稀缺或者特价商品，电商网站一般会在约定时间点对其进行限量销售，因为这些商品的特殊性，会吸引大量用户前来抢购，并且会在约定的时间点同时在秒杀页面进行抢购。</p> 
<h6><a id="21__19"></a>2.1 秒杀系统场景特点</h6> 
<ul><li>秒杀时大量用户会在同一时间同时进行抢购，网站瞬时访问流量激增。 秒杀一般是访问请求。</li><li>数量远远大于库存数量，只有少部分用户能够秒杀成功。</li><li>秒杀业务流程比较简单，一般就是下订单减库存。</li></ul> 
<h6><a id="22__26"></a>2.2 秒杀系统设计理念</h6> 
<ul><li>限流</li><li>降级</li><li>解决写问题：流量肖峰</li><li>解决读问题：缓存</li><li>机器可弹性扩容</li><li>底层需要有个好的架构：分布式服务，读写分离</li></ul> 
<hr> 
<h3><a id="_35"></a>三、代码预览</h3> 
<p><img src="https://images2.imgbox.com/b4/23/jJY6eBzA_o.png" alt="在这里插入图片描述" width="390" height="750"></p> 
<h6><a id="31__39"></a>3.1 架构设计</h6> 
<p><img src="https://images2.imgbox.com/65/3c/cTWNqkt0_o.png" alt="在这里插入图片描述" width="300" height="300"></p> 
<p><img src="https://images2.imgbox.com/4d/30/h2AGUYzx_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="32__44"></a>3.2 项目启动说明</h6> 
<blockquote> 
 <p>1、启动前，进行相关redis、mysql、rocketMq地址<br> 2、登录地址：http://localhost:8888/page/login<br> 3、商品秒杀列表地址：http://localhost:8888/goods/list<br> 4、账号：18077200000，密码：123456</p> 
</blockquote> 
<p>PS：测试时需要修改秒杀活动时间seckill_goods表开始和结束时间，然后确保库存足够。</p> 
<h6><a id="33__52"></a>3.3 如何模拟高并发（测试）</h6> 
<blockquote> 
 <p>1、数据库共有一千个用户左右（手机号：从18077200000~18077200998 密码为：123456）<br> 2、使用CyclicBarrier模拟高并发，1000个用户秒杀某个商品<br> 3、读：Redis<br> 4、写：RocketMq</p> 
</blockquote> 
<pre><code class="prism language-java">ExecutorService executorService <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  CyclicBarrier barrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">int</span> finalI <span class="token operator">=</span> i<span class="token punctuation">;</span>
       <span class="token keyword">int</span> finalI1 <span class="token operator">=</span> i<span class="token punctuation">;</span>
       executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
           <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
               barrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 1000个人模拟高并发</span>
               <span class="token function">businessDoHandler</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>finalI<span class="token punctuation">)</span><span class="token punctuation">,</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="34__78"></a>3.4 技术实现</h6> 
<blockquote> 
 <p>1、页面缓存、商品详情静态化、订单静态化(生成html放缓存里面)<br> 2、消息队列RocketMq进行流量肖峰<br> 3、解决超卖问题 (文末有提3种方式，本应用用redis预减库存实现)<br> 4、接口限流防刷（Redis,Guava）</p> 
</blockquote> 
<h6><a id="35__85"></a>3.5 页面截图</h6> 
<p><img src="https://images2.imgbox.com/74/ae/0GT9HCai_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/e9/a5/dyGoRgYJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1e/f5/UH9WOxCa_o.png" alt="在这里插入图片描述"><br> 中奖名单：</p> 
<pre><code class="prism language-html">【排名：1】，用户名：user4，秒杀商品： iPhone X
【排名：2】，用户名：user2，秒杀商品： iPhone X
【排名：3】，用户名：user69，秒杀商品： iPhone X
【排名：4】，用户名：user6，秒杀商品： iPhone X
【排名：5】，用户名：user7，秒杀商品： iPhone X
【排名：6】，用户名：user9，秒杀商品： iPhone X
【排名：7】，用户名：user0，秒杀商品： iPhone X
【排名：8】，用户名：user1，秒杀商品： iPhone X
【排名：9】，用户名：user56，秒杀商品： iPhone X
【排名：10】，用户名：user59，秒杀商品： iPhone X
【排名：11】，用户名：user119，秒杀商品： iPhone X
【排名：12】，用户名：user122，秒杀商品： iPhone X
【排名：13】，用户名：user123，秒杀商品： iPhone X
【排名：14】，用户名：user100，秒杀商品： iPhone X
【排名：15】，用户名：user999，秒杀商品： iPhone X
【排名：16】，用户名：user127，秒杀商品： iPhone X
【排名：17】，用户名：user137，秒杀商品： iPhone X
【排名：18】，用户名：user160，秒杀商品： iPhone X
【排名：19】，用户名：user5，秒杀商品： iPhone X
【排名：20】，用户名：user146，秒杀商品： iPhone X
【排名：21】，用户名：user157，秒杀商品： iPhone X
【排名：22】，用户名：user180，秒杀商品： iPhone X
【排名：23】，用户名：user185，秒杀商品： iPhone X
【排名：24】，用户名：user435，秒杀商品： iPhone X
【排名：25】，用户名：user60，秒杀商品： iPhone X
.......
</code></pre> 
<p><img src="https://images2.imgbox.com/a3/2b/qfb9BzSl_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/33/2c/lAbkDmwP_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="_124"></a>四、秒杀系统常见问题</h3> 
<h6><a id="41__125"></a>4.1 高并发</h6> 
<p>特点：时间短，瞬间用户请求量巨大</p> 
<p>大量的请求进来，我们需要考虑的点就很多了，缓存雪崩，缓存击穿，缓存穿透这些我之前提到的点都是有可能发生的，出现问题打挂DB那就很难受了，活动失败用户体验差，活动人气没了，最后背锅的还是开发。</p> 
<h6><a id="42__130"></a>4.2 超卖</h6> 
<p>但凡是个秒杀，都怕超卖，100个华为Pro50，商家的预算经费卖100个可以赚点还可以造势，结果你写错程序多卖出去200个，你不发货用户投诉你，平台封你店，你发货就血亏，你怎么办？</p> 
<h6><a id="43__133"></a>4.3 恶意请求</h6> 
<p>搞个几十台机器搞点脚本，我也模拟出来十几万个人左右的请求，那我是不是意味着我基本上有80%的成功率了。真实情况可能远远不止，因为机器请求的速度比人的手速往往快太多了。假如我抢到了，我转手卖掉我不是血赚？就算我不卖我也不亏啊！！！</p> 
<h6><a id="44__137"></a>4.4 秒杀链接加盐</h6> 
<p>把URL动态化，就连写代码的人都不知道，你就通过MD5之类的加密算法加密随机的字符串去做url，然后通过前端代码获取url后台校验才能通过。</p> 
<h6><a id="45__141"></a>4.5 服务单一职责</h6> 
<p>设计个能抗住高并发的系统，我觉得还是得单一职责。什么意思呢，大家都知道现在设计都是微服务的设计思想，然后再用分布式的部署方式单一职责的好处就是就算秒杀没抗住，秒杀库崩了，服务挂了，也不会影响到其他的服务。</p> 
<h6><a id="46_Redis_145"></a>4.6 Redis集群</h6> 
<p>我们知道单机的Redis顶不住，那简单多找几个兄弟啊，秒杀本来就是读多写少，那你们是不是瞬间想起来我之前跟你们提到过的，Redis集群，主从同步、读写分离，我们还搞点哨兵，开启持久化直接无敌高可用！</p> 
<h6><a id="47_Nginx_149"></a>4.7 Nginx负载均衡</h6> 
<p><img src="https://images2.imgbox.com/bb/32/7m66sCkJ_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="48__152"></a>4.8 资源静态化</h6> 
<p>秒杀一般都是特定的商品还有页面模板，现在一般都是前后端分离的，所以页面一般都是不会经过后端的，但是前端也要自己的服务器啊，那就把能提前放入cdn服务器的东西都放进去，反正把所有能提升效率的步骤都做一下，减少真正秒杀时候服务器的压力。</p> 
<h6><a id="49__156"></a>4.9 按钮控制</h6> 
<p>大家有没有发现没到秒杀前，一般按钮都是置灰的，只有时间到了，才能点击。这是因为怕大家在时间快到的最后几秒秒疯狂请求服务器，然后还没到秒杀的时候基本上服务器就挂了。这个时候就需要前端的配合，定时去请求你的后端服务器，获取最新的北京时间，到时间点再给按钮可用状态。</p> 
<h6><a id="410__159"></a>4.10 库存预热</h6> 
<p>秒杀的本质，就是对库存的抢夺，每个秒杀的用户来你都去数据库查询库存校验库存，然后扣减库存，撇开性能因数，你不觉得这样好繁琐，对业务开发人员都不友好，而且数据库顶不住啊。所以我们可以先将库存加载到redis中预热，然后秒杀了，在对db库存进行异步修改。</p> 
<h6><a id="411__162"></a>4.11 限流</h6> 
<p><strong>前端限流</strong>：秒杀一般不会让你一直点的，一般都是点击一下或者两下然后几秒之后才可以继续点击，这也是保护服务器的一种手段。<br> <strong>后端限流</strong>：秒杀的时候肯定是涉及到后续的订单生成和支付等操作，但这时只有秒杀成功的请求才会执行后续操作。常用技术方案（Sentinel，Hystrix）</p> 
<h6><a id="412__166"></a>4.12 流量肖峰</h6> 
<p>把所有请求它入消息队列，然后一点点消费去改库存就好了嘛</p> 
<hr> 
<h3><a id="3_171"></a>五、解决超卖实现的3种方式</h3> 
<h6><a id="51_Mysql_172"></a>5.1 Mysql排他锁</h6> 
<blockquote> 
 <p>update goods set num = num - 1 WHERE id = 1001 and num &gt; 0</p> 
</blockquote> 
<p>排他锁又称为写锁，简称X锁，顾名思义，排他锁就是不能与其他所并存，如一个事务获取了一个数据行的排 他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据就 行读取和修改。就是类似于我在执行update操作的时候，这一行是一个事务(默认加了排他锁)。这一行不能 被任何其他线程修改和读写。</p> 
<h6><a id="52__177"></a>5.2 乐观锁版本控制</h6> 
<blockquote> 
 <p>select version from goods WHERE id= 1001<br> update goods set num = num - 1, version = version + 1 WHERE id= 1001 AND num &gt; 0 AND version = @version(上面查到的version);</p> 
</blockquote> 
<p>这种方式采用了版本号的方式，其实也就是CAS的原理。</p> 
<h6><a id="53_Redislua_183"></a>5.3 Redis单线程预减库存（lua脚本）</h6> 
<p>利用redis的单线程预减库存。比如商品有100件。那么我在redis存储一个k,v。例如 &lt;gs1001, 100&gt;每一个用户线程进来，key值就减1，等减到0的时候，全部拒绝剩下的请求。那么也就是只有100个线程会进入到后续操作。所以一定不会出现超卖的现象。</p> 
<pre><code class="prism language-html"> static {
    /**
       * @desc 扣减库存Lua脚本
       * 库存（stock）-1：表示不限库存
       * 库存（stock）0：表示没有库存
       * 库存（stock）大于0：表示剩余库存
       *
       * @params 库存key
       * @return
       * 		-3:库存未初始化
       * 		-2:库存不足
       * 		-1:不限库存
       * 		大于等于0:剩余库存（扣减之后剩余的库存）
       * 	    redis缓存的库存(value)是-1表示不限库存，直接返回1
       */
      StringBuilder sb = new StringBuilder();
      sb.append("if (redis.call('exists', KEYS[1]) == 1) then");
      sb.append("    local stock = tonumber(redis.call('get', KEYS[1]));");
      sb.append("    local num = tonumber(ARGV[1]);");
      sb.append("    if (stock == -1) then");
      sb.append("        return -1;");
      sb.append("    end;");
      sb.append("    if (stock &gt;= num) then");
      sb.append("        return redis.call('incrby', KEYS[1], 0 - num);");
      sb.append("    end;");
      sb.append("    return -2;");
      sb.append("end;");
      sb.append("return -3;");
      STOCK_LUA = sb.toString();
  }
</code></pre> 
<p>总结：第二种CAS是失败重试，并无加锁。应该比第一种加锁效率要高很多。类似于Java中的Synchronize和CAS。</p> 
<hr> 
<h3><a id="Redis_221"></a>六、限流（Redis实现）</h3> 
<pre><code class="prism language-html">@Retention(RUNTIME)
@Target(METHOD)
public @interface AccessLimit {
	int seconds();
	int maxCount();
	boolean needLogin() default true;
}

</code></pre> 
<p><img src="https://images2.imgbox.com/39/15/oeM7baQt_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-html">  //接口限流
 AccessLimit accessLimit = handlerMethod.getMethodAnnotation(AccessLimit.class);
   if(accessLimit == null) {
       return true;
   }
   int seconds = accessLimit.seconds();
   int maxCount = accessLimit.maxCount();
   boolean needLogin = accessLimit.needLogin();
   String key = request.getRequestURI();
   
   AccessKey ak = AccessKey.withExpire;
   Integer count = redisService.get(ak, key, Integer.class);
   if(count == null) {
       redisService.set(ak, key, 1, seconds);
   }else if(count &lt; maxCount) {
       redisService.incr(ak, key);
   }else {
       render(response, CodeMsg.ACCESS_LIMIT_REACHED);
       return false;
   }
</code></pre> 
<hr> 
<h3><a id="_258"></a>七、分布式锁</h3> 
<p>测试代码：在该项目lxhv1分支里面：<a href="https://github.com/chenxingxing6/second_skill/tree/lxhv1">下载地址</a></p> 
<h6><a id="71___260"></a>7.1 基于数据库实现 (效率低，不推荐使用)</h6> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>my_lock<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>gmt_modify<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lock_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lock_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>version<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'版本号'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>UK_key<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>lock_type<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">664</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8
</code></pre> 
<p>1）唯一索引 UNIQUE KEY<br> 当想要锁住某个方法时执行insert方法，插入一条数据，lock_type有唯一约束，可以保证多次提交只有一次成功，而成功的<br> 这次就可以认为其获得了锁，而执行完成后执行delete语句释放锁。</p> 
<p>缺点：</p> 
<blockquote> 
 <p>1.强依赖与数据库<br> 2.非阻塞的，获取失败直接失败<br> 3.没有失效时间<br> 4.非重入锁</p> 
</blockquote> 
<hr> 
<p>2）乐观锁</p> 
<pre><code class="prism language-html">-- 线程1查询，当前left_count为1，则有记录，当前版本号为1234
select left_count, version from t_bonus where id = 10001 and left_count &gt; 0

-- 线程2查询，当前left_count为1，有记录，当前版本号为1234
select left_count, version from t_bonus where id = 10001 and left_count &gt; 0

-- 线程1,更新完成后当前的version为1235，update状态为1，更新成功
update t_bonus set version = 1235, left_count = left_count-1 where id = 10001 and version = 1234

-- 线程2,更新由于当前的version为1235，udpate状态为0，更新失败，再针对相关业务做异常处理
update t_bonus set version = 1235, left_count = left_count-1 where id = 10001 and version = 1234
</code></pre> 
<p>3）悲观锁（排他锁）for update<br> 在查询语句后面增加for update，数据库会在查询过程中给数据库表增加排他锁。当某条记录被加上排他锁之后，其他线程无法再在该行记录上增加排他锁。<br> 我们可以认为获得排它锁的线程即可获得分布式锁，当获取到锁之后，可以执行方法的业务逻辑，执行完方法之后，再通过connection.commit();操作来释放锁</p> 
<h6><a id="72_Redis_redisson_307"></a>7.2 Redis （使用redisson，释放锁要小心）</h6> 
<blockquote> 
 <p>1.se<br> tnx(lockkey, 1) 如果返回0，则说明占位失败；如果返回1，则说明占位成功<br> 2.expire()命令对lockkey设置超时时间，为的是避免死锁问题。<br> 3.执行完业务代码后，可以通过delete命令删除key。</p> 
</blockquote> 
<pre><code class="prism language-html"> private void handler_redis(User user, Long goodId){
    String key = "MY_KEY_"+goodId;
    try {
        boolean lock = lock4.getLock(key, String.valueOf(user.getId()), 10);
        if (lock){
            System.out.println("获取到锁....");
        }else {
            System.out.println("没获取到锁");
        }
    }finally {
        lock4.unLock(key, String.valueOf(user.getId()));
    }
    }
</code></pre> 
<h6><a id="73_Zookeeper_327"></a>7.3 Zookeeper（临时节点，效率高）</h6> 
<p>原理：使用zookeeper创建临时序列节点来实现分布式锁，适用于顺序执行的程序，大体思路就是创建临时序列节点，找出最小的序列节点，获取分布式锁，程序执行完成之后此序列节点消失，通过watch来监控节点的变化，从剩下的节点的找到最小的序列节点，获取分布式锁，执行相应处理，依次类推……</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>curator-recipes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<pre><code class="prism language-html">/**
 * 获取分布式锁
 */
public Boolean tryLock(String path) {
    String keyPath = "/" + ROOT_PATH_LOCK + "/" + path;
    try {
        client.create()
        .creatingParentsIfNeeded()
        .withMode(CreateMode.EPHEMERAL)
        .withACL(ZooDefs.Ids.OPEN_ACL_UNSAFE)
        .forPath(keyPath);
        System.out.println("success to acquire lock for path " + keyPath);
        return true;
    } catch (Exception e) {
        System.out.println("failed to acquire lock for path");
        return false;
    }
}

/**
 * 释放分布式锁
 */
public boolean unLock(String path) {
    try {
        String keyPath = "/" + ROOT_PATH_LOCK + "/" + path;
        if (client.checkExists().forPath(keyPath) != null) {
            client.delete().forPath(keyPath);
        }
    } catch (Exception e) {
        System.out.println("failed to release lock");
        return false;
    }
    return true;
}
</code></pre> 
<hr> 
<h3><a id="MQ_378"></a>八、MQ异步处理</h3> 
<h6><a id="81__379"></a>8.1 发送消息</h6> 
<pre><code class="prism language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">businessDoHandler</span><span class="token punctuation">(</span>User user<span class="token punctuation">,</span> <span class="token keyword">long</span> goodId<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//内存标记，减少redis访问</span>
        <span class="token keyword">boolean</span> over <span class="token operator">=</span> localOverMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>over<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"【内存标记】用户：%s，秒杀失败：%s"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CodeMsg<span class="token punctuation">.</span>MIAO_SHA_OVER<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//预减库存（volatile保证原子可见性）</span>
        stock <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span>GoodsKey<span class="token punctuation">.</span>getSeckillGoodsStock<span class="token punctuation">,</span> <span class="token string">""</span> <span class="token operator">+</span> goodId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"【预减库存】用户：%s，秒杀失败：%s"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CodeMsg<span class="token punctuation">.</span>MIAO_SHA_OVER<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            localOverMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>goodId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//判断是否已经秒杀到了</span>
        SeckillOrder order <span class="token operator">=</span> seckillOrderService<span class="token punctuation">.</span><span class="token function">getSeckillOrderByUserIdGoodsId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> goodId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"用户：%s，秒杀失败：%s"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CodeMsg<span class="token punctuation">.</span>REPEATE_MIAOSHA<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        SeckillMessage mm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mm<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mm<span class="token punctuation">.</span><span class="token function">setGoodsId</span><span class="token punctuation">(</span>goodId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mm<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mqSender<span class="token punctuation">.</span><span class="token function">sendSeckillMessage</span><span class="token punctuation">(</span>mm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5a/01/JUcdJRcr_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/38/6b/nF8KQPhD_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="82__413"></a>8.2 处理消息</h6> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>mq<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>bo<span class="token punctuation">.</span>GoodsBo<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>common<span class="token punctuation">.</span>Const<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>AbstractRocketConsumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>RedisService<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>SeckillKey<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service<span class="token punctuation">.</span>OrderService<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service<span class="token punctuation">.</span>SeckillGoodsService<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service<span class="token punctuation">.</span>SeckillOrderService<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service<span class="token punctuation">.</span>UserService<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>ThreadPoolScheduleManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>util<span class="token punctuation">.</span>MD5Util<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>WebSocketServer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>CollectionUtils<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyStatus<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>MessageListenerConcurrently<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageExt<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Logger<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>LoggerFactory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Service<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Objects<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ScheduledExecutorService<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span>AtomicInteger<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MQReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRocketConsumer</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> Logger log <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>MQReceiver<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token annotation punctuation">@Autowired</span>
	RedisService redisService<span class="token punctuation">;</span>
	<span class="token annotation punctuation">@Autowired</span>
	SeckillGoodsService goodsService<span class="token punctuation">;</span>
	<span class="token annotation punctuation">@Autowired</span>
    OrderService orderService<span class="token punctuation">;</span>
	<span class="token annotation punctuation">@Autowired</span>
    SeckillOrderService seckillOrderService<span class="token punctuation">;</span>
	<span class="token annotation punctuation">@Autowired</span>
	WebSocketServer webSocketServer<span class="token punctuation">;</span>
	<span class="token annotation punctuation">@Autowired</span>
    UserService userService<span class="token punctuation">;</span>
	<span class="token keyword">private</span> AtomicInteger num <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> stock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 设置主题,标签与消费者标题</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">"skill"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token string">"标题"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> ConsumeConcurrentlyStatus <span class="token function">consumeMessage</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>MessageExt<span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> ConsumeConcurrentlyContext consumeConcurrentlyContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>msg<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
					String content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					String keyMd5 <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">receive</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> keyMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span>String content<span class="token punctuation">,</span> String md5<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>redisService<span class="token punctuation">.</span><span class="token function">setnx</span><span class="token punctuation">(</span>md5<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息重复消费"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		SeckillMessage mm  <span class="token operator">=</span> RedisService<span class="token punctuation">.</span><span class="token function">stringToBean</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> SeckillMessage<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		User user <span class="token operator">=</span> mm<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">long</span> goodsId <span class="token operator">=</span> mm<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		Long grabTime <span class="token operator">=</span> mm<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//判断是否已经秒杀到了</span>
		String key <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> goodsId<span class="token punctuation">;</span>
		Boolean aBoolean <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>SeckillKey<span class="token punctuation">.</span>skillUser<span class="token punctuation">,</span> key<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>aBoolean <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> Boolean<span class="token punctuation">.</span>TRUE <span class="token operator">==</span> aBoolean<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// 用户排名sorted Set</span>
		redisService<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"activity_"</span><span class="token operator">+</span>goodsId<span class="token punctuation">,</span> grabTime<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 分布式锁(5s内抢完，延时发送消息)</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>redisService<span class="token punctuation">.</span><span class="token function">setnx</span><span class="token punctuation">(</span><span class="token string">"activity_lock"</span><span class="token operator">+</span>goodsId<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			ScheduledExecutorService scheduledExecutorService <span class="token operator">=</span> ThreadPoolScheduleManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			scheduledExecutorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">execute5SecondsDeliver</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">execute5SecondsDeliver</span><span class="token punctuation">(</span>Long goodId<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 根据抢的时间进行升序排序</span>
		List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> userIds <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">zrange</span><span class="token punctuation">(</span><span class="token string">"activity_"</span><span class="token operator">+</span>goodId<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>CollectionUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		List<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		GoodsBo goodsBo <span class="token operator">=</span> goodsService<span class="token punctuation">.</span><span class="token function">getseckillGoodsBoByGoodsId</span><span class="token punctuation">(</span>goodId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		Map<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> User<span class="token punctuation">&gt;</span></span> userMap <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>e <span class="token operator">-</span><span class="token operator">&gt;</span> e<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> u <span class="token operator">-</span><span class="token operator">&gt;</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//减库存,下订单,写入秒杀订单</span>
		userIds <span class="token operator">=</span> userIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>String userId <span class="token operator">:</span> userIds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			User user <span class="token operator">=</span> userMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			webSocketServer<span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"【排名：%s】，用户名：%s，秒杀商品：%s"</span><span class="token punctuation">,</span> num<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> goodsBo<span class="token punctuation">.</span><span class="token function">getGoodsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			String key <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> goodId<span class="token punctuation">;</span>
			redisService<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>SeckillKey<span class="token punctuation">.</span>skillUser<span class="token punctuation">,</span> key<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">,</span> Const<span class="token punctuation">.</span>RedisCacheExtime<span class="token punctuation">.</span>Second60<span class="token punctuation">)</span><span class="token punctuation">;</span>
			seckillOrderService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> goodsBo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<hr>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6f599ae842006ce652148d37a86a5fad/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">等保测评2.0：Windows 剩余信息保护</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7d41d8e4bac9acedb13851fad904be96/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Springboot中Service不被识别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>