<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Shell_scp expect实现 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Shell_scp expect实现" />
<meta property="og:description" content="Shell_scp expect实现 时间:2012-10-23 08:52 来源:未知 作者:zhibj 点击: 199 次 使用expect实现自动登录的脚本，网上有很多，可是都没有一个明白的说明，初学者一般都是照抄、收藏。可是为什么要这么写却不知其然。本文用一个最短的例子说明脚本的原理。 南京嵌入式培训 脚本代码如下： ############################################## # 使用expect实现自动登录的脚本，网上有很多，可是都没有一个明白的说明，初学者一般都是照抄、收藏。可是为什么要这么写却不知其然。本文用一个最短的例子说明脚本的原理。
南京嵌入式培训
脚本代码如下：
##############################################
#!/usr/bin/expect
set timeout 30
spawn ssh -l username 192.168.1.1
expect &#34;password:&#34;
send &#34;ispass\r&#34;
interact ##############################################
1. ［#!/usr/bin/expect］
这一行告诉操作系统脚本里的代码使用那一个shell来执行。这里的expect其实和linux下的bash、windows下的cmd是一类东西。
注意：这一行需要在脚本的第一行。
2. ［set timeout 30］
基本上认识英文的都知道这是设置超时时间的，现在你只要记住他的计时单位是：秒
3. ［spawn ssh -l username 192.168.1.1］
spawn是进入expect环境后才可以执行的expect内部命令，如果没有装expect或者直接在默认的SHELL下执行是找不到spawn命 令的。所以不要用 “which spawn“之类的命令去找spawn命令。好比windows里的dir就是一个内部命令，这个命令由shell自带，你无法找到一个dir.com 或 dir.exe 的可执行文件。
它主要的功能是给ssh运行进程加个壳，用来传递交互指令。南京嵌入式培训
4. ［expect &#34;password:&#34;］
这里的expect也是expect的一个内部命令，有点晕吧，expect的shell命令和内部命令是一样的，但不是一个功能，习惯就好了。这个命 令的意思是判断上次输出结果里是否包含“password:”的字符串，如果有则立即返回，否则就等待一段时间后返回，这里等待时长就是前面设置的30秒 南京嵌入式培训
5. ［send &#34;ispass\r&#34;］
这里就是执行交互动作，与手工输入密码的动作等效。
温馨提示： 命令字符串结尾别忘记加上“\r”，如果出现异常等待的状态可以核查一下。
6. ［interact］" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/74e0b4f1dce913d9a97a5041d9b327d0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-03-13T01:03:33+08:00" />
<meta property="article:modified_time" content="2013-03-13T01:03:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Shell_scp expect实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="title"> 
 <h3>Shell_scp expect实现</h3> 
</div> 
<div class="info"> 
 <small><span style="font-size:12px">时间:</span></small>2012-10-23 08:52 
 <small><span style="font-size:12px">来源:</span></small>未知 
 <small><span style="font-size:12px">作者:</span></small>zhibj 
 <small><span style="font-size:12px">点击:</span></small> 199 次 
</div> 
<div class="intro">
  使用expect实现自动登录的脚本，网上有很多，可是都没有一个明白的说明，初学者一般都是照抄、收藏。可是为什么要这么写却不知其然。本文用一个最短的例子说明脚本的原理。 南京嵌入式培训 脚本代码如下： ############################################## # 
</div> 
<div class="content"> 
 <table width="100%" style="word-break:break-all"><tbody><tr><td> 
     <div id="content" style="line-height:1.5; margin:7px 0px 10px; width:758px; zoom:1; font-family:'Microsoft Yahei',微软雅黑,Tahoma,Arial,Helvetica,STHeiti; color:rgb(69,69,69); font-size:14px; overflow:hidden"> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">使用expect实现自动登录的脚本，网上有很多，可是都没有一个明白的说明，初学者一般都是照抄、收藏。可是为什么要这么写却不知其然。本文用一个最短的例子说明脚本的原理。</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> <a href="http://edu.iwetek.com/" rel="nofollow">南京嵌入式培训</a></span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　脚本代码如下：</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　##############################################</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　#!/usr/bin/expect</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　set timeout 30</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　spawn ssh -l username 192.168.1.1</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　expect "password:"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　send "ispass\r"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> interact </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　##############################################</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　1. ［#!/usr/bin/expect］</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　这一行告诉操作系统脚本里的代码使用那一个shell来执行。这里的expect其实和linux下的bash、windows下的cmd是一类东西。</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　注意：这一行需要在脚本的第一行。</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　2. ［set timeout 30］</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　基本上认识英文的都知道这是设置超时时间的，现在你只要记住他的计时单位是：秒</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　3. ［spawn ssh -l username 192.168.1.1］</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　spawn是进入expect环境后才可以执行的expect内部命令，如果没有装expect或者直接在默认的SHELL下执行是找不到spawn命 令的。所以不要用 “which spawn“之类的命令去找spawn命令。好比windows里的dir就是一个内部命令，这个命令由shell自带，你无法找到一个dir.com 或 dir.exe 的可执行文件。</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　它主要的功能是给ssh运行进程加个壳，用来传递交互指令。<a href="http://edu.iwetek.com/" rel="nofollow">南京嵌入式培训</a></span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　4. ［expect "password:"］</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　这里的expect也是expect的一个内部命令，有点晕吧，expect的shell命令和内部命令是一样的，但不是一个功能，习惯就好了。这个命 令的意思是判断上次输出结果里是否包含“password:”的字符串，如果有则立即返回，否则就等待一段时间后返回，这里等待时长就是前面设置的30秒 <a href="http://edu.iwetek.com/" rel="nofollow">南京嵌入式培训</a></span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　5. ［send "ispass\r"］</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　这里就是执行交互动作，与手工输入密码的动作等效。</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　温馨提示： 命令字符串结尾别忘记加上“\r”，如果出现异常等待的状态可以核查一下。</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　6. ［interact］</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　执行完成后保持交互状态，把控制权交给控制台，这个时候就可以手工操作了。如果没有这一句登录完成后会退出，而不是留在远程终端上。如果你只是登录过去执行</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　#!/usr/bin/expect #注意安装的路径，不确定 whereis expect 一下</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　# Change a login shell to bash</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　　set user [lindex $argv 0]</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　spawn bash $user</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　expect "]:"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">　send "/bin/bash "</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> expect eof </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">+=========================================================================================================</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">+=========================================================================================================</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">通过在shell脚本中用expect实现远程scp文件：</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">使用expect前，需要先安装两个rpm包：</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"># rpm -ihv CentOS/expect-5.43.0-5.1.i386.rpm</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"># rpm -ihv CentOS/expect-devel-5.43.0-5.1.i386.rpm<a href="http://edu.iwetek.com/" rel="nofollow">南京嵌入式培训</a></span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">#!/usr/bin/expect -f</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set password 密码</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">spawn scp 用户名@目标机器ip:拷贝文件的路径 存放本地文件的路径</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set timeout 300</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">expect "用户名@目标机器ip's password:" //注意：这里的“用户名@目标机器ip” 跟上面的一致</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set timeout 300</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">send "$password\r"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set timeout 300   //此处设置超时时间，单位为秒，如果，拷贝文件比较大并且多时，应该将这个值调大一些。</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">send "exit\r"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">expect eof</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">附：scp参数</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">-r：拷贝目录</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">-c：允许压缩</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">一个完整的例子</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">expect_scp.exp</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">-------------------------------------------------------------------------</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">#!/usr/bin/expect -f</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">#Author by kevin<a href="http://edu.iwetek.com/" rel="nofollow">南京嵌入式培训</a></span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">#date is 2011-11-14</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set password vcdog</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">#download local host</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">spawn scp -r root@192.168.1.107:/root/dba_tool/test /root/DBA_TOOL/</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set timeout 3</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">expect {<!-- --></span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">"yes/no" {send "yes\r";exp_continue}</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">}</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">expect "root@192.168.1.107's password:"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set timeout 3</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">send "$password\r"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set timeout 300</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">send "exit\r"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">expect eof</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">#upload remote host</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">spawn scp -r /root/DBA_TOOL/t.txt root@192.168.1.107:/root/dba_tool/</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set timeout 3</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">expect {<!-- --></span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">"yes/no" {send "yes\r";exp_continue}</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">}</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">expect "root@192.168.1.107's password:"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set timeout 3<a href="http://edu.iwetek.com/" rel="nofollow">南京嵌入式培训</a></span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">send "$password\r"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">set timeout 300</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">send "exit\r"</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">expect eof</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">-------------------------------------------------------------------------------------------------------------------------</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">测试验证：</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"># chmod +x ./expect_scp.exp</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"># expect ./expect_scp.exp</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">spawn scp -r root@192.168.1.107:/root/dba_tool/test /root/DBA_TOOL/</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">root@192.168.1.107's password:</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">test                                                                                              100%   12     0.0KB/s   00:00</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">spawn scp -r /root/DBA_TOOL/t.txt root@192.168.1.107:/root/dba_tool/</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">root@192.168.1.107's password:</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">t.txt                                                                                             100%  254     0.3KB/s   00:00</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">本地服务器：（192.168.1.106）</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">[root@F-app-01 DBA_TOOL]# ll /root/DBA_TOOL/</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">total 64</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">-rw-r--r-- 1 root root   548 Nov 14 23:46 expect_scp.exp</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">-rw-r--r-- 1 root root    12 Nov 14 23:24 test</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">-rw-r--r-- 1 root root   254 Nov 14 23:24 t.txt</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">远程服务器：（192.168.1.107）</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">[root@F-app-02 dba_tool]# ll /root/dba_tool/<a href="http://edu.iwetek.com/" rel="nofollow">南京嵌入式培训</a></span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">total 60</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">-rw-r--r-- 1 root root    12 Nov 14 22:24 test</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px">-rw-r--r-- 1 root root   254 Nov 14 22:47 t.txt</span></p> 
      <p style="margin-top:0px; margin-bottom:0px"><span style="font-size:12px"> </span></p> 
     </div> </td></tr></tbody></table> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e85235e9400e21b3e6c2e908c90697fd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ETL三大主流工具</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8b9c685c6bad43ef1d5f7d2407452c9a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何计算网络带宽需求?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>