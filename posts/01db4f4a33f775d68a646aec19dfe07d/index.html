<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>设备树基础语法与实例分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="设备树基础语法与实例分析" />
<meta property="og:description" content="文章目录 DTS和DTSIDTBdtc一、语法篇reg 属性reg 限制（注意是子节点）model 属性status 属性compatible 属性aliases 节点chosen 节点device_type 属性自定义属性 二、实例分析篇中断瑞芯微恩智浦三星其他写法总结： 实战：描述中断资源时钟CPUGPIO实战：用设备树点亮LED灯pinctrlpinctrl 客户端pinctrl 服务端 总结 三、使用篇设备树下的 device 和 driver 匹配查找节点有关的 OF 函数查找父/子节点的 OF 函数提取属性值的 OF 函数其他常用的 OF 函数获取中断号的 OF 函数获取 GPIO 的 OF 函数 四、附加篇ranges 属性 DTS和DTSI .dts文件是一种ASCII文本对Device Tree的描述，放置在内核的/arch/arm/boot/dts目录。一般而言，一个.dts文件对应一个ARM的machine。
.dtsi文件作用：由于一个SOC可能有多个不同的电路板，而每个电路板拥有一个 .dts。这些dts势必会存在许多共同部分，为了减少代码的冗余，设备树将这些共同部分提炼保存在.dtsi文件中，供不同的dts共同使用。.dtsi的使用方法，类似于C语言的头文件，在dts文件中需要进行include *.dtsi文件。当然，dtsi本身也支持include 另一个dtsi文件。
DTB DTC编译*.dts生成的二进制文件(.dtb)，bootloader在引导内核时，会预先读取.dtb到内存，进而由内核解析。
目录：
Linux/kernel/arch/arm/boot/dts
Linux/kernel/arch/arm64/boot/dts
dtc （编译内核源码时会编译出该工具，看 .config 中 CONFIG_DTC 选项是否编进内核，或者在 linux/kernel/scripts/dtc/ 中有源码，看 linux/kernel/scripts/ 目录下的makefile 会有：
subdir -S(CONFIG_DTC）&#43;= dtc 编译设备树：
dtc -I dts -O dtb -o xxx." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/01db4f4a33f775d68a646aec19dfe07d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-13T14:33:38+08:00" />
<meta property="article:modified_time" content="2023-08-13T14:33:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">设备树基础语法与实例分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#DTSDTSI_5" rel="nofollow">DTS和DTSI</a></li><li><a href="#DTB_9" rel="nofollow">DTB</a></li><li><a href="#dtc_15" rel="nofollow">dtc</a></li><li><a href="#_32" rel="nofollow">一、语法篇</a></li><li><ul><li><a href="#reg__55" rel="nofollow">reg 属性</a></li><li><a href="#reg__71" rel="nofollow">reg 限制（注意是子节点）</a></li><li><a href="#model__104" rel="nofollow">model 属性</a></li><li><a href="#status__107" rel="nofollow">status 属性</a></li><li><a href="#compatible__113" rel="nofollow">compatible 属性</a></li><li><a href="#aliases__118" rel="nofollow">aliases 节点</a></li><li><a href="#chosen__178" rel="nofollow">chosen 节点</a></li><li><a href="#device_type__199" rel="nofollow">device_type 属性</a></li><li><a href="#_209" rel="nofollow">自定义属性</a></li></ul> 
  </li><li><a href="#_217" rel="nofollow">二、实例分析篇</a></li><li><ul><li><a href="#_218" rel="nofollow">中断</a></li><li><ul><li><a href="#_229" rel="nofollow">瑞芯微</a></li><li><a href="#_259" rel="nofollow">恩智浦</a></li><li><a href="#_284" rel="nofollow">三星</a></li><li><a href="#_313" rel="nofollow">其他写法</a></li><li><a href="#_329" rel="nofollow">总结：</a></li></ul> 
   </li><li><a href="#_337" rel="nofollow">实战：描述中断资源</a></li><li><a href="#_368" rel="nofollow">时钟</a></li><li><a href="#CPU_397" rel="nofollow">CPU</a></li><li><a href="#GPIO_414" rel="nofollow">GPIO</a></li><li><a href="#LED_443" rel="nofollow">实战：用设备树点亮LED灯</a></li><li><a href="#pinctrl_533" rel="nofollow">pinctrl</a></li><li><ul><li><a href="#pinctrl__540" rel="nofollow">pinctrl 客户端</a></li><li><a href="#pinctrl__552" rel="nofollow">pinctrl 服务端</a></li></ul> 
   </li><li><a href="#_569" rel="nofollow">总结</a></li></ul> 
  </li><li><a href="#_573" rel="nofollow">三、使用篇</a></li><li><ul><li><a href="#_device__driver__655" rel="nofollow">设备树下的 device 和 driver 匹配</a></li><li><a href="#_OF__708" rel="nofollow">查找节点有关的 OF 函数</a></li><li><a href="#_OF__742" rel="nofollow">查找父/子节点的 OF 函数</a></li><li><a href="#_OF__754" rel="nofollow">提取属性值的 OF 函数</a></li><li><a href="#_OF__826" rel="nofollow">其他常用的 OF 函数</a></li><li><a href="#_OF__911" rel="nofollow">获取中断号的 OF 函数</a></li><li><a href="#_GPIO__OF__975" rel="nofollow">获取 GPIO 的 OF 函数</a></li></ul> 
  </li><li><a href="#_988" rel="nofollow">四、附加篇</a></li><li><ul><li><a href="#ranges__989" rel="nofollow">ranges 属性</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="DTSDTSI_5"></a>DTS和DTSI</h2> 
<p><em>.dts文件是一种ASCII文本对Device Tree的描述，放置在内核的/arch/arm/boot/dts目录。一般而言，一个</em>.dts文件对应一个ARM的machine。<br> <em>.dtsi文件作用：由于一个SOC可能有多个不同的电路板，而每个电路板拥有一个 <em>.dts。这些dts势必会存在许多共同部分，为了减少代码的冗余，设备树将这些共同部分提炼保存在</em>.dtsi文件中，供不同的dts共同使用。</em>.dtsi的使用方法，类似于C语言的头文件，在dts文件中需要进行include *.dtsi文件。当然，dtsi本身也支持include 另一个dtsi文件。</p> 
<h2><a id="DTB_9"></a>DTB</h2> 
<p>DTC编译*.dts生成的二进制文件(<em>.dtb)，bootloader在引导内核时，会预先读取</em>.dtb到内存，进而由内核解析。<br> 目录：<br> Linux/kernel/arch/arm/boot/dts<br> Linux/kernel/arch/arm64/boot/dts</p> 
<h2><a id="dtc_15"></a>dtc</h2> 
<p>（编译内核源码时会编译出该工具，看 .config 中 CONFIG_DTC 选项是否编进内核，或者在 linux/kernel/scripts/dtc/ 中有源码，看 linux/kernel/scripts/ 目录下的makefile 会有：</p> 
<pre><code class="prism language-powershell">subdir <span class="token operator">-</span>S<span class="token punctuation">(</span>CONFIG_DTC）<span class="token operator">+=</span> dtc
</code></pre> 
<p>编译设备树：</p> 
<pre><code class="prism language-powershell">dtc <span class="token operator">-</span>I dts <span class="token operator">-</span>O dtb <span class="token operator">-</span>o xxx<span class="token punctuation">.</span>dtb xxx<span class="token punctuation">.</span>dts
</code></pre> 
<p>反编译设备树：</p> 
<pre><code class="prism language-powershell">dtc <span class="token operator">-</span>I dtb <span class="token operator">-</span>O dts <span class="token operator">-</span>o xxx<span class="token punctuation">.</span>dts xxx<span class="token punctuation">.</span>dtb
</code></pre> 
<p>使用命令：make dtbs<br> 可以一次性编译 Linux/kernel/arch/arm/boot/dts/ 目录下的选中的SOC的所有dtc，但是很多并非我们需要的。<br> 在VS代码编辑器中可以安装 DeviceTree 插件。</p> 
<h2><a id="_32"></a>一、语法篇</h2> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>    #版本号，必须写，否则编译报错
<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>           #根节点，一个设备树文件仅有一个
    <span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token operator">:</span>node<span class="token operator">-</span>name<span class="token punctuation">[</span>@uint<span class="token operator">-</span>address<span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>    <span class="token comment">/* label：标签，用于引用节点；node-name:节点名；uint-address：设备地址，没实际意义 */</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">[</span>child nodes<span class="token punctuation">]</span>            <span class="token comment">/* 子节点，格式和节点一样 */</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">/* 同级的结点名不能相同 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>案例 1：</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    uart<span class="token operator">:</span> serial@<span class="token number">02288000</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* uart 是节点的标签/别名， serial@02288000 是结点名称 */</span>
</code></pre> 
<h3><a id="reg__55"></a>reg 属性</h3> 
<p>描述地址信息，例如寄存器地址</p> 
<pre><code class="prism language-c"> reg <span class="token operator">=</span> <span class="token operator">&lt;</span>address1 length1 address2 length2 address3 length3 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span>
  <span class="token comment">/* address：寄存器地址，length：地址长度 */</span>
</code></pre> 
<p>案例2：</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    uart<span class="token operator">:</span> serial@<span class="token number">02288000</span><span class="token punctuation">{<!-- --></span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x2200000</span> <span class="token number">0x4000</span>
               <span class="token number">0x3300000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="reg__71"></a>reg 限制（注意是子节点）</h3> 
<p>#address-cell /* 限制 子 节点中的地址数 <em>/<br> #size-cell /</em> 限制 子 节点中的长度数 */<br> 案例3：</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    node_1<span class="token operator">:</span> node1@<span class="token number">02288000</span><span class="token punctuation">{<!-- --></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span></span></span>
        serial_1<span class="token punctuation">{<!-- --></span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* 显然这个 0 对应的是地址，因为size-cell为0，代表没有长度信息 */</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    node_2<span class="token operator">:</span> node2@<span class="token number">02299000</span><span class="token punctuation">{<!-- --></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span>
        serial_1<span class="token punctuation">{<!-- --></span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x2200000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* 一个地址，一个长度 */</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    node_3<span class="token operator">:</span> node3@<span class="token number">02200000</span><span class="token punctuation">{<!-- --></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span></span></span>
        serial_1<span class="token punctuation">{<!-- --></span>
            reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x00</span> <span class="token number">0x01</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* 两个地址 */</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>包含自写的设备树文件时，多个根节点会被合成一个；如果自写的设备树把 #address-cell 和 #size-cell 放在根节点的下一级，将会在合并后限制根节点的所有子节点。<br> 解决这个问题需要在自己的设备树中添加一个无关节点，再把自己写的节点作为无关节点的子节点添加。</p> 
<h3><a id="model__104"></a>model 属性</h3> 
<p>字符串，可以描述设备的名字或用途</p> 
<h3><a id="status__107"></a>status 属性</h3> 
<pre><code class="prism language-c">status <span class="token operator">=</span> <span class="token string">"okay"</span>       <span class="token comment">/* 有的厂商的设备树是 ok ，表示设备可用 */</span>
status <span class="token operator">=</span> <span class="token string">"disable"</span>    <span class="token comment">/* 不可用 */</span>
</code></pre> 
<h3><a id="compatible__113"></a>compatible 属性</h3> 
<p>用来替换 driver device 分离后的 device 部分，用来与驱动匹配，匹配成功后执行驱动中的 probe 函数</p> 
<pre><code class="prism language-c">compatible <span class="token operator">=</span> <span class="token string">"driver1"</span><span class="token punctuation">,</span> <span class="token string">"driver2"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>    <span class="token comment">/* 没有找到第一个驱动就继续找下一个... */</span>
</code></pre> 
<h3><a id="aliases__118"></a>aliases 节点</h3> 
<p>定义别名，方便引用节点。<br> 案例4：</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span>
    
    aliases<span class="token punctuation">{<!-- --></span>
        led_1 <span class="token operator">=</span> <span class="token operator">&amp;</span>led<span class="token punctuation">;</span>    <span class="token comment">/* 之后使用 led_1 相当于 gpio@20202010 */</span>
    <span class="token punctuation">}</span>
    
    led<span class="token operator">:</span> gpio@<span class="token number">20202010</span><span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"led"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">20202010</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>编译成 dtb 文件，再反编译回 dts 文件，可以看到：</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span>
    
    aliases<span class="token punctuation">{<!-- --></span>
        led_1 <span class="token operator">=</span> <span class="token string">"/gpio@20202010"</span>
    <span class="token punctuation">}</span>
    
    gpio@<span class="token number">20202010</span><span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"led"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">20202010</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>案例5：</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span>
    
    aliases<span class="token punctuation">{<!-- --></span>
        led_1 <span class="token operator">=</span> <span class="token string">"/gpio@20202010"</span>
    <span class="token punctuation">}</span>
    
    gpio@<span class="token number">20202010</span><span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"led"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">20202010</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>针对没有标签的节点，aliases 里面也可以直接赋予路径，效果和案例4相同。</p> 
<h3><a id="chosen__178"></a>chosen 节点</h3> 
<p>uboot 将该节点的参数传递给内核，重点是 bootargs 参数。<br> chosen 节点必须是根节点的子节点。<br> 案例6：</p> 
<pre><code class="prism language-c">chosen<span class="token punctuation">{<!-- --></span>
    bootargs <span class="token operator">=</span> <span class="token string">"root=/dev/nfs rw nfsroot=192.168.1.1 console=ttyS0,115200"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>chosen调用流程：</p> 
<pre><code class="prism language-c">bootz命令
    <span class="token function">do_bootz</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">do_bootm_states</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">boot_selected_os</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">boot_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token function">boot_prep_linux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//启动Linux之前做一些其他处理，例如在在 bootargs 子节点存放 bootargs 环境变量</span>
                        <span class="token function">image_setup_linux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token function">image_setup_libfdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token function">fdt_chosen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//最终用该函数在 chosen 节点中添加 bootargs 属性</span>
</code></pre> 
<h3><a id="device_type__199"></a>device_type 属性</h3> 
<p>属性值是字符串，只用于 cpu、memory 节点进行描述。<br> 案例7：</p> 
<pre><code class="prism language-c">cpu1<span class="token operator">:</span> cpu@<span class="token number">1</span><span class="token punctuation">{<!-- --></span>
    device_type <span class="token operator">=</span> <span class="token string">"cpu"</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_209"></a>自定义属性</h3> 
<p>案例8：</p> 
<pre><code class="prism language-c"><span class="token comment">/* 自定义一个管脚标号的属性 pinnum */</span>
pinnum <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre> 
<p>驱动可以拿到设备树中的任意节点的任意数据，至于有没有用，用来做什么，都是驱动开发的事情了，所以开放自定义属性合理。</p> 
<h2><a id="_217"></a>二、实例分析篇</h2> 
<h3><a id="_218"></a>中断</h3> 
<p>三个处理对同一款SPI屏幕芯片的中断描述<br> 中断类型的宏定义在：include\dt-bindings\interrupt-controller/irq.h</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_NONE</span>			<span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_EDGE_RISING</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_EDGE_FALLING</span>	<span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_EDGE_BOTH</span>		<span class="token expression"><span class="token punctuation">(</span>IRQ_TYPE_EDGE_FALLING <span class="token operator">|</span> IRQ_TYPE_EDGE_RISING<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_LEVEL_HIGH</span>		<span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_TYPE_LEVEL_LOW</span>		<span class="token expression"><span class="token number">8</span></span></span>
</code></pre> 
<h4><a id="_229"></a>瑞芯微</h4> 
<pre><code class="prism language-c"><span class="token comment">/* 原厂中断节点 */</span>
gpio0<span class="token operator">:</span> gpio@fdd60000<span class="token punctuation">{<!-- --></span>
    compatible <span class="token operator">=</span> <span class="token string">"rockchip, gpio-bank"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xfdd60000</span> <span class="token number">0x0</span> <span class="token number">0x100</span><span class="token operator">&gt;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">33</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* spi中断 33号中断线 高电平出发
    clocks = &lt;&amp;pmucru PCLK_GPIO0&gt;, &lt;&amp;pmucru DBCLK_GPIO0&gt;;
    
    gpio-controller;                                  /* 表示该节点是 gpio 控制器 */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    gpio<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl <span class="token number">0</span> <span class="token number">0</span> <span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>                             <span class="token comment">/* 表示该节点是 中断 控制器 */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 开发者修改的中断节点 */</span>
rt5x06<span class="token operator">:</span> ft5x06@<span class="token number">38</span><span class="token punctuation">{<!-- --></span>
    status <span class="token operator">=</span> <span class="token string">"disable"</span><span class="token punctuation">;</span>
    compatible <span class="token operator">=</span> <span class="token string">"edt, edt-ft5x06"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x38</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touch<span class="token operator">-</span>gpio <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB5 IRQ_TYPE_EDGE_RISING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0<span class="token operator">&gt;</span><span class="token punctuation">;</span>                        <span class="token comment">/* 引用了 gpio0 节点 */</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>RK_PB5 IRQ_TYPE_LEVEL_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>           <span class="token comment">/* 受 interrupt-cell 限制，只能有两个属性 */</span>
    reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio RK_PB6 GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touchscreen<span class="token operator">-</span>size<span class="token operator">-</span>x <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">800</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touchscreen<span class="token operator">-</span>size<span class="token operator">-</span>y <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1200</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    touch_type <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_259"></a>恩智浦</h4> 
<pre><code class="prism language-c"><span class="token comment">/* 原厂中断节点 */</span>
gpio1<span class="token operator">:</span> gpio@<span class="token number">0209</span>c000<span class="token punctuation">{<!-- --></span>
    compatible <span class="token operator">=</span> <span class="token string">"fsl, imx6ul-gpio"</span><span class="token punctuation">,</span> <span class="token string">"fsl, imx35-gpio"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0209c000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">66</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">67</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span>；
    gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>                                  <span class="token comment">/* 表示该节点是 gpio 控制器 */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>                             <span class="token comment">/* 表示该节点是 中断 控制器 */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cell <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* 开发者修改的中断节点 */</span>
edt<span class="token operator">-</span>ft5x06@<span class="token number">38</span><span class="token punctuation">{<!-- --></span>
    compatible <span class="token operator">=</span> <span class="token string">"edt, edt-ft5306"</span><span class="token punctuation">,</span> <span class="token string">"edt, edt-ft5x06"</span><span class="token punctuation">,</span> <span class="token string">"edt, edt-ft5406"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ts_int_pin <span class="token operator">&amp;</span>ts_reset_pin<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x38</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1<span class="token operator">&gt;</span><span class="token punctuation">;</span>                        <span class="token comment">/* 引用了 gpio1 节点 */</span>
    interrups <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">9</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>                                  <span class="token comment">/* 发现这个和RK的不同，RK的interrupts 的属性是中断号 + 触发方式宏定义，这里的触发方式是数字，其实两者是一样的 */</span>
    reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio5 <span class="token number">9</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    irq<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio5 <span class="token number">9</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> <span class="token string">"disable"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_284"></a>三星</h4> 
<pre><code class="prism language-c"><span class="token comment">/* 原厂的中断节点 */</span>
gpio_c<span class="token operator">:</span> gpioc<span class="token punctuation">{<!-- --></span>
    gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* 开发者修改的中断节点 */</span>
ft5x06<span class="token operator">:</span> ft5x06@<span class="token number">38</span><span class="token punctuation">{<!-- --></span>
    compatible <span class="token operator">=</span> <span class="token string">"edt, edt-ft5x06"</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x38</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>RGB_XXXXXXX<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>RGB_XXXXXX<span class="token punctuation">)</span>    </span><span class="token comment">/* 类似C语言的预编译选项 */</span></span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>tsxx_irq<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio_c<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">26</span> IRQ_TYPE_EDGE_FALLING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>RGB_XXXXXXX<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>RGB_XXXXXX<span class="token punctuation">)</span>    </span><span class="token comment">/* 在两个条件中根据宏参数选择一个编译 */</span></span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gtxx_irq<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio_b<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">26</span> IRQ_TYPE_EDGE_FALLING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio_e <span class="token number">30</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>可以看到不同厂商的宏定义是自由编写的，我们需要记住的不是宏定义，而是宏定义代表的意义。<br> 开发者添加自己的设备，就是引用厂商的节点，在厂商的基础上加上自己的修改。</p> 
<h4><a id="_313"></a>其他写法</h4> 
<pre><code class="prism language-c">gic1<span class="token operator">:</span> interrupt<span class="token operator">-</span>controller@<span class="token number">20220101</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
gic2<span class="token operator">:</span> interrupt<span class="token operator">-</span>controller@<span class="token number">20220102</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gic1<span class="token operator">&gt;</span>        <span class="token comment">/* 中断控制器引用了中断控制器，表示的是中断控制器的级联 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
interrupt@<span class="token number">38</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    interrupt<span class="token operator">-</span>extended <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gic1 <span class="token number">9</span> <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gic2 <span class="token number">10</span> <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* interrupt-extended 可以定义多组中断 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_329"></a>总结：</h4> 
<ul><li>中断控制器中，必须有一个属性 #interrupt-cells 表示其他节点使用这个中断控制器需要几个 cell 来表示使用哪一个中断。</li><li>中断控制器中，必须有一个属性 interrupt-controller 表示它是中断控制器。</li><li>在设备树中使用中断，需要使用属性 interrupt-parent = &lt;&amp;中断控制器&gt; 表示中断信号链接的是哪个中断控制器。</li><li>声明引用的中断控制器后，需要用 interrupts 声明中断引脚和触发方式，至于 interrupts 中有几个 cell ，需要按照 interrupt-parent 的要求。</li></ul> 
<p>还有很多没见过的属性，保持疑问，接着理解。</p> 
<h3><a id="_337"></a>实战：描述中断资源</h3> 
<p>将驱动中的描述device资源部分转换为设备树描述：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> my_device_resources<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>start  <span class="token operator">=</span> <span class="token number">0xFDD60000</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>end    <span class="token operator">=</span> <span class="token number">0XFDD60004</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>flags  <span class="token operator">=</span> IORESOURCE_MEM<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>start  <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>end    <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>flags  <span class="token operator">=</span> IORESOURCE_IRQ<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/c4/pdamnEql_o.png" alt="在这里插入图片描述"><br> 中断管脚为 TP_INT_L_GPIO0_B5，GPIO控制器是 0（GPIO0）</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    ft5x06@<span class="token number">38</span><span class="token punctuation">{<!-- --></span>    <span class="token comment">/* 为了直观，直接写芯片名和设备地址即可 */</span>
        compatible <span class="token operator">=</span> <span class="token string">"edt, edt-ft5206"</span><span class="token punctuation">;</span> <span class="token comment">/* 驱动源码中的匹配表中compatible 成员的字符串，需要driver名和device名一样才能匹配到该设备 */</span>
        interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0<span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* 看内核源码中 SOC 的 dtsi 文件中的gpio0中断控制器是否名为 gpio0 */</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">13</span> <span class="token operator">&gt;</span>              <span class="token comment">/* 管脚对应的名称，对应关系可以在内核中的 dt-bindings/pinctrl/主板名.h 中找到；RK 中的宏定义：#define RK_PB5 13，不用13用PB5也可以，使用宏定义需要把 主板名.h 包含一下*/</span>
                                        <span class="token comment">/* 再打开 dt-bindings/pinctrl/irq.h 可以看到各种触发方式的宏定义 */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_368"></a>时钟</h3> 
<p>驱动解析设备树中时钟的信息，从而完成时钟的初始化和使用。<br> 设备树中，时钟为 消费者 和 生产者。<br> #clock-cells 代表时钟的路数，为 0 时，代表有一路时钟输出；为 1 时，代表有多路时钟输出。</p> 
<pre><code class="prism language-c"><span class="token comment">/* 消费者属性 */</span>
osc24m<span class="token operator">:</span> osc24m<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">24000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* 时钟的大小，这里频率为 24M */</span>
    clock<span class="token operator">-</span>output<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"osc24m"</span><span class="token punctuation">;</span>   <span class="token comment">/* 定义输出时钟名 */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

clock<span class="token operator">:</span> clock<span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>              </span><span class="token comment">/* 为 1 时有多路时钟输出 */</span></span>
    clock<span class="token operator">-</span>output<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"clock1"</span><span class="token punctuation">,</span> <span class="token string">"clock2"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 生产者属性 */</span>
cru<span class="token operator">:</span> clock<span class="token operator">-</span>controller@fdd20000<span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>            </span><span class="token comment">/* 声明了输出多路时钟信号 */</span></span>
    <span class="token comment">/* assigned-clocks 和 assigned-clock-rates 一般成对使用，当输出多路时钟时，为每路时钟编号 */</span>
    assigned<span class="token operator">-</span>clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pmucru CLK_RTC_32K<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>cru ACLK_RKVDEC_PRE<span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* 使用 pmucru 模块输出 CLK_RTC_32K 时钟信号；使用 cru 模块输出 ACLK_RKVDEC_PRE 时钟信号
    assigned-clock-rates = &lt;32768&gt;, &lt;300000000&gt;;                        /* 声明前面两路时钟的输出频率 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>clock-indices 属性指定索引号（index），如果不提供这个属性，那么 clock-output-names 和 index 的对应关系就是 0，1，2…如果这个关系不是线性的，可以通过 clock-indices定义映射。<br> <img src="https://images2.imgbox.com/45/74/bUktA2Q4_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="CPU_397"></a>CPU</h3> 
<p><strong>cpus 节点</strong><br> cpus 节点为物理 cpu 的布局。<br> <strong>cpu-map 节点</strong><br> 单核处理器不需要cpu-map节点，cpu-map 用于描述大小核架构的处理器中，其父节点必须为 cpus 节点，子节点必须是一个或多个 cluster 和 socket 节点。<br> <strong>socket 节点</strong><br> socket 节点描述的是板卡上的 CPU 插槽。主板有几个插槽就有几个socket节点。其子节点必须为一个或多个 cluster 节点。当有多个CPU插槽时，socket节点的命名方式必须是 socketN（N = 0,1,2…）。<br> <strong>cluster 节点</strong><br> cluster 节点描述的是 CPU 集群。RK3399 的 CPU 架构为双核 A73 + 四核 A53，其中四核 A53 和 双核 A73 各表示一个集群。集群命名必须为 clusterN（N = 0,1,2…）。<br> <strong>core 节点</strong><br> core 节点用来描述 CPU，如果是单核CPU，则 core 节点就是cpus节点中的子节点。命名格式为 coreN（N = 0,1,2…）。<br> <strong>thread 节点</strong><br> 该节点必须是 core 的子节点，用来描述处理器的线程。命名格式为 threadN（N = 0,1,2…）。</p> 
<p>实例：RK3399 的设备树，由于它是大小核架构的 CPU，所以可以用 cpu-map 节点，两个集群代表两个CPU，每个CPU又有多个核。<br> <img src="https://images2.imgbox.com/2f/8f/A9mjoR91_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="GPIO_414"></a>GPIO</h3> 
<ul><li>GPIO控制器中，必须有一个属性 #gpio-cells，表示其他节点使用这个GPIO控制器需要几个cell来描述。</li><li>GPIO控制器中，必须有一个属性 gpio-controller 声明。</li><li>使用GPIO需要用属性 data-gpios=&lt;&amp;gpio控制器标签 gpio引脚标号 高低电平&gt;<br> 设置gpio属性，该属性也可为自定义属性。<br> 案例：</li></ul> 
<pre><code class="prism language-c">gpio1<span class="token operator">:</span> gpio1<span class="token punctuation">{<!-- --></span>
    gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    </span><span class="token comment">/* 需要两个属性来描述 gpio，两个属性是：gpio引脚标号  高低电平 */</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

data<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 <span class="token number">12</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio <span class="token number">15</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>ngpios</strong><br> 表示当前 GPIO 控制器下有多少个 pin 脚<br> <strong>gpio-reserved-ranges</strong><br> 用于指定保留的 pin 脚，例如 gpio-reserved-ranges &lt;2 3&gt; 表示当前 GPIO 控制器的 2,3,4 pin 脚为预留 pin，即第一个参数为起始 pin，第二个参数为 pin 脚数量。<br> <strong>gpio-line-names</strong><br> 用于给 GPIO 控制器的 pin 脚命名，控制器有多少 pin，就有多少个名字，名字用逗号隔开。<br> <img src="https://images2.imgbox.com/0d/c7/7saYIrjE_o.png" alt="在这里插入图片描述"><br> <strong>gpio-ranges</strong></p> 
<pre><code class="prism language-c">gpio<span class="token operator">-</span>ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>foo <span class="token number">0</span> <span class="token number">128</span> <span class="token number">12</span><span class="token operator">&gt;</span>；
解析：将当前GPIO控制器中的<span class="token number">0</span>号<span class="token operator">~</span><span class="token number">11</span>号管脚对应到 foo GPIO控制器中的<span class="token number">128</span>号<span class="token operator">~</span><span class="token number">139</span>号管脚，<span class="token number">12</span> 表示的是管脚数量
</code></pre> 
<p>gpio-ranges通常和pinctrl使用，GPIO系统中有引脚号，Pinctrl子系统中也有自己的引脚号，2个号码要建立映射关系，当gpio和管脚编号不对应时就要用 gpio-ranges对应起来；</p> 
<h3><a id="LED_443"></a>实战：用设备树点亮LED灯</h3> 
<p><img src="https://images2.imgbox.com/70/f1/pXxEXHQd_o.png" alt="在这里插入图片描述"><br> 根据电路图，确定几个信息：管脚输出低电平点亮，控制器是GPIO0，编号是PB7<br> 这里用的 rk3568 的开发板做实验，瑞芯微的管教定义可以通过瑞芯微的内核文件：kernel/include/dt-bindings/pinctrl/rockchip.h 查看：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PA0</span>		<span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PA1</span>		<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PA2</span>		<span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PA3</span>		<span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PA4</span>		<span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PA5</span>		<span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PA6</span>		<span class="token expression"><span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PA7</span>		<span class="token expression"><span class="token number">7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PB0</span>		<span class="token expression"><span class="token number">8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PB1</span>		<span class="token expression"><span class="token number">9</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PB2</span>		<span class="token expression"><span class="token number">10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PB3</span>		<span class="token expression"><span class="token number">11</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PB4</span>		<span class="token expression"><span class="token number">12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PB5</span>		<span class="token expression"><span class="token number">13</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PB6</span>		<span class="token expression"><span class="token number">14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PB7</span>		<span class="token expression"><span class="token number">15</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PC0</span>		<span class="token expression"><span class="token number">16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PC1</span>		<span class="token expression"><span class="token number">17</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PC2</span>		<span class="token expression"><span class="token number">18</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PC3</span>		<span class="token expression"><span class="token number">19</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PC4</span>		<span class="token expression"><span class="token number">20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PC5</span>		<span class="token expression"><span class="token number">21</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PC6</span>		<span class="token expression"><span class="token number">22</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PC7</span>		<span class="token expression"><span class="token number">23</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PD0</span>		<span class="token expression"><span class="token number">24</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PD1</span>		<span class="token expression"><span class="token number">25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PD2</span>		<span class="token expression"><span class="token number">26</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PD3</span>		<span class="token expression"><span class="token number">27</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PD4</span>		<span class="token expression"><span class="token number">28</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PD5</span>		<span class="token expression"><span class="token number">29</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PD6</span>		<span class="token expression"><span class="token number">30</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_PD7</span>		<span class="token expression"><span class="token number">31</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_GPIO</span>	<span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_0</span>		<span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_1</span>		<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_2</span>		<span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_3</span>		<span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_4</span>		<span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_5</span>		<span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_6</span>		<span class="token expression"><span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_7</span>		<span class="token expression"><span class="token number">7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_8</span>		<span class="token expression"><span class="token number">8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_9</span>		<span class="token expression"><span class="token number">9</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_10</span>		<span class="token expression"><span class="token number">10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_11</span>		<span class="token expression"><span class="token number">11</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_12</span>		<span class="token expression"><span class="token number">12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_13</span>		<span class="token expression"><span class="token number">13</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_14</span>		<span class="token expression"><span class="token number">14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RK_FUNC_15</span>		<span class="token expression"><span class="token number">15</span></span></span>
</code></pre> 
<p>gpio简单属性设置可以在 kernel/include/dt-bindings/pinctrl/rockchip.h 中查看：</p> 
<pre><code class="prism language-c"><span class="token comment">/* Bit 0 express polarity */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_ACTIVE_HIGH</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_ACTIVE_LOW</span> <span class="token expression"><span class="token number">1</span></span></span>

<span class="token comment">/* Bit 1 express single-endedness */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PUSH_PULL</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_SINGLE_ENDED</span> <span class="token expression"><span class="token number">2</span></span></span>

<span class="token comment">/* Bit 2 express Open drain or open source */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_LINE_OPEN_SOURCE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_LINE_OPEN_DRAIN</span> <span class="token expression"><span class="token number">4</span></span></span>

<span class="token comment">/*
 * Open Drain/Collector is the combination of single-ended open drain interface.
 * Open Source/Emitter is the combination of single-ended open source interface.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_OPEN_DRAIN</span> <span class="token expression"><span class="token punctuation">(</span>GPIO_SINGLE_ENDED <span class="token operator">|</span> GPIO_LINE_OPEN_DRAIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_OPEN_SOURCE</span> <span class="token expression"><span class="token punctuation">(</span>GPIO_SINGLE_ENDED <span class="token operator">|</span> GPIO_LINE_OPEN_SOURCE<span class="token punctuation">)</span></span></span>

<span class="token comment">/* Bit 3 express GPIO suspend/resume and reset persistence */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PERSISTENT</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_TRANSITORY</span> <span class="token expression"><span class="token number">8</span></span></span>
</code></pre> 
<p>设备树编写：</p> 
<pre><code class="prism language-c">led<span class="token operator">:</span> led@<span class="token number">1</span><span class="token punctuation">{<!-- --></span>
    compatible <span class="token operator">=</span> <span class="token string">"led"</span><span class="token punctuation">;</span>    <span class="token comment">/* 驱动名，这里只是点亮，不需要驱动也没事，一样可以输出低电平 */</span>
    data<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 RK_PB7 <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* 引用了gpio0 控制器，需要按照 gpio0 控制器的规则编写 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="pinctrl_533"></a>pinctrl</h3> 
<p>目的是为了统一各个芯片原厂的 pin 管理，所以 pinctrl 子系统的驱动由芯片原厂 BSP 工程师编写（包括设备树）。<br> pinctrl 子系统用来管理 GPIO 引脚，它主要完成了：</p> 
<ul><li>引脚枚举与命名</li><li>引脚复用</li><li>引脚配置</li></ul> 
<h4><a id="pinctrl__540"></a>pinctrl 客户端</h4> 
<p>客户端语法是固定的，所有平台都是相同的，主要包括两个属性：pinctrl-names 和 pinctrl-x（x 为数字 0,1,2…）<br> pinctrl-name 属性表示设备的状态，<br> pinctrl-x 表示第 x 个状态对应的引脚配置。</p> 
<pre><code class="prism language-c">pinctrl<span class="token operator">-</span>name<span class="token operator">=</span><span class="token string">"default"</span><span class="token punctuation">;</span>        <span class="token comment">/* 这里只有一个状态，default 为第0个状态 */</span>
pinctrl<span class="token operator">-</span><span class="token number">0</span><span class="token operator">=</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_hog_1<span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* 表示第0个状态default对应的引脚在 pinctrl_hog_1 节点上配置 */</span>

pinctrl<span class="token operator">-</span>name<span class="token operator">=</span><span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"wake up"</span><span class="token punctuation">;</span>    <span class="token comment">/* default 为第0个状态, wake up 为第1个状态 */</span>
pinctrl<span class="token operator">-</span><span class="token number">0</span><span class="token operator">=</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_hog_1<span class="token operator">&gt;</span><span class="token punctuation">;</span>           <span class="token comment">/* 状态0 对应的引脚配置在 pinctrl_hog_1 节点 */</span>
pinctrl<span class="token operator">-</span><span class="token number">1</span><span class="token operator">=</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_hog_2<span class="token operator">&gt;</span><span class="token punctuation">;</span>           <span class="token comment">/* 状态1 对应的引脚配置在 pinctrl_hog_2 节点 */</span>
</code></pre> 
<h4><a id="pinctrl__552"></a>pinctrl 服务端</h4> 
<p>pinctrl 服务端在不同平台有不同的语法。<br> <strong>瑞星微平台</strong><br> 这里拿 RK3568 举例：<br> 在 pinctrl 节点内存在一个 pwm0子节点，pwm0 的 pwm0m0-pins 子节点对应 pinctrl 客户端的 pinctrl-x，rockchip,pins 是瑞星微 pinctrl pin 属性。<br> <img src="https://images2.imgbox.com/6e/ee/UQP8pxW8_o.png" alt="在这里插入图片描述"><br> 瑞星微 rockchip,pins 属性的第一个参数表示 GPIO组，第二个参数表示 pin 脚在该 GPIO 组的编号，第三个参数为引脚复用功能，第四个参数是 GPIO 驱动强度。<br> 前两个参数之前的笔记已经见过很多次，但复用功能是第一次遇到，该参数值需要查数据手册或用户手册，比如上面的 &lt;0 RK_PB7 1 &amp;pcfg_pull_none&gt; 中，复用功能为 1，通过查阅芯片 datasheet，可以知晓复用功能 1 对应的是 PWM_M0 功能。第四个参数暂时不去研究（基本都是填这个）。<br> <img src="https://images2.imgbox.com/f1/f5/i7DPKBAe_o.png" alt="在这里插入图片描述"><br> 上面提到不同平台 pin 属性的语法不同，我们可以查看内核 bindings 文档 （kernel/Documentation/devicetree/bindings/pinctrl）来了解设备树的语法，比如瑞星微 pin 属性的介绍：<img src="https://images2.imgbox.com/ca/8c/TBdSK6Af_o.png" alt="在这里插入图片描述"><br> <strong>iMX 平台</strong><br> iMX 平台 pins 属性相对比较复杂，该属性有六个参数，分别是：mux_reg、conf_reg、input_reg、mux_mode、input_val 和 CONFIG。<br> 前五个参数是写在一起的（用 ‘_’ 连接，见下图），用来表示引脚复用功能，第六个参数用来设置引脚电气属性。<br> （前五个参数的对应关系我没搞明白，直接分析例子吧）<br> 案例1：<br> <img src="https://images2.imgbox.com/30/5a/8nHI16gv_o.png" alt="在这里插入图片描述"><br> MX6QDL_PAD_SD4_DAT0__SD4_DATA0 的作用是将引脚 “SD4_DAT0” 设置为 “SD4_DATA0” 复用功能。</p> 
<h3><a id="_569"></a>总结</h3> 
<p>开发一个新模块时，要学会到设备树源码中去寻找相关的例子，找不到的可以去设备树的 /Documentation/devicetree/bangings 文档中找资料。</p> 
<h2><a id="_573"></a>三、使用篇</h2> 
<p>Linux 内核在启动的时候会解析 DTB 文件，然后在/proc/device-tree 目录下生成相应的设备<br> 树节点文件：</p> 
<pre><code class="prism language-c"><span class="token function">start_kernel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">setup_arch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">unflatten_device_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">__unflatten_device_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">unflatten_dt_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//解析DTB各个节点</span>
</code></pre> 
<p>DTB文件格式主要分为四个部分：头部、内存预留块、结构块、字符串块；自由空间块不一定存在。<br> <img src="https://images2.imgbox.com/30/8b/LWP4wdsX_o.png" alt="在这里插入图片描述"><br> <strong>头部</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fdt_header</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">uint32_t</span> magic<span class="token punctuation">;</span>                <span class="token comment">// 该字段应该被设置成0xd00dfeed，字节序是大端字节序</span>
	<span class="token class-name">uint32_t</span> totalsize<span class="token punctuation">;</span>            <span class="token comment">// DTB文件的总大小</span>
	<span class="token class-name">uint32_t</span> off_dt_struct<span class="token punctuation">;</span>        <span class="token comment">// structure block相对于DTB文件头的偏移的字节数</span>
	<span class="token class-name">uint32_t</span> off_dt_strings<span class="token punctuation">;</span>       <span class="token comment">// strings block相对于DTB文件头的偏移的字节数</span>
	<span class="token class-name">uint32_t</span> off_mem_rsvmap<span class="token punctuation">;</span>       <span class="token comment">// memory reservation相对于DTB文件头的字节数</span>
	<span class="token class-name">uint32_t</span> version<span class="token punctuation">;</span>              <span class="token comment">// DTB的版本号</span>
	<span class="token class-name">uint32_t</span> last_comp_version<span class="token punctuation">;</span>    <span class="token comment">// DTB的上一个版本</span>
	<span class="token class-name">uint32_t</span> boot_cpuid_phys<span class="token punctuation">;</span>      <span class="token comment">// 保存系统CPU的ID号</span>
	<span class="token class-name">uint32_t</span> size_dt_strings<span class="token punctuation">;</span>      <span class="token comment">// strings block的大小</span>
	<span class="token class-name">uint32_t</span> size_dt_struct<span class="token punctuation">;</span>       <span class="token comment">// structure block的大小</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>Memory Reservation</strong><br> 指定的内存范围将会被保留，它不能被一般的内存分配函数使用，防止这块内存内的重要数据被内核破坏。memory reservation也可以用C语言的结构体表示，如下:</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fdt_reserve_entry</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint64_t</span> address<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>Structure Block</strong><br> structure block由五个标识包含设备树的一些数据，形成一个树形结构，五个标识分别如下<br> FDT_BEGIN_NODE (0x00000001) ：表示一个设备节点的开始。接下来跟着设备节点的名字，设备备节点名字如果有unit-address，需要加上去，节点名字最后以NULL结尾。如果结尾没有4字节对齐，需要填充0x00，保证4字节对齐。<br> FDT_END_NODE (0x00000002) ：表示一个设备节点的结束。它的后面不用跟数据，通常是跟下一个标识，除了FDT_DROP。<br> 示例：</p> 
<pre><code class="prism language-c"><span class="token comment">/* DTS代码片段 */</span>
cpus <span class="token punctuation">{<!-- --></span>
    cpu@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"mips,mips24KEc"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* DTB代码片段 */</span>
<span class="token number">000000</span>b0              <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">01</span>  <span class="token number">63</span> <span class="token number">70</span> <span class="token number">75</span> <span class="token number">73</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token operator">|</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cpus<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">|</span>
<span class="token number">000000</span>c0  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">01</span> <span class="token number">63</span> <span class="token number">70</span> <span class="token number">75</span> <span class="token number">40</span>  <span class="token number">30</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">03</span>  <span class="token operator">|</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cpu@<span class="token number">0.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">|</span>
<span class="token number">000000</span>d0  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">0f</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">1</span>b  <span class="token number">6</span>d <span class="token number">69</span> <span class="token number">70</span> <span class="token number">73</span> <span class="token number">2</span>c <span class="token number">6</span>d <span class="token number">69</span> <span class="token number">70</span>  <span class="token operator">|</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>mips<span class="token punctuation">,</span>mip<span class="token operator">|</span>
<span class="token number">000000e0</span>  <span class="token number">73</span> <span class="token number">32</span> <span class="token number">34</span> <span class="token number">4</span>b <span class="token number">45</span> <span class="token number">63</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">02</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">02</span>  <span class="token operator">|</span>s24KEc<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">|</span>
</code></pre> 
<p>从上面的代码可知，包含了两个device_node，分别是cpus和cpu@0，cpu@0是cpus的子节点，所以代码中有两个FDT_BEGIN_NODE (0x00000001)，和FDT_END_NODE (0x00000002)。FDT_BEGIN后跟着节点名称。从DTB的组织方式也可以看出structure block是以树状层次结构布局的。<br> FDT_DROP (0x00000003) ：表示一个属性的开始。后面需要跟一个属性名的长度和偏移量，再后面跟属性的值，属性的长度和偏移量可以用C语言结构体表示：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> len<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> nameoff<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>len表示此结构后跟的属性值的长度，NULL也包含在内，nameoff表示属性名在strings block中偏移量。<br> <strong>Strings Block</strong><br> string block包含了在设备树中出现的所有的属性名，所有的名字都是以NULL结尾，structure block通过nameoff来引用其中的属性名。strings block的结尾不需要4字节对齐。</p> 
<p><strong>设备树如何传递给内核？</strong><br> <img src="https://images2.imgbox.com/b5/51/PE7Umyxl_o.png" alt="在这里插入图片描述"><br> 路径：arch/arm64/kernel/setup.c<br> 1、"cmdline_p = boot_command_line 记录了 uboot 传递内核的 command_line，大小是 4096.如果超过 4096 就要修改这个数组的大小。<br> setup_machine_fdt(__fdt_pointer);<br> __fdt_pointer 是 DTB 位于内存的地址。<br> 在 arch/arm64/kernel/head.S 文件，找到：</p> 
<pre><code class="prism language-c">preserve_boot_args<span class="token operator">:</span>
    mov x21<span class="token punctuation">,</span> x0    <span class="token comment">//x21 = FDT</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    str_l x21<span class="token punctuation">,</span> __fdt_pointer<span class="token punctuation">,</span> x5    <span class="token comment">//保存FDT指针</span>
</code></pre> 
<p>启动内核之前，uboot 把DTB的地址传递到 x0，然后再启动内核。x0 存放DTB地址是规定。</p> 
<h3><a id="_device__driver__655"></a>设备树下的 device 和 driver 匹配</h3> 
<p>匹配优先级：name &lt; id_table &lt; of_match_table<br> 案例：</p> 
<pre><code class="prism language-c"><span class="token comment">/* 测试节点 */</span>
<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    test<span class="token punctuation">{<!-- --></span>                           <span class="token comment">/* 无关节点也需要 compatible 兼容性节点，不然编译到该节点会直接返回 */</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cell<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cell<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        compatible<span class="token operator">=</span><span class="token string">"simple-bus"</span><span class="token punctuation">;</span>    <span class="token comment">/* 根据转换规则，无关节点的兼容性设置也必须是三个特殊值之一，这样有用的子节点才会被编译成平台设备 */</span>
        my_led<span class="token punctuation">{<!-- --></span>
            compatible<span class="token operator">=</span><span class="token string">"my_driver"</span><span class="token punctuation">;</span>    <span class="token comment">/* 匹配的关键属性 */</span>
            reg<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">0xFDD60000</span> <span class="token number">0X00000004</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 驱动代码中的匹配部分 */</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> mydriver_id_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"my_driver"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">/* 必须和设备树节点中 compatible 属性值一样 */</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>加载驱动到开发板后将会在 sys/firmware/mydriver/ 目录中出现 myled 节点。</p> 
<p>设备都是以节点的形式“挂”到设备树上的，因此要想获取这个设备的其他属性信息，必<br> 须先获取到这个设备的节点。<br> Linux 内核使用 device_node 结构体来描述一个节点：</p> 
<pre><code class="prism language-c"><span class="token comment">/* include/linux/of.h */</span>
<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">/* 节点名字 */</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">;</span> <span class="token comment">/* 设备类型 */</span>
    phandle phandle<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>full_name<span class="token punctuation">;</span> <span class="token comment">/* 节点全名 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> fwnode<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>properties<span class="token punctuation">;</span> <span class="token comment">/* 属性 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>deadprops<span class="token punctuation">;</span> <span class="token comment">/* removed 属性 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span> <span class="token comment">/* 父节点 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span> <span class="token comment">/* 子节点 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>sibling<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_OF_KOBJ<span class="token punctuation">)</span></span></span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> _flags<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_SPARC<span class="token punctuation">)</span></span></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path_component_name<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> unique_id<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">of_irq_controller</span> <span class="token operator">*</span>irq_trans<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_OF__708"></a>查找节点有关的 OF 函数</h3> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_type</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_compatible_node</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">,</span> 
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>compatible<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_matching_node_and_match</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>matches<span class="token punctuation">,</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数：<br> from：开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树<br> name：要查找的节点名字<br> type：要查找的节点对应的 type 字符串，也就是 device_type 属性值（of_find_compatible_node()中可为NULL）<br> compatible：要查找的节点所对应的 compatible 属性列表<br> matches：of_device_id 匹配表，也就是在此匹配表里面查找节点<br> match：找到的匹配的 of_device_id<br> path：带有全路径的节点名，可以使用节点的别名，比如“/backlight”就是 backlight 这个<br> 节点的全路径<br> 返回值：找到的节点，如果为 NULL 表示查找失败<br> 案例：（寻找上例中的节点）</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;of.h&gt;</span></span>

<span class="token class-name">int32_t</span> <span class="token function">mydriver_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>my_mode <span class="token operator">=</span> <span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"myled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_OF__742"></a>查找父/子节点的 OF 函数</h3> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_get_parent</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>返回值：返回输入节点的父节点的指针</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_get_next_child</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>node：父节点。<br> prev：前一个子节点，也就是从哪一个子节点开始迭代的查找下一个子节点。可以设置为<br> NULL，表示从第一个子节点开始。</p> 
<h3><a id="_OF__754"></a>提取属性值的 OF 函数</h3> 
<p>（比较多，不需要全记住，有大概印象即可）</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">/* 属性名字 */</span>
    <span class="token keyword">int</span> length<span class="token punctuation">;</span> <span class="token comment">/* 属性长度 */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span> <span class="token comment">/* 属性值 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment">/* 下一个属性 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> _flags<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> unique_id<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> attr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-c">property <span class="token operator">*</span><span class="token function">of_find_property</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>lenp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_count_elems_of_size</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> <span class="token keyword">int</span> elem_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u32_index</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> u32 index<span class="token punctuation">,</span>  u32 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>np：设备节点<br> name：属性名字<br> lenp：属性值的字节数<br> proname：需要统计元素数量的属性名字<br> elem_size：元素长度<br> index：要读取的值标号<br> out_value：读取到的值<br> of_find_property() 返回 得到的属性结构体指针<br> of_property_count_elems_of_size() 返回属性元素的数量<br> of_property_read_u32_index() 读取成功则返回0，否则为负</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_u8_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> u8 <span class="token operator">*</span>out_values<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u16_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>  u16 <span class="token operator">*</span>out_values<span class="token punctuation">,</span>  <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u32_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>  u32 <span class="token operator">*</span>out_values<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u64_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>  u64 <span class="token operator">*</span>out_values<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>np：设备节点<br> proname：要读取的属性名字<br> out_value：读取到的数组值，分别是 u8、u16、u32、u64<br> sz：读取的数组元素数量<br> 返回值：0，读取成功，负值，读取失败，-EINVAL 表示属性不存在，-ENODATA 表示没<br> 有要读取的数据，-EOVERFLOW 表示属性值列表太小。<br> 这 4 个函数分别是读取属性中 u8、u16、u32 和 u64 类型的数组数据。<br> 大多数的 reg 属<br> 性都是数组数据，可以使用这 4 个函数一次读取出 reg 属性中的所有数据。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_u8</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> u8 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u16</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> u16 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u32</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> u32 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u64</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> u64 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>np：设备节点<br> proname：要读取的属性名字<br> out_value：读取到的数组值<br> 返回值：0，读取成功，负值，读取失败，-EINVAL 表示属性不存在，-ENODATA 表示没<br> 有要读取的数据，-EOVERFLOW 表示属性值列表太小。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_string</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>out_string<span class="token punctuation">)</span>
</code></pre> 
<p>np：设备节点<br> proname： 要读取的属性名字<br> out_string：读取到的字符串值<br> 返回值：0，读取成功，负值，读取失败。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_n_addr_cells</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>返回值：获取到的#address-cells 属性值。<br> int of_n_size_cells(struct device_node *np);<br> 返回值：获取到的#size-cells 属性值。</p> 
<h3><a id="_OF__826"></a>其他常用的 OF 函数</h3> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_device_is_compatible</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>device<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>compat<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>device：设备节点<br> compat：要查看的字符串<br> 返回值：0，节点的 compatible 属性中不包含 compat 指定的字符串；正数，节点的 compatible<br> 属性中包含 compat 指定的字符串。</p> 
<pre><code class="prism language-c"><span class="token keyword">const</span> __be32 <span class="token operator">*</span><span class="token function">of_get_address</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> u64 <span class="token operator">*</span>size<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>dev：设备节点<br> index：要读取的地址标号<br> size：地址长度<br> flags：参数，比如 IORESOURCE_IO、IORESOURCE_MEM 等<br> 返回值：读取到的地址数据首地址，为 NULL 的话表示读取失败。</p> 
<pre><code class="prism language-c">u64 <span class="token function">of_translate_address</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> __be32 <span class="token operator">*</span>in_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>dev：设备节点<br> in_addr：要转换的地址<br> 返回值：得到的物理地址，如果为 OF_BAD_ADDR 的话表示转换失败。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_address_to_resource</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>  <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>dev：设备节点<br> index：地址资源标号<br> r：得到的 resource 类型的资源值<br> 返回值：0，成功；负值，失败。<br> IIC、SPI、GPIO 等这些外设都有对应的寄存器，这些寄存器其实就是一组内存空间，Linux<br> 内核使用 resource 结构体来描述一段内存空间，“resource”翻译出来就是“资源”，因此用 resource<br> 结构体描述的都是设备资源信息，resource 结构体定义在文件 include/linux/ioport.h 中，定义如<br> 下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">resource_size_t</span> start<span class="token punctuation">;</span>
    <span class="token class-name">resource_size_t</span> end<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> <span class="token operator">*</span>sibling<span class="token punctuation">,</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>对于 32 位的 SOC 来说，resource_size_t 是 u32 类型的。其中 start 表示开始地址，end 表示<br> 结束地址，name 是这个资源的名字，flags 是资源标志位，一般表示资源类型，可选的资源标志<br> 定义在文件 include/linux/ioport.h 中，如下所示：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_BITS</span> <span class="token expression"><span class="token number">0x000000ff</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_TYPE_BITS</span> <span class="token expression"><span class="token number">0x00001f00</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_IO</span> <span class="token expression"><span class="token number">0x00000100</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_MEM</span> <span class="token expression"><span class="token number">0x00000200</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_REG</span> <span class="token expression"><span class="token number">0x00000300</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_IRQ</span> <span class="token expression"><span class="token number">0x00000400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_DMA</span> <span class="token expression"><span class="token number">0x00000800</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_BUS</span> <span class="token expression"><span class="token number">0x00001000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_PREFETCH</span> <span class="token expression"><span class="token number">0x00002000</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_READONLY</span> <span class="token expression"><span class="token number">0x00004000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_CACHEABLE</span> <span class="token expression"><span class="token number">0x00008000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_RANGELENGTH</span> <span class="token expression"><span class="token number">0x00010000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_SHADOWABLE</span> <span class="token expression"><span class="token number">0x00020000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_SIZEALIGN</span> <span class="token expression"><span class="token number">0x00040000</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_STARTALIGN</span> <span class="token expression"><span class="token number">0x00080000</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_MEM_64</span> <span class="token expression"><span class="token number">0x00100000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_WINDOW</span> <span class="token expression"><span class="token number">0x00200000</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_MUXED</span> <span class="token expression"><span class="token number">0x00400000</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_EXCLUSIVE</span> <span class="token expression"><span class="token number">0x08000000</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_DISABLED</span> <span class="token expression"><span class="token number">0x10000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_UNSET</span> <span class="token expression"><span class="token number">0x20000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_AUTO</span> <span class="token expression"><span class="token number">0x40000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IORESOURCE_BUSY</span> <span class="token expression"><span class="token number">0x80000000</span></span></span>
</code></pre> 
<p>最 常 见 的 资 源 标 志 就 是 IORESOURCE_MEM 、 IORESOURCE_REG 和<br> IORESOURCE_IRQ。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> __iomem <span class="token operator">*</span><span class="token function">of_iomap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>np：设备节点<br> index：reg 属性中要完成内存映射的段，如果 reg 属性只有一段的话 index 就设置为 0<br> 返回值：经过内存映射后的虚拟内存首地址，如果为 NULL 的话表示内存映射失败<br> of_iomap 函数用于直接内存映射，以前我们会通过 ioremap 函数来完成物理地址到虚拟地址的映射，采用设备树以后就可以直接通过 of_iomap 函数来获取内存地址所对应的虚拟地址，不需要使用 ioremap 函数了。<br> of_iomap() 本质上也是将 reg 属性中地址信息转换为虚拟地址，如果 reg 属性有多段的话，可以通过 index 参数指定要完成内存映射的是哪一段。</p> 
<h3><a id="_OF__911"></a>获取中断号的 OF 函数</h3> 
<pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">irq_of_parse_and_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>dev：设备节点<br> index：索引号<br> 返回值：对应的中断号<br> 案例：获取一个gpio的终端号</p> 
<pre><code class="prism language-c"><span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    test<span class="token punctuation">{<!-- --></span>
        myirq<span class="token punctuation">{<!-- --></span>
            compatible<span class="token operator">=</span><span class="token string">"my_irq"</span><span class="token punctuation">;</span>
            interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0<span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">/* 引用 gpio0 控制器的设备树 */</span>
            interrupts<span class="token operator">=</span><span class="token operator">&lt;</span>RK_PB5 IRQ_TYPE_LEVEL_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_irq.h&gt;</span></span>

<span class="token class-name">int32_t</span> <span class="token function">my_irq_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    strcut device_node <span class="token operator">*</span>my_node <span class="token operator">=</span> <span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"myirq"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> irq <span class="token operator">=</span> <span class="token function">irq_of_parse_and_map</span><span class="token punctuation">(</span>my_node<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">pintk</span><span class="token punctuation">(</span><span class="token string">"irq is %d\n"</span><span class="token punctuation">,</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其他中断相关函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span><span class="token function">irq_get_irq_data</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输入中断号，返回 irq_data 结构体。</p> 
<pre><code class="prism language-c">u32 <span class="token function">irqd_get_trigger_type</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>从中断属性中获取中断标志位（中断触发方式）。<br> 其他函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">gpio_to_irq</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输入 gpio 编号获得其中断号。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_irq_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>根据设备节点和索引号获得中断号。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">platform_get_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>根据平台总线设备结构体和索引号获得中断号。<br> 案例：</p> 
<pre><code class="prism language-c"><span class="token class-name">int32_t</span> <span class="token function">my_irq_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">int</span> irq <span class="token operator">=</span> <span class="token function">platform_get_irq</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_GPIO__OF__975"></a>获取 GPIO 的 OF 函数</h3> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_gpio_named_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_gpio_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_get_named_gpio</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>np：设备节点<br> propname：要统计的 GPIO 属性<br> index：GPIO 索引，因为一个属性里面可能包含多个 GPIO，此参数指定要获取哪个 GPIO的编号，如果只有一个 GPIO 信息的话此参数为 0<br> of_gpio_named_count 和 of_gpio_count 返回统计到的GPIO数量<br> of_get_named_gpio 返回获取到的 GPIO 编号</p> 
<h2><a id="_988"></a>四、附加篇</h2> 
<h3><a id="ranges__989"></a>ranges 属性</h3> 
<p><strong>两个格式：</strong></p> 
<pre><code class="prism language-c">ranges<span class="token operator">=</span><span class="token operator">&lt;</span>child<span class="token operator">-</span>bus<span class="token operator">-</span>address parent<span class="token operator">-</span>bus<span class="token operator">-</span>addree length<span class="token operator">&gt;</span><span class="token punctuation">;</span>
ranges<span class="token punctuation">;</span> <span class="token comment">/* ranges 的值为空，那么将进行 1 ：1 映射，是内存区域 */</span>
</code></pre> 
<p>child-bus-address：子地址物理空间的其实地址。由所在节点的 #address-cells 决定地址字长。<br> parent-bus-address：父地址物理空间的起始地址。由所在节点的父节点 的#address-cells 决定地址字长。<br> length：映射的大小，由所在节点的 #size-cell 属性决定地址的字长</p> 
<p>案例：</p> 
<pre><code class="prism language-c">soc<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    ranges<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0xe0000000</span> <span class="token number">0x00100000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">/* 将地址0x0 ~ 0x0+0x10000000 映射到 0xe0000000+0x00100000 */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    serial <span class="token punctuation">{<!-- --></span>
        device_type <span class="token operator">=</span> <span class="token string">"serial"</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"ns16550"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x4600</span> <span class="token number">0x100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0xA</span> <span class="token number">0x8</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ipic<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>reg 属性定义了 serial 设备寄存器的起始地址为 0x4600，寄存器长度为 0x100。</p> 
<p>经过地址转换，serial 设备可以从 0xe0004600 开始进行读写操作，0xe0004600=0x4600+0xe0000000。</p> 
<p>按照 ranges 的两个格式，可以把设备分为内存映射型设备和非内存映射型设备。<br> 内存映射型设备：CPU可以直接访问的设备。<br> 当一个节点中含有：ranges;<br> 那么其 reg 属性的地址就是 CPU 可以直接访问的。</p> 
<p>非内存映射设备：CPU 不可直接访问的设备，需要通过外部总线转化地址。<br> 即需要使用带参数的 ranges 格式来映射内存。<br> 案例：某个以太网设备树中（高速设备一般走内存映射的传输方式）</p> 
<pre><code class="prism language-c"><span class="token operator">/</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cell<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>        </span><span class="token comment">/* 注意这里是 1 !!!*/</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cell<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    external<span class="token operator">-</span>bus<span class="token punctuation">{<!-- --></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cell<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    </span><span class="token comment">/* 注意这里是 2 !!!*/</span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cell<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        ranges<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0x10100000</span> <span class="token number">0x100000</span>    <span class="token comment">/* 以太网卡片选，不同的片选信号代表不同的地址域 */</span>
                <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0x10160000</span> <span class="token number">0x100000</span>    <span class="token comment">/* 片选，I2C 控制 */</span>
                <span class="token number">2</span> <span class="token number">0</span> <span class="token number">0x30000000</span> <span class="token number">0x30000000</span><span class="token operator">&gt;</span> <span class="token comment">/* 片选， NOR FLASH */</span>
        ethernet@<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            reg<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0x1000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token comment">/* 前两个 0 也是地址，0x1000 是数字32，即32位，那么两个0分别组成64位地址的高32位和低32位 */</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        i2c@<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            reg<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span> <span class="token number">0</span> <span class="token number">0x1000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        flash@<span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            reg<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">2</span> <span class="token number">0</span> <span class="token number">0x4000000</span><span class="token operator">&gt;</span>        
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>首先，因为<strong>所在节点的 #address-cell 是 2</strong>，所以用 2个数 来表示子地址，即可从左到右的前两位：0 0 ，两个数组成了地址的高32位和低32位。<br> 其次，<strong>ranges 的父节点的 #address-cell 是1</strong>，所以 ranges 中 父地址物理空间的起始地址 只用一个数值来表示地址。</p> 
<ul><li>Ethernet 片选</li></ul> 
<p>(0&lt;&lt;32) | (0) 就是 ethernet 节点中的 reg 的64位地址，设其为 addr1<br> (0&lt;&lt;32) | (0) 就是 ranges 中&lt;0 0 0x10100000 0x100000&gt;前两位组成的64位地址，设其为 addr2<br> 那么，地址范围就是：<br> （0x10100000 + (addr1-addr2) ）~ (0x10100000+0x1000-1)<br> 即：0x10100000 ~ 0x10100fff</p> 
<ul><li>IIC controller</li></ul> 
<p>(1&lt;&lt;32) | (0) 就是i2c节点中的reg的64位地址，设为addr1<br> (1&lt;&lt;32) | (0) 是 ranges 中&lt;1 0 0x10160000 0x100000&gt; 前两位组成的64位地址，设其为 addr2<br> 那么，地址范围就是：<br> （0x10160000 + (addr1-addr2) ）~ (0x10160000+0x1000-1)<br> 即：0x10160000 ~ 0x10160fff</p> 
<ul><li>NOR FLASH</li></ul> 
<p>略……</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/27e4300fd4daf3e43e37454c723234f3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信小程序通过蓝牙连接ESP32控制LED灯</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/863bc299f98e358c02271efafba16e39/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">时序预测 | MATLAB实现基于CNN卷积神经网络的时间序列预测-递归预测未来(多指标评价)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>