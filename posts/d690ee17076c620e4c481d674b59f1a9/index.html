<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>关于springboot的优雅停机和健康检查配置（用于k8s服务重启） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="关于springboot的优雅停机和健康检查配置（用于k8s服务重启）" />
<meta property="og:description" content="优雅停机 所谓的优雅停机指的是（一方面可以在停机的时候通过背板挡住外来正在发送的请求，另一方面已经接受的请求能够很好的执行完接下来的业务）。服务在关闭的时候，不能通过强制kill进程的方式进行停止，这样的话，对于有些未处理完成的业务要进行数据的补偿.
一. 优雅停机 1. 如果是springboot2.3版本之前可以通引入如下jar
&lt;dependency&gt; &lt;groupId&gt;com.github.timpeeters&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-graceful-shutdown&lt;/artifactId&gt; &lt;version&gt;X.X.X&lt;/version&gt; &lt;/dependency&gt; 版本可参考：
就可以实现优雅停机了
2、如果springboot是2.3版本之后，则可以直接在application.yml做如下配置即可
server: # 开启优雅关闭，默认：IMMEDIATE，立即关闭 shutdown: graceful spring: lifecycle: # 配置优雅关闭宽限时间，即项目在30s都没处理完，则进行强制关闭 timeout-per-shutdown-phase: 30s 二. 健康检查配置 添加依赖
&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; 配置application.yml，如下
management: # 也可指定ip和端口进行访问 # server: # address: 127.0.0.1 # port: 5000 # 开启shutdown endpoint endpoint: # 需要关机就要进行配置默认都是flase shutdown: enabled: true health: enabled: true endpoints: web: base-path: /actuator #访问http://127.0.0.1:8083/actuator/health exposure: # 暴露shutdown health（访问http://127.0.0.1:8083/actuator/health进行健康检测 # 访问http://127.0.0.1:8083/actuator/shutdown进行优雅停机） include: shutdown,health 访问http://127." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d690ee17076c620e4c481d674b59f1a9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-29T17:51:23+08:00" />
<meta property="article:modified_time" content="2022-08-29T17:51:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">关于springboot的优雅停机和健康检查配置（用于k8s服务重启）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>优雅停机</h3> 
<p>所谓的优雅停机指的是（<code>一方面可以在停机的时候通过背板挡住外来正在发送的请求，另一方面已经接受的请求能够很好的执行完接下来的业务</code>）。服务在关闭的时候，不能通过强制kill进程的方式进行停止，这样的话，对于有些未处理完成的业务要进行数据的补偿.</p> 
<h3><a id="__3"></a>一. 优雅停机</h3> 
<p><strong>1. 如果是springboot2.3版本之前可以通引入如下jar</strong></p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com.github.timpeeters<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring-boot-graceful-shutdown<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>X.X.X<span class="token operator">&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>版本可参考：<br> <img src="https://images2.imgbox.com/74/91/Ic3CPMel_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/56/90/3MLlqoTZ_o.png" alt="在这里插入图片描述"><br> 就可以实现优雅停机了</p> 
<p><strong>2、如果springboot是2.3版本之后，则可以直接在application.yml做如下配置即可</strong></p> 
<pre><code class="prism language-bash">server:
  <span class="token comment"># 开启优雅关闭，默认：IMMEDIATE，立即关闭</span>
  shutdown: graceful

spring:
  lifecycle:
    <span class="token comment"># 配置优雅关闭宽限时间，即项目在30s都没处理完，则进行强制关闭</span>
    timeout-per-shutdown-phase: 30s
</code></pre> 
<p><img src="https://images2.imgbox.com/59/51/zIpKO9TS_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="__32"></a>二. 健康检查配置</h3> 
<p>添加依赖</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.springframework.boot<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring-boot-starter-actuator<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>配置application.yml，如下</p> 
<pre><code class="prism language-yaml">  <span class="token key atrule">management</span><span class="token punctuation">:</span>
<span class="token comment">#  也可指定ip和端口进行访问</span>
<span class="token comment">#  server:</span>
<span class="token comment">#    address: 127.0.0.1</span>
<span class="token comment">#    port: 5000</span>
  <span class="token comment"># 开启shutdown endpoint</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
<span class="token comment">#    需要关机就要进行配置默认都是flase</span>
    <span class="token key atrule">shutdown</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">base-path</span><span class="token punctuation">:</span> /actuator  <span class="token comment">#访问http://127.0.0.1:8083/actuator/health</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token comment"># 暴露shutdown health（访问http://127.0.0.1:8083/actuator/health进行健康检测</span>
        <span class="token comment"># 访问http://127.0.0.1:8083/actuator/shutdown进行优雅停机）</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> shutdown<span class="token punctuation">,</span>health

</code></pre> 
<p>访问http://127.0.0.1:8083/actuator/health进行健康检测</p> 
<p>http://127.0.0.1:8083/actuator/shutdown进行优雅停机</p> 
<p>另外，其他端点的路径如下表格，注意，<code>前面需要添加/actuator根路径</code>，如下</p> 
<p><img src="https://images2.imgbox.com/c2/63/IJm3Tjdf_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_springbootdocker_72"></a>三. springboot在docker容器中如何进行优雅关闭</h3> 
<p>如果在Dockerfile做如下配置</p> 
<pre><code class="prism language-powershell">ENTRYPOINT <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"java <span class="token variable">$JAVA_OPTS</span> -Djava.security.egd=file:/dev/./urandom -jar /app.jar"</span> <span class="token punctuation">]</span>
</code></pre> 
<p>是没法实现优雅关闭的效果。其原因是使用 docker stop 关闭容器时, 只有 init(pid 1)进程能收到中断信号, 如果容器的pid 1 进程是 sh 进程, 它不具备转发结束信号到它的子进程的能力, 所以我们真正的java程序得不到中断信号, 也就不能实现优雅关闭. 解决思路是: 让pid 1 进程具备转发终止信号, 或者将 java 程序配成 pid 1 进程.<br> 因此只需对Dockerfile做如下改造就行</p> 
<pre><code class="prism language-powershell">ENTRYPOINT <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"exec java <span class="token variable">$JAVA_OPTS</span> -Djava.security.egd=file:/dev/./urandom -jar /app.jar"</span> <span class="token punctuation">]</span>
</code></pre> 
<p>其实就是在java前边加上exec即可。其实现机理可以参考如下链接<br> https://spring.io/guides/topicals/spring-boot-docker</p> 
<p><strong>在k8s中如何进行优雅关闭</strong></p> 
<p><strong>1、配置preStop Hook钩子</strong></p> 
<p>preStop Hook 是一个发送到 Pod 中的容器特殊命令或 Http 请求。如果您的应用程序在接收 SIGTERM 时没有正常关闭，您可以使用 preStop Hook 来触发正常关闭。接收 <code>SIGTERM 时大多数</code>程序都会正常关闭，但如果您使用的是第三方代码或管理的系统无法控制，则 preStop Hook 是在不修改应用程序的情况下触发正常关闭的好方法。<br> <strong>2、适当延长terminationGracePeriodSeconds时间</strong></p> 
<p>其配置参考如下</p> 
<pre><code class="prism language-powershell">apiVersion: v1 
kind: Pod 
metadata:
  name: demopod
spec:
  containers:
  <span class="token operator">-</span> image: springboot-demo:v1<span class="token punctuation">.</span>10
    name: demo-container
    ports:
    <span class="token operator">-</span> containerPort: 8080
    lifecycle:
      preStop:
        exec:
          command: <span class="token punctuation">[</span><span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-XPOST"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:8083/actuator/shutdown"</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_114"></a>总结</h3> 
<p>优雅关闭正常都是会配置一定的处理时间，超过该时间没处理完，就会进行强杀。因此对于核心业务，我们还得考虑万一进行强杀时，还要考虑是否需要对业务进行补偿操作</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1b2308a1dbc38a1f973db5da15a0f5d6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android Studio 关联源码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7857edae32c94b282b11cb55571df61a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Pandas中的loc与iloc用法详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>