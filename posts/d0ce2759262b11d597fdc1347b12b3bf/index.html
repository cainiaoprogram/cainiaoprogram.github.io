<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[20190827]函数索引与选择率.txt - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[20190827]函数索引与选择率.txt" />
<meta property="og:description" content="[20190827]函数索引与选择率.txt --//一般情况下查询条件使用函数，选择率1%.如果建立虚拟列并且分析的情况下，能够获得比较准确的选择率。 --//如果建立对应的函数索引呢，情况会怎么呢？最近遇到的问题，让我注意其中一些细节。 1.环境： SCOTT@test01p&gt; @ ver1 PORT_STRING VERSION BANNER CON_ID ------------------------------ -------------- -------------------------------------------------------------------------------- ---------- IBMPC/WIN_NT64-9.1.0 12.2.0.1.0 Oracle Database 12c Enterprise Edition Release 12.2.0.1.0 - 64bit Production 0 SCOTT@test01p&gt; create table t1 as select rownum id,dbms_random.string(&#39;U&#39;,10) v1 from dual connect by level&lt;=1e4; Table created. --//分析略.Method_Opt =&gt; &#39;FOR ALL COLUMNS SIZE 1 &#39; SCOTT@test01p&gt; select * from t1 where rownum=1; ID V1 ---------- -------------------- 1 KCIXTFQWHZ 2.测试： SCOTT@test01p&gt; alter session set statistics_level = all; Session altered." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d0ce2759262b11d597fdc1347b12b3bf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-08-28T21:38:22+08:00" />
<meta property="article:modified_time" content="2019-08-28T21:38:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[20190827]函数索引与选择率.txt</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="preview-main"> 
 <p> <span style="font-family:'微软雅黑', 'Microsoft YaHei';font-size:12px;">[20190827]函数索引与选择率.txt <br><br>--//一般情况下查询条件使用函数，选择率1%.如果建立虚拟列并且分析的情况下，能够获得比较准确的选择率。 <br>--//如果建立对应的函数索引呢，情况会怎么呢？最近遇到的问题，让我注意其中一些细节。 <br><br>1.环境： <br>SCOTT@test01p&gt; @ ver1 <br>PORT_STRING                    VERSION        BANNER                                                                               CON_ID <br>------------------------------ -------------- -------------------------------------------------------------------------------- ---------- <br>IBMPC/WIN_NT64-9.1.0           12.2.0.1.0     Oracle Database 12c Enterprise Edition Release 12.2.0.1.0 - 64bit Production              0 <br><br>SCOTT@test01p&gt; create table t1 as select rownum id,dbms_random.string('U',10) v1 from dual connect by level&lt;=1e4; <br>Table created. <br><br>--//分析略.Method_Opt =&gt; 'FOR ALL COLUMNS SIZE 1 ' <br>SCOTT@test01p&gt; select * from t1 where rownum=1; <br>        ID V1 <br>---------- -------------------- <br>         1 KCIXTFQWHZ <br><br>2.测试： <br>SCOTT@test01p&gt; alter session set statistics_level = all; <br>Session altered. <br><br>SCOTT@test01p&gt; select * from t1 where lower(v1)='kcixtfqwhz'; <br>        ID V1 <br>---------- -------------------- <br>         1 KCIXTFQWHZ <br><br>SCOTT@test01p&gt; @ dpc '' '' <br>PLAN_TABLE_OUTPUT <br>------------------------------------- <br>SQL_ID  ds718dy9422mr, child number 1 <br>------------------------------------- <br>select * from t1 where lower(v1)='kcixtfqwhz' <br>Plan hash value: 3617692013 <br>-------------------------------------------------------------------------------------------------------------------- <br>| Id  | Operation         | Name | Starts | E-Rows |E-Bytes| Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | <br>-------------------------------------------------------------------------------------------------------------------- <br>|   0 | SELECT STATEMENT  |      |      1 |        |       |    10 (100)|          |      1 |00:00:00.01 |      41 | <br>|*  1 |  TABLE ACCESS FULL| T1   |      1 |    100 |  1500 |    10   (0)| 00:00:01 |      1 |00:00:00.01 |      41 | <br>-------------------------------------------------------------------------------------------------------------------- <br>--//E-Rows=100, <br>--//选择率100/10000 = .01. <br><br>3.如果建立对应的函数索引呢？ <br><br>SCOTT@test01p&gt; create index if_t1_v1 on t1( lower(v1)); <br>Index created. <br><br>SCOTT@test01p&gt; select * from t1 where lower(v1)='kcixtfqwhz'; <br>        ID V1 <br>---------- -------------------- <br>         1 KCIXTFQWHZ <br><br>SCOTT@test01p&gt; @ dpc '' '' <br>PLAN_TABLE_OUTPUT <br>------------------------------------- <br>SQL_ID  ds718dy9422mr, child number 1 <br>------------------------------------- <br>select * from t1 where lower(v1)='kcixtfqwhz' <br>Plan hash value: 544604454 <br>--------------------------------------------------------------------------------------------------------------------------------------------------- <br>| Id  | Operation                           | Name     | Starts | E-Rows |E-Bytes| Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  | <br>--------------------------------------------------------------------------------------------------------------------------------------------------- <br>|   0 | SELECT STATEMENT                    |          |      1 |        |       |     9 (100)|          |      1 |00:00:00.01 |       4 |      1 | <br>|   1 |  TABLE ACCESS BY INDEX ROWID BATCHED| T1       |      1 |    100 |  1500 |     9   (0)| 00:00:01 |      1 |00:00:00.01 |       4 |      1 | <br>|*  2 |   INDEX RANGE SCAN                  | IF_T1_V1 |      1 |     40 |       |     1   (0)| 00:00:01 |      1 |00:00:00.01 |       3 |      1 | <br>--------------------------------------------------------------------------------------------------------------------------------------------------- <br>--//E-Rows=40. <br>--//选择率40/10000 = .004,这个是我以前没有注意到的,我一直以为选择率还是1%.不知道这个缺省的选择率如何确定的. <br><br>4.继续探究: <br>--//实际上建立函数索引时有1个细节不容忽视,就是该隐含字段缺乏统计信息,我曾经在这里栽过跟头. <br><br>SCOTT@test01p&gt; SCOTT@test01p&gt; @ tab_lh scott t1  '' <br><br>DISPLAY TABLE_NAME OF COLUMN_NAME INFORMATION. <br>INPUT   OWNER TABLE_NAME COLUMN <br>SAMPLE  : @ TAB_LH TABLE_NAME [COLUMN_NAME] <br>IF NOT INPUT COLUMN_NAME ,USE "" . <br><br>COLUMN_NAME   DATA_TYPE DATA_LENGTH N NUM_DISTINCT    DENSITY SAMPLE_SIZE TRANS_LOW  TRANS_HIGH NUM_NULLS NUM_BUCKETS LAST_ANALYZED       HISTOGRAM DATA_DEFAULT <br>------------- --------- ----------- - ------------ ---------- ----------- ---------- ---------- --------- ----------- ------------------- --------- ------------- <br>ID            NUMBER             22 Y        10000      .0001       10000 1          10000              0           1 2019-08-27 21:35:55 NONE <br>V1            VARCHAR2         4000 Y        10000      .0001       10000 AAAXTDLLNT ZZZBEIPJYY         0           1 2019-08-27 21:35:55 NONE <br>SYS_NC00003$  VARCHAR2         4000 Y                                                                                                     NONE       LOWER("V1") <br>--//必须要重新分析表. <br><br>execute sys.dbms_stats.gather_table_stats ( OwnName =&gt; nvl('',user),TabName =&gt; 't1',Estimate_Percent =&gt; NULL,Method_Opt =&gt; 'FOR ALL COLUMNS SIZE 1 ',Cascade =&gt; True ,No_Invalidate =&gt; false) <br><br>SCOTT@test01p&gt; @ tab_lh scott t1  SYS_NC00003$ <br>DISPLAY TABLE_NAME OF COLUMN_NAME INFORMATION. <br>INPUT   OWNER TABLE_NAME COLUMN <br>SAMPLE  : @ TAB_LH TABLE_NAME [COLUMN_NAME] <br>IF NOT INPUT COLUMN_NAME ,USE "" . <br>COLUMN_NAME  DATA_TYPE DATA_LENGTH N NUM_DISTINCT    DENSITY SAMPLE_SIZE TRANS_LOW  TRANS_HIGH NUM_NULLS NUM_BUCKETS LAST_ANALYZED       HISTOGRAM DATA_DEFAULT <br>------------ --------- ----------- - ------------ ---------- ----------- ---------- ---------- --------- ----------- ------------------- --------- ------------ <br>SYS_NC00003$ VARCHAR2         4000 Y        10000      .0001       10000 aaaxtdllnt zzzbeipjyy         0           1 2019-08-27 21:46:06 NONE      LOWER("V1") <br><br>SCOTT@test01p&gt; select * from t1 where lower(v1)='kcixtfqwhz'; <br>        ID V1 <br>---------- -------------------- <br>         1 KCIXTFQWHZ <br><br>SCOTT@test01p&gt; @ dpc '' '' <br>PLAN_TABLE_OUTPUT <br>------------------------------------- <br>SQL_ID  ds718dy9422mr, child number 1 <br>------------------------------------- <br>select * from t1 where lower(v1)='kcixtfqwhz' <br><br>Plan hash value: 544604454 <br><br>------------------------------------------------------------------------------------------------------------------------------------------ <br>| Id  | Operation                           | Name     | Starts | E-Rows |E-Bytes| Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | <br>------------------------------------------------------------------------------------------------------------------------------------------ <br>|   0 | SELECT STATEMENT                    |          |      1 |        |       |     2 (100)|          |      1 |00:00:00.01 |       4 | <br>|   1 |  TABLE ACCESS BY INDEX ROWID BATCHED| T1       |      1 |      1 |    26 |     2   (0)| 00:00:01 |      1 |00:00:00.01 |       4 | <br>|*  2 |   INDEX RANGE SCAN                  | IF_T1_V1 |      1 |      1 |       |     1   (0)| 00:00:01 |      1 |00:00:00.01 |       3 | <br>------------------------------------------------------------------------------------------------------------------------------------------ <br>--//这样E-Rows估算就比较准确了. <br><br>5.附上tab_lh.sql脚本: <br>/* Formatted on 2014/10/19 20:53:41 (QP5 v5.227.12220.39754) */ <br>PROMPT <br>PROMPT DISPLAY TABLE_NAME OF COLUMN_NAME INFORMATION. <br>PROMPT INPUT   OWNER TABLE_NAME COLUMN <br>PROMPT SAMPLE  : @ TAB_LH TABLE_NAME [COLUMN_NAME] <br>PROMPT IF NOT INPUT COLUMN_NAME ,USE "" . <br>PROMPT <br><br>column trans_low format a32 <br>column trans_high format a32 <br>column data_default format a20 <br>column column_name format a24 <br>SELECT <br>--owner, <br>--         table_name, <br>         column_name, <br>         data_type, <br>         data_length, <br>         nullable, <br>         num_distinct, <br>         density, <br>         sample_size, <br>         CASE <br>            WHEN data_type IN ('CHAR', 'VARCHAR2') <br>            THEN <br>               UTL_RAW.cast_to_varchar2 (low_value) <br>            WHEN data_type = 'NUMBER' <br>            THEN <br>               TO_CHAR (UTL_RAW.cast_to_number (low_value)) <br>            WHEN data_type = 'DATE' <br>            THEN <br>               RTRIM ( <br>                     LTRIM ( <br>                        TO_CHAR ( <br>                               100 <br>                             * (  TO_NUMBER (SUBSTR (low_value, 1, 2), 'XX') <br>                                - 100) <br>                           + (TO_NUMBER (SUBSTR (low_value, 3, 2), 'XX') - 100), <br>                           '0000')) <br>                  || '-' <br>                  || LTRIM ( <br>                        TO_CHAR (TO_NUMBER (SUBSTR (low_value, 5, 2), 'XX'), <br>                                 '00')) <br>                  || '-' <br>                  || LTRIM ( <br>                        TO_CHAR (TO_NUMBER (SUBSTR (low_value, 7, 2), 'XX'), <br>                                 '00')) <br>                  || ' ' <br>                  || LTRIM ( <br>                        TO_CHAR ( <br>                           TO_NUMBER (SUBSTR (low_value, 9, 2), 'XX') - 1, <br>                           '00')) <br>                  || ':' <br>                  || LTRIM ( <br>                        TO_CHAR ( <br>                           TO_NUMBER (SUBSTR (low_value, 11, 2), 'XX') - 1, <br>                           '00')) <br>                  || ':' <br>                  || LTRIM ( <br>                        TO_CHAR ( <br>                           TO_NUMBER (SUBSTR (low_value, 13, 2), 'XX') - 1, <br>                           '00'))) <br>         END <br>            trans_low, <br>         CASE <br>            WHEN data_type IN ('CHAR', 'VARCHAR2') <br>            THEN <br>               UTL_RAW.cast_to_varchar2 (high_value) <br>            WHEN data_type = 'NUMBER' <br>            THEN <br>               TO_CHAR (UTL_RAW.cast_to_number (high_value)) <br>            WHEN data_type = 'DATE' <br>            THEN <br>               RTRIM ( <br>                     LTRIM ( <br>                        TO_CHAR ( <br>                               100 <br>                             * (  TO_NUMBER (SUBSTR (high_value, 1, 2), 'XX') <br>                                - 100) <br>                           + (TO_NUMBER (SUBSTR (high_value, 3, 2), 'XX') - 100), <br>                           '0000')) <br>                  || '-' <br>                  || LTRIM ( <br>                        TO_CHAR (TO_NUMBER (SUBSTR (high_value, 5, 2), 'XX'), <br>                                 '00')) <br>                  || '-' <br>                  || LTRIM ( <br>                        TO_CHAR (TO_NUMBER (SUBSTR (high_value, 7, 2), 'XX'), <br>                                 '00')) <br>                  || ' ' <br>                  || LTRIM ( <br>                        TO_CHAR ( <br>                           TO_NUMBER (SUBSTR (high_value, 9, 2), 'XX') - 1, <br>                           '00')) <br>                  || ':' <br>                  || LTRIM ( <br>                        TO_CHAR ( <br>                           TO_NUMBER (SUBSTR (high_value, 11, 2), 'XX') - 1, <br>                           '00')) <br>                  || ':' <br>                  || LTRIM ( <br>                        TO_CHAR ( <br>                           TO_NUMBER (SUBSTR (high_value, 13, 2), 'XX') - 1, <br>                           '00'))) <br>         END <br>            trans_high, <br>         num_nulls, <br>         num_buckets, <br>         last_analyzed, <br>         histogram, <br>        data_default <br>    FROM dba_tab_cols <br>   WHERE  owner = decode('&amp;1','',user,upper('&amp;1')) <br>AND table_name = upper('&amp;2') <br>AND column_name = decode('&amp;&amp;3','',column_name,upper('&amp;&amp;3')) <br>ORDER BY column_id <br>/ <br><br></span></p> 
 <p style="clear:both;"></p> 
 <p class="translate"> 来自 “ ITPUB博客 ” ，链接：http://blog.itpub.net/267265/viewspace-2655338/，如需转载，请注明出处，否则将追究法律责任。 </p> 
</div> 
<p>转载于:http://blog.itpub.net/267265/viewspace-2655338/</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6d79da4b71785585196e74073c5051cd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android 护眼模式的实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/df976d9f3c8acce0786cd400e062d4c1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java 抽象类为什么不能被实例化？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>