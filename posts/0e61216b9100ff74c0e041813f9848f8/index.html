<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>数据库高可用mha - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="数据库高可用mha" />
<meta property="og:description" content="MHA搭建的步骤 一.配置主从复制 1.初始化环境 #在四台服务器上初始化环境 systemctl stop firewalld systemctl disable firewalld setenforce 0 2.修改 Master、Slave1、Slave2 节点的主机名 #在Master上 hostnamectl set-hostname mysql1 su #在Slave1 hostnamectl set-hostname mysql2 su #在Slave2 hostnamectl set-hostname mysql3 su 3.在Master、Slave1、Slave2添加域名解析 vim /etc/hosts 172.16.23.13 mysql1 172.16.23.15 mysql2 172.16.23.16 mysql3 4.配置主从同步 #修改 Master、Slave1、Slave2 节点的 Mysql主配置文件/etc/my.cnf ##Master 节点## vim /etc/my.cnf [mysqld] server-id = 1 log_bin = mysql-bin binlog_format = mixed log-slave-updates = true relay-log = relay-log-bin relay-log-index = slave-relay-bin.index systemctl restart mysqld ##Slave1 节点## vim /etc/my." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0e61216b9100ff74c0e041813f9848f8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-06T04:03:04+08:00" />
<meta property="article:modified_time" content="2024-01-06T04:03:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据库高可用mha</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 id="%E4%B8%89%E3%80%81MHA%E6%90%AD%E5%BB%BA%E7%9A%84%E6%AD%A5%E9%AA%A4" style="background-color:transparent;"><strong>MHA搭建的步骤</strong></h2> 
<h4 id="3.1%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6" style="background-color:transparent;"><a name="t10"></a><strong>一.配置主从复制</strong></h4> 
<h5><strong>1.初始化环境</strong></h5> 
<pre><code>#在四台服务器上初始化环境
systemctl stop firewalld
systemctl disable firewalld
setenforce 0</code></pre> 
<h5 id="2.%E4%BF%AE%E6%94%B9%20Master%E3%80%81Slave1%E3%80%81Slave2%20%E8%8A%82%E7%82%B9%E7%9A%84%E4%B8%BB%E6%9C%BA%E5%90%8D"><strong>2.修改 Master、Slave1、Slave2 节点的主机名</strong></h5> 
<pre><code>#在Master上
hostnamectl set-hostname mysql1
su
 
#在Slave1
hostnamectl set-hostname mysql2
su
 
#在Slave2
hostnamectl set-hostname mysql3
su</code></pre> 
<h5 id="3.%E5%9C%A8Master%E3%80%81Slave1%E3%80%81Slave2%E6%B7%BB%E5%8A%A0%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90"><strong>3.在Master、Slave1、Slave2添加域名解析</strong></h5> 
<pre><code>vim /etc/hosts
172.16.23.13 mysql1
172.16.23.15 mysql2
172.16.23.16 mysql3</code></pre> 
<p><img alt="" height="249" src="https://images2.imgbox.com/2a/b4/69h0GhN3_o.png" width="1200"></p> 
<h5 id="4.%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5"><strong>4.配置主从同步</strong></h5> 
<pre><code>#修改 Master、Slave1、Slave2 节点的 Mysql主配置文件/etc/my.cnf 
##Master 节点##
vim /etc/my.cnf
[mysqld]
server-id = 1
log_bin = mysql-bin
binlog_format = mixed
log-slave-updates = true
relay-log = relay-log-bin
relay-log-index = slave-relay-bin.index

 
systemctl restart mysqld
 
##Slave1 节点##
vim /etc/my.cnf
server-id = 2 						#三台服务器的 server-id 不能一样
log_bin = mysql-bin
binlog_format = mixed
log-slave-updates = true
relay-log = relay-log-bin
relay-log-index = slave-relay-bin.index
 
systemctl restart mysqld
 
###Slave2 节点##
vim /etc/my.cnf
server-id = 3 						
log_bin = mysql-bin
binlog_format = mixed
log-slave-updates = true
relay-log = relay-log-bin
relay-log-index = slave-relay-bin.index



systemctl restart mysqld
 </code></pre> 
<p><img alt="" height="729" src="https://images2.imgbox.com/49/1e/0kJkNEbw_o.png" width="1200"></p> 
<p><img alt="" height="765" src="https://images2.imgbox.com/58/2e/mtvCPCkg_o.png" width="1200"></p> 
<p><img alt="" height="682" src="https://images2.imgbox.com/89/86/b44uMnWi_o.png" width="1200"></p> 
<h5 id="5.%20Master%E3%80%81Slave1%E3%80%81Slave2%20%E8%8A%82%E7%82%B9%E4%B8%8A%E9%83%BD%E5%88%9B%E5%BB%BA%E4%B8%A4%E4%B8%AA%E8%BD%AF%E9%93%BE%E6%8E%A5"><strong>5. Master、Slave1、Slave2 节点上都创建两个软链接</strong></h5> 
<pre><code>ln -s /usr/local/mysql/bin/mysql /usr/sbin/
ln -s /usr/local/mysql/bin/mysqlbinlog /usr/sbin/

</code></pre> 
<p><img alt="" height="125" src="https://images2.imgbox.com/52/ba/Qlou4cqw_o.png" width="1200"></p> 
<h5 id="6.%E7%99%BB%E5%BD%95%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE%E6%8E%88%E6%9D%83"><strong>6.登录数据库主从配置授权</strong></h5> 
<pre><code>###Master、Slave1、Slave2 节点上都授权###
grant replication slave on *.* to 'myslave'@'172.16.23.%' identified by '123';
#授权主从用户
grant all privileges on *.* to 'mha'@'172.16.23.%' identified by '123';
grant all privileges on *.* to 'mha'@'mysql1' identified by '123';
grant all privileges on *.* to 'mha'@'mysql2' identified by '123';
grant all privileges on *.* to 'mha'@'mysql3' identified by '123';
 
#刷新库
flush privileges;</code></pre> 
<p></p> 
<h5><img alt="" height="384" src="https://images2.imgbox.com/fc/b6/CKSXJVJi_o.png" width="1200"></h5> 
<h5 id="7.Master%20%E8%8A%82%E7%82%B9%E6%9F%A5%E7%9C%8B%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%92%8C%E5%90%8C%E6%AD%A5%E7%82%B9%20%E3%80%81%E5%9C%A8%20Slave1%E3%80%81Slave2%20%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C%E5%90%8C%E6%AD%A5%E6%93%8D%E4%BD%9C"><img alt="" height="397" src="https://images2.imgbox.com/5a/93/Te73FYYZ_o.png" width="1200"><strong>7.Master 节点查看二进制文件和同步点 、在 Slave1、Slave2 节点执行同步操作</strong></h5> 
<pre><code>###在master上###
show master status;
 
###在slave1、slave2节点执行同步操作##
change master to
master_host='172.16.23.13',master_user='myslave',master_password='123',master_log_file='master-bin.000001',master_log_pos=1743;
start slave;
show slave status\G;</code></pre> 
<p><img alt="" height="180" src="https://images2.imgbox.com/13/2d/LuKb6tOd_o.png" width="1200"></p> 
<p><img alt="" height="735" src="https://images2.imgbox.com/6d/be/3ygt3bQb_o.png" width="1200"></p> 
<p><img alt="" height="754" src="https://images2.imgbox.com/d1/6f/88KmdD8w_o.png" width="1200"></p> 
<h5 id="8.%E8%AE%BE%E7%BD%AE%E4%B8%A4%E4%B8%AA%E4%BB%8E%E8%8A%82%E7%82%B9%20%E5%8F%AA%E8%AF%BB%E6%A8%A1%E5%BC%8F"><strong>8.设置两个从节点 只读模式</strong></h5> 
<pre><code>set global read_only=1;</code></pre> 
<p><img alt="" height="80" src="https://images2.imgbox.com/e3/ac/7S48EDCP_o.png" width="671"></p> 
<p><img alt="" height="66" src="https://images2.imgbox.com/5d/70/VI4YAREa_o.png" width="1046"></p> 
<h5 id="9.%E9%AA%8C%E8%AF%81%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5" style="background-color:transparent;"><strong>9.验证主从同步</strong></h5> 
<pre><code>主：
create database test;
use test;
create table info(id int primary key auto_increment,name varchar(20) unique key,age int);
insert into info (name,age)values('lxy',18);
insert into info (name,age)values('mz',19);
select * from info;
备：
select * from test.info;</code></pre> 
<p><img alt="" height="624" src="https://images2.imgbox.com/28/73/rvbIAhSA_o.png" width="1200"></p> 
<p><img alt="" height="216" src="https://images2.imgbox.com/60/2d/Dmkhi1zo_o.png" width="1062"></p> 
<p><img alt="" height="232" src="https://images2.imgbox.com/c1/cd/Phs54Aw8_o.png" width="971"></p> 
<h4 style="background-color:transparent;">二.安装 MHA 软件</h4> 
<h5>1.所有服务器上都安装 MHA 依赖的环境，首先安装 epel 源</h5> 
<pre><code>yum install epel-release --nogpgcheck -y
 
yum install -y perl-DBD-MySQL \
perl-Config-Tiny \
perl-Log-Dispatch \
perl-Parallel-ForkManager \
perl-ExtUtils-CBuilder \
perl-ExtUtils-MakeMaker \
perl-CPAN</code></pre> 
<p><img alt="" height="481" src="https://images2.imgbox.com/71/16/VYGKYWyM_o.png" width="1200"></p> 
<p><img alt="" height="361" src="https://images2.imgbox.com/e3/18/4e633gqQ_o.png" width="1200"></p> 
<h5>2.安装 MHA 软件包，先在所有服务器上必须先安装 node 组件</h5> 
<ul><li> <p>对于每个操作系统版本不一样，这里 CentOS7.4 必须选择 0.57 版本。</p> </li><li> <p>在所有服务器上必须先安装 <a href="https://so.csdn.net/so/search?q=node&amp;spm=1001.2101.3001.7020" title="node">node</a> 组件，最后在 MHA-manager 节点上安装 manager 组件，因为 manager 依赖 node 组件。</p> <pre><code>##将需要的包下载到/opt下##
 
##每台服务器上解压安装node组件##
cd /opt
tar zxvf mha4mysql-node-0.57.tar.gz
cd mha4mysql-node-0.57
perl Makefile.PL
make &amp;&amp; make install</code></pre> <p><img alt="" height="775" src="https://images2.imgbox.com/b7/08/0cAAvkv3_o.png" width="1200"></p> </li></ul> 
<h5 id="3.%E5%9C%A8%20MHA-manager%20%E8%8A%82%E7%82%B9%E4%B8%8A%E5%AE%89%E8%A3%85%20manager%20%E7%BB%84%E4%BB%B6"><strong>3.在 MHA-manager 节点上安装 manager 组件</strong></h5> 
<pre><code>cd /opt
tar zxvf mha4mysql-manager-0.57.tar.gz 
cd mha4mysql-manager-0.57/
perl Makefile.PL
make &amp;&amp; make install</code></pre> 
<p><img alt="" height="506" src="https://images2.imgbox.com/2e/c3/72SToBN8_o.png" width="1200"></p> 
<pre><code>cd /usr/local/bin/
#manager 组件安装后在/usr/local/bin 下面会生成几个工具，主要包括以下几个：
masterha_check_ssh 检查 MHA 的 SSH 配置状况
masterha_check_repl 检查 MySQL 复制状况
masterha_manger 启动 manager的脚本
masterha_check_status 检测当前 MHA 运行状态
masterha_master_monitor 检测 master 是否宕机
masterha_master_switch 控制故障转移（自动或者 手动）
masterha_conf_host 添加或删除配置的 server 信息
masterha_stop  关闭manager
 
#node 组件安装后也会在/usr/local/bin 下面会生成几个脚本（这些工具通常由 MHAManager 的脚本触发，无需人为操作）主要如下：
save_binary_logs 保存和复制 master 的二进制日志
apply_diff_relay_logs 识别差异的中继日志事件并将其差异的事件应用于其他的 slave
filter_mysqlbinlog 去除不必要的 ROLLBACK 事件（MHA 已不再使用这个工具）
purge_relay_logs 清除中继日志（不会阻塞 SQL 线程）</code></pre> 
<p><img alt="" height="232" src="https://images2.imgbox.com/22/1e/hNSMPBIy_o.png" width="1200"></p> 
<h5 id="4.%E5%9C%A8%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E9%85%8D%E7%BD%AE%E6%97%A0%E5%AF%86%E7%A0%81%E8%AE%A4%E8%AF%81"><strong>4.在所有服务器上配置无密码认证</strong></h5> 
<pre><code>#在 manager 节点上配置到所有数据库节点的无密码认证
ssh-keygen -t rsa 				#一路按回车键
ssh-copy-id 172.16.23.13
ssh-copy-id 172.16.23.15
ssh-copy-id 172.16.23.16
 
####数据库服务器之间互相导入即可####
 
#在master上
ssh-keygen -t rsa 				#一路按回车键
ssh-copy-id 172.16.23.15
ssh-copy-id 172.16.23.16
 
#在slave1上
ssh-keygen -t rsa 				#一路按回车键
ssh-copy-id 172.16.23.13
ssh-copy-id 172.16.23.16
 
#在slave2上
ssh-keygen -t rsa 				#一路按回车键
ssh-copy-id 172.16.23.13
ssh-copy-id 172.16.23.15</code></pre> 
<p><img alt="" height="765" src="https://images2.imgbox.com/a1/21/anQjPVF2_o.png" width="1200"></p> 
<p><img alt="" height="706" src="https://images2.imgbox.com/9d/77/hdRZKCmr_o.png" width="1200"></p> 
<p><img alt="" height="341" src="https://images2.imgbox.com/3b/04/l0ivYrDk_o.png" width="1200"></p> 
<h5><img alt="" height="287" src="https://images2.imgbox.com/f4/ca/dQWtr4kP_o.png" width="1200"></h5> 
<h5><img alt="" height="267" src="https://images2.imgbox.com/2b/5f/9lQYZ1C0_o.png" width="1200"></h5> 
<h5><img alt="" height="285" src="https://images2.imgbox.com/e5/74/DJ3FfIIT_o.png" width="1200"></h5> 
<h5 id="5.%E5%9C%A8manager%E8%8A%82%E7%82%B9%E4%B8%8A%E6%93%8D%E4%BD%9C"><strong>5.在manager节点上操作</strong></h5> 
<pre><code>（1）##在 manager 节点上复制相关脚本到/usr/local/bin 目录
cp -rp /opt/mha4mysql-manager-0.57/samples/scripts /usr/local/bin
 
#拷贝后会有四个执行文件
ll /usr/local/bin/scripts/
master_ip_failover  		#自动切换时 VIP 管理的脚本
master_ip_online_change 	#在线切换时 vip 的管理
power_manager 				#故障发生后关闭主机的脚本
send_report 				#因故障切换后发送报警的脚本
 
（2）##复制上述的自动切换时 VIP 管理的脚本到 /usr/local/bin 目录，这里使用master_ip_failover脚本来管理 VIP 和故障切换
cp /usr/local/bin/scripts/master_ip_failover /usr/local/bin
 
（3）##修改master_ip_failover 全部删除，添加以下内容，修改相关参数
#!/usr/bin/env perl
use strict;
use warnings FATAL =&gt; 'all';
 
use Getopt::Long;
 
my (
    $command, $orig_master_host, $orig_master_ip,$ssh_user,
    $orig_master_port, $new_master_host, $new_master_ip,$new_master_port,
    $orig_master_ssh_port,$new_master_ssh_port,$new_master_user,$new_master_password
);
 
# 这里定义的虚拟IP配置要注意，这个ip必须要与你自己的集群在同一个网段，否则无效
my $vip = '172.16.23.100/24';
my $key = '1';
# 这里的网卡名称 “ens33” 需要根据你机器的网卡名称进行修改
# 如果多台机器直接的网卡名称不统一，有两种方式，一个是改脚本，二是把网卡名称修改成统一
# 我这边实际情况是修改成统一的网卡名称
my $ssh_start_vip = "sudo /sbin/ifconfig ens33:$key $vip";
my $ssh_stop_vip = "sudo /sbin/ifconfig ens33:$key down";
my $ssh_Bcast_arp= "sudo /sbin/arping -I ens33 -c 3 -A $vip";

GetOptions(
    'command=s'          =&gt; \$command,
    'ssh_user=s'         =&gt; \$ssh_user,
    'orig_master_host=s' =&gt; \$orig_master_host,
    'orig_master_ip=s'   =&gt; \$orig_master_ip,
    'orig_master_port=i' =&gt; \$orig_master_port,
    'orig_master_ssh_port=i' =&gt; \$orig_master_ssh_port,
    'new_master_host=s'  =&gt; \$new_master_host,
    'new_master_ip=s'    =&gt; \$new_master_ip,
    'new_master_port=i'  =&gt; \$new_master_port,
    'new_master_ssh_port' =&gt; \$new_master_ssh_port,
    'new_master_user' =&gt; \$new_master_user,
    'new_master_password' =&gt; \$new_master_password
 
);
 
exit &amp;main();
 
sub main {
    $ssh_user = defined $ssh_user ? $ssh_user : 'root';
    print "\n\nIN SCRIPT TEST====$ssh_user|$ssh_stop_vip==$ssh_user|$ssh_start_vip===\n\n";
 
    if ( $command eq "stop" || $command eq "stopssh" ) {
 
        my $exit_code = 1;
        eval {
            print "Disabling the VIP on old master: $orig_master_host \n";
            &amp;stop_vip();
            $exit_code = 0;
        };
        if ($@) {
            warn "Got Error: $@\n";
            exit $exit_code;
        }
        exit $exit_code;
    }
    elsif ( $command eq "start" ) {
 
        my $exit_code = 10;
        eval {
            print "Enabling the VIP - $vip on the new master - $new_master_host \n";
            &amp;start_vip();
        &amp;start_arp();
            $exit_code = 0;
        };
        if ($@) {
            warn $@;
            exit $exit_code;
        }
        exit $exit_code;
    }
    elsif ( $command eq "status" ) {
        print "Checking the Status of the script.. OK \n";
        exit 0;
    }
    else {
        &amp;usage();
        exit 1;
    }
}
 
sub start_vip() {
    `ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`;
}
sub stop_vip() {
    `ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`;
}
 
sub start_arp() {
    `ssh $ssh_user\@$new_master_host \" $ssh_Bcast_arp \"`;
}
sub usage {
    print
    "Usage: master_ip_failover --command=start|stop|stopssh|status --ssh_user=user --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n";
}

 
4）创建 MHA 软件目录并拷贝配置文件，这里使用app1.cnf配置文件来管理 mysql 节点服务器
#创建相关目录（所有节点）
mkdir -p /opt/mysql-mha/mha-node

# manager节点
mkdir -p /opt/mysql-mha/mha

#编写配置文件
vim /opt/mysql-mha/mysql_mha.cnf
[server default]
manager_log=/opt/mysql-mha/manager.log
manager_workdir=/opt/mysql-mha/mha
master_binlog_dir=/usr/local/mysql/data
master_ip_failover_script=/usr/local/bin/master_ip_failover
master_ip_online_change_script=/usr/local/bin/master_ip_online_change
user=mha
password=123
port=3306
ping_interval=1
remote_workdir=/opt/mysql-mha/mha-node
repl_user=myslave
repl_password=123
secondary_check_script=/usr/local/bin/masterha_secondary_check -s 172.16.23.15 -s 172.16.23.16
shutdown_script=""
ssh_user=root

[server1]
hostname=172.16.23.13
port=3306

[server2]
candidate_master=1
check_repl_delay=0
hostname=172.16.23.15
port=3306

[server3]
hostname=172.16.23.16
port=3306

----------------------------------------------------------------------------------------------------------
[server default]
manager_log=/opt/mysql-mha/manager.log		#指定manager日志路径
manager_workdir=/opt/mysql-mha/mha			#指定manager工作目录
master_binlog_dir=/usr/local/mysql/data		#指定master保存binlog的位置，这里的路径要与master里配置的binlog的路径一致，以便MHA能找到
master_ip_failover_script=/usr/local/bin/master_ip_failover　　#设置自动failover时候的切换脚本，也就是上面的那个脚本
master_ip_online_change_script=/usr/local/bin/master_ip_online_change　　#设置手动切换时候的切换脚本
user=mha					#设置mha访问数据库的账号
password=manager			#设置mha访问数据库的账号密码
ping_interval=1				#设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行failover
remote_workdir=/opt/mysql-mha/mha-node		#指定mha在远程节点上的工作目录
repl_user=myslave			#设置主从复制的用户
repl_password=123			#设置主从复制的用户密码
report_script=/usr/local/send_report　　　　　#设置发生故障切换的时候发送邮件提醒
secondary_check_script=/usr/local/bin/masterha_secondary_check -s 172.16.23.15 -s 172.16.23.16	#指定检查的从服务器IP地址
shutdown_script=""			#设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机防止发生脑裂，这里没有使用）
ssh_user=root				#设置ssh的登录用户名

[server1]
hostname=172.16.23.13
port=3306

[server2]
hostname=172.16.23.15
port=3306
candidate_master=1
#设置为候选master，设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个从库不是集群中最新的slave

check_repl_delay=0
#默认情况下如果一个slave落后master 超过100M的relay logs的话，MHA将不会选择该slave作为一个新的master， 因为对于这个slave的恢复需要花费很长时间；通过设置check_repl_delay=0，MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master

[server3]
hostname=172.16.23.16
port=3306
 
（5）###在主节点开启虚拟IP
/sbin/ifconfig ens33:1 172.16.23.100/24
 
（6）##在 manager 节点上测试 ssh 无密码认证，如果正常最后会输出 successfully。如下所示
masterha_check_ssh -conf=/opt/mysql-mha/mysql_mha.cnf

 
（7）##在 manager 节点上测试 mysql 主从连接情况，最后出现 MySQL Replication Health is OK 字样说明正常。如下所示。
masterha_check_repl -conf=/opt/mysql-mha/mysql_mha.cnf

 
（8）##在 manager 节点上启动 MHA
nohup masterha_manager \
--conf=/opt/mysql-mha/mysql_mha.cnf \
--remove_dead_master_conf \
--ignore_last_failover &lt; /dev/null &gt; /var/log/mha_manager.log 2&gt;&amp;1 &amp;
 
（9）##查看 MHA 状态，可以看到当前的 master 是 Mysql1 节点。
masterha_check_status --conf=/etc/masterha/app1.cnf
 
（10）查看 MHA 日志，也以看到当前的 master 是 192.168.59.118，如下所示。
cat /var/log/masterha/app1/manager.log | grep "current master"
 
(11)##查看 Mysql1 的 VIP 地址 192.168.59.118 是否存在，这个 VIP 地址不会因为 manager 节点停止 MHA 服务而消失。
ifconfig
 
//若要关闭 manager 服务，可以使用如下命令。
masterha_stop --conf=/etc/masterha/app1.cnf
或者可以直接采用 kill 进程 ID 的方式关闭。</code></pre> 
<p><img alt="" height="621" src="https://images2.imgbox.com/ee/56/c36fX0K4_o.png" width="1200"><img alt="" height="509" src="https://images2.imgbox.com/3f/fc/ia4z2bFZ_o.png" width="1200"></p> 
<p><img alt="" height="655" src="https://images2.imgbox.com/da/41/7GILIL9F_o.png" width="1200"><img alt="" height="329" src="https://images2.imgbox.com/d3/3c/4a52WO0K_o.png" width="686"><img alt="" height="764" src="https://images2.imgbox.com/0e/11/ih5FOoQo_o.png" width="1200"></p> 
<p><img alt="" height="129" src="https://images2.imgbox.com/10/23/afMNYYHx_o.png" width="1200"><img alt="" height="59" src="https://images2.imgbox.com/52/29/HVXkuJsU_o.png" width="1185"><img alt="" height="81" src="https://images2.imgbox.com/40/bc/m4ZhCXTW_o.png" width="1200"><img alt="" height="692" src="https://images2.imgbox.com/2a/5f/O42VQkpO_o.png" width="1200"></p> 
<h4 id="3.2%20%E6%95%85%E9%9A%9C%E6%A8%A1%E6%8B%9F" style="background-color:transparent;"><strong>三. 故障模拟</strong></h4> 
<pre><code class="hljs">#在 manager 节点上监控观察日志记录
tail -f /opt/mysql-mha/manager.log

#在 Master 节点 mysql1 上停止mysql服务
systemctl stop mysqld
或
pkill -9 mysql

#正常自动切换一次后，MHA 进程会退出。HMA 会自动修改 app1.cnf 文件内容，将宕机的 mysql1 节点删除。查看 mysql2 是否接管 VIP
ifconfig

故障切换备选主库的算法：
1．一般判断从库的是从（position/GTID）判断优劣，数据有差异，最接近于master的slave，成为备选主。
2．数据一致的情况下，按照配置文件顺序，选择备选主库。
3．设定有权重（candidate_master=1），按照权重强制指定备选主。
（1）默认情况下如果一个slave落后master 100M的relay logs的话，即使有权重，也会失效。
（2）如果check_repl_delay=0的话，即使落后很多日志，也强制选择其为备选主。</code></pre> 
<p><img alt="" height="285" src="https://images2.imgbox.com/40/fe/YK0m82Xu_o.png" width="1200"><img alt="" height="607" src="https://images2.imgbox.com/12/5e/45QPAyZc_o.png" width="1200"></p> 
<p><img alt="" height="676" src="https://images2.imgbox.com/68/25/BAEhHWJM_o.png" width="1200"><img alt="" height="732" src="https://images2.imgbox.com/1d/f3/Rj7v9hXS_o.png" width="1200"></p> 
<h4 id="3.3%20%E6%95%85%E9%9A%9C%E4%BF%AE%E5%A4%8D"><strong>四. 故障修复</strong></h4> 
<pre><code class="hljs">1．修复mysql1
systemctl restart mysqld

2．修复主从
#在现主库服务器 mysql2 查看二进制文件和同步点
show master status;

#在原主库服务器 mysql1 执行同步操作
change master to master_host='172.16.23.15',master_user='myslave',master_password='123',master_log_file='mysql-bin.000001',master_log_pos=3361;

start slave;


3．在 manager 节点上修改配置文件app1.cnf（再把这个记录添加进去，因为它检测掉失效时候会自动消失）
vi    /opt/mysql-mha/mysql_mha.cnf
......
secondary_check_script=/usr/local/bin/masterha_secondary_check -s 172.16.23.13 -s 172.16.23.16
......
[server1]
hostname=172.16.23.15
port=3306

[server2]
candidate_master=1
check_repl_delay=0
hostname=172.16.23.13
port=3306

[server3]
hostname=172.16.23.16
port=3306

4．在 manager 节点上启动 MHA
nohup masterha_manager \
--conf=/opt/mysql-mha/mysql_mha.cnf \
--remove_dead_master_conf \
--ignore_last_failover &lt; /dev/null &gt; /var/log/mha_manager.log 2&gt;&amp;1 &amp;



#解决中英字不兼容报错的问题
dos2unix /usr/local/bin/master_ip_failover </code></pre> 
<p><img alt="" height="47" src="https://images2.imgbox.com/9b/01/fInn47Ud_o.png" width="1042"></p> 
<p><strong>修复主从</strong></p> 
<p><img alt="" height="497" src="https://images2.imgbox.com/04/20/ACLwsaAd_o.png" width="1200"><strong>在原主库服务器 mysql1 执行同步操作</strong><img alt="" height="131" src="https://images2.imgbox.com/36/fc/VpBrAswG_o.png" width="1200"><img alt="" height="517" src="https://images2.imgbox.com/d6/51/rRi3Zi3Y_o.png" width="1200"></p> 
<p><strong>在 manager 节点上修改配置文件app1.cnf（再把这个记录添加进去，因为它检测掉失效时候会自动消失）</strong></p> 
<p><img alt="" height="715" src="https://images2.imgbox.com/19/c3/iy0T3OB3_o.png" width="1200"></p> 
<p><strong>在 manager 节点上启动 MHA</strong></p> 
<p><img alt="" height="72" src="https://images2.imgbox.com/a6/af/Bqh2gecQ_o.png" width="1200"></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/60118c6569ac3f065a2feaf7fd394d95/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">leetcode：908. 最小差值 I</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/37a760cac01209f09a16cc3ac918a5fd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">英文诗歌里是如何表达“我命由我不由天”这句话的？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>