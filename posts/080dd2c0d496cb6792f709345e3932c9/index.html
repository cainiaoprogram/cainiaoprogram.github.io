<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Postgres中恢复删除的表数据 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Postgres中恢复删除的表数据" />
<meta property="og:description" content="参考文档：
pg9的文档：
http://postgres.cn/docs/9.6/app-pgresetxlog.html
http://postgres.cn/docs/9.6/pgxlogdump.html
pg10的文档：
http://postgres.cn/docs/10/pgwaldump.html
http://postgres.cn/docs/10/app-pgresetwal.html
-- 测试环境，PG9.4. 手头上电脑上有2年前的pg9，顺便测试下。如果是pg10及以上版本，则一些函数会不一样。
[postgres@redhat762100 pg_xlog]$ pg_config | grep VERSION VERSION = PostgreSQL 9.4.23 [postgres@redhat762100 pg_xlog]$ 会用到查询pg的日志信息的一些函数，这些函数在不同的版本中是不一样的。
-- 10之前写法
select pg_current_xlog_location(), pg_xlogfile_name(pg_current_xlog_location()), pg_xlogfile_name_offset(pg_current_xlog_location()); -- 10 以后写法
select pg_current_wal_lsn(), pg_walfile_name(pg_current_wal_lsn()), pg_walfile_name_offset(pg_current_wal_lsn()); -- 插入5行数据
mydb=# create table t1 (id int,name text); CREATE TABLE mydb=# insert into t1 values(1,&#39;aa&#39;); INSERT 0 1 mydb=# insert into t1 values (2,&#39;bb&#39;); INSERT 0 1 mydb=# insert into t1 values(3,&#39;cc&#39;); INSERT 0 1 mydb=# insert into t1 values(4,&#39;dd&#39;); INSERT 0 1 mydb=# insert into t1 values(5,&#39;ee&#39;); INSERT 0 1 mydb=# select * from t1; id | name ----&#43;------ 1 | aa 2 | bb 3 | cc 4 | dd 5 | ee (5 rows) mydb=# -- 将ID=4的记录删除掉" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/080dd2c0d496cb6792f709345e3932c9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-30T15:56:16+08:00" />
<meta property="article:modified_time" content="2021-09-30T15:56:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Postgres中恢复删除的表数据</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>参考文档：<br> pg9的文档：<br> http://postgres.cn/docs/9.6/app-pgresetxlog.html<br> http://postgres.cn/docs/9.6/pgxlogdump.html<br> pg10的文档：<br> http://postgres.cn/docs/10/pgwaldump.html<br> http://postgres.cn/docs/10/app-pgresetwal.html</p> 
<p>-- 测试环境，PG9.4. 手头上电脑上有2年前的pg9，顺便测试下。如果是pg10及以上版本，则一些函数会不一样。</p> 
<pre><code>[postgres@redhat762100 pg_xlog]$ pg_config | grep VERSION
VERSION = PostgreSQL 9.4.23
[postgres@redhat762100 pg_xlog]$ </code></pre> 
<p>会用到查询pg的日志信息的一些函数，这些函数在不同的版本中是不一样的。</p> 
<p>-- 10之前写法</p> 
<pre><code>select pg_current_xlog_location(),
pg_xlogfile_name(pg_current_xlog_location()),
pg_xlogfile_name_offset(pg_current_xlog_location());</code></pre> 
<p>-- 10 以后写法</p> 
<pre><code>select pg_current_wal_lsn(),
pg_walfile_name(pg_current_wal_lsn()),
pg_walfile_name_offset(pg_current_wal_lsn());</code></pre> 
<p>-- 插入5行数据</p> 
<pre><code>mydb=# create table t1 (id int,name text);
CREATE TABLE
mydb=# insert into t1 values(1,'aa');
INSERT 0 1
mydb=# insert into t1 values (2,'bb');
INSERT 0 1
mydb=# insert into t1 values(3,'cc');
INSERT 0 1
mydb=# insert into t1 values(4,'dd');
INSERT 0 1
mydb=# insert into t1 values(5,'ee');
INSERT 0 1
mydb=# select * from t1;
 id | name 
----+------
  1 | aa
  2 | bb
  3 | cc
  4 | dd
  5 | ee
(5 rows)

mydb=# </code></pre> 
<p>-- 将ID=4的记录删除掉</p> 
<pre><code>mydb=# delete from t1 where id =4;
DELETE 1
mydb=#</code></pre> 
<p>-- 查看此时的xlog的信息</p> 
<pre><code>mydb=# select pg_current_xlog_location(),
mydb-# pg_xlogfile_name(pg_current_xlog_location()),
mydb-# pg_xlogfile_name_offset(pg_current_xlog_location());
 pg_current_xlog_location |     pg_xlogfile_name     |      pg_xlogfile_name_offset      
--------------------------+--------------------------+-----------------------------------
 0/A0CF5C8                | 00000001000000000000000A | (00000001000000000000000A,849352)
(1 row)

mydb=# </code></pre> 
<p>-- pg_xlogdump出日志中的信息，这里面可以看到insert日期，delete日期 。delete操作对应的事务id是108532</p> 
<pre><code>rmgr: Transaction len (rec/tot):     12/    44, tx:     108526, lsn: 0/0A0CF2D0, prev 0/0A0CF280, bkp: 0000, desc: commit: 2021-09-30 
15:07:57.784808 CST
rmgr: Heap        len (rec/tot):     34/    66, tx:     108527, lsn: 0/0A0CF300, prev 0/0A0CF2D0, bkp: 0000, desc: insert(init): rel 1
663/16393/32871; tid 0/1
rmgr: Transaction len (rec/tot):     12/    44, tx:     108527, lsn: 0/0A0CF348, prev 0/0A0CF300, bkp: 0000, desc: commit: 2021-09-30 
15:08:09.698156 CST
rmgr: Heap        len (rec/tot):     34/    66, tx:     108528, lsn: 0/0A0CF378, prev 0/0A0CF348, bkp: 0000, desc: insert: rel 1663/16
393/32871; tid 0/2
rmgr: Transaction len (rec/tot):     12/    44, tx:     108528, lsn: 0/0A0CF3C0, prev 0/0A0CF378, bkp: 0000, desc: commit: 2021-09-30 
15:08:18.007196 CST
rmgr: Heap        len (rec/tot):     34/    66, tx:     108529, lsn: 0/0A0CF3F0, prev 0/0A0CF3C0, bkp: 0000, desc: insert: rel 1663/16
393/32871; tid 0/3
rmgr: Transaction len (rec/tot):     12/    44, tx:     108529, lsn: 0/0A0CF438, prev 0/0A0CF3F0, bkp: 0000, desc: commit: 2021-09-30 
15:08:25.447322 CST
rmgr: Heap        len (rec/tot):     34/    66, tx:     108530, lsn: 0/0A0CF468, prev 0/0A0CF438, bkp: 0000, desc: insert: rel 1663/16
393/32871; tid 0/4
rmgr: Transaction len (rec/tot):     12/    44, tx:     108530, lsn: 0/0A0CF4B0, prev 0/0A0CF468, bkp: 0000, desc: commit: 2021-09-30 
15:08:34.940943 CST
rmgr: Heap        len (rec/tot):     34/    66, tx:     108531, lsn: 0/0A0CF4E0, prev 0/0A0CF4B0, bkp: 0000, desc: insert: rel 1663/16
393/32871; tid 0/5
rmgr: Transaction len (rec/tot):     12/    44, tx:     108531, lsn: 0/0A0CF528, prev 0/0A0CF4E0, bkp: 0000, desc: commit: 2021-09-30 
15:08:45.259812 CST
rmgr: Heap        len (rec/tot):     26/    58, tx:     108532, lsn: 0/0A0CF558, prev 0/0A0CF528, bkp: 0000, desc: delete: rel 1663/16
393/32871; tid 0/4 KEYS_UPDATED 
rmgr: Transaction len (rec/tot):     12/    44, tx:     108532, lsn: 0/0A0CF598, prev 0/0A0CF558, bkp: 0000, desc: commit: 2021-09-30 
15:09:42.075268 CST
rmgr: XLOG        len (rec/tot):     72/   104, tx:          0, lsn: 0/0A0CF5C8, prev 0/0A0CF598, bkp: 0000, desc: checkpoint: redo 0/
A0CF5C8; tli 1; prev tli 1; fpw true; xid 0/108533; oid 41063; multi 1; offset 0; oldest xid 1884 in DB 1; oldest multi 1 in DB 1; old
est running xid 0; online</code></pre> 
<p>-- 关闭数据库</p> 
<pre><code>[postgres@redhat762100 pg_xlog]$ pg_ctl stop -m fast
waiting for server to shut down.... done
server stopped
[postgres@redhat762100 pg_xlog]$</code></pre> 
<p>-- 通过事务id 108532 来重置xlog ，注意这里没有-D，具体用法可以参考下help</p> 
<pre><code>pg_resetxlog -x 108532  /pgdata/94/data
[postgres@redhat762100 pg_xlog]$ pg_resetxlog -x 108532  /pgdata/94/data
Transaction log reset
[postgres@redhat762100 pg_xlog]$ </code></pre> 
<p>-- 启动数据库，查看</p> 
<pre><code>[postgres@redhat762100 pg_xlog]$ pg_ctl start -D /pgdata/94/data
server starting
[postgres@redhat762100 pg_xlog]$ LOG:  redirecting log output to logging collector process
HINT:  Future log output will appear in directory "pg_log".</code></pre> 
<p>-- 查看数据，发现被删除的id=4的数据，回来了。</p> 
<pre><code>mydb=# \c mydb
You are now connected to database "mydb" as user "postgres".
mydb=# 
mydb=# 
mydb=# select * from t1;
 id | name 
----+------
  1 | aa
  2 | bb
  3 | cc
  4 | dd
  5 | ee
(5 rows)

mydb=# </code></pre> 
<p>END</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a5d7681dcd6d3175465f4532d93cdc8d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">首届长三角青少年人工智能擂台赛全记录（YOLOv5&#43;Win10&#43;Anaconda&#43;Pycharm&#43;ModelArts）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fc432f9495df6d772bed99cfb05a487d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">梯度消失与梯度爆炸</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>