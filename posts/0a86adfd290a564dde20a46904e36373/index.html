<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>超融合时序数据库YMatrixDB与PostGIS案例 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="超融合时序数据库YMatrixDB与PostGIS案例" />
<meta property="og:description" content="目录
什么是PostGIS
PostGIS的特点
PostGIS 基础知识
OGC的WKB和WKT格式
插入数据实例
EWKT、EWKB和Canonical格式
插入数据实例
SQL-MM格式
常几何类型和函数
常用操作符
常用操作函数
OGC标准函数
管理函数
几何对象关系函数
几何对象处理函数
几何对象存取函数
类型转换函数
PostGIS 系统表查看
spatial_ref_sys表
geometry_columns表
PostGIS 两个重要的坐标体系
YMatrixDB 安装PostGIS
PostGIS 安装
在YMatrixDB上安装postgis扩展
YMatrixDB的PostGIS使用案例
计算两点之间的距离
范围内的点查找
弯曲的几何实体案例
YMatrixDB的PostGIS车联网数据案例
车联网数据下载
表创建
数据加载
数据处理
出租车数据分析
出租车行程统计
费率分布
机场行程分析
附近出租车
YMatrix适用于各种规模设备的数据融合与物联网时序应用场景，本案例以具体的案例来说明YMatrix在PostGIS中的数据加载、处理和分析的能力以及时空数据的具体使用方法，首先我们先了解下PostGIS，然后再分享几个PostGIS在YMatrixDB的案例。
什么是PostGIS PostGIS是一个空间数据库，空间数据库像存储和操作数据库中其他任何对象一样去存储和操作空间对象。空间数据库将空间数据和对象关系数据库（Object Relational database）完全集成在一起。实现从以GIS为中心向以数据库为中心的转变。PostGIS 实现了点、线、面、多点、多线、多面等的SQL实现参考。
PostGIS的特点 PostGIS 具有强大的功能，具有以下的特点PostGIS支持空间数据类型，包括点（POINT）、线（LINESTRING）、面（POLYGON）、多点 （MULTIPOINT）、多线（MULTILINESTRING）、多面（MULTIPOLYGON）和几何集合 （GEOMETRYCOLLECTION）等。支持对象表达方法，比如WKT和WKB。提供简单的空间分析函数，同时也提供其他一些具有复杂分析功能的函数。支持所有的数据存取和构造方法，如GeomFromText()、AsBinary()，以及GeometryN()等。对于元数据的支持，如GEOMETRY_COLUMNS和SPATIAL_REF_SYS。同时也支持AddGeometryColumn和DropGeometryColumn函数等。能对矢量数据和栅格数据做处理，能通过 SQL 调用栅格、矢量数据的投影函数。能通过多种工具导入多种标准的栅格数据，同时能通过 SQL 语句将栅格渲染至各种格式GeoTiff、PNG、JPG、NetCDF 等。能通过 SQL 调用 KML、GML、GeoJSON、GeoHash、WKT 等标准文本类型的矢量数据的函数。矢量或栅格操作函数，包括按区域伸缩栅格像元值、局域统计、按矢量图形裁剪栅格、矢量化栅格等。 PostGIS 基础知识 OGC的WKB和WKT格式 OGC定义了两种描述几何对象的格式，分别是WKB（Well-Known Binary）和WKT（Well-Known Text）格式。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0a86adfd290a564dde20a46904e36373/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-02T17:40:45+08:00" />
<meta property="article:modified_time" content="2022-12-02T17:40:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">超融合时序数据库YMatrixDB与PostGIS案例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E4%BB%80%E4%B9%88%E6%98%AFPostGIS-toc" style="margin-left:0px;"><a href="#%E4%BB%80%E4%B9%88%E6%98%AFPostGIS" rel="nofollow">什么是PostGIS</a></p> 
<p id="PostGIS%E7%9A%84%E7%89%B9%E7%82%B9-toc" style="margin-left:0px;"><a href="#PostGIS%E7%9A%84%E7%89%B9%E7%82%B9" rel="nofollow">PostGIS的特点</a></p> 
<p id="PostGIS-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-toc" style="margin-left:0px;"><a href="#PostGIS-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86" rel="nofollow">PostGIS 基础知识</a></p> 
<p id="OGC%E7%9A%84WKB%E5%92%8CWKT%E6%A0%BC%E5%BC%8F-toc" style="margin-left:40px;"><a href="#OGC%E7%9A%84WKB%E5%92%8CWKT%E6%A0%BC%E5%BC%8F" rel="nofollow">OGC的WKB和WKT格式</a></p> 
<p id="%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E5%AE%9E%E4%BE%8B-toc" style="margin-left:40px;"><a href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E5%AE%9E%E4%BE%8B" rel="nofollow">插入数据实例</a></p> 
<p id="EWKT%E3%80%81EWKB%E5%92%8CCanonical%E6%A0%BC%E5%BC%8F-toc" style="margin-left:40px;"><a href="#EWKT%E3%80%81EWKB%E5%92%8CCanonical%E6%A0%BC%E5%BC%8F" rel="nofollow">EWKT、EWKB和Canonical格式</a></p> 
<p id="%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E5%AE%9E%E4%BE%8B-toc" style="margin-left:80px;"><a href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E5%AE%9E%E4%BE%8B" rel="nofollow">插入数据实例</a></p> 
<p id="SQL-MM%E6%A0%BC%E5%BC%8F-toc" style="margin-left:40px;"><a href="#SQL-MM%E6%A0%BC%E5%BC%8F" rel="nofollow">SQL-MM格式</a></p> 
<p id="%E5%B8%B8%E5%87%A0%E4%BD%95%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%87%BD%E6%95%B0-toc" style="margin-left:40px;"><a href="#%E5%B8%B8%E5%87%A0%E4%BD%95%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%87%BD%E6%95%B0" rel="nofollow">常几何类型和函数</a></p> 
<p id="%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E7%AC%A6-toc" style="margin-left:40px;"><a href="#%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E7%AC%A6" rel="nofollow">常用操作符</a></p> 
<p id="%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0-toc" style="margin-left:40px;"><a href="#%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0" rel="nofollow">常用操作函数</a></p> 
<p id="OGC%E6%A0%87%E5%87%86%E5%87%BD%E6%95%B0-toc" style="margin-left:40px;"><a href="#OGC%E6%A0%87%E5%87%86%E5%87%BD%E6%95%B0" rel="nofollow">OGC标准函数</a></p> 
<p id="%E7%AE%A1%E7%90%86%E5%87%BD%E6%95%B0-toc" style="margin-left:80px;"><a href="#%E7%AE%A1%E7%90%86%E5%87%BD%E6%95%B0" rel="nofollow">管理函数</a></p> 
<p id="%E5%87%A0%E4%BD%95%E5%AF%B9%E8%B1%A1%E5%85%B3%E7%B3%BB%E5%87%BD%E6%95%B0-toc" style="margin-left:80px;"><a href="#%E5%87%A0%E4%BD%95%E5%AF%B9%E8%B1%A1%E5%85%B3%E7%B3%BB%E5%87%BD%E6%95%B0" rel="nofollow">几何对象关系函数</a></p> 
<p id="%E5%87%A0%E4%BD%95%E5%AF%B9%E8%B1%A1%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0-toc" style="margin-left:80px;"><a href="#%E5%87%A0%E4%BD%95%E5%AF%B9%E8%B1%A1%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0" rel="nofollow">几何对象处理函数</a></p> 
<p id="%E5%87%A0%E4%BD%95%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%8F%96%E5%87%BD%E6%95%B0-toc" style="margin-left:80px;"><a href="#%E5%87%A0%E4%BD%95%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%8F%96%E5%87%BD%E6%95%B0" rel="nofollow">几何对象存取函数</a></p> 
<p id="%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0-toc" style="margin-left:80px;"><a href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0" rel="nofollow">类型转换函数</a></p> 
<p id="PostGIS-%E7%B3%BB%E7%BB%9F%E8%A1%A8%E6%9F%A5%E7%9C%8B-toc" style="margin-left:0px;"><a href="#PostGIS-%E7%B3%BB%E7%BB%9F%E8%A1%A8%E6%9F%A5%E7%9C%8B" rel="nofollow">PostGIS 系统表查看</a></p> 
<p id="spatial_ref_sys%E8%A1%A8-toc" style="margin-left:40px;"><a href="#spatial_ref_sys%E8%A1%A8" rel="nofollow">spatial_ref_sys表</a></p> 
<p id="geometry_columns%E8%A1%A8-toc" style="margin-left:40px;"><a href="#geometry_columns%E8%A1%A8" rel="nofollow">geometry_columns表</a></p> 
<p id="PostGIS-%E4%B8%A4%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E5%9D%90%E6%A0%87%E4%BD%93%E7%B3%BB-toc" style="margin-left:40px;"><a href="#PostGIS-%E4%B8%A4%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E5%9D%90%E6%A0%87%E4%BD%93%E7%B3%BB" rel="nofollow">PostGIS 两个重要的坐标体系</a></p> 
<p id="YMatrixDB-%E5%AE%89%E8%A3%85PostGIS-toc" style="margin-left:0px;"><a href="#YMatrixDB-%E5%AE%89%E8%A3%85PostGIS" rel="nofollow">YMatrixDB 安装PostGIS</a></p> 
<p id="PostGIS-%E5%AE%89%E8%A3%85-toc" style="margin-left:40px;"><a href="#PostGIS-%E5%AE%89%E8%A3%85" rel="nofollow">PostGIS 安装</a></p> 
<p id="%E5%9C%A8YMatrixDB%E4%B8%8A%E5%AE%89%E8%A3%85postgis%E6%89%A9%E5%B1%95-toc" style="margin-left:40px;"><a href="#%E5%9C%A8YMatrixDB%E4%B8%8A%E5%AE%89%E8%A3%85postgis%E6%89%A9%E5%B1%95" rel="nofollow">在YMatrixDB上安装postgis扩展</a></p> 
<p id="YMatrixDB%E7%9A%84PostGIS%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-toc" style="margin-left:0px;"><a href="#YMatrixDB%E7%9A%84PostGIS%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B" rel="nofollow">YMatrixDB的PostGIS使用案例</a></p> 
<p id="%E8%AE%A1%E7%AE%97%E4%B8%A4%E7%82%B9%E4%B9%8B%E9%97%B4%E7%9A%84%E8%B7%9D%E7%A6%BB-toc" style="margin-left:40px;"><a href="#%E8%AE%A1%E7%AE%97%E4%B8%A4%E7%82%B9%E4%B9%8B%E9%97%B4%E7%9A%84%E8%B7%9D%E7%A6%BB" rel="nofollow">计算两点之间的距离</a></p> 
<p id="%E8%8C%83%E5%9B%B4%E5%86%85%E7%9A%84%E7%82%B9%E6%9F%A5%E6%89%BE-toc" style="margin-left:40px;"><a href="#%E8%8C%83%E5%9B%B4%E5%86%85%E7%9A%84%E7%82%B9%E6%9F%A5%E6%89%BE" rel="nofollow">范围内的点查找</a></p> 
<p id="%E5%BC%AF%E6%9B%B2%E7%9A%84%E5%87%A0%E4%BD%95%E5%AE%9E%E4%BD%93%E6%A1%88%E4%BE%8B-toc" style="margin-left:40px;"><a href="#%E5%BC%AF%E6%9B%B2%E7%9A%84%E5%87%A0%E4%BD%95%E5%AE%9E%E4%BD%93%E6%A1%88%E4%BE%8B" rel="nofollow">弯曲的几何实体案例</a></p> 
<p id="YMatrixDB%E7%9A%84PostGIS%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B0%E6%8D%AE%E6%A1%88%E4%BE%8B-toc" style="margin-left:0px;"><a href="#YMatrixDB%E7%9A%84PostGIS%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B0%E6%8D%AE%E6%A1%88%E4%BE%8B" rel="nofollow">YMatrixDB的PostGIS车联网数据案例</a></p> 
<p id="%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B0%E6%8D%AE%E4%B8%8B%E8%BD%BD-toc" style="margin-left:40px;"><a href="#%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B0%E6%8D%AE%E4%B8%8B%E8%BD%BD" rel="nofollow">车联网数据下载</a></p> 
<p id="%E8%A1%A8%E5%88%9B%E5%BB%BA-toc" style="margin-left:40px;"><a href="#%E8%A1%A8%E5%88%9B%E5%BB%BA" rel="nofollow">表创建</a></p> 
<p id="%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD-toc" style="margin-left:40px;"><a href="#%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD" rel="nofollow">数据加载</a></p> 
<p id="%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86-toc" style="margin-left:40px;"><a href="#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86" rel="nofollow">数据处理</a></p> 
<p id="%E5%87%BA%E7%A7%9F%E8%BD%A6%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90-toc" style="margin-left:40px;"><a href="#%E5%87%BA%E7%A7%9F%E8%BD%A6%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90" rel="nofollow">出租车数据分析</a></p> 
<p id="%E5%87%BA%E7%A7%9F%E8%BD%A6%E8%A1%8C%E7%A8%8B%E7%BB%9F%E8%AE%A1-toc" style="margin-left:80px;"><a href="#%E5%87%BA%E7%A7%9F%E8%BD%A6%E8%A1%8C%E7%A8%8B%E7%BB%9F%E8%AE%A1" rel="nofollow">出租车行程统计</a></p> 
<p id="%E8%B4%B9%E7%8E%87%E5%88%86%E5%B8%83-toc" style="margin-left:80px;"><a href="#%E8%B4%B9%E7%8E%87%E5%88%86%E5%B8%83" rel="nofollow">费率分布</a></p> 
<p id="%E6%9C%BA%E5%9C%BA%E8%A1%8C%E7%A8%8B%E5%88%86%E6%9E%90-toc" style="margin-left:40px;"><a href="#%E6%9C%BA%E5%9C%BA%E8%A1%8C%E7%A8%8B%E5%88%86%E6%9E%90" rel="nofollow">机场行程分析</a></p> 
<p id="%E9%99%84%E8%BF%91%E5%87%BA%E7%A7%9F%E8%BD%A6-toc" style="margin-left:40px;"><a href="#%E9%99%84%E8%BF%91%E5%87%BA%E7%A7%9F%E8%BD%A6" rel="nofollow">附近出租车</a></p> 
<hr id="hr-toc"> 
<p></p> 
<p>YMatrix适用于各种规模设备的数据融合与物联网时序应用场景，本案例以具体的案例来说明YMatrix在PostGIS中的数据加载、处理和分析的能力以及时空数据的具体使用方法，首先我们先了解下PostGIS，然后再分享几个PostGIS在YMatrixDB的案例。</p> 
<h2 id="%E4%BB%80%E4%B9%88%E6%98%AFPostGIS"><strong>什么是PostGIS</strong></h2> 
<p>PostGIS是一个空间<a href="https://cloud.tencent.com/solution/database?from=10680" rel="nofollow" title="数据库">数据库</a>，空间数据库像存储和操作数据库中其他任何对象一样去存储和操作空间对象。空间数据库将空间数据和对象关系数据库（Object Relational database）完全集成在一起。实现从以GIS为中心向以数据库为中心的转变。PostGIS 实现了点、线、面、多点、多线、多面等的SQL实现参考。</p> 
<h2 id="PostGIS%E7%9A%84%E7%89%B9%E7%82%B9"><strong>PostGIS的特点</strong></h2> 
<ol><li>PostGIS 具有强大的功能，具有以下的特点</li><li>PostGIS支持空间数据类型，包括点（POINT）、线（LINESTRING）、面（POLYGON）、多点 （MULTIPOINT）、多线（MULTILINESTRING）、多面（MULTIPOLYGON）和几何集合 （GEOMETRYCOLLECTION）等。</li><li>支持对象表达方法，比如WKT和WKB。</li><li>提供简单的空间分析函数，同时也提供其他一些具有复杂分析功能的函数。</li><li>支持所有的数据存取和构造方法，如GeomFromText()、AsBinary()，以及GeometryN()等。</li><li>对于元数据的支持，如GEOMETRY_COLUMNS和SPATIAL_REF_SYS。同时也支持AddGeometryColumn和DropGeometryColumn函数等。</li><li>能对矢量数据和栅格数据做处理，能通过 SQL 调用栅格、矢量数据的投影函数。</li><li>能通过多种工具导入多种标准的栅格数据，同时能通过 SQL 语句将栅格渲染至各种格式GeoTiff、PNG、JPG、NetCDF 等。</li><li>能通过 SQL 调用 KML、GML、GeoJSON、GeoHash、WKT 等标准文本类型的矢量数据的函数。</li><li>矢量或栅格操作函数，包括按区域伸缩栅格像元值、局域统计、按矢量图形裁剪栅格、矢量化栅格等。</li></ol> 
<h2 id="PostGIS-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><strong>PostGIS 基础知识</strong></h2> 
<h3 id="OGC%E7%9A%84WKB%E5%92%8CWKT%E6%A0%BC%E5%BC%8F"><strong>OGC的WKB和WKT格式</strong></h3> 
<p>OGC定义了两种描述几何对象的格式，分别是WKB（Well-Known Binary）和WKT（Well-Known Text）格式。</p> 
<table><thead><tr><th style="width:110px;"> <p>几何要素</p> </th><th style="width:578px;"> <p>WKT格式</p> </th></tr></thead><tbody><tr><td style="width:110px;"> <p>点</p> </td><td style="width:578px;"> <p>POINT(0 0)</p> </td></tr><tr><td style="width:110px;"> <p>线</p> </td><td style="width:578px;"> <p>LINESTRING(0 0,1 1,1 2)</p> </td></tr><tr><td style="width:110px;"> <p>面</p> </td><td style="width:578px;"> <p>POLYGON((0 0,4 0,4 4,0 4,0 0),(1 1, 2 1, 2 2, 1 2,1 1))</p> </td></tr><tr><td style="width:110px;"> <p>多点</p> </td><td style="width:578px;"> <p>MULTIPOINT(0 0,1 2)</p> </td></tr><tr><td style="width:110px;"> <p>多线</p> </td><td style="width:578px;"> <p>MULTILINESTRING((0 0,1 1,1 2),(2 3,3 2,5 4))</p> </td></tr><tr><td style="width:110px;"> <p>多面</p> </td><td style="width:578px;"> <p>MULTIPOLYGON(((0 0,4 0,4 4,0 4,0 0),(1 1,2 1,2 2,1 2,1 1)), ((-1 -1,-1 -2,-2 -2,-2 -1,-1 -1)))</p> </td></tr><tr><td style="width:110px;"> <p>几何集合</p> </td><td style="width:578px;"> <p>GEOMETRYCOLLECTION(POINT(2 3),LINESTRING((2 3,3 4)))</p> </td></tr></tbody></table> 
<h3 id="%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E5%AE%9E%E4%BE%8B"><strong>插入数据实例</strong></h3> 
<h3 id="EWKT%E3%80%81EWKB%E5%92%8CCanonical%E6%A0%BC%E5%BC%8F"><strong>EWKT、EWKB和Canonical格式</strong></h3> 
<p>EWKT和EWKB相比OGC WKT和WKB格式主要的扩展有3DZ、3DM、4D坐标和内嵌空间参考支持。</p> 
<table><thead><tr><th> <p>几何类型</p> </th><th> <p>格式</p> </th></tr></thead><tbody><tr><td> <p>3D点</p> </td><td> <p>POINT(0 0 0)</p> </td></tr><tr><td> <p>内嵌空间参考的点</p> </td><td> <p>SRID=32632;POINT(0 0)</p> </td></tr><tr><td> <p>带M值的点</p> </td><td> <p>POINTM(0 0 0)</p> </td></tr><tr><td> <p>带M值的3D点</p> </td><td> <p>POINT(0 0 0 0)</p> </td></tr><tr><td> <p>内嵌空间参考的带M值的多点</p> </td><td> <p>SRID=4326;MULTIPOINTM(0 0 0,1 2 1)</p> </td></tr></tbody></table> 
<h4><strong>插入数据实例</strong></h4> 
<pre><code class="hljs">INSERT INTO table (SHAPE,NAME) VALUES (GeomFromText('POINT(116.39 39.9)', 4326), '北京');</code></pre> 
<h3 id="SQL-MM%E6%A0%BC%E5%BC%8F"><strong>SQL-MM格式</strong></h3> 
<p>SQL-MM格式定义了一些插值曲线，这些插值曲线和EWKT有点类似，也支持3DZ、3DM、4D坐标，但是不支持嵌入空间参考。</p> 
<table><thead><tr><th style="width:130px;"> <p>几何类型</p> </th><th style="width:558px;"> <p>格式</p> </th></tr></thead><tbody><tr><td style="width:130px;"> <p>插值圆弧</p> </td><td style="width:558px;"> <p>CIRCULARSTRING(0 0, 1 1, 1 0)</p> </td></tr><tr><td style="width:130px;"> <p>插值复合曲线</p> </td><td style="width:558px;"> <p>COMPOUNDCURVE(CIRCULARSTRING(0 0, 1 1, 1 0),(1 0, 0 1))</p> </td></tr><tr><td style="width:130px;"> <p>曲线多边形</p> </td><td style="width:558px;"> <p>CURVEPOLYGON(CIRCULARSTRING(0 0, 4 0, 4 4, 0 4, 0 0),(1 1, 3 3, 3 1, 1 1))</p> </td></tr><tr><td style="width:130px;"> <p>多曲线</p> </td><td style="width:558px;"> <p>MULTICURVE((0 0, 5 5),CIRCULARSTRING(4 0, 4 4, 8 4))</p> </td></tr><tr><td style="width:130px;"> <p>多曲面</p> </td><td style="width:558px;"> <p>MULTISURFACE(CURVEPOLYGON(CIRCULARSTRING(0 0, 4 0, 4 4, 0 4, 0 0),(1 1, 3 3, 3 1, 1 1)),((10 10, 14 12, 11 10, 10 10),(11 11, 11.5 11, 11 11.5, 11 11)))</p> </td></tr></tbody></table> 
<h3 id="%E5%B8%B8%E5%87%A0%E4%BD%95%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%87%BD%E6%95%B0"><strong>常几何类型和函数</strong></h3> 
<table><thead><tr><th> <p>名字</p> </th><th> <p>存储空间</p> </th><th> <p>描述</p> </th><th> <p>表现形式</p> </th></tr></thead><tbody><tr><td> <p>point</p> </td><td> <p>16字节</p> </td><td> <p>平面上的点</p> </td><td> <p>(x,y)</p> </td></tr><tr><td> <p>line</p> </td><td> <p>32字节</p> </td><td> <p>直线</p> </td><td> <p>{A,B,C}</p> </td></tr><tr><td> <p>lseg</p> </td><td> <p>32字节</p> </td><td> <p>线段</p> </td><td> <p>((x1,y1),(x2,y2))</p> </td></tr><tr><td> <p>box</p> </td><td> <p>32字节</p> </td><td> <p>矩形</p> </td><td> <p>((x1,y1),(x2,y2))</p> </td></tr><tr><td> <p>path</p> </td><td> <p>16+16n字节</p> </td><td> <p>闭合路径</p> </td><td> <p>((x1,y1),…)</p> </td></tr><tr><td> <p>path</p> </td><td> <p>16+16n字节</p> </td><td> <p>开放路径</p> </td><td> <p>[(x1,y1),…]</p> </td></tr><tr><td> <p>polygon</p> </td><td> <p>40+16n字节</p> </td><td> <p>多边形</p> </td><td> <p>((x1,y1),…)</p> </td></tr><tr><td> <p>circle</p> </td><td> <p>24字节</p> </td><td> <p>圆</p> </td><td> <p>&lt;(x,y),r&gt;</p> </td></tr></tbody></table> 
<p>操作实例</p> 
<pre><code class="hljs">--  点
point(0 0)

-- 线
linestring(0 0,1 1,1 2)

-- 面
polygon((0 0,4 0,4 4,0 4,0 0),(1 1, 2 1, 2 2, 1 2,1 1))

-- 多点
multipoint((0 0),(1 2))

-- 多线
multilinestring((0 0,1 1,1 2),(2 3,3 2,5 4))

-- 多面
multipolygon(((0 0,4 0,4 4,0 4,0 0),(1 1,2 1,2 2,1 2,1 1)), ((-1 -1,-1 -2,-2 -2,-2 -1,-1 -1))) 

-- 几何集合
geometrycollection(point(2 3),linestring(2 3,3 4))</code></pre> 
<p></p> 
<h3 id="%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E7%AC%A6"><strong>常用操作符</strong></h3> 
<table><thead><tr><th> <p>操作符</p> </th><th> <p>描述</p> </th><th> <p>示例</p> </th><th> <p>结果</p> </th></tr></thead><tbody><tr><td> <p>+</p> </td><td> <p>平移</p> </td><td> <p>select box '((0,0),(1,1))' + point '(2.0,0)';</p> </td><td> <p>(3,1),(2,0)</p> </td></tr><tr><td> <p>–</p> </td><td> <p>平移</p> </td><td> <p>select box '((0,0),(1,1))' – point '(2.0,0)';</p> </td><td> <p>(-1,1),(-2,0)</p> </td></tr><tr><td> <p>*</p> </td><td> <p>伸缩/旋转</p> </td><td> <p>select box '((0,0),(1,1))' * point '(2.0,0)';</p> </td><td> <p>(2,2),(0,0)</p> </td></tr><tr><td> <p>/</p> </td><td> <p>伸缩/旋转</p> </td><td> <p>select box '((0,0),(2,2))' / point '(2.0,0)';</p> </td><td> <p>(1,1),(0,0)</p> </td></tr><tr><td> <p>#</p> </td><td> <p>交点或者交面</p> </td><td> <p>select box'((1,-1),(-1,1))' # box'((1,1),(-1,-1))';</p> </td><td> <p>(1,1),(-1,-1)</p> </td></tr><tr><td> <p>#</p> </td><td> <p>path或polygon的顶点数</p> </td><td> <p>select #path'((1,1),(2,2),(2,1))';</p> </td><td> <p>3</p> </td></tr><tr><td> <p>@-@</p> </td><td> <p>长度或周长</p> </td><td> <p>select @-@ path'((1,1),(2,2),(2,1))';</p> </td><td> <p>3.414213562</p> </td></tr><tr><td> <p>@@</p> </td><td> <p>中心</p> </td><td> <p>select @@ circle'&lt;(0,0),1&gt;';</p> </td><td> <p>(0,0)</p> </td></tr><tr><td> <p>##</p> </td><td> <p>第一个操作数和第二个操作数的最近点</p> </td><td> <p>select point '(0,0)' ## lseg '((2,0),(0,2))';</p> </td><td> <p>(1,1)</p> </td></tr><tr><td> <p>&lt;-&gt;</p> </td><td> <p>间距</p> </td><td> <p>select circle '&lt;(0,0),1&gt;' &lt;-&gt; circle '&lt;(5,0),1&gt;';</p> </td><td> <p>3</p> </td></tr><tr><td> <p>&amp;&amp;</p> </td><td> <p>是否有重叠</p> </td><td> <p>select box '((0,0),(1,1))' &amp;&amp; box '((0,0),(2,2))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>&lt;&lt;</p> </td><td> <p>是否严格在左</p> </td><td> <p>select circle '((0,0),1)' &lt;&lt; circle '((5,0),1)';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>&gt;&gt;</p> </td><td> <p>是否严格在右</p> </td><td> <p>select circle '((0,0),1)' &gt;&gt; circle '((5,0),1)';</p> </td><td> <p>f</p> </td></tr><tr><td> <p>&amp;&lt;</p> </td><td> <p>是否没有延伸到右边</p> </td><td> <p>select box '((0,0),(1,1))' &amp;&lt; box '((0,0),(2,2))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>&amp;&gt;</p> </td><td> <p>是否没有延伸到左边</p> </td><td> <p>select box '((0,0),(3,3))' &amp;&gt; box '((0,0),(2,2))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>&lt;&lt;|</p> </td><td> <p>是否严格在下</p> </td><td> <p>select box '((0,0),(3,3))' &lt;&lt;| box '((3,4),(5,5))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>|&gt;&gt;</p> </td><td> <p>是否严格在上</p> </td><td> <p>select box '((3,4),(5,5))' |&gt;&gt; box '((0,0),(3,3))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>&amp;&lt;|</p> </td><td> <p>是否没有延伸到上面</p> </td><td> <p>select box '((0,0),(1,1))' &amp;&lt;| box '((0,0),(2,2))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>|&amp;&gt;</p> </td><td> <p>是否没有延伸到下面</p> </td><td> <p>select box '((0,0),(3,3))' |&amp;&gt; box '((0,0),(2,2))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>&lt;^</p> </td><td> <p>是否低于（允许接触）</p> </td><td> <p>select box '((0,0),(3,3))' &lt;^ box '((3,3),(4,4))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>&gt;^</p> </td><td> <p>是否高于（允许接触）</p> </td><td> <p>select box '((0,0),(3,3))' &gt;^ box '((3,3),(4,4))';</p> </td><td> <p>f</p> </td></tr><tr><td> <p>?#</p> </td><td> <p>是否相交</p> </td><td> <p>select lseg '((-1,0),(1,0))' ?# box '((-2,-2),(2,2))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>?-</p> </td><td> <p>是否水平对齐</p> </td><td> <p>select ?- lseg '((-1,1),(1,1))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>?-</p> </td><td> <p>两边图形是否水平对齐</p> </td><td> <p>select point '(1,0)' ?- point '(0,0)';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>?|</p> </td><td> <p>是否竖直对齐</p> </td><td> <p>select ?| lseg '((-1,0),(1,0))';</p> </td><td> <p>f</p> </td></tr><tr><td> <p>?|</p> </td><td> <p>两边图形是否竖直对齐</p> </td><td> <p>select point '(0,1)' ?| point '(0,0)';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>?-|</p> </td><td> <p>是否垂直</p> </td><td> <p>select lseg '((0,0),(0,1))' ?-| lseg '((0,0),(1,0))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>?||</p> </td><td> <p>是否平行</p> </td><td> <p>select lseg '((-1,0),(1,0))' ?|| lseg '((-1,2),(1,2))';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>@&gt;</p> </td><td> <p>是否包含</p> </td><td> <p>select circle '((0,0),2)' @&gt; point '(1,1)';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>&lt;@</p> </td><td> <p>是否包含于或在图形上</p> </td><td> <p>select point '(1,1)' &lt;@ circle '((0,0),2)';</p> </td><td> <p>t</p> </td></tr><tr><td> <p>~=</p> </td><td> <p>是否相同</p> </td><td> <p>select polygon '((0,0),(1,1))' ~= polygon '((1,1),(0,0))';</p> </td><td> <p>t</p> </td></tr></tbody></table> 
<h3 id="%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0"><strong>常用操作函数</strong></h3> 
<table><thead><tr><th> <p>函数</p> </th><th> <p>返回值</p> </th><th> <p>描述</p> </th><th> <p>示例</p> </th><th> <p>结果</p> </th></tr></thead><tbody><tr><td> <p>area(object)</p> </td><td> <p>double precision</p> </td><td> <p>面积</p> </td><td> <p>select area(circle'((0,0),1)');</p> </td><td> <p>3.141592654</p> </td></tr><tr><td> <p>center(object)</p> </td><td> <p>point</p> </td><td> <p>中心</p> </td><td> <p>select center(box'(0,0),(1,1)');</p> </td><td> <p>(0.5,0.5)</p> </td></tr><tr><td> <p>diameter(circle)</p> </td><td> <p>double precision</p> </td><td> <p>圆周长</p> </td><td> <p>select diameter(circle '((0,0),2.0)');</p> </td><td> <p>4</p> </td></tr><tr><td> <p>height(box)</p> </td><td> <p>double precision</p> </td><td> <p>矩形竖直高度</p> </td><td> <p>select height(box '((0,0),(1,1))');</p> </td><td> <p>1</p> </td></tr><tr><td> <p>isclosed(path)</p> </td><td> <p>boolean</p> </td><td> <p>是否为闭合路径</p> </td><td> <p>select isclosed(path '((0,0),(1,1),(2,0))');</p> </td><td> <p>t</p> </td></tr><tr><td> <p>isopen(path)</p> </td><td> <p>boolean</p> </td><td> <p>是否为开放路径</p> </td><td> <p>select isopen(path '[(0,0),(1,1),(2,0)]');</p> </td><td> <p>t</p> </td></tr><tr><td> <p>length(object)</p> </td><td> <p>double precision</p> </td><td> <p>长度</p> </td><td> <p>select length(path '((-1,0),(1,0))');</p> </td><td> <p>4</p> </td></tr><tr><td> <p>npoints(path)</p> </td><td> <p>int</p> </td><td> <p>path中的顶点数</p> </td><td> <p>select npoints(path '[(0,0),(1,1),(2,0)]');</p> </td><td> <p>3</p> </td></tr><tr><td> <p>npoints(polygon)</p> </td><td> <p>int</p> </td><td> <p>多边形的顶点数</p> </td><td> <p>select npoints(polygon '((1,1),(0,0))');</p> </td><td> <p>2</p> </td></tr><tr><td> <p>pclose(path)</p> </td><td> <p>path</p> </td><td> <p>将开放path转换为闭合path</p> </td><td> <p>select pclose(path '[(0,0),(1,1),(2,0)]');</p> </td><td> <p>((0,0),(1,1),(2,0))</p> </td></tr><tr><td> <p>popen(path)</p> </td><td> <p>path</p> </td><td> <p>将闭合path转换为开放path</p> </td><td> <p>select popen(path '((0,0),(1,1),(2,0))');</p> </td><td> <p>[(0,0),(1,1),(2,0)]</p> </td></tr><tr><td> <p>radius(circle)</p> </td><td> <p>double precision</p> </td><td> <p>圆半径</p> </td><td> <p>select radius(circle '((0,0),2.0)');</p> </td><td> <p>2</p> </td></tr><tr><td> <p>width(box)</p> </td><td> <p>double precision</p> </td><td> <p>矩形的水平长度</p> </td><td> <p>select width(box '((0,0),(1,1))');</p> </td><td> <p>1</p> </td></tr></tbody></table> 
<h3 id="OGC%E6%A0%87%E5%87%86%E5%87%BD%E6%95%B0"><strong>OGC标准函数</strong></h3> 
<h4 id="%E7%AE%A1%E7%90%86%E5%87%BD%E6%95%B0"><strong>管理函数</strong></h4> 
<table><thead><tr><th> <p>函数</p> </th><th> <p>说明</p> </th></tr></thead><tbody><tr><td> <p>AddGeometryColumn(, , , , , )</p> </td><td> <p>添加几何字段</p> </td></tr><tr><td> <p>DropGeometryColumn(, , )</p> </td><td> <p>删除几何字段</p> </td></tr><tr><td> <p>Probe_Geometry_Columns()</p> </td><td> <p>检查数据库几何字段并在geometry_columns中归档</p> </td></tr><tr><td> <p>ST_SetSRID(geometry, integer)</p> </td><td> <p>给几何对象设置空间参考（在通过一个范围做空间查询时常用）</p> </td></tr></tbody></table> 
<h4 id="%E5%87%A0%E4%BD%95%E5%AF%B9%E8%B1%A1%E5%85%B3%E7%B3%BB%E5%87%BD%E6%95%B0"><strong>几何对象关系函数</strong></h4> 
<table><thead><tr><th> <p>函数</p> </th><th> <p>说明</p> </th></tr></thead><tbody><tr><td> <p>ST_Distance(geometry, geometry)</p> </td><td> <p>获取两个几何对象间的距离</p> </td></tr><tr><td> <p>ST_DWithin(geometry, geometry, float)</p> </td><td> <p>如果两个几何对象间距离在给定值范围内，则返回TRUE</p> </td></tr><tr><td> <p>ST_Equals(geometry, geometry)</p> </td><td> <p>判断两个几何对象是否相等（比如LINESTRING(0 0, 2 2)和LINESTRING(0 0, 1 1, 2 2)是相同的几何对象）</p> </td></tr><tr><td> <p>ST_Disjoint(geometry, geometry)</p> </td><td> <p>判断两个几何对象是否分离</p> </td></tr><tr><td> <p>ST_Intersects(geometry, geometry)</p> </td><td> <p>判断两个几何对象是否相交</p> </td></tr><tr><td> <p>ST_Touches(geometry, geometry)</p> </td><td> <p>判断两个几何对象的边缘是否接触</p> </td></tr><tr><td> <p>ST_Crosses(geometry, geometry)</p> </td><td> <p>判断两个几何对象是否互相穿过</p> </td></tr><tr><td> <p>ST_Within(geometry A, geometry B)</p> </td><td> <p>判断A是否被B包含</p> </td></tr><tr><td> <p>ST_Overlaps(geometry, geometry)</p> </td><td> <p>判断两个几何对象是否是重叠</p> </td></tr><tr><td> <p>ST_Contains(geometry A, geometry B)</p> </td><td> <p>判断A是否包含B</p> </td></tr><tr><td> <p>ST_Covers(geometry A, geometry B)</p> </td><td> <p>判断A是否覆盖 B</p> </td></tr><tr><td> <p>ST_CoveredBy(geometry A, geometry B)</p> </td><td> <p>判断A是否被B所覆盖</p> </td></tr><tr><td> <p>ST_Relate(geometry, geometry, intersectionPatternMatrix)</p> </td><td> <p>通过DE-9IM 矩阵判断两个几何对象的关系是否成立</p> </td></tr><tr><td> <p>ST_Relate(geometry, geometry)</p> </td><td> <p>获得两个几何对象的关系（DE-9IM矩阵）</p> </td></tr></tbody></table> 
<h4 id="%E5%87%A0%E4%BD%95%E5%AF%B9%E8%B1%A1%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><strong>几何对象处理函数</strong></h4> 
<table><thead><tr><th> <p>函数</p> </th><th> <p>说明</p> </th></tr></thead><tbody><tr><td> <p>ST_Centroid(geometry)</p> </td><td> <p>获取几何对象的中心</p> </td></tr><tr><td> <p>ST_Area(geometry)</p> </td><td> <p>面积量测</p> </td></tr><tr><td> <p>ST_Length(geometry)</p> </td><td> <p>长度量测</p> </td></tr><tr><td> <p>ST_PointOnSurface(geometry)</p> </td><td> <p>返回曲面上的一个点</p> </td></tr><tr><td> <p>ST_Boundary(geometry)</p> </td><td> <p>获取边界</p> </td></tr><tr><td> <p>ST_Buffer(geometry, double, [integer])</p> </td><td> <p>获取缓冲后的几何对象</p> </td></tr><tr><td> <p>ST_ConvexHull(geometry)</p> </td><td> <p>获取多几何对象的外接对象</p> </td></tr><tr><td> <p>ST_Intersection(geometry, geometry)</p> </td><td> <p>获取两个几何对象相交的部分</p> </td></tr><tr><td> <p>ST_Shift_Longitude(geometry)</p> </td><td> <p>将经度小于0的值加360使所有经度值在0-360间</p> </td></tr><tr><td> <p>ST_SymDifference(geometry A, geometry B)</p> </td><td> <p>获取两个几何对象不相交的部分（A、B可互换）</p> </td></tr><tr><td> <p>ST_Difference(geometry A, geometry B)</p> </td><td> <p>从A去除和B相交的部分后返回</p> </td></tr><tr><td> <p>ST_Union(geometry, geometry)</p> </td><td> <p>返回两个几何对象的合并结果</p> </td></tr><tr><td> <p>ST_Union(geometry set)</p> </td><td> <p>返回一系列几何对象的合并结果</p> </td></tr><tr><td> <p>ST_MemUnion(geometry set)</p> </td><td> <p>用较少的内存和较长的时间完成合并操作，结果和ST_Union</p> </td></tr></tbody></table> 
<h4 id="%E5%87%A0%E4%BD%95%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%8F%96%E5%87%BD%E6%95%B0"><strong>几何对象存取函数</strong></h4> 
<table><thead><tr><th> <p>函数</p> </th><th> <p>说明</p> </th></tr></thead><tbody><tr><td> <p>ST_AsText(geometry)</p> </td><td> <p>获取几何对象的WKT描述</p> </td></tr><tr><td> <p>ST_AsBinary(geometry)</p> </td><td> <p>获取几何对象的WKB描述</p> </td></tr><tr><td> <p>ST_SRID(geometry)</p> </td><td> <p>获取几何对象的空间参考ID</p> </td></tr><tr><td> <p>ST_Dimension(geometry)</p> </td><td> <p>获取几何对象的维数</p> </td></tr><tr><td> <p>ST_Envelope(geometry)</p> </td><td> <p>获取几何对象的边界范围</p> </td></tr><tr><td> <p>ST_IsEmpty(geometry)</p> </td><td> <p>判断几何对象是否为空</p> </td></tr><tr><td> <p>ST_IsSimple(geometry)</p> </td><td> <p>判断几何对象是否不包含特殊点（比如自相交）</p> </td></tr><tr><td> <p>ST_IsClosed(geometry)</p> </td><td> <p>判断几何对象是否闭合</p> </td></tr><tr><td> <p>ST_IsRing(geometry)</p> </td><td> <p>判断曲线是否闭合并且不包含特殊点</p> </td></tr><tr><td> <p>ST_NumGeometries(geometry)</p> </td><td> <p>获取多几何对象中的对象个数</p> </td></tr><tr><td> <p>ST_GeometryN(geometry,int)</p> </td><td> <p>获取多几何对象中第N个对象</p> </td></tr><tr><td> <p>ST_NumPoints(geometry)</p> </td><td> <p>获取几何对象中的点个数</p> </td></tr><tr><td> <p>ST_PointN(geometry,integer)</p> </td><td> <p>获取几何对象的第N个点</p> </td></tr><tr><td> <p>ST_ExteriorRing(geometry)</p> </td><td> <p>获取多边形的外边缘</p> </td></tr><tr><td> <p>ST_NumInteriorRings(geometry)</p> </td><td> <p>获取多边形内边界个数</p> </td></tr><tr><td> <p>ST_NumInteriorRing(geometry)</p> </td><td> <p>(同上)</p> </td></tr><tr><td> <p>ST_InteriorRingN(geometry,integer)</p> </td><td> <p>获取多边形的第N个内边界</p> </td></tr><tr><td> <p>ST_EndPoint(geometry)</p> </td><td> <p>获取线的终点</p> </td></tr><tr><td> <p>ST_StartPoint(geometry)</p> </td><td> <p>获取线的起始点</p> </td></tr><tr><td> <p>ST_GeometryType(geometry)</p> </td><td> <p>获取几何对象的类型</p> </td></tr><tr><td> <p>ST_GeometryType(geometry)</p> </td><td> <p>类似上，但是不检查M值，即POINTM对象会被判断为point</p> </td></tr><tr><td> <p>ST_X(geometry)</p> </td><td> <p>获取点的X坐标</p> </td></tr><tr><td> <p>ST_Y(geometry)</p> </td><td> <p>获取点的Y坐标</p> </td></tr><tr><td> <p>ST_Z(geometry)</p> </td><td> <p>获取点的Z坐标</p> </td></tr><tr><td> <p>ST_M(geometry)</p> </td><td> <p>获取点的M值</p> </td></tr></tbody></table> 
<h4 id="%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0"><strong>类型转换函数</strong></h4> 
<table><thead><tr><th> <p>函数</p> </th><th style="width:71px;"> <p>返回类型</p> </th><th style="width:72px;"> <p>描述</p> </th><th style="width:83px;"> <p>示例</p> </th><th style="width:291px;"> <p>结果</p> </th></tr></thead><tbody><tr><td> <p>box(circle)</p> </td><td style="width:71px;"> <p>box</p> </td><td style="width:72px;"> <p>圆形转矩形</p> </td><td style="width:83px;"> <p>select box(circle ‘((0,0),2.0)’);</p> </td><td style="width:291px;"> <p>(1.41421356237309,1.41421356237309),(-1.41421356237309,-1.41421356237309)</p> </td></tr><tr><td> <p>box(point)</p> </td><td style="width:71px;"> <p>box</p> </td><td style="width:72px;"> <p>点转空矩形</p> </td><td style="width:83px;"> <p>select box(point ‘(0,0)’);</p> </td><td style="width:291px;"> <p>(0,0),(0,0)</p> </td></tr><tr><td> <p>box(point, point)</p> </td><td style="width:71px;"> <p>box</p> </td><td style="width:72px;"> <p>点转矩形</p> </td><td style="width:83px;"> <p>select box(point ‘(0,0)’, point ‘(1,1)’);</p> </td><td style="width:291px;"> <p>(1,1),(0,0)</p> </td></tr><tr><td> <p>box(polygon)</p> </td><td style="width:71px;"> <p>box</p> </td><td style="width:72px;"> <p>多边形转矩形</p> </td><td style="width:83px;"> <p>select box(polygon ‘((0,0),(1,1),(2,0))’);</p> </td><td style="width:291px;"> <p>(2,1),(0,0)</p> </td></tr><tr><td> <p>bound_box(box, box)</p> </td><td style="width:71px;"> <p>box</p> </td><td style="width:72px;"> <p>将两个矩形转换成一个边界矩形</p> </td><td style="width:83px;"> <p>select bound_box(box ‘((0,0),(1,1))’, box ‘((3,3),(4,4))’);</p> </td><td style="width:291px;"> <p>(4,4),(0,0)</p> </td></tr><tr><td> <p>circle(box)</p> </td><td style="width:71px;"> <p>circle</p> </td><td style="width:72px;"> <p>矩形转圆形</p> </td><td style="width:83px;"> <p>select circle(box ‘((0,0),(1,1))’);</p> </td><td style="width:291px;"> <p>&lt;(0.5,0.5),0.707106781186548&gt;</p> </td></tr><tr><td> <p>circle(point, double precision)</p> </td><td style="width:71px;"> <p>circle</p> </td><td style="width:72px;"> <p>圆心与半径转圆形</p> </td><td style="width:83px;"> <p>select circle(point ‘(0,0)’, 2.0);</p> </td><td style="width:291px;"> <p>&lt;(0,0),2&gt;</p> </td></tr><tr><td> <p>circle(polygon)</p> </td><td style="width:71px;"> <p>circle</p> </td><td style="width:72px;"> <p>多边形转圆形</p> </td><td style="width:83px;"> <p>select circle(polygon ‘((0,0),(1,1),(2,0))’);</p> </td><td style="width:291px;"> <p>&lt;(1,0.333333333333333),0.924950591148529&gt;</p> </td></tr><tr><td> <p>line(point, point)</p> </td><td style="width:71px;"> <p>line</p> </td><td style="width:72px;"> <p>点转直线</p> </td><td style="width:83px;"> <p>select line(point ‘(-1,0)’, point ‘(1,0)’);</p> </td><td style="width:291px;"> <p>{0,-1,0}</p> </td></tr><tr><td> <p>lseg(box)</p> </td><td style="width:71px;"> <p>lseg</p> </td><td style="width:72px;"> <p>矩形转线段</p> </td><td style="width:83px;"> <p>select lseg(box ‘((-1,0),(1,0))’);</p> </td><td style="width:291px;"> <p>[(1,0),(-1,0)]</p> </td></tr><tr><td> <p>lseg(point, point)</p> </td><td style="width:71px;"> <p>lseg</p> </td><td style="width:72px;"> <p>点转线段</p> </td><td style="width:83px;"> <p>select lseg(point ‘(-1,0)’, point ‘(1,0)’);</p> </td><td style="width:291px;"> <p>[(-1,0),(1,0)]</p> </td></tr><tr><td> <p>path(polygon)</p> </td><td style="width:71px;"> <p>path</p> </td><td style="width:72px;"> <p>多边形转path</p> </td><td style="width:83px;"> <p>select path(polygon ‘((0,0),(1,1),(2,0))’);</p> </td><td style="width:291px;"> <p>((0,0),(1,1),(2,0))</p> </td></tr><tr><td> <p>point(double precision, double precision)</p> </td><td style="width:71px;"> <p>point</p> </td><td style="width:72px;"> <p>点</p> </td><td style="width:83px;"> <p>select point(23.4, -44.5);</p> </td><td style="width:291px;"> <p>(23.4,-44.5)</p> </td></tr><tr><td> <p>point(box)</p> </td><td style="width:71px;"> <p>point</p> </td><td style="width:72px;"> <p>矩形转点</p> </td><td style="width:83px;"> <p>select point(box ‘((-1,0),(1,0))’);</p> </td><td style="width:291px;"> <p>(0,0)</p> </td></tr><tr><td> <p>point(circle)</p> </td><td style="width:71px;"> <p>point</p> </td><td style="width:72px;"> <p>圆心</p> </td><td style="width:83px;"> <p>select point(circle ‘((0,0),2.0)’);</p> </td><td style="width:291px;"> <p>(0,0)</p> </td></tr><tr><td> <p>point(lseg)</p> </td><td style="width:71px;"> <p>point</p> </td><td style="width:72px;"> <p>线段中心</p> </td><td style="width:83px;"> <p>select point(lseg ‘((-1,0),(1,0))’);</p> </td><td style="width:291px;"> <p>(0,0)</p> </td></tr><tr><td> <p>point(polygon)</p> </td><td style="width:71px;"> <p>point</p> </td><td style="width:72px;"> <p>多边形的中心</p> </td><td style="width:83px;"> <p>select point(polygon ‘((0,0),(1,1),(2,0))’);</p> </td><td style="width:291px;"> <p>(1,0.333333333333333)</p> </td></tr><tr><td> <p>polygon(box)</p> </td><td style="width:71px;"> <p>polygon</p> </td><td style="width:72px;"> <p>矩形转4点多边形</p> </td><td style="width:83px;"> <p>select polygon(box ‘((0,0),(1,1))’);</p> </td><td style="width:291px;"> <p>((0,0),(0,1),(1,1),(1,0))</p> </td></tr><tr><td colspan="1" rowspan="3"> <p>polygon(circle)</p> </td><td colspan="1" rowspan="3" style="width:71px;"> <p>polygon</p> </td><td colspan="1" rowspan="3" style="width:72px;"> <p>圆形转12点多边形</p> </td><td colspan="1" rowspan="3" style="width:83px;"> <p>select polygon(circle ‘((0,0),2.0)’);</p> </td><td style="width:291px;"> <p>((-2,0),(-1.73205080756888,1),(-1,1.73205080756888),(-1.22460635382238e-16,2),(1,1.73205080756888),(1.73205080756888,1),(2,2.4492127</p> </td></tr><tr><td style="width:291px;"> <p>0764475e-16),(1.73205080756888,-0.999999999999999),(1,-1.73205080756888),(3.67381906146713e-16,-2),(-0.999999999999999,-1.73205080756</p> </td></tr><tr><td style="width:291px;"> <p>888),(-1.73205080756888,-1))</p> </td></tr><tr><td colspan="1" rowspan="3"> <p>polygon(npts, circle)</p> </td><td colspan="1" rowspan="3" style="width:71px;"> <p>polygon</p> </td><td colspan="1" rowspan="3" style="width:72px;"> <p>圆形转npts点多边形</p> </td><td colspan="1" rowspan="3" style="width:83px;"> <p>select polygon(12, circle ‘((0,0),2.0)’);</p> </td><td style="width:291px;"> <p>((-2,0),(-1.73205080756888,1),(-1,1.73205080756888),(-1.22460635382238e-16,2),(1,1.73205080756888),(1.73205080756888,1),(2,2.4492127</p> </td></tr><tr><td style="width:291px;"> <p>0764475e-16),(1.73205080756888,-0.999999999999999),(1,-1.73205080756888),(3.67381906146713e-16,-2),(-0.999999999999999,-1.73205080756</p> </td></tr><tr><td style="width:291px;"> <p>888),(-1.73205080756888,-1))</p> </td></tr><tr><td> <p>polygon(path)</p> </td><td style="width:71px;"> <p>polygon</p> </td><td style="width:72px;"> <p>将path转多边形</p> </td><td style="width:83px;"> <p>select polygon(path ‘((0,0),(1,1),(2,0))’);</p> </td><td style="width:291px;"> <p>((0,0),(1,1),(2,0))</p> </td></tr></tbody></table> 
<h2 id="PostGIS-%E7%B3%BB%E7%BB%9F%E8%A1%A8%E6%9F%A5%E7%9C%8B"><strong>PostGIS 系统表查看</strong></h2> 
<h3 id="spatial_ref_sys%E8%A1%A8"><strong>spatial_ref_sys表</strong></h3> 
<p>在基于PostGIS模板创建的数据库的public模式下，有一个spatial_ref_sys表，它存放的是OGC规范的空间参考。</p> 
<h3 id="geometry_columns%E8%A1%A8"><strong>geometry_columns表</strong></h3> 
<p>1、geometry_columns表存放了当前数据库中所有几何字段的信息，比如我当前的库里面有两个空间表，在geometry_columns表中就可以找到这两个空间表中几何字段的定义 2、其中f_table_schema字段表示的是空间表所在的模式，f_table_name字段表示的是空间表的表名，f_geometry_column字段表示的是该空间表中几何字段的名称，srid字段表示的是该空间表的空间参考。</p> 
<pre><code class="hljs">taix=# select * from geometry_columns;
 f_table_catalog | f_table_schema | f_table_name  | f_geometry_column | coord_dimension | srid | type
-----------------+----------------+---------------+-------------------+-----------------+------+-------
 taix            | public         | trip          | pickup_geom       |               2 | 2163 | POINT
 taix            | public         | trip          | dropoff_geom      |               2 | 2163 | POINT
 taix            | public         | trip_1_prt_1  | pickup_geom       |               2 | 2163 | POINT
 taix            | public         | trip_1_prt_1  | dropoff_geom      |               2 | 2163 | POINT</code></pre> 
<h3 id="PostGIS-%E4%B8%A4%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E5%9D%90%E6%A0%87%E4%BD%93%E7%B3%BB"><strong>PostGIS 两个重要的坐标体系</strong></h3> 
<ol><li>4326 \ GCS_WGS_1984 \ Geographic Coordinate System(GCSS)地理坐标系, World Geodetic System(WGS)世界大地测量系统</li><li>26986 \ 美国马萨诸塞州地方坐标系（区域坐标系）\ 投影坐标, 平面坐标</li></ol> 
<h2 id="YMatrixDB-%E5%AE%89%E8%A3%85PostGIS"><strong>YMatrixDB 安装PostGIS</strong></h2> 
<p>YMatrixDB的安装可以参考</p> 
<p>https://ymatrix.cn/doc/5.0/install/mx5_cluster/mx5_cluster</p> 
<h3 id="PostGIS-%E5%AE%89%E8%A3%85"><strong>PostGIS 安装</strong></h3> 
<p>使用以下连接下载postgis安装包及相关的依赖。</p> 
<pre><code class="hljs">链接: https://pan.baidu.com/s/1D_awBTLzOqZV5--cxE8_oA 提取码: gjj7</code></pre> 
<p>如果是集群安装的数据库需要在每台节点安装postgis。</p> 
<pre><code class="hljs">---- 以下操作需要使用root用户执行

-- 解压postgis安装包
# unzip postgis-install.zip

-- 创建postgis的repo
# cd postgis-install
# ls
county.tgz  create_repo.sh  mxdb-postgis-2.5-1.el7.x86_64.rpm  pkg-postgis

# sh create_repo.sh
Create postgis repo successfully!

-- 查看postgis的repo
# yum repolist
repo id                                  repo name                                   status                         0
postgis                                  postgis 


-- 安装postgis
# yum install  --disablerepo="*" --enablerepo=postgis -y mxdb-postgis-2.5-1.el7.x86_64.rpm</code></pre> 
<h3 id="%E5%9C%A8YMatrixDB%E4%B8%8A%E5%AE%89%E8%A3%85postgis%E6%89%A9%E5%B1%95"><strong>在YMatrixDB上安装postgis扩展</strong></h3> 
<p>使用mxadmin用户登录到数据库并创建postgis扩展，postgis适用于当前session数据库，如果其他的数据库使用，请切换到其他数据库中再次创建即可。</p> 
<pre><code class="hljs">postgres=# create extension postgis;
CREATE EXTENSION
postgres=# \dx
                                         List of installed extensions
      Name       | Version |   Schema   |                             Description
-----------------+---------+------------+---------------------------------------------------------------------
 gp_exttable_fdw | 1.0     | pg_catalog | External Table Foreign Data Wrapper for Greenplum
 plpgsql         | 1.0     | pg_catalog | PL/pgSQL procedural language
 postgis         | 2.5.5   | public     | PostGIS geometry, geography, and raster spatial types and functions
(3 rows)</code></pre> 
<h2 id="YMatrixDB%E7%9A%84PostGIS%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><strong>YMatrixDB的PostGIS使用案例</strong></h2> 
<p>首先我们先熟悉一下PostGIS的常用的案例，然后再使用真实的北京市内所有的酒店信息和宾馆信息做统计。</p> 
<h3 id="%E8%AE%A1%E7%AE%97%E4%B8%A4%E7%82%B9%E4%B9%8B%E9%97%B4%E7%9A%84%E8%B7%9D%E7%A6%BB"><strong>计算两点之间的距离</strong></h3> 
<pre><code class="hljs">-- 两个点之间的距离,距离单位是m
select ST_Distance(ST_GeographyFromText('SRID=4326;POINT(114.017299 22.537126)'),
ST_GeographyFromText('SRID=4326;POINT(114.025919 22.534866)'));

-- 两点之间的斜度数
SELECT ST_Distance(ST_GeomFromText('POINT(114.017299 22.537126)',4326),
ST_GeomFromText('POINT(114.025919 22.534866)', 4326));</code></pre> 
<h3 id="%E8%8C%83%E5%9B%B4%E5%86%85%E7%9A%84%E7%82%B9%E6%9F%A5%E6%89%BE"><strong>范围内的点查找</strong></h3> 
<pre><code class="hljs">-- 查看两点的距离是否有1000m，单位米m，返回t是在范围内，否则不在
SELECT ST_DWithin(
ST_GeographyFromText('SRID=4326;POINT(114.017299 22.537126)'),
ST_GeographyFromText('SRID=4326;POINT(114.025919 22.534866)'),1000);

-- 查看两点直接的斜度，是否在制定的斜度内，返回t是在范围内，f不在斜度内
SELECT ST_DWithin(ST_GeomFromText('POINT(114.017299 22.537126)',4326),
ST_GeomFromText('POINT(114.025919 22.534866)', 4326),0.00811134108875483);

-- 查找给定经纬度5km以内的点
-- geom_point::geography，单位变成米, 否则默认距离单位是度。
SELECT
    uuid,
    longitude,
    latitude,
    ST_DistanceSphere (
        geom_point,
    ST_GeomFromText('POINT(121.248642 31.380415)', 4326 )) distance 
FROM
    s_poi_gaode 
WHERE
    ST_DWithin ( geom_point :: geography, ST_GeomFromText ( 'POINT(121.248642 31.380415)', 4326 ) :: geography, 5000 ) IS TRUE 
    order by distance desc
    LIMIT 30;

-- 查看给定坐标的最近的10个点
SELECT * FROM s_poi_gaode_gps ORDER BY geom_point &lt;-&gt; ST_GeomFromText ( 'POINT(121.248642 31.380415)', 4326 )  LIMIT 10;</code></pre> 
<h3 id="%E5%BC%AF%E6%9B%B2%E7%9A%84%E5%87%A0%E4%BD%95%E5%AE%9E%E4%BD%93%E6%A1%88%E4%BE%8B"><strong>弯曲的几何实体案例</strong></h3> 
<pre><code class="hljs">-- 创建表
create table global_points (
id int,
name varchar(64),
location geography(point,4326)
) Distributed by(id);

-- 插入数据
insert into global_points (id,name, location) values (1,'town', 'srid=4326;point(-110 30)');
insert into global_points (id,name, location) values (2,'forest', 'srid=4326;point(-109 29)');
insert into global_points (id,name, location) values (3,'london', 'srid=4326;point(0 49)');

-- 创建索引
create index global_points_gix on global_points using gist ( location );

-- 查看数据
postgis=# select * from global_points;
 id |  name  |                      location
----+--------+----------------------------------------------------
  2 | forest | 0101000020E61000000000000000405BC00000000000003D40
  3 | london | 0101000020E610000000000000000000000000000000804840
  1 | town   | 0101000020E61000000000000000805BC00000000000003E40
(3 rows)

-- 查询给位置1000公里之内的城镇
select name from global_points where st_dwithin(location, 'srid=4326;point(-110 29)'::
geography, 1000000);

-- 计算从西雅图(-122.33 47.606)飞往伦敦(0.0 51.5)的距离
select st_distance('linestring(-122.33 47.606, 0.0 51.5)'::geography, 'point(-21.96
64.15)'::geography);

-- 计算点线之间的距离
select st_distance('linestring(-122.33 47.606, 0.0 51.5)'::geometry, 'point(-21.96 64.15)
'::geometry);</code></pre> 
<p>我们可以使用地图查看西雅图(-122.33 47.606)和伦敦(0.0 51.5)的坐标点</p> 
<p>https://lbsyun.baidu.com/jsdemo/demo/yLngLatLocation.htm</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/69/05/dGWoXvm4_o.png"></p> 
<h2 id="YMatrixDB%E7%9A%84PostGIS%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B0%E6%8D%AE%E6%A1%88%E4%BE%8B"><strong>YMatrixDB的PostGIS车联网数据案例</strong></h2> 
<h3 id="%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B0%E6%8D%AE%E4%B8%8B%E8%BD%BD"><strong>车联网数据下载</strong></h3> 
<p>某城市拥有超过800万人口和20万辆出租车的行程信息，该行程信息乘客的上下车时间、上下车地点、乘车人数、车费和支付的方式等。接下来使用该数据分析出租车的出车情况和交通的拥堵情况，根据道路的拥堵情况合理的分配出车调度，便于乘客方便打车提高乘客的生活体验。</p> 
<p>数据下载：</p> 
<pre><code class="hljs">https://pan.baidu.com/share/init?surl=JJv6ADN5vHOlem7smTrEDw  (提取码1x4u)</code></pre> 
<h3 id="%E8%A1%A8%E5%88%9B%E5%BB%BA"><strong>表创建</strong></h3> 
<p>接下来创建付费方式、费率和行程时序表。</p> 
<pre><code class="hljs">----   付费方式表
create table if not exists payment_types (
    payment_type int,
    description text
) DISTRIBUTED BY(payment_type);

insert into payment_types values
(1, '信用卡'),
(2, '现金'),
(3, '免付费'),
(4, '有争议'),
(5, '未知'),
(6, '无效行程');

---- 费率表
create table if not exists rate_codes (
    rate_code   int,
    description text
) DISTRIBUTED BY(rate_code);

insert into rate_codes values
(1, '标准费率'),
(2, '1号机场'),
(3, '2号机场'),
(4, '特殊区域'),
(5, '协商价'),
(6, '团体');

---- 行程时序表
create extension matrixts ;
create table if not exists trip (
  vendor_id text,
  pickup_datetime timestamp without time zone,
  dropoff_datetime timestamp without time zone,
  passenger_count int,
  trip_distance numeric,
  pickup_longitude numeric,
  pickup_latitude numeric,
  rate_code_id int,
  store_and_fwd_flag text,
  dropoff_longitude numeric,
  dropoff_latitude numeric,
  payment_type int,
  fare_amount numeric,
  extra numeric,
  mta_tax numeric,
  tip_amount numeric,
  tolls_amount numeric,
  improvement_surcharge numeric,
  total_amount numeric,
  trip_duration numeric generated always as (EXTRACT(EPOCH FROM (dropoff_datetime - pickup_datetime)::INTERVAL)/60) STORED,
  is_valid boolean,
  pickup_geom geometry(POINT,2163),
  dropoff_geom geometry(POINT,2163)
)
USING mars2 with (compresstype=zstd, compresslevel=5)
DISTRIBUTED BY (vendor_id)
PARTITION BY RANGE (pickup_datetime)
( START (date '2016-01-01') INCLUSIVE
   END (date '2016-02-01') EXCLUSIVE
   EVERY (INTERVAL '1 day')
 );

CREATE INDEX trip_index ON trip USING mars2_btree(c1, daq_time) WITH (uniquemode=true);

pickup_datetime : 上车时间点
dropoff_datetime : 下车时间点 
pickup_longitude :  上车地点的经度值
pickup_latitude :  上车地点的纬度值
dropoff_longitude : 下车地点的经度值
dropoff_longitude : 下车地点的纬度值
passenger_count : 表示乘客数量
trip_distance :  旅程的距离（单位为英里）
total_amount :  乘车费用
trip_duration : 乘车的时长（单位为分钟)
pickup_geom/dropoff_geom : 位置区域信息</code></pre> 
<h3 id="%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><strong>数据加载</strong></h3> 
<p>mxgate的详细使用可以参考： https://ymatrix.cn/doc/latest/tools/mxgate.md</p> 
<pre><code class="hljs">-- 使用以下命令把数据加载到表中
tail -n +2 yellow_tripdata_2016-01.csv | mxgate --source stdin --db-database mxdb --db-master-host master --db-master-port 5432 --db-user mxadmin --time-format raw --target trip --parallel 256  --delimiter ','  --exclude-columns trip_duration,is_valid,pickup_geom,dropoff_geom
</code></pre> 
<h3 id="%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><strong>数据处理</strong></h3> 
<p>在时序的场景中，因为各种复杂的原因，数据有时会包含一些明显错误或者无效的数据。借助YMatrix提供的丰富SQL能力，可以快速检测并清除这些无效错误数据。 一种错误情况是下车时间早于或者等于上车时间，我们把is_valid字段设置成false表示该数据无效。</p> 
<pre><code class="hljs">insert into trip(vendor_id,pickup_datetime,is_valid) 
select vendor_id,pickup_datetime,'false' as is_valid 
from  trip 
where dropoff_datetime &lt;= pickup_datetime 
order by 1,2;

vacuum trip;</code></pre> 
<p>还有一种情况是汽车的平均速度大于每小时300英里，尤其在旅程或者时间较长时，这种情况明显不合理，我们也把is_valid设置成false表示该数据无效。</p> 
<pre><code class="hljs">insert into trip(vendor_id,pickup_datetime,is_valid) 
select vendor_id,pickup_datetime,'false' as is_valid 
from  trip 
where trip_distance &gt; trip_duration* (300/60) and trip_distance &gt; 100 
order by 1,2;

vacuum trip;</code></pre> 
<h3 id="%E5%87%BA%E7%A7%9F%E8%BD%A6%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><strong>出租车数据分析</strong></h3> 
<h4 id="%E5%87%BA%E7%A7%9F%E8%BD%A6%E8%A1%8C%E7%A8%8B%E7%BB%9F%E8%AE%A1"><strong>出租车行程统计</strong></h4> 
<p>YMatrix提供了time_bucket函数，支持按照任意时间区间的分段计算。需要在数据库上安装Matrixts Extension来初始化时序组件:</p> 
<pre><code class="hljs"> CREATE EXTENSION matrixts;</code></pre> 
<p>接下来我们就可以通过下面的SQL语句统计出每天有多少行程：</p> 
<pre><code class="hljs">select time_bucket('24 hours', pickup_datetime) as day, count(*) 
from trip 
where is_valid is null
group by day
order by day;</code></pre> 
<p>如果想要了解2016年1月2号一天中每个小时，分别有多少人乘车，可以用下面的SQL：</p> 
<pre><code class="hljs">SELECT time_bucket('1 hour', pickup_datetime) as hour, sum(passenger_count)
FROM trip 
where is_valid is null
and pickup_datetime &gt;= '2016-01-02 00:00:00' and pickup_datetime &lt; '2016-01-03 00:00:00'
GROUP BY hour
ORDER BY hour;</code></pre> 
<p>接下来我们统计0-10、10-50、50-100、100-200、200英里以上不同行程距离区段的总行程信息</p> 
<pre><code class="hljs">select distance_range, count(*) as num_of_trips  
from
(
    select
    case
        when trip_distance &lt;= 10 then 10
        when trip_distance &gt; 10 AND trip_distance &lt;= 50 then 50
        when trip_distance &gt; 50 AND trip_distance &lt;= 100 then 100 
        when trip_distance &gt; 100 AND trip_distance &lt;= 200 then 200
        when trip_distance &gt; 200 then 500 
        end as distance_range
    from trip where is_valid is null
) as temp
group by distance_range;</code></pre> 
<p>执行后可以看到这样的输出：</p> 
<pre><code class="hljs"> distance_range | num_of_trips
----------------+--------------
             10 |      3883839
             50 |       239067
            100 |          168
            200 |           24
            500 |            1</code></pre> 
<h4 id="%E8%B4%B9%E7%8E%87%E5%88%86%E5%B8%83"><strong>费率分布</strong></h4> 
<p>YMatrix <a href="https://cloud.tencent.com/product/ctsdb?from=10680" rel="nofollow" title="时序数据库">时序数据库</a>支持多表关联和高级窗口函数，例如RANK(),ROW_NUMBER(),DENSE_RANK() 。以下使用高级窗口函数统计出费率每个类型的个数。</p> 
<pre><code class="hljs">SELECT rates.description, 
       COUNT(vendor_id) AS num_trips,
       RANK () OVER (ORDER BY COUNT(vendor_id) DESC) AS trip_rank 
FROM trip
JOIN rate_codes rates ON trip.rate_code_id = rates.rate_code
WHERE is_valid is null AND pickup_datetime &lt; '2016-02-01'
GROUP BY rates.description
ORDER BY LOWER(rates.description);</code></pre> 
<p>执行后可以看到这样的输出。</p> 
<pre><code class="hljs"> description | num_trips | trip_rank
-------------+-----------+-----------
 1号机场     |     92551 |         2
 2号机场     |      7304 |         4
 协商价      |     14010 |         3
 团体        |       37 |          6
 标准费率    |   4007265 |         1
 特殊区域    |      1886 |         5</code></pre> 
<p>我们可以统计出去1号机场和2号机场机场的次数，平均行程时间（下车时间点 - 上车时间点）,平均票价，最小和最大和平均路程(单位为英里)以及平均乘客人数。根据这些信息可以合理的安排出租车的运行情况，减少车的拥堵情况。</p> 
<pre><code class="hljs">select rates.description,
   count(vendor_id) as num_trips,
   avg(dropoff_datetime - pickup_datetime) as avg_trip_duration,
   min(trip_distance) as min_distance,
   max(trip_distance) as max_distance,
   avg(passenger_count) as avg_passengers
from trip
join rate_codes rates on trip.rate_code_id = rates.rate_code
where is_valid is null  and trip.rate_code_id in (2,3) and pickup_datetime &lt; '2016-02-01'
group by rates.description
order by rates.description;</code></pre> 
<p>执行后可以看到这样的输出：</p> 
<pre><code class="hljs"> description | num_trips | avg_trip_duration | min_distance | max_distance |   avg_passengers
-------------+-----------+-------------------+--------------+--------------+--------------------
 1号机场     |     92274 | 00:44:30.722349   |         0.00 |       213.60 | 1.7191408197325357
 2号机场     |      7335 | 00:34:10.621541   |         0.00 |        77.40 | 1.7346966598500341</code></pre> 
<h3 id="%E6%9C%BA%E5%9C%BA%E8%A1%8C%E7%A8%8B%E5%88%86%E6%9E%90"><strong>机场行程分析</strong></h3> 
<p>我们使用YMatrix的time_bucket函数分析最近一段内出租车去1号机场和2号机场的情况。实时观测出租车的运行情况，使用软件实时的同步给出租车司机，并协助出租车规划最优路线。</p> 
<pre><code class="hljs">select time_bucket('5 minute', pickup_datetime) as datetime,rates.description,count(*)  
from trip
join rate_codes rates on trip.rate_code_id = rates.rate_code
where is_valid is null  and  trip.rate_code_id in (2,3) and pickup_datetime &gt; '2016-01-02 08:00' and pickup_datetime &lt; '2016-01-02 10:00'
group by datetime,rates.description
order by datetime desc;</code></pre> 
<p>执行后可以看到这样的输出：</p> 
<pre><code class="hljs">      datetime       | description | count
---------------------+-------------+-------
 2016-01-02 09:55:00 | 1号机场     |    16
 2016-01-02 09:55:00 | 2号机场     |     1
 2016-01-02 09:50:00 | 1号机场     |     8
 2016-01-02 09:50:00 | 2号机场     |     3
 2016-01-02 09:45:00 | 1号机场     |     8
 2016-01-02 09:40:00 | 1号机场     |    10
 2016-01-02 09:40:00 | 2号机场     |     3
 2016-01-02 09:35:00 | 1号机场     |    10
 2016-01-02 09:35:00 | 2号机场     |     2
 2016-01-02 09:30:00 | 1号机场     |    15
 2016-01-02 09:30:00 | 2号机场     |     2
 2016-01-02 09:25:00 | 1号机场     |    15</code></pre> 
<h3 id="%E9%99%84%E8%BF%91%E5%87%BA%E7%A7%9F%E8%BD%A6"><strong>附近出租车</strong></h3> 
<p>YMatrix支持空间范围数据查询，需要将纬度和经度点转换为几何坐标，来根据该经纬度的位置统计出租车的数量。根据(lat,long) (40.7589,-73.9851)位置信息获取400米范围内每隔30分钟的出租车的数量。</p> 
<pre><code class="hljs">insert into trip(vendor_id,pickup_datetime,pickup_geom) 
select vendor_id,pickup_datetime,st_transform(st_setsrid(st_makepoint(pickup_longitude,pickup_latitude),4326),2163) as pickup_geom 
from  trip  order by 1,2;

insert into trip(vendor_id,pickup_datetime,dropoff_geom) 
select vendor_id,pickup_datetime,st_transform(st_setsrid(st_makepoint(dropoff_longitude,dropoff_latitude),4326),2163) as dropoff_geom 
from  trip  order by 1,2;

vacuum trip; 

select time_bucket('30 minutes', pickup_datetime) as thirty_min, count(*) as near_times_sq
from  trip where is_valid is null  and 
 st_distance(pickup_geom, st_transform(st_setsrid(st_makepoint(-73.9851,40.7589),4326),2163)) &lt; 400
and pickup_datetime &lt; '2016-01-01 14:00'
group by thirty_min 
order by thirty_min;</code></pre> 
<p>执行后可以看到这样的输出。</p> 
<pre><code class="hljs">     thirty_min      | near_times_sq
---------------------+---------------
 2016-01-01 00:00:00 |            21
 2016-01-01 00:30:00 |            34
 2016-01-01 01:00:00 |            24
 2016-01-01 01:30:00 |            23
 2016-01-01 02:00:00 |            20
 2016-01-01 02:30:00 |            33
 2016-01-01 03:00:00 |            51
 2016-01-01 03:30:00 |            57
 2016-01-01 04:00:00 |            88</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/83270eb5643227f0a28d2d51fcd992c5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">机器学习笔记之概率图模型(五)马尔可夫随机场的结构表示</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ad35b639bbaf9862409887eef564c015/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">wsl-系统迁移-非系统盘</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>