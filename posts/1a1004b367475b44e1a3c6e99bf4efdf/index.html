<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>大白话唠唠 Oauth2 与授权认证的那些事儿！ - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="大白话唠唠 Oauth2 与授权认证的那些事儿！" />
<meta property="og:description" content="我的新课《C2C 电商系统微服务架构120天实战训练营》在公众号儒猿技术窝上线了，感兴趣的同学，可以长按扫描下方二维码了解课程详情：
课程大纲请参见文末
出处：
https://kefeng.wang/2018/04/06/oauth2-sso/
1 什么是单点登录 1.1 多点登录 传统的多点登录系统中，每个站点都实现了本站专用的帐号数据库和登录模块。各站点的登录状态相互不认可，各站点需要逐一手工登录。如下图，有两个术语含义如下：
认证(authentication): 验证用户的身份；
授权(authorization): 验证用户的访问权限。
1.2 单点登录 单点登录，英文是 Single Sign On，缩写为 SSO。
多个站点(192.168.1.20X)共用一台认证授权服务器(192.168.1.110，用户数据库和认证授权模块共用)。用户经由其中任何一个站点(比如 192.168.1.201)登录后，可以免登录访问其他所有站点。而且，各站点间可以通过该登录状态直接交互。
2 OAuth2 认证授权的原理流程 2.1 生活实例【★★重点★★】 为了直观的理解 OAuth2.0 原理流程，我们假设这样一个生活场景：
(1)档案局A(客户端 / Client)：以“档案局ID/密码”标识，是掌握档案资源的机构。并列还有很多档案局B/C/…，每个档案局存储的档案内容(资源 / Resource)不一样，比如政治、经济、军事、文化等；
(2)公民张三(资源所有者 / Resource Owner)：以“用户名/密码”标识，需要到各个档案局查档案；
(3)派出所(授权服务器 / Authentication Server)：可以是单个巨大的派出所，也可以是数据共享的派出所集群，掌管的信息、提供的对外接口功能有：
档案局信息：所有档案局的“档案局ID/密码”，证明档案局的身份；
公民信息：所有公民的“用户名/密码”，能提供张三是张三的用户身份证明(认证 / Authentication)
公民对于档案局的权限：有张公民和档案局的权限的映射表，可查得各公民对各档案局是否有操作权限(授权 / Authorization)。通常，设计中会增加官职(角色 / Role)一层，各公民属于哪个官职(角色)，哪个官职(角色)对于特定档案局有操作权限。
2.1.1 张三首次访问档案局A 张三之前从未到访档案局，第一次来档案局。对照下图序号理解：
(1)张三来到“档案局A”的“档案处”，该处要求实名登记后才能查询，被指示到“用户登记处”办理(HTTP重定向)；
(2)张三来到“档案局A”的“用户登记处”，既不能证明身份(认证)，又不能证明自己有查档案A的权限(授权)。张三携带档案局A的标识(client-id)，被重定向至“授权信开具处”；
(3)张三来到“派出所”的“授权信开具处”，出示档案局A的标识，希望开具授权信(授权)。该处要求首先证明身份(认证)，被重定向至“用户身份验证处”；
(4)张三来到“派出所”的“用户身份验证处”，领取了用户身份表(网页登录表单 Form)；
(5)张三填上自己的用户名和密码，交给(提交 / Submit)“用户身份验证处”，该处从私用数据库中查得用户名密码匹配，确定此人是张三，开具身份证明信，完成认证。张三带上身份证明信和档案局A的标识，被重定向至“授权信开具处”；
(6)张三再次来到“授权信开具处”，出示身份证明信和档案局A的标识，该处从私用数据库中查得，张三的官职是市长级别(角色)，该官职具有档案局A的查询权限，就开具“允许张三查询档案局A”的授权信(授权码 / code)，张三带上授权信被重定向至“档案局”的“用户登录处”；
(7)张三到了“档案局”的“用户登录处”，该处私下拿出档案局A的标识(client-id)和密码，再附上张三出示的授权信(code)，向“派出所”的“腰牌发放处”为张三申请的“腰牌”(token)，将来张三可以带着这个腰牌表明身份和权限。又被重定向到“档案处”；
(8)张三的会话(Session)已经关联上了腰牌(token)，可以直接通过“档案处”查档案。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1a1004b367475b44e1a3c6e99bf4efdf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-26T08:30:00+08:00" />
<meta property="article:modified_time" content="2020-11-26T08:30:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">大白话唠唠 Oauth2 与授权认证的那些事儿！</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="js_content"> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/af/0d/8NDeAdXS_o.png"><br></p> 
 <p style="text-align: left">我的新课《C2C 电商系统微服务架构120天实战训练营》在公众号<strong>儒猿技术窝</strong>上线了，感兴趣的同学，可以长按扫描下方二维码了解课程详情：<br></p> 
 <p style="text-align: center"><strong>课程大纲请参见文末</strong></p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/08/2d/pAUq1yo3_o.png"></p> 
 <p><img src="https://images2.imgbox.com/ed/d9/lo8q9m6w_o.png"></p> 
 <hr> 
 <p style="text-align: right">出处：</p> 
 <p style="text-align: right">https://kefeng.wang/2018/04/06/oauth2-sso/</p> 
 <h3>1 什么是单点登录</h3> 
 <h5><br></h5> 
 <h4>1.1 多点登录</h4> 
 <p>传统的多点登录系统中，每个站点都实现了本站专用的帐号数据库和登录模块。各站点的登录状态相互不认可，各站点需要逐一手工登录。如下图，有两个术语含义如下：</p> 
 <ul><li><p>认证(authentication): 验证用户的身份；</p></li><li><p>授权(authorization): 验证用户的访问权限。</p></li></ul> 
 <p><img src="https://images2.imgbox.com/9a/a8/jvbPBk1u_o.png"></p> 
 <h4>1.2 单点登录</h4> 
 <p>单点登录，英文是 Single Sign On，缩写为 SSO。</p> 
 <p><br>多个站点(192.168.1.20X)共用一台认证授权服务器(192.168.1.110，用户数据库和认证授权模块共用)。用户经由其中任何一个站点(比如 192.168.1.201)登录后，可以免登录访问其他所有站点。而且，各站点间可以通过该登录状态直接交互。<br></p> 
 <p><img src="https://images2.imgbox.com/2a/f5/SJHVCZWw_o.png"></p> 
 <h3>2 OAuth2 认证授权的原理流程</h3> 
 <h4>2.1 生活实例【★★重点★★】</h4> 
 <p>为了直观的理解 OAuth2.0 原理流程，我们假设这样一个生活场景：</p> 
 <p><br>(1)档案局A(<code>客户端 / Client</code>)：以“档案局ID/密码”标识，是掌握档案资源的机构。并列还有很多档案局B/C/…，每个档案局存储的档案内容(<code>资源 / Resource</code>)不一样，比如政治、经济、军事、文化等；</p> 
 <p><br>(2)公民张三(<code>资源所有者 / Resource Owner</code>)：以“用户名/密码”标识，需要到各个档案局查档案；</p> 
 <p><br>(3)派出所(<code>授权服务器 / Authentication Server</code>)：可以是单个巨大的派出所，也可以是数据共享的派出所集群，掌管的信息、提供的对外接口功能有：</p> 
 <ul><li><p>档案局信息：所有档案局的“档案局ID/密码”，证明档案局的身份；</p></li><li><p>公民信息：所有公民的“用户名/密码”，能提供张三是张三的用户身份证明(<code>认证 / Authentication</code>)</p></li><li><p>公民对于档案局的权限：有张公民和档案局的权限的映射表，可查得各公民对各档案局是否有操作权限(<code>授权 / Authorization</code>)。通常，设计中会增加官职(<code>角色 / Role</code>)一层，各公民属于哪个官职(角色)，哪个官职(角色)对于特定档案局有操作权限。</p></li></ul> 
 <h5>2.1.1 张三首次访问档案局A</h5> 
 <p>张三之前从未到访档案局，第一次来档案局。对照下图序号理解：<br>(1)张三来到“档案局A”的“档案处”，该处要求实名登记后才能查询，被指示到“用户登记处”办理(HTTP重定向)；</p> 
 <p><br>(2)张三来到“档案局A”的“用户登记处”，既不能证明身份(<code>认证</code>)，又不能证明自己有查档案A的权限(<code>授权</code>)。张三携带档案局A的标识(<code>client-id</code>)，被重定向至“授权信开具处”；</p> 
 <p><br>(3)张三来到“派出所”的“授权信开具处”，出示档案局A的标识，希望开具授权信(<code>授权</code>)。该处要求首先证明身份(<code>认证</code>)，被重定向至“用户身份验证处”；</p> 
 <p><br>(4)张三来到“派出所”的“用户身份验证处”，领取了用户身份表(<code>网页登录表单 Form</code>)；</p> 
 <p><br>(5)张三填上自己的用户名和密码，交给(<code>提交 / Submit</code>)“用户身份验证处”，该处从私用数据库中查得用户名密码匹配，确定此人是张三，开具身份证明信，完成<code>认证</code>。张三带上身份证明信和档案局A的标识，被重定向至“授权信开具处”；</p> 
 <p><br>(6)张三再次来到“授权信开具处”，出示身份证明信和档案局A的标识，该处从私用数据库中查得，张三的官职是市长级别(角色)，该官职具有档案局A的查询权限，就开具“允许张三查询档案局A”的授权信(<code>授权码 / code</code>)，张三带上授权信被重定向至“档案局”的“用户登录处”；</p> 
 <p><br>(7)张三到了“档案局”的“用户登录处”，该处私下拿出档案局A的标识(<code>client-id</code>)和密码，再附上张三出示的授权信(<code>code</code>)，向“派出所”的“腰牌发放处”为张三申请的“腰牌”(<code>token</code>)，将来张三可以带着这个腰牌表明身份和权限。又被重定向到“档案处”；</p> 
 <p><br>(8)张三的会话(Session)已经关联上了腰牌(token)，可以直接通过“档案处”查档案。</p> 
 <p><img src="https://images2.imgbox.com/af/6e/DkkYzQ0B_o.png"></p> 
 <h5><br></h5> 
 <h5>2.1.2 张三首次访问档案局B</h5> 
 <p>张三已经成功访问了档案局A，现在他要访问档案局B。对照下图序号理解：<br>(1)/(2) 同上；</p> 
 <p><br>(3)张三已经有“身份证明信”，直接在“派出所”的“授权信开具处”成功开具“访问档案局B”的授权信；</p> 
 <p><br>(4)/(5)/(6) 免了；</p> 
 <p><br>(7)“档案局B”的“用户登记处”完成登记；</p> 
 <p><br>(8)“档案局B”的“档案处”查得档案。<br></p> 
 <p><img src="https://images2.imgbox.com/44/18/u0MHovL6_o.png"></p> 
 <h5>2.1.3 张三再次访问档案局A</h5> 
 <p>张三已经成功访问了档案局A，现在他要访问档案局A。对照下图序号理解：<br>(1)直接成功查到了档案；<br>(2~8)都免了。<br><img src="https://images2.imgbox.com/d9/db/X0V2L4RE_o.png"></p> 
 <h4>2.2 HTTP 重定向原理</h4> 
 <p>HTTP 协议中，浏览器的 REQUEST 发给服务器之后，服务器如果发现该业务不属于自己管辖，会把你支派到自身服务器或其他服务器(host)的某个接口(uri)。</p> 
 <p>正如我们去政府部门办事，每到一个窗口，工作人员会说“你带上材料A，到本所的X窗口，或者其他Y所的Z窗口”进行下一个手续。<br><img src="https://images2.imgbox.com/67/14/GGgs3VYQ_o.png"></p> 
 <h4>2.3 SSO 工作流程</h4> 
 <p>至此，就不难理解 OAuth 2.0 的认证/授权流程，此处不再赘述。请拿下图对照“2.1 生活实例”一节来理解。</p> 
 <p><img src="https://images2.imgbox.com/ec/bb/1d24sL5g_o.png"></p> 
 <h4>2.4 OAuth2.0 进阶</h4> 
 <ul><li><p>RFC 6749: The OAuth 2.0 Authorization Framework</p></li><li><p>RFC 6750: The OAuth 2.0 Authorization Framework: Bearer Token Usage</p></li><li><p>帮你深入理解OAuth2.0协议</p></li></ul> 
 <p>根据官方标准，OAuth 2.0 共用四种授权模式：</p> 
 <ul><li><p>Authorization Code: 用在服务端应用之间，这种最复杂，也是本文采用的模式；</p></li><li><p>Implicit: 用在移动app或者web app(这些app是在用户的设备上的，如在手机上调起微信来进行认证授权)</p></li><li><p>Resource Owner Password Credentials(password): 应用直接都是受信任的(都是由一家公司开发的，本例子使用)</p></li><li><p>Client Credentials: 用在应用API访问。</p></li></ul> 
 <p><img src="https://images2.imgbox.com/0f/f9/63IUdc1H_o.png"></p> 
 <h3>3 基于 SpringBoot 实现认证/授权</h3> 
 <p>官方文档：Spring Cloud Security</p> 
 <h4>3.1 授权服务器(Authorization Server)</h4> 
 <p><strong>(1) pom.xml</strong><br></p> 
 <table><tbody><tr><td><pre class="has"><code class="language-php">1
2
3
4

</code></pre></td><td><pre class="has"><code class="language-php">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
&lt;/dependency&gt;

</code></pre></td></tr></tbody></table> 
 <p><strong>(2) application.properties</strong><br></p> 
 <table><tbody><tr><td><pre class="has"><code class="language-php">1

</code></pre></td><td><pre class="has"><code class="language-php">server.port=8110 ## 监听端口

</code></pre></td></tr></tbody></table> 
 <p>(3) AuthorizationServerApplication.java<br></p> 
 <table><tbody><tr><td><pre class="has"><code class="language-php">1
2
3
4

</code></pre></td><td><pre class="has"><code class="language-php">@EnableResourceServer // 启用资源服务器
public class AuthorizationServerApplication {
    // ...
}

</code></pre></td></tr></tbody></table> 
 <p>(4) 配置授权服务的参数<br></p> 
 <table><tbody><tr><td><pre class="has"><code class="language-php">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29

</code></pre></td><td><pre class="has"><code class="language-php">@Configuration
@EnableAuthorizationServer
public class Oauth2AuthorizationServerConfigurer extends AuthorizationServerConfigurerAdapter {
    @Override
    public void configure(final ClientDetailsServiceConfigurer clients) throws Exception {
        clients.inMemory()
                .withClient("webapp").secret("secret") //客户端 id/secret
                .authorizedGrantTypes("authorization code") //授权妈模式
                .scopes("user_info")
                .autoApprove(true) //自动审批
                .accessTokenValiditySeconds(3600); //有效期1hour
    }
}

@Configuration
public class Oauth2WebSecurityConfigurer extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.requestMatchers()
                .antMatchers("/login", "/oauth/authorize/oauth/logout")
                .and().authorizeRequests().anyRequest().authenticated()
                .and().formLogin().permitAll();
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.inMemoryAuthentication().withUser("admin").password("admin123").roles("ADMIN");
    }
}

</code></pre></td></tr></tbody></table> 
 <h4>3.2 客户端(Client, 业务网站)</h4> 
 <p><strong>(1) pom.xml</strong><br></p> 
 <table><tbody><tr><td><pre class="has"><code class="language-php">1
2
3
4

</code></pre></td><td><pre class="has"><code class="language-php">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
&lt;/dependency&gt;

</code></pre></td></tr></tbody></table> 
 <p><strong>(2) application.properties</strong><br></p> 
 <table><tbody><tr><td><pre class="has"><code class="language-php">1
2
3
4
5
6

</code></pre></td><td><pre class="has"><code class="language-php">server port=8080
security.oauth2.client.client-id=webapp
security.oauth2.client.client-secret=secret
security.oauth2.client.access-token-uri=http://localhost:8110/oauth/token
security.oauth2.client.user-authorization-uri=http://localhost:8110/oauth/authorize
security.oauth2.resource.user-info-uri=http://localhost:8110/oauth/user

</code></pre></td></tr></tbody></table> 
 <p><strong>(3) 配置 WEB 安全</strong><br></p> 
 <table><tbody><tr><td><pre class="has"><code class="language-php">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23

</code></pre></td><td><pre class="has"><code class="language-php">@Configuration
@EnableOAuth2Sso
public class Oauth2WebsecurityConfigurer extends WebSecurityConfigurerAdapter {
    @Override
    public void configure(HttpSecurity http) throws Exception {
        http.antMatcher("/**").authorizeRequests()
                .antMatchers("/", "/login").permitAll()
                .anyRequest().authenticated();
    }
}

@RestController
public class Oauth2ClientController {
    @GetMapping("/")
    public ModelAndView index() {
        return new ModelAndView("index");
    }

    @GetMapping("/welcome")
    public ModelAndView welcome() {
        return new ModelAndView("welcome");
    }
}

</code></pre></td></tr></tbody></table> 
 <h4>3.3 用户权限控制(基于角色)</h4> 
 <ul><li><p>授权服务器中，定义各用户拥有的角色: user=USER, admin=ADMIN/USER, root=ROOT/ADMIN/USER</p></li><li><p>业务网站中(client)，注解标明哪些角色可</p></li></ul> 
 <table><tbody><tr><td><pre class="has"><code class="language-php">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22

</code></pre></td><td><pre class="has"><code class="language-php">@RestController
public class Oauth2ClientController {
    @GetMapping("/welcome")
    public ModelAndView welcome() {
        return new ModelAndView("welcome");
    }

    @GetMapping("/api/user")
    @PreAuthorize("hasAuthority('USER')")
    public Map&lt;String, Object&gt; apiUser() {
    }

    @GetMapping("/api/admin")
    @PreAuthorize("hasAuthority('ADMIN')")
    public Map&lt;String, Object&gt; apiAdmin() {
    }

    @GetMapping("/api/root")
    @PreAuthorize("hasAuthority('ROOT')")
    public Map&lt;String, Object&gt; apiRoot() {
    }
}

</code></pre></td></tr></tbody></table> 
 <h3>4 综合运用</h3> 
 <h4>4.1 权限控制方案</h4> 
 <p>下图是基本的认证/授权控制方案，主要设计了认证授权服务器上相关数据表的基本定义。可对照本文“2.1 生活实例”一节来理解。<br><img src="https://images2.imgbox.com/6b/f5/G27aH2QX_o.png"></p> 
 <h4>4.2 在微服务架构中的应用</h4> 
 <p>与常规服务架构不同，在微服务架构中，Authorization Server/Resource Server 是作为微服务存在的，用户的登录可以通过API网关一次性完成，无需与无法跳转至内网的 Authorization Server 来完成。<br><img src="https://images2.imgbox.com/3a/cd/EaQtdAvL_o.png"></p> 
 <p style="text-align: center"><strong>END</strong></p> 
 <p style="text-align: left"><em>征稿：愿意技术分享的朋友，欢迎投稿，每篇文章提供 800 ~ 1000 元的稿酬</em></p> 
 <p style="text-align: left"><em>投稿请扫描下方二维码，添加微信：<strong><em>puzzle_about</em></strong></em></p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/22/6d/dDhFE2KI_o.png"></p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/8e/44/LjAg9oNe_o.png"></p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/7f/21/i9uoYc5c_o.png"></p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/ec/2b/o6pnkkPm_o.png"></p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/11/20/QfS4NK3C_o.png"></p> 
 <p>长按扫描下方二维码，了解课程详情<br></p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/18/33/ji7vxaqM_o.png"></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/84f12b3aedf166c60dc90373be0bbf8c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python学习笔记-------问题（pycharm无法导入模块）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bd9e02d5c0c870c4594b07f2c378c580/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python人工智能识别视频水印_人工智能-OpenCV&#43;Python实现人脸识别（视频人脸检测）...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>