<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SPI驱动理论与实例分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SPI驱动理论与实例分析" />
<meta property="og:description" content="文章目录 前言一、SPI总线SPI总线概述SPI总线时序SPI总线传输模式SPI总线的优缺点 Linux SPI 框架软件架构初始化及退出流程注册spi控制器注销spi控制器 关键数据结构数据传输流程关键函数解析 实例分析：SPI 陀螺仪驱动修改设备树编写驱动程序 实例：瑞芯微 SPI 设备驱动总结 前言 实例部分分为几个部分：
1、正点原子 imx6ull 陀螺仪模块驱动，非常经典，基本满足所有 SPI 驱动开发；
2、瑞芯微官方 SPI 设备驱动例程；
由于文章长度，以下两个实战例子放在另一篇文章。
3、高通 DACx0501 （ADC）模块驱动；
4、高通 IDT8V97003 （无线发射接收器）模块驱动。
一、SPI总线 SPI总线概述 SPI，是英语Serial Peripheral interface的缩写，顾名思义就是串行外围设备接口。是Motorola首先在其MC68HCXX系列处理器上定义的。SPI接口主要应用在 EEPROM，FLASH，实时时钟，AD转换器，还有数字信号处理器和数字信号解码器之间。
SPI，是一种高速的，全双工，同步的通信总线，并且在芯片的管脚上只占用四根线，节约了芯片的管脚，同时为PCB的布局上节省空间，提供方便，正是出于这种简单易用的特性，现在越来越多的芯片集成了这种通信协议。
SPI总线的构成及信号类型如图1-1所示：
MOSI – 主设备数据输出，从设备数据输入 对应MOSI master output slave input
MISO – 主设备数据输入，从设备数据输出 对应MISO master input slave output
CLK – 时钟信号，由主设备产生
nCS – 从设备使能信号，由主设备控制
SPI总线时序 SPI接口在Master控制下产生的从设备使能信号和时钟信号，两个双向移位寄存器按位传输进行数据交换，传输数据高位在前（MSB first），低位在后。如下图所示，在CLK的下降沿上数据改变，上升沿一位数据被存入移位寄存器。
在一个SPI时钟周期内，会完成如下操作：
（1）Master通过MOSI线发送1位数据，同时Slave通过MOSI线读取这1位数据；
（2）Slave通过MISO线发送1位数据，同时Master通过MISO线读取这1位数据。
Master和Slave各有一个移位寄存器，而且这两个移位寄存器连接成环状。依照CLK的变化，数据以MSB first的方式依次移出Master寄存器和Slave寄存器，并且依次移入Slave寄存器和Master寄存器。当寄存器中的内容全部移出时，相当于完成了两个寄存器内容的交换。如图所示：
SPI总线传输模式 SPI总线传输一共有4中模式，这4种模式分别由时钟极性(CPOL，Clock Polarity)和时钟相位(CPHA，Clock Phase)来定义，其中CPOL参数规定了SCK时钟信号空闲状态的电平，CPHA规定了数据是在SCK时钟的上升沿被采样还是下降沿被采样。这四种模式的时序图如下图所示：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/57d0943936d453aaf61f04a23c73b6e1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-10T18:48:39+08:00" />
<meta property="article:modified_time" content="2023-09-10T18:48:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SPI驱动理论与实例分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_3" rel="nofollow">前言</a></li><li><a href="#SPI_10" rel="nofollow">一、SPI总线</a></li><li><ul><li><a href="#SPI_11" rel="nofollow">SPI总线概述</a></li><li><a href="#SPI_20" rel="nofollow">SPI总线时序</a></li><li><a href="#SPI_28" rel="nofollow">SPI总线传输模式</a></li><li><a href="#SPI_37" rel="nofollow">SPI总线的优缺点</a></li></ul> 
  </li><li><a href="#Linux_SPI__41" rel="nofollow">Linux SPI 框架</a></li><li><ul><li><a href="#_42" rel="nofollow">软件架构</a></li><li><a href="#_51" rel="nofollow">初始化及退出流程</a></li><li><ul><li><a href="#spi_52" rel="nofollow">注册spi控制器</a></li><li><a href="#spi_58" rel="nofollow">注销spi控制器</a></li></ul> 
   </li><li><a href="#_63" rel="nofollow">关键数据结构</a></li><li><a href="#_253" rel="nofollow">数据传输流程</a></li><li><a href="#_306" rel="nofollow">关键函数解析</a></li></ul> 
  </li><li><a href="#SPI__401" rel="nofollow">实例分析：SPI 陀螺仪驱动</a></li><li><ul><li><a href="#_407" rel="nofollow">修改设备树</a></li><li><a href="#_436" rel="nofollow">编写驱动程序</a></li></ul> 
  </li><li><a href="#_SPI__930" rel="nofollow">实例：瑞芯微 SPI 设备驱动</a></li><li><a href="#_1388" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_3"></a>前言</h2> 
<p>实例部分分为几个部分：<br> 1、正点原子 imx6ull 陀螺仪模块驱动，非常经典，基本满足所有 SPI 驱动开发；<br> 2、瑞芯微官方 SPI 设备驱动例程；<br> 由于文章长度，以下两个实战例子放在另一篇文章。<br> 3、高通 DACx0501 （ADC）模块驱动；<br> 4、高通 IDT8V97003 （无线发射接收器）模块驱动。</p> 
<h2><a id="SPI_10"></a>一、SPI总线</h2> 
<h3><a id="SPI_11"></a>SPI总线概述</h3> 
<p>SPI，是英语Serial Peripheral interface的缩写，顾名思义就是串行外围设备接口。是Motorola首先在其MC68HCXX系列处理器上定义的。SPI接口主要应用在 EEPROM，FLASH，实时时钟，AD转换器，还有数字信号处理器和数字信号解码器之间。<br> SPI，是一种高速的，全双工，同步的通信总线，并且在芯片的管脚上只占用四根线，节约了芯片的管脚，同时为PCB的布局上节省空间，提供方便，正是出于这种简单易用的特性，现在越来越多的芯片集成了这种通信协议。<br> SPI总线的构成及信号类型如图1-1所示：<br> MOSI – 主设备数据输出，从设备数据输入 对应MOSI master output slave input<br> MISO – 主设备数据输入，从设备数据输出 对应MISO master input slave output<br> CLK – 时钟信号，由主设备产生<br> nCS – 从设备使能信号，由主设备控制<br> <img src="https://images2.imgbox.com/be/c5/uIFBhMmM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="SPI_20"></a>SPI总线时序</h3> 
<p>SPI接口在Master控制下产生的从设备使能信号和时钟信号，两个双向移位寄存器按位传输进行数据交换，传输数据高位在前（MSB first），低位在后。如下图所示，在CLK的下降沿上数据改变，上升沿一位数据被存入移位寄存器。<br> <img src="https://images2.imgbox.com/db/51/CU7hFO8q_o.png" alt="在这里插入图片描述"><br> 在一个SPI时钟周期内，会完成如下操作：<br> （1）Master通过MOSI线发送1位数据，同时Slave通过MOSI线读取这1位数据；<br> （2）Slave通过MISO线发送1位数据，同时Master通过MISO线读取这1位数据。<br> Master和Slave各有一个移位寄存器，而且这两个移位寄存器连接成环状。依照CLK的变化，数据以MSB first的方式依次移出Master寄存器和Slave寄存器，并且依次移入Slave寄存器和Master寄存器。当寄存器中的内容全部移出时，相当于完成了两个寄存器内容的交换。如图所示：<br> <img src="https://images2.imgbox.com/ac/59/CnLs9L59_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="SPI_28"></a>SPI总线传输模式</h3> 
<p>SPI总线传输一共有4中模式，这4种模式分别由时钟极性(CPOL，Clock Polarity)和时钟相位(CPHA，Clock Phase)来定义，其中CPOL参数规定了SCK时钟信号空闲状态的电平，CPHA规定了数据是在SCK时钟的上升沿被采样还是下降沿被采样。这四种模式的时序图如下图所示：<br> <img src="https://images2.imgbox.com/93/5a/TrbkKsUX_o.png" alt="在这里插入图片描述"><br> 模式0：CPOL= 0，CPHA=0。CLK串行时钟线空闲是为低电平，数据在SCK时钟的上升沿被采样，数据在CLK时钟的下降沿切换<br> 模式1：CPOL= 0，CPHA=1。CLK串行时钟线空闲是为低电平，数据在SCK时钟的下降沿被采样，数据在CLK时钟的上升沿切换<br> 模式2：CPOL= 1，CPHA=0。CLK串行时钟线空闲是为高电平，数据在SCK时钟的下降沿被采样，数据在CLK时钟的上升沿切换<br> 模式3：CPOL= 1，CPHA=1。CLK串行时钟线空闲是为高电平，数据在SCK时钟的上升沿被采样，数据在CLK时钟的下降沿切换<br> 其中比较常用的模式是模式0和模式3。为了更清晰的描述SPI总线的时序，下面展现了模式0下的SPI时序图：<br> <img src="https://images2.imgbox.com/85/3c/D6miql9H_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="SPI_37"></a>SPI总线的优缺点</h3> 
<p>（1） 在点对点的通信中，SPI接口不需要进行寻址操作，且为全双工通信，显得简单高效。<br> （2） SPI接口没有指定的流控制，没有应答机制确认是否接收到数据。</p> 
<h2><a id="Linux_SPI__41"></a>Linux SPI 框架</h2> 
<h3><a id="_42"></a>软件架构</h3> 
<p>Linux系统对spi设备具有很好的支持，linux系统下的spi驱动程序从逻辑上可以分为3个部分：</p> 
<p>spi核心（SPI Core）：SPI Core是Linux内核用来维护和管理spi的核心部分，SPI Core提供操作接口函数，允许一个spi master，spi driver和spi device初始化时在SPI Core中进行注册，以及推出时进行注销。<br> spi控制器驱动（SPI Master Driver）：SPI Master针对不同类型的spi控制器硬件，实现spi总线的硬件访问操作。SPI Master通过接口函数向SPI Core注册一个控制器。<br> spi设备驱动（SPI Device Driver）：SPI Driver是对应于spi设备端的驱动程序，通过接口函数向SPI Core进行注册，SPI Driver的作用是将spi设备挂接到spi总线上；<br> Linux的软件架构图如图所示：<br> <img src="https://images2.imgbox.com/cf/0e/6BWKJSdl_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_51"></a>初始化及退出流程</h3> 
<h4><a id="spi_52"></a>注册spi控制器</h4> 
<p>注册spi控制器到内核分为两个阶段：<br> 第一个阶段，使用spi_alloc_master,分配一个spi_master的空间，具体流程如图2-2所示：<br> <img src="https://images2.imgbox.com/9d/27/qwtYWDHM_o.png" alt="在这里插入图片描述"><br> 第二阶段，使用spi_register_master将第一阶段分配的spi_master注册到内核中，具体流程如所示：<br> <img src="https://images2.imgbox.com/82/2d/5xHSw0bw_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="spi_58"></a>注销spi控制器</h4> 
<p>spi控制器注销的流程如图所示：<br> <img src="https://images2.imgbox.com/f4/82/WlrsGrzy_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_63"></a>关键数据结构</h3> 
<p><strong>spi_device</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span>       dev<span class="token punctuation">;</span>              <span class="token comment">/*spi控制器对应的device结构
    struct spi_master   *master;          /*设备使用的master结构，挂在哪个主控制器下*/</span>
    u32                 max_speed_hz<span class="token punctuation">;</span>     <span class="token comment">/*通讯时钟最大频率*/</span>
    u8                  chip_select<span class="token punctuation">;</span>      <span class="token comment">/*片选号，每个master支持多个spi_device  */</span> 
    u8                  mode<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_CPHA</span>        <span class="token expression"><span class="token number">0x01</span>                    </span><span class="token comment">/* clock phase */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_CPOL</span>        <span class="token expression"><span class="token number">0x02</span>                    </span><span class="token comment">/* clock polarity */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_MODE_0</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span>                   </span><span class="token comment">/* (original MicroWire) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_MODE_1</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">|</span>SPI_CPHA<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_MODE_2</span>      <span class="token expression"><span class="token punctuation">(</span>SPI_CPOL<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_MODE_3</span>      <span class="token expression"><span class="token punctuation">(</span>SPI_CPOL<span class="token operator">|</span>SPI_CPHA<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_CS_HIGH</span>     <span class="token expression"><span class="token number">0x04</span>                    </span><span class="token comment">/* chipselect active high? */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_LSB_FIRST</span>   <span class="token expression"><span class="token number">0x08</span>                    </span><span class="token comment">/* per-word bits-on-wire */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_3WIRE</span>       <span class="token expression"><span class="token number">0x10</span>                    </span><span class="token comment">/* SI/SO signals shared */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_LOOP</span>        <span class="token expression"><span class="token number">0x20</span>                    </span><span class="token comment">/* loopback mode */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_NO_CS</span>       <span class="token expression"><span class="token number">0x40</span>                    </span><span class="token comment">/* 1 dev/bus, no chipselect */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_READY</span>       <span class="token expression"><span class="token number">0x80</span>                    </span><span class="token comment">/* slave pulls low to pause */</span></span>
    u8                  bits_per_word<span class="token punctuation">;</span>          <span class="token comment">/*每个字长的比特数，默认是8*/</span>
    <span class="token keyword">int</span>                 irq<span class="token punctuation">;</span>
    <span class="token keyword">void</span>                <span class="token operator">*</span>controller_state<span class="token punctuation">;</span>       <span class="token comment">/*控制器状态*/</span>
    <span class="token keyword">void</span>                <span class="token operator">*</span>controller_data<span class="token punctuation">;</span>        <span class="token comment">/*控制器数据*/</span>
    <span class="token keyword">char</span>                modalias<span class="token punctuation">[</span>SPI_NAME_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* 设备驱动的名字 */</span>
    <span class="token keyword">int</span>                 cs_gpio<span class="token punctuation">;</span>                 <span class="token comment">/* chip select gpio */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>spi_device代表一个外围spi设备，由master controller driver注册完成后扫描BSP中注册设备产生的设备链表并向spi_bus注册产生。在内核中，每个spi_device代表一个物理的spi设备。<br> <strong>spi_driver</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">spi_driver</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">spi_device_id</span> <span class="token operator">*</span>id_table<span class="token punctuation">;</span>    <span class="token comment">/*支持的spi_device设备表*/</span>
        <span class="token keyword">int</span>                     <span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>                     <span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span>                    <span class="token punctuation">(</span><span class="token operator">*</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>                     <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">,</span> <span class="token class-name">pm_message_t</span> mesg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span>                     <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">device_driver</span>    driver<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>spi_driver</strong> 代表一个SPI protocol drivers，即<strong>外设驱动</strong>。<br> <strong>spi_master</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">spi_master</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">device</span>    dev<span class="token punctuation">;</span>     <span class="token comment">/*spi控制器对应的device结构*/</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>    <span class="token comment">/*链表
        s16              bus_num; /*总线（或控制器编号）*/</span>
        u16              num_chipselect<span class="token punctuation">;</span> <span class="token comment">/*片选数量*/</span>

        <span class="token comment">/* some SPI controllers pose alignment requirements on DMAable
         * buffers; let protocol drivers know about these requirements.
         */</span>
        u16              dma_alignment<span class="token punctuation">;</span>

        <span class="token comment">/* spi_device.mode flags understood by this controller driver */</span>
        u16              mode_bits<span class="token punctuation">;</span>            <span class="token comment">/* master支持的设备模式 */</span>

        <span class="token comment">/* bitmask of supported bits_per_word for transfers */</span>
        u32              bits_per_word_mask<span class="token punctuation">;</span>

        <span class="token comment">/* other constraints relevant to this driver */</span>
        u16              flags<span class="token punctuation">;</span> <span class="token comment">/*用于限定某些限制条件的标志位
#define SPI_MASTER_HALF_DUPLEX  BIT(0)          /* can't do full duplex */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_MASTER_NO_RX</span>        <span class="token expression"><span class="token function">BIT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>          </span><span class="token comment">/* can't do buffer read */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_MASTER_NO_TX</span>        <span class="token expression"><span class="token function">BIT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>          </span><span class="token comment">/* can't do buffer write */</span></span>

        <span class="token comment">/* lock and mutex for SPI bus locking */</span>
        <span class="token class-name">spinlock_t</span>       bus_lock_spinlock<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">mutex</span>     bus_lock_mutex<span class="token punctuation">;</span>

        <span class="token comment">/* flag indicating that the SPI bus is locked for exclusive use */</span>
        bool             bus_lock_flag<span class="token punctuation">;</span>

        <span class="token comment">/* Setup mode and clock, etc (spi driver may call many times).
         *
         * IMPORTANT:  this may be called when transfers to another
         * device are active.  DO NOT UPDATE SHARED REGISTERS in ways
         * which could break those transfers.
         */</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*根据spi设备更新硬件配置。设置spi工作模式、时钟等*/</span>

        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>transfer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">,</span>
                        <span class="token keyword">struct</span> <span class="token class-name">spi_message</span> <span class="token operator">*</span>mesg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/*添加消息到队列的方法，此函数不可睡眠。它的职责是安排发生的传送并且调用注册的回调函数complete()*/</span>

        <span class="token comment">/* called on release() to free memory provided by spi_master */</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>cleanup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*cleanup函数会在spidev_release函数中被调用，spidev_release被登记为spi dev的release函数。*/</span>

        bool                   queued<span class="token punctuation">;</span> 
        <span class="token keyword">struct</span> <span class="token class-name">kthread_worker</span>  kworker<span class="token punctuation">;</span> <span class="token comment">/*用于管理数据传输消息队列的工作队列线程*/</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span>     <span class="token operator">*</span>kworker_task<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">kthread_work</span>    pump_messages<span class="token punctuation">;</span> <span class="token comment">/*具体实现数据传输队列的工作队列*/</span>
        <span class="token class-name">spinlock_t</span>             queue_lock<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>       queue<span class="token punctuation">;</span> <span class="token comment">/*该控制器的消息队列，所有等待传输的队列挂在该链表下*/</span>
        <span class="token keyword">struct</span> <span class="token class-name">spi_message</span>     <span class="token operator">*</span>cur_msg<span class="token punctuation">;</span><span class="token comment">/*当前正在处理的消息队列*/</span>
        bool                   busy<span class="token punctuation">;</span> <span class="token operator">/</span>忙状态<span class="token operator">*</span><span class="token operator">/</span>
        bool                   running<span class="token punctuation">;</span> <span class="token comment">/*正在跑*/</span>
        bool                   rt<span class="token punctuation">;</span> 
        
        <span class="token comment">/*回调函数，正式发起传输前会被调用，用于准备硬件资源*/</span>         
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>prepare_transfer_hardware<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_master</span> <span class="token operator">*</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*单个消息的原子传输回调函数，队列中每个消息都会回调一次该回调来完成传输工作*/</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>transfer_one_message<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_master</span> <span class="token operator">*</span>master<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">spi_message</span> <span class="token operator">*</span>mesg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">/*清理回调函数*/</span>
        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>unprepare_transfer_hardware<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_master</span> <span class="token operator">*</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">/* gpio chip select */</span>
        <span class="token keyword">int</span>                    <span class="token operator">*</span>cs_gpios<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>spi_master代表一个spi控制器。</p> 
<p>要完成和SPI设备的数据传输，还需要另外两个数据结构：spi_message和spi_transfer。<br> spi_message包含了一个的spi_transfer结构序列，一旦控制器接收了一个spi_message，其中的spi_transfer应该按顺序被发送，并且不能被其它spi_message打断，所以我们认为spi_message就是一次SPI数据交换的原子操作。<br> <strong>struct spi_message</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">spi_message</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>   transfers<span class="token punctuation">;</span>        <span class="token comment">/*spi_transfer链表队列，此次消息的传输段队列，一个消息可以包含多个传输段。*/</span>

        <span class="token keyword">struct</span> <span class="token class-name">spi_device</span>  <span class="token operator">*</span>spi<span class="token punctuation">;</span>             <span class="token comment">/*传输的目的设备*/</span>
        <span class="token keyword">unsigned</span>           is_dma_mapped<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">/*如果为真，此次调用提供dma和cpu虚拟地址。*/</span>
        <span class="token comment">/* completion is reported through a callback */</span>
        <span class="token keyword">void</span>               <span class="token punctuation">(</span><span class="token operator">*</span>complete<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*异步调用完成后的回调函数*/</span>
        <span class="token keyword">void</span>               <span class="token operator">*</span>context<span class="token punctuation">;</span>         <span class="token comment">/*回调函数的参数*/</span>
        <span class="token keyword">unsigned</span>           actual_length<span class="token punctuation">;</span>    <span class="token comment">/*实际传输的长度*/</span>
        <span class="token keyword">int</span>                status<span class="token punctuation">;</span>           <span class="token comment">/*该消息的发送结果，成功被置0，否则是一个负的错误码。*/</span>

        <span class="token comment">/* for optional use by whatever driver currently owns the
         * spi_message ...  between calls to spi_async and then later
         * complete(), that's the spi_master controller driver.
         */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>   queue<span class="token punctuation">;</span>
        <span class="token keyword">void</span>               <span class="token operator">*</span>state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>链表字段queue用于把该结构挂在代表控制器的spi_master结构的queue字段上，控制器上可以同时被加入多个spi_message进行排队。另一个链表字段transfers则用于链接挂在本message下的spi_tranfer结构。complete回调函数则会在该message下的所有spi_transfer都被传输完成时被调用，以便通知协议驱动处理接收到的数据以及准备下一批需要发送的数据。我们再来看看spi_transfer结构：<br> <strong>spi_transfer</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">spi_transfer</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* it's ok if tx_buf == rx_buf (right?)
         * for MicroWire, one buffer must be null
         * buffers must work with dma_*map_single() calls, unless
         *   spi_message.is_dma_mapped reports a pre-existing mapping
         */</span>
        <span class="token keyword">const</span> <span class="token keyword">void</span>     <span class="token operator">*</span>tx_buf<span class="token punctuation">;</span>        <span class="token comment">/*发送缓冲区*/</span>
        <span class="token keyword">void</span>            <span class="token operator">*</span>rx_buf<span class="token punctuation">;</span>       <span class="token comment">/*接收缓冲区*/</span>
        <span class="token keyword">unsigned</span>        len<span class="token punctuation">;</span>           <span class="token comment">/*缓冲区长度，tx和rx的大小（字节数）。指它们各自的大小*/</span>
        <span class="token class-name">dma_addr_t</span>      tx_dma<span class="token punctuation">;</span>        <span class="token comment">/*tx的dma地址*/</span>
        <span class="token class-name">dma_addr_t</span>      rx_dma<span class="token punctuation">;</span>        <span class="token comment">/*rx的dma地址*/</span>
        <span class="token keyword">unsigned</span>        cs_change<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">/*当前spi_transfer发送完成之后重新片选*/</span>
        u8              bits_per_word<span class="token punctuation">;</span> <span class="token comment">/*每个字长的比特数，0代表使用spi_device中的默认值8*/</span>
        u16             delay_usecs<span class="token punctuation">;</span>   <span class="token comment">/*发送完成一个spi_transfer后的延时时间，此次传输结束和片选改变之间的延时，之后就会启动另一个传输或者结束整个消息*/</span>
        u32             speed_hz<span class="token punctuation">;</span>      <span class="token comment">/*通信时钟。如果是0，使用默认值*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SPI_LOMBO</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">lombo_spi_operate_para</span> <span class="token operator">*</span>esop<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> transfer_list<span class="token punctuation">;</span> <span class="token comment">/*用于链接到spi_message，用来连接的双向链接节点*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>首先，transfer_list链表字段用于把该transfer挂在一个spi_message结构中，tx_buf和rx_buf提供了非dma模式下的数据缓冲区地址，len则是需要传输数据的长度，tx_dma和rx_dma则给出了dma模式下的缓冲区地址。原则来讲，spi_transfer才是传输的最小单位，之所以又引进了spi_message进行打包，我觉得原因是：有时候希望往spi设备的多个不连续的地址（或寄存器）一次性写入，如果没有spi_message进行把这样的多个spi_transfer打包，因为通常真正的数据传送工作是在另一个内核线程（工作队列）中完成的，不打包的后果就是会造成更多的进程切换，效率降低，延迟增加，尤其对于多个不连续地址的小规模数据传送而言就更为明显。</p> 
<p><strong>spi_board_info</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">spi_board_info</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* the device name and module name are coupled, like platform_bus;
         * "modalias" is normally the driver name.
         *
         * platform_data goes to spi_device.dev.platform_data,
         * controller_data goes to spi_device.controller_data,
         * irq is copied too
         */</span>
        <span class="token keyword">char</span>            modalias<span class="token punctuation">[</span>SPI_NAME_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/*名字*/</span>
        <span class="token keyword">const</span> <span class="token keyword">void</span>      <span class="token operator">*</span>platform_data<span class="token punctuation">;</span> <span class="token comment">/*平台数据*/</span>
        <span class="token keyword">void</span>            <span class="token operator">*</span>controller_data<span class="token punctuation">;</span> <span class="token comment">/*控制器数据*/</span>
        <span class="token keyword">int</span>             irq<span class="token punctuation">;</span>

        <span class="token comment">/* slower signaling on noisy or low voltage boards */</span>
        u32             max_speed_hz<span class="token punctuation">;</span> <span class="token comment">/*最大速率*/</span>
        u16             bus_num<span class="token punctuation">;</span> <span class="token comment">/*spi总线编号*/</span>
        u16             chip_select<span class="token punctuation">;</span> <span class="token comment">/*片选*/</span>
        u8              mode<span class="token punctuation">;</span> <span class="token comment">/*模式 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_253"></a>数据传输流程</h3> 
<p>整体的数据传输流程大致上是这样的:</p> 
<ol><li>定义一个spi_message结构；</li><li>用spi_message_init函数初始化spi_message；</li><li>定义一个或数个spi_transfer结构，初始化并为数据准备缓冲区并赋值给spi_transfer相应的字段（tx_buf，rx_buf等）；</li><li>通过spi_message_init函数把这些spi_transfer挂在spi_message结构下；</li><li>如果使用同步方式，调用spi_sync()，如果使用异步方式，调用spi_async();(我调试外设时，只使用过spi_sync</li></ol> 
<p>传输示意图如图所示：<br> <img src="https://images2.imgbox.com/18/99/xO3PeUKD_o.png" alt="在这里插入图片描述"><br> 数据准备</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">spi_message_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_message</span> <span class="token operator">*</span>m<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">memset</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token operator">-&gt;</span>transfers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>初始化spi_message：清空message，初始化transfers链表头。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span>
<span class="token function">spi_message_add_tail</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_transfer</span> <span class="token operator">*</span>t<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">spi_message</span> <span class="token operator">*</span>m<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>transfer_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token operator">-&gt;</span>transfers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将spi_transfer加入到spi_message的链表尾部。</p> 
<p><strong>数据传输</strong><br> SPI数据传输可以有两种方式：同步方式和异步方式。所谓同步方式是指数据传输的发起者必须等待本次传输的结束，期间不能做其它事情，用代码来解释就是，调用传输的函数后，直到数据传输完成，函数才会返回。而异步方式则正好相反，数据传输的发起者无需等待传输的结束，数据传输期间还可以做其它事情，用代码来解释就是，调用传输的函数后，函数会立刻返回而不用等待数据传输完成，我们只需设置一个回调函数，传输完成后，该回调函数会被调用以通知发起者数据传送已经完成。同步方式简单易用，很适合处理那些少量数据的单次传输。但是对于数据量大、次数多的传输来说，异步方式就显得更加合适。<br> 对于SPI控制器来说，要支持异步方式必须要考虑以下两种状况：</p> 
<ul><li>对于同一个数据传输的发起者，既然异步方式无需等待数据传输完成即可返回，返回后，该发起者可以立刻又发起一个message，而这时上一个message还没有处理完。</li><li>对于另外一个不同的发起者来说，也有可能同时发起一次message传输请求，首先分析spi_sync()接口的实现流程，如图：<br> <img src="https://images2.imgbox.com/11/5e/ovezcUcw_o.png" alt="在这里插入图片描述"><br> 其次分析spi_async_locked接口的实现流程，如图所示：<br> <img src="https://images2.imgbox.com/30/c2/5CwxvgnV_o.png" alt="在这里插入图片描述"><br> spi_queued_transfer接口的实现流程如图所示：<br> <img src="https://images2.imgbox.com/f1/e2/1WGMpWPi_o.png" alt="在这里插入图片描述"><br> spi_pump_messages函数的处理流程如图所示：<br> <img src="https://images2.imgbox.com/fd/9e/RSXykU5I_o.png" alt="在这里插入图片描述"><br> 图中transfer_one_message是spi控制器驱动要实现的，主要功能是处理spi_message中的每个spi_transfer。</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">spi_sync</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">spi_message</span> <span class="token operator">*</span>message<span class="token punctuation">)</span>
</code></pre> 
<p>同步传输会阻塞的等待 SPI 数据传输完成。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">spi_async</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">spi_message</span> <span class="token operator">*</span>message<span class="token punctuation">)</span>
</code></pre> 
<p>异步传输不会阻塞的等到 SPI 数据传输完成，异步传输需要设置 spi_message 中的 complete 成员变量，complete 是一个回调函数，当 SPI 异步传输完成以后此函数就会被调用。</p> 
<h3><a id="_306"></a>关键函数解析</h3> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">spi_master</span> <span class="token operator">*</span><span class="token function">spi_alloc_master</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> size<span class="token punctuation">)</span>
</code></pre> 
<p>功能：<br> 分配一个spi_master结构体指针。<br> 参数：<br> dev:spi控制器device指针<br> size ：分配的driver-private data大小<br> 返回值 ：<br> 成功，返回spi_master指针；否则返回NULL</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">spi_register_master</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_master</span> <span class="token operator">*</span>master<span class="token punctuation">)</span> 
</code></pre> 
<p>功能：注册spi控制器驱动到内核。<br> 参数<br> master：spi_master指针<br> 返回值：成功，返回0；否则返回错误码</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">spi_unregister_master</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_master</span> <span class="token operator">*</span>master<span class="token punctuation">)</span> 
</code></pre> 
<p>功能：注销spi控制器驱动。<br> 参数：master：spi_master指针</p> 
<p>还有一个每个 spi 驱动都要调用的 spi_setup( struct spi_device *spi )</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">spi_setup</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span>	bad_bits<span class="token punctuation">,</span> ugly_bits<span class="token punctuation">;</span>
	<span class="token keyword">int</span>		status<span class="token punctuation">;</span>
 
	<span class="token comment">/* check mode to prevent that DUAL and QUAD set at the same time
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> SPI_TX_DUAL<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> SPI_TX_QUAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
		<span class="token punctuation">(</span><span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> SPI_RX_DUAL<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> SPI_RX_QUAD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span><span class="token string">"setup: can not select dual and quad at the same time\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/* if it is SPI_3WIRE mode, DUAL and QUAD should be forbidden
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> SPI_3WIRE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span>
		<span class="token punctuation">(</span>SPI_TX_DUAL <span class="token operator">|</span> SPI_TX_QUAD <span class="token operator">|</span> SPI_RX_DUAL <span class="token operator">|</span> SPI_RX_QUAD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token comment">/* help drivers fail *cleanly* when they need options
	 * that aren't supported with their current master
	 */</span>
	bad_bits <span class="token operator">=</span> spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> <span class="token operator">~</span>spi<span class="token operator">-&gt;</span>master<span class="token operator">-&gt;</span>mode_bits<span class="token punctuation">;</span>
	ugly_bits <span class="token operator">=</span> bad_bits <span class="token operator">&amp;</span>
		    <span class="token punctuation">(</span>SPI_TX_DUAL <span class="token operator">|</span> SPI_TX_QUAD <span class="token operator">|</span> SPI_RX_DUAL <span class="token operator">|</span> SPI_RX_QUAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ugly_bits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">dev_warn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>
			 <span class="token string">"setup: ignoring unsupported mode bits %x\n"</span><span class="token punctuation">,</span>
			 ugly_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
		spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;=</span> <span class="token operator">~</span>ugly_bits<span class="token punctuation">;</span>
		bad_bits <span class="token operator">&amp;=</span> <span class="token operator">~</span>ugly_bits<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bad_bits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"setup: unsupported mode bits %x\n"</span><span class="token punctuation">,</span>
			bad_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spi<span class="token operator">-&gt;</span>bits_per_word<span class="token punctuation">)</span>
		spi<span class="token operator">-&gt;</span>bits_per_word <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
 
	status <span class="token operator">=</span> <span class="token function">__spi_validate_bits_per_word</span><span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>master<span class="token punctuation">,</span> spi<span class="token operator">-&gt;</span>bits_per_word<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span>
		<span class="token keyword">return</span> status<span class="token punctuation">;</span>
 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spi<span class="token operator">-&gt;</span>max_speed_hz<span class="token punctuation">)</span>
		spi<span class="token operator">-&gt;</span>max_speed_hz <span class="token operator">=</span> spi<span class="token operator">-&gt;</span>master<span class="token operator">-&gt;</span>max_speed_hz<span class="token punctuation">;</span>
 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>master<span class="token operator">-&gt;</span>setup<span class="token punctuation">)</span>
		status <span class="token operator">=</span> spi<span class="token operator">-&gt;</span>master<span class="token operator">-&gt;</span><span class="token function">setup</span><span class="token punctuation">(</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token function">spi_set_cs</span><span class="token punctuation">(</span>spi<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token function">dev_dbg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"setup mode %d, %s%s%s%s%u bits/w, %u Hz max --&gt; %d\n"</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>SPI_CPOL <span class="token operator">|</span> SPI_CPHA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> SPI_CS_HIGH<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"cs_high, "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> SPI_LSB_FIRST<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"lsb, "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> SPI_3WIRE<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"3wire, "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>mode <span class="token operator">&amp;</span> SPI_LOOP<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"loopback, "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
			spi<span class="token operator">-&gt;</span>bits_per_word<span class="token punctuation">,</span> spi<span class="token operator">-&gt;</span>max_speed_hz<span class="token punctuation">,</span>
			status<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>spi_setup 函数实际上的工作就是去告知 SPI 主控器该怎么配置 SPI 的时序参数。<br> 对于我们只需要在驱动加载之前，将配置好的 spi 设备指针交给 spi_setup 函数就行了。</p> 
<h2><a id="SPI__401"></a>实例分析：SPI 陀螺仪驱动</h2> 
<p>先上原理图：<br> <img src="https://images2.imgbox.com/9f/50/Da9ayEq9_o.png" alt="在这里插入图片描述"><br> 实验用到的一些寄存器和位：<br> <img src="https://images2.imgbox.com/13/3f/H5B28RoW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ef/a0/K5i4zLUA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_407"></a>修改设备树</h3> 
<pre><code class="prism language-c"><span class="token comment">/* IO 复用 */</span>
pinctrl_ecspi3<span class="token operator">:</span> icm20608 <span class="token punctuation">{<!-- --></span>
 fsl<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span>
     MX6UL_PAD_UART2_TX_DATA__GPIO1_IO20 <span class="token number">0x10b0</span>  <span class="token comment">/* CS */</span>
     MX6UL_PAD_UART2_RX_DATA__ECSPI3_SCLK <span class="token number">0x10b1</span> <span class="token comment">/* SCLK */</span>
     MX6UL_PAD_UART2_RTS_B__ECSPI3_MISO <span class="token number">0x10b1</span>   <span class="token comment">/* MISO */</span>
     MX6UL_PAD_UART2_CTS_B__ECSPI3_MOSI <span class="token number">0x10b1</span>   <span class="token comment">/* MOSI */</span>
 <span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 在SPI设备节点下，增加设备节点 */</span>
<span class="token operator">&amp;</span>ecspi3 <span class="token punctuation">{<!-- --></span>
 fsl<span class="token punctuation">,</span>spi<span class="token operator">-</span>num<span class="token operator">-</span>chipselects <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>            <span class="token comment">//片选数量设为 1，只接了一个设备嘛</span>
 cs<span class="token operator">-</span>gpio <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 <span class="token number">20</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">//一个SPI控制器上或许有多个cs，不够的话也可以使用普通的GPIO来控制，用到的话就加到设备节点里就行了</span>
 pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>                <span class="token comment">//默认功能，没有添加其他功能的话，就是 SPI 功能了</span>
 pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_ecspi3<span class="token operator">&gt;</span><span class="token punctuation">;</span>            <span class="token comment">//设置 IO 要使用的 pinctrl 子节点：pinctrl_ecspi3，就是上面那个</span>
 status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>

 spidev<span class="token operator">:</span> icm20608@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
     compatible <span class="token operator">=</span> <span class="token string">"alientek,icm20608"</span><span class="token punctuation">;</span>
     spi<span class="token operator">-</span>max<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">8000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>        <span class="token comment">//这里是8M，根据模块支持的最大时钟频率来改</span>
     reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">//spi设备是没有设备地址的, 这里是指使用spi控制器的cs-gpios里的第几个片选io</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>SPI设备树参考资料：https://blog.csdn.net/jklinux/article/details/78701702</p> 
<h3><a id="_436"></a>编写驱动程序</h3> 
<p>思路：</p> 
<ol><li>先完成驱动框架</li><li>再完成通信功能</li><li>最后加上业务<br> 按照之前的寄存器地址表，把寄存器先写好放设备头文件：</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">ICM20608_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ICM20608_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ICM20608G_ID</span>            <span class="token expression"><span class="token number">0XAF</span>    </span><span class="token comment">/* ID值 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ICM20608D_ID</span>            <span class="token expression"><span class="token number">0XAE</span>    </span><span class="token comment">/* ID值 */</span></span>

<span class="token comment">/* ICM20608寄存器 
 *复位后所有寄存器地址都为0，除了
 *Register 107(0X6B) Power Management 1     = 0x40
 *Register 117(0X75) WHO_AM_I                 = 0xAF或0xAE
 */</span>
<span class="token comment">/* 陀螺仪和加速度自测(出产时设置，用于与用户的自检输出值比较） */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_SELF_TEST_X_GYRO</span>        <span class="token expression"><span class="token number">0x00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_SELF_TEST_Y_GYRO</span>        <span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_SELF_TEST_Z_GYRO</span>        <span class="token expression"><span class="token number">0x02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_SELF_TEST_X_ACCEL</span>       <span class="token expression"><span class="token number">0x0D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_SELF_TEST_Y_ACCEL</span>       <span class="token expression"><span class="token number">0x0E</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_SELF_TEST_Z_ACCEL</span>       <span class="token expression"><span class="token number">0x0F</span></span></span>

<span class="token comment">/* 陀螺仪静态偏移 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_XG_OFFS_USRH</span>            <span class="token expression"><span class="token number">0x13</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_XG_OFFS_USRL</span>            <span class="token expression"><span class="token number">0x14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_YG_OFFS_USRH</span>            <span class="token expression"><span class="token number">0x15</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_YG_OFFS_USRL</span>            <span class="token expression"><span class="token number">0x16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ZG_OFFS_USRH</span>            <span class="token expression"><span class="token number">0x17</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ZG_OFFS_USRL</span>            <span class="token expression"><span class="token number">0x18</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_SMPLRT_DIV</span>             <span class="token expression"><span class="token number">0x19</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_CONFIG</span>                 <span class="token expression"><span class="token number">0x1A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_GYRO_CONFIG</span>            <span class="token expression"><span class="token number">0x1B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_CONFIG</span>           <span class="token expression"><span class="token number">0x1C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_CONFIG2</span>          <span class="token expression"><span class="token number">0x1D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_LP_MODE_CFG</span>            <span class="token expression"><span class="token number">0x1E</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_WOM_THR</span>          <span class="token expression"><span class="token number">0x1F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_FIFO_EN</span>                <span class="token expression"><span class="token number">0x23</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_FSYNC_INT</span>              <span class="token expression"><span class="token number">0x36</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_INT_PIN_CFG</span>            <span class="token expression"><span class="token number">0x37</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_INT_ENABLE</span>             <span class="token expression"><span class="token number">0x38</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_INT_STATUS</span>             <span class="token expression"><span class="token number">0x3A</span></span></span>

<span class="token comment">/* 加速度输出 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_XOUT_H</span>           <span class="token expression"><span class="token number">0x3B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_XOUT_L</span>           <span class="token expression"><span class="token number">0x3C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_YOUT_H</span>           <span class="token expression"><span class="token number">0x3D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_YOUT_L</span>           <span class="token expression"><span class="token number">0x3E</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_ZOUT_H</span>           <span class="token expression"><span class="token number">0x3F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_ZOUT_L</span>           <span class="token expression"><span class="token number">0x40</span></span></span>

<span class="token comment">/* 温度输出 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_TEMP_OUT_H</span>             <span class="token expression"><span class="token number">0x41</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_TEMP_OUT_L</span>             <span class="token expression"><span class="token number">0x42</span></span></span>

<span class="token comment">/* 陀螺仪输出 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_GYRO_XOUT_H</span>            <span class="token expression"><span class="token number">0x43</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_GYRO_XOUT_L</span>            <span class="token expression"><span class="token number">0x44</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_GYRO_YOUT_H</span>            <span class="token expression"><span class="token number">0x45</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_GYRO_YOUT_L</span>            <span class="token expression"><span class="token number">0x46</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_GYRO_ZOUT_H</span>            <span class="token expression"><span class="token number">0x47</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_GYRO_ZOUT_L</span>            <span class="token expression"><span class="token number">0x48</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_SIGNAL_PATH_RESET</span>      <span class="token expression"><span class="token number">0x68</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ACCEL_INTEL_CTRL</span>       <span class="token expression"><span class="token number">0x69</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_USER_CTRL</span>              <span class="token expression"><span class="token number">0x6A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_PWR_MGMT_1</span>             <span class="token expression"><span class="token number">0x6B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_PWR_MGMT_2</span>             <span class="token expression"><span class="token number">0x6C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_FIFO_COUNTH</span>            <span class="token expression"><span class="token number">0x72</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_FIFO_COUNTL</span>            <span class="token expression"><span class="token number">0x73</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_FIFO_R_W</span>               <span class="token expression"><span class="token number">0x74</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_WHO_AM_I</span>               <span class="token expression"><span class="token number">0x75</span></span></span>

<span class="token comment">/* 加速度静态偏移 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_XA_OFFSET_H</span>            <span class="token expression"><span class="token number">0x77</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_XA_OFFSET_L</span>            <span class="token expression"><span class="token number">0x78</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_YA_OFFSET_H</span>            <span class="token expression"><span class="token number">0x7A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_YA_OFFSET_L</span>            <span class="token expression"><span class="token number">0x7B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ZA_OFFSET_H</span>            <span class="token expression"><span class="token number">0x7D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">ICM20_ZA_OFFSET_L</span>            <span class="token expression"><span class="token number">0x7E</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>数据定义和数据结构：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ICM20608_CNT</span>    <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ICM20608_NAME</span>    <span class="token string">"icm20608"</span></span>

<span class="token keyword">struct</span> <span class="token class-name">icm20608_dev</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">dev_t</span> devid<span class="token punctuation">;</span>                <span class="token comment">/* 设备号      */</span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>            <span class="token comment">/* cdev     */</span>
    <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>        <span class="token comment">/* 类         */</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span>        <span class="token comment">/* 设备      */</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span>    <span class="token operator">*</span>nd<span class="token punctuation">;</span>     <span class="token comment">/* 设备节点 */</span>
    <span class="token keyword">int</span> major<span class="token punctuation">;</span>                    <span class="token comment">/* 主设备号 */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>private_data<span class="token punctuation">;</span>            <span class="token comment">/* 私有数据         */</span>
    <span class="token keyword">int</span> cs_gpio<span class="token punctuation">;</span>                <span class="token comment">/* 片选所使用的GPIO编号        */</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> gyro_x_adc<span class="token punctuation">;</span>        <span class="token comment">/* 陀螺仪X轴原始值      */</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> gyro_y_adc<span class="token punctuation">;</span>        <span class="token comment">/* 陀螺仪Y轴原始值        */</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> gyro_z_adc<span class="token punctuation">;</span>        <span class="token comment">/* 陀螺仪Z轴原始值         */</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> accel_x_adc<span class="token punctuation">;</span>        <span class="token comment">/* 加速度计X轴原始值     */</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> accel_y_adc<span class="token punctuation">;</span>        <span class="token comment">/* 加速度计Y轴原始值    */</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> accel_z_adc<span class="token punctuation">;</span>        <span class="token comment">/* 加速度计Z轴原始值     */</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> temp_adc<span class="token punctuation">;</span>        <span class="token comment">/* 温度原始值             */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">icm20608_dev</span> icm20608dev<span class="token punctuation">;</span>
</code></pre> 
<p>SPI 读写函数：</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * 功能: 读取icm20608指定寄存器值，读取一个寄存器
 * dev:  icm20608设备；
reg:  要读取的寄存器
 * 返回: 读取到的寄存器值
 */</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">icm20608_read_onereg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icm20608_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> u8 reg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">icm20608_read_regs</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> reg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
 * 功能: 从icm20608读取多个寄存器数据

 * reg:  要读取的寄存器首地址
；val:  读取到的数据
；len:  要读取的数据长度

 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">icm20608_read_regs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icm20608_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> u8 reg<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> txdata<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_message</span> m<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_transfer</span> <span class="token operator">*</span>t<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span><span class="token punctuation">)</span>dev<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>

    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>cs_gpio<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">/* 片选拉低，选中ICM20608 */</span>
    t <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_transfer</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 申请内存 */</span>

    <span class="token comment">/* 第1次，发送要读取的寄存地址 */</span>
    txdata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> reg <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">;</span>                <span class="token comment">/* 写数据的时候寄存器地址bit8要置1 */</span>
    t<span class="token operator">-&gt;</span>tx_buf <span class="token operator">=</span> txdata<span class="token punctuation">;</span>                    <span class="token comment">/* 要发送的数据 */</span>
    t<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                            <span class="token comment">/* 1个字节 */</span>
    <span class="token function">spi_message_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">/* 初始化spi_message */</span>
    <span class="token function">spi_message_add_tail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 将spi_transfer添加到spi_message队列 */</span>
    ret <span class="token operator">=</span> <span class="token function">spi_sync</span><span class="token punctuation">(</span>spi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/* 同步发送 */</span>

    <span class="token comment">/* 第2次，读取数据 */</span>
    txdata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xff</span><span class="token punctuation">;</span>                    <span class="token comment">/* 随便一个值，此处无意义 */</span>
    t<span class="token operator">-&gt;</span>rx_buf <span class="token operator">=</span> buf<span class="token punctuation">;</span>                    <span class="token comment">/* 读取到的数据 */</span>
    t<span class="token operator">-&gt;</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>                        <span class="token comment">/* 要读取的数据长度 */</span>
    <span class="token function">spi_message_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">/* 初始化spi_message */</span>
    <span class="token function">spi_message_add_tail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 将spi_transfer添加到spi_message队列 */</span>
    ret <span class="token operator">=</span> <span class="token function">spi_sync</span><span class="token punctuation">(</span>spi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/* 同步发送 */</span>

    <span class="token function">kfree</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/* 释放内存 */</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>cs_gpio<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 片选拉高，释放ICM20608 */</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 *
 功能: 向icm20608指定寄存器写入指定的值，写一个寄存器
 * dev:  icm20608设备
；reg:  要写的寄存器
；data: 要写入的值

 */</span>    

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icm20608_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> u8 reg<span class="token punctuation">,</span> u8 value<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 buf <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token function">icm20608_write_regs</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> reg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
 * @description    : 向icm20608多个寄存器写入数据

 * reg:  要写入的寄存器首地址
；val:  要写入的数据缓冲区
；len:  要写入的数据长度

 */</span>
<span class="token keyword">static</span> s32 <span class="token function">icm20608_write_regs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icm20608_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> u8 reg<span class="token punctuation">,</span> u8 <span class="token operator">*</span>buf<span class="token punctuation">,</span> u8 len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> txdata<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_message</span> m<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_transfer</span> <span class="token operator">*</span>t<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span><span class="token punctuation">)</span>dev<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>

    t <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_transfer</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 申请内存 */</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>cs_gpio<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/* 片选拉低 */</span>

    <span class="token comment">/* 第1次，发送要读取的寄存地址 */</span>
    txdata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> reg <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0x80</span><span class="token punctuation">;</span>            <span class="token comment">/* 写数据的时候寄存器地址bit8要清零 */</span>
    t<span class="token operator">-&gt;</span>tx_buf <span class="token operator">=</span> txdata<span class="token punctuation">;</span>                    <span class="token comment">/* 要发送的数据 */</span>
    t<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                            <span class="token comment">/* 1个字节 */</span>
    <span class="token function">spi_message_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">/* 初始化spi_message */</span>
    <span class="token function">spi_message_add_tail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 将spi_transfer添加到spi_message队列 */</span>
    ret <span class="token operator">=</span> <span class="token function">spi_sync</span><span class="token punctuation">(</span>spi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/* 同步发送 */</span>

    <span class="token comment">/* 第2次，发送要写入的数据 */</span>
    t<span class="token operator">-&gt;</span>tx_buf <span class="token operator">=</span> buf<span class="token punctuation">;</span>                    <span class="token comment">/* 要写入的数据 */</span>
    t<span class="token operator">-&gt;</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>                        <span class="token comment">/* 写入的字节数 */</span>
    <span class="token function">spi_message_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">/* 初始化spi_message */</span>
    <span class="token function">spi_message_add_tail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 将spi_transfer添加到spi_message队列 */</span>
    ret <span class="token operator">=</span> <span class="token function">spi_sync</span><span class="token punctuation">(</span>spi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/* 同步发送 */</span>

    <span class="token function">kfree</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/* 释放内存 */</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>cs_gpio<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 片选拉高，释放ICM20608 */</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>业务函数：读取陀螺仪数据</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 功能: 读取ICM20608的数据，读取原始数据，包括三轴陀螺仪、
三轴加速度计和内部温度 */</span>
<span class="token comment">/* 数据读取到设备！！！然后 read 操作的时候，就可以直接从设备结构体传输给应用层了 */</span>
<span class="token keyword">void</span> <span class="token function">icm20608_readdata</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icm20608_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">icm20608_read_regs</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> ICM20_ACCEL_XOUT_H<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    dev<span class="token operator">-&gt;</span>accel_x_adc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    dev<span class="token operator">-&gt;</span>accel_y_adc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    dev<span class="token operator">-&gt;</span>accel_z_adc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    dev<span class="token operator">-&gt;</span>temp_adc    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    dev<span class="token operator">-&gt;</span>gyro_x_adc  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> data<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    dev<span class="token operator">-&gt;</span>gyro_y_adc  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> data<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>gyro_z_adc  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> data<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* open 操作，把设备指针给文件指针，read 的时候可以直接从文件指针读 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">icm20608_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    filp<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> <span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">;</span> <span class="token comment">/* 设置私有数据 */</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* read 操作，把文件指针强转为设备指针，然后数据全部拿走 */</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">icm20608_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cnt<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>off<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">icm20608_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icm20608_dev</span> <span class="token operator">*</span><span class="token punctuation">)</span>filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>

    <span class="token function">icm20608_readdata</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>gyro_x_adc<span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>gyro_y_adc<span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>gyro_z_adc<span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>accel_x_adc<span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>accel_y_adc<span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>accel_z_adc<span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>temp_adc<span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//传输给应用层</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>补充操作集</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">icm20608_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* icm20608操作函数 */</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> icm20608_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> icm20608_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> icm20608_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> icm20608_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>业务函数：初始化陀螺仪设备</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">icm20608_reginit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_PWR_MGMT_1<span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mdelay</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_PWR_MGMT_1<span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mdelay</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    value <span class="token operator">=</span> <span class="token function">icm20608_read_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_WHO_AM_I<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ICM20608 ID = %#X\r\n"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>    

    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_SMPLRT_DIV<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 输出速率是内部采样率 */</span>
    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_GYRO_CONFIG<span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 陀螺仪±2000dps量程 */</span>
    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_ACCEL_CONFIG<span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 加速度计±16G量程 */</span>
    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_CONFIG<span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">/* 陀螺仪低通滤波BW=20Hz */</span>
    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_ACCEL_CONFIG2<span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 加速度计低通滤波BW=21.2Hz */</span>
    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_PWR_MGMT_2<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 打开加速度计和陀螺仪所有轴 */</span>
    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_LP_MODE_CFG<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 关闭低功耗 */</span>
    <span class="token function">icm20608_write_onereg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">,</span> ICM20_FIFO_EN<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 关闭FIFO    */</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>完成 spi 驱动结构体</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">icm20608_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* 1、构建设备号 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>major<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        icm20608dev<span class="token punctuation">.</span>devid <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> ICM20608_CNT<span class="token punctuation">,</span> ICM20608_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ICM20608_CNT<span class="token punctuation">,</span> ICM20608_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        icm20608dev<span class="token punctuation">.</span>major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>devid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 2、注册设备 */</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>icm20608_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span> icm20608dev<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> ICM20608_CNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 3、创建类 */</span>
    icm20608dev<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> ICM20608_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 4、创建设备 */</span>
    icm20608dev<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> icm20608dev<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> ICM20608_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 获取设备树中cs片选信号 */</span>
    icm20608dev<span class="token punctuation">.</span>nd <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/soc/aips-bus@02000000/spba-bus@02000000/ecspi@02010000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这一步可取的原因是设备树上使能的设备都会在 sysfs 文件系统中出现</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>nd <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ecspi3 node not find!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

    <span class="token comment">/* 2、 获取设备树中的gpio属性，得到BEEP所使用的BEEP编号 */</span>
    icm20608dev<span class="token punctuation">.</span>cs_gpio <span class="token operator">=</span> <span class="token function">of_get_named_gpio</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>nd<span class="token punctuation">,</span> <span class="token string">"cs-gpio"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>cs_gpio <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"can't get cs-gpio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 3、设置GPIO1_IO20为输出，并且输出高电平 */</span>
    ret <span class="token operator">=</span> <span class="token function">gpio_direction_output</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>cs_gpio<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"can't set gpio!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*初始化spi_device */</span>
    spi<span class="token operator">-&gt;</span>mode <span class="token operator">=</span> SPI_MODE_0<span class="token punctuation">;</span>    <span class="token comment">/*MODE0，CPOL=0，CPHA=0*/</span>
    <span class="token function">spi_setup</span><span class="token punctuation">(</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    icm20608dev<span class="token punctuation">.</span>private_data <span class="token operator">=</span> spi<span class="token punctuation">;</span> <span class="token comment">/* 设置私有数据 */</span>

    <span class="token comment">/* 初始化ICM20608内部寄存器 */</span>
    <span class="token function">icm20608_reginit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">icm20608_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* 删除设备 */</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608dev<span class="token punctuation">.</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>devid<span class="token punctuation">,</span> ICM20608_CNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 注销掉类和设备 */</span>
    <span class="token function">device_destroy</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>class<span class="token punctuation">,</span> icm20608dev<span class="token punctuation">.</span>devid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>icm20608dev<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 设备树匹配列表 */</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> icm20608_of_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"alientek,icm20608"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">/* Sentinel */</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* SPI驱动结构体 */</span>    
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">spi_driver</span> icm20608_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> icm20608_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> icm20608_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
               <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"icm20608"</span><span class="token punctuation">,</span>
               <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> icm20608_of_match<span class="token punctuation">,</span> 
           <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>id_table <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>最后完成出入口函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">icm20608_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">spi_register_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">icm20608_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">spi_unregister_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icm20608_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>icm20608_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>icm20608_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>编写测试程序：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">;</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> databuf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> gyro_x_adc<span class="token punctuation">,</span> gyro_y_adc<span class="token punctuation">,</span> gyro_z_adc<span class="token punctuation">;</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> accel_x_adc<span class="token punctuation">,</span> accel_y_adc<span class="token punctuation">,</span> accel_z_adc<span class="token punctuation">;</span>
    <span class="token keyword">signed</span> <span class="token keyword">int</span> temp_adc<span class="token punctuation">;</span>

    <span class="token keyword">float</span> gyro_x_act<span class="token punctuation">,</span> gyro_y_act<span class="token punctuation">,</span> gyro_z_act<span class="token punctuation">;</span>
    <span class="token keyword">float</span> accel_x_act<span class="token punctuation">,</span> accel_y_act<span class="token punctuation">,</span> accel_z_act<span class="token punctuation">;</span>
    <span class="token keyword">float</span> temp_act<span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error Usage!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    filename <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open file %s\r\n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> databuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>databuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>             <span class="token comment">/* 数据读取成功 */</span>
            gyro_x_adc <span class="token operator">=</span> databuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            gyro_y_adc <span class="token operator">=</span> databuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            gyro_z_adc <span class="token operator">=</span> databuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            accel_x_adc <span class="token operator">=</span> databuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            accel_y_adc <span class="token operator">=</span> databuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            accel_z_adc <span class="token operator">=</span> databuf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            temp_adc <span class="token operator">=</span> databuf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment">/* 计算实际值 */</span>
            gyro_x_act <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gyro_x_adc<span class="token punctuation">)</span>  <span class="token operator">/</span> <span class="token number">16.4</span><span class="token punctuation">;</span>
            gyro_y_act <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gyro_y_adc<span class="token punctuation">)</span>  <span class="token operator">/</span> <span class="token number">16.4</span><span class="token punctuation">;</span>
            gyro_z_act <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gyro_z_adc<span class="token punctuation">)</span>  <span class="token operator">/</span> <span class="token number">16.4</span><span class="token punctuation">;</span>
            accel_x_act <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>accel_x_adc<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2048</span><span class="token punctuation">;</span>
            accel_y_act <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>accel_y_adc<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2048</span><span class="token punctuation">;</span>
            accel_z_act <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>accel_z_adc<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2048</span><span class="token punctuation">;</span>
            temp_act <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>temp_adc<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">25</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">326.8</span> <span class="token operator">+</span> <span class="token number">25</span><span class="token punctuation">;</span>


            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n原始值:\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"gx = %d, gy = %d, gz = %d\r\n"</span><span class="token punctuation">,</span> gyro_x_adc<span class="token punctuation">,</span> gyro_y_adc<span class="token punctuation">,</span> gyro_z_adc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ax = %d, ay = %d, az = %d\r\n"</span><span class="token punctuation">,</span> accel_x_adc<span class="token punctuation">,</span> accel_y_adc<span class="token punctuation">,</span> accel_z_adc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"temp = %d\r\n"</span><span class="token punctuation">,</span> temp_adc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"实际值:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"act gx = %.2f°/S, act gy = %.2f°/S, act gz = %.2f°/S\r\n"</span><span class="token punctuation">,</span> gyro_x_act<span class="token punctuation">,</span> gyro_y_act<span class="token punctuation">,</span> gyro_z_act<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"act ax = %.2fg, act ay = %.2fg, act az = %.2fg\r\n"</span><span class="token punctuation">,</span> accel_x_act<span class="token punctuation">,</span> accel_y_act<span class="token punctuation">,</span> accel_z_act<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"act temp = %.2f°C\r\n"</span><span class="token punctuation">,</span> temp_act<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*100ms */</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 关闭文件 */</span>    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试程序用到了浮点数运算，大多数处理器都是支持硬件浮点数运算的，一般都是有使能这个模块，如果没有，就需要手动使能了。<br> 测试结果：<br> <img src="https://images2.imgbox.com/1c/67/bJen8BJ7_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_SPI__930"></a>实例：瑞芯微 SPI 设备驱动</h2> 
<p>瑞芯微官方SPI主机驱动源码：rk356x_linux/kernel/drivers/spi/spi-rockchip.c<br> SPI 设备测试源码：spi-rockchip-test.c<br> 对于非原厂的 SPI 工程师我们来看 SPI 设备测试源码：spi-rockchip-test.c</p> 
<p>首先是官方建议设备树：</p> 
<pre><code class="prism language-c"><span class="token comment">/* dts config */</span>
<span class="token operator">&amp;</span>spi0 <span class="token punctuation">{<!-- --></span>
    status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    max<span class="token operator">-</span>freq <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">48000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>   <span class="token comment">//spi internal clk, don't modify</span>
    <span class="token comment">//dma-names = "tx", "rx";   //enable dma</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>  <span class="token comment">//pinctrl according to you board</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>spi0_clk <span class="token operator">&amp;</span>spi0_tx <span class="token operator">&amp;</span>spi0_rx <span class="token operator">&amp;</span>spi0_cs0 <span class="token operator">&amp;</span>spi0_cs1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    spi_test@<span class="token number">00</span> <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"rockchip,spi_test_bus0_cs0"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>   <span class="token comment">//chip select  0:cs0  1:cs1</span>
        id <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        spi<span class="token operator">-</span>max<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">24000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>   <span class="token comment">//spi output clock</span>
        <span class="token comment">//spi-cpha;      not support</span>
        <span class="token comment">//spi-cpol;     //if the property is here it is 1:clk is high, else 0:clk is low  when idle</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    spi_test@<span class="token number">01</span> <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"rockchip,spi_test_bus0_cs1"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        id <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        spi<span class="token operator">-</span>max<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">24000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        spi<span class="token operator">-</span>cpha<span class="token punctuation">;</span>
        spi<span class="token operator">-</span>cpol<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>官方提供了实例，也提供了测试方法：</p> 
<pre><code class="prism language-c"><span class="token comment">/* how to test spi */</span>
echo write <span class="token number">0</span> <span class="token number">10</span> <span class="token number">255</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>dev<span class="token operator">/</span>spi_misc_test
echo write <span class="token number">0</span> <span class="token number">10</span> <span class="token number">255</span> init<span class="token punctuation">.</span>rc <span class="token operator">&gt;</span> <span class="token operator">/</span>dev<span class="token operator">/</span>spi_misc_test
echo read <span class="token number">0</span> <span class="token number">10</span> <span class="token number">255</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>dev<span class="token operator">/</span>spi_misc_test
echo loop <span class="token number">0</span> <span class="token number">10</span> <span class="token number">255</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>dev<span class="token operator">/</span>spi_misc_test
echo setspeed <span class="token number">0</span> <span class="token number">1000000</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>dev<span class="token operator">/</span>spi_misc_test
</code></pre> 
<p>源码分析<br> 依然是先从设定和数据结构开始：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_SPI_DEV_NUM</span> <span class="token expression"><span class="token number">8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_MAX_SPEED_HZ</span>    <span class="token expression"><span class="token number">12000000</span></span></span>

<span class="token keyword">struct</span> <span class="token class-name">spi_test_data</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span>    <span class="token operator">*</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>rx_buf<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rx_len<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>tx_buf<span class="token punctuation">;</span>
    <span class="token keyword">int</span> tx_len<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">spi_test_data</span> <span class="token operator">*</span>g_spi_test_data<span class="token punctuation">[</span>MAX_SPI_DEV_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> u32 bit_per_word <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
</code></pre> 
<p>SPI 读写函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">spi_write_slt</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>txbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_transfer</span>     t <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span>tx_buf         <span class="token operator">=</span> txbuf<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>len            <span class="token operator">=</span> n<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>bits_per_word <span class="token operator">=</span> bit_per_word<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_message</span>      m<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;=</span> MAX_SPI_DEV_NUM<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"g_spi.%d is NULL\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        spi <span class="token operator">=</span> g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">-&gt;</span>spi<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">spi_message_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spi_message_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">spi_sync</span><span class="token punctuation">(</span>spi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">spi_read_slt</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>rxbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_transfer</span>     t <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span>rx_buf         <span class="token operator">=</span> rxbuf<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>len            <span class="token operator">=</span> n<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>bits_per_word <span class="token operator">=</span> bit_per_word<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_message</span>      m<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;=</span> MAX_SPI_DEV_NUM<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"g_spi.%d is NULL\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        spi <span class="token operator">=</span> g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">-&gt;</span>spi<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">spi_message_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spi_message_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">spi_sync</span><span class="token punctuation">(</span>spi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>利用基本读写函数拼凑的读写函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">spi_write_then_read_slt</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>txbuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> n_tx<span class="token punctuation">,</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>rxbuf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> n_rx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;=</span> MAX_SPI_DEV_NUM<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"g_spi.%d is NULL\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        spi <span class="token operator">=</span> g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">-&gt;</span>spi<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">spi_write_then_read</span><span class="token punctuation">(</span>spi<span class="token punctuation">,</span> txbuf<span class="token punctuation">,</span> n_tx<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> n_rx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">spi_write_and_read_slt</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>tx_buf<span class="token punctuation">,</span>
            <span class="token keyword">void</span> <span class="token operator">*</span>rx_buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_transfer</span>     t <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span>tx_buf         <span class="token operator">=</span> tx_buf<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>rx_buf         <span class="token operator">=</span> rx_buf<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>len            <span class="token operator">=</span> len<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_message</span>      m<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;=</span> MAX_SPI_DEV_NUM<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"g_spi.%d is NULL\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        spi <span class="token operator">=</span> g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">-&gt;</span>spi<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">spi_message_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spi_message_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">spi_sync</span><span class="token punctuation">(</span>spi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>业务函数：配合测试用的 write 函数</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">spi_test_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>offset<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> argc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token keyword">char</span> tmp<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> times <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> us <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> bytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>txbuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>rxbuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token class-name">ktime_t</span> start_time<span class="token punctuation">;</span>
    <span class="token class-name">ktime_t</span> end_time<span class="token punctuation">;</span>
    <span class="token class-name">ktime_t</span> cost_time<span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    cmd <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    data <span class="token operator">=</span> tmp<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>data <span class="token operator">&lt;</span> <span class="token punctuation">(</span>tmp <span class="token operator">+</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        data <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">++</span>data<span class="token punctuation">;</span>
        argc<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;=</span> <span class="token number">16</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    tmp<span class="token punctuation">[</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"setspeed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;=</span> MAX_SPI_DEV_NUM<span class="token punctuation">)</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"g_spi.%d is NULL\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            spi <span class="token operator">=</span> g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">-&gt;</span>spi<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        spi<span class="token operator">-&gt;</span>max_speed_hz <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
        <span class="token class-name">mm_segment_t</span> old_fs <span class="token operator">=</span> <span class="token function">get_fs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">set_fs</span><span class="token punctuation">(</span>KERNEL_DS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        txbuf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>txbuf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"spi write alloc buf size %d fail\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            fd <span class="token operator">=</span> <span class="token function">ksys_open</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"open %s fail\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">ksys_read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>txbuf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">ksys_close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">set_fs</span><span class="token punctuation">(</span>old_fs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                txbuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        start_time <span class="token operator">=</span> <span class="token function">ktime_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> times<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">spi_write_slt</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> txbuf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        end_time <span class="token operator">=</span> <span class="token function">ktime_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cost_time <span class="token operator">=</span> <span class="token function">ktime_sub</span><span class="token punctuation">(</span>end_time<span class="token punctuation">,</span> start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        us <span class="token operator">=</span> <span class="token function">ktime_to_us</span><span class="token punctuation">(</span>cost_time<span class="token punctuation">)</span><span class="token punctuation">;</span>

        bytes <span class="token operator">=</span> size <span class="token operator">*</span> times <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">;</span>
        bytes <span class="token operator">=</span> bytes <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> us<span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"spi write %d*%d cost %ldus speed:%ldKB/S\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> times<span class="token punctuation">,</span> us<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">kfree</span><span class="token punctuation">(</span>txbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        rxbuf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rxbuf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"spi read alloc buf size %d fail\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        start_time <span class="token operator">=</span> <span class="token function">ktime_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> times<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">spi_read_slt</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        end_time <span class="token operator">=</span> <span class="token function">ktime_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cost_time <span class="token operator">=</span> <span class="token function">ktime_sub</span><span class="token punctuation">(</span>end_time<span class="token punctuation">,</span> start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        us <span class="token operator">=</span> <span class="token function">ktime_to_us</span><span class="token punctuation">(</span>cost_time<span class="token punctuation">)</span><span class="token punctuation">;</span>

        bytes <span class="token operator">=</span> size <span class="token operator">*</span> times <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">;</span>
        bytes <span class="token operator">=</span> bytes <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> us<span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"spi read %d*%d cost %ldus speed:%ldKB/S\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> times<span class="token punctuation">,</span> us<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">print_hex_dump</span><span class="token punctuation">(</span>KERN_ERR<span class="token punctuation">,</span> <span class="token string">"SPI RX: "</span><span class="token punctuation">,</span>
                   DUMP_PREFIX_OFFSET<span class="token punctuation">,</span>
                   <span class="token number">16</span><span class="token punctuation">,</span>
                   <span class="token number">1</span><span class="token punctuation">,</span>
                   rxbuf<span class="token punctuation">,</span>
                   size<span class="token punctuation">,</span>
                   <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">kfree</span><span class="token punctuation">(</span>rxbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"loop"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        txbuf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>txbuf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"spi tx alloc buf size %d fail\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        rxbuf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rxbuf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">kfree</span><span class="token punctuation">(</span>txbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"spi rx alloc buf size %d fail\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            txbuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>

        start_time <span class="token operator">=</span> <span class="token function">ktime_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> times<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">spi_write_and_read_slt</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> txbuf<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>txbuf<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"spi loop test fail\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        end_time <span class="token operator">=</span> <span class="token function">ktime_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cost_time <span class="token operator">=</span> <span class="token function">ktime_sub</span><span class="token punctuation">(</span>end_time<span class="token punctuation">,</span> start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        us <span class="token operator">=</span> <span class="token function">ktime_to_us</span><span class="token punctuation">(</span>cost_time<span class="token punctuation">)</span><span class="token punctuation">;</span>

        bytes <span class="token operator">=</span> size <span class="token operator">*</span> times<span class="token punctuation">;</span>
        bytes <span class="token operator">=</span> bytes <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> us<span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"spi loop %d*%d cost %ldus speed:%ldKB/S\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> times<span class="token punctuation">,</span> us<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">kfree</span><span class="token punctuation">(</span>txbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>rxbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"config"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> width<span class="token punctuation">;</span>

        <span class="token function">sscanf</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>width <span class="token operator">==</span> <span class="token number">16</span><span class="token punctuation">)</span>
            bit_per_word <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            bit_per_word <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"echo id number size &gt; /dev/spi_misc_test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"echo write 0 10 255 &gt; /dev/spi_misc_test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"echo write 0 10 255 init.rc &gt; /dev/spi_misc_test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"echo read 0 10 255 &gt; /dev/spi_misc_test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"echo loop 0 10 255 &gt; /dev/spi_misc_test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"echo setspeed 0 1000000 &gt; /dev/spi_misc_test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"echo config 8 &gt; /dev/spi_misc_test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>完成文件操作集：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> spi_test_fops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> spi_test_write<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">miscdevice</span> spi_test_misc <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>minor <span class="token operator">=</span> MISC_DYNAMIC_MINOR<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"spi_misc_test"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>spi_test_fops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>所以可以明确的是，这个 spi 设备只能写，不能读。</p> 
<p>完成 spi 驱动结构体：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_spi_test_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">spi_test_data</span> <span class="token operator">*</span>spi_test_data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spi<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spi<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

    spi_test_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_test_data</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_test_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spi_test_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ERR: no memory for spi_test_data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    spi<span class="token operator">-&gt;</span>bits_per_word <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

    spi_test_data<span class="token operator">-&gt;</span>spi <span class="token operator">=</span> spi<span class="token punctuation">;</span>
    spi_test_data<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>spi<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">spi_setup</span><span class="token punctuation">(</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>spi_test_data<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ERR: fail to setup spi\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_property_read_u32</span><span class="token punctuation">(</span>spi<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_warn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"fail to get id, default set 0\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    g_spi_test_data<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> spi_test_data<span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s:name=%s,bus_num=%d,cs=%d,mode=%d,speed=%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> spi<span class="token operator">-&gt;</span>modalias<span class="token punctuation">,</span> spi<span class="token operator">-&gt;</span>master<span class="token operator">-&gt;</span>bus_num<span class="token punctuation">,</span> spi<span class="token operator">-&gt;</span>chip_select<span class="token punctuation">,</span> spi<span class="token operator">-&gt;</span>mode<span class="token punctuation">,</span> spi<span class="token operator">-&gt;</span>max_speed_hz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">rockchip_spi_test_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">spi_device</span> <span class="token operator">*</span>spi<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_OF</span></span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> rockchip_spi_test_dt_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"rockchip,spi_test_bus0_cs1"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> rockchip_spi_test_dt_match<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* CONFIG_OF */</span></span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">spi_driver</span> spi_rockchip_test_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>name    <span class="token operator">=</span> <span class="token string">"spi_test"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> <span class="token function">of_match_ptr</span><span class="token punctuation">(</span>rockchip_spi_test_dt_match<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> rockchip_spi_test_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> rockchip_spi_test_remove<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>编写驱动出入口函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">spi_rockchip_test_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi_test_misc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">spi_register_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi_rockchip_test_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>spi_rockchip_test_init<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">spi_rockchip_test_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">misc_deregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi_test_misc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">spi_unregister_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spi_rockchip_test_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>spi_rockchip_test_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_1388"></a>总结</h2> 
<ol><li>先完成驱动框架</li><li>再完成通信功能</li><li>最后加上业务</li></ol> 
<p>SPI 的传输速度比 IIC 快，但是在嵌入式中属于低速设备，一般用于读取传感器模块数据或者自动化模块的控制。所以业务基本集中在 write 和 read 操作中。<br> 先完成通信功能，整个模块的开发基本就完成了90%。</p> 
<p>参考资料：https://blog.csdn.net/daocaokafei/article/details/114377669</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0fd82c308dc91e93433980c8fd8a0637/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Boot yml 文件读取：@ConfigurationProperties 、@EnableConfigurationProperties、@Value、Environment</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ba60cb44d977a4be1feec7fa3c65ffc9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">几种常见web 容器比较 （tomcat、 jboss 、resin、 weblogic、 websphere、 glassfish）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>