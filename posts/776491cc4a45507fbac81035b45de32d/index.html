<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>t-SNE完整笔记 (附Python代码) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="t-SNE完整笔记 (附Python代码)" />
<meta property="og:description" content="t-SNE(t-distributed stochastic neighbor embedding)是用于降维的一种机器学习算法，是由 Laurens van der Maaten 和 Geoffrey Hinton在08年提出来。此外，t-SNE 是一种非线性降维算法，非常适用于高维数据降维到2维或者3维，进行可视化。
t-SNE是由SNE(Stochastic Neighbor Embedding, SNE; Hinton and Roweis, 2002)发展而来。我们先介绍SNE的基本原理，之后再扩展到t-SNE。最后再看一下t-SNE的实现以及一些优化。
1.SNE 1.1基本原理 SNE是通过仿射(affinitie)变换将数据点映射到概率分布上，主要包括两个步骤：
SNE构建一个高维对象之间的概率分布，使得相似的对象有更高的概率被选择，而不相似的对象有较低的概率被选择。SNE在低维空间里在构建这些点的概率分布，使得这两个概率分布之间尽可能的相似。 我们看到t-SNE模型是非监督的降维，他跟kmeans等不同，他不能通过训练得到一些东西之后再用于其它数据（比如kmeans可以通过训练得到k个点，再用于其它数据集，而t-SNE只能单独的对数据做操作，也就是说他只有fit_transform，而没有fit操作）
1.2 SNE原理推导 SNE是先将欧几里得距离转换为条件概率来表达点与点之间的相似度。具体来说，给定一个N个高维的数据 (x_1, … , x_N)（注意N不是维度）, t-SNE首先是计算概率(p_{ij})，正比于(x_i)和(x_j)之间的相似度（这种概率是我们自主构建的），即：
[{p_ {j \mid i} = \frac{\exp(- \mid \mid x_i -x_j \mid \mid ^2 / (2 \sigma^2_i ))} {\sum_{k \neq i} \exp(- \mid \mid x_i - x_k \mid \mid ^2 / (2 \sigma^2_i))}}]
这里的有一个参数是(\sigma_i)，对于不同的点(x_i)取值不一样，后续会讨论如何设置。此外设置(p_{x \mid x}=0),因为我们关注的是两两之间的相似度。
那对于低维度下的(y_i)，我们可以指定高斯分布为方差为(\frac{1}{\sqrt{2}})，因此它们之间的相似度如下:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/776491cc4a45507fbac81035b45de32d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-11T16:26:19+08:00" />
<meta property="article:modified_time" content="2023-12-11T16:26:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">t-SNE完整笔记 (附Python代码)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<p>t-SNE(t-distributed stochastic neighbor embedding)是用于<strong>降维</strong>的一种机器学习算法，是由 Laurens van der Maaten 和 Geoffrey Hinton在08年提出来。此外，t-SNE 是一种非线性降维算法，非常适用于高维数据降维到2维或者3维，进行可视化。</p> 
<p>t-SNE是由SNE(Stochastic Neighbor Embedding, SNE; Hinton and Roweis, 2002)发展而来。我们先介绍SNE的基本原理，之后再扩展到t-SNE。最后再看一下t-SNE的实现以及一些优化。</p> 
<h4 id="1sne">1.SNE</h4> 
<h5 id="11基本原理">1.1基本原理</h5> 
<p>SNE是通过仿射(affinitie)变换将数据点映射到概率分布上，主要包括两个步骤：</p> 
<ul><li>SNE构建一个高维对象之间的概率分布，使得相似的对象有更高的概率被选择，而不相似的对象有较低的概率被选择。</li><li>SNE在低维空间里在构建这些点的概率分布，使得这两个概率分布之间尽可能的相似。</li></ul> 
<p>我们看到t-SNE模型是非监督的降维，他跟kmeans等不同，他不能通过训练得到一些东西之后再用于其它数据（比如kmeans可以通过训练得到k个点，再用于其它数据集，而t-SNE只能单独的对数据做操作，也就是说他只有fit_transform，而没有fit操作）</p> 
<h5 id="12-sne原理推导">1.2 SNE原理推导</h5> 
<p>SNE是先<strong>将欧几里得距离转换为条件概率来表达点与点之间的相似度</strong>。具体来说，给定一个N个高维的数据 (x_1, … , x_N)（注意N不是维度）, t-SNE首先是计算概率(p_{ij})，正比于(x_i)和(x_j)之间的相似度（这种概率是我们自主构建的），即：</p> 
<p>[{p_ {j \mid i} = \frac{\exp(- \mid \mid x_i -x_j \mid \mid ^2 / (2 \sigma^2_i ))} {\sum_{k \neq i} \exp(- \mid \mid x_i - x_k \mid \mid ^2 / (2 \sigma^2_i))}}]</p> 
<p>这里的有一个参数是(\sigma_i)，对于不同的点(x_i)取值不一样，后续会讨论如何设置。此外设置(p_{x \mid x}=0),因为我们关注的是两两之间的相似度。</p> 
<p>那对于低维度下的(y_i)，我们可以指定高斯分布为方差为(\frac{1}{\sqrt{2}})，因此它们之间的相似度如下:</p> 
<p>[{q_ {j \mid i} = \frac{\exp(- \mid \mid x_i -x_j \mid \mid ^2)} {\sum_{k \neq i} \exp(- \mid \mid x_i - x_k \mid \mid ^2)}}]</p> 
<p>同样，设定(q_{i \mid i} = 0).</p> 
<p>如果降维的效果比较好，局部特征保留完整，那么 (p_{i \mid j} = q_{i \mid j}), 因此我们优化两个分布之间的距离-KL散度(Kullback-Leibler divergences)，那么目标函数(cost function)如下:</p> 
<p>[C = \sum_i KL(P_i \mid \mid Q_i) = \sum_i \sum_j p_{j \mid i} \log \frac{p_{j \mid i}}{q_{j \mid i}}]</p> 
<p>这里的(P_i)表示了给定点(x_i)下，其他所有数据点的条件概率分布。需要注意的是<strong>KL散度具有不对称性</strong>，在低维映射中不同的距离对应的惩罚权重是不同的，具体来说：距离较远的两个点来表达距离较近的两个点会产生更大的cost，相反，用较近的两个点来表达较远的两个点产生的cost相对较小(注意：类似于回归容易受异常值影响，但效果相反)。即用较小的 (q_{j \mid i}=0.2) 来建模较大的 (p_{j \mid i}=0.8), cost=(p \log(\frac{p}{q}))=1.11,同样用较大的(q_{j \mid i}=0.8)来建模较大的(p_{j \mid i}=0.2), cost=-0.277, 因此，<strong>SNE会倾向于保留数据中的局部特征</strong>。</p> 
<blockquote> 
 <p>思考:了解了基本思路之后，你会怎么选择(\sigma)，固定初始化?</p> 
</blockquote> 
<p>下面我们开始正式的推导SNE。首先不同的点具有不同的(\sigma_i)，(P_i)的熵(entropy)会随着(\sigma_i)的增加而增加。SNE使用困惑度(<a href="https://en.wikipedia.org/wiki/Perplexity" rel="external nofollow noopener noreferrer" target="_blank">perplexity</a>)的概念，用二分搜索的方式来寻找一个最佳的(\sigma)。其中困惑度指:</p> 
<p>[Perp(P_i) = 2^{H(P_i)}]</p> 
<p>这里的(H(P_i))是(P_i)的熵，即:</p> 
<p>[H(P_i) = -\sum_j p_{j \mid i} \log_2 p_{j \mid i}]</p> 
<p>困惑度可以解释为一个点附近的有效近邻点个数。<strong>SNE对困惑度的调整比较有鲁棒性，通常选择5-50之间</strong>，给定之后，使用二分搜索的方式寻找合适的(\sigma)</p> 
<p>那么核心问题是如何求解梯度了,目标函数等价于(\sum \sum - p log(q))这个式子与softmax非常的类似，我们知道softmax的目标函数是(\sum -y \log p)，对应的梯度是(y - p)(注：这里的softmax中y表示label，p表示预估值)。 同样我们可以推导SNE的目标函数中的i在j下的条件概率情况的梯度是(2(p_{i \mid j}-q_{i \mid j})(y_i-y_j))， 同样j在i下的条件概率的梯度是(2(p_{j \mid i}-q_{j \mid i})(y_i-y_j)), 最后得到完整的梯度公式如下:</p> 
<p>[\frac{\delta C}{\delta y_i} = 2 \sum_j (p_{j \mid i} - q_{j \mid i} + p_{i \mid j} - q_{i \mid j})(y_i - y_j)]</p> 
<p>在初始化中，可以用较小的(\sigma)下的高斯分布来进行初始化。为了加速优化过程和避免陷入局部最优解，梯度中需要使用一个相对较大的动量(momentum)。即参数更新中除了当前的梯度，还要引入之前的梯度累加的指数衰减项，如下:</p> 
<p>[Y^{(t)} = Y^{(t-1)} + \eta \frac{\delta C}{\delta Y} + \alpha(t)(Y^{(t-1)} - Y<sup>{(t-2)})]&lt;/p&gt;&lt;p&gt;这里的(Y</sup>{(t)})表示迭代t次的解，(\eta)表示学习速率,(\alpha(t))表示迭代t次的动量。</p> 
<p>此外，在初始优化的阶段，每次迭代中可以引入一些高斯噪声，之后像模拟退火一样逐渐减小该噪声，可以用来避免陷入局部最优解。因此，SNE在选择高斯噪声，以及学习速率，什么时候开始衰减，动量选择等等超参数上，需要跑多次优化才可以。</p> 
<blockquote> 
 <p>思考:SNE有哪些不足？ 面对SNE的不足，你会做什么改进？</p> 
</blockquote> 
<h4 id="2t-sne">2.t-SNE</h4> 
<p>尽管SNE提供了很好的可视化方法，但是他很难优化，而且存在”crowding problem”(拥挤问题)。后续中，Hinton等人又提出了t-SNE的方法。与SNE不同，主要如下:</p> 
<ul><li>使用对称版的SNE，简化梯度公式</li><li>低维空间下，使用t分布替代高斯分布表达两点之间的相似度</li></ul> 
<p>t-SNE在低维空间下使用更重长尾分布的t分布来避免crowding问题和优化问题。在这里，首先介绍一下对称版的SNE，之后介绍crowding问题，之后再介绍t-SNE。</p> 
<h5 id="21-symmetric-sne">2.1 Symmetric SNE</h5> 
<p>优化(p_{i \mid j})和(q_{i \mid j})的KL散度的一种替换思路是，使用联合概率分布来替换条件概率分布，即P是高维空间里各个点的联合概率分布，Q是低维空间下的，目标函数为:</p> 
<p>[C = KL(P \mid \mid Q) = \sum_i \sum_j p_{i,j} \log \frac{p_{ij}}{q_{ij}}]</p> 
<p>这里的(p_{ii}),(q_{ii})为0，我们将这种SNE称之为symmetric SNE(对称SNE)，因为他假设了对于任意i,(p_{ij} = p_{ji}, q_{ij} = q_{ji})，因此概率分布可以改写为:</p> 
<p>[p_{ij} = \frac{\exp(- \mid \mid x_i - x_j \mid \mid ^2 / 2\sigma^2)}{\sum_{k \neq l} \exp(- \mid \mid x_k-x_l \mid \mid ^2 / 2\sigma^2)} \ \ \ \ q_{ij} = \frac{\exp(- \mid \mid y_i - y_j \mid \mid ^2)}{\sum_{k \neq l} \exp(- \mid \mid y_k-y_l \mid \mid ^2)}]</p> 
<p>这种表达方式，使得整体简洁了很多。但是会引入<strong>异常值</strong>的问题。比如(x_i)是异常值，那么(\mid \mid x_i - x_j \mid \mid ^2)会很大，对应的所有的j, (p_{ij})都会很小(之前是仅在(x_i)下很小)，导致低维映射下的(y_i)对cost影响很小。</p> 
<blockquote> 
 <p>思考: 对于异常值，你会做什么改进？(p_i)表示什么？</p> 
</blockquote> 
<p>为了解决这个问题，我们将联合概率分布定义修正为: (p_{ij} = \frac{p_{i \mid j} + p_{j \mid i}}{2}), 这保证了(\sum_j p_{ij} \gt \frac{1}{2n}), 使得每个点对于cost都会有一定的贡献。对称SNE的最大优点是梯度计算变得简单了，如下:</p> 
<p>(\frac{\delta C}{\delta y_i} = 4 \sum_j (p_{ij} - q_{ij})(y_i - y_j))</p> 
<p>实验中，发现对称SNE能够产生和SNE一样好的结果，有时甚至略好一点。</p> 
<h5 id="22-crowding问题">2.2 Crowding问题</h5> 
<p>拥挤问题就是说各个簇聚集在一起，无法区分。比如有一种情况，高维度数据在降维到10维下，可以有很好的表达，但是降维到两维后无法得到可信映射，比如降维如10维中有11个点之间两两等距离的，在二维下就无法得到可信的映射结果(最多3个点)。<br> 进一步的说明，假设一个以数据点(x_i)为中心，半径为r的m维球(三维空间就是球)，其体积是按(r^m)增长的，假设数据点是在m维球中均匀分布的，我们来看看其他数据点与(x_i)的距离随维度增大而产生的变化。</p> 
<p><a href="https://static.plob.org/wp-content/uploads/2019/01/1547305472-3218-sne-crowding.png" rel="nofollow"><img class="attachment-medium size-medium" src="https://images2.imgbox.com/f5/4b/W2fpAPRi_o.png" alt="t-SNE完整笔记 (附Python代码)-图片1" width="700" height="175"></a></p> 
<p>从上图可以看到，随着维度的增大，大部分数据点都聚集在m维球的表面附近，与点(x_i)的距离分布极不均衡。如果直接将这种距离关系保留到低维，就会出现拥挤问题。</p> 
<blockquote> 
 <p>怎么解决crowding问题呢？</p> 
</blockquote> 
<p>Cook et al.(2007) 提出一种slight repulsion的方式，在基线概率分布(uniform background)中引入一个较小的混合因子(\rho),这样(q_{ij})就永远不会小于(\frac{2 \rho}{n(n-1)}) (因为一共了n(n-1)个pairs)，这样在高维空间中比较远的两个点之间的(q_{ij})总是会比(p_{ij})大一点。这种称之为UNI-SNE，效果通常比标准的SNE要好。优化UNI-SNE的方法是先让(\rho)为0，使用标准的SNE优化，之后用模拟退火的方法的时候，再慢慢增加(\rho).<br> 直接优化UNI-SNE是不行的(即一开始(\rho)不为0)，因为距离较远的两个点基本是一样的(q_{ij})(等于基线分布), 即使(p_{ij})很大，一些距离变化很难在(q_{ij})中产生作用。也就是说优化中刚开始距离较远的两个聚类点，后续就无法再把他们拉近了。</p> 
<h5 id="23-t-sne">2.3 t-SNE</h5> 
<p>对称SNE实际上在高维度下<br> 另外一种减轻”拥挤问题”的方法：在高维空间下，在高维空间下我们使用高斯分布将距离转换为概率分布，在低维空间下，我们使用更加偏重长尾分布的方式来将距离转换为概率分布，使得高维度下中低等的距离在映射后能够有一个较大的距离。</p> 
<p> </p> 
<p><a href="https://static.plob.org/wp-content/uploads/2019/01/1547305473-7690-norm-t-dict.png" rel="nofollow"><img class="attachment-medium size-medium" src="https://images2.imgbox.com/52/72/5Q2SNmWu_o.png" alt="t-SNE完整笔记 (附Python代码)-图片2" width="700" height="280"></a></p> 
<p>我们对比一下高斯分布和t分布(如上图,code见probability/distribution.md), t分布受异常值影响更小，拟合结果更为合理，较好的捕获了数据的整体特征。</p> 
<p>使用了t分布之后的q变化，如下:</p> 
<p>[q_{ij} = \frac{(1 + \mid \mid y_i -y_j \mid \mid <sup>2)</sup>{-1}}{\sum_{k \neq l} (1 + \mid \mid y_i -y_j \mid \mid <sup>2)</sup>{-1}}]</p> 
<p>此外，t分布是无限多个高斯分布的叠加，计算上不是指数的，会方便很多。优化的梯度如下:</p> 
<p>[\frac{\delta C}{\delta y_i} = 4 \sum_j(p_{ij}-q_{ij})(y_i-y_j)(1+ \mid \mid y_i-y_j \mid \mid <sup>2)</sup>{-1}]</p> 
<p><a href="https://static.plob.org/wp-content/uploads/2019/01/1547305474-6828-sne-norm-t-dist-cost.png" rel="nofollow"><img class="attachment-medium size-medium" src="https://images2.imgbox.com/c6/2e/pJbnqFFR_o.png" alt="t-SNE完整笔记 (附Python代码)-图片3" width="700" height="438"></a></p> 
<p>t-sne的有效性，也可以从上图中看到：横轴表示距离，纵轴表示相似度, 可以看到，对于较大相似度的点，t分布在低维空间中的距离需要稍小一点；而对于低相似度的点，t分布在低维空间中的距离需要更远。这恰好满足了我们的需求，即同一簇内的点(距离较近)聚合的更紧密，不同簇之间的点(距离较远)更加疏远。</p> 
<p>总结一下，t-SNE的梯度更新有两大优势：</p> 
<ul><li>对于不相似的点，用一个较小的距离会产生较大的梯度来让这些点排斥开来。</li><li>这种排斥又不会无限大(梯度中分母)，避免不相似的点距离太远。</li></ul> 
<h5 id="24-算法过程">2.4 算法过程</h5> 
<p>算法详细过程如下：</p> 
<ul><li>Data: (X = {x_1, … , x_n})</li><li>计算cost function的参数：困惑度Perp</li><li>优化参数: 设置迭代次数T， 学习速率(\eta), 动量(\alpha(t))</li><li>目标结果是低维数据表示 (Y^T = {y_1, … , y_n})</li><li>开始优化 
  <ul><li>计算在给定Perp下的条件概率(p_{j \mid i})(参见上面公式)</li><li>令 (p_{ij} = \frac{p_{j \mid i} + p_{i \mid j}}{2n})</li><li>用 (N(0, 10^{-4}I)) 随机初始化 Y</li><li>迭代，从 t = 1 到 T， 做如下操作: 
    <ul><li>计算低维度下的 (q_{ij})(参见上面的公式)</li><li>计算梯度（参见上面的公式）</li><li>更新 (Y^{t} = Y^{t-1} + \eta \frac{dC}{dY} + \alpha(t)(Y^{t-1} - Y^{t-2}))</li></ul></li><li>结束</li></ul></li><li>结束</li></ul> 
<p>优化过程中可以尝试的两个trick:</p> 
<ul><li>提前压缩(early compression):开始初始化的时候，各个点要离得近一点。这样小的距离，方便各个聚类中心的移动。可以通过引入L2正则项(距离的平方和)来实现。</li><li>提前夸大(early exaggeration)：在开始优化阶段，(p_{ij})乘以一个大于1的数进行扩大，来避免因为(q_{ij})太小导致优化太慢的问题。比如前50次迭代，(p_{ij})乘以4</li></ul> 
<p>优化的过程动态图如下：</p> 
<p><a href="https://img-blog.csdnimg.cn/img_convert/5cc6c9bc5c8aa9bd6858038e1eb370c9.gif" rel="nofollow"><img class="attachment-medium size-medium" src="https://images2.imgbox.com/b8/d2/QCPLGbTD_o.gif" alt="t-SNE完整笔记 (附Python代码)-图片4" width="640" height="640"></a></p> 
<h5 id="25-不足">2.5 不足</h5> 
<p>主要不足有四个:</p> 
<ul><li>主要用于可视化，很难用于其他目的。比如测试集合降维，因为他没有显式的预估部分，不能在测试集合直接降维；比如降维到10维，因为t分布偏重长尾，1个自由度的t分布很难保存好局部特征，可能需要设置成更高的自由度。</li><li>t-SNE倾向于保存局部特征，对于本征维数(intrinsic dimensionality)本身就很高的数据集，是不可能完整的映射到2-3维的空间</li><li>t-SNE没有唯一最优解，且没有预估部分。如果想要做预估，可以考虑降维之后，再构建一个回归方程之类的模型去做。但是要注意，t-sne中距离本身是没有意义，都是概率分布问题。</li><li>训练太慢。有很多基于树的算法在t-sne上做一些改进</li></ul> 
<h4 id="3变种">3.变种</h4> 
<p>后续有机会补充。</p> 
<ul><li>multiple maps of t-SNE</li><li>parametric t-SNE</li><li>Visualizing Large-scale and High-dimensional Data</li></ul> 
<h4 id="4参考文档">4.参考文档</h4> 
<ul><li>Maaten, L., &amp; Hinton, G. (2008). Visualizing data using t-SNE. Journal of Machine Learning Research.</li></ul> 
<h4 id="5-代码">5. 代码</h4> 
<p>文中的插图绘制:</p> 
<div class="codebox"> 
 <div class="btn-clipboard bgt" title="Copy"> 
  <i class="be be-clipboard"></i> 
 </div> 
 <pre class="prettyprint linenums prettyprinted">  
  <ol class="linenums"><li class="L0"><span class="com"># coding:utf-8</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">import</span><span class="pln"> numpy </span><span class="kwd">as</span><span class="pln"> np</span></li><li class="L3"><span class="kwd">from</span><span class="pln"> numpy</span><span class="pun">.</span><span class="pln">linalg </span><span class="kwd">import</span><span class="pln"> norm</span></li><li class="L4"><span class="kwd">from</span><span class="pln"> matplotlib </span><span class="kwd">import</span><span class="pln"> pyplot </span><span class="kwd">as</span><span class="pln"> plt</span></li><li class="L5"><span class="pln">plt</span><span class="pun">.</span><span class="pln">style</span><span class="pun">.</span><span class="kwd">use</span><span class="pun">(</span><span class="str">‘ggplot’</span><span class="pun">)</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="kwd">def</span><span class="pln"> sne_crowding</span><span class="pun">():</span></li><li class="L8"><span class="pln">    npoints </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1000</span><span class="pln"> </span><span class="com"># 抽取1000个m维球内均匀分布的点</span></li><li class="L9"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=(</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5</span><span class="pun">))</span></li><li class="L0"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> i</span><span class="pun">,</span><span class="pln"> m </span><span class="kwd">in</span><span class="pln"> enumerate</span><span class="pun">((</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8</span><span class="pun">)):</span></li><li class="L1"><span class="pln">        </span><span class="com"># 这里模拟m维球中的均匀分布用到了拒绝采样，</span></li><li class="L2"><span class="pln">        </span><span class="com"># 即先生成m维立方中的均匀分布，再剔除m维球外部的点</span></li><li class="L3"><span class="pln">        accepts </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[]</span></li><li class="L4"><span class="pln">        </span><span class="kwd">while</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">accepts</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">1000</span><span class="pun">:</span></li><li class="L5"><span class="pln">            points </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">random</span><span class="pun">.</span><span class="pln">rand</span><span class="pun">(</span><span class="lit">500</span><span class="pun">,</span><span class="pln"> m</span><span class="pun">)</span></li><li class="L6"><span class="pln">            accepts</span><span class="pun">.</span><span class="pln">extend</span><span class="pun">([</span><span class="pln">d </span><span class="kwd">for</span><span class="pln"> d </span><span class="kwd">in</span><span class="pln"> norm</span><span class="pun">(</span><span class="pln">points</span><span class="pun">,</span><span class="pln"> axis</span><span class="pun">=</span><span class="lit">1</span><span class="pun">)</span></li><li class="L7"><span class="pln">                            </span><span class="kwd">if</span><span class="pln"> d </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">1.0</span><span class="pun">])</span><span class="pln"> </span><span class="com"># 拒绝采样</span></li><li class="L8"><span class="pln">        accepts </span><span class="pun">=</span><span class="pln"> accepts</span><span class="pun">[:</span><span class="pln">npoints</span><span class="pun">]</span></li><li class="L9"><span class="pln">        ax </span><span class="pun">=</span><span class="pln"> plt</span><span class="pun">.</span><span class="pln">subplot</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4</span><span class="pun">,</span><span class="pln"> i</span><span class="pun">+</span><span class="lit">1</span><span class="pun">)</span></li><li class="L0"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> i </span><span class="pun"><mark></mark></span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></li><li class="L1"><span class="pln">            ax</span><span class="pun">.</span><span class="pln">set_ylabel</span><span class="pun">(</span><span class="str">‘count’</span><span class="pun">)</span></li><li class="L2"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> i </span><span class="pun"></span><span class="pln"> </span><span class="lit">2</span><span class="pun">:</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">            ax</span><span class="pun">.</span><span class="pln">set_xlabel</span><span class="pun">(</span><span class="str">‘distance’</span><span class="pun">)</span></li><li class="L5"><span class="pln">        ax</span><span class="pun">.</span><span class="pln">hist</span><span class="pun">(</span><span class="pln">accepts</span><span class="pun">,</span><span class="pln"> bins</span><span class="pun">=</span><span class="pln">np</span><span class="pun">.</span><span class="pln">linspace</span><span class="pun">(</span><span class="lit">0.</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.</span><span class="pun">,</span><span class="pln"> </span><span class="lit">50</span><span class="pun">))</span></li><li class="L6"><span class="pln">        ax</span><span class="pun">.</span><span class="pln">set_title</span><span class="pun">(</span><span class="str">‘m=%s’</span><span class="pln"> </span><span class="pun">%</span><span class="pln">m</span><span class="pun">)</span></li><li class="L7"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">savefig</span><span class="pun">(</span><span class="str">“./images/sne_crowding.png”</span><span class="pun">)</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">linspace</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="lit">100</span><span class="pun">)</span></li><li class="L0"><span class="pln">    ta </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="pun">(</span><span class="lit">1</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">square</span><span class="pun">(</span><span class="pln">x</span><span class="pun">))</span></li><li class="L1"><span class="pln">    tb </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">ta</span><span class="pun">)</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span></li><li class="L2"><span class="pln">    qa </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">exp</span><span class="pun">(-</span><span class="pln">np</span><span class="pun">.</span><span class="pln">square</span><span class="pun">(</span><span class="pln">x</span><span class="pun">))</span></li><li class="L3"><span class="pln">    qb </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">qa</span><span class="pun">)</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">def</span><span class="pln"> sne_norm_t_dist_cost</span><span class="pun">():</span></li><li class="L6"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">figure</span><span class="pun">(</span><span class="pln">figsize</span><span class="pun">=(</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5</span><span class="pun">))</span></li><li class="L7"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">qa</span><span class="pun">/</span><span class="pln">qb</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">=</span><span class="str">“b”</span><span class="pun">,</span><span class="pln"> label</span><span class="pun">=</span><span class="str">“normal-dist”</span><span class="pun">)</span></li><li class="L8"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">(</span><span class="pln">ta</span><span class="pun">/</span><span class="pln">tb</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">=</span><span class="str">“g”</span><span class="pun">,</span><span class="pln"> label</span><span class="pun">=</span><span class="str">“t-dist”</span><span class="pun">)</span></li><li class="L9"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">((</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">0.025</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.025</span><span class="pun">),</span><span class="pln"> </span><span class="str">‘r–’</span><span class="pun">)</span></li><li class="L0"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">text</span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.022</span><span class="pun">,</span><span class="pln"> r</span><span class="str">‘<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
         
          
           
            
            
              q 
             
             
             
               i 
              
             
               j 
              
             
            
           
          
            q_{ij} 
           
          
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span>’</span><span class="pun">)</span></li><li class="L1"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">text</span><span class="pun">(</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.026</span><span class="pun">,</span><span class="pln"> r</span><span class="str">‘<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
         
          
           
            
            
              p 
             
             
             
               i 
              
             
               j 
              
             
            
           
          
            p_{ij} 
           
          
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span>’</span><span class="pun">)</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">plot</span><span class="pun">((</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">55</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="lit">0.005</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.005</span><span class="pun">),</span><span class="pln"> </span><span class="str">‘r–’</span><span class="pun">)</span></li><li class="L4"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">text</span><span class="pun">(</span><span class="lit">36</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.003</span><span class="pun">,</span><span class="pln"> r</span><span class="str">‘<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
         
          
           
            
            
              q 
             
             
             
               i 
              
             
               j 
              
             
            
           
          
            q_{ij} 
           
          
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span>’</span><span class="pun">)</span></li><li class="L5"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">text</span><span class="pun">(</span><span class="lit">55</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.007</span><span class="pun">,</span><span class="pln"> r</span><span class="str">‘<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
         
          
           
            
            
              p 
             
             
             
               i 
              
             
               j 
              
             
            
           
          
            p_{ij} 
           
          
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span>’</span><span class="pun">)</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">title</span><span class="pun">(</span><span class="str">“probability of distance”</span><span class="pun">)</span></li><li class="L8"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">xlabel</span><span class="pun">(</span><span class="str">“distance”</span><span class="pun">)</span></li><li class="L9"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">ylabel</span><span class="pun">(</span><span class="str">“probability”</span><span class="pun">)</span></li><li class="L0"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">legend</span><span class="pun">()</span></li><li class="L1"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">savefig</span><span class="pun">(</span><span class="str">“./images/sne_norm_t_dist_cost.png”</span><span class="pun">)</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">if</span><span class="pln"> <strong>name</strong> </span><span class="pun"><mark></mark></span><span class="pln"> </span><span class="str">‘<strong>main</strong>’</span><span class="pun">:</span></li><li class="L4"><span class="pln">    sne_crowding</span><span class="pun">()</span></li><li class="L5"><span class="pln">    sne_norm_t_dist_cost</span><span class="pun">()</span></li></ol></pre> 
</div> 
<p>附录一下t-sne的完整代码实现:</p> 
<div class="codebox"> 
 <div class="btn-clipboard bgt" title="Copy"> 
  <i class="be be-clipboard"></i> 
 </div> 
 <pre class="prettyprint linenums prettyprinted">  
  <ol class="linenums"><li class="L0"><span class="com"># coding utf-8</span></li><li class="L1"><span class="str">‘’‘</span></li><li class="L2"><span class="str">代码参考了作者Laurens van der Maaten的开放出的t-sne代码, 并没有用类进行实现,主要是优化了计算的实现</span></li><li class="L3"><span class="str">’‘’</span></li><li class="L4"><span class="kwd">import</span><span class="pln"> numpy </span><span class="kwd">as</span><span class="pln"> np</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="kwd">def</span><span class="pln"> cal_pairwise_dist</span><span class="pun">(</span><span class="pln">x</span><span class="pun">):</span></li><li class="L8"><span class="pln">    </span><span class="str">‘’‘计算pairwise 距离, x是matrix</span></li><li class="L9"><span class="str">    (a-b)^2 = a^w + b^2 - 2<em>a</em>b</span></li><li class="L0"><span class="str">    ‘’’</span></li><li class="L1"><span class="pln">    sum_x </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">square</span><span class="pun">(</span><span class="pln">x</span><span class="pun">),</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></li><li class="L2"><span class="pln">    dist </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(-</span><span class="lit">2</span><span class="pln"> </span><span class="pun"><em></em></span><span class="pln"> np</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> x</span><span class="pun">.</span><span class="pln">T</span><span class="pun">),</span><span class="pln"> sum_x</span><span class="pun">).</span><span class="pln">T</span><span class="pun">,</span><span class="pln"> sum_x</span><span class="pun">)</span></li><li class="L3"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> dist</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="kwd">def</span><span class="pln"> cal_perplexity</span><span class="pun">(</span><span class="pln">dist</span><span class="pun">,</span><span class="pln"> idx</span><span class="pun">=</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> beta</span><span class="pun">=</span><span class="lit">1.0</span><span class="pun">):</span></li><li class="L7"><span class="pln">    </span><span class="str">‘’‘计算perplexity, D是距离向量，</span></li><li class="L8"><span class="str">    idx指dist中自己与自己距离的位置，beta是高斯分布参数</span></li><li class="L9"><span class="str">    这里的perp仅计算了熵，方便计算</span></li><li class="L0"><span class="str">    ‘’’</span></li><li class="L1"><span class="pln">    prob </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">exp</span><span class="pun">(-</span><span class="pln">dist </span><span class="pun"></span><span class="pln"> beta</span><span class="pun">)</span></li><li class="L2"><span class="pln">    </span><span class="com"># 设置自身prob为0</span></li><li class="L3"><span class="pln">    prob</span><span class="pun">[</span><span class="pln">idx</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span></li><li class="L4"><span class="pln">    sum_prob </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">prob</span><span class="pun">)</span></li><li class="L5"><span class="pln">    perp </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">sum_prob</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> beta </span><span class="pun"><em></em></span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">dist </span><span class="pun"></span><span class="pln"> prob</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> sum_prob</span></li><li class="L6"><span class="pln">    prob </span><span class="pun">/=</span><span class="pln"> sum_prob</span></li><li class="L7"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> perp</span><span class="pun">,</span><span class="pln"> prob</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="kwd">def</span><span class="pln"> seach_prob</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> tol</span><span class="pun">=</span><span class="lit">1e-5</span><span class="pun">,</span><span class="pln"> perplexity</span><span class="pun">=</span><span class="lit">30.0</span><span class="pun">):</span></li><li class="L1"><span class="pln">    </span><span class="str">‘’‘二分搜索寻找beta,并计算pairwise的prob</span></li><li class="L2"><span class="str">    ‘’’</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">    </span><span class="com"># 初始化参数</span></li><li class="L5"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">“Computing pairwise distances…”</span><span class="pun">)</span></li><li class="L6"><span class="pln">    </span><span class="pun">(</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> d</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> x</span><span class="pun">.</span><span class="pln">shape</span></li><li class="L7"><span class="pln">    dist </span><span class="pun">=</span><span class="pln"> cal_pairwise_dist</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span></li><li class="L8"><span class="pln">    pair_prob </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">zeros</span><span class="pun">((</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> n</span><span class="pun">))</span></li><li class="L9"><span class="pln">    beta </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">ones</span><span class="pun">((</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></li><li class="L0"><span class="pln">    </span><span class="com"># 取log，方便后续计算</span></li><li class="L1"><span class="pln">    base_perp </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">perplexity</span><span class="pun">)</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="pln">n</span><span class="pun">):</span></li><li class="L4"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> i </span><span class="pun">%</span><span class="pln"> </span><span class="lit">500</span><span class="pln"> </span><span class="pun"></span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></li><li class="L5"><span class="pln">            </span><span class="kwd">print</span><span class="pun">(</span><span class="str">“Computing pair_prob for point %s of %s …”</span><span class="pln"> </span><span class="pun">%(</span><span class="pln">i</span><span class="pun">,</span><span class="pln">n</span><span class="pun">))</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">        betamin </span><span class="pun">=</span><span class="pln"> </span><span class="pun">-</span><span class="pln">np</span><span class="pun">.</span><span class="pln">inf</span></li><li class="L8"><span class="pln">        betamax </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">inf</span></li><li class="L9"><span class="pln">        perp</span><span class="pun">,</span><span class="pln"> this_prob </span><span class="pun">=</span><span class="pln"> cal_perplexity</span><span class="pun">(</span><span class="pln">dist</span><span class="pun">[</span><span class="pln">i</span><span class="pun">],</span><span class="pln"> i</span><span class="pun">,</span><span class="pln"> beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">])</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">        </span><span class="com"># 二分搜索,寻找最佳sigma下的prob</span></li><li class="L2"><span class="pln">        perp_diff </span><span class="pun">=</span><span class="pln"> perp </span><span class="pun">-</span><span class="pln"> base_perp</span></li><li class="L3"><span class="pln">        tries </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span></li><li class="L4"><span class="pln">        </span><span class="kwd">while</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">abs</span><span class="pun">(</span><span class="pln">perp_diff</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> tol </span><span class="kwd">and</span><span class="pln"> tries </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">50</span><span class="pun">:</span></li><li class="L5"><span class="pln">            </span><span class="kwd">if</span><span class="pln"> perp_diff </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></li><li class="L6"><span class="pln">                betamin </span><span class="pun">=</span><span class="pln"> beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">copy</span><span class="pun">()</span></li><li class="L7"><span class="pln">                </span><span class="kwd">if</span><span class="pln"> betamax </span><span class="pun"><mark></mark></span><span class="pln"> np</span><span class="pun">.</span><span class="pln">inf </span><span class="kwd">or</span><span class="pln"> betamax </span><span class="pun"></span><span class="pln"> </span><span class="pun">-</span><span class="pln">np</span><span class="pun">.</span><span class="pln">inf</span><span class="pun">:</span></li><li class="L8"><span class="pln">                    beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun"><em></em></span><span class="pln"> </span><span class="lit">2</span></li><li class="L9"><span class="pln">                </span><span class="kwd">else</span><span class="pun">:</span></li><li class="L0"><span class="pln">                    beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> betamax</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="lit">2</span></li><li class="L1"><span class="pln">            </span><span class="kwd">else</span><span class="pun">:</span></li><li class="L2"><span class="pln">                betamax </span><span class="pun">=</span><span class="pln"> beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">copy</span><span class="pun">()</span></li><li class="L3"><span class="pln">                </span><span class="kwd">if</span><span class="pln"> betamin </span><span class="pun"><mark></mark></span><span class="pln"> np</span><span class="pun">.</span><span class="pln">inf </span><span class="kwd">or</span><span class="pln"> betamin </span><span class="pun"></span><span class="pln"> </span><span class="pun">-</span><span class="pln">np</span><span class="pun">.</span><span class="pln">inf</span><span class="pun">:</span></li><li class="L4"><span class="pln">                    beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="lit">2</span></li><li class="L5"><span class="pln">                </span><span class="kwd">else</span><span class="pun">:</span></li><li class="L6"><span class="pln">                    beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> betamin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="lit">2</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">            </span><span class="com"># 更新perb,prob值</span></li><li class="L9"><span class="pln">            perp</span><span class="pun">,</span><span class="pln"> this_prob </span><span class="pun">=</span><span class="pln"> cal_perplexity</span><span class="pun">(</span><span class="pln">dist</span><span class="pun">[</span><span class="pln">i</span><span class="pun">],</span><span class="pln"> i</span><span class="pun">,</span><span class="pln"> beta</span><span class="pun">[</span><span class="pln">i</span><span class="pun">])</span></li><li class="L0"><span class="pln">            perp_diff </span><span class="pun">=</span><span class="pln"> perp </span><span class="pun">-</span><span class="pln"> base_perp</span></li><li class="L1"><span class="pln">            tries </span><span class="pun">=</span><span class="pln"> tries </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span></li><li class="L2"><span class="pln">        </span><span class="com"># 记录prob值</span></li><li class="L3"><span class="pln">        pair_prob</span><span class="pun">[</span><span class="pln">i</span><span class="pun">,]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> this_prob</span></li><li class="L4"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">“Mean value of sigma: “</span><span class="pun">,</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">mean</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">sqrt</span><span class="pun">(</span><span class="lit">1</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> beta</span><span class="pun">)))</span></li><li class="L5"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> pair_prob</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="kwd">def</span><span class="pln"> pca</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> no_dims </span><span class="pun">=</span><span class="pln"> </span><span class="lit">50</span><span class="pun">):</span></li><li class="L9"><span class="pln">    </span><span class="str">‘’’ PCA算法</span></li><li class="L0"><span class="str">    使用PCA先进行预降维</span></li><li class="L1"><span class="str">    ‘’'</span></li><li class="L2"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">“Preprocessing the data using PCA…”</span><span class="pun">)</span></li><li class="L3"><span class="pln">    </span><span class="pun">(</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> d</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> x</span><span class="pun">.</span><span class="pln">shape</span></li><li class="L4"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> x </span><span class="pun">-</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">tile</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">mean</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></li><li class="L5"><span class="pln">    l</span><span class="pun">,</span><span class="pln"> M </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">linalg</span><span class="pun">.</span><span class="pln">eig</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">x</span><span class="pun">.</span><span class="pln">T</span><span class="pun">,</span><span class="pln"> x</span><span class="pun">))</span></li><li class="L6"><span class="pln">    y </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> M</span><span class="pun">[:,</span><span class="lit">0</span><span class="pun">:</span><span class="pln">no_dims</span><span class="pun">])</span></li><li class="L7"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> y</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="kwd">def</span><span class="pln"> tsne</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> no_dims</span><span class="pun">=</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> initial_dims</span><span class="pun">=</span><span class="lit">50</span><span class="pun">,</span><span class="pln"> perplexity</span><span class="pun">=</span><span class="lit">30.0</span><span class="pun">,</span><span class="pln"> max_iter</span><span class="pun">=</span><span class="lit">1000</span><span class="pun">):</span></li><li class="L1"><span class="pln">    </span><span class="str">””“Runs t-SNE on the dataset in the NxD array x</span></li><li class="L2"><span class="str">    to reduce its dimensionality to no_dims dimensions.</span></li><li class="L3"><span class="str">    The syntaxis of the function is Y = tsne.tsne(x, no_dims, perplexity),</span></li><li class="L4"><span class="str">    where x is an NxD NumPy array.</span></li><li class="L5"><span class="str">    “””</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">    </span><span class="com"># Check inputs</span></li><li class="L8"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">no_dims</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">float</span><span class="pun">):</span></li><li class="L9"><span class="pln">        </span><span class="kwd">print</span><span class="pun">(</span><span class="str">“Error: array x should have type float.”</span><span class="pun">)</span></li><li class="L0"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span></li><li class="L1"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> round</span><span class="pun">(</span><span class="pln">no_dims</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> no_dims</span><span class="pun">:</span></li><li class="L2"><span class="pln">        </span><span class="kwd">print</span><span class="pun">(</span><span class="str">“Error: number of dimensions should be an integer.”</span><span class="pun">)</span></li><li class="L3"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">    </span><span class="com"># 初始化参数和变量</span></li><li class="L6"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> pca</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> initial_dims</span><span class="pun">).</span><span class="pln">real</span></li><li class="L7"><span class="pln">    </span><span class="pun">(</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> d</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> x</span><span class="pun">.</span><span class="pln">shape</span></li><li class="L8"><span class="pln">    initial_momentum </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0.5</span></li><li class="L9"><span class="pln">    final_momentum </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0.8</span></li><li class="L0"><span class="pln">    eta </span><span class="pun">=</span><span class="pln"> </span><span class="lit">500</span></li><li class="L1"><span class="pln">    min_gain </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0.01</span></li><li class="L2"><span class="pln">    y </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">random</span><span class="pun">.</span><span class="pln">randn</span><span class="pun">(</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> no_dims</span><span class="pun">)</span></li><li class="L3"><span class="pln">    dy </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">zeros</span><span class="pun">((</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> no_dims</span><span class="pun">))</span></li><li class="L4"><span class="pln">    iy </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">zeros</span><span class="pun">((</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> no_dims</span><span class="pun">))</span></li><li class="L5"><span class="pln">    gains </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">ones</span><span class="pun">((</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> no_dims</span><span class="pun">))</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">    </span><span class="com"># 对称化</span></li><li class="L8"><span class="pln">    P </span><span class="pun">=</span><span class="pln"> seach_prob</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1e-5</span><span class="pun">,</span><span class="pln"> perplexity</span><span class="pun">)</span></li><li class="L9"><span class="pln">    P </span><span class="pun">=</span><span class="pln"> P </span><span class="pun">+</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">transpose</span><span class="pun">(</span><span class="pln">P</span><span class="pun">)</span></li><li class="L0"><span class="pln">    P </span><span class="pun">=</span><span class="pln"> P </span><span class="pun">/</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">P</span><span class="pun">)</span></li><li class="L1"><span class="pln">    </span><span class="com"># early exaggeration</span></li><li class="L2"><span class="pln">    P </span><span class="pun">=</span><span class="pln"> P </span><span class="pun"></span><span class="pln"> </span><span class="lit">4</span></li><li class="L3"><span class="pln">    P </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">maximum</span><span class="pun">(</span><span class="pln">P</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1e-12</span><span class="pun">)</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">    </span><span class="com"># Run iterations</span></li><li class="L6"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> iter </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="pln">max_iter</span><span class="pun">):</span></li><li class="L7"><span class="pln">        </span><span class="com"># Compute pairwise affinities</span></li><li class="L8"><span class="pln">        sum_y </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">square</span><span class="pun">(</span><span class="pln">y</span><span class="pun">),</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></li><li class="L9"><span class="pln">        num </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="pun">(</span><span class="lit">1</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(-</span><span class="lit">2</span><span class="pln"> </span><span class="pun"><em></em></span><span class="pln"> np</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">y</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">.</span><span class="pln">T</span><span class="pun">),</span><span class="pln"> sum_y</span><span class="pun">).</span><span class="pln">T</span><span class="pun">,</span><span class="pln"> sum_y</span><span class="pun">))</span></li><li class="L0"><span class="pln">        num</span><span class="pun">[</span><span class="pln">range</span><span class="pun">(</span><span class="pln">n</span><span class="pun">),</span><span class="pln"> range</span><span class="pun">(</span><span class="pln">n</span><span class="pun">)]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span></li><li class="L1"><span class="pln">        Q </span><span class="pun">=</span><span class="pln"> num </span><span class="pun">/</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">num</span><span class="pun">)</span></li><li class="L2"><span class="pln">        Q </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">maximum</span><span class="pun">(</span><span class="pln">Q</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1e-12</span><span class="pun">)</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">        </span><span class="com"># Compute gradient</span></li><li class="L5"><span class="pln">        PQ </span><span class="pun">=</span><span class="pln"> P </span><span class="pun">-</span><span class="pln"> Q</span></li><li class="L6"><span class="pln">        </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="pln">n</span><span class="pun">):</span></li><li class="L7"><span class="pln">            dy</span><span class="pun">[</span><span class="pln">i</span><span class="pun">,:]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">tile</span><span class="pun">(</span><span class="pln">PQ</span><span class="pun">[:,</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun"></span><span class="pln"> num</span><span class="pun">[:,</span><span class="pln">i</span><span class="pun">],</span><span class="pln"> </span><span class="pun">(</span><span class="pln">no_dims</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)).</span><span class="pln">T </span><span class="pun"><em></em></span><span class="pln"> </span><span class="pun">(</span><span class="pln">y</span><span class="pun">[</span><span class="pln">i</span><span class="pun">,:]</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> y</span><span class="pun">),</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">        </span><span class="com"># Perform the update</span></li><li class="L0"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> iter </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">20</span><span class="pun">:</span></li><li class="L1"><span class="pln">            momentum </span><span class="pun">=</span><span class="pln"> initial_momentum</span></li><li class="L2"><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></li><li class="L3"><span class="pln">            momentum </span><span class="pun">=</span><span class="pln"> final_momentum</span></li><li class="L4"><span class="pln">        gains </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">gains </span><span class="pun">+</span><span class="pln"> </span><span class="lit">0.2</span><span class="pun">)</span><span class="pln"> </span><span class="pun"></span><span class="pln"> </span><span class="pun">((</span><span class="pln">dy </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">iy </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">))</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">gains </span><span class="pun"><em></em></span><span class="pln"> </span><span class="lit">0.8</span><span class="pun">)</span><span class="pln"> </span><span class="pun"></span><span class="pln"> </span><span class="pun">((</span><span class="pln">dy </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun"><mark></mark></span><span class="pln"> </span><span class="pun">(</span><span class="pln">iy </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">))</span></li><li class="L5"><span class="pln">        gains</span><span class="pun">[</span><span class="pln">gains </span><span class="pun">&lt;</span><span class="pln"> min_gain</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> min_gain</span></li><li class="L6"><span class="pln">        iy </span><span class="pun">=</span><span class="pln"> momentum </span><span class="pun"><em></em></span><span class="pln"> iy </span><span class="pun">-</span><span class="pln"> eta </span><span class="pun"></span><span class="pln"> </span><span class="pun">(</span><span class="pln">gains </span><span class="pun">*</span><span class="pln"> dy</span><span class="pun">)</span></li><li class="L7"><span class="pln">        y </span><span class="pun">=</span><span class="pln"> y </span><span class="pun">+</span><span class="pln"> iy</span></li><li class="L8"><span class="pln">        y </span><span class="pun">=</span><span class="pln"> y </span><span class="pun">-</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">tile</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">mean</span><span class="pun">(</span><span class="pln">y</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></li><li class="L9"><span class="pln">        </span><span class="com"># Compute current value of cost function</span></li><li class="L0"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">iter </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="lit">100</span><span class="pln"> </span><span class="pun"></span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></li><li class="L1"><span class="pln">            </span><span class="kwd">if</span><span class="pln"> iter </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">100</span><span class="pun">:</span></li><li class="L2"><span class="pln">                C </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln">P </span><span class="pun"><em></em></span><span class="pln"> np</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">P </span><span class="pun">/</span><span class="pln"> Q</span><span class="pun">))</span></li><li class="L3"><span class="pln">            </span><span class="kwd">else</span><span class="pun">:</span></li><li class="L4"><span class="pln">                C </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">sum</span><span class="pun">(</span><span class="pln"> P</span><span class="pun">/</span><span class="lit">4</span><span class="pln"> </span><span class="pun"></span><span class="pln"> np</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln"> P</span><span class="pun">/</span><span class="lit">4</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> Q</span><span class="pun">))</span></li><li class="L5"><span class="pln">            </span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Iteration “</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="pln">iter </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">),</span><span class="pln"> </span><span class="str">”: error is "</span><span class="pun">,</span><span class="pln"> C</span><span class="pun">)</span></li><li class="L6"><span class="pln">        </span><span class="com"># Stop lying about P-values</span></li><li class="L7"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> iter </span><span class="pun"><mark></mark></span><span class="pln"> </span><span class="lit">100</span><span class="pun">:</span></li><li class="L8"><span class="pln">            P </span><span class="pun">=</span><span class="pln"> P </span><span class="pun">/</span><span class="pln"> </span><span class="lit">4</span></li><li class="L9"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">“finished training!”</span><span class="pun">)</span></li><li class="L0"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> y</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">if</span><span class="pln"> <strong>name</strong> </span><span class="pun"></span><span class="pln"> </span><span class="str">“<strong>main</strong>”</span><span class="pun">:</span></li><li class="L4"><span class="pln">    </span><span class="com"># Run Y = tsne.tsne(X, no_dims, perplexity) to perform t-SNE on your dataset.</span></li><li class="L5"><span class="pln">    X </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">loadtxt</span><span class="pun">(</span><span class="str">“mnist2500_X.txt”</span><span class="pun">)</span></li><li class="L6"><span class="pln">    labels </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">loadtxt</span><span class="pun">(</span><span class="str">“mnist2500_labels.txt”</span><span class="pun">)</span></li><li class="L7"><span class="pln">    Y </span><span class="pun">=</span><span class="pln"> tsne</span><span class="pun">(</span><span class="pln">X</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">50</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20.0</span><span class="pun">)</span></li><li class="L8"><span class="pln">    </span><span class="kwd">from</span><span class="pln"> matplotlib </span><span class="kwd">import</span><span class="pln"> pyplot </span><span class="kwd">as</span><span class="pln"> plt</span></li><li class="L9"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">scatter</span><span class="pun">(</span><span class="pln">Y</span><span class="pun">[:,</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> Y</span><span class="pun">[:,</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> </span><span class="lit">20</span><span class="pun">,</span><span class="pln"> labels</span><span class="pun">)</span></li><li class="L0"><span class="pln">    plt</span><span class="pun">.</span><span class="pln">show</span><span class="pun">()</span></li></ol></pre> 
</div> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/77b2f0e3f7fab16907f776de5c25de2b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C# WPF上位机开发（文本编辑器的界面开发）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a9a9f1cc0ee3d23a10c71e8a9759ba92/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">研发应用安全规范</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>