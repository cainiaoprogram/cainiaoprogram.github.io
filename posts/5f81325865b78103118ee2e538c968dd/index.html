<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【博客679】LVS NAT模式与FULLNAT模式原理与配置差别 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【博客679】LVS NAT模式与FULLNAT模式原理与配置差别" />
<meta property="og:description" content="LVS NAT模式与FULLNAT模式原理与配置差别 注意： LVS NAT模式是LVS原生的一种工作方式，而FULLNAT是在NAT模式下通过配置SNAT来
实现FULLNAT的，而且配合SNAT这部分是靠我们自己来实现的
1、LVS NAT模式原理与特点 NAT模式的数据包请求流程：
1、当用户请求到达 Director Server，此时请求的数据报文会先到内核空间的 PREROUTING 链。 此时报文的源 IP 为 CIP，目标 IP 为 VIP2、PREROUTING 检查发现数据包的目标 IP 是本机，将数据包送至 INPUT 链3、IPVS 比对数据包请求的服务是否为集群服务，若是，修改数据包的目标 IP 地址为后端服务器 IP，然后将数据包发至 POSTROUTING 链。 此时报文的源 IP 为 CIP，目标 IP 为 RIP4、POSTROUTING 链通过选路，将数据包发送给 Real Server5、Real Server 比对发现目标为自己的 IP，开始构建响应报文发回给 Director Server。 此时报文的源 IP 为 RIP，目标 IP 为 CIP6、Director Server 在响应客户端前，此时会将源 IP 地址修改为自己的 VIP 地址，然后响应给客户端。 此时报文的源 IP 为 VIP，目标 IP 为 CIP NAT模式特点：
RS 应该使用私有地址，RS 的网关必须指向 DIPDIP 和 RIP 必须在同一个网段内请求和响应报文都需要经过 Director Server，高负载场景中，Director Server 易成为性能瓶颈支持端口映射RS 可以使用任意操作系统 2、为什么需要LVS FULLNAT模式 LVS NAT模式下，一般需要设置RS 的网关必须指向 DS：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5f81325865b78103118ee2e538c968dd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-28T17:51:41+08:00" />
<meta property="article:modified_time" content="2023-06-28T17:51:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【博客679】LVS NAT模式与FULLNAT模式原理与配置差别</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="LVS_NATFULLNAT_0"></a>LVS NAT模式与FULLNAT模式原理与配置差别</h2> 
<h3><a id="_2"></a>注意：</h3> 
<blockquote> 
 <p>LVS NAT模式是LVS原生的一种工作方式，而FULLNAT是在NAT模式下通过配置SNAT来<br> 实现FULLNAT的，而且配合SNAT这部分是靠我们自己来实现的</p> 
</blockquote> 
<h3><a id="1LVS_NAT_7"></a>1、LVS NAT模式原理与特点</h3> 
<p><img src="https://images2.imgbox.com/1e/88/ec4JgXIV_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/4d/5a/NcjbSDZa_o.png" alt="在这里插入图片描述"><br> <strong>NAT模式的数据包请求流程：</strong></p> 
<ul><li>1、当用户请求到达 Director Server，此时请求的数据报文会先到内核空间的 PREROUTING 链。 此时报文的源 IP 为 CIP，目标 IP 为 VIP</li><li>2、PREROUTING 检查发现数据包的目标 IP 是本机，将数据包送至 INPUT 链</li><li>3、IPVS 比对数据包请求的服务是否为集群服务，若是，修改数据包的目标 IP 地址为后端服务器 IP，然后将数据包发至 POSTROUTING 链。 此时报文的源 IP 为 CIP，目标 IP 为 RIP</li><li>4、POSTROUTING 链通过选路，将数据包发送给 Real Server</li><li>5、Real Server 比对发现目标为自己的 IP，开始构建响应报文发回给 Director Server。 此时报文的源 IP 为 RIP，目标 IP 为 CIP</li><li>6、Director Server 在响应客户端前，此时会将源 IP 地址修改为自己的 VIP 地址，然后响应给客户端。 此时报文的源 IP 为 VIP，目标 IP 为 CIP</li></ul> 
<p><strong>NAT模式特点：</strong></p> 
<ul><li>RS 应该使用私有地址，RS 的网关必须指向 DIP</li><li>DIP 和 RIP 必须在同一个网段内</li><li>请求和响应报文都需要经过 Director Server，高负载场景中，Director Server 易成为性能瓶颈</li><li>支持端口映射</li><li>RS 可以使用任意操作系统</li></ul> 
<h3><a id="2LVS_FULLNAT_28"></a>2、为什么需要LVS FULLNAT模式</h3> 
<blockquote> 
 <p>LVS NAT模式下，一般需要设置RS 的网关必须指向 DS：<br> 因为RS收到的包的源ip是client ip，如果不设置RS 的网关必须指向 DS，默认将包送回DS，再由DS回复给client的话，那么RS直接回给client就会有问题，因为client发出的时候目的ip是vip，不是RS的ip，那么此时client对RS直接回过来的包会回复RST来终止这个连接，因为在client看来，不认为这个包是自己发出去的请求包的回包</p> 
</blockquote> 
<p><strong>如果采用LVS NAT + MASQUERADE实现FULLNAT的话，则不会有这个问题，因为RS看到的ip是DS的ip，也就是DS对client和对RS实现了双边连接，从而达到FULLNAT目的。虽然NAT模式也是RS流量都回给DS的，但是得将RS的默认网关设置为DS，这样有两个问题：</strong></p> 
<ul><li>需要操作RS（有时候RS你没有权限操作，有可能是别人是server，你是LB提供方）</li><li>如果一个RS同时是多个DS的后端，这时候你无法配置一个RS有多个默认网关，而且你无法区分流量要给哪个DS</li></ul> 
<p><strong>因此如果你是LB的提供方，你提供vip和负载均衡能力的时候只能使用FULLNAT，从而实现对于client和RS都无感知！</strong></p> 
<h3><a id="3LVS_NATMASQUERADEFULLNAT_39"></a>3、LVS NAT配合MASQUERADE实现FULLNAT要注意的地方</h3> 
<p><strong>1、需要开启两个内核特性：</strong></p> 
<ul><li>net.ipv4.ip_forward</li><li>net.ipv4.vs.conntrack</li></ul> 
<p><strong>2、需要添加MASQUERADE</strong></p> 
<pre><code>iptables -t nat -A POSTROUTING -m ipvs --vaddr xxxx --vport xxxxx -j MASQUERADE
</code></pre> 
<p><strong>3、参数的作用参考之前的博文：</strong></p> 
<ul><li><a href="https://blog.csdn.net/qq_43684922/article/details/127333055?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168794561516800182169870%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=168794561516800182169870&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-127333055-null-null.268%5Ev1%5Ekoosearch&amp;utm_term=ip_forward&amp;spm=1018.2226.3001.4450">【博客514】k8s中net.ipv4.ip_forward=1的意义</a></li><li><a href="https://blog.csdn.net/qq_43684922/article/details/128881968?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168794561516800182169870%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=168794561516800182169870&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-2-128881968-null-null.268%5Ev1%5Ekoosearch&amp;utm_term=ip_forward&amp;spm=1018.2226.3001.4450">【博客607】linux路由过程分析与net.ipv4.ip_forward参数</a></li><li><a href="https://blog.csdn.net/qq_43684922/article/details/128599358?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168794497616800192295057%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=168794497616800192295057&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-6-128599358-null-null.268%5Ev1%5Ekoosearch&amp;utm_term=lvs&amp;spm=1018.2226.3001.4450">【博客578】LVS NAT配合MASQUERADE实现FULLNAT的场景，及此场景下net.ipv4.vs.conntrack参数的重要作用</a></li></ul> 
<h3><a id="4LVS_NATnetipv4ip_forwardnetipv4vsconntrack_58"></a>4、LVS NAT模式下为什么不需要开启net.ipv4.ip_forward和net.ipv4.vs.conntrack</h3> 
<p><strong>原因是LVS NAT模式自己实现了一套连接跟踪机制，原理如下：</strong></p> 
<ul><li><a href="https://blog.csdn.net/qq_43684922/article/details/128694136?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168794585516800186515066%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=168794585516800186515066&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-6-128694136-null-null.268%5Ev1%5Ekoosearch&amp;utm_term=ipvs&amp;spm=1018.2226.3001.4450">【博客588】ipvs nat模式下独立于iptables与conntrack的连接跟踪表和NAT机制</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/243e098a4f77e1ac92ea4c23a97cea83/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">opencv学习笔记——4.0</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d5c4673bc0fe73fd01f484058626c614/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【宝塔下的免费 waf 防火墙对比】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>