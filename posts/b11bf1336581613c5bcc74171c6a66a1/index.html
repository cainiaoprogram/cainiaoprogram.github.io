<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>系统（嘀嗒）定时器 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="系统（嘀嗒）定时器" />
<meta property="og:description" content="一.简介 SysTick---系统（嘀嗒）定时器，内核外设，是一个24位的向下递减的计数器，计数器每计数一次的时间为 1/SYSCLK。
当重装载数值寄存器的值递减到 0 的时候，系统定时器就产生一次中断，以此循环往复。
系统定时器一般用于操作系统，用于产生时基，维持操作系统的心跳。
二.寄存器 校准寄存器一般不用。 三.实验（闪光灯） 编程步骤：
设置重装载寄存器的值；清除当前数值寄存器的值；配置控制与状态寄存器。 延时思路： systick 的 counter 从 reload 值往下递减到 0 的时候，CTRL 寄存器的位 16:countflag 会置 1 ，且读取该位的值可清 0 ，所有我们可以使用软件查询的方法来实现延时。 systick.c
#include &#34;systick.h&#34; #if 0 static __INLINE uint32_t SysTick_Config(uint32_t ticks) { // 判断 tick 的值是否大于 2^24，如果大于，则不符合规则 if (ticks &gt; SysTick_LOAD_RELOAD_Msk) return (1); // 初始化reload寄存器的值	SysTick-&gt;LOAD = (ticks &amp; SysTick_LOAD_RELOAD_Msk) - 1; // 配置中断优先级，配置为15，默认为最低的优先级 NVIC_SetPriority (SysTick_IRQn, (1&lt;&lt;__NVIC_PRIO_BITS) - 1); // 初始化counter的值为0	SysTick-&gt;VAL = 0; // 配置 systick 的时钟为 72M // 使能中断 // 使能systick SysTick-&gt;CTRL = SysTick_CTRL_CLKSOURCE_Msk | SysTick_CTRL_TICKINT_Msk | SysTick_CTRL_ENABLE_Msk; return (0); } #endif void SysTick_Delay_us(uint32_t us) { uint32_t i; SysTick_Config(72); for(i=0; i&lt;us; i&#43;&#43;) { // 当计数器的值减小到 0 的时候，CRTL 寄存器的位 16 会置 1 while( !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b11bf1336581613c5bcc74171c6a66a1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-02T19:29:49+08:00" />
<meta property="article:modified_time" content="2024-01-02T19:29:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">系统（嘀嗒）定时器</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一.简介</h2> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#000000;">SysTick---</span><span style="color:#000000;">系统（嘀嗒</span><span style="color:#000000;">）</span><span style="color:#000000;">定时器</span><span style="color:#000000;">，</span><span style="color:#fe2c24;">内核外设</span><span style="color:#000000;">，是一个</span><span style="color:#fe2c24;">24位</span><span style="color:#000000;">的</span><span style="color:#fe2c24;">向下递减</span><span style="color:#000000;">的</span><span style="color:#fe2c24;">计数器</span><span style="color:#000000;">，计数器每计数一次的时间为 1/SYSCLK</span><span style="color:#000000;">。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#000000;">当重装载数值寄存器的值递减到 0 的时候，系统定时器就产生一次中断，以此循环往复。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#000000;">系统定时器一般用于操作系统，用于产生时基，维</span><span style="color:#000000;">持操作系统的心跳。</span></p> 
<h2 style="margin-left:.0001pt;text-align:left;"><span style="color:#000000;">二.寄存器</span></h2> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ba/63/iA4DtA3T_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2a/07/UH355EtW_o.png"></p> 
<p style="text-align:center;">校准寄存器一般不用。 </p> 
<h2> 三.实验（闪光灯）</h2> 
<p><strong>编程步骤：</strong></p> 
<ol><li><span style="color:#000000;">设置重装载寄存器的值；</span></li><li><span style="color:#000000;">清除当前数值寄存器的值；</span></li><li><span style="color:#000000;">配置控制与状态寄存器。</span></li></ol> 
<div> 
 <strong>延时思路：</strong> 
</div> 
<div> 
 <span style="color:#000000;">systick </span> 
 <span style="color:#000000;">的 </span> 
 <span style="color:#000000;">counter </span> 
 <span style="color:#000000;">从 </span> 
 <span style="color:#000000;">reload </span> 
 <span style="color:#000000;">值往下递减到 </span> 
 <span style="color:#000000;">0 </span> 
 <span style="color:#000000;">的时候，CTRL </span> 
 <span style="color:#000000;">寄存器的位</span> 
 <span style="color:#000000;">16:countflag </span> 
 <span style="color:#000000;">会置 </span> 
 <span style="color:#000000;">1</span> 
 <span style="color:#000000;">，且读取该位的值可清 </span> 
 <span style="color:#000000;">0</span> 
 <span style="color:#000000;">，所有我们可以使用软件查询的方法来实现延时。</span> 
</div> 
<p> </p> 
<p>systick.c</p> 
<pre><code class="language-cpp">#include "systick.h"

#if 0
static __INLINE uint32_t SysTick_Config(uint32_t ticks)
{ 
	//  判断 tick 的值是否大于 2^24，如果大于，则不符合规则
  if (ticks &gt; SysTick_LOAD_RELOAD_Msk)  return (1);

  // 初始化reload寄存器的值	
  SysTick-&gt;LOAD  = (ticks &amp; SysTick_LOAD_RELOAD_Msk) - 1;
	
  // 配置中断优先级，配置为15，默认为最低的优先级
	NVIC_SetPriority (SysTick_IRQn, (1&lt;&lt;__NVIC_PRIO_BITS) - 1); 

  // 初始化counter的值为0	
  SysTick-&gt;VAL   = 0; 
  
  // 配置 systick 的时钟为 72M
  // 使能中断
	// 使能systick
  SysTick-&gt;CTRL  = SysTick_CTRL_CLKSOURCE_Msk | 
                   SysTick_CTRL_TICKINT_Msk   | 
                   SysTick_CTRL_ENABLE_Msk;                    
  return (0);                                                 
}
#endif

void SysTick_Delay_us(uint32_t us)
{
	uint32_t i;
	SysTick_Config(72);
	
	for(i=0; i&lt;us; i++)
	{
        // 当计数器的值减小到 0 的时候，CRTL 寄存器的位 16 会置 1
		while( !((SysTick-&gt;CTRL) &amp; (1&lt;&lt;16)) );
	}

	// 关闭 SysTick 定时器
	SysTick-&gt;CTRL &amp;= ~ SysTick_CTRL_ENABLE_Msk;
}

void SysTick_Delay_ms(uint32_t ms)
{
	uint32_t i;
	SysTick_Config(72000);
	
	for(i=0; i&lt;ms; i++)
	{
        // 当计数器的值减小到 0 的时候，CRTL 寄存器的位 16 会置 1
        // 当置 1 时，读取该位会清 0
		while( !((SysTick-&gt;CTRL) &amp; (1&lt;&lt;16)) );
	}
	
    // 关闭 SysTick 定时器
	SysTick-&gt;CTRL &amp;= ~ SysTick_CTRL_ENABLE_Msk;
}


</code></pre> 
<p><span style="color:#000000;"><strong>SysTick 中断时间的计算：</strong>SysTick_Config(SystemCoreClock </span><span style="color:#666666;">/ </span><span style="color:#21804f;">100000</span><span style="color:#000000;">) </span></p> 
<div> 
 <span style="color:#000000;">SysTick </span> 
 <span style="color:#000000;">定时器的计数器是向下递减计数的，计数一次的时间 </span> 
 <span style="color:#000000;">T</span> 
 <span style="color:#000000;">DEC</span> 
 <span style="color:#000000;">=1/CLK</span> 
 <span style="color:#000000;">AHB</span> 
 <span style="color:#000000;">，当重装载寄存器中的值 VALUE</span> 
 <span style="color:#000000;">LOAD </span> 
 <span style="color:#000000;">减到 </span> 
 <span style="color:#000000;">0 </span> 
 <span style="color:#000000;">的时候，产生中断，可知中断一次的时间 </span> 
 <span style="color:#000000;">T</span> 
 <span style="color:#000000;">INT</span> 
 <span style="color:#000000;">=VALUE</span> 
 <span style="color:#000000;">LOAD * </span> 
 <span style="color:#000000;">T</span> 
 <span style="color:#000000;">DEC</span> 
 <span style="color:#000000;">= VALUELOAD</span> 
 <span style="color:#000000;">/CLK</span> 
 <span style="color:#000000;">AHB</span> 
 <span style="color:#000000;">，其中 </span> 
 <span style="color:#000000;">CLK</span> 
 <span style="color:#000000;">AHB </span> 
 <span style="color:#000000;">=72MHZ</span> 
 <span style="color:#000000;">。如果设置 </span> 
 <span style="color:#000000;">VALUE</span> 
 <span style="color:#000000;">LOAD </span> 
 <span style="color:#000000;">为 </span> 
 <span style="color:#000000;">72</span> 
 <span style="color:#000000;">，那中断一次的时间 TINT</span> 
 <span style="color:#000000;">=72/72M=1us</span> 
 <span style="color:#000000;">。不过 </span> 
 <span style="color:#000000;">1us </span> 
 <span style="color:#000000;">的中断没啥意义，整个程序的重心都花在进出中断上了，根本没有时间处理其他的任务。 </span> 
</div> 
<p></p> 
<p>systick.h</p> 
<pre><code class="language-cpp">#ifndef _SYSTICK_H
#define _SYSTICK_H

#include "stm32f10x.h"
#include "core_cm3.h"


void SysTick_Delay_us(uint32_t us);
void SysTick_Delay_ms(uint32_t ms);

#endif

</code></pre> 
<p>led.c</p> 
<pre><code class="language-cpp">#include "led.h"

void led_gpio_init(void)
{
	GPIO_InitTypeDef GPIO_InitStruct;
	RCC_APB2PeriphClockCmd(LED0_GPIO_CLK,ENABLE);//注意需要用到的总线
	GPIO_InitStruct.GPIO_Pin = LED0_GPIO_PIN;
	GPIO_InitStruct.GPIO_Mode = GPIO_Mode_Out_PP;
	GPIO_InitStruct.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(LED0_GPIO_PORT,&amp;GPIO_InitStruct);
	GPIO_ResetBits(LED0_GPIO_PORT,LED0_GPIO_PIN);
	
}


</code></pre> 
<p>led.h</p> 
<pre><code class="language-cpp">#ifndef _LED_H
#define _LED_H

#include "stm32f10x.h"

#define LED0_GPIO_CLK			RCC_APB2Periph_GPIOB
#define LED0_GPIO_PORT 		GPIOB
#define LED0_GPIO_PIN			GPIO_Pin_5

/******************************************************************************************/
/* LED端口定义 */
#define LED0(x)   do{ x ? \
                      GPIO_SetBits(LED0_GPIO_PORT, LED0_GPIO_PIN) : \
                      GPIO_ResetBits(LED0_GPIO_PORT, LED0_GPIO_PIN); \
                  }while(0)      /* LED0翻转 */

#define digitalToggle(p,i) {p-&gt;ODR ^=i;} //输出反转状态

#define LED0_Toggle	digitalToggle(LED0_GPIO_PORT,LED0_GPIO_PIN)

void led_gpio_init(void);


#endif
</code></pre> 
<p>main.c</p> 
<pre><code class="language-cpp">#include "stm32f10x.h"
#include "led.h"
#include "systick.h"

int main()
{
	// 来到这里的时候，系统的时钟已经被配置成72M。
	led_gpio_init();

	while(1)
	{
		LED0(1);
		SysTick_Delay_ms(500);
		LED0(0);
		SysTick_Delay_ms(500);
		
	}
}
</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0d1638df2dee540f106ce263e014c955/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">react&#43;umi&#43;antd项目搭建配置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d8e9b6a2ce80cae17e1f5cf738fff768/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ABC201(A-C)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>