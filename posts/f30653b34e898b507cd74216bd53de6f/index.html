<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何高效安装MindSpore的GPU版本 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="如何高效安装MindSpore的GPU版本" />
<meta property="og:description" content="作者：王磊
更多精彩分享，欢迎访问和关注：https://www.zhihu.com/people/wldandan
MindSpore的GPU版本以前的安装指南，只写清楚了安装依赖，但没有明确指出安装具体执行的命令，缺乏实操性，比较依赖开发者自身的能力去完成安装，导致开发者在安装过程中会出现一些影响安装效率的问题。在新版本中，安装方面进行了优化，提供了自动化的脚本以及step by step的安装指南来帮助开发者完成Ubuntu&#43;GPU版本的安装。
基于自动化脚本完成Ubuntu18.04 &#43; GPU版本的安装 新的安装指南给出了自动化以及step by step安装方式，包括pip方式、Conda方式和源码编译方式。如果环境是全新的，可以使用自动化脚本安装，如果已经安装了一部分软件，也可以考虑跟随指南中后面的step by step的安装方式来完成安装。
在安装前，用户需要先执行nvidia-smi 来查看是否安装驱动，或者驱动是否匹配CUDA10.1/11.1。没有安装或者没有达到最低要求的驱动，需要按照指南先把驱动安装好。
sudo apt-get update sudo apt-get install ubuntu-drivers-common sudo ubuntu-drivers autoinstall 接下来只需要执行自动化脚本即可，假设我们需要用安装Python 3.9并使用pip完成1.6.1 的MindSpore版本安装，那么可以运行以下的脚本：
wget https://gitee.com/mindspore/mindspore/raw/master/scripts/install/ubuntu-gpu-pip.sh # 安装MindSpore 1.6.1，Python 3.9和CUDA 11.1。 PYTHON_VERSION=3.9 MINDSPORE_VERSION=1.6.1 bash -i ./ubuntu-gpu-pip.sh 如果你的网络条件比较好，那么在10-15分钟就能完成安装，自动化脚本在执行的结尾还会自动做run check检查以及运行简单的代码验证，最终你看到的结果应该是这样的：
MindSpore version: 1.6.1 The result of multiplication calculation is correct, MindSpore has been installed successfully! [[[[2. 2. 2. 2.] [2. 2. 2. 2.] [2. 2. 2. 2.]] [[2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f30653b34e898b507cd74216bd53de6f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-07T14:38:51+08:00" />
<meta property="article:modified_time" content="2023-02-07T14:38:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何高效安装MindSpore的GPU版本</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>作者：王磊</p> 
<p>更多精彩分享，欢迎访问和关注：https://www.zhihu.com/people/wldandan</p> 
<p>MindSpore的GPU版本以前的安装指南，只写清楚了安装依赖，但没有明确指出安装具体执行的命令，缺乏实操性，比较依赖开发者自身的能力去完成安装，导致开发者在安装过程中会出现一些<a href="https://link.zhihu.com/?target=https%3A//gitee.com/mindspore/mindspore/issues/I4N1CC" rel="nofollow" title="影响安装效率的问题">影响安装效率的问题</a>。在新版本中，安装方面进行了优化，提供了自动化的脚本以及step by step的安装指南来帮助开发者完成Ubuntu+GPU版本的安装。</p> 
<h4>基于自动化脚本完成Ubuntu18.04 + GPU版本的安装</h4> 
<p>新的安装指南给出了自动化以及step by step安装方式，包括<a href="https://link.zhihu.com/?target=https%3A//gitee.com/mindspore/docs/blob/master/install/mindspore_gpu_install_pip.md" rel="nofollow" title="pip方式">pip方式</a>、<a href="https://link.zhihu.com/?target=https%3A//gitee.com/mindspore/docs/blob/master/install/mindspore_gpu_install_conda.md" rel="nofollow" title="Conda方式">Conda方式</a>和<a href="https://link.zhihu.com/?target=https%3A//gitee.com/mindspore/docs/blob/master/install/mindspore_gpu_install_source.md" rel="nofollow" title="源码编译方式">源码编译方式</a>。如果环境是全新的，可以使用自动化脚本安装，如果已经安装了一部分软件，也可以考虑跟随指南中后面的step by step的安装方式来完成安装。</p> 
<p>在安装前，用户需要先执行<code>nvidia-smi</code> 来查看是否安装驱动，或者驱动是否匹配CUDA10.1/11.1。没有安装或者没有达到最低要求的驱动，需要按照指南先把驱动安装好。</p> 
<pre><code>sudo apt-get update
sudo apt-get install ubuntu-drivers-common
sudo ubuntu-drivers autoinstall
</code></pre> 
<p>接下来只需要执行自动化脚本即可，假设我们需要用安装Python 3.9并使用pip完成<code>1.6.1</code> 的MindSpore版本安装，那么可以运行以下的脚本：</p> 
<pre><code>wget https://gitee.com/mindspore/mindspore/raw/master/scripts/install/ubuntu-gpu-pip.sh
# 安装MindSpore 1.6.1，Python 3.9和CUDA 11.1。
PYTHON_VERSION=3.9 MINDSPORE_VERSION=1.6.1 bash -i ./ubuntu-gpu-pip.sh
</code></pre> 
<p>如果你的网络条件比较好，那么在<strong>10-15分钟</strong>就能完成安装，自动化脚本在执行的结尾还会自动做run check检查以及运行简单的代码验证，最终你看到的结果应该是这样的：</p> 
<pre><code>MindSpore version:  1.6.1
The result of multiplication calculation is correct, MindSpore has been installed successfully!
[[[[2. 2. 2. 2.]
   [2. 2. 2. 2.]
   [2. 2. 2. 2.]]

  [[2. 2. 2. 2.]
   [2. 2. 2. 2.]
   [2. 2. 2. 2.]]

  [[2. 2. 2. 2.]
   [2. 2. 2. 2.]
   [2. 2. 2. 2.]]]]
</code></pre> 
<h4>自动化脚本解释</h4> 
<p>以<a href="https://link.zhihu.com/?target=https%3A//gitee.com/mindspore/mindspore/raw/master/scripts/install/ubuntu-gpu-pip.sh" rel="nofollow" title="pip方式安装脚本">pip方式安装脚本</a>为例，我们来看下脚本的实现，理解脚本可以帮助大家更好的修改和扩展脚本。脚本整体可以分为四个部分： 1. 参数设置及检查； 2. 三方依赖安装； 3. CUDA及CUDNN安装； 4. MindSpore安装及验证；</p> 
<p>其中三方依赖安装和MindSpore比较简单，下面着重介绍下参数设置检查和CUDA安装，对于理解脚本使用以及扩展功能会有所帮助。</p> 
<h4>影响脚本的运行的参数</h4> 
<p>脚本的第一段提供了三个可调整的参数，Python版本(3.7,3.8,3.9)、MindSpore的版本(&gt;=1.6.0)以及Cuda的版本(10.1,11.1)，用户通过环境变量控制需要配置的环境，如</p> 
<pre><code>PYTHON_VERSION=3.9 MINDSPORE_VERSION=1.6.1 CUDA_VERSION=10.1 bash -i ./ubuntu-gpu-pip.sh</code></pre> 
<p>可以完成Python3.9、Cuda10.1以及MindSpore 1.6.1的版本安装。</p> 
<pre><code>PYTHON_VERSION=${PYTHON_VERSION:-3.7}
MINDSPORE_VERSION=${MINDSPORE_VERSION:EMPTY}
CUDA_VERSION=${CUDA_VERSION:-11.1}
</code></pre> 
<p>这里脚本用到点shell的小技巧，<code>PYTHON_VERSION=${PYTHON_VERSION:-3.7}</code> 指<code>PYTHON_VERSION</code> 缺省为3.7，但如果用户在脚本执行前设置了新值，则使用新的值。</p> 
<h4>CUDA和CUDDN的安装</h4> 
<p>Nvidia自身其实提供了cuda相关软件包的国内镜像源，基于镜像源，可以快速下载cuda的run包，使用静默方式完成cuda的安装。然后用同样的方式用apt-get的方式安装cudnn和libcudnn-dev。如果想安装其它的小版本，可以打开“<a href="https://link.zhihu.com/?target=https%3A//developer.download.nvidia.cn/compute/cuda/repos/ubuntu1804/x86_64/" rel="nofollow" title="https://developer.download.nvidia.cn/compute/cuda/repos/ubuntu1804/x86_64/">https://developer.download.nvidia.cn/compute/cuda/repos/ubuntu1804/x86_64/</a>”和“<a href="https://link.zhihu.com/?target=https%3A//developer.download.nvidia.cn/compute/machine-learning/repos/ubuntu1804/x86_64/" rel="nofollow" title="https://developer.download.nvidia.cn/compute/machine-learning/repos/ubuntu1804/x86_64/">https://developer.download.nvidia.cn/compute/machine-learning/repos/ubuntu1804/x86_64/</a>”地址来查找小版本号然后替换后执行脚本完成安装。</p> 
<pre><code># 下载并安装Cuda
echo "installing CUDA and cuDNN"
cd /tmp
declare -A cuda_url_map=()
cuda_url_map["10.1"]=https://developer.download.nvidia.cn/compute/cuda/10.1/Prod/local_installers/cuda_10.1.243_418.87.00_linux.run
cuda_url_map["11.1"]=https://developer.download.nvidia.cn/compute/cuda/11.1.1/local_installers/cuda_11.1.1_455.32.00_linux.run
cuda_url=${cuda_url_map[$CUDA_VERSION]}
wget $cuda_url
sudo sh ${cuda_url##*/} --silent --toolkit
cd -
# 添加cudnn/libcuda的镜像源
sudo apt-key adv --fetch-keys https://developer.download.nvidia.cn/compute/cuda/repos/ubuntu1804/x86_64/7fa2af80.pub
sudo add-apt-repository "deb https://developer.download.nvidia.cn/compute/cuda/repos/ubuntu1804/x86_64/ /"
sudo add-apt-repository "deb https://developer.download.nvidia.cn/compute/machine-learning/repos/ubuntu1804/x86_64/ /"
sudo apt-get update
declare -A cudnn_name_map=()
cudnn_name_map["10.1"]="libcudnn7=7.6.5.32-1+cuda10.1 libcudnn7-dev=7.6.5.32-1+cuda10.1"
cudnn_name_map["11.1"]="libcudnn8=8.0.4.30-1+cuda11.1 libcudnn8-dev=8.0.4.30-1+cuda11.1"
sudo apt-get install --no-install-recommends ${cudnn_name_map[$CUDA_VERSION]} -y

# 添加cuda到PATH和LD_LIBRARY_PATH中
set +e &amp;&amp; source ~/.bashrc
set -e
add_env PATH /usr/local/cuda/bin
add_env LD_LIBRARY_PATH /usr/local/cuda/lib64
add_env LD_LIBRARY_PATH /usr/lib/x86_64-linux-gnu
set +e &amp;&amp; source ~/.bashrc
</code></pre> 
<h4>自动化脚本存在的不足</h4> 
<p>自动化脚本在设计时，考虑到测试验证的成本问题，并没有将Ubuntu20.04和WSL加入到验收的范围，导致这两类用户在执行的时候报错，相应的问题已经转化为issue(<a href="https://link.zhihu.com/?target=https%3A//gitee.com/mindspore/mindspore/issues/I50V64" rel="nofollow" title="Ubuntu 20.04支持">Ubuntu 20.04支持</a>, <a href="https://link.zhihu.com/?target=https%3A//gitee.com/mindspore/mindspore/issues/I53JZC" rel="nofollow" title="WSL支持">WSL支持</a>)。</p> 
<h4>如何拓展脚本完成Ubuntu20.04以及WSL上的自动化安装</h4> 
<h4>拓展支持Ubuntu 20.04</h4> 
<p>如果我们再看下脚本解释中cuda安装的部分，可以看到“repos/ubuntu1804”如果更换为“repos/ubuntu2004”，就可以支持Ubuntu20.04了。所以我们需要在脚本中抽取一个Ubuntu版本的变量，通过Linux命令获得Ubuntu版本号，然后填充到下载地址就可以了。 具体的修改如下，通过<code>lsb_release -a | grep Release</code> 获取到包含版本的字符串如"Release: 20.04"，然后基于Linux字符串的魔法功能<code>${release_info//[!0-9]/}</code> 从字符串中抽取出数字2004。这里要增加一个额外的判断，因为Ubuntu 20.04不支持Cuda 10.1。后面的安装部分只要将硬编码的版本号改为引用变量即可。</p> 
<pre><code>release_info=$(lsb_release -a | grep Release)
UBUNTU_VERSION=${release_info//[!0-9]/}

[[ "$UBUNTU_VERSION" == "2004" &amp;&amp;  "$CUDA_VERSION" == "10.1" ]] &amp;&amp; echo "CUDA 10.1 is not supported on Ubuntu 20.04" &amp;&amp; exit 1
#...
sudo apt-key adv --fetch-keys https://developer.download.nvidia.cn/compute/cuda/repos/ubuntu${UBUNTU_VERSION}/x86_64/7fa2af80.pub
sudo add-apt-repository "deb https://developer.download.nvidia.cn/compute/cuda/repos/ubuntu${UBUNTU_VERSION}/x86_64/ /"
sudo add-apt-repository "deb https://developer.download.nvidia.cn/compute/machine-learning/repos/ubuntu${UBUNTU_VERSION}/x86_64/ /"
sudo
</code></pre> 
<h4>解决WSL上自动化安装的问题</h4> 
<p>原有的脚本在WSL上执行到下面的脚本时会遇到一个错误。</p> 
<pre><code>driver_version=$(modinfo nvidia | grep ^version | awk '{printf $2}')
if [[ $driver_version &lt; ${minimum_driver_version_map[$CUDA_VERSION]} ]]; then
    echo "CUDA $CUDA_VERSION minimum required driver version is ${minimum_driver_version_map[$CUDA_VERSION]}, \
        but current nvidia driver version is $driver_version, please upgrade your driver manually."
    exit 1
fi
</code></pre> 
<p>错误信息如下：</p> 
<pre><code>iambowen@LAPTOP-ESJAVHR4:~/jenkins$ MINDSPORE_VERSION=1.6.1 bash -i ubuntu-gpu-pip.sh
modinfo: ERROR: Module alias nvidia not found.
CUDA 11.1 minimum required driver version is 450.80.02,         but current nvidia driver version is , please upgrade your driver manually.
</code></pre> 
<p>错误的原因在于获取驱动信息的命令<code>modinfo nvidia</code> 在WSL执行会直接报<code>modinfo: ERROR: Module alias nvidia not found.</code> 错误。解决的办法是使用<code>nvidia-smi --query-gpu=driver_version --format=csv,noheader --id=0</code> 获取到Nvidia驱动的信息。如果驱动没有安装，命令执行返回为空，后面的检查逻辑也可以正常运行，提示安装升级驱动版本。</p> 
<pre><code>driver_version=$(nvidia-smi --query-gpu=driver_version --format=csv,noheader --id=0)
if [[ $driver_version &lt; ${minimum_driver_version_map[$CUDA_VERSION]} ]]; then
    echo "CUDA $CUDA_VERSION minimum required driver version is ${minimum_driver_version_map[$CUDA_VERSION]}, \
        but current nvidia driver version is $driver_version, please upgrade your driver manually."
    exit 1
fi
</code></pre> 
<p>相关脚本在华为云以及WSL的Ubuntu18.04/20.04上都完成验证，应该可行，修改已发送<a href="https://link.zhihu.com/?target=https%3A//gitee.com/mindspore/mindspore/pulls/33315" rel="nofollow" title="Pull Request">Pull Request</a>。</p> 
<h3>总结</h3> 
<p>当前MindSpore的Master分支中，除了GPU版本的自动化安装，针对昇腾和CPU等的版本，也提供了自动化脚本和简化安装的<a href="https://link.zhihu.com/?target=https%3A//gitee.com/mindspore/docs/tree/master/install" rel="nofollow" title="指南">指南</a>，相信这些脚本和指南可以持续提升MindSpore在多平台下的安装体验。</p> 
<h3><strong><u>说明：严禁转载本文内容，否则视为侵权。</u></strong></h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9917c0374ea2ba2c3c205b20aec5c144/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux添加环境变量的方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c4412037ca6c988e2bb96fa12561aeb5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux 网络流量监控工具</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>