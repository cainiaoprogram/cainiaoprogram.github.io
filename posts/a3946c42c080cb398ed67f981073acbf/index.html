<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>scrapy爬虫中间件和下载中间件的使用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="scrapy爬虫中间件和下载中间件的使用" />
<meta property="og:description" content="一、关于中间件 之前文章说过，scrapy有两种中间件：爬虫中间件和下载中间件，他们的作用时间和位置都不一样，具体区别如下：
爬虫中间件（Spider Middleware） 作用： 爬虫中间件主要负责处理从引擎发送到爬虫的请求和从爬虫返回到引擎的响应。这些中间件在请求发送给爬虫之前或响应返回给引擎之前可以对它们进行处理。
下载中间件（Downloader Middleware） 作用： 下载中间件主要负责处理引擎发送到下载器的请求和从下载器返回到引擎的响应。这些中间件在请求发送给下载器之前或响应返回给引擎之前可以对它们进行处理。
中间件作用优先级 只需要记住，级别越小的越接近scrapy的引擎，结合scrapy的数据流，就能记住每个中间件的作用时机。
结合图可知：
在下载中间件中： 对于process_request()来说，优先级数字越小越先被调用；对于process_response()来说，优先级数字越大越先被调用 在爬虫中间件中： 对于process_spider_input()来说，优先级数字越小越先被调用；对于process_spider_output()来说，优先级数字越大越先被调用 那么哪来的这些方法？
二、定义中间件的通用模板 先看一个内置的中间件：UserAgentMiddleware
init: 在这里进行中间件的初始化，可以使用 settings 对象获取配置信息from_crawler:在这里通过 crawler 对象创建中间件的实例，可以获取全局配置信息spider_opened(可选): 在这里执行爬虫启动时的初始化操作，例如打开文件、连接数据库等process_request(可选): 在这里对请求进行预处理，例如修改请求头、添加代理等那么同理process_response(可选) 爬虫中间件模板 class MySpiderMiddleware(object): def __init__(self, settings): # 在这里进行中间件的初始化，可以使用 settings 对象获取配置信息 pass @classmethod def from_crawler(cls, crawler): # 在这里通过 crawler 对象创建中间件的实例，可以获取全局配置信息 settings = crawler.settings return cls(settings) def process_spider_input(self, response, spider): # 在这里处理从下载器传递给爬虫的响应对象 return response def process_spider_output(self, response, result, spider): # 在这里处理爬虫生成的结果，例如对结果进行过滤或修改 return result def process_spider_exception(self, response, exception, spider): # 在这里处理爬虫产生的异常 pass 下载中间件模板 class MyDownloaderMiddleware(object): def __init__(self, settings): # 在这里进行中间件的初始化，可以使用 settings 对象获取配置信息 pass @classmethod def from_crawler(cls, crawler): # 在这里通过 crawler 对象创建中间件的实例，可以获取全局配置信息 settings = crawler." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a3946c42c080cb398ed67f981073acbf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-02T04:15:53+08:00" />
<meta property="article:modified_time" content="2023-12-02T04:15:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">scrapy爬虫中间件和下载中间件的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一、关于中间件</h3> 
<p>之前文章说过，scrapy有两种中间件：<code>爬虫中间件和下载中间件</code>，他们的作用时间和位置都不一样，具体区别如下：</p> 
<ol><li>爬虫中间件（Spider Middleware）</li></ol> 
<p>作用： 爬虫中间件主要负责处理从引擎发送到爬虫的请求和从爬虫返回到引擎的响应。这些中间件在请求发送给爬虫之前或响应返回给引擎之前可以对它们进行处理。</p> 
<ol start="2"><li>下载中间件（Downloader Middleware）</li></ol> 
<p>作用： 下载中间件主要负责处理引擎发送到下载器的请求和从下载器返回到引擎的响应。这些中间件在请求发送给下载器之前或响应返回给引擎之前可以对它们进行处理。</p> 
<ol start="3"><li><code>中间件作用优先级</code></li></ol> 
<p>只需要记住，级别越小的越接近scrapy的引擎，结合scrapy的数据流，就能记住每个中间件的作用时机。<br> <img src="https://images2.imgbox.com/8b/7a/7dB9N7KQ_o.png" alt="在这里插入图片描述"></p> 
<p>结合图可知：</p> 
<ul><li>在下载中间件中：</li></ul> 
<blockquote> 
 <ul><li>对于process_request()来说，优先级数字越小越先被调用；</li><li>对于process_response()来说，优先级数字越大越先被调用</li></ul> 
</blockquote> 
<ul><li>在爬虫中间件中：</li></ul> 
<blockquote> 
 <ul><li>对于process_spider_input()来说，优先级数字越小越先被调用；</li><li>对于process_spider_output()来说，优先级数字越大越先被调用</li></ul> 
</blockquote> 
<p>那么哪来的这些方法？</p> 
<h3><a id="_32"></a>二、定义中间件的通用模板</h3> 
<ol><li>先看一个内置的中间件：UserAgentMiddleware<br> <img src="https://images2.imgbox.com/75/ba/qcp0DZVI_o.png" alt="在这里插入图片描述"></li></ol> 
<ul><li>init: 在这里进行中间件的初始化，可以使用 settings 对象获取配置信息</li><li>from_crawler:在这里通过 crawler 对象创建中间件的实例，可以获取全局配置信息</li><li>spider_opened(可选): 在这里执行爬虫启动时的初始化操作，例如打开文件、连接数据库等</li><li>process_request(可选): 在这里对请求进行预处理，例如修改请求头、添加代理等</li><li>那么同理process_response(可选)</li></ul> 
<ol start="2"><li>爬虫中间件模板</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MySpiderMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里进行中间件的初始化，可以使用 settings 对象获取配置信息</span>
        <span class="token keyword">pass</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里通过 crawler 对象创建中间件的实例，可以获取全局配置信息</span>
        settings <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>settings<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_spider_input</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里处理从下载器传递给爬虫的响应对象</span>
        <span class="token keyword">return</span> response

    <span class="token keyword">def</span> <span class="token function">process_spider_output</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> result<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里处理爬虫生成的结果，例如对结果进行过滤或修改</span>
        <span class="token keyword">return</span> result

    <span class="token keyword">def</span> <span class="token function">process_spider_exception</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里处理爬虫产生的异常</span>
        <span class="token keyword">pass</span>

</code></pre> 
<ol start="3"><li>下载中间件模板</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MyDownloaderMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里进行中间件的初始化，可以使用 settings 对象获取配置信息</span>
        <span class="token keyword">pass</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里通过 crawler 对象创建中间件的实例，可以获取全局配置信息</span>
        settings <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>settings<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里对请求进行预处理，例如修改请求头、添加代理等</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>  <span class="token comment"># 返回 None 表示继续处理请求，或者返回一个新的请求对象</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里对响应进行处理，例如修改响应内容、判断是否重新发送请求等</span>
        <span class="token keyword">return</span> response  <span class="token comment"># 返回响应对象，或者返回一个新的响应对象</span>

    <span class="token keyword">def</span> <span class="token function">process_exception</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在这里处理请求异常，例如记录日志、发送通知等</span>
        <span class="token keyword">pass</span>
</code></pre> 
<h3><a id="_96"></a>三、位置</h3> 
<p><img src="https://images2.imgbox.com/12/5e/WuNC2n7L_o.png" alt="在这里插入图片描述"></p> 
<p>我们自定义的中间件在middlewares.py中编写类就可以</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0add48430b9152da83b58574afebf377/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">cocos 关于多个摄像机，动态添加节点的显示问题，需要动态修改layer。（跟随摄像机滚动）（神坑官网也不说明一下）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/afe12d9d13e4dfc834ef4f486444b57a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Yocto - bb脚本中使用的SRC_URI、SRCREV和S</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>