<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>旧照片修复-模糊图片变清晰-2023年度最强神器 codeformer - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="旧照片修复-模糊图片变清晰-2023年度最强神器 codeformer" />
<meta property="og:description" content="CodeFormer是一种基于AI技术深度学习的人脸复原模型，由南洋理工大学和商汤科技联合研究中心联合开发。该模型通过结合了VQGAN和Transformer等技术，可以通过提供模糊或马赛克图像来生成清晰的原始图像。
功能：
1、老照片修复
2、黑白照片彩色化
3、照片马赛克修复
4、低码率视频增强，增加细节
参考资料：
GitHub - sczhou/CodeFormer: [NeurIPS 2022] Towards Robust Blind Face Restoration with Codebook Lookup Transformer
按照教程，安装环境 首先安装miniconda3
新建python3.8 环境
/home/sean.xd/miniconda3/bin/conda create -n codeformer python=3.8 新建本地的venv
/home/sean.xd/miniconda3/envs/codeformer/bin/python -m venv venv
source venv/bin/activate
按照官方教程，安装requirements.txt
pip install -r requirements.txt
按照教程，安装
python basicsr/setup.py develop 但是会遇到报错，没有cython， 那就手工安装一下
pip install cython
然后再执行 python basicsr/setup.py develop， 这次就成功了
安装dlib
/home/sean.xd/miniconda3/bin/conda install -c conda-forge dlib 安装ffmpeg
/home/sean.xd/miniconda3/bin/conda install -c conda-forge ffmpeg 下载训练好的模型 python scripts/download_pretrained_models." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4c3220f4a596eff26e7ef94280b1a96c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-27T21:32:55+08:00" />
<meta property="article:modified_time" content="2023-04-27T21:32:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">旧照片修复-模糊图片变清晰-2023年度最强神器 codeformer</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p></p> 
<p id="1L0LGF0P">CodeFormer是一种基于AI技术深度学习的人脸复原模型，由南洋理工大学和商汤科技联合研究中心联合开发。该模型通过结合了VQGAN和Transformer等技术，可以通过提供模糊或马赛克图像来生成清晰的原始图像。</p> 
<p></p> 
<p id="ue425910e">功能：</p> 
<p id="u968567c3">1、老照片修复</p> 
<p id="ufac2a578">2、黑白照片彩色化</p> 
<p id="ua4110a77">3、照片马赛克修复</p> 
<p id="u74787341">4、低码率视频增强，增加细节</p> 
<p id="uc21e4a15"></p> 
<p id="u54b3ead9">参考资料：</p> 
<p id="ub6f7967e"><a href="https://github.com/sczhou/CodeFormer" title="GitHub - sczhou/CodeFormer: [NeurIPS 2022] Towards Robust Blind Face Restoration with Codebook Lookup Transformer">GitHub - sczhou/CodeFormer: [NeurIPS 2022] Towards Robust Blind Face Restoration with Codebook Lookup Transformer</a></p> 
<p id="uf4890134"></p> 
<p id="u9a1601eb"></p> 
<h3 id="ue0f43371">按照教程，安装环境</h3> 
<p id="uadc8eeb2"></p> 
<p id="ub7307619">首先安装miniconda3</p> 
<p id="udca8f421"></p> 
<p id="uc5fd21fa">新建python3.8 环境</p> 
<p id="u7c1c0eff"></p> 
<blockquote> 
 <pre id="ciu7J">/home/sean.xd/miniconda3/bin/conda create -n codeformer python=3.8</pre> 
</blockquote> 
<p id="u5ad3545a"></p> 
<p id="u69d098f8">新建本地的venv</p> 
<blockquote> 
 <p id="u1f5b64da">/home/sean.xd/miniconda3/envs/codeformer/bin/python -m venv venv</p> 
</blockquote> 
<blockquote> 
 <p id="u056bc0ee">source venv/bin/activate</p> 
</blockquote> 
<p id="u9e2c49c8"></p> 
<p id="u45619762">按照官方教程，安装requirements.txt</p> 
<blockquote> 
 <p id="uc8d0c335">pip install -r requirements.txt</p> 
</blockquote> 
<p id="u8a32a68e"></p> 
<p id="udb94500b">按照教程，安装</p> 
<blockquote> 
 <pre id="VUkYT">python basicsr/setup.py develop</pre> 
</blockquote> 
<p id="u953c621e"></p> 
<p id="uc48d99b4">但是会遇到报错，没有cython， 那就手工安装一下</p> 
<p></p> 
<blockquote> 
 <p id="u4e0b70db">pip install cython</p> 
</blockquote> 
<p></p> 
<p id="udab406fe">然后再执行 python basicsr/setup.py develop， 这次就成功了</p> 
<p id="ua8e175e8"></p> 
<p id="u911a6551"></p> 
<p id="uaa234d97">安装dlib</p> 
<blockquote> 
 <pre id="tN7Ss">/home/sean.xd/miniconda3/bin/conda install -c conda-forge dlib</pre> 
</blockquote> 
<p id="ubf85cc7d"></p> 
<p id="u5f338f55">安装ffmpeg</p> 
<blockquote> 
 <pre id="GV5vp">/home/sean.xd/miniconda3/bin/conda install -c conda-forge ffmpeg</pre> 
</blockquote> 
<p id="uea1d3c7a"></p> 
<p id="u7a37ea41"></p> 
<h3 id="uf27c8d2d">下载训练好的模型</h3> 
<p></p> 
<blockquote> 
 <pre id="wYc3U">python scripts/download_pretrained_models.py facelib</pre> 
</blockquote> 
<p id="u994b57eb"></p> 
<blockquote> 
 <pre id="nV1cU">python scripts/download_pretrained_models.py dlib</pre> 
</blockquote> 
<p id="u3d9952a8"></p> 
<blockquote> 
 <pre id="aSDm7">python scripts/download_pretrained_models.py CodeFormer</pre> 
</blockquote> 
<p id="ude4a7854"></p> 
<p id="u0ed19f4d"></p> 
<p id="u917bf358"></p> 
<p id="u1f4101eb"></p> 
<h3 id="uc8bfd1f1">测试视频增强功能</h3> 
<p id="u9b67c208"></p> 
<p id="ubb77233b">提醒缺少ffmpeg， import ffmpeg失败</p> 
<p id="u1832fe7f">pip3 install ffmpeg-python ，这样就有了</p> 
<p id="u74a35603"></p> 
<blockquote> 
 <p id="u14e09fd4">python inference_codeformer.py --bg_upsampler realesrgan --face_upsample -w 1.0 --input_path inputs/xudong.mp4</p> 
</blockquote> 
<p></p> 
<pre><code class="language-bash">python inference_codeformer.py --bg_upsampler realesrgan --face_upsample -w 1.0 --input_path  inputs/xudong.mp4  
inference_codeformer.py:49: RuntimeWarning: Running on CPU now! Make sure your PyTorch version matches your CUDA.The unoptimized RealESRGAN is slow on CPU. If you want to disable it, please remove `--bg_upsampler` and `--face_upsample` in command.
  warnings.warn('Running on CPU now! Make sure your PyTorch version matches your CUDA.'
Face detection model: retinaface_resnet50
Background upsampling: True, Face upsampling: True
[1/276] Processing: xudong_000000
	detect 0 faces
[2/276] Processing: xudong_000001
	detect 0 faces
[3/276] Processing: xudong_000002
	detect 0 faces
[4/276] Processing: xudong_000003
	detect 0 faces
[5/276] Processing: xudong_000004
	detect 0 faces
[6/276] Processing: xudong_000005
	detect 0 faces
[7/276] Processing: xudong_000006
	detect 0 faces
[8/276] Processing: xudong_000007
	detect 0 faces
[9/276] Processing: xudong_000008
	detect 0 faces
[10/276] Processing: xudong_000009
	detect 0 faces</code></pre> 
<pre id="AtZoJ">
</pre> 
<p id="u8076c82d">处理的很慢，最后给kill掉了。 不过过程来看，相对顺利。</p> 
<p id="u1f7c4f1e"></p> 
<p id="u19cd572f"></p> 
<p id="u25675724">占用cpu很高</p> 
<p id="u2a2f8aa8"></p> 
<pre><code class="language-bash">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                            
 29715 sean.xd   20   0 9967.3m   1.8g 104776 R  1237  1.5 116:27.63 python inference_codeformer.py --bg_upsampler realesrgan --face_upsample -w 1.0 --input_path inputs/xudong.mp4 </code></pre> 
<p id="uc780501e"></p> 
<p id="u9a5e133c"></p> 
<p id="ubf21a6b2"></p> 
<h3 id="u80596c99">测试图片增强功能</h3> 
<p id="u43249e47"></p> 
<p id="uf5889066">项目有个目录，专门用于测试的。例如这张</p> 
<p id="ufac3ad45"></p> 
<p id="udc2dabf2"><a href="https://github.com/sczhou/CodeFormer/blob/master/inputs/whole_imgs/03.jpg" title="https://github.com/sczhou/CodeFormer/blob/master/inputs/whole_imgs/03.jpg">https://github.com/sczhou/CodeFormer/blob/master/inputs/whole_imgs/03.jpg</a></p> 
<p id="u40e722cc"></p> 
<p id="u0015fde0"></p> 
<p id="u9b6f3f2f">运行如下命令</p> 
<p></p> 
<blockquote> 
 <p>$ python inference_codeformer.py -w 0.7 --bg_upsampler realesrgan  --face_upsample  --input_path inputs/whole_imgs/03.jpg<br> inference_codeformer.py:49: RuntimeWarning: Running on CPU now! Make sure your PyTorch version matches your CUDA.The unoptimized RealESRGAN is slow on CPU. If you want to disable it, please remove `--bg_upsampler` and `--face_upsample` in command.<br>   warnings.warn('Running on CPU now! Make sure your PyTorch version matches your CUDA.'<br> Face detection model: retinaface_resnet50<br> Background upsampling: True, Face upsampling: True<br> [1/1] Processing: 03.jpg<br>     detect 1 faces</p> 
 <p>All results are saved in results/test_img_0.7</p> 
</blockquote> 
<p></p> 
<p> </p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/d5/94/eIp7Esbq_o.png"></p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/53/7f/dAMUVi1V_o.png"></p> 
<p></p> 
<p id="udf98d77f">不得不说，效果是真的牛批！</p> 
<p id="ua444df51"></p> 
<p id="uc32207a9"></p> 
<p id="ud8ea8055">使用time命令，看看执行总共耗时多少。32核CPU，耗时55秒。如果是单核心cpu，则大概耗时8min多。</p> 
<p></p> 
<blockquote> 
 <p id="u860a4f25">real 0m55.259s</p> 
 <p id="uc8e09793">user 8m35.757s</p> 
 <p id="u52177cd6">sys 1m43.415s</p> 
</blockquote> 
<p id="u105243e6"></p> 
<p id="u289cd610"></p> 
<p id="ucfe3ea93">再多测试几张照片</p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/0c/4b/KDNmucVi_o.png"></p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/75/21/7xhGaCqU_o.png"></p> 
<p></p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/bf/3f/HFRuUQtC_o.png"></p> 
<p></p> 
<p></p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/9f/72/5UStHzDx_o.png"></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/909207744662c0089ae496f01aa36732/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Redis中的序列化</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/42979c06abb53e654677b27722684c05/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring RabbitMQ 实现消息队列延迟</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>