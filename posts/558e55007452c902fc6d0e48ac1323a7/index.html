<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql并发更新丢失解决方案实战 go语言 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql并发更新丢失解决方案实战 go语言" />
<meta property="og:description" content="mysql并发更新丢失解决方案实战 1 更新丢失 对于可重复读、读已提交隔离级别都会有更新丢失的问题。事务A、事务B开始读取到order_id=1的累计金额为0，事务A加一后执行更新并提交，此时数据库中累计金额为1。事务B也加一并执行更新且提交，覆盖了事务A的结果。两个事务完成后，数据库中累计金额为1。而我们的预期是2。
2 解决方案 2.1悲观锁 对数据加锁，同一时间内只能有一个事务进行更新。
2.2更改update语句 因为update语句是原子性的，对于update a = a &#43; 1类型，即使在高并发下，依然是一条一条执行，执行多少次update就增加几次1。
原来：
accumulativeTotal=1
accumulativeTotal= accumulativeTotal &#43;1
update accumulative_total = accumulativeTotal
改为：
accumulativeTotal=1
update accumulative_total = accumulative_total &#43; 1
2.3乐观锁 乐观锁没有加锁，而是由应用程序判断是否可以更新。一般会通过引入版本号的方式来实现，在更新之前读取到版本号，update语句指定where条件版本号等于之前读到的，并让版本加一，也是依赖update语句的原子性。版本号等于之前读到的说明数据没有被更改，可以更新，否则放弃更新，重新读取更新。由于可能在事务中多次读取版本号，且版本号要最新的，因此隔离级别应为读已提交。
乐观锁适合于并发较低的情况，当并发高时，应用会不断地读取版本、放弃更新，不停空转，消耗cpu、数据库资源。
2.4分布式锁 分布式锁，比如redis实现的分布式锁，多了跟redis交互的时间，效率并不高。
3 实战 3.1说明 3.1.1 源码 https://gitee.com/tong-exists/concurrent-update-mysql
3.1.2 机器配置 数据库机器
虚拟机2GB内存，1核cpu
redis机器配置
虚拟机2GB内存，1核cpu
宿主机配置
16GB内存，8核cpu 2.4Ghz。go程序、jmeter都在宿主机运行。
3.1.3 表的初始状态 也是测试前的状态
3.1.4 测试 测试软件为jmeter
3.1.4.1 高并发测试配置 样本为5000个，100的并发
3.1.4.2 低并发测试配置 样本为5000个，10的并发
3.2更新丢失 3.2.1 代码 package main import ( &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/558e55007452c902fc6d0e48ac1323a7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-26T12:41:25+08:00" />
<meta property="article:modified_time" content="2022-11-26T12:41:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql并发更新丢失解决方案实战 go语言</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <div align="center"> 
 <font size="70"> mysql并发更新丢失解决方案实战 </font> 
</div> 
<h2><a id="1____6"></a>1 更新丢失</h2> 
<p>对于可重复读、读已提交隔离级别都会有更新丢失的问题。事务A、事务B开始读取到order_id=1的累计金额为0，事务A加一后执行更新并提交，此时数据库中累计金额为1。事务B也加一并执行更新且提交，覆盖了事务A的结果。两个事务完成后，数据库中累计金额为1。而我们的预期是2。</p> 
<p><img src="https://images2.imgbox.com/36/f7/PvV3g0xi_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2____13"></a>2 解决方案</h2> 
<h3><a id="21_15"></a>2.1悲观锁</h3> 
<p>对数据加锁，同一时间内只能有一个事务进行更新。</p> 
<h3><a id="22update_19"></a>2.2更改update语句</h3> 
<p>因为update语句是原子性的，对于update a = a + 1类型，即使在高并发下，依然是一条一条执行，执行多少次update就增加几次1。</p> 
<p>原来：</p> 
<p>accumulativeTotal=1</p> 
<p>accumulativeTotal= accumulativeTotal +1</p> 
<p>update accumulative_total = accumulativeTotal</p> 
<p>改为：</p> 
<p>accumulativeTotal=1</p> 
<p>update accumulative_total = accumulative_total + 1</p> 
<h3><a id="23_37"></a>2.3乐观锁</h3> 
<p>乐观锁没有加锁，而是由应用程序判断是否可以更新。一般会通过引入版本号的方式来实现，在更新之前读取到版本号，update语句指定where条件版本号等于之前读到的，并让版本加一，也是依赖update语句的原子性。版本号等于之前读到的说明数据没有被更改，可以更新，否则放弃更新，重新读取更新。由于可能在事务中多次读取版本号，且版本号要最新的，因此隔离级别应为读已提交。</p> 
<p>乐观锁适合于并发较低的情况，当并发高时，应用会不断地读取版本、放弃更新，不停空转，消耗cpu、数据库资源。</p> 
<h3><a id="24_43"></a>2.4分布式锁</h3> 
<p>分布式锁，比如redis实现的分布式锁，多了跟redis交互的时间，效率并不高。</p> 
<h2><a id="3____47"></a>3 实战</h2> 
<h3><a id="31_49"></a>3.1说明</h3> 
<h4><a id="311_____51"></a>3.1.1 源码</h4> 
<p><a href="https://gitee.com/tong-exists/concurrent-update-mysql" rel="nofollow">https://gitee.com/tong-exists/concurrent-update-mysql</a></p> 
<h4><a id="312_____55"></a>3.1.2 机器配置</h4> 
<p><strong>数据库机器</strong></p> 
<p>虚拟机2GB内存，1核cpu</p> 
<p><strong>redis机器配置</strong></p> 
<p>虚拟机2GB内存，1核cpu</p> 
<p><strong>宿主机配置</strong></p> 
<p>16GB内存，8核cpu 2.4Ghz。go程序、jmeter都在宿主机运行。</p> 
<h4><a id="313_____69"></a>3.1.3 表的初始状态</h4> 
<p>也是测试前的状态<br> <img src="https://images2.imgbox.com/48/4e/d9YJcj2u_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="314_____75"></a>3.1.4 测试</h4> 
<p>测试软件为jmeter</p> 
<h5><a id="3141___79"></a>3.1.4.1 高并发测试配置</h5> 
<p>样本为5000个，100的并发</p> 
<p><img src="https://images2.imgbox.com/49/fa/flgNxMsa_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3142___86"></a>3.1.4.2 低并发测试配置</h5> 
<p>样本为5000个，10的并发<br> <img src="https://images2.imgbox.com/35/75/bMywoKAg_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32_92"></a>3.2更新丢失</h3> 
<h4><a id="321_____94"></a>3.2.1 代码</h4> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
 
 <span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">"github.com/gin-gonic/gin"</span>
  <span class="token string">"gorm.io/driver/mysql"</span>
  <span class="token string">"gorm.io/gorm"</span>
  <span class="token string">"log"</span>
  <span class="token string">"net/http"</span>
 <span class="token punctuation">)</span>
 
 <span class="token keyword">type</span> Order <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
  OrderId      <span class="token builtin">int64</span> <span class="token string">`gorm:"primaryKey"`</span>
  AccumulativeTotal <span class="token builtin">float64</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">func</span> <span class="token punctuation">(</span>Order<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token string">"t_order"</span>
 <span class="token punctuation">}</span>
 
 <span class="token comment">// 更新丢失 代码</span>
 <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//建立mysql连接</span>
  dsn <span class="token operator">:=</span> <span class="token string">"root:mWwdsqw1s2x3x*@tcp(mysql3:3306)/mytest?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span>
  db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"mysql数据库连接失败,"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//创建gin路由</span>
  r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/update"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//开启事务</span>
    tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> order Order
    tx<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">"select order_id, accumulative_total from t_order where order_id = ?"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>order<span class="token punctuation">)</span>
    <span class="token comment">//内存中加一后更新</span>
    tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"update t_order set accumulative_total = ? where order_id = ?"</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span>AccumulativeTotal<span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">//提交</span>
    tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
     <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span> <span class="token comment">// 监听并在 0.0.0.0:8080 上启动服务</span>
 <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="322_____146"></a>3.2.2 高并发测试</h4> 
<p>结果不是5000，错误</p> 
<p><img src="https://images2.imgbox.com/c5/dd/GP1HFTyA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1a/0d/YwawZ0nO_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="323_____154"></a>3.2.3 低并发测试</h4> 
<p>比高并发好点，但结果不是5000，错误</p> 
<p><img src="https://images2.imgbox.com/cb/48/UV7WcpMp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2a/ae/P9knQUou_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33_162"></a>3.3悲观锁</h3> 
<h4><a id="331_____164"></a>3.3.1 代码</h4> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
 
 <span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">"github.com/gin-gonic/gin"</span>
  <span class="token string">"gorm.io/driver/mysql"</span>
  <span class="token string">"gorm.io/gorm"</span>
  <span class="token string">"log"</span>
  <span class="token string">"net/http"</span>
 <span class="token punctuation">)</span>
 
 <span class="token keyword">type</span> Order <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
  OrderId      <span class="token builtin">int64</span> <span class="token string">`gorm:"primaryKey"`</span>
  AccumulativeTotal <span class="token builtin">float64</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">func</span> <span class="token punctuation">(</span>Order<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token string">"t_order"</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//建立mysql连接</span>
  dsn <span class="token operator">:=</span> <span class="token string">"root:mWwdsqw1s2x3x*@tcp(mysql3:3306)/mytest?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span>
  db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"mysql数据库连接失败,"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//创建gin路由</span>
  r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/update"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//开启事务</span>
    tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> order Order
    <span class="token comment">//加悲观锁</span>
    tx<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">"select order_id, accumulative_total from t_order where order_id = ? for update"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>order<span class="token punctuation">)</span>
    <span class="token comment">//内存中加一后更新</span>
    tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"update t_order set accumulative_total = ? where order_id = ?"</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span>AccumulativeTotal<span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">//提交</span>
    tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
     <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span> <span class="token comment">// 监听并在 0.0.0.0:8080 上启动服务</span>
 <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="332_____216"></a>3.3.2 高并发测试</h4> 
<p>结果正确</p> 
<p><img src="https://images2.imgbox.com/5a/ae/aFhRCyBL_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/26/7d/xJap1X9e_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="333_____224"></a>3.3.3 低并发测试</h4> 
<p>结果正确</p> 
<p><img src="https://images2.imgbox.com/d7/60/bzsmExqp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/00/3c/WBjRYond_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="34update_232"></a>3.4更改update语句</h3> 
<h4><a id="341_____234"></a>3.4.1 代码</h4> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
 
 <span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">"github.com/gin-gonic/gin"</span>
  <span class="token string">"gorm.io/driver/mysql"</span>
  <span class="token string">"gorm.io/gorm"</span>
  <span class="token string">"log"</span>
  <span class="token string">"net/http"</span>
 <span class="token punctuation">)</span>
 
 <span class="token keyword">type</span> Order <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
  OrderId      <span class="token builtin">int64</span> <span class="token string">`gorm:"primaryKey"`</span>
  AccumulativeTotal <span class="token builtin">float64</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">func</span> <span class="token punctuation">(</span>Order<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token string">"t_order"</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//建立mysql连接</span>
  dsn <span class="token operator">:=</span> <span class="token string">"root:mWwdsqw1s2x3x*@tcp(mysql3:3306)/mytest?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span>
  db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"mysql数据库连接失败,"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//创建gin路由</span>
  r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/update"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//开启事务</span>
    tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//依赖update的原子性加一</span>
    tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"update t_order set accumulative_total = ? where order_id = ?"</span><span class="token punctuation">,</span> gorm<span class="token punctuation">.</span><span class="token function">Expr</span><span class="token punctuation">(</span><span class="token string">"accumulative_total + ?"</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
     <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span> <span class="token comment">// 监听并在 0.0.0.0:8080 上启动服务</span>
 <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="342_____282"></a>3.4.2 高并发测试</h4> 
<p>结果正确</p> 
<p><img src="https://images2.imgbox.com/6c/8a/p0yvEGLE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/da/4c/Dqz3AHVS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="343_____290"></a>3.4.3 低并发测试</h4> 
<p><img src="https://images2.imgbox.com/26/b4/FnoJuCO5_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0a/e1/c4VutijU_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="35_296"></a>3.5乐观锁</h3> 
<p>数据库的全局隔离级别是REPEATABLE-READ，当前会话的隔离级别是READ-COMMITTED。乐观锁需要会话处于读已提交级别下。InnoDB在读已提交下需要binlog格式为ROW。</p> 
<p>执行以下命令设置binlog格式。</p> 
<p><img src="https://images2.imgbox.com/a4/10/yH4VuCyL_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="351_____306"></a>3.5.1 代码</h4> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
 
 <span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">"database/sql"</span>
  <span class="token string">"github.com/gin-gonic/gin"</span>
  <span class="token string">"gorm.io/driver/mysql"</span>
  <span class="token string">"gorm.io/gorm"</span>
  <span class="token string">"log"</span>
  <span class="token string">"net/http"</span>
 <span class="token punctuation">)</span>
 
 <span class="token keyword">type</span> Order <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
  OrderId      <span class="token builtin">int64</span> <span class="token string">`gorm:"primaryKey"`</span>
  AccumulativeTotal <span class="token builtin">float64</span>
  Version      <span class="token builtin">int64</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">func</span> <span class="token punctuation">(</span>Order<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token string">"t_order"</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//建立mysql连接</span>
  dsn <span class="token operator">:=</span> <span class="token string">"root:mWwdsqw1s2x3x*@tcp(mysql3:3306)/mytest?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span>
  db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"mysql数据库连接失败,"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//创建gin路由</span>
  r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/update"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//设置读已提交隔离级别</span>
    <span class="token keyword">var</span> opt sql<span class="token punctuation">.</span>TxOptions
    opt<span class="token punctuation">.</span>Isolation <span class="token operator">=</span> sql<span class="token punctuation">.</span>LevelReadCommitted
    opt<span class="token punctuation">.</span>ReadOnly <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">//开启事务</span>
    tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opt<span class="token punctuation">)</span>
    <span class="token keyword">var</span> orderBefore Order
    <span class="token comment">//读取版本号</span>
    tx<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">"select order_id, accumulative_total, version from t_order where order_id = ?"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orderBefore<span class="token punctuation">)</span>
    <span class="token comment">//尝试更新</span>
    affected <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"update t_order set accumulative_total = ?, version = ? where order_id = ? and version = ?"</span><span class="token punctuation">,</span>
     orderBefore<span class="token punctuation">.</span>AccumulativeTotal<span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">,</span> orderBefore<span class="token punctuation">.</span>Version<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>
     <span class="token number">1</span><span class="token punctuation">,</span> orderBefore<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token punctuation">.</span>RowsAffected
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"更新结果: "</span><span class="token punctuation">,</span> affected<span class="token punctuation">)</span>
    <span class="token keyword">for</span> affected <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//更新失败，数据被其他事务更改了</span>
     <span class="token comment">//重新读取版本号</span>
     tx<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">"select order_id, accumulative_total, version from t_order where order_id = ?"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orderBefore<span class="token punctuation">)</span>
     <span class="token comment">//重新尝试更新</span>
     affected <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"update t_order set accumulative_total = ?, version = ? where order_id = ? and version = ?"</span><span class="token punctuation">,</span>
       orderBefore<span class="token punctuation">.</span>AccumulativeTotal<span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">,</span> orderBefore<span class="token punctuation">.</span>Version<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>
       <span class="token number">1</span><span class="token punctuation">,</span> orderBefore<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token punctuation">.</span>RowsAffected
     log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"更新结果: "</span><span class="token punctuation">,</span> affected<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//更新成功了，提交</span>
    tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
     <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span> <span class="token comment">// 监听并在 0.0.0.0:8080 上启动服务</span>
 <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="352_____376"></a>3.5.2 高并发测试</h4> 
<p><img src="https://images2.imgbox.com/51/87/x8QabCyK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fd/1b/648KadaE_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="353_____382"></a>3.5.3 低并发测试</h4> 
<p><img src="https://images2.imgbox.com/25/ab/kRU5ydA5_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/27/29/V665s2uK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="36_389"></a>3.6分布式锁</h3> 
<h4><a id="361_____391"></a>3.6.1 代码</h4> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main
 
 <span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">"context"</span>
  <span class="token string">"github.com/gin-gonic/gin"</span>
  <span class="token string">"github.com/go-redis/redis/v9"</span>
  <span class="token string">"github.com/google/uuid"</span>
  <span class="token string">"gorm.io/driver/mysql"</span>
  <span class="token string">"gorm.io/gorm"</span>
  <span class="token string">"log"</span>
  <span class="token string">"net/http"</span>
 <span class="token punctuation">)</span>
 
 <span class="token keyword">type</span> Order <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
  OrderId      <span class="token builtin">int64</span> <span class="token string">`gorm:"primaryKey"`</span>
  AccumulativeTotal <span class="token builtin">float64</span>
  Version      <span class="token builtin">int64</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">func</span> <span class="token punctuation">(</span>Order<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token string">"t_order"</span>
 <span class="token punctuation">}</span>
 
 <span class="token comment">// 加锁lua代码</span>
 <span class="token keyword">const</span> LOCK_LUA <span class="token operator">=</span> <span class="token string">"if redis.call(\"setnx\", KEYS[1], KEYS[2]) == 1 then\n  return redis.call(\"pexpire\", KEYS[1], KEYS[3])\nelse\n  return 0\nend"</span>
 
 <span class="token comment">// 解锁lua代码</span>
 <span class="token keyword">const</span> UNLOCK_LUA <span class="token operator">=</span> <span class="token string">"if redis.call(\"get\",KEYS[1]) == KEYS[2] then\n  return redis.call(\"del\",KEYS[1])\nelse\n  return -1\nend"</span>
 <span class="token keyword">const</span> LOCK_KEY <span class="token operator">=</span> <span class="token string">"lock_key"</span>
 
 <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//建立redis连接</span>
  rdb <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{<!-- --></span>
    Addr<span class="token punctuation">:</span>   <span class="token string">"mysql4:6379"</span><span class="token punctuation">,</span>
    Password<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">// no password set</span>
    DB<span class="token punctuation">:</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// use default DB</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//建立mysql连接</span>
  dsn <span class="token operator">:=</span> <span class="token string">"root:mWwdsqw1s2x3x*@tcp(mysql3:3306)/mytest?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span>
  db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"mysql数据库连接失败,"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//创建gin路由</span>
  r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/update"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 加锁</span>
    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    value <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    lockResult<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> LOCK_LUA<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span>LOCK_KEY<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"5000"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> lockResult <span class="token operator">!=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 加锁失败</span>
     <span class="token comment">// 重新尝试加锁</span>
     lockResult<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> rdb<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> LOCK_LUA<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span>LOCK_KEY<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">"5000"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//加锁成功</span>
    <span class="token comment">//开启事务</span>
    tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> orderBefore Order
    <span class="token comment">//读取数据</span>
    tx<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">"select order_id, accumulative_total, version from t_order where order_id = ?"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orderBefore<span class="token punctuation">)</span>
    <span class="token comment">//内存中加一后更新</span>
    tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"update t_order set accumulative_total = ? where order_id = ?"</span><span class="token punctuation">,</span>
     orderBefore<span class="token punctuation">.</span>AccumulativeTotal<span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">//解锁</span>
    unlockResult<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> UNLOCK_LUA<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span>LOCK_KEY<span class="token punctuation">,</span> value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> unlockResult <span class="token operator">!=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//解锁失败，可能是方法太耗时，key过期了</span>
     <span class="token comment">//回滚</span>
     tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusServiceUnavailable<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
       <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"no"</span><span class="token punctuation">,</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//解锁成功</span>
      <span class="token comment">//提交</span>
     tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
       <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span> <span class="token comment">// 监听并在 0.0.0.0:8080 上启动服务</span>
 <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="362_____480"></a>3.6.2 高并发测试</h4> 
<p>、<img src="https://images2.imgbox.com/51/77/3wrgFDuN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/02/2e/IBbAlDym_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="363_____486"></a>3.6.3 低并发测试</h4> 
<p><img src="https://images2.imgbox.com/0b/83/VObsWbB8_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a7/82/7jGgyV9e_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4____492"></a>4 对比分析</h2> 
<p>表格 1高并发</p> 
<table><thead><tr><th></th><th><strong>平均响应时间</strong></th><th><strong>最低响应时间</strong></th><th><strong>最高响应时间</strong></th></tr></thead><tbody><tr><td><strong>update语句</strong></td><td>387</td><td>16</td><td>741</td></tr><tr><td><strong>悲观锁</strong></td><td>532</td><td>14</td><td>786</td></tr><tr><td><strong>乐观锁</strong></td><td>770</td><td>31</td><td>999</td></tr><tr><td><strong>分布式锁</strong></td><td>1681</td><td>9</td><td>15013</td></tr></tbody></table> 
<p>由上图可知，在高并发下，update语句的平均响应时间最少，乐观锁要多于悲观锁。分布式锁因为额外与redis交互时间较多。</p> 
<p>表格 2低并发</p> 
<table><thead><tr><th></th><th><strong>平均响应时间</strong></th><th><strong>最低响应时间</strong></th><th><strong>最高响应时间</strong></th></tr></thead><tbody><tr><td><strong>update语句</strong></td><td>30</td><td>4</td><td>77</td></tr><tr><td><strong>悲观锁</strong></td><td>45</td><td>5</td><td>149</td></tr><tr><td><strong>分布式锁</strong></td><td>60</td><td>6</td><td>375</td></tr><tr><td><strong>乐观锁</strong></td><td>69</td><td>6</td><td>134</td></tr></tbody></table> 
<p>由上图可知，在低并发下，还是update效率最高。最高响应时间最长的是分布式锁。这里乐观锁的平均响应时间比悲观锁要多。乐观锁、悲观锁没有优劣之分，适用场景不同。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5e281bcdc37012ac8c6ea78f952cfe1e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">COMMON LAYER INTERFACE (CLI)切片格式读取</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1dd42bfdf5dca2123997a993d3f2baa8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深度干货 | 32道JVM基础面试题 （1.2W字详细解析）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>