<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringMVC和Jackson解决Long 精度丢失（多方案） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringMVC和Jackson解决Long 精度丢失（多方案）" />
<meta property="og:description" content="概述 问题描述
Java输出至前端的整数长度超过16位时，前端js在解析整数时，超过16位的整数时，后面的数字会损失精度。
问题原因
JS内置的number类型是基于32位整数，Number类型的最大安全整数为9007199254740991，当Java Long型的值大小超过JS Number的最大安全整数时，超出此范围的整数值可能会被破坏，丢失精度。
解决办法
在后台将整数转换成字符串，围绕这个目标，共探索出5种解决方案，能满足大部分的个性化需求。
解决方案 过滤器统一拦截自定义Serializer序列化类POJO属性增加注解修改Serializers源码代码转化 项目环境：
Spring 3.X and Jackson 2.X
1）过滤器统一拦截 配置Spring消息转换器的ObjectMapper类，引用创建的自定义类型转换器类。
创建CustomObjectMapperForJackson类 package com.xiaodajia.framework.util.web.databind; import java.math.BigDecimal; import java.math.BigInteger; import java.text.SimpleDateFormat; import com.fasterxml.jackson.databind.ObjectMapper; import com.fasterxml.jackson.databind.module.SimpleModule; import com.fasterxml.jackson.databind.ser.std.ToStringSerializer; public class CustomObjectMapperForJackson extends ObjectMapper { public CustomObjectMapperForJackson() { super(); // 设置日期转换yyyy-MM-dd HH:mm:ss setDateFormat(new SimpleDateFormat(&#34;yyyy-MM-dd HH:mm:ss&#34;)); SimpleModule simpleModule = new SimpleModule(); simpleModule.addSerializer(BigDecimal.class, ToStringSerializer.instance); simpleModule.addSerializer(BigInteger.class, ToStringSerializer.instance); simpleModule.addSerializer(Long.class, ToStringSerializer.instance); simpleModule.addSerializer(Long.TYPE, ToStringSerializer.instance); registerModule(simpleModule); } } spring-mvc.xml配置objectMapper &lt;mvc:annotation-driven validator=&#34;validator&#34; conversion-service=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c36ad3f0a0ea6cbe65170dd66cc2c11a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-11-14T23:01:13+08:00" />
<meta property="article:modified_time" content="2019-11-14T23:01:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringMVC和Jackson解决Long 精度丢失（多方案）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>概述</h3> 
<p><strong>问题描述</strong><br> Java输出至前端的整数长度超过16位时，前端js在解析整数时，超过16位的整数时，后面的数字会损失精度。</p> 
<p><strong>问题原因</strong><br> JS内置的number类型是基于32位整数，Number类型的最大安全整数为<strong>9007199254740991</strong>，当Java Long型的值大小超过JS Number的最大安全整数时，超出此范围的整数值可能会被破坏，丢失精度。</p> 
<p><strong>解决办法</strong><br> <mark>在后台将整数转换成字符串</mark>，围绕这个目标，共探索出5种解决方案，能满足大部分的个性化需求。</p> 
<h3><a id="_11"></a>解决方案</h3> 
<ol><li>过滤器统一拦截</li><li>自定义Serializer序列化类</li><li>POJO属性增加注解</li><li>修改Serializers源码</li><li>代码转化</li></ol> 
<p><strong>项目环境：</strong></p> 
<blockquote> 
 <p>Spring 3.X and Jackson 2.X</p> 
</blockquote> 
<h5><a id="1_23"></a>1）过滤器统一拦截</h5> 
<p>配置Spring消息转换器的ObjectMapper类，引用创建的自定义类型转换器类。</p> 
<ul><li>创建CustomObjectMapperForJackson类</li></ul> 
<pre><code class="prism language-c">package com<span class="token punctuation">.</span>xiaodajia<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>util<span class="token punctuation">.</span>web<span class="token punctuation">.</span>databind<span class="token punctuation">;</span>

import java<span class="token punctuation">.</span>math<span class="token punctuation">.</span>BigDecimal<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>math<span class="token punctuation">.</span>BigInteger<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>SimpleDateFormat<span class="token punctuation">;</span>

import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>ObjectMapper<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>module<span class="token punctuation">.</span>SimpleModule<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>ser<span class="token punctuation">.</span>std<span class="token punctuation">.</span>ToStringSerializer<span class="token punctuation">;</span>

public class CustomObjectMapperForJackson extends ObjectMapper <span class="token punctuation">{<!-- --></span>

	public <span class="token function">CustomObjectMapperForJackson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 设置日期转换yyyy-MM-dd HH:mm:ss</span>
		<span class="token function">setDateFormat</span><span class="token punctuation">(</span>new <span class="token function">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SimpleModule simpleModule <span class="token operator">=</span> new <span class="token function">SimpleModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		simpleModule<span class="token punctuation">.</span><span class="token function">addSerializer</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">.</span>class<span class="token punctuation">,</span>
				ToStringSerializer<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
		simpleModule<span class="token punctuation">.</span><span class="token function">addSerializer</span><span class="token punctuation">(</span>BigInteger<span class="token punctuation">.</span>class<span class="token punctuation">,</span>
				ToStringSerializer<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
		simpleModule<span class="token punctuation">.</span><span class="token function">addSerializer</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span>class<span class="token punctuation">,</span>
				ToStringSerializer<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
		simpleModule<span class="token punctuation">.</span><span class="token function">addSerializer</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span>
				ToStringSerializer<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">registerModule</span><span class="token punctuation">(</span>simpleModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>spring-mvc.xml配置objectMapper</li></ul> 
<pre><code class="prism language-c"><span class="token operator">&lt;</span>mvc<span class="token punctuation">:</span>annotation<span class="token operator">-</span>driven validator<span class="token operator">=</span><span class="token string">"validator"</span> conversion<span class="token operator">-</span>service<span class="token operator">=</span><span class="token string">"conversion-service"</span><span class="token operator">&gt;</span>
    	<span class="token operator">&lt;</span>mvc<span class="token punctuation">:</span>message<span class="token operator">-</span>converters <span class="token keyword">register</span><span class="token operator">-</span>defaults<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 将StringHttpMessageConverter的默认编码设为UTF<span class="token operator">-</span><span class="token number">8</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>bean class<span class="token operator">=</span><span class="token string">"org.springframework.http.converter.StringHttpMessageConverter"</span><span class="token operator">&gt;</span>
		    	<span class="token operator">&lt;</span>constructor<span class="token operator">-</span>arg value<span class="token operator">=</span><span class="token string">"UTF-8"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 将Jackson2HttpMessageConverter的默认格式化输出设为true <span class="token operator">--</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>bean class<span class="token operator">=</span><span class="token string">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"prettyPrint"</span> value<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"objectMapper"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>bean class<span class="token operator">=</span><span class="token string">"com.xiaodajia.framework.util.web.databind.CustomObjectMapperForJackson"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>			
  		<span class="token operator">&lt;</span><span class="token operator">/</span>mvc<span class="token punctuation">:</span>message<span class="token operator">-</span>converters<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>mvc<span class="token punctuation">:</span>annotation<span class="token operator">-</span>driven<span class="token operator">&gt;</span>
</code></pre> 
<p><strong>关键代码</strong><br> 当项目中使用Mybatis持久层框架，如果结果类型设置为<code>resultType="map"</code>，将集合数据输出至前端时，Jackson会默认将数组、对象中的数值以<code>BigDecimal</code>类型序列化，如果我们只配置了Long的序列化类，对map中数据是不会生效，还需要在自定义ObjectMapper中配置<mark>BigDecimal、BigInteger类的序列化</mark></p> 
<pre><code>simpleModule.addSerializer(BigDecimal.class,ToStringSerializerForJackson.instance);
simpleModule.addSerializer(BigInteger.class,ToStringSerializerForJackson.instance);
</code></pre> 
<h5><a id="2Serializer_88"></a>2）自定义Serializer序列化类</h5> 
<p>在“过滤器统一拦截”方案中，会将所有数值全部转化为String，如果我们只需要将数值长度超过16位的整数才转化为String，那该如何处理呢？</p> 
<p>面对这类需求，我们可以参考ToStringSerializer类，自定义序列化类ToStringSerializerForJackson，<mark>重写serialize方法中BigDecimal、BigInteger、Long类型数值</mark>，将长度超过16位数值转化为String。</p> 
<pre><code class="prism language-c">package com<span class="token punctuation">.</span>xiaodajia<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>util<span class="token punctuation">.</span>web<span class="token punctuation">.</span>databind<span class="token punctuation">;</span>

import java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>math<span class="token punctuation">.</span>BigDecimal<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>math<span class="token punctuation">.</span>BigInteger<span class="token punctuation">;</span>

import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>JavaType<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>JsonMappingException<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>JsonNode<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>SerializationFeature<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>SerializerProvider<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>JacksonStdImpl<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>jsonFormatVisitors<span class="token punctuation">.</span>JsonFormatVisitorWrapper<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>jsontype<span class="token punctuation">.</span>TypeSerializer<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>ser<span class="token punctuation">.</span>std<span class="token punctuation">.</span>StdSerializer<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>util<span class="token punctuation">.</span>TokenBuffer<span class="token punctuation">;</span>

<span class="token comment">/**
 * Simple general purpose serializer, useful for any type for which
 * {@link Object#toString} returns the desired JSON value.
 */</span>
@JacksonStdImpl
public class ToStringSerializerForJackson extends StdSerializer<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 * Singleton instance to use.
	 */</span>
	public final <span class="token keyword">static</span> ToStringSerializerForJackson instance <span class="token operator">=</span> new <span class="token function">ToStringSerializerForJackson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * &lt;p&gt;
	 * Note: usually you should NOT create new instances, but instead use
	 * {@link #instance} which is stateless and fully thread-safe. However,
	 * there are cases where constructor is needed; for example, when using
	 * explicit serializer annotations like
	 * {@link com.fasterxml.jackson.databind.annotation.JsonSerialize#using}.
	 */</span>
	public <span class="token function">ToStringSerializerForJackson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">super</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	@Override
	public boolean <span class="token function">isEmpty</span><span class="token punctuation">(</span>Object value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> true<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		String str <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// would use String.isEmpty(), but that's JDK 1.6</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	@Override
	public <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Object value<span class="token punctuation">,</span> JsonGenerator jgen<span class="token punctuation">,</span>
			SerializerProvider provider<span class="token punctuation">)</span> throws IOException<span class="token punctuation">,</span>
			JsonGenerationException <span class="token punctuation">{<!-- --></span>
<span class="token comment">//		System.out.println("ToStringSerializerForJackson序列化------" + value);</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>value instanceof BigDecimal<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>provider
						<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span>SerializationFeature<span class="token punctuation">.</span>WRITE_BIGDECIMAL_AS_PLAIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// [Issue#232]: Ok, rather clumsy, but let's try to work</span>
					<span class="token comment">// around the problem with:</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>jgen instanceof TokenBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPlainString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">return</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>new <span class="token function">BigDecimal</span><span class="token punctuation">(</span>
						<span class="token number">1000000000000000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//					System.out.println("ToStringSerializerForJackson BigDecimal序列化------"+ value);</span>
					jgen<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//					System.out.println("ToStringSerializerForJackson BigDecimal  To String序列化------"+ value);</span>
					jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value instanceof BigInteger<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BigInteger<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>new <span class="token function">BigInteger</span><span class="token punctuation">(</span>
						<span class="token string">"1000000000000000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//					System.out.println("ToStringSerializerForJackson BigInteger序列化------"+ value);</span>
					jgen<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//					System.out.println("ToStringSerializerForJackson BigInteger  To String序列化------"+ value);</span>
					jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BigInteger<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value instanceof Long<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Long<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">1000000000000000L</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//					System.out.println("ToStringSerializerForJackson Long序列化------"</span>
<span class="token comment">//							+ value);</span>
					jgen<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//					System.out.println("ToStringSerializerForJackson Long To String序列化------"+ value);</span>
					jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Long<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//				System.out.println("StringSerializer else序列化------" + value);</span>
				jgen<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			jgen<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * 01-Mar-2011, tatu: We were serializing as "raw" String; but generally
	 * that is not what we want, since lack of type information would imply real
	 * String type.
	 */</span>
	<span class="token comment">/**
	 * Default implementation will write type prefix, call regular serialization
	 * method (since assumption is that value itself does not need JSON Array or
	 * Object start/end markers), and then write type suffix. This should work
	 * for most cases; some sub-classes may want to change this behavior.
	 */</span>
	@Override
	public <span class="token keyword">void</span> <span class="token function">serializeWithType</span><span class="token punctuation">(</span>Object value<span class="token punctuation">,</span> JsonGenerator jgen<span class="token punctuation">,</span>
			SerializerProvider provider<span class="token punctuation">,</span> TypeSerializer typeSer<span class="token punctuation">)</span>
			throws IOException<span class="token punctuation">,</span> JsonGenerationException <span class="token punctuation">{<!-- --></span>
		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ToStringSerializerForJackson -serializeWithType序列化------"</span>
				<span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
		typeSer<span class="token punctuation">.</span><span class="token function">writeTypePrefixForScalar</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> jgen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">serialize</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> jgen<span class="token punctuation">,</span> provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
		typeSer<span class="token punctuation">.</span><span class="token function">writeTypeSuffixForScalar</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> jgen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	@Override
	public JsonNode <span class="token function">getSchema</span><span class="token punctuation">(</span>SerializerProvider provider<span class="token punctuation">,</span> Type typeHint<span class="token punctuation">)</span>
			throws JsonMappingException <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">createSchemaNode</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	@Override
	public <span class="token keyword">void</span> <span class="token function">acceptJsonFormatVisitor</span><span class="token punctuation">(</span>JsonFormatVisitorWrapper visitor<span class="token punctuation">,</span>
			JavaType typeHint<span class="token punctuation">)</span> throws JsonMappingException <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>visitor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			visitor<span class="token punctuation">.</span><span class="token function">expectStringFormat</span><span class="token punctuation">(</span>typeHint<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3POJO_236"></a>3）POJO属性增加注解</h5> 
<p>在POJO类需要转换的属性上增加@JsonSerialize注解，如果需要转换的字段多，则需要逐一增加注解，管理很麻烦</p> 
<pre><code class="prism language-c">public class YNotice implements Serializable <span class="token punctuation">{<!-- --></span>
	private <span class="token keyword">static</span> final <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

	@<span class="token function">JsonSerialize</span><span class="token punctuation">(</span>using<span class="token operator">=</span>ToStringSerializer<span class="token punctuation">.</span>class<span class="token punctuation">)</span>
	private <span class="token keyword">long</span> noticeId<span class="token punctuation">;</span>

	private String content<span class="token punctuation">;</span>

	private Date createTime<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="4Serializers_250"></a>4）修改Serializers源码</h5> 
<p>修改Jackson源码，在NumberSerializers类的子类NumberSerializer中，将Long转换为String</p> 
<pre><code class="prism language-c">@JacksonStdImpl
    public final <span class="token keyword">static</span> class NumberSerializer
        extends StdScalarSerializer<span class="token operator">&lt;</span>Number<span class="token operator">&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        public final <span class="token keyword">static</span> NumberSerializer instance <span class="token operator">=</span> new <span class="token function">NumberSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        public <span class="token function">NumberSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">super</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
        @Override
        public <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Number value<span class="token punctuation">,</span> JsonGenerator jgen<span class="token punctuation">,</span> SerializerProvider provider<span class="token punctuation">)</span>
            throws IOException<span class="token punctuation">,</span> JsonGenerationException
        <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">/**
        	 * 强制转化类，判断数字长度超过16位时，将数字转化为字符串
        	 */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value instanceof BigDecimal<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span>SerializationFeature<span class="token punctuation">.</span>WRITE_BIGDECIMAL_AS_PLAIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// [Issue#232]: Ok, rather clumsy, but let's try to work around the problem with:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>jgen instanceof TokenBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPlainString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>new <span class="token function">BigDecimal</span><span class="token punctuation">(</span><span class="token number">10000000000000000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                	System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"NumberSerializer BigDecimal 转化为String------"</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                	jgen<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>value<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                	System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"NumberSerializer BigDecimal ------"</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                	jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value instanceof BigInteger<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BigInteger<span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value instanceof Integer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value instanceof Long<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">10000000000000000L</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"NumberSerializer Long 转化为String------"</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            		jgen<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>value<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            		System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"NumberSerializer Long ------"</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            		jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            	<span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value instanceof Double<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value instanceof Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">floatValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>value instanceof Byte<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>value instanceof Short<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// doesn't need to be cast to smaller numbers</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                jgen<span class="token punctuation">.</span><span class="token function">writeNumber</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    
        @Override
        public JsonNode <span class="token function">getSchema</span><span class="token punctuation">(</span>SerializerProvider provider<span class="token punctuation">,</span> Type typeHint<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">createSchemaNode</span><span class="token punctuation">(</span><span class="token string">"number"</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        @Override
        public <span class="token keyword">void</span> <span class="token function">acceptJsonFormatVisitor</span><span class="token punctuation">(</span>JsonFormatVisitorWrapper visitor<span class="token punctuation">,</span> JavaType typeHint<span class="token punctuation">)</span>
            throws JsonMappingException
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Hmmh. What should it be? Ideally should probably indicate BIG_DECIMAL</span>
            <span class="token comment">// to ensure no information is lost? But probably won't work that well...</span>
            JsonNumberFormatVisitor v2 <span class="token operator">=</span> visitor<span class="token punctuation">.</span><span class="token function">expectNumberFormat</span><span class="token punctuation">(</span>typeHint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v2 <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                v2<span class="token punctuation">.</span><span class="token function">numberType</span><span class="token punctuation">(</span>JsonParser<span class="token punctuation">.</span>NumberType<span class="token punctuation">.</span>BIG_DECIMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>关键代码是<mark><mark>NumberSerializer</mark></mark>类的<mark><mark>serialize</mark></mark>方法，在方法中判断数值是否BigDecimal、Long类型，如果数字长度超过16位时，则将数字转化为字符串。</p> 
<h5><a id="_329"></a>代码转化</h5> 
<p>直接在java代码中，将Map对象和集合的Long数值强转化为String类型</p> 
<h3><a id="_332"></a>参考资料</h3> 
<ol><li>https://my.oschina.net/u/1787735/blog/1833697</li><li>https://stackoverflow.com/questions/7854030/configuring-objectmapper-in-spring</li><li>https://www.jianshu.com/p/92ce8c52d468</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e4d1ec6cb6c038d51d73492d351f90bb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">接口和注解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3c47ced04cedcf15cbb24a04ea43320f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2019秋招面试总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>