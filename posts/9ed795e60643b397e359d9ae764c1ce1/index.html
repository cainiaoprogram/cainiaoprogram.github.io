<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>1Panel上的免费WAF长亭雷池搭配openresty的用法 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="1Panel上的免费WAF长亭雷池搭配openresty的用法" />
<meta property="og:description" content="原文链接： 1Panel上的长亭雷池WAF搭配openresty的用法
前言 最近把面板换成了国内公司出的但是开源的1panel，跑容器也是挺符合心里需求的，
主界面也挺干净整洁。看到第三方应用库有个免费WAF，然后又上了开源了但没完全开源的长亭雷池WAF。
记录一下在同一台机子上长亭雷池WAF搭配默认openresty的用法。
1. 调整openresty容器网络 需要将openresty修改为桥接网络模式。且修改https外部映射为其他端口如1443。
注意：改桥接端口之后，反向代理的思路就和使用Nginx Proxy Manager一样了，
不能写127.0.0.1:端口来反向代理了。 点击应用参数修改docker-compose.yml，重建openresty。
version: &#39;3&#39; services: openresty: image: openresty/openresty:latest #这里镜像注意对应自己的架构平台 container_name: ${CONTAINER_NAME} restart: always networks: - 1panel-network ports: - &#34;${PANEL_APP_PORT_HTTP}:80&#34; - &#34;1443:1443&#34; volumes: - ./conf/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf - ./conf/fastcgi_params:/usr/local/openresty/nginx/conf/fastcgi_params - ./conf/fastcgi-php.conf:/usr/local/openresty/nginx/conf/fastcgi-php.conf - ./log:/var/log/nginx - ./conf/conf.d:/usr/local/openresty/nginx/conf/conf.d/ - ./www:/www - ./root:/usr/share/nginx/html - /etc/localtime:/etc/localtime labels: createdBy: &#34;Apps&#34; networks: 1panel-network: external: true 2. 修改站点监听端口 站点正常配置，开启https啥的。
进入站点文件配置，修改https监听端口为1443，与外部端口一致。
可以按Ctrl F批量替换。其他配置可以不用动。
3. 雷池WAF添加站点 3.1 添加第三方库 然后应用商店安装雷池WAF
1Panel 应用商店的非官方应用适配库 以默认1Panel安装在/opt/路径下为例子，如果不是按需修改以下。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9ed795e60643b397e359d9ae764c1ce1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-18T16:09:21+08:00" />
<meta property="article:modified_time" content="2023-08-18T16:09:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">1Panel上的免费WAF长亭雷池搭配openresty的用法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>原文链接： <a href="https://www.boilog.com/archives/339" rel="nofollow">1Panel上的长亭雷池WAF搭配openresty的用法</a></p> 
<h2><a id="_1"></a>前言</h2> 
<p>最近把面板换成了国内公司出的但是开源的<code>1panel</code>，跑容器也是挺符合心里需求的，</p> 
<p>主界面也挺干净整洁。看到第三方应用库有个免费<code>WAF</code>，然后又上了开源了但没完全开源的<code>长亭雷池WAF</code>。</p> 
<p>记录一下在同一台机子上<code>长亭雷池WAF</code>搭配默认<code>openresty</code>的用法。</p> 
<h3><a id="1_openresty_8"></a>1. 调整openresty容器网络</h3> 
<p>需要将<code>openresty</code>修改为桥接网络模式。且修改<code>https</code>外部映射为其他端口如<code>1443</code>。</p> 
<p>注意：改桥接端口之后，反向代理的思路就和使用<code>Nginx Proxy Manager</code>一样了，</p> 
<ul><li>不能写<code>127.0.0.1:端口</code>来反向代理了。</li></ul> 
<p>点击应用参数修改<code>docker-compose.yml</code>，重建<code>openresty</code>。</p> 
<pre><code>version: '3'
services:
  openresty:
    image: openresty/openresty:latest #这里镜像注意对应自己的架构平台
    container_name: ${CONTAINER_NAME}
    restart: always
    networks:
      - 1panel-network
    ports:
      - "${PANEL_APP_PORT_HTTP}:80"
      - "1443:1443"
    volumes:
      - ./conf/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf
      - ./conf/fastcgi_params:/usr/local/openresty/nginx/conf/fastcgi_params
      - ./conf/fastcgi-php.conf:/usr/local/openresty/nginx/conf/fastcgi-php.conf
      - ./log:/var/log/nginx
      - ./conf/conf.d:/usr/local/openresty/nginx/conf/conf.d/
      - ./www:/www
      - ./root:/usr/share/nginx/html
      - /etc/localtime:/etc/localtime
    labels:  
      createdBy: "Apps"
 
networks:  
  1panel-network:  
    external: true
</code></pre> 
<p><img src="https://images2.imgbox.com/ef/c5/ZF0FdWRr_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2__47"></a>2. 修改站点监听端口</h2> 
<p>站点正常配置，开启<code>https</code>啥的。</p> 
<p>进入站点文件配置，修改<code>https</code>监听端口为<code>1443</code>，与外部端口一致。</p> 
<p>可以按<code>Ctrl F</code>批量替换。其他配置可以不用动。<br> <img src="https://images2.imgbox.com/47/a8/odSQuvoB_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_WAF_55"></a>3. 雷池WAF添加站点</h2> 
<h3><a id="31__56"></a>3.1 添加第三方库</h3> 
<p>然后应用商店安装<code>雷池WAF</code></p> 
<ul><li><a href="https://github.com/okxlin/appstore"><strong>1Panel 应用商店的非官方应用适配库</strong></a></li></ul> 
<p>以默认<code>1Panel</code>安装在<code>/opt/</code>路径下为例子，如果不是按需修改以下。</p> 
<h4><a id="311__62"></a>3.1.1 国内网络</h4> 
<p><code>1panel</code>计划任务类型<code>Shell 脚本</code>的计划任务框里，添加并执行以下命令，或者终端运行以下命令，</p> 
<pre><code>git clone -b localApps https://ghproxy.com/https://github.com/okxlin/appstore /opt/1panel/resource/apps/local/appstore-localApps
 
cp -rf /opt/1panel/resource/apps/local/appstore-localApps/apps/* /opt/1panel/resource/apps/local/
 
rm -r /opt/1panel/resource/apps/local/appstore-localApps
</code></pre> 
<p>然后应用商店刷新本地应用即可。</p> 
<h4><a id="312__74"></a>3.1.2 国际互联网络</h4> 
<p><code>1panel</code>计划任务类型<code>Shell 脚本</code>的计划任务框里，添加并执行以下命令，或者终端运行以下命令，</p> 
<pre><code>git clone -b localApps https://github.com/okxlin/appstore /opt/1panel/resource/apps/local/appstore-localApps
 
cp -rf /opt/1panel/resource/apps/local/appstore-localApps/apps/* /opt/1panel/resource/apps/local/
 
rm -r /opt/1panel/resource/apps/local/appstore-localApps
</code></pre> 
<p>然后应用商店刷新本地应用即可。</p> 
<h3><a id="32_WAF_85"></a>3.2 雷池WAF添加站点</h3> 
<ul><li>一种是直接添加普通容器端口做上游，<code>雷池WAF</code>监听<code>443</code>端口，上传证书即可。</li><li>另一种就是搭配<code>openresty</code>。</li></ul> 
<p>具体方式是如下：</p> 
<ul><li>添加上游服务为<code>https://127.0.0.1:1443</code></li><li>域名填写与<code>openresty</code>站点一致</li><li><code>雷池WAF</code>监听<code>443</code>端口</li><li>正常上传证书</li></ul> 
<p>这样子就正常添加了，正常网站配置还是由<code>openresty</code> 提供，<code>雷池WAF</code>做个下游。<br> <img src="https://images2.imgbox.com/ca/a3/nEHJBy5Y_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4_SSL_98"></a>4. 关于SSL证书持续</h2> 
<p><code>雷池WAF</code>社区版本这边还没证书夹，每添加一个站点就需要上传证书。</p> 
<p>然后命名也是随机产生。想要使访问站点的<code>SSL</code>证书正常，还是得不断将签发的证书将旧证书文件替换掉。</p> 
<p>这里用<code>acme.sh</code>签发的来替换。</p> 
<p>具体的对应站点<code>SSL</code>证书对应可以查看配置获取。<br> 具体文件路径在类似如下文件夹里</p> 
<pre><code>/opt/1panel/apps/local/safeline/safeline/data/resources/nginx/sites-enabled
</code></pre> 
<p><img src="https://images2.imgbox.com/ce/42/bCUof50Z_o.png" alt="在这里插入图片描述"></p> 
<p>打开查看配置文件获取具体对应证书的名字。</p> 
<pre><code># 配置文件示例
server {
    listen 0.0.0.0:443 ssl;
    server_name www.example.com;
    ssl_certificate /etc/nginx/certs/agicaikcgbac__.example.com-fullchain.cer;
    ssl_certificate_key /etc/nginx/certs/shcvogagbaovga__.example.com.key;
    location = /forbidden_page {
        internal;
        root /etc/nginx/forbidden_pages;
        try_files /default_forbidden_page.html =403;
    }
 
</code></pre> 
<p>如上所示则可以获得证书文件文件名如下：<br> – agicaikcgbac__.example.com-fullchain.cer<br> – shcvogagbaovga__.example.com.key</p> 
<p>则替换<code>雷池WAF</code>证书的命令可以写为</p> 
<pre><code># safeline-www.example.com
cp /root/.acme.sh/*.example.com_ecc/fullchain.cer /opt/1panel/apps/local/safeline/safeline/data/resources/nginx/certs/agicaikcgbac__.example.com-fullchain.cer
cp /root/.acme.sh/*.example.com_ecc/*.example.com.key /opt/1panel/apps/local/safeline/safeline/data/resources/nginx/certs/shcvogagbaovga__.example.com.key
</code></pre> 
<p>也可以顺手替换一下<code>openresty</code>创建的站点的证书</p> 
<pre><code># openresty-www.example.com
cp /root/.acme.sh/*.example.com_ecc/fullchain.cer /opt/1panel/apps/openresty/openresty/www/sites/www.example.com/ssl/fullchain.pem
cp /root/.acme.sh/*.example.com_ecc/*.example.com.key /opt/1panel/apps/openresty/openresty/www/sites/www.example.com/ssl/privkey.pem
</code></pre> 
<p>然后将这两个替换证书的命令添加到计划任务列表就行了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cd515f6122c0cd77e959230658976dca/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">网络安全这玩意儿真不建议一般人学...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3db78e818e0bf9fe6c402aa957d4e2ee/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">奇迹MU服务端IGC架设流程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>