<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【云原生之k8s】kubeadm搭建k8s集群 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【云原生之k8s】kubeadm搭建k8s集群" />
<meta property="og:description" content="【云原生之k8s】kubeadm搭建k8s集群 前言一、集群介绍(1)集群搭建方法(2)集群架构 二、集群部署(1)环境部署①所有节点，关闭防火墙规则，关闭selinux，关闭swap交换②修改主机名，并写入三台服务器的host中③调整内核参数④所有节点安装Docker (2)k8s集群部署①所有节点配置K8S源②所有节点安装kubeadm，kubelet和kubectl③部署kubernetes Master节点（master节点上执行）④token制作⑤k8s-node 节点加入 master 节点（两个 node 执行）⑥master节点安装部署pod网络插件（flannel）⑦给node节点添加标签⑧master检查⑨查询服务是否正常 (3)测试结果 前言 本文将介绍使用工具安装k8s的详细步骤
一、集群介绍 (1)集群搭建方法 目前生产部署Kubernetes 集群主要有两种方式：
Kubeadm
Kubeadm是一个K8s 部署工具，提供 kubeadm init 和 kubeadm join，用于快速部署Kubernetes 集群。二进制包
从github 下载发行版的二进制包，手动部署每个组件，组成Kubernetes 集群。 Kubeadm 降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可控，推荐使用二进制包部署Kubernetes 集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。
(2)集群架构 目前搭建集群一般采取一主一从、多主多从的集群架构（高可用）
二、集群部署 (1)环境部署 ①所有节点，关闭防火墙规则，关闭selinux，关闭swap交换 #所有节点，关闭防火墙规则，关闭selinux，关闭swap交换 systemctl stop firewalld systemctl disable firewalld setenforce 0 iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X swapoff -a	#交换分区必须要关闭 sed -ri &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab	#永久关闭swap分区，&amp;符号在sed命令中代表上次匹配的结果 ②修改主机名，并写入三台服务器的host中 cat &gt;&gt; /etc/hosts &lt;&lt; EOF 192." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f5d6af0d4d68f67abd5f26eadd081547/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-04T05:15:00+08:00" />
<meta property="article:modified_time" content="2022-08-04T05:15:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【云原生之k8s】kubeadm搭建k8s集群</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>【云原生之k8s】kubeadm搭建k8s集群</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_3" rel="nofollow">一、集群介绍</a></li><li><ul><li><a href="#1_4" rel="nofollow">(1)集群搭建方法</a></li><li><a href="#2_14" rel="nofollow">(2)集群架构</a></li></ul> 
  </li><li><a href="#_17" rel="nofollow">二、集群部署</a></li><li><ul><li><a href="#1_18" rel="nofollow">(1)环境部署</a></li><li><ul><li><a href="#selinuxswap_19" rel="nofollow">①所有节点，关闭防火墙规则，关闭selinux，关闭swap交换</a></li><li><a href="#host_29" rel="nofollow">②修改主机名，并写入三台服务器的host中</a></li><li><a href="#_37" rel="nofollow">③调整内核参数</a></li><li><a href="#Docker_56" rel="nofollow">④所有节点安装Docker</a></li></ul> 
   </li><li><a href="#2k8s_85" rel="nofollow">(2)k8s集群部署</a></li><li><ul><li><a href="#K8S_86" rel="nofollow">①所有节点配置K8S源</a></li><li><a href="#kubeadmkubeletkubectl_99" rel="nofollow">②所有节点安装kubeadm，kubelet和kubectl</a></li><li><a href="#kubernetes_Mastermaster_109" rel="nofollow">③部署kubernetes Master节点（master节点上执行）</a></li><li><a href="#token_136" rel="nofollow">④token制作</a></li><li><a href="#k8snode__master__node__143" rel="nofollow">⑤k8s-node 节点加入 master 节点（两个 node 执行）</a></li><li><a href="#masterpodflannel_155" rel="nofollow">⑥master节点安装部署pod网络插件（flannel）</a></li><li><a href="#node_181" rel="nofollow">⑦给node节点添加标签</a></li><li><a href="#master_188" rel="nofollow">⑧master检查</a></li><li><a href="#_198" rel="nofollow">⑨查询服务是否正常</a></li></ul> 
   </li><li><a href="#3_210" rel="nofollow">(3)测试结果</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<p>本文将介绍使用工具安装k8s的详细步骤</p> 
<h2><a id="_3"></a>一、集群介绍</h2> 
<h3><a id="1_4"></a>(1)集群搭建方法</h3> 
<p>目前生产部署Kubernetes 集群主要有两种方式：</p> 
<ol><li>Kubeadm<br> Kubeadm是一个K8s 部署工具，提供 kubeadm init 和 kubeadm join，用于快速部署Kubernetes 集群。</li><li>二进制包<br> 从github 下载发行版的二进制包，手动部署每个组件，组成Kubernetes 集群。</li></ol> 
<p>Kubeadm 降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可控，推荐使用二进制包部署Kubernetes 集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。</p> 
<h3><a id="2_14"></a>(2)集群架构</h3> 
<p>目前搭建集群一般采取一主一从、多主多从的集群架构（高可用）<br> <img src="https://images2.imgbox.com/81/19/z48fV0of_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_17"></a>二、集群部署</h2> 
<h3><a id="1_18"></a>(1)环境部署</h3> 
<h4><a id="selinuxswap_19"></a>①所有节点，关闭防火墙规则，关闭selinux，关闭swap交换</h4> 
<pre><code>#所有节点，关闭防火墙规则，关闭selinux，关闭swap交换
systemctl stop firewalld
systemctl disable firewalld
setenforce 0
iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X
swapoff -a		#交换分区必须要关闭
sed -ri 's/.*swap.*/#&amp;/' /etc/fstab	#永久关闭swap分区，&amp;符号在sed命令中代表上次匹配的结果
</code></pre> 
<p><img src="https://images2.imgbox.com/fa/b7/OkNvApSs_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="host_29"></a>②修改主机名，并写入三台服务器的host中</h4> 
<pre><code>cat &gt;&gt; /etc/hosts &lt;&lt; EOF
192.168.109.11 master
192.168.109.12 node01
192.168.109.13 node02
EOF
</code></pre> 
<p><img src="https://images2.imgbox.com/94/da/lGKvrVPS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_37"></a>③调整内核参数</h4> 
<p><strong>将桥接的 IPV4 流量传递到 iptables 链</strong></p> 
<pre><code>#调整内核参数

cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF
#开启网桥模式，可将网桥的流量传递给iptables链
net.bridge.bridge-nf-call-ip6tables=1
net.bridge.bridge-nf-call-iptables=1
#关闭ipv6协议
net.ipv6.conf.all.disable_ipv6=1
net.ipv4.ip_forward=1
EOF

#加载参数
sysctl --system  
</code></pre> 
<p><img src="https://images2.imgbox.com/19/62/RmqLAB0S_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7c/95/aL58DObv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Docker_56"></a>④所有节点安装Docker</h4> 
<pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2 
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 
yum install -y docker-ce docker-ce-cli containerd.io

mkdir /etc/docker
cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  }
}
EOF
#使用Systemd管理的Cgroup来进行资源控制与管理，因为相对Cgroupfs而言，Systemd限制CPU、内存等资源更加简单和成熟稳定。
#日志使用json-file格式类型存储，大小为100M，保存在/var/log/containers目录下，方便ELK等日志系统收集和管理日志。

systemctl daemon-reload
systemctl restart docker.service
systemctl enable docker.service 

docker info | grep "Cgroup Driver"
Cgroup Driver: system
</code></pre> 
<p><img src="https://images2.imgbox.com/80/d5/SWIj0YQY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dd/81/ba5nsOMj_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/54/c2/ooOEuedW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bd/4f/jf3IoTLi_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2k8s_85"></a>(2)k8s集群部署</h3> 
<h4><a id="K8S_86"></a>①所有节点配置K8S源</h4> 
<pre><code>#定义kubernetes源
cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre> 
<p><img src="https://images2.imgbox.com/ca/15/kGwAkg1v_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="kubeadmkubeletkubectl_99"></a>②所有节点安装kubeadm，kubelet和kubectl</h4> 
<pre><code>yum install -y kubelet-1.21.3 kubeadm-1.21.3 kubectl-1.21.3

#开机自启kubelet
systemctl enable kubelet.service
systemctl start kubelet
#K8S通过kubeadm安装出来以后都是以Pod方式存在，即底层是以容器方式运行，所以kubelet必须设置开机自启
</code></pre> 
<p><img src="https://images2.imgbox.com/87/f2/nu73YrGp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8d/a4/hSxvAYlu_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="kubernetes_Mastermaster_109"></a>③部署kubernetes Master节点（master节点上执行）</h4> 
<pre><code>kubeadm init \
--apiserver-advertise-address=192.168.109.11 \
--image-repository registry.aliyuncs.com/google_containers \
--kubernetes-version v1.21.3 \
--service-cidr=10.96.0.0/12 \
--pod-network-cidr=10.244.0.0/16
</code></pre> 
<p><strong>参数说明</strong></p> 
<pre><code>kubeadm init \
--apiserver-advertise-address=10.0.0.116 \ 　　 　　　　          #指定master监听的地址，修改为自己的master地址
--image-repository registry.aliyuncs.com/google_containers \ 　　#指定为aliyun的下载源，最好用国内的
--kubernetes-version v1.18.0 \ 　　 　　　　　　　　　　　　　#指定k8s版本，1.18.0版本比较稳定
--service-cidr=10.96.0.0/12 \ 　　 　　　　　　　　　　　　　 #设置集群内部的网络
--pod-network-cidr=10.244.0.0/16 　　 　　　　　　　　　　　 #设置pod的网络
# service-cidr 和 pod-network-cidr 最好就用这个，不然需要修改后面的 kube-flannel.yaml 文件
</code></pre> 
<p><img src="https://images2.imgbox.com/01/5c/4NNGYl5m_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/73/db/DbQhOYeI_o.png" alt="在这里插入图片描述"><br> <strong>执行以下命令可使用kubectl管理工具</strong></p> 
<pre><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre> 
<p><img src="https://images2.imgbox.com/57/35/11m9tjlG_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="token_136"></a>④token制作</h4> 
<p>node 节点加入集群需要生成的 token，token 有效期为 24 小时，过期需要重新创建<br> 创建命令为</p> 
<pre><code>kubeadm token create --print-join-command
</code></pre> 
<p><img src="https://images2.imgbox.com/bd/fd/EsvngL8Q_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="k8snode__master__node__143"></a>⑤k8s-node 节点加入 master 节点（两个 node 执行）</h4> 
<pre><code>获取前面创建好的token令牌
kubeadm join 192.168.109.11:6443 --token xwc4yz.g1zic1bv52wrwf0r --discovery-token-ca-cert-hash sha256:34c556c6a086d80b587c101f81b1602ba102feccc8dccd74a10fd25ab7cfa0ba
</code></pre> 
<p><img src="https://images2.imgbox.com/59/00/xNsRTOZ7_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/00/76/uzhYrPVr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ad/5f/3ut1x4EP_o.png" alt="在这里插入图片描述"><br> 节点显示 NotReady 状态，需要安装网络插件</p> 
<p><strong>token 过期重新生成 token</strong><br> <strong>kubeadm token create --print-join-command</strong></p> 
<h4><a id="masterpodflannel_155"></a>⑥master节点安装部署pod网络插件（flannel）</h4> 
<p><strong>下载插件</strong></p> 
<pre><code>#国外网站
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
#国内网站
wget http://120.78.77.38/file/kube-flannel.yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/c9/32/ezBL9uLk_o.png" alt="在这里插入图片描述"></p> 
<pre><code>#安装
kubectl apply -f kube-flannel.yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/09/bd/LzzKN0o2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9d/78/Iad2GCVg_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/18/35/dljhab2k_o.png" alt="在这里插入图片描述"><br> <strong>解决办法</strong></p> 
<pre><code>#修改 flannel 插件文件，这个版本比较低，高版本 k8s 尽量选择一些高一些的版本 flannel
sed -i -r "s#quay.io/coreos/flannel:.*-amd64#lizhenliang/flannel:v0.12.0-amd64#g" kube-flannel.yaml
kubectl apply -f kube-flannel.yaml
kubectl get pods -n kube-system
kubectl get node　　#部署好网络插件，node 准备就绪
</code></pre> 
<p><img src="https://images2.imgbox.com/13/27/9JhiUYL2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7e/00/6ob4rRJJ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="node_181"></a>⑦给node节点添加标签</h4> 
<pre><code>kubectl label node node01 node-role.kubernetes.io/node=node1
kubectl label node node02 node-role.kubernetes.io/node=node2
#获取节点信息
kubectl get nodes
</code></pre> 
<p><img src="https://images2.imgbox.com/2b/27/4SmnPsC3_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="master_188"></a>⑧master检查</h4> 
<pre><code>#查询master是否正常 
kubectl get cs 
#若为unhealthy 
vim /etc/kubernetes/manifests/kube-scheduler.yaml 
vim /etc/kubernetes/manifests/kube-controller-manager.yaml
#将- --port=0注释掉
</code></pre> 
<p><img src="https://images2.imgbox.com/c1/6d/SkeQT8mz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1f/7b/h9oclUSa_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_198"></a>⑨查询服务是否正常</h4> 
<p><strong>监测K8s集群是否正常后，再运行服务部署</strong></p> 
<pre><code>#查询所有pod是否正常运行 
kubectl get pods -A 
#查询master是否正常 
kubectl get cs 
#查询node节点是否ready 
kubectl get nodes
</code></pre> 
<p><img src="https://images2.imgbox.com/67/48/Rj68nGzV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a6/9a/CnGUBTCR_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_210"></a>(3)测试结果</h3> 
<p><strong>在集群中创建一个 pod，验证是否能正常运行</strong></p> 
<pre><code>#部署服务
kubectl create deployment nginx --image=nginx:1.14
#暴露端口
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get pods
kubectl get svc(service)
#删除pod与svc
kubectl delete deploy/nginx
kubectl delete svc/nginx
</code></pre> 
<p><img src="https://images2.imgbox.com/f1/7b/NQSHNQ1v_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/15/71/jZJr4exz_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5e4c982519a72442c4096d215486bc97/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vagrant和VirtualBox配置时出现的一些问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4faa950658e3fabc16818af9de4bc251/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">入门：如何搭建一个简单的静态网站，apache服务器，https，SSL(TLS)握手过程和发送包的内容</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>