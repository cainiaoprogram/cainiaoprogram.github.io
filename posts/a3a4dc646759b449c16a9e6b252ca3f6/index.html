<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CentOS k8s1.20.9集群配套KubesPhere3.1.1安装 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CentOS k8s1.20.9集群配套KubesPhere3.1.1安装" />
<meta property="og:description" content="文章目录 CentOS k8s集群 KubesPhere安装一、k8s集群1、基础环境准备2、安装docker3、安装kubelete、kubeadm、kubectl4、部署master节点（171）5、安装网络组件（flannel）：6、节点加入 二、KubeSphere1、准备helm 和 tiller（helm v3的版本不需要再安装tiller）2、安装OpenEBS3、开始kubesphere最小安装 CentOS k8s集群 KubesPhere安装 各组件版本表：
组件名称组件版本docker20.10.7k8s1.20.9helm3.7.1KubesPhere3.1.1 一、k8s集群 1、基础环境准备 由于我的centos7.5是最小安装，所以先安装一下工具集
yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git iproute lrzsz bash-completion tree bridge-utils unzip bind-utils gcc
然后进行关闭防火墙等操作
# 1.关闭防火墙 systemctl stop firewalld &amp;&amp; systemctl disable firewalld # 2.置空iptables yum -y install iptables-services &amp;&amp; systemctl start iptables &amp;&amp; systemctl enable iptables &amp;&amp; iptables -F &amp;&amp; service iptables save # 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a3a4dc646759b449c16a9e6b252ca3f6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-17T21:29:27+08:00" />
<meta property="article:modified_time" content="2022-03-17T21:29:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CentOS k8s1.20.9集群配套KubesPhere3.1.1安装</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#CentOS_k8s_KubesPhere_1" rel="nofollow">CentOS k8s集群 KubesPhere安装</a></li><li><ul><li><a href="#k8s_14" rel="nofollow">一、k8s集群</a></li><li><ul><li><a href="#1_16" rel="nofollow">1、基础环境准备</a></li><li><a href="#2docker_87" rel="nofollow">2、安装docker</a></li><li><a href="#3kubeletekubeadmkubectl_124" rel="nofollow">3、安装kubelete、kubeadm、kubectl</a></li><li><a href="#4master171_148" rel="nofollow">4、部署master节点（171）</a></li><li><a href="#5flannel_194" rel="nofollow">5、安装网络组件（flannel）：</a></li><li><a href="#6_207" rel="nofollow">6、节点加入</a></li></ul> 
   </li><li><a href="#KubeSphere_229" rel="nofollow">二、KubeSphere</a></li><li><ul><li><a href="#1helm__tillerhelm_v3tiller_231" rel="nofollow">1、准备helm 和 tiller（helm v3的版本不需要再安装tiller）</a></li><li><a href="#2OpenEBS_266" rel="nofollow">2、安装OpenEBS</a></li><li><a href="#3kubesphere_332" rel="nofollow">3、开始kubesphere最小安装</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="CentOS_k8s_KubesPhere_1"></a>CentOS k8s集群 KubesPhere安装</h2> 
<p>各组件版本表：</p> 
<table><thead><tr><th>组件名称</th><th>组件版本</th></tr></thead><tbody><tr><td>docker</td><td>20.10.7</td></tr><tr><td>k8s</td><td>1.20.9</td></tr><tr><td>helm</td><td>3.7.1</td></tr><tr><td>KubesPhere</td><td>3.1.1</td></tr></tbody></table> 
<h3><a id="k8s_14"></a>一、k8s集群</h3> 
<h4><a id="1_16"></a>1、基础环境准备</h4> 
<p>由于我的centos7.5是最小安装，所以先安装一下工具集</p> 
<p><code>yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git iproute lrzsz bash-completion tree bridge-utils unzip bind-utils gcc</code></p> 
<p>然后进行关闭防火墙等操作</p> 
<pre><code class="prism language-bash"><span class="token comment"># 1.关闭防火墙</span>
systemctl stop firewalld <span class="token operator">&amp;&amp;</span> systemctl disable firewalld
<span class="token comment"># 2.置空iptables </span>
yum -y <span class="token function">install</span> iptables-services <span class="token operator">&amp;&amp;</span> systemctl start iptables <span class="token operator">&amp;&amp;</span> systemctl <span class="token function">enable</span> iptables <span class="token operator">&amp;&amp;</span> iptables -F <span class="token operator">&amp;&amp;</span> <span class="token function">service</span> iptables save
<span class="token comment"># 3.关闭selinux</span>
<span class="token comment">#闭swap分区【虚拟内存】并且永久关闭虚拟内存</span>
swapoff -a <span class="token operator">&amp;&amp;</span> <span class="token function">sed</span> -i <span class="token string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab
<span class="token comment">#关闭selinux</span>
setenforce 0 <span class="token operator">&amp;&amp;</span> <span class="token function">sed</span> -i <span class="token string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config
<span class="token comment"># 4.升级Linux内核为4.4的版本  这里升级内核是因为k8s在3.10的内核下不稳定，升级内核（选做）</span>
rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm
<span class="token comment">#安装内核（根据自己的需要选择内核版本）</span>
<span class="token comment"># 阿里内核镜像仓库 http://mirrors.aliyun.com/elrepo/kernel/el7/x86_64/RPMS/</span>
<span class="token comment"># 下载自己想要的rpm 我这里下载的4.4.245版本的内核</span>
<span class="token function">wget</span> http://mirrors.aliyun.com/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-4.4.245-1.el7.elrepo.x86_64.rpm
yum -y <span class="token function">install</span>  kernel-lt-4.4.245-1.el7.elrepo.x86_64.rpm
<span class="token comment"># 查看系统目前内核</span>
<span class="token function">awk</span> -F\<span class="token string">' '</span><span class="token variable">$1</span><span class="token operator">==</span><span class="token string">"menuentry "</span> <span class="token punctuation">{<!-- --></span>print i++ <span class="token string">" : "</span> <span class="token variable">$2</span><span class="token punctuation">}</span>' /etc/grub2.cfg
<span class="token comment"># 修改默认引导版本（0就是刚才查看的我新安装的内核序号）</span>
grub2-set-default 0

<span class="token comment">#重启生效</span>
<span class="token function">reboot</span>
<span class="token comment">#查看当前内核版本</span>
<span class="token function">uname</span> -r 

<span class="token comment"># 5.设置iptable</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> kubernetes.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
net.ipv4.tcp_tw_recycle=0
vm.swappiness=0
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_instances=8192
fs.inotify.max_user_watches=1048576
fs.file-max=52706963
fs.nr_open=52706963
net.ipv6.conf.all.disable_ipv6=1
net.netfilter.nf_conntrack_max=2310720
EOF</span>
<span class="token comment">#将优化内核文件拷贝到/etc/sysctl.d/文件夹下，这样优化文件开机的时候能够被调用</span>
<span class="token function">cp</span> kubernetes.conf /etc/sysctl.d/kubernetes.conf
<span class="token comment">#手动刷新，让优化文件立即生效</span>
sysctl -p /etc/sysctl.d/kubernetes.conf
<span class="token comment">#如果这步出错，提示xxx：No such file or directory</span>
<span class="token comment">#可能跟我遇到的一样，看这个文章 https://blog.csdn.net/endless_fighting/article/details/122798452?spm=1001.2014.3001.5501</span>

<span class="token comment"># 6.调整系统临时区 --- 如果已经设置时区，可略过</span>
<span class="token comment">#设置系统时区为中国/上海</span>
timedatectl set-timezone Asia/Shanghai
<span class="token comment">#将当前的 UTC 时间写入硬件时钟</span>
timedatectl set-local-rtc 0
<span class="token comment">#重启依赖于系统时间的服务</span>
systemctl restart rsyslog
systemctl restart crond

<span class="token comment"># 7.关闭系统不需要的服务</span>
systemctl stop postfix <span class="token operator">&amp;&amp;</span> systemctl disable postfix
</code></pre> 
<h4><a id="2docker_87"></a>2、安装docker</h4> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> yum remove docker*
<span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils

<span class="token comment">#配置docker的yum地址</span>
<span class="token function">sudo</span> yum-config-manager \
--add-repo \
http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo


<span class="token comment">#安装指定版本</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> -y docker-ce-20.10.7 docker-ce-cli-20.10.7 containerd.io-1.4.6

<span class="token comment">#	启动&amp;开机启动docker</span>
systemctl <span class="token function">enable</span> docker --now

<span class="token comment"># docker加速配置</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/docker
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span>-<span class="token string">'EOF'</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"registry-mirrors"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token string">"https://82m9ar63.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,
  <span class="token string">"exec-opts"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span>,
  <span class="token string">"log-driver"</span><span class="token keyword">:</span> <span class="token string">"json-file"</span>,
  <span class="token string">"log-opts"</span><span class="token keyword">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"max-size"</span><span class="token keyword">:</span> <span class="token string">"100m"</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"storage-driver"</span><span class="token keyword">:</span> <span class="token string">"overlay2"</span>
<span class="token punctuation">}</span>
EOF
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart docker
</code></pre> 
<h4><a id="3kubeletekubeadmkubectl_124"></a>3、安装kubelete、kubeadm、kubectl</h4> 
<pre><code class="prism language-bash"><span class="token comment">#配置k8s的yum源地址</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/kubernetes.repo
<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>
name<span class="token operator">=</span>Kubernetes
baseurl<span class="token operator">=</span>http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled<span class="token operator">=</span>1
gpgcheck<span class="token operator">=</span>0
repo_gpgcheck<span class="token operator">=</span>0
gpgkey<span class="token operator">=</span>http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF


<span class="token comment">#安装 kubelet，kubeadm，kubectl</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9

<span class="token comment">#启动kubelet</span>
<span class="token function">sudo</span> systemctl <span class="token function">enable</span> --now kubelet

</code></pre> 
<h4><a id="4master171_148"></a>4、部署master节点（171）</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 我的主节点是192.168.0.171</span>
kubeadm init \
--apiserver-advertise-address<span class="token operator">=</span>192.168.0.171 \
--image-repository registry.aliyuncs.com/google_containers \
--kubernetes-version v1.20.9 \
--service-cidr<span class="token operator">=</span>10.96.0.0/12 \
--pod-network-cidr<span class="token operator">=</span>10.244.0.0/16
</code></pre> 
<p>完成后会有如下打印：</p> 
<pre><code class="prism language-bash">Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> -p <span class="token variable">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token variable">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token keyword">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token variable">$HOME</span>/.kube/config

Alternatively, <span class="token keyword">if</span> you are the root user, you can run:

  <span class="token function">export</span> KUBECONFIG<span class="token operator">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> 192.168.0.171:6443 --token 6xmb89.qob0p1siuttplf53 \
    --discovery-token-ca-cert-hash sha256:2a0a00dfe950bcfc21fc326f17e6ba8efb6d27576a664971675f9108fbaeab08
</code></pre> 
<p>根据提示执行命令：</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> -p <span class="token variable">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token variable">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token keyword">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token variable">$HOME</span>/.kube/config

</code></pre> 
<h4><a id="5flannel_194"></a>5、安装网络组件（flannel）：</h4> 
<p>如果后面的kubesphere要开启devops功能就安装flannel</p> 
<pre><code class="prism language-bash"><span class="token comment">#fannel地址： https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span>
<span class="token function">curl</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml -O
<span class="token comment">#如果下载不了就用上面的网址直接访问复制下来 </span>
kubectl apply -f kube-flannel.yml
kubectl get pod -A
<span class="token comment">#等全部running</span>
</code></pre> 
<h4><a id="6_207"></a>6、节点加入</h4> 
<p>172,173节点分别执行前面给的命令加入</p> 
<pre><code class="prism language-bash">kubeadm <span class="token function">join</span> 192.168.0.171:6443 --token 6xmb89.qob0p1siuttplf53 \
    --discovery-token-ca-cert-hash sha256:2a0a00dfe950bcfc21fc326f17e6ba8efb6d27576a664971675f9108fbaeab08
</code></pre> 
<p>在主节点查看node情况</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8sMaster local<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
NAME        STATUS     ROLES                  AGE   VERSION
k8smaster   Ready      control-plane,master   17m   v1.20.9
k8snode1    NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 27s   v1.20.9
k8snode2    NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 14s   v1.20.9

</code></pre> 
<p>等全部ready了就代表k8s集群搭建完成了。</p> 
<h3><a id="KubeSphere_229"></a>二、KubeSphere</h3> 
<h4><a id="1helm__tillerhelm_v3tiller_231"></a>1、准备helm 和 tiller（helm v3的版本不需要再安装tiller）</h4> 
<p>helm可以选择用官方的一键脚本或者下载二进制包进行安装</p> 
<p>https://helm.sh/zh/docs/topics/version_skew/这里是官网的helm和k8s的版本对照表</p> 
<p>这是官方给的命令：</p> 
<pre><code class="prism language-bash">$ <span class="token function">curl</span> -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
$ <span class="token function">chmod</span> 700 get_helm.sh
$ ./get_helm.sh
</code></pre> 
<p>我采取二进制安装</p> 
<pre><code class="prism language-bash"><span class="token comment">#安装socat</span>
<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># yum install -y socat</span>
<span class="token comment">#下载helm二进制包去官方GitHub  https://github.com/helm/helm/releases</span>
<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># tar -zxvf helm-v3.7.1-linux-amd64.tar.gz</span>
linux-amd64/
linux-amd64/helm
linux-amd64/LICENSE
linux-amd64/README.md
<span class="token comment">#移动文件</span>
<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># mv linux-amd64/helm /usr/local/bin/helm</span>
<span class="token comment">#安装成功查看版本</span>
<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># helm version</span>
version.BuildInfo<span class="token punctuation">{<!-- --></span>Version:<span class="token string">"v3.7.1"</span>, GitCommit:<span class="token string">"1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4"</span>, GitTreeState:<span class="token string">"clean"</span>, GoVersion:<span class="token string">"go1.16.9"</span><span class="token punctuation">}</span>

</code></pre> 
<p>helm安装成功</p> 
<h4><a id="2OpenEBS_266"></a>2、安装OpenEBS</h4> 
<p>去除master节点的taint</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8sMaster bin<span class="token punctuation">]</span><span class="token comment"># kubectl describe node k8smaster | grep Taint</span>
Taints:             node-role.kubernetes.io/master:NoSchedule
<span class="token punctuation">[</span>root@k8sMaster bin<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes k8smaster node-role.kubernetes.io/master:NoSchedule-</span>
node/k8smaster untainted
<span class="token punctuation">[</span>root@k8sMaster bin<span class="token punctuation">]</span><span class="token comment"># kubectl describe node k8smaster | grep Taint</span>
Taints:             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

</code></pre> 
<p>开始安装OpenEBS</p> 
<pre><code class="prism language-bash"><span class="token comment">#添加OpenEBS LocalPV仓库到helm</span>
<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># helm repo add openebs-localpv https://openebs.github.io/dynamic-localpv-provisioner</span>
<span class="token string">"openebs-localpv"</span> has been added to your repositories
<span class="token comment">#使用helm安装openebs</span>
<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># helm install openebs openebs-localpv/localpv-provisioner --namespace openebs --create-namespace</span>
NAME: openebs
LAST DEPLOYED: Thu Feb  3 13:38:24 2022
NAMESPACE: openebs
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
The OpenEBS Dynamic LocalPV Provisioner has been installed.
Check its status by running:
$ kubectl get pods -n openebs

Use <span class="token variable"><span class="token variable">`</span>kubectl get bd -n openebs<span class="token variable">`</span></span> to list the
blockdevices attached to the Kubernetes cluster nodes.

Get started with the Dynamic LocalPV Provisioner Quickstart guide at:
https://github.com/openebs/dynamic-localpv-provisioner/blob/develop/docs/quickstart.md

For <span class="token function">more</span> information, visit our Slack at https://openebs.io/community or view
the OpenEBS documentation online at https://openebs.io/docs
<span class="token comment">#过几分钟查看安装情况</span>
<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n openebs</span>
NAME                                           READY   STATUS    RESTARTS   AGE
openebs-localpv-provisioner-76f75ffc57-whssp   1/1     Running   0          9m28s
openebs-ndm-4n9bc                              1/1     Running   0          9m28s
openebs-ndm-d4kdv                              1/1     Running   0          9m28s
openebs-ndm-operator-6c8b775b45-p626k          1/1     Running   0          9m28s
openebs-ndm-s99sn                              1/1     Running   0          9m28s

<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># kubectl get sc</span>
NAME               PROVISIONER        RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
openebs-device     openebs.io/local   Delete          WaitForFirstConsumer   <span class="token boolean">false</span>                  10m
openebs-hostpath   openebs.io/local   Delete          WaitForFirstConsumer   <span class="token boolean">false</span>                  10m
<span class="token comment">#设置默认sc</span>
<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># kubectl patch storageclass openebs-hostpath -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span>
storageclass.storage.k8s.io/openebs-hostpath patched
<span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># kubectl get sc</span>
NAME                         PROVISIONER        RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
openebs-device               openebs.io/local   Delete          WaitForFirstConsumer   <span class="token boolean">false</span>                  11m
openebs-hostpath <span class="token punctuation">(</span>default<span class="token punctuation">)</span>   openebs.io/local   Delete          WaitForFirstConsumer   <span class="token boolean">false</span>                  11m

</code></pre> 
<p><strong>注意：此时不要给master加上污点，否者导致后面的pods安装不上(openldap,redis),待kubesphere安装完成后加上污点</strong></p> 
<h4><a id="3kubesphere_332"></a>3、开始kubesphere最小安装</h4> 
<p>https://github.com/kubesphere/ks-installer/blob/release-3.1/scripts/kubesphere-delete.sh先到官方的GitHub上下载个卸载脚本，以防安装失败重新安装</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master local<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/kubesphere/ks-installer/blob/release-3.1/scripts/kubesphere-delete.sh</span>
</code></pre> 
<p>官方给的两条命令我这没办法直接用，只能先直接访问链接把yaml下载下来了</p> 
<pre><code class="prism language-bash"><span class="token comment"># 官方命令</span>
kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.1.1/kubesphere-installer.yaml
   
kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.1.1/cluster-configuration.yaml

<span class="token comment">#先通过链接下载下来</span>
</code></pre> 
<p>修改cluster-configuration.yaml文件将devops这里设置为true，这个地方也可以先不改等安好kubesphere之后再在里面的组件里更新配置文件添加，官网有介绍可拔插组件</p> 
<p>按照官网给的命令执行</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8sMaster local<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f kubesphere-installer.yaml</span>
<span class="token punctuation">[</span>root@k8sMaster local<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f cluster-configuration.yaml</span>
<span class="token punctuation">[</span>root@k8sMaster local<span class="token punctuation">]</span><span class="token comment"># kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath='{.items[0].metadata.name}') -f</span>
<span class="token comment">#日志太长我就不全复制过来了 日志可以看到4个成功状态，还有如下控制台地址和默认的用户名密码</span>
Console: http://192.168.0.171:30880
Account: admin
Password: P@88w0rd

<span class="token punctuation">[</span>root@k8sMaster local<span class="token punctuation">]</span><span class="token comment"># kubectl get svc/ks-console -n kubesphere-system</span>
NAME         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
ks-console   NodePort   10.96.142.74   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        80:30880/TCP   36m

</code></pre> 
<pre><code class="prism language-bash"><span class="token comment"># 把之前的traint加回去</span>
<span class="token punctuation">[</span>root@k8sMaster local<span class="token punctuation">]</span><span class="token comment">#  kubectl taint nodes k8smaster node-role.kubernetes.io/master=:NoSchedule</span>
node/k8smaster tainted
<span class="token punctuation">[</span>root@k8sMaster local<span class="token punctuation">]</span><span class="token comment"># kubectl describe node k8smaster | grep Taint</span>
Taints:             node-role.kubernetes.io/master:NoSchedule
</code></pre> 
<p>第一次使用默认的密码登陆后会直接让修改密码，根据提示修改个强度高的密码就行了</p> 
<pre><code>
```bash
# 把之前的traint加回去
[root@k8sMaster local]#  kubectl taint nodes k8smaster node-role.kubernetes.io/master=:NoSchedule
node/k8smaster tainted
[root@k8sMaster local]# kubectl describe node k8smaster | grep Taint
Taints:             node-role.kubernetes.io/master:NoSchedule
</code></pre> 
<p>访问ip:30880进入页面，第一次使用默认的密码登陆后会直接让修改密码，根据提示修改个强度高的密码就行了</p> 
<p><img src="https://images2.imgbox.com/27/ea/quDLBean_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e06cbcffc86bb745269c2e2205966e4d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Flv解复用代码解析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e8b4cbba7e62102269613831183bd0b9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">1、Java程序如何运行</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>