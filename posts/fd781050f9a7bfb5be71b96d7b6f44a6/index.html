<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[记录]基于Flask Web全栈开发实战-项目实战·上篇（黄勇 • 著） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[记录]基于Flask Web全栈开发实战-项目实战·上篇（黄勇 • 著）" />
<meta property="og:description" content="说明 基于书籍《Flask Web全栈开发实战》【黄勇·著】第9章项目实战
创建项目 代码环境：pycharm
File-&gt;New Project-&gt;Flask
安装相应的python 包
# 用于flask在使用ORM模型操作数据库 pip install flask-sqlalchemy # Python操作数据库的驱动程序 pip install pymysql # 对密码加密和解密 pip install cryptography # 用于将ORM模型的变更同步到数据库中 pip install flask-migrate config.py文件 在根目录下，常见一个config.py的python文件，用来存放配置项。
class BaseConfig: SECRET_KEY = &#39;linql_test&#39; SQLALCHEMY_TRACK_MODIFICATIONS = False # 开发环境 class DevelopmentConfig(BaseConfig): # 配置连接数据库 HOSTNAME = &#39;192.168.3.5&#39; #服务器地址 PORT = 3306 #默认端口号 USERNAME = &#39;root&#39; PASSWORD = &#39;root&#39; DATABASE = &#39;pythonbbs&#39; #数据库名 SQLALCHEMY_DATABASE_URI = f&#34;mysql&#43;pymysql://{USERNAME}:{PASSWORD}@{HOSTNAME}:{PORT}/{DATABASE}?charset=utf8mb4&#34; # 测试环境 class TestingConfig(BaseConfig): # 配置连接数据库 HOSTNAME = &#39;192." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fd781050f9a7bfb5be71b96d7b6f44a6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-17T15:23:05+08:00" />
<meta property="article:modified_time" content="2023-10-17T15:23:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[记录]基于Flask Web全栈开发实战-项目实战·上篇（黄勇 • 著）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>说明</h3> 
<p>基于书籍《Flask Web全栈开发实战》【黄勇·著】第9章项目实战</p> 
<h3><a id="_3"></a>创建项目</h3> 
<p>代码环境：pycharm<br> File-&gt;New Project-&gt;Flask<br> <img src="https://images2.imgbox.com/17/8e/gPVl8izD_o.png" alt="在这里插入图片描述"></p> 
<p>安装相应的python 包</p> 
<pre><code class="prism language-python"><span class="token comment"># 用于flask在使用ORM模型操作数据库</span>
pip install flask<span class="token operator">-</span>sqlalchemy 
<span class="token comment"># Python操作数据库的驱动程序</span>
pip install pymysql
<span class="token comment"># 对密码加密和解密</span>
pip install cryptography
<span class="token comment"># 用于将ORM模型的变更同步到数据库中</span>
pip install flask<span class="token operator">-</span>migrate
</code></pre> 
<h4><a id="configpy_25"></a>config.py文件</h4> 
<p>在根目录下，常见一个config.py的python文件，用来存放配置项。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">BaseConfig</span><span class="token punctuation">:</span>
    SECRET_KEY <span class="token operator">=</span> <span class="token string">'linql_test'</span>
    SQLALCHEMY_TRACK_MODIFICATIONS <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token comment"># 开发环境</span>
<span class="token keyword">class</span> <span class="token class-name">DevelopmentConfig</span><span class="token punctuation">(</span>BaseConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 配置连接数据库</span>
    HOSTNAME <span class="token operator">=</span> <span class="token string">'192.168.3.5'</span> <span class="token comment">#服务器地址</span>
    PORT <span class="token operator">=</span> <span class="token number">3306</span> <span class="token comment">#默认端口号</span>
    USERNAME <span class="token operator">=</span> <span class="token string">'root'</span>
    PASSWORD <span class="token operator">=</span> <span class="token string">'root'</span>
    DATABASE <span class="token operator">=</span> <span class="token string">'pythonbbs'</span> <span class="token comment">#数据库名</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span>  <span class="token string-interpolation"><span class="token string">f"mysql+pymysql://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>USERNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PASSWORD<span class="token punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>HOSTNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PORT<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>DATABASE<span class="token punctuation">}</span></span><span class="token string">?charset=utf8mb4"</span></span>
   
<span class="token comment">#  测试环境</span>
<span class="token keyword">class</span> <span class="token class-name">TestingConfig</span><span class="token punctuation">(</span>BaseConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 配置连接数据库</span>
    HOSTNAME <span class="token operator">=</span> <span class="token string">'192.168.3.5'</span>  <span class="token comment"># 服务器地址</span>
    PORT <span class="token operator">=</span> <span class="token number">3306</span>  <span class="token comment"># 默认端口号</span>
    USERNAME <span class="token operator">=</span> <span class="token string">'root'</span>
    PASSWORD <span class="token operator">=</span> <span class="token string">'root'</span>
    DATABASE <span class="token operator">=</span> <span class="token string">'pythonbbs'</span>  <span class="token comment"># 数据库名</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"mysql+pymysql://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>USERNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PASSWORD<span class="token punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>HOSTNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PORT<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>DATABASE<span class="token punctuation">}</span></span><span class="token string">?charset=utf8mb4"</span></span>

<span class="token comment"># 生产部署环境</span>
<span class="token keyword">class</span> <span class="token class-name">ProductionConfig</span><span class="token punctuation">(</span>BaseConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 配置连接数据库</span>
    HOSTNAME <span class="token operator">=</span> <span class="token string">'192.168.3.5'</span>  <span class="token comment"># 服务器地址</span>
    PORT <span class="token operator">=</span> <span class="token number">3306</span>  <span class="token comment"># 默认端口号</span>
    USERNAME <span class="token operator">=</span> <span class="token string">'root'</span>
    PASSWORD <span class="token operator">=</span> <span class="token string">'root'</span>
    DATABASE <span class="token operator">=</span> <span class="token string">'pythonbbs'</span>  <span class="token comment"># 数据库名</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"mysql+pymysql://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>USERNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PASSWORD<span class="token punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>HOSTNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PORT<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>DATABASE<span class="token punctuation">}</span></span><span class="token string">?charset=utf8mb4"</span></span>
</code></pre> 
<p>在app.py中，绑定配置</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="extspy_86"></a>exts.py文件</h4> 
<p>在根目录里创建exts.py文件，主要用来存放一些第三方插件的对象。<br> 如：SQLAlchemy对象、Flask-Mail对象等。<br> 目的，是为了防止循环引用。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>回到app.py中，然后导入db变量，再通过db.init_app(app)完成初始化。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="blueprints_121"></a>blueprints模块</h4> 
<p>通过蓝图来模块化，创建一个blueprints的包，用于存放蓝图模块。<br> 在项目名称上右击，New-&gt;Python Package<br> 并在，blueprints下，分别创建名为：cms、front和user的python文件<br> <img src="https://images2.imgbox.com/fd/5b/6j1hMY2X_o.png" alt="在这里插入图片描述"></p> 
<p>在cms.py中创建蓝图对象</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint
bp <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"cms"</span><span class="token punctuation">,</span>__name__<span class="token punctuation">,</span>url_prefix<span class="token operator">=</span><span class="token string">"/cms"</span><span class="token punctuation">)</span>
</code></pre> 
<p>在front.py中创建蓝图对象</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint
bp <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"front"</span><span class="token punctuation">,</span>__name__<span class="token punctuation">,</span>url_prefix<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
</code></pre> 
<p>在user.py中创建蓝图对象</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint
bp <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span>__name__<span class="token punctuation">,</span>url_prefix<span class="token operator">=</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
</code></pre> 
<p>创建了蓝图对象，并指定了url前缀，因front是面向前台的，所以url为空<br> 创建蓝图对象后，还需要在app.py中完成注册。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="models_184"></a>models模块</h4> 
<p>在根目录下，创建一个名为models的Python Package，然后在models下分别创建user.py和post.py，用来存放与用户和帖子相关的ORM模型。</p> 
<p><img src="https://images2.imgbox.com/c5/0d/nyyG0ChG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_190"></a>创建用户相关模型</h3> 
<h4><a id="_192"></a>创建权限和角色模型</h4> 
<p>用户系统最核心的部分就是用户相关的ORM模型。<br> 该系统的前台和后台用的是同一个用户系统，而后台系统中需要角色和权限管理。<br> 首先，来添加权限ORM模型，在models/user.py中添加以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> exts <span class="token keyword">import</span> db
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum


<span class="token comment"># PermissionEnum 枚举类型</span>
<span class="token comment"># 存放权限类型的枚举</span>
<span class="token keyword">class</span> <span class="token class-name">PermissionEnum</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    BOARD <span class="token operator">=</span> <span class="token string">"板块"</span>
    POST <span class="token operator">=</span> <span class="token string">"帖子"</span>
    COMMENT <span class="token operator">=</span> <span class="token string">"评论"</span>
    FRONT_USER <span class="token operator">=</span> <span class="token string">"前台用户"</span>
    CMS_USER <span class="token operator">=</span> <span class="token string">"后台用户"</span>

<span class="token comment"># PermissionModel模型</span>
<span class="token comment"># name 从PermissionEnum 枚举取</span>
<span class="token keyword">class</span> <span class="token class-name">PermissionModel</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__<span class="token operator">=</span><span class="token string">"permission"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Enum<span class="token punctuation">(</span>PermissionEnum<span class="token punctuation">)</span><span class="token punctuation">,</span>nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># 中间表</span>
<span class="token comment"># role_id来引用role表</span>
<span class="token comment"># permission_id来引用permission表</span>
role_permission_table<span class="token operator">=</span>db<span class="token punctuation">.</span>Table<span class="token punctuation">(</span>
    <span class="token string">"role_permission_table"</span><span class="token punctuation">,</span>
    db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">"role_id"</span><span class="token punctuation">,</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span>db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"role.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">"permission_id"</span><span class="token punctuation">,</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span>db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"permission.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">RoleModel</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__<span class="token operator">=</span><span class="token string">"role"</span>
    <span class="token comment"># 主键id</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># 角色名称</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># 角色描述</span>
    desc <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># 创建时间</span>
    create_time <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Datetime<span class="token punctuation">,</span>default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>
    <span class="token comment"># 关系属性（RoleModel和PermissionModel属于多对多关系）</span>
    <span class="token comment"># role_permission_table 中间表</span>
    permissions <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">"PermissionModel"</span><span class="token punctuation">,</span>secondary<span class="token operator">=</span>role_permission_table<span class="token punctuation">,</span>backref<span class="token operator">=</span><span class="token string">"roles"</span><span class="token punctuation">)</span>
</code></pre> 
<p>在PermissionModel和RoleModel创建完成后，将模型映射到数据库中，需要借助Flask-Migrate插件<br> 在app.py中，创建Migrate对象</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>
<span class="token comment"># 创建Migrate对象</span>
migrate <span class="token operator">=</span> Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span>db<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>为了迁移时能让程序识别到models/user.py中的ORM模型，需要导入</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> models <span class="token keyword">import</span> user
</code></pre> 
<pre><code>---------------------------------------------------------------------------

ModuleNotFoundError                       Traceback (most recent call last)

Cell In[5], line 1
----&gt; 1 from models import user


ModuleNotFoundError: No module named 'models'
</code></pre> 
<p>在pyCharm的Terminal中执行以下命令，以生成迁移脚本，并完成迁移脚本的执行。</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span>pythonWeb<span class="token punctuation">)</span> linql@localhost flaskDemo1 <span class="token operator">%</span> flask db migrate <span class="token operator">-</span>m <span class="token string">"create permission and role model"</span>
Error<span class="token punctuation">:</span> Path doesn<span class="token string">'t exist: '</span><span class="token operator">/</span>Users<span class="token operator">/</span>linql<span class="token operator">/</span>Desktop<span class="token operator">/</span>code_Deeplearn<span class="token operator">/</span>flaskDemo1<span class="token operator">/</span>migrations<span class="token string">'.  Please use the '</span>init' command to create a new scripts folder<span class="token punctuation">.</span>
</code></pre> 
<p>上面运行，会报错。提示需要先“init”</p> 
<pre><code class="prism language-python"><span class="token comment"># 先执行</span>
flask db init
<span class="token comment"># 再执行</span>
flask db migrate <span class="token operator">-</span>m <span class="token string">"create permission and role model"</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/05/0d/qbTk5Ert_o.png" alt="在这里插入图片描述"></p> 
<p>执行以上命令后，已经为ORM模型生成了迁移脚本。<br> 但，此时并没有真正同步到数据库中，还需要执行以下命令才会实现同步到数据库中。</p> 
<pre><code class="prism language-python">flask db upgrade
</code></pre> 
<p><img src="https://images2.imgbox.com/a9/eb/mUCGQT4F_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/24/a2/fRuxKUvz_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_332"></a>创建权限和角色</h4> 
<h5><a id="Flask___334"></a>Flask 项目 如何创建命令</h5> 
<p>在flask安装时，默认会安装click库<br> click库，主要作用是用来实现命令，Flask已经针对click库进行了集成，通过app.cli即可访问到click对象。<br> 下面是一个简单的命令测试</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate
<span class="token keyword">from</span> models <span class="token keyword">import</span> user
<span class="token keyword">import</span> click

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>
<span class="token comment"># 创建Migrate对象</span>
migrate <span class="token operator">=</span> Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span>db<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token string">"my-command"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">my_command</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"这是我的自定义命令！"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>通过装饰器@app.cli.command，将my_command函数添加到命令中，并且指定命令的名称为my-command。<br> 然后，再在pycharm的terminal中输入以下命令。</p> 
<pre><code class="prism language-python">flask my<span class="token operator">-</span>command
</code></pre> 
<p><img src="https://images2.imgbox.com/8c/9c/6s8HCrzk_o.png" alt="在这里插入图片描述"></p> 
<p>在app.py中，实现一个名叫create-permission的命令。<br> 针对每个模块分别添加一个权限。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask  
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate
<span class="token keyword">from</span> models<span class="token punctuation">.</span>user <span class="token keyword">import</span> PermissionEnum<span class="token punctuation">,</span>PermissionModel<span class="token punctuation">,</span>RoleModel
<span class="token keyword">import</span> click

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>
<span class="token comment"># 创建Migrate对象</span>
migrate <span class="token operator">=</span> Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span>db<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>

<span class="token comment"># 测试命令</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token string">"my-command"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">my_command</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"这是我的自定义命令！"</span><span class="token punctuation">)</span>

<span class="token comment"># 创建create-permission命令</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token string">"create-permission"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_permission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> permission_name <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>PermissionEnum<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> permission_name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"__"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        permission <span class="token operator">=</span> PermissionModel<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>PermissionEnum<span class="token punctuation">,</span>permission_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>permission<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"权限添加成功"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>然后，再在pycharm的terminal中输入以下命令。</p> 
<pre><code class="prism language-python">flask create<span class="token operator">-</span>permission
</code></pre> 
<p><img src="https://images2.imgbox.com/b1/0a/HOrX7Y66_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/f7/31/LxDeVBRz_o.png" alt="在这里插入图片描述"></p> 
<p>权限创建成功后，再添加角色。<br> 创建3个角色，分别为：稽查、运营、管理员。<br> 角色名，稽查，权限：帖子、评论<br> 角色名，运营，权限：板块、帖子、评论、前台用户<br> 角色名，管理员，权限：板块、帖子、评论、前台用户、后台用户</p> 
<p><strong>创建角色，同创建权限一样操作，下面只给出代码，执行步骤一致</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate
<span class="token keyword">from</span> models<span class="token punctuation">.</span>user <span class="token keyword">import</span> PermissionEnum<span class="token punctuation">,</span> PermissionModel<span class="token punctuation">,</span> RoleModel
<span class="token keyword">import</span> click

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>
<span class="token comment"># 创建Migrate对象</span>
migrate <span class="token operator">=</span> Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span> db<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>


<span class="token comment"># 测试命令</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token string">"my-command"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">my_command</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"这是我的自定义命令！"</span><span class="token punctuation">)</span>


<span class="token comment"># 创建添加权限的命令create-permission</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token string">"create-permission"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_permission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> permission_name <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>PermissionEnum<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> permission_name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"__"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        permission <span class="token operator">=</span> PermissionModel<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>PermissionEnum<span class="token punctuation">,</span> permission_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>permission<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"权限添加成功"</span><span class="token punctuation">)</span>


<span class="token comment"># 创建添加角色的命令create-role</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token string">"create-role"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_role</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 稽查</span>
    inspector <span class="token operator">=</span> RoleModel<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"稽查"</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"负责审核帖子和评论是否合法合规"</span><span class="token punctuation">)</span>
    inspector<span class="token punctuation">.</span>permissions <span class="token operator">=</span> PermissionModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>
        PermissionModel<span class="token punctuation">.</span>name<span class="token punctuation">.</span>in_<span class="token punctuation">(</span><span class="token punctuation">[</span>PermissionEnum<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> PermissionEnum<span class="token punctuation">.</span>COMMENT<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 运营</span>
    operator <span class="token operator">=</span> RoleModel<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"运营"</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"负责网站持续正常运营！"</span><span class="token punctuation">)</span>
    operator<span class="token punctuation">.</span>permissions <span class="token operator">=</span> PermissionModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>PermissionModel<span class="token punctuation">.</span>name<span class="token punctuation">.</span>in_<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>PermissionEnum<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> PermissionEnum<span class="token punctuation">.</span>COMMENT<span class="token punctuation">,</span> PermissionEnum<span class="token punctuation">.</span>BOARD<span class="token punctuation">,</span> PermissionEnum<span class="token punctuation">.</span>FRONT_USER<span class="token punctuation">,</span>
         PermissionEnum<span class="token punctuation">.</span>CMS_USER<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 管理员</span>
    administrator <span class="token operator">=</span> RoleModel<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"管理员"</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"负责整个网站所有工作！"</span><span class="token punctuation">)</span>
    administrator<span class="token punctuation">.</span>permissions <span class="token operator">=</span> PermissionModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span><span class="token punctuation">[</span>inspector<span class="token punctuation">,</span>operator<span class="token punctuation">,</span>administrator<span class="token punctuation">]</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"角色创建成功！"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 在pycharm中的terminal中运行</span>
flask create<span class="token operator">-</span>role
</code></pre> 
<p><img src="https://images2.imgbox.com/b0/59/eToGXEOv_o.png" alt="在这里插入图片描述"></p> 
<p><strong>对app.py进行瘦身，将command部分的代码放到commands.py里</strong></p> 
<pre><code class="prism language-python"><span class="token comment"># commands.py</span>
<span class="token keyword">from</span> models<span class="token punctuation">.</span>user <span class="token keyword">import</span> PermissionEnum<span class="token punctuation">,</span> PermissionModel<span class="token punctuation">,</span> RoleModel
<span class="token keyword">import</span> click
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db

<span class="token comment"># 测试命令</span>
<span class="token comment"># @app.cli.command("my-command")</span>
<span class="token keyword">def</span> <span class="token function">my_command</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"这是我的自定义命令！"</span><span class="token punctuation">)</span>


<span class="token comment"># 创建添加权限的命令create-permission</span>
<span class="token comment"># @app.cli.command("create-permission")</span>
<span class="token keyword">def</span> <span class="token function">create_permission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> permission_name <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>PermissionEnum<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> permission_name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"__"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        permission <span class="token operator">=</span> PermissionModel<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>PermissionEnum<span class="token punctuation">,</span> permission_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>permission<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"权限添加成功"</span><span class="token punctuation">)</span>


<span class="token comment"># 创建添加角色的命令create-role</span>
<span class="token comment"># @app.cli.command("create-role")</span>
<span class="token keyword">def</span> <span class="token function">create_role</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 稽查</span>
    inspector <span class="token operator">=</span> RoleModel<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"稽查"</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"负责审核帖子和评论是否合法合规"</span><span class="token punctuation">)</span>
    inspector<span class="token punctuation">.</span>permissions <span class="token operator">=</span> PermissionModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>
        PermissionModel<span class="token punctuation">.</span>name<span class="token punctuation">.</span>in_<span class="token punctuation">(</span><span class="token punctuation">[</span>PermissionEnum<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> PermissionEnum<span class="token punctuation">.</span>COMMENT<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 运营</span>
    operator <span class="token operator">=</span> RoleModel<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"运营"</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"负责网站持续正常运营！"</span><span class="token punctuation">)</span>
    operator<span class="token punctuation">.</span>permissions <span class="token operator">=</span> PermissionModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>PermissionModel<span class="token punctuation">.</span>name<span class="token punctuation">.</span>in_<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>PermissionEnum<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> PermissionEnum<span class="token punctuation">.</span>COMMENT<span class="token punctuation">,</span> PermissionEnum<span class="token punctuation">.</span>BOARD<span class="token punctuation">,</span> PermissionEnum<span class="token punctuation">.</span>FRONT_USER<span class="token punctuation">,</span>
         PermissionEnum<span class="token punctuation">.</span>CMS_USER<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 管理员</span>
    administrator <span class="token operator">=</span> RoleModel<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"管理员"</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"负责整个网站所有工作！"</span><span class="token punctuation">)</span>
    administrator<span class="token punctuation">.</span>permissions <span class="token operator">=</span> PermissionModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span><span class="token punctuation">[</span>inspector<span class="token punctuation">,</span>operator<span class="token punctuation">,</span>administrator<span class="token punctuation">]</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"角色创建成功！"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># app.py文件</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate
<span class="token comment"># 引入了命令</span>
<span class="token keyword">import</span> commands

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>
<span class="token comment"># 创建Migrate对象</span>
migrate <span class="token operator">=</span> Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span> db<span class="token punctuation">)</span>

<span class="token comment"># 添加命令</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-permission"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_permission<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-role"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_role<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"my-command"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>my_command<span class="token punctuation">)</span> <span class="token comment">#瘦身后，再次测试</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/a0/23/WU9FnpOx_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_639"></a>创建用户模型</h4> 
<p>UUID(universally unique identfier)<br> UUID的长度为32字符，再加上4个横线，总共有36个字符。<br> 引入python第三方库，shortuuid<br> shortuuid 会对原始UUID进行base57 编码，然后删除相似的字符，如：I，1，L，o和0，最后生成默认22位长度的字符串。</p> 
<pre><code class="prism language-python"><span class="token comment"># 安装shortuuid库</span>
pip install shortuuid
</code></pre> 
<p><strong>重构UserModel</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> exts <span class="token keyword">import</span> db
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum
<span class="token comment"># 引入shortuuid</span>
<span class="token keyword">from</span> shortuuid <span class="token keyword">import</span> uuid
<span class="token comment"># 引入加密和验证</span>
<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>security <span class="token keyword">import</span> generate_password_hash<span class="token punctuation">,</span>check_password_hash


<span class="token comment"># PermissionEnum 枚举类型</span>
<span class="token comment"># 存放权限类型的枚举</span>
<span class="token keyword">class</span> <span class="token class-name">PermissionEnum</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    BOARD <span class="token operator">=</span> <span class="token string">"板块"</span>
    POST <span class="token operator">=</span> <span class="token string">"帖子"</span>
    COMMENT <span class="token operator">=</span> <span class="token string">"评论"</span>
    FRONT_USER <span class="token operator">=</span> <span class="token string">"前台用户"</span>
    CMS_USER <span class="token operator">=</span> <span class="token string">"后台用户"</span>


<span class="token comment"># PermissionModel模型</span>
<span class="token comment"># name 从PermissionEnum 枚举取</span>
<span class="token keyword">class</span> <span class="token class-name">PermissionModel</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"permission"</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Enum<span class="token punctuation">(</span>PermissionEnum<span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token comment"># 中间表</span>
<span class="token comment"># role_id来引用role表</span>
<span class="token comment"># permission_id来引用permission表</span>
role_permission_table <span class="token operator">=</span> db<span class="token punctuation">.</span>Table<span class="token punctuation">(</span>
    <span class="token string">"role_permission_table"</span><span class="token punctuation">,</span>
    db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">"role_id"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"role.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">"permission_id"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"permission.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">RoleModel</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"role"</span>
    <span class="token comment"># 主键id</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># 角色名称</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># 角色描述</span>
    desc <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># 创建时间</span>
    create_time <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>
    <span class="token comment"># 关系属性（RoleModel和PermissionModel属于多对多关系）</span>
    <span class="token comment"># role_permission_table 中间表</span>
    permissions <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">"PermissionModel"</span><span class="token punctuation">,</span> secondary<span class="token operator">=</span>role_permission_table<span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">"roles"</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">UserModel</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"user"</span>
    <span class="token comment"># 主键</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>uuid<span class="token punctuation">)</span>
    <span class="token comment"># 用户名，不能为空，且值唯一</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># 密码，最大长度200，应该先加密再存储</span>
    _password <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># 邮箱，不能为空，且值唯一</span>
    email <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># 头像，存储图片在服务器中保存的路径，可以为空</span>
    avatar <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 签名，可以为空</span>
    signature <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 加入时间，第一次存储，默认当前时间</span>
    join_time <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>
    <span class="token comment"># 是否员工，只有员工才能进入后台系统，默认为False</span>
    is_staff <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否可用，默认情况下是可用</span>
    is_active <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    is_admin <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Boolean<span class="token punctuation">,</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token comment"># 外键</span>
    <span class="token comment"># 角色外键，引用role表的id字段</span>
    role_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span>db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"role.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 关系属性，引用RoleModel</span>
    role <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">"RoleModel"</span><span class="token punctuation">,</span>backref<span class="token operator">=</span><span class="token string">"users"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span><span class="token operator">*</span>args<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">"password"</span> <span class="token keyword">in</span> kwargs<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>password <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
            kwargs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UserModel<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">password</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_password

    <span class="token decorator annotation punctuation">@password<span class="token punctuation">.</span>setter</span>
    <span class="token keyword">def</span> <span class="token function">password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>raw_password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_password<span class="token operator">=</span>generate_password_hash<span class="token punctuation">(</span>raw_password<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">check_password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>raw_password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> check_password_hash<span class="token punctuation">(</span>self<span class="token punctuation">.</span>password<span class="token punctuation">,</span>raw_password<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
    <span class="token keyword">def</span> <span class="token function">has_permission</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>permission<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> permission <span class="token keyword">in</span> <span class="token punctuation">[</span>permission<span class="token punctuation">.</span>name <span class="token keyword">for</span> permisson <span class="token keyword">in</span> self<span class="token punctuation">.</span>role<span class="token punctuation">.</span>permissions<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 在terminal中运行</span>
flask db migrate <span class="token operator">-</span>m <span class="token string">"create user model"</span>
flask db upgrade
</code></pre> 
<p><img src="https://images2.imgbox.com/98/c7/nmm9tx9L_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d5/65/Nr4I2T6c_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_767"></a>创建测试用户</h4> 
<p>为了方便后续开发，按照角色个数创建3个员工账户。<br> 在commands.py文件中，添加以下代码</p> 
<pre><code class="prism language-python">
<span class="token comment">#     添加测试3个角色的测试用户</span>
<span class="token keyword">def</span> <span class="token function">create_test_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    admin_role <span class="token operator">=</span> RoleModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"管理员"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    zhangsan <span class="token operator">=</span> UserModel<span class="token punctuation">(</span>username <span class="token operator">=</span><span class="token string">"张三"</span><span class="token punctuation">,</span>email<span class="token operator">=</span><span class="token string">"zhangsan@zlkt.net"</span><span class="token punctuation">,</span>password<span class="token operator">=</span><span class="token string">"111111"</span><span class="token punctuation">,</span>is_staff<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>role<span class="token operator">=</span>admin_role<span class="token punctuation">)</span>

    operator_role <span class="token operator">=</span> RoleModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"运营"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lisi <span class="token operator">=</span> UserModel<span class="token punctuation">(</span>username <span class="token operator">=</span><span class="token string">"李四"</span><span class="token punctuation">,</span>email<span class="token operator">=</span><span class="token string">"lisi@zlkt.net"</span><span class="token punctuation">,</span>password<span class="token operator">=</span><span class="token string">"111111"</span><span class="token punctuation">,</span>is_staff<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>role<span class="token operator">=</span>operator_role<span class="token punctuation">)</span>

    inspector_role <span class="token operator">=</span> RoleModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"稽查"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    wangwu <span class="token operator">=</span> UserModel<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">"王五"</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">"wangwu@zlkt.net"</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">"111111"</span><span class="token punctuation">,</span> is_staff<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> role<span class="token operator">=</span>inspector_role<span class="token punctuation">)</span>

    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span><span class="token punctuation">[</span>zhangsan<span class="token punctuation">,</span>lisi<span class="token punctuation">,</span>wangwu<span class="token punctuation">]</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"测试用户添加成功！"</span><span class="token punctuation">)</span>

</code></pre> 
<p>在app.py中添加，以下代码：</p> 
<pre><code class="prism language-python"><span class="token comment"># 添加命令（增加3个角色测试用户）</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-test-user"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_test_user<span class="token punctuation">)</span>
</code></pre> 
<p>在pycharm的terminal中，运行命令</p> 
<pre><code class="prism language-python">flask create<span class="token operator">-</span>test<span class="token operator">-</span>user
</code></pre> 
<p><img src="https://images2.imgbox.com/05/37/00GDTd3u_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_808"></a>创建管理员</h4> 
<p>在commands.py中添加以下命令：</p> 
<pre><code class="prism language-python"><span class="token comment"># 创建管理员</span>
<span class="token decorator annotation punctuation">@click<span class="token punctuation">.</span>option</span><span class="token punctuation">(</span><span class="token string">"--username"</span><span class="token punctuation">,</span><span class="token string">'-u'</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@click<span class="token punctuation">.</span>option</span><span class="token punctuation">(</span><span class="token string">"--email"</span><span class="token punctuation">,</span><span class="token string">'-e'</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@click<span class="token punctuation">.</span>option</span><span class="token punctuation">(</span><span class="token string">"--password"</span><span class="token punctuation">,</span><span class="token string">'-p'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_admin</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>email<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">:</span>     
    admin_role <span class="token operator">=</span> RoleModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"管理员"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    admin_user <span class="token operator">=</span> UserModel<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">,</span>email<span class="token operator">=</span>email<span class="token punctuation">,</span>password<span class="token operator">=</span>password<span class="token punctuation">,</span>is_staff<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>role <span class="token operator">=</span> admin_role<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>admin_user<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    click<span class="token punctuation">.</span>echo<span class="token punctuation">(</span><span class="token string">"管理员创建成功"</span><span class="token punctuation">)</span>
</code></pre> 
<p>其中，通过@click.option装饰器添加了3个参数。<br> 以后在命令行中即可使用–username，–email，–password将用户名、邮箱、密码当作参数传递到函数中。</p> 
<h3><a id="_833"></a>注册</h3> 
<h4><a id="_835"></a>渲染注册模版</h4> 
<p>因，未直接下载书籍自带的源码，只能手动自行编辑。<br> 1、在根目录的static文件下，创建一个文件夹，名为：front<br> 2、在front文件夹下，创建一个文件夹，名为：css<br> 3、在css文件夹下，创建2个文件，分别为：base.css、sign.css</p> 
<p>1、再在根目录的templates文件夹下，创建一个文件夹，名为：front<br> 2、在front文件夹下，创建2个文件，分别为：base.html、register.html</p> 
<pre><code class="prism language-python"><span class="token comment"># base.html</span>
<span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>scrip src<span class="token operator">=</span><span class="token string">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>scrip<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.css"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='front/css/base.css') }}"</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block title <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
    <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block head <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>nav <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar navbar-expand-lg navbar-light bg-light"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-brand"</span><span class="token operator">&gt;</span>知了Python论坛<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-toggle"</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"button"</span> data<span class="token operator">-</span>toggle<span class="token operator">=</span><span class="token string">"collapse"</span> data<span class="token operator">-</span>target<span class="token operator">=</span><span class="token string">"#navbarSupportedContent"</span>
            aria<span class="token operator">-</span>controls<span class="token operator">=</span><span class="token string">"navbarSupportedContent"</span> aria<span class="token operator">-</span>expanded<span class="token operator">=</span><span class="token string">"false"</span> aria<span class="token operator">-</span>label<span class="token operator">=</span><span class="token string">"Toggle navigation"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-toggle-icon"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"collapse navbar-collapse"</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"navbarSupportedContent"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ul <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-nav mr-auto"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-item active"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span><span class="token operator">&gt;</span>首页 <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sr-only"</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>form <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-inline my-lg-0"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control mr-sm-2"</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"search"</span> placeholder<span class="token operator">=</span><span class="token string">"请输入关键字"</span> aria<span class="token operator">-</span>label<span class="token operator">=</span><span class="token string">"Search"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-outline-success my-2 my-sm-0"</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">&gt;</span>搜索<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ul <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-nav ml-4"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-item"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span><span class="token operator">&gt;</span>登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span><span class="token operator">&gt;</span>注册<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>nav<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"main-container"</span><span class="token operator">&gt;</span>
    <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block body <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> 
<p>base.html文件是所有前台页面的父模版<br> jquery.min.js:3.6.0版本的JQuery文件。JQuery文件可以快速寻找元素，发送AJAX请求<br> bootstrap.min.css:4.6.0 版本的bootstrap样式文件。可以快速构建网页界面。<br> bootstrap.min.js:4.6.0 版本的bootstrap JavaScript文件。BootStrap中的一些组件运行需要通过bootstrap.min.js来实现。</p> 
<pre><code class="prism language-python"><span class="token comment"># register.html</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> extends <span class="token string">'front/base.html'</span> <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block title <span class="token operator">%</span><span class="token punctuation">}</span>
    知了课堂注册
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block head <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='front/css/sign.css') }}"</span><span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block body <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>h1 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"page-title"</span><span class="token operator">&gt;</span>注册<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sign-box"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">""</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"register-form"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"input-group"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"email"</span> placeholder<span class="token operator">=</span><span class="token string">"邮箱"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"input-group-append"</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>button <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"captcha-btn"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-outline-secondary"</span><span class="token operator">&gt;</span>发送验证码<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"captcha"</span> placeholder<span class="token operator">=</span><span class="token string">"邮箱验证码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"username"</span> placeholder<span class="token operator">=</span><span class="token string">"用户名"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"password"</span> placeholder<span class="token operator">=</span><span class="token string">"密码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"confirm_password"</span> placeholder<span class="token operator">=</span><span class="token string">"确认密码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"signup-link"</span><span class="token operator">&gt;</span>返回登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"resetpwd-link"</span> style<span class="token operator">=</span><span class="token string">"float: right"</span><span class="token operator">&gt;</span>找回密码<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<p>在blueprints/user.py中，添加以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint<span class="token punctuation">,</span>render_template
bp <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span>__name__<span class="token punctuation">,</span>url_prefix<span class="token operator">=</span><span class="token string">"/user"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/register/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"front/register.html"</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="FlaskMail_958"></a>使用Flask-Mail发送邮箱验证码</h4> 
<h5><a id="FlaskMail_960"></a>安装Flask-Mail</h5> 
<p>在Pycharm的Terminal，输入并执行：<br> pip install flask-mail</p> 
<h5><a id="_965"></a>配置邮箱参数</h5> 
<pre><code class="prism language-python"><span class="token comment"># 以QQ邮箱为例，其QQ邮箱，POP3/IMAP/SMTP/Exchange/CardDAV授权，请查阅其他资料完成。</span>
</code></pre> 
<p>开启个人邮箱的SMTP服务后，在项目中，打开config.py文件，在DevelopmentConfig中添加以下代码。</p> 
<pre><code class="prism language-python"><span class="token comment"># 开发环境</span>
<span class="token keyword">class</span> <span class="token class-name">DevelopmentConfig</span><span class="token punctuation">(</span>BaseConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 配置连接数据库</span>
    HOSTNAME <span class="token operator">=</span> <span class="token string">'192.168.3.5'</span>  <span class="token comment"># 服务器地址</span>
    PORT <span class="token operator">=</span> <span class="token number">3306</span>  <span class="token comment"># 默认端口号</span>
    USERNAME <span class="token operator">=</span> <span class="token string">'root'</span>
    PASSWORD <span class="token operator">=</span> <span class="token string">'root'</span>
    DATABASE <span class="token operator">=</span> <span class="token string">'pythonbbs'</span>  <span class="token comment"># 数据库名</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"mysql+pymysql://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>USERNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PASSWORD<span class="token punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>HOSTNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PORT<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>DATABASE<span class="token punctuation">}</span></span><span class="token string">?charset=utf8mb4"</span></span>

    <span class="token comment"># 邮箱配置</span>
    MAIL_SERVER <span class="token operator">=</span> <span class="token string">"smtp.qq.com"</span>
    MAIL_USE_SSL <span class="token operator">=</span> <span class="token boolean">True</span>
    MAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_PORT <span class="token operator">=</span> <span class="token number">465</span>
    MAIL_USERNAME <span class="token operator">=</span> <span class="token string">"**@qq.com"</span> <span class="token comment"># 发送者邮箱</span>
    MAIL_PASSWORD <span class="token operator">=</span> <span class="token string">"****"</span> <span class="token comment"># SMTP授权码</span>
    MAIL_DEFAULT_SENDER <span class="token operator">=</span> <span class="token string">"**@qq.com"</span> <span class="token comment">#默认发送邮箱</span>
</code></pre> 
<h5><a id="_996"></a>发送邮件</h5> 
<p>在项目中，打开exts.py中，创建1个mail对象</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Mail

db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 创建1个mail对象</span>
mail <span class="token operator">=</span> Mail<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>回到，app.py文件，从exts.py中导入mail变量，并进行初始化。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db<span class="token punctuation">,</span>mail

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate
<span class="token comment"># 引入了命令</span>
<span class="token keyword">import</span> commands

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 初始化mail</span>
mail<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>
<span class="token comment"># 创建Migrate对象</span>
migrate <span class="token operator">=</span> Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span> db<span class="token punctuation">)</span>

<span class="token comment"># 添加命令</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-permission"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_permission<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-role"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_role<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"my-command"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>my_command<span class="token punctuation">)</span> <span class="token comment">#瘦身后，再次测试</span>
<span class="token comment"># 添加命令（增加3个角色测试用户）</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-test-user"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_test_user<span class="token punctuation">)</span>
<span class="token comment"># 创建管理员命令</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-admin"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_admin<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>完成Flask-Mail对象的初始化，后续就可使用mail变量发送邮件了。<br> 接着，在blueprints/user.py中输入以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint<span class="token punctuation">,</span> render_template
<span class="token comment"># 发送邮箱，引入的2个包</span>
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Message
<span class="token keyword">from</span> exts <span class="token keyword">import</span> mail

bp <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">"/user"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/register/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"front/register.html"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/mail/captcha/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mail_captcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token comment">#     recipients，填写接收者的邮箱地址</span>
<span class="token comment"># 可以写多个，用,逗号隔开。</span>
    message <span class="token operator">=</span> Message<span class="token punctuation">(</span>subject<span class="token operator">=</span><span class="token string">"我是邮件主题"</span><span class="token punctuation">,</span> recipients<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'***@outlook.com'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token string">"我是邮件内容"</span><span class="token punctuation">)</span>
    mail<span class="token punctuation">.</span>send<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"success"</span>

</code></pre> 
<p>运行，输入URL：http://127.0.0.1:5000/user/mail/captcha/</p> 
<p><img src="https://images2.imgbox.com/51/82/KvIIzGIz_o.png" alt="在这里插入图片描述"></p> 
<p>上面是测试，下面是针对项目验证码的代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request 
<span class="token keyword">import</span> random
<span class="token comment"># 发送邮箱，引入的2个包</span>
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Message
<span class="token keyword">from</span> exts <span class="token keyword">import</span> mail

bp <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">"/user"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/register/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"front/register.html"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/mail/captcha/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mail_catpcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    email <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">)</span>
    digits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">]</span>
    captcha <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>digits<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    body<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"[知了Python论坛]您的注册验证码是：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>captcha<span class="token punctuation">}</span></span><span class="token string">,请勿告诉别人！"</span></span>
    message <span class="token operator">=</span> Message<span class="token punctuation">(</span>subject<span class="token operator">=</span><span class="token string">"我是邮箱主题"</span><span class="token punctuation">,</span>recipients<span class="token operator">=</span><span class="token punctuation">[</span>email<span class="token punctuation">]</span><span class="token punctuation">,</span>body<span class="token operator">=</span>body<span class="token punctuation">)</span>
    mail<span class="token punctuation">.</span>send<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Succes"</span>
</code></pre> 
<h4><a id="FlaskCachingRedis_1119"></a>使用Flask-Caching和Redis缓存验证码</h4> 
<p>要在Python中使用Redis，首先需要安装Redis包。<br> 打开pyCharm中的terminal，输入以下命令：<br> pip install redis</p> 
<p>在Flask中使用Redis，可以借助第三方插件Flask-Caching实现。<br> 打开Pycharm中的Terminal,输入以下命令：<br> pip install flask-caching</p> 
<p>回到项目中，打开config.py文件<br> 在DevelopmentConfig中添加Flask-Caching的配置信息，如下所示：</p> 
<pre><code class="prism language-python"><span class="token comment"># 开发环境</span>
<span class="token keyword">class</span> <span class="token class-name">DevelopmentConfig</span><span class="token punctuation">(</span>BaseConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 配置连接数据库</span>
    HOSTNAME <span class="token operator">=</span> <span class="token string">'192.168.3.5'</span>  <span class="token comment"># 服务器地址</span>
    PORT <span class="token operator">=</span> <span class="token number">3306</span>  <span class="token comment"># 默认端口号</span>
    USERNAME <span class="token operator">=</span> <span class="token string">'root'</span>
    PASSWORD <span class="token operator">=</span> <span class="token string">'root'</span>
    DATABASE <span class="token operator">=</span> <span class="token string">'pythonbbs'</span>  <span class="token comment"># 数据库名</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"mysql+pymysql://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>USERNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PASSWORD<span class="token punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>HOSTNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PORT<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>DATABASE<span class="token punctuation">}</span></span><span class="token string">?charset=utf8mb4"</span></span>

    <span class="token comment"># 邮箱配置</span>
    MAIL_SERVER <span class="token operator">=</span> <span class="token string">"smtp.qq.com"</span>
    MAIL_USE_SSL <span class="token operator">=</span> <span class="token boolean">True</span>
    MAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_PORT <span class="token operator">=</span> <span class="token number">465</span>
    MAIL_USERNAME <span class="token operator">=</span> <span class="token string">"**@qq.com"</span> <span class="token comment"># 发送者邮箱</span>
    MAIL_PASSWORD <span class="token operator">=</span> <span class="token string">"****"</span> <span class="token comment"># SMTP授权码</span>
    MAIL_DEFAULT_SENDER <span class="token operator">=</span> <span class="token string">"**@qq.com"</span> <span class="token comment">#默认发送邮箱</span>
    
    <span class="token comment"># 缓存配置</span>
    CACHE_TYPE <span class="token operator">=</span> <span class="token string">"RedisCache"</span>
    CACHE_REDIS_HOST <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
    CACHE_REDIS_PORT <span class="token operator">=</span> <span class="token number">6379</span>

</code></pre> 
<p>在项目中，打开exts.py文件，然后输入以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Mail
<span class="token keyword">from</span> flask_caching <span class="token keyword">import</span> Cache

db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 创建1个mail对象</span>
mail <span class="token operator">=</span> Mail<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 创建1个Flask-Caching对象</span>
cache <span class="token operator">=</span> Cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>再回到app.py文件中，从exts.py文件中导入cache变量，并且进行初始化，代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db<span class="token punctuation">,</span>mail<span class="token punctuation">,</span>cache

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate
<span class="token comment"># 引入了命令</span>
<span class="token keyword">import</span> commands

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 初始化mail</span>
mail<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 初始化cache</span>
cache<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>
<span class="token comment"># 创建Migrate对象</span>
migrate <span class="token operator">=</span> Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span> db<span class="token punctuation">)</span>

<span class="token comment"># 添加命令</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-permission"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_permission<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-role"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_role<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"my-command"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>my_command<span class="token punctuation">)</span> <span class="token comment">#瘦身后，再次测试</span>
<span class="token comment"># 添加命令（增加3个角色测试用户）</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-test-user"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_test_user<span class="token punctuation">)</span>
<span class="token comment"># 创建管理员命令</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-admin"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_admin<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>Flask-Caching初始化完成后，就可以用它来缓存数据了。<br> 回到blueprints/user.py文件中<br> 先从exts.py文件中导入cache对象，然后将email.captcha代码修改如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request
<span class="token keyword">import</span> random
<span class="token comment"># 发送邮箱，引入的2个包</span>
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Message
<span class="token keyword">from</span> exts <span class="token keyword">import</span> mail<span class="token punctuation">,</span> cache

bp <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">"/user"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/register/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"front/register.html"</span><span class="token punctuation">)</span>


<span class="token comment"># # 测试使用</span>
<span class="token comment"># @bp.route('/mail/captcha/')</span>
<span class="token comment"># def mail_captcha():</span>
<span class="token comment">#     message = Message(subject="我是邮件主题", recipients=['*****@outlook.com'], body="我是邮件内容")</span>
<span class="token comment">#     mail.send(message)</span>
<span class="token comment">#     return "success"</span>

<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/mail/captcha/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mail_catpcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    email <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">)</span>
    digits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">]</span>
    captcha <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>digits<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    body <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"[知了Python论坛]您的注册验证码是：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>captcha<span class="token punctuation">}</span></span><span class="token string">,请勿告诉别人！"</span></span>
    message <span class="token operator">=</span> Message<span class="token punctuation">(</span>subject<span class="token operator">=</span><span class="token string">"我是邮箱主题"</span><span class="token punctuation">,</span> recipients<span class="token operator">=</span><span class="token punctuation">[</span>email<span class="token punctuation">]</span><span class="token punctuation">,</span> body<span class="token operator">=</span>body<span class="token punctuation">)</span>
    mail<span class="token punctuation">.</span>send<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> captcha<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Succes"</span>

</code></pre> 
<h4><a id="Celery__1264"></a>使用Celery 发送邮件</h4> 
<p>上述，可以实现发送邮件，但体验感不好<br> 1、发送邮件需要发起网络请求，必须要等邮件发送成功后，浏览器才能收到响应，用户等待长。<br> 2、发送邮件这种耗时操作，会导致线程被长时间占用，从而无法服务其他请求。<br> 通过异步方式来解决。<br> <br> Celery是一个任务调度框架，由纯python开发，有5大模块：<br> 1、Task（任务）<br> 2、Broker（中间人）<br> 3、Celery Beat（调度器）<br> 4、Worker（消费者）<br> 5、Backend（存储）</p> 
<p>Celery是一个第三方Python库，在Pycharm的terminal中输入以下命令来安装：<br> pip install celery</p> 
<p>首先在config.py下的 DevelopmentConfig中添加Broker和Backend配置信息，代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># 开发环境</span>
<span class="token keyword">class</span> <span class="token class-name">DevelopmentConfig</span><span class="token punctuation">(</span>BaseConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 配置连接数据库</span>
    HOSTNAME <span class="token operator">=</span> <span class="token string">'192.168.3.5'</span>  <span class="token comment"># 服务器地址</span>
    PORT <span class="token operator">=</span> <span class="token number">3306</span>  <span class="token comment"># 默认端口号</span>
    USERNAME <span class="token operator">=</span> <span class="token string">'root'</span>
    PASSWORD <span class="token operator">=</span> <span class="token string">'root'</span>
    DATABASE <span class="token operator">=</span> <span class="token string">'pythonbbs'</span>  <span class="token comment"># 数据库名</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"mysql+pymysql://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>USERNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PASSWORD<span class="token punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>HOSTNAME<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>PORT<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>DATABASE<span class="token punctuation">}</span></span><span class="token string">?charset=utf8mb4"</span></span>

    <span class="token comment"># 邮箱配置</span>
    MAIL_SERVER <span class="token operator">=</span> <span class="token string">"smtp.qq.com"</span>
    MAIL_USE_SSL <span class="token operator">=</span> <span class="token boolean">True</span>
    MAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_PORT <span class="token operator">=</span> <span class="token number">465</span>
    MAIL_USERNAME <span class="token operator">=</span> <span class="token string">"**@qq.com"</span> <span class="token comment"># 发送者邮箱</span>
    MAIL_PASSWORD <span class="token operator">=</span> <span class="token string">"****"</span> <span class="token comment"># SMTP授权码</span>
    MAIL_DEFAULT_SENDER <span class="token operator">=</span> <span class="token string">"**@qq.com"</span> <span class="token comment">#默认发送邮箱</span>
    
    <span class="token comment"># 缓存配置</span>
    CACHE_TYPE <span class="token operator">=</span> <span class="token string">"RedisCache"</span>
    CACHE_REDIS_HOST <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
    CACHE_REDIS_PORT <span class="token operator">=</span> <span class="token number">6379</span>
    
    <span class="token comment"># Celery配置</span>
    CELERY_BROKER_URL <span class="token operator">=</span> <span class="token string">"redis://127.0.0.1:6379/0"</span>
    CELERY_RESULT_BACKEND <span class="token operator">=</span> <span class="token string">"redis://127.0.0.1:6379/0"</span>
</code></pre> 
<p>在根目录下，创建一个bbs_celery.py文件，然后输入以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Message
<span class="token keyword">from</span> exts <span class="token keyword">import</span> mail
<span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery


<span class="token comment"># 定义任务函数</span>
<span class="token keyword">def</span> <span class="token function">send_mail</span><span class="token punctuation">(</span>recipient<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">:</span>
    message <span class="token operator">=</span> Message<span class="token punctuation">(</span>subject<span class="token operator">=</span>subject<span class="token punctuation">,</span> recipients<span class="token operator">=</span><span class="token punctuation">[</span>recipient<span class="token punctuation">]</span><span class="token punctuation">,</span> body<span class="token operator">=</span>body<span class="token punctuation">)</span>
    mail<span class="token punctuation">.</span>send<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"发送成功"</span><span class="token punctuation">)</span>


<span class="token comment"># 创建Celery对象</span>
<span class="token keyword">def</span> <span class="token function">make_celery</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    celery <span class="token operator">=</span> Celery<span class="token punctuation">(</span>app<span class="token punctuation">.</span>import_name<span class="token punctuation">,</span> backend<span class="token operator">=</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'CELERY_RESULT_BACKEND'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    broker<span class="token operator">=</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'CELERY_BROKER_URL'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    TaskBase <span class="token operator">=</span> celery<span class="token punctuation">.</span>Task

    <span class="token keyword">class</span> <span class="token class-name">ContextTask</span><span class="token punctuation">(</span>TaskBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
        abstract <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> app<span class="token punctuation">.</span>app_context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> TaskBase<span class="token punctuation">.</span>__call__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    celery<span class="token punctuation">.</span>Task <span class="token operator">=</span> ContextTask
    app<span class="token punctuation">.</span>celery <span class="token operator">=</span> celery

    <span class="token comment"># 添加任务</span>
    celery<span class="token punctuation">.</span>task<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"send_mail"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>send_mail<span class="token punctuation">)</span>
    <span class="token keyword">return</span> celery
</code></pre> 
<p>在app.py中导入make_celery函数，并创建1个Celery对象</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db<span class="token punctuation">,</span>mail<span class="token punctuation">,</span>cache

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate
<span class="token comment"># 引入了命令</span>
<span class="token keyword">import</span> commands
<span class="token comment"># 导入make_celery函数，并创建1个Celery对象</span>
<span class="token keyword">from</span> bbs_celery <span class="token keyword">import</span> make_celery

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 初始化mail</span>
mail<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 初始化cache</span>
cache<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 构建celery</span>
celery <span class="token operator">=</span> make_celery<span class="token punctuation">(</span>app<span class="token punctuation">)</span>


<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>
<span class="token comment"># 创建Migrate对象</span>
migrate <span class="token operator">=</span> Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span> db<span class="token punctuation">)</span>

<span class="token comment"># 添加命令</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-permission"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_permission<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-role"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_role<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"my-command"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>my_command<span class="token punctuation">)</span> <span class="token comment">#瘦身后，再次测试</span>
<span class="token comment"># 添加命令（增加3个角色测试用户）</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-test-user"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_test_user<span class="token punctuation">)</span>
<span class="token comment"># 创建管理员命令</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-admin"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_admin<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>回到blueprints/user.py的email_captcha视图函数中，把之前的发送邮件代码删除，改成celery任务的方式发送。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> current_app
<span class="token keyword">import</span> random
<span class="token comment"># 发送邮箱，引入的2个包</span>
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Message
<span class="token keyword">from</span> exts <span class="token keyword">import</span> mail<span class="token punctuation">,</span> cache

bp <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">"/user"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/register/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"front/register.html"</span><span class="token punctuation">)</span>
<span class="token comment"># @bp.route('/mail/captcha/')</span>
<span class="token comment"># def mail_catpcha():</span>
<span class="token comment">#     email = request.args.get("mail")</span>
<span class="token comment">#     digits = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"]</span>
<span class="token comment">#     captcha = "".join(random.sample(digits, 4))</span>
<span class="token comment">#     body = f"[知了Python论坛]您的注册验证码是：{captcha},请勿告诉别人！"</span>
<span class="token comment">#     message = Message(subject="我是邮箱主题", recipients=[email], body=body)</span>
<span class="token comment">#     mail.send(message)</span>
<span class="token comment">#     cache.set(email, captcha, timeout=100)</span>
<span class="token comment">#     return "Succes"</span>

<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/mail/captcha/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mail_catpcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    email <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">)</span>
    digits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">]</span>
    captcha <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>digits<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    subject <span class="token operator">=</span> <span class="token string">"[知了Python论坛]注册验证码"</span>
    body <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"[知了Python论坛]您的注册验证码是：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>captcha<span class="token punctuation">}</span></span><span class="token string">,请勿告诉别人！"</span></span>
    current_app<span class="token punctuation">.</span>celery<span class="token punctuation">.</span>send_task<span class="token punctuation">(</span><span class="token string">"send_mail"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>email<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">)</span>
    cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> captcha<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Succes"</span>
</code></pre> 
<p>运行Celery，需要安装另外一个第三方python库：<br> pip install gevent</p> 
<p>在pycharm的terminal中，输入以下命令，启动cerely：<br> celery -A app.celery worker -l info<br> <br> <img src="https://images2.imgbox.com/26/cb/NOhwgkvK_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="Redis_1453"></a>配置Redis</h5> 
<p><strong>Mac电脑配置Redis参考：<a href="https://blog.csdn.net/m0_48936146/article/details/126304417?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-126304417-blog-130875087.235%5Ev38%5Epc_relevant_anti_t3&amp;spm=1001.2101.3001.4242.2&amp;utm_relevant_index=4">参考链接</a></strong></p> 
<pre><code class="prism language-python">【记录下这里关闭Redis报错】Mac上使用Redis无法写入快照或者 
Error trying to save the DB<span class="token punctuation">,</span> can‘t exit<span class="token punctuation">.</span>
</code></pre> 
<p>Mac上使用Redis无法写入快照或者 Error trying to save the DB, can‘t exit.<br> 参考：<a href="https://blog.csdn.net/m0_53370288/article/details/117416009">https://blog.csdn.net/m0_53370288/article/details/117416009</a></p> 
<h5><a id="Redis_Desktop_Manager_1466"></a>安装Redis Desktop Manager</h5> 
<p>下载地址：<a href="https://www.macyy.cn/archives/1343#J_DLIPPCont" rel="nofollow">https://www.macyy.cn/archives/1343#J_DLIPPCont</a><br> <br> 安装后，打开，并连接；<br> <img src="https://images2.imgbox.com/fe/74/lAJ7NXmD_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="RESTful_API_1474"></a>RESTful API</h4> 
<p>RESTful 也叫做REST（representational state transfer，表现层状态转换）<br> 在项目根目录下，创建1个名叫：utils的包，用于存放一些工具类模块。<br> 接着，在utils包下，创建1个restful.py的文件，代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> jsonify


<span class="token keyword">class</span> <span class="token class-name">HttpCode</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 响应正常</span>
    ok <span class="token operator">=</span> <span class="token number">200</span>
    <span class="token comment"># 登录错误</span>
    unloginerror <span class="token operator">=</span> <span class="token number">401</span>
    <span class="token comment"># 权限错误</span>
    permissionerror <span class="token operator">=</span> <span class="token number">403</span>
    <span class="token comment"># 客户端参数错误</span>
    paramserror <span class="token operator">=</span> <span class="token number">400</span>
    <span class="token comment"># 服务器错误</span>
    servererror <span class="token operator">=</span> <span class="token number">500</span>


<span class="token keyword">def</span> <span class="token function">_restful_result</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> message<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"message"</span><span class="token punctuation">:</span> message <span class="token keyword">or</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> data <span class="token keyword">or</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code


<span class="token keyword">def</span> <span class="token function">ok</span><span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> _restful_result<span class="token punctuation">(</span>code<span class="token operator">=</span>HttpCode<span class="token punctuation">.</span>ok<span class="token punctuation">,</span> message<span class="token operator">=</span>message<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">unlogin_error</span><span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"没有登录！"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> _restful_result<span class="token punctuation">(</span>code<span class="token operator">=</span>HttpCode<span class="token punctuation">.</span>unloginerror<span class="token punctuation">,</span> message<span class="token operator">=</span>message<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">permission_error</span><span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"没有权限！"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> _restful_result<span class="token punctuation">(</span>code<span class="token operator">=</span>HttpCode<span class="token punctuation">.</span>permissionerror<span class="token punctuation">,</span> message<span class="token operator">=</span>message<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">params_error</span><span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"参数错误！"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> _restful_result<span class="token punctuation">(</span>code<span class="token operator">=</span>HttpCode<span class="token punctuation">.</span>paramserror<span class="token punctuation">,</span> message<span class="token operator">=</span>message<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">server_error</span><span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"服务器错误！"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> _restful_result<span class="token punctuation">(</span>code<span class="token operator">=</span>HttpCode<span class="token punctuation">.</span>servererror<span class="token punctuation">,</span> message<span class="token operator">=</span>message <span class="token keyword">or</span> <span class="token string">"服务器内部错误"</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> 
<p>将blueprints/user.py中的email_captcha的代码修改如下：</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/mail/captcha/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mail_catpcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        email <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">)</span>
        digits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">]</span>
        captcha <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>digits<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        subject <span class="token operator">=</span> <span class="token string">"[知了Python论坛]注册验证码"</span>
        body <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"[知了Python论坛]您的注册验证码是：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>captcha<span class="token punctuation">}</span></span><span class="token string">,请勿告诉别人！"</span></span>
        current_app<span class="token punctuation">.</span>celery<span class="token punctuation">.</span>send_task<span class="token punctuation">(</span><span class="token string">"send_mail"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>email<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> captcha<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> restful<span class="token punctuation">.</span>ok<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> restful<span class="token punctuation">.</span>server_error<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="CSRF_1542"></a>CSRF保护</h4> 
<p>开启CSRF保护需要使用flask-wtf中的CSRFProtect <br> 首先，在pycharm的Terminal下输入安装flask-wtf命令：</p> 
<pre><code class="prism language-python">pip install flask<span class="token operator">-</span>wtf
</code></pre> 
<p>回到app.py中，添加以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask 
<span class="token keyword">import</span> config
<span class="token keyword">from</span> exts <span class="token keyword">import</span> db<span class="token punctuation">,</span>mail<span class="token punctuation">,</span>cache

<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>cms <span class="token keyword">import</span> bp <span class="token keyword">as</span> cms_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>front <span class="token keyword">import</span> bp <span class="token keyword">as</span> front_bp
<span class="token keyword">from</span> blueprints<span class="token punctuation">.</span>user <span class="token keyword">import</span> bp <span class="token keyword">as</span> user_bp

<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate
<span class="token comment"># 引入了命令</span>
<span class="token keyword">import</span> commands
<span class="token comment"># 导入make_celery函数，并创建1个Celery对象</span>
<span class="token keyword">from</span> bbs_celery <span class="token keyword">import</span> make_celery
<span class="token comment"># 导入CSRF</span>
<span class="token keyword">from</span> flask_wtf <span class="token keyword">import</span> CSRFProtect

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
<span class="token comment"># 引入开发环境</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">.</span>DevelopmentConfig<span class="token punctuation">)</span>
<span class="token comment"># 初始化db</span>
db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 初始化mail</span>
mail<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 初始化cache</span>
cache<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># 构建celery</span>
celery <span class="token operator">=</span> make_celery<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token comment"># CSRF保护</span>
CSRFProtect<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token comment"># 注册蓝图</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cms_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>front_bp<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user_bp<span class="token punctuation">)</span>
<span class="token comment"># 创建Migrate对象</span>
migrate <span class="token operator">=</span> Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span> db<span class="token punctuation">)</span>

<span class="token comment"># 添加命令</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-permission"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_permission<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-role"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_role<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"my-command"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>my_command<span class="token punctuation">)</span> <span class="token comment">#瘦身后，再次测试</span>
<span class="token comment"># 添加命令（增加3个角色测试用户）</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-test-user"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_test_user<span class="token punctuation">)</span>
<span class="token comment"># 创建管理员命令</span>
app<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string">"create-admin"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span>create_admin<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>---------------------------------------------------------------------------

ModuleNotFoundError                       Traceback (most recent call last)

Cell In[9], line 2
      1 from flask import Flask
----&gt; 2 import config
      3 from exts import db,mail,cache
      5 from blueprints.cms import bp as cms_bp


ModuleNotFoundError: No module named 'config'
</code></pre> 
<p>在templates/front/register.html的form标签下添加以下代码：</p> 
<pre><code class="prism language-python"> <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"hidden"</span> name<span class="token operator">=</span><span class="token string">"crsf_token"</span> value<span class="token operator">=</span><span class="token string">"{<!-- -->{ csrf_token() }}"</span><span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="AJAX_1632"></a>使用AJAX获取邮箱验证码</h4> 
<p>在static/common下，创建1个名为：zlajax.js文件，这样每次发送非GET请求都不需要手动设置csrf_token了。具体代码如下：</p> 
<pre><code class="prism language-python">var zlajax <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'get'</span><span class="token punctuation">:</span> function <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        args<span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"get"</span>
        <span class="token keyword">return</span> this<span class="token punctuation">.</span>ajax<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'post'</span><span class="token punctuation">:</span> function <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        args<span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"post"</span>
        <span class="token keyword">return</span> this<span class="token punctuation">.</span>ajax<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'put'</span><span class="token punctuation">:</span> function <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        args<span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"put"</span>
        <span class="token keyword">return</span> this<span class="token punctuation">.</span>ajax<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'delete'</span><span class="token punctuation">:</span> function <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        args<span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"delete"</span>
        <span class="token keyword">return</span> this<span class="token punctuation">.</span>ajax<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'ajax'</span><span class="token punctuation">:</span> function <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        this<span class="token punctuation">.</span>_ajaxSetup<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> $<span class="token punctuation">.</span>ajax<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'_ajaxSetup'</span><span class="token punctuation">:</span> function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $<span class="token punctuation">.</span>ajaxSetup<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token string">'beforeSend'</span><span class="token punctuation">:</span> function <span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> settings<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>!<span class="token operator">/</span><span class="token operator">^</span><span class="token punctuation">(</span>GET<span class="token operator">|</span>HEAD<span class="token operator">|</span>OPTIONS<span class="token operator">|</span>TRACE<span class="token punctuation">)</span>$<span class="token operator">/</span>i<span class="token punctuation">.</span>test<span class="token punctuation">(</span>settings<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> !this<span class="token punctuation">.</span>crossDomain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        var csrftoken <span class="token operator">=</span> $<span class="token punctuation">(</span><span class="token string">'meta[name=csrf-token]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>attr<span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        xhr<span class="token punctuation">.</span>setRequestHeader<span class="token punctuation">(</span><span class="token string">"X-CSRFToken"</span><span class="token punctuation">,</span> csrftoken<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>将zlajax.js文件放到templates/front/base.html的head标签里，这样后面所有的页面都能使用这个文件里。代码如下：</p> 
<pre><code class="prism language-python"><span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>scrip src<span class="token operator">=</span><span class="token string">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>scrip<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.css"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='common/zlajax.js') }}"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='front/css/base.css') }}"</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block title <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
    <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block head <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>nav <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar navbar-expand-lg navbar-light bg-light"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-brand"</span><span class="token operator">&gt;</span>知了Python论坛<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-toggle"</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"button"</span> data<span class="token operator">-</span>toggle<span class="token operator">=</span><span class="token string">"collapse"</span> data<span class="token operator">-</span>target<span class="token operator">=</span><span class="token string">"#navbarSupportedContent"</span>
            aria<span class="token operator">-</span>controls<span class="token operator">=</span><span class="token string">"navbarSupportedContent"</span> aria<span class="token operator">-</span>expanded<span class="token operator">=</span><span class="token string">"false"</span> aria<span class="token operator">-</span>label<span class="token operator">=</span><span class="token string">"Toggle navigation"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-toggle-icon"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"collapse navbar-collapse"</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"navbarSupportedContent"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ul <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-nav mr-auto"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-item active"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span><span class="token operator">&gt;</span>首页 <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sr-only"</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>form <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-inline my-lg-0"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control mr-sm-2"</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"search"</span> placeholder<span class="token operator">=</span><span class="token string">"请输入关键字"</span> aria<span class="token operator">-</span>label<span class="token operator">=</span><span class="token string">"Search"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-outline-success my-2 my-sm-0"</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">&gt;</span>搜索<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ul <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"navbar-nav ml-4"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-item"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span><span class="token operator">&gt;</span>登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav-link"</span><span class="token operator">&gt;</span>注册<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>nav<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"main-container"</span><span class="token operator">&gt;</span>
    <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block body <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-python">因为zlajax<span class="token punctuation">.</span>js依赖JQuery，所以必须把zlajax<span class="token punctuation">.</span>js放到jQuery文件后面。<span class="token operator">&lt;</span><span class="token operator">/</span>br<span class="token operator">&gt;</span>
在static<span class="token operator">/</span>front<span class="token operator">/</span>js下创建<span class="token number">1</span>个register<span class="token punctuation">.</span>js文件，用于绑定“发送验证码”按钮的单击时间，并且自信AJAX请求。代码如下：
</code></pre> 
<pre><code class="prism language-python">$<span class="token punctuation">(</span>function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    $<span class="token punctuation">(</span><span class="token string">'#captcha-btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> function <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        event<span class="token punctuation">.</span>preventDefault<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">//</span>   获取邮箱
        var email <span class="token operator">=</span> $<span class="token punctuation">(</span><span class="token string">"input[name='email']"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>val<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        zlajax<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            url<span class="token punctuation">:</span> <span class="token string">"/user/mail/captcha?mail="</span> <span class="token operator">+</span> email
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>done<span class="token punctuation">(</span>function <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            alert<span class="token punctuation">(</span><span class="token string">"验证码发送成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fail<span class="token punctuation">(</span>function <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            alert<span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>上述代码：id为captcha-btn的按钮绑定了单击事件。<br> 单击按钮后，先是获取用户输入的邮箱，然后通过zlajax.get方法发送请求，URL不需要带域名，向以/开头的URL发送请求，浏览器会自动使员工当前域名。<br> 如果请求成功，会执行done函数，如果请求失败，会执行fail函数。<br> 由于js文件必须要加载到模版中才能生效，所以，打开templates/front/register.html文件，将head这个block的中代码修改如下：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> extends <span class="token string">'front/base.html'</span> <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block title <span class="token operator">%</span><span class="token punctuation">}</span>
    知了课堂注册
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block head <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='front/css/sign.css') }}"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='front/js/register.js') }}"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block body <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>h1 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"page-title"</span><span class="token operator">&gt;</span>注册<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sign-box"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">""</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"register-form"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"input-group"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"email"</span> placeholder<span class="token operator">=</span><span class="token string">"邮箱"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"input-group-append"</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>button <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"captcha-btn"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-outline-secondary"</span><span class="token operator">&gt;</span>发送验证码<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"captcha"</span> placeholder<span class="token operator">=</span><span class="token string">"邮箱验证码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"username"</span> placeholder<span class="token operator">=</span><span class="token string">"用户名"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"password"</span> placeholder<span class="token operator">=</span><span class="token string">"密码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"confirm_password"</span> placeholder<span class="token operator">=</span><span class="token string">"确认密码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"signup-link"</span><span class="token operator">&gt;</span>返回登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"resetpwd-link"</span> style<span class="token operator">=</span><span class="token string">"float: right"</span><span class="token operator">&gt;</span>找回密码<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1800"></a>实现注册功能</h4> 
<p>首先，在templates/front/register.html中的form标签上添加action和method属性。代码如下：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> extends <span class="token string">'front/base.html'</span> <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block title <span class="token operator">%</span><span class="token punctuation">}</span>
    知了课堂注册
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block head <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='front/css/sign.css') }}"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='front/js/register.js') }}"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block body <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>h1 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"page-title"</span><span class="token operator">&gt;</span>注册<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sign-box"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('user.register') }}"</span> method<span class="token operator">=</span><span class="token string">"post"</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"register-form"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"input-group"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"email"</span> placeholder<span class="token operator">=</span><span class="token string">"邮箱"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"input-group-append"</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>button <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"captcha-btn"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-outline-secondary"</span><span class="token operator">&gt;</span>发送验证码<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"captcha"</span> placeholder<span class="token operator">=</span><span class="token string">"邮箱验证码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"username"</span> placeholder<span class="token operator">=</span><span class="token string">"用户名"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"password"</span> placeholder<span class="token operator">=</span><span class="token string">"密码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"confirm_password"</span> placeholder<span class="token operator">=</span><span class="token string">"确认密码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"signup-link"</span><span class="token operator">&gt;</span>返回登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"resetpwd-link"</span> style<span class="token operator">=</span><span class="token string">"float: right"</span><span class="token operator">&gt;</span>找回密码<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> 
<p>表单通常用POST方法，把表单数据提交到视图函数后，需要对先对表单数据做验证，在根目录下，插件一个名叫：forms的Python Package，然后插件user.py文件，代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> wtforms <span class="token keyword">import</span> Form<span class="token punctuation">,</span> StringField<span class="token punctuation">,</span> ValidationError 
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>validators <span class="token keyword">import</span> Email<span class="token punctuation">,</span> EqualTo<span class="token punctuation">,</span> Length
<span class="token keyword">from</span> exts <span class="token keyword">import</span> cache
<span class="token keyword">from</span> models<span class="token punctuation">.</span>user <span class="token keyword">import</span> UserModel


<span class="token keyword">class</span> <span class="token class-name">RegisterForm</span><span class="token punctuation">(</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>
    email <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>Email<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"请输入正确格式的邮箱！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    captcha <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"请输入正确格式的验证码！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"请输入正确格式的用户名！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"请输入正确长度的密码！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    confirm_password <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>EqualTo<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"两次密码不一致！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">validate_email</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>field<span class="token punctuation">)</span><span class="token punctuation">:</span>
        email <span class="token operator">=</span> field<span class="token punctuation">.</span>data
        user <span class="token operator">=</span> UserModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>email<span class="token operator">=</span>email<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> user<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"邮箱已存在"</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">validate_captcha</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>field<span class="token punctuation">)</span><span class="token punctuation">:</span>
        captcha <span class="token operator">=</span> field<span class="token punctuation">.</span>data
        email <span class="token operator">=</span> self<span class="token punctuation">.</span>email<span class="token punctuation">.</span>data
        cache_captcha <span class="token operator">=</span> cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>email<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> cache_captcha <span class="token keyword">or</span> captcha <span class="token operator">!=</span> cache_captcha<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"验证码错误！"</span><span class="token punctuation">)</span>
</code></pre> 
<p>创建了一个RegisterForm表单类，然后定义了email等5个字段，并分别指定了验证器，其中email验证器必须要安装第三方python库email_validator，在pycharm的terminal中，输入： pip install email_validator，进行安装。</p> 
<p>考虑到以后在视图函数中的表单验证失败后，需要吧错误信息传递到模版中，定一个父类，用于从form.errors中提取所有字符串类型的错误信息。<br> 在根目录下的forms文件下新建一个baseform.py文件。然后输入一下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> wtforms <span class="token keyword">import</span> Form


<span class="token keyword">class</span> <span class="token class-name">BaseForm</span><span class="token punctuation">(</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">message</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        message_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>errors<span class="token punctuation">:</span>
            <span class="token keyword">for</span> errors <span class="token keyword">in</span> self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                message_list<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>errors<span class="token punctuation">)</span>
        <span class="token keyword">return</span> message_list

</code></pre> 
<p>将RegisterFrom的继承关系修改如霞：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> wtforms <span class="token keyword">import</span> Form<span class="token punctuation">,</span> StringField<span class="token punctuation">,</span> ValidationError 
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>validators <span class="token keyword">import</span> Email<span class="token punctuation">,</span> EqualTo<span class="token punctuation">,</span> Length
<span class="token keyword">from</span> exts <span class="token keyword">import</span> cache
<span class="token keyword">from</span> models<span class="token punctuation">.</span>user <span class="token keyword">import</span> UserModel
<span class="token keyword">from</span> <span class="token punctuation">.</span>baseform <span class="token keyword">import</span> BaseForm


<span class="token keyword">class</span> <span class="token class-name">RegisterForm</span><span class="token punctuation">(</span>BaseForm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    email <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>Email<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"请输入正确格式的邮箱！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    captcha <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"请输入正确格式的验证码！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"请输入正确格式的用户名！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>Length<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"请输入正确长度的密码！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    confirm_password <span class="token operator">=</span> StringField<span class="token punctuation">(</span>validators<span class="token operator">=</span><span class="token punctuation">[</span>EqualTo<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"两次密码不一致！"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">validate_email</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>field<span class="token punctuation">)</span><span class="token punctuation">:</span>
        email <span class="token operator">=</span> field<span class="token punctuation">.</span>data
        user <span class="token operator">=</span> UserModel<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>email<span class="token operator">=</span>email<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> user<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"邮箱已存在"</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">validate_captcha</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>field<span class="token punctuation">)</span><span class="token punctuation">:</span>
        captcha <span class="token operator">=</span> field<span class="token punctuation">.</span>data
        email <span class="token operator">=</span> self<span class="token punctuation">.</span>email<span class="token punctuation">.</span>data
        cache_captcha <span class="token operator">=</span> cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>email<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> cache_captcha <span class="token keyword">or</span> captcha <span class="token operator">!=</span> cache_captcha<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"验证码错误！"</span><span class="token punctuation">)</span>
</code></pre> 
<p>下面，再把RegisterForm导入blueprints/user.py，完善register视图函数，代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> current_app<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> url_for<span class="token punctuation">,</span> flash
<span class="token keyword">import</span> random
<span class="token comment"># 发送邮箱，引入的2个包</span>
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Message
<span class="token keyword">from</span> exts <span class="token keyword">import</span> mail<span class="token punctuation">,</span> cache<span class="token punctuation">,</span> db
<span class="token comment"># 导入工具类</span>
<span class="token keyword">from</span> utils <span class="token keyword">import</span> restful

<span class="token keyword">from</span> forms<span class="token punctuation">.</span>user <span class="token keyword">import</span> RegisterForm
<span class="token keyword">from</span> models<span class="token punctuation">.</span>user <span class="token keyword">import</span> UserModel

bp <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">"/user"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/register/"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"front/register.html"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> RegisterForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>form<span class="token punctuation">)</span>
        <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            email <span class="token operator">=</span> form<span class="token punctuation">.</span>email<span class="token punctuation">.</span>data
            username <span class="token operator">=</span> form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data
            password <span class="token operator">=</span> form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data

            user <span class="token operator">=</span> UserModel<span class="token punctuation">(</span>email<span class="token operator">=</span>email<span class="token punctuation">,</span> username<span class="token operator">=</span>username<span class="token punctuation">,</span> password<span class="token operator">=</span>password<span class="token punctuation">)</span>
            db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
            db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'user.login'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> message <span class="token keyword">in</span> form<span class="token punctuation">.</span>messages<span class="token punctuation">:</span>
                flash<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"user.register"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"login"</span>


<span class="token decorator annotation punctuation">@bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/mail/captcha/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mail_catpcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        email <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">)</span>
        digits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">]</span>
        captcha <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>digits<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        subject <span class="token operator">=</span> <span class="token string">"[知了Python论坛]注册验证码"</span>
        body <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"[知了Python论坛]您的注册验证码是：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>captcha<span class="token punctuation">}</span></span><span class="token string">,请勿告诉别人！"</span></span>
        current_app<span class="token punctuation">.</span>celery<span class="token punctuation">.</span>send_task<span class="token punctuation">(</span><span class="token string">"send_mail"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>email<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> captcha<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> restful<span class="token punctuation">.</span>ok<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> restful<span class="token punctuation">.</span>server_error<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>表单验证失败的情况下，由于视图函数已经把错误消息添加到flash中，所以模版中可以通过get_flashed_messages获取所有的错误消息。<br> 在templates/front/register.html中的“立即注册”按钮桑拿添加以下代码：</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token operator">%</span> extends <span class="token string">'front/base.html'</span> <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block title <span class="token operator">%</span><span class="token punctuation">}</span>
    知了课堂注册
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block head <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='front/css/sign.css') }}"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('static',filename='front/js/register.js') }}"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> block body <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>h1 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"page-title"</span><span class="token operator">&gt;</span>注册<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sign-box"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">"{<!-- -->{ url_for('user.register') }}"</span> method<span class="token operator">=</span><span class="token string">"post"</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"register-form"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"input-group"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"email"</span> placeholder<span class="token operator">=</span><span class="token string">"邮箱"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"input-group-append"</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>button <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"captcha-btn"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-outline-secondary"</span><span class="token operator">&gt;</span>发送验证码<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"captcha"</span> placeholder<span class="token operator">=</span><span class="token string">"邮箱验证码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"username"</span> placeholder<span class="token operator">=</span><span class="token string">"用户名"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"password"</span> placeholder<span class="token operator">=</span><span class="token string">"密码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span> name<span class="token operator">=</span><span class="token string">"confirm_password"</span> placeholder<span class="token operator">=</span><span class="token string">"确认密码"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

            <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> <span class="token keyword">with</span> messages<span class="token operator">=</span>get_flashed_messages<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">}</span>
                <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> <span class="token keyword">if</span> messahes <span class="token operator">%</span><span class="token punctuation">}</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
                            <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> messages <span class="token operator">%</span><span class="token punctuation">}</span>
                                <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"text-danger"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> message <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
                            <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
                        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span>
            <span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endwith <span class="token operator">%</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-warning btn-block"</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"submit-btn"</span><span class="token operator">&gt;</span>立即注册<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"signup-link"</span><span class="token operator">&gt;</span>返回登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"resetpwd-link"</span> style<span class="token operator">=</span><span class="token string">"float: right"</span><span class="token operator">&gt;</span>找回密码<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c47e2c8585cbb706685f3818b3b896d9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MyCat 2全套学习笔记（完整配置【主从&#43;集群】&#43;理论解析 &#43; 大厂真实业务理解）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0874569a6f17e0b295b6ec5cffb6bf0f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux下采集摄像头的图像再保存为JPG图片存放到本地(YUYV转JPG)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>