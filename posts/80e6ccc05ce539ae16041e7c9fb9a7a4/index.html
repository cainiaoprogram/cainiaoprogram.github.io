<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>stm32使用串口进行通讯之发送数据 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="stm32使用串口进行通讯之发送数据" />
<meta property="og:description" content="前提准备： 1.库函数基础模板
2.stlink下载器、USB-TTL下载器、单片机最小开发板stm32F103C8T6
3.面包板及相关接线
4.vscode与keil的联合开发更流畅
5.串口软件，这个下面视频有
本文基于 哔哩哔哩 江科大自化协STM32入门教学
知识讲的非常详细，非常感谢作者的无私奉献，本文主要是基于此进行试验笔记。便于以后查找。
1.在库函数模板的前提下，在工程文件下新建文件夹Hardware,然后在keil中将文件目录加一下，Hardware文件下的文件也可以在keil下添加，添加时注意文件目录。保存关闭keil，打开VScode显示以下文件说明添加成功。具体步骤就不详细说明了，写过LED灯的应该都有了解。
2.在Hardware中添加文件夹Serial.c用来配置串口发送数据函数
首先是配置GPIO时钟以及USART时钟
void Serial_Init(void) { GPIO_InitTypeDef GPIO_InitStructure; USART_InitTypeDef USART_InitStructure; //定义USART结构体 RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1,ENABLE); //开启时钟 RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENABLE); GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP; //复用推挽输出 USART1 TX使用 GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; GPIO_Init(GPIOA,&amp;GPIO_InitStructure); USART_InitStructure.USART_BaudRate = 9600; //设置波特率9600，init函数内部会自动算好9600对应的分频系数 USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None; //硬件流控制，不启用 USART_InitStructure.USART_Mode = USART_Mode_Tx; //USART模式：发送数据 USART_InitStructure.USART_Parity = USART_Parity_No; //校验位：无校验 USART_InitStructure.USART_StopBits = USART_StopBits_1; //停止位1 USART_InitStructure.USART_WordLength = USART_WordLength_8b; //字长，这里不需要校验，字长选择8位 USART_Init(USART1,&amp;USART_InitStructure); //初始化USART USART_Cmd(USART1,ENABLE); } 3.发送数据（以字节发送）
void Serial_SendByte(u8 Byte) { /*内部将Byte传递给Data变量，之后Data&amp;01FF,把无关的高位清零， 然后直接赋值给DR寄存器，通向TDR发送数据寄存器，再传递到移位寄存器最后一位一位传递给TX引脚*/ USART_SendData(USART1,Byte); //调用串口的SendDate()函数 /*写完数据，需要等待，等TDR的数据到移位寄存器，不然数据还在TDR进行等待，再写入数据会产生覆盖 所以发送之后，需要等待标志位 USART_FLAG_TXE 发送数据寄存器为空 标志位，要等待TXE为1，这里要嵌套循环 如果TXE为RESET就一直循环，直到TXE为SET */ while (USART_GetFlagStatus(USART1,USART_FLAG_TXE) == RESET); /*关于标志位是否需要手动清楚的问题：标志位置1之后，不需要手动清0。因为对USART_DR进行写操作，将该位清0*/ } 主函数中" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/80e6ccc05ce539ae16041e7c9fb9a7a4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-16T18:36:42+08:00" />
<meta property="article:modified_time" content="2022-11-16T18:36:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">stm32使用串口进行通讯之发送数据</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a><strong>前提准备：</strong></h3> 
<p>1.库函数基础模板<br> 2.stlink下载器、USB-TTL下载器、单片机最小开发板stm32F103C8T6<br> 3.面包板及相关接线<br> 4.vscode与keil的联合开发更流畅<br> 5.串口软件，这个下面视频有</p> 
<p>本文基于 哔哩哔哩 江科大自化协<a rel="nofollow">STM32入门教学</a><br> 知识讲的非常详细，非常感谢作者的无私奉献，本文主要是基于此进行试验笔记。便于以后查找。</p> 
<p>1.在库函数模板的前提下，在工程文件下新建文件夹Hardware,然后在keil中将文件目录加一下，Hardware文件下的文件也可以在keil下添加，添加时注意文件目录。保存关闭keil，打开VScode显示以下文件说明添加成功。具体步骤就不详细说明了，写过LED灯的应该都有了解。<br> <img src="https://images2.imgbox.com/46/53/bJtxCVkv_o.png" alt="在这里插入图片描述"><br> 2.在Hardware中添加文件夹Serial.c用来配置串口发送数据函数<br> 首先是配置GPIO时钟以及USART时钟</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span>                  <span class="token comment">//定义USART结构体</span>
    
    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_USART1<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//开启时钟</span>
    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span>        <span class="token comment">//复用推挽输出   USART1 TX使用</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>  GPIO_Pin_9<span class="token punctuation">;</span>   
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                   

    USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> <span class="token number">9600</span><span class="token punctuation">;</span>              <span class="token comment">//设置波特率9600，init函数内部会自动算好9600对应的分频系数</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span> <span class="token comment">//硬件流控制，不启用</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Tx<span class="token punctuation">;</span>         <span class="token comment">//USART模式：发送数据</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>     <span class="token comment">//校验位：无校验</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>  <span class="token comment">//停止位1   </span>
    USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>    <span class="token comment">//字长，这里不需要校验，字长选择8位</span>
    <span class="token function">USART_Init</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span><span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//初始化USART</span>

    <span class="token function">USART_Cmd</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
</code></pre> 
<p>3.发送数据（以字节发送）</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span>u8 Byte<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*内部将Byte传递给Data变量，之后Data&amp;01FF,把无关的高位清零，
    然后直接赋值给DR寄存器，通向TDR发送数据寄存器，再传递到移位寄存器最后一位一位传递给TX引脚*/</span>
    <span class="token function">USART_SendData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//调用串口的SendDate()函数</span>
    <span class="token comment">/*写完数据，需要等待，等TDR的数据到移位寄存器，不然数据还在TDR进行等待，再写入数据会产生覆盖
        所以发送之后，需要等待标志位
        USART_FLAG_TXE 发送数据寄存器为空 标志位，要等待TXE为1，这里要嵌套循环
        如果TXE为RESET就一直循环，直到TXE为SET
    */</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">/*关于标志位是否需要手动清楚的问题：标志位置1之后，不需要手动清0。因为对USART_DR进行写操作，将该位清0*/</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主函数中</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//向串口写入数据</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4.发送数组</p> 
<pre><code class="prism language-c"><span class="token comment">/*
    发送数组，通过串口发送到电脑
    参数1：指针指向传递数组的首地址 
    参数2：长度
*/</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendArray</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>Array<span class="token punctuation">,</span>u16 Length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u16 i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span>Array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主函数</p> 
<pre><code class="prism language-c">u8 My_Array<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Serial_SendArray</span><span class="token punctuation">(</span>My_Array<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//向串口写入数组</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>5.发送字符串</p> 
<pre><code class="prism language-c"><span class="token comment">/*
    发送字符串函数
    字符串自带一个结束标志位，不需要再传递长度参数,对应空字符，是字符串的标志位
*/</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendString</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>String<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 i<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> String<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token char">'\0'</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//发送字符串</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主函数</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Serial_SendString</span><span class="token punctuation">(</span><span class="token string">"Hello,world!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//发送字符串 \r\n表示换行</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>6.发送数字</p> 
<pre><code class="prism language-c"><span class="token comment">/*
    次方函数，提取千百十个
*/</span>
u32 <span class="token function">Serial_Pow</span><span class="token punctuation">(</span>u32 X<span class="token punctuation">,</span>u32 Y<span class="token punctuation">)</span>        <span class="token comment">//2 3</span>
<span class="token punctuation">{<!-- --></span>
    u32 Result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>Y<span class="token operator">--</span><span class="token punctuation">)</span>                     <span class="token comment">//3--</span>
    <span class="token punctuation">{<!-- --></span>
        Result <span class="token operator">*=</span> X<span class="token punctuation">;</span>               <span class="token comment">//1*2 *2 *2 = 2^3</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
    发送一个数字
*/</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendNumber</span><span class="token punctuation">(</span>u32 Number<span class="token punctuation">,</span>u8 Length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*
           (Number / Serial_Pow(10,i) % 10)     1234/1%10=4   1234/10%10=3 1234/100%10=2
           第一个数据不是个位，需要反过来 (Number / Serial_Pow(10, Length - i -1) % 10)
           目前循环，参数会以十进制从高位到低位依次发送，因为最终要以字符的形式显示，所以这里要加一个偏移
        */</span>
        <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Number <span class="token operator">/</span> <span class="token function">Serial_Pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span>Length <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>主函数</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Serial_SendNumber</span><span class="token punctuation">(</span><span class="token number">1234567890</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送数字</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>7.重定向prinf发送数据，这个需要**include&lt;stdio.h&gt;**别忘了</p> 
<pre><code class="prism language-c"><span class="token comment">/*
    printf函数默认是输出到屏幕，单片机没有屏幕，需要重定向printf函数
    fputc是printf函数的底层，printf打印时，不断调用fputc函数一个一个打印
*/</span>
<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span>FILE <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主函数</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Number=%d\r\n"</span><span class="token punctuation">,</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//使用重定向的printf函数发送</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>8.在7的基础上使用非封装sprintf函数<br> 主函数</p> 
<pre><code class="prism language-c"><span class="token keyword">char</span> String<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*printf只能有一个，重定向到串口1使用，串口2再用就没有了
    多个串口想用printf，可以使用sprintf，sprintf可以把格式化字符输出到每一个字符串里*/</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span><span class="token string">"Number=%d\r\n"</span><span class="token punctuation">,</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>9.使用封装sprinf函数，别忘了include&lt;stdarg.h&gt;</p> 
<pre><code class="prism language-c"><span class="token comment">/*
    封装sprintf,参数1接收格式化字符串，...用来接收后面的可变参数列表
*/</span>
<span class="token keyword">void</span> <span class="token function">Serial_Printf</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> String<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    va_list arg<span class="token punctuation">;</span>    <span class="token comment">//参数列表变量</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//从format位置开始接收参数表，放在arg里面</span>
    <span class="token function">vsprintf</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span>format<span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//打印位置String，格式化字符串是format，参数表是arg</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//释放参数表</span>
    <span class="token function">Serial_SendString</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主函数</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上面每次都需要3步调用，所以对sprintf进行封装</span>
    <span class="token function">Serial_Printf</span><span class="token punctuation">(</span><span class="token string">"真的%d\r\n"</span><span class="token punctuation">,</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_226"></a>总的代码</h3> 
<p>Serial.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Serial.h"</span></span>

<span class="token keyword">void</span> <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span>                  <span class="token comment">//定义USART结构体</span>
    
    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_USART1<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//开启时钟</span>
    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span>        <span class="token comment">//复用推挽输出   USART1 TX使用</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>  GPIO_Pin_9<span class="token punctuation">;</span>   
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                   

    USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> <span class="token number">9600</span><span class="token punctuation">;</span>              <span class="token comment">//设置波特率9600，init函数内部会自动算好9600对应的分频系数</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span> <span class="token comment">//硬件流控制，不启用</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Tx<span class="token punctuation">;</span>         <span class="token comment">//USART模式：发送数据</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>     <span class="token comment">//校验位：无校验</span>
    USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>  <span class="token comment">//停止位1   </span>
    USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>    <span class="token comment">//字长，这里不需要校验，字长选择8位</span>
    <span class="token function">USART_Init</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span><span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//初始化USART</span>

    <span class="token function">USART_Cmd</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>

<span class="token comment">/*
    函数功能：发送数据
*/</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span>u8 Byte<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*内部将Byte传递给Data变量，之后Data&amp;01FF,把无关的高位清零，
    然后直接赋值给DR寄存器，通向TDR发送数据寄存器，再传递到移位寄存器最后一位一位传递给TX引脚*/</span>
    <span class="token function">USART_SendData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//调用串口的SendDate()函数</span>
    <span class="token comment">/*写完数据，需要等待，等TDR的数据到移位寄存器，不然数据还在TDR进行等待，再写入数据会产生覆盖
        所以发送之后，需要等待标志位
        USART_FLAG_TXE 发送数据寄存器为空 标志位，要等待TXE为1，这里要嵌套循环
        如果TXE为RESET就一直循环，直到TXE为SET
    */</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">/*关于标志位是否需要手动清楚的问题：标志位置1之后，不需要手动清0。因为对USART_DR进行写操作，将该位清0*/</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
    发送数组，通过串口发送到电脑
    参数1：指针指向传递数组的首地址 
    参数2：长度
*/</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendArray</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>Array<span class="token punctuation">,</span>u16 Length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u16 i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span>Array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
    发送字符串函数
    字符串自带一个结束标志位，不需要再传递长度参数,对应空字符，是字符串的标志位
*/</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendString</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>String<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 i<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> String<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token char">'\0'</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//发送字符串</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
    次方函数，提取千百十个
*/</span>
u32 <span class="token function">Serial_Pow</span><span class="token punctuation">(</span>u32 X<span class="token punctuation">,</span>u32 Y<span class="token punctuation">)</span>        <span class="token comment">//2 3</span>
<span class="token punctuation">{<!-- --></span>
    u32 Result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>Y<span class="token operator">--</span><span class="token punctuation">)</span>                     <span class="token comment">//3--</span>
    <span class="token punctuation">{<!-- --></span>
        Result <span class="token operator">*=</span> X<span class="token punctuation">;</span>               <span class="token comment">//1*2 *2 *2 = 2^3</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
    发送一个数字
*/</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendNumber</span><span class="token punctuation">(</span>u32 Number<span class="token punctuation">,</span>u8 Length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*
           (Number / Serial_Pow(10,i) % 10)     1234/1%10=4   1234/10%10=3 1234/100%10=2
           第一个数据不是个位，需要反过来 (Number / Serial_Pow(10, Length - i -1) % 10)
           目前循环，参数会以十进制从高位到低位依次发送，因为最终要以字符的形式显示，所以这里要加一个偏移
        */</span>
        <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Number <span class="token operator">/</span> <span class="token function">Serial_Pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span>Length <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>

<span class="token comment">/*
    printf函数默认是输出到屏幕，单片机没有屏幕，需要重定向printf函数
    fputc是printf函数的底层，printf打印时，不断调用fputc函数一个一个打印
*/</span>
<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span>FILE <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
    封装sprintf,参数1接收格式化字符串，...用来接收后面的可变参数列表
*/</span>
<span class="token keyword">void</span> <span class="token function">Serial_Printf</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> String<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    va_list arg<span class="token punctuation">;</span>    <span class="token comment">//参数列表变量</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//从format位置开始接收参数表，放在arg里面</span>
    <span class="token function">vsprintf</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span>format<span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//打印位置String，格式化字符串是format，参数表是arg</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//释放参数表</span>
    <span class="token function">Serial_SendString</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>Serial.h</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SERIAL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SERIAL_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span>u8 Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendArray</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>Array<span class="token punctuation">,</span>u16 Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendString</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Serial_SendNumber</span><span class="token punctuation">(</span>u32 Number<span class="token punctuation">,</span>u8 Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Serial_Printf</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre> 
<p>main.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span>   <span class="token comment">// Device header</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Serial.h"</span></span>

u8 My_Array<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> String<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Serial_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Serial_SendByte</span><span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//向串口写入数据</span>
    <span class="token function">Serial_SendArray</span><span class="token punctuation">(</span>My_Array<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//向串口写入数组</span>
    <span class="token function">Serial_SendString</span><span class="token punctuation">(</span><span class="token string">"Hello,world!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//发送字符串 \r\n表示换行</span>
    <span class="token function">Serial_SendNumber</span><span class="token punctuation">(</span><span class="token number">1234567890</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送数字</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Number=%d\r\n"</span><span class="token punctuation">,</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//使用重定向的printf函数发送</span>

    <span class="token comment">/*printf只能有一个，重定向到串口1使用，串口2再用就没有了
    多个串口想用printf，可以使用sprintf，sprintf可以把格式化字符输出到每一个字符串里*/</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span><span class="token string">"Number=%d\r\n"</span><span class="token punctuation">,</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//上面每次都需要3步调用，所以对sprintf进行封装</span>
    <span class="token function">Serial_Printf</span><span class="token punctuation">(</span><span class="token string">"真的%d\r\n"</span><span class="token punctuation">,</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_405"></a>试验硬件接图</h3> 
<p>暂未用到屏幕，可不接<br> <img src="https://images2.imgbox.com/18/cb/PVC7nvYY_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_408"></a>实验效果</h3> 
<p>按复位键，电脑串口接收到数据<br> <img src="https://images2.imgbox.com/32/2b/tLefQsr1_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7332ab07f727d3cb2461d166aebf4d3b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java基础Socket运用——服务端和客户端的信息交换</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e050734c96df25a5696361e313cb9124/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何在CSDN中发布文章</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>