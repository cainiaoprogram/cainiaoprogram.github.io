<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-聚合支付平台-020：基于seata解决分布式事务 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-聚合支付平台-020：基于seata解决分布式事务" />
<meta property="og:description" content="020：基于seata解决分布式事务 1 支付服务与积分存在的分布式事务问题2 将积分代码拷贝到项目中3 单独开启一个线程调用积分接口4 支付宝如何防止用户重复支付问题5 简单回顾seata与lcn解决分布式事务原理6 构建seata服务端项目7 微服务项目整合Seata框架8 异步回调整合Seata实现分布式事务 1 支付服务与积分存在的分布式事务问题 今日课程任务
支付项目如何用户防止用户重复支付使用feign客户端调用积分服务接口增加积分基于seata解决分布式事务难题seata解决分布式事务底层实现原理 支付回调接口：除了修改支付订单状态以外，其他流程一定要异步实现（目的快速响应支付宝，避免接口超时产生的幂等性问题）。
支付服务调用积分服务，可能会遇到幂等性问题。
解决：全局id（支付id&#43;userId组成）数据库中表主键唯一约束
基于feign的形式调用积分接口增加积分，如何积分服务宕机如何处理？
根据日志记录定时或者人工补偿，比较好的办法也可以直接采用MQ实现增加积分。
2 将积分代码拷贝到项目中 新建模块mt-shop-service-api-integral、mt-shop-service-integral
public interface IntegralService { /** * 增加积分 * @return */ @PostMapping(&#34;/addIntegral&#34;) BaseResponse&lt;String&gt; addIntegral(@RequestBody IntegralReqDto IntegralReqDto); } @RestController public class IntegralServiceImpl extends BaseApiService implements IntegralService { @Autowired private IntegralMapper integralMapper; @Override public BaseResponse&lt;String&gt; addIntegral(IntegralReqDto integralReqDto) { // 1.验证参数 Long userId = integralReqDto.getUserId(); if(userId==null){ return setResultError(&#34;userId不能为空!&#34;); } String paymentId = integralReqDto." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1d296b27443c86153bbda84bc2798e01/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-16T08:20:10+08:00" />
<meta property="article:modified_time" content="2021-07-16T08:20:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-聚合支付平台-020：基于seata解决分布式事务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>020：基于seata解决分布式事务</h4> 
 <ul><li><ul><li><a href="#1__1" rel="nofollow">1 支付服务与积分存在的分布式事务问题</a></li><li><a href="#2__17" rel="nofollow">2 将积分代码拷贝到项目中</a></li><li><a href="#3__80" rel="nofollow">3 单独开启一个线程调用积分接口</a></li><li><a href="#4__154" rel="nofollow">4 支付宝如何防止用户重复支付问题</a></li><li><a href="#5_seatalcn_161" rel="nofollow">5 简单回顾seata与lcn解决分布式事务原理</a></li><li><a href="#6_seata_182" rel="nofollow">6 构建seata服务端项目</a></li><li><a href="#7_Seata_190" rel="nofollow">7 微服务项目整合Seata框架</a></li><li><a href="#8_Seata_249" rel="nofollow">8 异步回调整合Seata实现分布式事务</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1__1"></a>1 支付服务与积分存在的分布式事务问题</h3> 
<p><strong>今日课程任务</strong></p> 
<ol><li>支付项目如何用户防止用户重复支付</li><li>使用feign客户端调用积分服务接口增加积分</li><li>基于seata解决分布式事务难题</li><li>seata解决分布式事务底层实现原理</li></ol> 
<p>支付回调接口：除了修改支付订单状态以外，其他流程一定要异步实现（目的快速响应支付宝，避免接口超时产生的幂等性问题）。</p> 
<p><strong>支付服务调用积分服务，可能会遇到幂等性问题。</strong><br> 解决：全局id（支付id+userId组成）数据库中表主键唯一约束</p> 
<p><strong>基于feign的形式调用积分接口增加积分，如何积分服务宕机如何处理？</strong><br> 根据日志记录定时或者人工补偿，比较好的办法也可以直接采用MQ实现增加积分。</p> 
<h3><a id="2__17"></a>2 将积分代码拷贝到项目中</h3> 
<p><strong>新建模块mt-shop-service-api-integral、mt-shop-service-integral</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IntegralService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 增加积分
     * @return
     */</span>
    @<span class="token function">PostMapping</span><span class="token punctuation">(</span><span class="token string">"/addIntegral"</span><span class="token punctuation">)</span>
    BaseResponse<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token function">addIntegral</span><span class="token punctuation">(</span>@RequestBody IntegralReqDto IntegralReqDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@RestController
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntegralServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">BaseApiService</span> <span class="token keyword">implements</span> <span class="token class-name">IntegralService</span> <span class="token punctuation">{<!-- --></span>
    @Autowired
    <span class="token keyword">private</span> IntegralMapper integralMapper<span class="token punctuation">;</span>
    @Override
    <span class="token keyword">public</span> BaseResponse<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token function">addIntegral</span><span class="token punctuation">(</span><span class="token parameter">IntegralReqDto integralReqDto</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.验证参数</span>
        Long userId <span class="token operator">=</span> integralReqDto<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>userId<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"userId不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String paymentId <span class="token operator">=</span> integralReqDto<span class="token punctuation">.</span><span class="token function">getPaymentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>paymentId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"paymentId不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Long integral <span class="token operator">=</span> integralReqDto<span class="token punctuation">.</span><span class="token function">getIntegral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>integral<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"integral不能为空!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.dto转换do</span>
        IntegralEntity integralEntity <span class="token operator">=</span> <span class="token function">dtoToDo</span><span class="token punctuation">(</span>integralReqDto<span class="token punctuation">,</span> IntegralEntity<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 插入到数据库中  根据支付id实现唯一约束，无法重复插入，所以不会重复增加积分。</span>
        int insertIntegral <span class="token operator">=</span> integralMapper<span class="token punctuation">.</span><span class="token function">insertIntegral</span><span class="token punctuation">(</span>integralEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>insertIntegral<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 将该日志信息记录下来，后期采用定时任务实现补偿</span>
            <span class="token keyword">return</span>  <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"增加积分失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">setResultSuccess</span><span class="token punctuation">(</span><span class="token string">"增加积分成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>积分表</strong></p> 
<pre><code>DROP TABLE IF EXISTS `meite_integral`;
CREATE TABLE `meite_integral` (
  `ID` int(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `USER_ID` int(11) DEFAULT NULL COMMENT '用户ID',
  `PAYMENT_ID` varchar(1024) NOT NULL COMMENT '支付ID',
  `INTEGRAL` varchar(32) DEFAULT NULL COMMENT '积分',
  `AVAILABILITY` int(11) DEFAULT NULL COMMENT '是否可用',
  `REVISION` int(11) DEFAULT NULL COMMENT '乐观锁',
  `CREATED_BY` varchar(32) DEFAULT NULL COMMENT '创建人',
  `CREATED_TIME` datetime DEFAULT NULL COMMENT '创建时间',
  `UPDATED_BY` varchar(32) DEFAULT NULL COMMENT '更新人',
  `UPDATED_TIME` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`ID`)
) ENGINE=InnoDB AUTO_INCREMENT=32 DEFAULT CHARSET=utf8 COMMENT=' ';
</code></pre> 
<h3><a id="3__80"></a>3 单独开启一个线程调用积分接口</h3> 
<p><strong>异步使用feign客户端调用积分服务要独立在一个类中处理</strong></p> 
<pre><code class="prism language-javascript">@<span class="token function">FeignClient</span><span class="token punctuation">(</span><span class="token string">"mayikt-integral"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IntegralServiceFeign</span> <span class="token keyword">extends</span> <span class="token class-name">IntegralService</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@Component
@EnableAsync
@Slf4j
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntegralServiceManage</span> <span class="token punctuation">{<!-- --></span>
    @Autowired
    <span class="token keyword">private</span> IntegralServiceFeign integralServiceFeign<span class="token punctuation">;</span>

    @Async
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addIntegral</span><span class="token punctuation">(</span><span class="token parameter">IntegralReqDto integralReqDto</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            BaseResponse<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> stringBaseResponse <span class="token operator">=</span> integralServiceFeign<span class="token punctuation">.</span><span class="token function">addIntegral</span><span class="token punctuation">(</span>integralReqDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Integer code <span class="token operator">=</span> stringBaseResponse<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>PayConstant<span class="token punctuation">.</span><span class="token constant">RPC_RESULT_OK_CODE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 日志记录 后期定时任务补偿</span>
                <span class="token function">addErrorPayLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 增加积分成功</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">addErrorPayLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 记录异常日志 后期采用定时任务实现补偿 积分服务接口宕机或者超时</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addErrorPayLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>AbstractPayCallbackTemplate</strong></p> 
<pre><code class="prism language-javascript">@Slf4j
<span class="token keyword">public</span> abstract <span class="token keyword">class</span> <span class="token class-name">AbstractPayCallbackTemplate</span> <span class="token punctuation">{<!-- --></span>
    @Autowired
    <span class="token keyword">private</span> IntegralServiceManage integralServiceManage<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 3.更改订单状态已经支付
     * 4.调用积分服务接口增加积分
     *
     * @return
     */</span>
    <span class="token keyword">private</span> String <span class="token function">asyncService</span><span class="token punctuation">(</span><span class="token parameter">String outTradeNo<span class="token punctuation">,</span> Long totalAmount</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 支付订单号码</span>
        PaymentTransactionEntity pte <span class="token operator">=</span> paymentTransactionMapper<span class="token punctuation">.</span><span class="token function">selectByPaymentId</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 以下代码可以重构进入父类里面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PayConstant<span class="token punctuation">.</span><span class="token constant">PAY_PAID_STATUS</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pte<span class="token punctuation">.</span><span class="token function">getPaymentStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回成功告诉给支付不要再继续重试</span>
            <span class="token keyword">return</span> <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.判断支付的金额 是否一致</span>
        Long payAmount <span class="token operator">=</span> pte<span class="token punctuation">.</span><span class="token function">getPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>payAmount<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回success，后台将该订单状态修改为异常订单状态，然后分析异常原因用定时任务处理</span>
            <span class="token keyword">return</span> <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3. 在修改为已经支付</span>
        int result <span class="token operator">=</span> paymentTransactionMapper<span class="token punctuation">.</span><span class="token function">updatePaymentStatus</span><span class="token punctuation">(</span>PayConstant<span class="token punctuation">.</span><span class="token constant">PAY_PAID_STATUS</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">,</span> outTradeNo<span class="token punctuation">,</span> <span class="token string">"ali_pay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> PayConstant<span class="token punctuation">.</span><span class="token constant">DB_FAIL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回失败告诉支付宝重试</span>
            <span class="token keyword">return</span> <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 调用积分服务接口增加积分 存在分布式事务的问题</span>
        IntegralReqDto integralReqDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntegralReqDto</span><span class="token punctuation">(</span>pte<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pte<span class="token punctuation">.</span><span class="token function">getPaymentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//积分公式根据业务要求定</span>
        <span class="token comment">// 采用多线程一步形式调用积分接口增加积分 MQ增加积分更好（自带补偿功能）</span>
        integralServiceManage<span class="token punctuation">.</span><span class="token function">addIntegral</span><span class="token punctuation">(</span>integralReqDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4__154"></a>4 支付宝如何防止用户重复支付问题</h3> 
<p><strong>如何防止用户重复支付？采用支付的全局id</strong><br> 传递相同的支付id给支付宝，支付宝端会做判重处理，该订单已经支付。</p> 
<p><strong>测试联调对接积分服务</strong><br> <img src="https://images2.imgbox.com/6b/3e/OIbrpBvc_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_seatalcn_161"></a>5 简单回顾seata与lcn解决分布式事务原理</h3> 
<p><strong>Seata简单介绍</strong><br> Seata:Simple Extensible Autonomous Transaction Architecture，简易可扩展的自治式分布式事务管理框架，其前身是fescar，是一种简单分布式事务的解决方案。<br> Seata给用户提供了AT、TCC、SAGA和XA事务模式，AT模式是阿里云中推出的商业版本GTS全局事务服务，项目中用的是0.9版本。</p> 
<p>https://github.com/seata/seata seata官网<br> https://yq.aliyun.com/zt/593075 阿里云GTS<br> LCN和Seata到底用哪个？ LCN有事务协调者管理界面但是Seata目前没有</p> 
<p><strong>Seata有3个基本组成部分：</strong></p> 
<ol><li>事务协调器（TC）：维护全局事务和分支事务的状态，驱动全局提交或回滚，相当于是协调者。</li><li>事务管理器TM：定义全局事务的范围：开始全局事务，提交或回滚全局事务，相当于LCN中发起方。</li><li>资源管理器（RM）：管理分支事务正在处理的资源，与TC进行对话以注册分支事务并报告分支事务的状态，并驱动分支事务的提交或回滚，相当于是LCN中的参与方。</li></ol> 
<p>如果支付服务调用积分服务接口，积分服务接口返回error，不属于分布式事务问题。</p> 
<p><strong>分布式事务的问题产生</strong>：支付服务调用积分服务成功之后，支付服务突然报错了，这时候支付服务回滚，但是积分服务是增加了。<br> <img src="https://images2.imgbox.com/cb/42/6aXs0Cd4_o.png" alt="在这里插入图片描述"><br> Seata会造成数据脏读，但是可以避免死锁的现象 --支付服务调用积分服务后，积分服务事务先提交，生成undo_log日志（参与方回滚）。<br> LCN防止数据的脏读，但是会发生死锁的现象–支付服务调完积分服务宕机，没有及时把事务全局id给积分服务，导致积分服务一直等待（假关闭状态）。</p> 
<h3><a id="6_seata_182"></a>6 构建seata服务端项目</h3> 
<p><strong>Seata环境的安装</strong><br> 下载seata-server-0.9.0<br> 修改conf目录下registry.conf<br> <img src="https://images2.imgbox.com/d6/32/mq0bq044_o.png" alt="在这里插入图片描述"><br> 双击启动seata-server.bat即可<br> 在需要解决分布式事务的数据库中，手动创建undo_log表 否则的情况下会报错</p> 
<h3><a id="7_Seata_190"></a>7 微服务项目整合Seata框架</h3> 
<p><strong>Seata客户端整合<br> 引入依赖</strong></p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>alibaba<span class="token operator">-</span>seata<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.1</span><span class="token number">.1</span><span class="token punctuation">.</span><span class="token constant">RELEASE</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p><strong>配置代理的数据源（注意两个项目都要配置）</strong></p> 
<pre><code class="prism language-javascript">@Configuration
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceProxyConfig</span> <span class="token punctuation">{<!-- --></span>

    @Bean
    @<span class="token function">ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> DataSource <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Bean
    <span class="token keyword">public</span> DataSourceProxy <span class="token function">dataSourceProxy</span><span class="token punctuation">(</span><span class="token parameter">DataSource dataSource</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Bean
    <span class="token keyword">public</span> SqlSessionFactory <span class="token function">sqlSessionFactoryBean</span><span class="token punctuation">(</span>DataSourceProxy dataSourceProxy<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
        SqlSessionFactoryBean sqlSessionFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSourceProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setTransactionFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpringManagedTransactionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>需要要将file.conf、registry.conf 拷贝到项目中（0.9版本以前）<br> <img src="https://images2.imgbox.com/c9/94/Ml1v6OR8_o.png" alt="在这里插入图片描述"><br> 默认的my_test_tx_group为分组的id，default.grouplist为全局的协调者连接地址<br> <strong>积分服务addIntegral方法上加上注解@GlobalTransactional<br> 积分/支付服务数据库都要建立undo_log表</strong></p> 
<pre><code>DROP TABLE IF EXISTS `undo_log`;
CREATE TABLE `undo_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(100) NOT NULL,
  `context` varchar(128) NOT NULL,
  `rollback_info` longblob NOT NULL,
  `log_status` int(11) NOT NULL,
  `log_created` datetime NOT NULL,
  `log_modified` datetime NOT NULL,
  `ext` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre> 
<p><strong>分别启动积分/支付服务，启动成功</strong><br> <img src="https://images2.imgbox.com/11/0b/0GeGRtWp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="8_Seata_249"></a>8 异步回调整合Seata实现分布式事务</h3> 
<p><strong>效果测试：</strong><br> <img src="https://images2.imgbox.com/47/79/JUWqK81C_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cc5abae1ca20f48e614456f7f918542f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-聚合支付平台-019：基于模板方法模式重构异步回调</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ca691339bd43625dfc9c6640168fba17/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Lambda在Java以及Kotlin、高阶函数中使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>