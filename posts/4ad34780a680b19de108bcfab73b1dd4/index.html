<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flask和Vue框架实现WebSocket消息通信 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flask和Vue框架实现WebSocket消息通信" />
<meta property="og:description" content="1 安装环境 1.1 安装Flask环境 主要的安装包 Flask、Flask-SocketIO，注意Python版本要求3.6&#43;
# Flask-SocketIO参考地址 https://flask-socketio.readthedocs.io/en/latest/ https://github.com/miguelgrinberg/flask-socketio 更新基础环境
# 更新pip python -m pip install --upgrade pip # 更新setuptools pip install --upgrade setuptools # 安装Flask pip install flask pip install flask_cors # 安装关于SocketIO的包 # 安装python-socketio时，会自动安装python-engineio依赖 pip install python-socketio pip install flask-socketio # eventlet具有WSGI支持的异步框架，主要功能是通过协程实现并发 pip install eventlet 我的“requirements.txt”的包
bidict==0.22.1 blinker==1.7.0 click==8.1.7 colorama==0.4.6 dnspython==2.4.2 eventlet==0.33.3 Flask==3.0.0 Flask-Cors==4.0.0 Flask-SocketIO==5.3.6 greenlet==3.0.1 h11==0.14.0 importlib-metadata==7.0.0 itsdangerous==2.1.2 Jinja2==3.1.2 MarkupSafe==2.1.3 python-engineio==4.8.0 python-socketio==5.10.0 simple-websocket==1.0.0 six==1.16.0 Werkzeug==3.0.1 wsproto==1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4ad34780a680b19de108bcfab73b1dd4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-10T15:33:24+08:00" />
<meta property="article:modified_time" content="2023-12-10T15:33:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flask和Vue框架实现WebSocket消息通信</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1 安装环境</h2> 
<h3><a id="11_Flask_4"></a>1.1 安装Flask环境</h3> 
<p>主要的安装包 Flask、Flask-SocketIO，注意Python版本要求3.6+</p> 
<pre><code># Flask-SocketIO参考地址
https://flask-socketio.readthedocs.io/en/latest/
https://github.com/miguelgrinberg/flask-socketio
</code></pre> 
<p>更新基础环境</p> 
<pre><code># 更新pip
python -m pip install --upgrade pip

# 更新setuptools
pip install --upgrade setuptools

# 安装Flask
pip install flask
pip install flask_cors

# 安装关于SocketIO的包
# 安装python-socketio时，会自动安装python-engineio依赖
pip install python-socketio
pip install flask-socketio

# eventlet具有WSGI支持的异步框架，主要功能是通过协程实现并发
pip install eventlet
</code></pre> 
<p>我的“requirements.txt”的包</p> 
<pre><code>bidict==0.22.1
blinker==1.7.0
click==8.1.7
colorama==0.4.6
dnspython==2.4.2
eventlet==0.33.3
Flask==3.0.0
Flask-Cors==4.0.0
Flask-SocketIO==5.3.6
greenlet==3.0.1
h11==0.14.0
importlib-metadata==7.0.0
itsdangerous==2.1.2
Jinja2==3.1.2
MarkupSafe==2.1.3
python-engineio==4.8.0
python-socketio==5.10.0
simple-websocket==1.0.0
six==1.16.0
Werkzeug==3.0.1
wsproto==1.2.0
zipp==3.17.0
</code></pre> 
<p>安装命令</p> 
<pre><code>pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre> 
<h3><a id="12_Vue_77"></a>1.2 安装Vue环境</h3> 
<p><strong>（1）使用vite创建项目</strong></p> 
<pre><code># 创建项目
npm create vite@latest

# 选择框架和语言，我选择的是Vue和TypeScript
√ Project name: ... websocket
√ Select a framework: » Vue
√ Select a variant: » TypeScript

Done. Now run:

  cd websocket
  npm install
  npm run dev

# 进入目录
cd websocket

# 安装相关包
npm install
# 安装包结束后提示如下：
added 44 packages, and audited 45 packages in 14s
</code></pre> 
<p><strong>（2）安装依赖包</strong></p> 
<pre><code># 安装一个包即可
npm install socket.io-client -S
</code></pre> 
<p>socket.io-client的参考地址</p> 
<pre><code>https://socket.io/docs/v4/client-api/
</code></pre> 
<p>查看npm包版本和例子的网络地址</p> 
<pre><code>https://www.npmjs.com/
</code></pre> 
<p>备注：npm中命令参数的意思</p> 
<pre><code>--global（-g）：表示全局全局安装，包安装在了node目录下的node_modules/npm中（可以在任意项目中使用该工具）；不使用-g安装，包安装在了工程目录下的node_modules中下。
--save（-S）：表示写入package.json文件中的dependencies，这里面的包是发布到生产环境中的，例如：vue、axios等。
--save-dev（-D）：表示写入package.json文件中的devDependencies，这里面的包是仅在开发环境中辅助开发，在生产环境中不需要，例如：vite、css-loader等。
不使用参数时：npm使用的是--save（-S）命令
</code></pre> 
<p>package.json文件</p> 
<pre><code>{
  "name": "websocket",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc &amp;&amp; vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "socket.io-client": "^4.7.2",
    "vue": "^3.3.8"
  },
  "devDependencies": {
    "@types/node": "^20.10.2",
    "@vitejs/plugin-vue": "^4.5.0",
    "typescript": "^5.2.2",
    "vite": "^5.0.0",
    "vue-tsc": "^1.8.22"
  }
}
</code></pre> 
<p><strong>（3）使用Vscode常见报错</strong></p> 
<p><strong>报错1</strong></p> 
<pre><code>Cannot find module './App.vue' or its corresponding type declarations.ts(2307)
</code></pre> 
<p>解决方法</p> 
<p>修改项目根目录中 “env.d.ts” 文件，添加如下内容：</p> 
<pre><code class="prism language-vue">/// &lt;reference types="vite/client" /&gt;
declare module "*.vue" {
    import { DefineComponent } from "vue"
    const component: DefineComponent&lt;{}, {}, any&gt;
    export default component
}
</code></pre> 
<p><strong>报错2</strong></p> 
<pre><code>Module xx.vue has no default export.Vetur(1192)
</code></pre> 
<p>解决方法</p> 
<pre><code>卸载vetur插件，主要针对vue2项目；
安装Volar插件，全称Vue Language Features (Volar)，主要针对vue3和TypeScript项目；
</code></pre> 
<p><strong>报错3</strong></p> 
<pre><code>使用“@”无法导入ts文件，错误符号指向“@”，Cannot find module 'XXXXs' or its corresponding type declarations
</code></pre> 
<p>解决方法</p> 
<ul><li>安装@types/node，会在项目中生成一个vite-env.d.ts文件</li></ul> 
<pre><code>npm i @types/node -D
</code></pre> 
<ul><li>在vite.config.js文件中配置参数</li></ul> 
<pre><code>import  defineConfig ] from 'vite';
import vue from '@vitejs/plugin-vue'
 
import path from "path";
 
export default defineConfig({
    plugins: [vue()],
    resolve: {
        // !!!!配置路径别名!!!
        alias: {
            '@': path.resolve(__dirname,'./src'),
        }
    },
});
</code></pre> 
<ul><li>在 tsconfig.json中配置代码</li></ul> 
<pre><code>"compilerOptions":{
	"baseUrl": "./",
	"paths":{
		"@": ["src"],
		"@/*": ["src/*"],
	}
}
</code></pre> 
<p><strong>（4）启动服务</strong></p> 
<p>在vscode中打开，在doc上启动服务</p> 
<pre><code>npm run dev
</code></pre> 
<h3><a id="13__267"></a>1.3 版本要求</h3> 
<p>flask-socketio的版本兼容</p> 
<table><thead><tr><th align="left">JavaScript Socket.IO version</th><th align="left">Socket.IO protocol revision</th><th align="left">Engine.IO protocol revision</th><th align="left">Flask-SocketIO version</th><th align="left">python-socketio version</th><th align="left">python-engineio version</th></tr></thead><tbody><tr><td align="left">0.9.x</td><td align="left">1, 2</td><td align="left">1, 2</td><td align="left">Not supported</td><td align="left">Not supported</td><td align="left">Not supported</td></tr><tr><td align="left">1.x and 2.x</td><td align="left">3, 4</td><td align="left">3</td><td align="left">4.x</td><td align="left">4.x</td><td align="left">3.x</td></tr><tr><td align="left">3.x and 4.x</td><td align="left">5</td><td align="left">4</td><td align="left">5.x</td><td align="left">5.x</td><td align="left">4.x</td></tr></tbody></table> 
<h3><a id="14_FlaskSocketIO_279"></a>1.4 Flask-SocketIO消息隔离</h3> 
<p>我认为有三种隔离级别</p> 
<table><thead><tr><th>隔离级别</th><th>对应策略</th><th>说明</th></tr></thead><tbody><tr><td>全局</td><td>/</td><td>全局命名空间，连接到此命名空间下的客户端会收到消息，系统默认空间</td></tr><tr><td>空间</td><td>namespace</td><td>特定命名空间，连接到此命名空间的客户端会收到消息，不同命名空间相互隔离</td></tr><tr><td>组</td><td>room</td><td>在某命名空间下的用户组，不同用户组仅仅接收自己所在组的消息，不同组消息隔离</td></tr></tbody></table> 
<h2><a id="2_Flask_293"></a>2 Flask项目</h2> 
<h3><a id="21__297"></a>2.1 项目布局</h3> 
<p><img src="https://images2.imgbox.com/c2/60/7OaVYOH7_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22__304"></a>2.2 源代码</h3> 
<p><strong>main.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> blueprint_user <span class="token keyword">import</span> init_blueprint
<span class="token keyword">from</span> config_app <span class="token keyword">import</span> socketio<span class="token punctuation">,</span> app


<span class="token comment"># 初始化蓝本</span>
<span class="token keyword">from</span> socket_comm <span class="token keyword">import</span> init_socket

init_blueprint<span class="token punctuation">(</span><span class="token punctuation">)</span>

init_socket<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    socketio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

</code></pre> 
<p><strong>config_app.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_cors <span class="token keyword">import</span> CORS

<span class="token keyword">from</span> flask_socketio <span class="token keyword">import</span> SocketIO


<span class="token keyword">def</span> <span class="token function">create_app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    flask_app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    <span class="token comment"># 设置密钥</span>
    flask_app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'123456'</span>
    CORS<span class="token punctuation">(</span>flask_app<span class="token punctuation">,</span> supports_credentials<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> flask_app


<span class="token keyword">def</span> <span class="token function">create_socketio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    flask_socketio <span class="token operator">=</span> SocketIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 解决跨域问题</span>
    flask_socketio<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">,</span> cors_allowed_origins<span class="token operator">=</span><span class="token string">'*'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> flask_socketio


app <span class="token operator">=</span> create_app<span class="token punctuation">(</span><span class="token punctuation">)</span>

socketio <span class="token operator">=</span> create_socketio<span class="token punctuation">(</span><span class="token punctuation">)</span>

name_space_user <span class="token operator">=</span> <span class="token string">"/user"</span>

</code></pre> 
<p><strong>blueprint_user.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint

<span class="token keyword">from</span> config_app <span class="token keyword">import</span> app<span class="token punctuation">,</span> name_space_user<span class="token punctuation">,</span> socketio

user <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> __name__<span class="token punctuation">)</span>


<span class="token comment"># 注册蓝本</span>
<span class="token keyword">def</span> <span class="token function">init_blueprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>user<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">'/user'</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@user<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"Success"</span>


<span class="token comment"># 使用方法传递参数</span>
<span class="token decorator annotation punctuation">@user<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/broad'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">broad_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    event_name <span class="token operator">=</span> <span class="token string">"data_res"</span>
    broad_casted_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token string">"test message!"</span><span class="token punctuation">}</span>
    <span class="token comment"># 发送消息</span>
    socketio<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>event_name<span class="token punctuation">,</span> broad_casted_data<span class="token punctuation">,</span> namespace<span class="token operator">=</span>name_space_user<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"success"</span>

</code></pre> 
<p><strong>socket_comm.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask_socketio <span class="token keyword">import</span> emit<span class="token punctuation">,</span> send<span class="token punctuation">,</span> join_room<span class="token punctuation">,</span> leave_room

<span class="token keyword">from</span> config_app <span class="token keyword">import</span> socketio<span class="token punctuation">,</span> name_space_user


<span class="token keyword">def</span> <span class="token function">init_socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token comment"># 可以用“@socketio.event”替代“@socketio.on('connect')”</span>
<span class="token comment"># “@socketio.event”可以用来装饰socketio默认的事件，例如：connect等</span>
<span class="token decorator annotation punctuation">@socketio<span class="token punctuation">.</span>on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span>name_space_user<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">connected_msg</span><span class="token punctuation">(</span>auth<span class="token punctuation">:</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'client connected.'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>auth<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token decorator annotation punctuation">@socketio<span class="token punctuation">.</span>on</span><span class="token punctuation">(</span><span class="token string">'disconnect'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span>name_space_user<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">disconnect_msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'client disconnected.'</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@socketio<span class="token punctuation">.</span>on</span><span class="token punctuation">(</span><span class="token string">'data_event'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span>name_space_user<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_event</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token comment"># emit(): 发送到指定活动上，对应前端的data_res</span>
    <span class="token triple-quoted-string string">"""
        # 对应前端的代码
        socket.on('data_res', (data:string) =&gt; {
            console.log('监听消息：');
            console.log(data);
        });
    
    """</span>
    emit<span class="token punctuation">(</span><span class="token string">'data_res'</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> broadcast<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@socketio<span class="token punctuation">.</span>on</span><span class="token punctuation">(</span><span class="token string">'data_msg'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span>name_space_user<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_msg</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token comment"># send(): 发送到message,对应前端的message</span>
    <span class="token triple-quoted-string string">"""
        # 对饮前端的代码
        socket.on("message", function(data: string){
            console.log("Message" + data)
        })
    """</span>
    send<span class="token punctuation">(</span>message<span class="token punctuation">,</span> namespace<span class="token operator">=</span>name_space_user<span class="token punctuation">,</span> broadcast<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@socketio<span class="token punctuation">.</span>on</span><span class="token punctuation">(</span><span class="token string">'join'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span>name_space_user<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">on_join</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>
    room <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'room'</span><span class="token punctuation">]</span>
    join_room<span class="token punctuation">(</span>room<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    send<span class="token punctuation">(</span>username <span class="token operator">+</span> <span class="token string">' has entered the room.'</span><span class="token punctuation">,</span> to<span class="token operator">=</span>room<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@socketio<span class="token punctuation">.</span>on</span><span class="token punctuation">(</span><span class="token string">'leave'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span>name_space_user<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">on_leave</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>
    room <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'room'</span><span class="token punctuation">]</span>
    leave_room<span class="token punctuation">(</span>room<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    send<span class="token punctuation">(</span>username <span class="token operator">+</span> <span class="token string">' has left the room.'</span><span class="token punctuation">,</span> to<span class="token operator">=</span>room<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@socketio<span class="token punctuation">.</span>on</span><span class="token punctuation">(</span><span class="token string">'send_room'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span>name_space_user<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">send_room</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>
    room <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'room'</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    send<span class="token punctuation">(</span>data<span class="token punctuation">,</span> to<span class="token operator">=</span>room<span class="token punctuation">)</span>

</code></pre> 
<h2><a id="3_Vue_486"></a>3 Vue项目</h2> 
<p>构建项目使用的是“组合式 API (Composition API)”编写，不是“选项式 API (Options API)”</p> 
<h3><a id="31__490"></a>3.1 项目布局</h3> 
<p><img src="https://images2.imgbox.com/d4/f6/Un1yROHk_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32__494"></a>3.2 源代码</h3> 
<p><strong>main.ts</strong></p> 
<pre><code class="prism language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token string">'./style.css'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>

<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

</code></pre> 
<p><strong>vite.config.ts</strong></p> 
<pre><code class="prism language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vite'</span>
<span class="token keyword">import</span> vue <span class="token keyword">from</span> <span class="token string">'@vitejs/plugin-vue'</span>


<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">"path"</span><span class="token punctuation">;</span>

<span class="token comment">// https://vitejs.dev/config/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 配置插件列表</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// !!!!配置路径别名!!!</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">'@'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 打包配置</span>
  build<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    target<span class="token operator">:</span> <span class="token string">'modules'</span><span class="token punctuation">,</span>
    <span class="token comment">// 设置输出路径</span>
    outDir<span class="token operator">:</span> <span class="token string">'dist'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 本地运行配置，及反向代理配置</span>
  server<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 默认启用并允许任何源</span>
    cors<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 使用默认浏览器中打开应用程序</span>
    open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 设置本地端口</span>
    port<span class="token operator">:</span> <span class="token number">4000</span><span class="token punctuation">,</span>
    <span class="token comment">// 在本地开发环境中，设置反向代理配置，注意配置rewrite</span>
    proxy<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// '/api': {<!-- --></span>
      <span class="token comment">//   // 设置代理接口访问实际地址</span>
      <span class="token comment">//   target: 'http://localhost/5000',</span>
      <span class="token comment">//   changeOrigin: true,</span>
      <span class="token comment">//   // 允许websocket代理</span>
      <span class="token comment">//   ws: true,</span>
      <span class="token comment">//   // 将api替换为空</span>
      <span class="token comment">//   rewrite: (path) =&gt; path.replace(/^\/api/, '')</span>
      <span class="token comment">// },</span>
      <span class="token comment">// '/socket.io': {<!-- --></span>
      <span class="token comment">//   target: `ws://127.0.0.1:5000`,</span>
      <span class="token comment">//   ws: true,</span>
      <span class="token comment">//   changeOrigin: true</span>
      <span class="token comment">//  },</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> 
<p><strong>App.vue</strong></p> 
<pre><code class="prism language-vue">&lt;script setup lang="ts"&gt;
import HelloWorld from './components/HelloWorld.vue'
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="app"&gt;
    &lt;HelloWorld msg="app" /&gt;
  &lt;/div&gt;
  
&lt;/template&gt;

&lt;style scoped&gt;
.app{
  width: 100%;
  height: 100%;
}
&lt;/style&gt;
</code></pre> 
<p>在”config/ws“目录下：</p> 
<p><strong>index.ts</strong></p> 
<pre><code class="prism language-typescript">
<span class="token comment">/*

import { io } from 'socket.io-client';

// 第一种连接方法
// 参考地址：https://socket.io/docs/v4/client-api/#io
export function create_socket(token: string) {
    const socket = io('http://127.0.0.1:5000', {
        // 指定传输方式，如WebSocket    
        transports: ['websocket'],
        // 是否自动连接
        autoConnect: true,
        // 是否自动重新连接
        reconnection: true,
        // 重新连接尝试次数
        reconnectionAttempts: 3,
        // 重新连接延迟时间（毫秒）
        reconnectionDelay: 1000,
        // 自定义查询参数
        // query: {
        //     token: token
        // },
        // 其他可选参数...
    });

    return socket;
}

*/</span>


<span class="token comment">// 第二种连接方法</span>
<span class="token comment">// 参考地址：https://socket.io/docs/v4/client-api/#manager</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Manager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"socket.io-client"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">create_socket</span><span class="token punctuation">(</span>token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Manager</span><span class="token punctuation">(</span><span class="token string">"ws://127.0.0.1:5000"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 指定传输方式，如WebSocket    </span>
        transports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'websocket'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 是否自动连接</span>
        autoConnect<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 是否自动重新连接</span>
        reconnection<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 重新连接尝试次数</span>
        reconnectionAttempts<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token comment">// 重新连接延迟时间（毫秒）</span>
        reconnectionDelay<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
        <span class="token comment">// 自定义查询参数</span>
        <span class="token comment">// query: {<!-- --></span>
        <span class="token comment">//     token: token</span>
        <span class="token comment">// },</span>
        <span class="token comment">// 其他可选参数...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> socket <span class="token operator">=</span> manager<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        auth<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            token<span class="token operator">:</span> token
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> socket
<span class="token punctuation">}</span>
</code></pre> 
<p>在”components“目录下：</p> 
<p><strong>HelloWorld.vue</strong></p> 
<pre><code class="prism language-vue">&lt;script setup lang="ts"&gt;
import { ref, onMounted } from 'vue'

import { create_socket } from '@/config/ws/index.ts';
const socket = create_socket("123");


defineProps&lt;{ msg: string }&gt;()


function re_open_conn(){
  // // 第一种方法连接
  let connect_res = socket.open();
  console.log(connect_res)
  
  // console.log(connect_res.connected)
  
  // 第二种方法连接
  // 默认通道 connect是通道名称
  // socket.on('connect', () =&gt; {
  //   console.log('连接成功');
  // });
}

function close_conn(){
  // 关闭连接，disconnect_res是一个Socket对象
  // socket.disconnect()和socket.close()作用相同
  // 对应后端的代码
  // @socketio.on('disconnect', namespace=name_space_user)
  let disconnect_res = socket.disconnect()
  console.log(disconnect_res)

  // 下面这种方法后端没反应
  // socket.on("disconnect", () =&gt; {
  //   console.log("关闭连接")
  // });
}

// 响应式状态
let msg = ref("测试")

function send_msg(){
  console.log("data_event" + msg.value)
  socket.emit("data_event", "Event " + msg.value)
  console.log(" data_msg "+ msg.value);
  socket.emit("data_msg", "Message " + msg.value)
}

// 更改状态、触发更新的函数
function listen_event() {

  socket.on('data_res', (data:string) =&gt; {
    console.log('监听事件(event)-对应后端emit()方法');
    console.log(data);
  });

  socket.on("message", function(data:string){
    console.log("监听消息(message)-对应后端send()方法:")
    console.log(data)
  });

}

onMounted(()=&gt;{
  listen_event()
});

function join_room(){
  socket.emit("join", {"username":"zhangsan", "room":"room1"})
}

function leave_room(){
  socket.emit("leave", {"username":"zhangsan", "room":"room1"})
}

function send_room(){
  socket.emit("send_room", {"username":"zhangsan", "room":"room1"})
}


&lt;/script&gt;

&lt;template&gt;
  &lt;div class="hello"&gt;
    &lt;button v-on:click="re_open_conn"&gt;打开连接&lt;/button&gt;
    &lt;button v-on:click="close_conn"&gt;关闭连接&lt;/button&gt;
    &lt;button v-on:click="send_msg"&gt;发送消息&lt;/button&gt;
    &lt;input v-model="msg"/&gt;

    &lt;br/&gt;
    &lt;button v-on:click="join_room"&gt;进入房间&lt;/button&gt;
    &lt;button v-on:click="leave_room"&gt;离开房间&lt;/button&gt;
    &lt;button v-on:click="send_room"&gt;房间发送消息&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.hello {
  color: #888;
}
&lt;/style&gt;

</code></pre> 
<p><strong>index.html</strong></p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/svg+xml<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/vite.svg<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Vite + Vue + TS<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/src/main.ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h2><a id="4__799"></a>4 运行结果</h2> 
<p><strong>前端</strong></p> 
<p><img src="https://images2.imgbox.com/4c/19/lqqc15Pc_o.png" alt="在这里插入图片描述"></p> 
<p><strong>后端</strong><br> <img src="https://images2.imgbox.com/53/e1/ofqhxKOe_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/161e1cc904bd84b208ff82c57093f207/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【实习面试题】机器学习算法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9ff29e83d521ddd26487c39917c66de6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">复制粘贴——QT实现原理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>