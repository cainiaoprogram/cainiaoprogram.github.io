<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>虚拟机使用主机显卡(hyper-v和WSL2) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="虚拟机使用主机显卡(hyper-v和WSL2)" />
<meta property="og:description" content="我的系统版本WSL2&#43;Ubuntu20.04&#43;CUDA启用WSL2&#43;安装Ubuntu20.04 主机安装WSL Cuda显卡驱动WSL2 Ubuntu安装cuda和cudnncudacudnn安装TensorFlow使用自带测试程序测试keras训练模型参考链接 hyper-v&#43;win10准备iso镜像使用hyper-v安装win10系统使用脚本配置GPU-Pv显卡驱动 hyper-v安装ghost备份文件创建虚拟机新建一个硬盘接着将这个硬盘添加到虚拟机里分区然后还原系统将DVD驱动器移除参考链接 我的系统版本 我更新到了最新的版本，这样可以避免很多不必要的麻烦。
WSL2&#43;Ubuntu20.04&#43;CUDA 启用WSL2&#43;安装Ubuntu20.04 这个很简单，请看：https://blog.csdn.net/RenLJ1895/article/details/122741040
主机安装WSL Cuda显卡驱动 在最新的显卡驱动都已经包含了WSL Cuda驱动，所以显卡驱动已经更新到最新版本，就不用重新安装了。另外：WSL2的Ubuntu系统里不需要再安装任何显卡相关的驱动
我的显卡驱动版本
WSL2 Ubuntu安装cuda和cudnn cuda 这个和再Ubuntu安装没有多大的区别，CUDA安装的命令查看地址：https://developer.nvidia.com/cuda-toolkit-archive
我选择的版本是11.6.0，接着再Ubuntu里面一个一个敲下面的命令等待安装完成。
更新~/.bashrc文件
#把这三行复制到文件底部 export CUDA_HOME=/usr/local/cuda export PATH=$PATH:$CUDA_HOME/bin export LD_LIBRARY_PATH=/usr/local/cuda-11.6/lib64${LD_LIBRARY_PATH:&#43;:${LD_LIBRARY_PATH}} #更新一下bashrc文件 source ~/.bashrc #更新一下可能需要的依赖 sudo apt-get install freeglut3-dev build-essential libx11-dev libxmu-dev libxi-dev libgl1-mesa-glx libglu1-mesa libglu1-mesa-dev #用以下代码检查cuda是否检查成功，注意此处的cuda版本是你在toolkit下载那里决定的，这个版本可能和nvidia-smi显示的版本号不一样，可高可低，这是因为nvidia给cuda开了两个api，这两个api只要差不是太远，基本都可以保证正常运行cuda nvcc -V ubuntu中的nvidia-smi目录再/usr/lib/wsl/lib/nvidia-smi，可以建个软链接到/usr/local/bin下，也可以将这个目录加到环境变量里，任何执行nvidia-smi(这里识别出cuda版本是11.7应该是主机的版本，这个不重要)
cudnn 下载地址：https://developer.nvidia.com/rdp/cudnn-archive (需要登录，下载最新的11.x, 其实就是11.6)
解压到cuda安装目录
#以下是安装命令 tar -zxvf cudnn-自己补全版本号.tgz sudo cp -P cuda/lib64/* /usr/local/cuda-11.6/lib64/ sudo cp cuda/include/cudnn.h /usr/local/cuda-11.6/include/ #为更改读取权限： sudo chmod a&#43;r /usr/local/cuda-11." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/42164693b56709f2e59c9062aff061b2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-10T17:44:42+08:00" />
<meta property="article:modified_time" content="2022-07-10T17:44:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">虚拟机使用主机显卡(hyper-v和WSL2)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4> </h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">我的系统版本</a></li><li><a href="#WSL2Ubuntu2004CUDA_5" rel="nofollow">WSL2+Ubuntu20.04+CUDA</a></li><li><ul><li><ul><li><a href="#WSL2Ubuntu2004_6" rel="nofollow">启用WSL2+安装Ubuntu20.04</a></li></ul> 
   </li></ul> 
   </li><li><a href="#WSL_Cuda_8" rel="nofollow">主机安装WSL Cuda显卡驱动</a></li><li><a href="#WSL2_Ubuntucudacudnn_13" rel="nofollow">WSL2 Ubuntu安装cuda和cudnn</a></li><li><ul><li><ul><li><a href="#cuda_14" rel="nofollow">cuda</a></li><li><a href="#cudnn_40" rel="nofollow">cudnn</a></li><li><a href="#TensorFlow_54" rel="nofollow">安装TensorFlow</a></li><li><a href="#_56" rel="nofollow">使用自带测试程序</a></li><li><a href="#keras_69" rel="nofollow">测试keras训练模型</a></li><li><a href="#_75" rel="nofollow">参考链接</a></li></ul> 
   </li></ul> 
   </li><li><a href="#hypervwin10_78" rel="nofollow">hyper-v+win10</a></li><li><ul><li><ul><li><a href="#iso_79" rel="nofollow">准备iso镜像</a></li><li><a href="#hypervwin10_82" rel="nofollow">使用hyper-v安装win10系统</a></li><li><a href="#GPUPv_84" rel="nofollow">使用脚本配置GPU-Pv</a></li><li><a href="#_95" rel="nofollow">显卡驱动</a></li></ul> 
   </li></ul> 
   </li><li><a href="#hypervghost_116" rel="nofollow">hyper-v安装ghost备份文件</a></li><li><ul><li><ul><li><a href="#_119" rel="nofollow">创建虚拟机</a></li><li><a href="#_122" rel="nofollow">新建一个硬盘</a></li><li><a href="#_126" rel="nofollow">接着将这个硬盘添加到虚拟机里</a></li><li><a href="#_130" rel="nofollow">分区然后还原系统</a></li><li><a href="#DVD_137" rel="nofollow">将DVD驱动器移除</a></li><li><a href="#_144" rel="nofollow">参考链接</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>我的系统版本</h3> 
<p>我更新到了最新的版本，这样可以避免很多不必要的麻烦。<br> <img src="https://images2.imgbox.com/73/03/o9Y8bp9V_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="WSL2Ubuntu2004CUDA_5"></a>WSL2+Ubuntu20.04+CUDA</h3> 
<h5><a id="WSL2Ubuntu2004_6"></a>启用WSL2+安装Ubuntu20.04</h5> 
<p>这个很简单，请看：https://blog.csdn.net/RenLJ1895/article/details/122741040</p> 
<h3><a id="WSL_Cuda_8"></a>主机安装WSL Cuda显卡驱动</h3> 
<p>在最新的显卡驱动都已经包含了WSL Cuda驱动，所以显卡驱动已经更新到最新版本，就不用重新安装了。<strong>另外：WSL2的Ubuntu系统里不需要再安装任何显卡相关的驱动</strong></p> 
<p>我的显卡驱动版本<br> <img src="https://images2.imgbox.com/f0/7c/NjNXMGhK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="WSL2_Ubuntucudacudnn_13"></a>WSL2 Ubuntu安装cuda和cudnn</h3> 
<h5><a id="cuda_14"></a>cuda</h5> 
<p>这个和再Ubuntu安装没有多大的区别，CUDA安装的命令查看地址：https://developer.nvidia.com/cuda-toolkit-archive</p> 
<p>我选择的版本是11.6.0，接着再Ubuntu里面一个一个敲下面的命令等待安装完成。</p> 
<p><img src="https://images2.imgbox.com/c5/18/KuCGgpfD_o.png" alt="在这里插入图片描述"><br> 更新<code>~/.bashrc</code>文件</p> 
<pre><code>#把这三行复制到文件底部
export CUDA_HOME=/usr/local/cuda
export PATH=$PATH:$CUDA_HOME/bin
export LD_LIBRARY_PATH=/usr/local/cuda-11.6/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
</code></pre> 
<pre><code>#更新一下bashrc文件
source ~/.bashrc
 
#更新一下可能需要的依赖
sudo apt-get install freeglut3-dev build-essential libx11-dev libxmu-dev libxi-dev libgl1-mesa-glx libglu1-mesa libglu1-mesa-dev
 
#用以下代码检查cuda是否检查成功，注意此处的cuda版本是你在toolkit下载那里决定的，这个版本可能和nvidia-smi显示的版本号不一样，可高可低，这是因为nvidia给cuda开了两个api，这两个api只要差不是太远，基本都可以保证正常运行cuda
nvcc -V
</code></pre> 
<p><img src="https://images2.imgbox.com/ed/6d/XkO5pMkK_o.png" alt="在这里插入图片描述"><br> ubuntu中的nvidia-smi目录再<code>/usr/lib/wsl/lib/nvidia-smi</code>，可以建个软链接到<code>/usr/local/bin</code>下，也可以将这个目录加到环境变量里，任何执行<code>nvidia-smi</code>(这里识别出cuda版本是11.7应该是主机的版本，这个不重要)<br> <img src="https://images2.imgbox.com/9d/19/qluKYona_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="cudnn_40"></a>cudnn</h5> 
<p>下载地址：https://developer.nvidia.com/rdp/cudnn-archive (需要登录，下载最新的11.x, 其实就是11.6)<br> <img src="https://images2.imgbox.com/18/40/XsVqWzH4_o.png" alt="在这里插入图片描述"><br> 解压到cuda安装目录</p> 
<pre><code>#以下是安装命令
tar -zxvf cudnn-自己补全版本号.tgz
sudo cp -P cuda/lib64/* /usr/local/cuda-11.6/lib64/
sudo cp cuda/include/cudnn.h /usr/local/cuda-11.6/include/
 
#为更改读取权限：
sudo chmod a+r /usr/local/cuda-11.6/include/cudnn.h
sudo chmod a+r /usr/local/cuda-11.6/lib64/*
</code></pre> 
<h5><a id="TensorFlow_54"></a>安装TensorFlow</h5> 
<p>我选择的是tensorflow-gpu==2.8.1, 因为2.0以后的TensorFlow自带了keras，直接import tensorflow.keras即可。所以不用额外安装了。</p> 
<h5><a id="_56"></a>使用自带测试程序</h5> 
<p><code>cat /usr/local/cuda/samples/README_CUDA_Samples.txt</code><br> 这个文件里有个GitHub的链接：https://github.com/NVIDIA/cuda-samples<br> 把文件拷下来(如果速度很慢，则需要点手段，这个就不说了)<br> <code>cd /usr/local/cuda/samples</code><br> <code>git clone https://github.com/NVIDIA/cuda-samples.git</code><br> 然后编译可执行文件<br> <code>cd cuda-samples</code><br> <code>sudo make</code><br> 需要等待个十几分钟吧，生成的可执行文件在<code>cuda-samples/bin/x86_64/linux/release</code> 目录<br> <img src="https://images2.imgbox.com/1f/e2/ydqc0jlC_o.png" alt="bin/x86_64/linux/release"><br> 测试通过，说明环境都没啥问题</p> 
<h5><a id="keras_69"></a>测试keras训练模型</h5> 
<p>在vscode里下载Remote-WSl 插件，左边就会多一个按钮。打开然后创建个目录写代码<br> <img src="https://images2.imgbox.com/8b/8c/b764ZGYe_o.png" alt="在这里插入图片描述"><br> 效果(可以看到显存已经占满了，训练也正常跑了)<br> 不过出了很多的警告信息，谷歌搜了下没找到什么原因，算了，能跑就行了<br> <img src="https://images2.imgbox.com/6e/91/LYoO9Pno_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_75"></a>参考链接</h5> 
<p>1、https://blog.csdn.net/iwanvan/article/details/122119595</p> 
<h3><a id="hypervwin10_78"></a>hyper-v+win10</h3> 
<h5><a id="iso_79"></a>准备iso镜像</h5> 
<p>需要下载和主机系统一样的镜像(主要是为了显卡驱动一模一样，保证直接拷贝主机显卡驱动文件到虚拟机不会出问题)</p> 
<h5><a id="hypervwin10_82"></a>使用hyper-v安装win10系统</h5> 
<p>步骤没什么区别</p> 
<h5><a id="GPUPv_84"></a>使用脚本配置GPU-Pv</h5> 
<p>下载脚本：https://github.com/Sam-Chai/gpu-pv-ps1</p> 
<p>修改图中两个位置，第一个为虚拟机的名称，第二个是虚拟机能使用的最大显存。我设置的和主机显卡一样<br> <img src="https://images2.imgbox.com/86/9f/MRlZaoWi_o.png" alt="在这里插入图片描述"><br> 然后右键使用powershell运行，这样会不容易看出输出信息。窗口一闪而过</p> 
<p>可以使用Powershell ISE来运行，打开位置如下<br> <img src="https://images2.imgbox.com/e1/30/b9lUSYkG_o.png" alt="在这里插入图片描述"><br> 将gpu.ps1文件直接拖到这个窗口，点击绿色的执行按钮就能看到输出，没报错输出完成就没问题<br> <img src="https://images2.imgbox.com/c0/d4/mIesiizx_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_95"></a>显卡驱动</h5> 
<p>现在直接打开虚拟机，虽然能在设备管理器里面看到显卡的信息，但是显示代码43，因为确实驱动程序，但是又不能直接使用驱动软件下载驱动。</p> 
<p>将虚拟机关机，并且挂着虚拟机的磁盘到主机，双击.vhdx文件就可以在磁盘管理里看到(也可以在磁盘管理右键选择附加VHD)，可能会有个报错，可以忽略，因为还没有分配盘符。右键分配一下盘符就行</p> 
<p>我已经分配过，一打开就挂载了，图中500G的那个<br> <img src="https://images2.imgbox.com/ff/a3/5eP8pGXB_o.png" alt="在这里插入图片描述"><br> 然后拷贝主机<code>C:\Windows\System32\DriverStore\FileRepository</code>目录下nv开头的文件夹到虚拟机硬盘<code>F:\Windows\System32\HostDriverStore\FileRepository</code>下(目录需要自己建)<br> <img src="https://images2.imgbox.com/6b/86/0YcT26JF_o.png" alt="在这里插入图片描述"><br> 然后在磁盘管理红圈的部分右键选择分离VHD，磁盘就取消挂载了<br> <img src="https://images2.imgbox.com/06/62/fLTer70N_o.png" alt="在这里插入图片描述"><br> 接着虚拟机开机就应该能看到显卡正常工作了<br> <img src="https://images2.imgbox.com/09/45/edPBBqBC_o.png" alt="在这里插入图片描述"><br> 具体有没有真的正常工作，这个还真不清楚，先跑个鲁大师试试<br> 虚拟机：<img src="https://images2.imgbox.com/23/2a/Q8lJVKX9_o.png" alt="在这里插入图片描述"><br> 主机：<br> <img src="https://images2.imgbox.com/bd/1b/sOaqQeCV_o.png" alt="在这里插入图片描述"><br> 相差还是挺大的，<s>而且在虚拟机跑鲁大师直接卡死了，要等他测完才能连接到</s> ，尴尬，虚拟机CPU只给了1核，我说怎么这么卡。</p> 
<p>后面在看看玩游戏的表现，跑模型就没必要了，用WSL或者直接在主机里跑更方便。</p> 
<h3><a id="hypervghost_116"></a>hyper-v安装ghost备份文件</h3> 
<p>一开始我不想安装系统，想直接备份主机的系统到ghost文件里。然后再hyper-v还原成虚拟机，但是还原后的虚拟机很卡，基本无法操作，估计是很多驱动都不兼容，分享下如果安装ghost</p> 
<h5><a id="_119"></a>创建虚拟机</h5> 
<p>其他步骤一样，就是选择镜像的时候，需要选择PE系统的ISO镜像，我这里选了微PE的镜像(下载微PE，就有生成ISO文件的选项)<br> <img src="https://images2.imgbox.com/ab/61/7hHyL45k_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_122"></a>新建一个硬盘</h5> 
<p>硬盘大小比ghost文件大一点就行，比如我备份的系统文件大小是62G，虚拟硬盘选个63G就行了，选择固定大小(因为看到下面写了更好的性能)<br> <img src="https://images2.imgbox.com/ea/0c/6CRAfPq5_o.png" alt="在这里插入图片描述"><br> 生成虚拟硬盘文件之后，就是挂载这个硬盘，然后拷贝ghost文件到虚拟硬盘，这样做的目的是因为到时候要在虚拟机里还原系统，ghost文件又不能放系统盘，所以创建个盘来装。装完系统这个盘就可以卸载了</p> 
<h5><a id="_126"></a>接着将这个硬盘添加到虚拟机里</h5> 
<p>添加刚才的包含ghost文件的虚拟硬盘<br> <img src="https://images2.imgbox.com/2c/84/HGwQSAK1_o.png" alt="在这里插入图片描述"><br> 接着开机，正常应该进入到pe系统</p> 
<h5><a id="_130"></a>分区然后还原系统</h5> 
<p><img src="https://images2.imgbox.com/87/ae/m86Y6Zzu_o.png" alt="在这里插入图片描述"></p> 
<p>因为选的第二代，分区的格式必须选择GPT，不能选MBR，第二代引导是UEFI。还原成功后，需要修复下UEFI引导(可能是非必要的)</p> 
<p>这个就不截图演示了</p> 
<h5><a id="DVD_137"></a>将DVD驱动器移除</h5> 
<p>选择无点应用就可以了，包含ghost文件的虚拟硬盘也可以移除<br> <img src="https://images2.imgbox.com/10/96/0DGW0gRB_o.png" alt="在这里插入图片描述"><br> 如果你也修复了UEFI引导，那么在固件的位置会增加一个文件，这个不用管<br> <img src="https://images2.imgbox.com/5e/a4/lSLO3oba_o.png" alt="在这里插入图片描述"><br> 点开机然后应该就能正常进入系统，</p> 
<h5><a id="_144"></a>参考链接</h5> 
<p>1、https://www.bilibili.com/read/cv15539810<br> 2、https://www.bilibili.com/video/BV11u411U7KJ</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0fa91cc77f26cae9821e19b462700aa1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">力扣每日一题-第33天-599. 两个列表的最小索引总和</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/315e1cb0b6d7209044c47739864583ee/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[ECharts] Component legend is used but not imported.</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>