<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2个nodejs进程利用redis 实现订阅发布 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2个nodejs进程利用redis 实现订阅发布" />
<meta property="og:description" content="1.新建文件 redis_db.js &#39;use strict&#39;; const redis = require(&#39;redis&#39;); const options = { host: &#34;127.0.0.1&#34;, port: 6379, password: &#34;123456&#34;, // CONFIG SET requirepass &#34;123456&#34; } var array = [] for(var i=0; i&lt;3; i&#43;&#43;){ const client = redis.createClient(options) array.push(client) } function getDB(index){ if(typeof index === &#34;number&#34;){ return array[index] } return array } for(var key in array){ const client = array[key] client.on(&#39;error&#39;, err =&gt; console.log(&#39;------ client Redis connection failed ------&#39; &#43; err)) ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/05f9e9a2c38690e16709b10d74d6a262/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-08T09:12:56+08:00" />
<meta property="article:modified_time" content="2024-01-08T09:12:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2个nodejs进程利用redis 实现订阅发布</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>1.新建文件 redis_db.js</h3> 
<pre><code class="language-javascript">'use strict';

const redis = require('redis');
const options = {
    host: "127.0.0.1",
    port: 6379,
    password: "123456", // CONFIG SET requirepass "123456"
}

var array = []
for(var i=0; i&lt;3; i++){
    const client = redis.createClient(options)
    array.push(client)
}

function getDB(index){
    if(typeof index === "number"){
        return array[index]
    }
    return array
}

for(var key in array){
    const client = array[key]
    client.on('error', err =&gt; console.log('------ client Redis connection failed ------' + err))
        .on('connect', () =&gt; console.log('------ client Redis connection succeed ------')
    )
}

module.exports = {
    getDB,
}
</code></pre> 
<p>备注1：安装 reids 啥的就不说了</p> 
<p><a href="https://blog.csdn.net/weixin_65777087/article/details/131462691" title="【保姆级】Redis安装教程（Windows版）_windows安装redis-CSDN博客">【保姆级】Redis安装教程（Windows版）_windows安装redis-CSDN博客</a></p> 
<p><a href="https://blog.csdn.net/ic_xcc/article/details/133027232" title="linux环境安装redis(亲测完成)_linux 斌阿姨安装redis-CSDN博客">linux环境安装redis(亲测完成)_linux 斌阿姨安装redis-CSDN博客</a></p> 
<p>备注2：新增3个redis的连接:  [0] 是之前的;  [1] 用于sub; [2] 用于pub</p> 
<p>如果没有多个的话，sub和pub的时候会报错 </p> 
<p>ReplyError: ERR only (P)SUBSCRIBE / (P)UNSUBSCRIBE / QUIT allowed in this context</p> 
<h3>2.新建文件 redis_ipc.js</h3> 
<pre><code class="language-javascript">var redis_db = require("./redis_db.js");
const clients  = redis_db.getDB()
const client1  = clients[1]
const client2  = clients[2]

function mySub(channelName, handleMessage){
    // 订阅指定的频道
    client1.subscribe(channelName, (err, channels) =&gt; {
        if (err) {
            console.error('无法订阅频道：', err);
        } else {
            // 设置每次收到新消息时调用的处理函数
            client1.on('message', handleMessage);
        }
    })
}

function myPub(channelName, messageContent){
    client2.publish(channelName, messageContent, (err, reply) =&gt; {
        if (!err &amp;&amp; reply === 0) {
            console.log(`消息 "${messageContent}" 未被任何人接收。`);
        } else if (!err &amp;&amp; reply &gt; 0) {
            console.log(`消息 "${messageContent}" 已成功发送给 ${reply} 个订阅者。`);
        } else {
            console.error('发送消息失败：', err);
        }
    });
}

module.exports = {
    mySub,
    myPub,
}
</code></pre> 
<h3>3.新增测试代码</h3> 
<h4>3.1新建文件test01.js 测试同个进程的</h4> 
<pre><code class="language-javascript">
const redis_ipc = require('./redis_ipc.js')
function testSubPub(){
    const channelName = 'test_channel_1';
    function handleMessage(channel, message) {
        // 在这里编写处理收到消息后的操作
        console.log(`收到来自 ${channel} 通道的消息：${message}`);
    }
    redis_ipc.mySub(channelName, handleMessage)

    const messageContent = '{"data":{"name":"xxx","age":"18"}}';
    redis_ipc.myPub(channelName, messageContent)
}

testSubPub()</code></pre> 
<p>目录如下:</p> 
<p><img alt="" height="69" src="https://images2.imgbox.com/65/df/Mv1H5mjI_o.png" width="390"></p> 
<p>执行指令：node .\test01.js</p> 
<p><img alt="" height="135" src="https://images2.imgbox.com/38/f3/iZWG3AIE_o.png" width="562"></p> 
<h4>3.2新建文件test02.js test03.js 测试同个进程的</h4> 
<pre><code class="language-javascript">// test02.js
const redis_ipc = require('./redis_ipc.js')
function testSubPub(){
    const channelName = 'test_channel_1';
    function handleMessage(channel, message) {
        // 在这里编写处理收到消息后的操作
        console.log(`收到来自 ${channel} 通道的消息：${message}`);
    }
    redis_ipc.mySub(channelName, handleMessage)

    // const messageContent = '{"data":{"name":"xxx","age":"18"}}';
    // redis_ipc.myPub(channelName, messageContent)
}

testSubPub()</code></pre> 
<pre><code class="language-javascript">test03.js
const redis_ipc = require('./redis_ipc.js')
function testSubPub(){
    const channelName = 'test_channel_1';
    // function handleMessage(channel, message) {
    //     // 在这里编写处理收到消息后的操作
    //     console.log(`收到来自 ${channel} 通道的消息：${message}`);
    // }
    // redis_ipc.mySub(channelName, handleMessage)

    const messageContent = '{"data":{"name":"xxx","age":"18"}}';
    redis_ipc.myPub(channelName, messageContent)
}

testSubPub()</code></pre> 
<p>订阅者：先在一个终端执行 node .\test02.js </p> 
<p><img alt="" height="108" src="https://images2.imgbox.com/c5/c6/yI0moLWn_o.png" width="649"></p> 
<p>发布者：再在一个终端执行 node .\test03.js</p> 
<p><img alt="" height="121" src="https://images2.imgbox.com/a3/cd/2tqpAT6D_o.png" width="562"></p> 
<p>观察第一个终端 会收到 发布者的消息</p> 
<p><img alt="" height="121" src="https://images2.imgbox.com/c0/42/DKkRUkuZ_o.png" width="568"></p> 
<h3>4.大功告成</h3> 
<p><img alt="" height="352" src="https://images2.imgbox.com/5e/a4/pU3erOUo_o.gif" width="1200"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/60227077f0519195603cc64d66c89d0d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">docker拉取镜像提示 remote trust data does not exist for xxxxxx</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dd8f934eb7dcc5c69bda5f1e4bf0b987/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Open CV 图像处理基础：（四）使用 Open CV 在 Java 中进行基本的图片模糊处理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>