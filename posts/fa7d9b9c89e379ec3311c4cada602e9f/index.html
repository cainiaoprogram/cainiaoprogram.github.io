<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL运维实战(2.4) SSL认证在MySQL中的应用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL运维实战(2.4) SSL认证在MySQL中的应用" />
<meta property="og:description" content="作者：俊达
引言 MySQL支持使用TLS协议进行通信，该协议在数据库通信中具有关键作用。首先，TLS能够加密客户端与服务端之间的通信数据，涵盖了客户端发送至服务端的SQL请求以及服务端返回给客户端的数据，从而确保敏感信息的保密性和完整性。除此之外，TLS还允许客户端验证服务端的身份，确保安全连接。同时，TLS还使得服务端能够验证客户端的身份，实现双向认证，从而进一步增强了通信安全性和互信性。这些TLS功能在MySQL通信中发挥着重要作用，为数据传输提供了必要的保护和验证机制。
1 Server端开启SSL 服务端默认已经开启SSL，可以通过如下命令查看是否支持SSL：
参数have_ssl为 YES
| have_openssl | YES | | have_ssl | YES | | ssl_ca | ca.pem | | ssl_capath | | | ssl_cert | server-cert.pem | | ssl_cipher | | | ssl_crl | | | ssl_crlpath | | | ssl_key | server-key.pem | 参数说明：
参数说明have_openssl和have_ssl一样have_sslYES: 启用SSLDISABLED: 已经编译了SSL功能，但是没有开启ssl_caCA文件，默认是ca.pemssl_capathCA文件路径，默认为空。mysqld会从datadir查找ca.pemssl_cert服务端证书，默认server-cert.pem.ssl_cipherSSL加密方式，默认为空ssl_crlcertificate revocation lists文件，默认为空ssl_crlpathcertificate revocation lists文件路径，默认为空ssl_key服务端证书私钥，默认server-key.pem. server端启用SSL，需要ca.pem, server-cert.pem, server-key.pem 3个文件。
客户端需要有ca.pem, client-cert.pem, client-key.pem 3个文件。
2 客户端SSL 使用mysql客户端连接到服务端时，默认会使用加密通信，
登陆后输入 \s, 或者show status like ‘ssl_cipher’，如果看Cipher信息，说明连接已经开启加密通信" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fa7d9b9c89e379ec3311c4cada602e9f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-05T14:11:53+08:00" />
<meta property="article:modified_time" content="2024-01-05T14:11:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL运维实战(2.4) SSL认证在MySQL中的应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><em>作者：俊达</em></p> 
<h3><a id="_1"></a>引言</h3> 
<p>MySQL支持使用TLS协议进行通信，该协议在数据库通信中具有关键作用。首先，TLS能够加密客户端与服务端之间的通信数据，涵盖了客户端发送至服务端的SQL请求以及服务端返回给客户端的数据，从而确保敏感信息的保密性和完整性。除此之外，TLS还允许客户端验证服务端的身份，确保安全连接。同时，TLS还使得服务端能够验证客户端的身份，实现双向认证，从而进一步增强了通信安全性和互信性。这些TLS功能在MySQL通信中发挥着重要作用，为数据传输提供了必要的保护和验证机制。</p> 
<h3><a id="1_ServerSSL_3"></a>1 Server端开启SSL</h3> 
<p>服务端默认已经开启SSL，可以通过如下命令查看是否支持SSL：<br> 参数have_ssl为 YES</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">|</span> have_openssl  <span class="token punctuation">|</span> YES             <span class="token punctuation">|</span>
<span class="token punctuation">|</span> have_ssl      <span class="token punctuation">|</span> YES             <span class="token punctuation">|</span>
<span class="token punctuation">|</span> ssl_ca        <span class="token punctuation">|</span> ca<span class="token punctuation">.</span>pem          <span class="token punctuation">|</span>
<span class="token punctuation">|</span> ssl_capath    <span class="token punctuation">|</span>                 <span class="token punctuation">|</span>
<span class="token punctuation">|</span> ssl_cert      <span class="token punctuation">|</span> server-cert<span class="token punctuation">.</span>pem <span class="token punctuation">|</span>
<span class="token punctuation">|</span> ssl_cipher    <span class="token punctuation">|</span>                 <span class="token punctuation">|</span>
<span class="token punctuation">|</span> ssl_crl       <span class="token punctuation">|</span>                 <span class="token punctuation">|</span>
<span class="token punctuation">|</span> ssl_crlpath   <span class="token punctuation">|</span>                 <span class="token punctuation">|</span>
<span class="token punctuation">|</span> ssl_key       <span class="token punctuation">|</span> server-key<span class="token punctuation">.</span>pem  <span class="token punctuation">|</span>
</code></pre> 
<p>参数说明：</p> 
<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>have_openssl</td><td>和have_ssl一样</td></tr><tr><td>have_ssl</td><td>YES: 启用SSL</td></tr><tr><td></td><td>DISABLED: 已经编译了SSL功能，但是没有开启</td></tr><tr><td>ssl_ca</td><td>CA文件，默认是ca.pem</td></tr><tr><td>ssl_capath</td><td>CA文件路径，默认为空。mysqld会从datadir查找ca.pem</td></tr><tr><td>ssl_cert</td><td>服务端证书，默认server-cert.pem.</td></tr><tr><td>ssl_cipher</td><td>SSL加密方式，默认为空</td></tr><tr><td>ssl_crl</td><td>certificate revocation lists文件，默认为空</td></tr><tr><td>ssl_crlpath</td><td>certificate revocation lists文件路径，默认为空</td></tr><tr><td>ssl_key</td><td>服务端证书私钥，默认server-key.pem.</td></tr></tbody></table> 
<p>server端启用SSL，需要ca.pem, server-cert.pem, server-key.pem 3个文件。<br> 客户端需要有ca.pem, client-cert.pem, client-key.pem 3个文件。</p> 
<h3><a id="2_SSL_34"></a>2 客户端SSL</h3> 
<p>使用mysql客户端连接到服务端时，默认会使用加密通信，<br> 登陆后输入 \s, 或者show status like ‘ssl_cipher’，如果看Cipher信息，说明连接已经开启加密通信</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 mysql]</span><span class="token comment"># mysql -uroot -h127.0.0.1 -P3306 -phello</span>
Server version: 5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>32 MySQL Community Server <span class="token punctuation">(</span>GPL<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">Type</span> <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help<span class="token punctuation">.</span> <span class="token function">Type</span> <span class="token string">'\c'</span> to clear the current input statement<span class="token punctuation">.</span>

mysql&gt; \s
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
mysql  Ver 14<span class="token punctuation">.</span>14 Distrib 5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>32<span class="token punctuation">,</span> <span class="token keyword">for</span> Linux <span class="token punctuation">(</span>x86_64<span class="token punctuation">)</span> <span class="token keyword">using</span>  EditLine wrapper

Connection id:		23
Current database:
Current user:		root@localhost
SSL:			Cipher in use is ECDHE-RSA-AES128-GCM-SHA256
Current pager:		stdout
<span class="token keyword">Using</span> outfile:		<span class="token string">''</span>
<span class="token keyword">Using</span> delimiter:	<span class="token punctuation">;</span>
Server version:		5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>32 MySQL Community Server <span class="token punctuation">(</span>GPL<span class="token punctuation">)</span>
Protocol version:	10
Connection:		127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1 via TCP/IP
Server characterset:	latin1


mysql&gt; show status like <span class="token string">'ssl_cipher'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value                       <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Ssl_cipher    <span class="token punctuation">|</span> ECDHE-RSA-AES128-GCM-SHA256 <span class="token punctuation">|</span>
</code></pre> 
<h4><a id="21_ssl_67"></a>2.1 客户端禁用ssl通信</h4> 
<p>mysql客户端登陆时加上 --ssl-mode=disabled禁用TLS通信</p> 
<pre><code class="prism language-powershell">mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>h127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1 <span class="token operator">-</span>P3306 <span class="token operator">-</span>phello <span class="token operator">--</span>ssl-mode=disabled

mysql&gt; \s
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
mysql  Ver 14<span class="token punctuation">.</span>14 Distrib 5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>32<span class="token punctuation">,</span> <span class="token keyword">for</span> Linux <span class="token punctuation">(</span>x86_64<span class="token punctuation">)</span> <span class="token keyword">using</span>  EditLine wrapper

Connection id:		25
Current database:
Current user:		root@localhost
SSL:			Not in use
Current pager:		stdout


mysql&gt; show status like <span class="token string">'ssl_cipher'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Ssl_cipher    <span class="token punctuation">|</span>       <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
</code></pre> 
<h4><a id="22_91"></a>2.2客户端要求验证服务端证书</h4> 
<p>客户端可以要求验证服务端的证书。<br> mysql客户端将ssl-mode参数设置为verify_ca或verify_identity, 同时需要提供用来签名的ca证书。<br> verify_ca的作用，是为了让服务端证明，他的证书是客户端参数中的指定的ca签名的。其他服务器无法冒充。</p> 
<pre><code class="prism language-powershell">mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>h127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1 <span class="token operator">-</span>P3306 <span class="token operator">-</span>phello <span class="token operator">--</span>ssl-mode=verify_ca <span class="token operator">--</span>ssl-ca=ca<span class="token punctuation">.</span>pem

 show status like <span class="token string">'ssl_cipher'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value                       <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Ssl_cipher    <span class="token punctuation">|</span> ECDHE-RSA-AES128-GCM-SHA256 <span class="token punctuation">|</span>
</code></pre> 
<p>如果证书验证不通过，客户端连接会报错。服务端日志中也能看到相关报错信息。</p> 
<pre><code class="prism language-powershell"><span class="token comment">### client</span>
root@box1 mysql<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -h127.0.0.1 -P3306 -phello --ssl-mode=verify_ca --ssl-ca=/data/mysql01/data/ca.pem</span>
mysql: <span class="token namespace">[Warning]</span> <span class="token keyword">Using</span> a password on the command line interface can be insecure<span class="token punctuation">.</span>
ERROR 2026 <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: SSL connection error: error:00000001:lib<span class="token punctuation">(</span>0<span class="token punctuation">)</span>:func<span class="token punctuation">(</span>0<span class="token punctuation">)</span>:reason<span class="token punctuation">(</span>1<span class="token punctuation">)</span>

<span class="token comment">### server</span>
<span class="token namespace">[root@box1 mysql]</span><span class="token comment"># tail -1 /var/log/mysqld.log</span>
2021-03-31T23:34:20<span class="token punctuation">.</span>461350Z 28 <span class="token namespace">[Note]</span> Bad handshake
</code></pre> 
<h3><a id="3_SSL_117"></a>3 服务端要求验证客户端使用SSL登录</h3> 
<p>虽然服务端开启了SSL，但是默认情况下用户可以选择启用或不启用加密通信。<br> 服务端可以强制要求客户端使用加密通信，也可以要求客户端证明自己的身份。<br> 这可以在创建用户的时候指定。</p> 
<pre><code class="prism language-powershell">CREATE USER <span class="token string">'user_1'</span>@<span class="token string">'%'</span>  identified by <span class="token string">'hello'</span> require ssl<span class="token punctuation">;</span>
CREATE USER <span class="token string">'user_2'</span>@<span class="token string">'%'</span>  identified by <span class="token string">'hello'</span> require x509<span class="token punctuation">;</span>
CREATE USER <span class="token string">'user_3'</span>@<span class="token string">'%'</span>  identified by <span class="token string">'hello'</span> require cipher <span class="token string">'ECDHE-RSA-AES256-GCM-SHA384'</span><span class="token punctuation">;</span>
CREATE USER <span class="token string">'user_4'</span>@<span class="token string">'%'</span>  identified by <span class="token string">'hello'</span> require cipher <span class="token string">'ECDHE-ECDSA-AES256-GCM-SHA384'</span><span class="token punctuation">;</span>
CREATE USER <span class="token string">'user_5'</span>@<span class="token string">'%'</span>  identified by <span class="token string">'hello'</span> require issuer <span class="token string">'www.dtstack.com'</span> <span class="token punctuation">;</span>
CREATE USER <span class="token string">'user_6'</span>@<span class="token string">'%'</span>  identified by <span class="token string">'hello'</span> require subject <span class="token string">'/CN=client.dtstack.com'</span><span class="token punctuation">;</span>
</code></pre> 
<p>上面创建的用户中，<br> user_1必须开启SSL加密才能连接到服务器<br> user_2需要使用x509证书格式<br> user_3需要使用cipher ECDHE-RSA-AES256-GCM-SHA384<br> user_4需要使用cipher ECDHE-ECDSA-AES256-GCM-SHA384<br> user_5需要使用www.dtstack.com签发的证书<br> user_6需要使用subject为client.dtstack.com的证书</p> 
<h3><a id="4_136"></a>4测试用户信息</h3> 
<pre><code class="prism language-powershell"><span class="token function">select</span> user<span class="token punctuation">,</span>host<span class="token punctuation">,</span> ssl_type<span class="token punctuation">,</span> ssl_cipher<span class="token punctuation">,</span> x509_issuer<span class="token punctuation">,</span> x509_subject <span class="token keyword">from</span> mysql<span class="token punctuation">.</span>user where user like <span class="token string">'user%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span> user   <span class="token punctuation">|</span> host <span class="token punctuation">|</span> ssl_type  <span class="token punctuation">|</span> ssl_cipher                    <span class="token punctuation">|</span> x509_issuer     <span class="token punctuation">|</span> x509_subject           <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span> user_1 <span class="token punctuation">|</span> <span class="token operator">%</span>    <span class="token punctuation">|</span> ANY       <span class="token punctuation">|</span>                               <span class="token punctuation">|</span>                 <span class="token punctuation">|</span>                        <span class="token punctuation">|</span>
<span class="token punctuation">|</span> user_2 <span class="token punctuation">|</span> <span class="token operator">%</span>    <span class="token punctuation">|</span> X509      <span class="token punctuation">|</span>                               <span class="token punctuation">|</span>                 <span class="token punctuation">|</span>                        <span class="token punctuation">|</span>
<span class="token punctuation">|</span> user_3 <span class="token punctuation">|</span> <span class="token operator">%</span>    <span class="token punctuation">|</span> SPECIFIED <span class="token punctuation">|</span> ECDHE-RSA-AES256-GCM-SHA384   <span class="token punctuation">|</span>                 <span class="token punctuation">|</span>                        <span class="token punctuation">|</span>
<span class="token punctuation">|</span> user_4 <span class="token punctuation">|</span> <span class="token operator">%</span>    <span class="token punctuation">|</span> SPECIFIED <span class="token punctuation">|</span> ECDHE-ECDSA-AES256-GCM-SHA384 <span class="token punctuation">|</span>                 <span class="token punctuation">|</span>                        <span class="token punctuation">|</span>
<span class="token punctuation">|</span> user_5 <span class="token punctuation">|</span> <span class="token operator">%</span>    <span class="token punctuation">|</span> SPECIFIED <span class="token punctuation">|</span>                               <span class="token punctuation">|</span> www<span class="token punctuation">.</span>dtstack<span class="token punctuation">.</span>com <span class="token punctuation">|</span> client<span class="token punctuation">.</span>dtstack<span class="token punctuation">.</span>com     <span class="token punctuation">|</span>
<span class="token punctuation">|</span> user_6 <span class="token punctuation">|</span> <span class="token operator">%</span>    <span class="token punctuation">|</span> SPECIFIED <span class="token punctuation">|</span>                               <span class="token punctuation">|</span>                 <span class="token punctuation">|</span> <span class="token operator">/</span>CN=client<span class="token punctuation">.</span>dtstack<span class="token punctuation">.</span>com <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
</code></pre> 
<h4><a id="41SSL_151"></a>4.1强制SSL</h4> 
<p>user_1登陆，如果不开启ssl-mode，登陆报错。使用SSL才能登陆</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_1 -phello -h127.0.0.1 --ssl-mode=disabled</span>
mysql: <span class="token namespace">[Warning]</span> <span class="token keyword">Using</span> a password on the command line interface can be insecure<span class="token punctuation">.</span>
ERROR 1045 <span class="token punctuation">(</span>28000<span class="token punctuation">)</span>: Access denied <span class="token keyword">for</span> user <span class="token string">'user_1'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span><span class="token keyword">using</span> password: YES<span class="token punctuation">)</span>

<span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_1 -phello -h127.0.0.1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">Type</span> <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help<span class="token punctuation">.</span> <span class="token function">Type</span> <span class="token string">'\c'</span> to clear the current input statement<span class="token punctuation">.</span>

mysql&gt; \s
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Current user:		user_1@localhost
SSL:			Cipher in use is ECDHE-RSA-AES128-GCM-SHA256
</code></pre> 
<h4><a id="42_167"></a>4.2强制使用客户端证书</h4> 
<p>user_2需要x509证书才能登陆</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_2 -phello -h127.0.0.1</span>
ERROR 1045 <span class="token punctuation">(</span>28000<span class="token punctuation">)</span>: Access denied <span class="token keyword">for</span> user <span class="token string">'user_2'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span><span class="token keyword">using</span> password: YES<span class="token punctuation">)</span>

<span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_2 -phello -h127.0.0.1 --ssl-mode=required</span>
ERROR 1045 <span class="token punctuation">(</span>28000<span class="token punctuation">)</span>: Access denied <span class="token keyword">for</span> user <span class="token string">'user_2'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span><span class="token keyword">using</span> password: YES<span class="token punctuation">)</span>

<span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_2 -phello -h127.0.0.1  --ssl-cert=client-cert.pem --ssl-key=client-key.pem</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Welcome to the MySQL monitor<span class="token punctuation">.</span>  Commands <span class="token keyword">end</span> with <span class="token punctuation">;</span> or \g<span class="token punctuation">.</span>
mysql&gt; \s
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Current user:		user_2@localhost
SSL:			Cipher in use is ECDHE-RSA-AES128-GCM-SHA256
</code></pre> 
<h4><a id="43_cipher_184"></a>4.3 强制指定客户端cipher</h4> 
<p>user_3指定了cipher, 无法登陆。 可以从服务端alert.log查看登陆失败的原因。</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_3 -pxhello -h127.0.0.1 --ssl-mode=required --ssl-cert=client-cert.pem --ssl-key=client-key.pem</span>
ERROR 1045 <span class="token punctuation">(</span>28000<span class="token punctuation">)</span>: Access denied <span class="token keyword">for</span> user <span class="token string">'user_3'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span><span class="token keyword">using</span> password: YES<span class="token punctuation">)</span>

<span class="token comment">### 服务端日志</span>
<span class="token namespace">[root@box1 mysql]</span><span class="token comment"># tail -1 /var/log/mysqld.log2021-04-01T00:07:44.216859Z 51 [Note] X509 ciphers mismatch: should be 'ECDHE-RSA-AES256-GCM-SHA384' but is 'ECDHE-RSA-AES128-GCM-SHA256'</span>
2021-04-01T00:07:44<span class="token punctuation">.</span>216915Z 51 <span class="token namespace">[Note]</span> Access denied <span class="token keyword">for</span> user <span class="token string">'user_3'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span><span class="token keyword">using</span> password: YES<span class="token punctuation">)</span>
</code></pre> 
<p>说明了cipher不满足要求。<br> my.cnf增加ssl_ciphper参数，重启服务</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 mysql]</span><span class="token comment"># tail -1 /etc/my.cnf</span>
ssl_cipher=ECDHE-RSA-AES256-GCM-SHA384
<span class="token namespace">[root@box1 mysql]</span><span class="token comment"># service mysqld restart</span>
Redirecting to <span class="token operator">/</span>bin/systemctl restart mysqld<span class="token punctuation">.</span>service
</code></pre> 
<pre><code class="prism language-powershell"><span class="token operator">--</span> 再次尝试登陆，可以看到SSL 使用的ciper变成了 ECDHE-RSA-AES256-GCM-SHA384

<span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_3 -phello -h127.0.0.1 --ssl-mode=required --ssl-cert=client-cert.pem --ssl-key=client-key.pem</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
mysql&gt; \s

Current user:		user_3@localhost
SSL:			Cipher in use is ECDHE-RSA-AES256-GCM-SHA384
</code></pre> 
<h4><a id="44subject__issuer_214"></a>4.4验证客户端证书的subject 和 issuer</h4> 
<pre><code class="prism language-powershell"><span class="token comment">### client</span>
<span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_5 -phello -h127.0.0.1 --ssl-mode=required --ssl-cert=client-cert.pem --ssl-key=client-key.pem</span>
ERROR 1045 <span class="token punctuation">(</span>28000<span class="token punctuation">)</span>: Access denied <span class="token keyword">for</span> user <span class="token string">'user_5'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span><span class="token keyword">using</span> password: YES<span class="token punctuation">)</span>

<span class="token comment">### server</span>
<span class="token namespace">[root@box1 mysql]</span><span class="token comment"># tail -2 /var/log/mysqld.log</span>
2021-04-01T01:17:21<span class="token punctuation">.</span>692560Z 6 <span class="token namespace">[Note]</span> X509 issuer mismatch: should be <span class="token string">'www.dtstack.com'</span> but is <span class="token string">'/C=CN/ST=HZ/L=ZJ/O=lazybug CO/OU=freecity/CN=www.dtstack.com/emailAddress=junda@dtstack.com'</span>
2021-04-01T01:17:21<span class="token punctuation">.</span>692607Z 6 <span class="token namespace">[Note]</span> Access denied <span class="token keyword">for</span> user <span class="token string">'user_5'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span><span class="token keyword">using</span> password: YES<span class="token punctuation">)</span>

<span class="token comment">### client</span>
<span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_6 -phello -h127.0.0.1 --ssl-mode=required --ssl-cert=client-cert.pem --ssl-key=client-key.pem</span>
ERROR 1045 <span class="token punctuation">(</span>28000<span class="token punctuation">)</span>: Access denied <span class="token keyword">for</span> user <span class="token string">'user_6'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span><span class="token keyword">using</span> password: YES<span class="token punctuation">)</span>

<span class="token comment">### server</span>
<span class="token namespace">[root@box1 mysql]</span><span class="token comment"># tail -2 /var/log/mysqld.log</span>
2021-04-01T01:20:41<span class="token punctuation">.</span>297093Z 8 <span class="token namespace">[Note]</span> X509 subject mismatch: should be <span class="token string">'/CN=client.dtstack.com'</span> but is <span class="token string">'/C=XX/L=Default City/O=Default Company Ltd'</span>
2021-04-01T01:20:41<span class="token punctuation">.</span>297144Z 8 <span class="token namespace">[Note]</span> Access denied <span class="token keyword">for</span> user <span class="token string">'user_6'</span>@<span class="token string">'localhost'</span> <span class="token punctuation">(</span><span class="token keyword">using</span> password: YES<span class="token punctuation">)</span>
</code></pre> 
<p>重新生成client证书，指定subject</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 pki]</span><span class="token comment"># openssl req -subj /CN=client.dtstack.com -newkey rsa:2048 -days 3600 \</span>
        <span class="token operator">-</span>nodes <span class="token operator">-</span>keyout client-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>out client-req<span class="token punctuation">.</span>pem
        
writing new private key to <span class="token string">'client-key.pem'</span>

<span class="token namespace">[root@box1 pki]</span><span class="token comment"># openssl rsa -in client-key.pem -out client-key.pem</span>
writing RSA key

<span class="token namespace">[root@box1 pki]</span><span class="token comment"># openssl x509 -sha384 -req -in client-req.pem -days 3600 \</span>
&gt;         <span class="token operator">-</span>CA ca<span class="token punctuation">.</span>pem <span class="token operator">-</span>CAkey ca-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>set_serial 01 <span class="token operator">-</span>out client-cert<span class="token punctuation">.</span>pem
Signature ok
subject=<span class="token operator">/</span>CN=client<span class="token punctuation">.</span>dtstack<span class="token punctuation">.</span>com
Getting CA Private Key
</code></pre> 
<p>使用新的证书，就可以登录的数据库了：</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 pki]</span><span class="token comment"># mysql -uuser_6 -phello -h127.0.0.1 --ssl-mode=required --ssl-cert=client-cert.pem --ssl-key=client-key.pem</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
mysql&gt; \s
Current user:		user_6@localhost
SSL:			Cipher in use is ECDHE-RSA-AES256-GCM-SHA384
</code></pre> 
<h3><a id="SSL_258"></a>附录：SSL证书相关命令</h3> 
<h4><a id="_259"></a>生成证书的命令</h4> 
<pre><code class="prism language-powershell"><span class="token comment"># Create clean environment</span>
<span class="token function">rm</span> <span class="token operator">-</span>rf newcerts
mkdir newcerts &amp;&amp; cd newcerts

<span class="token comment"># Create CA certificate</span>
openssl genrsa 2048 &gt; ca-key<span class="token punctuation">.</span>pem
openssl req <span class="token operator">-</span>new <span class="token operator">-</span>x509 <span class="token operator">-</span>nodes <span class="token operator">-</span>days 3600 \
        <span class="token operator">-</span>key ca-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>out ca<span class="token punctuation">.</span>pem

<span class="token comment"># Create server certificate, remove passphrase, and sign it</span>
<span class="token comment"># server-cert.pem = public key, server-key.pem = private key</span>
openssl req <span class="token operator">-</span>newkey rsa:2048 <span class="token operator">-</span>days 3600 \
        <span class="token operator">-</span>nodes <span class="token operator">-</span>keyout server-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>out server-req<span class="token punctuation">.</span>pem
openssl rsa <span class="token operator">-in</span> server-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>out server-key<span class="token punctuation">.</span>pem
openssl x509  <span class="token operator">-</span>sha384 <span class="token operator">-</span>req <span class="token operator">-in</span> server-req<span class="token punctuation">.</span>pem <span class="token operator">-</span>days 3600 \
        <span class="token operator">-</span>CA ca<span class="token punctuation">.</span>pem <span class="token operator">-</span>CAkey ca-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>set_serial 01 <span class="token operator">-</span>out server-cert<span class="token punctuation">.</span>pem

<span class="token comment"># Create client certificate, remove passphrase, and sign it</span>
<span class="token comment"># client-cert.pem = public key, client-key.pem = private key</span>
openssl req <span class="token operator">-</span>subj <span class="token operator">/</span>client<span class="token punctuation">.</span>dtstack<span class="token punctuation">.</span>com <span class="token operator">-</span>newkey rsa:2048 <span class="token operator">-</span>days 3600 \
        <span class="token operator">-</span>nodes <span class="token operator">-</span>keyout client-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>out client-req<span class="token punctuation">.</span>pem
openssl rsa <span class="token operator">-in</span> client-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>out client-key<span class="token punctuation">.</span>pem
openssl x509 <span class="token operator">-</span>sha384 <span class="token operator">-</span>req <span class="token operator">-in</span> client-req<span class="token punctuation">.</span>pem <span class="token operator">-</span>days 3600 \
        <span class="token operator">-</span>CA ca<span class="token punctuation">.</span>pem <span class="token operator">-</span>CAkey ca-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>set_serial 01 <span class="token operator">-</span>out client-cert<span class="token punctuation">.</span>pem
        
openssl x509 <span class="token operator">-</span>req <span class="token operator">-in</span> client-req<span class="token punctuation">.</span>pem <span class="token operator">-</span>days 3600 \
        <span class="token operator">-</span>CA ca<span class="token punctuation">.</span>pem <span class="token operator">-</span>CAkey ca-key<span class="token punctuation">.</span>pem <span class="token operator">-</span>set_serial 01 <span class="token operator">-</span>out client-cert<span class="token punctuation">.</span>pem
</code></pre> 
<h4><a id="_290"></a>查看证书信息</h4> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 mysql]</span><span class="token comment"># openssl x509 -text -in server-cert.pem -noout</span>
Certificate:
    <span class="token keyword">Data</span>:
        Version: 3 <span class="token punctuation">(</span>0x2<span class="token punctuation">)</span>
        Serial Number: 2 <span class="token punctuation">(</span>0x2<span class="token punctuation">)</span>
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=MySQL_Server_5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>32_Auto_Generated_CA_Certificate
        Validity
            Not Before: Mar 31 12:14:46 2021 GMT
            Not After : Mar 29 12:14:46 2031 GMT
        Subject: CN=MySQL_Server_5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>32_Auto_Generated_Server_Certificate
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: <span class="token punctuation">(</span>2048 bit<span class="token punctuation">)</span>
                Modulus:

<span class="token namespace">[root@box1 pki]</span><span class="token comment"># openssl x509 -text -in client-cert.pem -noout</span>
Certificate:
    <span class="token keyword">Data</span>:
        Version: 1 <span class="token punctuation">(</span>0x0<span class="token punctuation">)</span>
        Serial Number: 1 <span class="token punctuation">(</span>0x1<span class="token punctuation">)</span>
    Signature Algorithm: sha384WithRSAEncryption
        Issuer: C=CN<span class="token punctuation">,</span> ST=HZ<span class="token punctuation">,</span> L=ZJ<span class="token punctuation">,</span> O=lazybug CO<span class="token punctuation">,</span> OU=freecity<span class="token punctuation">,</span> CN=www<span class="token punctuation">.</span>dtstack<span class="token punctuation">.</span>com/emailAddress=junda@dtstack<span class="token punctuation">.</span>com
        Validity
            Not Before: Apr  1 01:34:53 2021 GMT
            Not After : Feb  8 01:34:53 2031 GMT
        Subject: CN=client<span class="token punctuation">.</span>dtstack<span class="token punctuation">.</span>com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: <span class="token punctuation">(</span>2048 b
</code></pre> 
<h4><a id="_324"></a>验证证书</h4> 
<p>使用openssl verify命令验证证书有效性。CAfile是用于创建证书的ca文件。</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 pki]</span><span class="token comment"># openssl verify -CAfile ca.pem server-cert.pem client-cert.pem</span>
server-cert<span class="token punctuation">.</span>pem: OK
client-cert<span class="token punctuation">.</span>pem: OK
</code></pre> 
<p>如果ca文件和证书文件不匹配，验证会报错</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@box1 pki]</span><span class="token comment"># openssl verify -CAfile /var/lib/backupca/ca.pem server-cert.pem client-cert.pem</span>
server-cert<span class="token punctuation">.</span>pem: C = CN<span class="token punctuation">,</span> ST = ZJ<span class="token punctuation">,</span> L = HZ<span class="token punctuation">,</span> O = bugfree server<span class="token punctuation">,</span> OU = land<span class="token punctuation">,</span> CN = www<span class="token punctuation">.</span>dtstack<span class="token punctuation">.</span>com<span class="token punctuation">,</span> emailAddress = server@dtstack<span class="token punctuation">.</span>com
error 20 at 0 depth lookup:unable to get local issuer certificate
client-cert<span class="token punctuation">.</span>pem: CN = client<span class="token punctuation">.</span>dtstack<span class="token punctuation">.</span>com
error 20 at 0 depth lookup:unable to get local issuer certificate
</code></pre> 
<p>更多技术信息请查看云掣官网<a href="https://yunche.pro/?t=yrgw" rel="nofollow">https://yunche.pro/?t=yrgw</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6a8cd70e4db1bf93c1e9671487e34364/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解锁测试性能瓶颈：深度探讨JMeter分布式性能测试！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2c1473dd717382d2336b9e4f04bcd11f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">代码review</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>